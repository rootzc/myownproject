cscope 15 /Opensrc/vire -q 0000005003 0001092845
	@dep/ae/ae.c

33 
	~<¡dio.h
>

34 
	~<sys/time.h
>

35 
	~<sys/ty³s.h
>

36 
	~<uni¡d.h
>

37 
	~<¡dlib.h
>

38 
	~<pŞl.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

41 
	~<”ºo.h
>

43 
	~<dm®loc.h
>

45 
	~<«.h
>

47 #ifdeà
HAVE_CONFIG_H


48 
	~<cÚfig.h
>

53 #ifdeà
HAVE_EVENT_PORTS


54 
	~"«_evpÜt.c
"

56 #ifdeà
HAVE_EPOLL


57 
	~"«_•Şl.c
"

59 #ifdeà
HAVE_KQUEUE


60 
	~"«_kqueue.c
"

62 
	~"«_£Ëù.c
"

67 
«Ev’tLoİ
 *
	$«C»©eEv’tLoİ
(
£tsize
) {

68 
«Ev’tLoİ
 *
ev’tLoİ
;

69 
i
;

71 ià((
ev’tLoİ
 = 
	`d®loc
((*ev’tLoİ))è=ğ
NULL
è
”r
;

72 
ev’tLoİ
->
ev’ts
 = 
	`d®loc
((
«FeEv’t
)*
£tsize
);

73 
ev’tLoİ
->
fœed
 = 
	`d®loc
((
«FœedEv’t
)*
£tsize
);

74 ià(
ev’tLoİ
->
ev’ts
 =ğ
NULL
 ||ƒv’tLoİ->
fœed
 =ğNULLè
”r
;

75 
ev’tLoİ
->
£tsize
 = setsize;

76 
ev’tLoİ
->
Ï¡Time
 = 
	`time
(
NULL
);

77 
ev’tLoİ
->
timeEv’tH—d
 = 
NULL
;

78 
ev’tLoİ
->
timeEv’tNextId
 = 0;

79 
ev’tLoİ
->
¡İ
 = 0;

80 
ev’tLoİ
->
maxfd
 = -1;

81 
ev’tLoİ
->
befÜe¦“p
 = 
NULL
;

82 
ev’tLoİ
->
bsd©a
 = 
NULL
;

83 ià(
	`«ApiC»©e
(
ev’tLoİ
è=ğ-1è
”r
;

86 
i
 = 0; i < 
£tsize
; i++)

87 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

88  
ev’tLoİ
;

90 
”r
:

91 ià(
ev’tLoİ
) {

92 
	`dä“
(
ev’tLoİ
->
ev’ts
);

93 
	`dä“
(
ev’tLoİ
->
fœed
);

94 
	`dä“
(
ev’tLoİ
);

96  
NULL
;

97 
	}
}

100 
	$«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
) {

101  
ev’tLoİ
->
£tsize
;

102 
	}
}

111 
	$«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

112 
i
;

114 ià(
£tsize
 =ğ
ev’tLoİ
->£tsizeè 
AE_OK
;

115 ià(
ev’tLoİ
->
maxfd
 >ğ
£tsize
è 
AE_ERR
;

116 ià(
	`«ApiResize
(
ev’tLoİ
,
£tsize
è=ğ-1è 
AE_ERR
;

118 
ev’tLoİ
->
ev’ts
 = 
	`d»®loc
Óv’tLoİ->ev’ts,(
«FeEv’t
)*
£tsize
);

119 
ev’tLoİ
->
fœed
 = 
	`d»®loc
Óv’tLoİ->fœed,(
«FœedEv’t
)*
£tsize
);

120 
ev’tLoİ
->
£tsize
 = setsize;

124 
i
 = 
ev’tLoİ
->
maxfd
+1; i < 
£tsize
; i++)

125 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

126  
AE_OK
;

127 
	}
}

129 
	$«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

130 
	`«ApiF»e
(
ev’tLoİ
);

131 
	`dä“
(
ev’tLoİ
->
ev’ts
);

132 
	`dä“
(
ev’tLoİ
->
fœed
);

133 
	`dä“
(
ev’tLoİ
);

134 
	}
}

136 
	$«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

137 
ev’tLoİ
->
¡İ
 = 1;

138 
	}
}

140 
	$«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

141 
«FeProc
 *
´oc
, *
ş›ÁD©a
)

143 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) {

144 ià(
	`«ResizeS‘Size
(
ev’tLoİ
,
fd
+1000è!ğ
AE_OK
) {

145  
AE_ERR
;

148 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

150 ià(
	`«ApiAddEv’t
(
ev’tLoİ
, 
fd
, 
mask
) == -1)

151  
AE_ERR
;

152 
ã
->
mask
 |= mask;

153 ià(
mask
 & 
AE_READABLE
è
ã
->
rfeProc
 = 
´oc
;

154 ià(
mask
 & 
AE_WRITABLE
è
ã
->
wfeProc
 = 
´oc
;

155 
ã
->
ş›ÁD©a
 = clientData;

156 ià(
fd
 > 
ev’tLoİ
->
maxfd
)

157 
ev’tLoİ
->
maxfd
 = 
fd
;

158  
AE_OK
;

159 
	}
}

161 
	$«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
)

163 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) ;

164 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

165 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

167 
	`«ApiD–Ev’t
(
ev’tLoİ
, 
fd
, 
mask
);

168 
ã
->
mask
 = fe->mask & (~mask);

169 ià(
fd
 =ğ
ev’tLoİ
->
maxfd
 && 
ã
->
mask
 =ğ
AE_NONE
) {

171 
j
;

173 
j
 = 
ev’tLoİ
->
maxfd
-1; j >= 0; j--)

174 ià(
ev’tLoİ
->
ev’ts
[
j
].
mask
 !ğ
AE_NONE
) ;

175 
ev’tLoİ
->
maxfd
 = 
j
;

177 
	}
}

179 
	$«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
) {

180 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
)  0;

181 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

183  
ã
->
mask
;

184 
	}
}

186 
	$«G‘Time
(*
£cÚds
, *
mli£cÚds
)

188 
timev®
 
tv
;

190 
	`g‘timeofday
(&
tv
, 
NULL
);

191 *
£cÚds
 = 
tv
.
tv_£c
;

192 *
mli£cÚds
 = 
tv
.
tv_u£c
/1000;

193 
	}
}

195 
	$«AddMli£cÚdsToNow
(
mli£cÚds
, *
£c
, *
ms
) {

196 
cur_£c
, 
cur_ms
, 
wh’_£c
, 
wh’_ms
;

198 
	`«G‘Time
(&
cur_£c
, &
cur_ms
);

199 
wh’_£c
 = 
cur_£c
 + 
mli£cÚds
/1000;

200 
wh’_ms
 = 
cur_ms
 + 
mli£cÚds
%1000;

201 ià(
wh’_ms
 >= 1000) {

202 
wh’_£c
 ++;

203 
wh’_ms
 -= 1000;

205 *
£c
 = 
wh’_£c
;

206 *
ms
 = 
wh’_ms
;

207 
	}
}

209 
	$«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

210 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

211 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
)

213 
id
 = 
ev’tLoİ
->
timeEv’tNextId
++;

214 
«TimeEv’t
 *
‹
;

216 
‹
 = 
	`d®loc
((*te));

217 ià(
‹
 =ğ
NULL
è 
AE_ERR
;

218 
‹
->
id
 = id;

219 
	`«AddMli£cÚdsToNow
(
mli£cÚds
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

220 
‹
->
timeProc
 = 
´oc
;

221 
‹
->
fš®iz”Proc
 = finalizerProc;

222 
‹
->
ş›ÁD©a
 = clientData;

223 
‹
->
Ãxt
 = 
ev’tLoİ
->
timeEv’tH—d
;

224 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
;

225  
id
;

226 
	}
}

228 
	$«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
)

230 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

231 
‹
) {

232 ià(
‹
->
id
 == id) {

233 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

234  
AE_OK
;

236 
‹
 =e->
Ãxt
;

238  
AE_ERR
;

239 
	}
}

252 
«TimeEv’t
 *
	$«S—rchN—»¡Tim”
(
«Ev’tLoİ
 *
ev’tLoİ
)

254 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

255 
«TimeEv’t
 *
Ã¬e¡
 = 
NULL
;

257 
‹
) {

258 ià(!
Ã¬e¡
 || 
‹
->
wh’_£c
 <‚earest->when_sec ||

259 (
‹
->
wh’_£c
 =ğ
Ã¬e¡
->when_sec &&

260 
‹
->
wh’_ms
 < 
Ã¬e¡
->when_ms))

261 
Ã¬e¡
 = 
‹
;

262 
‹
 =e->
Ãxt
;

264  
Ã¬e¡
;

265 
	}
}

268 
	$´oûssTimeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
) {

269 
´oûs£d
 = 0;

270 
«TimeEv’t
 *
‹
, *
´ev
;

271 
maxId
;

272 
time_t
 
now
 = 
	`time
(
NULL
);

282 ià(
now
 < 
ev’tLoİ
->
Ï¡Time
) {

283 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

284 
‹
) {

285 
‹
->
wh’_£c
 = 0;

286 
‹
 =e->
Ãxt
;

289 
ev’tLoİ
->
Ï¡Time
 = 
now
;

291 
´ev
 = 
NULL
;

292 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

293 
maxId
 = 
ev’tLoİ
->
timeEv’tNextId
-1;

294 
‹
) {

295 
now_£c
, 
now_ms
;

296 
id
;

299 ià(
‹
->
id
 =ğ
AE_DELETED_EVENT_ID
) {

300 
«TimeEv’t
 *
Ãxt
 = 
‹
->next;

301 ià(
´ev
 =ğ
NULL
)

302 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
->
Ãxt
;

304 
´ev
->
Ãxt
 = 
‹
->next;

305 ià(
‹
->
fš®iz”Proc
)

306 
‹
->
	`fš®iz”Proc
(
ev’tLoİ
,e->
ş›ÁD©a
);

307 
	`dä“
(
‹
);

308 
‹
 = 
Ãxt
;

317 ià(
‹
->
id
 > 
maxId
) {

318 
‹
 =e->
Ãxt
;

321 
	`«G‘Time
(&
now_£c
, &
now_ms
);

322 ià(
now_£c
 > 
‹
->
wh’_£c
 ||

323 (
now_£c
 =ğ
‹
->
wh’_£c
 && 
now_ms
 >ğ‹->
wh’_ms
))

325 
»tv®
;

327 
id
 = 
‹
->id;

328 
»tv®
 = 
‹
->
	`timeProc
(
ev’tLoİ
, 
id
,e->
ş›ÁD©a
);

329 
´oûs£d
++;

330 ià(
»tv®
 !ğ
AE_NOMORE
) {

331 
	`«AddMli£cÚdsToNow
(
»tv®
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

333 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

336 
´ev
 = 
‹
;

337 
‹
 =e->
Ãxt
;

339  
´oûs£d
;

340 
	}
}

355 
	$«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
)

357 
´oûs£d
 = 0, 
numev’ts
;

360 ià(!(
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_FILE_EVENTS
))  0;

366 ià(
ev’tLoİ
->
maxfd
 != -1 ||

367 ((
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_DONT_WAIT
))) {

368 
j
;

369 
«TimeEv’t
 *
shÜ‹¡
 = 
NULL
;

370 
timev®
 
tv
, *
tvp
;

372 ià(
æags
 & 
AE_TIME_EVENTS
 && !(æag & 
AE_DONT_WAIT
))

373 
shÜ‹¡
 = 
	`«S—rchN—»¡Tim”
(
ev’tLoİ
);

374 ià(
shÜ‹¡
) {

375 
now_£c
, 
now_ms
;

377 
	`«G‘Time
(&
now_£c
, &
now_ms
);

378 
tvp
 = &
tv
;

382 
ms
 =

383 (
shÜ‹¡
->
wh’_£c
 - 
now_£c
)*1000 +

384 
shÜ‹¡
->
wh’_ms
 - 
now_ms
;

386 ià(
ms
 > 0) {

387 
tvp
->
tv_£c
 = 
ms
/1000;

388 
tvp
->
tv_u£c
 = (
ms
 % 1000)*1000;

390 
tvp
->
tv_£c
 = 0;

391 
tvp
->
tv_u£c
 = 0;

397 ià(
æags
 & 
AE_DONT_WAIT
) {

398 
tv
.
tv_£c
 =v.
tv_u£c
 = 0;

399 
tvp
 = &
tv
;

402 
tvp
 = 
NULL
;

406 
numev’ts
 = 
	`«ApiPŞl
(
ev’tLoİ
, 
tvp
);

407 
j
 = 0; j < 
numev’ts
; j++) {

408 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[ev’tLoİ->
fœed
[
j
].
fd
];

409 
mask
 = 
ev’tLoİ
->
fœed
[
j
].mask;

410 
fd
 = 
ev’tLoİ
->
fœed
[
j
].fd;

411 
rfœed
 = 0;

416 ià(
ã
->
mask
 & mask & 
AE_READABLE
) {

417 
rfœed
 = 1;

418 
ã
->
	`rfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

420 ià(
ã
->
mask
 & mask & 
AE_WRITABLE
) {

421 ià(!
rfœed
 || 
ã
->
wfeProc
 !ğã->
rfeProc
)

422 
ã
->
	`wfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

424 
´oûs£d
++;

428 ià(
æags
 & 
AE_TIME_EVENTS
)

429 
´oûs£d
 +ğ
	`´oûssTimeEv’ts
(
ev’tLoİ
);

431  
´oûs£d
;

432 
	}
}

436 
	$«Wa™
(
fd
, 
mask
, 
mli£cÚds
) {

437 
pŞlfd
 
pfd
;

438 
»tmask
 = 0, 
»tv®
;

440 
	`mem£t
(&
pfd
, 0, (pfd));

441 
pfd
.
fd
 = fd;

442 ià(
mask
 & 
AE_READABLE
è
pfd
.
ev’ts
 |ğ
POLLIN
;

443 ià(
mask
 & 
AE_WRITABLE
è
pfd
.
ev’ts
 |ğ
POLLOUT
;

445 ià((
»tv®
 = 
	`pŞl
(&
pfd
, 1, 
mli£cÚds
))== 1) {

446 ià(
pfd
.
»v’ts
 & 
POLLIN
è
»tmask
 |ğ
AE_READABLE
;

447 ià(
pfd
.
»v’ts
 & 
POLLOUT
è
»tmask
 |ğ
AE_WRITABLE
;

448 ià(
pfd
.
»v’ts
 & 
POLLERR
è
»tmask
 |ğ
AE_WRITABLE
;

449 ià(
pfd
.
»v’ts
 & 
POLLHUP
è
»tmask
 |ğ
AE_WRITABLE
;

450  
»tmask
;

452  
»tv®
;

454 
	}
}

456 
	$«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
) {

457 
ev’tLoİ
->
¡İ
 = 0;

458 !
ev’tLoİ
->
¡İ
) {

459 ià(
ev’tLoİ
->
befÜe¦“p
 !ğ
NULL
)

460 
ev’tLoİ
->
	`befÜe¦“p
Óv’tLoİ,ƒv’tLoİ->
bsd©a
);

461 
	`«ProûssEv’ts
(
ev’tLoİ
, 
AE_ALL_EVENTS
);

463 
	}
}

465 *
	$«G‘ApiName
() {

466  
	`«ApiName
();

467 
	}
}

469 
	$«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
, *
´iv©e_d©a
) {

470 
ev’tLoİ
->
befÜe¦“p
 = beforesleep;

471 
ev’tLoİ
->
bsd©a
 = 
´iv©e_d©a
;

472 
	}
}

	@dep/ae/ae.h

33 #iâdeà
__AE_H__


34 
	#__AE_H__


	)

36 
	~<time.h
>

38 
	#AE_OK
 0

	)

39 
	#AE_ERR
 -1

	)

41 
	#AE_NONE
 0

	)

42 
	#AE_READABLE
 1

	)

43 
	#AE_WRITABLE
 2

	)

45 
	#AE_FILE_EVENTS
 1

	)

46 
	#AE_TIME_EVENTS
 2

	)

47 
	#AE_ALL_EVENTS
 (
AE_FILE_EVENTS
|
AE_TIME_EVENTS
)

	)

48 
	#AE_DONT_WAIT
 4

	)

50 
	#AE_NOMORE
 -1

	)

51 
	#AE_DELETED_EVENT_ID
 -1

	)

54 
	#AE_NOTUSED
(
V
è((èV)

	)

56 
	g«Ev’tLoİ
;

59 
	t«FeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tfd
, *
	tş›ÁD©a
, 
	tmask
);

60 
	t«TimeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tid
, *
	tş›ÁD©a
);

61 
	t«Ev’tFš®iz”Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	tş›ÁD©a
);

62 
	t«BefÜeSË•Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	t´iv©e_d©a
);

65 
	s«FeEv’t
 {

66 
	mmask
;

67 
«FeProc
 *
	mrfeProc
;

68 
«FeProc
 *
	mwfeProc
;

69 *
	mş›ÁD©a
;

70 } 
	t«FeEv’t
;

73 
	s«TimeEv’t
 {

74 
	mid
;

75 
	mwh’_£c
;

76 
	mwh’_ms
;

77 
«TimeProc
 *
	mtimeProc
;

78 
«Ev’tFš®iz”Proc
 *
	mfš®iz”Proc
;

79 *
	mş›ÁD©a
;

80 
«TimeEv’t
 *
	mÃxt
;

81 } 
	t«TimeEv’t
;

84 
	s«FœedEv’t
 {

85 
	mfd
;

86 
	mmask
;

87 } 
	t«FœedEv’t
;

90 
	s«Ev’tLoİ
 {

91 
	mmaxfd
;

92 
	m£tsize
;

93 
	mtimeEv’tNextId
;

94 
time_t
 
	mÏ¡Time
;

95 
«FeEv’t
 *
	mev’ts
;

96 
«FœedEv’t
 *
	mfœed
;

97 
«TimeEv’t
 *
	mtimeEv’tH—d
;

98 
	m¡İ
;

99 *
	m­id©a
;

100 
«BefÜeSË•Proc
 *
	mbefÜe¦“p
;

101 *
	mbsd©a
;

102 } 
	t«Ev’tLoİ
;

105 
«Ev’tLoİ
 *
«C»©eEv’tLoİ
(
£tsize
);

106 
«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

107 
«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

108 
«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

109 
«FeProc
 *
´oc
, *
ş›ÁD©a
);

110 
«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
);

111 
«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
);

112 
«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

113 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

114 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
);

115 
«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
);

116 
«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
);

117 
«Wa™
(
fd
, 
mask
, 
mli£cÚds
);

118 
«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
);

119 *
«G‘ApiName
();

120 
«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
, *
´iv©e_d©a
);

121 
«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
);

122 
«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
);

	@dep/ae/ae_epoll.c

32 
	~<sys/•Şl.h
>

34 
	s«ApiS‹
 {

35 
	m•fd
;

36 
•Şl_ev’t
 *
	mev’ts
;

37 } 
	t«ApiS‹
;

39 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

40 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

42 ià(!
¡©e
)  -1;

43 
¡©e
->
ev’ts
 = 
	`d®loc
((
•Şl_ev’t
)*
ev’tLoİ
->
£tsize
);

44 ià(!
¡©e
->
ev’ts
) {

45 
	`dä“
(
¡©e
);

48 
¡©e
->
•fd
 = 
	`•Şl_ü—‹
(1024);

49 ià(
¡©e
->
•fd
 == -1) {

50 
	`dä“
(
¡©e
->
ev’ts
);

51 
	`dä“
(
¡©e
);

54 
ev’tLoİ
->
­id©a
 = 
¡©e
;

56 
	}
}

58 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

59 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

61 
¡©e
->
ev’ts
 = 
	`d»®loc
(¡©e->ev’ts, (
•Şl_ev’t
)*
£tsize
);

63 
	}
}

65 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

66 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

68 
	`şo£
(
¡©e
->
•fd
);

69 
	`dä“
(
¡©e
->
ev’ts
);

70 
	`dä“
(
¡©e
);

71 
	}
}

73 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

74 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

75 
•Şl_ev’t
 
“
 = {0};

78 
İ
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
 =ğ
AE_NONE
 ?

79 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
;

81 
“
.
ev’ts
 = 0;

82 
mask
 |ğ
ev’tLoİ
->
ev’ts
[
fd
].mask;

83 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

84 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

85 
“
.
d©a
.
fd
 = fd;

86 ià(
	`•Şl_ùl
(
¡©e
->
•fd
,
İ
,
fd
,&
“
) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
d–mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
•Şl_ev’t
 
“
 = {0};

93 
mask
 = 
ev’tLoİ
->
ev’ts
[
fd
].mask & (~
d–mask
);

95 
“
.
ev’ts
 = 0;

96 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

97 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

98 
“
.
d©a
.
fd
 = fd;

99 ià(
mask
 !ğ
AE_NONE
) {

100 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_MOD
,
fd
,&
“
);

104 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_DEL
,
fd
,&
“
);

106 
	}
}

108 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

109 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

110 
»tv®
, 
numev’ts
 = 0;

112 
»tv®
 = 
	`•Şl_wa™
(
¡©e
->
•fd
,¡©e->
ev’ts
,
ev’tLoİ
->
£tsize
,

113 
tvp
 ? (tvp->
tv_£c
*1000 +vp->
tv_u£c
/1000) : -1);

114 ià(
»tv®
 > 0) {

115 
j
;

117 
numev’ts
 = 
»tv®
;

118 
j
 = 0; j < 
numev’ts
; j++) {

119 
mask
 = 0;

120 
•Şl_ev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

122 ià(
e
->
ev’ts
 & 
EPOLLIN
è
mask
 |ğ
AE_READABLE
;

123 ià(
e
->
ev’ts
 & 
EPOLLOUT
è
mask
 |ğ
AE_WRITABLE
;

124 ià(
e
->
ev’ts
 & 
EPOLLERR
è
mask
 |ğ
AE_WRITABLE
;

125 ià(
e
->
ev’ts
 & 
EPOLLHUP
è
mask
 |ğ
AE_WRITABLE
;

126 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
d©a
.fd;

127 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

130  
numev’ts
;

131 
	}
}

133 *
	$«ApiName
() {

135 
	}
}

	@dep/ae/ae_evport.c

31 
	~<as£¹.h
>

32 
	~<”ºo.h
>

33 
	~<pÜt.h
>

34 
	~<pŞl.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

39 
	~<¡dio.h
>

41 
	gevpÜt_debug
 = 0;

66 
	#MAX_EVENT_BATCHSZ
 512

	)

68 
	s«ApiS‹
 {

69 
	mpÜtfd
;

70 
	mÅ’dšg
;

71 
	m³ndšg_fds
[
MAX_EVENT_BATCHSZ
];

72 
	m³ndšg_masks
[
MAX_EVENT_BATCHSZ
];

73 } 
	t«ApiS‹
;

75 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

76 
i
;

77 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

78 ià(!
¡©e
)  -1;

80 
¡©e
->
pÜtfd
 = 
	`pÜt_ü—‹
();

81 ià(
¡©e
->
pÜtfd
 == -1) {

82 
	`dä“
(
¡©e
);

86 
¡©e
->
Å’dšg
 = 0;

88 
i
 = 0; i < 
MAX_EVENT_BATCHSZ
; i++) {

89 
¡©e
->
³ndšg_fds
[
i
] = -1;

90 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

93 
ev’tLoİ
->
­id©a
 = 
¡©e
;

95 
	}
}

97 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

100 
	}
}

102 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

103 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

105 
	`şo£
(
¡©e
->
pÜtfd
);

106 
	`dä“
(
¡©e
);

107 
	}
}

109 
	$«ApiLookupP’dšg
(
«ApiS‹
 *
¡©e
, 
fd
) {

110 
i
;

112 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

113 ià(
¡©e
->
³ndšg_fds
[
i
] =ğ
fd
)

114  (
i
);

118 
	}
}

123 
	$«ApiAssocŸ‹
(cÚ¡ *
wh”e
, 
pÜtfd
, 
fd
, 
mask
) {

124 
ev’ts
 = 0;

125 
rv
, 
”r
;

127 ià(
mask
 & 
AE_READABLE
)

128 
ev’ts
 |ğ
POLLIN
;

129 ià(
mask
 & 
AE_WRITABLE
)

130 
ev’ts
 |ğ
POLLOUT
;

132 ià(
evpÜt_debug
)

133 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹(%d, 0x%xèğ", 
wh”e
, 
fd
, 
ev’ts
);

135 
rv
 = 
	`pÜt_assocŸ‹
(
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
, 
ev’ts
,

136 (*)(
ušŒ_t
)
mask
);

137 
”r
 = 
”ºo
;

139 ià(
evpÜt_debug
)

140 
	`årštf
(
¡d”r
, "%d (%s)\n", 
rv
,„v =ğ0 ? "nØ”rÜ" : 
	`¡»¼Ü
(
”r
));

142 ià(
rv
 == -1) {

143 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹: %s\n", 
wh”e
, 
	`¡»¼Ü
(
”r
));

145 ià(
”r
 =ğ
EAGAIN
)

146 
	`årštf
(
¡d”r
, "aeApiAssociate:ƒvent…ort†imitƒxceeded.");

149  
rv
;

150 
	}
}

152 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

153 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

154 
fuÎmask
, 
pfd
;

156 ià(
evpÜt_debug
)

157 
	`årštf
(
¡d”r
, "«ApiAddEv’t: fd %d mask 0x%x\n", 
fd
, 
mask
);

164 
fuÎmask
 = 
mask
 | 
ev’tLoİ
->
ev’ts
[
fd
].mask;

165 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

167 ià(
pfd
 != -1) {

174 ià(
evpÜt_debug
)

175 
	`årštf
(
¡d”r
, "«ApiAddEv’t:‡ddšgØ³ndšg fd %d\n", 
fd
);

176 
¡©e
->
³ndšg_masks
[
pfd
] |ğ
fuÎmask
;

180  (
	`«ApiAssocŸ‹
("«ApiAddEv’t", 
¡©e
->
pÜtfd
, 
fd
, 
fuÎmask
));

181 
	}
}

183 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

184 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

185 
fuÎmask
, 
pfd
;

187 ià(
evpÜt_debug
)

188 
	`årštf
(
¡d”r
, "d– fd %d mask 0x%x\n", 
fd
, 
mask
);

190 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

192 ià(
pfd
 != -1) {

193 ià(
evpÜt_debug
)

194 
	`årštf
(
¡d”r
, "d–‘šgƒv’ˆäom…’dšg fd %d\n", 
fd
);

201 
¡©e
->
³ndšg_masks
[
pfd
] &ğ~
mask
;

203 ià(
¡©e
->
³ndšg_masks
[
pfd
] =ğ
AE_NONE
)

204 
¡©e
->
³ndšg_fds
[
pfd
] = -1;

217 
fuÎmask
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
;

218 ià(
fuÎmask
 =ğ
AE_NONE
) {

223 ià(
evpÜt_debug
)

224 
	`årštf
(
¡d”r
, "«ApiD–Ev’t:…Üt_dissocŸ‹(%d)\n", 
fd
);

226 ià(
	`pÜt_dissocŸ‹
(
¡©e
->
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
) != 0) {

227 
	`³¼Ü
("aeApiDelEvent:…ort_dissociate");

228 
	`abÜt
();

230 } ià(
	`«ApiAssocŸ‹
("«ApiD–Ev’t", 
¡©e
->
pÜtfd
, 
fd
,

231 
fuÎmask
) != 0) {

239 
	`abÜt
();

241 
	}
}

243 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

244 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

245 
time¥ec
 
timeout
, *
t¥
;

246 
mask
, 
i
;

247 
ušt_t
 
Ãv’ts
;

248 
pÜt_ev’t_t
 
ev’t
[
MAX_EVENT_BATCHSZ
];

255 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

256 ià(
¡©e
->
³ndšg_fds
[
i
] == -1)

260 ià(
	`«ApiAssocŸ‹
("«ApiPŞl", 
¡©e
->
pÜtfd
,

261 
¡©e
->
³ndšg_fds
[
i
], s‹->
³ndšg_masks
[i]) != 0) {

263 
	`abÜt
();

266 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

267 
¡©e
->
³ndšg_fds
[
i
] = -1;

270 
¡©e
->
Å’dšg
 = 0;

272 ià(
tvp
 !ğ
NULL
) {

273 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

274 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

275 
t¥
 = &
timeout
;

277 
t¥
 = 
NULL
;

284 
Ãv’ts
 = 1;

285 ià(
	`pÜt_g‘n
(
¡©e
->
pÜtfd
, 
ev’t
, 
MAX_EVENT_BATCHSZ
, &
Ãv’ts
,

286 
t¥
è=ğ-1 && (
”ºo
 !ğ
ETIME
 || 
Ãv’ts
 == 0)) {

287 ià(
”ºo
 =ğ
ETIME
 ||ƒ¼nØ=ğ
EINTR
)

291 
	`³¼Ü
("aeApiPoll:…ort_get");

292 
	`abÜt
();

295 
¡©e
->
Å’dšg
 = 
Ãv’ts
;

297 
i
 = 0; i < 
Ãv’ts
; i++) {

298 
mask
 = 0;

299 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLIN
)

300 
mask
 |ğ
AE_READABLE
;

301 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLOUT
)

302 
mask
 |ğ
AE_WRITABLE
;

304 
ev’tLoİ
->
fœed
[
i
].
fd
 = 
ev’t
[i].
pÜ‹v_objeù
;

305 
ev’tLoİ
->
fœed
[
i
].
mask
 = mask;

307 ià(
evpÜt_debug
)

308 
	`årštf
(
¡d”r
, "aeApiPoll: fd %d mask 0x%x\n",

309 ()
ev’t
[
i
].
pÜ‹v_objeù
, 
mask
);

311 
¡©e
->
³ndšg_fds
[
i
] = 
ev’t
[i].
pÜ‹v_objeù
;

312 
¡©e
->
³ndšg_masks
[
i
] = (
ušŒ_t
)
ev’t
[i].
pÜ‹v_u£r
;

315  
Ãv’ts
;

316 
	}
}

318 *
	$«ApiName
() {

320 
	}
}

	@dep/ae/ae_kqueue.c

32 
	~<sys/ty³s.h
>

33 
	~<sys/ev’t.h
>

34 
	~<sys/time.h
>

36 
	s«ApiS‹
 {

37 
	mkqfd
;

38 
kev’t
 *
	mev’ts
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
¡©e
->
ev’ts
 = 
	`d®loc
((
kev’t
)*
ev’tLoİ
->
£tsize
);

46 ià(!
¡©e
->
ev’ts
) {

47 
	`dä“
(
¡©e
);

50 
¡©e
->
kqfd
 = 
	`kqueue
();

51 ià(
¡©e
->
kqfd
 == -1) {

52 
	`dä“
(
¡©e
->
ev’ts
);

53 
	`dä“
(
¡©e
);

56 
ev’tLoİ
->
­id©a
 = 
¡©e
;

58 
	}
}

60 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

61 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

63 
¡©e
->
ev’ts
 = 
	`d»®loc
(¡©e->ev’ts, (
kev’t
)*
£tsize
);

65 
	}
}

67 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

68 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

70 
	`şo£
(
¡©e
->
kqfd
);

71 
	`dä“
(
¡©e
->
ev’ts
);

72 
	`dä“
(
¡©e
);

73 
	}
}

75 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

76 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

77 
kev’t
 
ke
;

79 ià(
mask
 & 
AE_READABLE
) {

80 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_ADD
, 0, 0, 
NULL
);

81 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

83 ià(
mask
 & 
AE_WRITABLE
) {

84 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_ADD
, 0, 0, 
NULL
);

85 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
kev’t
 
ke
;

94 ià(
mask
 & 
AE_READABLE
) {

95 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

96 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

98 ià(
mask
 & 
AE_WRITABLE
) {

99 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

100 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

102 
	}
}

104 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

105 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

106 
»tv®
, 
numev’ts
 = 0;

108 ià(
tvp
 !ğ
NULL
) {

109 
time¥ec
 
timeout
;

110 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

111 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

112 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

113 &
timeout
);

115 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

116 
NULL
);

119 ià(
»tv®
 > 0) {

120 
j
;

122 
numev’ts
 = 
»tv®
;

123 
j
 = 0; j < 
numev’ts
; j++) {

124 
mask
 = 0;

125 
kev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

127 ià(
e
->
f‹r
 =ğ
EVFILT_READ
è
mask
 |ğ
AE_READABLE
;

128 ià(
e
->
f‹r
 =ğ
EVFILT_WRITE
è
mask
 |ğ
AE_WRITABLE
;

129 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
id’t
;

130 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

133  
numev’ts
;

134 
	}
}

136 *
	$«ApiName
() {

138 
	}
}

	@dep/ae/ae_select.c

32 
	~<¡ršg.h
>

34 
	s«ApiS‹
 {

35 
fd_£t
 
	mrfds
, 
	mwfds
;

38 
fd_£t
 
	m_rfds
, 
	m_wfds
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
	`FD_ZERO
(&
¡©e
->
rfds
);

46 
	`FD_ZERO
(&
¡©e
->
wfds
);

47 
ev’tLoİ
->
­id©a
 = 
¡©e
;

49 
	}
}

51 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

53 ià(
£tsize
 >ğ
FD_SETSIZE
)  -1;

55 
	}
}

57 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

58 
	`dä“
(
ev’tLoİ
->
­id©a
);

59 
	}
}

61 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

62 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

64 ià(
mask
 & 
AE_READABLE
è
	`FD_SET
(
fd
,&
¡©e
->
rfds
);

65 ià(
mask
 & 
AE_WRITABLE
è
	`FD_SET
(
fd
,&
¡©e
->
wfds
);

67 
	}
}

69 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

70 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

72 ià(
mask
 & 
AE_READABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
rfds
);

73 ià(
mask
 & 
AE_WRITABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
wfds
);

74 
	}
}

76 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

77 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

78 
»tv®
, 
j
, 
numev’ts
 = 0;

80 
	`memıy
(&
¡©e
->
_rfds
,&¡©e->
rfds
,(
fd_£t
));

81 
	`memıy
(&
¡©e
->
_wfds
,&¡©e->
wfds
,(
fd_£t
));

83 
»tv®
 = 
	`£Ëù
(
ev’tLoİ
->
maxfd
+1,

84 &
¡©e
->
_rfds
,&¡©e->
_wfds
,
NULL
,
tvp
);

85 ià(
»tv®
 > 0) {

86 
j
 = 0; j <ğ
ev’tLoİ
->
maxfd
; j++) {

87 
mask
 = 0;

88 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
j
];

90 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

91 ià(
ã
->
mask
 & 
AE_READABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_rfds
))

92 
mask
 |ğ
AE_READABLE
;

93 ià(
ã
->
mask
 & 
AE_WRITABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_wfds
))

94 
mask
 |ğ
AE_WRITABLE
;

95 
ev’tLoİ
->
fœed
[
numev’ts
].
fd
 = 
j
;

96 
ev’tLoİ
->
fœed
[
numev’ts
].
mask
 = mask;

97 
numev’ts
++;

100  
numev’ts
;

101 
	}
}

103 *
	$«ApiName
() {

105 
	}
}

	@dep/darray/darray.c

1 
	~<¡dlib.h
>

3 
	~<dm®loc.h
>

5 
	~<d¬¿y.h
>

7 
d¬¿y
 *

8 
	$d¬¿y_ü—‹
(
n
, 
size_t
 
size
)

10 
d¬¿y
 *
a
;

12 
a
 = 
	`d®loc
((*a));

13 ià(
a
 =ğ
NULL
) {

14  
NULL
;

17 
a
->
–em
 = 
	`d®loc
(
n
 * 
size
);

18 ià(
a
->
–em
 =ğ
NULL
) {

19 
	`dä“
(
a
);

20  
NULL
;

23 
a
->
ÃËm
 = 0;

24 
a
->
size
 = size;

25 
a
->
ÇÎoc
 = 
n
;

27  
a
;

28 
	}
}

31 
	$d¬¿y_de¡roy
(
d¬¿y
 *
a
)

33 
	`d¬¿y_deš™
(
a
);

34 
	`dä“
(
a
);

35 
	}
}

38 
	$d¬¿y_š™
(
d¬¿y
 *
a
, 
n
, 
size_t
 
size
)

40 
a
->
–em
 = 
	`d®loc
(
n
 * 
size
);

41 ià(
a
->
–em
 =ğ
NULL
) {

45 
a
->
ÃËm
 = 0;

46 
a
->
size
 = size;

47 
a
->
ÇÎoc
 = 
n
;

50 
	}
}

53 
	$d¬¿y_deš™
(
d¬¿y
 *
a
)

55 ià(
a
->
–em
 !ğ
NULL
) {

56 
	`dä“
(
a
->
–em
);

58 
	}
}

61 
	$d¬¿y_idx
(
d¬¿y
 *
a
, *
–em
)

63 *
p
, *
q
;

64 
off
, 
idx
;

66 
p
 = 
a
->
–em
;

67 
q
 = 
–em
;

68 
off
 = ()(
q
 - 
p
);

70 
idx
 = 
off
 / ()
a
->
size
;

72  
idx
;

73 
	}
}

76 
	$d¬¿y_push
(
d¬¿y
 *
a
)

78 *
–em
, *
Ãw
;

79 
size_t
 
size
;

81 ià(
a
->
ÃËm
 =ğa->
ÇÎoc
) {

84 
size
 = 
a
->siz*‡->
ÇÎoc
;

85 
Ãw
 = 
	`d»®loc
(
a
->
–em
, 2 * 
size
);

86 ià(
Ãw
 =ğ
NULL
) {

87  
NULL
;

90 
a
->
–em
 = 
Ãw
;

91 
a
->
ÇÎoc
 *= 2;

94 
–em
 = (*)
a
->–em +‡->
size
 *‡->
ÃËm
;

95 
a
->
ÃËm
++;

97  
–em
;

98 
	}
}

101 
	$d¬¿y_pİ
(
d¬¿y
 *
a
)

103 *
–em
;

105 
a
->
ÃËm
--;

106 
–em
 = (*)
a
->–em +‡->
size
 *‡->
ÃËm
;

108  
–em
;

109 
	}
}

112 
	$d¬¿y_g‘
(
d¬¿y
 *
a
, 
idx
)

114 *
–em
;

116 
–em
 = (*)
a
->–em + (a->
size
 * 
idx
);

118  
–em
;

119 
	}
}

122 
	$d¬¿y_tİ
(
d¬¿y
 *
a
)

124  
	`d¬¿y_g‘
(
a
,‡->
ÃËm
 - 1);

125 
	}
}

128 
	$d¬¿y_sw­
(
d¬¿y
 *
a
, d¬¿y *
b
)

130 
d¬¿y
 
tmp
;

132 
tmp
 = *
a
;

133 *
a
 = *
b
;

134 *
b
 = 
tmp
;

135 
	}
}

142 
	$d¬¿y_sÜt
(
d¬¿y
 *
a
, 
d¬¿y_com·»_t
 
com·»
)

144 
	`qsÜt
(
a
->
–em
,‡->
ÃËm
,‡->
size
, 
com·»
);

145 
	}
}

152 
	$d¬¿y_—ch
(
d¬¿y
 *
a
, 
d¬¿y_—ch_t
 
func
, *
d©a
)

154 
i
, 
ÃËm
;

156 
i
 = 0, 
ÃËm
 = 
	`d¬¿y_n
(
a
); i <‚elem; i++) {

157 *
–em
 = 
	`d¬¿y_g‘
(
a
, 
i
);

158 
»t
;

160 
»t
 = 
	`func
(
–em
, 
d©a
);

161 ià(
»t
 != 0) {

167 
	}
}

	@dep/darray/darray.h

1 #iâdeà
_DARRAY_H_


2 
	#_DARRAY_H_


	)

4 (*
	td¬¿y_com·»_t
)(const *, const *);

5 (*
	td¬¿y_—ch_t
)(*, *);

7 
	sd¬¿y
 {

8 
ÃËm
;

9 *
–em
;

10 
size_t
 
size
;

11 
ÇÎoc
;

12 } 
	td¬¿y
;

14 
	#nuÎ_d¬¿y
 { 0, 
NULL
, 0, 0 
	}

	)
}

16 
šlše
 

17 
	$d¬¿y_nuÎ
(
d¬¿y
 *
a
)

19 
a
->
ÃËm
 = 0;

20 
a
->
–em
 = 
NULL
;

21 
a
->
size
 = 0;

22 
a
->
ÇÎoc
 = 0;

23 
	}
}

25 
šlše
 

26 
	$d¬¿y_£t
(
d¬¿y
 *
a
, *
–em
, 
size_t
 
size
, 
ÇÎoc
)

28 
a
->
ÃËm
 = 0;

29 
a
->
–em
 =ƒlem;

30 
a
->
size
 = size;

31 
a
->
ÇÎoc
 =‚alloc;

32 
	}
}

34 
šlše
 

35 
	$d¬¿y_n
(cÚ¡ 
d¬¿y
 *
a
)

37  
a
->
ÃËm
;

38 
	}
}

40 
d¬¿y
 *
d¬¿y_ü—‹
(
n
, 
size_t
 
size
);

41 
d¬¿y_de¡roy
(
d¬¿y
 *
a
);

42 
d¬¿y_š™
(
d¬¿y
 *
a
, 
n
, 
size_t
 
size
);

43 
d¬¿y_deš™
(
d¬¿y
 *
a
);

45 
d¬¿y_idx
(
d¬¿y
 *
a
, *
–em
);

46 *
d¬¿y_push
(
d¬¿y
 *
a
);

47 *
d¬¿y_pİ
(
d¬¿y
 *
a
);

48 *
d¬¿y_g‘
(
d¬¿y
 *
a
, 
idx
);

49 *
d¬¿y_tİ
(
d¬¿y
 *
a
);

50 
d¬¿y_sw­
(
d¬¿y
 *
a
, d¬¿y *
b
);

51 
d¬¿y_sÜt
(
d¬¿y
 *
a
, 
d¬¿y_com·»_t
 
com·»
);

52 
d¬¿y_—ch
(
d¬¿y
 *
a
, 
d¬¿y_—ch_t
 
func
, *
d©a
);

	@dep/dhashkit/dcrc16.c

1 
	~<dhashk™.h
>

3 cÚ¡ 
ušt16_t
 
	güc16b
[256] = {

38 
ušt32_t


39 
	$hash_üc16
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

41 
ušt64_t
 
x
;

42 
ušt32_t
 
üc
 = 0;

44 
x
=0; x < 
key_Ëngth
; x++) {

45 
üc
 = (üø<< 8è^ 
üc16b
[((üø>> 8è^ *
key
++) & 0x00ff];

48  
üc
;

49 
	}
}

	@dep/dhashkit/dcrc32.c

1 
	~<dhashk™.h
>

3 cÚ¡ 
ušt32_t
 
	güc32b
[256] = {

74 
ušt32_t


75 
	$hash_üc32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

77 
ušt64_t
 
x
;

78 
ušt32_t
 
üc
 = 
UINT32_MAX
;

80 
x
 = 0; x < 
key_Ëngth
; x++) {

81 
üc
 = (üø>> 8è^ 
üc32b
[(üø^ (
ušt64_t
)
key
[
x
]) & 0xff];

84  ((~
üc
) >> 16) & 0x7fff;

85 
	}
}

87 
ušt32_t


88 
	$hash_üc32a
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

90 cÚ¡ 
ušt8_t
 *
p
 = 
key
;

91 
ušt32_t
 
üc
;

93 
üc
 = ~0U;

94 
key_Ëngth
--) {

95 
üc
 = 
üc32b
[(üø^ *
p
++) & 0xFF] ^ (crc >> 8);

98  
üc
 ^ ~0U;

99 
	}
}

	@dep/dhashkit/dfnv.c

1 
	~<dhashk™.h
>

3 
ušt64_t
 
	gFNV_64_INIT
 = 
UINT64_C
(0xcbf29ce484222325);

4 
ušt64_t
 
	gFNV_64_PRIME
 = 
UINT64_C
(0x100000001b3);

5 
ušt32_t
 
	gFNV_32_INIT
 = 2166136261UL;

6 
ušt32_t
 
	gFNV_32_PRIME
 = 16777619;

8 
ušt32_t


9 
	$hash_âv1_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

11 
ušt64_t
 
hash
 = 
FNV_64_INIT
;

12 
size_t
 
x
;

14 
x
 = 0; x < 
key_Ëngth
; x++) {

15 
hash
 *ğ
FNV_64_PRIME
;

16 
hash
 ^ğ(
ušt64_t
)
key
[
x
];

19  (
ušt32_t
)
hash
;

20 
	}
}

22 
ušt32_t


23 
	$hash_âv1a_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

25 
ušt32_t
 
hash
 = (ušt32_tè
FNV_64_INIT
;

26 
size_t
 
x
;

28 
x
 = 0; x < 
key_Ëngth
; x++) {

29 
ušt32_t
 
v®
 = (ušt32_t)
key
[
x
];

30 
hash
 ^ğ
v®
;

31 
hash
 *ğ(
ušt32_t
è
FNV_64_PRIME
;

34  
hash
;

35 
	}
}

37 
ušt32_t


38 
	$hash_âv1_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

40 
ušt32_t
 
hash
 = 
FNV_32_INIT
;

41 
size_t
 
x
;

43 
x
 = 0; x < 
key_Ëngth
; x++) {

44 
ušt32_t
 
v®
 = (ušt32_t)
key
[
x
];

45 
hash
 *ğ
FNV_32_PRIME
;

46 
hash
 ^ğ
v®
;

49  
hash
;

50 
	}
}

52 
ušt32_t


53 
	$hash_âv1a_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

55 
ušt32_t
 
hash
 = 
FNV_32_INIT
;

56 
size_t
 
x
;

58 
x
ğ0; x < 
key_Ëngth
; x++) {

59 
ušt32_t
 
v®
 = (ušt32_t)
key
[
x
];

60 
hash
 ^ğ
v®
;

61 
hash
 *ğ
FNV_32_PRIME
;

64  
hash
;

65 
	}
}

	@dep/dhashkit/dhashkit.h

1 #iâdeà
_DHASHKIT_H_


2 
	#_DHASHKIT_H_


	)

4 
	~<¡dšt.h
>

5 
	~<¡dio.h
>

7 
	~<sys/ty³s.h
>

9 
	scÚtšuum
 {

10 
ušt32_t
 
	mšdex
;

11 
ušt32_t
 
	mv®ue
;

14 
	#HASH_CODEC
(
ACTION
) \

15 
	`ACTION
Ğ
HASH_ONE_AT_A_TIME
, 
Úe_©_a_time
 ) \

16 
	`ACTION
Ğ
HASH_MD5
, 
md5
 ) \

17 
	`ACTION
Ğ
HASH_CRC16
, 
üc16
 ) \

18 
	`ACTION
Ğ
HASH_CRC32
, 
üc32
 ) \

19 
	`ACTION
Ğ
HASH_CRC32A
, 
üc32a
 ) \

20 
	`ACTION
Ğ
HASH_FNV1_64
, 
âv1_64
 ) \

21 
	`ACTION
Ğ
HASH_FNV1A_64
, 
âv1a_64
 ) \

22 
	`ACTION
Ğ
HASH_FNV1_32
, 
âv1_32
 ) \

23 
	`ACTION
Ğ
HASH_FNV1A_32
, 
âv1a_32
 ) \

24 
	`ACTION
Ğ
HASH_HSIEH
, 
hs›h
 ) \

25 
	`ACTION
Ğ
HASH_MURMUR
, 
murmur
 ) \

26 
	`ACTION
Ğ
HASH_JENKINS
, 
j’kšs
 ) \

27 

	)

28 
	#DIST_CODEC
(
ACTION
) \

29 
	`ACTION
Ğ
DIST_KETAMA
, 
k‘ama
 ) \

30 
	`ACTION
Ğ
DIST_MODULA
, 
moduÏ
 ) \

31 
	`ACTION
Ğ
DIST_RANDOM
, 
¿ndom
 ) \

32 

	)

33 
	#DEFINE_ACTION
(
_hash
, 
_Çme
è_hash,

	)

34 
	ehash_ty³
 {

35 
HASH_CODEC
Ğ
DEFINE_ACTION
 )

36 
	mHASH_SENTINEL


37 } 
	thash_ty³_t
;

38 #undeà
DEFINE_ACTION


40 
	#DEFINE_ACTION
(
_di¡
, 
_Çme
è_di¡,

	)

41 
	edi¡_ty³
 {

42 
DIST_CODEC
Ğ
DEFINE_ACTION
 )

43 
	mDIST_SENTINEL


44 } 
	tdi¡_ty³_t
;

45 #undeà
DEFINE_ACTION


47 
ušt32_t
 
hash_Úe_©_a_time
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

48 
md5_sigÇtu»
(cÚ¡ *
key
, 
Ëngth
, *
»suÉ
);

49 
ušt32_t
 
hash_md5
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

50 
ušt32_t
 
hash_üc16
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

51 
ušt32_t
 
hash_üc32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

52 
ušt32_t
 
hash_üc32a
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

53 
ušt32_t
 
hash_âv1_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

54 
ušt32_t
 
hash_âv1a_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

55 
ušt32_t
 
hash_âv1_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

56 
ušt32_t
 
hash_âv1a_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

57 
ušt32_t
 
hash_hs›h
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

58 
ušt32_t
 
hash_j’kšs
(cÚ¡ *
key
, 
size_t
 
Ëngth
);

59 
ušt32_t
 
hash_murmur
(cÚ¡ *
key
, 
size_t
 
Ëngth
);

61 
ušt32_t
 
k‘ama_di¥©ch
(
cÚtšuum
 *cÚtšuum, ušt32_ˆ
ncÚtšuum
, ušt32_ˆ
hash
);

62 
ušt32_t
 
moduÏ_di¥©ch
(
cÚtšuum
 *cÚtšuum, ušt32_ˆ
ncÚtšuum
, ušt32_ˆ
hash
);

63 
ušt32_t
 
¿ndom_di¥©ch
(
cÚtšuum
 *cÚtšuum, ušt32_ˆ
ncÚtšuum
, ušt32_ˆ
hash
);

68 
ušt32_t
 
	m¡©e
[5];

69 
ušt32_t
 
	mcouÁ
[2];

70 
	mbufãr
[64];

71 } 
	tSHA1_CTX
;

73 
SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64]);

74 
SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
);

75 
SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
);

76 
SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
);

	@dep/dhashkit/dhsieh.c

1 
	~<dhashk™.h
>

3 #undeà
g‘16b™s


4 #ià(
defšed
(
__GNUC__
è&& defšed(
__i386__
))

5 
	#g‘16b™s
(
d
è(*((cÚ¡ 
ušt16_t
 *è(d)))

	)

8 #ià!
defšed
 (
g‘16b™s
)

9 
	#g‘16b™s
(
d
è((((
ušt32_t
)(((cÚ¡ 
ušt8_t
 *)(d))[1])) << 8)\

10 +(
ušt32_t
)(((cÚ¡ 
ušt8_t
 *)(
d
))[0]è)

	)

13 
ušt32_t


14 
	$hash_hs›h
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

16 
ušt32_t
 
hash
 = 0, 
tmp
;

17 
»m
;

19 ià(
key_Ëngth
 <ğ0 || 
key
 =ğ
NULL
) {

23 
»m
 = 
key_Ëngth
 & 3;

24 
key_Ëngth
 >>= 2;

27 ;
key_Ëngth
 > 0; key_length--) {

28 
hash
 +ğ
	`g‘16b™s
 (
key
);

29 
tmp
 = (
	`g‘16b™s
 (
key
+2è<< 11è^ 
hash
;

30 
hash
 = (hash << 16è^ 
tmp
;

31 
key
 +ğ2* (
ušt16_t
);

32 
hash
 += hash >> 11;

36 
»m
) {

38 
hash
 +ğ
	`g‘16b™s
 (
key
);

39 
hash
 ^= hash << 16;

40 
hash
 ^ğ(
ušt32_t
)
key
[ (
ušt16_t
)] << 18;

41 
hash
 += hash >> 11;

45 
hash
 +ğ
	`g‘16b™s
 (
key
);

46 
hash
 ^= hash << 11;

47 
hash
 += hash >> 17;

51 
hash
 +ğ()(*
key
);

52 
hash
 ^= hash << 10;

53 
hash
 += hash >> 1;

60 
hash
 ^= hash << 3;

61 
hash
 += hash >> 5;

62 
hash
 ^= hash << 4;

63 
hash
 += hash >> 17;

64 
hash
 ^= hash << 25;

65 
hash
 += hash >> 6;

67  
hash
;

68 
	}
}

	@dep/dhashkit/djenkins.c

1 
	~<dhashk™.h
>

3 
	#hashsize
(
n
è((
ušt32_t
)1<<Ò))

	)

4 
	#hashmask
(
n
è(
	`hashsize
Ò)-1)

	)

5 
	#rÙ
(
x
,
k
è(((x)<<(k)è| ((x)>>(32-(k))))

	)

7 
	#mix
(
a
,
b
,
c
) \

9 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c, 4); c +ğ
b
; \

10 
b
 -ğ
a
; b ^ğ
	`rÙ
×, 6);‡ +ğ
c
; \

11 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 8); b +ğ
a
; \

12 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c,16); c +ğ
b
; \

13 
b
 -ğ
a
; b ^ğ
	`rÙ
×,19);‡ +ğ
c
; \

14 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 4); b +ğ
a
; \

15 }

	)

17 
	#fš®
(
a
,
b
,
c
) \

19 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,14); \

20 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,11); \

21 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,25); \

22 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,16); \

23 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,4); \

24 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,14); \

25 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,24); \

26 }

	)

28 
	#JENKINS_INITVAL
 13

	)

46 
ušt32_t


47 
	$hash_j’kšs
(cÚ¡ *
key
, 
size_t
 
Ëngth
)

49 
ušt32_t
 
a
,
b
,
c
;

50 uniÚ { cÚ¡ *
±r
; 
size_t
 
i
; } 
u
;

53 
a
 = 
b
 = 
c
 = 0xd—db“à+ ((
ušt32_t
)
Ëngth
è+ 
JENKINS_INITVAL
;

55 
u
.
±r
 = 
key
;

56 #iâdeà
WORDS_BIGENDIAN


57 ià((
u
.
i
 & 0x3) == 0)

59 cÚ¡ 
ušt32_t
 *
k
 = (cÚ¡ ušt32_ˆ*)
key
;

62 
Ëngth
 > 12)

64 
a
 +ğ
k
[0];

65 
b
 +ğ
k
[1];

66 
c
 +ğ
k
[2];

67 
	`mix
(
a
,
b
,
c
);

68 
Ëngth
 -= 12;

69 
k
 += 3;

82 
Ëngth
)

84 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

85 11: 
c
+=
k
[2]&0xffffff; 
b
+=k[1]; 
a
+=k[0]; ;

86 10: 
c
+=
k
[2]&0xffff; 
b
+=k[1]; 
a
+=k[0]; ;

87 9 : 
c
+=
k
[2]&0xff; 
b
+=k[1]; 
a
+=k[0]; ;

88 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

89 7 : 
b
+=
k
[1]&0xffffff; 
a
+=k[0]; ;

90 6 : 
b
+=
k
[1]&0xffff; 
a
+=k[0]; ;

91 5 : 
b
+=
k
[1]&0xff; 
a
+=k[0]; ;

92 4 : 
a
+=
k
[0]; ;

93 3 : 
a
+=
k
[0]&0xffffff; ;

94 2 : 
a
+=
k
[0]&0xffff; ;

95 1 : 
a
+=
k
[0]&0xff; ;

96 0 :  
c
;

97 :  
c
;

101 ià((
u
.
i
 & 0x1) == 0)

103 cÚ¡ 
ušt16_t
 *
k
 = (cÚ¡ ušt16_ˆ*)
key
;

104 cÚ¡ 
ušt8_t
 *
k8
;

107 
Ëngth
 > 12)

109 
a
 +ğ
k
[0] + (((
ušt32_t
)k[1])<<16);

110 
b
 +ğ
k
[2] + (((
ušt32_t
)k[3])<<16);

111 
c
 +ğ
k
[4] + (((
ušt32_t
)k[5])<<16);

112 
	`mix
(
a
,
b
,
c
);

113 
Ëngth
 -= 12;

114 
k
 += 6;

118 
k8
 = (cÚ¡ 
ušt8_t
 *)
k
;

119 
Ëngth
)

121 12: 
c
+=
k
[4]+(((
ušt32_t
)k[5])<<16);

122 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

123 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

125 11: 
c
+=((
ušt32_t
)
k8
[10])<<16;

126 10: 
c
+=
k
[4];

127 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

128 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

130 9 : 
c
+=
k8
[8];

131 8 : 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

132 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

134 7 : 
b
+=((
ušt32_t
)
k8
[6])<<16;

135 6 : 
b
+=
k
[2];

136 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

138 5 : 
b
+=
k8
[4];

139 4 : 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

141 3 : 
a
+=((
ušt32_t
)
k8
[2])<<16;

142 2 : 
a
+=
k
[0];

144 1 : 
a
+=
k8
[0];

146 0 :  
c
;

147 :  
c
;

154 cÚ¡ 
ušt8_t
 *
k
 = (cÚ¡ ušt8_ˆ*)
key
;

157 
Ëngth
 > 12)

159 
a
 +ğ
k
[0];

160 
a
 +ğ((
ušt32_t
)
k
[1])<<8;

161 
a
 +ğ((
ušt32_t
)
k
[2])<<16;

162 
a
 +ğ((
ušt32_t
)
k
[3])<<24;

163 
b
 +ğ
k
[4];

164 
b
 +ğ((
ušt32_t
)
k
[5])<<8;

165 
b
 +ğ((
ušt32_t
)
k
[6])<<16;

166 
b
 +ğ((
ušt32_t
)
k
[7])<<24;

167 
c
 +ğ
k
[8];

168 
c
 +ğ((
ušt32_t
)
k
[9])<<8;

169 
c
 +ğ((
ušt32_t
)
k
[10])<<16;

170 
c
 +ğ((
ušt32_t
)
k
[11])<<24;

171 
	`mix
(
a
,
b
,
c
);

172 
Ëngth
 -= 12;

173 
k
 += 12;

177 
Ëngth
)

179 12: 
c
+=((
ušt32_t
)
k
[11])<<24;

180 11: 
c
+=((
ušt32_t
)
k
[10])<<16;

181 10: 
c
+=((
ušt32_t
)
k
[9])<<8;

182 9 : 
c
+=
k
[8];

183 8 : 
b
+=((
ušt32_t
)
k
[7])<<24;

184 7 : 
b
+=((
ušt32_t
)
k
[6])<<16;

185 6 : 
b
+=((
ušt32_t
)
k
[5])<<8;

186 5 : 
b
+=
k
[4];

187 4 : 
a
+=((
ušt32_t
)
k
[3])<<24;

188 3 : 
a
+=((
ušt32_t
)
k
[2])<<16;

189 2 : 
a
+=((
ušt32_t
)
k
[1])<<8;

190 1 : 
a
+=
k
[0];

192 0 :  
c
;

193  :  
c
;

195 #iâdeà
WORDS_BIGENDIAN


199 
	`fš®
(
a
,
b
,
c
);

200  
c
;

201 
	}
}

	@dep/dhashkit/dketama.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<m©h.h
>

5 
	~<dhashk™.h
>

7 
	#KETAMA_CONTINUUM_ADDITION
 10

	)

8 
	#KETAMA_POINTS_PER_SERVER
 160

	)

9 
	#KETAMA_MAX_HOSTLEN
 86

	)

11 
ušt32_t


12 
	$k‘ama_hash
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
, 
ušt32_t
 
®ignm’t
)

14 
»suÉs
[16];

16 
	`md5_sigÇtu»
((cÚ¡ *)
key
, ()
key_Ëngth
, 
»suÉs
);

18  ((
ušt32_t
è(
»suÉs
[3 + 
®ignm’t
 * 4] & 0xFF) << 24)

19 | ((
ušt32_t
è(
»suÉs
[2 + 
®ignm’t
 * 4] & 0xFF) << 16)

20 | ((
ušt32_t
è(
»suÉs
[1 + 
®ignm’t
 * 4] & 0xFF) << 8)

21 | (
»suÉs
[0 + 
®ignm’t
 * 4] & 0xFF);

22 
	}
}

25 
	$k‘ama_™em_cmp
(cÚ¡ *
t1
, cÚ¡ *
t2
)

27 cÚ¡ 
cÚtšuum
 *
ù1
 = 
t1
, *
ù2
 = 
t2
;

29 ià(
ù1
->
v®ue
 =ğ
ù2
->value) {

31 } ià(
ù1
->
v®ue
 > 
ù2
->value) {

36 
	}
}

38 
ušt32_t


39 
	$k‘ama_di¥©ch
(
cÚtšuum
 *cÚtšuum, 
ušt32_t
 
ncÚtšuum
, ušt32_ˆ
hash
)

41 
cÚtšuum
 *
begš
, *
’d
, *
Ëá
, *
right
, *
middË
;

43 
	`ASSERT
(
cÚtšuum
 !ğ
NULL
);

44 
	`ASSERT
(
ncÚtšuum
 != 0);

46 
begš
 = 
Ëá
 = 
cÚtšuum
;

47 
’d
 = 
right
 = 
cÚtšuum
 + 
ncÚtšuum
;

49 
Ëá
 < 
right
) {

50 
middË
 = 
Ëá
 + (
right
 -†eft) / 2;

51 ià(
middË
->
v®ue
 < 
hash
) {

52 
Ëá
 = 
middË
 + 1;

54 
right
 = 
middË
;

58 ià(
right
 =ğ
’d
) {

59 
right
 = 
begš
;

62  
right
->
šdex
;

63 
	}
}

	@dep/dhashkit/dmd5.c

1 
	~<¡ršg.h
>

3 
	~<dhashk™.h
>

14 
	tMD5_u32¶us
;

17 
MD5_u32¶us
 
	mlo
, 
	mhi
;

18 
MD5_u32¶us
 
	ma
, 
	mb
, 
	mc
, 
	md
;

19 
	mbufãr
[64];

20 
MD5_u32¶us
 
	mblock
[16];

21 } 
	tMD5_CTX
;

30 
	#F
(
x
, 
y
, 
z
è((zè^ ((xè& ((yè^ (z))))

	)

31 
	#G
(
x
, 
y
, 
z
è((yè^ ((zè& ((xè^ (y))))

	)

32 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

33 
	#I
(
x
, 
y
, 
z
è((yè^ ((xè| ~(z)))

	)

38 
	#STEP
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
t
, 
s
) \

39 (
a
è+ğ
	`f
((
b
), (
c
), (
d
)è+ (
x
è+ (
t
); \

40 (
a
èğ((×è<< (
s
)) | (((a) & 0xffffffff) >> (32 - (s)))); \

41 (
a
è+ğ(
b
);

	)

51 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
è|| defšed(
__vax__
)

52 
	#SET
(
n
) \

53 (*(
MD5_u32¶us
 *)&
±r
[(
n
è* 4])

	)

54 
	#GET
(
n
) \

55 
	`SET
(
n
)

	)

57 
	#SET
(
n
) \

58 (
ùx
->
block
[(
n
)] = \

59 (
MD5_u32¶us
)
±r
[(
n
) * 4] | \

60 ((
MD5_u32¶us
)
±r
[(
n
) * 4 + 1] << 8) | \

61 ((
MD5_u32¶us
)
±r
[(
n
) * 4 + 2] << 16) | \

62 ((
MD5_u32¶us
)
±r
[(
n
è* 4 + 3] << 24))

	)

63 
	#GET
(
n
) \

64 (
ùx
->
block
[(
n
)])

	)

72 
	$body
(
MD5_CTX
 *
ùx
, *
d©a
, 
size
)

74 *
±r
;

75 
MD5_u32¶us
 
a
, 
b
, 
c
, 
d
;

76 
MD5_u32¶us
 
§ved_a
, 
§ved_b
, 
§ved_c
, 
§ved_d
;

78 
±r
 = 
d©a
;

80 
a
 = 
ùx
->a;

81 
b
 = 
ùx
->b;

82 
c
 = 
ùx
->c;

83 
d
 = 
ùx
->d;

86 
§ved_a
 = 
a
;

87 
§ved_b
 = 
b
;

88 
§ved_c
 = 
c
;

89 
§ved_d
 = 
d
;

92 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(0), 0xd76aa478, 7)

93 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(1), 0xe8c7b756, 12)

94 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(2), 0x242070db, 17)

95 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(3), 0xc1bdceee, 22)

96 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(4), 0xf57c0faf, 7)

97 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(5), 0x4787c62a, 12)

98 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(6), 0xa8304613, 17)

99 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(7), 0xfd469501, 22)

100 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(8), 0x698098d8, 7)

101 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(9), 0x8b44f7af, 12)

102 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(10), 0xffff5bb1, 17)

103 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(11), 0x895cd7be, 22)

104 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(12), 0x6b901122, 7)

105 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(13), 0xfd987193, 12)

106 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(14), 0xa679438e, 17)

107 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(15), 0x49b40821, 22)

110 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xf61e2562, 5)

111 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(6), 0xc040b340, 9)

112 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x265e5a51, 14)

113 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(0), 0xe9b6c7aa, 20)

114 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xd62f105d, 5)

115 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(10), 0x02441453, 9)

116 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0xd8a1e681, 14)

117 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(4), 0xe7d3fbc8, 20)

118 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0x21e1cde6, 5)

119 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(14), 0xc33707d6, 9)

120 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xf4d50d87, 14)

121 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(8), 0x455a14ed, 20)

122 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0xa9e3e905, 5)

123 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(2), 0xfcefa3f8, 9)

124 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0x676f02d9, 14)

125 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(12), 0x8d2a4c8a, 20)

128 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xfffa3942, 4)

129 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(8), 0x8771f681, 11)

130 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x6d9d6122, 16)

131 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(14), 0xfde5380c, 23)

132 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xa4beea44, 4)

133 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(4), 0x4bdecfa9, 11)

134 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0xf6bb4b60, 16)

135 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(10), 0xbebfbc70, 23)

136 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0x289b7ec6, 4)

137 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(0), 0xeaa127fa, 11)

138 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xd4ef3085, 16)

139 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(6), 0x04881d05, 23)

140 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0xd9d4d039, 4)

141 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(12), 0xe6db99e5, 11)

142 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0x1fa27cf8, 16)

143 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(2), 0xc4ac5665, 23)

146 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(0), 0xf4292244, 6)

147 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(7), 0x432aff97, 10)

148 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(14), 0xab9423a7, 15)

149 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(5), 0xfc93a039, 21)

150 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(12), 0x655b59c3, 6)

151 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(3), 0x8f0ccc92, 10)

152 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(10), 0xffeff47d, 15)

153 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(1), 0x85845dd1, 21)

154 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(8), 0x6fa87e4f, 6)

155 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(15), 0xfe2ce6e0, 10)

156 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(6), 0xa3014314, 15)

157 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(13), 0x4e0811a1, 21)

158 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(4), 0xf7537e82, 6)

159 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(11), 0xbd3af235, 10)

160 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(2), 0x2ad7d2bb, 15)

161 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(9), 0xeb86d391, 21)

163 
a
 +ğ
§ved_a
;

164 
b
 +ğ
§ved_b
;

165 
c
 +ğ
§ved_c
;

166 
d
 +ğ
§ved_d
;

168 
±r
 += 64;

169 } 
size
 -= 64);

171 
ùx
->
a
 =‡;

172 
ùx
->
b
 = b;

173 
ùx
->
c
 = c;

174 
ùx
->
d
 = d;

176  
±r
;

177 
	}
}

180 
	$MD5_In™
(
MD5_CTX
 *
ùx
)

182 
ùx
->
a
 = 0x67452301;

183 
ùx
->
b
 = 0xefcdab89;

184 
ùx
->
c
 = 0x98badcfe;

185 
ùx
->
d
 = 0x10325476;

187 
ùx
->
lo
 = 0;

188 
ùx
->
hi
 = 0;

189 
	}
}

192 
	$MD5_Upd©e
(
MD5_CTX
 *
ùx
, *
d©a
, 
size
)

194 
MD5_u32¶us
 
§ved_lo
;

195 
u£d
, 
ä“
;

197 
§ved_lo
 = 
ùx
->
lo
;

198 ià((
ùx
->
lo
 = (
§ved_lo
 + 
size
) & 0x1fffffff) < saved_lo) {

199 
ùx
->
hi
++;

201 
ùx
->
hi
 +ğ
size
 >> 29;

203 
u£d
 = 
§ved_lo
 & 0x3f;

205 ià(
u£d
) {

206 
ä“
 = 64 - 
u£d
;

208 ià(
size
 < 
ä“
) {

209 
	`memıy
(&
ùx
->
bufãr
[
u£d
], 
d©a
, 
size
);

213 
	`memıy
(&
ùx
->
bufãr
[
u£d
], 
d©a
, 
ä“
);

214 
d©a
 = (*)d©¨+ 
ä“
;

215 
size
 -ğ
ä“
;

216 
	`body
(
ùx
, ctx->
bufãr
, 64);

219 ià(
size
 >= 64) {

220 
d©a
 = 
	`body
(
ùx
, d©a, 
size
 & ~()0x3f);

221 
size
 &= 0x3f;

224 
	`memıy
(
ùx
->
bufãr
, 
d©a
, 
size
);

225 
	}
}

228 
	$MD5_Fš®
(*
»suÉ
, 
MD5_CTX
 *
ùx
)

230 
u£d
, 
ä“
;

232 
u£d
 = 
ùx
->
lo
 & 0x3f;

234 
ùx
->
bufãr
[
u£d
++] = 0x80;

236 
ä“
 = 64 - 
u£d
;

238 ià(
ä“
 < 8) {

239 
	`mem£t
(&
ùx
->
bufãr
[
u£d
], 0, 
ä“
);

240 
	`body
(
ùx
, ctx->
bufãr
, 64);

241 
u£d
 = 0;

242 
ä“
 = 64;

245 
	`mem£t
(&
ùx
->
bufãr
[
u£d
], 0, 
ä“
 - 8);

247 
ùx
->
lo
 <<= 3;

248 
ùx
->
bufãr
[56] = ctx->
lo
;

249 
ùx
->
bufãr
[57] = ctx->
lo
 >> 8;

250 
ùx
->
bufãr
[58] = ctx->
lo
 >> 16;

251 
ùx
->
bufãr
[59] = ctx->
lo
 >> 24;

252 
ùx
->
bufãr
[60] = ctx->
hi
;

253 
ùx
->
bufãr
[61] = ctx->
hi
 >> 8;

254 
ùx
->
bufãr
[62] = ctx->
hi
 >> 16;

255 
ùx
->
bufãr
[63] = ctx->
hi
 >> 24;

257 
	`body
(
ùx
, ctx->
bufãr
, 64);

259 
»suÉ
[0] = 
ùx
->
a
;

260 
»suÉ
[1] = 
ùx
->
a
 >> 8;

261 
»suÉ
[2] = 
ùx
->
a
 >> 16;

262 
»suÉ
[3] = 
ùx
->
a
 >> 24;

263 
»suÉ
[4] = 
ùx
->
b
;

264 
»suÉ
[5] = 
ùx
->
b
 >> 8;

265 
»suÉ
[6] = 
ùx
->
b
 >> 16;

266 
»suÉ
[7] = 
ùx
->
b
 >> 24;

267 
»suÉ
[8] = 
ùx
->
c
;

268 
»suÉ
[9] = 
ùx
->
c
 >> 8;

269 
»suÉ
[10] = 
ùx
->
c
 >> 16;

270 
»suÉ
[11] = 
ùx
->
c
 >> 24;

271 
»suÉ
[12] = 
ùx
->
d
;

272 
»suÉ
[13] = 
ùx
->
d
 >> 8;

273 
»suÉ
[14] = 
ùx
->
d
 >> 16;

274 
»suÉ
[15] = 
ùx
->
d
 >> 24;

276 
	`mem£t
(
ùx
, 0, (*ctx));

277 
	}
}

284 
	$md5_sigÇtu»
(cÚ¡ *
key
, 
Ëngth
, *
»suÉ
)

286 
MD5_CTX
 
my_md5
;

288 
	`MD5_In™
(&
my_md5
);

289 ()
	`MD5_Upd©e
(&
my_md5
, 
key
, 
Ëngth
);

290 
	`MD5_Fš®
(
»suÉ
, &
my_md5
);

291 
	}
}

293 
ušt32_t


294 
	$hash_md5
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

296 
»suÉs
[16];

298 
	`md5_sigÇtu»
((cÚ¡ *)
key
, ()
key_Ëngth
, 
»suÉs
);

300  ((
ušt32_t
è(
»suÉs
[3] & 0xFF) << 24) |

301 ((
ušt32_t
è(
»suÉs
[2] & 0xFF) << 16) |

302 ((
ušt32_t
è(
»suÉs
[1] & 0xFF) << 8) |

303 (
»suÉs
[0] & 0xFF);

304 
	}
}

	@dep/dhashkit/dmodula.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

4 
	~<dhashk™.h
>

6 
	#MODULA_CONTINUUM_ADDITION
 10

	)

7 
	#MODULA_POINTS_PER_SERVER
 1

	)

9 
ušt32_t


10 
	$moduÏ_di¥©ch
(
cÚtšuum
 *cÚtšuum, 
ušt32_t
 
ncÚtšuum
, ušt32_ˆ
hash
)

12 
cÚtšuum
 *
c
;

14 
	`ASSERT
(
cÚtšuum
 !ğ
NULL
);

15 
	`ASSERT
(
ncÚtšuum
 != 0);

17 
c
 = 
cÚtšuum
 + 
hash
 % 
ncÚtšuum
;

19  
c
->
šdex
;

20 
	}
}

	@dep/dhashkit/dmurmur.c

18 
	~<dhashk™.h
>

20 
ušt32_t


21 
	$hash_murmur
(cÚ¡ *
key
, 
size_t
 
Ëngth
)

28 cÚ¡ 
m
 = 0x5bd1e995;

29 cÚ¡ 
ušt32_t
 
£ed
 = (0xd—db“à* (ušt32_t)
Ëngth
);

30 cÚ¡ 
r
 = 24;

35 
ušt32_t
 
h
 = 
£ed
 ^ (ušt32_t)
Ëngth
;

39 cÚ¡ * 
d©a
 = (cÚ¡ *)
key
;

41 
Ëngth
 >= 4) {

42 
k
 = *(*)
d©a
;

44 
k
 *ğ
m
;

45 
k
 ^ğk >> 
r
;

46 
k
 *ğ
m
;

48 
h
 *ğ
m
;

49 
h
 ^ğ
k
;

51 
d©a
 += 4;

52 
Ëngth
 -= 4;

57 
Ëngth
) {

59 
h
 ^ğ((
ušt32_t
)
d©a
[2]) << 16;

62 
h
 ^ğ((
ušt32_t
)
d©a
[1]) << 8;

65 
h
 ^ğ
d©a
[0];

66 
h
 *ğ
m
;

77 
h
 ^= h >> 13;

78 
h
 *ğ
m
;

79 
h
 ^= h >> 15;

81  
h
;

82 
	}
}

	@dep/dhashkit/done_at_a_time.c

15 
	~<dhashk™.h
>

17 
ušt32_t


18 
	$hash_Úe_©_a_time
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

20 cÚ¡ *
±r
 = 
key
;

21 
ušt32_t
 
v®ue
 = 0;

23 
key_Ëngth
--) {

24 
ušt32_t
 
v®
 = (ušt32_tè*
±r
++;

25 
v®ue
 +ğ
v®
;

26 
v®ue
 += (value << 10);

27 
v®ue
 ^= (value >> 6);

29 
v®ue
 += (value << 3);

30 
v®ue
 ^= (value >> 11);

31 
v®ue
 += (value << 15);

33  
v®ue
;

34 
	}
}

	@dep/dhashkit/drandom.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

4 
	~<dhashk™.h
>

6 
	#RANDOM_CONTINUUM_ADDITION
 10

	)

7 
	#RANDOM_POINTS_PER_SERVER
 1

	)

9 
ušt32_t


10 
	$¿ndom_di¥©ch
(
cÚtšuum
 *cÚtšuum, 
ušt32_t
 
ncÚtšuum
, ušt32_ˆ
hash
)

12 
cÚtšuum
 *
c
;

14 
	`ASSERT
(
cÚtšuum
 !ğ
NULL
);

15 
	`ASSERT
(
ncÚtšuum
 != 0);

17 
c
 = 
cÚtšuum
 + 
	`¿ndom
(è% 
ncÚtšuum
;

19  
c
->
šdex
;

20 
	}
}

	@dep/dhashkit/dsha1.c

22 
	#SHA1HANDSOFF


	)

24 
	~<¡dio.h
>

25 
	~<¡ršg.h
>

26 
	~<¡dšt.h
>

28 
	~<dhashk™.h
>

30 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

34 #ifdeà
VR_LITTLE_ENDIAN


35 
	#blk0
(
i
è(
block
->
l
[i] = (
	`rŞ
(block->l[i],24)&0xFF00FF00) \

36 |(
	`rŞ
(
block
->
l
[
i
],8)&0x00FF00FF))

	)

38 
	#blk0
(
i
è
block
->
l
[i]

	)

40 
	#blk
(
i
è(
block
->
l
[i&15] = 
	`rŞ
(block->l[(i+13)&15]^block->l[(i+8)&15] \

41 ^
block
->
l
[(
i
+2)&15]^block->l[i&15],1))

	)

44 
	#R0
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk0
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

45 
	#R1
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

46 
	#R2
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0x6ED9EBA1+
	`rŞ
(v,5);wôŞ(w,30);

	)

47 
	#R3
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(((w|x)&y)|(w&x))+
	`blk
(i)+0x8F1BBCDC+
	`rŞ
(v,5);wôŞ(w,30);

	)

48 
	#R4
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0xCA62C1D6+
	`rŞ
(v,5);wôŞ(w,30);

	)

53 
	$SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64])

55 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

57 
c
[64];

58 
ušt32_t
 
l
[16];

59 } 
	tCHAR64LONG16
;

60 #ifdeà
SHA1HANDSOFF


61 
CHAR64LONG16
 
block
[1];

62 
	`memıy
(
block
, 
bufãr
, 64);

69 
CHAR64LONG16
* 
block
 = (cÚ¡ CHAR64LONG16*)
bufãr
;

72 
a
 = 
¡©e
[0];

73 
b
 = 
¡©e
[1];

74 
c
 = 
¡©e
[2];

75 
d
 = 
¡©e
[3];

76 
e
 = 
¡©e
[4];

78 
	`R0
(
a
,
b
,
c
,
d
,
e
, 0); R0(e,a,b,c,d, 1); R0(d,e,a,b,c, 2); R0(c,d,e,a,b, 3);

79 
	`R0
(
b
,
c
,
d
,
e
,
a
, 4); R0(a,b,c,d,e, 5); R0(e,a,b,c,d, 6); R0(d,e,a,b,c, 7);

80 
	`R0
(
c
,
d
,
e
,
a
,
b
, 8); R0(b,c,d,e,a, 9); R0(a,b,c,d,e,10); R0(e,a,b,c,d,11);

81 
	`R0
(
d
,
e
,
a
,
b
,
c
,12); R0(c,d,e,a,b,13); R0(b,c,d,e,a,14); R0(a,b,c,d,e,15);

82 
	`R1
(
e
,
a
,
b
,
c
,
d
,16); R1(d,e,a,b,c,17); R1(c,d,e,a,b,18); R1(b,c,d,e,a,19);

83 
	`R2
(
a
,
b
,
c
,
d
,
e
,20); R2(e,a,b,c,d,21); R2(d,e,a,b,c,22); R2(c,d,e,a,b,23);

84 
	`R2
(
b
,
c
,
d
,
e
,
a
,24); R2(a,b,c,d,e,25); R2(e,a,b,c,d,26); R2(d,e,a,b,c,27);

85 
	`R2
(
c
,
d
,
e
,
a
,
b
,28); R2(b,c,d,e,a,29); R2(a,b,c,d,e,30); R2(e,a,b,c,d,31);

86 
	`R2
(
d
,
e
,
a
,
b
,
c
,32); R2(c,d,e,a,b,33); R2(b,c,d,e,a,34); R2(a,b,c,d,e,35);

87 
	`R2
(
e
,
a
,
b
,
c
,
d
,36); R2(d,e,a,b,c,37); R2(c,d,e,a,b,38); R2(b,c,d,e,a,39);

88 
	`R3
(
a
,
b
,
c
,
d
,
e
,40); R3(e,a,b,c,d,41); R3(d,e,a,b,c,42); R3(c,d,e,a,b,43);

89 
	`R3
(
b
,
c
,
d
,
e
,
a
,44); R3(a,b,c,d,e,45); R3(e,a,b,c,d,46); R3(d,e,a,b,c,47);

90 
	`R3
(
c
,
d
,
e
,
a
,
b
,48); R3(b,c,d,e,a,49); R3(a,b,c,d,e,50); R3(e,a,b,c,d,51);

91 
	`R3
(
d
,
e
,
a
,
b
,
c
,52); R3(c,d,e,a,b,53); R3(b,c,d,e,a,54); R3(a,b,c,d,e,55);

92 
	`R3
(
e
,
a
,
b
,
c
,
d
,56); R3(d,e,a,b,c,57); R3(c,d,e,a,b,58); R3(b,c,d,e,a,59);

93 
	`R4
(
a
,
b
,
c
,
d
,
e
,60); R4(e,a,b,c,d,61); R4(d,e,a,b,c,62); R4(c,d,e,a,b,63);

94 
	`R4
(
b
,
c
,
d
,
e
,
a
,64); R4(a,b,c,d,e,65); R4(e,a,b,c,d,66); R4(d,e,a,b,c,67);

95 
	`R4
(
c
,
d
,
e
,
a
,
b
,68); R4(b,c,d,e,a,69); R4(a,b,c,d,e,70); R4(e,a,b,c,d,71);

96 
	`R4
(
d
,
e
,
a
,
b
,
c
,72); R4(c,d,e,a,b,73); R4(b,c,d,e,a,74); R4(a,b,c,d,e,75);

97 
	`R4
(
e
,
a
,
b
,
c
,
d
,76); R4(d,e,a,b,c,77); R4(c,d,e,a,b,78); R4(b,c,d,e,a,79);

99 
¡©e
[0] +ğ
a
;

100 
¡©e
[1] +ğ
b
;

101 
¡©e
[2] +ğ
c
;

102 
¡©e
[3] +ğ
d
;

103 
¡©e
[4] +ğ
e
;

105 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

106 #ifdeà
SHA1HANDSOFF


107 
	`mem£t
(
block
, '\0', (block));

109 
	}
}

114 
	$SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
)

117 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

118 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

119 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

120 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

121 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

122 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

123 
	}
}

128 
	$SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
)

130 
ušt32_t
 
i
, 
j
;

132 
j
 = 
cÚ‹xt
->
couÁ
[0];

133 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3è< 
j
)

134 
cÚ‹xt
->
couÁ
[1]++;

135 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
>>29);

136 
j
 = (j >> 3) & 63;

137 ià((
j
 + 
Ën
) > 63) {

138 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64-j));

139 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

140  ; 
i
 + 63 < 
Ën
; i += 64) {

141 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, &
d©a
[
i
]);

143 
j
 = 0;

145 
i
 = 0;

146 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

147 
	}
}

152 
	$SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
)

154 
i
;

155 
fš®couÁ
[8];

156 
c
;

164 *
fı
 = &
fš®couÁ
[8];

166 
i
 = 0; i < 2; i++)

168 
ušt32_t
 
t
 = 
cÚ‹xt
->
couÁ
[
i
];

169 
j
;

171 
j
 = 0; j < 4; 
t
 >>= 8, j++)

172 *--
fı
 = (è
t
;

175 
i
 = 0; i < 8; i++) {

176 
fš®couÁ
[
i
] = ()((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)]

177 >> ((3-(
i
 & 3)) * 8) ) & 255);

180 
c
 = 0200;

181 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

182 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

183 
c
 = 0000;

184 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

186 
	`SHA1Upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

187 
i
 = 0; i < 20; i++) {

188 
dige¡
[
i
] = ()

189 ((
cÚ‹xt
->
¡©e
[
i
>>2] >> ((3-(i & 3)) * 8) ) & 255);

192 
	`mem£t
(
cÚ‹xt
, '\0', (*context));

193 
	`mem£t
(&
fš®couÁ
, '\0', (finalcount));

194 
	}
}

	@dep/dlist/dlist.c

1 
	~<¡dlib.h
>

3 
	~<dm®loc.h
>

5 
	~<dli¡.h
>

12 
dli¡
 *
	$dli¡C»©e
()

14 
dli¡
 *
li¡
;

16 ià((
li¡
 = 
	`d®loc
((*li¡))è=ğ
NULL
)

17  
NULL
;

18 
li¡
->
h—d
 =†i¡->

 = 
NULL
;

19 
li¡
->
Ën
 = 0;

20 
li¡
->
dup
 = 
NULL
;

21 
li¡
->
ä“
 = 
NULL
;

22 
li¡
->
m©ch
 = 
NULL
;

23  
li¡
;

24 
	}
}

29 
	$dli¡R–—£
(
dli¡
 *
li¡
)

31 
Ën
;

32 
dli¡Node
 *
cu¼’t
, *
Ãxt
;

34 
cu¼’t
 = 
li¡
->
h—d
;

35 
Ën
 = 
li¡
->len;

36 
Ën
--) {

37 
Ãxt
 = 
cu¼’t
->next;

38 ià(
li¡
->
ä“
èli¡->
	`ä“
(
cu¼’t
->
v®ue
);

39 
	`dä“
(
cu¼’t
);

40 
cu¼’t
 = 
Ãxt
;

42 
	`dä“
(
li¡
);

43 
	}
}

51 
dli¡
 *
	$dli¡AddNodeH—d
(
dli¡
 *
li¡
, *
v®ue
)

53 
dli¡Node
 *
node
;

55 ià((
node
 = 
	`d®loc
((*node))è=ğ
NULL
)

56  
NULL
;

57 
node
->
v®ue
 = value;

58 ià(
li¡
->
Ën
 == 0) {

59 
li¡
->
h—d
 =†i¡->

 = 
node
;

60 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

62 
node
->
´ev
 = 
NULL
;

63 
node
->
Ãxt
 = 
li¡
->
h—d
;

64 
li¡
->
h—d
->
´ev
 = 
node
;

65 
li¡
->
h—d
 = 
node
;

67 
li¡
->
Ën
++;

68  
li¡
;

69 
	}
}

77 
dli¡
 *
	$dli¡AddNodeTa
(
dli¡
 *
li¡
, *
v®ue
)

79 
dli¡Node
 *
node
;

81 ià((
node
 = 
	`d®loc
((*node))è=ğ
NULL
)

82  
NULL
;

83 
node
->
v®ue
 = value;

84 ià(
li¡
->
Ën
 == 0) {

85 
li¡
->
h—d
 =†i¡->

 = 
node
;

86 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

88 
node
->
´ev
 = 
li¡
->

;

89 
node
->
Ãxt
 = 
NULL
;

90 
li¡
->

->
Ãxt
 = 
node
;

91 
li¡
->

 = 
node
;

93 
li¡
->
Ën
++;

94  
li¡
;

95 
	}
}

97 
dli¡
 *
	$dli¡In£¹Node
(
dli¡
 *
li¡
, 
dli¡Node
 *
Şd_node
, *
v®ue
, 
aá”
) {

98 
dli¡Node
 *
node
;

100 ià((
node
 = 
	`d®loc
((*node))è=ğ
NULL
)

101  
NULL
;

102 
node
->
v®ue
 = value;

103 ià(
aá”
) {

104 
node
->
´ev
 = 
Şd_node
;

105 
node
->
Ãxt
 = 
Şd_node
->next;

106 ià(
li¡
->

 =ğ
Şd_node
) {

107 
li¡
->

 = 
node
;

110 
node
->
Ãxt
 = 
Şd_node
;

111 
node
->
´ev
 = 
Şd_node
->prev;

112 ià(
li¡
->
h—d
 =ğ
Şd_node
) {

113 
li¡
->
h—d
 = 
node
;

116 ià(
node
->
´ev
 !ğ
NULL
) {

117 
node
->
´ev
->
Ãxt
 =‚ode;

119 ià(
node
->
Ãxt
 !ğ
NULL
) {

120 
node
->
Ãxt
->
´ev
 =‚ode;

122 
li¡
->
Ën
++;

123  
li¡
;

124 
	}
}

130 
	$dli¡D–Node
(
dli¡
 *
li¡
, 
dli¡Node
 *
node
)

132 ià(
node
->
´ev
)

133 
node
->
´ev
->
Ãxt
 =‚ode->next;

135 
li¡
->
h—d
 = 
node
->
Ãxt
;

136 ià(
node
->
Ãxt
)

137 
node
->
Ãxt
->
´ev
 =‚ode->prev;

139 
li¡
->

 = 
node
->
´ev
;

140 ià(
li¡
->
ä“
èli¡->
	`ä“
(
node
->
v®ue
);

141 
	`dä“
(
node
);

142 
li¡
->
Ën
--;

143 
	}
}

149 
dli¡I‹r
 *
	$dli¡G‘I‹¿tÜ
(
dli¡
 *
li¡
, 
dœeùiÚ
)

151 
dli¡I‹r
 *
™”
;

153 ià((
™”
 = 
	`d®loc
((*™”))è=ğ
NULL
)  NULL;

154 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
)

155 
™”
->
Ãxt
 = 
li¡
->
h—d
;

157 
™”
->
Ãxt
 = 
li¡
->

;

158 
™”
->
dœeùiÚ
 = direction;

159  
™”
;

160 
	}
}

163 
	$dli¡R–—£I‹¿tÜ
(
dli¡I‹r
 *
™”
) {

164 
	`dä“
(
™”
);

165 
	}
}

168 
	$dli¡Rewšd
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
) {

169 
li
->
Ãxt
 = 
li¡
->
h—d
;

170 
li
->
dœeùiÚ
 = 
AL_START_HEAD
;

171 
	}
}

173 
	$dli¡RewšdTa
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
) {

174 
li
->
Ãxt
 = 
li¡
->

;

175 
li
->
dœeùiÚ
 = 
AL_START_TAIL
;

176 
	}
}

192 
dli¡Node
 *
	$dli¡Next
(
dli¡I‹r
 *
™”
)

194 
dli¡Node
 *
cu¼’t
 = 
™”
->
Ãxt
;

196 ià(
cu¼’t
 !ğ
NULL
) {

197 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
)

198 
™”
->
Ãxt
 = 
cu¼’t
->next;

200 
™”
->
Ãxt
 = 
cu¼’t
->
´ev
;

202  
cu¼’t
;

203 
	}
}

213 
dli¡
 *
	$dli¡Dup
(
dli¡
 *
Üig
)

215 
dli¡
 *
cİy
;

216 
dli¡I‹r
 
™”
;

217 
dli¡Node
 *
node
;

219 ià((
cİy
 = 
	`dli¡C»©e
()è=ğ
NULL
)

220  
NULL
;

221 
cİy
->
dup
 = 
Üig
->dup;

222 
cİy
->
ä“
 = 
Üig
->free;

223 
cİy
->
m©ch
 = 
Üig
->match;

224 
	`dli¡Rewšd
(
Üig
, &
™”
);

225 (
node
 = 
	`dli¡Next
(&
™”
)è!ğ
NULL
) {

226 *
v®ue
;

228 ià(
cİy
->
dup
) {

229 
v®ue
 = 
cİy
->
	`dup
(
node
->value);

230 ià(
v®ue
 =ğ
NULL
) {

231 
	`dli¡R–—£
(
cİy
);

232  
NULL
;

235 
v®ue
 = 
node
->value;

236 ià(
	`dli¡AddNodeTa
(
cİy
, 
v®ue
è=ğ
NULL
) {

237 
	`dli¡R–—£
(
cİy
);

238  
NULL
;

241  
cİy
;

242 
	}
}

253 
dli¡Node
 *
	$dli¡S—rchKey
(
dli¡
 *
li¡
, *
key
)

255 
dli¡I‹r
 
™”
;

256 
dli¡Node
 *
node
;

258 
	`dli¡Rewšd
(
li¡
, &
™”
);

259 (
node
 = 
	`dli¡Next
(&
™”
)è!ğ
NULL
) {

260 ià(
li¡
->
m©ch
) {

261 ià(
li¡
->
	`m©ch
(
node
->
v®ue
, 
key
)) {

262  
node
;

265 ià(
key
 =ğ
node
->
v®ue
) {

266  
node
;

270  
NULL
;

271 
	}
}

278 
dli¡Node
 *
	$dli¡Index
(
dli¡
 *
li¡
, 
šdex
) {

279 
dli¡Node
 *
n
;

281 ià(
šdex
 < 0) {

282 
šdex
 = (-index)-1;

283 
n
 = 
li¡
->

;

284 
šdex
-- && 
n
èÀğn->
´ev
;

286 
n
 = 
li¡
->
h—d
;

287 
šdex
-- && 
n
èÀğn->
Ãxt
;

289  
n
;

290 
	}
}

293 
	$dli¡RÙ©e
(
dli¡
 *
li¡
) {

294 
dli¡Node
 *

 = 
li¡
->tail;

296 ià(
	`dli¡L’gth
(
li¡
) <= 1) ;

299 
li¡
->

 =a->
´ev
;

300 
li¡
->

->
Ãxt
 = 
NULL
;

302 
li¡
->
h—d
->
´ev
 = 

;

303 

->
´ev
 = 
NULL
;

304 

->
Ãxt
 = 
li¡
->
h—d
;

305 
li¡
->
h—d
 = 

;

306 
	}
}

308 
dli¡
 *
	$dli¡Push
(
dli¡
 *
li¡
, *
v®ue
) {

309 
	`dli¡AddNodeTa
(
li¡
, 
v®ue
);

310  
li¡
;

311 
	}
}

313 *
	$dli¡Pİ
(
dli¡
 *
li¡
) {

314 
dli¡Node
 *
node
;

315 *
v®ue
;

317 
node
 = 
	`dli¡Fœ¡
(
li¡
);

318 ià(
node
 =ğ
NULL
) {

319  
NULL
;

322 
v®ue
 = 
	`dli¡NodeV®ue
(
node
);

323 
	`dli¡D–Node
(
li¡
, 
node
);

325 ià(
li¡
->
ä“
è 
NULL
;

327  
v®ue
;

328 
	}
}

	@dep/dlist/dlist.h

1 #iâdeà
_DLIST_H__


2 
	#_DLIST_H__


	)

6 
	sdli¡Node
 {

7 
dli¡Node
 *
	m´ev
;

8 
dli¡Node
 *
	mÃxt
;

9 *
	mv®ue
;

10 } 
	tdli¡Node
;

12 
	sdli¡I‹r
 {

13 
dli¡Node
 *
	mÃxt
;

14 
	mdœeùiÚ
;

15 } 
	tdli¡I‹r
;

17 
	sdli¡
 {

18 
dli¡Node
 *
	mh—d
;

19 
dli¡Node
 *
	m
;

20 *(*
	mdup
)(*
	m±r
);

21 (*
	mä“
)(*
	m±r
);

22 (*
	mm©ch
)(*
	m±r
, *
	mkey
);

23 
	mËn
;

24 } 
	tdli¡
;

27 
	#dli¡L’gth
(
l
è(Ö)->
Ën
)

	)

28 
	#dli¡Fœ¡
(
l
è(Ö)->
h—d
)

	)

29 
	#dli¡La¡
(
l
è(Ö)->

)

	)

30 
	#dli¡P»vNode
(
n
è(Ò)->
´ev
)

	)

31 
	#dli¡NextNode
(
n
è(Ò)->
Ãxt
)

	)

32 
	#dli¡NodeV®ue
(
n
è(Ò)->
v®ue
)

	)

34 
	#dli¡S‘DupM‘hod
(
l
,
m
è(Ö)->
dup
 = (m))

	)

35 
	#dli¡S‘F»eM‘hod
(
l
,
m
è(Ö)->
ä“
 = (m))

	)

36 
	#dli¡S‘M©chM‘hod
(
l
,
m
è(Ö)->
m©ch
 = (m))

	)

38 
	#dli¡G‘DupM‘hod
(
l
è(Ö)->
dup
)

	)

39 
	#dli¡G‘F»e
(
l
è(Ö)->
ä“
)

	)

40 
	#dli¡G‘M©chM‘hod
(
l
è(Ö)->
m©ch
)

	)

43 
dli¡
 *
dli¡C»©e
();

44 
dli¡R–—£
(
dli¡
 *
li¡
);

45 
dli¡
 *
dli¡AddNodeH—d
(dli¡ *
li¡
, *
v®ue
);

46 
dli¡
 *
dli¡AddNodeTa
(dli¡ *
li¡
, *
v®ue
);

47 
dli¡
 *
dli¡In£¹Node
(dli¡ *
li¡
, 
dli¡Node
 *
Şd_node
, *
v®ue
, 
aá”
);

48 
dli¡D–Node
(
dli¡
 *
li¡
, 
dli¡Node
 *
node
);

49 
dli¡I‹r
 *
dli¡G‘I‹¿tÜ
(
dli¡
 *
li¡
, 
dœeùiÚ
);

50 
dli¡Node
 *
dli¡Next
(
dli¡I‹r
 *
™”
);

51 
dli¡R–—£I‹¿tÜ
(
dli¡I‹r
 *
™”
);

52 
dli¡
 *
dli¡Dup
(dli¡ *
Üig
);

53 
dli¡Node
 *
dli¡S—rchKey
(
dli¡
 *
li¡
, *
key
);

54 
dli¡Node
 *
dli¡Index
(
dli¡
 *
li¡
, 
šdex
);

55 
dli¡Rewšd
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
);

56 
dli¡RewšdTa
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
);

57 
dli¡RÙ©e
(
dli¡
 *
li¡
);

58 
dli¡
 *
dli¡Push
(dli¡ *
li¡
, *
v®ue
);

59 *
dli¡Pİ
(
dli¡
 *
li¡
);

62 
	#AL_START_HEAD
 0

	)

63 
	#AL_START_TAIL
 1

	)

	@dep/dlist/dlockqueue.c

1 
	~<±h»ad.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dio.h
>

5 
	~<dm®loc.h
>

7 
	~<dli¡.h
>

8 
	~<dmtqueue.h
>

9 
	~<dlockqueue.h
>

11 
dlockqueue
 *
	$dlockqueue_ü—‹
()

13 
dlockqueue
 *
lqueue
;

15 
lqueue
 = 
	`d®loc
((*lqueue));

16 ià(
lqueue
 =ğ
NULL
) {

17  
NULL
;

20 
lqueue
->
maxËn
 = -1;

21 
lqueue
->
maxËn_pŞicy
 = 
MAX_LENGTH_POLICY_REJECT
;

22 
	`±h»ad_mu‹x_š™
(&
lqueue
->
lmu‹x
,
NULL
);

24 
lqueue
->
l
 = 
	`dli¡C»©e
();

25 ià(
lqueue
->
l
 =ğ
NULL
) {

26 
	`dlockqueue_de¡roy
(
lqueue
);

27  
NULL
;

30  
lqueue
;

31 
	}
}

33 
	$dlockqueue_push
(*
q
, *
v®ue
)

35 
dlockqueue
 *
lqueue
 = 
q
;

36 
dli¡
 *
li¡
;

37 
Ëngth
;

39 
	`±h»ad_mu‹x_lock
(&
lqueue
->
lmu‹x
);

40 
Ëngth
 = ()
	`dli¡L’gth
(
lqueue
->
l
);

41 ià(
lqueue
->
maxËn
 >0 && 
Ëngth
 >=†queue->maxlen) {

42 ià(
lqueue
->
maxËn_pŞicy
 =ğ
MAX_LENGTH_POLICY_REJECT
) {

43 
Ëngth
 = -1;

44 } ià(
lqueue
->
maxËn_pŞicy
 =ğ
MAX_LENGTH_POLICY_EVICT_HEAD
) {

45 
Ëngth
 >ğ
lqueue
->
maxËn
) {

46 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
lqueue
->
l
);

47 
	`dli¡D–Node
(
lqueue
->
l
,
Ê
);

48 
Ëngth
 = ()
	`dli¡L’gth
(
lqueue
->
l
);

50 
li¡
 = 
	`dli¡AddNodeTa
(
lqueue
->
l
, 
v®ue
);

51 
Ëngth
 ++;

52 } ià(
lqueue
->
maxËn_pŞicy
 =ğ
MAX_LENGTH_POLICY_EVICT_END
) {

53 
Ëngth
 >ğ
lqueue
->
maxËn
) {

54 
dli¡Node
 *
Ê
 = 
	`dli¡La¡
(
lqueue
->
l
);

55 
	`dli¡D–Node
(
lqueue
->
l
,
Ê
);

56 
Ëngth
 = ()
	`dli¡L’gth
(
lqueue
->
l
);

58 
li¡
 = 
	`dli¡AddNodeTa
(
lqueue
->
l
, 
v®ue
);

59 
Ëngth
 ++;

62 
li¡
 = 
	`dli¡AddNodeTa
(
lqueue
->
l
, 
v®ue
);

63 
Ëngth
 ++;

65 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

67 ià(
li¡
 =ğ
NULL
) {

71  
Ëngth
;

72 
	}
}

74 *
	$dlockqueue_pİ
(*
q
)

76 
dlockqueue
 *
lqueue
 = 
q
;

77 
dli¡Node
 *
node
;

78 *
v®ue
;

80 ià(
lqueue
 =ğ
NULL
 ||†queue->
l
 == NULL) {

81  
NULL
;

84 
	`±h»ad_mu‹x_lock
(&
lqueue
->
lmu‹x
);

86 
node
 = 
	`dli¡Fœ¡
(
lqueue
->
l
);

87 ià(
node
 =ğ
NULL
) {

88 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

89  
NULL
;

92 
v®ue
 = 
	`dli¡NodeV®ue
(
node
);

94 
	`dli¡D–Node
(
lqueue
->
l
, 
node
);

96 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

98  
v®ue
;

99 
	}
}

101 
	$dlockqueue_de¡roy
(*
q
)

103 
dlockqueue
 *
lqueue
 = 
q
;

104 ià(
lqueue
 =ğ
NULL
) {

108 ià(
lqueue
->
l
 !ğ
NULL
) {

109 
	`dli¡R–—£
(
lqueue
->
l
);

112 
	`±h»ad_mu‹x_de¡roy
(&
lqueue
->
lmu‹x
);

114 
	`dä“
(
lqueue
);

115 
	}
}

117 
	$dlockqueue_Ëngth
(*
q
)

119 
dlockqueue
 *
lqueue
 = 
q
;

120 
Ëngth
;

122 ià(
lqueue
 =ğ
NULL
 ||†queue->
l
 == NULL) {

126 
	`±h»ad_mu‹x_lock
(&
lqueue
->
lmu‹x
);

127 
Ëngth
 = 
	`dli¡L’gth
(
lqueue
->
l
);

128 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

130  
Ëngth
;

131 
	}
}

	@dep/dlist/dlockqueue.h

1 #iâdeà
_DLOCKQUEUE_H_


2 
	#_DLOCKQUEUE_H_


	)

4 
	gdli¡
;

6 
	sdlockqueue
{

7 
dli¡
 *
	ml
;

8 
	mmaxËn
;

9 
	mmaxËn_pŞicy
;

10 
±h»ad_mu‹x_t
 
	mlmu‹x
;

11 } 
	tdlockqueue
;

13 
dlockqueue
 *
dlockqueue_ü—‹
();

14 
dlockqueue_push
(*
q
, *
v®ue
);

15 *
dlockqueue_pİ
(*
q
);

16 
dlockqueue_de¡roy
(*
q
);

17 
dlockqueue_Ëngth
(*
q
);

	@dep/dlist/dmtqueue.c

1 
	~<¡dlib.h
>

3 
	~<dm®loc.h
>

5 
	~<dli¡.h
>

6 
	~<dmtqueue.h
>

7 
	~<dlockqueue.h
>

10 
dmtqueue
 *
	$dmtqueue_ü—‹
()

12 
dmtqueue
 *
q
;

14 
q
 = 
	`d®loc
((*q));

15 ià(
q
 =ğ
NULL
) {

16  
NULL
;

19 
q
->
l
 = 
NULL
;

20 
q
->
lock_push
 = 
NULL
;

21 
q
->
lock_pİ
 = 
NULL
;

22 
q
->
de¡roy
 = 
NULL
;

23 
q
->
Ëngth
 = 
NULL
;

25  
q
;

26 
	}
}

28 
	$dmtqueue_de¡roy
(
dmtqueue
 *
q
)

30 ià(
q
 =ğ
NULL
) {

34 ià(
q
->
de¡roy
) {

35 
q
->
	`de¡roy
(q->
l
);

38 
	`dä“
(
q
);

39 
	}
}

41 
	$dmtqueue_push
(
dmtqueue
 *
q
, *
v®ue
)

43 if(
q
 =ğ
NULL
 || q->
l
 == NULL

44 || 
q
->
lock_push
 =ğ
NULL
)

49  
q
->
	`lock_push
(q->
l
, 
v®ue
);

50 
	}
}

52 *
	$dmtqueue_pİ
(
dmtqueue
 *
q
)

54 if(
q
 =ğ
NULL
 || q->
l
 == NULL

55 || 
q
->
lock_pİ
 =ğ
NULL
)

57  
NULL
;

60  
q
->
	`lock_pİ
(q->
l
);

61 
	}
}

63 
	$dmtqueue_em±y
(
dmtqueue
 *
q
)

65 if(
q
 =ğ
NULL
 || q->
l
 == NULL

66 || 
q
->
Ëngth
 =ğ
NULL
)

71 if(
q
->
	`Ëngth
(q->
l
) > 0)

77 
	}
}

79 
	$dmtqueue_Ëngth
(
dmtqueue
 *
q
)

81 if(
q
 =ğ
NULL
 || q->
l
 == NULL

82 || 
q
->
Ëngth
 =ğ
NULL
)

87  
q
->
	`Ëngth
(q->
l
);

88 
	}
}

96 
	$dmtqueue_š™_w™h_lockqueue
(
dmtqueue
 *
q
, 
dlockqueue_ä“func
 
ä“func
)

98 
dlockqueue
 *
lq
;

100 ià(
q
 =ğ
NULL
) {

104 
lq
 = 
	`dlockqueue_ü—‹
();

105 ià(
lq
 =ğ
NULL
) {

109 
lq
->
l
->
ä“
 = 
ä“func
;

111 
q
->
l
 = 
lq
;

112 
q
->
lock_push
 = 
dlockqueue_push
;

113 
q
->
lock_pİ
 = 
dlockqueue_pİ
;

114 
q
->
de¡roy
 = 
dlockqueue_de¡roy
;

115 
q
->
Ëngth
 = 
dlockqueue_Ëngth
;

118 
	}
}

	@dep/dlist/dmtqueue.h

1 #iâdeà
_DMTQUEUE_H_


2 
	#_DMTQUEUE_H_


	)

4 
	#MAX_LENGTH_POLICY_REJECT
 0

	)

5 
	#MAX_LENGTH_POLICY_EVICT_HEAD
 1

	)

6 
	#MAX_LENGTH_POLICY_EVICT_END
 2

	)

9 
	sdmtqueue
{

10 *
	ml
;

11 (*
	mlock_push
)(*
	mq
, *
	mv®ue
);

12 *(*
	mlock_pİ
)(*
	mq
);

13 (*
	mde¡roy
)(*
	mq
);

14 (*
	mËngth
)(*
	mq
);

15 } 
	tdmtqueue
;

17 
	#dmtqueueS‘MaxËngth
(
q
,
l
è((q)->l->
maxËn
 = (l))

	)

18 
	#dmtqueueS‘MaxËngthPŞicy
(
q
,
p
è((q)->
l
->
maxËn
 = (p))

	)

20 (*
	tdmtqueue_š™
)(
	tdmtqueue
 *);

24 
dmtqueue
 *
	`dmtqueue_ü—‹
();

25 
	`dmtqueue_de¡roy
(
dmtqueue
 *
q
);

26 
	`dmtqueue_push
(
dmtqueue
 *
q
, *
v®ue
);

27 *
	`dmtqueue_pİ
(
dmtqueue
 *
q
);

28 
	`dmtqueue_em±y
(
dmtqueue
 *
q
);

29 
	`dmtqueue_Ëngth
(
dmtqueue
 *
q
);

33 (*
	tdlockqueue_ä“func
)(*);

34 
	`dmtqueue_š™_w™h_lockqueue
(
dmtqueue
 *
l
, 
dlockqueue_ä“func
 
ä“func
);

	@dep/dmalloc/dmalloc.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<”ºo.h
>

5 
	~<±h»ad.h
>

7 
	~<uni¡d.h
>

9 
	~<dut.h
>

10 
	~<dlog.h
>

12 
	~<dm®loc.h
>

15 
size_t
 
	gu£d_memÜy
 = 0;

16 
±h»ad_mu‹x_t
 
	gu£d_memÜy_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

18 #ià
defšed
(
__ATOMIC_RELAXED
)

19 
	#upd©e_u£d_mem_¡©_add
(
__n
è
	`__©omic_add_ãtch
(&
u£d_memÜy
, (__n), 
__ATOMIC_RELAXED
)

	)

20 
	#upd©e_u£d_mem_¡©_sub
(
__n
è
	`__©omic_sub_ãtch
(&
u£d_memÜy
, (__n), 
__ATOMIC_RELAXED
)

	)

21 *
	$m®loc_lock_ty³
(è{ "__ATOMIC_RELAXED";
	}
}

22 #–ià
defšed
(
HAVE_ATOMIC
)

23 
	#upd©e_u£d_mem_¡©_add
(
__n
è
	`__sync_add_ªd_ãtch
(&
u£d_memÜy
, (__n))

	)

24 
	#upd©e_u£d_mem_¡©_sub
(
__n
è
	`__sync_sub_ªd_ãtch
(&
u£d_memÜy
, (__n))

	)

25 *
	$m®loc_lock_ty³
(è{ "HAVE_ATOMIC";
	}
}

27 
	#upd©e_u£d_mem_¡©_add
(
__n
) do { \

28 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
); \

29 
u£d_memÜy
 +ğ(
__n
); \

30 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
); \

31 } 0)

	)

33 
	#upd©e_u£d_mem_¡©_sub
(
__n
) do { \

34 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
); \

35 
u£d_memÜy
 -ğ(
__n
); \

36 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
); \

37 } 0)

	)

39 *
	$m®loc_lock_ty³
(è{ "±h»ad_mu‹x_t";
	}
}

42 
	#upd©e_dm®loc_¡©_®loc
(
__n
) do { \

43 
size_t
 
_n
 = (
__n
); \

44 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

45 
	`upd©e_u£d_mem_¡©_add
(
_n
); \

46 } 0)

	)

48 
	#upd©e_dm®loc_¡©_ä“
(
__n
) do { \

49 
size_t
 
_n
 = (
__n
); \

50 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

51 
	`upd©e_u£d_mem_¡©_sub
(
_n
); \

52 } 0)

	)

54 #ifdeà
HAVE_MALLOC_SIZE


55 
	#PREFIX_SIZE
 (0)

	)

57 #ià
defšed
(
__sun
è|| defšed(
__¥¬c
è|| defšed(
__¥¬c__
)

58 
	#PREFIX_SIZE
 (())

	)

60 
	#PREFIX_SIZE
 ((
size_t
))

	)

67 #iâdeà
HAVE_MALLOC_SIZE


68 
size_t
 
	$dm®loc_size
(*
±r
) {

69 *
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

70 
size_t
 
size
 = *((size_t*)
»®±r
);

73 ià(
size
&(()-1)) size += ()-(size&(()-1));

74  
size
+
PREFIX_SIZE
;

75 
	}
}

79 
	$_d®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
)

81 *
p
;

83 
	`ASSERT
(
size
 != 0);

85 #ifdeà
DUSE_JEMALLOC


86 
p
 = 
	`je_m®loc
(
size
+
PREFIX_SIZE
);

88 
p
 = 
	`m®loc
(
size
+
PREFIX_SIZE
);

90 ià(
p
 =ğ
NULL
) {

91 
	`log_”rÜ
("m®loc(%zuèçed @ %s:%d", 
size
, 
Çme
, 
lše
);

93 #ifdeà
HAVE_MALLOC_SIZE


94 
	`upd©e_dm®loc_¡©_®loc
(
	`dm®loc_size
(
p
));

95  
p
;

97 *((
size_t
*)
p
èğ
size
;

98 
	`upd©e_dm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

99  (*)
p
+
PREFIX_SIZE
;

101 
	`log_debug
(
LOG_VVERB
, "m®loc(%zuè© %°@ %s:%d", 
size
, 
p
, 
Çme
, 
lše
);

104  
p
;

105 
	}
}

108 
	$_dz®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
)

110 *
p
;

112 
p
 = 
	`_d®loc
(
size
, 
Çme
, 
lše
);

113 ià(
p
 !ğ
NULL
) {

114 
	`mem£t
(
p
, 0, 
size
);

117  
p
;

118 
	}
}

121 
	$_dÿÎoc
(
size_t
 
nmemb
, size_ˆ
size
, cÚ¡ *
Çme
, 
lše
)

123  
	`_dz®loc
(
nmemb
 * 
size
, 
Çme
, 
lše
);

124 
	}
}

127 
	$_d»®loc
(*
±r
, 
size_t
 
size
, cÚ¡ *
Çme
, 
lše
)

129 #iâdeà
HAVE_MALLOC_SIZE


130 *
»®p
;

132 *
p
;

133 
size_t
 
Şdsize
;

135 
	`ASSERT
(
size
 != 0);

137 ià(
±r
 =ğ
NULL
è 
	`_d®loc
(
size
, 
Çme
, 
lše
);

139 #ifdeà
HAVE_MALLOC_SIZE


140 
Şdsize
 = 
	`dm®loc_size
(
±r
);

141 #ifdeà
DUSE_JEMALLOC


142 
p
 = 
	`je_»®loc
(
±r
, 
size
);

144 
p
 = 
	`»®loc
(
±r
, 
size
);

147 
»®p
 = (*)
±r
-
PREFIX_SIZE
;

148 
Şdsize
 = *((
size_t
*)
»®p
);

149 #ifdeà
DUSE_JEMALLOC


150 
p
 = 
	`je_»®loc
(
±r
, 
size
+
PREFIX_SIZE
);

152 
p
 = 
	`»®loc
(
±r
, 
size
+
PREFIX_SIZE
);

155 ià(
p
 =ğ
NULL
) {

156 
	`log_”rÜ
("»®loc(%zuèçed @ %s:%d", 
size
, 
Çme
, 
lše
);

157  
NULL
;

159 
	`log_debug
(
LOG_VVERB
, "»®loc(%zuè© %°@ %s:%d", 
size
, 
p
, 
Çme
, 
lše
);

160 #ifdeà
HAVE_MALLOC_SIZE


161 
	`upd©e_dm®loc_¡©_ä“
(
Şdsize
);

162 
	`upd©e_dm®loc_¡©_®loc
(
	`dm®loc_size
(
p
));

163  
p
;

165 *((
size_t
*)
p
èğ
size
;

166 
	`upd©e_dm®loc_¡©_ä“
(
Şdsize
);

167 
	`upd©e_dm®loc_¡©_®loc
(
size
);

168  
p
+
PREFIX_SIZE
;

172  
NULL
;

173 
	}
}

176 
	$_dä“
(*
±r
, cÚ¡ *
Çme
, 
lše
)

178 #iâdeà
HAVE_MALLOC_SIZE


179 *
»®p
;

180 
size_t
 
Şdsize
;

183 
	`ASSERT
(
±r
 !ğ
NULL
);

184 
	`log_debug
(
LOG_VVERB
, "ä“(%pè@ %s:%d", 
±r
, 
Çme
, 
lše
);

186 #ifdeà
HAVE_MALLOC_SIZE


187 
	`upd©e_dm®loc_¡©_ä“
(
	`dm®loc_size
(
±r
));

188 #ifdeà
DUSE_JEMALLOC


189 
	`je_ä“
(
±r
);

191 
	`ä“
(
±r
);

194 
»®p
 = (*)
±r
-
PREFIX_SIZE
;

195 
Şdsize
 = *((
size_t
*)
»®p
);

196 
	`upd©e_dm®loc_¡©_ä“
(
Şdsize
+
PREFIX_SIZE
);

197 
	`ä“
(
»®p
);

198 #ifdeà
DUSE_JEMALLOC


199 
	`je_ä“
(
»®p
);

201 
	`ä“
(
»®p
);

204 
	}
}

206 
size_t


207 
	$d®loc_u£d_memÜy
()

209 
size_t
 
um
;

211 #ià
	`defšed
(
__ATOMIC_RELAXED
è|| defšed(
HAVE_ATOMIC
)

212 
um
 = 
	`upd©e_u£d_mem_¡©_add
(0);

214 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
);

215 
um
 = 
u£d_memÜy
;

216 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
);

219  
um
;

220 
	}
}

235 
size_t
 
	$d®loc_g‘_memÜy_size
() {

236 #ià
	`defšed
(
__unix__
è|| defšed(
__unix
è|| defšed(
unix
) || \

237 (
	`defšed
(
__APPLE__
è&& defšed(
__MACH__
))

238 #ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_MEMSIZE
è|| defšed(
HW_PHYSMEM64
))

239 
mib
[2];

240 
mib
[0] = 
CTL_HW
;

241 #ià
	`defšed
(
HW_MEMSIZE
)

242 
mib
[1] = 
HW_MEMSIZE
;

243 #–ià
	`defšed
(
HW_PHYSMEM64
)

244 
mib
[1] = 
HW_PHYSMEM64
;

246 
št64_t
 
size
 = 0;

247 
size_t
 
Ën
 = (
size
);

248 ià(
	`sysùl
Ğ
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

249  (
size_t
)
size
;

252 #–ià
	`defšed
(
_SC_PHYS_PAGES
è&& defšed(
_SC_PAGESIZE
)

254  (
size_t
)
	`syscÚf
(
_SC_PHYS_PAGES
è* (size_t)syscÚf(
_SC_PAGESIZE
);

256 #–ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_PHYSMEM
è|| defšed(
HW_REALMEM
))

258 
mib
[2];

259 
mib
[0] = 
CTL_HW
;

260 #ià
	`defšed
(
HW_REALMEM
)

261 
mib
[1] = 
HW_REALMEM
;

262 #–ià
	`defšed
(
HW_PYSMEM
)

263 
mib
[1] = 
HW_PHYSMEM
;

265 
size
 = 0;

266 
size_t
 
Ën
 = (
size
);

267 ià(
	`sysùl
(
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

268  (
size_t
)
size
;

275 
	}
}

287 #ià
defšed
(
HAVE_PROC_STAT
)

288 
	~<uni¡d.h
>

289 
	~<sys/ty³s.h
>

290 
	~<sys/¡©.h
>

291 
	~<fú.h
>

293 
size_t
 
	$d®loc_g‘_rss
() {

294 
·ge
 = 
	`syscÚf
(
_SC_PAGESIZE
);

295 
size_t
 
rss
;

296 
buf
[4096];

297 
f’ame
[256];

298 
fd
, 
couÁ
;

299 *
p
, *
x
;

301 
	`¢´štf
(
f’ame
,256,"/´oc/%d/¡©",
	`g‘pid
());

302 ià((
fd
 = 
	`İ’
(
f’ame
,
O_RDONLY
)) == -1)  0;

303 ià(
	`»ad
(
fd
,
buf
,4096) <= 0) {

304 
	`şo£
(
fd
);

307 
	`şo£
(
fd
);

309 
p
 = 
buf
;

310 
couÁ
 = 23;

311 
p
 && 
couÁ
--) {

312 
p
 = 
	`¡rchr
(p,' ');

313 ià(
p
)…++;

315 ià(!
p
)  0;

316 
x
 = 
	`¡rchr
(
p
,' ');

317 ià(!
x
)  0;

318 *
x
 = '\0';

320 
rss
 = 
	`¡¹Şl
(
p
,
NULL
,10);

321 
rss
 *ğ
·ge
;

322  
rss
;

323 
	}
}

324 #–ià
defšed
(
HAVE_TASKINFO
)

325 
	~<uni¡d.h
>

326 
	~<¡dio.h
>

327 
	~<¡dlib.h
>

328 
	~<sys/ty³s.h
>

329 
	~<sys/sysùl.h
>

330 
	~<mach/sk.h
>

331 
	~<mach/mach_š™.h
>

333 
size_t
 
	$d®loc_g‘_rss
() {

334 
sk_t
 
sk
 = 
MACH_PORT_NULL
;

335 
sk_basic_šfo
 
t_šfo
;

336 
mach_msg_ty³_numb”_t
 
t_šfo_couÁ
 = 
TASK_BASIC_INFO_COUNT
;

338 ià(
	`sk_fÜ_pid
(
	`cu¼’t_sk
(), 
	`g‘pid
(), &
sk
è!ğ
KERN_SUCCESS
)

340 
	`sk_šfo
(
sk
, 
TASK_BASIC_INFO
, (
sk_šfo_t
)&
t_šfo
, &
t_šfo_couÁ
);

342  
t_šfo
.
»sid’t_size
;

343 
	}
}

345 
size_t
 
	$d®loc_g‘_rss
() {

351  
	`d®loc_u£d_memÜy
();

352 
	}
}

356 
	$d®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
) {

357  ()
rss
/
	`d®loc_u£d_memÜy
();

358 
	}
}

	@dep/dmalloc/dmalloc.h

1 #iâdeà
_DMALLOC_H_


2 
	#_DMALLOC_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	~<d¥ecŸlcÚfig.h
>

10 #ifdeà
HAVE_JEMALLOC


11 
	#DUSE_JEMALLOC
 1

	)

20 #ià
defšed
(
DUSE_JEMALLOC
)

21 
	#DMALLOC_LIB
 ("jem®loc-" 
	`__x¡r
(
JEMALLOC_VERSION_MAJOR
è"." __x¡r(
JEMALLOC_VERSION_MINOR
è"." __x¡r(
JEMALLOC_VERSION_BUGFIX
))

	)

22 
	~<jem®loc/jem®loc.h
>

23 #ià(
JEMALLOC_VERSION_MAJOR
 =ğ2 && 
JEMALLOC_VERSION_MINOR
 >= 1) || (JEMALLOC_VERSION_MAJOR > 2)

24 
	#HAVE_MALLOC_SIZE
 1

	)

25 
	#dm®loc_size
(
p
è
	`je_m®loc_u§bË_size
Õ)

	)

29 #–ià
defšed
(
__APPLE__
)

30 
	~<m®loc/m®loc.h
>

31 
	#HAVE_MALLOC_SIZE
 1

	)

32 
	#dm®loc_size
(
p
è
	`m®loc_size
Õ)

	)

35 #iâdeà
DMALLOC_LIB


36 
	#DMALLOC_LIB
 "libc"

	)

39 
	#d®loc
(
_s
) \

40 
	`_d®loc
((
size_t
)(
_s
), 
__FILE__
, 
__LINE__
)

	)

42 
	#dz®loc
(
_s
) \

43 
	`_dz®loc
((
size_t
)(
_s
), 
__FILE__
, 
__LINE__
)

	)

45 
	#dÿÎoc
(
_n
, 
_s
) \

46 
	`_dÿÎoc
((
size_t
)(
_n
), (size_t)(
_s
), 
__FILE__
, 
__LINE__
)

	)

48 
	#d»®loc
(
_p
, 
_s
) \

49 
	`_d»®loc
(
_p
, (
size_t
)(
_s
), 
__FILE__
, 
__LINE__
)

	)

51 
	#dä“
(
_p
) do { \

52 
	`_dä“
(
_p
, 
__FILE__
, 
__LINE__
); \

53 } 0)

	)

55 *
dm®loc_lock_ty³
();

57 #iâdeà
HAVE_MALLOC_SIZE


58 
size_t
 
dm®loc_size
(*
±r
);

61 *
_d®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
);

62 *
_dz®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
);

63 *
_dÿÎoc
(
size_t
 
nmemb
, size_ˆ
size
, cÚ¡ *
Çme
, 
lše
);

64 *
_d»®loc
(*
±r
, 
size_t
 
size
, cÚ¡ *
Çme
, 
lše
);

65 
_dä“
(*
±r
, cÚ¡ *
Çme
, 
lše
);

67 
size_t
 
d®loc_u£d_memÜy
();

69 
size_t
 
d®loc_g‘_memÜy_size
();

71 
size_t
 
d®loc_g‘_rss
();

72 
d®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
);

	@dep/himemcached-0.1.0/himcdep/sds.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 
	~<ùy³.h
>

35 
	~<as£¹.h
>

37 
	~"sds.h
"

51 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

52 
sdshdr
 *
sh
;

54 ià(
š™
) {

55 
sh
 = 
	`m®loc
( *sh+
š™Ën
+1);

57 
sh
 = 
	`ÿÎoc
( *sh+
š™Ën
+1,1);

59 ià(
sh
 =ğ
NULL
)  NULL;

60 
sh
->
Ën
 = 
š™Ën
;

61 
sh
->
ä“
 = 0;

62 ià(
š™Ën
 && 
š™
)

63 
	`memıy
(
sh
->
buf
, 
š™
, 
š™Ën
);

64 
sh
->
buf
[
š™Ën
] = '\0';

65  (*)
sh
->
buf
;

66 
	}
}

70 
sds
 
	$sd£m±y
() {

71  
	`sd¢ewËn
("",0);

72 
	}
}

75 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

76 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

77  
	`sd¢ewËn
(
š™
, 
š™Ën
);

78 
	}
}

81 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

82  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

83 
	}
}

86 
	$sdsä“
(
sds
 
s
) {

87 ià(
s
 =ğ
NULL
) ;

88 
	`ä“
(
s
-(
sdshdr
));

89 
	}
}

105 
	$sdsupd©–’
(
sds
 
s
) {

106 
sdshdr
 *
sh
 = (*è(
s
- *sh);

107 
»®Ën
 = 
	`¡¾’
(
s
);

108 
sh
->
ä“
 +ğ(sh->
Ën
-
»®Ën
);

109 
sh
->
Ën
 = 
»®Ën
;

110 
	}
}

116 
	$sdsş—r
(
sds
 
s
) {

117 
sdshdr
 *
sh
 = (*è(
s
- *sh);

118 
sh
->
ä“
 +ğsh->
Ën
;

119 
sh
->
Ën
 = 0;

120 
sh
->
buf
[0] = '\0';

121 
	}
}

129 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

130 
sdshdr
 *
sh
, *
Ãwsh
;

131 
size_t
 
ä“
 = 
	`sd§va
(
s
);

132 
size_t
 
Ën
, 
ÃwËn
;

134 ià(
ä“
 >ğ
addËn
è 
s
;

135 
Ën
 = 
	`sd¦’
(
s
);

136 
sh
 = (*è(
s
- *sh);

137 
ÃwËn
 = (
Ën
+
addËn
);

138 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

139 
ÃwËn
 *= 2;

141 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

142 
Ãwsh
 = 
	`»®loc
(
sh
,  *Ãwsh+
ÃwËn
+1);

143 ià(
Ãwsh
 =ğ
NULL
)  NULL;

145 
Ãwsh
->
ä“
 = 
ÃwËn
 - 
Ën
;

146  
Ãwsh
->
buf
;

147 
	}
}

155 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

156 
sdshdr
 *
sh
;

158 
sh
 = (*è(
s
- *sh);

159 
sh
 = 
	`»®loc
(sh,  *sh+sh->
Ën
+1);

160 
sh
->
ä“
 = 0;

161  
sh
->
buf
;

162 
	}
}

171 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

172 
sdshdr
 *
sh
 = (*è(
s
- *sh);

174  (*
sh
)+sh->
Ën
+sh->
ä“
+1;

175 
	}
}

200 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

201 
sdshdr
 *
sh
 = (*è(
s
- *sh);

203 
	`as£¹
(
sh
->
ä“
 >ğ
šü
);

204 
sh
->
Ën
 +ğ
šü
;

205 
sh
->
ä“
 -ğ
šü
;

206 
	`as£¹
(
sh
->
ä“
 >= 0);

207 
s
[
sh
->
Ën
] = '\0';

208 
	}
}

215 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

216 
sdshdr
 *
sh
 = (*è(
s
- *sh);

217 
size_t
 
tÙËn
, 
cu¾’
 = 
sh
->
Ën
;

219 ià(
Ën
 <ğ
cu¾’
è 
s
;

220 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

221 ià(
s
 =ğ
NULL
)  NULL;

224 
sh
 = (*)(
s
- *sh);

225 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

226 
tÙËn
 = 
sh
->
Ën
+sh->
ä“
;

227 
sh
->
Ën
 =†en;

228 
sh
->
ä“
 = 
tÙËn
-sh->
Ën
;

229  
s
;

230 
	}
}

237 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

238 
sdshdr
 *
sh
;

239 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

241 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

242 ià(
s
 =ğ
NULL
)  NULL;

243 
sh
 = (*è(
s
- *sh);

244 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

245 
sh
->
Ën
 = 
cu¾’
+len;

246 
sh
->
ä“
 = sh->ä“-
Ën
;

247 
s
[
cu¾’
+
Ën
] = '\0';

248  
s
;

249 
	}
}

255 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

256  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

257 
	}
}

263 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

264  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

265 
	}
}

269 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

270 
sdshdr
 *
sh
 = (*è(
s
- *sh);

271 
size_t
 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

273 ià(
tÙËn
 < 
Ën
) {

274 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
sh
->len);

275 ià(
s
 =ğ
NULL
)  NULL;

276 
sh
 = (*è(
s
- *sh);

277 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

279 
	`memıy
(
s
, 
t
, 
Ën
);

280 
s
[
Ën
] = '\0';

281 
sh
->
Ën
 =†en;

282 
sh
->
ä“
 = 
tÙËn
-
Ën
;

283  
s
;

284 
	}
}

288 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

289  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

290 
	}
}

298 
	#SDS_LLSTR_SIZE
 21

	)

299 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

300 *
p
, 
aux
;

301 
v
;

302 
size_t
 
l
;

306 
v
 = (
v®ue
 < 0) ? -value : value;

307 
p
 = 
s
;

309 *
p
++ = '0'+(
v
%10);

310 
v
 /= 10;

311 } 
v
);

312 ià(
v®ue
 < 0è*
p
++ = '-';

315 
l
 = 
p
-
s
;

316 *
p
 = '\0';

319 
p
--;

320 
s
 < 
p
) {

321 
aux
 = *
s
;

322 *
s
 = *
p
;

323 *
p
 = 
aux
;

324 
s
++;

325 
p
--;

327  
l
;

328 
	}
}

331 
	$sdsuÎ2¡r
(*
s
, 
v
) {

332 *
p
, 
aux
;

333 
size_t
 
l
;

337 
p
 = 
s
;

339 *
p
++ = '0'+(
v
%10);

340 
v
 /= 10;

341 } 
v
);

344 
l
 = 
p
-
s
;

345 *
p
 = '\0';

348 
p
--;

349 
s
 < 
p
) {

350 
aux
 = *
s
;

351 *
s
 = *
p
;

352 *
p
 = 
aux
;

353 
s
++;

354 
p
--;

356  
l
;

357 
	}
}

360 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

361 
va_li¡
 
ıy
;

362 *
buf
, *
t
;

363 
size_t
 
buæ’
 = 16;

366 
buf
 = 
	`m®loc
(
buæ’
);

367 ià(
buf
 =ğ
NULL
)  NULL;

368 
buf
[
buæ’
-2] = '\0';

369 
	`va_cİy
(
ıy
,
­
);

370 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

371 ià(
buf
[
buæ’
-2] != '\0') {

372 
	`ä“
(
buf
);

373 
buæ’
 *= 2;

378 
t
 = 
	`sdsÿt
(
s
, 
buf
);

379 
	`ä“
(
buf
);

380  
t
;

381 
	}
}

399 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

400 
va_li¡
 
­
;

401 *
t
;

402 
	`va_¡¬t
(
­
, 
fmt
);

403 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

404 
	`va_’d
(
­
);

405  
t
;

406 
	}
}

425 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

426 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

427 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

428 cÚ¡ *
f
 = 
fmt
;

429 
i
;

430 
va_li¡
 
­
;

432 
	`va_¡¬t
(
­
,
fmt
);

433 
f
 = 
fmt
;

434 
i
 = 
š™Ën
;

435 *
f
) {

436 
Ãxt
, *
¡r
;

437 
l
;

438 
num
;

439 
unum
;

442 ià(
sh
->
ä“
 == 0) {

443 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

444 
sh
 = (*è(
s
-((
sdshdr
)));

447 *
f
) {

449 
Ãxt
 = *(
f
+1);

450 
f
++;

451 
Ãxt
) {

454 
¡r
 = 
	`va_¬g
(
­
,*);

455 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

456 ià(
sh
->
ä“
 < 
l
) {

457 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

458 
sh
 = (*è(
s
-((
sdshdr
)));

460 
	`memıy
(
s
+
i
,
¡r
,
l
);

461 
sh
->
Ën
 +ğ
l
;

462 
sh
->
ä“
 -ğ
l
;

463 
i
 +ğ
l
;

467 ià(
Ãxt
 == 'i')

468 
num
 = 
	`va_¬g
(
­
,);

470 
num
 = 
	`va_¬g
(
­
,);

472 
buf
[
SDS_LLSTR_SIZE
];

473 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

474 ià(
sh
->
ä“
 < 
l
) {

475 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

476 
sh
 = (*è(
s
-((
sdshdr
)));

478 
	`memıy
(
s
+
i
,
buf
,
l
);

479 
sh
->
Ën
 +ğ
l
;

480 
sh
->
ä“
 -ğ
l
;

481 
i
 +ğ
l
;

487 ià(
Ãxt
 == 'u')

488 
unum
 = 
	`va_¬g
(
­
,);

489 if(
Ãxt
 == 'U')

490 
unum
 = 
	`va_¬g
(
­
,);

492 
unum
 = ()
	`va_¬g
(
­
,
size_t
);

494 
buf
[
SDS_LLSTR_SIZE
];

495 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

496 ià(
sh
->
ä“
 < 
l
) {

497 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

498 
sh
 = (*è(
s
-((
sdshdr
)));

500 
	`memıy
(
s
+
i
,
buf
,
l
);

501 
sh
->
Ën
 +ğ
l
;

502 
sh
->
ä“
 -ğ
l
;

503 
i
 +ğ
l
;

507 
s
[
i
++] = 
Ãxt
;

508 
sh
->
Ën
 += 1;

509 
sh
->
ä“
 -= 1;

514 
s
[
i
++] = *
f
;

515 
sh
->
Ën
 += 1;

516 
sh
->
ä“
 -= 1;

519 
f
++;

521 
	`va_’d
(
­
);

524 
s
[
i
] = '\0';

525  
s
;

526 
	}
}

543 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

544 
sdshdr
 *
sh
 = (*è(
s
- *sh);

545 *
¡¬t
, *
’d
, *
¥
, *
•
;

546 
size_t
 
Ën
;

548 
¥
 = 
¡¬t
 = 
s
;

549 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

550 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

551 
•
 > 
¡¬t
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

552 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

553 ià(
sh
->
buf
 !ğ
¥
è
	`memmove
(sh->buf, sp, 
Ën
);

554 
sh
->
buf
[
Ën
] = '\0';

555 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-len);

556 
sh
->
Ën
 =†en;

557 
	}
}

575 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

576 
sdshdr
 *
sh
 = (*è(
s
- *sh);

577 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

579 ià(
Ën
 == 0) ;

580 ià(
¡¬t
 < 0) {

581 
¡¬t
 = 
Ën
+start;

582 ià(
¡¬t
 < 0) start = 0;

584 ià(
’d
 < 0) {

585 
’d
 = 
Ën
+end;

586 ià(
’d
 < 0)ƒnd = 0;

588 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

589 ià(
ÃwËn
 != 0) {

590 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

591 
ÃwËn
 = 0;

592 } ià(
’d
 >ğ(sigÃd)
Ën
) {

593 
’d
 = 
Ën
-1;

594 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

597 
¡¬t
 = 0;

599 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
sh
->
buf
, sh->buf+start,‚ewlen);

600 
sh
->
buf
[
ÃwËn
] = 0;

601 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-
ÃwËn
);

602 
sh
->
Ën
 = 
ÃwËn
;

603 
	}
}

606 
	$sd¡Şow”
(
sds
 
s
) {

607 
Ën
 = 
	`sd¦’
(
s
), 
j
;

609 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

610 
	}
}

613 
	$sd¡ouµ”
(
sds
 
s
) {

614 
Ën
 = 
	`sd¦’
(
s
), 
j
;

616 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

617 
	}
}

630 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

631 
size_t
 
l1
, 
l2
, 
mšËn
;

632 
cmp
;

634 
l1
 = 
	`sd¦’
(
s1
);

635 
l2
 = 
	`sd¦’
(
s2
);

636 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

637 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

638 ià(
cmp
 =ğ0è 
l1
-
l2
;

639  
cmp
;

640 
	}
}

658 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

659 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

660 
sds
 *
tok’s
;

662 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

664 
tok’s
 = 
	`m®loc
((
sds
)*
¦Ùs
);

665 ià(
tok’s
 =ğ
NULL
)  NULL;

667 ià(
Ën
 == 0) {

668 *
couÁ
 = 0;

669  
tok’s
;

671 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

673 ià(
¦Ùs
 < 
–em’ts
+2) {

674 
sds
 *
Ãwtok’s
;

676 
¦Ùs
 *= 2;

677 
Ãwtok’s
 = 
	`»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

678 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

679 
tok’s
 = 
Ãwtok’s
;

682 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

683 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

684 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

685 
–em’ts
++;

686 
¡¬t
 = 
j
+
£¶’
;

687 
j
 = j+
£¶’
-1;

691 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

692 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

693 
–em’ts
++;

694 *
couÁ
 = 
–em’ts
;

695  
tok’s
;

697 
ş—nup
:

699 
i
;

700 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

701 
	`ä“
(
tok’s
);

702 *
couÁ
 = 0;

703  
NULL
;

705 
	}
}

708 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

709 ià(!
tok’s
) ;

710 
couÁ
--)

711 
	`sdsä“
(
tok’s
[
couÁ
]);

712 
	`ä“
(
tok’s
);

713 
	}
}

719 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

720 
buf
[32], *
p
;

721 
v
;

723 
v
 = (
v®ue
 < 0) ? -value : value;

724 
p
 = 
buf
+31;

726 *
p
-- = '0'+(
v
%10);

727 
v
 /= 10;

728 } 
v
);

729 ià(
v®ue
 < 0è*
p
-- = '-';

730 
p
++;

731  
	`sd¢ewËn
(
p
,32-Õ-
buf
));

732 
	}
}

740 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

741 
s
 = 
	`sdsÿ’
(s,"\"",1);

742 
Ën
--) {

743 *
p
) {

746 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

748 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

749 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

750 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

751 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

752 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

754 ià(
	`i¥ršt
(*
p
))

755 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

757 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

760 
p
++;

762  
	`sdsÿ’
(
s
,"\"",1);

763 
	}
}

767 
	$is_hex_dig™
(
c
) {

768  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

769 (
c
 >= 'A' && c <= 'F');

770 
	}
}

774 
	$hex_dig™_to_št
(
c
) {

775 
c
) {

794 
	}
}

815 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

816 cÚ¡ *
p
 = 
lše
;

817 *
cu¼’t
 = 
NULL
;

818 **
veùÜ
 = 
NULL
;

820 *
¬gc
 = 0;

823 *
p
 && 
	`is¥aû
(*p))…++;

824 ià(*
p
) {

826 
šq
=0;

827 
šsq
=0;

828 
dÚe
=0;

830 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

831 !
dÚe
) {

832 ià(
šq
) {

833 ià(*
p
 == '\\' && *(p+1) == 'x' &&

834 
	`is_hex_dig™
(*(
p
+2)) &&

835 
	`is_hex_dig™
(*(
p
+3)))

837 
by‹
;

839 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

840 
	`hex_dig™_to_št
(*(
p
+3));

841 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

842 
p
 += 3;

843 } ià(*
p
 == '\\' && *(p+1)) {

844 
c
;

846 
p
++;

847 *
p
) {

848 'n': 
c
 = '\n'; ;

849 'r': 
c
 = '\r'; ;

850 't': 
c
 = '\t'; ;

851 'b': 
c
 = '\b'; ;

852 'a': 
c
 = '\a'; ;

853 : 
c
 = *
p
; ;

855 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

856 } ià(*
p
 == '"') {

859 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

860 
dÚe
=1;

861 } ià(!*
p
) {

863 
”r
;

865 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

867 } ià(
šsq
) {

868 ià(*
p
 == '\\' && *(p+1) == '\'') {

869 
p
++;

870 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

871 } ià(*
p
 == '\'') {

874 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

875 
dÚe
=1;

876 } ià(!*
p
) {

878 
”r
;

880 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

883 *
p
) {

889 
dÚe
=1;

892 
šq
=1;

895 
šsq
=1;

898 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

902 ià(*
p
)…++;

905 
veùÜ
 = 
	`»®loc
(veùÜ,((*
¬gc
)+1)*(*));

906 
veùÜ
[*
¬gc
] = 
cu¼’t
;

907 (*
¬gc
)++;

908 
cu¼’t
 = 
NULL
;

911 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`m®loc
((*));

912  
veùÜ
;

916 
”r
:

917 (*
¬gc
)--)

918 
	`sdsä“
(
veùÜ
[*
¬gc
]);

919 
	`ä“
(
veùÜ
);

920 ià(
cu¼’t
è
	`sdsä“
(current);

921 *
¬gc
 = 0;

922  
NULL
;

923 
	}
}

934 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

935 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

937 
j
 = 0; j < 
l
; j++) {

938 
i
 = 0; i < 
£’
; i++) {

939 ià(
s
[
j
] =ğ
äom
[
i
]) {

940 
s
[
j
] = 
to
[
i
];

945  
s
;

946 
	}
}

950 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
, 
size_t
 
£¶’
) {

951 
sds
 
još
 = 
	`sd£m±y
();

952 
j
;

954 
j
 = 0; j < 
¬gc
; j++) {

955 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

956 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

958  
još
;

959 
	}
}

962 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

963 
sds
 
još
 = 
	`sd£m±y
();

964 
j
;

966 
j
 = 0; j < 
¬gc
; j++) {

967 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

968 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

970  
još
;

971 
	}
}

973 #ifdeà
SDS_TEST_MAIN


974 
	~<¡dio.h
>

975 
	~"‹¡h–p.h
"

977 
	$maš
() {

979 
sdshdr
 *
sh
;

980 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

982 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

983 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

985 
	`sdsä“
(
x
);

986 
x
 = 
	`sd¢ewËn
("foo",2);

987 
	`‹¡_cÚd
("Create‡ string with specified†ength",

988 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

990 
x
 = 
	`sdsÿt
(x,"bar");

991 
	`‹¡_cÚd
("Strings concatenation",

992 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

994 
x
 = 
	`sdsıy
(x,"a");

995 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

996 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

998 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

999 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1000 
	`sd¦’
(
x
) == 33 &&

1001 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1003 
	`sdsä“
(
x
);

1004 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1005 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1006 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) ==0)

1008 
	`sdsä“
(
x
);

1009 
x
 = 
	`sd¢ew
("xxciaoyyy");

1010 
	`sd¡rim
(
x
,"xy");

1011 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1012 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1014 
y
 = 
	`sdsdup
(
x
);

1015 
	`sd¤ªge
(
y
,1,1);

1016 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1017 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1019 
	`sdsä“
(
y
);

1020 
y
 = 
	`sdsdup
(
x
);

1021 
	`sd¤ªge
(
y
,1,-1);

1022 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1023 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1025 
	`sdsä“
(
y
);

1026 
y
 = 
	`sdsdup
(
x
);

1027 
	`sd¤ªge
(
y
,-2,-1);

1028 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1029 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1031 
	`sdsä“
(
y
);

1032 
y
 = 
	`sdsdup
(
x
);

1033 
	`sd¤ªge
(
y
,2,1);

1034 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1035 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1037 
	`sdsä“
(
y
);

1038 
y
 = 
	`sdsdup
(
x
);

1039 
	`sd¤ªge
(
y
,1,100);

1040 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1041 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1043 
	`sdsä“
(
y
);

1044 
y
 = 
	`sdsdup
(
x
);

1045 
	`sd¤ªge
(
y
,100,100);

1046 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1047 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1049 
	`sdsä“
(
y
);

1050 
	`sdsä“
(
x
);

1051 
x
 = 
	`sd¢ew
("foo");

1052 
y
 = 
	`sd¢ew
("foa");

1053 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1055 
	`sdsä“
(
y
);

1056 
	`sdsä“
(
x
);

1057 
x
 = 
	`sd¢ew
("bar");

1058 
y
 = 
	`sd¢ew
("bar");

1059 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1061 
	`sdsä“
(
y
);

1062 
	`sdsä“
(
x
);

1063 
x
 = 
	`sd¢ew
("aar");

1064 
y
 = 
	`sd¢ew
("bar");

1065 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1067 
	`sdsä“
(
y
);

1068 
	`sdsä“
(
x
);

1069 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1070 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1071 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1072 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1075 
Şdä“
;

1077 
	`sdsä“
(
x
);

1078 
x
 = 
	`sd¢ew
("0");

1079 
sh
 = (*è(
x
-((
sdshdr
)));

1080 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
sh
->
Ën
 =ğ1 && sh->
ä“
 == 0);

1081 
x
 = 
	`sdsMakeRoomFÜ
(x,1);

1082 
sh
 = (*è(
x
-((
sdshdr
)));

1083 
	`‹¡_cÚd
("sdsMakeRoomFÜ()", 
sh
->
Ën
 =ğ1 && sh->
ä“
 > 0);

1084 
Şdä“
 = 
sh
->
ä“
;

1085 
x
[1] = '1';

1086 
	`sdsInüL’
(
x
,1);

1087 
	`‹¡_cÚd
("sdsInüL’(è-- cÚ‹Á", 
x
[0] == '0' && x[1] == '1');

1088 
	`‹¡_cÚd
("sdsInüL’(è--†’", 
sh
->
Ën
 == 2);

1089 
	`‹¡_cÚd
("sdsInüL’(è-- f»e", 
sh
->
ä“
 =ğ
Şdä“
-1);

1092 
	`‹¡_»pÜt
()

1094 
	}
}

	@dep/himemcached-0.1.0/himcdep/sds.h

31 #iâdeà
__SDS_H


32 
	#__SDS_H


	)

34 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

36 
	~<sys/ty³s.h
>

37 
	~<¡d¬g.h
>

38 #ifdeà
_MSC_VER


39 
	~"wš32.h
"

42 *
	tsds
;

44 
	ssdshdr
 {

45 
	mËn
;

46 
	mä“
;

47 
	mbuf
[];

50 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

51 
sdshdr
 *
sh
 = (sdshd¸*)(
s
- *sh);

52  
sh
->
Ën
;

53 
	}
}

55 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

56 
sdshdr
 *
sh
 = (sdshd¸*)(
s
- *sh);

57  
sh
->
ä“
;

58 
	}
}

60 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

61 
sds
 
sd¢ew
(cÚ¡ *
š™
);

62 
sds
 
sd£m±y
();

63 
size_t
 
sd¦’
(cÚ¡ 
sds
 
s
);

64 
sds
 
sdsdup
(cÚ¡ sd 
s
);

65 
sdsä“
(
sds
 
s
);

66 
size_t
 
sd§va
(cÚ¡ 
sds
 
s
);

67 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

68 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

69 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

70 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

71 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

72 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

74 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

75 #ifdeà
__GNUC__


76 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

77 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

79 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

82 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

83 
	`sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
);

84 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

85 
	`sdsupd©–’
(
sds
 
s
);

86 
	`sdsş—r
(
sds
 
s
);

87 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

88 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

89 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

90 
	`sd¡Şow”
(
sds
 
s
);

91 
	`sd¡ouµ”
(
sds
 
s
);

92 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

93 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

94 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

95 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

96 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
, 
size_t
 
£¶’
);

97 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

100 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

101 
	`sdsInüL’
(
sds
 
s
, 
šü
);

102 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

103 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

	@dep/himemcached-0.1.0/himcread.c

1 
	~<¡ršg.h
>

2 
	~<¡dlib.h
>

3 #iâdeà
_MSC_VER


4 
	~<uni¡d.h
>

6 
	~<as£¹.h
>

7 
	~<”ºo.h
>

8 
	~<ùy³.h
>

10 
	~"himü—d.h
"

11 
	~"himcd•/sds.h
"

13 
	#PARSE_OK
 0

	)

14 
	#PARSE_ERROR
 1

	)

15 
	#PARSE_AGAIN
 3

	)

17 
	#RSP_TYPE_UNKNOWN
 0

	)

18 
	#RSP_TYPE_NUM
 1

	)

19 
	#RSP_TYPE_STORED
 2

	)

20 
	#RSP_TYPE_NOT_STORED
 3

	)

21 
	#RSP_TYPE_EXISTS
 4

	)

22 
	#RSP_TYPE_NOT_FOUND
 5

	)

23 
	#RSP_TYPE_END
 6

	)

24 
	#RSP_TYPE_VALUE
 7

	)

25 
	#RSP_TYPE_DELETED
 8

	)

26 
	#RSP_TYPE_ERROR
 9

	)

27 
	#RSP_TYPE_CLIENT_ERROR
 10

	)

28 
	#RSP_TYPE_SERVER_ERROR
 11

	)

30 
memÿchedR—d”Re£t
(
mcR—d”
 *
r
);

32 
	$__memÿchedR—d”S‘E¼Ü
(
mcR—d”
 *
r
, 
ty³
, cÚ¡ *
¡r
) {

33 
size_t
 
Ën
;

35 
	`memÿchedR—d”Re£t
(
r
);

38 ià(
r
->
buf
 !ğ
NULL
) {

39 
	`sdsä“
(
r
->
buf
);

40 
r
->
buf
 = 
NULL
;

41 
r
->
pos
 =„->
Ën
 = 0;

45 
r
->
”r
 = 
ty³
;

46 
Ën
 = 
	`¡¾’
(
¡r
);

47 
Ën
 =†’ < ((
r
->
”r¡r
)-1) ?†en : ((r->errstr)-1);

48 
	`memıy
(
r
->
”r¡r
,
¡r
,
Ën
);

49 
r
->
”r¡r
[
Ën
] = '\0';

50 
	}
}

52 
size_t
 
	$ch¹os
(*
buf
, 
size_t
 
size
, 
by‹
)

54 
size_t
 
Ën
 = 0;

56 
by‹
) {

59 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\%c\"",
by‹
);

61 '\n': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\n\""); ;

62 '\r': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\r\""); ;

63 '\t': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\t\""); ;

64 '\a': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\a\""); ;

65 '\b': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\b\""); ;

67 ià(
	`i¥ršt
(
by‹
))

68 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"%c\"",
by‹
);

70 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\x%02x\"",()
by‹
);

74  
Ën
;

75 
	}
}

77 
	$__memÿchedR—d”S‘E¼ÜPrÙocŞBy‹
(
mcR—d”
 *
r
, 
by‹
) {

78 
cbuf
[8], 
sbuf
[128];

80 
	`ch¹os
(
cbuf
,(cbuf),
by‹
);

81 
	`¢´štf
(
sbuf
,(sbuf),

82 "PrÙocŞƒ¼Ü, gÙ % a »¶yy³ by‹", 
cbuf
);

83 
	`__memÿchedR—d”S‘E¼Ü
(
r
,
MC_ERR_PROTOCOL
,
sbuf
);

84 
	}
}

86 
	$__memÿchedR—d”S‘E¼ÜOOM
(
mcR—d”
 *
r
) {

87 
	`__memÿchedR—d”S‘E¼Ü
(
r
,
MC_ERR_OOM
,"Out of memory");

88 
	}
}

90 
	$–em’tA¼ayC»©e
(
mcR—d”
 *
r
)

92 
	`as£¹
(
r
->
®loc_Ën
 == 0);

93 
	`as£¹
(
r
->
–em’t
 =ğ
NULL
);

94 
	`as£¹
(
r
->
–em’ts
 == 0);

96 
r
->
–em’t
 = 
	`m®loc
(10*(*));

97 ià(
r
->
–em’t
 =ğ
NULL
) {

98 
	`__memÿchedR—d”S‘E¼ÜOOM
(
r
);

99  
MC_ERR
;

101 
r
->
®loc_Ën
 = 10;

102 
r
->
–em’ts
 = 0;

104  
MC_OK
;

105 
	}
}

107 
	$–em’tA¼ayDe¡roy
(
mcR—d”
 *
r
)

109 
i
;

111 ià(
r
->
–em’t
 =ğ
NULL
)

114 ià(
r
->
â
 &&„->â->
ä“Objeù
) {

115 
i
 = 0; i < 
r
->
–em’ts
; i ++) {

116 ià(
r
->
–em’t
[
i
])

117 
r
->
â
->
	`ä“Objeù
Ô->
–em’t
[
i
]);

120 
	`ä“
(
r
->
–em’t
);

121 
r
->
–em’t
 = 
NULL
;

122 
r
->
–em’ts
 = 0;

123 
r
->
®loc_Ën
 = 0;

125  
MC_OK
;

126 
	}
}

128 
	#EXPAND_MAX_SIZE_PER_TIME
 300

	)

129 
	$–em’tA¼ayEx·nd
(
mcR—d”
 *
r
)

131 
size_t
 
Ãw_Ëngth
;

132 ià(
r
->
®loc_Ën
 <= 150) {

133 
Ãw_Ëngth
 = 
r
->
®loc_Ën
*2;

134 } ià(
r
->
®loc_Ën
 <= 500) {

135 
Ãw_Ëngth
 = 
r
->
®loc_Ën
+
EXPAND_MAX_SIZE_PER_TIME
;

137 
r
->
–em’t
 = 
	`»®loc
Ô->–em’t,
Ãw_Ëngth
*(*));

138 ià(
r
->
–em’t
 =ğ
NULL
) {

139 
	`__memÿchedR—d”S‘E¼ÜOOM
(
r
);

140  
MC_ERR
;

142 
r
->
®loc_Ën
 = 
Ãw_Ëngth
;

144  
MC_OK
;

145 
	}
}

147 
	$–em’tA¼ayAdd
(
mcR—d”
 *
r
, *
»¶y
)

149 
	`as£¹
(
r
->
–em’ts
 <ğr->
®loc_Ën
);

150 ià(
r
->
–em’ts
 =ğr->
®loc_Ën
) {

151 ià(
	`–em’tA¼ayEx·nd
(
r
è!ğ
MC_OK
)

152  
MC_ERR
;

154 
r
->
–em’t
[r->
–em’ts
++] = 
»¶y
;

156  
MC_OK
;

157 
	}
}

159 
	$memÿchedP¬£Re¥Ú£
(
mcR—d”
 *
r
)

161 *
obj
;

162 *
p
, *
m
;

163 
ch
;

165 
SW_START
,

166 
SW_RSP_NUM
,

167 
SW_RSP_STR
,

168 
SW_SPACES_BEFORE_KEY
,

169 
SW_KEY
,

170 
SW_SPACES_BEFORE_FLAGS
,

171 
SW_FLAGS
,

172 
SW_SPACES_BEFORE_VLEN
,

173 
SW_VLEN
,

174 
SW_RUNTO_VAL
,

175 
SW_VAL
,

176 
SW_VAL_LF
,

177 
SW_END
,

178 
SW_RUNTO_CRLF
,

179 
SW_CRLF
,

180 
SW_ALMOST_DONE
,

181 
SW_SENTINEL


182 } 
¡©e
;

184 
¡©e
 = 
r
->state;

186 
	`as£¹
(
¡©e
 >ğ
SW_START
 && s‹ < 
SW_SENTINEL
);

189 
	`as£¹
(
r
->
buf
 !ğ
NULL
);

190 
	`as£¹
(
r
->
pos
 <„->
Ën
);

192 
p
 = 
r
->
buf
+r->
pos
;… <ğr->buf+r->
Ën
;…++) {

193 
ch
 = *
p
;

195 
¡©e
) {

196 
SW_START
:

197 ià(
	`isdig™
(
ch
)) {

198 
¡©e
 = 
SW_RSP_NUM
;

200 
¡©e
 = 
SW_RSP_STR
;

202 
p
 =… - 1;

206 
SW_RSP_NUM
:

207 ià(
r
->
tok’
 =ğ
NULL
) {

209 
r
->
tok’
 = 
p
;

212 ià(
	`isdig™
(
ch
)) {

214 
r
->
š‹g”
 =„->š‹g”*10 + ()(
ch
-'0');

215 } ià(
ch
 == ' ' || ch == '\r') {

217 
r
->
tok’
 = 
NULL
;

218 
r
->
š‹g”
 = 0;

219 
r
->
ty³
 = 
RSP_TYPE_NUM
;

220 
p
 =… - 1;

221 
¡©e
 = 
SW_CRLF
;

223 
”rÜ
;

228 
SW_RSP_STR
:

229 ià(
r
->
tok’
 =ğ
NULL
) {

231 
r
->
tok’
 = 
p
;

234 ià(
ch
 == ' ' || ch == '\r') {

236 
m
 = 
r
->
tok’
;

238 
r
->
ty³
 = 
RSP_TYPE_UNKNOWN
;

239 
	`as£¹
(
r
->
¡r
 =ğ
NULL
 &&„->
¡¾’
 == 0);

241 
p
 - 
m
) {

243 ià(!
	`¡ºcmp
(
m
,"END\r",4)) {

244 
r
->
ty³
 = 
RSP_TYPE_END
;

251 ià(!
	`¡ºcmp
(
m
,"VALUE",5)) {

256 
r
->
ty³
 = 
RSP_TYPE_VALUE
;

260 ià(!
	`¡ºcmp
(
m
,"ERROR",5)) {

261 
r
->
ty³
 = 
RSP_TYPE_ERROR
;

268 ià(!
	`¡ºcmp
(
m
,"STORED",6)) {

269 
r
->
ty³
 = 
RSP_TYPE_STORED
;

271 
r
->
¡r
 = 
m
;

272 
r
->
¡¾’
 = 6;

276 ià(!
	`¡ºcmp
(
m
,"EXISTS",6)) {

277 
r
->
ty³
 = 
RSP_TYPE_EXISTS
;

279 
r
->
¡r
 = 
m
;

280 
r
->
¡¾’
 = 6;

287 ià(!
	`¡ºcmp
(
m
,"DELETED",7)) {

288 
r
->
ty³
 = 
RSP_TYPE_DELETED
;

290 
r
->
¡r
 = 
m
;

291 
r
->
¡¾’
 = 7;

298 ià(!
	`¡ºcmp
(
m
,"NOT_FOUND",9)) {

299 
r
->
ty³
 = 
RSP_TYPE_NOT_FOUND
;

301 
r
->
¡r
 = 
m
;

302 
r
->
¡¾’
 = 9;

309 ià(!
	`¡ºcmp
(
m
,"NOT_STORED",10)) {

310 
r
->
ty³
 = 
RSP_TYPE_NOT_STORED
;

312 
r
->
¡r
 = 
m
;

313 
r
->
¡¾’
 = 10;

320 ià(!
	`¡ºcmp
(
m
,"CLIENT_ERROR",12)) {

321 
r
->
ty³
 = 
RSP_TYPE_CLIENT_ERROR
;

325 ià(!
	`¡ºcmp
(
m
,"SERVER_ERROR",12)) {

326 
r
->
ty³
 = 
RSP_TYPE_SERVER_ERROR
;

333 
r
->
ty³
) {

334 
RSP_TYPE_UNKNOWN
:

335 
”rÜ
;

337 
RSP_TYPE_STORED
:

338 
RSP_TYPE_NOT_STORED
:

339 
RSP_TYPE_EXISTS
:

340 
RSP_TYPE_NOT_FOUND
:

341 
RSP_TYPE_DELETED
:

342 
¡©e
 = 
SW_CRLF
;

345 
RSP_TYPE_END
:

346 
¡©e
 = 
SW_CRLF
;

349 
RSP_TYPE_VALUE
:

350 
¡©e
 = 
SW_SPACES_BEFORE_KEY
;

353 
RSP_TYPE_ERROR
:

354 
¡©e
 = 
SW_CRLF
;

357 
RSP_TYPE_CLIENT_ERROR
:

358 
RSP_TYPE_SERVER_ERROR
:

359 
r
->
tok’
 = 
NULL
;

360 
¡©e
 = 
SW_RUNTO_CRLF
;

364 
	`NOT_REACHED
();

367 
p
 =… - 1;

372 
SW_SPACES_BEFORE_KEY
:

373 ià(
ch
 != ' ') {

374 
¡©e
 = 
SW_KEY
;

375 
p
 =… - 1;

376 
r
->
tok’
 = 
NULL
;

381 
SW_KEY
:

382 ià(
r
->
tok’
 =ğ
NULL
) {

383 
r
->
tok’
 = 
p
;

386 ià(
ch
 == ' ') {

387 
	`as£¹
(
r
->
¡r
 =ğ
NULL
 &&„->
¡¾’
 == 0);

388 
m
 = 
r
->
tok’
;

389 
r
->
tok’
 = 
NULL
;

390 
¡©e
 = 
SW_SPACES_BEFORE_FLAGS
;

391 
r
->
¡¾’
 = 
p
-
m
;

392 
r
->
¡r
 = 
m
;

397 
SW_SPACES_BEFORE_FLAGS
:

398 ià(
ch
 != ' ') {

399 ià(!
	`isdig™
(
ch
)) {

400 
”rÜ
;

402 
¡©e
 = 
SW_FLAGS
;

403 
p
 =… - 1;

404 
r
->
kæags
 = 0;

409 
SW_FLAGS
:

410 ià(
	`isdig™
(
ch
)) {

412 
r
->
kæags
 =„->kæags*10 + ()(
ch
-'0');

413 } ià(
ch
 == ' ') {

416 
¡©e
 = 
SW_SPACES_BEFORE_VLEN
;

418 
”rÜ
;

423 
SW_SPACES_BEFORE_VLEN
:

424 ià(
ch
 != ' ') {

425 ià(!
	`isdig™
(
ch
)) {

426 
”rÜ
;

428 
p
 =… - 1;

429 
¡©e
 = 
SW_VLEN
;

430 
r
->
š‹g”
 = 0;

435 
SW_VLEN
:

436 ià(
	`isdig™
(
ch
)) {

437 
r
->
š‹g”
 =„->š‹g”*10 + ()(
ch
-'0');

438 } ià(
ch
 == ' ' || ch == '\r') {

440 
p
 =… - 1;

442 
¡©e
 = 
SW_RUNTO_CRLF
;

444 
”rÜ
;

449 
SW_RUNTO_VAL
:

450 
ch
) {

453 
¡©e
 = 
SW_VAL
;

454 
r
->
tok’
 = 
NULL
;

458 
”rÜ
;

463 
SW_VAL
:

464 ià(
r
->
tok’
 =ğ
NULL
) {

466 
r
->
tok’
 = 
p
;

469 
m
 = 
r
->
tok’
 +„->
š‹g”
;

470 ià(
m
 > 
r
->
buf
+r->
Ën
) {

471 
p
 = 
r
->
buf
 +„->
Ën
;

475 *
m
) {

478 
p
 = 
m
;

479 
¡©e
 = 
SW_VAL_LF
;

483 
”rÜ
;

488 
SW_VAL_LF
:

489 
ch
) {

492 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

493 
obj
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_STRING
,r->
¡r
,r->
¡¾’
,

494 
r
->
tok’
,r->
š‹g”
,r->
kæags
,r->
kv”siÚ
);

496 
obj
 = (*)
MC_REPLY_STRING
;

497 ià(
r
->
–em’t
) {

498 
	`as£¹
(
r
->
sub»¶y
 =ğ
NULL
);

499 
	`–em’tA¼ayAdd
(
r
,r->
sub»¶y
);

500 } ià(
r
->
sub»¶y
) {

501 
	`–em’tA¼ayC»©e
(
r
);

502 
	`–em’tA¼ayAdd
(
r
,r->
sub»¶y
);

503 
r
->
sub»¶y
 = 
NULL
;

504 
	`–em’tA¼ayAdd
(
r
,
obj
);

506 
r
->
sub»¶y
 = 
obj
;

509 
r
->
tok’
 = 
NULL
;

510 
r
->
¡r
 = 
NULL
;

511 
r
->
¡¾’
 = 0;

512 
r
->
kæags
 = 0;

513 
r
->
kv”siÚ
 = -1;

514 
¡©e
 = 
SW_RSP_STR
;

518 
”rÜ
;

523 
SW_END
:

524 ià(
r
->
tok’
 =ğ
NULL
) {

525 ià(
ch
 != 'E') {

526 
”rÜ
;

529 
r
->
tok’
 = 
p
;

530 } ià(
ch
 == '\r') {

532 
m
 = 
r
->
tok’
;

533 
r
->
tok’
 = 
NULL
;

535 
p
 - 
m
) {

537 ià(!
	`¡ºcmp
(
m
,"END\r",4)) {

538 
¡©e
 = 
SW_ALMOST_DONE
;

543 
”rÜ
;

549 
SW_RUNTO_CRLF
:

550 
ch
) {

552 ià(
r
->
ty³
 =ğ
RSP_TYPE_VALUE
) {

553 
¡©e
 = 
SW_RUNTO_VAL
;

555 ià(
r
->
ty³
 =ğ
RSP_TYPE_CLIENT_ERROR
 ||

556 
r
->
ty³
 =ğ
RSP_TYPE_SERVER_ERROR
) {

557 
m
 = 
r
->
tok’
;

558 
r
->
tok’
 = 
NULL
;

559 
r
->
¡¾’
 = 
p
-
m
;

560 
r
->
¡r
 = 
m
;

562 
¡©e
 = 
SW_ALMOST_DONE
;

573 
SW_CRLF
:

574 
ch
) {

579 
¡©e
 = 
SW_ALMOST_DONE
;

583 
”rÜ
;

588 
SW_ALMOST_DONE
:

589 
ch
) {

592 
dÚe
;

595 
”rÜ
;

600 
SW_SENTINEL
:

602 
	`NOT_REACHED
();

608 
	`as£¹
(
p
 =ğ
r
->
buf
+r->
Ën
);

609 
r
->
pos
 =„->
Ën
;

610 
r
->
¡©e
 = state;

612 
r
->
»suÉ
 = 
PARSE_AGAIN
;

616 
dÚe
:

617 
r
->
pos
 = 
p
-r->
buf
+1;

618 
	`as£¹
(
r
->
pos
 <ğr->
Ën
);

619 
r
->
¡©e
 = 
SW_START
;

620 
r
->
tok’
 = 
NULL
;

621 
r
->
»suÉ
 = 
PARSE_OK
;

625 
”rÜ
:

626 
r
->
»suÉ
 = 
PARSE_ERROR
;

627 
r
->
¡©e
 = state;

628 
”ºo
 = 
EINVAL
;

629 
	}
}

631 
mcR—d”
 *
	$memÿchedR—d”C»©eW™hFunùiÚs
(
mcR•lyObjeùFunùiÚs
 *
â
)

633 
mcR—d”
 *
r
;

635 
r
 = 
	`ÿÎoc
((
mcR—d”
),1);

636 ià(
r
 =ğ
NULL
)

637  
NULL
;

639 
r
->
”r
 = 0;

640 
r
->
”r¡r
[0] = '\0';

641 
r
->
buf
 = 
	`sd£m±y
();

642 
r
->
maxbuf
 = 
MC_READER_MAX_BUF
;

643 ià(
r
->
buf
 =ğ
NULL
) {

644 
	`ä“
(
r
);

645  
NULL
;

648 
r
->
sub»¶y
 = 
NULL
;

649 
r
->
®loc_Ën
 = 0;

650 
r
->
–em’ts
 = 0;

651 
r
->
–em’t
 = 
NULL
;

653 
r
->
¡©e
 = 0;

654 
r
->
tok’
 = 
NULL
;

656 
r
->
¡r
 = 
NULL
;

657 
r
->
¡¾’
 = 0;

658 
r
->
kæags
 = 0;

659 
r
->
kv”siÚ
 = -1;

660 
r
->
š‹g”
 = 0;

661 
r
->
ty³
 = 
RSP_TYPE_UNKNOWN
;

662 
r
->
»suÉ
 = 
PARSE_OK
;

664 
r
->
â
 = fn;

666  
r
;

667 
	}
}

669 
	$memÿchedR—d”F»e
(
mcR—d”
 *
r
)

671 
	`memÿchedR—d”Re£t
(
r
);

673 ià(
r
->
buf
 !ğ
NULL
)

674 
	`sdsä“
(
r
->
buf
);

675 
	`ä“
(
r
);

676 
	}
}

678 
	$memÿchedR—d”F“d
(
mcR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
)

680 
sds
 
Ãwbuf
;

683 ià(
r
->
”r
)

684  
MC_ERR
;

687 ià(
buf
 !ğ
NULL
 && 
Ën
 >= 1) {

689 ià(
r
->
Ën
 =ğ0 &&„->
maxbuf
 !ğ0 && 
	`sd§va
Ô->
buf
) >„->maxbuf) {

690 
	`sdsä“
(
r
->
buf
);

691 
r
->
buf
 = 
	`sd£m±y
();

692 
r
->
pos
 = 0;

695 
	`as£¹
(
r
->
buf
 !ğ
NULL
);

698 
Ãwbuf
 = 
	`sdsÿ’
(
r
->
buf
,buf,
Ën
);

699 ià(
Ãwbuf
 =ğ
NULL
) {

700 
	`__memÿchedR—d”S‘E¼ÜOOM
(
r
);

701  
MC_ERR
;

704 
r
->
buf
 = 
Ãwbuf
;

705 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

708  
MC_OK
;

709 
	}
}

711 
	$memÿchedR—d”Re£t
(
mcR—d”
 *
r
)

713 
r
->
¡r
 = 
NULL
;

714 
r
->
¡¾’
 = 0;

715 
r
->
kæags
 = 0;

716 
r
->
kv”siÚ
 = -1;

718 
r
->
¡©e
 = 0;

719 
r
->
tok’
 = 0;

721 
r
->
š‹g”
 = 0;

723 
r
->
ty³
 = 
RSP_TYPE_UNKNOWN
;

724 
r
->
»suÉ
 = 
PARSE_OK
;

726 ià(
r
->
sub»¶y
 !ğ
NULL
) {

727 ià(
r
->
â
 &&„->â->
ä“Objeù
)

728 
r
->
â
->
	`ä“Objeù
Ô->
sub»¶y
);

730 
r
->
sub»¶y
 = 
NULL
;

733 
	`–em’tA¼ayDe¡roy
(
r
);

735 
r
->
”r
 = 0;

736 
r
->
”r¡r
[0] = '\0';

737 
	}
}

739 *
	$g‘R•lyFromR—d”
(
mcR—d”
 *
r
)

741 *
»¶y
;

743 
r
->
ty³
) {

744 
RSP_TYPE_VALUE
:

745 ià(
r
->
–em’t
) {

746 
	`as£¹
(
r
->
sub»¶y
 =ğ
NULL
);

747 ià(
r
->
â
 &&„->â->
ü—‹A¼ay
) {

748 
»¶y
 = 
r
->
â
->
	`ü—‹A¼ay
Ô->
–em’ts
,r->
–em’t
);

749 
r
->
–em’t
 = 
NULL
;

750 
r
->
–em’ts
 = 0;

751 
r
->
®loc_Ën
 = 0;

753 
»¶y
 = (*)
MC_REPLY_ARRAY
;

755 } ià(
r
->
sub»¶y
) {

756 
»¶y
 = 
r
->
sub»¶y
;

759 
RSP_TYPE_NUM
:

760 ià(
r
->
â
 &&„->â->
ü—‹IÁeg”
)

761 
»¶y
 = 
r
->
â
->
	`ü—‹IÁeg”
Ô->
š‹g”
);

763 
»¶y
 = (*)
MC_REPLY_INTEGER
;

765 
RSP_TYPE_END
:

766 ià(
r
->
â
 &&„->â->
ü—‹N
)

767 
»¶y
 = 
r
->
â
->
	`ü—‹N
();

769 
»¶y
 = (*)
MC_REPLY_NIL
;

771 
RSP_TYPE_CLIENT_ERROR
:

772 
RSP_TYPE_SERVER_ERROR
:

773 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

774 
»¶y
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_ERROR
,

775 
NULL
,0,
r
->
¡r
,r->
¡¾’
,0,0);

777 
»¶y
 = (*)
MC_REPLY_ERROR
;

779 
RSP_TYPE_ERROR
:

780 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

781 
»¶y
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_ERROR
,

782 
NULL
,0,"",0,0,0);

784 
»¶y
 = (*)
MC_REPLY_ERROR
;

786 
RSP_TYPE_STORED
:

787 
RSP_TYPE_NOT_STORED
:

788 
RSP_TYPE_EXISTS
:

789 
RSP_TYPE_NOT_FOUND
:

790 
RSP_TYPE_DELETED
:

791 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

792 
»¶y
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_STATUS
,

793 
NULL
,0,
r
->
¡r
,r->
¡¾’
,0,0);

795 
»¶y
 = (*)
MC_REPLY_STATUS
;

798 
»¶y
 = 
NULL
;

802  
»¶y
;

803 
	}
}

805 
	$memÿchedR—d”G‘R•ly
(
mcR—d”
 *
r
, **
»¶y
) {

807 ià(
»¶y
 !ğ
NULL
)

808 *
»¶y
 = 
NULL
;

811 ià(
r
->
”r
)

812  
MC_ERR
;

815 ià(
r
->
Ën
 == 0)

816  
MC_OK
;

818 
	`memÿchedP¬£Re¥Ú£
(
r
);

821 ià(
r
->
”r
)

822  
MC_ERR
;

831 ià(
r
->
»suÉ
 =ğ
PARSE_OK
) {

832 ià(
»¶y
 !ğ
NULL
) {

833 *
»¶y
 = 
	`g‘R•lyFromR—d”
(
r
);

835 
	`memÿchedR—d”Re£t
(
r
);

840 ià(
r
->
pos
 >ğ1024 &&„->
tok’
 =ğ
NULL
 &&„->
¡r
 == NULL) {

841 
	`sd¤ªge
(
r
->
buf
,r->
pos
,-1);

842 
r
->
pos
 = 0;

843 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

846  
MC_OK
;

847 
	}
}

	@dep/himemcached-0.1.0/himcread.h

1 #iâdeà
_HIMC_READ_H_


2 
	#_HIMC_READ_H_


	)

3 
	~<¡dio.h
>

5 
	~<himü—d.h
>

7 
	#MC_ERR
 -1

	)

8 
	#MC_OK
 0

	)

14 
	#MC_ERR_IO
 1

	)

15 
	#MC_ERR_EOF
 3

	)

16 
	#MC_ERR_PROTOCOL
 4

	)

17 
	#MC_ERR_OOM
 5

	)

18 
	#MC_ERR_OTHER
 2

	)

20 
	#MC_REPLY_STRING
 1

	)

21 
	#MC_REPLY_ARRAY
 2

	)

22 
	#MC_REPLY_INTEGER
 3

	)

23 
	#MC_REPLY_NIL
 4

	)

24 
	#MC_REPLY_STATUS
 5

	)

25 
	#MC_REPLY_ERROR
 6

	)

27 
	#MC_READER_MAX_BUF
 (1024*16è

	)

29 #ifdeà
__ılu¥lus


33 
	smcR•lyObjeùFunùiÚs
 {

34 *(*
ü—‹SŒšg
)(, *, 
size_t
, *, size_t, , );

35 *(*
ü—‹A¼ay
)(
size_t
, **);

36 *(*
ü—‹IÁeg”
)();

37 *(*
ü—‹N
)();

38 (*
ä“Objeù
)(*);

39 } 
	tmcR•lyObjeùFunùiÚs
;

41 
	smcR—d”
 {

42 
”r
;

43 
”r¡r
[128];

45 *
buf
;

46 
size_t
 
pos
;

47 
size_t
 
Ën
;

48 
size_t
 
maxbuf
;

50 *
sub»¶y
;

51 
size_t
 
®loc_Ën
;

52 
size_t
 
–em’ts
;

53 **
–em’t
;

55 *
¡r
;

56 
size_t
 
¡¾’
;

57 
kæags
;

58 
kv”siÚ
;

60 
¡©e
;

61 *
tok’
;

63 
š‹g”
;

65 
ty³
;

66 
»suÉ
;

68 
mcR•lyObjeùFunùiÚs
 *
â
;

69 *
´ivd©a
;

70 } 
	tmcR—d”
;

73 
mcR—d”
 *
memÿchedR—d”C»©eW™hFunùiÚs
(
mcR•lyObjeùFunùiÚs
 *
â
);

74 
memÿchedR—d”F»e
(
mcR—d”
 *
r
);

75 
memÿchedR—d”F“d
(
mcR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

76 
memÿchedR—d”G‘R•ly
(
mcR—d”
 *
r
, **
»¶y
);

78 #ifdeà
__ılu¥lus


	@dep/himemcached-0.1.0/himemcached.c

1 
	~<¡dlib.h
>

2 
	~<”ºo.h
>

3 
	~<as£¹.h
>

5 
	~"himemÿched.h
"

7 
	#REQ_TYPE_UNKNOWN
 0

	)

8 
	#REQ_TYPE_STORAGE
 1

	)

9 
	#REQ_TYPE_CAS
 2

	)

10 
	#REQ_TYPE_RETRIEVAL
 3

	)

11 
	#REQ_TYPE_ARITHMETIC
 4

	)

12 
	#REQ_TYPE_DELETE
 5

	)

14 
mcR•ly
 *
ü—‹R•lyObjeù
(
ty³
);

15 *
ü—‹SŒšgObjeù
(
ty³
, *
key
, 
size_t
 
keyËn
, *
¡r
, size_ˆ
Ën
, 
æags
, 
v”siÚ
);

16 *
ü—‹A¼ayObjeù
(
size_t
 
–em’ts
, **
–em’t
);

17 *
ü—‹IÁeg”Objeù
(
v®ue
);

18 *
ü—‹NObjeù
();

22 
mcR•lyObjeùFunùiÚs
 
	gdeçuÉFunùiÚs
 = {

23 
ü—‹SŒšgObjeù
,

24 
ü—‹A¼ayObjeù
,

25 
ü—‹IÁeg”Objeù
,

26 
ü—‹NObjeù
,

27 
ä“McR•lyObjeù


31 
mcR•ly
 *
	$ü—‹R•lyObjeù
(
ty³
) {

32 
mcR•ly
 *
r
 = 
	`ÿÎoc
(1,(*r));

34 ià(
r
 =ğ
NULL
)

35  
NULL
;

37 
r
->
ty³
 =ype;

39  
r
;

40 
	}
}

43 
	$ä“McR•lyObjeù
(*
»¶y
) {

44 
mcR•ly
 *
r
 = 
»¶y
;

45 
size_t
 
j
;

47 ià(
r
 =ğ
NULL
)

50 
r
->
ty³
) {

51 
MC_REPLY_INTEGER
:

52 
MC_REPLY_NIL
:

54 
MC_REPLY_ARRAY
:

55 ià(
r
->
–em’t
 !ğ
NULL
) {

56 
j
 = 0; j < 
r
->
–em’ts
; j++)

57 ià(
r
->
–em’t
[
j
] !ğ
NULL
)

58 
	`ä“McR•lyObjeù
(
r
->
–em’t
[
j
]);

59 
	`ä“
(
r
->
–em’t
);

62 
MC_REPLY_ERROR
:

63 
MC_REPLY_STATUS
:

64 
MC_REPLY_STRING
:

65 ià(
r
->
key
 !ğ
NULL
)

66 
	`ä“
(
r
->
key
);

67 ià(
r
->
¡r
 !ğ
NULL
)

68 
	`ä“
(
r
->
¡r
);

71 
	`as£¹
(0);

74 
	`ä“
(
r
);

75 
	}
}

77 *
	$ü—‹SŒšgObjeù
(
ty³
, *
key
, 
size_t
 
keyËn
, *
¡r
, size_ˆ
Ën
, 
æags
, 
v”siÚ
) {

78 
mcR•ly
 *
r
, *
·»Á
;

79 *
buf
;

81 
	`as£¹
(
ty³
 =ğ
MC_REPLY_ERROR
 ||

82 
ty³
 =ğ
MC_REPLY_STATUS
 ||

83 
ty³
 =ğ
MC_REPLY_STRING
);

85 
r
 = 
	`ü—‹R•lyObjeù
(
ty³
);

86 ià(
r
 =ğ
NULL
)

87  
NULL
;

89 ià(
key
 !ğ
NULL
) {

90 
r
->
key
 = 
	`m®loc
(
keyËn
+1);

91 ià(
r
->
key
 =ğ
NULL
) {

92 
	`ä“McR•lyObjeù
(
r
);

93  
NULL
;

95 ià(
keyËn
 > 0)

97 
	`memıy
(
r
->
key
,key,
keyËn
);

98 
r
->
key
[
keyËn
] = '\0';

99 
r
->
keyËn
 = keylen;

102 
buf
 = 
	`m®loc
(
Ën
+1);

103 ià(
buf
 =ğ
NULL
) {

104 
	`ä“McR•lyObjeù
(
r
);

105  
NULL
;

107 ià(
Ën
 > 0)

109 
	`memıy
(
buf
,
¡r
,
Ën
);

110 
buf
[
Ën
] = '\0';

111 
r
->
¡r
 = 
buf
;

112 
r
->
Ën
 =†en;

114 
r
->
æags
 = flags;

115 
r
->
v”siÚ
 = version;

117  
r
;

118 
	}
}

120 *
	$ü—‹A¼ayObjeù
(
size_t
 
–em’ts
, **
–em’t
) {

121 
mcR•ly
 *
r
;

123 
r
 = 
	`ü—‹R•lyObjeù
(
MC_REPLY_ARRAY
);

124 ià(
r
 =ğ
NULL
)

125  
NULL
;

127 
r
->
–em’ts
 =ƒlements;

128 
r
->
–em’t
 = (
mcR•ly
 **)element;

130  
r
;

131 
	}
}

133 *
	$ü—‹IÁeg”Objeù
(
v®ue
) {

134 
mcR•ly
 *
r
;

136 
r
 = 
	`ü—‹R•lyObjeù
(
MC_REPLY_INTEGER
);

137 ià(
r
 =ğ
NULL
)

138  
NULL
;

140 
r
->
š‹g”
 = 
v®ue
;

142  
r
;

143 
	}
}

145 *
	$ü—‹NObjeù
() {

146 
mcR•ly
 *
r
;

148 
r
 = 
	`ü—‹R•lyObjeù
(
MC_REPLY_NIL
);

149 ià(
r
 =ğ
NULL
)

150  
NULL
;

152  
r
;

153 
	}
}

155 
	$__memÿchedS‘E¼Ü
(
mcCÚ‹xt
 *
c
, 
ty³
, cÚ¡ *
¡r
) {

156 
size_t
 
Ën
;

158 
c
->
”r
 = 
ty³
;

159 ià(
¡r
 !ğ
NULL
) {

160 
Ën
 = 
	`¡¾’
(
¡r
);

161 
Ën
 =†’ < ((
c
->
”r¡r
)-1) ?†en : ((c->errstr)-1);

162 
	`memıy
(
c
->
”r¡r
,
¡r
,
Ën
);

163 
c
->
”r¡r
[
Ën
] = '\0';

166 
	`as£¹
(
ty³
 =ğ
MC_ERR_IO
);

169 
	}
}

181 
	$memÿchedBufãrWr™e
(
mcCÚ‹xt
 *
c
, *
dÚe
) {

182 
nwr™‹n
;

185 ià(
c
->
”r
)

186  
MC_ERR
;

188 ià(
	`sd¦’
(
c
->
obuf
) > 0) {

189 
nwr™‹n
 = 
	`wr™e
(
c
->
fd
,c->
obuf
,
	`sd¦’
(c->obuf));

190 ià(
nwr™‹n
 == -1) {

191 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
MC_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

194 
	`__memÿchedS‘E¼Ü
(
c
,
MC_ERR_IO
,
NULL
);

195  
MC_ERR
;

197 } ià(
nwr™‹n
 > 0) {

198 ià(
nwr™‹n
 =ğ(sigÃd)
	`sd¦’
(
c
->
obuf
)) {

199 
	`sdsä“
(
c
->
obuf
);

200 
c
->
obuf
 = 
	`sd£m±y
();

202 
	`sd¤ªge
(
c
->
obuf
,
nwr™‹n
,-1);

206 ià(
dÚe
 !ğ
NULL
è*dÚğ(
	`sd¦’
(
c
->
obuf
) == 0);

207  
MC_OK
;

208 
	}
}

212 
	$memÿchedG‘R•lyFromR—d”
(
mcCÚ‹xt
 *
c
, **
»¶y
) {

213 ià(
	`memÿchedR—d”G‘R•ly
(
c
->
»ad”
,
»¶y
è=ğ
MC_ERR
) {

214 
	`__memÿchedS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

215  
MC_ERR
;

217  
MC_OK
;

218 
	}
}

220 
	$memÿchedG‘R•ly
(
mcCÚ‹xt
 *
c
, **
»¶y
) {

221 
wdÚe
 = 0;

222 *
aux
 = 
NULL
;

225 ià(
	`memÿchedG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
MC_ERR
)

226  
MC_ERR
;

229 ià(
aux
 =ğ
NULL
 && 
c
->
æags
 & 
MC_BLOCK
) {

232 ià(
	`memÿchedBufãrWr™e
(
c
,&
wdÚe
è=ğ
MC_ERR
)

233  
MC_ERR
;

234 } !
wdÚe
);

238 ià(
	`memÿchedBufãrR—d
(
c
è=ğ
MC_ERR
)

239  
MC_ERR
;

240 ià(
	`memÿchedG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
MC_ERR
)

241  
MC_ERR
;

242 } 
aux
 =ğ
NULL
);

246 ià(
»¶y
 !ğ
NULL
è*»¶y = 
aux
;

247  
MC_OK
;

248 
	}
}

250 
mcR—d”
 *
	$memÿchedR—d”C»©e
() {

251  
	`memÿchedR—d”C»©eW™hFunùiÚs
(&
deçuÉFunùiÚs
);

252 
	}
}

254 
mcCÚ‹xt
 *
	$memÿchedCÚ‹xtIn™
() {

255 
mcCÚ‹xt
 *
c
;

257 
c
 = 
	`ÿÎoc
(1,(
mcCÚ‹xt
));

258 ià(
c
 =ğ
NULL
)

259  
NULL
;

261 
c
->
”r
 = 0;

262 
c
->
”r¡r
[0] = '\0';

263 
c
->
obuf
 = 
	`sd£m±y
();

264 
c
->
»ad”
 = 
	`memÿchedR—d”C»©e
();

265 
c
->
tı
.
ho¡
 = 
NULL
;

266 
c
->
tı
.
sourû_addr
 = 
NULL
;

267 
c
->
unix_sock
.
·th
 = 
NULL
;

268 
c
->
timeout
 = 
NULL
;

270 ià(
c
->
obuf
 =ğ
NULL
 || c->
»ad”
 == NULL) {

271 
	`memÿchedF»e
(
c
);

272  
NULL
;

275  
c
;

276 
	}
}

278 
	$memÿchedF»e
(
mcCÚ‹xt
 *
c
) {

279 ià(
c
 =ğ
NULL
)

281 ià(
c
->
fd
 > 0)

282 
	`şo£
(
c
->
fd
);

283 ià(
c
->
obuf
 !ğ
NULL
)

284 
	`sdsä“
(
c
->
obuf
);

285 ià(
c
->
»ad”
 !ğ
NULL
)

286 
	`memÿchedR—d”F»e
(
c
->
»ad”
);

287 ià(
c
->
tı
.
ho¡
)

288 
	`ä“
(
c
->
tı
.
ho¡
);

289 ià(
c
->
tı
.
sourû_addr
)

290 
	`ä“
(
c
->
tı
.
sourû_addr
);

291 ià(
c
->
unix_sock
.
·th
)

292 
	`ä“
(
c
->
unix_sock
.
·th
);

293 ià(
c
->
timeout
)

294 
	`ä“
(
c
->
timeout
);

295 
	`ä“
(
c
);

296 
	}
}

303 
	$memÿchedBufãrR—d
(
mcCÚ‹xt
 *
c
) {

304 
buf
[1024*16];

305 
Ä—d
;

308 ià(
c
->
”r
)

309  
MC_ERR
;

311 
Ä—d
 = 
	`»ad
(
c
->
fd
,
buf
,(buf));

312 ià(
Ä—d
 == -1) {

313 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
MC_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

316 
	`__memÿchedS‘E¼Ü
(
c
,
MC_ERR_IO
,
NULL
);

317  
MC_ERR
;

319 } ià(
Ä—d
 == 0) {

320 
	`__memÿchedS‘E¼Ü
(
c
,
MC_ERR_EOF
,"Server closedhe connection");

321  
MC_ERR
;

323 ià(
	`memÿchedR—d”F“d
(
c
->
»ad”
,
buf
,
Ä—d
è!ğ
MC_OK
) {

324 
	`__memÿchedS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

325  
MC_ERR
;

328  
MC_OK
;

329 
	}
}

331 
	$g‘Reque¡Ty³FromSŒšg
(*
¡r
, 
size_t
 
Ën
)

333 ià(
¡r
 =ğ
NULL
 || 
Ën
 == 0)

336 ià(
Ën
 == 3) {

337 ià(!
	`¡ºÿ£cmp
(
¡r
,"set",3) ||

338 !
	`¡ºÿ£cmp
(
¡r
,"add",3)) {

339  
REQ_TYPE_STORAGE
;

340 } ià(!
	`¡ºÿ£cmp
(
¡r
,"cas",3)) {

341  
REQ_TYPE_CAS
;

342 } ià(!
	`¡ºÿ£cmp
(
¡r
,"get",3)) {

343  
REQ_TYPE_RETRIEVAL
;

347 } ià(
Ën
 == 4) {

348 ià(!
	`¡ºÿ£cmp
(
¡r
,"gets",4)) {

349  
REQ_TYPE_RETRIEVAL
;

350 } ià(!
	`¡ºÿ£cmp
(
¡r
,"incr",4) ||

351 !
	`¡ºÿ£cmp
(
¡r
,"decr",4)) {

352  
REQ_TYPE_ARITHMETIC
;

356 } ià(
Ën
 == 6) {

357 ià(!
	`¡ºÿ£cmp
(
¡r
,"append",6)) {

358  
REQ_TYPE_STORAGE
;

359 } ià(!
	`¡ºÿ£cmp
(
¡r
,"delete",6)) {

360  
REQ_TYPE_DELETE
;

364 } ià(
Ën
 == 7) {

365 ià(!
	`¡ºÿ£cmp
(
¡r
,"replace",7) ||

366 !
	`¡ºÿ£cmp
(
¡r
,"prepend",7)) {

367  
REQ_TYPE_STORAGE
;

374 
	}
}

376 
	#ARGUMENTLEN
(
_¬gty³
,
_¬gv
,
_¬gvËn
,
_idx
) \

377 (
_¬gty³
==0?
	`sd¦’
(
_¬gv
[
_idx
]):(
_¬gvËn
==
NULL
?
	`¡¾’
(_¬gv[_idx]):_¬gvËn[_idx]))

	)

384 
	$checkCmdV®idAndG‘TÙ®L’
(
cmdty³
, 
¬gty³
, 
¬gc
, **
¬gv
, 
size_t
 *
¬gvËn
)

386 
size_t
 
Ën
;

387 
tÙËn
, 
j
;

389 
cmdty³
) {

390 
REQ_TYPE_STORAGE
:

391 ià(
¬gc
 != 6 &&‡rgc != 7) {

394 ià(
¬gc
 =ğ7 && (
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,5) != 7 ||

395 
	`¡ºÿ£cmp
(
¬gv
[5],"noreply",7))) {

399 
tÙËn
 = 0;

400 
j
 = 0; j < 
¬gc
-1; j ++) {

401 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
) + 1;

403 
tÙËn
 +ğ2 + 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1) + 2;

405 
REQ_TYPE_CAS
:

406 ià(
¬gc
 != 7 &&‡rgc != 8) {

409 ià(
¬gc
 =ğ8 && (
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,6) != 7 ||

410 
	`¡ºÿ£cmp
(
¬gv
[6],"noreply",7))) {

414 
tÙËn
 = 0;

415 
j
 = 0; j < 
¬gc
-1; j ++) {

416 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
) + 1;

418 
tÙËn
 +ğ2 + 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1) + 2;

420 
REQ_TYPE_ARITHMETIC
:

421 ià(
¬gc
 != 3) {

424 
tÙËn
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,0) + 1 +

425 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,1) + 1 +

426 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,2) + 2;

428 
REQ_TYPE_RETRIEVAL
:

429 ià(
¬gc
 <= 1) {

433 
tÙËn
 = 0;

434 
j
 = 0; j < 
¬gc
-1; j ++) {

435 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
) + 1;

437 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1) + 2;

439 
REQ_TYPE_DELETE
:

440 ià(
¬gc
 != 2 &&‡rgc != 3) {

444 
tÙËn
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,0) + 1 +

445 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,1);

446 ià(
¬gc
 == 3) {

447 ià(
	`¡ºÿ£cmp
(
¬gv
[2],"noreply",7)) {

450 
tÙËn
 +ğ1 + 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,2);

452 
tÙËn
 += 2;

455 
tÙËn
 = -1;

459  
tÙËn
;

460 
	}
}

463 
	$g’”icMemÿchedCommªd
(
cmdty³
, *
cmd
, 
¬gty³
, 
¬gc
, **
¬gv
, 
size_t
 *
¬gvËn
)

465 
j
;

466 
size_t
 
Ën
;

467 
pos
 = 0;

469 
cmdty³
) {

470 
REQ_TYPE_STORAGE
:

471 
REQ_TYPE_CAS
:

472 
j
 = 0; j < 
¬gc
-1; j ++) {

473 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
);

474 
	`memıy
(
cmd
+
pos
,
¬gv
[
j
],
Ën
);

475 
pos
 +ğ()
Ën
;

476 
cmd
[
pos
++] = ' ';

478 
cmd
[
pos
++] = '\r';

479 
cmd
[
pos
++] = '\n';

480 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1);

481 
	`memıy
(
cmd
+
pos
,
¬gv
[
¬gc
-1],
Ën
);

482 
pos
 +ğ()
Ën
;

483 
cmd
[
pos
++] = '\r';

484 
cmd
[
pos
++] = '\n';

486 
REQ_TYPE_ARITHMETIC
:

487 
REQ_TYPE_RETRIEVAL
:

488 
REQ_TYPE_DELETE
:

489 
j
 = 0; j < 
¬gc
-1; j ++) {

490 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
);

491 
	`memıy
(
cmd
+
pos
,
¬gv
[
j
],
Ën
);

492 
pos
 +ğ
Ën
;

493 
cmd
[
pos
++] = ' ';

495 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1);

496 
	`memıy
(
cmd
+
pos
,
¬gv
[
¬gc
-1],
Ën
);

497 
pos
 +ğ()
Ën
;

498 
cmd
[
pos
++] = '\r';

499 
cmd
[
pos
++] = '\n';

502 
pos
 = -1;

506  
pos
;

507 
	}
}

512 
	$memÿchedFÜm©CommªdSdsArgv
(**
rg‘
, 
¬gc
, cÚ¡ 
sds
 *
¬gv
) {

513 *
cmd
 = 
NULL
;

514 
pos
;

515 
tÙËn
;

516 
ty³
;

519 ià(
rg‘
 =ğ
NULL
 || 
¬gc
 < 1)

522 
ty³
 = 
	`g‘Reque¡Ty³FromSŒšg
(
¬gv
[0], 
	`sd¦’
(argv[0]));

523 ià(
ty³
 < 0)

524 
fÜm©_”r
;

526 
tÙËn
 = 
	`checkCmdV®idAndG‘TÙ®L’
(
ty³
, 0, 
¬gc
, 
¬gv
, 
NULL
);

527 ià(
tÙËn
 < 0) {

528 
fÜm©_”r
;

532 
cmd
 = 
	`m®loc
(
tÙËn
+1);

533 ià(
cmd
 =ğ
NULL
è
memÜy_”r
;

535 
pos
 = 
	`g’”icMemÿchedCommªd
(
ty³
, 
cmd
, 0, 
¬gc
, 
¬gv
, 
NULL
);

536 ià(
pos
 < 0è
fÜm©_”r
;

538 
	`as£¹
(
pos
 =ğ
tÙËn
);

539 
cmd
[
pos
] = '\0';

541 *
rg‘
 = 
cmd
;

542  
tÙËn
;

544 
fÜm©_”r
:

545 ià(
cmd
è
	`ä“
(cmd);

548 
memÜy_”r
:

550 
	}
}

552 
	$memÿchedvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

554 cÚ¡ *
c
 = 
fÜm©
;

555 *
cmd
 = 
NULL
;

556 
pos
;

557 
sds
 
cu¿rg
, 
Ãw¬g
;

558 
touched
 = 0;

559 **
cu¿rgv
 = 
NULL
, **
Ãw¬gv
 = NULL;

560 
¬gc
 = 0;

561 
tÙËn
;

562 
”rÜ_ty³
 = 0;

563 
j
;

566 ià(
rg‘
 =ğ
NULL
)

570 
cu¿rg
 = 
	`sd£m±y
();

571 ià(
cu¿rg
 =ğ
NULL
)

574 *
c
 != '\0') {

575 ià(*
c
 != '%' || c[1] == '\0') {

576 ià(*
c
 == ' ') {

577 ià(
touched
) {

578 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

579 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

580 
cu¿rgv
 = 
Ãw¬gv
;

581 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

584 
cu¿rg
 = 
	`sd£m±y
();

585 ià(
cu¿rg
 =ğ
NULL
è
memÜy_”r
;

586 
touched
 = 0;

589 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
c
,1);

590 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

591 
cu¿rg
 = 
Ãw¬g
;

592 
touched
 = 1;

595 *
¬g
;

596 
size_t
 
size
;

599 
Ãw¬g
 = 
cu¿rg
;

601 
c
[1]) {

603 
¬g
 = 
	`va_¬g
(
­
,*);

604 
size
 = 
	`¡¾’
(
¬g
);

605 ià(
size
 > 0)

606 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

609 
¬g
 = 
	`va_¬g
(
­
,*);

610 
size
 = 
	`va_¬g
(
­
,
size_t
);

611 ià(
size
 > 0)

612 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

615 
Ãw¬g
 = 
	`sdsÿt
(
cu¿rg
,"%");

620 cÚ¡ 
štfmts
[] = "diouxX";

621 cÚ¡ 
æags
[] = "#0-+ ";

622 
_fÜm©
[16];

623 cÚ¡ *
_p
 = 
c
+1;

624 
size_t
 
_l
 = 0;

625 
va_li¡
 
_ıy
;

628 *
_p
 !ğ'\0' && 
	`¡rchr
(
æags
,*_pè!ğ
NULL
) _p++;

631 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

634 ià(*
_p
 == '.') {

635 
_p
++;

636 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

640 
	`va_cİy
(
_ıy
,
­
);

643 ià(
	`¡rchr
(
štfmts
,*
_p
è!ğ
NULL
) {

644 
	`va_¬g
(
­
,);

645 
fmt_v®id
;

649 ià(
	`¡rchr
("eEfFgGaA",*
_p
è!ğ
NULL
) {

650 
	`va_¬g
(
­
,);

651 
fmt_v®id
;

655 ià(
_p
[0] == 'h' && _p[1] == 'h') {

656 
_p
 += 2;

657 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

658 
	`va_¬g
(
­
,);

659 
fmt_v®id
;

661 
fmt_šv®id
;

665 ià(
_p
[0] == 'h') {

666 
_p
 += 1;

667 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

668 
	`va_¬g
(
­
,);

669 
fmt_v®id
;

671 
fmt_šv®id
;

675 ià(
_p
[0] == 'l' && _p[1] == 'l') {

676 
_p
 += 2;

677 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

678 
	`va_¬g
(
­
,);

679 
fmt_v®id
;

681 
fmt_šv®id
;

685 ià(
_p
[0] == 'l') {

686 
_p
 += 1;

687 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

688 
	`va_¬g
(
­
,);

689 
fmt_v®id
;

691 
fmt_šv®id
;

694 
fmt_šv®id
:

695 
	`va_’d
(
_ıy
);

696 
fÜm©_”r
;

698 
fmt_v®id
:

699 
_l
 = (
_p
+1)-
c
;

700 ià(
_l
 < (
_fÜm©
)-2) {

701 
	`memıy
(
_fÜm©
,
c
,
_l
);

702 
_fÜm©
[
_l
] = '\0';

703 
Ãw¬g
 = 
	`sdsÿtv´štf
(
cu¿rg
,
_fÜm©
,
_ıy
);

707 
c
 = 
_p
-1;

710 
	`va_’d
(
_ıy
);

715 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

716 
cu¿rg
 = 
Ãw¬g
;

718 
touched
 = 1;

719 
c
++;

721 
c
++;

725 ià(
touched
) {

726 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

727 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

728 
cu¿rgv
 = 
Ãw¬gv
;

729 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

731 
	`sdsä“
(
cu¿rg
);

735 
cu¿rg
 = 
NULL
;

737 
tÙËn
 = 
	`memÿchedFÜm©CommªdSdsArgv
(&
cmd
, 
¬gc
,
cu¿rgv
);

738 ià(
tÙËn
 < 0) {

739 
”rÜ_ty³
 = 
tÙËn
;

740 
ş—nup
;

743 
	`ä“
(
cu¿rgv
);

744 *
rg‘
 = 
cmd
;

745  
tÙËn
;

747 
fÜm©_”r
:

748 
”rÜ_ty³
 = -2;

749 
ş—nup
;

751 
memÜy_”r
:

752 
”rÜ_ty³
 = -1;

753 
ş—nup
;

755 
ş—nup
:

756 ià(
cu¿rgv
) {

757 
¬gc
--)

758 
	`sdsä“
(
cu¿rgv
[
¬gc
]);

759 
	`ä“
(
cu¿rgv
);

762 
	`sdsä“
(
cu¿rg
);

766 ià(
cmd
 !ğ
NULL
)

767 
	`ä“
(
cmd
);

769  
”rÜ_ty³
;

770 
	}
}

784 
	$memÿchedFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...) {

785 
va_li¡
 
­
;

786 
Ën
;

787 
	`va_¡¬t
(
­
,
fÜm©
);

788 
Ën
 = 
	`memÿchedvFÜm©Commªd
(
rg‘
,
fÜm©
,
­
);

789 
	`va_’d
(
­
);

793 ià(
Ën
 < 0)

794 
Ën
 = -1;

796  
Ën
;

797 
	}
}

804 
	$memÿchedFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

805 *
cmd
 = 
NULL
;

806 
pos
;

807 
tÙËn
;

808 
ty³
;

811 ià(
rg‘
 =ğ
NULL
 || 
¬gc
 < 1)

814 
ty³
 = 
	`g‘Reque¡Ty³FromSŒšg
(
¬gv
[0], 
¬gvËn
==
NULL
?
	`¡¾’
(argv[0]):argvlen[0]);

815 ià(
ty³
 < 0) {

816 
fÜm©_”r
;

819 
tÙËn
 = 
	`checkCmdV®idAndG‘TÙ®L’
(
ty³
, 1, 
¬gc
, 
¬gv
, 
¬gvËn
);

820 ià(
tÙËn
 < 0) {

821 
fÜm©_”r
;

825 
cmd
 = 
	`m®loc
(
tÙËn
+1);

826 ià(
cmd
 =ğ
NULL
è
memÜy_”r
;

828 
pos
 = 
	`g’”icMemÿchedCommªd
(
ty³
, 
cmd
, 1, 
¬gc
, 
¬gv
, 
¬gvËn
);

829 ià(
pos
 < 0) {

830 
fÜm©_”r
;

833 
	`as£¹
(
pos
 =ğ
tÙËn
);

834 
cmd
[
pos
] = '\0';

836 *
rg‘
 = 
cmd
;

837  
tÙËn
;

839 
fÜm©_”r
:

840 ià(
cmd
è
	`ä“
(cmd);

843 
memÜy_”r
:

845 
	}
}

	@dep/himemcached-0.1.0/himemcached.h

1 #iâdeà
_HIMEMCACHED_H_


2 
	#_HIMEMCACHED_H_


	)

4 
	~"himü—d.h
"

5 
	~"himcd•/sds.h
"

7 
	#HIMC_MAJOR
 0

	)

8 
	#HIMC_MINOR
 13

	)

9 
	#HIMC_PATCH
 1

	)

13 
	#MC_BLOCK
 0x1

	)

17 
	#MC_CONNECTED
 0x2

	)

23 
	#MC_DISCONNECTING
 0x4

	)

27 
	#MC_FREEING
 0x8

	)

30 
	#MC_IN_CALLBACK
 0x10

	)

33 
	#MC_SUBSCRIBED
 0x20

	)

36 
	#MC_MONITORING
 0x40

	)

39 
	#MC_REUSEADDR
 0x80

	)

41 
	#MC_KEEPALIVE_INTERVAL
 15

	)

45 
	#MC_CONNECT_RETRIES
 10

	)

48 
	smcR•ly
 {

49 
	mty³
;

50 
	mš‹g”
;

51 
	mkeyËn
;

52 *
	mkey
;

53 
	mËn
;

54 *
	m¡r
;

55 
	mæags
;

56 
	mv”siÚ
;

57 
size_t
 
	m–em’ts
;

58 
mcR•ly
 **
	m–em’t
;

59 } 
	tmcR•ly
;

61 
mcR—d”
 *
memÿchedR—d”C»©e
();

64 
ä“McR•lyObjeù
(*
»¶y
);

66 
	emcCÚÃùiÚTy³
 {

67 
	mMC_CONN_TCP
,

68 
	mMC_CONN_UNIX
,

72 
	smcCÚ‹xt
 {

73 
	m”r
;

74 
	m”r¡r
[128];

75 
	mfd
;

76 
	mæags
;

77 *
	mobuf
;

78 
mcR—d”
 *
	m»ad”
;

80 
mcCÚÃùiÚTy³
 
	mcÚÃùiÚ_ty³
;

81 
timev®
 *
	mtimeout
;

84 *
	mho¡
;

85 *
	msourû_addr
;

86 
	mpÜt
;

87 } 
	mtı
;

90 *
	m·th
;

91 } 
	munix_sock
;

92 } 
	tmcCÚ‹xt
;

94 
memÿchedBufãrWr™e
(
mcCÚ‹xt
 *
c
, *
dÚe
);

95 
memÿchedBufãrR—d
(
mcCÚ‹xt
 *
c
);

97 
memÿchedG‘R•lyFromR—d”
(
mcCÚ‹xt
 *
c
, **
»¶y
);

98 
memÿchedG‘R•ly
(
mcCÚ‹xt
 *
c
, **
»¶y
);

100 
mcCÚ‹xt
 *
memÿchedCÚ‹xtIn™
();

101 
memÿchedF»e
(
mcCÚ‹xt
 *
c
) ;

103 
memÿchedFÜm©CommªdSdsArgv
(**
rg‘
, 
¬gc
, cÚ¡ 
sds
 *
¬gv
);

104 
memÿchedvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

105 
memÿchedFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...);

106 
memÿchedFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

	@dep/sds/sds.c

33 
	~<¡dio.h
>

34 
	~<¡dlib.h
>

35 
	~<¡ršg.h
>

36 
	~<ùy³.h
>

37 
	~<as£¹.h
>

39 
	~<sds.h
>

40 
	~<sd§Îoc.h
>

42 
šlše
 
	$sdsHdrSize
(
ty³
) {

43 
ty³
&
SDS_TYPE_MASK
) {

44 
SDS_TYPE_5
:

45  (
sdshdr5
);

46 
SDS_TYPE_8
:

47  (
sdshdr8
);

48 
SDS_TYPE_16
:

49  (
sdshdr16
);

50 
SDS_TYPE_32
:

51  (
sdshdr32
);

52 
SDS_TYPE_64
:

53  (
sdshdr64
);

56 
	}
}

58 
šlše
 
	$sdsReqTy³
(
size_t
 
¡ršg_size
) {

59 ià(
¡ršg_size
 < 32)

60  
SDS_TYPE_5
;

61 ià(
¡ršg_size
 < 0xff)

62  
SDS_TYPE_8
;

63 ià(
¡ršg_size
 < 0xffff)

64  
SDS_TYPE_16
;

65 ià(
¡ršg_size
 < 0xffffffff)

66  
SDS_TYPE_32
;

67  
SDS_TYPE_64
;

68 
	}
}

82 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

83 *
sh
;

84 
sds
 
s
;

85 
ty³
 = 
	`sdsReqTy³
(
š™Ën
);

88 ià(
ty³
 =ğ
SDS_TYPE_5
 && 
š™Ën
 =ğ0èty³ = 
SDS_TYPE_8
;

89 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

90 *
å
;

92 
sh
 = 
	`s_m®loc
(
hd¾’
+
š™Ën
+1);

93 ià(!
š™
)

94 
	`mem£t
(
sh
, 0, 
hd¾’
+
š™Ën
+1);

95 ià(
sh
 =ğ
NULL
)  NULL;

96 
s
 = (*)
sh
+
hd¾’
;

97 
å
 = ((*)
s
)-1;

98 
ty³
) {

99 
SDS_TYPE_5
: {

100 *
å
 = 
ty³
 | (
š™Ën
 << 
SDS_TYPE_BITS
);

103 
SDS_TYPE_8
: {

104 
	`SDS_HDR_VAR
(8,
s
);

105 
sh
->
Ën
 = 
š™Ën
;

106 
sh
->
®loc
 = 
š™Ën
;

107 *
å
 = 
ty³
;

110 
SDS_TYPE_16
: {

111 
	`SDS_HDR_VAR
(16,
s
);

112 
sh
->
Ën
 = 
š™Ën
;

113 
sh
->
®loc
 = 
š™Ën
;

114 *
å
 = 
ty³
;

117 
SDS_TYPE_32
: {

118 
	`SDS_HDR_VAR
(32,
s
);

119 
sh
->
Ën
 = 
š™Ën
;

120 
sh
->
®loc
 = 
š™Ën
;

121 *
å
 = 
ty³
;

124 
SDS_TYPE_64
: {

125 
	`SDS_HDR_VAR
(64,
s
);

126 
sh
->
Ën
 = 
š™Ën
;

127 
sh
->
®loc
 = 
š™Ën
;

128 *
å
 = 
ty³
;

132 ià(
š™Ën
 && 
š™
)

133 
	`memıy
(
s
, 
š™
, 
š™Ën
);

134 
s
[
š™Ën
] = '\0';

135  
s
;

136 
	}
}

140 
sds
 
	$sd£m±y
() {

141  
	`sd¢ewËn
("",0);

142 
	}
}

145 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

146 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

147  
	`sd¢ewËn
(
š™
, 
š™Ën
);

148 
	}
}

151 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

152  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

153 
	}
}

156 
	$sdsä“
(
sds
 
s
) {

157 ià(
s
 =ğ
NULL
) ;

158 
	`s_ä“
((*)
s
-
	`sdsHdrSize
(s[-1]));

159 
	}
}

175 
	$sdsupd©–’
(
sds
 
s
) {

176 
»®Ën
 = 
	`¡¾’
(
s
);

177 
	`sds£’
(
s
, 
»®Ën
);

178 
	}
}

184 
	$sdsş—r
(
sds
 
s
) {

185 
	`sds£’
(
s
, 0);

186 
s
[0] = '\0';

187 
	}
}

195 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

196 *
sh
, *
Ãwsh
;

197 
size_t
 
ava
 = 
	`sd§va
(
s
);

198 
size_t
 
Ën
, 
ÃwËn
;

199 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

200 
hd¾’
;

203 ià(
ava
 >ğ
addËn
è 
s
;

205 
Ën
 = 
	`sd¦’
(
s
);

206 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

207 
ÃwËn
 = (
Ën
+
addËn
);

208 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

209 
ÃwËn
 *= 2;

211 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

213 
ty³
 = 
	`sdsReqTy³
(
ÃwËn
);

218 ià(
ty³
 =ğ
SDS_TYPE_5
èty³ = 
SDS_TYPE_8
;

220 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

221 ià(
Şdty³
==
ty³
) {

222 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
ÃwËn
+1);

223 ià(
Ãwsh
 =ğ
NULL
)  NULL;

224 
s
 = (*)
Ãwsh
+
hd¾’
;

228 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
ÃwËn
+1);

229 ià(
Ãwsh
 =ğ
NULL
)  NULL;

230 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

231 
	`s_ä“
(
sh
);

232 
s
 = (*)
Ãwsh
+
hd¾’
;

233 
s
[-1] = 
ty³
;

234 
	`sds£’
(
s
, 
Ën
);

236 
	`sds£Îoc
(
s
, 
ÃwËn
);

237  
s
;

238 
	}
}

246 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

247 *
sh
, *
Ãwsh
;

248 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

249 
hd¾’
;

250 
size_t
 
Ën
 = 
	`sd¦’
(
s
);

251 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

253 
ty³
 = 
	`sdsReqTy³
(
Ën
);

254 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

255 ià(
Şdty³
==
ty³
) {

256 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
Ën
+1);

257 ià(
Ãwsh
 =ğ
NULL
)  NULL;

258 
s
 = (*)
Ãwsh
+
hd¾’
;

260 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
Ën
+1);

261 ià(
Ãwsh
 =ğ
NULL
)  NULL;

262 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

263 
	`s_ä“
(
sh
);

264 
s
 = (*)
Ãwsh
+
hd¾’
;

265 
s
[-1] = 
ty³
;

266 
	`sds£’
(
s
, 
Ën
);

268 
	`sds£Îoc
(
s
, 
Ën
);

269  
s
;

270 
	}
}

279 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

280 
size_t
 
®loc
 = 
	`sd§Îoc
(
s
);

281  
	`sdsHdrSize
(
s
[-1])+
®loc
+1;

282 
	}
}

286 *
	$sdsAÎocPŒ
(
sds
 
s
) {

287  (*è(
s
-
	`sdsHdrSize
(s[-1]));

288 
	}
}

313 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

314 
æags
 = 
s
[-1];

315 
size_t
 
Ën
;

316 
æags
&
SDS_TYPE_MASK
) {

317 
SDS_TYPE_5
: {

318 *
å
 = ((*)
s
)-1;

319 
ŞdËn
 = 
	`SDS_TYPE_5_LEN
(
æags
);

320 
	`as£¹
((
šü
 > 0 && 
ŞdËn
+incr < 32) || (incr < 0 && oldlen >= ()(-incr)));

321 *
å
 = 
SDS_TYPE_5
 | ((
ŞdËn
+
šü
è<< 
SDS_TYPE_BITS
);

322 
Ën
 = 
ŞdËn
+
šü
;

325 
SDS_TYPE_8
: {

326 
	`SDS_HDR_VAR
(8,
s
);

327 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

328 
Ën
 = (
sh
->ËÀ+ğ
šü
);

331 
SDS_TYPE_16
: {

332 
	`SDS_HDR_VAR
(16,
s
);

333 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

334 
Ën
 = (
sh
->ËÀ+ğ
šü
);

337 
SDS_TYPE_32
: {

338 
	`SDS_HDR_VAR
(32,
s
);

339 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= ()incr) || (incr < 0 && sh->len >= ()(-incr)));

340 
Ën
 = (
sh
->ËÀ+ğ
šü
);

343 
SDS_TYPE_64
: {

344 
	`SDS_HDR_VAR
(64,
s
);

345 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >ğ(
ušt64_t
)incr) || (incr < 0 && sh->len >= (uint64_t)(-incr)));

346 
Ën
 = (
sh
->ËÀ+ğ
šü
);

349 : 
Ën
 = 0;

351 
s
[
Ën
] = '\0';

352 
	}
}

359 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

360 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

362 ià(
Ën
 <ğ
cu¾’
è 
s
;

363 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

364 ià(
s
 =ğ
NULL
)  NULL;

367 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

368 
	`sds£’
(
s
, 
Ën
);

369  
s
;

370 
	}
}

377 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

378 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

380 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

381 ià(
s
 =ğ
NULL
)  NULL;

382 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

383 
	`sds£’
(
s
, 
cu¾’
+
Ën
);

384 
s
[
cu¾’
+
Ën
] = '\0';

385  
s
;

386 
	}
}

392 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

393  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

394 
	}
}

400 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

401  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

402 
	}
}

406 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

407 ià(
	`sd§Îoc
(
s
è< 
Ën
) {

408 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
	`sd¦’
(s));

409 ià(
s
 =ğ
NULL
)  NULL;

411 
	`memıy
(
s
, 
t
, 
Ën
);

412 
s
[
Ën
] = '\0';

413 
	`sds£’
(
s
, 
Ën
);

414  
s
;

415 
	}
}

419 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

420  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

421 
	}
}

429 
	#SDS_LLSTR_SIZE
 21

	)

430 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

431 *
p
, 
aux
;

432 
v
;

433 
size_t
 
l
;

437 
v
 = (
v®ue
 < 0) ? -value : value;

438 
p
 = 
s
;

440 *
p
++ = '0'+(
v
%10);

441 
v
 /= 10;

442 } 
v
);

443 ià(
v®ue
 < 0è*
p
++ = '-';

446 
l
 = 
p
-
s
;

447 *
p
 = '\0';

450 
p
--;

451 
s
 < 
p
) {

452 
aux
 = *
s
;

453 *
s
 = *
p
;

454 *
p
 = 
aux
;

455 
s
++;

456 
p
--;

458  
l
;

459 
	}
}

462 
	$sdsuÎ2¡r
(*
s
, 
v
) {

463 *
p
, 
aux
;

464 
size_t
 
l
;

468 
p
 = 
s
;

470 *
p
++ = '0'+(
v
%10);

471 
v
 /= 10;

472 } 
v
);

475 
l
 = 
p
-
s
;

476 *
p
 = '\0';

479 
p
--;

480 
s
 < 
p
) {

481 
aux
 = *
s
;

482 *
s
 = *
p
;

483 *
p
 = 
aux
;

484 
s
++;

485 
p
--;

487  
l
;

488 
	}
}

494 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

495 
buf
[
SDS_LLSTR_SIZE
];

496 
Ën
 = 
	`sd¦l2¡r
(
buf
,
v®ue
);

498  
	`sd¢ewËn
(
buf
,
Ën
);

499 
	}
}

502 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

503 
va_li¡
 
ıy
;

504 
¡©icbuf
[1024], *
buf
 = sticbuf, *
t
;

505 
size_t
 
buæ’
 = 
	`¡¾’
(
fmt
)*2;

509 ià(
buæ’
 > (
¡©icbuf
)) {

510 
buf
 = 
	`s_m®loc
(
buæ’
);

511 ià(
buf
 =ğ
NULL
)  NULL;

513 
buæ’
 = (
¡©icbuf
);

519 
buf
[
buæ’
-2] = '\0';

520 
	`va_cİy
(
ıy
,
­
);

521 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

522 
	`va_’d
(
ıy
);

523 ià(
buf
[
buæ’
-2] != '\0') {

524 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

525 
buæ’
 *= 2;

526 
buf
 = 
	`s_m®loc
(
buæ’
);

527 ià(
buf
 =ğ
NULL
)  NULL;

534 
t
 = 
	`sdsÿt
(
s
, 
buf
);

535 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

536  
t
;

537 
	}
}

555 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

556 
va_li¡
 
­
;

557 *
t
;

558 
	`va_¡¬t
(
­
, 
fmt
);

559 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

560 
	`va_’d
(
­
);

561  
t
;

562 
	}
}

580 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

581 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

582 cÚ¡ *
f
 = 
fmt
;

583 
i
;

584 
va_li¡
 
­
;

586 
	`va_¡¬t
(
­
,
fmt
);

587 
f
 = 
fmt
;

588 
i
 = 
š™Ën
;

589 *
f
) {

590 
Ãxt
, *
¡r
;

591 
size_t
 
l
;

592 
num
;

593 
unum
;

596 ià(
	`sd§va
(
s
)==0) {

597 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

600 *
f
) {

602 
Ãxt
 = *(
f
+1);

603 
f
++;

604 
Ãxt
) {

607 
¡r
 = 
	`va_¬g
(
­
,*);

608 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

609 ià(
	`sd§va
(
s
è< 
l
) {

610 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

612 
	`memıy
(
s
+
i
,
¡r
,
l
);

613 
	`sdsšş’
(
s
,
l
);

614 
i
 +ğ
l
;

618 ià(
Ãxt
 == 'i')

619 
num
 = 
	`va_¬g
(
­
,);

621 
num
 = 
	`va_¬g
(
­
,);

623 
buf
[
SDS_LLSTR_SIZE
];

624 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

625 ià(
	`sd§va
(
s
è< 
l
) {

626 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

628 
	`memıy
(
s
+
i
,
buf
,
l
);

629 
	`sdsšş’
(
s
,
l
);

630 
i
 +ğ
l
;

635 ià(
Ãxt
 == 'u')

636 
unum
 = 
	`va_¬g
(
­
,);

638 
unum
 = 
	`va_¬g
(
­
,);

640 
buf
[
SDS_LLSTR_SIZE
];

641 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

642 ià(
	`sd§va
(
s
è< 
l
) {

643 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

645 
	`memıy
(
s
+
i
,
buf
,
l
);

646 
	`sdsšş’
(
s
,
l
);

647 
i
 +ğ
l
;

651 
s
[
i
++] = 
Ãxt
;

652 
	`sdsšş’
(
s
,1);

657 
s
[
i
++] = *
f
;

658 
	`sdsšş’
(
s
,1);

661 
f
++;

663 
	`va_’d
(
­
);

666 
s
[
i
] = '\0';

667  
s
;

668 
	}
}

684 
sds
 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

685 *
¡¬t
, *
’d
, *
¥
, *
•
;

686 
size_t
 
Ën
;

688 
¥
 = 
¡¬t
 = 
s
;

689 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

690 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

691 
•
 > 
¥
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

692 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

693 ià(
s
 !ğ
¥
è
	`memmove
(s, sp, 
Ën
);

694 
s
[
Ën
] = '\0';

695 
	`sds£’
(
s
,
Ën
);

696  
s
;

697 
	}
}

715 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

716 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

718 ià(
Ën
 == 0) ;

719 ià(
¡¬t
 < 0) {

720 
¡¬t
 = 
Ën
+start;

721 ià(
¡¬t
 < 0) start = 0;

723 ià(
’d
 < 0) {

724 
’d
 = 
Ën
+end;

725 ià(
’d
 < 0)ƒnd = 0;

727 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

728 ià(
ÃwËn
 != 0) {

729 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

730 
ÃwËn
 = 0;

731 } ià(
’d
 >ğ(sigÃd)
Ën
) {

732 
’d
 = 
Ën
-1;

733 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

736 
¡¬t
 = 0;

738 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
s
, s+start,‚ewlen);

739 
s
[
ÃwËn
] = 0;

740 
	`sds£’
(
s
,
ÃwËn
);

741 
	}
}

744 
	$sd¡Şow”
(
sds
 
s
) {

745 
Ën
 = 
	`sd¦’
(
s
), 
j
;

747 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

748 
	}
}

751 
	$sd¡ouµ”
(
sds
 
s
) {

752 
Ën
 = 
	`sd¦’
(
s
), 
j
;

754 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

755 
	}
}

768 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

769 
size_t
 
l1
, 
l2
, 
mšËn
;

770 
cmp
;

772 
l1
 = 
	`sd¦’
(
s1
);

773 
l2
 = 
	`sd¦’
(
s2
);

774 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

775 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

776 ià(
cmp
 =ğ0è 
l1
-
l2
;

777  
cmp
;

778 
	}
}

796 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

797 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

798 
sds
 *
tok’s
;

800 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

802 
tok’s
 = 
	`s_m®loc
((
sds
)*
¦Ùs
);

803 ià(
tok’s
 =ğ
NULL
)  NULL;

805 ià(
Ën
 == 0) {

806 *
couÁ
 = 0;

807  
tok’s
;

809 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

811 ià(
¦Ùs
 < 
–em’ts
+2) {

812 
sds
 *
Ãwtok’s
;

814 
¦Ùs
 *= 2;

815 
Ãwtok’s
 = 
	`s_»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

816 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

817 
tok’s
 = 
Ãwtok’s
;

820 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

821 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

822 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

823 
–em’ts
++;

824 
¡¬t
 = 
j
+
£¶’
;

825 
j
 = j+
£¶’
-1;

829 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

830 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

831 
–em’ts
++;

832 *
couÁ
 = 
–em’ts
;

833  
tok’s
;

835 
ş—nup
:

837 
i
;

838 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

839 
	`s_ä“
(
tok’s
);

840 *
couÁ
 = 0;

841  
NULL
;

843 
	}
}

846 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

847 ià(!
tok’s
) ;

848 
couÁ
--)

849 
	`sdsä“
(
tok’s
[
couÁ
]);

850 
	`s_ä“
(
tok’s
);

851 
	}
}

859 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

860 
s
 = 
	`sdsÿ’
(s,"\"",1);

861 
Ën
--) {

862 *
p
) {

865 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

867 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

868 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

869 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

870 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

871 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

873 ià(
	`i¥ršt
(*
p
))

874 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

876 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

879 
p
++;

881  
	`sdsÿ’
(
s
,"\"",1);

882 
	}
}

886 
	$is_hex_dig™
(
c
) {

887  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

888 (
c
 >= 'A' && c <= 'F');

889 
	}
}

893 
	$hex_dig™_to_št
(
c
) {

894 
c
) {

913 
	}
}

934 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

935 cÚ¡ *
p
 = 
lše
;

936 *
cu¼’t
 = 
NULL
;

937 **
veùÜ
 = 
NULL
;

939 *
¬gc
 = 0;

942 *
p
 && 
	`is¥aû
(*p))…++;

943 ià(*
p
) {

945 
šq
=0;

946 
šsq
=0;

947 
dÚe
=0;

949 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

950 !
dÚe
) {

951 ià(
šq
) {

952 ià(*
p
 == '\\' && *(p+1) == 'x' &&

953 
	`is_hex_dig™
(*(
p
+2)) &&

954 
	`is_hex_dig™
(*(
p
+3)))

956 
by‹
;

958 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

959 
	`hex_dig™_to_št
(*(
p
+3));

960 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

961 
p
 += 3;

962 } ià(*
p
 == '\\' && *(p+1)) {

963 
c
;

965 
p
++;

966 *
p
) {

967 'n': 
c
 = '\n'; ;

968 'r': 
c
 = '\r'; ;

969 't': 
c
 = '\t'; ;

970 'b': 
c
 = '\b'; ;

971 'a': 
c
 = '\a'; ;

972 : 
c
 = *
p
; ;

974 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

975 } ià(*
p
 == '"') {

978 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

979 
dÚe
=1;

980 } ià(!*
p
) {

982 
”r
;

984 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

986 } ià(
šsq
) {

987 ià(*
p
 == '\\' && *(p+1) == '\'') {

988 
p
++;

989 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

990 } ià(*
p
 == '\'') {

993 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

994 
dÚe
=1;

995 } ià(!*
p
) {

997 
”r
;

999 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1002 *
p
) {

1008 
dÚe
=1;

1011 
šq
=1;

1014 
šsq
=1;

1017 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1021 ià(*
p
)…++;

1024 
veùÜ
 = 
	`s_»®loc
(veùÜ,((*
¬gc
)+1)*(*));

1025 
veùÜ
[*
¬gc
] = 
cu¼’t
;

1026 (*
¬gc
)++;

1027 
cu¼’t
 = 
NULL
;

1030 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`s_m®loc
((*));

1031  
veùÜ
;

1035 
”r
:

1036 (*
¬gc
)--)

1037 
	`sdsä“
(
veùÜ
[*
¬gc
]);

1038 
	`s_ä“
(
veùÜ
);

1039 ià(
cu¼’t
è
	`sdsä“
(current);

1040 *
¬gc
 = 0;

1041  
NULL
;

1042 
	}
}

1053 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

1054 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

1056 
j
 = 0; j < 
l
; j++) {

1057 
i
 = 0; i < 
£’
; i++) {

1058 ià(
s
[
j
] =ğ
äom
[
i
]) {

1059 
s
[
j
] = 
to
[
i
];

1064  
s
;

1065 
	}
}

1069 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
) {

1070 
sds
 
još
 = 
	`sd£m±y
();

1071 
j
;

1073 
j
 = 0; j < 
¬gc
; j++) {

1074 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

1075 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿt
(još,
£p
);

1077  
još
;

1078 
	}
}

1081 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

1082 
sds
 
još
 = 
	`sd£m±y
();

1083 
j
;

1085 
j
 = 0; j < 
¬gc
; j++) {

1086 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

1087 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

1089  
još
;

1090 
	}
}

1092 
	$sdsIsNum
(
sds
 
s
) {

1093 
size_t
 
i
;

1095 ià(
s
 =ğ
NULL
 || 
	`sd¦’
(s) == 0) {

1099 
i
 = 0; i < 
	`sd¦’
(
s
); i ++) {

1100 if(*(
s
+
i
) < '0' || *(s+i) > '9'){

1106 
	}
}

1113 *
	$sds_m®loc
(
size_t
 
size
è{  
	`s_m®loc
(size); 
	}
}

1114 *
	$sds_»®loc
(*
±r
, 
size_t
 
size
è{  
	`s_»®loc
ÕŒ,size); 
	}
}

1115 
	$sds_ä“
(*
±r
è{ 
	`s_ä“
ÕŒ); 
	}
}

1117 #ià
defšed
(
SDS_TEST_MAIN
)

1118 
	~<¡dio.h
>

1119 
	~"‹¡h–p.h
"

1120 
	~"lim™s.h
"

1122 
	#UNUSED
(
x
è()(x)

	)

1123 
	$sdsTe¡
() {

1125 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

1127 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

1128 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

1130 
	`sdsä“
(
x
);

1131 
x
 = 
	`sd¢ewËn
("foo",2);

1132 
	`‹¡_cÚd
("Create‡ string with specified†ength",

1133 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

1135 
x
 = 
	`sdsÿt
(x,"bar");

1136 
	`‹¡_cÚd
("Strings concatenation",

1137 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

1139 
x
 = 
	`sdsıy
(x,"a");

1140 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

1141 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

1143 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

1144 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1145 
	`sd¦’
(
x
) == 33 &&

1146 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1148 
	`sdsä“
(
x
);

1149 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1150 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1151 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) == 0)

1153 
	`sdsä“
(
x
);

1154 
x
 = 
	`sd¢ew
("--");

1155 
x
 = 
	`sdsÿtfmt
(x, "H–lØ% WÜld %I,%I--", "Hi!", 
LLONG_MIN
,
LLONG_MAX
);

1156 
	`‹¡_cÚd
("sdscatfmt() seems working inhe base case",

1157 
	`sd¦’
(
x
) == 60 &&

1158 
	`memcmp
(
x
,"--Hello Hi! World -9223372036854775808,"

1160 
	`´štf
("[%s]\n",
x
);

1162 
	`sdsä“
(
x
);

1163 
x
 = 
	`sd¢ew
("--");

1164 
x
 = 
	`sdsÿtfmt
(x, "%u,%U--", 
UINT_MAX
, 
ULLONG_MAX
);

1165 
	`‹¡_cÚd
("sdscatfmt() seems working with unsigned‚umbers",

1166 
	`sd¦’
(
x
) == 35 &&

1167 
	`memcmp
(
x
,"--4294967295,18446744073709551615--",35) == 0)

1169 
	`sdsä“
(
x
);

1170 
x
 = 
	`sd¢ew
(" x ");

1171 
	`sd¡rim
(
x
," x");

1172 
	`‹¡_cÚd
("sdstrim() works when‡ll chars match",

1173 
	`sd¦’
(
x
) == 0)

1175 
	`sdsä“
(
x
);

1176 
x
 = 
	`sd¢ew
(" x ");

1177 
	`sd¡rim
(
x
," ");

1178 
	`‹¡_cÚd
("sdstrim() works when‡ single char„emains",

1179 
	`sd¦’
(
x
) == 1 && x[0] == 'x')

1181 
	`sdsä“
(
x
);

1182 
x
 = 
	`sd¢ew
("xxciaoyyy");

1183 
	`sd¡rim
(
x
,"xy");

1184 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1185 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1187 
y
 = 
	`sdsdup
(
x
);

1188 
	`sd¤ªge
(
y
,1,1);

1189 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1190 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1192 
	`sdsä“
(
y
);

1193 
y
 = 
	`sdsdup
(
x
);

1194 
	`sd¤ªge
(
y
,1,-1);

1195 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1196 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1198 
	`sdsä“
(
y
);

1199 
y
 = 
	`sdsdup
(
x
);

1200 
	`sd¤ªge
(
y
,-2,-1);

1201 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1202 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1204 
	`sdsä“
(
y
);

1205 
y
 = 
	`sdsdup
(
x
);

1206 
	`sd¤ªge
(
y
,2,1);

1207 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1208 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1210 
	`sdsä“
(
y
);

1211 
y
 = 
	`sdsdup
(
x
);

1212 
	`sd¤ªge
(
y
,1,100);

1213 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1214 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1216 
	`sdsä“
(
y
);

1217 
y
 = 
	`sdsdup
(
x
);

1218 
	`sd¤ªge
(
y
,100,100);

1219 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1220 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1222 
	`sdsä“
(
y
);

1223 
	`sdsä“
(
x
);

1224 
x
 = 
	`sd¢ew
("foo");

1225 
y
 = 
	`sd¢ew
("foa");

1226 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1228 
	`sdsä“
(
y
);

1229 
	`sdsä“
(
x
);

1230 
x
 = 
	`sd¢ew
("bar");

1231 
y
 = 
	`sd¢ew
("bar");

1232 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1234 
	`sdsä“
(
y
);

1235 
	`sdsä“
(
x
);

1236 
x
 = 
	`sd¢ew
("aar");

1237 
y
 = 
	`sd¢ew
("bar");

1238 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1240 
	`sdsä“
(
y
);

1241 
	`sdsä“
(
x
);

1242 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1243 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1244 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1245 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1248 
Şdä“
;

1249 *
p
;

1250 
¡•
 = 10, 
j
, 
i
;

1252 
	`sdsä“
(
x
);

1253 
	`sdsä“
(
y
);

1254 
x
 = 
	`sd¢ew
("0");

1255 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
	`sd¦’
(
x
è=ğ1 && 
	`sd§va
(x) == 0);

1259 
i
 = 0; i < 10; i++) {

1260 
ŞdËn
 = 
	`sd¦’
(
x
);

1261 
x
 = 
	`sdsMakeRoomFÜ
(x,
¡•
);

1262 
ty³
 = 
x
[-1]&
SDS_TYPE_MASK
;

1264 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èËn", 
	`sd¦’
(
x
è=ğ
ŞdËn
);

1265 ià(
ty³
 !ğ
SDS_TYPE_5
) {

1266 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èä“", 
	`sd§va
(
x
è>ğ
¡•
);

1267 
Şdä“
 = 
	`sd§va
(
x
);

1269 
p
 = 
x
+
ŞdËn
;

1270 
j
 = 0; j < 
¡•
; j++) {

1271 
p
[
j
] = 'A'+j;

1273 
	`sdsInüL’
(
x
,
¡•
);

1275 
	`‹¡_cÚd
("sdsMakeRoomFor() content",

1276 
	`memcmp
("0ABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJ",
x
,101) == 0);

1277 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èfš®†’gth",
	`sd¦’
(
x
)==101);

1279 
	`sdsä“
(
x
);

1282 
	`‹¡_»pÜt
()

1284 
	}
}

1287 #ifdeà
SDS_TEST_MAIN


1288 
	$maš
() {

1289  
	`sdsTe¡
();

1290 
	}
}

	@dep/sds/sds.h

33 #iâdeà
__SDS_H


34 
	#__SDS_H


	)

36 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

38 
	~<sys/ty³s.h
>

39 
	~<¡d¬g.h
>

40 
	~<¡dšt.h
>

42 *
	tsds
;

46 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr5
 {

47 
	gæags
;

48 
	gbuf
[];

50 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr8
 {

51 
ušt8_t
 
	gËn
;

52 
ušt8_t
 
	g®loc
;

53 
	gæags
;

54 
	gbuf
[];

56 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr16
 {

57 
ušt16_t
 
	gËn
;

58 
ušt16_t
 
	g®loc
;

59 
	gæags
;

60 
	gbuf
[];

62 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr32
 {

63 
ušt32_t
 
	gËn
;

64 
ušt32_t
 
	g®loc
;

65 
	gæags
;

66 
	gbuf
[];

68 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr64
 {

69 
ušt64_t
 
	gËn
;

70 
ušt64_t
 
	g®loc
;

71 
	gæags
;

72 
	gbuf
[];

75 
	#SDS_TYPE_5
 0

	)

76 
	#SDS_TYPE_8
 1

	)

77 
	#SDS_TYPE_16
 2

	)

78 
	#SDS_TYPE_32
 3

	)

79 
	#SDS_TYPE_64
 4

	)

80 
	#SDS_TYPE_MASK
 7

	)

81 
	#SDS_TYPE_BITS
 3

	)

82 
	#SDS_HDR_VAR
(
T
,
s
è
sdshdr
##T *
sh
 = (*)((s)-((sdshdr##T)));

	)

83 
	#SDS_HDR
(
T
,
s
è((
sdshdr
##T *)((s)-((sdshdr##T))))

	)

84 
	#SDS_TYPE_5_LEN
(
f
è((f)>>
SDS_TYPE_BITS
)

	)

86 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

87 
æags
 = 
s
[-1];

88 
æags
&
SDS_TYPE_MASK
) {

89 
SDS_TYPE_5
:

90  
	`SDS_TYPE_5_LEN
(
æags
);

91 
SDS_TYPE_8
:

92  
	`SDS_HDR
(8,
s
)->
Ën
;

93 
SDS_TYPE_16
:

94  
	`SDS_HDR
(16,
s
)->
Ën
;

95 
SDS_TYPE_32
:

96  
	`SDS_HDR
(32,
s
)->
Ën
;

97 
SDS_TYPE_64
:

98  
	`SDS_HDR
(64,
s
)->
Ën
;

101 
	}
}

103 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

104 
æags
 = 
s
[-1];

105 
æags
&
SDS_TYPE_MASK
) {

106 
SDS_TYPE_5
: {

109 
SDS_TYPE_8
: {

110 
	`SDS_HDR_VAR
(8,
s
);

111  
sh
->
®loc
 - sh->
Ën
;

113 
SDS_TYPE_16
: {

114 
	`SDS_HDR_VAR
(16,
s
);

115  
sh
->
®loc
 - sh->
Ën
;

117 
SDS_TYPE_32
: {

118 
	`SDS_HDR_VAR
(32,
s
);

119  
sh
->
®loc
 - sh->
Ën
;

121 
SDS_TYPE_64
: {

122 
	`SDS_HDR_VAR
(64,
s
);

123  
sh
->
®loc
 - sh->
Ën
;

127 
	}
}

129 
šlše
 
	$sds£’
(
sds
 
s
, 
size_t
 
ÃwËn
) {

130 
æags
 = 
s
[-1];

131 
æags
&
SDS_TYPE_MASK
) {

132 
SDS_TYPE_5
:

134 *
å
 = ((*)
s
)-1;

135 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

138 
SDS_TYPE_8
:

139 
	`SDS_HDR
(8,
s
)->
Ën
 = 
ÃwËn
;

141 
SDS_TYPE_16
:

142 
	`SDS_HDR
(16,
s
)->
Ën
 = 
ÃwËn
;

144 
SDS_TYPE_32
:

145 
	`SDS_HDR
(32,
s
)->
Ën
 = 
ÃwËn
;

147 
SDS_TYPE_64
:

148 
	`SDS_HDR
(64,
s
)->
Ën
 = 
ÃwËn
;

151 
	}
}

153 
šlše
 
	$sdsšş’
(
sds
 
s
, 
size_t
 
šc
) {

154 
æags
 = 
s
[-1];

155 
æags
&
SDS_TYPE_MASK
) {

156 
SDS_TYPE_5
:

158 *
å
 = ((*)
s
)-1;

159 
ÃwËn
 = 
	`SDS_TYPE_5_LEN
(
æags
)+
šc
;

160 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

163 
SDS_TYPE_8
:

164 
	`SDS_HDR
(8,
s
)->
Ën
 +ğ
šc
;

166 
SDS_TYPE_16
:

167 
	`SDS_HDR
(16,
s
)->
Ën
 +ğ
šc
;

169 
SDS_TYPE_32
:

170 
	`SDS_HDR
(32,
s
)->
Ën
 +ğ
šc
;

172 
SDS_TYPE_64
:

173 
	`SDS_HDR
(64,
s
)->
Ën
 +ğ
šc
;

176 
	}
}

179 
šlše
 
size_t
 
	$sd§Îoc
(cÚ¡ 
sds
 
s
) {

180 
æags
 = 
s
[-1];

181 
æags
&
SDS_TYPE_MASK
) {

182 
SDS_TYPE_5
:

183  
	`SDS_TYPE_5_LEN
(
æags
);

184 
SDS_TYPE_8
:

185  
	`SDS_HDR
(8,
s
)->
®loc
;

186 
SDS_TYPE_16
:

187  
	`SDS_HDR
(16,
s
)->
®loc
;

188 
SDS_TYPE_32
:

189  
	`SDS_HDR
(32,
s
)->
®loc
;

190 
SDS_TYPE_64
:

191  
	`SDS_HDR
(64,
s
)->
®loc
;

194 
	}
}

196 
šlše
 
	$sds£Îoc
(
sds
 
s
, 
size_t
 
ÃwËn
) {

197 
æags
 = 
s
[-1];

198 
æags
&
SDS_TYPE_MASK
) {

199 
SDS_TYPE_5
:

202 
SDS_TYPE_8
:

203 
	`SDS_HDR
(8,
s
)->
®loc
 = 
ÃwËn
;

205 
SDS_TYPE_16
:

206 
	`SDS_HDR
(16,
s
)->
®loc
 = 
ÃwËn
;

208 
SDS_TYPE_32
:

209 
	`SDS_HDR
(32,
s
)->
®loc
 = 
ÃwËn
;

211 
SDS_TYPE_64
:

212 
	`SDS_HDR
(64,
s
)->
®loc
 = 
ÃwËn
;

215 
	}
}

217 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

218 
sds
 
sd¢ew
(cÚ¡ *
š™
);

219 
sds
 
sd£m±y
();

220 
sds
 
sdsdup
(cÚ¡ sd 
s
);

221 
sdsä“
(
sds
 
s
);

222 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

223 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

224 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

225 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

226 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

227 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

229 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

230 #ifdeà
__GNUC__


231 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

232 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

234 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

237 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

238 
sds
 
	`sd¡rim
(sd 
s
, cÚ¡ *
c£t
);

239 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

240 
	`sdsupd©–’
(
sds
 
s
);

241 
	`sdsş—r
(
sds
 
s
);

242 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

243 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

244 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

245 
	`sd¡Şow”
(
sds
 
s
);

246 
	`sd¡ouµ”
(
sds
 
s
);

247 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

248 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

249 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

250 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

251 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
);

252 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

254 
	`sdsIsNum
(
sds
 
s
);

257 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

258 
	`sdsInüL’
(
sds
 
s
, 
šü
);

259 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

260 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

261 *
	`sdsAÎocPŒ
(
sds
 
s
);

267 *
	`sds_m®loc
(
size_t
 
size
);

268 *
	`sds_»®loc
(*
±r
, 
size_t
 
size
);

269 
	`sds_ä“
(*
±r
);

271 #ifdeà
REDIS_TEST


272 
	`sdsTe¡
(
¬gc
, *
¬gv
[]);

	@dep/sds/sdsalloc.h

39 
	~<dm®loc.h
>

41 
	#s_m®loc
 
d®loc


	)

42 
	#s_»®loc
 
d»®loc


	)

43 
	#s_ä“
 
dä“


	)

	@dep/util/dlog.c

1 
	~<¡dlib.h
>

2 
	~<¡d¬g.h
>

3 
	~<uni¡d.h
>

4 
	~<ùy³.h
>

5 
	~<time.h
>

6 
	~<sys/¡©.h
>

7 
	~<fú.h
>

8 
	~<”ºo.h
>

10 
	~<dut.h
>

11 
	~<dlog.h
>

13 
logg”
 
	glogg”
;

16 
	$log_š™
(
Ëv–
, *
Çme
)

18 
logg”
 *
l
 = &logger;

20 
l
->
Ëv–
 = 
	`MAX
(
LOG_EMERG
, 
	`MIN
Öev–, 
LOG_PVERB
));

21 
l
->
Çme
 =‚ame;

22 ià(
Çme
 =ğ
NULL
 || !
	`¡¾’
(name)) {

23 
l
->
fd
 = 
STDERR_FILENO
;

25 
l
->
fd
 = 
	`İ’
(
Çme
, 
O_WRONLY
 | 
O_APPEND
 | 
O_CREAT
, 0644);

26 ià(
l
->
fd
 < 0) {

27 
	`log_¡d”r
("İ’šg†og f'%s' faed: %s", 
Çme
,

28 
	`¡»¼Ü
(
”ºo
));

34 
	}
}

37 
	$log_deš™
()

39 
logg”
 *
l
 = &logger;

41 ià(
l
->
fd
 < 0 ||†->fd =ğ
STDERR_FILENO
) {

45 
	`şo£
(
l
->
fd
);

46 
	}
}

49 
	$log_»İ’
()

51 
logg”
 *
l
 = &logger;

53 ià(
l
->
fd
 !ğ
STDERR_FILENO
) {

54 
	`şo£
(
l
->
fd
);

55 
l
->
fd
 = 
	`İ’
Ö->
Çme
, 
O_WRONLY
 | 
O_APPEND
 | 
O_CREAT
, 0644);

56 ià(
l
->
fd
 < 0) {

57 
	`log_¡d”r_§ã
("»İ’šg†og f'%s' faed, ignÜed: %s", 
l
->
Çme
,

58 
	`¡»¼Ü
(
”ºo
));

61 
	}
}

64 
	$log_Ëv–_up
()

66 
logg”
 *
l
 = &logger;

68 ià(
l
->
Ëv–
 < 
LOG_PVERB
) {

69 
l
->
Ëv–
++;

70 
	`log_§ã
("u°log†ev–Ø%d", 
l
->
Ëv–
);

72 
	}
}

75 
	$log_Ëv–_down
()

77 
logg”
 *
l
 = &logger;

79 ià(
l
->
Ëv–
 > 
LOG_EMERG
) {

80 
l
->
Ëv–
--;

81 
	`log_§ã
("dowÀlog†ev–Ø%d", 
l
->
Ëv–
);

83 
	}
}

86 
	$log_Ëv–_£t
(
Ëv–
)

88 
logg”
 *
l
 = &logger;

90 
l
->
Ëv–
 = 
	`MAX
(
LOG_EMERG
, 
	`MIN
Öev–, 
LOG_PVERB
));

91 
	`loga
("£ˆlog†ev–Ø%d", 
l
->
Ëv–
);

92 
	}
}

95 
	$log_¡ackŒaû
()

97 
logg”
 *
l
 = &logger;

99 ià(
l
->
fd
 < 0) {

102 
	`d¡ackŒaû_fd
(
l
->
fd
);

103 
	}
}

106 
	$log_loggabË
(
Ëv–
)

108 
logg”
 *
l
 = &logger;

110 ià(
Ëv–
 > 
l
->level) {

115 
	}
}

118 
	$_log
(cÚ¡ *
fe
, 
lše
, 
Ëv–
, 
·nic
, cÚ¡ *
fmt
, ...)

120 
logg”
 *
l
 = &logger;

121 
Ën
, 
size
, 
”ºo_§ve
;

122 
buf
[
LOG_MAX_LEN
];

123 
va_li¡
 
¬gs
;

124 
ssize_t
 
n
;

125 
timev®
 
tv
;

127 ià(
l
->
fd
 < 0) {

131 
”ºo_§ve
 = 
”ºo
;

132 
Ën
 = 0;

133 
size
 = 
LOG_MAX_LEN
;

135 
	`g‘timeofday
(&
tv
, 
NULL
);

136 
buf
[
Ën
++] = '[';

137 
Ën
 +ğ
	`d¡ráime
(
buf
 +†’, 
size
 -†’, "%Y-%m-%d %H:%M:%S.", 
	`loÿÉime
(&
tv
.
tv_£c
));

138 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%03ld", 
tv
.
tv_u£c
/1000);

139 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "] %s:%d ", 
fe
, 
lše
);

141 
	`va_¡¬t
(
¬gs
, 
fmt
);

142 
Ën
 +ğ
	`dvsú´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

143 
	`va_’d
(
¬gs
);

145 
buf
[
Ën
++] = '\n';

147 
n
 = 
	`wr™e
(
l
->
fd
, 
buf
, 
Ën
);

148 ià(
n
 < 0) {

149 
l
->
Ã¼Ü
++;

152 
”ºo
 = 
”ºo_§ve
;

154 ià(
·nic
) {

155 
	`abÜt
();

157 
	}
}

160 
	$_log_¡d”r
(cÚ¡ *
fmt
, ...)

162 
logg”
 *
l
 = &logger;

163 
Ën
, 
size
, 
”ºo_§ve
;

164 
buf
[4 * 
LOG_MAX_LEN
];

165 
va_li¡
 
¬gs
;

166 
ssize_t
 
n
;

168 
”ºo_§ve
 = 
”ºo
;

169 
Ën
 = 0;

170 
size
 = 4 * 
LOG_MAX_LEN
;

172 
	`va_¡¬t
(
¬gs
, 
fmt
);

173 
Ën
 +ğ
	`dvsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

174 
	`va_’d
(
¬gs
);

176 
buf
[
Ën
++] = '\n';

178 
n
 = 
	`wr™e
(
STDERR_FILENO
, 
buf
, 
Ën
);

179 ià(
n
 < 0) {

180 
l
->
Ã¼Ü
++;

183 
”ºo
 = 
”ºo_§ve
;

184 
	}
}

187 
	$_log_¡dout
(cÚ¡ *
fmt
, ...)

189 
logg”
 *
l
 = &logger;

190 
Ën
, 
size
, 
”ºo_§ve
;

191 
buf
[4 * 
LOG_MAX_LEN
];

192 
va_li¡
 
¬gs
;

193 
ssize_t
 
n
;

195 
”ºo_§ve
 = 
”ºo
;

196 
Ën
 = 0;

197 
size
 = 4 * 
LOG_MAX_LEN
;

199 
	`va_¡¬t
(
¬gs
, 
fmt
);

200 
Ën
 +ğ
	`dvsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

201 
	`va_’d
(
¬gs
);

203 
buf
[
Ën
++] = '\n';

205 
n
 = 
	`wr™e
(
STDOUT_FILENO
, 
buf
, 
Ën
);

206 ià(
n
 < 0) {

207 
l
->
Ã¼Ü
++;

210 
”ºo
 = 
”ºo_§ve
;

211 
	}
}

218 
	$_log_hexdump
(cÚ¡ *
fe
, 
lše
, *
d©a
, 
d©®’
,

219 cÚ¡ *
fmt
, ...)

221 
logg”
 *
l
 = &logger;

222 
buf
[8 * 
LOG_MAX_LEN
];

223 
i
, 
off
, 
Ën
, 
size
, 
”ºo_§ve
;

224 
ssize_t
 
n
;

226 ià(
l
->
fd
 < 0) {

231 
”ºo_§ve
 = 
”ºo
;

232 
off
 = 0;

233 
Ën
 = 0;

234 
size
 = 8 * 
LOG_MAX_LEN
;

236 
d©®’
 !ğ0 && (
Ën
 < 
size
 - 1)) {

237 *
§ve
, *
¡r
;

238 
c
;

239 
§v–’
;

241 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%08x ", 
off
);

243 
§ve
 = 
d©a
;

244 
§v–’
 = 
d©®’
;

246 
i
 = 0; 
d©®’
 !ğ0 && i < 16; 
d©a
++, datalen--, i++) {

247 
c
 = ()(*
d©a
);

248 
¡r
 = (
i
 == 7) ? " " : " ";

249 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%02x%s", 
c
, 
¡r
);

251  ; 
i
 < 16; i++) {

252 
¡r
 = (
i
 == 7) ? " " : " ";

253 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, " %s", 
¡r
);

256 
d©a
 = 
§ve
;

257 
d©®’
 = 
§v–’
;

259 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†en, " |");

261 
i
 = 0; 
d©®’
 !ğ0 && i < 16; 
d©a
++, datalen--, i++) {

262 
c
 = ()(
	`i¥ršt
(*
d©a
) ? *data : '.');

263 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%c", 
c
);

265 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†en, "|\n");

267 
off
 += 16;

270 
n
 = 
	`wr™e
(
l
->
fd
, 
buf
, 
Ën
);

271 ià(
n
 < 0) {

272 
l
->
Ã¼Ü
++;

275 ià(
Ën
 >ğ
size
 - 1) {

276 
n
 = 
	`wr™e
(
l
->
fd
, "\n", 1);

277 ià(
n
 < 0) {

278 
l
->
Ã¼Ü
++;

282 
”ºo
 = 
”ºo_§ve
;

283 
	}
}

286 
	$_log_§ã
(cÚ¡ *
fmt
, ...)

288 
logg”
 *
l
 = &logger;

289 
Ën
, 
size
, 
”ºo_§ve
;

290 
buf
[
LOG_MAX_LEN
];

291 
va_li¡
 
¬gs
;

292 
ssize_t
 
n
;

294 ià(
l
->
fd
 < 0) {

298 
”ºo_§ve
 = 
”ºo
;

299 
Ën
 = 0;

300 
size
 = 
LOG_MAX_LEN
;

302 
Ën
 +ğ
	`d§ã_¢´štf
(
buf
 +†’, 
size
 -†en, "[.......................] ");

304 
	`va_¡¬t
(
¬gs
, 
fmt
);

305 
Ën
 +ğ
	`d§ã_v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

306 
	`va_’d
(
¬gs
);

308 
buf
[
Ën
++] = '\n';

310 
n
 = 
	`wr™e
(
l
->
fd
, 
buf
, 
Ën
);

311 ià(
n
 < 0) {

312 
l
->
Ã¼Ü
++;

315 
”ºo
 = 
”ºo_§ve
;

316 
	}
}

319 
	$_log_¡d”r_§ã
(cÚ¡ *
fmt
, ...)

321 
logg”
 *
l
 = &logger;

322 
Ën
, 
size
, 
”ºo_§ve
;

323 
buf
[
LOG_MAX_LEN
];

324 
va_li¡
 
¬gs
;

325 
ssize_t
 
n
;

327 
”ºo_§ve
 = 
”ºo
;

328 
Ën
 = 0;

329 
size
 = 
LOG_MAX_LEN
;

331 
Ën
 +ğ
	`d§ã_¢´štf
(
buf
 +†’, 
size
 -†en, "[.......................] ");

333 
	`va_¡¬t
(
¬gs
, 
fmt
);

334 
Ën
 +ğ
	`d§ã_v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

335 
	`va_’d
(
¬gs
);

337 
buf
[
Ën
++] = '\n';

339 
n
 = 
	`wr™e
(
STDERR_FILENO
, 
buf
, 
Ën
);

340 ià(
n
 < 0) {

341 
l
->
Ã¼Ü
++;

344 
”ºo
 = 
”ºo_§ve
;

345 
	}
}

347 
	$log_wr™e_Ën
(*
¡r
, 
size_t
 
Ën
)

349 
logg”
 *
l
 = &logger;

350 
”ºo_§ve
;

351 
ssize_t
 
n
;

353 ià(
l
->
fd
 < 0) {

357 
”ºo_§ve
 = 
”ºo
;

358 
n
 = 
	`wr™e
(
l
->
fd
, 
¡r
, 
Ën
);

359 ià(
n
 < 0) {

360 
l
->
Ã¼Ü
++;

363 
”ºo
 = 
”ºo_§ve
;

364 
	}
}

	@dep/util/dlog.h

1 #iâdeà
_DLOG_H_


2 
	#_DLOG_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	slogg”
 {

9 *
	mÇme
;

10 
	mËv–
;

11 
	mfd
;

12 
	mÃ¼Ü
;

15 
	#LOG_EMERG
 0

	)

16 
	#LOG_ALERT
 1

	)

17 
	#LOG_CRIT
 2

	)

18 
	#LOG_ERR
 3

	)

19 
	#LOG_WARN
 4

	)

20 
	#LOG_NOTICE
 5

	)

21 
	#LOG_INFO
 6

	)

22 
	#LOG_DEBUG
 7

	)

23 
	#LOG_VERB
 8

	)

24 
	#LOG_VVERB
 9

	)

25 
	#LOG_VVVERB
 10

	)

26 
	#LOG_PVERB
 11

	)

28 
	#LOG_MAX_LEN
 256

	)

41 #ifdeà
HAVE_DEBUG_LOG


43 
	#log_debug
(
_Ëv–
, ...) do { \

44 ià(
	`log_loggabË
(
_Ëv–
) != 0) { \

45 
	`_log
(
__FILE__
, 
__LINE__
, 
_Ëv–
, 0, 
__VA_ARGS__
); \

47 } 0)

	)

51 
	#log_debug
(
_Ëv–
, ...)

	)

55 
	#log_hexdump
(
_Ëv–
, 
_d©a
, 
_d©®’
, ...) do { \

56 ià(
	`log_loggabË
(
_Ëv–
) != 0) { \

57 
	`_log
(
__FILE__
, 
__LINE__
, 
_Ëv–
, 0, 
__VA_ARGS__
); \

58 
	`_log_hexdump
(
__FILE__
, 
__LINE__
, (*)(
_d©a
), ()(
_d©®’
), \

59 
__VA_ARGS__
); \

61 } 0)

	)

63 
	#log_¡d”r
(...) do { \

64 
	`_log_¡d”r
(
__VA_ARGS__
); \

65 } 0)

	)

67 
	#log_¡dout
(...) do { \

68 
	`_log_¡dout
(
__VA_ARGS__
); \

69 } 0)

	)

71 
	#log_§ã
(...) do { \

72 
	`_log_§ã
(
__VA_ARGS__
); \

73 } 0)

	)

75 
	#log_¡d”r_§ã
(...) do { \

76 
	`_log_¡d”r_§ã
(
__VA_ARGS__
); \

77 } 0)

	)

79 
	#loga
(...) do { \

80 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 0, 
__VA_ARGS__
); \

81 } 0)

	)

83 
	#loga_hexdump
(
_d©a
, 
_d©®’
, ...) do { \

84 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 0, 
__VA_ARGS__
); \

85 
	`_log_hexdump
(
__FILE__
, 
__LINE__
, (*)(
_d©a
), ()(
_d©®’
), \

86 
__VA_ARGS__
); \

88 

	)

89 
	#log_”rÜ
(...) do { \

90 ià(
	`log_loggabË
(
LOG_ERR
) != 0) { \

91 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_ERR
, 0, 
__VA_ARGS__
); \

93 } 0)

	)

95 
	#log_w¬n
(...) do { \

96 ià(
	`log_loggabË
(
LOG_WARN
) != 0) { \

97 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_WARN
, 0, 
__VA_ARGS__
); \

99 } 0)

	)

101 
	#log_nÙiû
(...) do { \

102 ià(
	`log_loggabË
(
LOG_NOTICE
) != 0) { \

103 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_NOTICE
, 0, 
__VA_ARGS__
); \

105 } 0)

	)

107 
	#log_·nic
(...) do { \

108 ià(
	`log_loggabË
(
LOG_EMERG
) != 0) { \

109 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 1, 
__VA_ARGS__
); \

111 } 0)

	)

113 
log_š™
(
Ëv–
, *
f’ame
);

114 
log_deš™
();

115 
log_Ëv–_up
();

116 
log_Ëv–_down
();

117 
log_Ëv–_£t
(
Ëv–
);

118 
log_¡ackŒaû
();

119 
log_»İ’
();

120 
log_loggabË
(
Ëv–
);

122 
_log
(cÚ¡ *
fe
, 
lše
, 
Ëv–
, 
·nic
, cÚ¡ *
fmt
, ...);

123 
_log_¡d”r
(cÚ¡ *
fmt
, ...);

124 
_log_¡dout
(cÚ¡ *
fmt
, ...);

125 
_log_§ã
(cÚ¡ *
fmt
, ...);

126 
_log_¡d”r_§ã
(cÚ¡ *
fmt
, ...);

127 
_log_hexdump
(cÚ¡ *
fe
, 
lše
, *
d©a
, 
d©®’
, cÚ¡ *
fmt
, ...);

129 
log_wr™e_Ën
(* 
¡r
, 
size_t
 
Ën
);

	@dep/util/dspecialconfig.h

1 #iâdeà
_DSPECIALCONFIG_H_


2 
	#_DSPECIALCONFIG_H_


	)

4 #ifdeà
__APPLE__


5 
	~<Avaab™yMaüos.h
>

8 #ifdeà
__lšux__


9 
	~<lšux/v”siÚ.h
>

10 
	~<ã©u»s.h
>

13 #ià(
__i386
 || 
__amd64
 || 
__pow”pc__
è&& 
__GNUC__


14 
	#GNUC_VERSION
 (
__GNUC__
 * 10000 + 
__GNUC_MINOR__
 * 100 + 
__GNUC_PATCHLEVEL__
)

	)

15 #ià
defšed
(
__şªg__
)

16 
	#HAVE_ATOMIC


	)

18 #ià(
defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
))

19 #ià(
GNUC_VERSION
 >ğ40100 && 
__GLIBC_PREREQ
(2, 6))

20 
	#HAVE_ATOMIC


	)

26 #ià
defšed
(
__sun
)

27 #ià
defšed
(
__GNUC__
)

28 
	~<m©h.h
>

29 #undeà
i¢ª


30 
	#i¢ª
(
x
) \

31 
	`__ex‹nsiÚ__
({ 
	`__ty³of
 (
x
è
__x_a
 = (x); \

32 
	`__butš_ex³ù
(
__x_a
 !ğ__x_a, 0); })

	)

34 #undeà
isfš™e


35 
	#isfš™e
(
x
) \

36 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_f
 = (x); \

37 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_f
 - __x_f), 1); })

	)

39 #undeà
isšf


40 
	#isšf
(
x
) \

41 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_i
 = (x); \

42 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_i
è&& !
	`isfš™e
(__x_i), 0); })

	)

44 
	#u_št
 
ušt


	)

45 
	#u_št32_t
 
ušt32_t


	)

51 #ifdeà
__lšux__


52 
	#HAVE_PROC_STAT
 1

	)

53 
	#HAVE_PROC_MAPS
 1

	)

54 
	#HAVE_PROC_SMAPS
 1

	)

55 
	#HAVE_PROC_SOMAXCONN
 1

	)

59 #ià
defšed
(
__APPLE__
)

60 
	#HAVE_TASKINFO
 1

	)

	@dep/util/dutil.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡d¬g.h
>

4 
	~<¡ršg.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<Ãtdb.h
>

8 
	~<”ºo.h
>

10 
	~<sys/time.h
>

11 
	~<sys/ty³s.h
>

12 
	~<sys/sock‘.h
>

13 
	~<sys/ioùl.h
>

15 
	~<Ãtš‘/š.h
>

16 
	~<Ãtš‘/tı.h
>

18 #ifdeà
HAVE_CONFIG_H


19 
	~<cÚfig.h
>

22 #ifdeà
HAVE_BACKTRACE


23 
	~<execšfo.h
>

26 
	~<dlog.h
>

27 
	~<dut.h
>

30 #ià
defšed
(
__ATOMIC_RELAXED
)

32 #–ià
defšed
(
HAVE_ATOMIC
)

34 
±h»ad_mu‹x_t
 
	g©omic_lock”
 = 
PTHREAD_MUTEX_INITIALIZER
;

38 
	$das£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
)

40 
	`log_”rÜ
("as£¹ '%s' faed @ (%s, %d)", 
cÚd
, 
fe
, 
lše
);

42 ià(
·nic
) {

43 
	`d¡ackŒaû
(1);

44 
	`abÜt
();

46 
	}
}

49 
	$d¡ackŒaû
(
sk_couÁ
)

51 #ifdeà
HAVE_BACKTRACE


52 *
¡ack
[64];

53 **
symbŞs
;

54 
size
, 
i
, 
j
;

56 
size
 = 
	`backŒaû
(
¡ack
, 64);

57 
symbŞs
 = 
	`backŒaû_symbŞs
(
¡ack
, 
size
);

58 ià(
symbŞs
 =ğ
NULL
) {

62 
sk_couÁ
++;

64 
i
 = 
sk_couÁ
, 
j
 = 0; i < 
size
; i++, j++) {

65 
	`loga
("[%d] %s", 
j
, 
symbŞs
[
i
]);

68 
	`ä“
(
symbŞs
);

70 
	}
}

73 
	$d¡ackŒaû_fd
(
fd
)

75 #ifdeà
HAVE_BACKTRACE


76 *
¡ack
[64];

77 
size
;

79 
size
 = 
	`backŒaû
(
¡ack
, 64);

80 
	`backŒaû_symbŞs_fd
(
¡ack
, 
size
, 
fd
);

82 
	}
}

85 
	$_dvsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
)

87 
n
;

89 
n
 = 
	`v¢´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

101 ià(
n
 <= 0) {

105 ià(
n
 < (è
size
) {

106  
n
;

109  ()(
size
 - 1);

110 
	}
}

113 
	$_dsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...)

115 
va_li¡
 
¬gs
;

116 
n
;

118 
	`va_¡¬t
(
¬gs
, 
fmt
);

119 
n
 = 
	`_dvsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

120 
	`va_’d
(
¬gs
);

122  
n
;

123 
	}
}

126 
	$_§ã_utß
(
_ba£
, 
ušt64_t
 
v®
, *
buf
)

128 
hex
[] = "0123456789abcdef";

129 
ušt32_t
 
ba£
 = (ušt32_tè
_ba£
;

130 *
buf
-- = 0;

132 *
buf
-- = 
hex
[
v®
 % 
ba£
];

133 } (
v®
 /ğ
ba£
) != 0);

134  
buf
 + 1;

135 
	}
}

138 
	$_§ã_™ß
(
ba£
, 
št64_t
 
v®
, *
buf
)

140 
hex
[] = "0123456789abcdef";

141 *
Üig_buf
 = 
buf
;

142 cÚ¡ 
št32_t
 
is_Ãg
 = (
v®
 < 0);

143 *
buf
-- = 0;

145 ià(
is_Ãg
) {

146 
v®
 = -val;

148 ià(
is_Ãg
 && 
ba£
 == 16) {

149 
ix
;

150 
v®
 -= 1;

151 
ix
 = 0; ix < 16; ++ix)

152 
buf
[-
ix
] = '0';

156 *
buf
-- = 
hex
[
v®
 % 
ba£
];

157 } (
v®
 /ğ
ba£
) != 0);

159 ià(
is_Ãg
 && 
ba£
 == 10) {

160 *
buf
-- = '-';

163 ià(
is_Ãg
 && 
ba£
 == 16) {

164 
ix
;

165 
buf
 = 
Üig_buf
 - 1;

166 
ix
 = 0; ix < 16; ++ix, --
buf
) {

168 *
buf
) {

169 '0': *
buf
 = 'f'; ;

170 '1': *
buf
 = 'e'; ;

171 '2': *
buf
 = 'd'; ;

172 '3': *
buf
 = 'c'; ;

173 '4': *
buf
 = 'b'; ;

174 '5': *
buf
 = 'a'; ;

175 '6': *
buf
 = '9'; ;

176 '7': *
buf
 = '8'; ;

177 '8': *
buf
 = '7'; ;

178 '9': *
buf
 = '6'; ;

179 'a': *
buf
 = '5'; ;

180 'b': *
buf
 = '4'; ;

181 'c': *
buf
 = '3'; ;

182 'd': *
buf
 = '2'; ;

183 'e': *
buf
 = '1'; ;

184 'f': *
buf
 = '0'; ;

189  
buf
 + 1;

190 
	}
}

193 
	$_§ã_check_lÚglÚg
(cÚ¡ *
fmt
, *
have_lÚglÚg
)

195 *
have_lÚglÚg
 = 0;

196 ià(*
fmt
 == 'l') {

197 
fmt
++;

198 ià(*
fmt
 != 'l') {

199 *
have_lÚglÚg
 = (() == ());

201 
fmt
++;

202 *
have_lÚglÚg
 = 1;

205  
fmt
;

206 
	}
}

209 
	$_§ã_v¢´štf
(*
to
, 
size_t
 
size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

211 *
¡¬t
 = 
to
;

212 *
’d
 = 
¡¬t
 + 
size
 - 1;

213 ; *
fÜm©
; ++format) {

214 
have_lÚglÚg
 = 0;

215 ià(*
fÜm©
 != '%') {

216 ià(
to
 =ğ
’d
) {

219 *
to
++ = *
fÜm©
;

222 ++
fÜm©
;

224 
fÜm©
 = 
	`_§ã_check_lÚglÚg
(fÜm©, &
have_lÚglÚg
);

226 *
fÜm©
) {

233 
št64_t
 
iv®
 = 0;

234 
ušt64_t
 
uv®
 = 0;

235 ià(*
fÜm©
 == 'p')

236 
have_lÚglÚg
 = ((*è=ğ(
ušt64_t
));

237 ià(
have_lÚglÚg
) {

238 ià(*
fÜm©
 == 'u') {

239 
uv®
 = 
	`va_¬g
(
­
, 
ušt64_t
);

241 
iv®
 = 
	`va_¬g
(
­
, 
št64_t
);

244 ià(*
fÜm©
 == 'u') {

245 
uv®
 = 
	`va_¬g
(
­
, 
ušt32_t
);

247 
iv®
 = 
	`va_¬g
(
­
, 
št32_t
);

252 
buff
[22];

253 cÚ¡ 
ba£
 = (*
fÜm©
 == 'x' || *format == 'p') ? 16 : 10;

256 *
v®_as_¡r
 = (*
fÜm©
 == 'u') ?

257 
	`_§ã_utß
(
ba£
, 
uv®
, &
buff
[(buff) - 1]) :

258 
	`_§ã_™ß
(
ba£
, 
iv®
, &
buff
[(buff) - 1]);

262 ià(*
fÜm©
 =ğ'x' && !
have_lÚglÚg
 && 
iv®
 < 0) {

263 
v®_as_¡r
 += 8;

266 *
v®_as_¡r
 && 
to
 < 
’d
) {

267 *
to
++ = *
v®_as_¡r
++;

274 cÚ¡ *
v®
 = 
	`va_¬g
(
­
, *);

275 ià(!
v®
) {

276 
v®
 = "(null)";

278 *
v®
 && 
to
 < 
’d
) {

279 *
to
++ = *
v®
++;

285 *
to
 = 0;

286  ()(
to
 - 
¡¬t
);

287 
	}
}

290 
	$_§ã_¢´štf
(*
to
, 
size_t
 
n
, cÚ¡ *
fmt
, ...)

292 
»suÉ
;

293 
va_li¡
 
¬gs
;

294 
	`va_¡¬t
(
¬gs
, 
fmt
);

295 
»suÉ
 = 
	`_§ã_v¢´štf
(
to
, 
n
, 
fmt
, 
¬gs
);

296 
	`va_’d
(
¬gs
);

297  
»suÉ
;

298 
	}
}

304 
	$du£c_now
()

306 
timev®
 
now
;

307 
št64_t
 
u£c
;

308 
¡©us
;

310 
¡©us
 = 
	`g‘timeofday
(&
now
, 
NULL
);

311 ià(
¡©us
 < 0) {

312 
	`log_”rÜ
("g‘timeofday faed: %s", 
	`¡»¼Ü
(
”ºo
));

316 
u£c
 = (
št64_t
)
now
.
tv_£c
 * 1000000LL + (št64_têow.
tv_u£c
;

318  
u£c
;

319 
	}
}

325 
	$dm£c_now
()

327  
	`du£c_now
() / 1000LL;

328 
	}
}

334 
	$d£c_now
()

336  
	`du£c_now
() / 1000000LL;

337 
	}
}

340 
	$¡ršg_m©ch_Ën
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

341 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

343 
·‰”nL’
) {

344 
·‰”n
[0]) {

346 
·‰”n
[1] == '*') {

347 
·‰”n
++;

348 
·‰”nL’
--;

350 ià(
·‰”nL’
 == 1)

352 
¡ršgL’
) {

353 ià(
	`¡ršg_m©ch_Ën
(
·‰”n
+1, 
·‰”nL’
-1,

354 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

356 
¡ršg
++;

357 
¡ršgL’
--;

362 ià(
¡ršgL’
 == 0)

364 
¡ršg
++;

365 
¡ršgL’
--;

369 
nÙ
, 
m©ch
;

371 
·‰”n
++;

372 
·‰”nL’
--;

373 
nÙ
 = 
·‰”n
[0] == '^';

374 ià(
nÙ
) {

375 
·‰”n
++;

376 
·‰”nL’
--;

378 
m©ch
 = 0;

380 ià(
·‰”n
[0] == '\\') {

381 
·‰”n
++;

382 
·‰”nL’
--;

383 ià(
·‰”n
[0] =ğ
¡ršg
[0])

384 
m©ch
 = 1;

385 } ià(
·‰”n
[0] == ']') {

387 } ià(
·‰”nL’
 == 0) {

388 
·‰”n
--;

389 
·‰”nL’
++;

391 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

392 
¡¬t
 = 
·‰”n
[0];

393 
’d
 = 
·‰”n
[2];

394 
c
 = 
¡ršg
[0];

395 ià(
¡¬t
 > 
’d
) {

396 
t
 = 
¡¬t
;

397 
¡¬t
 = 
’d
;

398 
’d
 = 
t
;

400 ià(
noÿ£
) {

401 
¡¬t
 = 
	`tŞow”
(start);

402 
’d
 = 
	`tŞow”
(end);

403 
c
 = 
	`tŞow”
(c);

405 
·‰”n
 += 2;

406 
·‰”nL’
 -= 2;

407 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

408 
m©ch
 = 1;

410 ià(!
noÿ£
) {

411 ià(
·‰”n
[0] =ğ
¡ršg
[0])

412 
m©ch
 = 1;

414 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

415 
m©ch
 = 1;

418 
·‰”n
++;

419 
·‰”nL’
--;

421 ià(
nÙ
)

422 
m©ch
 = !match;

423 ià(!
m©ch
)

425 
¡ršg
++;

426 
¡ršgL’
--;

430 ià(
·‰”nL’
 >= 2) {

431 
·‰”n
++;

432 
·‰”nL’
--;

436 ià(!
noÿ£
) {

437 ià(
·‰”n
[0] !ğ
¡ršg
[0])

440 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

443 
¡ršg
++;

444 
¡ršgL’
--;

447 
·‰”n
++;

448 
·‰”nL’
--;

449 ià(
¡ršgL’
 == 0) {

450 *
·‰”n
 == '*') {

451 
·‰”n
++;

452 
·‰”nL’
--;

457 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

460 
	}
}

462 
	$¡ršg_m©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

463  
	`¡ršg_m©ch_Ën
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

464 
	}
}

	@dep/util/dutil.h

1 #iâdeà
_DUTIL_H_


2 
	#_DUTIL_H_


	)

4 
	~<¡d¬g.h
>

6 
	~<d¥ecŸlcÚfig.h
>

8 
	#UNUSED
(
x
è()(x)

	)

10 
	#LF
 (
ušt8_t
è10

	)

11 
	#CR
 (
ušt8_t
è13

	)

12 
	#CRLF
 "\x0d\x0a"

	)

13 
	#CRLF_LEN
 (("\x0d\x0a"è- 1)

	)

15 
	#NELEMS
(
a
è((×)è/ (×)[0]))

	)

17 
	#MIN
(
a
, 
b
è(×è< (bè? (aè: (b))

	)

18 
	#MAX
(
a
, 
b
è(×è> (bè? (aè: (b))

	)

20 
	#SQUARE
(
d
è((dè* (d))

	)

21 
	#VAR
(
s
, 
s2
, 
n
è((Òè< 2è? 0.0 : ((s2è- 
	`SQUARE
(s)/Ò)è/ (Òè- 1))

	)

22 
	#STDDEV
(
s
, 
s2
, 
n
è((Òè< 2è? 0.0 : 
	`sq¹
(
	`VAR
((s), (s2), (n))))

	)

29 #ifdeà
HAVE_ASSERT_PANIC


31 
	#ASSERT
(
_x
) do { \

32 ià(!(
_x
)) { \

33 
	`das£¹
(#_x, 
__FILE__
, 
__LINE__
, 1); \

35 } 0)

	)

37 
	#NOT_REACHED
(è
	`ASSERT
(0)

	)

39 #–ià
HAVE_ASSERT_LOG


41 
	#ASSERT
(
_x
) do { \

42 ià(!(
_x
)) { \

43 
	`das£¹
(#_x, 
__FILE__
, 
__LINE__
, 0); \

45 } 0)

	)

47 
	#NOT_REACHED
(è
	`ASSERT
(0)

	)

51 
	#ASSERT
(
_x
)

	)

53 
	#NOT_REACHED
()

	)

57 
das£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
);

58 
d¡ackŒaû
(
sk_couÁ
);

59 
d¡ackŒaû_fd
(
fd
);

61 
_dsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...);

62 
_dvsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
);

63 
du£c_now
();

64 
dm£c_now
();

65 
d£c_now
();

78 
_§ã_v¢´štf
(*
to
, 
size_t
 
size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

79 
_§ã_¢´štf
(*
to
, 
size_t
 
n
, cÚ¡ *
fmt
, ...);

81 
	#d§ã_¢´štf
(
_s
, 
_n
, ...) \

82 
	`_§ã_¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
__VA_ARGS__
)

	)

84 
	#d§ã_v¢´štf
(
_s
, 
_n
, 
_f
, 
_a
) \

85 
	`_§ã_v¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
_f
, 
_a
)

	)

101 
	#d¢´štf
(
_s
, 
_n
, ...) \

102 
	`¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
__VA_ARGS__
)

	)

104 
	#dsú´štf
(
_s
, 
_n
, ...) \

105 
	`_dsú´štf
((*)(
_s
), (
size_t
)(
_n
), 
__VA_ARGS__
)

	)

107 
	#dv¢´štf
(
_s
, 
_n
, 
_f
, 
_a
) \

108 
	`v¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
_f
, 
_a
)

	)

110 
	#dvsú´štf
(
_s
, 
_n
, 
_f
, 
_a
) \

111 
	`_dvsú´štf
((*)(
_s
), (
size_t
)(
_n
), 
_f
, 
_a
)

	)

113 
	#d¡ráime
(
_s
, 
_n
, 
fmt
, 
tm
) \

114 ()
	`¡ráime
((*)(
_s
), (
size_t
)(
_n
), 
fmt
, 
tm
)

	)

116 
¡ršg_m©ch_Ën
(cÚ¡ *
·‰”n
, 
·‰”nL’
, cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
);

117 
¡ršg_m©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
);

122 #ià
defšed
(
__ATOMIC_RELAXED
)

123 
	#©omic_add
(
_v®ue
, 
_n
è
	`__©omic_add_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

124 
	#©omic_sub
(
_v®ue
, 
_n
è
	`__©omic_sub_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

125 
	#©omic_£t
(
_v®ue
, 
_n
è
	`__©omic_¡Üe_n
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

126 
	#©omic_g‘
(
_v®ue
, 
_v
) do { \

127 
	`__©omic_lßd
(&
_v®ue
, 
_v
, 
__ATOMIC_RELAXED
); \

128 } 0)

	)

130 
	#ATOMIC_LOCK_TYPE
 "__ATOMIC_RELAXED"

	)

132 #–ià
defšed
(
HAVE_ATOMIC
)

133 
	#©omic_add
(
_v®ue
, 
_n
è
	`__sync_add_ªd_ãtch
(&_v®ue, (_n))

	)

134 
	#©omic_sub
(
_v®ue
, 
_n
è
	`__sync_sub_ªd_ãtch
(&_v®ue, (_n))

	)

135 
	#©omic_£t
(
_v®ue
, 
_n
è
	`__sync_lock_‹¡_ªd_£t
(&_v®ue, (_n))

	)

136 
	#©omic_g‘
(
_v®ue
, 
_v
) do { \

137 (*
_v
èğ
	`__sync_add_ªd_ãtch
(&
_v®ue
, 0); \

138 } 0)

	)

140 
	#ATOMIC_LOCK_TYPE
 "HAVE_ATOMIC"

	)

142 
±h»ad_mu‹x_t
 
©omic_lock”
;

144 
	#©omic_add
(
_v®ue
, 
_n
) do { \

145 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

146 
_v®ue
 +ğ(
_n
); \

147 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

148 } 0)

	)

150 
	#©omic_sub
(
_v®ue
, 
_n
) do { \

151 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

152 
_v®ue
 -ğ(
_n
); \

153 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

154 } 0)

	)

156 
	#©omic_£t
(
_v®ue
, 
_n
) do { \

157 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

158 
_v®ue
 = (
_n
); \

159 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

160 } 0)

	)

162 
	#©omic_g‘
(
_v®ue
, 
_v
) do { \

163 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

164 (*
_v
èğ
_v®ue
; \

165 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

166 } 0)

	)

168 
	#ATOMIC_LOCK_TYPE
 "±h»ad_mu‹x_lock"

	)

	@src/vr.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<sigÇl.h
>

5 
	~<g‘İt.h
>

6 
	~<fú.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/ut¢ame.h
>

10 
	~<vr_cÜe.h
>

11 
	~<vr_cÚf.h
>

12 
	~<vr_sigÇl.h
>

14 
	#VR_CONF_PATH
 "cÚf/vœe.cÚf"

	)

16 
	#VR_LOG_DEFAULT
 
LOG_NOTICE


	)

17 
	#VR_LOG_MIN
 
LOG_EMERG


	)

18 
	#VR_LOG_MAX
 
LOG_PVERB


	)

19 
	#VR_LOG_PATH
 
NULL


	)

21 
	#VR_PORT
 8889

	)

22 
	#VR_ADDR
 "0.0.0.0"

	)

23 
	#VR_INTERVAL
 (30 * 1000è

	)

25 
	#VR_PID_FILE
 
NULL


	)

27 
	#VR_THREAD_NUM_DEFAULT
 (
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>6?6:syscÚf(_SC_NPROCESSORS_ONLN))

	)

29 
	gshow_h–p
;

30 
	gshow_v”siÚ
;

31 
	g‹¡_cÚf
;

32 
	gd«mÚize
;

34 
İtiÚ
 
	glÚg_İtiÚs
[] = {

35 { "h–p", 
no_¬gum’t
, 
NULL
, 'h' },

36 { "v”siÚ", 
no_¬gum’t
, 
NULL
, 'V' },

37 { "‹¡-cÚf", 
no_¬gum’t
, 
NULL
, 't' },

38 { "d«mÚize", 
no_¬gum’t
, 
NULL
, 'd' },

39 { "v”bo£", 
»quœed_¬gum’t
, 
NULL
, 'v' },

40 { "ouut", 
»quœed_¬gum’t
, 
NULL
, 'o' },

41 { "cÚf-fe", 
»quœed_¬gum’t
, 
NULL
, 'c' },

42 { "pid-fe", 
»quœed_¬gum’t
, 
NULL
, 'p' },

43 { "th»ad-num", 
»quœed_¬gum’t
, 
NULL
, 'T' },

44 { 
NULL
, 0, NULL, 0 }

47 
	gshÜt_İtiÚs
[] = "hVtdv:o:c:p:T:";

49 
r¡©us_t


50 
	$vr_d«mÚize
(
dump_cÜe
)

52 
r¡©us_t
 
¡©us
;

53 
pid_t
 
pid
, 
sid
;

54 
fd
;

56 
pid
 = 
	`fÜk
();

57 
pid
) {

59 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

60  
VR_ERROR
;

67 
	`_ex™
(0);

72 
sid
 = 
	`£tsid
();

73 ià(
sid
 < 0) {

74 
	`log_”rÜ
("£tsid(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

75  
VR_ERROR
;

78 ià(
	`sigÇl
(
SIGHUP
, 
SIG_IGN
è=ğ
SIG_ERR
) {

79 
	`log_”rÜ
("sigÇl(SIGHUP, SIG_IGNèçed: %s", 
	`¡»¼Ü
(
”ºo
));

80  
VR_ERROR
;

83 
pid
 = 
	`fÜk
();

84 
pid
) {

86 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

87  
VR_ERROR
;

94 
	`_ex™
(0);

100 ià(
dump_cÜe
 == 0) {

101 
¡©us
 = 
	`chdœ
("/");

102 ià(
¡©us
 < 0) {

103 
	`log_”rÜ
("chdœ(\"/\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

104  
VR_ERROR
;

109 
	`umask
(0);

113 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

114 ià(
fd
 < 0) {

115 
	`log_”rÜ
("İ’(\"/dev/nuÎ\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

116  
VR_ERROR
;

119 
¡©us
 = 
	`dup2
(
fd
, 
STDIN_FILENO
);

120 ià(
¡©us
 < 0) {

121 
	`log_”rÜ
("dup2(%d, STDINèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

122 
	`şo£
(
fd
);

123  
VR_ERROR
;

126 
¡©us
 = 
	`dup2
(
fd
, 
STDOUT_FILENO
);

127 ià(
¡©us
 < 0) {

128 
	`log_”rÜ
("dup2(%d, STDOUTèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

129 
	`şo£
(
fd
);

130  
VR_ERROR
;

133 
¡©us
 = 
	`dup2
(
fd
, 
STDERR_FILENO
);

134 ià(
¡©us
 < 0) {

135 
	`log_”rÜ
("dup2(%d, STDERRèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

136 
	`şo£
(
fd
);

137  
VR_ERROR
;

140 ià(
fd
 > 
STDERR_FILENO
) {

141 
¡©us
 = 
	`şo£
(
fd
);

142 ià(
¡©us
 < 0) {

143 
	`log_”rÜ
("şo£(%dèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

144  
VR_ERROR
;

148  
VR_OK
;

149 
	}
}

152 
	$vr_´št_run
(
š¡ªû
 *
nci
)

154 
¡©us
;

155 
ut¢ame
 
Çme
;

157 
¡©us
 = 
	`uÇme
(&
Çme
);

159 ià(
nci
->
log_f’ame
) {

160 *
ascii_logo
 =

178 *
buf
 = 
	`d®loc
(1024*16);

179 
	`¢´štf
(
buf
,1024*16,
ascii_logo
,

180 
VR_VERSION_STRING
,

182 "¡ªd®Úe", 
£rv”
.
pÜt
,

183 (è
nci
->
pid
,

184 
¡©us
 < 0 ? " ":
Çme
.
sy¢ame
,

185 
¡©us
 < 0 ? " ":
Çme
.
»Ëa£
,

186 
¡©us
 < 0 ? " ":
Çme
.
machše
);

187 
	`log_wr™e_Ën
(
buf
, 
	`¡¾’
(buf));

188 
	`dä“
(
buf
);

190 
buf
[256];

191 
	`¢´štf
(
buf
,256,"Vire %s, %s bit, %s mode,…ort %d,…id %ld, built for %s %s %s„eadyo„un.\n",

192 
VR_VERSION_STRING
, (() == 8) ? "64" : "32",

193 "¡ªd®Úe", 
£rv”
.
pÜt
, (è
nci
->
pid
,

194 
¡©us
 < 0 ? " ":
Çme
.
sy¢ame
,

195 
¡©us
 < 0 ? " ":
Çme
.
»Ëa£
,

196 
¡©us
 < 0 ? " ":
Çme
.
machše
);

197 
	`log_wr™e_Ën
(
buf
, 
	`¡¾’
(buf));

199 
	}
}

202 
	$vr_´št_dÚe
()

204 
	`loga
("done,„abbit done");

205 
	}
}

208 
	$vr_show_u§ge
()

210 
	`log_¡d”r
(

211 "U§ge: vœ[-?hVdt] [-v v”bos™y†ev–] [-Øouuˆfe]" 
CRLF


212 " [-øcÚàfe] [-°pid fe]" 
CRLF


213 " [-T wÜk”h»ad numb”]" 
CRLF


215 
	`log_¡d”r
(

216 "O±iÚs:" 
CRLF


217 " -h, --h–° :hi h–p" 
CRLF


218 " -V, --v”siÚ : show v”siÚ‡ndƒx™" 
CRLF


219 " -t, --‹¡-cÚà :e¡ cÚfigu¿tiÚ fÜ syÁaxƒ¼Ü ªdƒx™" 
CRLF


221 
	`log_¡d”r
(

222 " -v, --v”bo£=N : s‘†oggšg†ev– (deçuÉ: %d, mš: %d, max: %d)" 
CRLF


223 " -o, --ouut=S : s‘†oggšg f(deçuÉ: %s)" 
CRLF


224 " -c, --cÚf-fe=S : s‘ cÚfigu¿tiÚ f(deçuÉ: %s)" 
CRLF


225 " -p, --pid-fe=S : s‘…id f(deçuÉ: %s)" 
CRLF


226 " -T, --th»ad_num=N : s‘hwÜk”h»ad numb” (deçuÉ: %d)" 
CRLF


228 
VR_LOG_DEFAULT
, 
VR_LOG_MIN
, 
VR_LOG_MAX
,

229 
VR_LOG_PATH
 !ğ
NULL
 ? VR_LOG_PATH : "stderr",

230 
VR_CONF_PATH
,

231 
VR_PID_FILE
 !ğ
NULL
 ? VR_PID_FILE : "off",

232 
VR_THREAD_NUM_DEFAULT
);

233 
	}
}

235 
r¡©us_t


236 
	$vr_ü—‹_pidfe
(
š¡ªû
 *
nci
)

238 
pid
[
VR_UINTMAX_MAXLEN
];

239 
fd
, 
pid_Ën
;

240 
ssize_t
 
n
;

242 
fd
 = 
	`İ’
(
nci
->
pid_f’ame
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

243 ià(
fd
 < 0) {

244 
	`log_”rÜ
("İ’šg…id f'%s' faed: %s", 
nci
->
pid_f’ame
,

245 
	`¡»¼Ü
(
”ºo
));

246  
VR_ERROR
;

248 
nci
->
pidfe
 = 1;

250 
pid_Ën
 = 
	`d¢´štf
(
pid
, 
VR_UINTMAX_MAXLEN
, "%d", 
nci
->pid);

252 
n
 = 
	`vr_wr™e
(
fd
, 
pid
, 
pid_Ën
);

253 ià(
n
 < 0) {

254 
	`log_”rÜ
("wr™tØpid f'%s' faed: %s", 
nci
->
pid_f’ame
,

255 
	`¡»¼Ü
(
”ºo
));

256  
VR_ERROR
;

259 
	`şo£
(
fd
);

261  
VR_OK
;

262 
	}
}

265 
	$vr_»move_pidfe
(
š¡ªû
 *
nci
)

267 
¡©us
;

269 
¡©us
 = 
	`uÆšk
(
nci
->
pid_f’ame
);

270 ià(
¡©us
 < 0) {

271 
	`log_”rÜ
("unlink of…id file '%s' failed, ignored: %s",

272 
nci
->
pid_f’ame
, 
	`¡»¼Ü
(
”ºo
));

274 
	}
}

277 
	$vr_£t_deçuÉ_İtiÚs
(
š¡ªû
 *
nci
)

279 
¡©us
;

281 
nci
->
log_Ëv–
 = 
VR_LOG_DEFAULT
;

282 
nci
->
log_f’ame
 = 
VR_LOG_PATH
;

284 
nci
->
cÚf_f’ame
 = 
VR_CONF_PATH
;

286 
¡©us
 = 
	`vr_g‘ho¡Çme
(
nci
->
ho¡Çme
, 
VR_MAXHOSTNAMELEN
);

287 ià(
¡©us
 < 0) {

288 
	`log_w¬n
("g‘ho¡Çmçed, ignÜed: %s", 
	`¡»¼Ü
(
”ºo
));

289 
	`d¢´štf
(
nci
->
ho¡Çme
, 
VR_MAXHOSTNAMELEN
, "unknown");

291 
nci
->
ho¡Çme
[
VR_MAXHOSTNAMELEN
 - 1] = '\0';

293 
nci
->
pid
 = (
pid_t
)-1;

294 
nci
->
pid_f’ame
 = 
NULL
;

295 
nci
->
pidfe
 = 0;

297 
nci
->
th»ad_num
 = ()
VR_THREAD_NUM_DEFAULT
;

298 
	}
}

300 
r¡©us_t


301 
	$vr_g‘_İtiÚs
(
¬gc
, **
¬gv
, 
š¡ªû
 *
nci
)

303 
c
, 
v®ue
;

305 
İ‹¼
 = 0;

308 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İtiÚs
, 
lÚg_İtiÚs
, 
NULL
);

309 ià(
c
 == -1) {

314 
c
) {

316 
show_v”siÚ
 = 1;

317 
show_h–p
 = 1;

321 
show_v”siÚ
 = 1;

325 
‹¡_cÚf
 = 1;

329 
d«mÚize
 = 1;

333 
v®ue
 = 
	`vr_©oi
(
İrg
, 
	`¡¾’
(optarg));

334 ià(
v®ue
 < 0) {

335 
	`log_¡d”r
("vire: option -v„equires‡‚umber");

336  
VR_ERROR
;

338 
nci
->
log_Ëv–
 = 
v®ue
;

342 
nci
->
log_f’ame
 = 
İrg
;

346 
nci
->
cÚf_f’ame
 = 
İrg
;

350 
nci
->
pid_f’ame
 = 
İrg
;

354 
v®ue
 = 
	`vr_©oi
(
İrg
, 
	`¡¾’
(optarg));

355 ià(
v®ue
 < 0) {

356 
	`log_¡d”r
("vire: option -T„equires‡‚umber");

357  
VR_ERROR
;

360 
nci
->
th»ad_num
 = 
v®ue
;

364 
İtİt
) {

368 
	`log_¡d”r
("vire: option -%c„equires‡ file‚ame",

369 
İtİt
);

374 
	`log_¡d”r
("vœe: o±iÚ -%ø»quœe ¨numb”", 
İtİt
);

378 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

381  
VR_ERROR
;

384 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

385  
VR_ERROR
;

390  
VR_OK
;

391 
	}
}

397 
boŞ


398 
	$vr_‹¡_cÚf
(
š¡ªû
 *
nci
, 
‹¡
)

400 
vr_cÚf
 *
cf
;

402 
cf
 = 
	`cÚf_ü—‹
(
nci
->
cÚf_f’ame
);

403 ià(
cf
 =ğ
NULL
) {

404 ià(
‹¡
)

405 
	`log_¡d”r
("vire: configuration file '%s' syntax is invalid",

406 
nci
->
cÚf_f’ame
);

407  
çl£
;

410 
	`cÚf_de¡roy
(
cf
);

412 ià(
‹¡
)

413 
	`log_¡d”r
("vire: configuration file '%s' syntax is ok",

414 
nci
->
cÚf_f’ame
);

415  
Œue
;

416 
	}
}

419 
	$vr_´e_run
(
š¡ªû
 *
nci
)

421 
»t
;

423 
»t
 = 
	`log_š™
(
nci
->
log_Ëv–
,‚ci->
log_f’ame
);

424 ià(
»t
 !ğ
VR_OK
) {

425  
»t
;

428 
	`log_debug
(
LOG_VERB
, "Vœu£d†ogfe: %s", 
nci
->
cÚf_f’ame
);

430 ià(!
	`vr_‹¡_cÚf
(
nci
, 
çl£
)) {

431 
	`log_”rÜ
("cÚàf% i ”rÜ", 
nci
->
cÚf_f’ame
);

432  
VR_ERROR
;

435 ià(
d«mÚize
) {

436 
»t
 = 
	`vr_d«mÚize
(1);

437 ià(
»t
 !ğ
VR_OK
) {

438  
»t
;

442 
nci
->
pid
 = 
	`g‘pid
();

444 
»t
 = 
	`sigÇl_š™
();

445 ià(
»t
 !ğ
VR_OK
) {

446  
»t
;

449 ià(
nci
->
pid_f’ame
) {

450 
»t
 = 
	`vr_ü—‹_pidfe
(
nci
);

451 ià(
»t
 !ğ
VR_OK
) {

452  
VR_ERROR
;

456 
»t
 = 
	`š™_£rv”
(
nci
);

457 ià(
»t
 !ğ
VR_OK
) {

458  
VR_ERROR
;

461 
	`vr_´št_run
(
nci
);

463  
VR_OK
;

464 
	}
}

467 
	$vr_po¡_run
(
š¡ªû
 *
nci
)

470 
	`wÜk”s_deš™
();

471 
	`back’ds_deš™
();

472 
	`ma¡”_deš™
();

474 ià(
nci
->
pidfe
) {

475 
	`vr_»move_pidfe
(
nci
);

478 
	`sigÇl_deš™
();

480 
	`vr_´št_dÚe
();

482 
	`log_deš™
();

483 
	}
}

486 
	$vr_run
(
š¡ªû
 *
nci
)

488 ià(
nci
->
th»ad_num
 <= 0) {

489 
	`log_”rÜ
("number of workhreads must be greaterhan 0");

491 } ià(
nci
->
th»ad_num
 > 64) {

492 
	`log_w¬n
("WARNING: Setting‡ high‚umber of workerhreads is‚ot„ecommended."

497 
	`ma¡”_run
();

498 
	`wÜk”s_run
();

499 
	`back’ds_run
();

502 
	`wÜk”s_wa™
();

503 
	`back’ds_wa™
();

504 
	}
}

507 
	$maš
(
¬gc
, **
¬gv
)

509 
r¡©us_t
 
¡©us
;

510 
š¡ªû
 
nci
;

512 
	`vr_£t_deçuÉ_İtiÚs
(&
nci
);

514 
¡©us
 = 
	`vr_g‘_İtiÚs
(
¬gc
, 
¬gv
, &
nci
);

515 ià(
¡©us
 !ğ
VR_OK
) {

516 
	`vr_show_u§ge
();

517 
	`ex™
(1);

520 ià(
show_v”siÚ
) {

521 
	`log_¡d”r
("Thi i vœe-%s" 
CRLF
, 
VR_VERSION_STRING
);

522 ià(
show_h–p
) {

523 
	`vr_show_u§ge
();

525 
	`ex™
(0);

528 ià(
‹¡_cÚf
) {

529 ià(!
	`vr_‹¡_cÚf
(&
nci
, 
Œue
)) {

530 
	`ex™
(1);

532 
	`ex™
(0);

535 
¡©us
 = 
	`vr_´e_run
(&
nci
);

536 ià(
¡©us
 !ğ
VR_OK
) {

537 
	`vr_po¡_run
(&
nci
);

538 
	`ex™
(1);

541 
£rv”
.
execubË
 = 
	`g‘AbsŞu‹P©h
(
¬gv
[0]);

543 
	`vr_run
(&
nci
);

545 
	`vr_po¡_run
(&
nci
);

547  
VR_OK
;

548 
	}
}

	@src/vr_aof.c

1 
	~<vr_cÜe.h
>

4 
	$aofRewr™eBufãrSize
() {

5 
dli¡Node
 *
Ê
;

6 
dli¡I‹r
 
li
;

7 
size
 = 0;

9 
	`dli¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

10 (
Ê
 = 
	`dli¡Next
(&
li
))) {

11 
aoäwblock
 *
block
 = 
	`dli¡NodeV®ue
(
Ê
);

12 
size
 +ğ
block
->
u£d
;

14  
size
;

15 
	}
}

24 
sds
 
	$ÿtAµ’dOÆyExpœeAtCommªd
(
sds
 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
) {

25 
wh’
;

26 
robj
 *
¬gv
[3];

29 
£cÚds
 = 
	`g‘DecodedObjeù
(seconds);

30 
wh’
 = 
	`¡¹Şl
(
£cÚds
->
±r
,
NULL
,10);

32 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
£‹xCommªd
 ||

33 
cmd
->
´oc
 =ğ
expœ—tCommªd
)

35 
wh’
 *= 1000;

38 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

39 
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
)

41 
wh’
 +ğ
	`vr_m£c_now
();

43 
	`deüRefCouÁ
(
£cÚds
);

45 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PEXPIREAT",9);

46 
¬gv
[1] = 
key
;

47 
¬gv
[2] = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
wh’
);

48 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf, 3, 
¬gv
);

49 
	`deüRefCouÁ
(
¬gv
[0]);

50 
	`deüRefCouÁ
(
¬gv
[2]);

51  
buf
;

52 
	}
}

54 
sds
 
	$ÿtAµ’dOÆyG’”icCommªd
(
sds
 
d¡
, 
¬gc
, 
robj
 **
¬gv
) {

55 
buf
[32];

56 
Ën
, 
j
;

57 
robj
 *
o
;

59 
buf
[0] = '*';

60 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
¬gc
);

61 
buf
[
Ën
++] = '\r';

62 
buf
[
Ën
++] = '\n';

63 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

65 
j
 = 0; j < 
¬gc
; j++) {

66 
o
 = 
	`g‘DecodedObjeù
(
¬gv
[
j
]);

67 
buf
[0] = '$';

68 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
	`sd¦’
(
o
->
±r
));

69 
buf
[
Ën
++] = '\r';

70 
buf
[
Ën
++] = '\n';

71 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

72 
d¡
 = 
	`sdsÿ’
(d¡,
o
->
±r
,
	`sd¦’
(o->ptr));

73 
d¡
 = 
	`sdsÿ’
(dst,"\r\n",2);

74 
	`deüRefCouÁ
(
o
);

76  
d¡
;

77 
	}
}

82 
	$aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

83 
dli¡Node
 *
Ê
;

84 
aoäwblock
 *
block
;

85 
ssize_t
 
nwr™‹n
;

86 
	`UNUSED
(
–
);

87 
	`UNUSED
(
fd
);

88 
	`UNUSED
(
´ivd©a
);

89 
	`UNUSED
(
mask
);

92 
Ê
 = 
	`dli¡Fœ¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

93 
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

94 ià(
£rv”
.
aof_¡İ_£ndšg_diff
 || !
block
) {

95 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,

96 
AE_WRITABLE
);

99 ià(
block
->
u£d
 > 0) {

100 
nwr™‹n
 = 
	`vr_wr™e
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
,

101 
block
->
buf
,block->
u£d
);

102 ià(
nwr™‹n
 <= 0) ;

103 
	`memmove
(
block
->
buf
,block->buf+
nwr™‹n
,block->
u£d
-nwritten);

104 
block
->
u£d
 -ğ
nwr™‹n
;

106 ià(
block
->
u£d
 =ğ0è
	`dli¡D–Node
(
£rv”
.
aof_»wr™e_buf_blocks
,
Ê
);

108 
	}
}

111 
	$aofRewr™eBufãrAµ’d
(*
s
, 
Ën
) {

112 
dli¡Node
 *
Ê
 = 
	`dli¡La¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

113 
aoäwblock
 *
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

115 
Ën
) {

118 ià(
block
) {

119 
thi¦’
 = (
block
->
ä“
 < 
Ën
) ? block->free :†en;

120 ià(
thi¦’
) {

121 
	`memıy
(
block
->
buf
+block->
u£d
, 
s
, 
thi¦’
);

122 
block
->
u£d
 +ğ
thi¦’
;

123 
block
->
ä“
 -ğ
thi¦’
;

124 
s
 +ğ
thi¦’
;

125 
Ën
 -ğ
thi¦’
;

129 ià(
Ën
) {

130 
numblocks
;

132 
block
 = 
	`d®loc
((*block));

133 
block
->
ä“
 = 
AOF_RW_BUF_BLOCK_SIZE
;

134 
block
->
u£d
 = 0;

135 
	`dli¡AddNodeTa
(
£rv”
.
aof_»wr™e_buf_blocks
,
block
);

139 
numblocks
 = 
	`dli¡L’gth
(
£rv”
.
aof_»wr™e_buf_blocks
);

140 ià(((
numblocks
+1) % 10) == 0) {

141 
Ëv–
 = ((
numblocks
+1è% 100è=ğ0 ? 
LOG_WARN
 :

142 
LOG_NOTICE
;

143 
	`log_debug
(
Ëv–
, "Background AOF buffer size: %lu MB",

144 
	`aofRewr™eBufãrSize
()/(1024*1024));

151 ià(
	`«G‘FeEv’ts
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
) == 0) {

152 
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
aof_pe_wr™e_d©a_to_chd
,

153 
AE_WRITABLE
, 
aofChdWr™eDiffD©a
, 
NULL
);

155 
	}
}

157 
	$ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

158 
sds
 
buf
 = 
	`sd£m±y
();

159 
robj
 *
tm·rgv
[3];

163 ià(
diùid
 !ğ
£rv”
.
aof_£Ëùed_db
) {

164 
£ldb
[64];

166 
	`¢´štf
(
£ldb
,(£ldb),"%d",
diùid
);

167 
buf
 = 
	`sdsÿrštf
(buf,"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n",

168 ()
	`¡¾’
(
£ldb
),seldb);

169 
£rv”
.
aof_£Ëùed_db
 = 
diùid
;

172 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

173 
cmd
->
´oc
 =ğ
expœ—tCommªd
) {

175 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

176 } ià(
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
) {

178 
tm·rgv
[0] = 
	`ü—‹SŒšgObjeù
("SET",3);

179 
tm·rgv
[1] = 
¬gv
[1];

180 
tm·rgv
[2] = 
¬gv
[3];

181 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,3,
tm·rgv
);

182 
	`deüRefCouÁ
(
tm·rgv
[0]);

183 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

188 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,
¬gc
,
¬gv
);

194 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
)

195 
£rv”
.
aof_buf
 = 
	`sdsÿ’
(£rv”.aof_buf,
buf
,
	`sd¦’
(buf));

201 ià(
£rv”
.
aof_chd_pid
 != -1)

202 
	`aofRewr™eBufãrAµ’d
((*)
buf
,
	`sd¦’
(buf));

204 
	`sdsä“
(
buf
);

205 
	}
}

	@src/vr_aof.h

1 #iâdeà
_VR_AOF_H_


2 
	#_VR_AOF_H_


	)

5 
	#AOF_OFF
 0

	)

6 
	#AOF_ON
 1

	)

7 
	#AOF_WAIT_REWRITE
 2

	)

9 
	#AOF_AUTOSYNC_BYTES
 (1024*1024*32è

	)

25 
	#AOF_RW_BUF_BLOCK_SIZE
 (1024*1024*10è

	)

27 
	saoäwblock
 {

28 
	mu£d
, 
	mä“
;

29 
	mbuf
[
AOF_RW_BUF_BLOCK_SIZE
];

30 } 
	taoäwblock
;

32 
aofRewr™eBufãrSize
();

33 
aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

34 
sds
 
ÿtAµ’dOÆyExpœeAtCommªd
(sd 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
);

35 
sds
 
ÿtAµ’dOÆyG’”icCommªd
(sd 
d¡
, 
¬gc
, 
robj
 **
¬gv
);

36 
aofRewr™eBufãrAµ’d
(*
s
, 
Ën
);

37 
ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

	@src/vr_backend.c

1 
	~<vr_cÜe.h
>

4 
	gnum_back’d_th»ads
;

6 
d¬¿y
 
	gback’ds
;

8 *
back’d_th»ad_run
(*
¬gs
);

11 
	$vr_back’d_š™
(
vr_back’d
 *
back’d
)

13 
r¡©us_t
 
¡©us
;

14 
th»ads_num
;

16 ià(
back’d
 =ğ
NULL
) {

17  
VR_ERROR
;

20 
back’d
->
id
 = 0;

21 
back’d
->
cu¼’t_db
 = 0;

22 
back’d
->
tim–im™_ex™
 = 0;

23 
back’d
->
Ï¡_ç¡_cyşe
 = 0;

24 
back’d
->
»size_db
 = 0;

25 
back’d
->
»hash_db
 = 0;

27 
	`vr_ev’oİ_š™
(&
back’d
->
v–
, 10);

28 
back’d
->
v–
.
th»ad
.
fun_run
 = 
back’d_th»ad_run
;

29 
back’d
->
v–
.
th»ad
.
d©a
 = backend;

31  
VR_OK
;

32 
	}
}

35 
	$vr_back’d_deš™
(
vr_back’d
 *
back’d
)

37 ià(
back’d
 =ğ
NULL
) {

41 
	`vr_ev’oİ_deš™
(&
back’d
->
v–
);

42 
	}
}

45 
	$back’d_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

46 
vr_wÜk”
 *
back’d
 = 
ş›ÁD©a
;

47 
vr_ev’oİ
 *
v–
 = &
back’d
->vel;

48 
size_t
 
¡©_u£d_memÜy
, 
¡©s_³ak_memÜy
;

50 
	`UNUSED
(
ev’tLoİ
);

51 
	`UNUSED
(
id
);

52 
	`UNUSED
(
ş›ÁD©a
);

54 
	`ASSERT
(
ev’tLoİ
 =ğ
v–
->
–
);

56 
v–
->
unixtime
 = 
	`time
(
NULL
);

57 
v–
->
m¡ime
 = 
	`vr_m£c_now
();

60 
¡©_u£d_memÜy
 = 
	`d®loc_u£d_memÜy
();

61 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
, 
³ak_memÜy
, &
¡©s_³ak_memÜy
);

62 ià(
¡©_u£d_memÜy
 > 
¡©s_³ak_memÜy
) {

63 
	`upd©e_¡©s_£t
(
v–
->
¡©s
, 
³ak_memÜy
, 
¡©_u£d_memÜy
);

66 
	`d©aba£sCrÚ
(
back’d
);

69 
	`run_w™h_³riod
(1000, 
v–
->
üÚloİs
) {

70 
	`cÚf_ÿche_upd©e
(&
v–
->
cc
);

73 
v–
->
üÚloİs
 ++;

74  1000/
v–
->
hz
;

75 
	}
}

78 
	$£tup_back’d
(
vr_back’d
 *
back’d
)

82 if(
	`«C»©eTimeEv’t
(
back’d
->
v–
.
–
, 1, 
back’d_üÚ
, back’d, 
NULL
è=ğ
AE_ERR
) {

83 
	`£rv”Pªic
("Can't createhe serverCronimeƒvent.");

84  
VR_ERROR
;

87  
VR_OK
;

88 
	}
}

91 
	$back’d_th»ad_run
(*
¬gs
)

93 
vr_wÜk”
 *
back’d
 = 
¬gs
;

96 
	`«Maš
(
back’d
->
v–
.
–
);

98  
NULL
;

99 
	}
}

102 
	$back’ds_š™
(
ušt32_t
 
back’d_couÁ
)

104 
r¡©us_t
 
¡©us
;

105 
ušt32_t
 
idx
;

106 
vr_back’d
 *
back’d
;

108 
	`d¬¿y_š™
(&
back’ds
, 
back’d_couÁ
, (
vr_back’d
));

110 
idx
 = 0; idx < 
back’d_couÁ
; idx ++) {

111 
back’d
 = 
	`d¬¿y_push
(&
back’ds
);

112 
	`vr_back’d_š™
(
back’d
);

113 
back’d
->
id
 = 
idx
;

114 
¡©us
 = 
	`£tup_back’d
(
back’d
);

115 ià(
¡©us
 !ğ
VR_OK
) {

116 
	`ex™
(1);

120 
num_back’d_th»ads
 = ()
	`d¬¿y_n
(&
back’ds
);

122  
VR_OK
;

123 
	}
}

126 
	$back’ds_run
()

128 
ušt32_t
 
i
, 
th»ad_couÁ
;

129 
vr_back’d
 *
back’d
;

131 
th»ad_couÁ
 = (
ušt32_t
)
num_back’d_th»ads
;

133 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

134 
back’d
 = 
	`d¬¿y_g‘
(&
back’ds
, 
i
);

135 
	`vr_th»ad_¡¬t
(&
back’d
->
v–
.
th»ad
);

138  
VR_OK
;

139 
	}
}

142 
	$back’ds_wa™
()

144 
ušt32_t
 
i
, 
th»ad_couÁ
;

145 
vr_back’d
 *
back’d
;

147 
th»ad_couÁ
 = (
ušt32_t
)
num_back’d_th»ads
;

149 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

150 
back’d
 = 
	`d¬¿y_g‘
(&
back’ds
, 
i
);

151 
	`±h»ad_još
(
back’d
->
v–
.
th»ad
.
th»ad_id
, 
NULL
);

154  
VR_OK
;

155 
	}
}

158 
	$back’ds_deš™
()

160 
vr_back’d
 *
back’d
;

162 
	`d¬¿y_n
(&
back’ds
)) {

163 
back’d
 = 
	`d¬¿y_pİ
(&
back’ds
);

164 
	`vr_back’d_deš™
(
back’d
);

166 
	}
}

	@src/vr_backend.h

1 #iâdeà
_VR_BACKEND_H_


2 
	#_VR_BACKEND_H_


	)

4 
	svr_back’d
 {

6 
	mid
;

7 
vr_ev’oİ
 
	mv–
;

11 
	mcu¼’t_db
;

12 
	mtim–im™_ex™
;

13 
	mÏ¡_ç¡_cyşe
;

18 
	m»size_db
;

19 
	m»hash_db
;

20 }
	tvr_back’d
;

22 
d¬¿y
 
back’ds
;

24 
back’ds_š™
(
ušt32_t
 
back’d_couÁ
);

25 
back’ds_run
();

26 
back’ds_wa™
();

27 
back’ds_deš™
();

	@src/vr_bitops.c

1 
	~<vr_cÜe.h
>

10 
size_t
 
	$»disPİcouÁ
(*
s
, 
couÁ
) {

11 
size_t
 
b™s
 = 0;

12 *
p
 = 
s
;

13 
ušt32_t
 *
p4
;

14 cÚ¡ 
b™sšby‹
[256] = {0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8};

17 ()
p
 & 3 && 
couÁ
) {

18 
b™s
 +ğ
b™sšby‹
[*
p
++];

19 
couÁ
--;

23 
p4
 = (
ušt32_t
*)
p
;

24 
couÁ
>=28) {

25 
ušt32_t
 
aux1
, 
aux2
, 
aux3
, 
aux4
, 
aux5
, 
aux6
, 
aux7
;

27 
aux1
 = *
p4
++;

28 
aux2
 = *
p4
++;

29 
aux3
 = *
p4
++;

30 
aux4
 = *
p4
++;

31 
aux5
 = *
p4
++;

32 
aux6
 = *
p4
++;

33 
aux7
 = *
p4
++;

34 
couÁ
 -= 28;

36 
aux1
 =‡ux1 - ((aux1 >> 1) & 0x55555555);

37 
aux1
 = (aux1 & 0x33333333) + ((aux1 >> 2) & 0x33333333);

38 
aux2
 =‡ux2 - ((aux2 >> 1) & 0x55555555);

39 
aux2
 = (aux2 & 0x33333333) + ((aux2 >> 2) & 0x33333333);

40 
aux3
 =‡ux3 - ((aux3 >> 1) & 0x55555555);

41 
aux3
 = (aux3 & 0x33333333) + ((aux3 >> 2) & 0x33333333);

42 
aux4
 =‡ux4 - ((aux4 >> 1) & 0x55555555);

43 
aux4
 = (aux4 & 0x33333333) + ((aux4 >> 2) & 0x33333333);

44 
aux5
 =‡ux5 - ((aux5 >> 1) & 0x55555555);

45 
aux5
 = (aux5 & 0x33333333) + ((aux5 >> 2) & 0x33333333);

46 
aux6
 =‡ux6 - ((aux6 >> 1) & 0x55555555);

47 
aux6
 = (aux6 & 0x33333333) + ((aux6 >> 2) & 0x33333333);

48 
aux7
 =‡ux7 - ((aux7 >> 1) & 0x55555555);

49 
aux7
 = (aux7 & 0x33333333) + ((aux7 >> 2) & 0x33333333);

50 
b™s
 +ğ((((
aux1
 + (aux1 >> 4)) & 0x0F0F0F0F) +

51 ((
aux2
 + (aux2 >> 4)) & 0x0F0F0F0F) +

52 ((
aux3
 + (aux3 >> 4)) & 0x0F0F0F0F) +

53 ((
aux4
 + (aux4 >> 4)) & 0x0F0F0F0F) +

54 ((
aux5
 + (aux5 >> 4)) & 0x0F0F0F0F) +

55 ((
aux6
 + (aux6 >> 4)) & 0x0F0F0F0F) +

56 ((
aux7
 + (aux7 >> 4)) & 0x0F0F0F0F))* 0x01010101) >> 24;

59 
p
 = (*)
p4
;

60 
couÁ
--è
b™s
 +ğ
b™sšby‹
[*
p
++];

61  
b™s
;

62 
	}
}

71 
	$»disB™pos
(*
s
, 
couÁ
, 
b™
) {

72 *
l
;

73 *
c
;

74 
skv®
, 
wÜd
 = 0, 
Úe
;

75 
pos
 = 0;

76 
j
;

88 
skv®
 = 
b™
 ? 0 : 
UCHAR_MAX
;

89 
c
 = (*è
s
;

90 ()
c
 & ((*
l
)-1è&& 
couÁ
) {

91 ià(*
c
 !ğ
skv®
) ;

92 
c
++;

93 
couÁ
--;

94 
pos
 += 8;

98 
skv®
 = 
b™
 ? 0 : 
ULONG_MAX
;

99 
l
 = (*è
c
;

100 
couÁ
 >ğ(*
l
)) {

101 ià(*
l
 !ğ
skv®
) ;

102 
l
++;

103 
couÁ
 -ğ(*
l
);

104 
pos
 +ğ(*
l
)*8;

114 
c
 = (*)
l
;

115 
j
 = 0; j < (*
l
); j++) {

116 
wÜd
 <<= 8;

117 ià(
couÁ
) {

118 
wÜd
 |ğ*
c
;

119 
c
++;

120 
couÁ
--;

129 ià(
b™
 =ğ1 && 
wÜd
 == 0)  -1;

135 
Úe
 = 
ULONG_MAX
;

136 
Úe
 >>= 1;

137 
Úe
 = ~one;

139 
Úe
) {

140 ià(((
Úe
 & 
wÜd
è!ğ0è=ğ
b™
è 
pos
;

141 
pos
++;

142 
Úe
 >>= 1;

147 
	`£rv”Pªic
("End of„edisBitpos()„eached.");

149 
	}
}

172 
	$£tUnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, ušt64_ˆ
v®ue
) {

173 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
;

175 
j
 = 0; j < 
b™s
; j++) {

176 
b™v®
 = (
v®ue
 & ((
ušt64_t
)1<<(
b™s
-1-
j
))) != 0;

177 
by‹
 = 
off£t
 >> 3;

178 
b™
 = 7 - (
off£t
 & 0x7);

179 
by‹v®
 = 
p
[
by‹
];

180 
by‹v®
 &ğ~(1 << 
b™
);

181 
by‹v®
 |ğ
b™v®
 << 
b™
;

182 
p
[
by‹
] = 
by‹v®
 & 0xff;

183 
off£t
++;

185 
	}
}

187 
	$£tSigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, 
št64_t
 
v®ue
) {

188 
ušt64_t
 
uv
;

190 ià(
v®ue
 >= 0)

191 
uv
 = 
v®ue
;

193 
uv
 = 
UINT64_MAX
 + 
v®ue
 + 1;

194 
	`£tUnsigÃdB™f›ld
(
p
,
off£t
,
b™s
,
uv
);

195 
	}
}

197 
ušt64_t
 
	$g‘UnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

198 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
, 
v®ue
 = 0;

200 
j
 = 0; j < 
b™s
; j++) {

201 
by‹
 = 
off£t
 >> 3;

202 
b™
 = 7 - (
off£t
 & 0x7);

203 
by‹v®
 = 
p
[
by‹
];

204 
b™v®
 = (
by‹v®
 >> 
b™
) & 1;

205 
v®ue
 = (v®ue<<1è| 
b™v®
;

206 
off£t
++;

208  
v®ue
;

209 
	}
}

211 
št64_t
 
	$g‘SigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

212 
št64_t
 
v®ue
 = 
	`g‘UnsigÃdB™f›ld
(
p
,
off£t
,
b™s
);

216 ià(
v®ue
 & ((
ušt64_t
)1 << (
b™s
-1)))

217 
v®ue
 |ğ((
ušt64_t
)-1è<< 
b™s
;

218  
v®ue
;

219 
	}
}

240 
	#BFOVERFLOW_WRAP
 0

	)

241 
	#BFOVERFLOW_SAT
 1

	)

242 
	#BFOVERFLOW_FAIL
 2

	)

244 
	$checkUnsigÃdB™f›ldOv”æow
(
ušt64_t
 
v®ue
, 
št64_t
 
šü
, ušt64_ˆ
b™s
, 
owty³
, ušt64_ˆ*
lim™
) {

245 
ušt64_t
 
max
 = (
b™s
 =ğ64è? 
UINT64_MAX
 : (((uint64_t)1<<bits)-1);

246 
št64_t
 
maxšü
 = 
max
-
v®ue
;

247 
št64_t
 
mššü
 = -
v®ue
;

249 ià(
v®ue
 > 
max
 || (
šü
 > 0 && inü > 
maxšü
)) {

250 ià(
lim™
) {

251 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

252 
hªdË_w¿p
;

253 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

254 *
lim™
 = 
max
;

258 } ià(
šü
 < 0 && inü < 
mššü
) {

259 ià(
lim™
) {

260 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

261 
hªdË_w¿p
;

262 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

263 *
lim™
 = 0;

270 
hªdË_w¿p
:

272 
ušt64_t
 
mask
 = ((
št64_t
)-1è<< 
b™s
;

273 
ušt64_t
 
»s
 = 
v®ue
+
šü
;

275 
»s
 &ğ~
mask
;

276 *
lim™
 = 
»s
;

279 
	}
}

281 
	$checkSigÃdB™f›ldOv”æow
(
št64_t
 
v®ue
, iÁ64_ˆ
šü
, 
ušt64_t
 
b™s
, 
owty³
, iÁ64_ˆ*
lim™
) {

282 
št64_t
 
max
 = (
b™s
 =ğ64è? 
INT64_MAX
 : (((int64_t)1<<(bits-1))-1);

283 
št64_t
 
mš
 = (-
max
)-1;

288 
št64_t
 
maxšü
 = 
max
-
v®ue
;

289 
št64_t
 
mššü
 = 
mš
-
v®ue
;

291 ià(
v®ue
 > 
max
 || (
b™s
 !ğ64 && 
šü
 > 
maxšü
) || (value >= 0 && incr > 0 && incr > maxincr))

293 ià(
lim™
) {

294 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

295 
hªdË_w¿p
;

296 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

297 *
lim™
 = 
max
;

301 } ià(
v®ue
 < 
mš
 || (
b™s
 !ğ64 && 
šü
 < 
mššü
) || (value < 0 && incr < 0 && incr < minincr)) {

302 ià(
lim™
) {

303 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

304 
hªdË_w¿p
;

305 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

306 *
lim™
 = 
mš
;

313 
hªdË_w¿p
:

315 
ušt64_t
 
mask
 = ((
št64_t
)-1è<< 
b™s
;

316 
ušt64_t
 
msb
 = (ušt64_t)1 << (
b™s
-1);

317 
ušt64_t
 
a
 = 
v®ue
, 
b
 = 
šü
, 
c
;

318 
c
 = 
a
+
b
;

323 ià(
c
 & 
msb
) {

324 
c
 |ğ
mask
;

326 
c
 &ğ~
mask
;

328 *
lim™
 = 
c
;

331 
	}
}

335 
	$´štB™s
(*
p
, 
couÁ
) {

336 
j
, 
i
, 
by‹
;

338 
j
 = 0; j < 
couÁ
; j++) {

339 
by‹
 = 
p
[
j
];

340 
i
 = 0x80; i > 0; i /= 2)

341 
	`´štf
("%c", (
by‹
 & 
i
) ? '1' : '0');

342 
	`´štf
("|");

344 
	`´štf
("\n");

345 
	}
}

351 
	#BITOP_AND
 0

	)

352 
	#BITOP_OR
 1

	)

353 
	#BITOP_XOR
 2

	)

354 
	#BITOP_NOT
 3

	)

356 
	#BITFIELDOP_GET
 0

	)

357 
	#BITFIELDOP_SET
 1

	)

358 
	#BITFIELDOP_INCRBY
 2

	)

367 
	$g‘B™Off£tFromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
, 
hash
, 
b™s
) {

368 
loff£t
;

369 *
”r
 = "bit offset is‚ot‡n integer or out of„ange";

370 *
p
 = 
o
->
±r
;

371 
size_t
 
¶’
 = 
	`sd¦’
(
p
);

372 
u£hash
 = 0;

375 ià(
p
[0] =ğ'#' && 
hash
 && 
b™s
 > 0è
u£hash
 = 1;

377 ià(
	`¡ršg2Î
(
p
+
u£hash
,
¶’
-u£hash,&
loff£t
) == 0) {

378 
	`addR•lyE¼Ü
(
c
,
”r
);

379  
VR_ERROR
;

383 ià(
u£hash
è
loff£t
 *ğ
b™s
;

386 ià((
loff£t
 < 0) || (()loffset >> 3) >= (512*1024*1024))

388 
	`addR•lyE¼Ü
(
c
,
”r
);

389  
VR_ERROR
;

392 *
off£t
 = (
size_t
)
loff£t
;

393  
VR_OK
;

394 
	}
}

403 
	$g‘B™f›ldTy³FromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, *
sign
, *
b™s
) {

404 *
p
 = 
o
->
±r
;

405 *
”r
 = "Invalid bitfieldype. Use something†ike i16 u8. Notehat u64 is‚ot supported but i64 is.";

406 
Îb™s
;

408 ià(
p
[0] == 'i') {

409 *
sign
 = 1;

410 } ià(
p
[0] == 'u') {

411 *
sign
 = 0;

413 
	`addR•lyE¼Ü
(
c
,
”r
);

414  
VR_ERROR
;

417 ià((
	`¡ršg2Î
(
p
+1,
	`¡¾’
Õ+1),&
Îb™s
)) == 0 ||

418 
Îb™s
 < 1 ||

419 (*
sign
 =ğ1 && 
Îb™s
 > 64) ||

420 (*
sign
 =ğ0 && 
Îb™s
 > 63))

422 
	`addR•lyE¼Ü
(
c
,
”r
);

423  
VR_ERROR
;

425 *
b™s
 = 
Îb™s
;

426  
VR_OK
;

427 
	}
}

434 
robj
 *
	$lookupSŒšgFÜB™Commªd
(
ş›Á
 *
c
, 
size_t
 
maxb™
, *
expœed
) {

435 
size_t
 
by‹
 = 
maxb™
 >> 3;

436 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
expœed
);

438 ià(
o
 =ğ
NULL
) {

439 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
by‹
+1));

440 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

442 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)è 
NULL
;

443 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

444 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
by‹
+1);

446  
o
;

447 
	}
}

450 
	$£tb™Commªd
(
ş›Á
 *
c
) {

451 
robj
 *
o
;

452 *
”r
 = "bit is‚ot‡n integer or out of„ange";

453 
size_t
 
b™off£t
;

454 
ssize_t
 
by‹
, 
b™
;

455 
by‹v®
, 
b™v®
;

456 
Ú
;

457 
expœed
 = 0;

459 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
VR_OK
)

462 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
Ú
,
”r
è!ğ
VR_OK
)

466 ià(
Ú
 & ~1) {

467 
	`addR•lyE¼Ü
(
c
,
”r
);

471 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

472 
	`lockDbWr™e
(
c
->
db
);

473 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,
b™off£t
,&
expœed
)è=ğ
NULL
) {

474 
	`uÆockDb
(
c
->
db
);

475 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

480 
by‹
 = 
b™off£t
 >> 3;

481 
by‹v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
];

482 
b™
 = 7 - (
b™off£t
 & 0x7);

483 
b™v®
 = 
by‹v®
 & (1 << 
b™
);

486 
by‹v®
 &ğ~(1 << 
b™
);

487 
by‹v®
 |ğ((
Ú
 & 0x1è<< 
b™
);

488 ((
ušt8_t
*)
o
->
±r
)[
by‹
] = 
by‹v®
;

489 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

490 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

491 
c
->
v–
->
dœty
++;

492 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

493 
	`uÆockDb
(
c
->
db
);

494 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

495 
	}
}

498 
	$g‘b™Commªd
(
ş›Á
 *
c
) {

499 
robj
 *
o
;

500 
Îbuf
[32];

501 
size_t
 
b™off£t
;

502 
size_t
 
by‹
, 
b™
;

503 
size_t
 
b™v®
 = 0;

505 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
VR_OK
)

508 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

509 
	`lockDbR—d
(
c
->
db
);

510 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

511 
	`uÆockDb
(
c
->
db
);

512 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

514 } ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

515 
	`uÆockDb
(
c
->
db
);

516 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

519 
by‹
 = 
b™off£t
 >> 3;

520 
b™
 = 7 - (
b™off£t
 & 0x7);

521 ià(
	`sdsEncodedObjeù
(
o
)) {

522 ià(
by‹
 < 
	`sd¦’
(
o
->
±r
))

523 
b™v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
] & (1 << 
b™
);

525 ià(
by‹
 < (
size_t
)
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
))

526 
b™v®
 = 
Îbuf
[
by‹
] & (1 << 
b™
);

529 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

530 
	`uÆockDb
(
c
->
db
);

531 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

532 
	}
}

535 
	$b™İCommªd
(
ş›Á
 *
c
) {

536 *
İÇme
 = 
c
->
¬gv
[1]->
±r
;

537 
robj
 *
o
, *
rg‘key
 = 
c
->
¬gv
[2];

538 
İ
, 
j
, 
numkeys
;

539 
robj
 **
objeùs
;

540 **
¤c
;

541 *
Ën
, 
maxËn
 = 0;

543 
mšËn
 = 0;

544 *
»s
 = 
NULL
;

547 ià((
İÇme
[0] =ğ'a' || o²ame[0] =ğ'A'è&& !
	`¡rÿ£cmp
(opname,"and"))

548 
İ
 = 
BITOP_AND
;

549 if((
İÇme
[0] =ğ'o' || o²ame[0] =ğ'O'è&& !
	`¡rÿ£cmp
(opname,"or"))

550 
İ
 = 
BITOP_OR
;

551 if((
İÇme
[0] =ğ'x' || o²ame[0] =ğ'X'è&& !
	`¡rÿ£cmp
(opname,"xor"))

552 
İ
 = 
BITOP_XOR
;

553 if((
İÇme
[0] =ğ'n' || o²ame[0] =ğ'N'è&& !
	`¡rÿ£cmp
(opname,"not"))

554 
İ
 = 
BITOP_NOT
;

556 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

561 ià(
İ
 =ğ
BITOP_NOT
 && 
c
->
¬gc
 != 4) {

562 
	`addR•lyE¼Ü
(
c
,"BITOP NOT must be called with‡ single source key.");

567 
numkeys
 = 
c
->
¬gc
 - 3;

568 
¤c
 = 
	`d®loc
((*è* 
numkeys
);

569 
Ën
 = 
	`d®loc
((è* 
numkeys
);

570 
objeùs
 = 
	`d®loc
((
robj
*è* 
numkeys
);

571 
j
 = 0; j < 
numkeys
; j++) {

572 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
+3]);

574 ià(
o
 =ğ
NULL
) {

575 
objeùs
[
j
] = 
NULL
;

576 
¤c
[
j
] = 
NULL
;

577 
Ën
[
j
] = 0;

578 
mšËn
 = 0;

582 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

583 
i
;

584 
i
 = 0; i < 
j
; i++) {

585 ià(
objeùs
[
i
])

586 
	`deüRefCouÁ
(
objeùs
[
i
]);

588 
	`dä“
(
¤c
);

589 
	`dä“
(
Ën
);

590 
	`dä“
(
objeùs
);

593 
objeùs
[
j
] = 
	`g‘DecodedObjeù
(
o
);

594 
¤c
[
j
] = 
objeùs
[j]->
±r
;

595 
Ën
[
j
] = 
	`sd¦’
(
objeùs
[j]->
±r
);

596 ià(
Ën
[
j
] > 
maxËn
) maxlen =†en[j];

597 ià(
j
 =ğ0 || 
Ën
[j] < 
mšËn
) minlen =†en[j];

601 ià(
maxËn
) {

602 
»s
 = (*è
	`sd¢ewËn
(
NULL
,
maxËn
);

603 
ouut
, 
by‹
;

604 
i
;

609 
j
 = 0;

610 ià(
mšËn
 >ğ()*4 && 
numkeys
 <= 16) {

611 *
Í
[16];

612 *
Ìes
 = (*è
»s
;

615 
	`memıy
(
Í
,
¤c
,(*)*
numkeys
);

616 
	`memıy
(
»s
,
¤c
[0],
mšËn
);

619 ià(
İ
 =ğ
BITOP_AND
) {

620 
mšËn
 >= ()*4) {

621 
i
 = 1; i < 
numkeys
; i++) {

622 
Ìes
[0] &ğ
Í
[
i
][0];

623 
Ìes
[1] &ğ
Í
[
i
][1];

624 
Ìes
[2] &ğ
Í
[
i
][2];

625 
Ìes
[3] &ğ
Í
[
i
][3];

626 
Í
[
i
]+=4;

628 
Ìes
+=4;

629 
j
 += ()*4;

630 
mšËn
 -= ()*4;

632 } ià(
İ
 =ğ
BITOP_OR
) {

633 
mšËn
 >= ()*4) {

634 
i
 = 1; i < 
numkeys
; i++) {

635 
Ìes
[0] |ğ
Í
[
i
][0];

636 
Ìes
[1] |ğ
Í
[
i
][1];

637 
Ìes
[2] |ğ
Í
[
i
][2];

638 
Ìes
[3] |ğ
Í
[
i
][3];

639 
Í
[
i
]+=4;

641 
Ìes
+=4;

642 
j
 += ()*4;

643 
mšËn
 -= ()*4;

645 } ià(
İ
 =ğ
BITOP_XOR
) {

646 
mšËn
 >= ()*4) {

647 
i
 = 1; i < 
numkeys
; i++) {

648 
Ìes
[0] ^ğ
Í
[
i
][0];

649 
Ìes
[1] ^ğ
Í
[
i
][1];

650 
Ìes
[2] ^ğ
Í
[
i
][2];

651 
Ìes
[3] ^ğ
Í
[
i
][3];

652 
Í
[
i
]+=4;

654 
Ìes
+=4;

655 
j
 += ()*4;

656 
mšËn
 -= ()*4;

658 } ià(
İ
 =ğ
BITOP_NOT
) {

659 
mšËn
 >= ()*4) {

660 
Ìes
[0] = ~lres[0];

661 
Ìes
[1] = ~lres[1];

662 
Ìes
[2] = ~lres[2];

663 
Ìes
[3] = ~lres[3];

664 
Ìes
+=4;

665 
j
 += ()*4;

666 
mšËn
 -= ()*4;

672 ; 
j
 < 
maxËn
; j++) {

673 
ouut
 = (
Ën
[0] <ğ
j
è? 0 : 
¤c
[0][j];

674 ià(
İ
 =ğ
BITOP_NOT
è
ouut
 = ~output;

675 
i
 = 1; i < 
numkeys
; i++) {

676 
by‹
 = (
Ën
[
i
] <ğ
j
è? 0 : 
¤c
[i][j];

677 
İ
) {

678 
BITOP_AND
: 
ouut
 &ğ
by‹
; ;

679 
BITOP_OR
: 
ouut
 |ğ
by‹
; ;

680 
BITOP_XOR
: 
ouut
 ^ğ
by‹
; ;

683 
»s
[
j
] = 
ouut
;

686 
j
 = 0; j < 
numkeys
; j++) {

687 ià(
objeùs
[
j
])

688 
	`deüRefCouÁ
(
objeùs
[
j
]);

690 
	`dä“
(
¤c
);

691 
	`dä“
(
Ën
);

692 
	`dä“
(
objeùs
);

695 ià(
maxËn
) {

696 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
»s
);

697 
	`£tKey
(
c
->
db
,
rg‘key
,
o
,
NULL
);

698 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
rg‘key
,
c
->
db
->
id
);

699 
	`deüRefCouÁ
(
o
);

700 } ià(
	`dbD–‘e
(
c
->
db
,
rg‘key
)) {

701 
	`sigÇlModif›dKey
(
c
->
db
,
rg‘key
);

702 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
rg‘key
,
c
->
db
->
id
);

704 
£rv”
.
dœty
++;

705 
	`addR•lyLÚgLÚg
(
c
,
maxËn
);

706 
	}
}

709 
	$b™couÁCommªd
(
ş›Á
 *
c
) {

710 
robj
 *
o
;

711 
¡¬t
, 
’d
, 
¡¾’
;

712 *
p
;

713 
Îbuf
[32];

715 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

716 
	`lockDbR—d
(
c
->
db
);

718 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

719 
	`uÆockDb
(
c
->
db
);

720 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

722 } ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

723 
	`uÆockDb
(
c
->
db
);

724 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

730 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

731 
p
 = (*è
Îbuf
;

732 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

734 
p
 = (*è
o
->
±r
;

735 
¡¾’
 = 
	`sd¦’
(
o
->
±r
);

739 ià(
c
->
¬gc
 == 4) {

740 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
VR_OK
) {

741 
	`uÆockDb
(
c
->
db
);

742 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

745 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
VR_OK
) {

746 
	`uÆockDb
(
c
->
db
);

747 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

751 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

752 ià(
’d
 < 0è’d = 
¡¾’
+end;

753 ià(
¡¬t
 < 0) start = 0;

754 ià(
’d
 < 0)ƒnd = 0;

755 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

756 } ià(
c
->
¬gc
 == 2) {

758 
¡¬t
 = 0;

759 
’d
 = 
¡¾’
-1;

761 
	`uÆockDb
(
c
->
db
);

762 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

764 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

770 ià(
¡¬t
 > 
’d
) {

771 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

773 
by‹s
 = 
’d
-
¡¬t
+1;

775 
	`addR•lyLÚgLÚg
(
c
,
	`»disPİcouÁ
(
p
+
¡¬t
,
by‹s
));

777 
	`uÆockDb
(
c
->
db
);

778 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

779 
	}
}

782 
	$b™posCommªd
(
ş›Á
 *
c
) {

783 
robj
 *
o
;

784 
b™
, 
¡¬t
, 
’d
, 
¡¾’
;

785 *
p
;

786 
Îbuf
[32];

787 
’d_giv’
 = 0;

791 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
b™
,
NULL
è!ğ
VR_OK
)

793 ià(
b™
 != 0 && bit != 1) {

794 
	`addR•lyE¼Ü
(
c
, "The bit‡rgument must be 1 or 0.");

798 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

799 
	`lockDbR—d
(
c
->
db
);

803 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

804 
	`uÆockDb
(
c
->
db
);

805 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

806 
	`addR•lyLÚgLÚg
(
c
, 
b™
 ? -1 : 0);

809 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

810 
	`uÆockDb
(
c
->
db
);

811 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

817 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

818 
p
 = (*è
Îbuf
;

819 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

821 
p
 = (*è
o
->
±r
;

822 
¡¾’
 = 
	`sd¦’
(
o
->
±r
);

826 ià(
c
->
¬gc
 == 4 || c->argc == 5) {

827 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
¡¬t
,
NULL
è!ğ
VR_OK
) {

828 
	`uÆockDb
(
c
->
db
);

829 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

832 ià(
c
->
¬gc
 == 5) {

833 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
’d
,
NULL
è!ğ
VR_OK
) {

834 
	`uÆockDb
(
c
->
db
);

835 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

838 
’d_giv’
 = 1;

840 
’d
 = 
¡¾’
-1;

843 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

844 ià(
’d
 < 0è’d = 
¡¾’
+end;

845 ià(
¡¬t
 < 0) start = 0;

846 ià(
’d
 < 0)ƒnd = 0;

847 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

848 } ià(
c
->
¬gc
 == 3) {

850 
¡¬t
 = 0;

851 
’d
 = 
¡¾’
-1;

853 
	`uÆockDb
(
c
->
db
);

854 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

856 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

862 ià(
¡¬t
 > 
’d
) {

863 
	`addR•lyLÚgLÚg
(
c
, -1);

865 
by‹s
 = 
’d
-
¡¬t
+1;

866 
pos
 = 
	`»disB™pos
(
p
+
¡¬t
,
by‹s
,
b™
);

875 ià(
’d_giv’
 && 
b™
 =ğ0 && 
pos
 =ğ
by‹s
*8) {

876 
	`uÆockDb
(
c
->
db
);

877 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

878 
	`addR•lyLÚgLÚg
(
c
,-1);

881 ià(
pos
 !ğ-1èpo +ğ
¡¬t
*8;

882 
	`addR•lyLÚgLÚg
(
c
,
pos
);

884 
	`uÆockDb
(
c
->
db
);

885 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

886 
	}
}

898 
	sb™f›ldOp
 {

899 
ušt64_t
 
	moff£t
;

900 
št64_t
 
	mi64
;

901 
	mİcode
;

902 
	mowty³
;

903 
	mb™s
;

904 
	msign
;

907 
	$b™f›ldCommªd
(
ş›Á
 *
c
) {

908 
robj
 *
o
;

909 
size_t
 
b™off£t
;

910 
j
, 
numİs
 = 0, 
chªges
 = 0;

911 
b™f›ldOp
 *
İs
 = 
NULL
;

912 
owty³
 = 
BFOVERFLOW_WRAP
;

914 
j
 = 2; j < 
c
->
¬gc
; j++) {

915 
»m¬gs
 = 
c
->
¬gc
-
j
-1;

916 *
subcmd
 = 
c
->
¬gv
[
j
]->
±r
;

917 
İcode
;

918 
i64
 = 0;

919 
sign
 = 0;

920 
b™s
 = 0;

922 ià(!
	`¡rÿ£cmp
(
subcmd
,"g‘"è&& 
»m¬gs
 >= 2)

923 
İcode
 = 
BITFIELDOP_GET
;

924 ià(!
	`¡rÿ£cmp
(
subcmd
,"£t"è&& 
»m¬gs
 >= 3)

925 
İcode
 = 
BITFIELDOP_SET
;

926 ià(!
	`¡rÿ£cmp
(
subcmd
,"šüby"è&& 
»m¬gs
 >= 3)

927 
İcode
 = 
BITFIELDOP_INCRBY
;

928 ià(!
	`¡rÿ£cmp
(
subcmd
,"ov”æow"è&& 
»m¬gs
 >= 1) {

929 *
owty³Çme
 = 
c
->
¬gv
[
j
+1]->
±r
;

930 
j
++;

931 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"wrap"))

932 
owty³
 = 
BFOVERFLOW_WRAP
;

933 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"sat"))

934 
owty³
 = 
BFOVERFLOW_SAT
;

935 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"fail"))

936 
owty³
 = 
BFOVERFLOW_FAIL
;

938 
	`addR•lyE¼Ü
(
c
,"Invalid OVERFLOWype specified");

939 
	`dä“
(
İs
);

944 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

945 
	`dä“
(
İs
);

950 ià(
	`g‘B™f›ldTy³FromArgum’t
(
c
,c->
¬gv
[
j
+1],&
sign
,&
b™s
è!ğ
VR_OK
) {

951 
	`dä“
(
İs
);

955 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[
j
+2],&
b™off£t
,1,
b™s
è!ğ
VR_OK
){

956 
	`dä“
(
İs
);

961 ià(
İcode
 !ğ
BITFIELDOP_GET
) {

962 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+3],&
i64
,
NULL
è!ğ
VR_OK
){

963 
	`dä“
(
İs
);

969 
İs
 = 
	`d»®loc
(İs,(*İs)*(
numİs
+1));

970 
İs
[
numİs
].
off£t
 = 
b™off£t
;

971 
İs
[
numİs
].
i64
 = i64;

972 
İs
[
numİs
].
İcode
 = opcode;

973 
İs
[
numİs
].
owty³
 = owtype;

974 
İs
[
numİs
].
b™s
 = bits;

975 
İs
[
numİs
].
sign
 = sign;

976 
numİs
++;

978 
j
 +ğ3 - (
İcode
 =ğ
BITFIELDOP_GET
);

981 
	`addR•lyMuÉiBulkL’
(
c
,
numİs
);

984 
j
 = 0; j < 
numİs
; j++) {

985 
b™f›ldOp
 *
thisİ
 = 
İs
+
j
;

988 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_SET
 ||

989 
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
)

997 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,

998 
thisİ
->
off£t
 + (thisİ->
b™s
-1), 
NULL
)) == NULL) ;

1003 ià(
thisİ
->
sign
) {

1004 
št64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1005 
ov”æow
;

1007 
Şdv®
 = 
	`g‘SigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1008 
thisİ
->
b™s
);

1010 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1011 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1012 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Şdv®
,

1013 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1014 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1015 
»tv®
 = 
Ãwv®
;

1017 
Ãwv®
 = 
thisİ
->
i64
;

1018 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Ãwv®
,

1019 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1020 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1021 
»tv®
 = 
Şdv®
;

1026 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1027 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1028 
	`£tSigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1029 
thisİ
->
b™s
,
Ãwv®
);

1031 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1034 
ušt64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1035 
ov”æow
;

1037 
Şdv®
 = 
	`g‘UnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1038 
thisİ
->
b™s
);

1040 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1041 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1042 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Şdv®
,

1043 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1044 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1045 
»tv®
 = 
Ãwv®
;

1047 
Ãwv®
 = 
thisİ
->
i64
;

1048 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Ãwv®
,

1049 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1050 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1051 
»tv®
 = 
Şdv®
;

1055 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1056 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1057 
	`£tUnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1058 
thisİ
->
b™s
,
Ãwv®
);

1060 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1063 
chªges
++;

1066 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

1067 
size_t
 
Ş’
 = (
o
 =ğ
NULL
è? 0 : 
	`sd¦’
(o->
±r
);

1068 
buf
[9];

1074 
	`mem£t
(
buf
,0,9);

1075 *
¤c
 = 
o
 ? o->
±r
 : 
NULL
;

1076 
i
;

1077 
size_t
 
by‹
 = 
thisİ
->
off£t
 >> 3;

1078 
i
 = 0; i < 9; i++) {

1079 ià(
¤c
 =ğ
NULL
 || 
i
+
by‹
 >ğ
Ş’
) ;

1080 
buf
[
i
] = 
¤c
[i+
by‹
];

1085 ià(
thisİ
->
sign
) {

1086 
št64_t
 
v®
 = 
	`g‘SigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1087 
thisİ
->
b™s
);

1088 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1090 
ušt64_t
 
v®
 = 
	`g‘UnsigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1091 
thisİ
->
b™s
);

1092 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1097 ià(
chªges
) {

1098 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1099 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

1100 
£rv”
.
dœty
 +ğ
chªges
;

1102 
	`dä“
(
İs
);

1103 
	}
}

	@src/vr_bitops.h

1 #iâdeà
_VR_BITOPS_H_


2 
	#_VR_BITOPS_H_


	)

4 
size_t
 
»disPİcouÁ
(*
s
, 
couÁ
);

5 
»disB™pos
(*
s
, 
couÁ
, 
b™
);

6 
£tUnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, ušt64_ˆ
v®ue
);

7 
£tSigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, 
št64_t
 
v®ue
);

8 
ušt64_t
 
g‘UnsigÃdB™f›ld
(*
p
, ušt64_ˆ
off£t
, ušt64_ˆ
b™s
);

9 
št64_t
 
g‘SigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
);

10 
checkUnsigÃdB™f›ldOv”æow
(
ušt64_t
 
v®ue
, 
št64_t
 
šü
, ušt64_ˆ
b™s
, 
owty³
, ušt64_ˆ*
lim™
);

11 
checkSigÃdB™f›ldOv”æow
(
št64_t
 
v®ue
, iÁ64_ˆ
šü
, 
ušt64_t
 
b™s
, 
owty³
, iÁ64_ˆ*
lim™
);

12 
´štB™s
(*
p
, 
couÁ
);

13 
g‘B™Off£tFromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
, 
hash
, 
b™s
);

14 
g‘B™f›ldTy³FromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, *
sign
, *
b™s
);

15 
robj
 *
lookupSŒšgFÜB™Commªd
(
ş›Á
 *
c
, 
size_t
 
maxb™
, *
expœed
);

16 
£tb™Commªd
(
ş›Á
 *
c
);

17 
g‘b™Commªd
(
ş›Á
 *
c
);

18 
b™İCommªd
(
ş›Á
 *
c
);

19 
b™couÁCommªd
(
ş›Á
 *
c
);

20 
b™posCommªd
(
ş›Á
 *
c
);

21 
b™f›ldCommªd
(
ş›Á
 *
c
);

	@src/vr_block.c

1 
	~<vr_cÜe.h
>

6 
	$unblockCl›Á
(
ş›Á
 *
c
) {

7 ià(
c
->
bty³
 =ğ
BLOCKED_LIST
) {

8 
	`unblockCl›ÁWa™šgD©a
(
c
);

9 } ià(
c
->
bty³
 =ğ
BLOCKED_WAIT
) {

10 
	`unblockCl›ÁWa™šgR•liÿs
(
c
);

12 
	`£rv”Pªic
("Unknown btype in unblockClient().");

16 
c
->
æags
 &ğ~
CLIENT_BLOCKED
;

17 
c
->
bty³
 = 
BLOCKED_NONE
;

18 
c
->
v–
->
bpİ_blocked_ş›Ás
--;

21 ià(!(
c
->
æags
 & 
CLIENT_UNBLOCKED
)) {

22 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

23 
	`dli¡AddNodeTa
(
c
->
v–
->
unblocked_ş›Ás
,c);

25 
	}
}

35 
	$g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, *
timeout
, 
un™
) {

36 
tv®
;

38 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
objeù
,&
tv®
,

39 "timeouˆi nÙ‡Àš‹g” o¸ouˆoà¿nge"è!ğ
VR_OK
)

40  
VR_ERROR
;

42 ià(
tv®
 < 0) {

43 
	`addR•lyE¼Ü
(
c
,"timeout is‚egative");

44  
VR_ERROR
;

47 ià(
tv®
 > 0) {

48 ià(
un™
 =ğ
UNIT_SECONDS
è
tv®
 *= 1000;

49 
tv®
 +ğ
	`vr_m£c_now
();

51 *
timeout
 = 
tv®
;

53  
VR_OK
;

54 
	}
}

59 
	$blockCl›Á
(
ş›Á
 *
c
, 
bty³
) {

60 
c
->
æags
 |ğ
CLIENT_BLOCKED
;

61 
c
->
bty³
 = btype;

62 
c
->
v–
->
bpİ_blocked_ş›Ás
++;

63 
	}
}

	@src/vr_block.h

1 #iâdeà
_VR_BLOCK_H_


2 
	#_VR_BLOCK_H_


	)

6 
	sblockšgS‹
 {

8 
	mtimeout
;

12 
diù
 *
	mkeys
;

14 
robj
 *
	mrg‘
;

18 
	mnum»¶iÿs
;

19 
	m»¶off£t
;

20 } 
	tblockšgS‹
;

22 
blockCl›Á
(
ş›Á
 *
c
, 
bty³
);

23 
unblockCl›Á
(
ş›Á
 *
c
);

24 
g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, *
timeout
, 
un™
);

	@src/vr_client.c

1 
	~<vr_cÜe.h
>

3 
	gncu¼_ccÚn
 = 0;

5 
£tPrÙocŞE¼Ü
(
ş›Á
 *
c
, 
pos
);

10 
size_t
 
	$sdsZm®locSize
(
sds
 
s
) {

11 *
sh
 = 
	`sdsAÎocPŒ
(
s
);

12  
	`dm®loc_size
(
sh
);

13 
	}
}

15 *
	$dupCl›ÁR•lyV®ue
(*
o
) {

16  
o
;

17 
	}
}

19 
	$ä“Cl›ÁR•lyV®ue
(*
o
) {

20 
	`ä“Objeù
(
o
);

21 
	}
}

23 
	$li¡M©chObjeùs
(*
a
, *
b
) {

24  
	`equ®SŒšgObjeùs
(
a
,
b
);

25 
	}
}

27 
ş›Á
 *
	$ü—‹Cl›Á
(
vr_ev’oİ
 *
v–
, 
cÚn
 *conn) {

28 
ş›Á
 *
c
 = 
	`d®loc
((client));

34 ià(
cÚn
->
sd
 != -1) {

35 
	`vr_£t_nÚblockšg
(
cÚn
->
sd
);

36 
	`vr_£t_tınod–ay
(
cÚn
->
sd
);

37 ià(
£rv”
.
tık“·live
)

38 
	`vr_£t_tık“·live
(
cÚn
->
sd
,
£rv”
.
tık“·live
,0,0);

39 ià(
	`«C»©eFeEv’t
(
v–
->
–
,
cÚn
->
sd
,
AE_READABLE
,

40 
»adQu”yFromCl›Á
, 
c
è=ğ
AE_ERR
)

42 
	`log_”rÜ
("Unrecoverableƒrror creating client ipfd fileƒvent.");

43 
	`dä“
(
c
);

44  
NULL
;

48 
	`£ËùDb
(
c
,0);

49 
c
->
id
 = 
v–
->
Ãxt_ş›Á_id
++;

50 
c
->
cÚn
 = conn;

51 
c
->
v–
 = vel;

52 
c
->
sÿnid
 = -1;

53 
c
->
Çme
 = 
NULL
;

54 
c
->
buåos
 = 0;

55 
c
->
qu”ybuf
 = 
	`sd£m±y
();

56 
c
->
qu”ybuf_³ak
 = 0;

57 
c
->
»qty³
 = 0;

58 
c
->
¬gc
 = 0;

59 
c
->
¬gv
 = 
NULL
;

60 
c
->
cmd
 = c->
Ï¡cmd
 = 
NULL
;

61 
c
->
muÉibulkËn
 = 0;

62 
c
->
bulkËn
 = -1;

63 
c
->
£ÁËn
 = 0;

64 
c
->
æags
 = 0;

65 
c
->
ùime
 = c->
Ï¡š‹¿ùiÚ
 = 
v–
->
unixtime
;

66 
c
->
auth’tiÿ‹d
 = 0;

67 
c
->
»¶¡©e
 = 
REPL_STATE_NONE
;

68 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

69 
c
->
»¶off
 = 0;

70 
c
->
»¶_ack_off
 = 0;

71 
c
->
»¶_ack_time
 = 0;

72 
c
->
¦ave_li¡’šg_pÜt
 = 0;

73 
c
->
¦ave_ÿ·
 = 
SLAVE_CAPA_NONE
;

74 
c
->
»¶y
 = 
	`dli¡C»©e
();

75 
c
->
»¶y_by‹s
 = 0;

76 
c
->
obuf_soá_lim™_»ached_time
 = 0;

77 
	`dli¡S‘F»eM‘hod
(
c
->
»¶y
,
ä“Cl›ÁR•lyV®ue
);

78 
	`dli¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

79 
c
->
bty³
 = 
BLOCKED_NONE
;

80 
c
->
bpİ
.
timeout
 = 0;

81 
c
->
bpİ
.
keys
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

82 
c
->
bpİ
.
rg‘
 = 
NULL
;

83 
c
->
bpİ
.
num»¶iÿs
 = 0;

84 
c
->
bpİ
.
»¶off£t
 = 0;

85 
c
->
woff
 = 0;

86 
c
->
w©ched_keys
 = 
	`dli¡C»©e
();

87 
c
->
pubsub_chªÃls
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

88 
c
->
pubsub_·‰”ns
 = 
	`dli¡C»©e
();

89 
c
->
³”id
 = 
NULL
;

90 
c
->
curidx
 = -1;

91 
c
->
ridx
 = -1;

92 
c
->
¡•s
 = 0;

93 
c
->
ÿche
 = 
NULL
;

94 
	`dli¡S‘F»eM‘hod
(
c
->
pubsub_·‰”ns
,
deüRefCouÁVoid
);

95 
	`dli¡S‘M©chM‘hod
(
c
->
pubsub_·‰”ns
,
li¡M©chObjeùs
);

96 ià(
cÚn
->
sd
 !ğ-1è
	`dli¡AddNodeTa
(
v–
->
ş›Ás
,
c
);

97 
	`š™Cl›ÁMuÉiS‹
(
c
);

98  
c
;

99 
	}
}

123 
	$´•¬eCl›ÁToWr™e
(
ş›Á
 *
c
) {

126 ià(
c
->
æags
 & 
CLIENT_LUA
è 
VR_OK
;

129 ià(
c
->
æags
 & (
CLIENT_REPLY_OFF
|
CLIENT_REPLY_SKIP
)è 
VR_ERROR
;

133 ià((
c
->
æags
 & 
CLIENT_MASTER
) &&

134 !(
c
->
æags
 & 
CLIENT_MASTER_FORCE_REPLY
)è 
VR_ERROR
;

136 ià(
c
->
cÚn
->
sd
 <ğ0è 
VR_ERROR
;

142 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

143 !(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) &&

144 (
c
->
»¶¡©e
 =ğ
REPL_STATE_NONE
 ||

145 (
c
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 && !c->
»¶_put_Úlše_Ú_ack
)))

153 
c
->
æags
 |ğ
CLIENT_PENDING_WRITE
;

154 
	`dli¡AddNodeH—d
(
c
->
v–
->
ş›Ás_³ndšg_wr™e
,c);

158  
VR_OK
;

159 
	}
}

163 
robj
 *
	$dupLa¡ObjeùIfN“ded
(
dli¡
 *
»¶y
) {

164 
robj
 *
Ãw
, *
cur
;

165 
dli¡Node
 *
Ê
;

166 
	`ASSERT
(
	`dli¡L’gth
(
»¶y
) > 0);

167 
Ê
 = 
	`dli¡La¡
(
»¶y
);

168 
cur
 = 
	`dli¡NodeV®ue
(
Ê
);

169 ià(
cur
->
cÚ¡ªt
) {

170 
Ãw
 = 
	`dupSŒšgObjeù
(
cur
);

171 
	`dli¡NodeV®ue
(
Ê
èğ
Ãw
;

173  
	`dli¡NodeV®ue
(
Ê
);

174 
	}
}

180 
	$_addR•lyToBufãr
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

181 
size_t
 
avaabË
 = (
c
->
buf
)-c->
buåos
;

183 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è 
VR_OK
;

187 ià(
	`dli¡L’gth
(
c
->
»¶y
è> 0è 
VR_ERROR
;

190 ià(
Ën
 > 
avaabË
è 
VR_ERROR
;

192 
	`memıy
(
c
->
buf
+c->
buåos
,
s
,
Ën
);

193 
c
->
buåos
+=
Ën
;

194  
VR_OK
;

195 
	}
}

197 
	$_addR•lyObjeùToLi¡
(
ş›Á
 *
c
, 
robj
 *
o
) {

198 
robj
 *

, *
obj
;

200 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

202 ià(
	`dli¡L’gth
(
c
->
»¶y
) == 0) {

203 ià(
o
->
cÚ¡ªt
)

204 
obj
 = 
o
;

206 
obj
 = 
	`dupSŒšgObjeù
(
o
);

207 
	`dli¡AddNodeTa
(
c
->
»¶y
,
obj
);

208 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
obj
);

210 

 = 
	`dli¡NodeV®ue
(
	`dli¡La¡
(
c
->
»¶y
));

213 ià(

->
±r
 !ğ
NULL
 &&

214 

->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

215 
	`sd¦’
(

->
±r
)+sd¦’(
o
->±rè<ğ
PROTO_REPLY_CHUNK_BYTES
)

217 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(

->
±r
);

218 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

219 

->
±r
 = 
	`sdsÿ’
Ña->±r,
o
->±r,
	`sd¦’
(o->ptr));

220 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(

->
±r
);

222 ià(
o
->
cÚ¡ªt
)

223 
obj
 = 
o
;

225 
obj
 = 
	`dupSŒšgObjeù
(
o
);

226 
	`dli¡AddNodeTa
(
c
->
»¶y
,
obj
);

227 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
obj
);

230 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

231 
	}
}

235 
	$_addR•lySdsToLi¡
(
ş›Á
 *
c
, 
sds
 
s
) {

236 
robj
 *

;

238 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

239 
	`sdsä“
(
s
);

243 ià(
	`dli¡L’gth
(
c
->
»¶y
) == 0) {

244 
	`dli¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
OBJ_STRING
,
s
));

245 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
s
);

247 

 = 
	`dli¡NodeV®ue
(
	`dli¡La¡
(
c
->
»¶y
));

250 ià(

->
±r
 !ğ
NULL
 &&a->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

251 
	`sd¦’
(

->
±r
)+sd¦’(
s
è<ğ
PROTO_REPLY_CHUNK_BYTES
)

253 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(

->
±r
);

254 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

255 

->
±r
 = 
	`sdsÿ’
Ña->±r,
s
,
	`sd¦’
(s));

256 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(

->
±r
);

257 
	`sdsä“
(
s
);

259 
	`dli¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
OBJ_STRING
,
s
));

260 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
s
);

263 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

264 
	}
}

266 
	$_addR•lySŒšgToLi¡
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

267 
robj
 *

;

269 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

271 ià(
	`dli¡L’gth
(
c
->
»¶y
) == 0) {

272 
robj
 *
o
 = 
	`ü—‹SŒšgObjeù
(
s
,
Ën
);

274 
	`dli¡AddNodeTa
(
c
->
»¶y
,
o
);

275 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

277 

 = 
	`dli¡NodeV®ue
(
	`dli¡La¡
(
c
->
»¶y
));

280 ià(

->
±r
 !ğ
NULL
 &&a->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

281 
	`sd¦’
(

->
±r
)+
Ën
 <ğ
PROTO_REPLY_CHUNK_BYTES
)

283 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(

->
±r
);

284 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

285 

->
±r
 = 
	`sdsÿ’
Ña->±r,
s
,
Ën
);

286 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(

->
±r
);

288 
robj
 *
o
 = 
	`ü—‹SŒšgObjeù
(
s
,
Ën
);

290 
	`dli¡AddNodeTa
(
c
->
»¶y
,
o
);

291 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

294 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

295 
	}
}

302 
	$addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
) {

303 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
) ;

312 ià(
	`sdsEncodedObjeù
(
obj
)) {

313 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
VR_OK
)

314 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

315 } ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

316 
robj
 *
obj_Ãw
;

320 ià(
	`dli¡L’gth
(
c
->
»¶y
è=ğ0 && ((c->
buf
è- c->
buåos
) >= 32) {

321 
buf
[32];

322 
Ën
;

324 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
obj
->
±r
);

325 ià(
	`_addR•lyToBufãr
(
c
,
buf
,
Ën
è=ğ
VR_OK
)

330 
obj_Ãw
 = 
	`g‘DecodedObjeù
(
obj
);

331 ià(
	`_addR•lyToBufãr
(
c
,
obj_Ãw
->
±r
,
	`sd¦’
(obj_Ãw->±r)è!ğ
VR_OK
)

332 
	`_addR•lyObjeùToLi¡
(
c
,
obj_Ãw
);

333 ià(
obj_Ãw
 !ğ
obj
è
	`ä“Objeù
(obj_new);

335 
	`£rv”Pªic
("Wrong obj->encoding in‡ddReply()");

337 
	}
}

339 
	$addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
) {

340 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
) {

342 
	`sdsä“
(
s
);

345 ià(
	`_addR•lyToBufãr
(
c
,
s
,
	`sd¦’
(s)è=ğ
VR_OK
) {

346 
	`sdsä“
(
s
);

349 
	`_addR•lySdsToLi¡
(
c
,
s
);

351 
	}
}

353 
	$addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

354 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
) ;

355 ià(
	`_addR•lyToBufãr
(
c
,
s
,
Ën
è!ğ
VR_OK
)

356 
	`_addR•lySŒšgToLi¡
(
c
,
s
,
Ën
);

357 
	}
}

359 
	$addR•lyE¼ÜL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

360 
	`addR•lySŒšg
(
c
,"-ERR ",5);

361 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

362 
	`addR•lySŒšg
(
c
,"\r\n",2);

363 
	}
}

365 
	$addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
) {

366 
	`addR•lyE¼ÜL’gth
(
c
,
”r
,
	`¡¾’
(err));

367 
	}
}

369 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

370 
size_t
 
l
, 
j
;

371 
va_li¡
 
­
;

372 
	`va_¡¬t
(
­
,
fmt
);

373 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

374 
	`va_’d
(
­
);

377 
l
 = 
	`sd¦’
(
s
);

378 
j
 = 0; j < 
l
; j++) {

379 ià(
s
[
j
] == '\r' || s[j] == '\n') s[j] = ' ';

381 
	`addR•lyE¼ÜL’gth
(
c
,
s
,
	`sd¦’
(s));

382 
	`sdsä“
(
s
);

383 
	}
}

385 
	$addR•lyStusL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

386 
	`addR•lySŒšg
(
c
,"+",1);

387 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

388 
	`addR•lySŒšg
(
c
,"\r\n",2);

389 
	}
}

391 
	$addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
) {

392 
	`addR•lyStusL’gth
(
c
,
¡©us
,
	`¡¾’
(status));

393 
	}
}

395 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

396 
va_li¡
 
­
;

397 
	`va_¡¬t
(
­
,
fmt
);

398 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

399 
	`va_’d
(
­
);

400 
	`addR•lyStusL’gth
(
c
,
s
,
	`sd¦’
(s));

401 
	`sdsä“
(
s
);

402 
	}
}

406 *
	$addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
) {

410 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
è 
NULL
;

411 
	`dli¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
OBJ_STRING
,
NULL
));

412  
	`dli¡La¡
(
c
->
»¶y
);

413 
	}
}

416 
	$£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
) {

417 
dli¡Node
 *
Ê
 = (dli¡Node*)
node
;

418 
robj
 *
Ën
, *
Ãxt
;

421 ià(
node
 =ğ
NULL
) ;

423 
Ën
 = 
	`dli¡NodeV®ue
(
Ê
);

424 
Ën
->
±r
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"*%ld\r\n",
Ëngth
);

425 
Ën
->
’codšg
 = 
OBJ_ENCODING_RAW
;

426 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
Ën
->
±r
);

427 ià(
Ê
->
Ãxt
 !ğ
NULL
) {

428 
Ãxt
 = 
	`dli¡NodeV®ue
(
Ê
->next);

431 ià(
Ãxt
->
±r
 !ğ
NULL
) {

432 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(
Ën
->
±r
);

433 
c
->
»¶y_by‹s
 -ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
Ãxt
);

434 
Ën
->
±r
 = 
	`sdsÿ’
Ö’->±r,
Ãxt
->±r,
	`sd¦’
(next->ptr));

435 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
Ën
->
±r
);

436 
	`dli¡D–Node
(
c
->
»¶y
,
Ê
->
Ãxt
);

439 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

440 
	}
}

443 
	$addR•lyDoubË
(
ş›Á
 *
c
, 
d
) {

444 
dbuf
[128], 
sbuf
[128];

445 
dËn
, 
¦’
;

446 ià(
	`isšf
(
d
)) {

449 
	`addR•lyBulkCSŒšg
(
c
, 
d
 > 0 ? "inf" : "-inf");

451 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

452 
¦’
 = 
	`¢´štf
(
sbuf
,(sbuf),"$%d\r\n%s\r\n",
dËn
,
dbuf
);

453 
	`addR•lySŒšg
(
c
,
sbuf
,
¦’
);

455 
	}
}

460 
	$addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
) {

461 
robj
 *
o
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
d
,1);

462 
	`addR•lyBulk
(
c
,
o
);

463 
	`deüRefCouÁ
(
o
);

464 
	}
}

468 
	$addR•lyLÚgLÚgW™hP»fix
(
ş›Á
 *
c
, 
Î
, 
´efix
) {

469 
buf
[128];

470 
Ën
;

475 ià(
´efix
 =ğ'*' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

476 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Î
]);

478 } ià(
´efix
 =ğ'$' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

479 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Î
]);

483 
buf
[0] = 
´efix
;

484 
Ën
 = 
	`Î2¡ršg
(
buf
+1,(buf)-1,
Î
);

485 
buf
[
Ën
+1] = '\r';

486 
buf
[
Ën
+2] = '\n';

487 
	`addR•lySŒšg
(
c
,
buf
,
Ën
+3);

488 
	}
}

490 
	$addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

491 ià(
Î
 == 0)

492 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

493 ià(
Î
 == 1)

494 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

496 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Î
,':');

497 
	}
}

499 
	$addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
) {

500 ià(
Ëngth
 < 
OBJ_SHARED_BULKHDR_LEN
)

501 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Ëngth
]);

503 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ëngth
,'*');

504 
	}
}

507 
	$addR•lyBulkL’
(
ş›Á
 *
c
, 
robj
 *
obj
) {

508 
size_t
 
Ën
;

510 ià(
	`sdsEncodedObjeù
(
obj
)) {

511 
Ën
 = 
	`sd¦’
(
obj
->
±r
);

513 
n
 = ()
obj
->
±r
;

516 
Ën
 = 1;

517 ià(
n
 < 0) {

518 
Ën
++;

519 
n
 = -n;

521 (
n
 =‚/10) != 0) {

522 
Ën
++;

526 ià(
Ën
 < 
OBJ_SHARED_BULKHDR_LEN
)

527 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Ën
]);

529 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

530 
	}
}

533 
	$addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
) {

534 
	`addR•lyBulkL’
(
c
,
obj
);

535 
	`addR•ly
(
c
,
obj
);

536 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

537 
	}
}

540 
	$addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
) {

541 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

542 
	`addR•lySŒšg
(
c
,
p
,
Ën
);

543 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

544 
	}
}

547 
	$addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
) {

548 
	`addR•lySds
(
c
,
	`sdsÿtfmt
(
	`sd£m±y
(),"$%u\r\n",

549 ()
	`sd¦’
(
s
)));

550 
	`addR•lySds
(
c
,
s
);

551 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

552 
	}
}

555 
	$addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
) {

556 ià(
s
 =ğ
NULL
) {

557 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

559 
	`addR•lyBulkCBufãr
(
c
,
s
,
	`¡¾’
(s));

561 
	}
}

564 
	$addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

565 
buf
[64];

566 
Ën
;

568 
Ën
 = 
	`Î2¡ršg
(
buf
,64,
Î
);

569 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

570 
	}
}

575 
	$cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
) {

576 
	`dli¡R–—£
(
d¡
->
»¶y
);

577 
d¡
->
»¶y
 = 
	`dli¡Dup
(
¤c
->reply);

578 
	`memıy
(
d¡
->
buf
,
¤c
->buf,¤c->
buåos
);

579 
d¡
->
buåos
 = 
¤c
->bufpos;

580 
d¡
->
»¶y_by‹s
 = 
¤c
->reply_bytes;

581 
	}
}

585 
	$ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
) {

586  
c
->
buåos
 || 
	`dli¡L’gth
(c->
»¶y
);

587 
	}
}

589 
	$ä“Cl›ÁArgv
(
ş›Á
 *
c
) {

590 
j
;

591 
j
 = 0; j < 
c
->
¬gc
; j++)

592 
	`ä“Objeù
(
c
->
¬gv
[
j
]);

593 
c
->
¬gc
 = 0;

594 
c
->
cmd
 = 
NULL
;

595 
	}
}

600 
	$discÚÃùSÏves
() {

601 
	`dli¡L’gth
(
»¶
.
¦aves
)) {

602 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
»¶
.
¦aves
);

603 
	`ä“Cl›Á
((
ş›Á
*)
Ê
->
v®ue
);

605 
	}
}

610 
	$uÆškCl›ÁFromEv’oİ
(
ş›Á
 *
c
) {

611 
dli¡Node
 *
Ê
;

612 
vr_ev’oİ
 *
v–
 = 
c
->vel;

614 
c
->
v–
 = 
NULL
;

616 ià(
c
->
¡•s
 >= 1) ;

619 ià(
v–
->
cu¼’t_ş›Á
 =ğ
c
èv–->cu¼’t_ş›Á = 
NULL
;

624 ià(
c
->
cÚn
->
sd
 != -1) {

626 
Ê
 = 
	`dli¡S—rchKey
(
v–
->
ş›Ás
,
c
);

627 
	`ASSERT
(
Ê
 !ğ
NULL
);

628 
	`dli¡D–Node
(
v–
->
ş›Ás
,
Ê
);

631 
	`«D–‘eFeEv’t
(
v–
->
–
,
c
->
cÚn
->
sd
,
AE_READABLE
);

632 
	`«D–‘eFeEv’t
(
v–
->
–
,
c
->
cÚn
->
sd
,
AE_WRITABLE
);

636 ià(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) {

637 
Ê
 = 
	`dli¡S—rchKey
(
v–
->
ş›Ás_³ndšg_wr™e
,
c
);

638 
	`ASSERT
(
Ê
 !ğ
NULL
);

639 
	`dli¡D–Node
(
v–
->
ş›Ás_³ndšg_wr™e
,
Ê
);

640 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

645 ià(
c
->
æags
 & 
CLIENT_UNBLOCKED
) {

646 
Ê
 = 
	`dli¡S—rchKey
(
v–
->
unblocked_ş›Ás
,
c
);

647 
	`ASSERT
(
Ê
 !ğ
NULL
);

648 
	`dli¡D–Node
(
v–
->
unblocked_ş›Ás
,
Ê
);

649 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

651 
	}
}

653 
	$lškCl›ÁToEv’oİ
(
ş›Á
 *
c
,
vr_ev’oİ
 *
v–
) {

654 
	`dli¡Push
(
v–
->
ş›Ás
,
c
);

655 
c
->
v–
 = vel;

656 ià(
	`«C»©eFeEv’t
(
v–
->
–
,
c
->
cÚn
->
sd
,
AE_READABLE
,

657 
»adQu”yFromCl›Á
,
c
è=ğ
AE_ERR
)

659 
	`ä“Cl›Á
(
c
);

664 
	`´oûssIÅutBufãr
(
c
);

665 ià(
c
->
æags
&
CLIENT_JUMP
) {

666 
	`di¥©ch_cÚn_exi¡
(
c
,c->
ridx
);

668 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

669 !(
c
->
æags
&
CLIENT_PENDING_WRITE
)) {

670 ià(
	`«C»©eFeEv’t
(
v–
->
–
, 
c
->
cÚn
->
sd
, 
AE_WRITABLE
,

671 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

673 
	`ä“Cl›ÁAsync
(
c
);

677 
	}
}

682 
	$uÆškCl›Á
(
ş›Á
 *
c
) {

683 
dli¡Node
 *
Ê
;

686 ià(
c
->
v–
->
cu¼’t_ş›Á
 =ğcèc->v–->cu¼’t_ş›Á = 
NULL
;

691 ià(
c
->
cÚn
->
sd
 != -1) {

693 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás
,c);

694 
	`ASSERT
(
Ê
 !ğ
NULL
);

695 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás
,
Ê
);

698 
	`«D–‘eFeEv’t
(
c
->
v–
->
–
,c->
cÚn
->
sd
,
AE_READABLE
);

699 
	`«D–‘eFeEv’t
(
c
->
v–
->
–
,c->
cÚn
->
sd
,
AE_WRITABLE
);

700 
	`cÚn_put
(
c
->
cÚn
);

701 
c
->
cÚn
 = 
NULL
;

705 ià(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) {

706 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás_³ndšg_wr™e
,c);

707 
	`ASSERT
(
Ê
 !ğ
NULL
);

708 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás_³ndšg_wr™e
,
Ê
);

709 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

714 ià(
c
->
æags
 & 
CLIENT_UNBLOCKED
) {

715 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
unblocked_ş›Ás
,c);

716 
	`ASSERT
(
Ê
 !ğ
NULL
);

717 
	`dli¡D–Node
(
c
->
v–
->
unblocked_ş›Ás
,
Ê
);

718 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

720 
	}
}

722 
	$ä“Cl›Á
(
ş›Á
 *
c
) {

723 
dli¡Node
 *
Ê
;

730 ià(
»¶
.
rŞe
 =ğ
REPLICATION_ROLE_MASTER
 && 
c
->
æags
 & 
CLIENT_MASTER
) {

731 
	`log_w¬n
("connection with master†ost.");

732 ià(!(
c
->
æags
 & (
CLIENT_CLOSE_AFTER_REPLY
|

733 
CLIENT_CLOSE_ASAP
|

734 
CLIENT_BLOCKED
|

735 
CLIENT_UNBLOCKED
)))

737 
	`»¶iÿtiÚCacheMa¡”
(
c
);

743 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
)) {

744 
	`log_w¬n
("connection with slave %s†ost.",

745 
	`»¶iÿtiÚG‘SÏveName
(
c
));

749 
	`sdsä“
(
c
->
qu”ybuf
);

750 
c
->
qu”ybuf
 = 
NULL
;

753 ià(
c
->
æags
 & 
CLIENT_BLOCKED
è
	`unblockCl›Á
(c);

754 
	`diùR–—£
(
c
->
bpİ
.
keys
);

757 
	`unw©chAÎKeys
(
c
);

758 
	`dli¡R–—£
(
c
->
w©ched_keys
);

761 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,0);

762 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,0);

763 
	`diùR–—£
(
c
->
pubsub_chªÃls
);

764 
	`dli¡R–—£
(
c
->
pubsub_·‰”ns
);

767 
	`dli¡R–—£
(
c
->
»¶y
);

768 
	`ä“Cl›ÁArgv
(
c
);

773 
	`uÆškCl›Á
(
c
);

777 ià(
c
->
æags
 & 
CLIENT_SLAVE
) {

778 ià(
c
->
»¶¡©e
 =ğ
SLAVE_STATE_SEND_BULK
) {

779 ià(
c
->
»¶dbfd
 !ğ-1è
	`şo£
(c->repldbfd);

780 ià(
c
->
»¶´—mbË
è
	`sdsä“
(c->replpreamble);

782 
dli¡
 *
l
 = (
c
->
æags
 & 
CLIENT_MONITOR
è? 
£rv”
.
mÚ™Üs
 : 
»¶
.
¦aves
;

783 
Ê
 = 
	`dli¡S—rchKey
(
l
,
c
);

784 
	`ASSERT
(
Ê
 !ğ
NULL
);

785 
	`dli¡D–Node
(
l
,
Ê
);

789 ià(
c
->
æags
 & 
CLIENT_SLAVE
 && 
	`dli¡L’gth
(
»¶
.
¦aves
) == 0)

790 
»¶
.
»¶_no_¦aves_sšû
 = 
c
->
v–
->
unixtime
;

791 
	`»äeshGoodSÏvesCouÁ
();

796 ià(
c
->
æags
 & 
CLIENT_MASTER
è
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

800 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
) {

801 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás_to_şo£
,c);

802 
	`ASSERT
(
Ê
 !ğ
NULL
);

803 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás_to_şo£
,
Ê
);

808 ià(
c
->
Çme
è
	`ä“Objeù
(c->name);

809 ià(
c
->
¬gv
è
	`dä“
(c->argv);

810 
	`ä“Cl›ÁMuÉiS‹
(
c
);

811 
	`sdsä“
(
c
->
³”id
);

812 
	`dä“
(
c
);

813 
	}
}

819 
	$ä“Cl›ÁAsync
(
ş›Á
 *
c
) {

820 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
 || c->æag & 
CLIENT_LUA
) ;

821 
c
->
æags
 |ğ
CLIENT_CLOSE_ASAP
;

822 
	`dli¡AddNodeTa
(
c
->
v–
->
ş›Ás_to_şo£
,c);

823 
	}
}

825 
	$ä“Cl›ÁsInAsyncF»eQueue
(
vr_ev’oİ
 *
v–
) {

826 
	`dli¡L’gth
(
v–
->
ş›Ás_to_şo£
)) {

827 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
v–
->
ş›Ás_to_şo£
);

828 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

830 
c
->
æags
 &ğ~
CLIENT_CLOSE_ASAP
;

831 
	`ä“Cl›Á
(
c
);

832 
	`dli¡D–Node
(
v–
->
ş›Ás_to_şo£
,
Ê
);

834 
	}
}

838 
	$wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
) {

839 
ssize_t
 
nwr™‹n
 = 0, 
tÙwr™‹n
 = 0;

840 
size_t
 
objËn
;

841 
size_t
 
objmem
;

842 
robj
 *
o
;

843 
maxmemÜy
;

845 
maxmemÜy
 = 
c
->
v–
->
cc
.maxmemory;

846 
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

847 ià(
c
->
buåos
 > 0) {

848 
nwr™‹n
 = 
	`vr_wr™e
(
fd
,
c
->
buf
+c->
£ÁËn
,c->
buåos
-c->sentlen);

849 ià(
nwr™‹n
 <= 0) ;

850 
c
->
£ÁËn
 +ğ
nwr™‹n
;

851 
tÙwr™‹n
 +ğ
nwr™‹n
;

855 ià(()
c
->
£ÁËn
 =ğc->
buåos
) {

856 
c
->
buåos
 = 0;

857 
c
->
£ÁËn
 = 0;

860 
o
 = 
	`dli¡NodeV®ue
(
	`dli¡Fœ¡
(
c
->
»¶y
));

861 
objËn
 = 
	`sd¦’
(
o
->
±r
);

862 
objmem
 = 
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

864 ià(
objËn
 == 0) {

865 
	`dli¡D–Node
(
c
->
»¶y
,
	`dli¡Fœ¡
(c->reply));

866 
c
->
»¶y_by‹s
 -ğ
objmem
;

870 
nwr™‹n
 = 
	`vr_wr™e
(
fd
, ((*)
o
->
±r
)+
c
->
£ÁËn
,
objËn
-c->sentlen);

871 ià(
nwr™‹n
 <= 0) ;

872 
c
->
£ÁËn
 +ğ
nwr™‹n
;

873 
tÙwr™‹n
 +ğ
nwr™‹n
;

876 ià(
c
->
£ÁËn
 =ğ
objËn
) {

877 
	`dli¡D–Node
(
c
->
»¶y
,
	`dli¡Fœ¡
(c->reply));

878 
c
->
£ÁËn
 = 0;

879 
c
->
»¶y_by‹s
 -ğ
objmem
;

890 ià(
tÙwr™‹n
 > 
NET_MAX_WRITES_PER_EVENT
 &&

891 (
maxmemÜy
 =ğ0 || 
	`d®loc_u£d_memÜy
() < maxmemory))

894 ià(
nwr™‹n
 == -1) {

895 ià(
”ºo
 =ğ
EAGAIN
) {

896 
nwr™‹n
 = 0;

898 
	`log_debug
(
LOG_VERB
,

899 "”rÜ wr™šgØş›Á: %s", 
	`¡»¼Ü
(
”ºo
));

900 
	`ä“Cl›Á
(
c
);

901  
VR_ERROR
;

904 ià(
tÙwr™‹n
 > 0) {

905 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
Ãt_ouut_by‹s
, ()
tÙwr™‹n
);

910 ià(!(
c
->
æags
 & 
CLIENT_MASTER
)èc->
Ï¡š‹¿ùiÚ
 = c->
v–
->
unixtime
;

912 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

913 
c
->
£ÁËn
 = 0;

914 ià(
hªdËr_š¡®Ëd
è
	`«D–‘eFeEv’t
(
c
->
v–
->
–
,c->
cÚn
->
sd
,
AE_WRITABLE
);

917 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

918 
	`ä“Cl›Á
(
c
);

919  
VR_ERROR
;

922  
VR_OK
;

923 
	}
}

926 
	$£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

927 
	`UNUSED
(
–
);

928 
	`UNUSED
(
mask
);

929 
	`wr™eToCl›Á
(
fd
,
´ivd©a
,1);

930 
	}
}

936 
	$hªdËCl›ÁsW™hP’dšgWr™es
(
vr_ev’oİ
 *
v–
) {

937 
dli¡I‹r
 
li
;

938 
dli¡Node
 *
Ê
;

939 
´oûs£d
 = 
	`dli¡L’gth
(
v–
->
ş›Ás_³ndšg_wr™e
);

941 
	`dli¡Rewšd
(
v–
->
ş›Ás_³ndšg_wr™e
,&
li
);

942 (
Ê
 = 
	`dli¡Next
(&
li
))) {

943 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

944 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

945 
	`dli¡D–Node
(
v–
->
ş›Ás_³ndšg_wr™e
,
Ê
);

948 ià(
	`wr™eToCl›Á
(
c
->
cÚn
->
sd
,c,0è=ğ
VR_ERROR
) ;

952 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

953 
	`«C»©eFeEv’t
(
v–
->
–
, 
c
->
cÚn
->
sd
, 
AE_WRITABLE
,

954 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

956 
	`ä“Cl›ÁAsync
(
c
);

959  
´oûs£d
;

960 
	}
}

963 
	$»£tCl›Á
(
ş›Á
 *
c
) {

964 
»disCommªdProc
 *
´evcmd
 = 
c
->
cmd
 ? c->cmd->
´oc
 : 
NULL
;

966 ià(
c
->
æags
&
CLIENT_JUMP
)

969 
	`ä“Cl›ÁArgv
(
c
);

970 
c
->
»qty³
 = 0;

971 
c
->
muÉibulkËn
 = 0;

972 
c
->
bulkËn
 = -1;

977 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP
;

978 ià(
c
->
æags
 & 
CLIENT_REPLY_SKIP_NEXT
) {

979 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP
;

980 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP_NEXT
;

982 
	}
}

984 
	$´oûssIÆšeBufãr
(
ş›Á
 *
c
) {

985 *
Ãwlše
;

986 
¬gc
, 
j
;

987 
sds
 *
¬gv
, 
aux
;

988 
size_t
 
qu”yËn
;

991 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\n');

994 ià(
Ãwlše
 =ğ
NULL
) {

995 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

996 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big inline„equest");

997 
	`£tPrÙocŞE¼Ü
(
c
,0);

999  
VR_ERROR
;

1003 ià(
Ãwlše
 &&‚ewlš!ğ
c
->
qu”ybuf
 && *(newline-1) == '\r')

1004 
Ãwlše
--;

1007 
qu”yËn
 = 
Ãwlše
-(
c
->
qu”ybuf
);

1008 
aux
 = 
	`sd¢ewËn
(
c
->
qu”ybuf
,
qu”yËn
);

1009 
¬gv
 = 
	`sds¥l™¬gs
(
aux
,&
¬gc
);

1010 
	`sdsä“
(
aux
);

1011 ià(
¬gv
 =ğ
NULL
) {

1012 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: unbalanced quotes in„equest");

1013 
	`£tPrÙocŞE¼Ü
(
c
,0);

1014  
VR_ERROR
;

1020 ià(
qu”yËn
 =ğ0 && 
c
->
æags
 & 
CLIENT_SLAVE
)

1021 
c
->
»¶_ack_time
 = c->
v–
->
unixtime
;

1024 
	`sd¤ªge
(
c
->
qu”ybuf
,
qu”yËn
+2,-1);

1027 ià(
¬gc
) {

1028 ià(
c
->
¬gv
è
	`dä“
(c->argv);

1029 
c
->
¬gv
 = 
	`d®loc
((
robj
*)*
¬gc
);

1033 
c
->
¬gc
 = 0, 
j
 = 0; j <‡rgc; j++) {

1034 ià(
	`sd¦’
(
¬gv
[
j
])) {

1035 
c
->
¬gv
[c->
¬gc
] = 
	`ü—‹Objeù
(
OBJ_STRING
,¬gv[
j
]);

1036 
c
->
¬gc
++;

1038 
	`sdsä“
(
¬gv
[
j
]);

1041 
	`dä“
(
¬gv
);

1042  
VR_OK
;

1043 
	}
}

1047 
	$£tPrÙocŞE¼Ü
(
ş›Á
 *
c
, 
pos
) {

1048 ià(
	`log_loggabË
(
LOG_VERB
)) {

1049 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1050 
	`log_debug
(
LOG_VERB
,

1051 "PrÙocŞƒ¼Ü from cl›Á: %s", 
ş›Á
);

1052 
	`sdsä“
(
ş›Á
);

1054 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1055 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1056 
	}
}

1058 
	$´oûssMuÉibulkBufãr
(
ş›Á
 *
c
) {

1059 *
Ãwlše
 = 
NULL
;

1060 
pos
 = 0, 
ok
;

1061 
Î
;

1063 ià(
c
->
muÉibulkËn
 == 0) {

1065 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
¬gc
 == 0);

1068 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\r');

1069 ià(
Ãwlše
 =ğ
NULL
) {

1070 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1071 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big mbulk count string");

1072 
	`£tPrÙocŞE¼Ü
(
c
,0);

1074  
VR_ERROR
;

1078 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1079  
VR_ERROR
;

1083 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
qu”ybuf
[0] == '*');

1084 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+1,
Ãwlše
-(c->qu”ybuf+1),&
Î
);

1085 ià(!
ok
 || 
Î
 > 1024*1024) {

1086 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid multibulk†ength");

1087 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1088  
VR_ERROR
;

1091 
pos
 = (
Ãwlše
-
c
->
qu”ybuf
)+2;

1092 ià(
Î
 <= 0) {

1093 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1094  
VR_OK
;

1097 
c
->
muÉibulkËn
 = 
Î
;

1100 ià(
c
->
¬gv
è
	`dä“
(c->argv);

1101 
c
->
¬gv
 = 
	`d®loc
((
robj
*)*c->
muÉibulkËn
);

1104 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
muÉibulkËn
 > 0);

1105 
c
->
muÉibulkËn
) {

1107 ià(
c
->
bulkËn
 == -1) {

1108 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
+
pos
,'\r');

1109 ià(
Ãwlše
 =ğ
NULL
) {

1110 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1111 
	`addR•lyE¼Ü
(
c
,

1113 
	`£tPrÙocŞE¼Ü
(
c
,0);

1114  
VR_ERROR
;

1120 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1123 ià(
c
->
qu”ybuf
[
pos
] != '$') {

1124 
	`addR•lyE¼ÜFÜm©
(
c
,

1126 
c
->
qu”ybuf
[
pos
]);

1127 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1128  
VR_ERROR
;

1131 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+
pos
+1,
Ãwlše
-(c->qu”ybuf+pos+1),&
Î
);

1132 ià(!
ok
 || 
Î
 < 0 ||†l > 512*1024*1024) {

1133 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid bulk†ength");

1134 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1135  
VR_ERROR
;

1138 
pos
 +ğ
Ãwlše
-(
c
->
qu”ybuf
+pos)+2;

1139 ià(
Î
 >ğ
PROTO_MBULK_BIG_ARG
) {

1140 
size_t
 
qbËn
;

1146 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1147 
pos
 = 0;

1148 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1151 ià(
qbËn
 < (
size_t
)
Î
+2)

1152 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf,
Î
+2-
qbËn
);

1154 
c
->
bulkËn
 = 
Î
;

1158 ià(
	`sd¦’
(
c
->
qu”ybuf
)-
pos
 < ()(c->
bulkËn
+2)) {

1165 ià(
pos
 == 0 &&

1166 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
 &&

1167 (sigÃdè
	`sd¦’
(
c
->
qu”ybuf
è=ğc->
bulkËn
+2)

1169 
c
->
¬gv
[c->
¬gc
++] = 
	`ü—‹Objeù
(
OBJ_STRING
,c->
qu”ybuf
);

1170 
	`sdsInüL’
(
c
->
qu”ybuf
,-2);

1173 
c
->
qu”ybuf
 = 
	`sd¢ewËn
(
NULL
,c->
bulkËn
+2);

1174 
	`sdsş—r
(
c
->
qu”ybuf
);

1175 
pos
 = 0;

1177 
c
->
¬gv
[c->
¬gc
++] =

1178 
	`ü—‹SŒšgObjeù
(
c
->
qu”ybuf
+
pos
,c->
bulkËn
);

1179 
pos
 +ğ
c
->
bulkËn
+2;

1181 
c
->
bulkËn
 = -1;

1182 
c
->
muÉibulkËn
--;

1187 ià(
pos
è
	`sd¤ªge
(
c
->
qu”ybuf
,pos,-1);

1190 ià(
c
->
muÉibulkËn
 =ğ0è 
VR_OK
;

1193  
VR_ERROR
;

1194 
	}
}

1196 
	$´oûssIÅutBufãr
(
ş›Á
 *
c
) {

1197 
c
->
v–
->
cu¼’t_ş›Á
 = c;

1199 
	`sd¦’
(
c
->
qu”ybuf
)) {

1201 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
è&& 
	`ş›ÁsA»Pau£d
(c->
v–
)) ;

1204 ià(
c
->
æags
 & 
CLIENT_BLOCKED
) ;

1209 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

1212 ià(!
c
->
»qty³
) {

1213 ià(
c
->
qu”ybuf
[0] == '*') {

1214 
c
->
»qty³
 = 
PROTO_REQ_MULTIBULK
;

1216 
c
->
»qty³
 = 
PROTO_REQ_INLINE
;

1220 ià(
c
->
»qty³
 =ğ
PROTO_REQ_INLINE
) {

1221 ià(
	`´oûssIÆšeBufãr
(
c
è!ğ
VR_OK
) ;

1222 } ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
) {

1223 ià(
	`´oûssMuÉibulkBufãr
(
c
è!ğ
VR_OK
) ;

1225 
	`£rv”Pªic
("Unknown„equestype");

1229 ià(
c
->
¬gc
 == 0) {

1230 
	`»£tCl›Á
(
c
);

1233 ià(
	`´oûssCommªd
(
c
è=ğ
VR_OK
)

1234 
	`»£tCl›Á
(
c
);

1237 ià(
c
->
v–
->
cu¼’t_ş›Á
 =ğ
NULL
) ;

1242 ià(
c
->
æags
&
CLIENT_JUMP
) ;

1245 
c
->
v–
->
cu¼’t_ş›Á
 = 
NULL
;

1246 
	}
}

1248 
	$»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1249 
ş›Á
 *
c
 = (ş›Á*è
´ivd©a
;

1250 
Ä—d
, 
»adËn
;

1251 
size_t
 
qbËn
;

1252 
	`UNUSED
(
–
);

1253 
	`UNUSED
(
mask
);

1255 
»adËn
 = 
PROTO_IOBUF_LEN
;

1262 ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
 && c->
muÉibulkËn
 && c->
bulkËn
 != -1

1263 && 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
)

1265 
»maššg
 = ()(
c
->
bulkËn
+2)-
	`sd¦’
(c->
qu”ybuf
);

1267 ià(
»maššg
 < 
»adËn
)„eadlen =„emaining;

1270 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1271 ià(
c
->
qu”ybuf_³ak
 < 
qbËn
) c->querybuf_peak = qblen;

1272 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf, 
»adËn
);

1273 
Ä—d
 = 
	`vr_»ad
(
fd
, 
c
->
qu”ybuf
+
qbËn
, 
»adËn
);

1274 ià(
Ä—d
 == -1) {

1275 ià(
”ºo
 =ğ
EAGAIN
) {

1278 
	`log_debug
(
LOG_VERB
, "»adšg from cl›Á: %s",
	`¡»¼Ü
(
”ºo
));

1279 
	`ä“Cl›Á
(
c
);

1282 } ià(
Ä—d
 == 0) {

1283 
	`log_debug
(
LOG_VERB
, "client closed connection");

1284 
	`ä“Cl›Á
(
c
);

1288 
	`sdsInüL’
(
c
->
qu”ybuf
,
Ä—d
);

1289 
c
->
Ï¡š‹¿ùiÚ
 = c->
v–
->
unixtime
;

1290 ià(
c
->
æags
 & 
CLIENT_MASTER
èc->
»¶off
 +ğ
Ä—d
;

1291 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
Ãt_šput_by‹s
, 
Ä—d
);

1292 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
£rv”
.
ş›Á_max_qu”ybuf_Ën
) {

1293 
sds
 
ci
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
), 
by‹s
 = sdsempty();

1295 
by‹s
 = 
	`sdsÿŒ•r
(by‹s,
c
->
qu”ybuf
,64);

1296 
	`log_w¬n
("şosšg cl›Áh©„—ched max qu”y bufã¸Ëngth: % (qbuàš™ŸÈby‹s: %s)", 
ci
, 
by‹s
);

1297 
	`sdsä“
(
ci
);

1298 
	`sdsä“
(
by‹s
);

1299 
	`ä“Cl›Á
(
c
);

1302 
	`´oûssIÅutBufãr
(
c
);

1304 ià(
c
->
æags
&
CLIENT_JUMP
) {

1305 
	`di¥©ch_cÚn_exi¡
(
c
,c->
ridx
);

1307 
	}
}

1309 
	$g‘Cl›ÁsMaxBufãrs
(
vr_ev’oİ
 *
v–
, *
lÚge¡_ouut_li¡
,

1310 *
bigge¡_šput_bufãr
) {

1311 
ş›Á
 *
c
;

1312 
dli¡Node
 *
Ê
;

1313 
dli¡I‹r
 
li
;

1314 
lŞ
 = 0, 
bib
 = 0;

1316 
	`dli¡Rewšd
(
v–
->
ş›Ás
,&
li
);

1317 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1318 
c
 = 
	`dli¡NodeV®ue
(
Ê
);

1320 ià(
	`dli¡L’gth
(
c
->
»¶y
è> 
lŞ
)†ol = dlistLength(c->reply);

1321 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
bib
) bib = sdslen(c->querybuf);

1323 *
lÚge¡_ouut_li¡
 = 
lŞ
;

1324 *
bigge¡_šput_bufãr
 = 
bib
;

1325 
	}
}

1338 
	$g’Cl›ÁP“rId
(
ş›Á
 *ş›Á, *
³”id
,

1339 
size_t
 
³”id_Ën
) {

1340 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

1342 
	`¢´štf
(
³”id
,
³”id_Ën
,"%s:0",
£rv”
.
unixsock‘
);

1345 
	`vr_Ãt_fÜm©_³”
(
ş›Á
->
cÚn
->
sd
,
³”id
,
³”id_Ën
);

1347 
	}
}

1353 *
	$g‘Cl›ÁP“rId
(
ş›Á
 *
c
) {

1354 
³”id
[
VR_INET_PEER_ID_LEN
];

1356 ià(
c
->
³”id
 =ğ
NULL
) {

1357 
	`g’Cl›ÁP“rId
(
c
,
³”id
,(peerid));

1358 
c
->
³”id
 = 
	`sd¢ew
(peerid);

1360  
c
->
³”id
;

1361 
	}
}

1365 
sds
 
	$ÿtCl›ÁInfoSŒšg
(
sds
 
s
, 
ş›Á
 *client) {

1366 
æags
[16], 
ev’ts
[3], *
p
;

1367 
emask
;

1369 
p
 = 
æags
;

1370 ià(
ş›Á
->
æags
 & 
CLIENT_SLAVE
) {

1371 ià(
ş›Á
->
æags
 & 
CLIENT_MONITOR
)

1372 *
p
++ = 'O';

1374 *
p
++ = 'S';

1376 ià(
ş›Á
->
æags
 & 
CLIENT_MASTER
è*
p
++ = 'M';

1377 ià(
ş›Á
->
æags
 & 
CLIENT_MULTI
è*
p
++ = 'x';

1378 ià(
ş›Á
->
æags
 & 
CLIENT_BLOCKED
è*
p
++ = 'b';

1379 ià(
ş›Á
->
æags
 & 
CLIENT_DIRTY_CAS
è*
p
++ = 'd';

1380 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è*
p
++ = 'c';

1381 ià(
ş›Á
->
æags
 & 
CLIENT_UNBLOCKED
è*
p
++ = 'u';

1382 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_ASAP
è*
p
++ = 'A';

1383 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
è*
p
++ = 'U';

1384 ià(
ş›Á
->
æags
 & 
CLIENT_READONLY
è*
p
++ = 'r';

1385 ià(
p
 =ğ
æags
) *p++ = 'N';

1386 *
p
++ = '\0';

1388 
emask
 = 
ş›Á
->
cÚn
->
sd
 =ğ-1 ? 0 : 
	`«G‘FeEv’ts
(ş›Á->
v–
->
–
,client->conn->sd);

1389 
p
 = 
ev’ts
;

1390 ià(
emask
 & 
AE_READABLE
è*
p
++ = 'r';

1391 ià(
emask
 & 
AE_WRITABLE
è*
p
++ = 'w';

1392 *
p
 = '\0';

1394  
	`sdsÿtfmt
(
s
,

1396 
ş›Á
->
curidx
,

1397 (è
ş›Á
->
id
,

1398 
	`g‘Cl›ÁP“rId
(
ş›Á
),

1399 
ş›Á
->
cÚn
->
sd
,

1400 
ş›Á
->
Çme
 ? (*)ş›Á->Çme->
±r
 : "",

1401 ()(
ş›Á
->
v–
->
unixtime
 - cl›Á->
ùime
),

1402 ()(
ş›Á
->
v–
->
unixtime
 - cl›Á->
Ï¡š‹¿ùiÚ
),

1403 
æags
,

1404 
ş›Á
->
diùid
,

1405 (è
	`diùSize
(
ş›Á
->
pubsub_chªÃls
),

1406 (è
	`dli¡L’gth
(
ş›Á
->
pubsub_·‰”ns
),

1407 (
ş›Á
->
æags
 & 
CLIENT_MULTI
è? cl›Á->
m¡©e
.
couÁ
 : -1,

1408 (è
	`sd¦’
(
ş›Á
->
qu”ybuf
),

1409 (è
	`sd§va
(
ş›Á
->
qu”ybuf
),

1410 (è
ş›Á
->
buåos
,

1411 (è
	`dli¡L’gth
(
ş›Á
->
»¶y
),

1412 (è
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
),

1413 
ev’ts
,

1414 
ş›Á
->
Ï¡cmd
 ? cl›Á->Ï¡cmd->
Çme
 : "NULL");

1415 
	}
}

1417 
sds
 
	$g‘AÎCl›ÁsInfoSŒšg
(
vr_ev’oİ
 *
v–
) {

1418 
dli¡Node
 *
Ê
;

1419 
dli¡I‹r
 
li
;

1420 
ş›Á
 *client;

1421 
sds
 
o
 = 
	`sd¢ewËn
(
NULL
,200*
	`dli¡L’gth
(
v–
->
ş›Ás
));

1422 
	`sdsş—r
(
o
);

1423 
	`dli¡Rewšd
(
v–
->
ş›Ás
,&
li
);

1424 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1425 
ş›Á
 = 
	`dli¡NodeV®ue
(
Ê
);

1426 
o
 = 
	`ÿtCl›ÁInfoSŒšg
(o,
ş›Á
);

1427 
o
 = 
	`sdsÿ’
(o,"\n",1);

1429  
o
;

1430 
	}
}

1432 
	sş›Ákld©a
 {

1433 
sds
 
	maddr
;

1434 
	mty³
;

1435 
ušt64_t
 
	mid
;

1436 
	mskme
;

1437 
	mkËd
;

1438 
	mşo£_this_ş›Á
;

1441 
	$ş›ÁCommªd
(
ş›Á
 *
c
) {

1442 
dli¡Node
 *
Ê
;

1443 
dli¡I‹r
 
li
;

1444 
ş›Á
 *client;

1446 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"li¡"è&& c->
¬gc
 == 2) {

1448 
sds
 
¡r
 = 
c
->
ÿche
;

1449 
sds
 
o
 = 
	`g‘AÎCl›ÁsInfoSŒšg
(
c
->
v–
);

1451 
¡r
 = 
	`sdsÿtsds
(¡r?¡r:
	`sd£m±y
(),
o
);

1453 ià(
c
->
¡•s
 >ğ(
	`d¬¿y_n
(&
wÜk”s
) - 1)) {

1454 
	`addR•lyBulkCBufãr
(
c
,
¡r
,
	`sd¦’
(str));

1455 
c
->
¡•s
 = 0;

1456 
c
->
ridx
 = -1;

1457 
	`sdsä“
(
¡r
);

1458 
c
->
ÿche
 = 
NULL
;

1459 
c
->
æags
 &ğ~
CLIENT_JUMP
;

1461 ià(!(
c
->
æags
&
CLIENT_JUMP
))

1462 
c
->
æags
 |ğ
CLIENT_JUMP
;

1463 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

1464 
c
->
ÿche
 = 
¡r
;

1466 
	`sdsä“
(
o
);

1468 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"kill")) {

1471 
ş›Ákld©a
 *
ckd
;

1473 ià(
c
->
¡•s
 == 0) {

1474 
ckd
 = 
	`d®loc
((
ş›Ákld©a
));

1475 
ckd
->
addr
 = 
NULL
;

1476 
ckd
->
ty³
 = -1;

1477 
ckd
->
id
 = 0;

1478 
ckd
->
skme
 = 1;

1479 
ckd
->
kËd
 = 0;

1480 
ckd
->
şo£_this_ş›Á
 = 0;

1482 ià(
c
->
¬gc
 == 3) {

1484 
ckd
->
addr
 = 
	`sd¢ew
(
c
->
¬gv
[2]->
±r
);

1485 
ckd
->
skme
 = 0;

1486 } ià(
c
->
¬gc
 > 3) {

1487 
i
 = 2;

1490 
i
 < 
c
->
¬gc
) {

1491 
mÜ—rgs
 = 
c
->
¬gc
 > 
i
+1;

1493 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"id"è&& 
mÜ—rgs
) {

1494 
tmp
;

1496 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
i
+1],&
tmp
,
NULL
)

1497 !ğ
VR_OK
) {

1498 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1499 
	`dä“
(
ckd
);

1502 
ckd
->
id
 = 
tmp
;

1503 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"ty³"è&& 
mÜ—rgs
) {

1504 
ckd
->
ty³
 = 
	`g‘Cl›ÁTy³ByName
(
c
->
¬gv
[
i
+1]->
±r
);

1505 ià(
ckd
->
ty³
 == -1) {

1506 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1507 
	`dä“
(
ckd
);

1508 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown clientype '%s'",

1509 (*è
c
->
¬gv
[
i
+1]->
±r
);

1512 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"addr"è&& 
mÜ—rgs
) {

1513 
ckd
->
addr
 = 
	`sd¢ew
(
c
->
¬gv
[
i
+1]->
±r
);

1514 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"skme"è&& 
mÜ—rgs
) {

1515 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"yes")) {

1516 
ckd
->
skme
 = 1;

1517 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"no")) {

1518 
ckd
->
skme
 = 0;

1520 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1521 
	`dä“
(
ckd
);

1522 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1526 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1527 
	`dä“
(
ckd
);

1528 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1531 
i
 += 2;

1534 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1535 
	`dä“
(
ckd
);

1536 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1540 ià(!(
c
->
æags
&
CLIENT_JUMP
))

1541 
c
->
æags
 |ğ
CLIENT_JUMP
;

1542 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

1543 
c
->
ÿche
 = 
ckd
;

1545 
ckd
 = 
c
->
ÿche
;

1546 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

1550 
	`dli¡Rewšd
(
c
->
v–
->
ş›Ás
,&
li
);

1551 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1552 
ş›Á
 = 
	`dli¡NodeV®ue
(
Ê
);

1553 ià(
ckd
->
addr
 && 
	`¡rcmp
(
	`g‘Cl›ÁP“rId
(
ş›Á
),ckd->addr) != 0) ;

1554 ià(
ckd
->
ty³
 !ğ-1 && 
	`g‘Cl›ÁTy³
(
ş›Á
) != ckd->type) ;

1555 ià(
ckd
->
id
 !ğ0 && 
ş›Á
->id != ckd->id) ;

1556 ià(
c
 =ğ
ş›Á
 && 
ckd
->
skme
) ;

1559 ià(
c
 =ğ
ş›Á
) {

1560 
ckd
->
şo£_this_ş›Á
 = 1;

1562 
	`ä“Cl›Á
(
ş›Á
);

1564 
ckd
->
kËd
++;

1567 ià(
c
->
¡•s
 >ğ(
	`d¬¿y_n
(&
wÜk”s
) - 1)) {

1569 ià(
c
->
¬gc
 == 3) {

1570 ià(
ckd
->
kËd
 == 0)

1571 
	`addR•lyE¼Ü
(
c
,"No such client");

1573 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1575 
	`addR•lyLÚgLÚg
(
c
,
ckd
->
kËd
);

1578 
c
->
¡•s
 = 0;

1579 
c
->
ridx
 = -1;

1580 
c
->
ÿche
 = 
NULL
;

1581 
c
->
æags
 &ğ~
CLIENT_JUMP
;

1585 ià(
ckd
->
şo£_this_ş›Á
è
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1587 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1588 
	`dä“
(
ckd
);

1592 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£Šame"è&& c->
¬gc
 == 3) {

1593 
j
, 
Ën
 = 
	`sd¦’
(
c
->
¬gv
[2]->
±r
);

1594 *
p
 = 
c
->
¬gv
[2]->
±r
;

1598 ià(
Ën
 == 0) {

1599 ià(
c
->
Çme
è
	`ä“Objeù
(c->name);

1600 
c
->
Çme
 = 
NULL
;

1601 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1608 
j
 = 0; j < 
Ën
; j++) {

1609 ià(
p
[
j
] < '!' ||…[j] > '~') {

1610 
	`addR•lyE¼Ü
(
c
,

1616 ià(
c
->
Çme
è
	`ä“Objeù
(c->name);

1617 
c
->
Çme
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(c->
¬gv
[2]);

1618 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1620 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘Çme"è&& c->
¬gc
 == 2) {

1621 ià(
c
->
Çme
)

1622 
	`addR•lyBulk
(
c
,c->
Çme
);

1624 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1627 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL ip:port | SETNAME connection-name)");

1631 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶y"è&& c->
¬gc
 == 3) {

1633 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"on")) {

1634 
c
->
æags
 &ğ~(
CLIENT_REPLY_SKIP
|
CLIENT_REPLY_OFF
);

1635 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1636 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"off")) {

1637 
c
->
æags
 |ğ
CLIENT_REPLY_OFF
;

1638 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"skip")) {

1639 ià(!(
c
->
æags
 & 
CLIENT_REPLY_OFF
))

1640 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP_NEXT
;

1642 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1645 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"·u£"è&& c->
¬gc
 == 3) {

1646 
du¿tiÚ
;

1648 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
du¿tiÚ
,
UNIT_MILLISECONDS
)

1649 !ğ
VR_OK
) ;

1650 
	`·u£Cl›Ás
(
NULL
, 
du¿tiÚ
);

1651 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1653 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL ip:port | GETNAME | SETNAME connection-name)");

1655 
	}
}

1659 
	$»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...) {

1660 
va_li¡
 
­
;

1661 
j
;

1662 
robj
 **
¬gv
;

1664 
¬gv
 = 
	`d®loc
((
robj
*)*
¬gc
);

1665 
	`va_¡¬t
(
­
,
¬gc
);

1666 
j
 = 0; j < 
¬gc
; j++) {

1667 
robj
 *
a
;

1668 
a
 = 
	`va_¬g
(
­
, 
robj
*);

1669 
¬gv
[
j
] = 
a
;

1672 
j
 = 0; j < 
c
->
¬gc
; j++è
	`ä“Objeù
(c->
¬gv
[j]);

1673 
	`dä“
(
c
->
¬gv
);

1675 
c
->
¬gv
 =‡rgv;

1676 
c
->
¬gc
 =‡rgc;

1677 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1678 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1679 
	`va_’d
(
­
);

1680 
	}
}

1683 
	$»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
) {

1684 
	`ä“Cl›ÁArgv
(
c
);

1685 
	`dä“
(
c
->
¬gv
);

1686 
c
->
¬gv
 =‡rgv;

1687 
c
->
¬gc
 =‡rgc;

1688 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1689 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1690 
	}
}

1703 
	$»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
) {

1704 
robj
 *
Şdv®
;

1706 ià(
i
 >ğ
c
->
¬gc
) {

1707 
c
->
¬gv
 = 
	`d»®loc
(c->¬gv,(
robj
*)*(
i
+1));

1708 
c
->
¬gc
 = 
i
+1;

1709 
c
->
¬gv
[
i
] = 
NULL
;

1711 
Şdv®
 = 
c
->
¬gv
[
i
];

1712 
c
->
¬gv
[
i
] = 
Ãwv®
;

1713 ià(
Şdv®
è
	`ä“Objeù
(oldval);

1716 ià(
i
 == 0) {

1717 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1718 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1720 
	}
}

1735 
	$g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
) {

1736 
li¡_™em_size
 = (
dli¡Node
)+(
robj
);

1738  
c
->
»¶y_by‹s
 + (
li¡_™em_size
*
	`dli¡L’gth
(c->
»¶y
));

1739 
	}
}

1750 
	$g‘Cl›ÁTy³
(
ş›Á
 *
c
) {

1751 ià(
c
->
æags
 & 
CLIENT_MASTER
è 
CLIENT_TYPE_MASTER
;

1752 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
))

1753  
CLIENT_TYPE_SLAVE
;

1754 ià(
c
->
æags
 & 
CLIENT_PUBSUB
è 
CLIENT_TYPE_PUBSUB
;

1755  
CLIENT_TYPE_NORMAL
;

1756 
	}
}

1758 
	$g‘Cl›ÁTy³ByName
(*
Çme
) {

1759 ià(!
	`¡rÿ£cmp
(
Çme
,"nÜm®")è 
CLIENT_TYPE_NORMAL
;

1760 ià(!
	`¡rÿ£cmp
(
Çme
,"¦ave")è 
CLIENT_TYPE_SLAVE
;

1761 ià(!
	`¡rÿ£cmp
(
Çme
,"pubsub")è 
CLIENT_TYPE_PUBSUB
;

1762 ià(!
	`¡rÿ£cmp
(
Çme
,"ma¡”")è 
CLIENT_TYPE_MASTER
;

1764 
	}
}

1766 *
	$g‘Cl›ÁTy³Name
(
şass
) {

1767 
şass
) {

1768 
CLIENT_TYPE_NORMAL
:  "normal";

1769 
CLIENT_TYPE_SLAVE
:  "slave";

1770 
CLIENT_TYPE_PUBSUB
:  "pubsub";

1771 
CLIENT_TYPE_MASTER
:  "master";

1772 :  
NULL
;

1774 
	}
}

1782 
	$checkCl›ÁOuutBufãrLim™s
(
ş›Á
 *
c
) {

1783 
soá
 = 0, 
h¬d
 = 0, 
şass
;

1784 
u£d_mem
 = 
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

1786 
şass
 = 
	`g‘Cl›ÁTy³
(
c
);

1789 ià(
şass
 =ğ
CLIENT_TYPE_MASTER
èşas ğ
CLIENT_TYPE_NORMAL
;

1791 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 &&

1792 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
)

1793 
h¬d
 = 1;

1794 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 &&

1795 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
)

1796 
soá
 = 1;

1800 ià(
soá
) {

1801 ià(
c
->
obuf_soá_lim™_»ached_time
 == 0) {

1802 
c
->
obuf_soá_lim™_»ached_time
 = c->
v–
->
unixtime
;

1803 
soá
 = 0;

1805 
time_t
 
–­£d
 = 
c
->
v–
->
unixtime
 - c->
obuf_soá_lim™_»ached_time
;

1807 ià(
–­£d
 <=

1808 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
) {

1809 
soá
 = 0;

1815 
c
->
obuf_soá_lim™_»ached_time
 = 0;

1817  
soá
 || 
h¬d
;

1818 
	}
}

1827 
	$asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
) {

1828 
	`ASSERT
(
c
->
»¶y_by‹s
 < 
SIZE_MAX
-(1024*64));

1829 ià(
c
->
»¶y_by‹s
 =ğ0 || c->
æags
 & 
CLIENT_CLOSE_ASAP
) ;

1830 ià(
	`checkCl›ÁOuutBufãrLim™s
(
c
)) {

1831 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1833 
	`ä“Cl›ÁAsync
(
c
);

1834 
	`log_w¬n
("Cl›Á % scheduËdØbşo£d ASAP fÜ ov”comšg oàouuˆbufã¸lim™s.", 
ş›Á
);

1835 
	`sdsä“
(
ş›Á
);

1837 
	}
}

1843 
	$æushSÏvesOuutBufãrs
() {

1844 
dli¡I‹r
 
li
;

1845 
dli¡Node
 *
Ê
;

1847 
	`dli¡Rewšd
(
»¶
.
¦aves
,&
li
);

1848 (
Ê
 = 
	`dli¡Next
(&
li
))) {

1849 
ş›Á
 *
¦ave
 = 
	`dli¡NodeV®ue
(
Ê
);

1850 
ev’ts
;

1858 
ev’ts
 = 
	`«G‘FeEv’ts
(
»¶
.
v–
.
–
,
¦ave
->
cÚn
->
sd
);

1859 ià(
ev’ts
 & 
AE_WRITABLE
 &&

1860 
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

1861 
	`ş›ÁHasP’dšgR•l›s
(
¦ave
))

1863 
	`wr™eToCl›Á
(
¦ave
->
cÚn
->
sd
,slave,0);

1866 
	}
}

1885 
	$·u£Cl›Ás
(
vr_ev’oİ
 *
v–
, 
’d
) {

1886 ià(
v–
 =ğ
NULL
) ;

1888 ià(!
v–
->
ş›Ás_·u£d
 || 
’d
 > v–->
ş›Ás_·u£_’d_time
)

1889 
v–
->
ş›Ás_·u£_’d_time
 = 
’d
;

1890 
v–
->
ş›Ás_·u£d
 = 1;

1891 
	}
}

1895 
	$ş›ÁsA»Pau£d
(
vr_ev’oİ
 *
v–
) {

1896 ià(
v–
->
ş›Ás_·u£d
 &&

1897 
v–
->
ş›Ás_·u£_’d_time
 < v–->
m¡ime
)

1899 
dli¡Node
 *
Ê
;

1900 
dli¡I‹r
 
li
;

1901 
ş›Á
 *
c
;

1903 
v–
->
ş›Ás_·u£d
 = 0;

1907 
	`dli¡Rewšd
(
v–
->
ş›Ás
,&
li
);

1908 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1909 
c
 = 
	`dli¡NodeV®ue
(
Ê
);

1913 ià(
c
->
æags
 & (
CLIENT_SLAVE
|
CLIENT_BLOCKED
)) ;

1914 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

1915 
	`dli¡AddNodeTa
(
v–
->
unblocked_ş›Ás
,
c
);

1918  
v–
->
ş›Ás_·u£d
;

1919 
	}
}

1933 
	$´oûssEv’tsWheBlocked
(
vr_ev’oİ
 *
v–
) {

1934 
™”©iÚs
 = 4;

1935 
couÁ
 = 0;

1936 
™”©iÚs
--) {

1937 
ev’ts
 = 0;

1938 
ev’ts
 +ğ
	`«ProûssEv’ts
(
v–
->
–
, 
AE_FILE_EVENTS
|
AE_DONT_WAIT
);

1939 
ev’ts
 +ğ
	`hªdËCl›ÁsW™hP’dšgWr™es
(
v–
);

1940 ià(!
ev’ts
) ;

1941 
couÁ
 +ğ
ev’ts
;

1943  
couÁ
;

1944 
	}
}

1947 
	$cu¼’t_ş›Ás
()

1949 
ccs
;

1951 #ià
	`defšed
(
__ATOMIC_RELAXED
è|| defšed(
HAVE_ATOMIC
)

1952 
ccs
 = 
	`upd©e_cu¼_ş›Ás_add
(0);

1954 
	`±h»ad_mu‹x_lock
(&
cu¼_ş›Ás_mu‹x
);

1955 
ccs
 = 
ncu¼_ccÚn
;

1956 
	`±h»ad_mu‹x_uÆock
(&
cu¼_ş›Ás_mu‹x
);

1959  
ccs
;

1960 
	}
}

	@src/vr_client.h

1 #iâdeà
_VR_CLIENT_H_


2 
	#_VR_CLIENT_H_


	)

4 
	#NET_MAX_WRITES_PER_EVENT
 (1024*64)

	)

6 
	#PROTO_MAX_QUERYBUF_LEN
 (1024*1024*1024è

	)

7 
	#PROTO_IOBUF_LEN
 (1024*16è

	)

8 
	#PROTO_REPLY_CHUNK_BYTES
 (16*1024è

	)

9 
	#PROTO_INLINE_MAX_SIZE
 (1024*64è

	)

10 
	#PROTO_MBULK_BIG_ARG
 (1024*32)

	)

13 
	#CLIENT_SLAVE
 (1<<0è

	)

14 
	#CLIENT_MASTER
 (1<<1è

	)

15 
	#CLIENT_MONITOR
 (1<<2è

	)

16 
	#CLIENT_MULTI
 (1<<3è

	)

17 
	#CLIENT_BLOCKED
 (1<<4è

	)

18 
	#CLIENT_DIRTY_CAS
 (1<<5è

	)

19 
	#CLIENT_CLOSE_AFTER_REPLY
 (1<<6è

	)

20 
	#CLIENT_UNBLOCKED
 (1<<7è

	)

22 
	#CLIENT_LUA
 (1<<8è

	)

23 
	#CLIENT_ASKING
 (1<<9è

	)

24 
	#CLIENT_CLOSE_ASAP
 (1<<10)

	)

25 
	#CLIENT_UNIX_SOCKET
 (1<<11è

	)

26 
	#CLIENT_DIRTY_EXEC
 (1<<12è

	)

27 
	#CLIENT_MASTER_FORCE_REPLY
 (1<<13è

	)

28 
	#CLIENT_FORCE_AOF
 (1<<14è

	)

29 
	#CLIENT_FORCE_REPL
 (1<<15è

	)

30 
	#CLIENT_PRE_PSYNC
 (1<<16è

	)

31 
	#CLIENT_READONLY
 (1<<17è

	)

32 
	#CLIENT_PUBSUB
 (1<<18è

	)

33 
	#CLIENT_PREVENT_AOF_PROP
 (1<<19è

	)

34 
	#CLIENT_PREVENT_REPL_PROP
 (1<<20è

	)

35 
	#CLIENT_PREVENT_PROP
 (
CLIENT_PREVENT_AOF_PROP
|
CLIENT_PREVENT_REPL_PROP
)

	)

36 
	#CLIENT_PENDING_WRITE
 (1<<21è

	)

38 
	#CLIENT_REPLY_OFF
 (1<<22è

	)

39 
	#CLIENT_REPLY_SKIP_NEXT
 (1<<23è

	)

40 
	#CLIENT_REPLY_SKIP
 (1<<24è

	)

41 
	#CLIENT_LUA_DEBUG
 (1<<25è

	)

42 
	#CLIENT_LUA_DEBUG_SYNC
 (1<<26è

	)

43 
	#CLIENT_JUMP
 (1<<27)

	)

45 
	#REDIS_REPLY_CHUNK_BYTES
 (16*1024è

	)

48 
	#PROTO_REQ_INLINE
 1

	)

49 
	#PROTO_REQ_MULTIBULK
 2

	)

53 
	#CLIENT_TYPE_NORMAL
 0

	)

54 
	#CLIENT_TYPE_SLAVE
 1

	)

55 
	#CLIENT_TYPE_PUBSUB
 2

	)

56 
	#CLIENT_TYPE_MASTER
 3

	)

57 
	#CLIENT_TYPE_OBUF_COUNT
 3

	)

63 
	#BLOCKED_NONE
 0

	)

64 
	#BLOCKED_LIST
 1

	)

65 
	#BLOCKED_WAIT
 2

	)

69 
	sş›Á
 {

70 
ušt64_t
 
	mid
;

72 
cÚn
 *
	mcÚn
;

73 
vr_ev’oİ
 *
	mv–
;

75 
»disDb
 *
	mdb
;

76 
	mdiùid
;

77 
	msÿnid
;

78 
robj
 *
	mÇme
;

79 
sds
 
	mqu”ybuf
;

80 
size_t
 
	mqu”ybuf_³ak
;

81 
	m¬gc
;

82 
robj
 **
	m¬gv
;

83 
»disCommªd
 *
	mcmd
, *
	mÏ¡cmd
;

84 
	m»qty³
;

85 
	mmuÉibulkËn
;

86 
	mbulkËn
;

87 
dli¡
 *
	m»¶y
;

88 
	m»¶y_by‹s
;

89 
size_t
 
	m£ÁËn
;

91 
time_t
 
	mùime
;

92 
time_t
 
	mÏ¡š‹¿ùiÚ
;

93 
time_t
 
	mobuf_soá_lim™_»ached_time
;

94 
	mæags
;

95 
	mauth’tiÿ‹d
;

96 
	m»¶¡©e
;

97 
	m»¶_put_Úlše_Ú_ack
;

98 
	m»¶dbfd
;

99 
off_t
 
	m»¶dboff
;

100 
off_t
 
	m»¶dbsize
;

101 
sds
 
	m»¶´—mbË
;

102 
	m»¶off
;

103 
	m»¶_ack_off
;

104 
	m»¶_ack_time
;

105 
	mpsync_š™Ÿl_off£t
;

108 
	m»¶runid
[
CONFIG_RUN_ID_SIZE
+1];

109 
	m¦ave_li¡’šg_pÜt
;

110 
	m¦ave_ÿ·
;

111 
muÉiS‹
 
	mm¡©e
;

112 
	mbty³
;

113 
blockšgS‹
 
	mbpİ
;

114 
	mwoff
;

115 
dli¡
 *
	mw©ched_keys
;

116 
diù
 *
	mpubsub_chªÃls
;

117 
dli¡
 *
	mpubsub_·‰”ns
;

118 
sds
 
	m³”id
;

120 
	mcuridx
;

121 
	mridx
;

122 
	m¡•s
;

123 *
	mÿche
;

126 
	mbuåos
;

127 
	mbuf
[
PROTO_REPLY_CHUNK_BYTES
];

128 } 
	tş›Á
;

130 
	sş›ÁBufãrLim™sCÚfig
 {

131 
	mh¬d_lim™_by‹s
;

132 
	msoá_lim™_by‹s
;

133 
time_t
 
	msoá_lim™_£cÚds
;

134 } 
	tş›ÁBufãrLim™sCÚfig
;

137 
ş›Á
 *
ü—‹Cl›Á
(
vr_ev’oİ
 *
v–
, 
cÚn
 *conn);

138 
şo£TimedoutCl›Ás
();

139 
ä“Cl›Á
(
ş›Á
 *
c
);

140 
ä“Cl›ÁAsync
(
ş›Á
 *
c
);

141 
»£tCl›Á
(
ş›Á
 *
c
);

142 
£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

143 *
addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
);

144 
£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
);

145 
´oûssIÅutBufãr
(
ş›Á
 *
c
);

146 
»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

147 
addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
);

148 
addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
);

149 
addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
);

150 
addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

151 
addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
);

152 
addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
);

153 
addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

154 
addR•lyE¼ÜL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

155 
addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
);

156 
addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
);

157 
addR•lyStusL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

158 
addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
);

159 
addR•lyDoubË
(
ş›Á
 *
c
, 
d
);

160 
addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
);

161 
addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

162 
addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
);

163 
cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
);

164 *
dupCl›ÁR•lyV®ue
(*
o
);

165 
ä“Cl›ÁR•lyV®ue
(*
o
);

166 
g‘Cl›ÁsMaxBufãrs
(
vr_ev’oİ
 *
v–
, *
lÚge¡_ouut_li¡
,

167 *
bigge¡_šput_bufãr
);

168 *
g‘Cl›ÁP“rId
(
ş›Á
 *client);

169 
sds
 
ÿtCl›ÁInfoSŒšg
(sd 
s
, 
ş›Á
 *client);

170 
sds
 
g‘AÎCl›ÁsInfoSŒšg
(
vr_ev’oİ
 *
v–
);

171 
ş›ÁCommªd
(
ş›Á
 *
c
);

172 
»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...);

173 
»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
);

174 
»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
);

175 
g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
);

176 
ä“Cl›ÁsInAsyncF»eQueue
(
vr_ev’oİ
 *
v–
);

177 
asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
);

178 
g‘Cl›ÁTy³
(
ş›Á
 *
c
);

179 
g‘Cl›ÁTy³ByName
(*
Çme
);

180 *
g‘Cl›ÁTy³Name
(
şass
);

181 
æushSÏvesOuutBufãrs
();

182 
discÚÃùSÏves
();

183 
li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
);

184 
·u£Cl›Ás
(
vr_ev’oİ
 *
v–
, 
du¿tiÚ
);

185 
ş›ÁsA»Pau£d
(
vr_ev’oİ
 *
v–
);

186 
´oûssEv’tsWheBlocked
(
vr_ev’oİ
 *
v–
);

187 
hªdËCl›ÁsW™hP’dšgWr™es
(
vr_ev’oİ
 *
v–
);

188 
ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
);

189 
uÆškCl›ÁFromEv’oİ
(
ş›Á
 *
c
);

190 
lškCl›ÁToEv’oİ
(
ş›Á
 *
c
,
vr_ev’oİ
 *
v–
);

191 
uÆškCl›Á
(
ş›Á
 *
c
);

192 
wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
);

194 #ifdeà
__GNUC__


195 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

196 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

197 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

198 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

200 
	`addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

201 
	`addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

204 
ncu¼_ccÚn
;

206 #ià
	`defšed
(
__ATOMIC_RELAXED
)

207 
	#upd©e_cu¼_ş›Ás_add
(
__n
è
	`__©omic_add_ãtch
(&
ncu¼_ccÚn
, (__n), 
__ATOMIC_RELAXED
)

	)

208 
	#upd©e_cu¼_ş›Ás_sub
(
__n
è
	`__©omic_sub_ãtch
(&
ncu¼_ccÚn
, (__n), 
__ATOMIC_RELAXED
)

	)

209 #–ià
	`defšed
(
HAVE_ATOMIC
)

210 
	#upd©e_cu¼_ş›Ás_add
(
__n
è
	`__sync_add_ªd_ãtch
(&
ncu¼_ccÚn
, (__n))

	)

211 
	#upd©e_cu¼_ş›Ás_sub
(
__n
è
	`__sync_sub_ªd_ãtch
(&
ncu¼_ccÚn
, (__n))

	)

213 
±h»ad_mu‹x_t
 
cu¼_ş›Ás_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

215 
	#upd©e_cu¼_ş›Ás_add
(
__n
) do { \

216 
	`±h»ad_mu‹x_lock
(&
cu¼_ş›Ás_mu‹x
); \

217 
ncu¼_ccÚn
 +ğ(
__n
); \

218 
	`±h»ad_mu‹x_uÆock
(&
cu¼_ş›Ás_mu‹x
); \

219 
	}
} 0)

	)

221 
	#upd©e_cu¼_ş›Ás_sub
(
__n
) do { \

222 
	`±h»ad_mu‹x_lock
(&
cu¼_ş›Ás_mu‹x
); \

223 
ncu¼_ccÚn
 -ğ(
__n
); \

224 
	`±h»ad_mu‹x_uÆock
(&
cu¼_ş›Ás_mu‹x
); \

225 } 0)

	)

228 
cu¼’t_ş›Ás
();

	@src/vr_command.c

1 
	~<vr_cÜe.h
>

4 
diùTy³
 
	gcommªdTabËDiùTy³
 = {

5 
diùSdsCa£Hash
,

6 
NULL
,

7 
NULL
,

8 
diùSdsKeyCa£Com·»
,

9 
diùSdsDe¡ruùÜ
,

10 
NULL


65 
»disCommªd
 
	g»disCommªdTabË
[] = {

67 {"pšg",
pšgCommªd
,-1,"tF",0,
NULL
,0,0,0,0,0},

68 {"echo",
echoCommªd
,2,"F",0,
NULL
,0,0,0,0,0},

69 {"£Ëù",
£ËùCommªd
,2,"lF",0,
NULL
,0,0,0,0,0},

70 {"auth",
authCommªd
,2,"¦tF",0,
NULL
,0,0,0,0,0},

71 {"admš",
admšCommªd
,2,"¦tF",0,
NULL
,0,0,0,0,0},

73 {"šfo",
šfoCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

74 {"æushdb",
æushdbCommªd
,1,"w",0,
NULL
,0,0,0,0,0},

75 {"æush®l",
æush®lCommªd
,1,"w",0,
NULL
,0,0,0,0,0},

76 {"time",
timeCommªd
,1,"RF",0,
NULL
,0,0,0,0,0},

77 {"dbsize",
dbsizeCommªd
,1,"rF",0,
NULL
,0,0,0,0,0},

78 {"commªd",
commªdCommªd
,0,"É",0,
NULL
,0,0,0,0,0},

79 {"cÚfig",
cÚfigCommªd
,-2,"Ït",0,
NULL
,0,0,0,0,0},

80 {"ş›Á",
ş›ÁCommªd
,-2,"as",0,
NULL
,0,0,0,0,0},

81 {"¦owlog",
¦owlogCommªd
,-2,"a",0,
NULL
,0,0,0,0,0},

83 {"d–",
d–Commªd
,-2,"w",0,
NULL
,1,-1,1,0,0},

84 {"exi¡s",
exi¡sCommªd
,-2,"rF",0,
NULL
,1,-1,1,0,0},

85 {"‰l",
‰lCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

86 {"±",
±Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

87 {"expœe",
expœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

88 {"expœ—t",
expœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

89 {"³xpœe",
³xpœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

90 {"³xpœ—t",
³xpœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

91 {"³rsi¡",
³rsi¡Commªd
,2,"wF",0,
NULL
,1,1,1,0,0},

92 {"¿ndomkey",
¿ndomkeyCommªd
,1,"rR",0,
NULL
,0,0,0,0,0},

93 {"ty³",
ty³Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

94 {"keys",
keysCommªd
,2,"rS",0,
NULL
,0,0,0,0,0},

95 {"sÿn",
sÿnCommªd
,-2,"rR",0,
NULL
,0,0,0,0,0},

96 {"objeù",
objeùCommªd
,3,"r",0,
NULL
,2,2,2,0,0},

98 {"g‘",
g‘Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

99 {"£t",
£tCommªd
,-3,"wm",0,
NULL
,1,1,1,0,0},

100 {"£Šx",
£ŠxCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

101 {"£‹x",
£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

102 {"p£‹x",
p£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

103 {"šü",
šüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

104 {"deü",
deüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

105 {"šüby",
šübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

106 {"deüby",
deübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

107 {"­³nd",
­³ndCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

108 {"¡¾’",
¡¾’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

109 {"g‘£t",
g‘£tCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

110 {"šübyæßt",
šübyæßtCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

111 {"£tb™",
£tb™Commªd
,4,"wm",0,
NULL
,1,1,1,0,0},

112 {"g‘b™",
g‘b™Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

113 {"£Œªge",
£ŒªgeCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

114 {"g‘¿nge",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

115 {"b™couÁ",
b™couÁCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

116 {"b™pos",
b™posCommªd
,-3,"r",0,
NULL
,1,1,1,0,0},

117 {"mg‘",
mg‘Commªd
,-2,"r",0,
NULL
,1,-1,1,0,0},

118 {"m£t",
m£tCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

120 {"h£t",
h£tCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

121 {"hg‘",
hg‘Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

122 {"hËn",
hËnCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

123 {"hd–",
hd–Commªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

124 {"hexi¡s",
hexi¡sCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

125 {"hkeys",
hkeysCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

126 {"hv®s",
hv®sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

127 {"hg‘®l",
hg‘®lCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

128 {"hšüby",
hšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

129 {"hšübyæßt",
hšübyæßtCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

130 {"hmg‘",
hmg‘Commªd
,-3,"r",0,
NULL
,1,1,1,0,0},

131 {"hm£t",
hm£tCommªd
,-4,"wm",0,
NULL
,1,1,1,0,0},

132 {"h£Šx",
h£ŠxCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

133 {"h¡¾’",
h¡¾’Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

134 {"hsÿn",
hsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

136 {"½ush",
½ushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

137 {"Íush",
ÍushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

138 {"Ìªge",
ÌªgeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

139 {"½İ",
½İCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

140 {"Íİ",
ÍİCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

141 {"Î’",
Î’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

142 {"Ìem",
ÌemCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

143 {"Érim",
ÉrimCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

144 {"lšdex",
lšdexCommªd
,3,"r",0,
NULL
,1,1,1,0,0},

145 {"l£t",
l£tCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

147 {"§dd",
§ddCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

148 {"smemb”s",
smemb”sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

149 {"sÿrd",
sÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

150 {"¤em",
¤emCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

151 {"¥İ",
¥İCommªd
,-2,"wRsF",0,
NULL
,1,1,1,0,0},

152 {"sismemb”",
sismemb”Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

153 {"ssÿn",
ssÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

154 {"suniÚ",
suniÚCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

155 {"suniÚ¡Üe",
suniÚ¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

156 {"sdiff",
sdiffCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

157 {"sdiff¡Üe",
sdiff¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

158 {"sš‹r",
sš‹rCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

159 {"sš‹r¡Üe",
sš‹r¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

161 {"zadd",
zaddCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

162 {"zšüby",
zšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

163 {"z¿nge",
z¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

164 {"z»v¿nge",
z»v¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

165 {"z»m",
z»mCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

166 {"zÿrd",
zÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

167 {"zcouÁ",
zcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

168 {"z¿ngebyscÜe",
z¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

169 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

170 {"z¿nk",
z¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

171 {"z»v¿nk",
z»v¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

172 {"zscÜe",
zscÜeCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

173 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜeCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

174 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nkCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

175 {"z»m¿ngebyËx",
z»m¿ngebyËxCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

176 {"zsÿn",
zsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

178 {"pçdd",
pçddCommªd
,-2,"wmF",0,
NULL
,1,1,1,0,0},

179 {"pfcouÁ",
pfcouÁCommªd
,-2,"r",0,
NULL
,1,-1,1,0,0}

184 
	$pİuÏ‹CommªdTabË
() {

185 
j
;

186 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

188 
j
 = 0; j < 
numcommªds
; j++) {

189 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

190 *
f
 = 
c
->
sæags
;

191 
»tv®1
;

193 *
f
 != '\0') {

194 *
f
) {

195 'w': 
c
->
æags
 |ğ
CMD_WRITE
; ;

196 'r': 
c
->
æags
 |ğ
CMD_READONLY
; ;

197 'm': 
c
->
æags
 |ğ
CMD_DENYOOM
; ;

198 'a': 
c
->
æags
 |ğ
CMD_ADMIN
; ;

199 'p': 
c
->
æags
 |ğ
CMD_PUBSUB
; ;

200 's': 
c
->
æags
 |ğ
CMD_NOSCRIPT
; ;

201 'R': 
c
->
æags
 |ğ
CMD_RANDOM
; ;

202 'S': 
c
->
æags
 |ğ
CMD_SORT_FOR_SCRIPT
; ;

203 'l': 
c
->
æags
 |ğ
CMD_LOADING
; ;

204 't': 
c
->
æags
 |ğ
CMD_STALE
; ;

205 'M': 
c
->
æags
 |ğ
CMD_SKIP_MONITOR
; ;

206 'k': 
c
->
æags
 |ğ
CMD_ASKING
; ;

207 'F': 
c
->
æags
 |ğ
CMD_FAST
; ;

208 : 
	`£rv”Pªic
("Unsupported command flag"); ;

210 
f
++;

213 
»tv®1
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

214 
	`ASSERT
(
»tv®1
 =ğ
DICT_OK
);

216 
c
->
idx
 = 
j
;

218 
	}
}

220 
	$pİuÏ‹CommªdsN“dAdmš·ss
() {

221 
d¬¿y
 
commªds_Ãed_admš·ss
;

222 
sds
 *
commªd_Çme
;

223 
»disCommªd
 *
commªd
;

225 
	`d¬¿y_š™
(&
commªds_Ãed_admš·ss
,1,(
sds
));

226 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_COMMANDSNAP
,&
commªds_Ãed_admš·ss
);

227 
	`d¬¿y_n
(&
commªds_Ãed_admš·ss
)) {

228 
commªd_Çme
 = 
	`d¬¿y_pİ
(&
commªds_Ãed_admš·ss
);

229 
commªd
 = 
	`lookupCommªd
(*
commªd_Çme
);

230 ià(
commªd
 =ğ
NULL
) {

231 
	`log_”rÜ
("Unknow command %s for commands-need-amdminpass",

232 
commªd_Çme
);

233  
VR_ERROR
;

235 
commªd
->
Ãedadmš
 = 1;

236 
	`sdsä“
(*
commªd_Çme
);

238 
	`d¬¿y_deš™
(&
commªds_Ãed_admš·ss
);

240  
VR_OK
;

241 
	}
}

243 
»disCommªd
 *
	$lookupCommªd
(
sds
 
Çme
) {

244  
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

245 
	}
}

254 
»disCommªd
 *
	$lookupCommªdOrOrigš®
(
sds
 
Çme
) {

255 
»disCommªd
 *
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

257 ià(!
cmd
ècmd = 
	`diùF‘chV®ue
(
£rv”
.
Üig_commªds
,
Çme
);

258  
cmd
;

259 
	}
}

261 
»disCommªd
 *
	$lookupCommªdByCSŒšg
(*
s
) {

262 
»disCommªd
 *
cmd
;

263 
sds
 
Çme
 = 
	`sd¢ew
(
s
);

265 
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

266 
	`sdsä“
(
Çme
);

267  
cmd
;

268 
	}
}

308 
	$ÿÎ
(
ş›Á
 *
c
, 
æags
) {

309 
dœty
, 
¡¬t
, 
du¿tiÚ
;

310 
ş›Á_Şd_æags
 = 
c
->
æags
;

314 ià(
	`dli¡L’gth
(
£rv”
.
mÚ™Üs
) &&

315 !
£rv”
.
lßdšg
 &&

316 !(
c
->
cmd
->
æags
 & (
CMD_SKIP_MONITOR
|
CMD_ADMIN
)))

318 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

323 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

324 
	`»disOpA¼ayIn™
(&
£rv”
.
®so_´İag©e
);

327 
dœty
 = 
c
->
v–
->dirty;

328 
¡¬t
 = 
	`vr_u£c_now
();

329 
c
->
cmd
->
	`´oc
(c);

330 
du¿tiÚ
 = 
	`vr_u£c_now
()-
¡¬t
;

331 
dœty
 = 
c
->
v–
->dirty-dirty;

332 ià(
dœty
 < 0) dirty = 0;

336 ià(
£rv”
.
lßdšg
 && 
c
->
æags
 & 
CLIENT_LUA
)

337 
æags
 &ğ~(
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
);

342 ià(
c
->
æags
 & 
CLIENT_LUA
 && 
£rv”
.
lua_ÿÎ”
) {

343 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
)

344 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_REPL
;

345 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
)

346 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_AOF
;

351 ià(
æags
 & 
CMD_CALL_SLOWLOG
 && 
c
->
cmd
->
´oc
 !ğ
execCommªd
) {

355 
	`¦owlogPushEÁryIfN“ded
(
c
->
v–
,c->
¬gv
,c->
¬gc
,
du¿tiÚ
);

357 ià(
æags
 & 
CMD_CALL_STATS
) {

358 
commªdSts
 *
c¡©s
 = 
	`d¬¿y_g‘
(
c
->
v–
->
c¡abË
,c->
Ï¡cmd
->
idx
);

359 
c¡©s
->
miüo£cÚds
 +ğ
du¿tiÚ
;

360 
c¡©s
->
ÿÎs
++;

364 ià(
æags
 & 
CMD_CALL_PROPAGATE
 &&

365 (
c
->
æags
 & 
CLIENT_PREVENT_PROP
) != CLIENT_PREVENT_PROP)

367 
´İag©e_æags
 = 
PROPAGATE_NONE
;

371 ià(
dœty
è
´İag©e_æags
 |ğ(
PROPAGATE_AOF
|
PROPAGATE_REPL
);

375 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
è
´İag©e_æags
 |ğ
PROPAGATE_REPL
;

376 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
è
´İag©e_æags
 |ğ
PROPAGATE_AOF
;

381 ià(
c
->
æags
 & 
CLIENT_PREVENT_REPL_PROP
 ||

382 !(
æags
 & 
CMD_CALL_PROPAGATE_REPL
))

383 
´İag©e_æags
 &ğ~
PROPAGATE_REPL
;

384 ià(
c
->
æags
 & 
CLIENT_PREVENT_AOF_PROP
 ||

385 !(
æags
 & 
CMD_CALL_PROPAGATE_AOF
))

386 
´İag©e_æags
 &ğ~
PROPAGATE_AOF
;

390 ià(
´İag©e_æags
 !ğ
PROPAGATE_NONE
)

391 
	`´İag©e
(
c
->
cmd
,c->
db
->
id
,c->
¬gv
,c->
¬gc
,
´İag©e_æags
);

396 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

397 
c
->
æags
 |ğ
ş›Á_Şd_æags
 &

398 (
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

403 ià(
£rv”
.
®so_´İag©e
.
numİs
) {

404 
j
;

405 
»disOp
 *
rİ
;

407 ià(
æags
 & 
CMD_CALL_PROPAGATE
) {

408 
j
 = 0; j < 
£rv”
.
®so_´İag©e
.
numİs
; j++) {

409 
rİ
 = &
£rv”
.
®so_´İag©e
.
İs
[
j
];

410 
rg‘
 = 
rİ
->target;

412 ià(!(
æags
&
CMD_CALL_PROPAGATE_AOF
)è
rg‘
 &ğ~
PROPAGATE_AOF
;

413 ià(!(
æags
&
CMD_CALL_PROPAGATE_REPL
)è
rg‘
 &ğ~
PROPAGATE_REPL
;

414 ià(
rg‘
)

415 
	`´İag©e
(
rİ
->
cmd
,rİ->
dbid
,rİ->
¬gv
,rİ->
¬gc
,
rg‘
);

418 
	`»disOpA¼ayF»e
(&
£rv”
.
®so_´İag©e
);

420 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
numcommªds
, 1);

421 
	}
}

431 
	$´oûssCommªd
(
ş›Á
 *
c
) {

432 
maxmemÜy
;

438 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"quit")) {

439 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

440 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

441  
VR_ERROR
;

446 
c
->
cmd
 = c->
Ï¡cmd
 = 
	`lookupCommªd
(c->
¬gv
[0]->
±r
);

447 ià(!
c
->
cmd
) {

448 
	`æagT¿n§ùiÚ
(
c
);

449 
	`addR•lyE¼ÜFÜm©
(
c
,"unknown command '%s'",

450 (*)
c
->
¬gv
[0]->
±r
);

451  
VR_OK
;

452 } ià((
c
->
cmd
->
¬™y
 > 0 && c->cmd->¬™y !ğc->
¬gc
) ||

453 (
c
->
¬gc
 < -c->
cmd
->
¬™y
)) {

454 
	`æagT¿n§ùiÚ
(
c
);

455 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

456 
c
->
cmd
->
Çme
);

457  
VR_OK
;

461 ià(
c
->
v–
->
cc
.
»quœ•ass
 && !c->
auth’tiÿ‹d
 &&

462 
c
->
cmd
->
´oc
 !ğ
authCommªd
 && c->cmd->´oø!ğ
admšCommªd
)

464 
	`æagT¿n§ùiÚ
(
c
);

465 
	`addR•ly
(
c
,
sh¬ed
.
nßuth”r
);

466  
VR_OK
;

469 ià(
c
->
cmd
->
Ãedadmš
 && c->
v–
->
cc
.
admš·ss
 &&

470 
c
->
auth’tiÿ‹d
 < 2 && c->
cmd
->
´oc
 !ğ
admšCommªd
)

472 
	`æagT¿n§ùiÚ
(
c
);

473 
	`addR•ly
(
c
,
sh¬ed
.
nßdmš”r
);

474  
VR_OK
;

482 
maxmemÜy
 = 
c
->
v–
->
cc
.maxmemory;

483 ià(
maxmemÜy
) {

484 
»tv®
 = 
	`ä“MemÜyIfN“ded
(
c
->
v–
);

487 ià(
c
->
v–
->
cu¼’t_ş›Á
 =ğ
NULL
è 
VR_ERROR
;

491 ià((
c
->
cmd
->
æags
 & 
CMD_DENYOOM
è&& 
»tv®
 =ğ
VR_ERROR
) {

492 
	`æagT¿n§ùiÚ
(
c
);

493 
	`addR•ly
(
c
, 
sh¬ed
.
oom”r
);

494  
VR_OK
;

500 ià(((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

501 
£rv”
.
§v•¬am¦’
 > 0 &&

502 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
VR_ERROR
) ||

503 
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
VR_ERROR
) &&

504 
»¶
.
ma¡”ho¡
 =ğ
NULL
 &&

505 (
c
->
cmd
->
æags
 & 
CMD_WRITE
 ||

506 
c
->
cmd
->
´oc
 =ğ
pšgCommªd
))

508 
	`æagT¿n§ùiÚ
(
c
);

509 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
VR_OK
)

510 
	`addR•ly
(
c
, 
sh¬ed
.
bg§v“¼
);

512 
	`addR•lySds
(
c
,

513 
	`sdsÿrštf
(
	`sd£m±y
(),

515 
	`¡»¼Ü
(
£rv”
.
aof_Ï¡_wr™e_”ºo
)));

516  
VR_OK
;

521 ià(
»¶
.
ma¡”ho¡
 =ğ
NULL
 &&

522 
»¶
.
»¶_mš_¦aves_to_wr™e
 &&

523 
»¶
.
»¶_mš_¦aves_max_Ïg
 &&

524 
c
->
cmd
->
æags
 & 
CMD_WRITE
 &&

525 
»¶
.
»¶_good_¦aves_couÁ
 <„•l.
»¶_mš_¦aves_to_wr™e
)

527 
	`æagT¿n§ùiÚ
(
c
);

528 
	`addR•ly
(
c
, 
sh¬ed
.
nÜ•liÿ£¼
);

529  
VR_OK
;

534 ià(
»¶
.
ma¡”ho¡
 &&„•l.
»¶_¦ave_ro
 &&

535 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

536 
c
->
cmd
->
æags
 & 
CMD_WRITE
)

538 
	`addR•ly
(
c
, 
sh¬ed
.
ro¦av“¼
);

539  
VR_OK
;

543 ià(
c
->
æags
 & 
CLIENT_PUBSUB
 &&

544 
c
->
cmd
->
´oc
 !ğ
pšgCommªd
 &&

545 
c
->
cmd
->
´oc
 !ğ
subsüibeCommªd
 &&

546 
c
->
cmd
->
´oc
 !ğ
unsubsüibeCommªd
 &&

547 
c
->
cmd
->
´oc
 !ğ
psubsüibeCommªd
 &&

548 
c
->
cmd
->
´oc
 !ğ
punsubsüibeCommªd
) {

549 
	`addR•lyE¼Ü
(
c
,"only (P)SUBSCRIBE / (P)UNSUBSCRIBE / PING / QUIT‡llowed inhis context");

550  
VR_OK
;

555 ià(
»¶
.
ma¡”ho¡
 &&„•l.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
 &&

556 
»¶
.
»¶_£rve_¡®e_d©a
 == 0 &&

557 !(
c
->
cmd
->
æags
 & 
CMD_STALE
))

559 
	`æagT¿n§ùiÚ
(
c
);

560 
	`addR•ly
(
c
, 
sh¬ed
.
ma¡”dowÃ¼
);

561  
VR_OK
;

566 ià(
£rv”
.
lßdšg
 && !(
c
->
cmd
->
æags
 & 
CMD_LOADING
)) {

567 
	`addR•ly
(
c
, 
sh¬ed
.
lßdšg”r
);

568  
VR_OK
;

572 ià(
£rv”
.
lua_timedout
 &&

573 
c
->
cmd
->
´oc
 !ğ
authCommªd
 &&

574 
c
->
cmd
->
´oc
 !ğ
»¶cÚfCommªd
 &&

575 !(
c
->
cmd
->
´oc
 =ğ
shutdownCommªd
 &&

576 
c
->
¬gc
 == 2 &&

577 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'n') &&

578 !(
c
->
cmd
->
´oc
 =ğ
sütCommªd
 &&

579 
c
->
¬gc
 == 2 &&

580 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'k'))

582 
	`æagT¿n§ùiÚ
(
c
);

583 
	`addR•ly
(
c
, 
sh¬ed
.
¦owsü‹¼
);

584  
VR_OK
;

588 ià(
c
->
æags
 & 
CLIENT_MULTI
 &&

589 
c
->
cmd
->
´oc
 !ğ
execCommªd
 && c->cmd->´oø!ğ
disÿrdCommªd
 &&

590 
c
->
cmd
->
´oc
 !ğ
muÉiCommªd
 && c->cmd->´oø!ğ
w©chCommªd
)

592 
	`queueMuÉiCommªd
(
c
);

593 
	`addR•ly
(
c
,
sh¬ed
.
queued
);

595 
	`ÿÎ
(
c
,
CMD_CALL_FULL
);

596 
c
->
woff
 = 
»¶
.
ma¡”_»¶_off£t
;

597 ià(
	`dli¡L’gth
(
£rv”
.
»ady_keys
))

598 
	`hªdËCl›ÁsBlockedOnLi¡s
();

601  
VR_OK
;

602 
	}
}

606 
	$»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
) {

607 
ß
->
İs
 = 
NULL
;

608 
ß
->
numİs
 = 0;

609 
	}
}

611 
	$»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
,

612 
robj
 **
¬gv
, 
¬gc
, 
rg‘
)

614 
»disOp
 *
İ
;

616 
ß
->
İs
 = 
	`d»®loc
(ß->İs,(
»disOp
)*((
size_t
)ß->
numİs
+1));

617 
İ
 = 
ß
->
İs
+ß->
numİs
;

618 
İ
->
cmd
 = cmd;

619 
İ
->
dbid
 = dbid;

620 
İ
->
¬gv
 =‡rgv;

621 
İ
->
¬gc
 =‡rgc;

622 
İ
->
rg‘
 =arget;

623 
ß
->
numİs
++;

624  
ß
->
numİs
;

625 
	}
}

627 
	$»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
) {

628 
ß
->
numİs
) {

629 
j
;

630 
»disOp
 *
İ
;

632 
ß
->
numİs
--;

633 
İ
 = 
ß
->
İs
+ß->
numİs
;

634 
j
 = 0; j < 
İ
->
¬gc
; j++)

635 
	`deüRefCouÁ
(
İ
->
¬gv
[
j
]);

636 
	`dä“
(
İ
->
¬gv
);

638 
	`dä“
(
ß
->
İs
);

639 
	}
}

652 
	$´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

653 
æags
)

655 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
 && 
æags
 & 
PROPAGATE_AOF
)

656 
	`ãedAµ’dOÆyFe
(
cmd
,
dbid
,
¬gv
,
¬gc
);

657 ià(
æags
 & 
PROPAGATE_REPL
)

658 
	`»¶iÿtiÚF“dSÏves
(
»¶
.
¦aves
,
dbid
,
¬gv
,
¬gc
);

659 
	}
}

673 
	$®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

674 
rg‘
)

676 
robj
 **
¬gvcİy
;

677 
j
;

679 ià(
£rv”
.
lßdšg
) ;

681 
¬gvcİy
 = 
	`d®loc
((
robj
*)*(
size_t
)
¬gc
);

682 
j
 = 0; j < 
¬gc
; j++) {

683 
¬gvcİy
[
j
] = 
	`dupSŒšgObjeùUncÚ¡ªt
(
¬gv
[j]);

685 
	`»disOpA¼ayAµ’d
(&
£rv”
.
®so_´İag©e
,
cmd
,
dbid
,
¬gvcİy
,
¬gc
,
rg‘
);

686 
	}
}

691 
	$fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
) {

692 ià(
æags
 & 
PROPAGATE_REPL
è
c
->æag |ğ
CLIENT_FORCE_REPL
;

693 ià(
æags
 & 
PROPAGATE_AOF
è
c
->æag |ğ
CLIENT_FORCE_AOF
;

694 
	}
}

699 
	$´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
) {

700 
c
->
æags
 |ğ
CLIENT_PREVENT_PROP
;

701 
	}
}

704 
	$´ev’tCommªdAOF
(
ş›Á
 *
c
) {

705 
c
->
æags
 |ğ
CLIENT_PREVENT_AOF_PROP
;

706 
	}
}

709 
	$´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
) {

710 
c
->
æags
 |ğ
CLIENT_PREVENT_REPL_PROP
;

711 
	}
}

714 
	$addR•lyCommªdFÏg
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
f
, *
»¶y
) {

715 ià(
cmd
->
æags
 & 
f
) {

716 
	`addR•lyStus
(
c
, 
»¶y
);

720 
	}
}

723 
	$addR•lyCommªd
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
) {

724 ià(!
cmd
) {

725 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

728 
	`addR•lyMuÉiBulkL’
(
c
, 6);

729 
	`addR•lyBulkCSŒšg
(
c
, 
cmd
->
Çme
);

730 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
¬™y
);

732 
æagcouÁ
 = 0;

733 *
æagËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

734 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_WRITE
, "write");

735 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_READONLY
, "readonly");

736 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_DENYOOM
, "denyoom");

737 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ADMIN
, "admin");

738 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_PUBSUB
, "pubsub");

739 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_NOSCRIPT
, "noscript");

740 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_RANDOM
, "random");

741 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SORT_FOR_SCRIPT
,"sort_for_script");

742 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_LOADING
, "loading");

743 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_STALE
, "stale");

744 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SKIP_MONITOR
, "skip_monitor");

745 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ASKING
, "asking");

746 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_FAST
, "fast");

747 ià(
cmd
->
g‘keys_´oc
) {

748 
	`addR•lyStus
(
c
, "movablekeys");

749 
æagcouÁ
 += 1;

751 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
æagËn
, 
æagcouÁ
);

753 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
fœ¡key
);

754 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
Ï¡key
);

755 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
key¡•
);

757 
	}
}

760 
	$commªdCommªd
(
ş›Á
 *
c
) {

761 ià(
c
->
¬gc
 == 1) {

762 
diùI‹¿tÜ
 *
di
;

763 
diùEÁry
 *
de
;

765 
	`addR•lyMuÉiBulkL’
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

766 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
commªds
);

767 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

768 
	`addR•lyCommªd
(
c
, 
	`diùG‘V®
(
de
));

770 
	`diùR–—£I‹¿tÜ
(
di
);

771 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "info")) {

772 
i
;

773 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

774 
i
 = 2; i < 
c
->
¬gc
; i++) {

775 
	`addR•lyCommªd
(
c
, 
	`diùF‘chV®ue
(
£rv”
.
commªds
, c->
¬gv
[
i
]->
±r
));

777 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "couÁ"è&& c->
¬gc
 == 2) {

778 
	`addR•lyLÚgLÚg
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

779 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keys"è&& c->
¬gc
 >= 3) {

780 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
c
->
¬gv
[2]->
±r
);

781 *
keys
, 
numkeys
, 
j
;

783 ià(!
cmd
) {

784 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid command specified");

786 } ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
c
->
¬gc
-2) ||

787 ((
c
->
¬gc
-2è< -
cmd
->
¬™y
))

789 
	`addR•lyE¼Ü
(
c
,"Invalid‚umber of‡rguments specified for command");

793 
keys
 = 
	`g‘KeysFromCommªd
(
cmd
,
c
->
¬gv
+2,c->
¬gc
-2,&
numkeys
);

794 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

795 
j
 = 0; j < 
numkeys
; j++è
	`addR•lyBulk
(
c
,c->
¬gv
[
keys
[j]+2]);

796 
	`g‘KeysF»eResuÉ
(
keys
);

797 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "¡©s"è&& c->
¬gc
 == 2) {

798 
j
;

799 
d¬¿y
 *
c¡abË®l
;

800 
¬¿y
 *
c¡abË
 = 
c
->
v–
->cstable;

801 
commªdSts
 *
c¡©s
, *
c¡©§Î
;

803 ià(
c
->
¡•s
 == 0) {

804 
c¡abË®l
 = 
	`commªdStsTabËC»©e
();

805 ià(!(
c
->
æags
&
CLIENT_JUMP
))

806 
c
->
æags
 |ğ
CLIENT_JUMP
;

807 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

808 
c
->
ÿche
 = 
c¡abË®l
;

810 
c¡abË®l
 = 
c
->
ÿche
;

811 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

814 
j
 = 0; j < 
	`d¬¿y_n
(
c¡abË
); j ++) {

815 
c¡©s
 = 
	`d¬¿y_g‘
(
c¡abË
, 
j
);

816 ià(!
c¡©s
->
ÿÎs
) ;

818 
c¡©§Î
 = 
	`d¬¿y_g‘
(
c¡abË®l
, 
j
);

819 
c¡©§Î
->
miüo£cÚds
 +ğ
c¡©s
->microseconds;

820 
c¡©§Î
->
ÿÎs
 +ğ
c¡©s
->calls;

823 ià(
c
->
¡•s
 >ğ(
	`d¬¿y_n
(&
wÜk”s
) - 1)) {

824 
sds
 
commªd_¡©s_šfo
;

825 *
»¶yËn_node
;

826 
»¶yËn
 = 0;

828 
c
->
¡•s
 = 0;

829 
c
->
ridx
 = -1;

830 
c
->
ÿche
 = 
NULL
;

831 
c
->
æags
 &ğ~
CLIENT_JUMP
;

833 
»¶yËn_node
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

834 
j
 = 0; j < 
	`d¬¿y_n
(
c¡abË®l
); j ++) {

835 
c¡©§Î
 = 
	`d¬¿y_g‘
(
c¡abË®l
, 
j
);

836 ià(!
c¡©§Î
->
ÿÎs
) ;

838 
commªd_¡©s_šfo
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

840 
c¡©§Î
->
Çme
, c¡©§Î->
ÿÎs
, c¡©§Î->
miüo£cÚds
,

841 ()
c¡©§Î
->
miüo£cÚds
/c¡©§Î->
ÿÎs
);

842 
	`addR•lyBulkSds
(
c
,
commªd_¡©s_šfo
);

843 
»¶yËn
 ++;

846 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn_node
,
»¶yËn
);

848 
	`commªdStsTabËDe¡roy
(
c¡abË®l
);

851 
	`addR•lyE¼Ü
(
c
, "Unknown subcommand or wrong‚umber of‡rguments.");

854 
	}
}

856 
d¬¿y
 *

857 
	$commªdStsTabËC»©e
()

859 
j
;

860 
commªdSts
 *
c¡©s
;

861 
d¬¿y
 *
c¡©¡abË
;

862 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

865 
c¡©¡abË
 = 
	`d¬¿y_ü—‹
(
numcommªds
,(
commªdSts
));

866 ià(
c¡©¡abË
 =ğ
NULL
)  NULL;

867 
j
 = 0; j < 
numcommªds
; j ++) {

868 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

869 
c¡©s
 = 
	`d¬¿y_push
(
c¡©¡abË
);

870 
c¡©s
->
Çme
 = 
c
->name;

871 
c¡©s
->
miüo£cÚds
 = 0;

872 
c¡©s
->
ÿÎs
 = 0;

873 
	`ASSERT
(
j
 =ğ
c
->
idx
);

876  
c¡©¡abË
;

877 
	}
}

880 
	$commªdStsTabËDe¡roy
(
d¬¿y
 *
c¡©¡abË
)

882 
c¡©¡abË
->
ÃËm
 = 0;

883 
	`d¬¿y_de¡roy
(
c¡©¡abË
);

884 
	}
}

	@src/vr_command.h

1 #iâdeà
_VR_COMMAND_H_


2 
	#_VR_COMMAND_H_


	)

6 
	#CMD_WRITE
 1

	)

7 
	#CMD_READONLY
 2

	)

8 
	#CMD_DENYOOM
 4

	)

9 
	#CMD_NOT_USED_1
 8

	)

10 
	#CMD_ADMIN
 16

	)

11 
	#CMD_PUBSUB
 32

	)

12 
	#CMD_NOSCRIPT
 64

	)

13 
	#CMD_RANDOM
 128

	)

14 
	#CMD_SORT_FOR_SCRIPT
 256

	)

15 
	#CMD_LOADING
 512

	)

16 
	#CMD_STALE
 1024

	)

17 
	#CMD_SKIP_MONITOR
 2048

	)

18 
	#CMD_ASKING
 4096

	)

19 
	#CMD_FAST
 8192

	)

22 
	#CMD_CALL_NONE
 0

	)

23 
	#CMD_CALL_SLOWLOG
 (1<<0)

	)

24 
	#CMD_CALL_STATS
 (1<<1)

	)

25 
	#CMD_CALL_PROPAGATE_AOF
 (1<<2)

	)

26 
	#CMD_CALL_PROPAGATE_REPL
 (1<<3)

	)

27 
	#CMD_CALL_PROPAGATE
 (
CMD_CALL_PROPAGATE_AOF
|
CMD_CALL_PROPAGATE_REPL
)

	)

28 
	#CMD_CALL_FULL
 (
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
 | 
CMD_CALL_PROPAGATE
)

	)

31 
	#PROPAGATE_NONE
 0

	)

32 
	#PROPAGATE_AOF
 1

	)

33 
	#PROPAGATE_REPL
 2

	)

36 
	#SHUTDOWN_NOFLAGS
 0

	)

37 
	#SHUTDOWN_SAVE
 1

	)

39 
	#SHUTDOWN_NOSAVE
 2

	)

41 
	t»disCommªdProc
(
	tş›Á
 *
	tc
);

42 *
	t»disG‘KeysProc
(
	t»disCommªd
 *
	tcmd
, 
	trobj
 **
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

43 
	s»disCommªd
 {

44 *
	mÇme
;

45 
»disCommªdProc
 *
	m´oc
;

46 
	m¬™y
;

47 *
	msæags
;

48 
	mæags
;

51 
»disG‘KeysProc
 *
	mg‘keys_´oc
;

53 
	mfœ¡key
;

54 
	mÏ¡key
;

55 
	mkey¡•
;

56 
	midx
;

57 
	mÃedadmš
;

60 
	scommªdSts
 {

61 *
	mÇme
;

62 
	mmiüo£cÚds
;

63 
	mÿÎs
;

64 }
	tcommªdSts
;

72 
	s»disOp
 {

73 
robj
 **
	m¬gv
;

74 
	m¬gc
, 
	mdbid
, 
	mrg‘
;

75 
»disCommªd
 *
	mcmd
;

76 } 
	t»disOp
;

85 
	s»disOpA¼ay
 {

86 
»disOp
 *
	mİs
;

87 
	mnumİs
;

88 } 
	t»disOpA¼ay
;

90 
diùTy³
 
commªdTabËDiùTy³
;

92 
pİuÏ‹CommªdTabË
();

93 
pİuÏ‹CommªdsN“dAdmš·ss
();

95 
»disCommªd
 *
lookupCommªd
(
sds
 
Çme
);

96 
»disCommªd
 *
lookupCommªdOrOrigš®
(
sds
 
Çme
);

97 
»disCommªd
 *
lookupCommªdByCSŒšg
(*
s
);

99 
ÿÎ
(
ş›Á
 *
c
, 
æags
);

100 
´oûssCommªd
(
ş›Á
 *
c
);

102 
»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
);

103 
»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

104 
»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
);

106 
´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
æags
);

107 
®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

108 
fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
);

109 
´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
);

110 
´ev’tCommªdAOF
(
ş›Á
 *
c
);

111 
´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
);

113 
commªdCommªd
(
ş›Á
 *
c
);

115 
d¬¿y
 *
commªdStsTabËC»©e
();

116 
commªdStsTabËDe¡roy
(
d¬¿y
 *
c¡©¡abË
);

	@src/vr_conf.c

1 
	~<fú.h
>

3 
	~<vr_cÜe.h
>

5 cÚ¡ *(*
	tcÚfigEnumG‘SŒFun
)(
	tty³
);

7 
	#CONF_TOKEN_ORGANIZATION_START
 "["

	)

8 
	#CONF_TOKEN_ORGANIZATION_END
 "]"

	)

9 
	#CONF_TOKEN_KEY_VALUE_BETWEEN
 ":"

	)

10 
	#CONF_TOKEN_ARRAY_START
 "-"

	)

12 
	#CONF_ORGANIZATION_NAME_COMMAN
 "commÚ"

	)

13 
	#CONF_ORGANIZATION_NAME_SERVER
 "£rv”"

	)

15 
	#CONF_VALUE_YES
 "yes"

	)

16 
	#CONF_VALUE_NO
 "no"

	)

18 
	#CONF_MAX_LINE
 1024

	)

20 
	#CONF_TAG_DEFAULT_TYPE
 
GROUP_TYPE_SINGLE


	)

21 
	#CONF_TAG_DEFAULT_HASH
 
HASH_FNV1_64


	)

22 
	#CONF_TAG_DEFAULT_HASH_TAG
 
NULL


	)

23 
	#CONF_TAG_DEFAULT_DISTRIBUTION
 "k‘ama"

	)

24 
	#CONF_TAG_DEFAULT_REDIS_AUTH
 
NULL


	)

25 
	#CONF_TAG_DEFAULT_REDIS_DB
 0

	)

26 
	#CONF_TAG_DEFAULT_TIMEOUT
 300

	)

27 
	#CONF_TAG_DEFAULT_SERVERS
 "127.0.0.1:6379"

	)

28 
	#CONF_TAG_DEFAULT_LISTEN
 "127.0.0.1:6380"

	)

29 
	#CONF_TAG_DEFAULT_MAXMEMORY
 1073741824

30 
	#CONF_TAG_DEFAULT_THREADS
 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)

	)

31 
	#CONF_TAG_DEFAULT_NOREPLY
 "çl£"

	)

32 
	#CONF_TAG_DEFAULT_RDB_DISKLESS
 "çl£"

	)

34 
	#DEFINE_ACTION
(
_hash
, 
_Çme
è(*)(#_Çme),

	)

35 * 
	ghash_¡ršgs
[] = {

36 
HASH_CODEC
Ğ
DEFINE_ACTION
 )

37 
NULL


39 #undeà
DEFINE_ACTION


41 
	#DEFINE_ACTION
(
_di¡
, 
_Çme
è(*)(#_Çme),

	)

42 * 
	gdi¡_¡ršgs
[] = {

43 
DIST_CODEC
Ğ
DEFINE_ACTION
 )

44 
NULL


46 #undeà
DEFINE_ACTION


48 
	#DEFINE_ACTION
(
_pŞicy
, 
_Çme
è(*)(#_Çme),

	)

49 * 
	geviùpŞicy_¡ršgs
[] = {

50 
EVICTPOLICY_CODEC
Ğ
DEFINE_ACTION
 )

51 
NULL


53 #undeà
DEFINE_ACTION


55 
cÚf_İtiÚ
 
	gcÚf_£rv”_İtiÚs
[] = {

56 { (*)
CONFIG_SOPN_DATABASES
,

57 
CONF_FIELD_TYPE_INT
, 1,

58 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

59 
off£tof
(
cÚf_£rv”
, 
d©aba£s
) },

60 { (*)
CONFIG_SOPN_IDPDATABASE
,

61 
CONF_FIELD_TYPE_INT
, 1,

62 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

63 
off£tof
(
cÚf_£rv”
, 
š‹º®_dbs_³r_d©aba£s
) },

64 { (*)
CONFIG_SOPN_MAXMEMORY
,

65 
CONF_FIELD_TYPE_LONGLONG
, 0,

66 
cÚf_£t_maxmemÜy
, 
cÚf_g‘_lÚglÚg
,

67 
off£tof
(
cÚf_£rv”
, 
maxmemÜy
) },

68 { (*)
CONFIG_SOPN_MAXMEMORYP
,

69 
CONF_FIELD_TYPE_INT
, 0,

70 
cÚf_£t_maxmemÜy_pŞicy
, 
cÚf_g‘_št
,

71 
off£tof
(
cÚf_£rv”
, 
maxmemÜy_pŞicy
) },

72 { (*)
CONFIG_SOPN_MAXMEMORYS
,

73 
CONF_FIELD_TYPE_INT
, 0,

74 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

75 
off£tof
(
cÚf_£rv”
, 
maxmemÜy_§m¶es
) },

76 { (*)
CONFIG_SOPN_MTCLIMIT
,

77 
CONF_FIELD_TYPE_LONGLONG
, 0,

78 
cÚf_£t_lÚglÚg
, 
cÚf_g‘_lÚglÚg
,

79 
off£tof
(
cÚf_£rv”
, 
max_time_com¶ex™y_lim™
) },

80 { (*)
CONFIG_SOPN_BIND
,

81 
CONF_FIELD_TYPE_ARRAYSDS
, 1,

82 
cÚf_£t_¬¿y_sds
, 
cÚf_g‘_¬¿y_sds
,

83 
off£tof
(
cÚf_£rv”
, 
bšds
) },

84 { (*)
CONFIG_SOPN_PORT
,

85 
CONF_FIELD_TYPE_INT
, 1,

86 
cÚf_£t_št
, 
cÚf_g‘_št
,

87 
off£tof
(
cÚf_£rv”
, 
pÜt
) },

88 { (*)
CONFIG_SOPN_THREADS
,

89 
CONF_FIELD_TYPE_INT
, 1,

90 
cÚf_£t_št
, 
cÚf_g‘_št
,

91 
off£tof
(
cÚf_£rv”
, 
th»ads
) },

92 { (*)
CONFIG_SOPN_MAXCLIENTS
,

93 
CONF_FIELD_TYPE_INT
, 0,

94 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

95 
off£tof
(
cÚf_£rv”
, 
maxş›Ás
) },

96 { (*)
CONFIG_SOPN_SLOWLOGLST
,

97 
CONF_FIELD_TYPE_LONGLONG
, 0,

98 
cÚf_£t_lÚglÚg
, 
cÚf_g‘_lÚglÚg
,

99 
off£tof
(
cÚf_£rv”
, 
¦owlog_log_¦ow”_thª
) },

100 { (*)
CONFIG_SOPN_SLOWLOGML
,

101 
CONF_FIELD_TYPE_INT
, 0,

102 
cÚf_£t_št
, 
cÚf_g‘_št
,

103 
off£tof
(
cÚf_£rv”
, 
¦owlog_max_Ën
) },

104 { (*)
CONFIG_SOPN_REQUIREPASS
,

105 
CONF_FIELD_TYPE_SDS
, 0,

106 
cÚf_£t_·sswÜd
, 
cÚf_g‘_sds
,

107 
off£tof
(
cÚf_£rv”
, 
»quœ•ass
) },

108 { (*)
CONFIG_SOPN_ADMINPASS
,

109 
CONF_FIELD_TYPE_SDS
, 0,

110 
cÚf_£t_·sswÜd
, 
cÚf_g‘_sds
,

111 
off£tof
(
cÚf_£rv”
, 
admš·ss
) },

112 { (*)
CONFIG_SOPN_COMMANDSNAP
,

113 
CONF_FIELD_TYPE_ARRAYSDS
, 1,

114 
cÚf_£t_commªds_Ãed_admš·ss
, 
cÚf_g‘_¬¿y_sds
,

115 
off£tof
(
cÚf_£rv”
, 
commªds_Ãed_admš·ss
) },

116 { 
NULL
, NULL, 0 }

119 
vr_cÚf
 *
	gcÚf
 = 
NULL
;

120 
cÚf_£rv”
 *
	gc£rv”
 = 
NULL
;

123 
	$cÚf_v®ue_dump
(
cÚf_v®ue
 *
cv
, 
log_Ëv–
)

125 
ušt32_t
 
i
;

126 
cÚf_v®ue
 **
cv_sub
;

128 if(
cv
 =ğ
NULL
){

132 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
){

133 
	`log_debug
(
log_Ëv–
, "%.*s", 
	`sd¦’
(
cv
->
v®ue
), cv->value);

134 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

135 
i
 = 0; i < 
	`d¬¿y_n
(
cv
->
v®ue
); i++){

136 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
i
);

137 
	`cÚf_v®ue_dump
(*
cv_sub
, 
log_Ëv–
);

140 
	`NOT_REACHED
();

142 
	}
}

145 
	$cÚf_Ügªiz©iÚ_dump
(
sds
 
Çme
, 
diù
 *
Üg
, 
log_Ëv–
)

147 
diùI‹¿tÜ
 *
di
;

148 
diùEÁry
 *
de
;

149 
sds
 
key
;

150 
cÚf_v®ue
 *
cv
;

152 if(
Çme
 =ğ
NULL
 || 
Üg
 == NULL){

156 
	`log_debug
(
log_Ëv–
, "[%.*s]", 
	`sd¦’
(
Çme
),‚ame);

158 
di
 = 
	`diùG‘I‹¿tÜ
(
Üg
);

160 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
){

161 
key
 = 
	`diùG‘Key
(
de
);

162 
cv
 = 
	`diùG‘V®
(
de
);

164 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
){

165 
	`log_debug
(
log_Ëv–
, "%.*s: %.*s",

166 
	`sd¦’
(
key
), key,

167 
	`sd¦’
(
cv
->
v®ue
), cv->value);

168 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

169 
	`log_debug
(
log_Ëv–
, "%.*s:",
	`sd¦’
(
key
), key);

170 
	`cÚf_v®ue_dump
(
cv
, 
log_Ëv–
);

172 
	`NOT_REACHED
();

176 
	`diùR–—£I‹¿tÜ
(
di
);

177 
	}
}

180 
	$cÚf_Ügªiz©iÚs_dump
(
vr_cÚf
 *
cf
)

182 
diù
 *
Ügs
, *
Üg
;

183 
diùI‹¿tÜ
 *
di
;

184 
diùEÁry
 *
de
;

185 
sds
 
Çme
;

186 
log_Ëv–
 = 
LOG_VERB
;

188 if(
cf
 =ğ
NULL
){

192 
Ügs
 = 
cf
->
Ügªiz©iÚs
;

193 if(
Ügs
 =ğ
NULL
){

194 
	`log_debug
(
log_Ëv–
, "organization is NULL");

198 
di
 = 
	`diùG‘I‹¿tÜ
(
Ügs
);

200 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
){

201 
Çme
 = 
	`diùG‘Key
(
de
);

202 
Üg
 = 
	`diùG‘V®
(
de
);

204 
	`cÚf_Ügªiz©iÚ_dump
(
Çme
, 
Üg
, 
log_Ëv–
);

205 
	`log_debug
(
log_Ëv–
, "");

208 
	`diùR–—£I‹¿tÜ
(
di
);

209 
	}
}

212 
	$cÚf_£t_maxmemÜy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

214 
ušt8_t
 *
p
;

215 
cÚf_v®ue
 *
cv
 = 
d©a
;

216 
v®ue
;

217 *
gt
;

218 
”r
;

220 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

221 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

222 
İt
->
Çme
);

223  
VR_ERROR
;

226 
	`CONF_WLOCK
();

228 
p
 = 
obj
;

229 
gt
 = (*)(
p
 + 
İt
->
off£t
);

231 
v®ue
 = 
	`memtŞl
(
cv
->v®ue, &
”r
);

232 if(
”r
 !ğ0 || 
v®ue
 < 0){

233 
	`CONF_UNLOCK
();

234 
	`log_”rÜ
("value forhe key %s in conf file is invalid",

235 
İt
->
Çme
);

236  
VR_ERROR
;

239 *
gt
 = 
v®ue
;

240 
cÚf
->
v”siÚ
 ++;

241 
	`CONF_UNLOCK
();

242  
VR_OK
;

243 
	}
}

246 
	$cÚf_£t_maxmemÜy_pŞicy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

248 
ušt8_t
 *
p
;

249 
cÚf_v®ue
 *
cv
 = 
d©a
;

250 *
gt
;

251 **
pŞicy
;

253 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

254 
	`log_”rÜ
("conf server inhe conf file is‚ot‡ string");

255  
VR_ERROR
;

258 
	`CONF_WLOCK
();

260 
p
 = 
obj
;

261 
gt
 = (*)(
p
 + 
İt
->
off£t
);

263 
pŞicy
 = 
eviùpŞicy_¡ršgs
; *policy;…olicy ++) {

264 ià(
	`¡rcmp
(
cv
->
v®ue
, *
pŞicy
) == 0) {

265 *
gt
 = 
pŞicy
 - 
eviùpŞicy_¡ršgs
;

270 ià(*
pŞicy
 =ğ
NULL
) {

271 
	`CONF_UNLOCK
();

272 
	`log_”rÜ
("ERROR: Conf maxmemory…olicy '%s' is invalid",

273 
cv
->
v®ue
);

274  
VR_ERROR
;

277 ià(*
gt
 =ğ
MAXMEMORY_VOLATILE_LRU
 || *gˆ=ğ
MAXMEMORY_ALLKEYS_LRU
) {

278 
	`CONF_UNLOCK
();

279 
	`log_”rÜ
("ERROR: Conf maxmemory…olicy‚ow is‚ot support %s‡nd %s",

280 
eviùpŞicy_¡ršgs
[
MAXMEMORY_VOLATILE_LRU
],

281 
eviùpŞicy_¡ršgs
[
MAXMEMORY_ALLKEYS_LRU
]);

282  
VR_ERROR
;

285 
	`CONF_UNLOCK
();

286  
VR_OK
;

287 
	}
}

290 
	$cÚf_£t_št_nÚ_z”o
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

292 
ušt8_t
 *
p
;

293 
cÚf_v®ue
 *
cv
 = 
d©a
;

294 *
gt
;

296 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

297 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

298 
İt
->
Çme
);

299  
VR_ERROR
;

302 
	`CONF_WLOCK
();

304 
p
 = 
obj
;

305 
gt
 = (*)(
p
 + 
İt
->
off£t
);

307 if(!
	`sdsIsNum
(
cv
->
v®ue
)){

308 
	`CONF_UNLOCK
();

309 
	`log_”rÜ
("value ofhe key %s in conf file is‚ot‡‚umber",

310 
İt
->
Çme
);

311  
VR_ERROR
;

314 *
gt
 = 
	`vr_©oi
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

316 ià(*
gt
 < 0) {

317 
	`CONF_UNLOCK
();

318 
	`log_”rÜ
("value ofhe key %s in conf file is invalid",

319 
İt
->
Çme
);

320  
VR_ERROR
;

321 } ià(*
gt
 < 1) {

322 
	`CONF_UNLOCK
();

323 
	`log_”rÜ
("value ofhe key %s in conf file must be 1 or greater",

324 
İt
->
Çme
);

325  
VR_ERROR
;

327 
cÚf
->
v”siÚ
 ++;

328 
	`CONF_UNLOCK
();

329  
VR_OK
;

330 
	}
}

334 
	$cÚf_g‘_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

336 
ušt8_t
 *
p
;

337 
sds
 *
¡r
 = 
d©a
;

338 
sds
 *
gt
;

340 ià(
d©a
 =ğ
NULL
)

341  
VR_ERROR
;

343 
	`CONF_RLOCK
();

344 
p
 = 
obj
;

345 
gt
 = (
sds
*)(
p
 + 
İt
->
off£t
);

346 ià(*
gt
 =ğ
NULL
è*
¡r
 = NULL;

347 *
¡r
 = 
	`sdsdup
(*
gt
);

348 
	`CONF_UNLOCK
();

349  
VR_OK
;

350 
	}
}

353 
	$cÚf_£t_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

355 
ušt8_t
 *
p
;

356 
cÚf_v®ue
 *
cv
 = 
d©a
;

357 
sds
 *
gt
;

359 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

360 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string",

361 
İt
->
Çme
);

362  
VR_ERROR
;

365 
	`CONF_WLOCK
();

366 
p
 = 
obj
;

367 
gt
 = (
sds
*)(
p
 + 
İt
->
off£t
);

369 *
gt
 = 
	`sd¢ewËn
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

370 
cÚf
->
v”siÚ
 ++;

371 
	`CONF_UNLOCK
();

372  
VR_OK
;

373 
	}
}

376 
	$cÚf_£t_·sswÜd
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

378 
ušt8_t
 *
p
;

379 
cÚf_v®ue
 *
cv
 = 
d©a
;

380 
sds
 *
gt
;

382 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

383 
	`log_”rÜ
("Conf…ool %s inhe conf file is‚ot‡ string",

384 
İt
->
Çme
);

385  
VR_ERROR
;

386 } ià(
	`sd¦’
(
cv
->
v®ue
è> 
CONFIG_AUTHPASS_MAX_LEN
) {

387 
	`log_”rÜ
("Password is†ongerhan CONFIG_AUTHPASS_MAX_LEN");

388  
VR_ERROR
;

391 
	`CONF_WLOCK
();

392 
p
 = 
obj
;

393 
gt
 = (
sds
*)(
p
 + 
İt
->
off£t
);

395 ià(*
gt
 !ğ
NULL
è
	`sdsä“
(*gt);

396 ià(
	`sd¦’
(
cv
->
v®ue
è=ğ0è*
gt
 = 
NULL
;

397 *
gt
 = 
	`sd¢ewËn
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

398 
cÚf
->
v”siÚ
 ++;

399 
	`CONF_UNLOCK
();

400  
VR_OK
;

401 
	}
}

404 
	$cÚf_g‘_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

406 
ušt8_t
 *
p
;

407 *
š‹g”
 = 
d©a
;

408 *
gt
;

410 ià(
d©a
 =ğ
NULL
)

411  
VR_ERROR
;

413 
	`CONF_RLOCK
();

414 
p
 = 
obj
;

415 
gt
 = (*)(
p
 + 
İt
->
off£t
);

416 *
š‹g”
 = *
gt
;

417 
	`CONF_UNLOCK
();

418  
VR_OK
;

419 
	}
}

422 
	$cÚf_£t_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

424 
ušt8_t
 *
p
;

425 
cÚf_v®ue
 *
cv
 = 
d©a
;

426 *
gt
;

428 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

429 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

430 
İt
->
Çme
);

431  
VR_ERROR
;

434 
	`CONF_WLOCK
();

436 
p
 = 
obj
;

437 
gt
 = (*)(
p
 + 
İt
->
off£t
);

439 if(!
	`sdsIsNum
(
cv
->
v®ue
)){

440 
	`CONF_UNLOCK
();

441 
	`log_”rÜ
("value ofhe key %s in conf file is‚ot‡‚umber",

442 
İt
->
Çme
);

443  
VR_ERROR
;

446 *
gt
 = 
	`vr_©oi
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

448 ià(*
gt
 < 0) {

449 
	`CONF_UNLOCK
();

450 
	`log_”rÜ
("value ofhe key %s in conf file is invalid",

451 
İt
->
Çme
);

452  
VR_ERROR
;

454 
cÚf
->
v”siÚ
 ++;

455 
	`CONF_UNLOCK
();

456  
VR_OK
;

457 
	}
}

460 
	$cÚf_g‘_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

462 
ušt8_t
 *
p
;

463 *
š‹g”
 = 
d©a
;

464 *
gt
;

466 ià(
d©a
 =ğ
NULL
)

467  
VR_ERROR
;

469 
	`CONF_RLOCK
();

470 
p
 = 
obj
;

471 
gt
 = (*)(
p
 + 
İt
->
off£t
);

472 *
š‹g”
 = *
gt
;

473 
	`CONF_UNLOCK
();

474  
VR_OK
;

475 
	}
}

478 
	$cÚf_£t_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

480 
ušt8_t
 *
p
;

481 
cÚf_v®ue
 *
cv
 = 
d©a
;

482 *
gt
;

484 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

485 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

486 
İt
->
Çme
);

487  
VR_ERROR
;

490 
	`CONF_WLOCK
();

492 
p
 = 
obj
;

493 
gt
 = (*)(
p
 + 
İt
->
off£t
);

495 ià(!
	`¡ršg2Î
(
cv
->
v®ue
, 
	`sd¦’
(cv->v®ue), 
gt
)) {

496 
	`CONF_UNLOCK
();

497 
	`log_”rÜ
("value ofhe key %s in conf file is invalid",

498 
İt
->
Çme
);

499  
VR_ERROR
;

501 
cÚf
->
v”siÚ
 ++;

502 
	`CONF_UNLOCK
();

503  
VR_OK
;

504 
	}
}

507 
	$cÚf_£t_yesÜno
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

509 
ušt8_t
 *
p
;

510 
cÚf_v®ue
 *
cv
 = 
d©a
;

511 *
gt
;

513 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

514 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

515 
İt
->
Çme
);

516  
VR_ERROR
;

519 
	`CONF_WLOCK
();

521 
p
 = 
obj
;

522 
gt
 = (*)(
p
 + 
İt
->
off£t
);

524 if(!
	`¡rÿ£cmp
(
cv
->
v®ue
, 
CONF_VALUE_YES
)){

525 *
gt
 = 1;

526 }if(!
	`¡rÿ£cmp
(
cv
->
v®ue
, 
CONF_VALUE_NO
)){

527 *
gt
 = 0;

529 
	`CONF_UNLOCK
();

530 
	`log_”rÜ
("key %s in conf file must be %s or %s",

531 
İt
->
Çme
, 
CONF_VALUE_YES
, 
CONF_VALUE_NO
);

532  
VR_ERROR
;

534 
cÚf
->
v”siÚ
 ++;

535 
	`CONF_UNLOCK
();

536  
VR_OK
;

537 
	}
}

540 
	$cÚf_£t_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

542 
ušt8_t
 *
p
;

543 
ušt32_t
 
j
;

544 
cÚf_v®ue
 **
cv_sub
, *
cv
 = 
d©a
;

545 
d¬¿y
 *
gt
;

546 
sds
 *
¡r
;

548 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
 &&

549 
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_ARRAY
){

550 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string or‡rray",

551 
İt
->
Çme
);

552  
VR_ERROR
;

553 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

554 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

555 ià((*
cv_sub
)->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
) {

556 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string‡rray",

557 
İt
->
Çme
);

558  
VR_ERROR
;

562 
	`CONF_WLOCK
();

563 
p
 = 
obj
;

564 
gt
 = (
d¬¿y
*)(
p
 + 
İt
->
off£t
);

566 
	`d¬¿y_n
(
gt
) > 0) {

567 
¡r
 = 
	`d¬¿y_pİ
(
gt
);

568 
	`sdsä“
(*
¡r
);

571 ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
) {

572 
¡r
 = 
	`d¬¿y_push
(
gt
);

573 *
¡r
 = 
	`sdsdup
(
cv
->
v®ue
);

574 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

575 
j
 = 0; j < 
	`d¬¿y_n
(
cv
->
v®ue
); j ++) {

576 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

577 
¡r
 = 
	`d¬¿y_push
(
gt
);

578 *
¡r
 = 
	`sdsdup
((*
cv_sub
)->
v®ue
);

581 
cÚf
->
v”siÚ
 ++;

582 
	`CONF_UNLOCK
();

583  
VR_OK
;

584 
	}
}

587 
	$cÚf_£t_commªds_Ãed_admš·ss
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

589 
ušt8_t
 *
p
;

590 
ušt32_t
 
j
;

591 
cÚf_v®ue
 **
cv_sub
, *
cv
 = 
d©a
;

592 
d¬¿y
 *
gt
;

593 
sds
 *
¡r
;

595 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
 &&

596 
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_ARRAY
){

597 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string or‡rray",

598 
İt
->
Çme
);

599  
VR_ERROR
;

600 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

601 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

602 ià((*
cv_sub
)->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
) {

603 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string‡rray",

604 
İt
->
Çme
);

605  
VR_ERROR
;

609 
	`CONF_WLOCK
();

610 
p
 = 
obj
;

611 
gt
 = (
d¬¿y
*)(
p
 + 
İt
->
off£t
);

613 
	`d¬¿y_n
(
gt
) > 0) {

614 
¡r
 = 
	`d¬¿y_pİ
(
gt
);

615 
	`sdsä“
(*
¡r
);

618 ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
) {

619 
¡r
 = 
	`d¬¿y_push
(
gt
);

620 *
¡r
 = 
	`sdsdup
(
cv
->
v®ue
);

621 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

622 
j
 = 0; j < 
	`d¬¿y_n
(
cv
->
v®ue
); j ++) {

623 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

624 
¡r
 = 
	`d¬¿y_push
(
gt
);

625 *
¡r
 = 
	`sdsdup
((*
cv_sub
)->
v®ue
);

628 
cÚf
->
v”siÚ
 ++;

629 
	`CONF_UNLOCK
();

630  
VR_OK
;

631 
	}
}

634 
	$cÚf_g‘_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

636 
ušt8_t
 *
p
;

637 
ušt32_t
 
j
;

638 
d¬¿y
 *
¡rs
 = 
d©a
;

639 
¬¿y
 *
gt
;

640 
sds
 *
¡r1
, *
¡r2
;

642 ià(
d©a
 =ğ
NULL
) {

643  
VR_ERROR
;

646 
	`CONF_RLOCK
();

647 
p
 = 
obj
;

648 
gt
 = (
d¬¿y
*)(
p
 + 
İt
->
off£t
);

650 
	`ASSERT
(
	`d¬¿y_n
(
¡rs
) == 0);

652 
j
 = 0; j < 
	`d¬¿y_n
(
gt
); j ++) {

653 
¡r1
 = 
	`d¬¿y_g‘
(
gt
, 
j
);

654 
¡r2
 = 
	`d¬¿y_push
(
¡rs
);

655 *
¡r2
 = 
	`sdsdup
(*
¡r1
);

658 
	`CONF_UNLOCK
();

659  
VR_OK
;

660 
	}
}

662 
	$diùCÚfV®ueDe¡ruùÜ
(*
´ivd©a
, *
v®
)

664 
	`DICT_NOTUSED
(
´ivd©a
);

666 
	`cÚf_v®ue_de¡roy
(
v®
);

667 
	}
}

669 
	$diùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

671 
	`DICT_NOTUSED
(
´ivd©a
);

673 
	`diùR–—£
(
v®
);

674 
	}
}

676 
diùTy³
 
	gOrgªiz©iÚDiùTy³
 = {

677 
diùSdsHash
,

678 
NULL
,

679 
NULL
,

680 
diùSdsKeyCom·»
,

681 
diùSdsDe¡ruùÜ
,

682 
diùDe¡ruùÜ


685 
diùTy³
 
	gKeyV®ueDiùTy³
 = {

686 
diùSdsHash
,

687 
NULL
,

688 
NULL
,

689 
diùSdsKeyCom·»
,

690 
diùSdsDe¡ruùÜ
,

691 
diùCÚfV®ueDe¡ruùÜ


694 
diùTy³
 
	gCÚfTabËDiùTy³
 = {

695 
diùSŒCa£Hash
,

696 
NULL
,

697 
NULL
,

698 
diùSŒKeyCa£Com·»
,

699 
NULL
,

700 
NULL


703 
cÚf_v®ue
 *
	$cÚf_v®ue_ü—‹
(
ty³
)

705 
cÚf_v®ue
 *
cv
;

707 
cv
 = 
	`d®loc
((*cv));

708 if(
cv
 =ğ
NULL
){

709  
NULL
;

712 
cv
->
ty³
 =ype;

713 
cv
->
v®ue
 = 
NULL
;

715 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

716 
cv
->
v®ue
 = 
	`d¬¿y_ü—‹
(3, (
cÚf_v®ue
*));

717 if(
cv
->
v®ue
 =ğ
NULL
){

718 
	`dä“
(
cv
);

719  
NULL
;

723  
cv
;

724 
	}
}

726 
	$cÚf_v®ue_de¡roy
(
cÚf_v®ue
 *
cv
)

728 
cÚf_v®ue
 **
cv_sub
;

730 if(
cv
 =ğ
NULL
){

734 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_UNKNOW
){

735 
	`dä“
(
cv
);

737 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
){

738 if(
cv
->
v®ue
 !ğ
NULL
){

739 
	`sdsä“
(
cv
->
v®ue
);

741 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

742 if(
cv
->
v®ue
 !ğ
NULL
){

743 
	`d¬¿y_n
(
cv
->
v®ue
) > 0){

744 
cv_sub
 = 
	`d¬¿y_pİ
(
cv
->
v®ue
);

745 
	`cÚf_v®ue_de¡roy
(*
cv_sub
);

748 
	`d¬¿y_de¡roy
(
cv
->
v®ue
);

751 
	`NOT_REACHED
();

754 
	`dä“
(
cv
);

755 
	}
}

757 
	$cÚf_£rv”_š™
(
cÚf_£rv”
 *
cs
)

759 if(
cs
 =ğ
NULL
){

760  
VR_ERROR
;

763 
cs
->
ùabË
 = 
	`diùC»©e
(&
CÚfTabËDiùTy³
,
NULL
);

765 
cs
->
d©aba£s
 = 
CONF_UNSET_NUM
;

766 
cs
->
š‹º®_dbs_³r_d©aba£s
 = 
CONF_UNSET_NUM
;

767 
cs
->
max_time_com¶ex™y_lim™
 = 
CONF_UNSET_NUM
;

768 
cs
->
maxmemÜy
 = 
CONF_UNSET_NUM
;

769 
cs
->
maxmemÜy_pŞicy
 = 
CONF_UNSET_NUM
;

770 
cs
->
maxmemÜy_§m¶es
 = 
CONF_UNSET_NUM
;

771 
cs
->
maxş›Ás
 = 
CONF_UNSET_NUM
;

772 
cs
->
th»ads
 = 
CONF_UNSET_NUM
;

773 
	`d¬¿y_š™
(&
cs
->
bšds
,1,(
sds
));

774 
cs
->
pÜt
 = 
CONF_UNSET_NUM
;

775 
cs
->
»quœ•ass
 = 
CONF_UNSET_PTR
;

776 
cs
->
admš·ss
 = 
CONF_UNSET_PTR
;

777 
cs
->
dœ
 = 
CONF_UNSET_PTR
;

778 
	`d¬¿y_š™
(&
cs
->
commªds_Ãed_admš·ss
,1,(
sds
));

780  
VR_OK
;

781 
	}
}

783 
	$cÚf_£rv”_£t_deçuÉ
(
cÚf_£rv”
 *
cs
)

785 
sds
 *
¡r
;

786 
cÚf_İtiÚ
 *
İt
;

788 if(
cs
 =ğ
NULL
){

789  
VR_ERROR
;

792 
İt
 = 
cÚf_£rv”_İtiÚs
; o±&&İt->
Çme
; opt++) {

793 
	`diùAdd
(
cs
->
ùabË
,
İt
->
Çme
,opt);

796 
cs
->
d©aba£s
 = 
CONFIG_DEFAULT_LOGICAL_DBNUM
;

797 
cs
->
š‹º®_dbs_³r_d©aba£s
 = 
CONFIG_DEFAULT_INTERNAL_DBNUM
;

798 
cs
->
max_time_com¶ex™y_lim™
 = 
CONFIG_DEFAULT_MAX_TIME_COMPLEXITY_LIMIT
;

799 
cs
->
maxmemÜy
 = 
CONFIG_DEFAULT_MAXMEMORY
;

800 
cs
->
maxmemÜy_pŞicy
 = 
CONFIG_DEFAULT_MAXMEMORY_POLICY
;

801 
cs
->
maxmemÜy_§m¶es
 = 
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
;

802 
cs
->
maxş›Ás
 = 
CONFIG_DEFAULT_MAX_CLIENTS
;

803 
cs
->
th»ads
 = 
CONFIG_DEFAULT_THREADS_NUM
;

804 
cs
->
¦owlog_log_¦ow”_thª
 = 
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
;

805 
cs
->
¦owlog_max_Ën
 = 
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
;

806 
cs
->
»quœ•ass
 = 
CONF_UNSET_PTR
;

807 
cs
->
admš·ss
 = 
CONF_UNSET_PTR
;

809 
	`d¬¿y_n
(&
cs
->
bšds
) > 0) {

810 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
bšds
);

811 
	`sdsä“
(*
¡r
);

813 
¡r
 = 
	`d¬¿y_push
(&
cs
->
bšds
);

814 *
¡r
 = 
	`sd¢ew
(
CONFIG_DEFAULT_HOST
);

816 
cs
->
pÜt
 = 
CONFIG_DEFAULT_SERVER_PORT
;

818 ià(
cs
->
dœ
 !ğ
CONF_UNSET_PTR
) {

819 
	`sdsä“
(
cs
->
dœ
);

821 
cs
->
dœ
 = 
	`sd¢ew
(
CONFIG_DEFAULT_DATA_DIR
);

823 
	`d¬¿y_n
(&
cs
->
commªds_Ãed_admš·ss
) > 0) {

824 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
commªds_Ãed_admš·ss
);

825 
	`sdsä“
(*
¡r
);

828  
VR_OK
;

829 
	}
}

831 
	$cÚf_£rv”_deš™
(
cÚf_£rv”
 *
cs
)

833 
sds
 *
¡r
;

835 if(
cs
 =ğ
NULL
){

839 
cs
->
d©aba£s
 = 
CONF_UNSET_NUM
;

840 
cs
->
š‹º®_dbs_³r_d©aba£s
 = 
CONF_UNSET_NUM
;

841 
cs
->
maxmemÜy
 = 
CONF_UNSET_NUM
;

842 
cs
->
maxmemÜy_pŞicy
 = 
CONF_UNSET_NUM
;

843 
cs
->
maxmemÜy_§m¶es
 = 
CONF_UNSET_NUM
;

844 
cs
->
max_time_com¶ex™y_lim™
 = 
CONF_UNSET_NUM
;

845 
cs
->
maxş›Ás
 = 
CONF_UNSET_NUM
;

846 
cs
->
th»ads
 = 
CONF_UNSET_NUM
;

848 
	`d¬¿y_n
(&
cs
->
bšds
) > 0) {

849 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
bšds
);

850 
	`sdsä“
(*
¡r
);

852 
	`d¬¿y_deš™
(&
cs
->
bšds
);

854 
cs
->
pÜt
 = 
CONF_UNSET_NUM
;

856 ià(
cs
->
dœ
 !ğ
CONF_UNSET_PTR
) {

857 
	`sdsä“
(
cs
->
dœ
);

858 
cs
->
dœ
 = 
CONF_UNSET_PTR
;

861 ià(
cs
->
»quœ•ass
 !ğ
CONF_UNSET_PTR
) {

862 
	`sdsä“
(
cs
->
»quœ•ass
);

863 
cs
->
»quœ•ass
 = 
CONF_UNSET_PTR
;

865 ià(
cs
->
admš·ss
 !ğ
CONF_UNSET_PTR
) {

866 
	`sdsä“
(
cs
->
admš·ss
);

867 
cs
->
admš·ss
 = 
CONF_UNSET_PTR
;

870 
	`d¬¿y_n
(&
cs
->
commªds_Ãed_admš·ss
) > 0) {

871 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
commªds_Ãed_admš·ss
);

872 
	`sdsä“
(*
¡r
);

874 
	`d¬¿y_deš™
(&
cs
->
commªds_Ãed_admš·ss
);

875 
	}
}

878 
	$cÚf_£rv”_g‘
(cÚ¡ *
İtiÚ_Çme
, *
v®ue
)

880 
cÚf_İtiÚ
 *
İt
;

882 
İt
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
İtiÚ_Çme
);

883 ià(
İt
 =ğ
NULL
)

884  
VR_ERROR
;

886  
İt
->
	`g‘
(
c£rv”
, o±, 
v®ue
);

887 
	}
}

890 
	$cÚf_£rv”_£t
(cÚ¡ *
İtiÚ_Çme
, 
cÚf_v®ue
 *
v®ue
)

892 
cÚf_İtiÚ
 *
İt
;

894 
İt
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
İtiÚ_Çme
);

895 ià(
İt
 =ğ
NULL
 || o±->
æags
&
CONF_FIELD_FLAGS_NO_MODIFY
)

896  
VR_ERROR
;

898  
İt
->
	`£t
(
c£rv”
, o±, 
v®ue
);

899 
	}
}

901 
	$cÚf_š™
(
vr_cÚf
 *
cf
)

903 
»t
;

905 if(
cf
 =ğ
NULL
){

906  
VR_ERROR
;

909 
cf
->
âame
 = 
NULL
;

910 
cf
->
Ügªiz©iÚs
 = 
NULL
;

911 
cf
->
v”siÚ
 = 0;

912 
	`±h»ad_rwlock_š™
(&
cf
->
rwl
, 
NULL
);

913 
	`±h»ad_mu‹x_š™
(&
cf
->
æock
, 
NULL
);

915 
cf
->
Ügªiz©iÚs
 = 
	`diùC»©e
(&
Orgªiz©iÚDiùTy³
, 
NULL
);

916 ià(
cf
->
Ügªiz©iÚs
 =ğ
NULL
) {

917  
VR_ERROR
;

920 
	`cÚf_£rv”_š™
(&
cf
->
c£rv”
);

922 
cÚf
 = 
cf
;

924  
VR_OK
;

925 
	}
}

927 
	$cÚf_£t_deçuÉ
(
vr_cÚf
 *
cf
)

929 
	`CONF_WLOCK
();

930 
	`cÚf_£rv”_£t_deçuÉ
(&
cf
->
c£rv”
);

931 
	`CONF_UNLOCK
();

932  
VR_OK
;

933 
	}
}

935 
	$cÚf_deš™
(
vr_cÚf
 *
cf
)

937 if(
cf
 =ğ
NULL
){

941 ià(
cf
->
âame
 !ğ
NULL
) {

942 
	`sdsä“
(
cf
->
âame
);

943 
cf
->
âame
 = 
NULL
;

946 if(
cf
->
Ügªiz©iÚs
 !ğ
NULL
){

947 
	`diùR–—£
(
cf
->
Ügªiz©iÚs
);

948 
cf
->
Ügªiz©iÚs
 = 
NULL
;

951 
	`cÚf_£rv”_deš™
(&
cf
->
c£rv”
);

953 
cf
->
v”siÚ
 = 0;

954 
	`±h»ad_rwlock_de¡roy
(&
cf
->
rwl
);

955 
	`±h»ad_mu‹x_de¡roy
(&
cf
->
æock
);

956 
	}
}

959 
	$cÚf_£rv”_dump
(
cÚf_£rv”
 *
cs
, 
log_Ëv–
)

961 if(
cs
 =ğ
NULL
){

965 
	`log_debug
(
log_Ëv–
, " d©aba£ : %d", 
cs
->
d©aba£s
);

966 
	`log_debug
(
log_Ëv–
, " iÁ”Çl_dbs_³r_d©aba£ : %d", 
cs
->
š‹º®_dbs_³r_d©aba£s
);

967 
	`log_debug
(
log_Ëv–
, " maxmemÜy : %Îd", 
cs
->
maxmemÜy
);

968 
	`log_debug
(
log_Ëv–
, " maxmemÜy_pŞicy : %d", 
cs
->
maxmemÜy_pŞicy
);

969 
	`log_debug
(
log_Ëv–
, " maxmemÜy_§m¶e : %d", 
cs
->
maxmemÜy_§m¶es
);

970 
	`log_debug
(
log_Ëv–
, " max_time_com¶ex™y_lim™ : %Îd", 
cs
->
max_time_com¶ex™y_lim™
);

971 
	}
}

974 
	$cÚf_dump
(
vr_cÚf
 *
cf
)

976 
log_Ëv–
 = 
LOG_VERB
;

977 
cÚf_£rv”
 *
cs
;

979 if(
cf
 =ğ
NULL
){

983 
cs
 = &
cf
->
c£rv”
;

984 
	`log_debug
(
log_Ëv–
, "server in conf file");

985 
	`cÚf_£rv”_dump
(
cs
, 
log_Ëv–
);

986 
	`log_debug
(
log_Ëv–
, "");

987 
	}
}

993 
	$cÚf_key_v®ue_š£¹
(
diù
 *
Üg
, 
sds
 
key
, 
cÚf_v®ue
 *
cv
)

995 ià(
key
 =ğ
NULL
) {

996 
	`log_”rÜ
("value in conf file has‚o key");

1000 ià(
cv
 =ğ
NULL
) {

1001 
	`log_”rÜ
("key % š cÚàfha nØv®ue", 
key
);

1005 ià(
Üg
 =ğ
NULL
) {

1006 
	`log_”rÜ
("key %s in conf file has‚o organization",

1007 
key
);

1011 ià(
	`diùAdd
(
Üg
,
key
,
cv
è!ğ
DICT_OK
) {

1012 
diùEÁry
 *
de
;

1013 
cÚf_v®ue
 *
cv_Şd
, *
cv_Ãw
, **
cv_sub
;

1014 
de
 = 
	`diùFšd
(
Üg
,
key
);

1015 
cv_Şd
 = 
	`diùG‘V®
(
de
);

1016 ià(
cv_Şd
->
ty³
 !ğ
CONF_VALUE_TYPE_ARRAY
) {

1017 
cv_Ãw
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_ARRAY
);

1018 
cv_sub
 = 
	`d¬¿y_push
(
cv_Ãw
->
v®ue
);

1019 *
cv_sub
 = 
cv_Şd
;

1020 
cv_sub
 = 
	`d¬¿y_push
(
cv_Ãw
->
v®ue
);

1021 *
cv_sub
 = 
cv
;

1022 
	`diùS‘V®
(
Üg
,
de
,
cv_Ãw
);

1024 
cv_sub
 = 
	`d¬¿y_push
(
cv_Şd
->
v®ue
);

1025 *
cv_sub
 = 
cv
;

1031 
	}
}

1034 
	$cÚf_´e_lßd_äom_¡ršg
(
vr_cÚf
 *
cf
, *
cÚfig
)

1036 
»t
;

1037 
lš’um
 = 0, 
tÙlšes
, 
i
, 
j
;

1038 
¦aveof_lš’um
 = 0;

1039 
sds
 *
lšes
 = 
NULL
;

1040 
diù
 *
Üg
 = 
NULL
;

1041 
sds
 
Üg_Çme
 = 
NULL
;

1042 
diùEÁry
 *
de
;

1043 
sds
 
key
 = 
NULL
;

1044 
cÚf_v®ue
 *
cv
 = 
NULL
;

1046 
lšes
 = 
	`sds¥l™Ën
(
cÚfig
,
	`¡¾’
(cÚfig),"\n",1,&
tÙlšes
);

1048 
i
 = 0; i < 
tÙlšes
; i++) {

1049 
sds
 *
¬gv
;

1050 
¬gc
;

1052 
lš’um
 = 
i
+1;

1053 
lšes
[
i
] = 
	`sd¡rim
(lines[i]," \t\r\n");

1056 ià(
lšes
[
i
][0] == '#' ||†ines[i][0] == '\0') ;

1058 ià(
lšes
[
i
][0] == '[') {

1059 ià(
	`sd¦’
(
lšes
[
i
]) <= 2 ||†ines[i][sdslen(lines[i])-1] == ']') {

1060 
	`log_”rÜ
("Organization‚ame %s in conf file %sƒrror",

1061 
lšes
[
i
], 
cf
->
âame
);

1062 
lßd”r
;

1064 
Üg_Çme
 = 
	`sd¢ewËn
(
lšes
[
i
]+1,
	`sd¦’
(lines[i])-2);

1065 
de
 = 
	`diùFšd
(
cf
->
Ügªiz©iÚs
,
Üg_Çme
);

1066 ià(
de
 =ğ
NULL
) {

1067 
Üg
 = 
	`diùC»©e
(&
KeyV®ueDiùTy³
, 
NULL
);

1068 
	`diùAdd
(
cf
->
Ügªiz©iÚs
,
Üg_Çme
,
Üg
);

1070 
Üg
 = 
	`diùG‘V®
(
de
);

1071 
	`sdsä“
(
Üg_Çme
);

1078 
¬gv
 = 
	`sds¥l™¬gs
(
lšes
[
i
],&
¬gc
);

1079 ià(
¬gv
 =ğ
NULL
) {

1080 
	`log_”rÜ
("Unbalanced quotes in configuration†ine");

1081 
lßd”r
;

1085 ià(
¬gc
 == 0) {

1086 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1089 
	`sd¡Şow”
(
¬gv
[0]);

1091 ià(
Üg
 =ğ
NULL
) {

1092 
Üg_Çme
 = 
	`sd¢ew
("server");

1093 
Üg
 = 
	`diùC»©e
(&
KeyV®ueDiùTy³
, 
NULL
);

1094 
	`diùAdd
(
cf
->
Ügªiz©iÚs
,
Üg_Çme
,
Üg
);

1097 
key
 = 
¬gv
[0];

1098 
¬gv
[0] = 
NULL
;

1099 
j
 = 1; j < 
¬gc
; j ++) {

1100 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1101 
cv
->
v®ue
 = 
¬gv
[
j
];

1102 
¬gv
[
j
] = 
NULL
;

1103 
»t
 = 
	`cÚf_key_v®ue_š£¹
(
Üg
, 
key
, 
cv
);

1104 if(
»t
 == -1){

1105 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1106 
	`sdsä“
(
key
);

1107 
	`cÚf_v®ue_de¡roy
(
cv
);

1108 
	`log_”rÜ
("key value insert into organization failed");

1109 
lßd”r
;

1110 } ià(
j
 =ğ1 && 
»t
 == 0) {

1111 
	`sdsä“
(
key
);

1115 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1118 ià(
lšes
) {

1119 
	`sdsä“¥l™»s
(
lšes
,
lš’um
);

1121  
VR_OK
;

1123 
lßd”r
:

1124 ià(
lšes
) {

1125 
	`sdsä“¥l™»s
(
lšes
,
lš’um
);

1127  
VR_ERROR
;

1128 
	}
}

1131 
	$cÚf_´e_v®id©e
(
vr_cÚf
 *
cf
)

1133 
»t
;

1134 
sds
 
cÚfig
 = 
	`sd£m±y
();

1135 
buf
[
CONF_MAX_LINE
+1];

1138 ià(
cf
->
âame
) {

1139 
FILE
 *
å
;

1141 ià(
cf
->
âame
[0] == '-' && cf->fname[1] == '\0') {

1142 
å
 = 
¡dš
;

1144 ià((
å
 = 
	`fİ’
(
cf
->
âame
,"r")è=ğ
NULL
) {

1145 
	`log_”rÜ
("O³ÀcÚfig f'%s' faed: %s", 
cf
->
âame
, 
	`¡»¼Ü
(
”ºo
));

1146 
	`sdsä“
(
cÚfig
);

1147  
VR_ERROR
;

1150 
	`fg‘s
(
buf
,
CONF_MAX_LINE
+1,
å
è!ğ
NULL
)

1151 
cÚfig
 = 
	`sdsÿt
(cÚfig,
buf
);

1152 ià(
å
 !ğ
¡dš
è
	`fşo£
(fp);

1155 
»t
 = 
	`cÚf_´e_lßd_äom_¡ršg
(
cf
,
cÚfig
);

1156 ià(
»t
 !ğ
VR_OK
) {

1157 
	`sdsä“
(
cÚfig
);

1158  
VR_ERROR
;

1161 
	`sdsä“
(
cÚfig
);

1162  
VR_OK
;

1163 
	}
}

1166 
	$cÚf_·r£_cÚf_£rv”
(
cÚf_£rv”
 *
cs
, 
diù
 *
Üg
)

1168 
»t
;

1169 
cÚf_İtiÚ
 *
İt
;

1170 
diùEÁry
 *
de
;

1171 
sds
 
key
;

1173 if(
cs
 =ğ
NULL
 || 
Üg
 == NULL){

1174  
VR_ERROR
;

1177 
key
 = 
	`sd£m±y
();

1178 
İt
 = 
cÚf_£rv”_İtiÚs
; o±&&İt->
Çme
; opt++) {

1179 
key
 = 
	`sdsıy
(key,
İt
->
Çme
);

1180 
de
 = 
	`diùFšd
(
Üg
,
key
);

1181 ià(
de
 !ğ
NULL
) {

1182 
»t
 = 
İt
->
	`£t
(
cs
, o±, 
	`diùG‘V®
(
de
));

1183 if(
»t
 !ğ
VR_OK
){

1184 
	`log_”rÜ
("·r£ key % š cÚàf”rÜ", 
key
);

1185 
	`sdsä“
(
key
);

1186  
VR_ERROR
;

1191 
	`sdsä“
(
key
);

1192  
VR_OK
;

1193 
	}
}

1196 
	$cÚf_·r£
(
vr_cÚf
 *
cf
)

1198 
»t
;

1199 
diù
 *
Ügs
, *
Üg
;

1200 
diùEÁry
 *
de
;

1201 
sds
 
key
;

1203 ià(
cf
 =ğ
NULL
) {

1204  
VR_ERROR
;

1207 
Ügs
 = 
cf
->
Ügªiz©iÚs
;

1208 ià(
Ügs
 =ğ
NULL
) {

1209  
VR_ERROR
;

1213 
key
 = 
	`sd¢ew
(
CONF_ORGANIZATION_NAME_SERVER
);

1214 
de
 = 
	`diùFšd
(
Ügs
, 
key
);

1215 ià(
de
 =ğ
NULL
) {

1216 
	`log_”rÜ
("can‚ot find %s organization in conf file %s",

1217 
CONF_ORGANIZATION_NAME_SERVER
, 
cf
->
âame
);

1218 
	`sdsä“
(
key
);

1219  
VR_ERROR
;

1222 
Üg
 = 
	`diùG‘V®
(
de
);

1223 ià(
Üg
 =ğ
NULL
) {

1224 
	`log_”rÜ
("diù % ’Œy v®ui NULL", 
	`diùG‘Key
(
de
));

1225 
	`sdsä“
(
key
);

1226  
VR_ERROR
;

1229 
»t
 = 
	`cÚf_·r£_cÚf_£rv”
(&
cf
->
c£rv”
, 
Üg
);

1230 ifĞ
»t
 !ğ
VR_OK
) {

1231 
	`log_”rÜ
("common conf…arseƒrror");

1232 
	`sdsä“
(
key
);

1233  
VR_ERROR
;

1236 
	`sdsä“
(
key
);

1238  
VR_OK
;

1239 
	}
}

1242 
	$cÚf_po¡_v®id©e
(
vr_cÚf
 *
cf
)

1244 if(
cf
 =ğ
NULL
){

1245  
VR_ERROR
;

1248 if(
cf
->
Ügªiz©iÚs
 !ğ
NULL
){

1249 
	`diùR–—£
(
cf
->
Ügªiz©iÚs
);

1250 
cf
->
Ügªiz©iÚs
 = 
NULL
;

1253  
VR_OK
;

1254 
	}
}

1256 
vr_cÚf
 *

1257 
	$cÚf_İ’
(*
f’ame
)

1259 
»t
;

1260 
vr_cÚf
 *
cf
 = 
NULL
;

1261 
sds
 
·th
 = 
NULL
;

1263 ià(
f’ame
 =ğ
NULL
) {

1264 
	`log_”rÜ
("configuration file‚ame is NULL.");

1265  
NULL
;

1268 
·th
 = 
	`g‘AbsŞu‹P©h
(
f’ame
);

1269 ià(
·th
 =ğ
NULL
) {

1270 
	`log_”rÜ
("cÚfigu¿tiÚ fÇm'%s' i ”rÜ.", 
f’ame
);

1271 
”rÜ
;

1274 
cf
 = 
	`d®loc
((*cf));

1275 ià(
cf
 =ğ
NULL
) {

1276 
”rÜ
;

1279 
»t
 = 
	`cÚf_š™
(
cf
);

1280 if(
»t
 !ğ
VR_OK
){

1281 
”rÜ
;

1284 
»t
 = 
	`cÚf_£t_deçuÉ
(
cf
);

1285 ià(
»t
 !ğ
VR_OK
) {

1286 
”rÜ
;

1289 
cf
->
âame
 = 
·th
;

1291  
cf
;

1293 
”rÜ
:

1295 ià(
cf
 !ğ
NULL
) {

1296 
	`cÚf_de¡roy
(
cf
);

1299 ià(
·th
 !ğ
NULL
) {

1300 
	`sdsä“
(
·th
);

1303  
NULL
;

1304 
	}
}

1306 
vr_cÚf
 *

1307 
	$cÚf_ü—‹
(*
f’ame
)

1309 
»t
;

1310 
vr_cÚf
 *
cf
;

1312 
cf
 = 
	`cÚf_İ’
(
f’ame
);

1313 ià(
cf
 =ğ
NULL
) {

1314  
NULL
;

1318 
»t
 = 
	`cÚf_´e_v®id©e
(
cf
);

1319 ià(
»t
 !ğ
VR_OK
) {

1320 
”rÜ
;

1323 
	`cÚf_Ügªiz©iÚs_dump
(
cf
);

1326 
»t
 = 
	`cÚf_·r£
(
cf
);

1327 ià(
»t
 !ğ
VR_OK
) {

1328 
”rÜ
;

1332 
»t
 = 
	`cÚf_po¡_v®id©e
(
cf
);

1333 ià(
»t
 !ğ
VR_OK
) {

1334 
”rÜ
;

1337 
	`cÚf_dump
(
cf
);

1339 
c£rv”
 = &
cf
->cserver;

1341  
cf
;

1343 
”rÜ
:

1344 
	`cÚf_de¡roy
(
cf
);

1345  
NULL
;

1346 
	}
}

1349 
	$cÚf_de¡roy
(
vr_cÚf
 *
cf
)

1351 ià(
cf
 =ğ
NULL
) {

1355 
	`cÚf_deš™
(
cf
);

1357 
	`dä“
(
cf
);

1358 
	}
}

1361 
	$cÚf_v”siÚ_g‘
()

1363 
v”siÚ
;

1365 
	`CONF_RLOCK
();

1366 
v”siÚ
 = 
cÚf
->version;

1367 
	`CONF_UNLOCK
();

1369  
v”siÚ
;

1370 
	}
}

1373 
	$CONF_RLOCK
()

1375  
	`±h»ad_rwlock_rdlock
(&
cÚf
->
rwl
);

1376 
	}
}

1379 
	$CONF_WLOCK
()

1381  
	`±h»ad_rwlock_w¾ock
(&
cÚf
->
rwl
);

1382 
	}
}

1385 
	$CONF_UNLOCK
()

1387  
	`±h»ad_rwlock_uÆock
(&
cÚf
->
rwl
);

1388 
	}
}

1391 
	$CONFF_LOCK
()

1393  
	`±h»ad_mu‹x_lock
(&
cÚf
->
æock
);

1394 
	}
}

1397 
	$CONFF_UNLOCK
()

1399  
	`±h»ad_mu‹x_uÆock
(&
cÚf
->
æock
);

1400 
	}
}

1403 
	$g‘_eviùpŞicy_¡ršgs
(
eviùpŞicy_ty³
)

1405  
eviùpŞicy_¡ršgs
[
eviùpŞicy_ty³
];

1406 
	}
}

1412 
	$cÚfigS‘Commªd
(
ş›Á
 *
c
) {

1413 
»t
;

1414 
sds
 
v®ue
;

1415 
sds
 *
f›lds
;

1416 
f›lds_couÁ
 = 0;

1417 
cÚf_İtiÚ
 *
İt
;

1418 
cÚf_v®ue
 *
cv
;

1420 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[2],
	`sdsEncodedObjeù
(c->argv[2]));

1421 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[3],
	`sdsEncodedObjeù
(c->argv[3]));

1423 
İt
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
c
->
¬gv
[2]->
±r
);

1425 ià(
İt
 =ğ
NULL
) {

1426 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported CONFIG…arameter: %s",

1427 (*)
c
->
¬gv
[2]->
±r
);

1429 } ià(
İt
->
æags
&
CONF_FIELD_FLAGS_NO_MODIFY
) {

1430 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported modifyhis CONFIG…arameter: %s",

1431 (*)
c
->
¬gv
[2]->
±r
);

1435 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

1438 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
CONFIG_SOPN_MAXCLIENTS
)) {

1439 
maxş›Ás
;

1440 
f–im™
, 
th»ads
;

1441 ià(
	`¡ršg2l
(
v®ue
,
	`sd¦’
(v®ue),&
maxş›Ás
è=ğ0 || maxş›Á < 1è
badfmt
;

1442 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_THREADS
,&
th»ads
);

1444 
f–im™
 = 
	`adju¡O³nFesLim™
(()
maxş›Ás
);

1445 ià((
f–im™
-
th»ads
*2-
CONFIG_MIN_RESERVED_FDS
è!ğ
maxş›Ás
) {

1446 
	`addR•lyE¼ÜFÜm©
(
c
,"The operating system is‚ot‡bleo handlehe specified‚umber of clients");

1449 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
CONFIG_SOPN_ADMINPASS
)) {

1450 ià(
c
->
v–
->
cc
.
admš·ss
 && c->
auth’tiÿ‹d
 < 2) {

1451 
	`addR•lyE¼ÜFÜm©
(
c
,"You‚eed‡dminpasso sethis CONFIG…arameter: %s",

1452 (*)
c
->
¬gv
[2]->
±r
);

1457 
f›lds
 = 
	`sds¥l™Ën
(
v®ue
,
	`sd¦’
(v®ue)," ",1,&
f›lds_couÁ
);

1458 ià(
f›lds
 =ğ
NULL
) {

1459 
badfmt
;

1460 } ià(
f›lds_couÁ
 == 0) {

1461 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1462 
cv
->
v®ue
 = 
	`sd£m±y
();

1463 } ià(
f›lds_couÁ
 == 1) {

1464 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1465 
cv
->
v®ue
 = 
f›lds
[0];

1466 
f›lds
[0] = 
NULL
;

1467 } ià(
f›lds_couÁ
 > 1) {

1468 
cÚf_v®ue
 **
cv_sub
;

1469 
ušt32_t
 
i
;

1471 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_ARRAY
);

1472 
i
 = 0; i < 
f›lds_couÁ
; i ++) {

1473 
cv_sub
 = 
	`d¬¿y_push
(
cv
->
v®ue
);

1474 *
cv_sub
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1475 (*
cv_sub
)->
v®ue
 = 
f›lds
[
i
];

1476 
f›lds
[
i
] = 
NULL
;

1479 
	`log_debug
(
LOG_NOTICE
, "f›lds_couÁ: %d", 
f›lds_couÁ
);

1480 
	`£rv”Pªic
("Error config set value");

1482 
	`sdsä“¥l™»s
(
f›lds
,
f›lds_couÁ
);

1484 
»t
 = 
İt
->
	`£t
(
c£rv”
, o±, 
cv
);

1485 
	`cÚf_v®ue_de¡roy
(
cv
);

1486 ià(
»t
 !ğ
VR_OK
) {

1487 
badfmt
;

1491 ià(!
	`¡rcmp
(
İt
->
Çme
,
CONFIG_SOPN_MAXMEMORY
)) {

1492 
maxmemÜy
;

1493 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
maxmemÜy
);

1494 ià(
maxmemÜy
) {

1495 ià(
maxmemÜy
 < 
	`d®loc_u£d_memÜy
()) {

1496 
	`log_w¬n
("WARNING:he‚ew maxmemory value set via CONFIG SET is smallerhanhe current memory usage. This will„esult in keysƒviction‡nd/or inabilityo‡ccept‚ew write commands depending onhe maxmemory-policy.");

1497 
	`ä“MemÜyIfN“ded
(
c
->
v–
);

1503 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1506 
badfmt
:

1507 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for CONFIG SET '%s'",

1508 (*)
v®ue
,

1509 (*)
c
->
¬gv
[2]->
±r
);

1510 
	}
}

1516 
	$addR•lyCÚfO±iÚ
(
ş›Á
 *
c
,
cÚf_İtiÚ
 *
cİ
)

1518 
	`addR•lyBulkCSŒšg
(
c
,
cİ
->
Çme
);

1519 ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_INT
) {

1520 
v®ue
;

1521 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ue
);

1523 ià(!
	`¡rcmp
(
cİ
->
Çme
,
CONFIG_SOPN_MAXMEMORYP
)) {

1524 
	`addR•lyBulkCSŒšg
(
c
,
	`g‘_eviùpŞicy_¡ršgs
(
v®ue
));

1526 
	`addR•lyBulkLÚgLÚg
(
c
,
v®ue
);

1528 } ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_LONGLONG
) {

1529 
v®ue
;

1530 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ue
);

1531 
	`addR•lyBulkLÚgLÚg
(
c
,
v®ue
);

1532 } ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_SDS
) {

1533 
sds
 
v®ue
;

1534 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ue
);

1535 ià(
v®ue
 =ğ
NULL
) {

1536 
	`addR•lyBulkCSŒšg
(
c
,"");

1538 
	`addR•lyBulkSds
(
c
,
v®ue
);

1540 } ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_ARRAYSDS
) {

1541 
d¬¿y
 
v®ues
;

1542 
sds
 
v®ue
 = 
	`sd£m±y
();

1543 
sds
 *
–em
;

1545 
	`d¬¿y_š™
(&
v®ues
,1,(
sds
));

1546 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ues
);

1547 
	`d¬¿y_n
(&
v®ues
) > 0) {

1548 
–em
 = 
	`d¬¿y_pİ
(&
v®ues
);

1549 
v®ue
 = 
	`sdsÿtsds
(v®ue,*
–em
);

1550 
v®ue
 = 
	`sdsÿt
(value," ");

1551 
	`sdsä“
(*
–em
);

1553 
	`d¬¿y_deš™
(&
v®ues
);

1554 ià(
	`sd¦’
(
v®ue
è> 0è
	`sd¤ªge
(value,0,-2);

1555 
	`addR•lyBulkSds
(
c
,
v®ue
);

1557 
	`£rv”Pªic
("Error conf fieldype");

1559 
	}
}

1561 
	$cÚfigG‘Commªd
(
ş›Á
 *
c
) {

1562 
robj
 *
o
 = 
c
->
¬gv
[2];

1563 *
·‰”n
 = 
o
->
±r
;

1564 
cÚf_İtiÚ
 *
cİ
;

1565 
	`£rv”As£¹W™hInfo
(
c
,
o
,
	`sdsEncodedObjeù
(o));

1567 
cİ
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
·‰”n
);

1568 ià(
cİ
 !ğ
NULL
) {

1570 ià(!
	`¡rcmp
(
cİ
->
Çme
,
CONFIG_SOPN_ADMINPASS
) &&

1571 
c
->
v–
->
cc
.
admš·ss
 && c->
auth’tiÿ‹d
 < 2) {

1572 
	`addR•ly
(
c
,
sh¬ed
.
nßdmš”r
);

1574 
	`addR•lyMuÉiBulkL’
(
c
,2);

1575 
	`addR•lyCÚfO±iÚ
(
c
,
cİ
);

1578 
m©ches
 = 0;

1579 * 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1580 
cİ
 = 
cÚf_£rv”_İtiÚs
; cİ&&cİ->
Çme
; cop++) {

1581 ià(
	`¡ršgm©ch
(
·‰”n
,
cİ
->
Çme
,1)) {

1583 ià(!
	`¡rcmp
(
cİ
->
Çme
,
CONFIG_SOPN_ADMINPASS
) &&

1584 
c
->
v–
->
cc
.
admš·ss
 && c->
auth’tiÿ‹d
 < 2)

1587 
	`addR•lyCÚfO±iÚ
(
c
,
cİ
);

1588 
m©ches
 ++;

1591 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
m©ches
*2);

1593 
	}
}

1600 
	s»wr™eCÚfigS‹
 {

1601 
diù
 *
	mİtiÚ_to_lše
;

1602 
diù
 *
	m»wr™‹n
;

1603 
	mnumlšes
;

1604 
sds
 *
	mlšes
;

1605 
	mhas_
;

1610 
	$»wr™eCÚfigAµ’dLše
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
lše
) {

1611 
¡©e
->
lšes
 = 
	`d»®loc
(¡©e->lšes, (*è* (¡©e->
numlšes
+1));

1612 
¡©e
->
lšes
[¡©e->
numlšes
++] = 
lše
;

1613 
	}
}

1616 
	$»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
İtiÚ
, 
lš’um
) {

1617 
dli¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
İtiÚ
);

1619 ià(
l
 =ğ
NULL
) {

1620 
l
 = 
	`dli¡C»©e
();

1621 
	`diùAdd
(
¡©e
->
İtiÚ_to_lše
,
	`sdsdup
(
İtiÚ
),
l
);

1623 
	`dli¡AddNodeTa
(
l
,(*)()
lš’um
);

1624 
	}
}

1626 
diùTy³
 
	gİtiÚToLšeDiùTy³
 = {

1627 
diùSdsCa£Hash
,

1628 
NULL
,

1629 
NULL
,

1630 
diùSdsKeyCa£Com·»
,

1631 
diùSdsDe¡ruùÜ
,

1632 
diùLi¡De¡ruùÜ


1635 
diùTy³
 
	gİtiÚS‘DiùTy³
 = {

1636 
diùSdsCa£Hash
,

1637 
NULL
,

1638 
NULL
,

1639 
diùSdsKeyCa£Com·»
,

1640 
diùSdsDe¡ruùÜ
,

1641 
NULL


1644 
	#CONFIG_MAX_LINE
 1024

	)

1645 
	#REDIS_CONFIG_REWRITE_SIGNATURE
 "# G’”©ed by CONFIG REWRITE"

	)

1651 
»wr™eCÚfigS‹
 *
	$»wr™eCÚfigR—dOldFe
(*
·th
) {

1652 
FILE
 *
å
 = 
	`fİ’
(
·th
,"r");

1653 
»wr™eCÚfigS‹
 *
¡©e
 = 
	`d®loc
((*state));

1654 
buf
[
CONFIG_MAX_LINE
+1];

1655 
lš’um
 = -1;

1657 ià(
å
 =ğ
NULL
 && 
”ºo
 !ğ
ENOENT
)  NULL;

1659 
¡©e
->
İtiÚ_to_lše
 = 
	`diùC»©e
(&
İtiÚToLšeDiùTy³
,
NULL
);

1660 
¡©e
->
»wr™‹n
 = 
	`diùC»©e
(&
İtiÚS‘DiùTy³
,
NULL
);

1661 
¡©e
->
numlšes
 = 0;

1662 
¡©e
->
lšes
 = 
NULL
;

1663 
¡©e
->
has_
 = 0;

1664 ià(
å
 =ğ
NULL
è 
¡©e
;

1667 
	`fg‘s
(
buf
,
CONFIG_MAX_LINE
+1,
å
è!ğ
NULL
) {

1668 
¬gc
;

1669 
sds
 *
¬gv
;

1670 
sds
 
lše
 = 
	`sd¡rim
(
	`sd¢ew
(
buf
),"\r\n\t ");

1672 
lš’um
++;

1675 ià(
lše
[0] == '#' ||†ine[0] == '\0') {

1676 ià(!
¡©e
->
has_
 && !
	`¡rcmp
(
lše
,
REDIS_CONFIG_REWRITE_SIGNATURE
))

1677 
¡©e
->
has_
 = 1;

1678 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1683 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

1684 ià(
¬gv
 =ğ
NULL
) {

1688 
sds
 
aux
 = 
	`sd¢ew
("# ??? ");

1689 
aux
 = 
	`sdsÿtsds
×ux,
lše
);

1690 
	`sdsä“
(
lše
);

1691 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
aux
);

1695 
	`sd¡Şow”
(
¬gv
[0]);

1699 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1700 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
¡©e
,
¬gv
[0],
lš’um
);

1702 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1704 
	`fşo£
(
å
);

1705  
¡©e
;

1706 
	}
}

1712 
	$»wr™eCÚfigM¬kAsProûs£d
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
) {

1713 
sds
 
İt
 = 
	`sd¢ew
(
İtiÚ
);

1715 ià(
	`diùAdd
(
¡©e
->
»wr™‹n
,
İt
,
NULL
è!ğ
DICT_OK
è
	`sdsä“
(opt);

1716 
	}
}

1734 
	$»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
, 
sds
 
lše
, 
fÜû
) {

1735 
sds
 
o
 = 
	`sd¢ew
(
İtiÚ
);

1736 
dli¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
o
);

1738 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1740 ià(!
l
 && !
fÜû
) {

1742 
	`sdsä“
(
lše
);

1743 
	`sdsä“
(
o
);

1747 ià(
l
) {

1748 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
l
);

1749 
lš’um
 = (è
Ê
->
v®ue
;

1753 
	`dli¡D–Node
(
l
,
Ê
);

1754 ià(
	`dli¡L’gth
(
l
è=ğ0è
	`diùD–‘e
(
¡©e
->
İtiÚ_to_lše
,
o
);

1755 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1756 
¡©e
->
lšes
[
lš’um
] = 
lše
;

1759 ià(!
¡©e
->
has_
) {

1760 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,

1761 
	`sd¢ew
(
REDIS_CONFIG_REWRITE_SIGNATURE
));

1762 
¡©e
->
has_
 = 1;

1764 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1766 
	`sdsä“
(
o
);

1767 
	}
}

1770 
	$»wr™eCÚfigR–—£S‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1771 
	`sdsä“¥l™»s
(
¡©e
->
lšes
,¡©e->
numlšes
);

1772 
	`diùR–—£
(
¡©e
->
İtiÚ_to_lše
);

1773 
	`diùR–—£
(
¡©e
->
»wr™‹n
);

1774 
	`dä“
(
¡©e
);

1775 
	}
}

1785 
	$»wr™eCÚfigRemoveO½hªed
(
»wr™eCÚfigS‹
 *
¡©e
) {

1786 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
¡©e
->
İtiÚ_to_lše
);

1787 
diùEÁry
 *
de
;

1789 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1790 
dli¡
 *
l
 = 
	`diùG‘V®
(
de
);

1791 
sds
 
İtiÚ
 = 
	`diùG‘Key
(
de
);

1795 ià(
	`diùFšd
(
¡©e
->
»wr™‹n
,
İtiÚ
è=ğ
NULL
) {

1796 
	`log_debug
(
LOG_DEBUG
,"NÙ„ewr™‹ÀİtiÚ: %s", 
İtiÚ
);

1800 
	`dli¡L’gth
(
l
)) {

1801 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
l
);

1802 
lš’um
 = (è
Ê
->
v®ue
;

1804 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1805 
¡©e
->
lšes
[
lš’um
] = 
	`sd£m±y
();

1806 
	`dli¡D–Node
(
l
,
Ê
);

1809 
	`diùR–—£I‹¿tÜ
(
di
);

1810 
	}
}

1814 
sds
 
	$»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1815 
sds
 
cÚ‹Á
 = 
	`sd£m±y
();

1816 
j
, 
was_em±y
 = 0;

1818 
j
 = 0; j < 
¡©e
->
numlšes
; j++) {

1820 ià(
	`sd¦’
(
¡©e
->
lšes
[
j
]) == 0) {

1821 ià(
was_em±y
) ;

1822 
was_em±y
 = 1;

1824 
was_em±y
 = 0;

1826 
cÚ‹Á
 = 
	`sdsÿtsds
(cÚ‹Á,
¡©e
->
lšes
[
j
]);

1827 
cÚ‹Á
 = 
	`sdsÿ’
(content,"\n",1);

1829  
cÚ‹Á
;

1830 
	}
}

1844 
	$»wr™eCÚfigOv”wr™eFe
(*
cÚfigfe
, 
sds
 
cÚ‹Á
) {

1845 
»tv®
 = 0;

1846 
fd
 = 
	`İ’
(
cÚfigfe
,
O_RDWR
|
O_CREAT
,0644);

1847 
cÚ‹Á_size
 = 
	`sd¦’
(
cÚ‹Á
), 
·ddšg
 = 0;

1848 
¡©
 
sb
;

1849 
sds
 
cÚ‹Á_·dded
;

1853 ià(
fd
 == -1)  -1;

1854 ià(
	`f¡©
(
fd
,&
sb
) == -1) {

1855 
	`şo£
(
fd
);

1860 
cÚ‹Á_·dded
 = 
	`sdsdup
(
cÚ‹Á
);

1861 ià(
cÚ‹Á_size
 < 
sb
.
¡_size
) {

1864 
·ddšg
 = 
sb
.
¡_size
 - 
cÚ‹Á_size
;

1865 
cÚ‹Á_·dded
 = 
	`sdsgrowz”o
(cÚ‹Á_·dded,
sb
.
¡_size
);

1866 
cÚ‹Á_·dded
[
cÚ‹Á_size
] = '\n';

1867 
	`mem£t
(
cÚ‹Á_·dded
+
cÚ‹Á_size
+1,'#',
·ddšg
-1);

1871 ià(
	`wr™e
(
fd
,
cÚ‹Á_·dded
,
	`¡¾’
(content_padded)) == -1) {

1872 
»tv®
 = -1;

1873 
ş—nup
;

1877 ià(
·ddšg
) {

1878 ià(
	`árunÿ‹
(
fd
,
cÚ‹Á_size
) == -1) {

1883 
ş—nup
:

1884 
	`sdsä“
(
cÚ‹Á_·dded
);

1885 
	`şo£
(
fd
);

1886  
»tv®
;

1887 
	}
}

1890 
	$»wr™eCÚfigIÁO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
defv®ue
) {

1891 
v®ue
;

1892 
fÜû
;

1893 
sds
 
lše
;

1895 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1896 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %d",
İtiÚ
,
v®ue
);

1897 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1899 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1900 
	}
}

1903 
	$»wr™eCÚfigSdsO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
sds
 
defv®ue
) {

1904 
sds
 
v®ue
;

1905 
fÜû
;

1906 
sds
 
lše
;

1908 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1909 ià(
defv®ue
 =ğ
NULL
 && 
v®ue
 == NULL) {

1910 
fÜû
 = 0;

1911 } ià(
defv®ue
 !ğ
NULL
 && 
v®ue
 !ğNULL && !
	`sdscmp
(value,defvalue)) {

1912 
fÜû
 = 0;

1914 
fÜû
 = 1;

1917 ià(
v®ue
 =ğ
NULL
) {

1918 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% \"\"",
İtiÚ
);

1920 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
v®ue
);

1921 
	`sdsä“
(
v®ue
);

1924 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1925 
	}
}

1928 
	$»wr™eCÚfigLÚgLÚgO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
defv®ue
) {

1929 
v®ue
;

1930 
fÜû
;

1931 
sds
 
lše
;

1933 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1934 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %Îd",
İtiÚ
,
v®ue
);

1935 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1937 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1938 
	}
}

1942 
	$»wr™eCÚfigFÜm©MemÜy
(*
buf
, 
size_t
 
Ën
, 
by‹s
) {

1943 
gb
 = 1024*1024*1024;

1944 
mb
 = 1024*1024;

1945 
kb
 = 1024;

1947 ià(
by‹s
 && (by‹ % 
gb
) == 0) {

1948  
	`¢´štf
(
buf
,
Ën
,"%Îdgb",
by‹s
/
gb
);

1949 } ià(
by‹s
 && (by‹ % 
mb
) == 0) {

1950  
	`¢´štf
(
buf
,
Ën
,"%Îdmb",
by‹s
/
mb
);

1951 } ià(
by‹s
 && (by‹ % 
kb
) == 0) {

1952  
	`¢´štf
(
buf
,
Ën
,"%Îdkb",
by‹s
/
kb
);

1954  
	`¢´štf
(
buf
,
Ën
,"%Îd",
by‹s
);

1956 
	}
}

1959 
	$»wr™eCÚfigBy‹sO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
defv®ue
) {

1960 
v®ue
;

1961 
buf
[64];

1962 
fÜû
;

1963 
sds
 
lše
;

1965 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1966 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1968 
	`»wr™eCÚfigFÜm©MemÜy
(
buf
,(buf),
v®ue
);

1969 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
buf
);

1970 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1971 
	}
}

1976 
	$»wr™eCÚfigEnumO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
cÚfigEnumG‘SŒFun
 
fun
, 
defv®
) {

1977 
v®ue
;

1978 
sds
 
lše
;

1979 cÚ¡ *
Çme
;

1980 
fÜû
;

1982 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1983 
fÜû
 = 
v®ue
 !ğ
defv®
;

1984 
Çme
 = 
	`fun
(
v®ue
);

1985 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

1986 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1987 
	}
}

1990 
	$»wr™eCÚfigBšdO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1991 
d¬¿y
 
v®ues
;

1992 
sds
 *
v®ue
, 
lše
;

1993 
fÜû
 = 1;

1994 *
İtiÚ
 = 
CONFIG_SOPN_BIND
;

1996 
	`d¬¿y_š™
(&
v®ues
,1,(
sds
));

1997 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ues
);

1999 ià(
	`d¬¿y_n
(&
v®ues
) == 0) {

2000 
	`d¬¿y_deš™
(&
v®ues
);

2001 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

2006 
lše
 = 
	`sd¢ew
(
İtiÚ
);

2007 
	`d¬¿y_n
(&
v®ues
) > 0) {

2008 
lše
 = 
	`sdsÿt
(line," ");

2009 
v®ue
 = 
	`d¬¿y_pİ
(&
v®ues
);

2010 
lše
 = 
	`sdsÿtsds
Öše,*
v®ue
);

2011 
	`sdsä“
(*
v®ue
);

2013 
	`d¬¿y_deš™
(&
v®ues
);

2015 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2016 
	}
}

2019 
	$»wr™eCÚfigCommªdsNAPO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

2020 
d¬¿y
 
v®ues
;

2021 
sds
 *
v®ue
, 
lše
;

2022 
fÜû
 = 1;

2023 *
İtiÚ
 = 
CONFIG_SOPN_COMMANDSNAP
;

2025 
	`d¬¿y_š™
(&
v®ues
,1,(
sds
));

2026 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ues
);

2028 ià(
	`d¬¿y_n
(&
v®ues
) == 0) {

2029 
	`d¬¿y_deš™
(&
v®ues
);

2030 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

2034 
	`d¬¿y_n
(&
v®ues
) > 0) {

2035 
v®ue
 = 
	`d¬¿y_pİ
(&
v®ues
);

2036 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,*
v®ue
);

2037 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2038 
	`sdsä“
(*
v®ue
);

2040 
	`d¬¿y_deš™
(&
v®ues
);

2041 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

2042 
	}
}

2052 
	$»wr™eCÚfig
(*
·th
) {

2053 
»wr™eCÚfigS‹
 *
¡©e
;

2054 
sds
 
ÃwcÚ‹Á
;

2055 
»tv®
;

2056 
cÚf_İtiÚ
 *
cİ
;

2058 
	`CONFF_LOCK
();

2060 ià((
¡©e
 = 
	`»wr™eCÚfigR—dOldFe
(
·th
)è=ğ
NULL
) {

2061 
	`CONFF_UNLOCK
();

2067 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_DATABASES
,
CONFIG_DEFAULT_LOGICAL_DBNUM
);

2068 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_IDPDATABASE
,
CONFIG_DEFAULT_INTERNAL_DBNUM
);

2069 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXMEMORY
,
CONFIG_DEFAULT_MAXMEMORY
);

2070 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXMEMORYP
,
g‘_eviùpŞicy_¡ršgs
,
CONFIG_DEFAULT_MAXMEMORY_POLICY
);

2071 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXMEMORYS
,
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
);

2072 
	`»wr™eCÚfigLÚgLÚgO±iÚ
(
¡©e
,
CONFIG_SOPN_MTCLIMIT
,
CONFIG_DEFAULT_MAX_TIME_COMPLEXITY_LIMIT
);

2073 
	`»wr™eCÚfigBšdO±iÚ
(
¡©e
);

2074 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_PORT
,
CONFIG_DEFAULT_SERVER_PORT
);

2075 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_THREADS
,
CONFIG_DEFAULT_THREADS_NUM
);

2076 
	`»wr™eCÚfigLÚgLÚgO±iÚ
(
¡©e
,
CONFIG_SOPN_SLOWLOGLST
,
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
);

2077 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_SLOWLOGML
,
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
);

2078 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXCLIENTS
,
CONFIG_DEFAULT_MAX_CLIENTS
);

2079 
	`»wr™eCÚfigSdsO±iÚ
(
¡©e
,
CONFIG_SOPN_REQUIREPASS
,
NULL
);

2080 
	`»wr™eCÚfigSdsO±iÚ
(
¡©e
,
CONFIG_SOPN_ADMINPASS
,
NULL
);

2081 
	`»wr™eCÚfigCommªdsNAPO±iÚ
(
¡©e
);

2086 
	`»wr™eCÚfigRemoveO½hªed
(
¡©e
);

2090 
ÃwcÚ‹Á
 = 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
¡©e
);

2091 
»tv®
 = 
	`»wr™eCÚfigOv”wr™eFe
(
£rv”
.
cÚfigfe
,
ÃwcÚ‹Á
);

2092 
	`CONFF_UNLOCK
();

2094 
	`sdsä“
(
ÃwcÚ‹Á
);

2095 
	`»wr™eCÚfigR–—£S‹
(
¡©e
);

2096  
»tv®
;

2097 
	}
}

2103 
	$cÚfigCommªd
(
ş›Á
 *
c
) {

2105 ià(
£rv”
.
lßdšg
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2106 
	`addR•lyE¼Ü
(
c
,"Only CONFIG GET is‡llowed during†oading");

2110 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

2111 ià(
c
->
¬gc
 !ğ4è
bad¬™y
;

2112 
	`cÚfigS‘Commªd
(
c
);

2113 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2114 ià(
c
->
¬gc
 !ğ3è
bad¬™y
;

2115 
	`cÚfigG‘Commªd
(
c
);

2121  ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"rewrite")) {

2122 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

2123 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

2124 
	`addR•lyE¼Ü
(
c
,"The server is„unning without‡ config file");

2127 ià(
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
) == -1) {

2128 
	`log_w¬n
("CONFIG REWRITE faed: %s", 
	`¡»¼Ü
(
”ºo
));

2129 
	`addR•lyE¼ÜFÜm©
(
c
,"Rewr™šg cÚfig fe: %s", 
	`¡»¼Ü
(
”ºo
));

2131 
	`log_w¬n
("CONFIG REWRITEƒxecuted with success.");

2132 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2135 
	`addR•lyE¼Ü
(
c
,

2141 
bad¬™y
:

2142 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for CONFIG %s",

2143 (*è
c
->
¬gv
[1]->
±r
);

2144 
	}
}

2147 
	$cÚf_ÿche_š™
(
cÚf_ÿche
 *
cc
)

2149 
cc
->
ÿche_v”siÚ
 = 0;

2150 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
cc
->
maxş›Ás
);

2151 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_REQUIREPASS
,&
cc
->
»quœ•ass
);

2152 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_ADMINPASS
,&
cc
->
admš·ss
);

2153 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
cc
->
maxmemÜy
);

2154 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MTCLIMIT
,&
cc
->
max_time_com¶ex™y_lim™
);

2155 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_SLOWLOGLST
,&
cc
->
¦owlog_log_¦ow”_thª
);

2157  
VR_OK
;

2158 
	}
}

2161 
	$cÚf_ÿche_deš™
(
cÚf_ÿche
 *
cc
)

2163 
cc
->
ÿche_v”siÚ
 = 0;

2164 ià(
cc
->
»quœ•ass
 !ğ
NULL
) {

2165 
	`sdsä“
(
cc
->
»quœ•ass
);

2166 
cc
->
»quœ•ass
 = 
NULL
;

2168 ià(
cc
->
admš·ss
 !ğ
NULL
) {

2169 
	`sdsä“
(
cc
->
admš·ss
);

2170 
cc
->
admš·ss
 = 
NULL
;

2173  
VR_OK
;

2174 
	}
}

2177 
	$cÚf_ÿche_upd©e
(
cÚf_ÿche
 *
cc
)

2179 
cv”siÚ
 = 
	`cÚf_v”siÚ_g‘
();

2182 ià(
cv”siÚ
 <ğ
cc
->
ÿche_v”siÚ
) {

2186 ià(
cc
->
»quœ•ass
 !ğ
NULL
) {

2187 
	`sdsä“
(
cc
->
»quœ•ass
);

2188 
cc
->
»quœ•ass
 = 
NULL
;

2190 ià(
cc
->
admš·ss
 !ğ
NULL
) {

2191 
	`sdsä“
(
cc
->
admš·ss
);

2192 
cc
->
admš·ss
 = 
NULL
;

2195 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
cc
->
maxş›Ás
);

2196 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_REQUIREPASS
,&
cc
->
»quœ•ass
);

2197 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_ADMINPASS
,&
cc
->
admš·ss
);

2198 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
cc
->
maxmemÜy
);

2199 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MTCLIMIT
,&
cc
->
max_time_com¶ex™y_lim™
);

2200 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_SLOWLOGLST
,&
cc
->
¦owlog_log_¦ow”_thª
);

2202 
cc
->
ÿche_v”siÚ
 = 
cv”siÚ
;

2204  
VR_OK
;

2205 
	}
}

	@src/vr_conf.h

1 #iâdeà
_VR_CONF_H_


2 
	#_VR_CONF_H_


	)

5 
	#CONFIG_SOPN_DATABASES
 "d©aba£s"

	)

6 
	#CONFIG_SOPN_IDPDATABASE
 "š‹º®-dbs-³r-d©aba£s"

	)

7 
	#CONFIG_SOPN_MAXMEMORY
 "maxmemÜy"

	)

8 
	#CONFIG_SOPN_MAXMEMORYP
 "maxmemÜy-pŞicy"

	)

9 
	#CONFIG_SOPN_MAXMEMORYS
 "maxmemÜy-§m¶es"

	)

10 
	#CONFIG_SOPN_MTCLIMIT
 "max-time-com¶ex™y-lim™"

	)

11 
	#CONFIG_SOPN_BIND
 "bšd"

	)

12 
	#CONFIG_SOPN_PORT
 "pÜt"

	)

13 
	#CONFIG_SOPN_THREADS
 "th»ads"

	)

14 
	#CONFIG_SOPN_DIR
 "dœ"

	)

15 
	#CONFIG_SOPN_MAXCLIENTS
 "maxş›Ás"

	)

16 
	#CONFIG_SOPN_SLOWLOGLST
 "¦owlog-log-¦ow”-thª"

	)

17 
	#CONFIG_SOPN_SLOWLOGML
 "¦owlog-max-Ën"

	)

18 
	#CONFIG_SOPN_REQUIREPASS
 "»quœ•ass"

	)

19 
	#CONFIG_SOPN_ADMINPASS
 "admš·ss"

	)

20 
	#CONFIG_SOPN_COMMANDSNAP
 "commªds-Ãed-admš·ss"

	)

22 
	#CONFIG_RUN_ID_SIZE
 40

	)

23 
	#CONFIG_DEFAULT_ACTIVE_REHASHING
 1

	)

25 
	#CONFIG_DEFAULT_LOGICAL_DBNUM
 6

	)

26 
	#CONFIG_DEFAULT_INTERNAL_DBNUM
 6

	)

28 
	#CONFIG_DEFAULT_MAXMEMORY
 0

	)

29 
	#CONFIG_DEFAULT_MAXMEMORY_SAMPLES
 5

	)

30 
	#CONFIG_DEFAULT_MAX_CLIENTS
 10000

	)

32 
	#CONFIG_DEFAULT_MAX_CLIENTS
 10000

	)

34 
	#CONFIG_DEFAULT_THREADS_NUM
 (
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>6?6:syscÚf(_SC_NPROCESSORS_ONLN))

	)

36 
	#CONFIG_DEFAULT_HOST
 "0.0.0.0"

	)

38 
	#CONFIG_DEFAULT_SERVER_PORT
 55555

	)

40 
	#CONFIG_DEFAULT_DATA_DIR
 "vœed©a"

	)

42 
	#CONFIG_DEFAULT_MAX_TIME_COMPLEXITY_LIMIT
 0

	)

44 
	#CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
 10000

	)

45 
	#CONFIG_DEFAULT_SLOWLOG_MAX_LEN
 128

	)

47 
	#CONFIG_AUTHPASS_MAX_LEN
 512

	)

49 
	#CONFIG_BINDADDR_MAX
 16

	)

51 
	#CONF_UNSET_NUM
 -1

	)

52 
	#CONF_UNSET_PTR
 
NULL


	)

53 
	#CONF_UNSET_GROUP
 (
group_ty³_t
è-1

	)

54 
	#CONF_UNSET_HASH
 (
hash_ty³_t
è-1

	)

55 
	#CONF_UNSET_DIST
 (
di¡_ty³_t
è-1

	)

58 
	#CONF_FIELD_TYPE_INT
 0

	)

59 
	#CONF_FIELD_TYPE_LONGLONG
 1

	)

60 
	#CONF_FIELD_TYPE_SDS
 2

	)

61 
	#CONF_FIELD_TYPE_ARRAYSDS
 3

	)

64 
	#CONF_FIELD_FLAGS_NO_MODIFY
 (1<<0)

	)

66 
	scÚf_İtiÚ
 {

67 *
	mÇme
;

68 
	mty³
;

69 
	mæags
;

70 (*
	m£t
)(*
	mcf
, 
cÚf_İtiÚ
 *
	mİt
, *
	md©a
);

71 (*
	mg‘
)(*
	mcf
, 
cÚf_İtiÚ
 *
	mİt
, *
	md©a
);

72 
	moff£t
;

73 }
	tcÚf_İtiÚ
;

75 
	#EVICTPOLICY_CODEC
(
ACTION
) \

76 
	`ACTION
Ğ
MAXMEMORY_VOLATILE_LRU
, vŞ©e-
Ìu
) \

77 
	`ACTION
Ğ
MAXMEMORY_VOLATILE_RANDOM
, vŞ©e-
¿ndom
) \

78 
	`ACTION
Ğ
MAXMEMORY_VOLATILE_TTL
, vŞ©e-
‰l
) \

79 
	`ACTION
Ğ
MAXMEMORY_ALLKEYS_LRU
, 
®lkeys
-
Ìu
) \

80 
	`ACTION
Ğ
MAXMEMORY_ALLKEYS_RANDOM
, 
®lkeys
-
¿ndom
) \

81 
	`ACTION
Ğ
MAXMEMORY_NO_EVICTION
, 
nÛviùiÚ
) \

82 

	)

83 
	#DEFINE_ACTION
(
_pŞicy
, 
_Çme
è_pŞicy,

	)

84 
	eeviùpŞicy_ty³
 {

85 
EVICTPOLICY_CODEC
Ğ
DEFINE_ACTION
 )

86 
	mEVICTPOLICY_SENTINEL


87 } 
	teviùpŞicy_ty³_t
;

88 #undeà
DEFINE_ACTION


90 
	scÚf_£rv”
 {

91 
diù
 *
	mùabË
;

93 
	md©aba£s
;

94 
	mš‹º®_dbs_³r_d©aba£s
;

97 
	mmax_time_com¶ex™y_lim™
;

98 
	mmaxmemÜy
;

99 
	mmaxmemÜy_pŞicy
;

100 
	mmaxmemÜy_§m¶es
;

101 
	mmaxş›Ás
;

103 
	mth»ads
;

105 
d¬¿y
 
	mbšds
;

106 
	mpÜt
;

108 
sds
 
	mdœ
;

110 
	m¦owlog_log_¦ow”_thª
;

111 
	m¦owlog_max_Ën
;

113 
sds
 
	m»quœ•ass
;

114 
sds
 
	madmš·ss
;

115 
d¬¿y
 
	mcommªds_Ãed_admš·ss
;

116 } 
	tcÚf_£rv”
;

118 
	svr_cÚf
 {

119 
sds
 
	mâame
;

121 
diù
 *
	mÜgªiz©iÚs
;

123 
cÚf_£rv”
 
	mc£rv”
;

125 
	mv”siÚ
;

126 
±h»ad_rwlock_t
 
	mrwl
;

127 
±h»ad_mu‹x_t
 
	mæock
;

128 }
	tvr_cÚf
;

130 
	#CONF_VALUE_TYPE_UNKNOW
 0

	)

131 
	#CONF_VALUE_TYPE_STRING
 1

	)

132 
	#CONF_VALUE_TYPE_ARRAY
 2

	)

134 
	scÚf_v®ue
{

135 
	mty³
;

136 *
	mv®ue
;

137 }
	tcÚf_v®ue
;

141 
	scÚf_ÿche
 {

142 
	mÿche_v”siÚ
;

144 
	mmaxş›Ás
;

145 
sds
 
	m»quœ•ass
;

146 
sds
 
	madmš·ss
;

147 
	mmaxmemÜy
;

148 
	mmax_time_com¶ex™y_lim™
;

149 
	m¦owlog_log_¦ow”_thª
;

150 }
	tcÚf_ÿche
;

152 
vr_cÚf
 *
cÚf
;

153 
cÚf_£rv”
 *
c£rv”
;

155 
cÚf_v®ue
 *
cÚf_v®ue_ü—‹
(
ty³
);

156 
cÚf_v®ue_de¡roy
(
cÚf_v®ue
 *
cv
);

158 
vr_cÚf
 *
cÚf_ü—‹
(*
f’ame
);

159 
cÚf_de¡roy
(
vr_cÚf
 *
cf
);

161 
cÚf_v”siÚ_g‘
();

163 
cÚf_£rv”_g‘
(cÚ¡ *
İtiÚ_Çme
, *
v®ue
);

164 
cÚf_£rv”_£t
(cÚ¡ *
İtiÚ_Çme
, 
cÚf_v®ue
 *
v®ue
);

166 
cÚf_£t_maxmemÜy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

167 
cÚf_£t_maxmemÜy_pŞicy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

168 
cÚf_£t_št_nÚ_z”o
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

170 
cÚf_g‘_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

171 
cÚf_g‘_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

172 
cÚf_g‘_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

173 
cÚf_g‘_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

175 
cÚf_£t_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

176 
cÚf_£t_·sswÜd
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

177 
cÚf_£t_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

178 
cÚf_£t_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

179 
cÚf_£t_yesÜno
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

180 
cÚf_£t_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

181 
cÚf_£t_commªds_Ãed_admš·ss
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

183 
CONF_RLOCK
();

184 
CONF_WLOCK
();

185 
CONF_UNLOCK
();

187 
CONFF_LOCK
();

188 
CONFF_UNLOCK
();

190 cÚ¡ *
g‘_eviùpŞicy_¡ršgs
(
eviùpŞicy_ty³
);

192 
cÚfigCommªd
(
ş›Á
 *
c
);

194 
cÚf_ÿche_š™
(
cÚf_ÿche
 *
cc
);

195 
cÚf_ÿche_deš™
(
cÚf_ÿche
 *
cc
);

196 
cÚf_ÿche_upd©e
(
cÚf_ÿche
 *
cc
);

	@src/vr_connection.c

1 
	~<sys/uio.h
>

3 
	~<vr_cÜe.h
>

5 
cÚn_ä“
(
cÚn
 *conn);

7 
cÚn
 *

8 
	$_cÚn_g‘
(
cÚn_ba£
 *
cb
)

10 
cÚn
 *conn;

12 ià(
cb
 !ğ
NULL
 && 
	`dli¡L’gth
(cb->
ä“_cÚnq
) > 0) {

13 
cÚn
 = 
	`dli¡Pİ
(
cb
->
ä“_cÚnq
);

15 
cÚn
 = 
	`d®loc
((*conn));

16 ià(
cÚn
 =ğ
NULL
) {

17  
NULL
;

19 
cÚn
->
cb
 = cb;

21 
cÚn
->
šqueue
 = 
NULL
;

22 
cÚn
->
outqueue
 = 
NULL
;

25 
cÚn
->
owÃr
 = 
NULL
;

27 
cÚn
->
sd
 = -1;

29 
cÚn
->
£nd_by‹s
 = 0;

30 
cÚn
->
»cv_by‹s
 = 0;

32 
cÚn
->
”r
 = 0;

33 
cÚn
->
»cv_aùive
 = 0;

34 
cÚn
->
»cv_»ady
 = 0;

35 
cÚn
->
£nd_aùive
 = 0;

36 
cÚn
->
£nd_»ady
 = 0;

38 
cÚn
->
cÚÃùšg
 = 0;

39 
cÚn
->
cÚÃùed
 = 0;

40 
cÚn
->
eof
 = 0;

41 
cÚn
->
dÚe
 = 0;

43 ià(
cÚn
->
šqueue
 =ğ
NULL
) {

44 
cÚn
->
šqueue
 = 
	`dli¡C»©e
();

45 ià(
cÚn
->
šqueue
 =ğ
NULL
) {

46 
	`cÚn_ä“
(
cÚn
);

47  
NULL
;

51 ià(
cÚn
->
outqueue
 =ğ
NULL
) {

52 
cÚn
->
outqueue
 = 
	`dli¡C»©e
();

53 ià(
cÚn
->
outqueue
 =ğ
NULL
) {

54 
	`cÚn_ä“
(
cÚn
);

55  
NULL
;

59 ià(
cb
 !ğ
NULL
) {

60 
cb
->
ÁÙ®_cÚn
++;

61 
cb
->
ncu¼_cÚn
++;

64  
cÚn
;

65 
	}
}

67 
cÚn
 *

68 
	$cÚn_g‘
(
cÚn_ba£
 *
cb
)

70 
cÚn
 *conn;

72 
cÚn
 = 
	`_cÚn_g‘
(
cb
);

73 ià(
cÚn
 =ğ
NULL
) {

74  
NULL
;

77 
	`log_debug
(
LOG_VVERB
, "g‘ cÚÀ%°ş›Á %d", 
cÚn
, cÚn->
sd
);

79  
cÚn
;

80 
	}
}

83 
	$cÚn_ä“
(
cÚn
 *conn)

85 
	`log_debug
(
LOG_VVERB
, "ä“ cÚÀ%p", 
cÚn
);

87 ià(
cÚn
 =ğ
NULL
) {

91 ià(
cÚn
->
sd
 > 0) {

92 
	`şo£
(
cÚn
->
sd
);

93 
cÚn
->
sd
 = -1;

94 
	`upd©e_cu¼_ş›Ás_sub
(1);

97 ià(
cÚn
->
šqueue
) {

98 
sds
 
buf
;

99 
buf
 = 
	`dli¡Pİ
(
cÚn
->
šqueue
)) {

100 
	`sdsä“
(
buf
);

102 
	`dli¡R–—£
(
cÚn
->
šqueue
);

103 
cÚn
->
šqueue
 = 
NULL
;

106 ià(
cÚn
->
outqueue
) {

107 
sds
 
buf
;

108 
buf
 = 
	`dli¡Pİ
(
cÚn
->
outqueue
)) {

109 
	`sdsä“
(
buf
);

111 
	`dli¡R–—£
(
cÚn
->
outqueue
);

112 
cÚn
->
outqueue
 = 
NULL
;

115 
	`dä“
(
cÚn
);

116 
	}
}

119 
	$cÚn_put
(
cÚn
 *conn)

121 
cÚn_ba£
 *
cb
 = 
cÚn
->cb;

123 
	`ASSERT
(
cÚn
->
owÃr
 =ğ
NULL
);

125 
	`log_debug
(
LOG_VVERB
, "puˆcÚÀ%p", 
cÚn
);

127 ià(
cÚn
->
sd
 > 0) {

128 
	`şo£
(
cÚn
->
sd
);

129 
cÚn
->
sd
 = -1;

130 
	`upd©e_cu¼_ş›Ás_sub
(1);

133 ià(
cb
 =ğ
NULL
) {

134 
	`cÚn_ä“
(
cÚn
);

138 ià(
cÚn
->
šqueue
) {

139 
sds
 
buf
;

140 
buf
 = 
	`dli¡Pİ
(
cÚn
->
šqueue
)) {

141 
	`sdsä“
(
buf
);

145 ià(
cÚn
->
outqueue
) {

146 
sds
 
buf
;

147 
buf
 = 
	`dli¡Pİ
(
cÚn
->
outqueue
)) {

148 
	`sdsä“
(
buf
);

152 
	`dli¡Push
(
cb
->
ä“_cÚnq
, 
cÚn
);

153 
cb
->
ncu¼_ccÚn
--;

154 
cb
->
ncu¼_cÚn
--;

155 
	}
}

158 
	$cÚn_š™
(
cÚn_ba£
 *
cb
)

160 
	`log_debug
(
LOG_DEBUG
, "cÚÀsiz%d", (
cÚn
));

162 
cb
->
ä“_cÚnq
 = 
NULL
;

163 
cb
->
ÁÙ®_cÚn
 = 0;

164 
cb
->
ncu¼_ccÚn
 = 0;

165 
cb
->
ncu¼_ccÚn
 = 0;

167 
cb
->
ä“_cÚnq
 = 
	`dli¡C»©e
();

168 ià(
cb
->
ä“_cÚnq
 =ğ
NULL
) {

169  
VR_ENOMEM
;

172  
VR_OK
;

173 
	}
}

176 
	$cÚn_deš™
(
cÚn_ba£
 *
cb
)

178 
cÚn
 *conn;

180 ià(
cb
->
ä“_cÚnq
) {

181 
cÚn
 = 
	`dli¡Pİ
(
cb
->
ä“_cÚnq
)) {

182 
	`cÚn_ä“
(
cÚn
);

184 
	`ASSERT
(
	`dli¡L’gth
(
cb
->
ä“_cÚnq
) == 0);

185 
	`dli¡R–—£
(
cb
->
ä“_cÚnq
);

187 
	}
}

189 
ssize_t


190 
	$cÚn_»cv
(
cÚn
 *cÚn, *
buf
, 
size_t
 
size
)

192 
ssize_t
 
n
;

194 
	`ASSERT
(
buf
 !ğ
NULL
);

195 
	`ASSERT
(
size
 > 0);

196 
	`ASSERT
(
cÚn
->
»cv_»ady
);

199 
n
 = 
	`vr_»ad
(
cÚn
->
sd
, 
buf
, 
size
);

201 
	`log_debug
(
LOG_VERB
, "»cv oÀsd %d %zd oà%zu", 
cÚn
->
sd
, 
n
, 
size
);

203 ià(
n
 > 0) {

204 ià(
n
 < (
ssize_t
è
size
) {

205 
cÚn
->
»cv_»ady
 = 0;

207 
cÚn
->
»cv_by‹s
 +ğ(
size_t
)
n
;

208  
n
;

211 ià(
n
 == 0) {

212 
cÚn
->
»cv_»ady
 = 0;

213 
cÚn
->
eof
 = 1;

214 
	`log_debug
(
LOG_INFO
, "»cv oÀsd %dƒoàrb %zu sb %zu", 
cÚn
->
sd
,

215 
cÚn
->
»cv_by‹s
, cÚn->
£nd_by‹s
);

216  
n
;

219 ià(
”ºo
 =ğ
EINTR
) {

220 
	`log_debug
(
LOG_VERB
, "»cv oÀsd %d‚Ù„—dy -ƒšŒ", 
cÚn
->
sd
);

222 } ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

223 
cÚn
->
»cv_»ady
 = 0;

224 
	`log_debug
(
LOG_VERB
, "»cv oÀsd %d‚Ù„—dy -ƒagaš", 
cÚn
->
sd
);

225  
VR_EAGAIN
;

227 
cÚn
->
»cv_»ady
 = 0;

228 
cÚn
->
”r
 = 
”ºo
;

229 
	`log_”rÜ
("»cv oÀsd %d faed: %s", 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

230  
VR_ERROR
;

234 
	`NOT_REACHED
();

236  
VR_ERROR
;

237 
	}
}

239 
ssize_t


240 
	$cÚn_£nd
(
cÚn
 *cÚn, *
buf
, 
size_t
 
n£nd
)

242 
ssize_t
 
n
;

244 
	`ASSERT
(
n£nd
 != 0);

245 
	`ASSERT
(
cÚn
->
£nd_»ady
);

248 
n
 = 
	`vr_wr™e
(
cÚn
->
sd
, 
buf
, 
n£nd
);

250 
	`log_debug
(
LOG_VERB
, "send on sd %d %zd of %zu",

251 
cÚn
->
sd
, 
n
, 
n£nd
);

253 ià(
n
 > 0) {

254 ià(
n
 < (
ssize_t
è
n£nd
) {

255 
cÚn
->
£nd_»ady
 = 0;

257 
cÚn
->
£nd_by‹s
 +ğ(
size_t
)
n
;

258  
n
;

261 ià(
n
 == 0) {

262 
	`log_w¬n
("£nd oÀsd %d„‘uºed z”o", 
cÚn
->
sd
);

263 
cÚn
->
£nd_»ady
 = 0;

267 ià(
”ºo
 =ğ
EINTR
) {

268 
	`log_debug
(
LOG_VERB
, "£nd oÀsd %d‚Ù„—dy -ƒšŒ", 
cÚn
->
sd
);

270 } ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

271 
cÚn
->
£nd_»ady
 = 0;

272 
	`log_debug
(
LOG_VERB
, "£nd oÀsd %d‚Ù„—dy -ƒagaš", 
cÚn
->
sd
);

273  
VR_EAGAIN
;

275 
cÚn
->
£nd_»ady
 = 0;

276 
cÚn
->
”r
 = 
”ºo
;

277 
	`log_”rÜ
("£nd oÀsd %d faed: %s", 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

278  
VR_ERROR
;

282 
	`NOT_REACHED
();

284  
VR_ERROR
;

285 
	}
}

287 
ssize_t


288 
	$cÚn_£ndv
(
cÚn
 *cÚn, 
d¬¿y
 *
£ndv
, 
size_t
 
n£nd
)

290 
ssize_t
 
n
;

292 
	`ASSERT
(
	`d¬¿y_n
(
£ndv
) > 0);

293 
	`ASSERT
(
n£nd
 != 0);

294 
	`ASSERT
(
cÚn
->
£nd_»ady
);

297 
n
 = 
	`vr_wr™ev
(
cÚn
->
sd
, 
£ndv
->
–em
, s’dv->
ÃËm
);

299 
	`log_debug
(
LOG_VERB
, "£ndv oÀsd %d %zd oà%zu iÀ%"
PRIu32
" buffers",

300 
cÚn
->
sd
, 
n
, 
n£nd
, 
£ndv
->
ÃËm
);

302 ià(
n
 > 0) {

303 ià(
n
 < (
ssize_t
è
n£nd
) {

304 
cÚn
->
£nd_»ady
 = 0;

306 
cÚn
->
£nd_by‹s
 +ğ(
size_t
)
n
;

307  
n
;

310 ià(
n
 == 0) {

311 
	`log_w¬n
("£ndv oÀsd %d„‘uºed z”o", 
cÚn
->
sd
);

312 
cÚn
->
£nd_»ady
 = 0;

316 ià(
”ºo
 =ğ
EINTR
) {

317 
	`log_debug
(
LOG_VERB
, "£ndv oÀsd %d‚Ù„—dy -ƒšŒ", 
cÚn
->
sd
);

319 } ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

320 
cÚn
->
£nd_»ady
 = 0;

321 
	`log_debug
(
LOG_VERB
, "£ndv oÀsd %d‚Ù„—dy -ƒagaš", 
cÚn
->
sd
);

322  
VR_EAGAIN
;

324 
cÚn
->
£nd_»ady
 = 0;

325 
cÚn
->
”r
 = 
”ºo
;

326 
	`log_”rÜ
("£ndv oÀsd %d faed: %s", 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

327  
VR_ERROR
;

331 
	`NOT_REACHED
();

333  
VR_ERROR
;

334 
	}
}

	@src/vr_connection.h

1 #iâdeà
_VR_CONNECTION_H_


2 
	#_VR_CONNECTION_H_


	)

4 
	scÚn_ba£
 {

5 
dli¡
 *
	mä“_cÚnq
;

6 
ušt64_t
 
	mÁÙ®_cÚn
;

7 
ušt32_t
 
	mncu¼_cÚn
;

8 
ušt32_t
 
	mncu¼_ccÚn
;

9 }
	tcÚn_ba£
;

11 
	scÚn
 {

12 *
	mowÃr
;

14 
cÚn_ba£
 *
	mcb
;

16 
	msd
;

18 
size_t
 
	m»cv_by‹s
;

19 
size_t
 
	m£nd_by‹s
;

21 
”r_t
 
	m”r
;

22 
	m»cv_aùive
:1;

23 
	m»cv_»ady
:1;

24 
	m£nd_aùive
:1;

25 
	m£nd_»ady
:1;

27 
	mcÚÃùšg
:1;

28 
	mcÚÃùed
:1;

29 
	meof
:1;

30 
	mdÚe
:1;

32 
dli¡
 *
	mšqueue
;

33 
dli¡
 *
	moutqueue
;

36 
cÚn
 *
cÚn_g‘
(
cÚn_ba£
 *
cb
);

37 
cÚn_put
(
cÚn
 *conn);

39 
cÚn_š™
(
cÚn_ba£
 *
cb
);

40 
cÚn_deš™
(
cÚn_ba£
 *
cb
);

42 
ssize_t
 
cÚn_»cv
(
cÚn
 *cÚn, *
buf
, 
size_t
 
size
);

43 
ssize_t
 
cÚn_£nd
(
cÚn
 *cÚn, *
buf
, 
size_t
 
n£nd
);

44 
ssize_t
 
cÚn_£ndv
(
cÚn
 *cÚn, 
d¬¿y
 *
£ndv
, 
size_t
 
n£nd
);

	@src/vr_core.c

1 
	~<¡dlib.h
>

2 
	~<uni¡d.h
>

4 
	~<vr_cÜe.h
>

6 
ušt32_t
 
	g»£rved_fds
 = 0;

	@src/vr_core.h

1 #iâdeà
_VR_CORE_H_


2 
	#_VR_CORE_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	~<d¥ecŸlcÚfig.h
>

10 #ifdeà
HAVE_STATS


11 
	#VR_STATS
 1

	)

13 
	#VR_STATS
 0

	)

16 #ifdeà
HAVE_LITTLE_ENDIAN


17 
	#VR_LITTLE_ENDIAN
 1

	)

20 #ifdeà
HAVE_BACKTRACE


21 
	#VR_HAVE_BACKTRACE
 1

	)

24 #ifdeà
HAVE_SPINLOCK


25 
	#VR_USE_SPINLOCK
 1

	)

28 
	#VR_OK
 0

	)

29 
	#VR_ERROR
 -1

	)

30 
	#VR_EAGAIN
 -2

	)

31 
	#VR_ENOMEM
 -3

	)

34 
	#RESERVED_FDS
 32

	)

36 
	tr¡©us_t
;

37 
	t”r_t
;

39 
	tm¡ime_t
;

41 
	gš¡ªû
;

42 
	gd¬¿y
;

43 
	gcÚn
;

44 
	gş›Á
;

45 
	gş›ÁBufãrLim™sCÚfig
;

46 
	g»disCommªd
;

47 
	gvr_wÜk”
;

49 
	~<¡ddef.h
>

50 
	~<¡dšt.h
>

51 
	~<š‰y³s.h
>

52 
	~<¡ršg.h
>

53 
	~<¡dio.h
>

54 
	~<ùy³.h
>

55 
	~<”ºo.h
>

56 
	~<lim™s.h
>

57 
	~<time.h
>

58 
	~<uni¡d.h
>

59 
	~<±h»ad.h
>

61 
	~<sys/ty³s.h
>

62 
	~<sys/sock‘.h
>

63 
	~<sys/un.h
>

64 
	~<sys/time.h
>

65 
	~<sys/»sourû.h
>

66 
	~<Ãtš‘/š.h
>

68 
	~<«.h
>

69 
	~<sds.h
>

70 
	~<dut.h
>

71 
	~<dlog.h
>

72 
	~<dhashk™.h
>

73 
	~<dm®loc.h
>

74 
	~<d¬¿y.h
>

75 
	~<dli¡.h
>

77 
	~<vr_ut.h
>

78 
	~<vr_sigÇl.h
>

80 
	~<vr_zli¡.h
>

81 
	~<vr_zm­.h
>

82 
	~<vr_diù.h
>

83 
	~<vr_rbŒ“.h
>

84 
	~<vr_št£t.h
>

85 
	~<vr_quickli¡.h
>

87 
	~<vr_lzf.h
>

88 
	~<vr_lzfP.h
>

90 
	~<vr_objeù.h
>

92 
	~<vr_li¡’.h
>

93 
	~<vr_cÚÃùiÚ.h
>

95 
	~<vr_¡©s.h
>

96 
	~<vr_cÚf.h
>

98 
	~<vr_th»ad.h
>

99 
	~<vr_ev’oİ.h
>

100 
	~<vr_ma¡”.h
>

101 
	~<vr_wÜk”.h
>

102 
	~<vr_back’d.h
>

104 
	~<vr_db.h
>

105 
	~<vr_muÉi.h
>

107 
	~<vr_commªd.h
>

108 
	~<vr_block.h
>

109 
	~<vr_ş›Á.h
>

110 
	~<vr_£rv”.h
>

112 
	~<vr_nÙify.h
>

113 
	~<vr_pubsub.h
>

115 
	~<vr_rdb.h
>

116 
	~<vr_aof.h
>

117 
	~<vr_»¶iÿtiÚ.h
>

118 
	~<vr_sütšg.h
>

120 
	~<vr_t_hash.h
>

121 
	~<vr_t_li¡.h
>

122 
	~<vr_t_£t.h
>

123 
	~<vr_t_¡ršg.h
>

124 
	~<vr_t_z£t.h
>

126 
	~<vr_b™İs.h
>

128 
	~<vr_hy³¾oglog.h
>

130 
	~<vr_¦owlog.h
>

132 
	sš¡ªû
 {

133 
	mlog_Ëv–
;

134 *
	mlog_f’ame
;

135 *
	mcÚf_f’ame
;

136 
	mho¡Çme
[
VR_MAXHOSTNAMELEN
];

137 
size_t
 
	mmbuf_chunk_size
;

138 
pid_t
 
	mpid
;

139 *
	mpid_f’ame
;

140 
	mpidfe
:1;

141 
	mth»ad_num
;

	@src/vr_db.c

1 
	~<sigÇl.h
>

2 
	~<ùy³.h
>

4 
	~<vr_cÜe.h
>

7 
diùTy³
 
	gdbDiùTy³
 = {

8 
diùSdsHash
,

9 
NULL
,

10 
NULL
,

11 
diùSdsKeyCom·»
,

12 
diùSdsDe¡ruùÜ
,

13 
diùObjeùDe¡ruùÜ


17 
diùTy³
 
	gkey±rDiùTy³
 = {

18 
diùSdsHash
,

19 
NULL
,

20 
NULL
,

21 
diùSdsKeyCom·»
,

22 
NULL
,

23 
NULL


29 
diùTy³
 
	gkeyli¡DiùTy³
 = {

30 
diùObjHash
,

31 
NULL
,

32 
NULL
,

33 
diùObjKeyCom·»
,

34 
diùObjeùDe¡ruùÜ
,

35 
diùLi¡De¡ruùÜ


39 
eviùiÚPoŞEÁry
 *
	$eviùiÚPoŞAÎoc
() {

40 
eviùiÚPoŞEÁry
 *
•
;

41 
j
;

43 
•
 = 
	`d®loc
((*•)*
MAXMEMORY_EVICTION_POOL_SIZE
);

44 
j
 = 0; j < 
MAXMEMORY_EVICTION_POOL_SIZE
; j++) {

45 
•
[
j
].
idË
 = 0;

46 
•
[
j
].
key
 = 
NULL
;

48  
•
;

49 
	}
}

55 
	$»disDbIn™
(
»disDb
 *
db
)

57 
db
->
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

58 
db
->
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

59 
db
->
blockšg_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

60 
db
->
»ady_keys
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

61 
db
->
w©ched_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

62 
db
->
eviùiÚ_poŞ
 = 
	`eviùiÚPoŞAÎoc
();

63 
db
->
avg_‰l
 = 0;

65 
	`±h»ad_rwlock_š™
(&
db
->
rwl
, 
NULL
);

67  
VR_OK
;

68 
	}
}

71 
	$»disDbDeš™
(
»disDb
 *
db
)

73 
	`±h»ad_rwlock_de¡roy
(&
db
->
rwl
);

74  
VR_OK
;

75 
	}
}

78 
	$lockDbR—d
(
»disDb
 *
db
)

80 
	`±h»ad_rwlock_rdlock
(&
db
->
rwl
);

81  
VR_OK
;

82 
	}
}

85 
	$lockDbWr™e
(
»disDb
 *
db
)

87 
	`±h»ad_rwlock_w¾ock
(&
db
->
rwl
);

88  
VR_OK
;

89 
	}
}

92 
	$uÆockDb
(
»disDb
 *
db
)

94 
	`±h»ad_rwlock_uÆock
(&
db
->
rwl
);

95  
VR_OK
;

96 
	}
}

98 
robj
 *
	$lookupKey
(
»disDb
 *
db
, 
robj
 *
key
) {

99 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

100 ià(
de
) {

101 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

106 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1)

108 
v®
->
Ìu
 = 0;

109  
v®
;

111  
NULL
;

113 
	}
}

115 
robj
 *
	$lookupKeyR—d
(
»disDb
 *
db
, 
robj
 *
key
) {

116 ià(
	`checkIfExpœed
(
db
, 
key
)è 
NULL
;

117  
	`lookupKey
(
db
,
key
);

118 
	}
}

120 
robj
 *
	$lookupKeyWr™e
(
»disDb
 *
db
, 
robj
 *
key
, *
expœed
) {

121 ià(
expœed
è*expœed = 
	`expœeIfN“ded
(
db
,
key
);

122  
	`lookupKey
(
db
,
key
);

123 
	}
}

125 
robj
 *
	$lookupKeyR—dOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

126 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
, 
key
);

127 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

128  
o
;

129 
	}
}

131 
robj
 *
	$lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
, *
expœed
) {

132 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
, 
key
, 
expœed
);

133 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

134  
o
;

135 
	}
}

142 
	$dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

143 
sds
 
cİy
 = 
	`sdsdup
(
key
->
±r
);

144 
»tv®
 = 
	`diùAdd
(
db
->
diù
, 
cİy
, 
v®
);

145 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
»tv®
 =ğ
DICT_OK
);

146 ià(
v®
->
ty³
 =ğ
OBJ_LIST
è
	`sigÇlLi¡AsR—dy
(
db
, 
key
);

147 
	}
}

155 
	$dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

156 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

158 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
de
 != NULL);

159 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

160 
	}
}

168 
	$£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
, *
expœed
) {

169 ià(
	`lookupKeyWr™e
(
db
,
key
,
expœed
è=ğ
NULL
) {

170 
	`dbAdd
(
db
,
key
,
v®
);

172 
	`dbOv”wr™e
(
db
,
key
,
v®
);

175 
	`»moveExpœe
(
db
,
key
);

176 
	}
}

178 
	$dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
) {

179  
	`diùFšd
(
db
->
diù
,
key
->
±r
è!ğ
NULL
;

180 
	}
}

186 
robj
 *
	$dbRªdomKey
(
»disDb
 *
db
) {

187 
diùEÁry
 *
de
;

190 
sds
 
key
;

191 
robj
 *
keyobj
;

193 
	`lockDbR—d
(
db
);

194 
de
 = 
	`diùG‘RªdomKey
(
db
->
diù
);

195 ià(
de
 =ğ
NULL
) {

196 
	`uÆockDb
(
db
);

197  
NULL
;

200 
key
 = 
	`diùG‘Key
(
de
);

201 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

202 ià(
	`diùFšd
(
db
->
expœes
,
key
)) {

203 ià(
	`checkIfExpœed
(
db
,
keyobj
)) {

204 
	`uÆockDb
(
db
);

205 
	`ä“Objeù
(
keyobj
);

209 
	`uÆockDb
(
db
);

210  
keyobj
;

212 
	}
}

215 
	$dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

218 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

219 ià(
	`diùD–‘e
(
db
->
diù
,
key
->
±r
è=ğ
DICT_OK
) {

224 
	}
}

226 
robj
 *
	$dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
o
) {

227 
	`ASSERT
(
o
->
ty³
 =ğ
OBJ_STRING
);

228 ià(
o
->
cÚ¡ªt
 || o->
’codšg
 !ğ
OBJ_ENCODING_RAW
) {

229 
robj
 *
decoded
, *
Ãw
;

230 
decoded
 = 
	`g‘DecodedObjeù
(
o
);

231 
Ãw
 = 
	`ü—‹RawSŒšgObjeù
(
decoded
->
±r
, 
	`sd¦’
(decoded->ptr));

232 ià(
decoded
 !ğ
o
è
	`ä“Objeù
(decoded);

233 
	`dbOv”wr™e
(
db
,
key
,
Ãw
);

234  
Ãw
;

236  
o
;

237 
	}
}

239 
em±yDb
((
ÿÎback
)(*)) {

240 
j
;

241 
»moved
 = 0;

242 
»disDb
 *
db
;

244 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

245 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)
j
);

246 
»moved
 +ğ
	`diùSize
(
db
->
diù
);

247 
	`diùEm±y
(
db
->
diù
,
ÿÎback
);

248 
	`diùEm±y
(
db
->
expœes
,
ÿÎback
);

251  
»moved
;

252 
	}
}

254 
	$£ËùDb
(
ş›Á
 *
c
, 
id
) {

255 
»disDb
 *
db
;

257 ià(
id
 < 0 || id >ğ
£rv”
.
dbÊum
)

258  
VR_ERROR
;

260 
c
->
diùid
 = 
id
;

261  
VR_OK
;

262 
	}
}

273 
	$sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
) {

274 
	`touchW©chedKey
(
db
,
key
);

275 
	}
}

277 
	$sigÇlFlushedDb
(
dbid
) {

278 
	`touchW©chedKeysOnFlush
(
dbid
);

279 
	}
}

285 
	$æushdbCommªd
(
ş›Á
 *
c
) {

286 
idx
;

288 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

289 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

290 
	`lockDbWr™e
(
c
->
db
);

291 
c
->
v–
->
dœty
 +ğ
	`diùSize
(c->
db
->
diù
);

292 
	`sigÇlFlushedDb
(
c
->
db
->
id
);

293 
	`diùEm±y
(
c
->
db
->
diù
,
NULL
);

294 
	`diùEm±y
(
c
->
db
->
expœes
,
NULL
);

295 
	`uÆockDb
(
c
->
db
);

298 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

299 
	}
}

301 
	$æush®lCommªd
(
ş›Á
 *
c
) {

302 
idx
;

303 
»disDb
 *
db
;

305 
idx
 = 0; idx < 
£rv”
.
dbnum
; idx ++) {

306 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)
idx
);

307 
	`lockDbWr™e
(
db
);

308 
	`diùEm±y
(
db
->
diù
,
NULL
);

309 
	`diùEm±y
(
db
->
expœes
,
NULL
);

310 
	`uÆockDb
(
db
);

313 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

314 
	}
}

316 
	$d–Commªd
(
ş›Á
 *
c
) {

317 
d–‘ed
 = 0, 
j
;

318 
expœed
 = 0;

320 
j
 = 1; j < 
c
->
¬gc
; j++) {

321 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[
j
]);

322 
	`lockDbWr™e
(
c
->
db
);

323 
expœed
 +ğ
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

324 ià(
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
])) {

325 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

326 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

327 "d–",
c
->
¬gv
[
j
],c->
db
->
id
);

328 
c
->
v–
->
dœty
++;

329 
d–‘ed
++;

331 
	`uÆockDb
(
c
->
db
);

333 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

335 ià(
expœed
 > 0) {

336 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 
expœed
);

338 
	}
}

342 
	$exi¡sCommªd
(
ş›Á
 *
c
) {

343 
couÁ
 = 0;

344 
j
;

346 
j
 = 1; j < 
c
->
¬gc
; j++) {

347 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

348 
	`lockDbR—d
(
c
->
db
);

349 ià(
	`checkIfExpœed
(
c
->
db
,c->
¬gv
[
j
])) {

350 
	`uÆockDb
(
c
->
db
);

353 ià(
	`dbExi¡s
(
c
->
db
,c->
¬gv
[
j
])è
couÁ
++;

354 
	`uÆockDb
(
c
->
db
);

356 
	`addR•lyLÚgLÚg
(
c
,
couÁ
);

358 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 
couÁ
);

359 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, c->
¬gc
-1-
couÁ
);

360 
	}
}

362 
	$£ËùCommªd
(
ş›Á
 *
c
) {

363 
id
;

365 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[1], &
id
,

366 "šv®id DB index"è!ğ
VR_OK
)

369 ià(
	`£ËùDb
(
c
,
id
è=ğ
VR_ERROR
) {

370 
	`addR•lyE¼Ü
(
c
,"invalid DB index");

372 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

374 
	}
}

376 
	$¿ndomkeyCommªd
(
ş›Á
 *
c
) {

377 
robj
 *
key
;

378 
idx
, 
»Œy_couÁ
 = 0;

380 
idx
 = 
	`¿ndom
()%
£rv”
.
dbšum
;

382 
»Œy
:

383 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

384 ià((
key
 = 
	`dbRªdomKey
(
c
->
db
)è=ğ
NULL
) {

385 ià(
»Œy_couÁ
++ < 
£rv”
.
dbšum
) {

386 ià(++
idx
 >ğ
£rv”
.
dbšum
) {

387 
idx
 = 0;

389 
»Œy
;

392 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

396 
	`addR•lyBulk
(
c
,
key
);

397 
	`ä“Objeù
(
key
);

398 
	}
}

400 
	$keysCommªd
(
ş›Á
 *
c
) {

401 
diùI‹¿tÜ
 *
di
;

402 
diùEÁry
 *
de
;

403 
sds
 
·‰”n
 = 
c
->
¬gv
[1]->
±r
;

404 
¶’
 = 
	`sd¦’
(
·‰”n
), 
®lkeys
;

405 
numkeys
 = 0;

406 *
»¶yËn
;

407 
idx
;

408 
keys_couÁ
 = 0;

409 
expœed
 = 0;

410 
max_time_com¶ex™y_lim™
;

413 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

414 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

415 
	`lockDbWr™e
(
c
->
db
);

416 
keys_couÁ
 +ğ
	`diùSize
(
c
->
db
->
diù
);

417 
	`uÆockDb
(
c
->
db
);

420 
max_time_com¶ex™y_lim™
 = 
c
->
v–
->
cc
.max_time_complexity_limit;

421 ià(
max_time_com¶ex™y_lim™
 &&

422 
keys_couÁ
 > 
max_time_com¶ex™y_lim™
) {

423 
	`addR•ly
(
c
,
sh¬ed
.
outofcom¶ex™ylim™
);

427 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

428 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

429 
	`ãtchIÁ”ÇlDbById
(
c
,
idx
);

430 
	`lockDbWr™e
(
c
->
db
);

431 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
db
->
diù
);

432 
®lkeys
 = (
·‰”n
[0] == '*' &&…attern[1] == '\0');

433 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

434 
sds
 
key
 = 
	`diùG‘Key
(
de
);

435 
robj
 *
keyobj
;

437 ià(
®lkeys
 || 
	`¡ršgm©chËn
(
·‰”n
,
¶’
,
key
,
	`sd¦’
(key),0)) {

438 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

439 ià(
	`expœeIfN“ded
(
c
->
db
,
keyobj
) == 0) {

440 
	`addR•lyBulk
(
c
,
keyobj
);

441 
numkeys
++;

443 
expœed
 ++;

445 
	`ä“Objeù
(
keyobj
);

448 
	`diùR–—£I‹¿tÜ
(
di
);

449 
	`uÆockDb
(
c
->
db
);

451 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
numkeys
);

452 
	}
}

456 
	$sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
) {

457 **
pd
 = (**è
´ivd©a
;

458 
dli¡
 *
keys
 = 
pd
[0];

459 
robj
 *
o
 = 
pd
[1];

460 
robj
 *
key
, *
v®
 = 
NULL
;

462 ià(
o
 =ğ
NULL
) {

463 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

464 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
, 
	`sd¦’
(sdskey));

465 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

466 
key
 = 
	`diùG‘Key
(
de
);

467 
key
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(key);

468 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

469 
key
 = 
	`diùG‘Key
(
de
);

470 
key
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(key);

471 
v®
 = 
	`diùG‘V®
(
de
);

472 
v®
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(val);

473 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

474 
key
 = 
	`diùG‘Key
(
de
);

475 
key
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(key);

476 
v®
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(*(*)
	`diùG‘V®
(
de
),0);

478 
	`£rv”Pªic
("Type‚ot handled in SCAN callback.");

481 
	`dli¡AddNodeTa
(
keys
, 
key
);

482 ià(
v®
è
	`dli¡AddNodeTa
(
keys
, val);

483 
	}
}

489 
	$·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
) {

490 *
•Œ
;

494 
”ºo
 = 0;

495 *
cursÜ
 = 
	`¡¹oul
(
o
->
±r
, &
•Œ
, 10);

496 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
)

498 
	`addR•lyE¼Ü
(
c
, "invalid cursor");

499  
VR_ERROR
;

501  
VR_OK
;

502 
	}
}

515 
	$sÿnG’”icCommªd
(
ş›Á
 *
c
, 
sÿÁy³
) {

516 
i
, 
j
;

517 
dli¡
 *
keys
 = 
	`dli¡C»©e
();

518 
dli¡Node
 *
node
, *
ÃxŠode
;

519 
couÁ
 = 10;

520 
sds
 
·t
 = 
NULL
;

521 
·’
 = 0, 
u£_·‰”n
 = 0;

522 
cursÜ
;

523 
robj
 *
o
;

524 
diù
 *
ht
;

527 
i
 = (
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) ? 2 : 3;

528 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[
i
-1],&
cursÜ
è=ğ
VR_ERROR
) ;

531 
i
 < 
c
->
¬gc
) {

532 
j
 = 
c
->
¬gc
 - 
i
;

533 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "couÁ"è&& 
j
 >= 2) {

534 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
i
+1], &
couÁ
, 
NULL
)

535 !ğ
VR_OK
)

537 
ş—nup
;

540 ià(
couÁ
 < 1) {

541 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

542 
ş—nup
;

545 
i
 += 2;

546 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "m©ch"è&& 
j
 >= 2) {

547 
·t
 = 
c
->
¬gv
[
i
+1]->
±r
;

548 
·’
 = 
	`sd¦’
(
·t
);

552 
u£_·‰”n
 = !(
·t
[0] =ğ'*' && 
·’
 == 1);

554 
i
 += 2;

556 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

557 
ş—nup
;

561 ià(
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) {

562 
o
 = 
NULL
;

563 ià(
c
->
sÿnid
 =ğ-1 || 
cursÜ
 == 0) c->scanid = 0;

564 
	`ãtchIÁ”ÇlDbById
(
c
, c->
sÿnid
);

565 
	`lockDbR—d
(
c
->
db
);

566 } ià(
sÿÁy³
 =ğ
SCAN_TYPE_HASH
 ||

567 
sÿÁy³
 =ğ
SCAN_TYPE_SET
 ||

568 
sÿÁy³
 =ğ
SCAN_TYPE_ZSET
) {

569 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

570 
	`lockDbR—d
(
c
->
db
);

571 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
) {

572 
	`uÆockDb
(
c
->
db
);

573 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

578 
sÿÁy³
) {

579 
SCAN_TYPE_KEY
:

580 
	`ASSERT
(
o
 =ğ
NULL
);

582 
SCAN_TYPE_HASH
:

583 ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

584 
	`uÆockDb
(
c
->
db
);

585 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

589 
SCAN_TYPE_SET
:

590 ià(
	`checkTy³
(
c
,
o
,
OBJ_SET
)) {

591 
	`uÆockDb
(
c
->
db
);

592 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

596 
SCAN_TYPE_ZSET
:

597 ià(
	`checkTy³
(
c
,
o
,
OBJ_ZSET
)) {

598 
	`uÆockDb
(
c
->
db
);

599 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

607 
	`ASSERT
(
o
 =ğ
NULL
 || o->
ty³
 =ğ
OBJ_SET
 || o->ty³ =ğ
OBJ_HASH
 ||

608 
o
->
ty³
 =ğ
OBJ_ZSET
);

610 
sÿn_»Œy
:

621 
ht
 = 
NULL
;

622 ià(
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) {

623 
ht
 = 
c
->
db
->
diù
;

624 } ià(
o
->
ty³
 =ğ
OBJ_SET
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

625 
ht
 = 
o
->
±r
;

626 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

627 
ht
 = 
o
->
±r
;

628 
couÁ
 *= 2;

629 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
 && o->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

630 
z£t
 *
zs
 = 
o
->
±r
;

631 
ht
 = 
zs
->
diù
;

632 
couÁ
 *= 2;

635 ià(
ht
) {

636 *
´ivd©a
[2];

641 
max™”©iÚs
 = 
couÁ
*10;

646 
´ivd©a
[0] = 
keys
;

647 
´ivd©a
[1] = 
o
;

649 
cursÜ
 = 
	`diùSÿn
(
ht
, cursÜ, 
sÿnC®lback
, 
´ivd©a
);

650 } 
cursÜ
 &&

651 
max™”©iÚs
-- &&

652 
	`dli¡L’gth
(
keys
è< ()
couÁ
);

653 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

654 
pos
 = 0;

655 
št64_t
 
Î
;

657 
	`št£tG‘
(
o
->
±r
,
pos
++,&
Î
))

658 
	`dli¡AddNodeTa
(
keys
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î
));

659 
cursÜ
 = 0;

660 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 || o->ty³ =ğ
OBJ_ZSET
) {

661 *
p
 = 
	`zli¡Index
(
o
->
±r
,0);

662 *
v¡r
;

663 
vËn
;

664 
vÎ
;

666 
p
) {

667 
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vÎ
);

668 
	`dli¡AddNodeTa
(
keys
,

669 (
v¡r
 !ğ
NULL
è? 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
) :

670 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
));

671 
p
 = 
	`zli¡Next
(
o
->
±r
,p);

673 
cursÜ
 = 0;

675 
	`£rv”Pªic
("Not handledƒncoding in SCAN.");

678 
	`uÆockDb
(
c
->
db
);

679 ià(
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) {

680 ià(
cursÜ
 == 0) {

681 ià(
c
->
sÿnid
 < (
£rv”
.
dbšum
 - 1)) {

682 
c
->
sÿnid
 ++;

683 
	`ãtchIÁ”ÇlDbById
(
c
, c->
sÿnid
);

684 
	`lockDbR—d
(
c
->
db
);

685 
sÿn_»Œy
;

687 
c
->
sÿnid
 = -1;

690 } ià(
sÿÁy³
 =ğ
SCAN_TYPE_HASH
 ||

691 
sÿÁy³
 =ğ
SCAN_TYPE_SET
 ||

692 
sÿÁy³
 =ğ
SCAN_TYPE_ZSET
) {

693 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

697 
node
 = 
	`dli¡Fœ¡
(
keys
);

698 
node
) {

699 
robj
 *
kobj
 = 
	`dli¡NodeV®ue
(
node
);

700 
ÃxŠode
 = 
	`dli¡NextNode
(
node
);

701 
f‹r
 = 0;

704 ià(!
f‹r
 && 
u£_·‰”n
) {

705 ià(
	`sdsEncodedObjeù
(
kobj
)) {

706 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
kobj
->
±r
, 
	`sd¦’
(kobj->ptr), 0))

707 
f‹r
 = 1;

709 
buf
[
LONG_STR_SIZE
];

710 
Ën
;

712 
	`ASSERT
(
kobj
->
’codšg
 =ğ
OBJ_ENCODING_INT
);

713 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
kobj
->
±r
);

714 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
buf
, 
Ën
, 0)è
f‹r
 = 1;

719 ià(!
f‹r
 && 
o
 =ğ
NULL
 && 
	`checkIfExpœed
(
c
->
db
,
kobj
)) filter = 1;

722 ià(
f‹r
) {

723 
	`ä“Objeù
(
kobj
);

724 
	`dli¡D–Node
(
keys
, 
node
);

730 ià(
o
 && (o->
ty³
 =ğ
OBJ_ZSET
 || o->ty³ =ğ
OBJ_HASH
)) {

731 
node
 = 
ÃxŠode
;

732 
ÃxŠode
 = 
	`dli¡NextNode
(
node
);

733 ià(
f‹r
) {

734 
kobj
 = 
	`dli¡NodeV®ue
(
node
);

735 
	`ä“Objeù
(
kobj
);

736 
	`dli¡D–Node
(
keys
, 
node
);

739 
node
 = 
ÃxŠode
;

743 
	`addR•lyMuÉiBulkL’
(
c
, 2);

744 
	`addR•lyBulkLÚgLÚg
(
c
,
cursÜ
);

746 
	`addR•lyMuÉiBulkL’
(
c
, 
	`dli¡L’gth
(
keys
));

747 (
node
 = 
	`dli¡Fœ¡
(
keys
)è!ğ
NULL
) {

748 
robj
 *
kobj
 = 
	`dli¡NodeV®ue
(
node
);

749 
	`addR•lyBulk
(
c
, 
kobj
);

750 
	`ä“Objeù
(
kobj
);

751 
	`dli¡D–Node
(
keys
, 
node
);

754 
ş—nup
:

755 
	`dli¡S‘F»eM‘hod
(
keys
,
ä“ObjeùVoid
);

756 
	`dli¡R–—£
(
keys
);

757 
	}
}

760 
	$sÿnCommªd
(
ş›Á
 *
c
) {

761 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_KEY
);

762 
	}
}

764 
	$dbsizeCommªd
(
ş›Á
 *
c
) {

765 
idx
;

766 
couÁ
 = 0;

768 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

769 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

770 
	`lockDbR—d
(
c
->
db
);

771 
couÁ
 +ğ
	`diùSize
(
c
->
db
->
diù
);

772 
	`uÆockDb
(
c
->
db
);

775 
	`addR•lyLÚgLÚg
(
c
,
couÁ
);

776 
	}
}

778 
	$Ï¡§veCommªd
(
ş›Á
 *
c
) {

779 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
Ï¡§ve
);

780 
	}
}

782 
	$ty³Commªd
(
ş›Á
 *
c
) {

783 
robj
 *
o
;

784 *
ty³
;

786 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

787 
	`lockDbR—d
(
c
->
db
);

788 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

789 ià(
o
 =ğ
NULL
) {

790 
ty³
 = "none";

791 
	`uÆockDb
(
c
->
db
);

792 
	`addR•lyStus
(
c
,
ty³
);

793 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

796 
o
->
ty³
) {

797 
OBJ_STRING
: 
ty³
 = "string"; ;

798 
OBJ_LIST
: 
ty³
 = "list"; ;

799 
OBJ_SET
: 
ty³
 = "set"; ;

800 
OBJ_ZSET
: 
ty³
 = "zset"; ;

801 
OBJ_HASH
: 
ty³
 = "hash"; ;

802 : 
ty³
 = "unknown"; ;

806 
	`uÆockDb
(
c
->
db
);

807 
	`addR•lyStus
(
c
,
ty³
);

808 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

809 
	}
}

811 
	$shutdownCommªd
(
ş›Á
 *
c
) {

812 
æags
 = 0;

814 ià(
c
->
¬gc
 > 2) {

815 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

817 } ià(
c
->
¬gc
 == 2) {

818 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nosave")) {

819 
æags
 |ğ
SHUTDOWN_NOSAVE
;

820 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"save")) {

821 
æags
 |ğ
SHUTDOWN_SAVE
;

823 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

833 ià(
£rv”
.
lßdšg
)

834 
æags
 = (æag & ~
SHUTDOWN_SAVE
è| 
SHUTDOWN_NOSAVE
;

836 
	`addR•lyE¼Ü
(
c
,"Errorsryingo SHUTDOWN. Check†ogs.");

837 
	}
}

839 
	$»ÇmeG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

840 
robj
 *
o
;

841 
expœe
;

842 
§mekey
 = 0;

846 ià(
	`sdscmp
(
c
->
¬gv
[1]->
±r
,c->¬gv[2]->±rè=ğ0è
§mekey
 = 1;

848 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
,
NULL
)) == NULL)

851 ià(
§mekey
) {

852 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
ok
);

856 
	`šüRefCouÁ
(
o
);

857 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

858 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
) != NULL) {

859 ià(
nx
) {

860 
	`deüRefCouÁ
(
o
);

861 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

866 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[2]);

868 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
o
);

869 ià(
expœe
 !ğ-1è
	`£tExpœe
(
c
->
db
,c->
¬gv
[2],expire);

870 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

871 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

872 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

873 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_from",

874 
c
->
¬gv
[1],c->
db
->
id
);

875 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_to",

876 
c
->
¬gv
[2],c->
db
->
id
);

877 
£rv”
.
dœty
++;

878 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

879 
	}
}

881 
	$»ÇmeCommªd
(
ş›Á
 *
c
) {

882 
	`»ÇmeG’”icCommªd
(
c
,0);

883 
	}
}

885 
	$»Çm’xCommªd
(
ş›Á
 *
c
) {

886 
	`»ÇmeG’”icCommªd
(
c
,1);

887 
	}
}

889 
	$moveCommªd
(
ş›Á
 *
c
) {

890 
robj
 *
o
;

891 
»disDb
 *
¤c
, *
d¡
;

892 
¤cid
;

893 
dbid
, 
expœe
;

896 
¤c
 = 
c
->
db
;

897 
¤cid
 = 
c
->
db
->
id
;

899 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[2],&
dbid
è=ğ
VR_ERROR
 ||

900 
dbid
 < 
INT_MIN
 || dbid > 
INT_MAX
 ||

901 
	`£ËùDb
(
c
,
dbid
è=ğ
VR_ERROR
)

903 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

906 
d¡
 = 
c
->
db
;

907 
	`£ËùDb
(
c
,
¤cid
);

911 ià(
¤c
 =ğ
d¡
) {

912 
	`addR•ly
(
c
,
sh¬ed
.
§meobjeù”r
);

917 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
NULL
);

918 ià(!
o
) {

919 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

922 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

925 ià(
	`lookupKeyWr™e
(
d¡
,
c
->
¬gv
[1],
NULL
) != NULL) {

926 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

929 
	`dbAdd
(
d¡
,
c
->
¬gv
[1],
o
);

930 ià(
expœe
 !ğ-1è
	`£tExpœe
(
d¡
,
c
->
¬gv
[1],expire);

931 
	`šüRefCouÁ
(
o
);

934 
	`dbD–‘e
(
¤c
,
c
->
¬gv
[1]);

935 
£rv”
.
dœty
++;

936 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

937 
	}
}

943 
	$»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

946 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

947  
	`diùD–‘e
(
db
->
expœes
,
key
->
±r
è=ğ
DICT_OK
;

948 
	}
}

950 
	$£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
) {

951 
diùEÁry
 *
kde
, *
de
;

954 
kde
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

955 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
kde
 != NULL);

956 
de
 = 
	`diùR•ÏûRaw
(
db
->
expœes
,
	`diùG‘Key
(
kde
));

957 
	`diùS‘SigÃdIÁeg”V®
(
de
,
wh’
);

958 
	}
}

962 
	$g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
) {

963 
diùEÁry
 *
de
;

966 ià(
	`diùSize
(
db
->
expœes
) == 0 ||

967 (
de
 = 
	`diùFšd
(
db
->
expœes
,
key
->
±r
)è=ğ
NULL
)  -1;

971 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

972  
	`diùG‘SigÃdIÁeg”V®
(
de
);

973 
	}
}

983 
	$´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

984 
robj
 *
¬gv
[2];

986 
¬gv
[0] = 
sh¬ed
.
d–
;

987 
¬gv
[1] = 
key
;

988 
	`šüRefCouÁ
(
¬gv
[0]);

989 
	`šüRefCouÁ
(
¬gv
[1]);

991 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
)

992 
	`ãedAµ’dOÆyFe
(
£rv”
.
d–Commªd
,
db
->
id
,
¬gv
,2);

993 
	`»¶iÿtiÚF“dSÏves
(
»¶
.
¦aves
,
db
->
id
,
¬gv
,2);

995 
	`deüRefCouÁ
(
¬gv
[0]);

996 
	`deüRefCouÁ
(
¬gv
[1]);

997 
	}
}

1000 
	$checkIfExpœed
(
»disDb
 *
db
, 
robj
 *
key
) {

1001 
wh’
;

1003 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

1004 ià(
wh’
 > 0 && 
	`vr_m£c_now
() > when) {

1009 
	}
}

1011 
	$expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
) {

1012 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

1013 
now
;

1015 ià(
wh’
 < 0)  0;

1018 ià(
£rv”
.
lßdšg
)  0;

1025 
now
 = 
£rv”
.
lua_ÿÎ”
 ? s”v”.
lua_time_¡¬t
 : 
	`vr_m£c_now
();

1034 ià(
»¶
.
ma¡”ho¡
 !ğ
NULL
è 
now
 > 
wh’
;

1037 ià(
now
 <ğ
wh’
)  0;

1041 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EXPIRED
,

1042 "expœed",
key
,
db
->
id
);

1043  
	`dbD–‘e
(
db
,
key
);

1044 
	}
}

1057 
	$expœeG’”icCommªd
(
ş›Á
 *
c
, 
ba£time
, 
un™
) {

1058 
robj
 *
key
 = 
c
->
¬gv
[1], *
·¿m
 = c->argv[2];

1059 
wh’
;

1060 
expœed
 = 0;

1062 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
·¿m
, &
wh’
, 
NULL
è!ğ
VR_OK
)

1065 ià(
un™
 =ğ
UNIT_SECONDS
è
wh’
 *= 1000;

1066 
wh’
 +ğ
ba£time
;

1068 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1069 
	`lockDbWr™e
(
c
->
db
);

1071 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
,&
expœed
è=ğ
NULL
) {

1072 
	`uÆockDb
(
c
->
db
);

1073 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1074 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1084 ià(
wh’
 <ğ
	`vr_m£c_now
(è&& !
£rv”
.
lßdšg
 && !
»¶
.
ma¡”ho¡
) {

1085 
robj
 *
aux
;

1087 
	`£rv”As£¹W™hInfo
(
c
,
key
,
	`dbD–‘e
(c->
db
,key));

1088 
c
->
v–
->
dœty
++;

1091 
aux
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
key
);

1092 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
sh¬ed
.
d–
,
aux
);

1093 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1094 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1095 
	`uÆockDb
(
c
->
db
);

1096 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1097 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

1100 
	`£tExpœe
(
c
->
db
,
key
,
wh’
);

1101 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1102 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1103 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"expœe",
key
,
c
->
db
->
id
);

1104 
	`uÆockDb
(
c
->
db
);

1105 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1106 
c
->
v–
->
dœty
++;

1109 
	}
}

1111 
	$expœeCommªd
(
ş›Á
 *
c
) {

1112 
	`expœeG’”icCommªd
(
c
,
	`vr_m£c_now
(),
UNIT_SECONDS
);

1113 
	}
}

1115 
	$expœ—tCommªd
(
ş›Á
 *
c
) {

1116 
	`expœeG’”icCommªd
(
c
,0,
UNIT_SECONDS
);

1117 
	}
}

1119 
	$³xpœeCommªd
(
ş›Á
 *
c
) {

1120 
	`expœeG’”icCommªd
(
c
,
	`vr_m£c_now
(),
UNIT_MILLISECONDS
);

1121 
	}
}

1123 
	$³xpœ—tCommªd
(
ş›Á
 *
c
) {

1124 
	`expœeG’”icCommªd
(
c
,0,
UNIT_MILLISECONDS
);

1125 
	}
}

1127 
	$‰lG’”icCommªd
(
ş›Á
 *
c
, 
ouut_ms
) {

1128 
expœe
, 
‰l
 = -1;

1130 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

1131 
	`lockDbR—d
(
c
->
db
);

1133 ià(
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]è=ğ
NULL
) {

1134 
	`uÆockDb
(
c
->
db
);

1135 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

1136 
	`addR•lyLÚgLÚg
(
c
,-2);

1141 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

1142 
	`uÆockDb
(
c
->
db
);

1143 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

1145 ià(
expœe
 != -1) {

1146 
‰l
 = 
expœe
-
	`vr_m£c_now
();

1147 ià(
‰l
 < 0)tl = 0;

1149 ià(
‰l
 == -1) {

1150 
	`addR•lyLÚgLÚg
(
c
,-1);

1152 
	`addR•lyLÚgLÚg
(
c
,
ouut_ms
 ? 
‰l
 : ((ttl+500)/1000));

1154 
	}
}

1156 
	$‰lCommªd
(
ş›Á
 *
c
) {

1157 
	`‰lG’”icCommªd
(
c
, 0);

1158 
	}
}

1160 
	$±Commªd
(
ş›Á
 *
c
) {

1161 
	`‰lG’”icCommªd
(
c
, 1);

1162 
	}
}

1164 
	$³rsi¡Commªd
(
ş›Á
 *
c
) {

1165 
diùEÁry
 *
de
;

1167 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

1168 
	`lockDbWr™e
(
c
->
db
);

1169 
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[1]->
±r
);

1170 ià(
de
 =ğ
NULL
) {

1171 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1173 ià(
	`»moveExpœe
(
c
->
db
,c->
¬gv
[1])) {

1174 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1175 
c
->
v–
->
dœty
++;

1177 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1180 
	`uÆockDb
(
c
->
db
);

1181 
	}
}

1189 *
	$g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1190 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

1191 
	`UNUSED
(
¬gv
);

1193 ià(
cmd
->
fœ¡key
 == 0) {

1194 *
numkeys
 = 0;

1195  
NULL
;

1197 
Ï¡
 = 
cmd
->
Ï¡key
;

1198 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

1199 
keys
 = 
	`d®loc
(()*((
Ï¡
 - 
cmd
->
fœ¡key
)+1));

1200 
j
 = 
cmd
->
fœ¡key
; j <ğ
Ï¡
; j +ğcmd->
key¡•
) {

1201 
	`ASSERT
(
j
 < 
¬gc
);

1202 
keys
[
i
++] = 
j
;

1204 *
numkeys
 = 
i
;

1205  
keys
;

1206 
	}
}

1219 *
	$g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1220 ià(
cmd
->
g‘keys_´oc
) {

1221  
cmd
->
	`g‘keys_´oc
(cmd,
¬gv
,
¬gc
,
numkeys
);

1223  
	`g‘KeysUsšgCommªdTabË
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1225 
	}
}

1228 
	$g‘KeysF»eResuÉ
(*
»suÉ
) {

1229 
	`dä“
(
»suÉ
);

1230 
	}
}

1235 *
	$zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1236 
i
, 
num
, *
keys
;

1237 
	`UNUSED
(
cmd
);

1239 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1242 ià(
num
 > (
¬gc
-3)) {

1243 *
numkeys
 = 0;

1244  
NULL
;

1250 
keys
 = 
	`d®loc
(()*(
num
+1));

1253 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1256 
keys
[
num
] = 1;

1257 *
numkeys
 = 
num
+1;

1258  
keys
;

1259 
	}
}

1264 *
	$ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1265 
i
, 
num
, *
keys
;

1266 
	`UNUSED
(
cmd
);

1268 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1271 ià(
num
 > (
¬gc
-3)) {

1272 *
numkeys
 = 0;

1273  
NULL
;

1276 
keys
 = 
	`d®loc
(()*
num
);

1277 *
numkeys
 = 
num
;

1280 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1282  
keys
;

1283 
	}
}

1292 *
	$sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1293 
i
, 
j
, 
num
, *
keys
, 
found_¡Üe
 = 0;

1294 
	`UNUSED
(
cmd
);

1296 
num
 = 0;

1297 
keys
 = 
	`d®loc
(()*2);

1299 
keys
[
num
++] = 1;

1306 *
Çme
;

1307 
sk
;

1308 } 
skli¡
[] = {

1312 {
NULL
, 0}

1315 
i
 = 2; i < 
¬gc
; i++) {

1316 
j
 = 0; 
skli¡
[j].
Çme
 !ğ
NULL
; j++) {

1317 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,
skli¡
[
j
].
Çme
)) {

1318 
i
 +ğ
skli¡
[
j
].
sk
;

1320 } ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"¡Üe"è&& i+1 < 
¬gc
) {

1324 
found_¡Üe
 = 1;

1325 
keys
[
num
] = 
i
+1;

1330 *
numkeys
 = 
num
 + 
found_¡Üe
;

1331  
keys
;

1332 
	}
}

1334 *
	$mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1335 
i
, 
num
, 
fœ¡
, *
keys
;

1336 
	`UNUSED
(
cmd
);

1339 
fœ¡
 = 3;

1340 
num
 = 1;

1343 ià(
¬gc
 > 6) {

1344 
i
 = 6; i < 
¬gc
; i++) {

1345 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"keys") &&

1346 
	`sd¦’
(
¬gv
[3]->
±r
) == 0)

1348 
fœ¡
 = 
i
+1;

1349 
num
 = 
¬gc
-
fœ¡
;

1355 
keys
 = 
	`d®loc
(()*
num
);

1356 
i
 = 0; i < 
num
; i++è
keys
[i] = 
fœ¡
+i;

1357 *
numkeys
 = 
num
;

1358  
keys
;

1359 
	}
}

1361 
	$ãtchIÁ”ÇlDbByKey
(
ş›Á
 *
c
, 
robj
 *
key
) {

1362 
c
->
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
	`hash_üc16
(
key
->
±r
,
	`¡ršgObjeùL’
(key))&0x3FFF)%£rv”.
dbšum
+c->
diùid
*server.dbinum);

1363  
VR_OK
;

1364 
	}
}

1366 
	$ãtchIÁ”ÇlDbById
(
ş›Á
 *
c
, 
idx
) {

1367 
c
->
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
idx
+c->
diùid
*£rv”.
dbšum
);

1368  
VR_OK
;

1369 
	}
}

1373 
	$ŒyResizeHashTabËsFÜDb
(
dbid
) {

1374 
»disDb
 *
db
;

1376 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
dbid
);

1377 
	`lockDbWr™e
(
db
);

1378 ià(
	`htN“dsResize
(
db
->
diù
))

1379 
	`diùResize
(
db
->
diù
);

1380 ià(
	`htN“dsResize
(
db
->
expœes
))

1381 
	`diùResize
(
db
->
expœes
);

1382 
	`uÆockDb
(
db
);

1383 
	}
}

1392 
	$šüem’ÎyRehashFÜDb
(
dbid
) {

1393 
»disDb
 *
db
;

1395 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
dbid
);

1396 
	`lockDbWr™e
(
db
);

1399 ià(
	`diùIsRehashšg
(
db
->
diù
)) {

1400 
	`diùRehashMli£cÚds
(
db
->
diù
,1);

1401 
	`uÆockDb
(
db
);

1405 ià(
	`diùIsRehashšg
(
db
->
expœes
)) {

1406 
	`diùRehashMli£cÚds
(
db
->
expœes
,1);

1407 
	`uÆockDb
(
db
);

1411 
	`uÆockDb
(
db
);

1413 
	}
}

1437 
	$aùiveExpœeCyşe
(
vr_back’d
 *
back’d
, 
ty³
) {

1438 
j
, 
™”©iÚ
 = 0;

1439 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

1440 
¡¬t
 = 
	`vr_u£c_now
(), 
tim–im™
;

1441 
expœed_tÙ®
 = 0;

1443 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
) {

1447 ià(!
back’d
->
tim–im™_ex™
) ;

1448 ià(
¡¬t
 < 
back’d
->
Ï¡_ç¡_cyşe
 + 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
*2) ;

1449 
back’d
->
Ï¡_ç¡_cyşe
 = 
¡¬t
;

1459 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
 || 
back’d
->
tim–im™_ex™
)

1460 
dbs_³r_ÿÎ
 = 
£rv”
.
dbnum
;

1466 
tim–im™
 = 1000000*
ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
/
£rv”
.
hz
/100;

1467 
back’d
->
tim–im™_ex™
 = 0;

1468 ià(
tim–im™
 <= 0)imelimit = 1;

1470 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
)

1471 
tim–im™
 = 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
;

1473 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1474 
expœed
;

1475 
»disDb
 *
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
back’d
->
cu¼’t_db
%£rv”.
dbnum
);

1480 
back’d
->
cu¼’t_db
++;

1482 
	`lockDbWr™e
(
db
);

1486 
num
, 
¦Ùs
;

1487 
now
, 
‰l_sum
;

1488 
‰l_§m¶es
;

1490 ià((
num
 = 
	`diùSize
(
db
->
expœes
)) == 0) {

1491 
db
->
avg_‰l
 = 0;

1494 
¦Ùs
 = 
	`diùSlÙs
(
db
->
expœes
);

1495 
now
 = 
	`vr_m£c_now
();

1500 ià(
num
 && 
¦Ùs
 > 
DICT_HT_INITIAL_SIZE
 &&

1501 (
num
*100/
¦Ùs
 < 1)) ;

1505 
expœed
 = 0;

1506 
‰l_sum
 = 0;

1507 
‰l_§m¶es
 = 0;

1509 ià(
num
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
)

1510 
num
 = 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
;

1512 
num
--) {

1513 
diùEÁry
 *
de
;

1514 
‰l
;

1516 ià((
de
 = 
	`diùG‘RªdomKey
(
db
->
expœes
)è=ğ
NULL
) ;

1517 
‰l
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
)-
now
;

1518 ià(
	`aùiveExpœeCyşeTryExpœe
(
db
,
de
,
now
)è
expœed
++;

1519 ià(
‰l
 > 0) {

1521 
‰l_sum
 +ğ
‰l
;

1522 
‰l_§m¶es
++;

1526 
expœed_tÙ®
 +ğ
expœed
;

1529 ià(
‰l_§m¶es
) {

1530 
avg_‰l
 = 
‰l_sum
/
‰l_§m¶es
;

1535 ià(
db
->
avg_‰l
 == 0) db->avg_ttl =‡vg_ttl;

1536 
db
->
avg_‰l
 = (db->avg_ttl/50)*49 + (avg_ttl/50);

1542 
™”©iÚ
++;

1543 ià((
™”©iÚ
 & 0xf) == 0) {

1544 
–­£d
 = 
	`vr_u£c_now
()-
¡¬t
;

1547 ià(
–­£d
 > 
tim–im™
è
back’d
->
tim–im™_ex™
 = 1;

1549 ià(
back’d
->
tim–im™_ex™
) {

1550 
	`uÆockDb
(
db
);

1552 ià(
expœed_tÙ®
 > 0) {

1553 
	`upd©e_¡©s_add
(
back’d
->
v–
.
¡©s
, 
expœedkeys
, 
expœed_tÙ®
);

1559 } 
expœed
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
/4);

1560 
	`uÆockDb
(
db
);

1563 ià(
expœed_tÙ®
 > 0) {

1564 
	`upd©e_¡©s_add
(
back’d
->
v–
.
¡©s
, 
expœedkeys
, 
expœed_tÙ®
);

1566 
	}
}

1568 
	$aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
) {

1569 
t
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
);

1570 ià(
now
 > 
t
) {

1571 
sds
 
key
 = 
	`diùG‘Key
(
de
);

1572 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

1573 
	`dbD–‘e
(
db
,
keyobj
);

1574 
	`ä“Objeù
(
keyobj
);

1579 
	}
}

1584 
	$d©aba£sCrÚ
(
vr_back’d
 *
back’d
) {

1587 ià(
»¶
.
ma¡”ho¡
 =ğ
NULL
)

1588 
	`aùiveExpœeCyşe
(
back’d
, 
ACTIVE_EXPIRE_CYCLE_SLOW
);

1593 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

1594 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

1595 
j
;

1598 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
) dbs_per_call = server.dbnum;

1601 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1602 
	`ŒyResizeHashTabËsFÜDb
(
back’d
->
»size_db
%
£rv”
.
dbnum
);

1603 
back’d
->
»size_db
++;

1607 ià(
£rv”
.
aùiv”ehashšg
) {

1608 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1609 
wÜk_dÚe
 = 
	`šüem’ÎyRehashFÜDb
(
back’d
->
»hash_db
%
£rv”
.
dbnum
);

1610 
back’d
->
»hash_db
++;

1611 ià(
wÜk_dÚe
) {

1619 
	}
}

	@src/vr_db.h

1 #iâdeà
_VR_DB_H_


2 
	#_VR_DB_H_


	)

11 
	#MAXMEMORY_EVICTION_POOL_SIZE
 16

	)

12 
	seviùiÚPoŞEÁry
 {

13 
	midË
;

14 
sds
 
	mkey
;

20 
	s»disDb
 {

21 
diù
 *
	mdiù
;

22 
diù
 *
	mexpœes
;

23 
diù
 *
	mblockšg_keys
;

24 
diù
 *
	m»ady_keys
;

25 
diù
 *
	mw©ched_keys
;

26 
eviùiÚPoŞEÁry
 *
	meviùiÚ_poŞ
;

27 
	mid
;

28 
	mavg_‰l
;

30 
±h»ad_rwlock_t
 
	mrwl
;

31 } 
	t»disDb
;

33 
diùTy³
 
dbDiùTy³
;

34 
diùTy³
 
key±rDiùTy³
;

35 
diùTy³
 
keyli¡DiùTy³
;

37 
»disDbIn™
(
»disDb
 *
db
);

38 
»disDbDeš™
(
»disDb
 *
db
);

40 
lockDbR—d
(
»disDb
 *
db
);

41 
lockDbWr™e
(
»disDb
 *
db
);

42 
uÆockDb
(
»disDb
 *
db
);

44 
robj
 *
lookupKey
(
»disDb
 *
db
,„obj *
key
);

45 
robj
 *
lookupKeyR—d
(
»disDb
 *
db
,„obj *
key
);

46 
robj
 *
lookupKeyWr™e
(
»disDb
 *
db
,„obj *
key
, *
expœed
);

47 
robj
 *
lookupKeyR—dOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

48 
robj
 *
lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
, *
expœed
);

49 
dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

50 
dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

51 
£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
, *
expœed
);

52 
dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
);

53 
robj
 *
dbRªdomKey
(
»disDb
 *
db
);

54 
dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

55 
robj
 *
dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
,„obj *
key
,„obj *
o
);

56 
em±yDb
((
ÿÎback
)(*));

57 
	`£ËùDb
(
ş›Á
 *
c
, 
id
);

58 
	`sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
);

59 
	`sigÇlFlushedDb
(
dbid
);

60 
	`æushdbCommªd
(
ş›Á
 *
c
);

61 
	`æush®lCommªd
(
ş›Á
 *
c
);

62 
	`d–Commªd
(
ş›Á
 *
c
);

63 
	`exi¡sCommªd
(
ş›Á
 *
c
);

64 
	`£ËùCommªd
(
ş›Á
 *
c
);

65 
	`¿ndomkeyCommªd
(
ş›Á
 *
c
);

66 
	`keysCommªd
(
ş›Á
 *
c
);

67 
	`sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
);

68 
	`·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
);

69 
	`sÿnG’”icCommªd
(
ş›Á
 *
c
, 
sÿÁy³
);

70 
	`sÿnCommªd
(
ş›Á
 *
c
);

71 
	`dbsizeCommªd
(
ş›Á
 *
c
);

72 
	`Ï¡§veCommªd
(
ş›Á
 *
c
);

73 
	`ty³Commªd
(
ş›Á
 *
c
);

74 
	`shutdownCommªd
(
ş›Á
 *
c
);

75 
	`»ÇmeG’”icCommªd
(
ş›Á
 *
c
, 
nx
);

76 
	`»ÇmeCommªd
(
ş›Á
 *
c
);

77 
	`»Çm’xCommªd
(
ş›Á
 *
c
);

78 
	`moveCommªd
(
ş›Á
 *
c
);

79 
	`»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

80 
	`£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
);

81 
	`g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
);

82 
	`´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

83 
	`checkIfExpœed
(
»disDb
 *
db
, 
robj
 *
key
);

84 
	`expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
);

85 
	`expœeG’”icCommªd
(
ş›Á
 *
c
, 
ba£time
, 
un™
);

86 
	`expœeCommªd
(
ş›Á
 *
c
);

87 
	`expœ—tCommªd
(
ş›Á
 *
c
);

88 
	`³xpœeCommªd
(
ş›Á
 *
c
);

89 
	`³xpœ—tCommªd
(
ş›Á
 *
c
);

90 
	`‰lG’”icCommªd
(
ş›Á
 *
c
, 
ouut_ms
);

91 
	`‰lCommªd
(
ş›Á
 *
c
);

92 
	`±Commªd
(
ş›Á
 *
c
);

93 
	`³rsi¡Commªd
(
ş›Á
 *
c
);

94 *
	`g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

95 *
	`g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

96 
	`g‘KeysF»eResuÉ
(*
»suÉ
);

97 *
	`zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

98 *
	`ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

99 *
	`sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

100 *
	`mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

102 
	`ãtchIÁ”ÇlDbByKey
(
ş›Á
 *
c
, 
robj
 *
key
);

103 
	`ãtchIÁ”ÇlDbById
(
ş›Á
 *
c
, 
idx
);

105 
	`ŒyResizeHashTabËsFÜDb
(
dbid
);

106 
	`šüem’ÎyRehashFÜDb
(
dbid
);

107 
	`aùiveExpœeCyşe
(
vr_back’d
 *
back’d
, 
ty³
);

108 
	`aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
);

109 
	`d©aba£sCrÚ
(
vr_back’d
 *
back’d
);

	@src/vr_dict.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<¡d¬g.h
>

5 
	~<lim™s.h
>

6 
	~<sys/time.h
>

7 
	~<ùy³.h
>

9 
	~<vr_cÜe.h
>

19 
	gdiù_ÿn_»size
 = 1;

20 
	gdiù_fÜû_»size_¿tio
 = 5;

24 
_diùEx·ndIfN“ded
(
diù
 *
ht
);

25 
_diùNextPow”
(
size
);

26 
_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
);

27 
_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

32 
	$diùIÁHashFunùiÚ
(
key
)

34 
key
 += ~(key << 15);

35 
key
 ^= (key >> 10);

36 
key
 += (key << 3);

37 
key
 ^= (key >> 6);

38 
key
 += ~(key << 11);

39 
key
 ^= (key >> 16);

40  
key
;

41 
	}
}

43 
ušt32_t
 
	gdiù_hash_funùiÚ_£ed
 = 5381;

45 
	$diùS‘HashFunùiÚS“d
(
ušt32_t
 
£ed
) {

46 
diù_hash_funùiÚ_£ed
 = 
£ed
;

47 
	}
}

49 
ušt32_t
 
	$diùG‘HashFunùiÚS“d
() {

50  
diù_hash_funùiÚ_£ed
;

51 
	}
}

64 
	$diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
) {

67 
ušt32_t
 
£ed
 = 
diù_hash_funùiÚ_£ed
;

68 cÚ¡ 
ušt32_t
 
m
 = 0x5bd1e995;

69 cÚ¡ 
r
 = 24;

72 
ušt32_t
 
h
 = 
£ed
 ^ 
Ën
;

75 cÚ¡ *
d©a
 = (cÚ¡ *)
key
;

77 
Ën
 >= 4) {

78 
ušt32_t
 
k
 = *(ušt32_t*)
d©a
;

80 
k
 *ğ
m
;

81 
k
 ^ğk >> 
r
;

82 
k
 *ğ
m
;

84 
h
 *ğ
m
;

85 
h
 ^ğ
k
;

87 
d©a
 += 4;

88 
Ën
 -= 4;

92 
Ën
) {

93 3: 
h
 ^ğ
d©a
[2] << 16;

94 2: 
h
 ^ğ
d©a
[1] << 8;

95 1: 
h
 ^ğ
d©a
[0]; h *ğ
m
;

100 
h
 ^= h >> 13;

101 
h
 *ğ
m
;

102 
h
 ^= h >> 15;

104  ()
h
;

105 
	}
}

108 
	$diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
) {

109 
hash
 = ()
diù_hash_funùiÚ_£ed
;

111 
Ën
--)

112 
hash
 = ((hash << 5è+ hashè+ (
	`tŞow”
(*
buf
++));

113  
hash
;

114 
	}
}

120 
	$_diùRe£t
(
diùht
 *
ht
)

122 
ht
->
bË
 = 
NULL
;

123 
ht
->
size
 = 0;

124 
ht
->
sizemask
 = 0;

125 
ht
->
u£d
 = 0;

126 
	}
}

129 
diù
 *
	$diùC»©e
(
diùTy³
 *
ty³
,

130 *
´ivD©aPŒ
)

132 
diù
 *
d
 = 
	`d®loc
((*d));

134 
	`_diùIn™
(
d
,
ty³
,
´ivD©aPŒ
);

135  
d
;

136 
	}
}

139 
	$_diùIn™
(
diù
 *
d
, 
diùTy³
 *
ty³
,

140 *
´ivD©aPŒ
)

142 
	`_diùRe£t
(&
d
->
ht
[0]);

143 
	`_diùRe£t
(&
d
->
ht
[1]);

144 
d
->
ty³
 =ype;

145 
d
->
´ivd©a
 = 
´ivD©aPŒ
;

146 
d
->
»hashidx
 = -1;

147 
d
->
™”©Üs
 = 0;

148  
DICT_OK
;

149 
	}
}

153 
	$diùResize
(
diù
 *
d
)

155 
mšim®
;

157 ià(!
diù_ÿn_»size
 || 
	`diùIsRehashšg
(
d
)è 
DICT_ERR
;

158 
mšim®
 = 
d
->
ht
[0].
u£d
;

159 ià(
mšim®
 < 
DICT_HT_INITIAL_SIZE
)

160 
mšim®
 = 
DICT_HT_INITIAL_SIZE
;

161  
	`diùEx·nd
(
d
, 
mšim®
);

162 
	}
}

165 
	$diùEx·nd
(
diù
 *
d
, 
size
)

167 
diùht
 
n
;

168 
»®size
 = 
	`_diùNextPow”
(
size
);

172 ià(
	`diùIsRehashšg
(
d
è|| d->
ht
[0].
u£d
 > 
size
)

173  
DICT_ERR
;

176 ià(
»®size
 =ğ
d
->
ht
[0].
size
è 
DICT_ERR
;

179 
n
.
size
 = 
»®size
;

180 
n
.
sizemask
 = 
»®size
-1;

181 
n
.
bË
 = 
	`dÿÎoc
(
»®size
, (
diùEÁry
*));

182 
n
.
u£d
 = 0;

186 ià(
d
->
ht
[0].
bË
 =ğ
NULL
) {

187 
d
->
ht
[0] = 
n
;

188  
DICT_OK
;

192 
d
->
ht
[1] = 
n
;

193 
d
->
»hashidx
 = 0;

194  
DICT_OK
;

195 
	}
}

206 
	$diùRehash
(
diù
 *
d
, 
n
) {

207 
em±y_vis™s
 = 
n
*10;

208 ià(!
	`diùIsRehashšg
(
d
))  0;

210 
n
-- && 
d
->
ht
[0].
u£d
 != 0) {

211 
diùEÁry
 *
de
, *
Ãxtde
;

215 
	`ASSERT
(
d
->
ht
[0].
size
 > ()d->
»hashidx
);

216 
d
->
ht
[0].
bË
[d->
»hashidx
] =ğ
NULL
) {

217 
d
->
»hashidx
++;

218 ià(--
em±y_vis™s
 == 0)  1;

220 
de
 = 
d
->
ht
[0].
bË
[d->
»hashidx
];

222 
de
) {

223 
h
;

225 
Ãxtde
 = 
de
->
Ãxt
;

227 
h
 = 
	`diùHashKey
(
d
, 
de
->
key
è& d->
ht
[1].
sizemask
;

228 
de
->
Ãxt
 = 
d
->
ht
[1].
bË
[
h
];

229 
d
->
ht
[1].
bË
[
h
] = 
de
;

230 
d
->
ht
[0].
u£d
--;

231 
d
->
ht
[1].
u£d
++;

232 
de
 = 
Ãxtde
;

234 
d
->
ht
[0].
bË
[d->
»hashidx
] = 
NULL
;

235 
d
->
»hashidx
++;

239 ià(
d
->
ht
[0].
u£d
 == 0) {

240 
	`dä“
(
d
->
ht
[0].
bË
);

241 
d
->
ht
[0] = d->ht[1];

242 
	`_diùRe£t
(&
d
->
ht
[1]);

243 
d
->
»hashidx
 = -1;

249 
	}
}

251 
	$timeInMli£cÚds
() {

252 
timev®
 
tv
;

254 
	`g‘timeofday
(&
tv
,
NULL
);

255  ((()
tv
.
tv_£c
)*1000)+Ñv.
tv_u£c
/1000);

256 
	}
}

259 
	$diùRehashMli£cÚds
(
diù
 *
d
, 
ms
) {

260 
¡¬t
 = 
	`timeInMli£cÚds
();

261 
»hashes
 = 0;

263 
	`diùRehash
(
d
,100)) {

264 
»hashes
 += 100;

265 ià(
	`timeInMli£cÚds
()-
¡¬t
 > 
ms
) ;

267  
»hashes
;

268 
	}
}

278 
	$_diùRehashS‹p
(
diù
 *
d
) {

279 ià(
d
->
™”©Üs
 =ğ0è
	`diùRehash
(d,1);

280 
	}
}

283 
	$diùAdd
(
diù
 *
d
, *
key
, *
v®
)

285 
diùEÁry
 *
’Œy
 = 
	`diùAddRaw
(
d
,
key
);

287 ià(!
’Œy
è 
DICT_ERR
;

288 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

289  
DICT_OK
;

290 
	}
}

307 
diùEÁry
 *
	$diùAddRaw
(
diù
 *
d
, *
key
)

309 
šdex
;

310 
diùEÁry
 *
’Œy
;

311 
diùht
 *
ht
;

313 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

317 ià((
šdex
 = 
	`_diùKeyIndex
(
d
, 
key
)) == -1)

318  
NULL
;

324 
ht
 = 
	`diùIsRehashšg
(
d
) ? &d->ht[1] : &d->ht[0];

325 
’Œy
 = 
	`d®loc
((*entry));

326 
’Œy
->
Ãxt
 = 
ht
->
bË
[
šdex
];

327 
ht
->
bË
[
šdex
] = 
’Œy
;

328 
ht
->
u£d
++;

331 
	`diùS‘Key
(
d
, 
’Œy
, 
key
);

332  
’Œy
;

333 
	}
}

339 
	$diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
)

341 
diùEÁry
 *
’Œy
, 
aux’Œy
;

345 ià(
	`diùAdd
(
d
, 
key
, 
v®
è=ğ
DICT_OK
)

348 
’Œy
 = 
	`diùFšd
(
d
, 
key
);

354 
aux’Œy
 = *
’Œy
;

355 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

356 
	`diùF»eV®
(
d
, &
aux’Œy
);

358 
	}
}

366 
diùEÁry
 *
	$diùR•ÏûRaw
(
diù
 *
d
, *
key
) {

367 
diùEÁry
 *
’Œy
 = 
	`diùFšd
(
d
,
key
);

369  
’Œy
 ?ƒÁry : 
	`diùAddRaw
(
d
,
key
);

370 
	}
}

373 
	$diùG’”icD–‘e
(
diù
 *
d
, cÚ¡ *
key
, 
noä“
)

375 
h
, 
idx
;

376 
diùEÁry
 *
he
, *
´evHe
;

377 
bË
;

379 ià(
d
->
ht
[0].
size
 =ğ0è 
DICT_ERR
;

380 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

381 
h
 = 
	`diùHashKey
(
d
, 
key
);

383 
bË
 = 0;able <= 1;able++) {

384 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

385 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

386 
´evHe
 = 
NULL
;

387 
he
) {

388 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key)) {

390 ià(
´evHe
)

391 
´evHe
->
Ãxt
 = 
he
->next;

393 
d
->
ht
[
bË
].bË[
idx
] = 
he
->
Ãxt
;

394 ià(!
noä“
) {

395 
	`diùF»eKey
(
d
, 
he
);

396 
	`diùF»eV®
(
d
, 
he
);

398 
	`dä“
(
he
);

399 
d
->
ht
[
bË
].
u£d
--;

400  
DICT_OK
;

402 
´evHe
 = 
he
;

403 
he
 = he->
Ãxt
;

405 ià(!
	`diùIsRehashšg
(
d
)) ;

407  
DICT_ERR
;

408 
	}
}

410 
	$diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
) {

411  
	`diùG’”icD–‘e
(
ht
,
key
,0);

412 
	}
}

414 
	$diùD–‘eNoF»e
(
diù
 *
ht
, cÚ¡ *
key
) {

415  
	`diùG’”icD–‘e
(
ht
,
key
,1);

416 
	}
}

419 
_diùCË¬
(
diù
 *
d
, 
diùht
 *
ht
, (
ÿÎback
)(*)) {

420 
i
;

423 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

424 
diùEÁry
 *
he
, *
ÃxtHe
;

426 ià(
ÿÎback
 && (
i
 & 65535è=ğ0è
	`ÿÎback
(
d
->
´ivd©a
);

428 ià((
he
 = 
ht
->
bË
[
i
]è=ğ
NULL
) ;

429 
he
) {

430 
ÃxtHe
 = 
he
->
Ãxt
;

431 
	`diùF»eKey
(
d
, 
he
);

432 
	`diùF»eV®
(
d
, 
he
);

433 
	`dä“
(
he
);

434 
ht
->
u£d
--;

435 
he
 = 
ÃxtHe
;

439 if(
ht
->
bË
è
	`dä“
(ht->table);

441 
	`_diùRe£t
(
ht
);

442  
DICT_OK
;

443 
	}
}

446 
	$diùR–—£
(
diù
 *
d
)

448 
	`_diùCË¬
(
d
,&d->
ht
[0],
NULL
);

449 
	`_diùCË¬
(
d
,&d->
ht
[1],
NULL
);

450 
	`dä“
(
d
);

451 
	}
}

453 
diùEÁry
 *
	$diùFšd
(
diù
 *
d
, cÚ¡ *
key
)

455 
diùEÁry
 *
he
;

456 
h
, 
idx
, 
bË
;

458 ià(
d
->
ht
[0].
u£d
 + d->ht[1].u£d =ğ0è 
NULL
;

460 
h
 = 
	`diùHashKey
(
d
, 
key
);

461 
bË
 = 0;able <= 1;able++) {

462 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

463 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

464 
he
) {

465 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

466  
he
;

467 
he
 = he->
Ãxt
;

469 ià(!
	`diùIsRehashšg
(
d
)è 
NULL
;

471  
NULL
;

472 
	}
}

474 *
	$diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
) {

475 
diùEÁry
 *
he
;

477 
he
 = 
	`diùFšd
(
d
,
key
);

478  
he
 ? 
	`diùG‘V®
(heè: 
NULL
;

479 
	}
}

487 
	$diùFšg”´št
(
diù
 *
d
) {

488 
š‹g”s
[6], 
hash
 = 0;

489 
j
;

491 
š‹g”s
[0] = (è
d
->
ht
[0].
bË
;

492 
š‹g”s
[1] = 
d
->
ht
[0].
size
;

493 
š‹g”s
[2] = 
d
->
ht
[0].
u£d
;

494 
š‹g”s
[3] = (è
d
->
ht
[1].
bË
;

495 
š‹g”s
[4] = 
d
->
ht
[1].
size
;

496 
š‹g”s
[5] = 
d
->
ht
[1].
u£d
;

505 
j
 = 0; j < 6; j++) {

506 
hash
 +ğ
š‹g”s
[
j
];

508 
hash
 = (~hash) + (hash << 21);

509 
hash
 = hash ^ (hash >> 24);

510 
hash
 = (hash + (hash << 3)) + (hash << 8);

511 
hash
 = hash ^ (hash >> 14);

512 
hash
 = (hash + (hash << 2)) + (hash << 4);

513 
hash
 = hash ^ (hash >> 28);

514 
hash
 = hash + (hash << 31);

516  
hash
;

517 
	}
}

519 
diùI‹¿tÜ
 *
	$diùG‘I‹¿tÜ
(
diù
 *
d
)

521 
diùI‹¿tÜ
 *
™”
 = 
	`d®loc
((*iter));

523 
™”
->
d
 = d;

524 
™”
->
bË
 = 0;

525 
™”
->
šdex
 = -1;

526 
™”
->
§ã
 = 0;

527 
™”
->
’Œy
 = 
NULL
;

528 
™”
->
ÃxtEÁry
 = 
NULL
;

529  
™”
;

530 
	}
}

532 
diùI‹¿tÜ
 *
	$diùG‘SaãI‹¿tÜ
(
diù
 *
d
) {

533 
diùI‹¿tÜ
 *
i
 = 
	`diùG‘I‹¿tÜ
(
d
);

535 
i
->
§ã
 = 1;

536  
i
;

537 
	}
}

539 
diùEÁry
 *
	$diùNext
(
diùI‹¿tÜ
 *
™”
)

542 ià(
™”
->
’Œy
 =ğ
NULL
) {

543 
diùht
 *
ht
 = &
™”
->
d
->ht[™”->
bË
];

544 ià(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0) {

545 ià(
™”
->
§ã
)

546 
™”
->
d
->
™”©Üs
++;

548 
™”
->
fšg”´št
 = 
	`diùFšg”´št
(™”->
d
);

550 
™”
->
šdex
++;

551 ià(
™”
->
šdex
 >ğ(è
ht
->
size
) {

552 ià(
	`diùIsRehashšg
(
™”
->
d
è&& i‹r->
bË
 == 0) {

553 
™”
->
bË
++;

554 
™”
->
šdex
 = 0;

555 
ht
 = &
™”
->
d
->ht[1];

560 
™”
->
’Œy
 = 
ht
->
bË
[™”->
šdex
];

562 
™”
->
’Œy
 = i‹r->
ÃxtEÁry
;

564 ià(
™”
->
’Œy
) {

567 
™”
->
ÃxtEÁry
 = i‹r->
’Œy
->
Ãxt
;

568  
™”
->
’Œy
;

571  
NULL
;

572 
	}
}

574 
	$diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
)

576 ià(!(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0)) {

577 ià(
™”
->
§ã
) {

578 
™”
->
d
->
™”©Üs
--;

580 
hv
 = 
	`diùFšg”´št
(
™”
->
d
);

581 
	`ASSERT
(
™”
->
fšg”´št
 =ğ
hv
);

584 
	`dä“
(
™”
);

585 
	}
}

589 
diùEÁry
 *
	$diùG‘RªdomKey
(
diù
 *
d
)

591 
diùEÁry
 *
he
, *
Üighe
;

592 
h
;

593 
li¡Ën
, 
li¡–e
;

595 ià(
	`diùSize
(
d
è=ğ0è 
NULL
;

596 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

597 ià(
	`diùIsRehashšg
(
d
)) {

601 
h
 = 
d
->
»hashidx
 + (
	`¿ndom
(è% (d->
ht
[0].
size
 +

602 
d
->
ht
[1].
size
 -

603 
d
->
»hashidx
));

604 
he
 = (
h
 >ğ
d
->
ht
[0].
size
è? d->ht[1].
bË
[h - d->ht[0].size] :

605 
d
->
ht
[0].
bË
[
h
];

606 } 
he
 =ğ
NULL
);

609 
h
 = 
	`¿ndom
(è& 
d
->
ht
[0].
sizemask
;

610 
he
 = 
d
->
ht
[0].
bË
[
h
];

611 } 
he
 =ğ
NULL
);

618 
li¡Ën
 = 0;

619 
Üighe
 = 
he
;

620 
he
) {

621 
he
 = he->
Ãxt
;

622 
li¡Ën
++;

624 
li¡–e
 = 
	`¿ndom
(è% 
li¡Ën
;

625 
he
 = 
Üighe
;

626 
li¡–e
--è
he
 = he->
Ãxt
;

627  
he
;

628 
	}
}

652 
	$diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
) {

653 
j
;

654 
bËs
;

655 
¡Üed
 = 0, 
maxsizemask
;

656 
max¡•s
;

658 ià(
	`diùSize
(
d
è< 
couÁ
) count = dictSize(d);

659 
max¡•s
 = 
couÁ
*10;

662 
j
 = 0; j < 
couÁ
; j++) {

663 ià(
	`diùIsRehashšg
(
d
))

664 
	`_diùRehashS‹p
(
d
);

669 
bËs
 = 
	`diùIsRehashšg
(
d
) ? 2 : 1;

670 
maxsizemask
 = 
d
->
ht
[0].
sizemask
;

671 ià(
bËs
 > 1 && 
maxsizemask
 < 
d
->
ht
[1].
sizemask
)

672 
maxsizemask
 = 
d
->
ht
[1].
sizemask
;

675 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

676 
em±yËn
 = 0;

677 
¡Üed
 < 
couÁ
 && 
max¡•s
--) {

678 
j
 = 0; j < 
bËs
; j++) {

682 ià(
bËs
 =ğ2 && 
j
 =ğ0 && 
i
 < (è
d
->
»hashidx
) {

687 ià(
i
 >ğ
d
->
ht
[1].
size
è˜ğd->
»hashidx
;

690 ià(
i
 >ğ
d
->
ht
[
j
].
size
) ;

691 
diùEÁry
 *
he
 = 
d
->
ht
[
j
].
bË
[
i
];

695 ià(
he
 =ğ
NULL
) {

696 
em±yËn
++;

697 ià(
em±yËn
 >ğ5 &&ƒm±yËÀ> 
couÁ
) {

698 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

699 
em±yËn
 = 0;

702 
em±yËn
 = 0;

703 
he
) {

706 *
des
 = 
he
;

707 
des
++;

708 
he
 = he->
Ãxt
;

709 
¡Üed
++;

710 ià(
¡Üed
 =ğ
couÁ
)  stored;

714 
i
 = (i+1è& 
maxsizemask
;

716  
¡Üed
;

717 
	}
}

721 
	$»v
(
v
) {

722 
s
 = 8 * (
v
);

723 
mask
 = ~0;

724 (
s
 >>= 1) > 0) {

725 
mask
 ^ğ(mask << 
s
);

726 
v
 = ((v >> 
s
è& 
mask
) | ((v << s) & ~mask);

728  
v
;

729 
	}
}

815 
	$diùSÿn
(
diù
 *
d
,

816 
v
,

817 
diùSÿnFunùiÚ
 *
â
,

818 *
´ivd©a
)

820 
diùht
 *
t0
, *
t1
;

821 cÚ¡ 
diùEÁry
 *
de
;

822 
m0
, 
m1
;

824 ià(
	`diùSize
(
d
) == 0)  0;

826 ià(!
	`diùIsRehashšg
(
d
)) {

827 
t0
 = &(
d
->
ht
[0]);

828 
m0
 = 
t0
->
sizemask
;

831 
de
 = 
t0
->
bË
[
v
 & 
m0
];

832 
de
) {

833 
	`â
(
´ivd©a
, 
de
);

834 
de
 = de->
Ãxt
;

838 
t0
 = &
d
->
ht
[0];

839 
t1
 = &
d
->
ht
[1];

842 ià(
t0
->
size
 > 
t1
->size) {

843 
t0
 = &
d
->
ht
[1];

844 
t1
 = &
d
->
ht
[0];

847 
m0
 = 
t0
->
sizemask
;

848 
m1
 = 
t1
->
sizemask
;

851 
de
 = 
t0
->
bË
[
v
 & 
m0
];

852 
de
) {

853 
	`â
(
´ivd©a
, 
de
);

854 
de
 = de->
Ãxt
;

861 
de
 = 
t1
->
bË
[
v
 & 
m1
];

862 
de
) {

863 
	`â
(
´ivd©a
, 
de
);

864 
de
 = de->
Ãxt
;

868 
v
 = (((v | 
m0
) + 1) & ~m0) | (v & m0);

871 } 
v
 & (
m0
 ^ 
m1
));

876 
v
 |ğ~
m0
;

879 
v
 = 
	`»v
(v);

880 
v
++;

881 
v
 = 
	`»v
(v);

883  
v
;

884 
	}
}

889 
	$_diùEx·ndIfN“ded
(
diù
 *
d
)

892 ià(
	`diùIsRehashšg
(
d
)è 
DICT_OK
;

895 ià(
d
->
ht
[0].
size
 =ğ0è 
	`diùEx·nd
(d, 
DICT_HT_INITIAL_SIZE
);

901 ià(
d
->
ht
[0].
u£d
 >ğd->ht[0].
size
 &&

902 (
diù_ÿn_»size
 ||

903 
d
->
ht
[0].
u£d
/d->ht[0].
size
 > 
diù_fÜû_»size_¿tio
))

905  
	`diùEx·nd
(
d
, d->
ht
[0].
u£d
*2);

907  
DICT_OK
;

908 
	}
}

911 
	$_diùNextPow”
(
size
)

913 
i
 = 
DICT_HT_INITIAL_SIZE
;

915 ià(
size
 >ğ
LONG_MAX
)  LONG_MAX;

917 ià(
i
 >ğ
size
)

918  
i
;

919 
i
 *= 2;

921 
	}
}

929 
	$_diùKeyIndex
(
diù
 *
d
, cÚ¡ *
key
)

931 
h
, 
idx
, 
bË
;

932 
diùEÁry
 *
he
;

935 ià(
	`_diùEx·ndIfN“ded
(
d
è=ğ
DICT_ERR
)

938 
h
 = 
	`diùHashKey
(
d
, 
key
);

939 
bË
 = 0;able <= 1;able++) {

940 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

942 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

943 
he
) {

944 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

946 
he
 = he->
Ãxt
;

948 ià(!
	`diùIsRehashšg
(
d
)) ;

950  
idx
;

951 
	}
}

953 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*)) {

954 
	`_diùCË¬
(
d
,&d->
ht
[0],
ÿÎback
);

955 
	`_diùCË¬
(
d
,&d->
ht
[1],
ÿÎback
);

956 
d
->
»hashidx
 = -1;

957 
d
->
™”©Üs
 = 0;

958 
	}
}

960 
	$diùEÇbËResize
() {

961 
diù_ÿn_»size
 = 1;

962 
	}
}

964 
	$diùDi§bËResize
() {

965 
diù_ÿn_»size
 = 0;

966 
	}
}

970 
	#DICT_STATS_VECTLEN
 50

	)

971 
size_t
 
	$_diùG‘StsHt
(*
buf
, 
size_t
 
bufsize
, 
diùht
 *
ht
, 
bËid
) {

972 
i
, 
¦Ùs
 = 0, 
chašËn
, 
maxchašËn
 = 0;

973 
tÙchašËn
 = 0;

974 
şveùÜ
[
DICT_STATS_VECTLEN
];

975 
size_t
 
l
 = 0;

977 ià(
ht
->
u£d
 == 0) {

978  
	`¢´štf
(
buf
,
bufsize
,

983 
i
 = 0; i < 
DICT_STATS_VECTLEN
; i++è
şveùÜ
[i] = 0;

984 
i
 = 0; i < 
ht
->
size
; i++) {

985 
diùEÁry
 *
he
;

987 ià(
ht
->
bË
[
i
] =ğ
NULL
) {

988 
şveùÜ
[0]++;

991 
¦Ùs
++;

993 
chašËn
 = 0;

994 
he
 = 
ht
->
bË
[
i
];

995 
he
) {

996 
chašËn
++;

997 
he
 = he->
Ãxt
;

999 
şveùÜ
[(
chašËn
 < 
DICT_STATS_VECTLEN
) ? chainlen : (DICT_STATS_VECTLEN-1)]++;

1000 ià(
chašËn
 > 
maxchašËn
) maxchainlen = chainlen;

1001 
tÙchašËn
 +ğ
chašËn
;

1005 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1014 
bËid
, (tableid == 0) ? "main hashable" : "rehashingarget",

1015 
ht
->
size
, ht->
u£d
, 
¦Ùs
, 
maxchašËn
,

1016 ()
tÙchašËn
/
¦Ùs
, ()
ht
->
u£d
/slots);

1018 
i
 = 0; i < 
DICT_STATS_VECTLEN
-1; i++) {

1019 ià(
şveùÜ
[
i
] == 0) ;

1020 ià(
l
 >ğ
bufsize
) ;

1021 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1023 (
i
 =ğ
DICT_STATS_VECTLEN
-1)?">= ":"",

1024 
i
, 
şveùÜ
[i], (()şveùÜ[i]/
ht
->
size
)*100);

1028 ià(
bufsize
è
buf
[bufsize-1] = '\0';

1029  
	`¡¾’
(
buf
);

1030 
	}
}

1032 
	$diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
) {

1033 
size_t
 
l
;

1034 *
Üig_buf
 = 
buf
;

1035 
size_t
 
Üig_bufsize
 = 
bufsize
;

1037 
l
 = 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[0],0);

1038 
buf
 +ğ
l
;

1039 
bufsize
 -ğ
l
;

1040 ià(
	`diùIsRehashšg
(
d
è&& 
bufsize
 > 0) {

1041 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[1],1);

1044 ià(
Üig_bufsize
è
Üig_buf
[orig_bufsize-1] = '\0';

1045 
	}
}

	@src/vr_dict.h

1 #iâdeà
_VR_DICT_H_


2 
	#_VR_DICT_H_


	)

4 
	~<¡dšt.h
>

6 
	#DICT_OK
 0

	)

7 
	#DICT_ERR
 1

	)

10 
	#DICT_NOTUSED
(
V
è((èV)

	)

12 
	sdiùEÁry
 {

13 *
	mkey
;

15 *
	mv®
;

16 
ušt64_t
 
	mu64
;

17 
št64_t
 
	ms64
;

18 
	md
;

19 } 
	mv
;

20 
diùEÁry
 *
	mÃxt
;

21 } 
	tdiùEÁry
;

23 
	sdiùTy³
 {

24 (*
	mhashFunùiÚ
)(cÚ¡ *
	mkey
);

25 *(*
	mkeyDup
)(*
	m´ivd©a
, cÚ¡ *
	mkey
);

26 *(*
	mv®Dup
)(*
	m´ivd©a
, cÚ¡ *
	mobj
);

27 (*
	mkeyCom·»
)(*
	m´ivd©a
, cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

28 (*
	mkeyDe¡ruùÜ
)(*
	m´ivd©a
, *
	mkey
);

29 (*
	mv®De¡ruùÜ
)(*
	m´ivd©a
, *
	mobj
);

30 } 
	tdiùTy³
;

34 
	sdiùht
 {

35 
diùEÁry
 **
	mbË
;

36 
	msize
;

37 
	msizemask
;

38 
	mu£d
;

39 } 
	tdiùht
;

41 
	sdiù
 {

42 
diùTy³
 *
	mty³
;

43 *
	m´ivd©a
;

44 
diùht
 
	mht
[2];

45 
	m»hashidx
;

46 
	m™”©Üs
;

47 } 
	tdiù
;

53 
	sdiùI‹¿tÜ
 {

54 
diù
 *
	md
;

55 
	mšdex
;

56 
	mbË
, 
	m§ã
;

57 
diùEÁry
 *
	m’Œy
, *
	mÃxtEÁry
;

59 
	mfšg”´št
;

60 } 
	tdiùI‹¿tÜ
;

62 (
	tdiùSÿnFunùiÚ
)(*
	t´ivd©a
, cÚ¡ 
	tdiùEÁry
 *
	tde
);

65 
	#DICT_HT_INITIAL_SIZE
 4

	)

68 
	#diùF»eV®
(
d
, 
’Œy
) \

69 ià((
d
)->
ty³
->
v®De¡ruùÜ
) \

70 (
d
)->
ty³
->
	`v®De¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
v
.
v®
)

	)

72 
	#diùS‘V®
(
d
, 
’Œy
, 
_v®_
) do { \

73 ià((
d
)->
ty³
->
v®Dup
) \

74 
’Œy
->
v
.
v®
 = (
d
)->
ty³
->
	`v®Dup
((d)->
´ivd©a
, 
_v®_
); \

76 
’Œy
->
v
.
v®
 = (
_v®_
); \

77 
	}
} 0)

	)

79 
	#diùS‘SigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

80 dØ{ 
’Œy
->
v
.
s64
 = 
_v®_
; } 0)

	)

82 
	#diùS‘UnsigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

83 dØ{ 
’Œy
->
v
.
u64
 = 
_v®_
; } 0)

	)

85 
	#diùS‘DoubËV®
(
’Œy
, 
_v®_
) \

86 dØ{ 
’Œy
->
v
.
d
 = 
_v®_
; } 0)

	)

88 
	#diùF»eKey
(
d
, 
’Œy
) \

89 ià((
d
)->
ty³
->
keyDe¡ruùÜ
) \

90 (
d
)->
ty³
->
	`keyDe¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
key
)

	)

92 
	#diùS‘Key
(
d
, 
’Œy
, 
_key_
) do { \

93 ià((
d
)->
ty³
->
keyDup
) \

94 
’Œy
->
key
 = (
d
)->
ty³
->
	`keyDup
((d)->
´ivd©a
, 
_key_
); \

96 
’Œy
->
key
 = (
_key_
); \

97 } 0)

	)

99 
	#diùCom·»Keys
(
d
, 
key1
, 
key2
) \

100 (((
d
)->
ty³
->
keyCom·»
) ? \

101 (
d
)->
ty³
->
	`keyCom·»
((d)->
´ivd©a
, 
key1
, 
key2
) : \

102 (
key1
è=ğ(
key2
))

	)

104 
	#diùHashKey
(
d
, 
key
è(d)->
ty³
->
	`hashFunùiÚ
(key)

	)

105 
	#diùG‘Key
(
he
è((he)->
key
)

	)

106 
	#diùG‘V®
(
he
è((he)->
v
.
v®
)

	)

107 
	#diùG‘SigÃdIÁeg”V®
(
he
è((he)->
v
.
s64
)

	)

108 
	#diùG‘UnsigÃdIÁeg”V®
(
he
è((he)->
v
.
u64
)

	)

109 
	#diùG‘DoubËV®
(
he
è((he)->
v
.
d
)

	)

110 
	#diùSlÙs
(
d
è((d)->
ht
[0].
size
+(d)->ht[1].size)

	)

111 
	#diùSize
(
d
è((d)->
ht
[0].
u£d
+(d)->ht[1].u£d)

	)

112 
	#diùIsRehashšg
(
d
è((d)->
»hashidx
 !ğ-1)

	)

115 
diù
 *
diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

116 
diùEx·nd
(
diù
 *
d
, 
size
);

117 
diùAdd
(
diù
 *
d
, *
key
, *
v®
);

118 
diùEÁry
 *
diùAddRaw
(
diù
 *
d
, *
key
);

119 
diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
);

120 
diùEÁry
 *
diùR•ÏûRaw
(
diù
 *
d
, *
key
);

121 
diùD–‘e
(
diù
 *
d
, cÚ¡ *
key
);

122 
diùD–‘eNoF»e
(
diù
 *
d
, cÚ¡ *
key
);

123 
diùR–—£
(
diù
 *
d
);

124 
diùEÁry
 * 
diùFšd
(
diù
 *
d
, cÚ¡ *
key
);

125 *
diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
);

126 
diùResize
(
diù
 *
d
);

127 
diùI‹¿tÜ
 *
diùG‘I‹¿tÜ
(
diù
 *
d
);

128 
diùI‹¿tÜ
 *
diùG‘SaãI‹¿tÜ
(
diù
 *
d
);

129 
diùEÁry
 *
diùNext
(
diùI‹¿tÜ
 *
™”
);

130 
diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
);

131 
diùEÁry
 *
diùG‘RªdomKey
(
diù
 *
d
);

132 
diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
);

133 
diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
);

134 
diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
);

135 
diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
);

136 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*));

137 
	`diùEÇbËResize
();

138 
	`diùDi§bËResize
();

139 
	`diùRehash
(
diù
 *
d
, 
n
);

140 
	`diùRehashMli£cÚds
(
diù
 *
d
, 
ms
);

141 
	`diùS‘HashFunùiÚS“d
(
š™v®
);

142 
	`diùG‘HashFunùiÚS“d
();

143 
	`diùSÿn
(
diù
 *
d
, 
v
, 
diùSÿnFunùiÚ
 *
â
, *
´ivd©a
);

146 
diùTy³
 
diùTy³H—pSŒšgCİyKey
;

147 
diùTy³
 
diùTy³H—pSŒšgs
;

148 
diùTy³
 
diùTy³H—pSŒšgCİyKeyV®ue
;

	@src/vr_eventloop.c

1 
	~<vr_cÜe.h
>

4 
	$vr_ev’oİ_š™
(
vr_ev’oİ
 *
v–
, 
f–im™
)

6 
r¡©us_t
 
¡©us
;

7 
maxş›Ás
, 
th»ads_num
;

9 ià(
v–
 =ğ
NULL
 || 
f–im™
 <= 0) {

10  
VR_ERROR
;

13 
	`vr_th»ad_š™
(&
v–
->
th»ad
);

14 
v–
->
–
 = 
NULL
;

15 
v–
->
hz
 = 10;

16 
v–
->
üÚloİs
 = 0;

17 
v–
->
unixtime
 = 
	`time
(
NULL
);

18 
v–
->
m¡ime
 = 
	`vr_m£c_now
();

19 
v–
->
Ìuşock
 = 
	`g‘LRUClock
();

20 
v–
->
cb
 = 
NULL
;

21 
v–
->
Ãxt_ş›Á_id
 = 1;

22 
v–
->
cu¼’t_ş›Á
 = 
NULL
;

23 
v–
->
ş›Ás
 = 
NULL
;

24 
v–
->
ş›Ás_³ndšg_wr™e
 = 
NULL
;

25 
v–
->
ş›Ás_to_şo£
 = 
NULL
;

26 
v–
->
ş›Ás_·u£d
 = 0;

27 
v–
->
ş›Ás_·u£_’d_time
 = 0;

28 
v–
->
¡©s
 = 
NULL
;

29 
v–
->
»sid’t_£t_size
 = 0;

30 
v–
->
dœty
 = 0;

31 
v–
->
bpİ_blocked_ş›Ás
 = 0;

32 
v–
->
unblocked_ş›Ás
 = 
NULL
;

33 
v–
->
ş›Ás_wa™šg_acks
 = 
NULL
;

34 
v–
->
pubsub_chªÃls
 = 
NULL
;

35 
v–
->
pubsub_·‰”ns
 = 
NULL
;

36 
v–
->
nÙify_key¥aû_ev’ts
 = 0;

37 
v–
->
c¡abË
 = 
NULL
;

39 
v–
->
–
 = 
	`«C»©eEv’tLoİ
(
f–im™
);

40 ià(
v–
->
–
 =ğ
NULL
) {

41 
	`log_”rÜ
("createƒventloop failed.");

42  
VR_ERROR
;

45 
v–
->
cb
 = 
	`d®loc
((
cÚn_ba£
));

46 ià(
v–
->
cb
 =ğ
NULL
) {

47 
	`log_”rÜ
("create conn_base failed: out of memory");

48  
VR_ENOMEM
;

50 
¡©us
 = 
	`cÚn_š™
(
v–
->
cb
);

51 ià(
¡©us
 !ğ
VR_OK
) {

52 
	`log_”rÜ
("init conn_base failed");

53  
VR_ERROR
;

56 
v–
->
ş›Ás
 = 
	`dli¡C»©e
();

57 ià(
v–
->
ş›Ás
 =ğ
NULL
) {

58 
	`log_”rÜ
("create†ist failed: out of memory");

59  
VR_ENOMEM
;

62 
v–
->
ş›Ás_³ndšg_wr™e
 = 
	`dli¡C»©e
();

63 ià(
v–
->
ş›Ás_³ndšg_wr™e
 =ğ
NULL
) {

64 
	`log_”rÜ
("create†ist failed: out of memory");

65  
VR_ENOMEM
;

68 
v–
->
ş›Ás_to_şo£
 = 
	`dli¡C»©e
();

69 ià(
v–
->
ş›Ás_to_şo£
 =ğ
NULL
) {

70 
	`log_”rÜ
("create†ist failed: out of memory");

71  
VR_ENOMEM
;

74 
v–
->
unblocked_ş›Ás
 = 
	`dli¡C»©e
();

75 ià(
v–
->
unblocked_ş›Ás
 =ğ
NULL
) {

76 
	`log_”rÜ
("create†ist failed: out of memory");

77  
VR_ENOMEM
;

80 
v–
->
¡©s
 = 
	`d®loc
((
vr_¡©s
));

81 ià(
v–
->
¡©s
 =ğ
NULL
) {

82 
	`log_”rÜ
("out of memory");

83  
VR_ENOMEM
;

86 
	`vr_¡©s_š™
(
v–
->
¡©s
);

88 
	`cÚf_ÿche_š™
(&
v–
->
cc
);

90  
VR_OK
;

91 
	}
}

94 
	$vr_ev’oİ_deš™
(
vr_ev’oİ
 *
v–
)

96 ià(
v–
 =ğ
NULL
) {

100 
	`vr_th»ad_deš™
(&
v–
->
th»ad
);

102 ià(
v–
->
–
 !ğ
NULL
) {

103 
	`«D–‘eEv’tLoİ
(
v–
->
–
);

104 
v–
->
–
 = 
NULL
;

107 ià(
v–
->
ş›Ás
 !ğ
NULL
) {

108 
ş›Á
 *
c
;

109 
c
 = 
	`dli¡Pİ
(
v–
->
ş›Ás
)) {

110 
	`ä“Cl›Á
(
c
);

112 
	`dli¡R–—£
(
v–
->
ş›Ás
);

113 
v–
->
ş›Ás
 = 
NULL
;

116 ià(
v–
->
ş›Ás_³ndšg_wr™e
 !ğ
NULL
) {

117 
ş›Á
 *
c
;

118 
c
 = 
	`dli¡Pİ
(
v–
->
ş›Ás_³ndšg_wr™e
)) {}

119 
	`dli¡R–—£
(
v–
->
ş›Ás_³ndšg_wr™e
);

120 
v–
->
ş›Ás_³ndšg_wr™e
 = 
NULL
;

123 ià(
v–
->
ş›Ás_to_şo£
 !ğ
NULL
) {

124 
ş›Á
 *
c
;

125 
c
 = 
	`dli¡Pİ
(
v–
->
ş›Ás_to_şo£
)) {

126 
	`ä“Cl›Á
(
c
);

128 
	`dli¡R–—£
(
v–
->
ş›Ás_to_şo£
);

129 
v–
->
ş›Ás_to_şo£
 = 
NULL
;

132 ià(
v–
->
unblocked_ş›Ás
 !ğ
NULL
) {

133 
ş›Á
 *
c
;

134 
c
 = 
	`dli¡Pİ
(
v–
->
unblocked_ş›Ás
)) {}

135 
	`dli¡R–—£
(
v–
->
unblocked_ş›Ás
);

136 
v–
->
unblocked_ş›Ás
 = 
NULL
;

139 ià(
v–
->
cb
 !ğ
NULL
) {

140 
	`cÚn_deš™
(
v–
->
cb
);

141 
	`dä“
(
v–
->
cb
);

142 
v–
->
cb
 = 
NULL
;

145 ià(
v–
->
¡©s
 !ğ
NULL
) {

146 
	`vr_¡©s_deš™
(
v–
->
¡©s
);

147 
	`dä“
(
v–
->
¡©s
);

148 
v–
->
¡©s
 = 
NULL
;

151 ià(
v–
->
c¡abË
 !ğ
NULL
) {

152 
	`commªdStsTabËDe¡roy
(
v–
->
c¡abË
);

153 
v–
->
c¡abË
 = 
NULL
;

156 
	`cÚf_ÿche_deš™
(&
v–
->
cc
);

157 
	}
}

	@src/vr_eventloop.h

1 #iâdeà
_VR_EVENTLOOP_H_


2 
	#_VR_EVENTLOOP_H_


	)

4 
	svr_ev’oİ
 {

5 
vr_th»ad
 
	mth»ad
;

7 
«Ev’tLoİ
 *
	m–
;

8 
	mhz
;

9 
	müÚloİs
;

12 
time_t
 
	munixtime
;

13 
	mm¡ime
;

15 
	mÌuşock
:
LRU_BITS
;

17 
cÚn_ba£
 *
	mcb
;

19 
ušt64_t
 
	mÃxt_ş›Á_id
;

20 
ş›Á
 *
	mcu¼’t_ş›Á
;

21 
dli¡
 *
	mş›Ás
;

22 
dli¡
 *
	mş›Ás_³ndšg_wr™e
;

23 
dli¡
 *
	mş›Ás_to_şo£
;

25 
	mş›Ás_·u£d
;

26 
	mş›Ás_·u£_’d_time
;

28 
vr_¡©s
 *
	m¡©s
;

29 
size_t
 
	m»sid’t_£t_size
;

31 
	mdœty
;

34 
	mbpİ_blocked_ş›Ás
;

35 
dli¡
 *
	munblocked_ş›Ás
;

38 
dli¡
 *
	mş›Ás_wa™šg_acks
;

41 
diù
 *
	mpubsub_chªÃls
;

42 
dli¡
 *
	mpubsub_·‰”ns
;

43 
	mnÙify_key¥aû_ev’ts
;

46 
cÚf_ÿche
 
	mcc
;

48 
d¬¿y
 *
	mc¡abË
;

49 }
	tvr_ev’oİ
;

51 
vr_ev’oİ_š™
(
vr_ev’oİ
 *
v–
, 
f–im™
);

52 
vr_ev’oİ_deš™
(
vr_ev’oİ
 *
v–
);

	@src/vr_hyperloglog.c

1 
	~<vr_cÜe.h
>

3 
	~<¡dšt.h
>

4 
	~<m©h.h
>

151 
	shÎhdr
 {

152 
	mmagic
[4];

153 
ušt8_t
 
	m’codšg
;

154 
ušt8_t
 
	mnÙu£d
[3];

155 
ušt8_t
 
	mÿrd
[8];

156 
ušt8_t
 
	m»gi¡”s
[];

160 
	#HLL_INVALIDATE_CACHE
(
hdr
è(hdr)->
ÿrd
[7] |ğ(1<<7)

	)

161 
	#HLL_VALID_CACHE
(
hdr
è(((hdr)->
ÿrd
[7] & (1<<7)è=ğ0)

	)

163 
	#HLL_P
 14

	)

164 
	#HLL_REGISTERS
 (1<<
HLL_P
è

	)

165 
	#HLL_P_MASK
 (
HLL_REGISTERS
-1è

	)

166 
	#HLL_BITS
 6

	)

167 
	#HLL_REGISTER_MAX
 ((1<<
HLL_BITS
)-1)

	)

168 
	#HLL_HDR_SIZE
 (
hÎhdr
)

	)

169 
	#HLL_DENSE_SIZE
 (
HLL_HDR_SIZE
+((
HLL_REGISTERS
*
HLL_BITS
+7)/8))

	)

170 
	#HLL_DENSE
 0

	)

171 
	#HLL_SPARSE
 1

	)

172 
	#HLL_RAW
 255

	)

173 
	#HLL_MAX_ENCODING
 1

	)

175 *
	gšv®id_hÎ_”r
 = "-INVALIDOBJ Corrupted HLL object detected\r\n";

306 
	#HLL_DENSE_GET_REGISTER
(
rg‘
,
p
,
»gnum
) do { \

307 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

308 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

309 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

310 
_fb8
 = 8 - 
_fb
; \

311 
b0
 = 
_p
[
_by‹
]; \

312 
b1
 = 
_p
[
_by‹
+1]; \

313 
rg‘
 = ((
b0
 >> 
_fb
è| (
b1
 << 
_fb8
)è& 
HLL_REGISTER_MAX
; \

314 } 0)

	)

318 
	#HLL_DENSE_SET_REGISTER
(
p
,
»gnum
,
v®
) do { \

319 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

320 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

321 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

322 
_fb8
 = 8 - 
_fb
; \

323 
_v
 = 
v®
; \

324 
_p
[
_by‹
] &ğ~(
HLL_REGISTER_MAX
 << 
_fb
); \

325 
_p
[
_by‹
] |ğ
_v
 << 
_fb
; \

326 
_p
[
_by‹
+1] &ğ~(
HLL_REGISTER_MAX
 >> 
_fb8
); \

327 
_p
[
_by‹
+1] |ğ
_v
 >> 
_fb8
; \

328 } 0)

	)

332 
	#HLL_SPARSE_XZERO_BIT
 0x40

	)

333 
	#HLL_SPARSE_VAL_BIT
 0x80

	)

334 
	#HLL_SPARSE_IS_ZERO
(
p
è(((*Õ)è& 0xc0è=ğ0è

	)

335 
	#HLL_SPARSE_IS_XZERO
(
p
è(((*Õ)è& 0xc0è=ğ
HLL_SPARSE_XZERO_BIT
)

	)

336 
	#HLL_SPARSE_IS_VAL
(
p
è((*Õ)è& 
HLL_SPARSE_VAL_BIT
)

	)

337 
	#HLL_SPARSE_ZERO_LEN
(
p
è(((*Õ)è& 0x3f)+1)

	)

338 
	#HLL_SPARSE_XZERO_LEN
(
p
è(((((*Õ)è& 0x3fè<< 8è| (*(Õ)+1)))+1)

	)

339 
	#HLL_SPARSE_VAL_VALUE
(
p
è((((*Õ)è>> 2è& 0x1f)+1)

	)

340 
	#HLL_SPARSE_VAL_LEN
(
p
è(((*Õ)è& 0x3)+1)

	)

341 
	#HLL_SPARSE_VAL_MAX_VALUE
 32

	)

342 
	#HLL_SPARSE_VAL_MAX_LEN
 4

	)

343 
	#HLL_SPARSE_ZERO_MAX_LEN
 64

	)

344 
	#HLL_SPARSE_XZERO_MAX_LEN
 16384

	)

345 
	#HLL_SPARSE_VAL_SET
(
p
,
v®
,
Ën
) do { \

346 *(
p
èğ(((
v®
)-1)<<2|((
Ën
)-1))|
HLL_SPARSE_VAL_BIT
; \

347 } 0)

	)

348 
	#HLL_SPARSE_ZERO_SET
(
p
,
Ën
) do { \

349 *(
p
èğ(
Ën
)-1; \

350 } 0)

	)

351 
	#HLL_SPARSE_XZERO_SET
(
p
,
Ën
) do { \

352 
_l
 = (
Ën
)-1; \

353 *(
p
èğ(
_l
>>8è| 
HLL_SPARSE_XZERO_BIT
; \

354 *((
p
)+1èğ(
_l
&0xff); \

355 } 0)

	)

362 
ušt64_t
 
	$MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
) {

363 cÚ¡ 
ušt64_t
 
m
 = 0xc6a4a7935bd1e995;

364 cÚ¡ 
r
 = 47;

365 
ušt64_t
 
h
 = 
£ed
 ^ (
Ën
 * 
m
);

366 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*)
key
;

367 cÚ¡ 
ušt8_t
 *
’d
 = 
d©a
 + (
Ën
-(len&7));

369 
d©a
 !ğ
’d
) {

370 
ušt64_t
 
k
;

372 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

373 
k
 = *((
ušt64_t
*)
d©a
);

375 
k
 = (
ušt64_t
è
d©a
[0];

376 
k
 |ğ(
ušt64_t
è
d©a
[1] << 8;

377 
k
 |ğ(
ušt64_t
è
d©a
[2] << 16;

378 
k
 |ğ(
ušt64_t
è
d©a
[3] << 24;

379 
k
 |ğ(
ušt64_t
è
d©a
[4] << 32;

380 
k
 |ğ(
ušt64_t
è
d©a
[5] << 40;

381 
k
 |ğ(
ušt64_t
è
d©a
[6] << 48;

382 
k
 |ğ(
ušt64_t
è
d©a
[7] << 56;

385 
k
 *ğ
m
;

386 
k
 ^ğk >> 
r
;

387 
k
 *ğ
m
;

388 
h
 ^ğ
k
;

389 
h
 *ğ
m
;

390 
d©a
 += 8;

393 
Ën
 & 7) {

394 7: 
h
 ^ğ(
ušt64_t
)
d©a
[6] << 48;

395 6: 
h
 ^ğ(
ušt64_t
)
d©a
[5] << 40;

396 5: 
h
 ^ğ(
ušt64_t
)
d©a
[4] << 32;

397 4: 
h
 ^ğ(
ušt64_t
)
d©a
[3] << 24;

398 3: 
h
 ^ğ(
ušt64_t
)
d©a
[2] << 16;

399 2: 
h
 ^ğ(
ušt64_t
)
d©a
[1] << 8;

400 1: 
h
 ^ğ(
ušt64_t
)
d©a
[0];

401 
h
 *ğ
m
;

404 
h
 ^ğh >> 
r
;

405 
h
 *ğ
m
;

406 
h
 ^ğh >> 
r
;

407  
h
;

408 
	}
}

413 
	$hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
) {

414 
ušt64_t
 
hash
, 
b™
, 
šdex
;

415 
couÁ
;

428 
hash
 = 
	`MurmurHash64A
(
–e
,
–esize
,0xadc83b19ULL);

429 
šdex
 = 
hash
 & 
HLL_P_MASK
;

430 
hash
 |ğ((
ušt64_t
)1<<63);

431 
b™
 = 
HLL_REGISTERS
;

432 
couÁ
 = 1;

433 (
hash
 & 
b™
) == 0) {

434 
couÁ
++;

435 
b™
 <<= 1;

437 *
»gp
 = (è
šdex
;

438  
couÁ
;

439 
	}
}

454 
	$hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
) {

455 
ušt8_t
 
ŞdcouÁ
, 
couÁ
;

456 
šdex
;

459 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

460 
	`HLL_DENSE_GET_REGISTER
(
ŞdcouÁ
,
»gi¡”s
,
šdex
);

461 ià(
couÁ
 > 
ŞdcouÁ
) {

462 
	`HLL_DENSE_SET_REGISTER
(
»gi¡”s
,
šdex
,
couÁ
);

467 
	}
}

473 
	$hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

474 
E
 = 0;

475 
j
, 
ez
 = 0;

480 ià(
HLL_REGISTERS
 =ğ16384 && 
HLL_BITS
 == 6) {

481 
ušt8_t
 *
r
 = 
»gi¡”s
;

482 
r0
, 
r1
, 
r2
, 
r3
, 
r4
, 
r5
, 
r6
, 
r7
, 
r8
, 
r9
,

483 
r10
, 
r11
, 
r12
, 
r13
, 
r14
, 
r15
;

484 
j
 = 0; j < 1024; j++) {

486 
r0
 = 
r
[0] & 63; iàÔ0 =ğ0è
ez
++;

487 
r1
 = (
r
[0] >> 6 |„[1] << 2è& 63; iàÔ1 =ğ0è
ez
++;

488 
r2
 = (
r
[1] >> 4 |„[2] << 4è& 63; iàÔ2 =ğ0è
ez
++;

489 
r3
 = (
r
[2] >> 2è& 63; iàÔ3 =ğ0è
ez
++;

490 
r4
 = 
r
[3] & 63; iàÔ4 =ğ0è
ez
++;

491 
r5
 = (
r
[3] >> 6 |„[4] << 2è& 63; iàÔ5 =ğ0è
ez
++;

492 
r6
 = (
r
[4] >> 4 |„[5] << 4è& 63; iàÔ6 =ğ0è
ez
++;

493 
r7
 = (
r
[5] >> 2è& 63; iàÔ7 =ğ0è
ez
++;

494 
r8
 = 
r
[6] & 63; iàÔ8 =ğ0è
ez
++;

495 
r9
 = (
r
[6] >> 6 |„[7] << 2è& 63; iàÔ9 =ğ0è
ez
++;

496 
r10
 = (
r
[7] >> 4 |„[8] << 4è& 63; iàÔ10 =ğ0è
ez
++;

497 
r11
 = (
r
[8] >> 2è& 63; iàÔ11 =ğ0è
ez
++;

498 
r12
 = 
r
[9] & 63; iàÔ12 =ğ0è
ez
++;

499 
r13
 = (
r
[9] >> 6 |„[10] << 2è& 63; iàÔ13 =ğ0è
ez
++;

500 
r14
 = (
r
[10] >> 4 |„[11] << 4è& 63; iàÔ14 =ğ0è
ez
++;

501 
r15
 = (
r
[11] >> 2è& 63; iàÔ15 =ğ0è
ez
++;

506 
E
 +ğ(
PE
[
r0
] + PE[
r1
]è+ (PE[
r2
] + PE[
r3
]è+ (PE[
r4
] + PE[
r5
]) +

507 (
PE
[
r6
] + PE[
r7
]è+ (PE[
r8
] + PE[
r9
]è+ (PE[
r10
] + PE[
r11
]) +

508 (
PE
[
r12
] + PE[
r13
]è+ (PE[
r14
] + PE[
r15
]);

509 
r
 += 12;

512 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

513 
»g
;

515 
	`HLL_DENSE_GET_REGISTER
(
»g
,
»gi¡”s
,
j
);

516 ià(
»g
 == 0) {

517 
ez
++;

520 
E
 +ğ
PE
[
»g
];

523 
E
 +ğ
ez
;

525 *
ezp
 = 
ez
;

526  
E
;

527 
	}
}

537 
	$hÎS·r£ToD’£
(
robj
 *
o
) {

538 
sds
 
¥¬£
 = 
o
->
±r
, 
d’£
;

539 
hÎhdr
 *
hdr
, *
Şdhdr
 = (hÎhdr*)
¥¬£
;

540 
idx
 = 0, 
ruÆ’
, 
»gv®
;

541 
ušt8_t
 *
p
 = (ušt8_t*)
¥¬£
, *
’d
 =…+
	`sd¦’
(sparse);

544 
hdr
 = (
hÎhdr
*è
¥¬£
;

545 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
è 
VR_OK
;

550 
d’£
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

551 
hdr
 = (
hÎhdr
*è
d’£
;

552 *
hdr
 = *
Şdhdr
;

553 
hdr
->
’codšg
 = 
HLL_DENSE
;

557 
p
 +ğ
HLL_HDR_SIZE
;

558 
p
 < 
’d
) {

559 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

560 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

561 
idx
 +ğ
ruÆ’
;

562 
p
++;

563 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

564 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

565 
idx
 +ğ
ruÆ’
;

566 
p
 += 2;

568 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

569 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

570 
ruÆ’
--) {

571 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
idx
,
»gv®
);

572 
idx
++;

574 
p
++;

580 ià(
idx
 !ğ
HLL_REGISTERS
) {

581 
	`sdsä“
(
d’£
);

582  
VR_ERROR
;

586 
	`sdsä“
(
o
->
±r
);

587 
o
->
±r
 = 
d’£
;

588  
VR_OK
;

589 
	}
}

607 
	$hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

608 
hÎhdr
 *
hdr
;

609 
ušt8_t
 
ŞdcouÁ
, 
couÁ
, *
¥¬£
, *
’d
, *
p
, *
´ev
, *
Ãxt
;

610 
šdex
, 
fœ¡
, 
¥ª
;

611 
is_z”o
 = 0, 
is_xz”o
 = 0, 
is_v®
 = 0, 
ruÆ’
 = 0;

614 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

618 ià(
couÁ
 > 
HLL_SPARSE_VAL_MAX_VALUE
è
´omÙe
;

625 
o
->
±r
 = 
	`sdsMakeRoomFÜ
(o->ptr,3);

629 
¥¬£
 = 
p
 = ((
ušt8_t
*)
o
->
±r
è+ 
HLL_HDR_SIZE
;

630 
’d
 = 
p
 + 
	`sd¦’
(
o
->
±r
è- 
HLL_HDR_SIZE
;

632 
fœ¡
 = 0;

633 
´ev
 = 
NULL
;

634 
Ãxt
 = 
NULL
;

635 
¥ª
 = 0;

636 
p
 < 
’d
) {

637 
İËn
;

644 
İËn
 = 1;

645 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

646 
¥ª
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

647 } ià(
	`HLL_SPARSE_IS_VAL
(
p
)) {

648 
¥ª
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

650 
¥ª
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

651 
İËn
 = 2;

654 ià(
šdex
 <ğ
fœ¡
+
¥ª
-1) ;

655 
´ev
 = 
p
;

656 
p
 +ğ
İËn
;

657 
fœ¡
 +ğ
¥ª
;

659 ià(
¥ª
 == 0)  -1;

661 
Ãxt
 = 
	`HLL_SPARSE_IS_XZERO
(
p
) ?…+2 :…+1;

662 ià(
Ãxt
 >ğ
’d
èÃxˆğ
NULL
;

667 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

668 
is_z”o
 = 1;

669 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

670 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

671 
is_xz”o
 = 1;

672 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

674 
is_v®
 = 1;

675 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

699 ià(
is_v®
) {

700 
ŞdcouÁ
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

702 ià(
ŞdcouÁ
 >ğ
couÁ
)  0;

705 ià(
ruÆ’
 == 1) {

706 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

707 
upd©ed
;

713 ià(
is_z”o
 && 
ruÆ’
 == 1) {

714 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

715 
upd©ed
;

733 
ušt8_t
 
£q
[5], *
n
 = seq;

734 
Ï¡
 = 
fœ¡
+
¥ª
-1;

735 
Ën
;

737 ià(
is_z”o
 || 
is_xz”o
) {

739 ià(
šdex
 !ğ
fœ¡
) {

740 
Ën
 = 
šdex
-
fœ¡
;

741 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

742 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

743 
n
 += 2;

745 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

746 
n
++;

749 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

750 
n
++;

751 ià(
šdex
 !ğ
Ï¡
) {

752 
Ën
 = 
Ï¡
-
šdex
;

753 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

754 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

755 
n
 += 2;

757 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

758 
n
++;

763 
curv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

765 ià(
šdex
 !ğ
fœ¡
) {

766 
Ën
 = 
šdex
-
fœ¡
;

767 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

768 
n
++;

770 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

771 
n
++;

772 ià(
šdex
 !ğ
Ï¡
) {

773 
Ën
 = 
Ï¡
-
šdex
;

774 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

775 
n
++;

783 
£qËn
 = 
n
-
£q
;

784 
ŞdËn
 = 
is_xz”o
 ? 2 : 1;

785 
d–Ën
 = 
£qËn
-
ŞdËn
;

787 ià(
d–Ën
 > 0 &&

788 
	`sd¦’
(
o
->
±r
)+
d–Ën
 > 
£rv”
.
hÎ_¥¬£_max_by‹s
è
´omÙe
;

789 ià(
d–Ën
 && 
Ãxt
è
	`memmove
Òext+d–Ën,Ãxt,
’d
-next);

790 
	`sdsInüL’
(
o
->
±r
,
d–Ën
);

791 
	`memıy
(
p
,
£q
,
£qËn
);

792 
’d
 +ğ
d–Ën
;

794 
upd©ed
:

800 
p
 = 
´ev
 ?…»v : 
¥¬£
;

801 
sÿÆ’
 = 5;

802 
p
 < 
’d
 && 
sÿÆ’
--) {

803 ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

804 
p
 += 2;

806 } ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

807 
p
++;

812 ià(
p
+1 < 
’d
 && 
	`HLL_SPARSE_IS_VAL
(p+1)) {

813 
v1
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

814 
v2
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
+1);

815 ià(
v1
 =ğ
v2
) {

816 
Ën
 = 
	`HLL_SPARSE_VAL_LEN
(
p
)+HLL_SPARSE_VAL_LEN(p+1);

817 ià(
Ën
 <ğ
HLL_SPARSE_VAL_MAX_LEN
) {

818 
	`HLL_SPARSE_VAL_SET
(
p
+1,
v1
,
Ën
);

819 
	`memmove
(
p
,p+1,
’d
-p);

820 
	`sdsInüL’
(
o
->
±r
,-1);

821 
’d
--;

829 
p
++;

833 
hdr
 = 
o
->
±r
;

834 
	`HLL_INVALIDATE_CACHE
(
hdr
);

837 
´omÙe
:

838 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
)  -1;

839 
hdr
 = 
o
->
±r
;

848 
d’£_»tv®
 = 
	`hÎD’£Add
(
hdr
->
»gi¡”s
, 
–e
, 
–esize
);

849 
	`ASSERT
(
d’£_»tv®
 == 1);

850  
d’£_»tv®
;

851 
	}
}

857 
	$hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
) {

858 
E
 = 0;

859 
ez
 = 0, 
idx
 = 0, 
ruÆ’
, 
»gv®
;

860 
ušt8_t
 *
’d
 = 
¥¬£
+
¥¬£Ën
, *
p
 = sparse;

862 
p
 < 
’d
) {

863 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

864 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

865 
idx
 +ğ
ruÆ’
;

866 
ez
 +ğ
ruÆ’
;

868 
p
++;

869 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

870 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

871 
idx
 +ğ
ruÆ’
;

872 
ez
 +ğ
ruÆ’
;

874 
p
 += 2;

876 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

877 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

878 
idx
 +ğ
ruÆ’
;

879 
E
 +ğ
PE
[
»gv®
]*
ruÆ’
;

880 
p
++;

883 ià(
idx
 !ğ
HLL_REGISTERS
 && 
šv®id
) *invalid = 1;

884 
E
 +ğ
ez
;

885 *
ezp
 = 
ez
;

886  
E
;

887 
	}
}

897 
	$hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

898 
E
 = 0;

899 
j
, 
ez
 = 0;

900 
ušt64_t
 *
wÜd
 = (ušt64_t*è
»gi¡”s
;

901 
ušt8_t
 *
by‹s
;

903 
j
 = 0; j < 
HLL_REGISTERS
/8; j++) {

904 ià(*
wÜd
 == 0) {

905 
ez
 += 8;

907 
by‹s
 = (
ušt8_t
*è
wÜd
;

908 ià(
by‹s
[0]è
E
 +ğ
PE
[by‹s[0]]; 
ez
++;

909 ià(
by‹s
[1]è
E
 +ğ
PE
[by‹s[1]]; 
ez
++;

910 ià(
by‹s
[2]è
E
 +ğ
PE
[by‹s[2]]; 
ez
++;

911 ià(
by‹s
[3]è
E
 +ğ
PE
[by‹s[3]]; 
ez
++;

912 ià(
by‹s
[4]è
E
 +ğ
PE
[by‹s[4]]; 
ez
++;

913 ià(
by‹s
[5]è
E
 +ğ
PE
[by‹s[5]]; 
ez
++;

914 ià(
by‹s
[6]è
E
 +ğ
PE
[by‹s[6]]; 
ez
++;

915 ià(
by‹s
[7]è
E
 +ğ
PE
[by‹s[7]]; 
ez
++;

917 
wÜd
++;

919 
E
 +ğ
ez
;

921 *
ezp
 = 
ez
;

922  
E
;

923 
	}
}

936 
ušt64_t
 
	$hÎCouÁ
(
hÎhdr
 *
hdr
, *
šv®id
) {

937 
m
 = 
HLL_REGISTERS
;

938 
E
, 
®pha
 = 0.7213/(1+1.079/
m
);

939 
j
, 
ez
;

943 
š™Ÿlized
 = 0;

944 
PE
[64];

945 ià(!
š™Ÿlized
) {

946 
PE
[0] = 1;

947 
j
 = 1; j < 64; j++) {

949 
PE
[
j
] = 1.0/(1ULL << j);

951 
š™Ÿlized
 = 1;

955 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

956 
E
 = 
	`hÎD’£Sum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

957 } ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

958 
E
 = 
	`hÎS·r£Sum
(
hdr
->
»gi¡”s
,

959 
	`sd¦’
((
sds
)
hdr
)-
HLL_HDR_SIZE
,
PE
,&
ez
,
šv®id
);

960 } ià(
hdr
->
’codšg
 =ğ
HLL_RAW
) {

961 
E
 = 
	`hÎRawSum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

963 
	`£rv”Pªic
("Unknown HyperLogLogƒncoding in hllCount()");

967 
E
 = (1/E)*
®pha
*
m
*m;

974 ià(
E
 < 
m
*2.5 && 
ez
 != 0) {

975 
E
 = 
m
*
	`log
(m/
ez
);

976 } ià(
m
 =ğ16384 && 
E
 < 72000) {

981 
bŸs
 = 5.9119*1.0e-18*(
E
*E*E*E)

982 -1.4253*1.0e-12*(
E
*E*E)+

983 1.2940*1.0e-7*(
E
*E)

984 -5.2921*1.0e-3*
E
+

986 
E
 -ğE*(
bŸs
/100);

992  (
ušt64_t
è
E
;

993 
	}
}

996 
	$hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

997 
hÎhdr
 *
hdr
 = 
o
->
±r
;

998 
hdr
->
’codšg
) {

999 
HLL_DENSE
:  
	`hÎD’£Add
(
hdr
->
»gi¡”s
,
–e
,
–esize
);

1000 
HLL_SPARSE
:  
	`hÎS·r£Add
(
o
,
–e
,
–esize
);

1003 
	}
}

1013 
	$hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
) {

1014 
hÎhdr
 *
hdr
 = 
hÎ
->
±r
;

1015 
i
;

1017 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

1018 
ušt8_t
 
v®
;

1020 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1021 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1022 ià(
v®
 > 
max
[
i
]) max[i] = val;

1025 
ušt8_t
 *
p
 = 
hÎ
->
±r
, *
’d
 =… + 
	`sd¦’
(hll->ptr);

1026 
ruÆ’
, 
»gv®
;

1028 
p
 +ğ
HLL_HDR_SIZE
;

1029 
i
 = 0;

1030 
p
 < 
’d
) {

1031 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1032 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1033 
i
 +ğ
ruÆ’
;

1034 
p
++;

1035 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1036 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1037 
i
 +ğ
ruÆ’
;

1038 
p
 += 2;

1040 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1041 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1042 
ruÆ’
--) {

1043 ià(
»gv®
 > 
max
[
i
]) max[i] =„egval;

1044 
i
++;

1046 
p
++;

1049 ià(
i
 !ğ
HLL_REGISTERS
è 
VR_ERROR
;

1051  
VR_OK
;

1052 
	}
}

1058 
robj
 *
	$ü—‹HLLObjeù
() {

1059 
robj
 *
o
;

1060 
hÎhdr
 *
hdr
;

1061 
sds
 
s
;

1062 
ušt8_t
 *
p
;

1063 
¥¬£Ën
 = 
HLL_HDR_SIZE
 +

1064 (((
HLL_REGISTERS
+(
HLL_SPARSE_XZERO_MAX_LEN
-1)) /

1065 
HLL_SPARSE_XZERO_MAX_LEN
)*2);

1066 
aux
;

1070 
aux
 = 
HLL_REGISTERS
;

1071 
s
 = 
	`sd¢ewËn
(
NULL
,
¥¬£Ën
);

1072 
p
 = (
ušt8_t
*)
s
 + 
HLL_HDR_SIZE
;

1073 
aux
) {

1074 
xz”o
 = 
HLL_SPARSE_XZERO_MAX_LEN
;

1075 ià(
xz”o
 > 
aux
) xzero =‡ux;

1076 
	`HLL_SPARSE_XZERO_SET
(
p
,
xz”o
);

1077 
p
 += 2;

1078 
aux
 -ğ
xz”o
;

1080 
	`ASSERT
((
p
-(
ušt8_t
*)
s
è=ğ
¥¬£Ën
);

1083 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

1084 
hdr
 = 
o
->
±r
;

1085 
	`memıy
(
hdr
->
magic
,"HYLL",4);

1086 
hdr
->
’codšg
 = 
HLL_SPARSE
;

1087  
o
;

1088 
	}
}

1093 
	$isHLLObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
) {

1094 
hÎhdr
 *
hdr
;

1097 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

1098  
VR_ERROR
;

1100 ià(
	`¡ršgObjeùL’
(
o
è< (*
hdr
)è
šv®id
;

1101 
hdr
 = 
o
->
±r
;

1104 ià(
hdr
->
magic
[0] != 'H' || hdr->magic[1] != 'Y' ||

1105 
hdr
->
magic
[2] !ğ'L' || hdr->magic[3] !ğ'L'è
šv®id
;

1107 ià(
hdr
->
’codšg
 > 
HLL_MAX_ENCODING
è
šv®id
;

1110 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
 &&

1111 
	`¡ršgObjeùL’
(
o
è!ğ
HLL_DENSE_SIZE
è
šv®id
;

1114  
VR_OK
;

1116 
šv®id
:

1117 
	`addR•lySds
(
c
,

1118 
	`sd¢ew
("-WRONGTYPE Key is‚ot‡ valid "

1120  
VR_ERROR
;

1121 
	}
}

1124 
	$pçddCommªd
(
ş›Á
 *
c
) {

1125 
robj
 *
o
;

1126 
hÎhdr
 *
hdr
;

1127 
upd©ed
 = 0, 
j
;

1128 
expœed
 = 0;

1130 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

1131 
	`lockDbWr™e
(
c
->
db
);

1132 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

1133 ià(
o
 =ğ
NULL
) {

1137 
o
 = 
	`ü—‹HLLObjeù
();

1138 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1139 
upd©ed
++;

1141 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) {

1142 
	`uÆockDb
(
c
->
db
);

1143 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1146 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1149 
j
 = 2; j < 
c
->
¬gc
; j++) {

1150 
»tv®
 = 
	`hÎAdd
(
o
, (*)
c
->
¬gv
[
j
]->
±r
,

1151 
	`sd¦’
(
c
->
¬gv
[
j
]->
±r
));

1152 
»tv®
) {

1154 
upd©ed
++;

1157 
	`uÆockDb
(
c
->
db
);

1158 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1159 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1163 
hdr
 = 
o
->
±r
;

1164 ià(
upd©ed
) {

1165 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1166 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1167 
c
->
v–
->
dœty
++;

1168 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1170 
	`addR•ly
(
c
, 
upd©ed
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1171 
	`uÆockDb
(
c
->
db
);

1172 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1173 
	}
}

1176 
	$pfcouÁCommªd
(
ş›Á
 *
c
) {

1177 
robj
 *
o
;

1178 
hÎhdr
 *
hdr
;

1179 
ušt64_t
 
ÿrd
;

1180 
expœed
;

1186 ià(
c
->
¬gc
 > 2) {

1187 
ušt8_t
 
max
[
HLL_HDR_SIZE
+
HLL_REGISTERS
], *
»gi¡”s
;

1188 
j
;

1191 
	`mem£t
(
max
,0,(max));

1192 
hdr
 = (
hÎhdr
*è
max
;

1193 
hdr
->
’codšg
 = 
HLL_RAW
;

1194 
»gi¡”s
 = 
max
 + 
HLL_HDR_SIZE
;

1195 
j
 = 1; j < 
c
->
¬gc
; j++) {

1197 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

1198 
	`lockDbR—d
(
c
->
db
);

1199 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1200 ià(
o
 =ğ
NULL
) {

1201 
	`uÆockDb
(
c
->
db
);

1204 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) {

1205 
	`uÆockDb
(
c
->
db
);

1210 ià(
	`hÎM”ge
(
»gi¡”s
,
o
è=ğ
VR_ERROR
) {

1211 
	`uÆockDb
(
c
->
db
);

1212 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1216 
	`uÆockDb
(
c
->
db
);

1220 
	`addR•lyLÚgLÚg
(
c
,
	`hÎCouÁ
(
hdr
,
NULL
));

1228 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[1]);

1229 
	`lockDbWr™e
(
c
->
db
);

1230 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

1231 ià(
o
 =ğ
NULL
) {

1234 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1236 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) {

1237 
	`uÆockDb
(
c
->
db
);

1238 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1241 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1244 
hdr
 = 
o
->
±r
;

1245 ià(
	`HLL_VALID_CACHE
(
hdr
)) {

1247 
ÿrd
 = (
ušt64_t
)
hdr
->card[0];

1248 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[1] << 8;

1249 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[2] << 16;

1250 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[3] << 24;

1251 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[4] << 32;

1252 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[5] << 40;

1253 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[6] << 48;

1254 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[7] << 56;

1256 
šv®id
 = 0;

1258 
ÿrd
 = 
	`hÎCouÁ
(
hdr
,&
šv®id
);

1259 ià(
šv®id
) {

1260 
	`uÆockDb
(
c
->
db
);

1261 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1262 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1265 
hdr
->
ÿrd
[0] = card & 0xff;

1266 
hdr
->
ÿrd
[1] = (card >> 8) & 0xff;

1267 
hdr
->
ÿrd
[2] = (card >> 16) & 0xff;

1268 
hdr
->
ÿrd
[3] = (card >> 24) & 0xff;

1269 
hdr
->
ÿrd
[4] = (card >> 32) & 0xff;

1270 
hdr
->
ÿrd
[5] = (card >> 40) & 0xff;

1271 
hdr
->
ÿrd
[6] = (card >> 48) & 0xff;

1272 
hdr
->
ÿrd
[7] = (card >> 56) & 0xff;

1277 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1278 
£rv”
.
dœty
++;

1279 
c
->
v–
->
dœty
++;

1281 
	`addR•lyLÚgLÚg
(
c
,
ÿrd
);

1284 
	`uÆockDb
(
c
->
db
);

1285 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1286 
	}
}

1289 
	$pfm”geCommªd
(
ş›Á
 *
c
) {

1290 
ušt8_t
 
max
[
HLL_REGISTERS
];

1291 
hÎhdr
 *
hdr
;

1292 
j
;

1297 
	`mem£t
(
max
,0,(max));

1298 
j
 = 1; j < 
c
->
¬gc
; j++) {

1300 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1301 ià(
o
 =ğ
NULL
) ;

1302 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) ;

1306 ià(
	`hÎM”ge
(
max
,
o
è=ğ
VR_ERROR
) {

1307 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1313 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
NULL
);

1314 ià(
o
 =ğ
NULL
) {

1318 
o
 = 
	`ü—‹HLLObjeù
();

1319 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1324 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1328 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
) {

1329 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1335 
hdr
 = 
o
->
±r
;

1336 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1337 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
j
,
max
[j]);

1339 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1341 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1344 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1345 
£rv”
.
dœty
++;

1346 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1347 
	}
}

1354 
	#HLL_TEST_CYCLES
 1000

	)

1355 
	$pf£láe¡Commªd
(
ş›Á
 *
c
) {

1356 
j
, 
i
;

1357 
sds
 
b™couÁ”s
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

1358 
hÎhdr
 *
hdr
 = (hÎhdr*è
b™couÁ”s
, *
hdr2
;

1359 
robj
 *
o
 = 
NULL
;

1360 
ušt8_t
 
by‹couÁ”s
[
HLL_REGISTERS
];

1366 
j
 = 0; j < 
HLL_TEST_CYCLES
; j++) {

1369 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1370 
r
 = 
	`¿nd
(è& 
HLL_REGISTER_MAX
;

1372 
by‹couÁ”s
[
i
] = 
r
;

1373 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
i
,
r
);

1376 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1377 
v®
;

1379 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1380 ià(
v®
 !ğ
by‹couÁ”s
[
i
]) {

1381 
	`addR•lyE¼ÜFÜm©
(
c
,

1383 
i
, (è
by‹couÁ”s
[i], (è
v®
);

1384 
ş—nup
;

1399 
	`mem£t
(
hdr
->
»gi¡”s
,0,
HLL_DENSE_SIZE
-
HLL_HDR_SIZE
);

1400 
o
 = 
	`ü—‹HLLObjeù
();

1401 
»Ë¼
 = 1.04/
	`sq¹
(
HLL_REGISTERS
);

1402 
št64_t
 
checkpošt
 = 1;

1403 
ušt64_t
 
£ed
 = (ušt64_t)
	`¿nd
() | (uint64_t)rand() << 32;

1404 
ušt64_t
 
–e
;

1405 
j
 = 1; j <= 10000000; j++) {

1406 
–e
 = 
j
 ^ 
£ed
;

1407 
	`hÎD’£Add
(
hdr
->
»gi¡”s
,(*)&
–e
,(ele));

1408 
	`hÎAdd
(
o
,(*)&
–e
,(ele));

1412 ià(
j
 =ğ
checkpošt
 && j < 
£rv”
.
hÎ_¥¬£_max_by‹s
/2) {

1413 
hdr2
 = 
o
->
±r
;

1414 ià(
hdr2
->
’codšg
 !ğ
HLL_SPARSE
) {

1415 
	`addR•lyE¼Ü
(
c
, "TESTFAILED sparseƒncoding‚ot used");

1416 
ş—nup
;

1421 ià(
j
 =ğ
checkpošt
 && 
	`hÎCouÁ
(
hdr
,
NULL
è!ğhÎCouÁ(
o
->
±r
,NULL)) {

1422 
	`addR•lyE¼Ü
(
c
, "TESTFAILED dense/sparse disagree");

1423 
ş—nup
;

1427 ià(
j
 =ğ
checkpošt
) {

1428 
št64_t
 
ab£¼
 = 
checkpošt
 - (št64_t)
	`hÎCouÁ
(
hdr
,
NULL
);

1429 
ušt64_t
 
max”r
 = 
	`û
(
»Ë¼
*6*
checkpošt
);

1435 ià(
j
 =ğ10è
max”r
 = 1;

1437 ià(
ab£¼
 < 0)‡bserr = -abserr;

1438 ià(
ab£¼
 > (
št64_t
)
max”r
) {

1439 
	`addR•lyE¼ÜFÜm©
(
c
,

1441 (è
checkpošt
,

1442 (è
ab£¼
);

1443 
ş—nup
;

1445 
checkpošt
 *= 10;

1450 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1452 
ş—nup
:

1453 
	`sdsä“
(
b™couÁ”s
);

1454 ià(
o
è
	`deüRefCouÁ
(o);

1455 
	}
}

1459 
	$pfdebugCommªd
(
ş›Á
 *
c
) {

1460 *
cmd
 = 
c
->
¬gv
[1]->
±r
;

1461 
hÎhdr
 *
hdr
;

1462 
robj
 *
o
;

1463 
j
;

1465 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
);

1466 ià(
o
 =ğ
NULL
) {

1467 
	`addR•lyE¼Ü
(
c
,"The specified key does‚otƒxist");

1470 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) ;

1471 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[2],o);

1472 
hdr
 = 
o
->
±r
;

1475 ià(!
	`¡rÿ£cmp
(
cmd
,"getreg")) {

1476 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1478 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1479 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
) {

1480 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1483 
£rv”
.
dœty
++;

1486 
hdr
 = 
o
->
±r
;

1487 
	`addR•lyMuÉiBulkL’
(
c
,
HLL_REGISTERS
);

1488 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1489 
ušt8_t
 
v®
;

1491 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
j
);

1492 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1496 ià(!
	`¡rÿ£cmp
(
cmd
,"decode")) {

1497 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1499 
ušt8_t
 *
p
 = 
o
->
±r
, *
’d
 =…+
	`sd¦’
(o->ptr);

1500 
sds
 
decoded
 = 
	`sd£m±y
();

1502 ià(
hdr
->
’codšg
 !ğ
HLL_SPARSE
) {

1503 
	`addR•lyE¼Ü
(
c
,"HLLƒncoding is‚ot sparse");

1507 
p
 +ğ
HLL_HDR_SIZE
;

1508 
p
 < 
’d
) {

1509 
ruÆ’
, 
»gv®
;

1511 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1512 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1513 
p
++;

1514 
decoded
 = 
	`sdsÿrštf
(decoded,"z:%d ",
ruÆ’
);

1515 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1516 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1517 
p
 += 2;

1518 
decoded
 = 
	`sdsÿrštf
(decoded,"Z:%d ",
ruÆ’
);

1520 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1521 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1522 
p
++;

1523 
decoded
 = 
	`sdsÿrštf
(decoded,"v:%d,%d ",
»gv®
,
ruÆ’
);

1526 
decoded
 = 
	`sd¡rim
(decoded," ");

1527 
	`addR•lyBulkCBufãr
(
c
,
decoded
,
	`sd¦’
(decoded));

1528 
	`sdsä“
(
decoded
);

1531 ià(!
	`¡rÿ£cmp
(
cmd
,"encoding")) {

1532 *
’codšg¡r
[2] = {"dense","sparse"};

1533 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1535 
	`addR•lyStus
(
c
,
’codšg¡r
[
hdr
->
’codšg
]);

1538 ià(!
	`¡rÿ£cmp
(
cmd
,"todense")) {

1539 
cÚv
 = 0;

1540 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1542 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1543 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
) {

1544 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1547 
cÚv
 = 1;

1548 
£rv”
.
dœty
++;

1550 
	`addR•ly
(
c
,
cÚv
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1552 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀPFDEBUG subcommªd '%s'", 
cmd
);

1556 
¬™y”r
:

1557 
	`addR•lyE¼ÜFÜm©
(
c
,

1558 "WrÚg‚umb” oà¬gum’t fÜh'%s' subcommªd",
cmd
);

1559 
	}
}

	@src/vr_hyperloglog.h

1 #iâdeà
_VR_HYPERLOGLOG_H_


2 
	#_VR_HYPERLOGLOG_H_


	)

4 
ušt64_t
 
MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
);

5 
hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
);

6 
hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
);

7 
hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
);

8 
hÎS·r£ToD’£
(
robj
 *
o
);

9 
hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
);

10 
hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
);

11 
hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
);

12 
hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
);

13 
hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
);

14 
robj
 *
ü—‹HLLObjeù
();

15 
isHLLObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
);

16 
pçddCommªd
(
ş›Á
 *
c
);

17 
pfcouÁCommªd
(
ş›Á
 *
c
);

18 
pfm”geCommªd
(
ş›Á
 *
c
);

19 
pf£láe¡Commªd
(
ş›Á
 *
c
);

20 
pfdebugCommªd
(
ş›Á
 *
c
);

	@src/vr_intset.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

5 
	~<vr_cÜe.h
>

9 
	#INTSET_ENC_INT16
 ((
št16_t
))

	)

10 
	#INTSET_ENC_INT32
 ((
št32_t
))

	)

11 
	#INTSET_ENC_INT64
 ((
št64_t
))

	)

14 
ušt8_t
 
	$_št£tV®ueEncodšg
(
št64_t
 
v
) {

15 ià(
v
 < 
INT32_MIN
 || v > 
INT32_MAX
)

16  
INTSET_ENC_INT64
;

17 ià(
v
 < 
INT16_MIN
 || v > 
INT16_MAX
)

18  
INTSET_ENC_INT32
;

20  
INTSET_ENC_INT16
;

21 
	}
}

24 
št64_t
 
	$_št£tG‘Encoded
(
št£t
 *
is
, 
pos
, 
ušt8_t
 
’c
) {

25 
št64_t
 
v64
;

26 
št32_t
 
v32
;

27 
št16_t
 
v16
;

29 ià(
’c
 =ğ
INTSET_ENC_INT64
) {

30 
	`memıy
(&
v64
,((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
,(v64));

31 
	`mem»v64ifbe
(&
v64
);

32  
v64
;

33 } ià(
’c
 =ğ
INTSET_ENC_INT32
) {

34 
	`memıy
(&
v32
,((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
,(v32));

35 
	`mem»v32ifbe
(&
v32
);

36  
v32
;

38 
	`memıy
(&
v16
,((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
,(v16));

39 
	`mem»v16ifbe
(&
v16
);

40  
v16
;

42 
	}
}

45 
št64_t
 
	$_št£tG‘
(
št£t
 *
is
, 
pos
) {

46  
	`_št£tG‘Encoded
(
is
,
pos
,
	`šŒev32ifbe
(is->
’codšg
));

47 
	}
}

50 
	$_št£tS‘
(
št£t
 *
is
, 
pos
, 
št64_t
 
v®ue
) {

51 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

53 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

54 ((
št64_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

55 
	`mem»v64ifbe
(((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
);

56 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

57 ((
št32_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

58 
	`mem»v32ifbe
(((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
);

60 ((
št16_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

61 
	`mem»v16ifbe
(((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
);

63 
	}
}

66 
št£t
 *
	$št£tNew
() {

67 
št£t
 *
is
 = 
	`d®loc
((intset));

68 
is
->
’codšg
 = 
	`šŒev32ifbe
(
INTSET_ENC_INT16
);

69 
is
->
Ëngth
 = 0;

70  
is
;

71 
	}
}

74 
št£t
 *
	$št£tResize
(
št£t
 *
is
, 
ušt32_t
 
Ën
) {

75 
ušt32_t
 
size
 = 
Ën
*
	`šŒev32ifbe
(
is
->
’codšg
);

76 
is
 = 
	`d»®loc
(is,(
št£t
)+
size
);

77  
is
;

78 
	}
}

84 
ušt8_t
 
	$št£tS—rch
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt32_t
 *
pos
) {

85 
mš
 = 0, 
max
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-1, 
mid
 = -1;

86 
št64_t
 
cur
 = -1;

89 ià(
	`šŒev32ifbe
(
is
->
Ëngth
) == 0) {

90 ià(
pos
) *pos = 0;

95 ià(
v®ue
 > 
	`_št£tG‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
)-1)) {

96 ià(
pos
è*po ğ
	`šŒev32ifbe
(
is
->
Ëngth
);

98 } ià(
v®ue
 < 
	`_št£tG‘
(
is
,0)) {

99 ià(
pos
) *pos = 0;

104 
max
 >ğ
mš
) {

105 
mid
 = (()
mš
 + ()
max
) >> 1;

106 
cur
 = 
	`_št£tG‘
(
is
,
mid
);

107 ià(
v®ue
 > 
cur
) {

108 
mš
 = 
mid
+1;

109 } ià(
v®ue
 < 
cur
) {

110 
max
 = 
mid
-1;

116 ià(
v®ue
 =ğ
cur
) {

117 ià(
pos
è*po ğ
mid
;

120 ià(
pos
è*po ğ
mš
;

123 
	}
}

126 
št£t
 *
	$št£tUpg¿deAndAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

127 
ušt8_t
 
cu»nc
 = 
	`šŒev32ifbe
(
is
->
’codšg
);

128 
ušt8_t
 
Ãw’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

129 
Ëngth
 = 
	`šŒev32ifbe
(
is
->length);

130 
´•’d
 = 
v®ue
 < 0 ? 1 : 0;

133 
is
->
’codšg
 = 
	`šŒev32ifbe
(
Ãw’c
);

134 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

139 
Ëngth
--)

140 
	`_št£tS‘
(
is
,
Ëngth
+
´•’d
,
	`_št£tG‘Encoded
(is,Ëngth,
cu»nc
));

143 ià(
´•’d
)

144 
	`_št£tS‘
(
is
,0,
v®ue
);

146 
	`_št£tS‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
),
v®ue
);

147 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

148  
is
;

149 
	}
}

151 
	$št£tMoveTa
(
št£t
 *
is
, 
ušt32_t
 
äom
, ušt32_ˆ
to
) {

152 *
¤c
, *
d¡
;

153 
ušt32_t
 
by‹s
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-
äom
;

154 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

156 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

157 
¤c
 = (
št64_t
*)
is
->
cÚ‹Ás
+
äom
;

158 
d¡
 = (
št64_t
*)
is
->
cÚ‹Ás
+
to
;

159 
by‹s
 *ğ(
št64_t
);

160 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

161 
¤c
 = (
št32_t
*)
is
->
cÚ‹Ás
+
äom
;

162 
d¡
 = (
št32_t
*)
is
->
cÚ‹Ás
+
to
;

163 
by‹s
 *ğ(
št32_t
);

165 
¤c
 = (
št16_t
*)
is
->
cÚ‹Ás
+
äom
;

166 
d¡
 = (
št16_t
*)
is
->
cÚ‹Ás
+
to
;

167 
by‹s
 *ğ(
št16_t
);

169 
	`memmove
(
d¡
,
¤c
,
by‹s
);

170 
	}
}

173 
št£t
 *
	$št£tAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
) {

174 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

175 
ušt32_t
 
pos
;

176 ià(
sucûss
) *success = 1;

181 ià(
v®’c
 > 
	`šŒev32ifbe
(
is
->
’codšg
)) {

183  
	`št£tUpg¿deAndAdd
(
is
,
v®ue
);

188 ià(
	`št£tS—rch
(
is
,
v®ue
,&
pos
)) {

189 ià(
sucûss
) *success = 0;

190  
is
;

193 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

194 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)è
	`št£tMoveTa
(is,pos,pos+1);

197 
	`_št£tS‘
(
is
,
pos
,
v®ue
);

198 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

199  
is
;

200 
	}
}

203 
št£t
 *
	$št£tRemove
(
št£t
 *
is
, 
št64_t
 
v®ue
, *
sucûss
) {

204 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

205 
ušt32_t
 
pos
;

206 ià(
sucûss
) *success = 0;

208 ià(
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,&
pos
)) {

209 
ušt32_t
 
Ën
 = 
	`šŒev32ifbe
(
is
->
Ëngth
);

212 ià(
sucûss
) *success = 1;

215 ià(
pos
 < (
Ën
-1)è
	`št£tMoveTa
(
is
,pos+1,pos);

216 
is
 = 
	`št£tResize
(is,
Ën
-1);

217 
is
->
Ëngth
 = 
	`šŒev32ifbe
(
Ën
-1);

219  
is
;

220 
	}
}

223 
ušt8_t
 
	$št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

224 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

225  
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,
NULL
);

226 
	}
}

229 
št64_t
 
	$št£tRªdom
(
št£t
 *
is
) {

230  
	`_št£tG‘
(
is
,
	`¿nd
()%
	`šŒev32ifbe
(is->
Ëngth
));

231 
	}
}

235 
ušt8_t
 
	$št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
) {

236 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)) {

237 *
v®ue
 = 
	`_št£tG‘
(
is
,
pos
);

241 
	}
}

244 
ušt32_t
 
	$št£tL’
(
št£t
 *
is
) {

245  
	`šŒev32ifbe
(
is
->
Ëngth
);

246 
	}
}

249 
size_t
 
	$št£tBlobL’
(
št£t
 *
is
) {

250  (
št£t
)+
	`šŒev32ifbe
(
is
->
Ëngth
)*šŒev32ifbe(is->
’codšg
);

251 
	}
}

	@src/vr_intset.h

1 #iâdeà
_VR_INTSET_H_


2 
	#_VR_INTSET_H_


	)

4 
	~<¡dšt.h
>

6 
	sšt£t
 {

7 
ušt32_t
 
	m’codšg
;

8 
ušt32_t
 
	mËngth
;

9 
št8_t
 
	mcÚ‹Ás
[];

10 } 
	tšt£t
;

12 
št£t
 *
št£tNew
();

13 
št£t
 *
št£tAdd
(št£ˆ*
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
);

14 
št£t
 *
št£tRemove
(št£ˆ*
is
, 
št64_t
 
v®ue
, *
sucûss
);

15 
ušt8_t
 
št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
);

16 
št64_t
 
št£tRªdom
(
št£t
 *
is
);

17 
ušt8_t
 
št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
);

18 
ušt32_t
 
št£tL’
(
št£t
 *
is
);

19 
size_t
 
št£tBlobL’
(
št£t
 *
is
);

	@src/vr_listen.c

1 
	~<sys/¡©.h
>

2 
	~<sys/un.h
>

4 
	~<vr_cÜe.h
>

6 
vr_li¡’
 *

7 
	$vr_li¡’_ü—‹
(
sds
 
li¡’_¡r
)

9 
r¡©us_t
 
¡©us
;

10 
vr_li¡’
 *
vli¡’
;

11 
ušt8_t
 *
p
, *
Çme
;

12 
ušt32_t
 
Çm–’
;

14 ià(
li¡’_¡r
 =ğ
NULL
) {

15  
NULL
;

18 
vli¡’
 = 
	`d®loc
((
vr_li¡’
));

19 ià(
vli¡’
 =ğ
NULL
) {

20  
NULL
;

23 
vli¡’
->
Çme
 = 
NULL
;

24 
vli¡’
->
pÜt
 = 0;

25 
	`mem£t
(&
vli¡’
->
šfo
, 0, (vlisten->info));

26 
vli¡’
->
sd
 = -1;

28 ià(
li¡’_¡r
 == '/') {

29 
ušt8_t
 *
q
, *
¡¬t
, *
³rm
;

30 
ušt32_t
 
³rmËn
;

33 
p
 = 
li¡’_¡r
 + 
	`sd¦’
(listen_str) - 1;

34 
¡¬t
 = 
li¡’_¡r
;

35 
q
 = 
	`vr_¡¼chr
(
p
, 
¡¬t
, ' ');

36 ià(
q
 =ğ
NULL
) {

38 
Çme
 = 
li¡’_¡r
;

39 
Çm–’
 = 
	`sd¦’
(
li¡’_¡r
);

41 
³rm
 = 
q
 + 1;

42 
³rmËn
 = (
ušt32_t
)(
p
 - 
³rm
 + 1);

44 
p
 = 
q
 - 1;

45 
Çme
 = 
¡¬t
;

46 
Çm–’
 = (
ušt32_t
)(
p
 - 
¡¬t
 + 1);

48 
”ºo
 = 0;

49 
vli¡’
->
³rm
 = (
mode_t
)
	`¡¹Ş
((*í”m, 
NULL
, 8);

50 ià(
”ºo
 || 
vli¡’
->
³rm
 > 0777) {

51 
	`log_”rÜ
("config file has‡n invalid file…ermission in \"socket_path…ermission\" format string");

52 
	`vr_li¡’_de¡roy
(
vli¡’
);

53  
NULL
;

57 
ušt8_t
 *
q
, *
¡¬t
, *
pÜt
;

58 
ušt32_t
 
pÜ’
;

61 
p
 = 
li¡’_¡r
 + 
	`sd¦’
(listen_str) - 1;

62 
¡¬t
 = 
li¡’_¡r
;

63 
q
 = 
	`vr_¡¼chr
(
p
, 
¡¬t
, ':');

64 ià(
q
 =ğ
NULL
) {

65 
	`log_”rÜ
("config file has‡n invalid \"hostname:port\" format string");

66 
	`vr_li¡’_de¡roy
(
vli¡’
);

67  
NULL
;

70 
pÜt
 = 
q
 + 1;

71 
pÜ’
 = (
ušt32_t
)(
p
 - 
pÜt
 + 1);

73 
p
 = 
q
 - 1;

75 
Çme
 = 
¡¬t
;

76 
Çm–’
 = (
ušt32_t
)(
p
 - 
¡¬t
 + 1);

78 
vli¡’
->
pÜt
 = 
	`vr_©oi
ÕÜt, 
pÜ’
);

79 ià(
vli¡’
->
pÜt
 < 0 || !
	`vr_v®id_pÜt
(vlisten->port)) {

80 
	`log_”rÜ
("config file has‡n invalid…ort in \"hostname:port\" format string");

81 
	`vr_li¡’_de¡roy
(
vli¡’
);

82  
NULL
;

86 
vli¡’
->
Çme
 = 
	`sd¢ewËn
Òame, 
Çm–’
);

87 ià(
vli¡’
->
Çme
 =ğ
NULL
) {

88 
	`log_”rÜ
("create‡ sds string failed: out of memory.");

89 
	`vr_li¡’_de¡roy
(
vli¡’
);

90  
NULL
;

93 
¡©us
 = 
	`vr_»sŞve
(
vli¡’
->
Çme
, vli¡’->
pÜt
, &vli¡’->
šfo
);

94 ià(
¡©us
 !ğ
VR_OK
) {

95 
	`vr_li¡’_de¡roy
(
vli¡’
);

96  
NULL
;

99  
vli¡’
;

100 
	}
}

103 
	$vr_li¡’_de¡roy
(
vr_li¡’
 *
vli¡Ú
)

105 ià(
vli¡Ú
 =ğ
NULL
) {

109 ià(
vli¡Ú
->
Çme
) {

110 
	`sdsä“
(
vli¡Ú
->
Çme
);

111 
vli¡Ú
->
Çme
 = 
NULL
;

114 ià(
vli¡Ú
->
sd
 > 0) {

115 
	`şo£
(
vli¡Ú
->
sd
);

116 
vli¡Ú
->
sd
 = -1;

119 
	`dä“
(
vli¡Ú
);

120 
	}
}

122 
r¡©us_t


123 
	$vr_li¡’_»u£
(
vr_li¡’
 *
p
)

125 
r¡©us_t
 
¡©us
;

126 
sockaddr_un
 *
un
;

128 
p
->
šfo
.
çmy
) {

129 
AF_INET
:

130 
AF_INET6
:

131 
¡©us
 = 
	`vr_£t_»u£addr
(
p
->
sd
);

134 
AF_UNIX
:

140 
un
 = (
sockaddr_un
 *è&
p
->
šfo
.
addr
;

141 
	`uÆšk
(
un
->
sun_·th
);

142 
¡©us
 = 
VR_OK
;

146 
	`NOT_REACHED
();

147 
¡©us
 = 
VR_ERROR
;

150  
¡©us
;

151 
	}
}

153 
r¡©us_t


154 
	$vr_li¡’_begš
(
vr_li¡’
 *
vli¡’
)

156 
r¡©us_t
 
¡©us
;

158 
vli¡’
->
sd
 = 
	`sock‘
(vli¡’->
šfo
.
çmy
, 
SOCK_STREAM
, 0);

159 ià(
vli¡’
->
sd
 < 0) {

160 
	`log_”rÜ
("sock‘ faed: %s", 
	`¡»¼Ü
(
”ºo
));

161  
VR_ERROR
;

164 
¡©us
 = 
	`vr_li¡’_»u£
(
vli¡’
);

165 ià(
¡©us
 < 0) {

166 
	`log_”rÜ
("reuse of‡ddr %s for†istening on… %d failed: %s",

167 
vli¡’
->
Çme
, vli¡’->
sd
, 
	`¡»¼Ü
(
”ºo
));

168  
VR_ERROR
;

171 
¡©us
 = 
	`bšd
(
vli¡’
->
sd
, (
sockaddr
 *)&vli¡’->
šfo
.
addr
, vli¡’->šfo.
add¾’
);

172 ià(
¡©us
 < 0) {

173 
	`log_”rÜ
("bšd oÀ°%dØadd¸% çed: %s", 
vli¡’
->
sd
,

174 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

175  
VR_ERROR
;

178 ià(
vli¡’
->
šfo
.
çmy
 =ğ
AF_UNIX
 && vli¡’->
³rm
) {

179 
sockaddr_un
 *
un
 = (sockaddr_uÀ*)&
vli¡’
->
šfo
.
addr
;

180 
¡©us
 = 
	`chmod
(
un
->
sun_·th
, 
vli¡’
->
³rm
);

181 ià(
¡©us
 < 0) {

182 
	`log_”rÜ
("chmod oÀ°%d oÀadd¸% çed: %s", 
vli¡’
->
sd
,

183 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

184  
VR_ERROR
;

188 
¡©us
 = 
	`li¡’
(
vli¡’
->
sd
, 512);

189 ià(
¡©us
 < 0) {

190 
	`log_”rÜ
("li¡’ oÀ°%d oÀadd¸% çed: %s", 
vli¡’
->
sd
,

191 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

192  
VR_ERROR
;

195 
¡©us
 = 
	`vr_£t_nÚblockšg
(
vli¡’
->
sd
);

196 ià(
¡©us
 < 0) {

197 
	`log_”rÜ
("£ˆnÚblock oÀ°%d oÀadd¸% çed: %s", 
vli¡’
->
sd
,

198 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

199  
VR_ERROR
;

202  
VR_OK
;

203 
	}
}

206 
	$vr_li¡’_acû±
(
vr_li¡’
 *
vli¡’
)

208 
r¡©us_t
 
¡©us
;

209 
sd
;

210 
maxş›Ás
;

212 
	`ASSERT
(
vli¡’
->
sd
 > 0);

214 
	`log_debug
(
LOG_DEBUG
,"client_accept");

216 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
maxş›Ás
);

218 
sd
 = 
	`acû±
(
vli¡’
->sd, 
NULL
, NULL);

219 ià(
sd
 < 0) {

220 ià(
”ºo
 =ğ
EINTR
) {

221 
	`log_debug
(
LOG_VERB
, "acû± oÀ°%d‚Ù„—dy -ƒšŒ", 
vli¡’
->
sd
);

225 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
 ||ƒ¼nØ=ğ
ECONNABORTED
) {

226 
	`log_debug
(
LOG_VERB
, "acû± oÀ°%d‚Ù„—dy -ƒagaš", 
vli¡’
->
sd
);

230 ià(
”ºo
 =ğ
EMFILE
 ||ƒ¼nØ=ğ
ENFILE
) {

231 
	`log_debug
(
LOG_CRIT
, "accept on… %d "

234 
vli¡’
->
sd
, 
maxş›Ás
,

235 
	`cu¼’t_ş›Ás
(), 
	`¡»¼Ü
(
”ºo
));

239 
	`log_w¬n
("acû± oÀ°%d faed: %s", 
vli¡’
->
sd
, 
	`¡»¼Ü
(
”ºo
));

247 ià(
	`cu¼’t_ş›Ás
(è>ğ
maxş›Ás
) {

248 
	`log_debug
(
LOG_CRIT
, "client connections %dƒxceed†imit %d",

249 
	`cu¼’t_ş›Ás
(), 
maxş›Ás
);

250 
¡©us
 = 
	`şo£
(
sd
);

251 ià(
¡©us
 < 0) {

252 
	`log_”rÜ
("şo£ c %d faed, ignÜed: %s", 
sd
, 
	`¡»¼Ü
(
”ºo
));

255 
	`upd©e_¡©s_add
(
ma¡”
.
v–
.
¡©s
, 
»jeùed_cÚn
, 1);

260  
sd
;

261 
	}
}

	@src/vr_listen.h

1 #iâdeà
_VR_LISTEN_H_


2 
	#_VR_LISTEN_H_


	)

4 
	svr_li¡’
 {

5 
sds
 
	mÇme
;

6 
	mpÜt
;

7 
mode_t
 
	m³rm
;

8 
sockšfo
 
	mšfo
;

9 
	msd
;

10 }
	tvr_li¡’
;

12 
vr_li¡’
 *
vr_li¡’_ü—‹
(
sds
 
lš‹n_¡r
);

13 
vr_li¡’_de¡roy
(
vr_li¡’
 *
vli¡Ú
);

14 
r¡©us_t
 
vr_li¡’_begš
(
vr_li¡’
 *
vli¡’
);

15 
vr_li¡’_acû±
(
vr_li¡’
 *
vli¡’
);

	@src/vr_lzf.h

1 #iâdeà
_VR_LZF_H_


2 
	#_VR_LZF_H_


	)

13 
	#LZF_VERSION
 0x0105

	)

41 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

42 *
out_d©a
, 
out_Ën
);

60 
lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

61 *
out_d©a
, 
out_Ën
);

	@src/vr_lzfP.h

1 #iâdeà
_VR_LZFP_H_


2 
	#_VR_LZFP_H_


	)

4 
	#STANDALONE
 1

	)

6 #iâdeà
STANDALONE


7 
	~<vr_lzf.h
>

18 #iâdeà
HLOG


19 
	#HLOG
 16

	)

27 #iâdeà
VERY_FAST


28 
	#VERY_FAST
 1

	)

38 #iâdeà
ULTRA_FAST


39 
	#ULTRA_FAST
 0

	)

45 #iâdeà
STRICT_ALIGN


46 
	#STRICT_ALIGN
 !(
	`defšed
(
__i386
è|| defšed (
__amd64
))

	)

54 #iâdeà
INIT_HTAB


55 
	#INIT_HTAB
 0

	)

63 #iâdeà
AVOID_ERRNO


64 
	#AVOID_ERRNO
 0

	)

72 #iâdeà
LZF_STATE_ARG


73 
	#LZF_STATE_ARG
 0

	)

84 #iâdeà
CHECK_INPUT


85 
	#CHECK_INPUT
 1

	)

98 #ifdeà
__ılu¥lus


99 
	~<c¡ršg
>

100 
	~<şim™s
>

101 
usšg
 
Çme¥aû
 
	g¡d
;

103 
	~<¡ršg.h
>

104 
	~<lim™s.h
>

107 #iâdeà
LZF_USE_OFFSETS


108 #ià
defšed
 (
WIN32
)

109 
	#LZF_USE_OFFSETS
 
	`defšed
(
_M_X64
)

	)

111 #ià
__ılu¥lus
 > 199711L

112 
	~<c¡dšt
>

114 
	~<¡dšt.h
>

116 
	#LZF_USE_OFFSETS
 (
UINTPTR_MAX
 > 0xffffffffU)

	)

120 
	tu8
;

122 #ià
LZF_USE_OFFSETS


123 
	#LZF_HSLOT_BIAS
 ((cÚ¡ 
u8
 *)
š_d©a
)

	)

124 
	tLZF_HSLOT
;

126 
	#LZF_HSLOT_BIAS
 0

	)

127 cÚ¡ 
	tu8
 *
	tLZF_HSLOT
;

130 
LZF_HSLOT
 
	tLZF_STATE
[1 << (
HLOG
)];

132 #ià!
STRICT_ALIGN


134 #ià
USHRT_MAX
 == 65535

135 
	tu16
;

136 #–ià
UINT_MAX
 == 65535

137 
	tu16
;

139 #undeà
STRICT_ALIGN


140 
	#STRICT_ALIGN
 1

	)

144 #ià
ULTRA_FAST


145 #undeà
VERY_FAST


	@src/vr_lzf_c.c

1 
	~<vr_lzfP.h
>

3 
	#HSIZE
 (1 << (
HLOG
))

	)

11 #iâdeà
FRST


12 
	#FRST
(
p
è((Õ[0]è<< 8è|…[1])

	)

13 
	#NEXT
(
v
,
p
è(((vè<< 8è|…[2])

	)

14 #ià
ULTRA_FAST


15 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h ) & (
HSIZE
 - 1))

	)

16 #–ià
VERY_FAST


17 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

19 
	#IDX
(
h
è((((h ^ (h << 5)è>> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

33 
	#FRST
(
p
èÕ[0] << 5è^…[1]

	)

34 
	#NEXT
(
v
,
p
è((vè<< 5è^…[2]

	)

35 
	#IDX
(
h
è((hè& (
HSIZE
 - 1))

	)

38 
	#MAX_LIT
 (1 << 5)

	)

39 
	#MAX_OFF
 (1 << 13)

	)

40 
	#MAX_REF
 ((1 << 8è+ (1 << 3))

	)

42 #ià
__GNUC__
 >= 3

43 
	#ex³ù
(
ex´
,
v®ue
è
	`__butš_ex³ù
 (Óx´),(v®ue))

	)

44 
	#šlše
 
šlše


	)

46 
	#ex³ù
(
ex´
,
v®ue
èÓx´)

	)

47 
	#šlše
 

	)

50 
	#ex³ù_çl£
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 0)

	)

51 
	#ex³ù_Œue
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 1)

	)

63 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

64 *
out_d©a
, 
out_Ën


65 #ià
LZF_STATE_ARG


66 , 
LZF_STATE
 
hb


70 #ià!
LZF_STATE_ARG


71 
LZF_STATE
 
	ghb
;

73 cÚ¡ 
u8
 *
	g
 = (cÚ¡ u8 *)
š_d©a
;

74 
u8
 *
	gİ
 = (u8 *)
out_d©a
;

75 cÚ¡ 
u8
 *
	gš_’d
 = 

 + 
š_Ën
;

76 
u8
 *
	gout_’d
 = 
İ
 + 
out_Ën
;

77 cÚ¡ 
u8
 *
	g»f
;

86 #ià
defšed
 (
WIN32
è&& defšed (
_M_X64
)

87 
_št64
 
	goff
;

89 
	goff
;

91 
	ghv®
;

92 
	gl™
;

94 ià(!
	gš_Ën
 || !
	gout_Ën
)

97 #ià
INIT_HTAB


98 
mem£t
 (
hb
, 0,  (htab));

101 
	gl™
 = 0; 
	gİ
++;

103 
	ghv®
 = 
FRST
 (

);

104 
	g
 < 
	gš_’d
 - 2)

106 
LZF_HSLOT
 *
	gh¦Ù
;

108 
	ghv®
 = 
NEXT
 (
hv®
, 

);

109 
	gh¦Ù
 = 
hb
 + 
IDX
 (
hv®
);

110 
	g»f
 = *
h¦Ù
 + 
LZF_HSLOT_BIAS
; *
	gh¦Ù
 = 

 - LZF_HSLOT_BIAS;

113 #ià
INIT_HTAB


114 && 
	g»f
 < 
	g


116 && (
	goff
 = 

 - 
»f
 - 1è< 
MAX_OFF


117 && 
»f
 > (
u8
 *)
š_d©a


118 && 
»f
[2] =ğ

[2]

119 #ià
STRICT_ALIGN


120 && ((
»f
[1] << 8è|„ef[0]è=ğ((

[1] << 8) | ip[0])

122 && *(
u16
 *)
»f
 =ğ*(u16 *)



127 
Ën
 = 2;

128 
	gmaxËn
 = 
š_’d
 - 

 - 
Ën
;

129 
	gmaxËn
 = 
maxËn
 > 
MAX_REF
 ? MAX_REF : maxlen;

131 ià(
ex³ù_çl£
 (
İ
 + 3 + 1 >ğ
out_’d
))

132 ià(
İ
 - !
l™
 + 3 + 1 >ğ
out_’d
)

135 
	gİ
 [- 
l™
 - 1] =†it - 1;

136 
	gİ
 -ğ!
l™
;

140 ià(
ex³ù_Œue
 (
maxËn
 > 16))

142 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

143 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

144 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

145 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

147 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

148 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

149 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

150 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

152 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

153 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

154 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

155 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

157 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

158 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

159 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

160 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

164 
	gËn
++;

165 
	gËn
 < 
	gmaxËn
 && 
	g»f
[
Ën
] =ğ

[len]);

170 
	gËn
 -= 2;

171 
	g
++;

173 ià(
	gËn
 < 7)

175 *
	gİ
++ = (
off
 >> 8è+ (
Ën
 << 5);

179 *
	gİ
++ = (
off
 >> 8) + ( 7 << 5);

180 *
	gİ
++ = 
Ën
 - 7;

183 *
	gİ
++ = 
off
;

185 
	gl™
 = 0; 
	gİ
++;

187 
	g
 +ğ
Ën
 + 1;

189 ià(
ex³ù_çl£
 (

 >ğ
š_’d
 - 2))

192 #ià
ULTRA_FAST
 || 
VERY_FAST


193 --
	g
;

194 #ià
VERY_FAST
 && !
ULTRA_FAST


195 --
	g
;

197 
	ghv®
 = 
FRST
 (

);

199 
	ghv®
 = 
NEXT
 (
hv®
, 

);

200 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

201 
	g
++;

203 #ià
VERY_FAST
 && !
ULTRA_FAST


204 
	ghv®
 = 
NEXT
 (
hv®
, 

);

205 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

206 
	g
++;

209 
	g
 -ğ
Ën
 + 1;

213 
	ghv®
 = 
NEXT
 (
hv®
, 

);

214 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

215 
	g
++;

217 
	gËn
--);

223 ià(
ex³ù_çl£
 (
İ
 >ğ
out_’d
))

226 
	gl™
++; *
	gİ
++ = *

++;

228 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

230 
İ
 [- 
l™
 - 1] =†it - 1;

231 
	gl™
 = 0; 
	gİ
++;

236 ià(
	gİ
 + 3 > 
	gout_’d
)

239 
	g
 < 
	gš_’d
)

241 
	gl™
++; *
	gİ
++ = *

++;

243 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

245 
İ
 [- 
l™
 - 1] =†it - 1;

246 
	gl™
 = 0; 
	gİ
++;

250 
	gİ
 [- 
l™
 - 1] =†it - 1;

251 
	gİ
 -ğ!
l™
;

253  
	gİ
 - (
	gu8
 *)
	gout_d©a
;

	@src/vr_lzf_d.c

1 
	~<vr_lzfP.h
>

3 #ià
AVOID_ERRNO


4 
	#SET_ERRNO
(
n
)

	)

6 
	~<”ºo.h
>

7 
	#SET_ERRNO
(
n
è
”ºo
 = (n)

	)

10 #ià
USE_REP_MOVSB


11 #ià(
__i386
 || 
__amd64
è&& 
__GNUC__
 >= 3

12 
	#lzf_movsb
(
d¡
, 
¤c
, 
Ën
) \

13 
	`asm
 ("rep movsb" \

14 : "=D" (
d¡
), "=S" (
¤c
), "=c" (
Ën
) \

15 : "0" (
d¡
), "1" (
¤c
), "2" (
Ën
));

	)

20 
	$lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

21 *
out_d©a
, 
out_Ën
)

23 
u8
 cÚ¡ *

 = (cÚ¡ u8 *)
š_d©a
;

24 
u8
 *
İ
 = (u8 *)
out_d©a
;

25 
u8
 cÚ¡ *cÚ¡ 
š_’d
 = 

 + 
š_Ën
;

26 
u8
 *cÚ¡ 
out_’d
 = 
İ
 + 
out_Ën
;

30 
ù¾
 = *

++;

32 ià(
ù¾
 < (1 << 5))

34 
ù¾
++;

36 ià(
İ
 + 
ù¾
 > 
out_’d
)

38 
	`SET_ERRNO
 (
E2BIG
);

42 #ià
CHECK_INPUT


43 ià(

 + 
ù¾
 > 
š_’d
)

45 
	`SET_ERRNO
 (
EINVAL
);

50 #ifdeà
lzf_movsb


51 
	`lzf_movsb
 (
İ
, 

, 
ù¾
);

53 
ù¾
)

55 32: *
İ
++ = *

++; 31: *op++ = *ip++; 30: *op++ = *ip++; 29: *op++ = *ip++;

56 28: *
İ
++ = *

++; 27: *op++ = *ip++; 26: *op++ = *ip++; 25: *op++ = *ip++;

57 24: *
İ
++ = *

++; 23: *op++ = *ip++; 22: *op++ = *ip++; 21: *op++ = *ip++;

58 20: *
İ
++ = *

++; 19: *op++ = *ip++; 18: *op++ = *ip++; 17: *op++ = *ip++;

59 16: *
İ
++ = *

++; 15: *op++ = *ip++; 14: *op++ = *ip++; 13: *op++ = *ip++;

60 12: *
İ
++ = *

++; 11: *op++ = *ip++; 10: *op++ = *ip++; 9: *op++ = *ip++;

61 8: *
İ
++ = *

++; 7: *op++ = *ip++; 6: *op++ = *ip++; 5: *op++ = *ip++;

62 4: *
İ
++ = *

++; 3: *op++ = *ip++; 2: *op++ = *ip++; 1: *op++ = *ip++;

68 
Ën
 = 
ù¾
 >> 5;

70 
u8
 *
»f
 = 
İ
 - ((
ù¾
 & 0x1f) << 8) - 1;

72 #ià
CHECK_INPUT


73 ià(

 >ğ
š_’d
)

75 
	`SET_ERRNO
 (
EINVAL
);

79 ià(
Ën
 == 7)

81 
Ën
 +ğ*

++;

82 #ià
CHECK_INPUT


83 ià(

 >ğ
š_’d
)

85 
	`SET_ERRNO
 (
EINVAL
);

91 
»f
 -ğ*

++;

93 ià(
İ
 + 
Ën
 + 2 > 
out_’d
)

95 
	`SET_ERRNO
 (
E2BIG
);

99 ià(
»f
 < (
u8
 *)
out_d©a
)

101 
	`SET_ERRNO
 (
EINVAL
);

105 #ifdeà
lzf_movsb


106 
Ën
 += 2;

107 
	`lzf_movsb
 (
İ
, 
»f
, 
Ën
);

109 
Ën
)

112 
Ën
 += 2;

114 ià(
İ
 >ğ
»f
 + 
Ën
)

117 
	`memıy
 (
İ
, 
»f
, 
Ën
);

118 
İ
 +ğ
Ën
;

124 *
İ
++ = *
»f
++;

125 --
Ën
);

130 9: *
İ
++ = *
»f
++;

131 8: *
İ
++ = *
»f
++;

132 7: *
İ
++ = *
»f
++;

133 6: *
İ
++ = *
»f
++;

134 5: *
İ
++ = *
»f
++;

135 4: *
İ
++ = *
»f
++;

136 3: *
İ
++ = *
»f
++;

137 2: *
İ
++ = *
»f
++;

138 1: *
İ
++ = *
»f
++;

139 0: *
İ
++ = *
»f
++;

140 *
İ
++ = *
»f
++;

145 

 < 
š_’d
);

147  
İ
 - (
u8
 *)
out_d©a
;

148 
	}
}

	@src/vr_master.c

1 
	~<vr_cÜe.h
>

3 
vr_ma¡”
 
	gma¡”
;

5 
£tup_ma¡”
();

6 *
ma¡”_th»ad_run
(*
¬gs
);

9 
	$ma¡”_š™
(
vr_cÚf
 *
cÚf
)

11 
r¡©us_t
 
¡©us
;

12 
ušt32_t
 
j
;

13 
sds
 *
ho¡
, 
li¡’_¡r
;

14 
vr_li¡’
 **
vli¡’
;

15 
th»ads_num
;

16 
f–im™
;

18 
ma¡”
.
cbsul
 = 
NULL
;

19 
	`±h»ad_mu‹x_š™
(&
ma¡”
.
cbsuÎock
, 
NULL
);

21 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_THREADS
,&
th»ads_num
);

22 
f–im™
 = 
th»ads_num
*2+
CONFIG_MIN_RESERVED_FDS
;

23 
	`vr_ev’oİ_š™
(&
ma¡”
.
v–
,
f–im™
);

24 
ma¡”
.
v–
.
th»ad
.
fun_run
 = 
ma¡”_th»ad_run
;

26 
	`d¬¿y_š™
(&
ma¡”
.
li¡’s
,
	`d¬¿y_n
(&
c£rv”
->
bšds
),(
vr_li¡’
*));

28 
j
 = 0; j < 
	`d¬¿y_n
(&
c£rv”
->
bšds
); j ++) {

29 
ho¡
 = 
	`d¬¿y_g‘
(&
c£rv”
->
bšds
,
j
);

30 
li¡’_¡r
 = 
	`sdsdup
(*
ho¡
);

31 
li¡’_¡r
 = 
	`sdsÿtfmt
Öi¡’_¡r, ":%i", 
c£rv”
->
pÜt
);

32 
vli¡’
 = 
	`d¬¿y_push
(&
ma¡”
.
li¡’s
);

33 *
vli¡’
 = 
	`vr_li¡’_ü—‹
(
li¡’_¡r
);

34 ià(*
vli¡’
 =ğ
NULL
) {

35 
	`d¬¿y_pİ
(&
ma¡”
.
li¡’s
);

36 
	`log_”rÜ
("C»©li¡’ % çed", 
li¡’_¡r
);

37 
	`sdsä“
(
li¡’_¡r
);

38  
VR_ERROR
;

40 
	`sdsä“
(
li¡’_¡r
);

43 
j
 = 0; j < 
	`d¬¿y_n
(&
ma¡”
.
li¡’s
); j ++) {

44 
vli¡’
 = 
	`d¬¿y_g‘
(&
ma¡”
.
li¡’s
, 
j
);

45 
¡©us
 = 
	`vr_li¡’_begš
(*
vli¡’
);

46 ià(
¡©us
 !ğ
VR_OK
) {

47 
	`log_”rÜ
("Begš†i¡’Ø% çed", (*
vli¡’
)->
Çme
);

48  
VR_ERROR
;

52 
ma¡”
.
cbsul
 = 
	`dli¡C»©e
();

53 ià(
ma¡”
.
cbsul
 =ğ
NULL
) {

54 
	`log_”rÜ
("Create†ist failed: out of memory");

55  
VR_ENOMEM
;

58 
	`£tup_ma¡”
();

60  
VR_OK
;

61 
	}
}

64 
	$ma¡”_deš™
()

66 
vr_li¡’
 **
vli¡’
;

68 
	`vr_ev’oİ_deš™
(&
ma¡”
.
v–
);

70 
	`d¬¿y_n
(&
ma¡”
.
li¡’s
) > 0) {

71 
vli¡’
 = 
	`d¬¿y_pİ
(&
ma¡”
.
li¡’s
);

72 
	`vr_li¡’_de¡roy
(*
vli¡’
);

74 
	`d¬¿y_deš™
(&
ma¡”
.
li¡’s
);

76 
	}
}

79 
	$ş›Á_acû±
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

80 
sd
;

81 
vr_li¡’
 *
vli¡’
 = 
´ivd©a
;

83 (
sd
 = 
	`vr_li¡’_acû±
(
vli¡’
)) > 0) {

84 
	`di¥©ch_cÚn_Ãw
(
vli¡’
, 
sd
);

86 
	}
}

89 
	$cbsul_push
(
cÚnsw­un™
 *
su
)

91 
	`±h»ad_mu‹x_lock
(&
ma¡”
.
cbsuÎock
);

92 
	`dli¡Push
(
ma¡”
.
cbsul
, 
su
);

93 
	`±h»ad_mu‹x_uÆock
(&
ma¡”
.
cbsuÎock
);

94 
	}
}

96 
cÚnsw­un™
 *

97 
	$cbsul_pİ
()

99 
cÚnsw­un™
 *
su
 = 
NULL
;

101 
	`±h»ad_mu‹x_lock
(&
ma¡”
.
cbsuÎock
);

102 
su
 = 
	`dli¡Pİ
(
ma¡”
.
cbsul
);

103 
	`±h»ad_mu‹x_uÆock
(&
ma¡”
.
cbsuÎock
);

105  
su
;

106 
	}
}

109 
	$di¥©ch_cÚn_exi¡
(
ş›Á
 *
c
, 
tid
)

111 
cÚnsw­un™
 *
su
 = 
	`csui_Ãw
();

112 
buf
[1];

113 
vr_wÜk”
 *
wÜk”
;

115 ià(
su
 =ğ
NULL
) {

116 
	`ä“Cl›Á
(
c
);

118 
	`log_”rÜ
("Failedo‡llocate memory for connection swap object\n");

122 
su
->
num
 = 
tid
;

123 
su
->
d©a
 = 
c
;

125 
	`uÆškCl›ÁFromEv’oİ
(
c
);

127 
	`cbsul_push
(
su
);

129 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, (
ušt32_t
)
c
->
curidx
);

132 
buf
[0] = 'b';

133 ià(
	`vr_wr™e
(
wÜk”
->
sock‘·œs
[1], 
buf
, 1) != 1) {

134 
	`log_”rÜ
("Noticehe worker failed.");

136 
	}
}

139 
	$th»ad_ev’t_´oûss
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

141 
r¡©us_t
 
¡©us
;

142 
vr_wÜk”
 *
wÜk”
 = 
´ivd©a
;

143 
buf
[1];

144 
idx
;

145 
ş›Á
 *
c
;

146 
cÚnsw­un™
 *
su
;

148 
	`ASSERT
(
–
 =ğ
ma¡”
.
v–
.el);

149 
	`ASSERT
(
fd
 =ğ
wÜk”
->
sock‘·œs
[0]);

151 ià(
	`vr_»ad
(
fd
, 
buf
, 1) != 1) {

152 
	`log_w¬n
("Can't„ead for worker(id:%d) socketpairs[1](%d)",

153 
wÜk”
->
v–
.
th»ad
.
id
, 
fd
);

154 
buf
[0] = 'b';

157 
buf
[0]) {

159 
su
 = 
	`cbsul_pİ
();

160 ià(
su
 =ğ
NULL
) {

161 
	`log_w¬n
("Pop from connection back swap†ist is‚ull");

165 
idx
 = 
su
->
num
;

166 
su
->
num
 = 
wÜk”
->
id
;

167 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, (
ušt32_t
)
idx
);

168 
	`csul_push
(
wÜk”
, 
su
);

171 
buf
[0] = 'j';

172 ià(
	`vr_wr™e
(
wÜk”
->
sock‘·œs
[0], 
buf
, 1) != 1) {

173 
	`log_”rÜ
("Noticehe worker failed.");

177 
	`log_”rÜ
("readƒrror char '%c' for worker(id:%d) socketpairs[0](%d)",

178 
buf
[0], 
wÜk”
->
v–
.
th»ad
.
id
, wÜk”->
sock‘·œs
[1]);

181 
	}
}

184 
	$£tup_ma¡”
()

186 
r¡©us_t
 
¡©us
;

187 
ušt32_t
 
j
;

188 
vr_li¡’
 **
vli¡’
;

189 
vr_wÜk”
 *
wÜk”
;

191 
j
 = 0; j < 
	`d¬¿y_n
(&
wÜk”s
); j ++) {

192 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
j
);

193 
¡©us
 = 
	`«C»©eFeEv’t
(
ma¡”
.
v–
.
–
, 
wÜk”
->
sock‘·œs
[0],

194 
AE_READABLE
, 
th»ad_ev’t_´oûss
, 
wÜk”
);

195 ià(
¡©us
 =ğ
AE_ERR
) {

196 
	`log_”rÜ
("Unrecoverableƒrror creating master ipfd fileƒvent.");

197  
VR_ERROR
;

201 
j
 = 0; j < 
	`d¬¿y_n
(&
ma¡”
.
li¡’s
); j ++) {

202 
vli¡’
 = 
	`d¬¿y_g‘
(&
ma¡”
.
li¡’s
,
j
);

203 
¡©us
 = 
	`«C»©eFeEv’t
(
ma¡”
.
v–
.
–
, (*
vli¡’
)->
sd
, 
AE_READABLE
,

204 
ş›Á_acû±
, *
vli¡’
);

205 ià(
¡©us
 =ğ
AE_ERR
) {

206 
	`log_”rÜ
("Unrecoverableƒrror creating master ipfd fileƒvent.");

207  
VR_ERROR
;

211  
VR_OK
;

212 
	}
}

215 
	$ma¡”_th»ad_run
(*
¬gs
)

218 
	`«Maš
(
ma¡”
.
v–
.
–
);

220  
NULL
;

221 
	}
}

224 
	$ma¡”_run
()

226 
	`vr_th»ad_¡¬t
(&
ma¡”
.
v–
.
th»ad
);

227  
VR_OK
;

228 
	}
}

	@src/vr_master.h

1 #iâdeà
_VR_MASTER_H_


2 
	#_VR_MASTER_H_


	)

4 
	svr_ma¡”
 {

6 
vr_ev’oİ
 
	mv–
;

8 
d¬¿y
 
	mli¡’s
;

10 
dli¡
 *
	mcbsul
;

11 
±h»ad_mu‹x_t
 
	mcbsuÎock
;

12 }
	tvr_ma¡”
;

14 
vr_ma¡”
 
ma¡”
;

16 
ma¡”_š™
(
vr_cÚf
 *
cÚf
);

17 
ma¡”_deš™
();

19 
di¥©ch_cÚn_exi¡
(
ş›Á
 *
c
, 
tid
);

21 
ma¡”_run
();

	@src/vr_multi.c

1 
	~<vr_cÜe.h
>

15 
	sw©chedKey
 {

16 
robj
 *
	mkey
;

17 
»disDb
 *
	mdb
;

18 } 
	tw©chedKey
;

22 
	$unw©chAÎKeys
(
ş›Á
 *
c
) {

23 
dli¡I‹r
 
li
;

24 
dli¡Node
 *
Ê
;

26 ià(
	`dli¡L’gth
(
c
->
w©ched_keys
) == 0) ;

27 
	`dli¡Rewšd
(
c
->
w©ched_keys
,&
li
);

28 (
Ê
 = 
	`dli¡Next
(&
li
))) {

29 
dli¡
 *
ş›Ás
;

30 
w©chedKey
 *
wk
;

34 
wk
 = 
	`dli¡NodeV®ue
(
Ê
);

35 
ş›Ás
 = 
	`diùF‘chV®ue
(
wk
->
db
->
w©ched_keys
, wk->
key
);

36 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
ş›Ás
 != NULL);

37 
	`dli¡D–Node
(
ş›Ás
,
	`dli¡S—rchKey
(ş›Ás,
c
));

39 ià(
	`dli¡L’gth
(
ş›Ás
) == 0)

40 
	`diùD–‘e
(
wk
->
db
->
w©ched_keys
, wk->
key
);

42 
	`dli¡D–Node
(
c
->
w©ched_keys
,
Ê
);

43 
	`deüRefCouÁ
(
wk
->
key
);

44 
	`dä“
(
wk
);

46 
	}
}

49 
	$š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

50 
c
->
m¡©e
.
commªds
 = 
NULL
;

51 
c
->
m¡©e
.
couÁ
 = 0;

52 
	}
}

55 
	$ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

56 
j
;

58 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

59 
i
;

60 
muÉiCmd
 *
mc
 = 
c
->
m¡©e
.
commªds
+
j
;

62 
i
 = 0; i < 
mc
->
¬gc
; i++)

63 
	`deüRefCouÁ
(
mc
->
¬gv
[
i
]);

64 
	`dä“
(
mc
->
¬gv
);

66 ià(
c
->
m¡©e
.
commªds
è
	`dä“
(c->mstate.commands);

67 
	}
}

70 
	$queueMuÉiCommªd
(
ş›Á
 *
c
) {

71 
muÉiCmd
 *
mc
;

72 
j
;

74 
c
->
m¡©e
.
commªds
 = 
	`d»®loc
(c->mstate.commands,

75 (
muÉiCmd
)*(
c
->
m¡©e
.
couÁ
+1));

76 
mc
 = 
c
->
m¡©e
.
commªds
+c->m¡©e.
couÁ
;

77 
mc
->
cmd
 = 
c
->cmd;

78 
mc
->
¬gc
 = 
c
->argc;

79 
mc
->
¬gv
 = 
	`d®loc
((
robj
*)*
c
->
¬gc
);

80 
	`memıy
(
mc
->
¬gv
,
c
->¬gv,(
robj
*)*c->
¬gc
);

81 
j
 = 0; j < 
c
->
¬gc
; j++)

82 
	`šüRefCouÁ
(
mc
->
¬gv
[
j
]);

83 
c
->
m¡©e
.
couÁ
++;

84 
	}
}

88 
	$æagT¿n§ùiÚ
(
ş›Á
 *
c
) {

89 ià(
c
->
æags
 & 
CLIENT_MULTI
)

90 
c
->
æags
 |ğ
CLIENT_DIRTY_EXEC
;

91 
	}
}

93 
	$execCommªd
(
ş›Á
 *
c
) {

94 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

95 
	}
}

97 
	$disÿrdCommªd
(
ş›Á
 *
c
) {

98 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)) {

99 
	`addR•lyE¼Ü
(
c
,"DISCARD without MULTI");

102 
	`disÿrdT¿n§ùiÚ
(
c
);

103 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

104 
	}
}

106 
	$disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
) {

107 
	`ä“Cl›ÁMuÉiS‹
(
c
);

108 
	`š™Cl›ÁMuÉiS‹
(
c
);

109 
c
->
æags
 &ğ~(
CLIENT_MULTI
|
CLIENT_DIRTY_CAS
|
CLIENT_DIRTY_EXEC
);

110 
	`unw©chAÎKeys
(
c
);

111 
	}
}

113 
	$muÉiCommªd
(
ş›Á
 *
c
) {

114 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

115 
	`addR•lyE¼Ü
(
c
,"MULTI calls can‚ot be‚ested");

118 
c
->
æags
 |ğ
CLIENT_MULTI
;

119 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

120 
	}
}

123 
	$w©chFÜKey
(
ş›Á
 *
c
, 
robj
 *
key
) {

124 
dli¡
 *
ş›Ás
 = 
NULL
;

125 
dli¡I‹r
 
li
;

126 
dli¡Node
 *
Ê
;

127 
w©chedKey
 *
wk
;

130 
	`dli¡Rewšd
(
c
->
w©ched_keys
,&
li
);

131 (
Ê
 = 
	`dli¡Next
(&
li
))) {

132 
wk
 = 
	`dli¡NodeV®ue
(
Ê
);

133 ià(
wk
->
db
 =ğ
c
->db && 
	`equ®SŒšgObjeùs
(
key
,wk->key))

137 
ş›Ás
 = 
	`diùF‘chV®ue
(
c
->
db
->
w©ched_keys
,
key
);

138 ià(!
ş›Ás
) {

139 
ş›Ás
 = 
	`dli¡C»©e
();

140 
	`diùAdd
(
c
->
db
->
w©ched_keys
,
key
,
ş›Ás
);

141 
	`šüRefCouÁ
(
key
);

143 
	`dli¡AddNodeTa
(
ş›Ás
,
c
);

145 
wk
 = 
	`d®loc
((*wk));

146 
wk
->
key
 = key;

147 
wk
->
db
 = 
c
->db;

148 
	`šüRefCouÁ
(
key
);

149 
	`dli¡AddNodeTa
(
c
->
w©ched_keys
,
wk
);

150 
	}
}

152 
	$w©chCommªd
(
ş›Á
 *
c
) {

153 
j
;

155 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

156 
	`addR•lyE¼Ü
(
c
,"WATCH inside MULTI is‚ot‡llowed");

159 
j
 = 1; j < 
c
->
¬gc
; j++)

160 
	`w©chFÜKey
(
c
,c->
¬gv
[
j
]);

161 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

162 
	}
}

166 
	$touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
) {

167 
dli¡
 *
ş›Ás
;

168 
dli¡I‹r
 
li
;

169 
dli¡Node
 *
Ê
;

171 ià(
	`diùSize
(
db
->
w©ched_keys
) == 0) ;

172 
ş›Ás
 = 
	`diùF‘chV®ue
(
db
->
w©ched_keys
, 
key
);

173 ià(!
ş›Ás
) ;

177 
	`dli¡Rewšd
(
ş›Ás
,&
li
);

178 (
Ê
 = 
	`dli¡Next
(&
li
))) {

179 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

181 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

183 
	}
}

189 
	$touchW©chedKeysOnFlush
(
dbid
) {

190 
dli¡I‹r
 
li1
, 
li2
;

191 
dli¡Node
 *
Ê
;

194 
	`dli¡Rewšd
(
£rv”
.
ş›Ás
,&
li1
);

195 (
Ê
 = 
	`dli¡Next
(&
li1
))) {

196 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

197 
	`dli¡Rewšd
(
c
->
w©ched_keys
,&
li2
);

198 (
Ê
 = 
	`dli¡Next
(&
li2
))) {

199 
w©chedKey
 *
wk
 = 
	`dli¡NodeV®ue
(
Ê
);

204 ià(
dbid
 =ğ-1 || 
wk
->
db
->
id
 == dbid) {

205 ià(
	`diùFšd
(
wk
->
db
->
diù
, wk->
key
->
±r
è!ğ
NULL
)

206 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

210 
	}
}

	@src/vr_multi.h

1 #iâdeà
_VR_MULTI_H_


2 
	#_VR_MULTI_H_


	)

5 
	smuÉiCmd
 {

6 
robj
 **
	m¬gv
;

7 
	m¬gc
;

8 
»disCommªd
 *
	mcmd
;

9 } 
	tmuÉiCmd
;

11 
	smuÉiS‹
 {

12 
muÉiCmd
 *
	mcommªds
;

13 
	mcouÁ
;

14 
	mmš»¶iÿs
;

15 
time_t
 
	mmš»¶iÿs_timeout
;

16 } 
	tmuÉiS‹
;

18 
unw©chAÎKeys
(
ş›Á
 *
c
);

19 
š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

20 
ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

21 
queueMuÉiCommªd
(
ş›Á
 *
c
);

23 
æagT¿n§ùiÚ
(
ş›Á
 *
c
);

24 
execCommªd
(
ş›Á
 *
c
);

25 
disÿrdCommªd
(
ş›Á
 *
c
);

26 
disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
);

27 
muÉiCommªd
(
ş›Á
 *
c
);

28 
w©chFÜKey
(
ş›Á
 *
c
, 
robj
 *
key
);

29 
w©chCommªd
(
ş›Á
 *
c
);

30 
touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
);

31 
touchW©chedKeysOnFlush
(
dbid
) ;

	@src/vr_notify.c

1 
	~<vr_cÜe.h
>

11 
	$key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
) {

12 *
p
 = 
şas£s
;

13 
c
, 
æags
 = 0;

15 (
c
 = *
p
++) != '\0') {

16 
c
) {

17 'A': 
æags
 |ğ
NOTIFY_ALL
; ;

18 'g': 
æags
 |ğ
NOTIFY_GENERIC
; ;

19 '$': 
æags
 |ğ
NOTIFY_STRING
; ;

20 'l': 
æags
 |ğ
NOTIFY_LIST
; ;

21 's': 
æags
 |ğ
NOTIFY_SET
; ;

22 'h': 
æags
 |ğ
NOTIFY_HASH
; ;

23 'z': 
æags
 |ğ
NOTIFY_ZSET
; ;

24 'x': 
æags
 |ğ
NOTIFY_EXPIRED
; ;

25 'e': 
æags
 |ğ
NOTIFY_EVICTED
; ;

26 'K': 
æags
 |ğ
NOTIFY_KEYSPACE
; ;

27 'E': 
æags
 |ğ
NOTIFY_KEYEVENT
; ;

31  
æags
;

32 
	}
}

38 
sds
 
	$key¥aûEv’tsFÏgsToSŒšg
(
æags
) {

39 
sds
 
»s
;

41 
»s
 = 
	`sd£m±y
();

42 ià((
æags
 & 
NOTIFY_ALL
) == NOTIFY_ALL) {

43 
»s
 = 
	`sdsÿ’
(res,"A",1);

45 ià(
æags
 & 
NOTIFY_GENERIC
è
»s
 = 
	`sdsÿ’
(res,"g",1);

46 ià(
æags
 & 
NOTIFY_STRING
è
»s
 = 
	`sdsÿ’
(res,"$",1);

47 ià(
æags
 & 
NOTIFY_LIST
è
»s
 = 
	`sdsÿ’
(res,"l",1);

48 ià(
æags
 & 
NOTIFY_SET
è
»s
 = 
	`sdsÿ’
(res,"s",1);

49 ià(
æags
 & 
NOTIFY_HASH
è
»s
 = 
	`sdsÿ’
(res,"h",1);

50 ià(
æags
 & 
NOTIFY_ZSET
è
»s
 = 
	`sdsÿ’
(res,"z",1);

51 ià(
æags
 & 
NOTIFY_EXPIRED
è
»s
 = 
	`sdsÿ’
(res,"x",1);

52 ià(
æags
 & 
NOTIFY_EVICTED
è
»s
 = 
	`sdsÿ’
(res,"e",1);

54 ià(
æags
 & 
NOTIFY_KEYSPACE
è
»s
 = 
	`sdsÿ’
(res,"K",1);

55 ià(
æags
 & 
NOTIFY_KEYEVENT
è
»s
 = 
	`sdsÿ’
(res,"E",1);

56  
»s
;

57 
	}
}

66 
	$nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
) {

67 
sds
 
chª
;

68 
robj
 *
chªobj
, *
ev’tobj
;

69 
Ën
 = -1;

70 
buf
[24];

73 ià(!(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
ty³
)) ;

75 
ev’tobj
 = 
	`ü—‹SŒšgObjeù
(
ev’t
,
	`¡¾’
(event));

78 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYSPACE
) {

79 
chª
 = 
	`sd¢ewËn
("__keyspace@",11);

80 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
dbid
);

81 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

82 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

83 
chª
 = 
	`sdsÿtsds
(chª, 
key
->
±r
);

84 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

85 
	`pubsubPublishMes§ge
(
chªobj
, 
ev’tobj
);

86 
	`deüRefCouÁ
(
chªobj
);

90 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYEVENT
) {

91 
chª
 = 
	`sd¢ewËn
("__keyevent@",11);

92 ià(
Ën
 =ğ-1èËÀğ
	`Î2¡ršg
(
buf
,(buf),
dbid
);

93 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

94 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

95 
chª
 = 
	`sdsÿtsds
(chª, 
ev’tobj
->
±r
);

96 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

97 
	`pubsubPublishMes§ge
(
chªobj
, 
key
);

98 
	`deüRefCouÁ
(
chªobj
);

100 
	`deüRefCouÁ
(
ev’tobj
);

101 
	}
}

	@src/vr_notify.h

1 #iâdeà
_VR_NOTIFY_H_


2 
	#_VR_NOTIFY_H_


	)

6 
	#NOTIFY_KEYSPACE
 (1<<0è

	)

7 
	#NOTIFY_KEYEVENT
 (1<<1è

	)

8 
	#NOTIFY_GENERIC
 (1<<2è

	)

9 
	#NOTIFY_STRING
 (1<<3è

	)

10 
	#NOTIFY_LIST
 (1<<4è

	)

11 
	#NOTIFY_SET
 (1<<5è

	)

12 
	#NOTIFY_HASH
 (1<<6è

	)

13 
	#NOTIFY_ZSET
 (1<<7è

	)

14 
	#NOTIFY_EXPIRED
 (1<<8è

	)

15 
	#NOTIFY_EVICTED
 (1<<9è

	)

16 
	#NOTIFY_ALL
 (
NOTIFY_GENERIC
 | 
NOTIFY_STRING
 | 
NOTIFY_LIST
 | 
NOTIFY_SET
 | 
NOTIFY_HASH
 | 
NOTIFY_ZSET
 | 
NOTIFY_EXPIRED
 | 
NOTIFY_EVICTED
è

	)

	@src/vr_object.c

1 
	~<m©h.h
>

2 
	~<ùy³.h
>

4 
	~<vr_cÜe.h
>

6 #ifdeà
__CYGWIN__


7 
	#¡¹Şd
(
a
,
b
è(()
	`¡¹od
(×),(b)))

	)

10 
robj
 *
	$ü—‹Objeù
(
ty³
, *
±r
) {

11 
robj
 *
o
 = 
	`d®loc
((*o));

12 
o
->
ty³
 =ype;

13 
o
->
’codšg
 = 
OBJ_ENCODING_RAW
;

14 
o
->
±r
 =…tr;

15 
o
->
cÚ¡ªt
 = 0;

16 
o
->
»fcouÁ
 = -1;

17 
o
->
Ìu
 = 0;

18  
o
;

19 
	}
}

23 
robj
 *
	$ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

24  
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
±r
,
Ën
));

25 
	}
}

30 
robj
 *
	$ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

31 
robj
 *
o
 = 
	`d®loc
(Ôobj)+(
sdshdr8
)+
Ën
+1);

32 
sdshdr8
 *
sh
 = (*)(
o
+1);

34 
o
->
ty³
 = 
OBJ_STRING
;

35 
o
->
’codšg
 = 
OBJ_ENCODING_EMBSTR
;

36 
o
->
±r
 = 
sh
+1;

37 
o
->
cÚ¡ªt
 = 0;

38 
o
->
»fcouÁ
 = -1;

39 
o
->
Ìu
 = 0;

41 
sh
->
Ën
 =†en;

42 
sh
->
®loc
 = 
Ën
;

43 
sh
->
æags
 = 
SDS_TYPE_8
;

44 ià(
±r
) {

45 
	`memıy
(
sh
->
buf
,
±r
,
Ën
);

46 
sh
->
buf
[
Ën
] = '\0';

48 
	`mem£t
(
sh
->
buf
,0,
Ën
+1);

50  
o
;

51 
	}
}

59 
	#OBJ_ENCODING_EMBSTR_SIZE_LIMIT
 44

	)

60 
robj
 *
	$ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

61 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
)

62  
	`ü—‹EmbeddedSŒšgObjeù
(
±r
,
Ën
);

64  
	`ü—‹RawSŒšgObjeù
(
±r
,
Ën
);

65 
	}
}

67 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
) {

68 
robj
 *
o
;

69 ià(
v®ue
 >ğ0 && v®u< 
OBJ_SHARED_INTEGERS
) {

70 
o
 = 
sh¬ed
.
š‹g”s
[
v®ue
];

72 ià(
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
) {

73 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

74 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

75 
o
->
±r
 = (*)(()
v®ue
);

77 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
v®ue
));

80  
o
;

81 
	}
}

89 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
) {

90 
buf
[256];

91 
Ën
;

93 ià(
	`isšf
(
v®ue
)) {

96 ià(
v®ue
 > 0) {

97 
	`memıy
(
buf
,"inf",3);

98 
Ën
 = 3;

100 
	`memıy
(
buf
,"-inf",4);

101 
Ën
 = 4;

103 } ià(
humªä›ndly
) {

109 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%.17Lf", 
v®ue
);

111 ià(
	`¡rchr
(
buf
,'.'è!ğ
NULL
) {

112 *
p
 = 
buf
+
Ën
-1;

113 *
p
 == '0') {

114 
p
--;

115 
Ën
--;

117 ià(*
p
 =ğ'.'è
Ën
--;

120 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%.17Lg", 
v®ue
);

122  
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

123 
	}
}

133 
robj
 *
	$dupSŒšgObjeù
(
robj
 *
o
) {

134 
robj
 *
d
;

136 
	`ASSERT
(
o
->
ty³
 =ğ
OBJ_STRING
);

138 
o
->
’codšg
) {

139 
OBJ_ENCODING_RAW
:

140  
	`ü—‹RawSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

141 
OBJ_ENCODING_EMBSTR
:

142  
	`ü—‹EmbeddedSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

143 
OBJ_ENCODING_INT
:

144 
d
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

145 
d
->
’codšg
 = 
OBJ_ENCODING_INT
;

146 
d
->
±r
 = 
o
->ptr;

147  
d
;

149 
	`£rv”Pªic
("Wrongƒncoding.");

152 
	}
}

154 
robj
 *
	$dupSŒšgObjeùUncÚ¡ªt
(
robj
 *
o
) {

155 ià(
o
->
cÚ¡ªt
)  o;

156  
	`dupSŒšgObjeù
(
o
);

157 
	}
}

159 
robj
 *
	$ü—‹Quickli¡Objeù
() {

160 
quickli¡
 *
l
 = 
	`quickli¡C»©e
();

161 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
l
);

162 
o
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

163  
o
;

164 
	}
}

166 
robj
 *
	$ü—‹Zli¡Objeù
() {

167 *
zl
 = 
	`zli¡New
();

168 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
zl
);

169 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

170  
o
;

171 
	}
}

173 
robj
 *
	$ü—‹S‘Objeù
() {

174 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

175 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
d
);

176 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

177  
o
;

178 
	}
}

180 
robj
 *
	$ü—‹IÁ£tObjeù
() {

181 
št£t
 *
is
 = 
	`št£tNew
();

182 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
is
);

183 
o
->
’codšg
 = 
OBJ_ENCODING_INTSET
;

184  
o
;

185 
	}
}

187 
robj
 *
	$ü—‹HashObjeù
() {

188 *
zl
 = 
	`zli¡New
();

189 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_HASH
, 
zl
);

190 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

191  
o
;

192 
	}
}

198 
robj
 *
	$ü—‹Z£tObjeù
() {

199 
z£t
 *
zs
 = 
	`d®loc
((*zs));

200 
robj
 *
o
;

202 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

203 
zs
->
z¦
 = 
	`z¦C»©e
();

204 
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zs
);

205 
o
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

206  
o
;

207 
	}
}

209 
robj
 *
	$ü—‹Z£tZli¡Objeù
() {

210 *
zl
 = 
	`zli¡New
();

211 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zl
);

212 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

213  
o
;

214 
	}
}

216 
	$ä“SŒšgObjeù
(
robj
 *
o
) {

217 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
) {

218 
	`sdsä“
(
o
->
±r
);

220 
	}
}

222 
	$ä“Li¡Objeù
(
robj
 *
o
) {

223 
o
->
’codšg
) {

224 
OBJ_ENCODING_QUICKLIST
:

225 
	`quickli¡R–—£
(
o
->
±r
);

228 
	`£rv”Pªic
("Unknown†istƒncodingype");

230 
	}
}

232 
	$ä“S‘Objeù
(
robj
 *
o
) {

233 
o
->
’codšg
) {

234 
OBJ_ENCODING_HT
:

235 
	`diùR–—£
((
diù
*è
o
->
±r
);

237 
OBJ_ENCODING_INTSET
:

238 
	`dä“
(
o
->
±r
);

241 
	`£rv”Pªic
("Unknown setƒncodingype");

243 
	}
}

245 
	$ä“Z£tObjeù
(
robj
 *
o
) {

246 
z£t
 *
zs
;

247 
o
->
’codšg
) {

248 
OBJ_ENCODING_SKIPLIST
:

249 
zs
 = 
o
->
±r
;

250 
	`diùR–—£
(
zs
->
diù
);

251 
	`z¦F»e
(
zs
->
z¦
);

252 
	`dä“
(
zs
);

254 
OBJ_ENCODING_ZIPLIST
:

255 
	`dä“
(
o
->
±r
);

258 
	`£rv”Pªic
("Unknown sorted setƒncoding");

260 
	}
}

262 
	$ä“HashObjeù
(
robj
 *
o
) {

263 
o
->
’codšg
) {

264 
OBJ_ENCODING_HT
:

265 
	`diùR–—£
((
diù
*è
o
->
±r
);

267 
OBJ_ENCODING_ZIPLIST
:

268 
	`dä“
(
o
->
±r
);

271 
	`£rv”Pªic
("Unknown hashƒncodingype");

274 
	}
}

276 
	$šüRefCouÁ
(
robj
 *
o
) {

277 
o
->
»fcouÁ
++;

278 
	}
}

280 
	$deüRefCouÁ
(
robj
 *
o
) {

281 ià(
o
->
»fcouÁ
 <ğ0è
	`£rv”Pªic
("decrRefCount‡gainst„efcount <= 0");

282 ià(
o
->
»fcouÁ
 == 1) {

283 
o
->
ty³
) {

284 
OBJ_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

285 
OBJ_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

286 
OBJ_SET
: 
	`ä“S‘Objeù
(
o
); ;

287 
OBJ_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

288 
OBJ_HASH
: 
	`ä“HashObjeù
(
o
); ;

289 : 
	`£rv”Pªic
("Unknown objectype"); ;

291 
	`dä“
(
o
);

293 
o
->
»fcouÁ
--;

295 
	}
}

300 
	$deüRefCouÁVoid
(*
o
) {

301 
	`deüRefCouÁ
(
o
);

302 
	}
}

304 
	$ä“Objeù
(
robj
 *
o
) {

305 ià(
o
->
cÚ¡ªt
) ;

307 
o
->
ty³
) {

308 
OBJ_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

309 
OBJ_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

310 
OBJ_SET
: 
	`ä“S‘Objeù
(
o
); ;

311 
OBJ_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

312 
OBJ_HASH
: 
	`ä“HashObjeù
(
o
); ;

313 : 
	`£rv”Pªic
("Unknown objectype"); ;

315 
	`dä“
(
o
);

316 
	}
}

318 
	$ä“ObjeùVoid
(*
o
) {

319 
	`ä“Objeù
(
o
);

320 
	}
}

334 
robj
 *
	$»£tRefCouÁ
(
robj
 *
obj
) {

335 
obj
->
»fcouÁ
 = 0;

336  
obj
;

337 
	}
}

339 
	$checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
) {

340 ià(
o
->
ty³
 !=ype) {

341 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

345 
	}
}

347 
	$isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
Îv®
) {

348 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

349 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

350 ià(
Îv®
è*Îv® = (è
o
->
±r
;

351  
VR_OK
;

353  
	`¡ršg2Î
(
o
->
±r
,
	`sd¦’
(o->±r),
Îv®
è? 
VR_OK
 : 
VR_ERROR
;

355 
	}
}

358 
robj
 *
	$ŒyObjeùEncodšg
(
robj
 *
o
) {

359 
v®ue
;

360 
sds
 
s
 = 
o
->
±r
;

361 
size_t
 
Ën
;

367 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

372 ià(!
	`sdsEncodedObjeù
(
o
))  o;

375 ià(
o
->
cÚ¡ªt
)  o;

380 
Ën
 = 
	`sd¦’
(
s
);

381 ià(
Ën
 <ğ21 && 
	`¡ršg2l
(
s
,Ën,&
v®ue
)) {

390 
v®ue
 >= 0 &&

391 
v®ue
 < 
OBJ_SHARED_INTEGERS
)

393 
	`ä“Objeù
(
o
);

394  
sh¬ed
.
š‹g”s
[
v®ue
];

396 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
è
	`sdsä“
(o->
±r
);

397 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

398 
o
->
±r
 = (*è
v®ue
;

399  
o
;

407 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
) {

408 
robj
 *
emb
;

410 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
)  o;

411 
emb
 = 
	`ü—‹EmbeddedSŒšgObjeù
(
s
,
	`sd¦’
(s));

412 
	`ä“Objeù
(
o
);

413  
emb
;

425 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

426 
	`sd§va
(
s
è> 
Ën
/10)

428 
o
->
±r
 = 
	`sdsRemoveF»eS·û
(o->ptr);

432  
o
;

433 
	}
}

437 
robj
 *
	$g‘DecodedObjeù
(
robj
 *
o
) {

438 
robj
 *
dec
;

440 ià(
	`sdsEncodedObjeù
(
o
)) {

441  
o
;

443 ià(
o
->
ty³
 =ğ
OBJ_STRING
 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

444 
buf
[32];

446 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

447 
dec
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

448  
dec
;

450 
	`£rv”Pªic
("Unknownƒncodingype");

452 
	}
}

462 
	#REDIS_COMPARE_BINARY
 (1<<0)

	)

463 
	#REDIS_COMPARE_COLL
 (1<<1)

	)

465 
	$com·»SŒšgObjeùsW™hFÏgs
(
robj
 *
a
,„obj *
b
, 
æags
) {

466 
	`£rv”As£¹W™hInfo
(
NULL
,
a
,a->
ty³
 =ğ
OBJ_STRING
 && 
b
->type == OBJ_STRING);

467 
buç
[128], 
bufb
[128], *
a¡r
, *
b¡r
;

468 
size_t
 
®’
, 
bËn
, 
mšËn
;

470 ià(
a
 =ğ
b
)  0;

471 ià(
	`sdsEncodedObjeù
(
a
)) {

472 
a¡r
 = 
a
->
±r
;

473 
®’
 = 
	`sd¦’
(
a¡r
);

475 
®’
 = 
	`Î2¡ršg
(
buç
,(buç),(è
a
->
±r
);

476 
a¡r
 = 
buç
;

478 ià(
	`sdsEncodedObjeù
(
b
)) {

479 
b¡r
 = 
b
->
±r
;

480 
bËn
 = 
	`sd¦’
(
b¡r
);

482 
bËn
 = 
	`Î2¡ršg
(
bufb
,(bufb),(è
b
->
±r
);

483 
b¡r
 = 
bufb
;

485 ià(
æags
 & 
REDIS_COMPARE_COLL
) {

486  
	`¡rcŞl
(
a¡r
,
b¡r
);

488 
cmp
;

490 
mšËn
 = (
®’
 < 
bËn
) ?‡len : blen;

491 
cmp
 = 
	`memcmp
(
a¡r
,
b¡r
,
mšËn
);

492 ià(
cmp
 =ğ0è 
®’
-
bËn
;

493  
cmp
;

495 
	}
}

498 
	$com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

499  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_BINARY
);

500 
	}
}

503 
	$cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

504  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_COLL
);

505 
	}
}

511 
	$equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

512 ià(
a
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

513 
b
->
’codšg
 =ğ
OBJ_ENCODING_INT
){

516  
a
->
±r
 =ğ
b
->ptr;

518  
	`com·»SŒšgObjeùs
(
a
,
b
) == 0;

520 
	}
}

522 
size_t
 
	$¡ršgObjeùL’
(
robj
 *
o
) {

523 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

524 ià(
	`sdsEncodedObjeù
(
o
)) {

525  
	`sd¦’
(
o
->
±r
);

527  
	`sdig™s10
(()
o
->
±r
);

529 
	}
}

531 
	$g‘DoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

532 
v®ue
;

533 *
•Œ
;

535 ià(
o
 =ğ
NULL
) {

536 
v®ue
 = 0;

538 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

539 ià(
	`sdsEncodedObjeù
(
o
)) {

540 
”ºo
 = 0;

541 
v®ue
 = 
	`¡¹od
(
o
->
±r
, &
•Œ
);

542 ià(
	`is¥aû
(((*)
o
->
±r
)[0]) ||

543 
•Œ
[0] != '\0' ||

544 (
”ºo
 =ğ
ERANGE
 &&

545 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

546 
”ºo
 =ğ
EINVAL
 ||

547 
	`i¢ª
(
v®ue
))

548  
VR_ERROR
;

549 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

550 
v®ue
 = ()
o
->
±r
;

552 
	`£rv”Pªic
("Unknown stringƒncoding");

555 *
rg‘
 = 
v®ue
;

556  
VR_OK
;

557 
	}
}

559 
	$g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

560 
v®ue
;

561 ià(
	`g‘DoubËFromObjeù
(
o
, &
v®ue
è!ğ
VR_OK
) {

562 ià(
msg
 !ğ
NULL
) {

563 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

565 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

567  
VR_ERROR
;

569 *
rg‘
 = 
v®ue
;

570  
VR_OK
;

571 
	}
}

573 
	$g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

574 
v®ue
;

575 *
•Œ
;

577 ià(
o
 =ğ
NULL
) {

578 
v®ue
 = 0;

580 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

581 ià(
	`sdsEncodedObjeù
(
o
)) {

582 
”ºo
 = 0;

583 
v®ue
 = 
	`¡¹Şd
(
o
->
±r
, &
•Œ
);

584 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

585 
”ºo
 =ğ
ERANGE
 || 
	`i¢ª
(
v®ue
))

586  
VR_ERROR
;

587 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

588 
v®ue
 = ()
o
->
±r
;

590 
	`£rv”Pªic
("Unknown stringƒncoding");

593 *
rg‘
 = 
v®ue
;

594  
VR_OK
;

595 
	}
}

597 
	$g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

598 
v®ue
;

599 ià(
	`g‘LÚgDoubËFromObjeù
(
o
, &
v®ue
è!ğ
VR_OK
) {

600 ià(
msg
 !ğ
NULL
) {

601 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

603 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

605  
VR_ERROR
;

607 *
rg‘
 = 
v®ue
;

608  
VR_OK
;

609 
	}
}

611 
	$g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
) {

612 
v®ue
;

613 *
•Œ
;

615 ià(
o
 =ğ
NULL
) {

616 
v®ue
 = 0;

618 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

619 ià(
	`sdsEncodedObjeù
(
o
)) {

620 
”ºo
 = 0;

621 
v®ue
 = 
	`¡¹Şl
(
o
->
±r
, &
•Œ
, 10);

622 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

623 
”ºo
 =ğ
ERANGE
)

624  
VR_ERROR
;

625 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

626 
v®ue
 = ()
o
->
±r
;

628 
	`£rv”Pªic
("Unknown stringƒncoding");

631 ià(
rg‘
è*rg‘ = 
v®ue
;

632  
VR_OK
;

633 
	}
}

635 
	$g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

636 
v®ue
;

637 ià(
	`g‘LÚgLÚgFromObjeù
(
o
, &
v®ue
è!ğ
VR_OK
) {

638 ià(
msg
 !ğ
NULL
) {

639 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

641 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡n integer or out of„ange");

643  
VR_ERROR
;

645 *
rg‘
 = 
v®ue
;

646  
VR_OK
;

647 
	}
}

649 
	$g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

650 
v®ue
;

652 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
o
, &
v®ue
, 
msg
è!ğ
VR_OK
è 
VR_ERROR
;

653 ià(
v®ue
 < 
LONG_MIN
 || v®u> 
LONG_MAX
) {

654 ià(
msg
 !ğ
NULL
) {

655 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

657 
	`addR•lyE¼Ü
(
c
,"value is out of„ange");

659  
VR_ERROR
;

661 *
rg‘
 = 
v®ue
;

662  
VR_OK
;

663 
	}
}

665 *
	$¡rEncodšg
(
’codšg
) {

666 
’codšg
) {

667 
OBJ_ENCODING_RAW
:  "raw";

668 
OBJ_ENCODING_INT
:  "int";

669 
OBJ_ENCODING_HT
:  "hashtable";

670 
OBJ_ENCODING_QUICKLIST
:  "quicklist";

671 
OBJ_ENCODING_ZIPLIST
:  "ziplist";

672 
OBJ_ENCODING_INTSET
:  "intset";

673 
OBJ_ENCODING_SKIPLIST
:  "skiplist";

674 
OBJ_ENCODING_EMBSTR
:  "embstr";

677 
	}
}

681 
	$e¡im©eObjeùIdËTime
(
robj
 *
o
) {

682 
Ìuşock
 = 
	`LRU_CLOCK
();

683 ià(
Ìuşock
 >ğ
o
->
Ìu
) {

684  (
Ìuşock
 - 
o
->
Ìu
è* 
LRU_CLOCK_RESOLUTION
;

686  (
Ìuşock
 + (
LRU_CLOCK_MAX
 - 
o
->
Ìu
)) *

687 
LRU_CLOCK_RESOLUTION
;

689 
	}
}

693 
size_t
 
	$g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
) {

694 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

695 
o
->
’codšg
) {

696 
OBJ_ENCODING_RAW
:  
	`sdsZm®locSize
(
o
->
±r
);

697 
OBJ_ENCODING_EMBSTR
:  
	`dm®loc_size
(
o
)-(
robj
);

700 
	}
}

704 
robj
 *
	$objeùCommªdLookup
(
ş›Á
 *
c
, 
robj
 *
key
) {

705 
diùEÁry
 *
de
;

707 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,
key
->
±r
)è=ğ
NULL
)  NULL;

708  (
robj
*è
	`diùG‘V®
(
de
);

709 
	}
}

711 
robj
 *
	$objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

712 
robj
 *
o
 = 
	`objeùCommªdLookup
(
c
,
key
);

714 ià(!
o
è
	`addR•ly
(
c
, 
»¶y
);

715  
o
;

716 
	}
}

720 
	$objeùCommªd
(
ş›Á
 *
c
) {

721 
robj
 *
o
;

723 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"’codšg"è&& c->
¬gc
 == 3) {

724 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[2]);

725 
	`lockDbR—d
(
c
->
db
);

726 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

727 =ğ
NULL
) {

728 
	`uÆockDb
(
c
->
db
);

731 
	`addR•lyBulkCSŒšg
(
c
,
	`¡rEncodšg
(
o
->
’codšg
));

732 
	`uÆockDb
(
c
->
db
);

733 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"idËtime"è&& c->
¬gc
 == 3) {

734 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[2]);

735 
	`lockDbR—d
(
c
->
db
);

736 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

737 =ğ
NULL
) {

738 
	`uÆockDb
(
c
->
db
);

741 
	`addR•lyLÚgLÚg
(
c
,
	`e¡im©eObjeùIdËTime
(
o
)/1000);

742 
	`uÆockDb
(
c
->
db
);

744 
	`addR•lyE¼Ü
(
c
,"Syntaxƒrror. Try OBJECT (encoding|idletime)");

746 
	}
}

	@src/vr_object.h

1 #iâdeà
_VR_OBJECT_H_


2 
	#_VR_OBJECT_H_


	)

4 
	#OBJ_SHARED_INTEGERS
 10000

	)

5 
	#OBJ_SHARED_BULKHDR_LEN
 32

	)

8 
	#OBJ_STRING
 0

	)

9 
	#OBJ_LIST
 1

	)

10 
	#OBJ_SET
 2

	)

11 
	#OBJ_ZSET
 3

	)

12 
	#OBJ_HASH
 4

	)

17 
	#OBJ_ENCODING_RAW
 0

	)

18 
	#OBJ_ENCODING_INT
 1

	)

19 
	#OBJ_ENCODING_HT
 2

	)

20 
	#OBJ_ENCODING_ZIPMAP
 3

	)

21 
	#OBJ_ENCODING_LINKEDLIST
 4

	)

22 
	#OBJ_ENCODING_ZIPLIST
 5

	)

23 
	#OBJ_ENCODING_INTSET
 6

	)

24 
	#OBJ_ENCODING_SKIPLIST
 7

	)

25 
	#OBJ_ENCODING_EMBSTR
 8

	)

26 
	#OBJ_ENCODING_QUICKLIST
 9

	)

28 
	#OBJ_HASH_KEY
 1

	)

29 
	#OBJ_HASH_VALUE
 2

	)

31 
	#sdsEncodedObjeù
(
obj±r
è(obj±r->
’codšg
 =ğ
OBJ_ENCODING_RAW
 || obj±r->’codšg =ğ
OBJ_ENCODING_EMBSTR
)

	)

34 
	#LRU_BITS
 24

	)

35 
	#LRU_CLOCK_MAX
 ((1<<
LRU_BITS
)-1è

	)

36 
	#LRU_CLOCK_RESOLUTION
 1000

	)

37 
	svr_objeù
 {

38 
	mty³
:4;

39 
	m’codšg
:4;

40 
	mÌu
:
LRU_BITS
;

41 
	mcÚ¡ªt
:1;

42 
	m»fcouÁ
;

43 *
	m±r
;

44 } 
	trobj
;

46 
deüRefCouÁ
(
robj
 *
o
);

47 
deüRefCouÁVoid
(*
o
);

48 
šüRefCouÁ
(
robj
 *
o
);

49 
robj
 *
»£tRefCouÁ
Ôobj *
obj
);

50 
ä“Objeù
(
robj
 *
o
);

51 
ä“ObjeùVoid
(*
o
);

52 
ä“SŒšgObjeù
(
robj
 *
o
);

53 
ä“Li¡Objeù
(
robj
 *
o
);

54 
ä“S‘Objeù
(
robj
 *
o
);

55 
ä“Z£tObjeù
(
robj
 *
o
);

56 
ä“HashObjeù
(
robj
 *
o
);

57 
robj
 *
ü—‹Objeù
(
ty³
, *
±r
);

58 
robj
 *
ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

59 
robj
 *
ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

60 
robj
 *
ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

61 
robj
 *
dupSŒšgObjeù
Ôobj *
o
);

62 
robj
 *
dupSŒšgObjeùUncÚ¡ªt
Ôobj *
o
);

63 
isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
ÎÚgv®
);

64 
robj
 *
ŒyObjeùEncodšg
Ôobj *
o
);

65 
robj
 *
g‘DecodedObjeù
Ôobj *
o
);

66 
size_t
 
¡ršgObjeùL’
(
robj
 *
o
);

67 
robj
 *
ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

68 
robj
 *
ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
);

69 
robj
 *
ü—‹Quickli¡Objeù
();

70 
robj
 *
ü—‹Zli¡Objeù
();

71 
robj
 *
ü—‹S‘Objeù
();

72 
robj
 *
ü—‹IÁ£tObjeù
();

73 
robj
 *
ü—‹HashObjeù
();

74 
robj
 *
ü—‹Z£tObjeù
();

75 
robj
 *
ü—‹Z£tZli¡Objeù
();

76 
g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

77 
checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
);

78 
g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

79 
g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

80 
g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
);

81 
g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
);

82 
g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

83 *
¡rEncodšg
(
’codšg
);

84 
com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

85 
cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

86 
equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

87 
e¡im©eObjeùIdËTime
(
robj
 *
o
);

89 
size_t
 
g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
);

91 
robj
 *
objeùCommªdLookup
(
ş›Á
 *
c
,„obj *
key
);

92 
robj
 *
objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

93 
objeùCommªd
(
ş›Á
 *
c
);

	@src/vr_pubsub.c

1 
	~<vr_cÜe.h
>

5 
	$pubsubUnsubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
) {

6 
diùEÁry
 *
de
;

7 
dli¡
 *
ş›Ás
;

8 
dli¡Node
 *
Ê
;

9 
»tv®
 = 0;

12 
	`šüRefCouÁ
(
chªÃl
);

14 ià(
	`diùD–‘e
(
c
->
pubsub_chªÃls
,
chªÃl
è=ğ
DICT_OK
) {

15 
»tv®
 = 1;

17 
de
 = 
	`diùFšd
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
);

18 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
de
 != NULL);

19 
ş›Ás
 = 
	`diùG‘V®
(
de
);

20 
Ê
 = 
	`dli¡S—rchKey
(
ş›Ás
,
c
);

21 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
Ê
 != NULL);

22 
	`dli¡D–Node
(
ş›Ás
,
Ê
);

23 ià(
	`dli¡L’gth
(
ş›Ás
) == 0) {

27 
	`diùD–‘e
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
);

31 ià(
nÙify
) {

32 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

33 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

34 
	`addR•lyBulk
(
c
,
chªÃl
);

35 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

36 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

39 
	`deüRefCouÁ
(
chªÃl
);

40  
»tv®
;

41 
	}
}

45 
	$pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
) {

46 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
pubsub_chªÃls
);

47 
diùEÁry
 *
de
;

48 
couÁ
 = 0;

50 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

51 
robj
 *
chªÃl
 = 
	`diùG‘Key
(
de
);

53 
couÁ
 +ğ
	`pubsubUnsubsüibeChªÃl
(
c
,
chªÃl
,
nÙify
);

56 ià(
nÙify
 && 
couÁ
 == 0) {

57 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

58 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

59 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

60 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

61 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

63 
	`diùR–—£I‹¿tÜ
(
di
);

64  
couÁ
;

65 
	}
}

69 
	$pubsubUnsubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
) {

70 
dli¡Node
 *
Ê
;

71 
pubsubP©‹º
 
·t
;

72 
»tv®
 = 0;

74 
	`šüRefCouÁ
(
·‰”n
);

75 ià((
Ê
 = 
	`dli¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
)è!ğ
NULL
) {

76 
»tv®
 = 1;

77 
	`dli¡D–Node
(
c
->
pubsub_·‰”ns
,
Ê
);

78 
·t
.
ş›Á
 = 
c
;

79 
·t
.
·‰”n
 =…attern;

80 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
pubsub_·‰”ns
,&
·t
);

81 
	`dli¡D–Node
(
c
->
v–
->
pubsub_·‰”ns
,
Ê
);

84 ià(
nÙify
) {

85 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

86 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

87 
	`addR•lyBulk
(
c
,
·‰”n
);

88 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

89 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

91 
	`deüRefCouÁ
(
·‰”n
);

92  
»tv®
;

93 
	}
}

97 
	$pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
) {

98 
dli¡Node
 *
Ê
;

99 
dli¡I‹r
 
li
;

100 
couÁ
 = 0;

102 
	`dli¡Rewšd
(
c
->
pubsub_·‰”ns
,&
li
);

103 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

104 
robj
 *
·‰”n
 = 
Ê
->
v®ue
;

106 
couÁ
 +ğ
	`pubsubUnsubsüibeP©‹º
(
c
,
·‰”n
,
nÙify
);

108 ià(
nÙify
 && 
couÁ
 == 0) {

110 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

111 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

112 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

113 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

114 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

116  
couÁ
;

117 
	}
}

126 
	$pubsubSubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
) {

127 
diùEÁry
 *
de
;

128 
dli¡
 *
ş›Ás
 = 
NULL
;

129 
»tv®
 = 0;

132 ià(
	`diùAdd
(
c
->
pubsub_chªÃls
,
chªÃl
,
NULL
è=ğ
DICT_OK
) {

133 
»tv®
 = 1;

134 
	`šüRefCouÁ
(
chªÃl
);

136 
de
 = 
	`diùFšd
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
);

137 ià(
de
 =ğ
NULL
) {

138 
ş›Ás
 = 
	`dli¡C»©e
();

139 
	`diùAdd
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
,
ş›Ás
);

140 
	`šüRefCouÁ
(
chªÃl
);

142 
ş›Ás
 = 
	`diùG‘V®
(
de
);

144 
	`dli¡AddNodeTa
(
ş›Ás
,
c
);

147 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

148 
	`addR•ly
(
c
,
sh¬ed
.
subsüibebulk
);

149 
	`addR•lyBulk
(
c
,
chªÃl
);

150 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

151  
»tv®
;

152 
	}
}

154 
	$subsüibeCommªd
(
ş›Á
 *
c
) {

155 
j
;

157 
j
 = 1; j < 
c
->
¬gc
; j++)

158 
	`pubsubSubsüibeChªÃl
(
c
,c->
¬gv
[
j
]);

159 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

160 
	}
}

163 
	$ş›ÁSubsütiÚsCouÁ
(
ş›Á
 *
c
) {

164  
	`diùSize
(
c
->
pubsub_chªÃls
)+

165 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
);

166 
	}
}

168 
	$unsubsüibeCommªd
(
ş›Á
 *
c
) {

169 ià(
c
->
¬gc
 == 1) {

170 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,1);

172 
j
;

174 
j
 = 1; j < 
c
->
¬gc
; j++)

175 
	`pubsubUnsubsüibeChªÃl
(
c
,c->
¬gv
[
j
],1);

177 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

178 
	}
}

181 
	$pubsubSubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
) {

182 
»tv®
 = 0;

184 ià(
	`dli¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
è=ğ
NULL
) {

185 
»tv®
 = 1;

186 
pubsubP©‹º
 *
·t
;

187 
	`dli¡AddNodeTa
(
c
->
pubsub_·‰”ns
,
·‰”n
);

188 
	`šüRefCouÁ
(
·‰”n
);

189 
·t
 = 
	`d®loc
((*pat));

190 
·t
->
·‰”n
 = 
	`g‘DecodedObjeù
(pattern);

191 
·t
->
ş›Á
 = 
c
;

192 
	`dli¡AddNodeTa
(
c
->
v–
->
pubsub_·‰”ns
,
·t
);

195 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

196 
	`addR•ly
(
c
,
sh¬ed
.
psubsüibebulk
);

197 
	`addR•lyBulk
(
c
,
·‰”n
);

198 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

199  
»tv®
;

200 
	}
}

202 
	$psubsüibeCommªd
(
ş›Á
 *
c
) {

203 
j
;

205 
j
 = 1; j < 
c
->
¬gc
; j++)

206 
	`pubsubSubsüibeP©‹º
(
c
,c->
¬gv
[
j
]);

207 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

208 
	}
}

210 
	$punsubsüibeCommªd
(
ş›Á
 *
c
) {

211 ià(
c
->
¬gc
 == 1) {

212 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,1);

214 
j
;

216 
j
 = 1; j < 
c
->
¬gc
; j++)

217 
	`pubsubUnsubsüibeP©‹º
(
c
,c->
¬gv
[
j
],1);

219 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

220 
	}
}

223 
	$pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

224 
»ûiv”s
 = 0;

225 
diùEÁry
 *
de
;

226 
dli¡Node
 *
Ê
;

227 
dli¡I‹r
 
li
;

230 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

231 ià(
de
) {

232 
dli¡
 *
li¡
 = 
	`diùG‘V®
(
de
);

233 
dli¡Node
 *
Ê
;

234 
dli¡I‹r
 
li
;

236 
	`dli¡Rewšd
(
li¡
,&
li
);

237 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

238 
ş›Á
 *
c
 = 
Ê
->
v®ue
;

240 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

241 
	`addR•ly
(
c
,
sh¬ed
.
mes§gebulk
);

242 
	`addR•lyBulk
(
c
,
chªÃl
);

243 
	`addR•lyBulk
(
c
,
mes§ge
);

244 
»ûiv”s
++;

248 ià(
	`dli¡L’gth
(
£rv”
.
pubsub_·‰”ns
)) {

249 
	`dli¡Rewšd
(
£rv”
.
pubsub_·‰”ns
,&
li
);

250 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

251 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

252 
pubsubP©‹º
 *
·t
 = 
Ê
->
v®ue
;

254 ià(
	`¡ršgm©chËn
((*)
·t
->
·‰”n
->
±r
,

255 
	`sd¦’
(
·t
->
·‰”n
->
±r
),

256 (*)
chªÃl
->
±r
,

257 
	`sd¦’
(
chªÃl
->
±r
),0)) {

258 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
mbulkhdr
[4]);

259 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
pmes§gebulk
);

260 
	`addR•lyBulk
(
·t
->
ş›Á
,·t->
·‰”n
);

261 
	`addR•lyBulk
(
·t
->
ş›Á
,
chªÃl
);

262 
	`addR•lyBulk
(
·t
->
ş›Á
,
mes§ge
);

263 
»ûiv”s
++;

266 
	`deüRefCouÁ
(
chªÃl
);

268  
»ûiv”s
;

269 
	}
}

	@src/vr_pubsub.h

1 #iâdeà
_VR_PUBSUB_H_


2 
	#_VR_PUBSUB_H_


	)

4 
	spubsubP©‹º
 {

5 
ş›Á
 *
	mş›Á
;

6 
robj
 *
	m·‰”n
;

7 } 
	tpubsubP©‹º
;

9 
pubsubUnsubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
);

10 
pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
);

11 
pubsubUnsubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
);

12 
pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
);

13 
pubsubSubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
);

14 
ş›ÁSubsütiÚsCouÁ
(
ş›Á
 *
c
);

15 
subsüibeCommªd
(
ş›Á
 *
c
);

16 
unsubsüibeCommªd
(
ş›Á
 *
c
);

17 
psubsüibeCommªd
(
ş›Á
 *
c
);

18 
punsubsüibeCommªd
(
ş›Á
 *
c
);

19 
pubsubSubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
);

20 
pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
);

	@src/vr_quicklist.c

1 
	~<¡ršg.h
>

3 
	~<vr_cÜe.h
>

5 #ià
defšed
(
REDIS_TEST
è|| defšed(
REDIS_TEST_VERBOSE
)

6 
	~<¡dio.h
>

9 #iâdeà
REDIS_STATIC


10 
	#REDIS_STATIC
 

	)

14 cÚ¡ 
size_t
 
	gİtimiz©iÚ_Ëv–
[] = {4096, 8192, 16384, 32768, 65536};

18 
	#SIZE_SAFETY_LIMIT
 8192

	)

21 
	#MIN_COMPRESS_BYTES
 48

	)

26 
	#MIN_COMPRESS_IMPROVE
 8

	)

29 #iâdeà
REDIS_TEST_VERBOSE


30 
	#D
(...)

	)

32 
	#D
(...) \

34 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

35 
	`´štf
(
__VA_ARGS__
); \

36 
	`´štf
("\n"); \

37 } 0);

	)

41 
	#š™EÁry
(
e
) \

43 (
e
)->
zi
 = (e)->
v®ue
 = 
NULL
; \

44 (
e
)->
lÚgv®
 = -123456789; \

45 (
e
)->
quickli¡
 = 
NULL
; \

46 (
e
)->
node
 = 
NULL
; \

47 (
e
)->
off£t
 = 123456789; \

48 (
e
)->
sz
 = 0; \

49 } 0)

	)

51 #ià
__GNUC__
 >= 3

52 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

53 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

55 
	#lik–y
(
x
è(x)

	)

56 
	#uÆik–y
(
x
è(x)

	)

61 
quickli¡
 *
	$quickli¡C»©e
() {

62 
quickli¡
 *quicklist;

64 
quickli¡
 = 
	`d®loc
((*quicklist));

65 
quickli¡
->
h—d
 = quickli¡->

 = 
NULL
;

66 
quickli¡
->
Ën
 = 0;

67 
quickli¡
->
couÁ
 = 0;

68 
quickli¡
->
com´ess
 = 0;

69 
quickli¡
->
fl
 = -2;

70  
quickli¡
;

71 
	}
}

73 
	#COMPRESS_MAX
 (1 << 16)

	)

74 
	$quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
com´ess
) {

75 ià(
com´ess
 > 
COMPRESS_MAX
) {

76 
com´ess
 = 
COMPRESS_MAX
;

77 } ià(
com´ess
 < 0) {

78 
com´ess
 = 0;

80 
quickli¡
->
com´ess
 = compress;

81 
	}
}

83 
	#FILL_MAX
 (1 << 15)

	)

84 
	$quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
) {

85 ià(
fl
 > 
FILL_MAX
) {

86 
fl
 = 
FILL_MAX
;

87 } ià(
fl
 < -5) {

88 
fl
 = -5;

90 
quickli¡
->
fl
 = fill;

91 
	}
}

93 
	$quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
) {

94 
	`quickli¡S‘Fl
(
quickli¡
, 
fl
);

95 
	`quickli¡S‘Com´essD•th
(
quickli¡
, 
d•th
);

96 
	}
}

99 
quickli¡
 *
	$quickli¡New
(
fl
, 
com´ess
) {

100 
quickli¡
 *quickli¡ = 
	`quickli¡C»©e
();

101 
	`quickli¡S‘O±iÚs
(
quickli¡
, 
fl
, 
com´ess
);

102  
quickli¡
;

103 
	}
}

105 
REDIS_STATIC
 
quickli¡Node
 *
	$quickli¡C»©eNode
() {

106 
quickli¡Node
 *
node
;

107 
node
 = 
	`d®loc
((*node));

108 
node
->
zl
 = 
NULL
;

109 
node
->
couÁ
 = 0;

110 
node
->
sz
 = 0;

111 
node
->
Ãxt
 =‚ode->
´ev
 = 
NULL
;

112 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

113 
node
->
cÚš”
 = 
QUICKLIST_NODE_CONTAINER_ZIPLIST
;

114 
node
->
»com´ess
 = 0;

115  
node
;

116 
	}
}

119 
	$quickli¡CouÁ
(
quickli¡
 *
ql
è{  ql->
couÁ
; 
	}
}

122 
	$quickli¡R–—£
(
quickli¡
 *quicklist) {

123 
Ën
;

124 
quickli¡Node
 *
cu¼’t
, *
Ãxt
;

126 
cu¼’t
 = 
quickli¡
->
h—d
;

127 
Ën
 = 
quickli¡
->len;

128 
Ën
--) {

129 
Ãxt
 = 
cu¼’t
->next;

131 
	`dä“
(
cu¼’t
->
zl
);

132 
quickli¡
->
couÁ
 -ğ
cu¼’t
->count;

134 
	`dä“
(
cu¼’t
);

136 
quickli¡
->
Ën
--;

137 
cu¼’t
 = 
Ãxt
;

139 
	`dä“
(
quickli¡
);

140 
	}
}

145 
REDIS_STATIC
 
	$__quickli¡Com´essNode
(
quickli¡Node
 *
node
) {

146 #ifdeà
REDIS_TEST


147 
node
->
©‹m±ed_com´ess
 = 1;

151 ià(
node
->
sz
 < 
MIN_COMPRESS_BYTES
)

154 
quickli¡LZF
 *
lzf
 = 
	`d®loc
((*lzfè+ 
node
->
sz
);

157 ià(((
lzf
->
sz
 = 
	`lzf_com´ess
(
node
->
zl
,‚ode->sz,†zf->
com´es£d
,

158 
node
->
sz
)) == 0) ||

159 
lzf
->
sz
 + 
MIN_COMPRESS_IMPROVE
 >ğ
node
->sz) {

161 
	`dä“
(
lzf
);

164 
lzf
 = 
	`d»®loc
Özf, (*lzfè+†zf->
sz
);

165 
	`dä“
(
node
->
zl
);

166 
node
->
zl
 = (*)
lzf
;

167 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_LZF
;

168 
node
->
»com´ess
 = 0;

170 
	}
}

173 
	#quickli¡Com´essNode
(
_node
) \

175 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) { \

176 
	`__quickli¡Com´essNode
((
_node
)); \

178 } 0)

	)

182 
REDIS_STATIC
 
	$__quickli¡Decom´essNode
(
quickli¡Node
 *
node
) {

183 #ifdeà
REDIS_TEST


184 
node
->
©‹m±ed_com´ess
 = 0;

187 *
decom´es£d
 = 
	`d®loc
(
node
->
sz
);

188 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

189 ià(
	`lzf_decom´ess
(
lzf
->
com´es£d
,†zf->
sz
, 
decom´es£d
, 
node
->sz) == 0) {

191 
	`dä“
(
decom´es£d
);

194 
	`dä“
(
lzf
);

195 
node
->
zl
 = 
decom´es£d
;

196 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

198 
	}
}

201 
	#quickli¡Decom´essNode
(
_node
) \

203 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

204 
	`__quickli¡Decom´essNode
((
_node
)); \

206 } 0)

	)

209 
	#quickli¡Decom´essNodeFÜU£
(
_node
) \

211 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

212 
	`__quickli¡Decom´essNode
((
_node
)); \

213 (
_node
)->
»com´ess
 = 1; \

215 } 0)

	)

220 
size_t
 
	$quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
) {

221 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

222 *
d©a
 = 
lzf
->
com´es£d
;

223  
lzf
->
sz
;

224 
	}
}

226 
	#quickli¡AÎowsCom´essiÚ
(
_ql
è((_ql)->
com´ess
 !ğ0)

	)

232 
REDIS_STATIC
 
	$__quickli¡Com´ess
(cÚ¡ 
quickli¡
 *quicklist,

233 
quickli¡Node
 *
node
) {

236 ià(!
	`quickli¡AÎowsCom´essiÚ
(
quickli¡
) ||

237 
quickli¡
->
Ën
 < ()(quickli¡->
com´ess
 * 2))

242 ià(
quickli¡
->
com´ess
 == 1) {

243 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
t
 = quickli¡->

;

244 
	`quickli¡Decom´essNode
(
h
);

245 
	`quickli¡Decom´essNode
(
t
);

246 ià(
h
 !ğ
node
 && 
t
 !=‚ode)

247 
	`quickli¡Com´essNode
(
node
);

249 } ià(
quickli¡
->
com´ess
 == 2) {

250 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
hn
 = h->
Ãxt
, *
hÂ
 = hn->next;

251 
quickli¡Node
 *
t
 = 
quickli¡
->

, *

 =->
´ev
, *
p
 =p->prev;

252 
	`quickli¡Decom´essNode
(
h
);

253 
	`quickli¡Decom´essNode
(
hn
);

254 
	`quickli¡Decom´essNode
(
t
);

255 
	`quickli¡Decom´essNode
(

);

256 ià(
h
 !ğ
node
 && 
hn
 !ğnod&& 
t
 !ğnod&& 

 !=‚ode) {

257 
	`quickli¡Com´essNode
(
node
);

259 ià(
hÂ
 !ğ
t
) {

260 
	`quickli¡Com´essNode
(
hÂ
);

262 ià(
p
 !ğ
h
) {

263 
	`quickli¡Com´essNode
(
p
);

272 
quickli¡Node
 *
fÜw¬d
 = 
quickli¡
->
h—d
;

273 
quickli¡Node
 *
»v”£
 = 
quickli¡
->

;

274 
d•th
 = 0;

275 
š_d•th
 = 0;

276 
d•th
++ < 
quickli¡
->
com´ess
) {

277 
	`quickli¡Decom´essNode
(
fÜw¬d
);

278 
	`quickli¡Decom´essNode
(
»v”£
);

280 ià(
fÜw¬d
 =ğ
node
 || 
»v”£
 ==‚ode)

281 
š_d•th
 = 1;

283 ià(
fÜw¬d
 =ğ
»v”£
)

286 
fÜw¬d
 = fÜw¬d->
Ãxt
;

287 
»v”£
 =„ev”£->
´ev
;

290 ià(!
š_d•th
)

291 
	`quickli¡Com´essNode
(
node
);

293 ià(
d•th
 > 2) {

295 
	`quickli¡Com´essNode
(
fÜw¬d
);

296 
	`quickli¡Com´essNode
(
»v”£
);

298 
	}
}

300 
	#quickli¡Com´ess
(
_ql
, 
_node
) \

302 ià((
_node
)->
»com´ess
) \

303 
	`quickli¡Com´essNode
((
_node
)); \

305 
	`__quickli¡Com´ess
((
_ql
), (
_node
)); \

306 } 0)

	)

309 
	#quickli¡Recom´essOÆy
(
_ql
, 
_node
) \

311 ià((
_node
)->
»com´ess
) \

312 
	`quickli¡Com´essNode
((
_node
)); \

313 } 0)

	)

319 
REDIS_STATIC
 
	$__quickli¡In£¹Node
(
quickli¡
 *quicklist,

320 
quickli¡Node
 *
Şd_node
,

321 
quickli¡Node
 *
Ãw_node
, 
aá”
) {

322 ià(
aá”
) {

323 
Ãw_node
->
´ev
 = 
Şd_node
;

324 ià(
Şd_node
) {

325 
Ãw_node
->
Ãxt
 = 
Şd_node
->next;

326 ià(
Şd_node
->
Ãxt
)

327 
Şd_node
->
Ãxt
->
´ev
 = 
Ãw_node
;

328 
Şd_node
->
Ãxt
 = 
Ãw_node
;

330 ià(
quickli¡
->

 =ğ
Şd_node
)

331 
quickli¡
->

 = 
Ãw_node
;

333 
Ãw_node
->
Ãxt
 = 
Şd_node
;

334 ià(
Şd_node
) {

335 
Ãw_node
->
´ev
 = 
Şd_node
->prev;

336 ià(
Şd_node
->
´ev
)

337 
Şd_node
->
´ev
->
Ãxt
 = 
Ãw_node
;

338 
Şd_node
->
´ev
 = 
Ãw_node
;

340 ià(
quickli¡
->
h—d
 =ğ
Şd_node
)

341 
quickli¡
->
h—d
 = 
Ãw_node
;

344 ià(
quickli¡
->
Ën
 == 0) {

345 
quickli¡
->
h—d
 = quickli¡->

 = 
Ãw_node
;

348 ià(
Şd_node
)

349 
	`quickli¡Com´ess
(
quickli¡
, 
Şd_node
);

351 
quickli¡
->
Ën
++;

352 
	}
}

355 
REDIS_STATIC
 
	$_quickli¡In£¹NodeBefÜe
(
quickli¡
 *quicklist,

356 
quickli¡Node
 *
Şd_node
,

357 
quickli¡Node
 *
Ãw_node
) {

358 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 0);

359 
	}
}

361 
REDIS_STATIC
 
	$_quickli¡In£¹NodeAá”
(
quickli¡
 *quicklist,

362 
quickli¡Node
 *
Şd_node
,

363 
quickli¡Node
 *
Ãw_node
) {

364 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 1);

365 
	}
}

367 
REDIS_STATIC
 

368 
	$_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(cÚ¡ 
size_t
 
sz
,

369 cÚ¡ 
fl
) {

370 ià(
fl
 >= 0)

373 
size_t
 
off£t
 = (-
fl
) - 1;

374 ià(
off£t
 < ((
İtimiz©iÚ_Ëv–
) / (*optimization_level))) {

375 ià(
sz
 <ğ
İtimiz©iÚ_Ëv–
[
off£t
]) {

383 
	}
}

385 
	#sizeM“tsSaãtyLim™
(
sz
è((szè<ğ
SIZE_SAFETY_LIMIT
)

	)

387 
REDIS_STATIC
 
	$_quickli¡NodeAÎowIn£¹
(cÚ¡ 
quickli¡Node
 *
node
,

388 cÚ¡ 
fl
, cÚ¡ 
size_t
 
sz
) {

389 ià(
	`uÆik–y
(!
node
))

392 
zli¡_ov”h—d
;

394 ià(
sz
 < 254)

395 
zli¡_ov”h—d
 = 1;

397 
zli¡_ov”h—d
 = 5;

400 ià(
sz
 < 64)

401 
zli¡_ov”h—d
 += 1;

402 ià(
	`lik–y
(
sz
 < 16384))

403 
zli¡_ov”h—d
 += 2;

405 
zli¡_ov”h—d
 += 5;

408 
Ãw_sz
 = 
node
->
sz
 + sz + 
zli¡_ov”h—d
;

409 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
Ãw_sz
, 
fl
)))

411 ià(!
	`sizeM“tsSaãtyLim™
(
Ãw_sz
))

413 ià(()
node
->
couÁ
 < 
fl
)

417 
	}
}

419 
REDIS_STATIC
 
	$_quickli¡NodeAÎowM”ge
(cÚ¡ 
quickli¡Node
 *
a
,

420 cÚ¡ 
quickli¡Node
 *
b
,

421 cÚ¡ 
fl
) {

422 ià(!
a
 || !
b
)

427 
m”ge_sz
 = 
a
->
sz
 + 
b
->sz - 11;

428 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
m”ge_sz
, 
fl
)))

430 ià(!
	`sizeM“tsSaãtyLim™
(
m”ge_sz
))

432 ià(()(
a
->
couÁ
 + 
b
->couÁè<ğ
fl
)

436 
	}
}

438 
	#quickli¡NodeUpd©eSz
(
node
) \

440 (
node
)->
sz
 = 
	`zli¡BlobL’
(Òode)->
zl
); \

441 } 0)

	)

447 
	$quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

448 
quickli¡Node
 *
Üig_h—d
 = 
quickli¡
->
h—d
;

449 ià(
	`lik–y
(

450 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->
h—d
, quickli¡->
fl
, 
sz
))) {

451 
quickli¡
->
h—d
->
zl
 =

452 
	`zli¡Push
(
quickli¡
->
h—d
->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

453 
	`quickli¡NodeUpd©eSz
(
quickli¡
->
h—d
);

455 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

456 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

458 
	`quickli¡NodeUpd©eSz
(
node
);

459 
	`_quickli¡In£¹NodeBefÜe
(
quickli¡
, quickli¡->
h—d
, 
node
);

461 
quickli¡
->
couÁ
++;

462 
quickli¡
->
h—d
->
couÁ
++;

463  (
Üig_h—d
 !ğ
quickli¡
->
h—d
);

464 
	}
}

470 
	$quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

471 
quickli¡Node
 *
Üig_
 = 
quickli¡
->

;

472 ià(
	`lik–y
(

473 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->

, quickli¡->
fl
, 
sz
))) {

474 
quickli¡
->

->
zl
 =

475 
	`zli¡Push
(
quickli¡
->

->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

476 
	`quickli¡NodeUpd©eSz
(
quickli¡
->

);

478 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

479 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

481 
	`quickli¡NodeUpd©eSz
(
node
);

482 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

484 
quickli¡
->
couÁ
++;

485 
quickli¡
->

->
couÁ
++;

486  (
Üig_
 !ğ
quickli¡
->

);

487 
	}
}

492 
	$quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
) {

493 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

495 
node
->
zl
 = zl;

496 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

497 
node
->
sz
 = 
	`zli¡BlobL’
(
zl
);

499 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

500 
quickli¡
->
couÁ
 +ğ
node
->count;

501 
	}
}

509 
quickli¡
 *
	$quickli¡Aµ’dV®uesFromZli¡
(
quickli¡
 *quicklist,

510 *
zl
) {

511 *
v®ue
;

512 
sz
;

513 
lÚgv®
;

514 
lÚg¡r
[32] = {0};

516 *
p
 = 
	`zli¡Index
(
zl
, 0);

517 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
)) {

518 ià(!
v®ue
) {

520 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

521 
v®ue
 = (*)
lÚg¡r
;

523 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

524 
p
 = 
	`zli¡Next
(
zl
,…);

526 
	`dä“
(
zl
);

527  
quickli¡
;

528 
	}
}

533 
quickli¡
 *
	$quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

534 *
zl
) {

535  
	`quickli¡Aµ’dV®uesFromZli¡
(
	`quickli¡New
(
fl
, 
com´ess
), 
zl
);

536 
	}
}

538 
	#quickli¡D–‘eIfEm±y
(
ql
, 
n
) \

540 ià((
n
)->
couÁ
 == 0) { \

541 
	`__quickli¡D–Node
((
ql
), (
n
)); \

542 (
n
èğ
NULL
; \

544 } 0)

	)

546 
REDIS_STATIC
 
	$__quickli¡D–Node
(
quickli¡
 *quicklist,

547 
quickli¡Node
 *
node
) {

548 ià(
node
->
Ãxt
)

549 
node
->
Ãxt
->
´ev
 =‚ode->prev;

550 ià(
node
->
´ev
)

551 
node
->
´ev
->
Ãxt
 =‚ode->next;

553 ià(
node
 =ğ
quickli¡
->

) {

554 
quickli¡
->

 = 
node
->
´ev
;

557 ià(
node
 =ğ
quickli¡
->
h—d
) {

558 
quickli¡
->
h—d
 = 
node
->
Ãxt
;

563 
	`__quickli¡Com´ess
(
quickli¡
, 
NULL
);

565 
quickli¡
->
couÁ
 -ğ
node
->count;

567 
	`dä“
(
node
->
zl
);

568 
	`dä“
(
node
);

569 
quickli¡
->
Ën
--;

570 
	}
}

580 
REDIS_STATIC
 
	$quickli¡D–Index
(
quickli¡
 *quickli¡, 
quickli¡Node
 *
node
,

581 **
p
) {

582 
gÚe
 = 0;

584 
node
->
zl
 = 
	`zli¡D–‘e
Òode->zl, 
p
);

585 
node
->
couÁ
--;

586 ià(
node
->
couÁ
 == 0) {

587 
gÚe
 = 1;

588 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

590 
	`quickli¡NodeUpd©eSz
(
node
);

592 
quickli¡
->
couÁ
--;

594  
gÚe
 ? 1 : 0;

595 
	}
}

601 
	$quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

602 
quickli¡Node
 *
´ev
 = 
’Œy
->
node
->prev;

603 
quickli¡Node
 *
Ãxt
 = 
’Œy
->
node
->next;

604 
d–‘ed_node
 = 
	`quickli¡D–Index
((
quickli¡
 *)
’Œy
->quicklist,

605 
’Œy
->
node
, &’Œy->
zi
);

608 
™”
->
zi
 = 
NULL
;

611 ià(
d–‘ed_node
) {

612 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

613 
™”
->
cu¼’t
 = 
Ãxt
;

614 
™”
->
off£t
 = 0;

615 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

616 
™”
->
cu¼’t
 = 
´ev
;

617 
™”
->
off£t
 = -1;

628 
	}
}

634 
	$quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

635 
sz
) {

636 
quickli¡EÁry
 
’Œy
;

637 ià(
	`lik–y
(
	`quickli¡Index
(
quickli¡
, 
šdex
, &
’Œy
))) {

639 
’Œy
.
node
->
zl
 = 
	`zli¡D–‘e
ÓÁry.node->zl, &’Œy.
zi
);

640 
’Œy
.
node
->
zl
 = 
	`zli¡In£¹
ÓÁry.node->zl,ƒÁry.
zi
, 
d©a
, 
sz
);

641 
	`quickli¡Com´ess
(
quickli¡
, 
’Œy
.
node
);

646 
	}
}

661 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡Zli¡M”ge
(
quickli¡
 *quicklist,

662 
quickli¡Node
 *
a
,

663 
quickli¡Node
 *
b
) {

664 
	`D
("Reque¡ed m”g×,bè(%u, %u)", 
a
->
couÁ
, 
b
->count);

666 
	`quickli¡Decom´essNode
(
a
);

667 
	`quickli¡Decom´essNode
(
b
);

668 ià((
	`zli¡M”ge
(&
a
->
zl
, &
b
->zl))) {

670 
quickli¡Node
 *
k“p
 = 
NULL
, *
nok“p
 = NULL;

671 ià(!
a
->
zl
) {

672 
nok“p
 = 
a
;

673 
k“p
 = 
b
;

674 } ià(!
b
->
zl
) {

675 
nok“p
 = 
b
;

676 
k“p
 = 
a
;

678 
k“p
->
couÁ
 = 
	`zli¡L’
(k“p->
zl
);

679 
	`quickli¡NodeUpd©eSz
(
k“p
);

681 
nok“p
->
couÁ
 = 0;

682 
	`__quickli¡D–Node
(
quickli¡
, 
nok“p
);

683 
	`quickli¡Com´ess
(
quickli¡
, 
k“p
);

684  
k“p
;

687  
NULL
;

689 
	}
}

699 
REDIS_STATIC
 
	$_quickli¡M”geNodes
(
quickli¡
 *quicklist,

700 
quickli¡Node
 *
ûÁ”
) {

701 
fl
 = 
quickli¡
->fill;

702 
quickli¡Node
 *
´ev
, *
´ev_´ev
, *
Ãxt
, *
Ãxt_Ãxt
, *
rg‘
;

703 
´ev
 = 
´ev_´ev
 = 
Ãxt
 = 
Ãxt_Ãxt
 = 
rg‘
 = 
NULL
;

705 ià(
ûÁ”
->
´ev
) {

706 
´ev
 = 
ûÁ”
->prev;

707 ià(
ûÁ”
->
´ev
->prev)

708 
´ev_´ev
 = 
ûÁ”
->
´ev
->prev;

711 ià(
ûÁ”
->
Ãxt
) {

712 
Ãxt
 = 
ûÁ”
->next;

713 ià(
ûÁ”
->
Ãxt
->next)

714 
Ãxt_Ãxt
 = 
ûÁ”
->
Ãxt
->next;

718 ià(
	`_quickli¡NodeAÎowM”ge
(
´ev
, 
´ev_´ev
, 
fl
)) {

719 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
´ev_´ev
, 
´ev
);

720 
´ev_´ev
 = 
´ev
 = 
NULL
;

724 ià(
	`_quickli¡NodeAÎowM”ge
(
Ãxt
, 
Ãxt_Ãxt
, 
fl
)) {

725 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
Ãxt
, 
Ãxt_Ãxt
);

726 
Ãxt
 = 
Ãxt_Ãxt
 = 
NULL
;

730 ià(
	`_quickli¡NodeAÎowM”ge
(
ûÁ”
, c’‹r->
´ev
, 
fl
)) {

731 
rg‘
 = 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
ûÁ”
->
´ev
, center);

732 
ûÁ”
 = 
NULL
;

735 
rg‘
 = 
ûÁ”
;

739 ià(
	`_quickli¡NodeAÎowM”ge
(
rg‘
,¬g‘->
Ãxt
, 
fl
)) {

740 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
rg‘
,¬g‘->
Ãxt
);

742 
	}
}

763 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡S¶™Node
(
quickli¡Node
 *
node
, 
off£t
,

764 
aá”
) {

765 
size_t
 
zl_sz
 = 
node
->
sz
;

767 
quickli¡Node
 *
Ãw_node
 = 
	`quickli¡C»©eNode
();

768 
Ãw_node
->
zl
 = 
	`d®loc
(
zl_sz
);

771 
	`memıy
(
Ãw_node
->
zl
, 
node
->zl, 
zl_sz
);

774 
Üig_¡¬t
 = 
aá”
 ? 
off£t
 + 1 : 0;

775 
Üig_ex‹Á
 = 
aá”
 ? -1 : 
off£t
;

776 
Ãw_¡¬t
 = 
aá”
 ? 0 : 
off£t
;

777 
Ãw_ex‹Á
 = 
aá”
 ? 
off£t
 + 1 : -1;

779 
	`D
("Aá” %d (%d);„ªges: [%d, %d], [%d, %d]", 
aá”
, 
off£t
, 
Üig_¡¬t
,

780 
Üig_ex‹Á
, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

782 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
Üig_¡¬t
, 
Üig_ex‹Á
);

783 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

784 
	`quickli¡NodeUpd©eSz
(
node
);

786 
Ãw_node
->
zl
 = 
	`zli¡D–‘eRªge
Òew_node->zl, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

787 
Ãw_node
->
couÁ
 = 
	`zli¡L’
Òew_node->
zl
);

788 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

790 
	`D
("Aá” s¶™†’gths: orig (%d),‚ew (%d)", 
node
->
couÁ
, 
Ãw_node
->count);

791  
Ãw_node
;

792 
	}
}

798 
REDIS_STATIC
 
	$_quickli¡In£¹
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

799 *
v®ue
, cÚ¡ 
size_t
 
sz
, 
aá”
) {

800 
fuÎ
 = 0, 
©_
 = 0, 
©_h—d
 = 0, 
fuÎ_Ãxt
 = 0, 
fuÎ_´ev
 = 0;

801 
fl
 = 
quickli¡
->fill;

802 
quickli¡Node
 *
node
 = 
’Œy
->node;

803 
quickli¡Node
 *
Ãw_node
 = 
NULL
;

805 ià(!
node
) {

807 
	`D
("No‚ode given!");

808 
Ãw_node
 = 
	`quickli¡C»©eNode
();

809 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

810 
	`__quickli¡In£¹Node
(
quickli¡
, 
NULL
, 
Ãw_node
, 
aá”
);

811 
Ãw_node
->
couÁ
++;

812 
quickli¡
->
couÁ
++;

817 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
, 
fl
, 
sz
)) {

818 
	`D
("Current‚ode is full with count %d with„equested fill %lu",

819 
node
->
couÁ
, 
fl
);

820 
fuÎ
 = 1;

823 ià(
aá”
 && (
’Œy
->
off£t
 =ğ
node
->
couÁ
)) {

824 
	`D
("At Tail of current ziplist");

825 
©_
 = 1;

826 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
Ãxt
, 
fl
, 
sz
)) {

827 
	`D
("Next‚ode is fulloo.");

828 
fuÎ_Ãxt
 = 1;

832 ià(!
aá”
 && (
’Œy
->
off£t
 == 0)) {

833 
	`D
("At Head");

834 
©_h—d
 = 1;

835 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
´ev
, 
fl
, 
sz
)) {

836 
	`D
("Prev‚ode is fulloo.");

837 
fuÎ_´ev
 = 1;

842 ià(!
fuÎ
 && 
aá”
) {

843 
	`D
("Not full, inserting‡fter current…osition.");

844 
	`quickli¡Decom´essNodeFÜU£
(
node
);

845 *
Ãxt
 = 
	`zli¡Next
(
node
->
zl
, 
’Œy
->
zi
);

846 ià(
Ãxt
 =ğ
NULL
) {

847 
node
->
zl
 = 
	`zli¡Push
Òode->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

849 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
Ãxt
, 
v®ue
, 
sz
);

851 
node
->
couÁ
++;

852 
	`quickli¡NodeUpd©eSz
(
node
);

853 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

854 } ià(!
fuÎ
 && !
aá”
) {

855 
	`D
("Not full, inserting before current…osition.");

856 
	`quickli¡Decom´essNodeFÜU£
(
node
);

857 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
’Œy
->
zi
, 
v®ue
, 
sz
);

858 
node
->
couÁ
++;

859 
	`quickli¡NodeUpd©eSz
(
node
);

860 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

861 } ià(
fuÎ
 && 
©_
 && 
node
->
Ãxt
 && !
fuÎ_Ãxt
 && 
aá”
) {

864 
	`D
("Full‡ndail, but‚ext isn't full; inserting‚ext‚ode head");

865 
Ãw_node
 = 
node
->
Ãxt
;

866 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

867 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

868 
Ãw_node
->
couÁ
++;

869 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

870 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

871 } ià(
fuÎ
 && 
©_h—d
 && 
node
->
´ev
 && !
fuÎ_´ev
 && !
aá”
) {

874 
	`D
("Full‡nd head, but…rev isn't full, inserting…rev‚odeail");

875 
Ãw_node
 = 
node
->
´ev
;

876 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

877 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

878 
Ãw_node
->
couÁ
++;

879 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

880 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

881 } ià(
fuÎ
 && ((
©_
 && 
node
->
Ãxt
 && 
fuÎ_Ãxt
 && 
aá”
) ||

882 (
©_h—d
 && 
node
->
´ev
 && 
fuÎ_´ev
 && !
aá”
))) {

885 
	`D
("\tprovisioning‚ew‚ode...");

886 
Ãw_node
 = 
	`quickli¡C»©eNode
();

887 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

888 
Ãw_node
->
couÁ
++;

889 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

890 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

891 } ià(
fuÎ
) {

894 
	`D
("\tsplitting‚ode...");

895 
	`quickli¡Decom´essNodeFÜU£
(
node
);

896 
Ãw_node
 = 
	`_quickli¡S¶™Node
(
node
, 
’Œy
->
off£t
, 
aá”
);

897 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
,

898 
aá”
 ? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
);

899 
Ãw_node
->
couÁ
++;

900 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

901 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

902 
	`_quickli¡M”geNodes
(
quickli¡
, 
node
);

905 
quickli¡
->
couÁ
++;

906 
	}
}

908 
	$quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

909 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

910 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 0);

911 
	}
}

913 
	$quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

914 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

915 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 1);

916 
	}
}

924 
	$quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
,

925 cÚ¡ 
couÁ
) {

926 ià(
couÁ
 <= 0)

929 
ex‹Á
 = 
couÁ
;

931 ià(
¡¬t
 >ğ0 && 
ex‹Á
 > (
quickli¡
->
couÁ
 - start)) {

933 
ex‹Á
 = 
quickli¡
->
couÁ
 - 
¡¬t
;

934 } ià(
¡¬t
 < 0 && 
ex‹Á
 > ()(-start)) {

936 
ex‹Á
 = -
¡¬t
;

939 
quickli¡EÁry
 
’Œy
;

940 ià(!
	`quickli¡Index
(
quickli¡
, 
¡¬t
, &
’Œy
))

943 
	`D
("Quickli¡ d–‘»que¡ fÜ s¹ %ld, couÁ %ld,ƒx‹Á: %ld", 
¡¬t
,

944 
couÁ
, 
ex‹Á
);

945 
quickli¡Node
 *
node
 = 
’Œy
.node;

948 
ex‹Á
) {

949 
quickli¡Node
 *
Ãxt
 = 
node
->next;

951 
d–
;

952 
d–‘e_’tœe_node
 = 0;

953 ià(
’Œy
.
off£t
 =ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

956 
d–‘e_’tœe_node
 = 1;

957 
d–
 = 
node
->
couÁ
;

958 } ià(
’Œy
.
off£t
 >ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

961 
d–
 = 
node
->
couÁ
 - 
’Œy
.
off£t
;

962 } ià(
’Œy
.
off£t
 < 0) {

968 
d–
 = -
’Œy
.
off£t
;

973 ià(
d–
 > 
ex‹Á
)

974 
d–
 = 
ex‹Á
;

978 
d–
 = 
ex‹Á
;

981 
	`D
("[%ld]:‡skingo del: %ld because offset: %d; (ENTIRE NODE: %d), "

983 
ex‹Á
, 
d–
, 
’Œy
.
off£t
, 
d–‘e_’tœe_node
, 
node
->
couÁ
);

985 ià(
d–‘e_’tœe_node
) {

986 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

988 
	`quickli¡Decom´essNodeFÜU£
(
node
);

989 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
’Œy
.
off£t
, 
d–
);

990 
	`quickli¡NodeUpd©eSz
(
node
);

991 
node
->
couÁ
 -ğ
d–
;

992 
quickli¡
->
couÁ
 -ğ
d–
;

993 
	`quickli¡D–‘eIfEm±y
(
quickli¡
, 
node
);

994 ià(
node
)

995 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

998 
ex‹Á
 -ğ
d–
;

1000 
node
 = 
Ãxt
;

1002 
’Œy
.
off£t
 = 0;

1005 
	}
}

1008 
	$quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
) {

1009  
	`zli¡Com·»
(
p1
, 
p2
, 
p2_Ën
);

1010 
	}
}

1014 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
) {

1015 
quickli¡I‹r
 *
™”
;

1017 
™”
 = 
	`d®loc
((*iter));

1019 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1020 
™”
->
cu¼’t
 = 
quickli¡
->
h—d
;

1021 
™”
->
off£t
 = 0;

1022 } ià(
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1023 
™”
->
cu¼’t
 = 
quickli¡
->

;

1024 
™”
->
off£t
 = -1;

1027 
™”
->
dœeùiÚ
 = direction;

1028 
™”
->
quickli¡
 = quicklist;

1030 
™”
->
zi
 = 
NULL
;

1032  
™”
;

1033 
	}
}

1037 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

1038 cÚ¡ 
dœeùiÚ
,

1039 cÚ¡ 
idx
) {

1040 
quickli¡EÁry
 
’Œy
;

1042 ià(
	`quickli¡Index
(
quickli¡
, 
idx
, &
’Œy
)) {

1043 
quickli¡I‹r
 *
ba£
 = 
	`quickli¡G‘I‹¿tÜ
(
quickli¡
, 
dœeùiÚ
);

1044 
ba£
->
zi
 = 
NULL
;

1045 
ba£
->
cu¼’t
 = 
’Œy
.
node
;

1046 
ba£
->
off£t
 = 
’Œy
.offset;

1047  
ba£
;

1049  
NULL
;

1051 
	}
}

1055 
	$quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
) {

1056 ià(
™”
->
cu¼’t
)

1057 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1059 
	`dä“
(
™”
);

1060 
	}
}

1083 
	$quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

1084 
	`š™EÁry
(
’Œy
);

1086 ià(!
™”
) {

1087 
	`D
("Returning because‚o iter!");

1091 
’Œy
->
quickli¡
 = 
™”
->quicklist;

1092 
’Œy
->
node
 = 
™”
->
cu¼’t
;

1094 ià(!
™”
->
cu¼’t
) {

1095 
	`D
("Returning because current‚ode is NULL")

1099 *(*
ÃxtFn
)(*, *èğ
NULL
;

1100 
off£t_upd©e
 = 0;

1102 ià(!
™”
->
zi
) {

1104 
	`quickli¡Decom´essNodeFÜU£
(
™”
->
cu¼’t
);

1105 
™”
->
zi
 = 
	`zli¡Index
(™”->
cu¼’t
->
zl
, i‹r->
off£t
);

1108 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1109 
ÃxtFn
 = 
zli¡Next
;

1110 
off£t_upd©e
 = 1;

1111 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1112 
ÃxtFn
 = 
zli¡P»v
;

1113 
off£t_upd©e
 = -1;

1115 
™”
->
zi
 = 
	`ÃxtFn
(™”->
cu¼’t
->
zl
, iter->zi);

1116 
™”
->
off£t
 +ğ
off£t_upd©e
;

1119 
’Œy
->
zi
 = 
™”
->zi;

1120 
’Œy
->
off£t
 = 
™”
->offset;

1122 ià(
™”
->
zi
) {

1124 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1129 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1130 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1132 
	`D
("Jumpingo start of‚ext‚ode");

1133 
™”
->
cu¼’t
 = i‹r->cu¼’t->
Ãxt
;

1134 
™”
->
off£t
 = 0;

1135 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1137 
	`D
("Jumpingoƒnd of…revious‚ode");

1138 
™”
->
cu¼’t
 = i‹r->cu¼’t->
´ev
;

1139 
™”
->
off£t
 = -1;

1141 
™”
->
zi
 = 
NULL
;

1142  
	`quickli¡Next
(
™”
, 
’Œy
);

1144 
	}
}

1152 
quickli¡
 *
	$quickli¡Dup
(
quickli¡
 *
Üig
) {

1153 
quickli¡
 *
cİy
;

1154 
quickli¡Node
 *
cu¼’t
;

1156 
cİy
 = 
	`quickli¡New
(
Üig
->
fl
, orig->
com´ess
);

1158 
cu¼’t
 = 
Üig
->
h—d
; current;

1159 
cu¼’t
 = cu¼’t->
Ãxt
) {

1160 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

1162 ià(
node
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) {

1163 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

1164 
size_t
 
lzf_sz
 = (*
lzf
è+†zf->
sz
;

1165 
node
->
zl
 = 
	`d®loc
(
lzf_sz
);

1166 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, 
lzf_sz
);

1167 } ià(
node
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) {

1168 
node
->
zl
 = 
	`d®loc
(
cu¼’t
->
sz
);

1169 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, cu¼’t->
sz
);

1172 
node
->
couÁ
 = 
cu¼’t
->count;

1173 
cİy
->
couÁ
 +ğ
node
->count;

1174 
node
->
sz
 = 
cu¼’t
->sz;

1175 
node
->
’codšg
 = 
cu¼’t
->encoding;

1177 
	`_quickli¡In£¹NodeAá”
(
cİy
, cİy->

, 
node
);

1181  
cİy
;

1182 
	}
}

1192 
	$quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
idx
,

1193 
quickli¡EÁry
 *
’Œy
) {

1194 
quickli¡Node
 *
n
;

1195 
accum
 = 0;

1196 
šdex
;

1197 
fÜw¬d
 = 
idx
 < 0 ? 0 : 1;

1199 
	`š™EÁry
(
’Œy
);

1200 
’Œy
->
quickli¡
 = quicklist;

1202 ià(!
fÜw¬d
) {

1203 
šdex
 = (-
idx
) - 1;

1204 
n
 = 
quickli¡
->

;

1206 
šdex
 = 
idx
;

1207 
n
 = 
quickli¡
->
h—d
;

1210 ià(
šdex
 >ğ
quickli¡
->
couÁ
)

1213 
	`lik–y
(
n
)) {

1214 ià((
accum
 + 
n
->
couÁ
è> 
šdex
) {

1217 
	`D
("Skpšg ov” (%pè%u‡ˆaccum %Îd", (*)
n
,‚->
couÁ
,

1218 
accum
);

1219 
accum
 +ğ
n
->
couÁ
;

1220 
n
 = 
fÜw¬d
 ?‚->
Ãxt
 :‚->
´ev
;

1224 ià(!
n
)

1227 
	`D
("Found‚ode: %°©‡ccum %Îu, idx %Îu, sub+ %Îu, sub- %Îu", (*)
n
,

1228 
accum
, 
šdex
, index -‡ccum, (-index) - 1 +‡ccum);

1230 
’Œy
->
node
 = 
n
;

1231 ià(
fÜw¬d
) {

1233 
’Œy
->
off£t
 = 
šdex
 - 
accum
;

1237 
’Œy
->
off£t
 = (-
šdex
è- 1 + 
accum
;

1240 
	`quickli¡Decom´essNodeFÜU£
(
’Œy
->
node
);

1241 
’Œy
->
zi
 = 
	`zli¡Index
ÓÁry->
node
->
zl
,ƒÁry->
off£t
);

1242 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1246 
	}
}

1249 
	$quickli¡RÙ©e
(
quickli¡
 *quicklist) {

1250 ià(
quickli¡
->
couÁ
 <= 1)

1254 *
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1255 *
v®ue
;

1256 
lÚgv®
;

1257 
sz
;

1258 
lÚg¡r
[32] = {0};

1259 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
);

1262 ià(!
v®ue
) {

1264 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

1265 
v®ue
 = (*)
lÚg¡r
;

1269 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1274 ià(
quickli¡
->
Ën
 == 1) {

1275 
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1279 
	`quickli¡D–Index
(
quickli¡
, quickli¡->

, &
p
);

1280 
	}
}

1291 
	$quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1292 *
sz
, *
sv®
,

1293 *(*
§v”
)(*
d©a
, 
sz
)) {

1294 *
p
;

1295 *
v¡r
;

1296 
vËn
;

1297 
vlÚg
;

1298 
pos
 = (
wh”e
 =ğ
QUICKLIST_HEAD
) ? 0 : -1;

1300 ià(
quickli¡
->
couÁ
 == 0)

1303 ià(
d©a
)

1304 *
d©a
 = 
NULL
;

1305 ià(
sz
)

1306 *
sz
 = 0;

1307 ià(
sv®
)

1308 *
sv®
 = -123456789;

1310 
quickli¡Node
 *
node
;

1311 ià(
wh”e
 =ğ
QUICKLIST_HEAD
 && 
quickli¡
->
h—d
) {

1312 
node
 = 
quickli¡
->
h—d
;

1313 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
 && 
quickli¡
->

) {

1314 
node
 = 
quickli¡
->

;

1319 
p
 = 
	`zli¡Index
(
node
->
zl
, 
pos
);

1320 ià(
	`zli¡G‘
(
p
, &
v¡r
, &
vËn
, &
vlÚg
)) {

1321 ià(
v¡r
) {

1322 ià(
d©a
)

1323 *
d©a
 = 
	`§v”
(
v¡r
, 
vËn
);

1324 ià(
sz
)

1325 *
sz
 = 
vËn
;

1327 ià(
d©a
)

1328 *
d©a
 = 
NULL
;

1329 ià(
sv®
)

1330 *
sv®
 = 
vlÚg
;

1332 
	`quickli¡D–Index
(
quickli¡
, 
node
, &
p
);

1336 
	}
}

1339 
REDIS_STATIC
 *
	$_quickli¡Sav”
(*
d©a
, 
sz
) {

1340 *
v¡r
;

1341 ià(
d©a
) {

1342 
v¡r
 = 
	`d®loc
(
sz
);

1343 
	`memıy
(
v¡r
, 
d©a
, 
sz
);

1344  
v¡r
;

1346  
NULL
;

1347 
	}
}

1352 
	$quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1353 *
sz
, *
¦Úg
) {

1354 *
v¡r
;

1355 
vËn
;

1356 
vlÚg
;

1357 ià(
quickli¡
->
couÁ
 == 0)

1359 
»t
 = 
	`quickli¡PİCu¡om
(
quickli¡
, 
wh”e
, &
v¡r
, &
vËn
, &
vlÚg
,

1360 
_quickli¡Sav”
);

1361 ià(
d©a
)

1362 *
d©a
 = 
v¡r
;

1363 ià(
¦Úg
)

1364 *
¦Úg
 = 
vlÚg
;

1365 ià(
sz
)

1366 *
sz
 = 
vËn
;

1367  
»t
;

1368 
	}
}

1371 
	$quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

1372 
wh”e
) {

1373 ià(
wh”e
 =ğ
QUICKLIST_HEAD
) {

1374 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1375 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
) {

1376 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

1378 
	}
}

	@src/vr_quicklist.h

1 #iâdeà
_VR_QUICKLIST_H_


2 
	#_VR_QUICKLIST_H_


	)

14 
	squickli¡Node
 {

15 
quickli¡Node
 *
	m´ev
;

16 
quickli¡Node
 *
	mÃxt
;

17 *
	mzl
;

18 
	msz
;

19 
	mcouÁ
 : 16;

20 
	m’codšg
 : 2;

21 
	mcÚš”
 : 2;

22 
	m»com´ess
 : 1;

23 
	m©‹m±ed_com´ess
 : 1;

24 
	mexŒa
 : 10;

25 } 
	tquickli¡Node
;

32 
	squickli¡LZF
 {

33 
	msz
;

34 
	mcom´es£d
[];

35 } 
	tquickli¡LZF
;

43 
	squickli¡
 {

44 
quickli¡Node
 *
	mh—d
;

45 
quickli¡Node
 *
	m
;

46 
	mcouÁ
;

47 
	mËn
;

48 
	mfl
 : 16;

49 
	mcom´ess
 : 16;

50 } 
	tquickli¡
;

52 
	squickli¡I‹r
 {

53 cÚ¡ 
quickli¡
 *
	mquickli¡
;

54 
quickli¡Node
 *
	mcu¼’t
;

55 *
	mzi
;

56 
	moff£t
;

57 
	mdœeùiÚ
;

58 } 
	tquickli¡I‹r
;

60 
	squickli¡EÁry
 {

61 cÚ¡ 
quickli¡
 *
	mquickli¡
;

62 
quickli¡Node
 *
	mnode
;

63 *
	mzi
;

64 *
	mv®ue
;

65 
	msz
;

66 
	mlÚgv®
;

67 
	moff£t
;

68 } 
	tquickli¡EÁry
;

70 
	#QUICKLIST_HEAD
 0

	)

71 
	#QUICKLIST_TAIL
 -1

	)

74 
	#QUICKLIST_NODE_ENCODING_RAW
 1

	)

75 
	#QUICKLIST_NODE_ENCODING_LZF
 2

	)

78 
	#QUICKLIST_NOCOMPRESS
 0

	)

81 
	#QUICKLIST_NODE_CONTAINER_NONE
 1

	)

82 
	#QUICKLIST_NODE_CONTAINER_ZIPLIST
 2

	)

84 
	#quickli¡NodeIsCom´es£d
(
node
) \

85 ((
node
)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
)

	)

88 
quickli¡
 *
quickli¡C»©e
();

89 
quickli¡
 *
quickli¡New
(
fl
, 
com´ess
);

90 
quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
d•th
);

91 
quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
);

92 
quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
);

93 
quickli¡R–—£
(
quickli¡
 *quicklist);

94 
quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

95 
quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

96 
quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

97 
wh”e
);

98 
quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
);

99 
quickli¡
 *
quickli¡Aµ’dV®uesFromZli¡
(quicklist *quicklist,

100 *
zl
);

101 
quickli¡
 *
quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

102 *
zl
);

103 
quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

104 *
v®ue
, cÚ¡ 
size_t
 
sz
);

105 
quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

106 *
v®ue
, cÚ¡ 
size_t
 
sz
);

107 
quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
);

108 
quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

109 
sz
);

110 
quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
, cÚ¡ 
¡İ
);

111 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
);

112 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

113 
dœeùiÚ
, cÚ¡ 
idx
);

114 
quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
node
);

115 
quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
);

116 
quickli¡
 *
quickli¡Dup
(quickli¡ *
Üig
);

117 
quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
šdex
,

118 
quickli¡EÁry
 *
’Œy
);

119 
quickli¡Rewšd
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

120 
quickli¡RewšdTa
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

121 
quickli¡RÙ©e
(
quickli¡
 *quicklist);

122 
quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

123 *
sz
, *
sv®
,

124 *(*
§v”
)(*
d©a
, 
sz
));

125 
quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

126 *
sz
, *
¦Úg
);

127 
quickli¡CouÁ
(
quickli¡
 *
ql
);

128 
quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
);

129 
size_t
 
quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
);

132 
	#AL_START_HEAD
 0

	)

133 
	#AL_START_TAIL
 1

	)

	@src/vr_rbtree.c

1 
	~<vr_cÜe.h
>

4 
	$rbŒ“_node_š™
(
rbnode
 *
node
)

6 
node
->
Ëá
 = 
NULL
;

7 
node
->
right
 = 
NULL
;

8 
node
->
·»Á
 = 
NULL
;

9 
node
->
key
 = 0ULL;

10 
node
->
d©a
 = 
NULL
;

12 
	}
}

15 
	$rbŒ“_š™
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
)

17 
	`rbŒ“_node_š™
(
node
);

18 
	`rbŒ“_bÏck
(
node
);

19 
Œ“
->
roÙ
 = 
node
;

20 
Œ“
->
£Áš–
 = 
node
;

21 
	}
}

23 
rbnode
 *

24 
	$rbŒ“_node_mš
(
rbnode
 *
node
, rbnod*
£Áš–
)

28 
node
->
Ëá
 !ğ
£Áš–
) {

29 
node
 =‚ode->
Ëá
;

32  
node
;

33 
	}
}

35 
rbnode
 *

36 
	$rbŒ“_mš
(
rbŒ“
 *
Œ“
)

38 
rbnode
 *
node
 = 
Œ“
->
roÙ
;

39 
rbnode
 *
£Áš–
 = 
Œ“
->sentinel;

43 ià(
node
 =ğ
£Áš–
) {

44  
NULL
;

47  
	`rbŒ“_node_mš
(
node
, 
£Áš–
);

48 
	}
}

51 
	$rbŒ“_Ëá_rÙ©e
(
rbnode
 **
roÙ
, rbnod*
£Áš–
,

52 
rbnode
 *
node
)

54 
rbnode
 *
‹mp
;

56 
‹mp
 = 
node
->
right
;

57 
node
->
right
 = 
‹mp
->
Ëá
;

59 ià(
‹mp
->
Ëá
 !ğ
£Áš–
) {

60 
‹mp
->
Ëá
->
·»Á
 = 
node
;

63 
‹mp
->
·»Á
 = 
node
->parent;

65 ià(
node
 =ğ*
roÙ
) {

66 *
roÙ
 = 
‹mp
;

67 } ià(
node
 =ğnode->
·»Á
->
Ëá
) {

68 
node
->
·»Á
->
Ëá
 = 
‹mp
;

70 
node
->
·»Á
->
right
 = 
‹mp
;

73 
‹mp
->
Ëá
 = 
node
;

74 
node
->
·»Á
 = 
‹mp
;

75 
	}
}

78 
	$rbŒ“_right_rÙ©e
(
rbnode
 **
roÙ
, rbnod*
£Áš–
,

79 
rbnode
 *
node
)

81 
rbnode
 *
‹mp
;

83 
‹mp
 = 
node
->
Ëá
;

84 
node
->
Ëá
 = 
‹mp
->
right
;

86 ià(
‹mp
->
right
 !ğ
£Áš–
) {

87 
‹mp
->
right
->
·»Á
 = 
node
;

90 
‹mp
->
·»Á
 = 
node
->parent;

92 ià(
node
 =ğ*
roÙ
) {

93 *
roÙ
 = 
‹mp
;

94 } ià(
node
 =ğnode->
·»Á
->
right
) {

95 
node
->
·»Á
->
right
 = 
‹mp
;

97 
node
->
·»Á
->
Ëá
 = 
‹mp
;

100 
‹mp
->
right
 = 
node
;

101 
node
->
·»Á
 = 
‹mp
;

102 
	}
}

105 
	$rbŒ“_š£¹
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
)

107 
rbnode
 **
roÙ
 = &
Œ“
->root;

108 
rbnode
 *
£Áš–
 = 
Œ“
->sentinel;

109 
rbnode
 *
‹mp
, **
p
;

113 ià(*
roÙ
 =ğ
£Áš–
) {

114 
node
->
·»Á
 = 
NULL
;

115 
node
->
Ëá
 = 
£Áš–
;

116 
node
->
right
 = 
£Áš–
;

117 
	`rbŒ“_bÏck
(
node
);

118 *
roÙ
 = 
node
;

124 
‹mp
 = *
roÙ
;

127 
p
 = (
node
->
key
 < 
‹mp
->keyè? &‹mp->
Ëá
 : &‹mp->
right
;

128 ià(*
p
 =ğ
£Áš–
) {

131 
‹mp
 = *
p
;

134 *
p
 = 
node
;

135 
node
->
·»Á
 = 
‹mp
;

136 
node
->
Ëá
 = 
£Áš–
;

137 
node
->
right
 = 
£Áš–
;

138 
	`rbŒ“_»d
(
node
);

142 
node
 !ğ*
roÙ
 && 
	`rbŒ“_is_»d
Òode->
·»Á
)) {

144 ià(
node
->
·»Á
 =ğnode->·»Á->·»Á->
Ëá
) {

145 
‹mp
 = 
node
->
·»Á
->·»Á->
right
;

147 ià(
	`rbŒ“_is_»d
(
‹mp
)) {

148 
	`rbŒ“_bÏck
(
node
->
·»Á
);

149 
	`rbŒ“_bÏck
(
‹mp
);

150 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

151 
node
 =‚ode->
·»Á
->parent;

153 ià(
node
 =ğnode->
·»Á
->
right
) {

154 
node
 =‚ode->
·»Á
;

155 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
node
);

158 
	`rbŒ“_bÏck
(
node
->
·»Á
);

159 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

160 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
node
->
·»Á
->parent);

163 
‹mp
 = 
node
->
·»Á
->·»Á->
Ëá
;

165 ià(
	`rbŒ“_is_»d
(
‹mp
)) {

166 
	`rbŒ“_bÏck
(
node
->
·»Á
);

167 
	`rbŒ“_bÏck
(
‹mp
);

168 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

169 
node
 =‚ode->
·»Á
->parent;

171 ià(
node
 =ğnode->
·»Á
->
Ëá
) {

172 
node
 =‚ode->
·»Á
;

173 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
node
);

176 
	`rbŒ“_bÏck
(
node
->
·»Á
);

177 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

178 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
node
->
·»Á
->parent);

183 
	`rbŒ“_bÏck
(*
roÙ
);

184 
	}
}

187 
	$rbŒ“_d–‘e
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
)

189 
rbnode
 **
roÙ
 = &
Œ“
->root;

190 
rbnode
 *
£Áš–
 = 
Œ“
->sentinel;

191 
rbnode
 *
sub¡
, *
‹mp
, *
w
;

192 
ušt8_t
 
»d
;

196 ià(
node
->
Ëá
 =ğ
£Áš–
) {

197 
‹mp
 = 
node
->
right
;

198 
sub¡
 = 
node
;

199 } ià(
node
->
right
 =ğ
£Áš–
) {

200 
‹mp
 = 
node
->
Ëá
;

201 
sub¡
 = 
node
;

203 
sub¡
 = 
	`rbŒ“_node_mš
(
node
->
right
, 
£Áš–
);

204 
‹mp
 = 
sub¡
->
right
;

207 ià(
sub¡
 =ğ*
roÙ
) {

208 *
roÙ
 = 
‹mp
;

209 
	`rbŒ“_bÏck
(
‹mp
);

211 
	`rbŒ“_node_š™
(
node
);

216 
»d
 = 
	`rbŒ“_is_»d
(
sub¡
);

218 ià(
sub¡
 =ğsub¡->
·»Á
->
Ëá
) {

219 
sub¡
->
·»Á
->
Ëá
 = 
‹mp
;

221 
sub¡
->
·»Á
->
right
 = 
‹mp
;

224 ià(
sub¡
 =ğ
node
) {

225 
‹mp
->
·»Á
 = 
sub¡
->parent;

228 ià(
sub¡
->
·»Á
 =ğ
node
) {

229 
‹mp
->
·»Á
 = 
sub¡
;

231 
‹mp
->
·»Á
 = 
sub¡
->parent;

234 
sub¡
->
Ëá
 = 
node
->left;

235 
sub¡
->
right
 = 
node
->right;

236 
sub¡
->
·»Á
 = 
node
->parent;

237 
	`rbŒ“_cİy_cŞÜ
(
sub¡
, 
node
);

239 ià(
node
 =ğ*
roÙ
) {

240 *
roÙ
 = 
sub¡
;

242 ià(
node
 =ğnode->
·»Á
->
Ëá
) {

243 
node
->
·»Á
->
Ëá
 = 
sub¡
;

245 
node
->
·»Á
->
right
 = 
sub¡
;

249 ià(
sub¡
->
Ëá
 !ğ
£Áš–
) {

250 
sub¡
->
Ëá
->
·»Á
 = subst;

253 ià(
sub¡
->
right
 !ğ
£Áš–
) {

254 
sub¡
->
right
->
·»Á
 = subst;

258 
	`rbŒ“_node_š™
(
node
);

260 ià(
»d
) {

266 
‹mp
 !ğ*
roÙ
 && 
	`rbŒ“_is_bÏck
(temp)) {

268 ià(
‹mp
 =ğ‹mp->
·»Á
->
Ëá
) {

269 
w
 = 
‹mp
->
·»Á
->
right
;

271 ià(
	`rbŒ“_is_»d
(
w
)) {

272 
	`rbŒ“_bÏck
(
w
);

273 
	`rbŒ“_»d
(
‹mp
->
·»Á
);

274 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

275 
w
 = 
‹mp
->
·»Á
->
right
;

278 ià(
	`rbŒ“_is_bÏck
(
w
->
Ëá
è&&„bŒ“_is_bÏck(w->
right
)) {

279 
	`rbŒ“_»d
(
w
);

280 
‹mp
 =emp->
·»Á
;

282 ià(
	`rbŒ“_is_bÏck
(
w
->
right
)) {

283 
	`rbŒ“_bÏck
(
w
->
Ëá
);

284 
	`rbŒ“_»d
(
w
);

285 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
w
);

286 
w
 = 
‹mp
->
·»Á
->
right
;

289 
	`rbŒ“_cİy_cŞÜ
(
w
, 
‹mp
->
·»Á
);

290 
	`rbŒ“_bÏck
(
‹mp
->
·»Á
);

291 
	`rbŒ“_bÏck
(
w
->
right
);

292 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

293 
‹mp
 = *
roÙ
;

297 
w
 = 
‹mp
->
·»Á
->
Ëá
;

299 ià(
	`rbŒ“_is_»d
(
w
)) {

300 
	`rbŒ“_bÏck
(
w
);

301 
	`rbŒ“_»d
(
‹mp
->
·»Á
);

302 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

303 
w
 = 
‹mp
->
·»Á
->
Ëá
;

306 ià(
	`rbŒ“_is_bÏck
(
w
->
Ëá
è&&„bŒ“_is_bÏck(w->
right
)) {

307 
	`rbŒ“_»d
(
w
);

308 
‹mp
 =emp->
·»Á
;

310 ià(
	`rbŒ“_is_bÏck
(
w
->
Ëá
)) {

311 
	`rbŒ“_bÏck
(
w
->
right
);

312 
	`rbŒ“_»d
(
w
);

313 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
w
);

314 
w
 = 
‹mp
->
·»Á
->
Ëá
;

317 
	`rbŒ“_cİy_cŞÜ
(
w
, 
‹mp
->
·»Á
);

318 
	`rbŒ“_bÏck
(
‹mp
->
·»Á
);

319 
	`rbŒ“_bÏck
(
w
->
Ëá
);

320 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

321 
‹mp
 = *
roÙ
;

326 
	`rbŒ“_bÏck
(
‹mp
);

327 
	}
}

	@src/vr_rbtree.h

1 #iâdeà
_VR_RBTREE_


2 
	#_VR_RBTREE_


	)

4 
	#rbŒ“_»d
(
_node
è((_node)->
cŞÜ
 = 1)

	)

5 
	#rbŒ“_bÏck
(
_node
è((_node)->
cŞÜ
 = 0)

	)

6 
	#rbŒ“_is_»d
(
_node
è((_node)->
cŞÜ
)

	)

7 
	#rbŒ“_is_bÏck
(
_node
è(!
	`rbŒ“_is_»d
(_node))

	)

8 
	#rbŒ“_cİy_cŞÜ
(
_n1
, 
_n2
è((_n1)->
cŞÜ
 = (_n2)->cŞÜ)

	)

10 
	srbnode
 {

11 
rbnode
 *
	mËá
;

12 
rbnode
 *
	mright
;

13 
rbnode
 *
	m·»Á
;

14 
št64_t
 
	mkey
;

15 *
	md©a
;

16 
ušt8_t
 
	mcŞÜ
;

19 
	srbŒ“
 {

20 
rbnode
 *
	mroÙ
;

21 
rbnode
 *
	m£Áš–
;

24 
rbŒ“_node_š™
(
rbnode
 *
node
);

25 
rbŒ“_š™
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
);

26 
rbnode
 *
rbŒ“_mš
(
rbŒ“
 *
Œ“
);

27 
rbŒ“_š£¹
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
);

28 
rbŒ“_d–‘e
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
);

	@src/vr_rdb.c

1 
	~<vr_cÜe.h
>

4 
	$rdbSave
(*
f’ame
) {

5  
VR_OK
;

6 
	}
}

8 
	$rdbRemoveTempFe
(
pid_t
 
chdpid
) {

9 
tmpfe
[256];

11 
	`¢´štf
(
tmpfe
,Ñmpfe),"‹mp-%d.rdb", (è
chdpid
);

12 
	`uÆšk
(
tmpfe
);

13 
	}
}

	@src/vr_rdb.h

1 #iâdeà
_VR_RDB_H_


2 
	#_VR_RDB_H_


	)

17 
	#RDB_6BITLEN
 0

	)

18 
	#RDB_14BITLEN
 1

	)

19 
	#RDB_32BITLEN
 2

	)

20 
	#RDB_ENCVAL
 3

	)

21 
	#RDB_LENERR
 
UINT_MAX


	)

26 
	#RDB_ENC_INT8
 0

	)

27 
	#RDB_ENC_INT16
 1

	)

28 
	#RDB_ENC_INT32
 2

	)

29 
	#RDB_ENC_LZF
 3

	)

31 
	s§v•¬am
 {

32 
time_t
 
	m£cÚds
;

33 
	mchªges
;

36 
rdbSave
(*
f’ame
);

37 
rdbRemoveTempFe
(
pid_t
 
chdpid
);

	@src/vr_replication.c

1 
	~<vr_cÜe.h
>

3 
vr_»¶iÿtiÚ
 
	g»¶
;

5 
	$vr_»¶iÿtiÚ_š™
()

7 
	`vr_ev’oİ_š™
(&
»¶
.
v–
,1000);

9 
»¶
.
rŞe
 = 
REPLICATION_ROLE_MASTER
;

10 
»¶
.
ma¡”
 = 
NULL
;

11 
»¶
.
ÿched_ma¡”
 = 
NULL
;

12 
»¶
.
¦aves
 = 
NULL
;

13 
»¶
.
»¶_no_¦aves_sšû
 = 0;

14 
»¶
.
»¶_mš_¦aves_to_wr™e
 = 0;

15 
»¶
.
»¶_mš_¦aves_max_Ïg
 = 0;

16 
»¶
.
»¶_good_¦aves_couÁ
 = 0;

17 
»¶
.
»¶_¡©e
 = 
REPL_STATE_NONE
;

18 
»¶
.
»¶_down_sšû
 = 0;

21 
»¶
.
»¶_backlog
 = 
NULL
;

22 
»¶
.
»¶_backlog_size
 = 
CONFIG_DEFAULT_REPL_BACKLOG_SIZE
;

23 
»¶
.
»¶_backlog_hi¡Ën
 = 0;

24 
»¶
.
»¶_backlog_idx
 = 0;

25 
»¶
.
»¶_backlog_off
 = 0;

26 
»¶
.
»¶_backlog_time_lim™
 = 
CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
;

27 
»¶
.
»¶_no_¦aves_sšû
 = 
	`time
(
NULL
);

29 
»¶
.
¦aves
 = 
	`dli¡C»©e
();

31  
VR_OK
;

32 
	}
}

34 
	$vr_»¶iÿtiÚ_deš™
()

36 
	`vr_ev’oİ_deš™
(&
»¶
.
v–
);

38 ià(
»¶
.
ma¡”
 !ğ
NULL
) {

39 
	`ä“Cl›Á
(
»¶
.
ma¡”
);

40 
»¶
.
ma¡”
 = 
NULL
;

43 ià(
»¶
.
ÿched_ma¡”
 !ğ
NULL
) {

44 
	`ä“Cl›Á
(
»¶
.
ÿched_ma¡”
);

45 
»¶
.
ÿched_ma¡”
 = 
NULL
;

48 ià(
»¶
.
»¶_backlog
 !ğ
NULL
) {

49 
	`dä“
(
»¶
.
»¶_backlog
);

50 
»¶
.
»¶_backlog
 = 
NULL
;

53 ià(
»¶
.
¦aves
 !ğ
NULL
) {

54 
ş›Á
 *
¦ave
;

55 
¦ave
 = 
	`dli¡Pİ
(
»¶
.
¦aves
)) {

56 
	`ä“Cl›Á
(
¦ave
);

58 
	`dli¡R–—£
(
»¶
.
¦aves
);

59 
»¶
.
¦aves
 = 
NULL
;

61 
	}
}

67 
	$unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
) {

68 
dli¡Node
 *
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás_wa™šg_acks
,c);

69 
	`ASSERT
(
Ê
 !ğ
NULL
);

70 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás_wa™šg_acks
,
Ê
);

71 
	}
}

78 
	$»äeshGoodSÏvesCouÁ
() {

79 
dli¡I‹r
 
li
;

80 
dli¡Node
 *
Ê
;

81 
good
 = 0;

83 ià(!
»¶
.
»¶_mš_¦aves_to_wr™e
 ||

84 !
»¶
.
»¶_mš_¦aves_max_Ïg
) ;

86 
	`dli¡Rewšd
(
»¶
.
¦aves
,&
li
);

87 (
Ê
 = 
	`dli¡Next
(&
li
))) {

88 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

89 
time_t
 
Ïg
 = 
»¶
.
v–
.
unixtime
 - 
¦ave
->
»¶_ack_time
;

91 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

92 
Ïg
 <ğ
»¶
.
»¶_mš_¦aves_max_Ïg
è
good
++;

94 
»¶
.
»¶_good_¦aves_couÁ
 = 
good
;

95 
	}
}

99 
	$»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
() {

100 
»¶
.
ma¡”
 = 
NULL
;

101 
»¶
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

102 
»¶
.
»¶_down_sšû
 =„•l.
v–
.
unixtime
;

106 
	}
}

129 
	$»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
) {

130 
	`ASSERT
(
»¶
.
ma¡”
 !ğ
NULL
 &&„•l.
ÿched_ma¡”
 == NULL);

131 
	`log_debug
(
LOG_NOTICE
,"Cachinghe disconnected master state.");

134 
	`uÆškCl›Á
(
c
);

138 
»¶
.
ÿched_ma¡”
 =„•l.
ma¡”
;

141 ià(
c
->
³”id
) {

142 
	`sdsä“
(
c
->
³”id
);

143 
c
->
³”id
 = 
NULL
;

149 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

150 
	}
}

156 *
	$»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
) {

157 
buf
[
VR_INET_PEER_ID_LEN
];

158 

[
VR_INET_ADDRSTRLEN
];

160 

[0] = '\0';

161 
buf
[0] = '\0';

163  
buf
;

164 
	}
}

178 
	$»¶cÚfCommªd
(
ş›Á
 *
c
) {

179 
j
;

181 ià((
c
->
¬gc
 % 2) == 0) {

184 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

189 
j
 = 1; j < 
c
->
¬gc
; j+=2) {

190 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"listening-port")) {

191 
pÜt
;

193 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+1],

194 &
pÜt
,
NULL
è!ğ
VR_OK
))

196 
c
->
¦ave_li¡’šg_pÜt
 = 
pÜt
;

197 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"capa")) {

199 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
+1]->
±r
,"eof"))

200 
c
->
¦ave_ÿ·
 |ğ
SLAVE_CAPA_EOF
;

201 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"ack")) {

205 
off£t
;

207 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
)) ;

208 ià((
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[
j
+1], &
off£t
è!ğ
VR_OK
))

210 ià(
off£t
 > 
c
->
»¶_ack_off
)

211 
c
->
»¶_ack_off
 = 
off£t
;

212 
c
->
»¶_ack_time
 = c->
v–
->
unixtime
;

216 ià(
c
->
»¶_put_Úlše_Ú_ack
 && c->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
)

217 
	`putSÏveOÆše
(
c
);

220 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"getack")) {

223 ià(
»¶
.
ma¡”ho¡
 &&„•l.
ma¡”
è
	`»¶iÿtiÚS’dAck
();

226 
	`addR•lyE¼ÜFÜm©
(
c
,"Unrecognized REPLCONF option: %s",

227 (*)
c
->
¬gv
[
j
]->
±r
);

231 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

232 
	}
}

246 
	$putSÏveOÆše
(
ş›Á
 *
¦ave
) {

247 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

248 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 0;

249 
¦ave
->
»¶_ack_time
 = sÏve->
v–
->
unixtime
;

250 ià(
	`«C»©eFeEv’t
(
¦ave
->
v–
->
–
, sÏve->
cÚn
->
sd
, 
AE_WRITABLE
,

251 
£ndR•lyToCl›Á
, 
¦ave
è=ğ
AE_ERR
) {

252 
	`log_w¬n
("uÇbËØ»gi¡” wr™abËƒv’ˆfÜ sÏvbulk¿nsãr: %s", 
	`¡»¼Ü
(
”ºo
));

253 
	`ä“Cl›Á
(
¦ave
);

256 
	`»äeshGoodSÏvesCouÁ
();

257 
	`log_debug
(
LOG_NOTICE
,"Synchronization with slave %s succeeded",

258 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

259 
	}
}

264 
	$»¶iÿtiÚS’dAck
() {

265 
ş›Á
 *
c
 = 
»¶
.
ma¡”
;

267 ià(
c
 !ğ
NULL
) {

268 
c
->
æags
 |ğ
CLIENT_MASTER_FORCE_REPLY
;

269 
	`addR•lyMuÉiBulkL’
(
c
,3);

270 
	`addR•lyBulkCSŒšg
(
c
,"REPLCONF");

271 
	`addR•lyBulkCSŒšg
(
c
,"ACK");

272 
	`addR•lyBulkLÚgLÚg
(
c
,c->
»¶off
);

273 
c
->
æags
 &ğ~
CLIENT_MASTER_FORCE_REPLY
;

275 
	}
}

277 
	$»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
dli¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

278 
dli¡Node
 *
Ê
;

279 
dli¡I‹r
 
li
;

280 
j
;

281 
sds
 
cmd»´
 = 
	`sd¢ew
("+");

282 
robj
 *
cmdobj
;

283 
timev®
 
tv
;

285 
	`g‘timeofday
(&
tv
,
NULL
);

286 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"%ld.%06ld ",()
tv
.
tv_£c
,(év.
tv_u£c
);

287 ià(
c
->
æags
 & 
CLIENT_LUA
) {

288 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d†ua] ",
diùid
);

289 } ià(
c
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

290 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d unix:%s] ",
diùid
,
£rv”
.
unixsock‘
);

292 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d %s] ",
diùid
,
	`g‘Cl›ÁP“rId
(
c
));

295 
j
 = 0; j < 
¬gc
; j++) {

296 ià(
¬gv
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

297 
cmd»´
 = 
	`sdsÿrštf
(cmd»´, "\"%ld\"", ()
¬gv
[
j
]->
±r
);

299 
cmd»´
 = 
	`sdsÿŒ•r
(cmd»´,(*)
¬gv
[
j
]->
±r
,

300 
	`sd¦’
(
¬gv
[
j
]->
±r
));

302 ià(
j
 !ğ
¬gc
-1)

303 
cmd»´
 = 
	`sdsÿ’
(cmdrepr," ",1);

305 
cmd»´
 = 
	`sdsÿ’
(cmdrepr,"\r\n",2);

306 
cmdobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
cmd»´
);

308 
	`dli¡Rewšd
(
mÚ™Üs
,&
li
);

309 (
Ê
 = 
	`dli¡Next
(&
li
))) {

310 
ş›Á
 *
mÚ™Ü
 = 
Ê
->
v®ue
;

311 
	`addR•ly
(
mÚ™Ü
,
cmdobj
);

313 
	`deüRefCouÁ
(
cmdobj
);

314 
	}
}

320 
	$ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
) {

321 *
p
 = 
±r
;

323 
»¶
.
ma¡”_»¶_off£t
 +ğ
Ën
;

327 
Ën
) {

328 
size_t
 
thi¦’
 = 
»¶
.
»¶_backlog_size
 -„•l.
»¶_backlog_idx
;

329 ià(
thi¦’
 > 
Ën
)hislen =†en;

330 
	`memıy
(
»¶
.
»¶_backlog
+»¶.
»¶_backlog_idx
,
p
,
thi¦’
);

331 
»¶
.
»¶_backlog_idx
 +ğ
thi¦’
;

332 ià(
»¶
.
»¶_backlog_idx
 =ğ»¶.
»¶_backlog_size
)

333 
»¶
.
»¶_backlog_idx
 = 0;

334 
Ën
 -ğ
thi¦’
;

335 
p
 +ğ
thi¦’
;

336 
»¶
.
»¶_backlog_hi¡Ën
 +ğ
thi¦’
;

338 ià(
»¶
.
»¶_backlog_hi¡Ën
 >„•l.
»¶_backlog_size
)

339 
»¶
.
»¶_backlog_hi¡Ën
 =„•l.
»¶_backlog_size
;

341 
»¶
.
»¶_backlog_off
 =„•l.
ma¡”_»¶_off£t
 -

342 
»¶
.
»¶_backlog_hi¡Ën
 + 1;

343 
	}
}

347 
	$ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
) {

348 
Î¡r
[
LONG_STR_SIZE
];

349 *
p
;

350 
size_t
 
Ën
;

352 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

353 
Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),()
o
->
±r
);

354 
p
 = 
Î¡r
;

356 
Ën
 = 
	`sd¦’
(
o
->
±r
);

357 
p
 = 
o
->
±r
;

359 
	`ãedR•liÿtiÚBacklog
(
p
,
Ën
);

360 
	}
}

362 
	$»¶iÿtiÚF“dSÏves
(
dli¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

363 
dli¡Node
 *
Ê
;

364 
dli¡I‹r
 
li
;

365 
j
, 
Ën
;

366 
Î¡r
[
LONG_STR_SIZE
];

370 ià(
»¶
.
»¶_backlog
 =ğ
NULL
 && 
	`dli¡L’gth
(
¦aves
) == 0) ;

373 
	`ASSERT
(!(
	`dli¡L’gth
(
¦aves
è!ğ0 && 
»¶
.
»¶_backlog
 =ğ
NULL
));

376 ià(
»¶
.
¦ave£ldb
 !ğ
diùid
) {

377 
robj
 *
£Ëùcmd
;

380 ià(
diùid
 >ğ0 && diùid < 
PROTO_SHARED_SELECT_CMDS
) {

381 
£Ëùcmd
 = 
sh¬ed
.
£Ëù
[
diùid
];

383 
diùid_Ën
;

385 
diùid_Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),
diùid
);

386 
£Ëùcmd
 = 
	`ü—‹Objeù
(
OBJ_STRING
,

387 
	`sdsÿrštf
(
	`sd£m±y
(),

389 
diùid_Ën
, 
Î¡r
));

393 ià(
»¶
.
»¶_backlog
è
	`ãedR•liÿtiÚBacklogW™hObjeù
(
£Ëùcmd
);

396 
	`dli¡Rewšd
(
¦aves
,&
li
);

397 (
Ê
 = 
	`dli¡Next
(&
li
))) {

398 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

399 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

400 
	`addR•ly
(
¦ave
,
£Ëùcmd
);

403 ià(
diùid
 < 0 || diùid >ğ
PROTO_SHARED_SELECT_CMDS
)

404 
	`deüRefCouÁ
(
£Ëùcmd
);

406 
»¶
.
¦ave£ldb
 = 
diùid
;

409 ià(
»¶
.
»¶_backlog
) {

410 
aux
[
LONG_STR_SIZE
+3];

413 
aux
[0] = '*';

414 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
¬gc
);

415 
aux
[
Ën
+1] = '\r';

416 
aux
[
Ën
+2] = '\n';

417 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

419 
j
 = 0; j < 
¬gc
; j++) {

420 
objËn
 = 
	`¡ršgObjeùL’
(
¬gv
[
j
]);

425 
aux
[0] = '$';

426 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
objËn
);

427 
aux
[
Ën
+1] = '\r';

428 
aux
[
Ën
+2] = '\n';

429 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

430 
	`ãedR•liÿtiÚBacklogW™hObjeù
(
¬gv
[
j
]);

431 
	`ãedR•liÿtiÚBacklog
(
aux
+
Ën
+1,2);

436 
	`dli¡Rewšd
(
»¶
.
¦aves
,&
li
);

437 (
Ê
 = 
	`dli¡Next
(&
li
))) {

438 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

441 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

448 
	`addR•lyMuÉiBulkL’
(
¦ave
,
¬gc
);

452 
j
 = 0; j < 
¬gc
; j++)

453 
	`addR•lyBulk
(
¦ave
,
¬gv
[
j
]);

455 
	}
}

	@src/vr_replication.h

1 #iâdeà
_VR_REPLICATION_H_


2 
	#_VR_REPLICATION_H_


	)

6 
	#REPL_STATE_NONE
 0

	)

7 
	#REPL_STATE_CONNECT
 1

	)

8 
	#REPL_STATE_CONNECTING
 2

	)

10 
	#REPL_STATE_RECEIVE_PONG
 3

	)

11 
	#REPL_STATE_SEND_AUTH
 4

	)

12 
	#REPL_STATE_RECEIVE_AUTH
 5

	)

13 
	#REPL_STATE_SEND_PORT
 6

	)

14 
	#REPL_STATE_RECEIVE_PORT
 7

	)

15 
	#REPL_STATE_SEND_CAPA
 8

	)

16 
	#REPL_STATE_RECEIVE_CAPA
 9

	)

17 
	#REPL_STATE_SEND_PSYNC
 10

	)

18 
	#REPL_STATE_RECEIVE_PSYNC
 11

	)

20 
	#REPL_STATE_TRANSFER
 12

	)

21 
	#REPL_STATE_CONNECTED
 13

	)

27 
	#SLAVE_STATE_WAIT_BGSAVE_START
 6

	)

28 
	#SLAVE_STATE_WAIT_BGSAVE_END
 7

	)

29 
	#SLAVE_STATE_SEND_BULK
 8

	)

30 
	#SLAVE_STATE_ONLINE
 9

	)

33 
	#SLAVE_CAPA_NONE
 0

	)

34 
	#SLAVE_CAPA_EOF
 (1<<0è

	)

37 
	#CONFIG_REPL_SYNCIO_TIMEOUT
 5

	)

39 
	#REPLICATION_ROLE_MASTER
 0

	)

40 
	#REPLICATION_ROLE_SLAVE
 1

	)

42 
	#CONFIG_DEFAULT_REPL_BACKLOG_SIZE
 (1024*1024è

	)

43 
	#CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
 (60*60è

	)

44 
	#CONFIG_REPL_BACKLOG_MIN_SIZE
 (1024*16è

	)

46 
	svr_»¶iÿtiÚ
 {

47 
vr_ev’oİ
 
	mv–
;

49 
	mrŞe
;

52 
dli¡
 *
	m¦aves
;

53 
	m¦ave£ldb
;

54 
	mma¡”_»¶_off£t
;

55 
	m»¶_pšg_¦ave_³riod
;

56 *
	m»¶_backlog
;

57 
	m»¶_backlog_size
;

58 
	m»¶_backlog_hi¡Ën
;

59 
	m»¶_backlog_idx
;

60 
	m»¶_backlog_off
;

62 
time_t
 
	m»¶_backlog_time_lim™
;

64 
time_t
 
	m»¶_no_¦aves_sšû
;

66 
	m»¶_mš_¦aves_to_wr™e
;

67 
	m»¶_mš_¦aves_max_Ïg
;

68 
	m»¶_good_¦aves_couÁ
;

69 
	m»¶_diskËss_sync
;

70 
	m»¶_diskËss_sync_d–ay
;

73 *
	mma¡”auth
;

74 *
	mma¡”ho¡
;

75 
	mma¡”pÜt
;

76 
	m»¶_timeout
;

77 
ş›Á
 *
	mma¡”
;

78 
ş›Á
 *
	mÿched_ma¡”
;

79 
	m»¶_syncio_timeout
;

80 
	m»¶_¡©e
;

81 
off_t
 
	m»¶_Œªsãr_size
;

82 
off_t
 
	m»¶_Œªsãr_»ad
;

83 
off_t
 
	m»¶_Œªsãr_Ï¡_fsync_off
;

84 
	m»¶_Œªsãr_s
;

85 
	m»¶_Œªsãr_fd
;

86 *
	m»¶_Œªsãr_tmpfe
;

87 
time_t
 
	m»¶_Œªsãr_Ï¡io
;

88 
	m»¶_£rve_¡®e_d©a
;

89 
	m»¶_¦ave_ro
;

90 
time_t
 
	m»¶_down_sšû
;

91 
	m»¶_di§bË_tı_nod–ay
;

92 
	m¦ave_´iÜ™y
;

93 
	m»¶_ma¡”_runid
[
CONFIG_RUN_ID_SIZE
+1];

94 
	m»¶_ma¡”_š™Ÿl_off£t
;

97 
vr_»¶iÿtiÚ
 
»¶
;

99 
vr_»¶iÿtiÚ_š™
();

100 
vr_»¶iÿtiÚ_deš™
();

102 
unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
);

103 
»äeshGoodSÏvesCouÁ
();

104 
»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

105 
»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
);

106 *
»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
);

107 
»¶cÚfCommªd
(
ş›Á
 *
c
);

108 
putSÏveOÆše
(
ş›Á
 *
¦ave
);

109 
»¶iÿtiÚS’dAck
();

110 
»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
dli¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

111 
»¶iÿtiÚF“dSÏves
(
dli¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

112 
ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
);

113 
ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
);

	@src/vr_scripting.c

1 
	~<vr_cÜe.h
>

3 
	$sütCommªd
(
ş›Á
 *
c
) {

4 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5 
	}
}

	@src/vr_scripting.h

1 #iâdeà
_VR_SCRIPTING_H_


2 
	#_VR_SCRIPTING_H_


	)

4 
sütCommªd
(
ş›Á
 *
c
);

	@src/vr_server.c

1 
	~<sys/ut¢ame.h
>

3 
	~<vr_cÜe.h
>

6 
vr_£rv”
 
	g£rv”
;

9 
sh¬edObjeùsSŒuù
 
	gsh¬ed
;

12 
	$diùSŒHash
(cÚ¡ *
key
) {

13  
	`diùG’HashFunùiÚ
((*)
key
, 
	`¡¾’
((*)key));

14 
	}
}

17 
	$diùSŒCa£Hash
(cÚ¡ *
key
) {

18  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`¡¾’
((*)key));

19 
	}
}

22 
	$diùSdsHash
(cÚ¡ *
key
) {

23  
	`diùG’HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

24 
	}
}

27 
	$diùSdsCa£Hash
(cÚ¡ *
key
) {

28  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

29 
	}
}

32 
	$diùSŒKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

33 cÚ¡ *
key2
)

35 
l1
,
l2
;

36 
	`DICT_NOTUSED
(
´ivd©a
);

38 
l1
 = 
	`¡¾’
((*)
key1
);

39 
l2
 = 
	`¡¾’
((*)
key2
);

40 ià(
l1
 !ğ
l2
)  0;

41  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

42 
	}
}

47 
	$diùSŒKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

48 cÚ¡ *
key2
)

50 
	`DICT_NOTUSED
(
´ivd©a
);

52  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

53 
	}
}

56 
	$diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

57 cÚ¡ *
key2
)

59 
l1
,
l2
;

60 
	`DICT_NOTUSED
(
´ivd©a
);

62 
l1
 = 
	`sd¦’
((
sds
)
key1
);

63 
l2
 = 
	`sd¦’
((
sds
)
key2
);

64 ià(
l1
 !ğ
l2
)  0;

65  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

66 
	}
}

71 
	$diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

72 cÚ¡ *
key2
)

74 
	`DICT_NOTUSED
(
´ivd©a
);

76  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

77 
	}
}

80 
	$diùSdsKeyDupFromSŒ
(*
´ivd©a
, cÚ¡ *
key
)

82 
	`DICT_NOTUSED
(
´ivd©a
);

84  
	`sd¢ew
(
key
);

85 
	}
}

88 
	$diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
)

90 
	`DICT_NOTUSED
(
´ivd©a
);

92 
	`sdsä“
(
v®
);

93 
	}
}

96 
	$diùObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

98 
	`DICT_NOTUSED
(
´ivd©a
);

100 ià(
v®
 =ğ
NULL
) ;

101 
	`ä“Objeù
(
v®
);

102 
	}
}

105 
	$diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

106 cÚ¡ *
key2
)

108 
robj
 *
o1
 = (robj*è
key1
, *
o2
 = (robj*è
key2
;

109 
robj
 *
o1_Ãw
, *
o2_Ãw
;

110 
cmp
;

112 ià(
o1
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

113 
o2
->
’codšg
 =ğ
OBJ_ENCODING_INT
)

114  
o1
->
±r
 =ğ
o2
->ptr;

116 
o1_Ãw
 = 
	`g‘DecodedObjeù
(
o1
);

117 
o2_Ãw
 = 
	`g‘DecodedObjeù
(
o2
);

118 
cmp
 = 
	`diùSdsKeyCom·»
(
´ivd©a
,
o1_Ãw
->
±r
,
o2_Ãw
->ptr);

119 ià(
o1_Ãw
 !ğ
o1
è
	`ä“Objeù
(o1_new);

120 ià(
o2_Ãw
 !ğ
o2
è
	`ä“Objeù
(o2_new);

121  
cmp
;

122 
	}
}

125 
	$diùEncObjHash
(cÚ¡ *
key
) {

126 
robj
 *
o
 = (robj*è
key
;

128 ià(
	`sdsEncodedObjeù
(
o
)) {

129  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

131 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

132 
buf
[32];

133 
Ën
;

135 
Ën
 = 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

136  
	`diùG’HashFunùiÚ
((*)
buf
, 
Ën
);

138 
hash
;

139 
robj
 *
o_Ãw
;

141 
o_Ãw
 = 
	`g‘DecodedObjeù
(
o
);

142 
hash
 = 
	`diùG’HashFunùiÚ
(
o_Ãw
->
±r
, 
	`sd¦’
((
sds
)o_new->ptr));

143 ià(
o_Ãw
!ğ
o
è
	`ä“Objeù
(o_new);

144  
hash
;

147 
	}
}

150 
	$diùObjHash
(cÚ¡ *
key
) {

151 cÚ¡ 
robj
 *
o
 = 
key
;

152  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

153 
	}
}

156 
	$diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

157 cÚ¡ *
key2
)

159 cÚ¡ 
robj
 *
o1
 = 
key1
, *
o2
 = 
key2
;

160  
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

161 
	}
}

164 
	$diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
)

166 
	`DICT_NOTUSED
(
´ivd©a
);

167 
	`dli¡R–—£
((
dli¡
*)
v®
);

168 
	}
}

171 
diùTy³
 
	ghashDiùTy³
 = {

172 
diùEncObjHash
,

173 
NULL
,

174 
NULL
,

175 
diùEncObjKeyCom·»
,

176 
diùObjeùDe¡ruùÜ
,

177 
diùObjeùDe¡ruùÜ


181 
diùTy³
 
	g£tDiùTy³
 = {

182 
diùEncObjHash
,

183 
NULL
,

184 
NULL
,

185 
diùEncObjKeyCom·»
,

186 
diùObjeùDe¡ruùÜ
,

187 
NULL


191 
diùTy³
 
	gz£tDiùTy³
 = {

192 
diùEncObjHash
,

193 
NULL
,

194 
NULL
,

195 
diùEncObjKeyCom·»
,

196 
diùObjeùDe¡ruùÜ
,

197 
NULL


202 
	$ü—‹Sh¬edObjeùs
() {

203 
j
;

204 
robj
 **
obj
;

206 
sh¬ed
.
ülf
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("\r\n"));

207 
sh¬ed
.
ok
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+OK\r\n"));

208 
sh¬ed
.
”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("-ERR\r\n"));

209 
sh¬ed
.
em±ybulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$0\r\n\r\n"));

210 
sh¬ed
.
cz”o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":0\r\n"));

211 
sh¬ed
.
cÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":1\r\n"));

212 
sh¬ed
.
úegÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":-1\r\n"));

213 
sh¬ed
.
nuÎbulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$-1\r\n"));

214 
sh¬ed
.
nuÎmuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*-1\r\n"));

215 
sh¬ed
.
em±ymuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*0\r\n"));

216 
sh¬ed
.
pÚg
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+PONG\r\n"));

217 
sh¬ed
.
queued
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+QUEUED\r\n"));

218 
sh¬ed
.
em±ysÿn
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*2\r\n$1\r\n0\r\n*0\r\n"));

219 
sh¬ed
.
wrÚgty³”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

221 
sh¬ed
.
nokey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

223 
sh¬ed
.
syÁax”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

225 
sh¬ed
.
§meobjeù”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

227 
sh¬ed
.
outoäªg“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

229 
sh¬ed
.
nosü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

231 
sh¬ed
.
lßdšg”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

233 
sh¬ed
.
¦owsü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

235 
sh¬ed
.
ma¡”dowÃ¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

237 
sh¬ed
.
bg§v“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

239 
sh¬ed
.
ro¦av“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

241 
sh¬ed
.
nßuth”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

243 
sh¬ed
.
nßdmš”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

245 
sh¬ed
.
oom”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

247 
sh¬ed
.
exeÿbÜ‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

249 
sh¬ed
.
nÜ•liÿ£¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

251 
sh¬ed
.
busykey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

253 
sh¬ed
.
¥aû
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(" "));

254 
sh¬ed
.
cŞÚ
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":"));

255 
sh¬ed
.
¶us
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+"));

257 
j
 = 0; j < 
PROTO_SHARED_SELECT_CMDS
; j++) {

258 
diùid_¡r
[64];

259 
diùid_Ën
;

261 
diùid_Ën
 = 
	`Î2¡ršg
(
diùid_¡r
,(diùid_¡r),
j
);

262 
sh¬ed
.
£Ëù
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

263 
	`sdsÿrštf
(
	`sd£m±y
(),

265 
diùid_Ën
, 
diùid_¡r
));

267 
sh¬ed
.
mes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$7\r\nmessage\r\n",13);

268 
sh¬ed
.
pmes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$8\r\npmessage\r\n",14);

269 
sh¬ed
.
subsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$9\r\nsubscribe\r\n",15);

270 
sh¬ed
.
unsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$11\r\nunsubscribe\r\n",18);

271 
sh¬ed
.
psubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$10\r\npsubscribe\r\n",17);

272 
sh¬ed
.
punsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$12\r\npunsubscribe\r\n",19);

273 
sh¬ed
.
d–
 = 
	`ü—‹SŒšgObjeù
("DEL",3);

274 
sh¬ed
.
½İ
 = 
	`ü—‹SŒšgObjeù
("RPOP",4);

275 
sh¬ed
.
Íİ
 = 
	`ü—‹SŒšgObjeù
("LPOP",4);

276 
sh¬ed
.
Íush
 = 
	`ü—‹SŒšgObjeù
("LPUSH",5);

277 
j
 = 0; j < 
OBJ_SHARED_INTEGERS
; j++) {

278 
sh¬ed
.
š‹g”s
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,(*)()j);

279 
sh¬ed
.
š‹g”s
[
j
]->
’codšg
 = 
OBJ_ENCODING_INT
;

281 
j
 = 0; j < 
OBJ_SHARED_BULKHDR_LEN
; j++) {

282 
sh¬ed
.
mbulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

283 
	`sdsÿrštf
(
	`sd£m±y
(),"*%d\r\n",
j
));

284 
sh¬ed
.
bulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

285 
	`sdsÿrštf
(
	`sd£m±y
(),"$%d\r\n",
j
));

291 
sh¬ed
.
mš¡ršg
 = 
	`ü—‹SŒšgObjeù
("minstring",9);

292 
sh¬ed
.
max¡ršg
 = 
	`ü—‹SŒšgObjeù
("maxstring",9);

294 
sh¬ed
.
outofcom¶ex™ylim™
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

298 
obj
 = &
sh¬ed
; *obj !ğ
NULL
; obj ++) {

299 (*
obj
)->
cÚ¡ªt
 = 1;

301 
	}
}

304 
	$š™_£rv”
(
š¡ªû
 *
nci
)

306 
»t
;

307 
ušt32_t
 
i
;

308 
»disDb
 *
db
;

310 
£rv”
.
pid
 = 
	`g‘pid
();

311 
£rv”
.
¬ch_b™s
 = (() == 8) ? 64 : 32;

312 
£rv”
.
¡¬‰ime
 = 
	`time
(
NULL
);

313 
	`g‘_¿ndom_hex_ch¬s
(
£rv”
.
runid
, 
CONFIG_RUN_ID_SIZE
);

315 
£rv”
.
commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

316 
	`pİuÏ‹CommªdTabË
();

317 
£rv”
.
d–Commªd
 = 
	`lookupCommªdByCSŒšg
("del");

318 
£rv”
.
muÉiCommªd
 = 
	`lookupCommªdByCSŒšg
("multi");

319 
£rv”
.
ÍushCommªd
 = 
	`lookupCommªdByCSŒšg
("lpush");

320 
£rv”
.
ÍİCommªd
 = 
	`lookupCommªdByCSŒšg
("lpop");

321 
£rv”
.
½İCommªd
 = 
	`lookupCommªdByCSŒšg
("rpop");

322 
£rv”
.
¤emCommªd
 = 
	`lookupCommªdByCSŒšg
("srem");

323 
£rv”
.
execCommªd
 = 
	`lookupCommªdByCSŒšg
("exec");

325 
cÚf
 = 
	`cÚf_ü—‹
(
nci
->
cÚf_f’ame
);

327 
»t
 = 
	`pİuÏ‹CommªdsN“dAdmš·ss
();

328 ià(
»t
 !ğ
VR_OK
) {

329 
	`log_”rÜ
("Populate‚eed‡dminpass commands failed");

330  
VR_ERROR
;

333 
£rv”
.
cÚfigfe
 = 
	`g‘AbsŞu‹P©h
(
nci
->
cÚf_f’ame
);

334 
£rv”
.
hz
 = 10;

335 
£rv”
.
dbÊum
 = 
c£rv”
->
d©aba£s
;

336 
£rv”
.
dbšum
 = 
c£rv”
->
š‹º®_dbs_³r_d©aba£s
;

337 
£rv”
.
dbnum
 = s”v”.
dbÊum
*£rv”.
dbšum
;

338 
	`d¬¿y_š™
(&
£rv”
.
dbs
, s”v”.
dbnum
, (
»disDb
));

339 
£rv”
.
pidfe
 = 
nci
->
pid_f’ame
;

340 
£rv”
.
execubË
 = 
NULL
;

341 
£rv”
.
aùiv”ehashšg
 = 
CONFIG_DEFAULT_ACTIVE_REHASHING
;

343 
£rv”
.
ş›Á_max_qu”ybuf_Ën
 = 
PROTO_MAX_QUERYBUF_LEN
;

345 
i
 = 0; i < 
£rv”
.
dbnum
; i ++) {

346 
db
 = 
	`d¬¿y_push
(&
£rv”
.
dbs
);

347 
	`»disDbIn™
(
db
);

350 
£rv”
.
ş›Ás
 = 
	`dli¡C»©e
();

352 
£rv”
.
mÚ™Üs
 = 
	`dli¡C»©e
();

354 
£rv”
.
lßdšg
 = 0;

356 
£rv”
.
lua_timedout
 = 0;

358 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

360 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 0;

362 
£rv”
.
»ady_keys
 = 
	`dli¡C»©e
();

364 
£rv”
.
sy¡em_memÜy_size
 = 
	`d®loc_g‘_memÜy_size
();

366 
£rv”
.
rdb_chd_pid
 = -1;

367 
£rv”
.
aof_chd_pid
 = -1;

369 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
OBJ_HASH_MAX_ZIPLIST_ENTRIES
;

370 
£rv”
.
hash_max_zli¡_v®ue
 = 
OBJ_HASH_MAX_ZIPLIST_VALUE
;

371 
£rv”
.
li¡_max_zli¡_size
 = 
OBJ_LIST_MAX_ZIPLIST_SIZE
;

372 
£rv”
.
li¡_com´ess_d•th
 = 
OBJ_LIST_COMPRESS_DEPTH
;

373 
£rv”
.
£t_max_št£t_’Œ›s
 = 
OBJ_SET_MAX_INTSET_ENTRIES
;

374 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
OBJ_ZSET_MAX_ZIPLIST_ENTRIES
;

375 
£rv”
.
z£t_max_zli¡_v®ue
 = 
OBJ_ZSET_MAX_ZIPLIST_VALUE
;

376 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
;

378 
£rv”
.
nÙify_key¥aû_ev’ts
 = 0;

380 
	`¦owlogIn™
();

381 
	`vr_»¶iÿtiÚ_š™
();

383 
	`ü—‹Sh¬edObjeùs
();

385 
£rv”
.
pÜt
 = 
c£rv”
->port;

388 
»t
 = 
	`wÜk”s_š™
(
nci
->
th»ad_num
);

389 ià(
»t
 !ğ
VR_OK
) {

390 
	`log_”rÜ
("Init workerhreads failed");

391  
VR_ERROR
;

395 
»t
 = 
	`ma¡”_š™
(
cÚf
);

396 ià(
»t
 !ğ
VR_OK
) {

397 
	`log_”rÜ
("Init masterhread failed");

398  
VR_ERROR
;

401 
»t
 = 
	`back’ds_š™
(1);

402 ià(
»t
 !ğ
VR_OK
) {

403 
	`log_”rÜ
("Init backendhreads failed");

404  
VR_ERROR
;

407 
	`log_debug
(
LOG_NOTICE
, "memÜy‡Îoølocky³: %s", 
	`m®loc_lock_ty³
());

408 
	`log_debug
(
LOG_NOTICE
, "m®loølib: %s", 
DMALLOC_LIB
);

410 
	`log_debug
(
LOG_NOTICE
, "¡© locky³: %s", 
STATS_LOCK_TYPE
);

412  
VR_OK
;

413 
	}
}

415 
	$g‘LRUClock
() {

416  (
	`vr_m£c_now
()/
LRU_CLOCK_RESOLUTION
è& 
LRU_CLOCK_MAX
;

417 
	}
}

428 
	#EVICTION_SAMPLES_ARRAY_SIZE
 16

	)

429 
	$eviùiÚPoŞPİuÏ‹
(
diù
 *
§m¶ediù
, diù *
keydiù
,

430 
eviùiÚPoŞEÁry
 *
poŞ
, 
maxmemÜy_§m¶es
) {

431 
j
, 
k
, 
couÁ
;

432 
diùEÁry
 *
_§m¶es
[
EVICTION_SAMPLES_ARRAY_SIZE
];

433 
diùEÁry
 **
§m¶es
;

437 ià(
maxmemÜy_§m¶es
 <ğ
EVICTION_SAMPLES_ARRAY_SIZE
) {

438 
§m¶es
 = 
_§m¶es
;

440 
§m¶es
 = 
	`d®loc
((§m¶es[0])*
maxmemÜy_§m¶es
);

443 
couÁ
 = 
	`diùG‘SomeKeys
(
§m¶ediù
,
§m¶es
,
maxmemÜy_§m¶es
);

444 
j
 = 0; j < 
couÁ
; j++) {

445 
idË
;

446 
sds
 
key
;

447 
robj
 *
o
;

448 
diùEÁry
 *
de
;

450 
de
 = 
§m¶es
[
j
];

451 
key
 = 
	`diùG‘Key
(
de
);

455 ià(
§m¶ediù
 !ğ
keydiù
è
de
 = 
	`diùFšd
(keydiù, 
key
);

456 
o
 = 
	`diùG‘V®
(
de
);

457 
idË
 = 
	`e¡im©eObjeùIdËTime
(
o
);

462 
k
 = 0;

463 
k
 < 
MAXMEMORY_EVICTION_POOL_SIZE
 &&

464 
poŞ
[
k
].
key
 &&

465 
poŞ
[
k
].
idË
 < idle) k++;

466 ià(
k
 =ğ0 && 
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
key
 !ğ
NULL
) {

470 } ià(
k
 < 
MAXMEMORY_EVICTION_POOL_SIZE
 && 
poŞ
[k].
key
 =ğ
NULL
) {

475 ià(
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
key
 =ğ
NULL
) {

478 
	`memmove
(
poŞ
+
k
+1,pool+k,

479 (
poŞ
[0])*(
MAXMEMORY_EVICTION_POOL_SIZE
-
k
-1));

482 
k
--;

485 
	`sdsä“
(
poŞ
[0].
key
);

486 
	`memmove
(
poŞ
,poŞ+1,ÕoŞ[0])*
k
);

489 
poŞ
[
k
].
key
 = 
	`sdsdup
(key);

490 
poŞ
[
k
].
idË
 = idle;

492 ià(
§m¶es
 !ğ
_§m¶es
è
	`dä“
(samples);

493 
	}
}

495 
	$ä“MemÜyIfN“ded
(
vr_ev’oİ
 *
v–
) {

496 
size_t
 
mem_u£d
, 
mem_toä“
, 
mem_ä“d
;

497 
m¡ime_t
 
Ï‹ncy
, 
eviùiÚ_Ï‹ncy
;

498 
keys_ä“d
 = 0;

499 
maxmemÜy
;

500 
maxmemÜy_pŞicy
, 
maxmemÜy_§m¶es
;

501 
»t
;

503 
maxmemÜy
 = 
v–
->
cc
.maxmemory;

504 ià(
	`d®loc_u£d_memÜy
(è<ğ
maxmemÜy
)

505  
VR_OK
;

507 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORYP
, &
maxmemÜy_pŞicy
);

508 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_NO_EVICTION
)

509  
VR_ERROR
;

511 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORYS
, &
maxmemÜy_§m¶es
);

513 
j
, 
k
;

515 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

516 
be¡v®
 = 0;

517 
sds
 
be¡key
 = 
NULL
;

518 
diùEÁry
 *
de
;

519 
»disDb
 *
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
j
);

520 
diù
 *dict;

522 
	`lockDbWr™e
(
db
);

523 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_LRU
 ||

524 
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
)

526 
diù
 = 
db
->dict;

528 
diù
 = 
db
->
expœes
;

530 ià(
	`diùSize
(
diù
) == 0) {

531 
	`uÆockDb
(
db
);

536 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
 ||

537 
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_RANDOM
)

539 
de
 = 
	`diùG‘RªdomKey
(
diù
);

540 
be¡key
 = 
	`diùG‘Key
(
de
);

544 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_LRU
 ||

545 
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_LRU
)

547 
eviùiÚPoŞEÁry
 *
poŞ
 = 
db
->
eviùiÚ_poŞ
;

549 
be¡key
 =ğ
NULL
) {

550 
	`eviùiÚPoŞPİuÏ‹
(
diù
, 
db
->diù, db->
eviùiÚ_poŞ
, 
maxmemÜy_§m¶es
);

552 
k
 = 
MAXMEMORY_EVICTION_POOL_SIZE
-1; k >= 0; k--) {

553 ià(
poŞ
[
k
].
key
 =ğ
NULL
) ;

554 
de
 = 
	`diùFšd
(
diù
,
poŞ
[
k
].
key
);

557 
	`sdsä“
(
poŞ
[
k
].
key
);

559 
	`memmove
(
poŞ
+
k
,pool+k+1,

560 (
poŞ
[0])*(
MAXMEMORY_EVICTION_POOL_SIZE
-
k
-1));

563 
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
key
 = 
NULL
;

564 
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
idË
 = 0;

568 ià(
de
) {

569 
be¡key
 = 
	`diùG‘Key
(
de
);

580 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_TTL
) {

581 
k
 = 0; k < 
maxmemÜy_§m¶es
; k++) {

582 
sds
 
thiskey
;

583 
thisv®
;

585 
de
 = 
	`diùG‘RªdomKey
(
diù
);

586 
thiskey
 = 
	`diùG‘Key
(
de
);

587 
thisv®
 = (è
	`diùG‘V®
(
de
);

591 ià(
be¡key
 =ğ
NULL
 || 
thisv®
 < 
be¡v®
) {

592 
be¡key
 = 
thiskey
;

593 
be¡v®
 = 
thisv®
;

599 ià(
be¡key
) {

600 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
be¡key
,
	`sd¦’
(bestkey));

601 
	`dbD–‘e
(
db
,
keyobj
);

602 
	`ä“Objeù
(
keyobj
);

603 
keys_ä“d
++;

606 
	`uÆockDb
(
db
);

608 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
, &
maxmemÜy
);

609 ià(
	`d®loc_u£d_memÜy
(è<ğ
maxmemÜy
) {

610 
¡İ
;

614 ià(!
keys_ä“d
) {

615  
VR_ERROR
;

618 
	`upd©e_¡©s_add
(
v–
->
¡©s
, 
eviùedkeys
, 
keys_ä“d
);

619 
keys_ä“d
 = 0;

622 
¡İ
:

623 
	`upd©e_¡©s_add
(
v–
->
¡©s
, 
eviùedkeys
, 
keys_ä“d
);

624  
VR_OK
;

625 
	}
}

629 
	$pšgCommªd
(
ş›Á
 *
c
) {

631 ià(
c
->
¬gc
 > 2) {

632 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

633 
c
->
cmd
->
Çme
);

637 ià(
c
->
æags
 & 
CLIENT_PUBSUB
) {

638 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[2]);

639 
	`addR•lyBulkCBufãr
(
c
,"pong",4);

640 ià(
c
->
¬gc
 == 1)

641 
	`addR•lyBulkCBufãr
(
c
,"",0);

643 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

645 ià(
c
->
¬gc
 == 1)

646 
	`addR•ly
(
c
,
sh¬ed
.
pÚg
);

648 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

650 
	}
}

661 
	$time_šd•’d’t_¡rcmp
(*
a
, *
b
) {

662 
buç
[
CONFIG_AUTHPASS_MAX_LEN
], 
bufb
[CONFIG_AUTHPASS_MAX_LEN];

667 
®’
 = 
	`¡¾’
(
a
);

668 
bËn
 = 
	`¡¾’
(
b
);

669 
j
;

670 
diff
 = 0;

675 ià(
®’
 > (
buç
è|| 
bËn
 > (
bufb
))  1;

677 
	`mem£t
(
buç
,0,(bufa));

678 
	`mem£t
(
bufb
,0,(bufb));

681 
	`memıy
(
buç
,
a
,
®’
);

682 
	`memıy
(
bufb
,
b
,
bËn
);

686 
j
 = 0; j < (
buç
); j++) {

687 
diff
 |ğ(
buç
[
j
] ^ 
bufb
[j]);

690 
diff
 |ğ
®’
 ^ 
bËn
;

691  
diff
;

692 
	}
}

694 
	$authCommªd
(
ş›Á
 *
c
) {

695 
sds
 
»quœ•ass
;

697 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_REQUIREPASS
,&
»quœ•ass
);

698 ià(!
»quœ•ass
) {

699 
	`addR•lyE¼Ü
(
c
,"Client sent AUTH, but‚o…assword is set");

701 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
»quœ•ass
)) {

702 ià(!
c
->
auth’tiÿ‹d
)

703 
c
->
auth’tiÿ‹d
 = 1;

704 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

706 
c
->
auth’tiÿ‹d
 = 0;

707 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

709 
	`sdsä“
(
»quœ•ass
);

710 
	}
}

712 
	$admšCommªd
(
ş›Á
 *
c
) {

713 
sds
 
admš·ss
;

715 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_ADMINPASS
,&
admš·ss
);

716 ià(!
admš·ss
) {

717 
	`addR•lyE¼Ü
(
c
,"Client sent ADMIN, but‚o…assword is set");

719 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
admš·ss
)) {

720 
c
->
auth’tiÿ‹d
 = 2;

721 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

723 
c
->
auth’tiÿ‹d
 = 0;

724 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

726 
	`sdsä“
(
admš·ss
);

727 
	}
}

729 
	$htN“dsResize
(
diù
 *dict) {

730 
size
, 
u£d
;

732 
size
 = 
	`diùSlÙs
(
diù
);

733 
u£d
 = 
	`diùSize
(
diù
);

734  (
size
 && 
u£d
 && siz> 
DICT_HT_INITIAL_SIZE
 &&

735 (
u£d
*100/
size
 < 
HASHTABLE_MIN_FILL
));

736 
	}
}

738 
	skeys_¡©i¡ics
 {

739 
	mkeys_®l
;

740 
	mvkeys_®l
;

741 
	mavg_‰l_®l
;

742 
	mÃxi¡
;

748 
sds
 
	$g’VœeInfoSŒšg
(
vr_ev’oİ
 *
v–
, *
£ùiÚ
) {

749 
sds
 
šfo
 = 
	`sd£m±y
();

750 
time_t
 
u±ime
 = 
	`time
(
NULL
)-
£rv”
.
¡¬‰ime
;

751 
j
, 
k
, 
numcommªds
;

752 
ru§ge
 
£lf_ru
;

753 
lŞ
, 
bib
;

754 
®l£ùiÚs
 = 0, 
def£ùiÚs
 = 0;

755 
£ùiÚs
 = 0;

756 
d¬¿y
 *
kss
 = 
NULL
;

758 ià(
£ùiÚ
 =ğ
NULL
) section = "default";

759 
®l£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"all") == 0;

760 
def£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"default") == 0;

762 
	`g‘ru§ge
(
RUSAGE_SELF
, &
£lf_ru
);

765 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"server")) {

766 
ÿÎ_uÇme
 = 1;

767 
ut¢ame
 
Çme
;

768 *
mode
;

770 
mode
 = "standalone";

772 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

774 ià(
ÿÎ_uÇme
) {

776 
	`uÇme
(&
Çme
);

777 
ÿÎ_uÇme
 = 0;

780 
šfo
 = 
	`sdsÿrštf
(info,

798 
VR_VERSION_STRING
,

799 
mode
,

800 
Çme
.
sy¢ame
,‚ame.
»Ëa£
,‚ame.
machše
,

801 
£rv”
.
¬ch_b™s
,

802 
	`«G‘ApiName
(),

803 #ifdeà
__GNUC__


804 
__GNUC__
,
__GNUC_MINOR__
,
__GNUC_PATCHLEVEL__
,

808 (è
	`g‘pid
(),

809 
£rv”
.
runid
,

810 
£rv”
.
pÜt
,

811 (
štmax_t
)
u±ime
,

812 (
štmax_t
)(
u±ime
/(3600*24)),

813 
£rv”
.
hz
,

814 
£rv”
.
execubË
 ? server.executable : "",

815 
£rv”
.
cÚfigfe
 ? server.configfile : "",

816 
£rv”
.
dbÊum
,

817 
£rv”
.
dbšum
);

821 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"clients")) {

822 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

823 
šfo
 = 
	`sdsÿrštf
(info,

826 
	`cu¼’t_ş›Ás
());

830 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"memory")) {

831 
ušt32_t
 
idx
;

832 
vr_wÜk”
 *
wÜk”
;

833 
hmem
[64];

834 
³ak_hmem
[64];

835 
tÙ®_sy¡em_hmem
[64];

836 
u£d_memÜy_lua_hmem
[64];

837 
u£d_memÜy_rss_hmem
[64];

838 
maxmemÜy_hmem
[64];

839 
size_t
 
vr_u£d_memÜy
 = 
	`d®loc_u£d_memÜy
();

840 
size_t
 
tÙ®_sy¡em_mem
 = 
£rv”
.
sy¡em_memÜy_size
;

841 cÚ¡ *
eviù_pŞicy
;

842 
size_t
 
³ak_memÜy
 = 0, 
³ak_memÜy_fÜ_Úe_wÜk”
;

843 
maxmemÜy
;

844 
maxmemÜy_pŞicy
;

850 
idx
 = 0; idx < 
	`d¬¿y_n
(&
wÜk”s
); idx ++) {

851 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
idx
);

852 
	`upd©e_¡©s_g‘
(
wÜk”
->
v–
.
¡©s
, 
³ak_memÜy
,

853 &
³ak_memÜy_fÜ_Úe_wÜk”
);

854 ià(
³ak_memÜy
 < 
³ak_memÜy_fÜ_Úe_wÜk”
)

855 
³ak_memÜy
 = 
³ak_memÜy_fÜ_Úe_wÜk”
;

857 ià(
vr_u£d_memÜy
 > 
³ak_memÜy
) {

858 
³ak_memÜy
 = 
vr_u£d_memÜy
;

859 
	`upd©e_¡©s_£t
(
v–
->
¡©s
, 
³ak_memÜy
, 
vr_u£d_memÜy
);

862 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
maxmemÜy
);

863 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORYP
,&
maxmemÜy_pŞicy
);

864 
eviù_pŞicy
 = 
	`g‘_eviùpŞicy_¡ršgs
(
maxmemÜy_pŞicy
);

866 
	`by‹sToHumª
(
hmem
,
vr_u£d_memÜy
);

867 
	`by‹sToHumª
(
³ak_hmem
,
³ak_memÜy
);

868 
	`by‹sToHumª
(
tÙ®_sy¡em_hmem
,
tÙ®_sy¡em_mem
);

869 
	`by‹sToHumª
(
u£d_memÜy_rss_hmem
,
v–
->
»sid’t_£t_size
);

870 
	`by‹sToHumª
(
maxmemÜy_hmem
,
maxmemÜy
);

872 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

873 
šfo
 = 
	`sdsÿrštf
(info,

888 
vr_u£d_memÜy
,

889 
hmem
,

890 
v–
->
»sid’t_£t_size
,

891 
u£d_memÜy_rss_hmem
,

892 
³ak_memÜy
,

893 
³ak_hmem
,

894 ()
tÙ®_sy¡em_mem
,

895 
tÙ®_sy¡em_hmem
,

896 
maxmemÜy
,

897 
maxmemÜy_hmem
,

898 
eviù_pŞicy
,

899 ()
v–
->
»sid’t_£t_size
/
vr_u£d_memÜy
,

900 
DMALLOC_LIB


905 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"stats")) {

906 
ušt32_t
 
idx
;

907 
vr_¡©s
 *
¡©s
;

908 
¡©_numcÚÃùiÚs
=0, 
¡©_numcommªds
=0;

909 
¡©_Ãt_šput_by‹s
=0, 
¡©_Ãt_ouut_by‹s
=0;

910 
¡©_»jeùed_cÚn
=0;

911 
¡©_expœedkeys
=0;

912 
¡©_eviùedkeys
=0;

913 
¡©_key¥aû_h™s
=0, 
¡©_key¥aû_mis£s
=0;

914 
¡©_numcommªds_İs
=0;

915 
¡©_Ãt_šput_by‹s_İs
=0, 
¡©_Ãt_ouut_by‹s_İs
=0;

917 
idx
 = 0; idx < 
	`d¬¿y_n
(&
wÜk”s
); idx ++) {

918 
¡©s_v®ue
;

919 
vr_wÜk”
 *
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
idx
);

920 
¡©s
 = 
wÜk”
->
v–
.stats;

922 
	`upd©e_¡©s_g‘
(
¡©s
, 
numcommªds
, &
¡©s_v®ue
);

923 
¡©_numcommªds
 +ğ
¡©s_v®ue
;

924 
	`upd©e_¡©s_g‘
(
¡©s
, 
numcÚÃùiÚs
, &
¡©s_v®ue
);

925 
¡©_numcÚÃùiÚs
 +ğ
¡©s_v®ue
;

926 
	`upd©e_¡©s_g‘
(
¡©s
, 
expœedkeys
, &
¡©s_v®ue
);

927 
¡©_expœedkeys
 +ğ
¡©s_v®ue
;

928 
	`upd©e_¡©s_g‘
(
¡©s
, 
eviùedkeys
, &
¡©s_v®ue
);

929 
¡©_eviùedkeys
 +ğ
¡©s_v®ue
;

930 
	`upd©e_¡©s_g‘
(
¡©s
, 
Ãt_šput_by‹s
, &
¡©s_v®ue
);

931 
¡©_Ãt_šput_by‹s
 +ğ
¡©s_v®ue
;

932 
	`upd©e_¡©s_g‘
(
¡©s
, 
Ãt_ouut_by‹s
, &
¡©s_v®ue
);

933 
¡©_Ãt_ouut_by‹s
 +ğ
¡©s_v®ue
;

934 
	`upd©e_¡©s_g‘
(
¡©s
, 
key¥aû_h™s
, &
¡©s_v®ue
);

935 
¡©_key¥aû_h™s
 +ğ
¡©s_v®ue
;

936 
	`upd©e_¡©s_g‘
(
¡©s
, 
key¥aû_mis£s
, &
¡©s_v®ue
);

937 
¡©_key¥aû_mis£s
 +ğ
¡©s_v®ue
;

939 
¡©_numcommªds_İs
 +ğ
	`g‘In¡ªÃousM‘ric
(
¡©s
, 
STATS_METRIC_COMMAND
);

940 
¡©_Ãt_šput_by‹s_İs
 +ğ()
	`g‘In¡ªÃousM‘ric
(
¡©s
, 
STATS_METRIC_NET_INPUT
)/1024;

941 
¡©_Ãt_ouut_by‹s_İs
 +ğ()
	`g‘In¡ªÃousM‘ric
(
¡©s
, 
STATS_METRIC_NET_OUTPUT
)/1024;

943 
idx
 = 0; idx < 
	`d¬¿y_n
(&
back’ds
); idx ++) {

944 
¡©s_v®ue
;

945 
vr_back’d
 *
back’d
 = 
	`d¬¿y_g‘
(&
back’ds
, 
idx
);

946 
¡©s
 = 
back’d
->
v–
.stats;

948 
	`upd©e_¡©s_g‘
(
¡©s
, 
expœedkeys
, &
¡©s_v®ue
);

949 
¡©_expœedkeys
 +ğ
¡©s_v®ue
;

951 
	`upd©e_¡©s_g‘
(
ma¡”
.
v–
.
¡©s
, 
»jeùed_cÚn
, &
¡©_»jeùed_cÚn
);

953 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

954 
šfo
 = 
	`sdsÿrštf
(info,

968 
¡©_numcÚÃùiÚs
,

969 
¡©_numcommªds
,

970 
¡©_numcommªds_İs
,

971 
¡©_Ãt_šput_by‹s
,

972 
¡©_Ãt_ouut_by‹s
,

973 
¡©_Ãt_šput_by‹s_İs
,

974 
¡©_Ãt_ouut_by‹s_İs
,

975 
¡©_»jeùed_cÚn
,

976 
¡©_expœedkeys
,

977 
¡©_eviùedkeys
,

978 
¡©_key¥aû_h™s
,

979 
¡©_key¥aû_mis£s
);

983 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cpu")) {

984 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

985 
šfo
 = 
	`sdsÿrštf
(info,

989 ()
£lf_ru
.
ru_¡ime
.
tv_£c
+()£lf_ru.ru_¡ime.
tv_u£c
/1000000,

990 ()
£lf_ru
.
ru_utime
.
tv_£c
+()£lf_ru.ru_utime.
tv_u£c
/1000000);

994 ià(
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"internal")) {

995 
»disDb
 *
db
;

996 
keys_¡©i¡ics
 *
ks
;

997 
keys
, 
vkeys
, 
avg_‰l
;

999 
kss
 = 
	`d¬¿y_ü—‹
(
£rv”
.
dbÊum
, (
keys_¡©i¡ics
));

1001 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

1002 
šfo
 = 
	`sdsÿrštf
(info, "# Internal\r\n");

1003 
j
 = 0; j < 
£rv”
.
dbÊum
; j++) {

1004 
ks
 = 
	`d¬¿y_push
(
kss
);

1005 
ks
->
keys_®l
 = ks->
vkeys_®l
 = ks->
avg_‰l_®l
 = 0;

1006 
ks
->
Ãxi¡
 = 0;

1007 
k
 = 0; k < 
£rv”
.
dbšum
; k ++) {

1008 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)(
j
*£rv”.
dbšum
+
k
));

1009 
	`lockDbR—d
(
db
);

1010 
keys
 = 
	`diùSize
(
db
->
diù
);

1011 
vkeys
 = 
	`diùSize
(
db
->
expœes
);

1012 
avg_‰l
 = 
db
->avg_ttl;

1013 
	`uÆockDb
(
db
);

1014 ià(
keys
 || 
vkeys
) {

1015 
šfo
 = 
	`sdsÿrštf
(info,

1017 
j
, 
k
, 
keys
, 
vkeys
, 
db
->
avg_‰l
);

1019 
ks
->
keys_®l
 +ğ
keys
;

1020 
ks
->
vkeys_®l
 +ğ
vkeys
;

1021 
ks
->
avg_‰l_®l
 +ğ
avg_‰l
;

1022 ià(
avg_‰l
 > 0è
ks
->
Ãxi¡
 ++;

1028 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"keyspace")) {

1029 
»disDb
 *
db
;

1030 
keys_¡©i¡ics
 *
ks
;

1031 
keys_®l
, 
vkeys_®l
, 
avg_‰l_®l
;

1032 
Ãxi¡
;

1034 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

1035 
šfo
 = 
	`sdsÿrštf
(info, "# Keyspace\r\n");

1036 ià(
kss
 =ğ
NULL
) {

1037 
j
 = 0; j < 
£rv”
.
dbÊum
; j++) {

1038 
keys_®l
 = 
vkeys_®l
 = 
avg_‰l_®l
 = 0;

1039 
Ãxi¡
 = 0;

1040 
k
 = 0; k < 
£rv”
.
dbšum
; k ++) {

1041 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)(
j
*£rv”.
dbšum
+
k
));

1042 
	`lockDbR—d
(
db
);

1043 
keys_®l
 +ğ
	`diùSize
(
db
->
diù
);

1044 
vkeys_®l
 +ğ
	`diùSize
(
db
->
expœes
);

1045 
avg_‰l_®l
 +ğ
db
->
avg_‰l
;

1046 ià(
db
->
avg_‰l
 > 0è
Ãxi¡
 ++;

1047 
	`uÆockDb
(
db
);

1049 ià(
keys_®l
 || 
vkeys_®l
) {

1050 
šfo
 = 
	`sdsÿrštf
(info,

1052 
j
, 
keys_®l
, 
vkeys_®l
, 
Ãxi¡
>0?(
avg_‰l_®l
/nexist):0);

1056 
j
 = 0; j < 
£rv”
.
dbÊum
; j ++) {

1057 
ks
 = 
	`d¬¿y_g‘
(
kss
, 
j
);

1058 ià(
ks
->
keys_®l
 || ks->
vkeys_®l
) {

1059 
šfo
 = 
	`sdsÿrštf
(info,

1061 
j
, 
ks
->
keys_®l
, ks->
vkeys_®l
,

1062 
ks
->
Ãxi¡
>0?(ks->
avg_‰l_®l
/ks->nexist):0);

1068 ià(
kss
 !ğ
NULL
) {

1069 
kss
->
ÃËm
 = 0;

1070 
	`d¬¿y_de¡roy
(
kss
);

1071 
kss
 = 
NULL
;

1074  
šfo
;

1075 
	}
}

1077 
	$šfoCommªd
(
ş›Á
 *
c
) {

1078 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : "default";

1080 ià(
c
->
¬gc
 > 2) {

1081 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1084 
	`addR•lyBulkSds
(
c
, 
	`g’VœeInfoSŒšg
(c->
v–
, 
£ùiÚ
));

1085 
	}
}

1087 
	$echoCommªd
(
ş›Á
 *
c
) {

1088 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

1089 
	}
}

1091 
	$timeCommªd
(
ş›Á
 *
c
) {

1092 
timev®
 
tv
;

1096 
	`g‘timeofday
(&
tv
,
NULL
);

1097 
	`addR•lyMuÉiBulkL’
(
c
,2);

1098 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_£c
);

1099 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_u£c
);

1100 
	}
}

1110 
	$adju¡O³nFesLim™
(
maxş›Ás
) {

1111 
¾im_t
 
maxfes
, 
fš®lim™
 = 0;

1112 
¾im_t
 
Şdlim™
;

1113 
fš®maxş›Ás
;

1114 
¾im™
 
lim™
;

1115 
th»ads
;

1117 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_THREADS
,&
th»ads
);

1118 
maxfes
 = 
maxş›Ás
+
th»ads
*2+
CONFIG_MIN_RESERVED_FDS
;

1119 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
,&
lim™
) == -1) {

1120 
	`log_w¬n
("Unableo obtainhe current NOFILE†imit (%s),‡ssuming 1024‡nd settinghe max clients configuration‡ccordingly.",

1121 
	`¡»¼Ü
(
”ºo
));

1122 
Şdlim™
 = 1024;

1123 
fš®lim™
 = 
Şdlim™
;

1125 
Şdlim™
 = 
lim™
.
¾im_cur
;

1129 ià(
Şdlim™
 < 
maxfes
) {

1130 
¾im_t
 
be¡lim™
;

1131 
£Œlim™_”rÜ
 = 0;

1135 
be¡lim™
 = 
maxfes
;

1136 
be¡lim™
 > 
Şdlim™
) {

1137 
¾im_t
 
deü_¡•
 = 16;

1139 
lim™
.
¾im_cur
 = 
be¡lim™
;

1140 
lim™
.
¾im_max
 = 
be¡lim™
;

1141 ià(
	`£Œlim™
(
RLIMIT_NOFILE
,&
lim™
) != -1) ;

1142 
£Œlim™_”rÜ
 = 
”ºo
;

1146 ià(
be¡lim™
 < 
deü_¡•
) ;

1147 
be¡lim™
 -ğ
deü_¡•
;

1152 ià(
be¡lim™
 < 
Şdlim™
) bestlimit = oldlimit;

1154 
fš®lim™
 = 
be¡lim™
;

1155 ià(
be¡lim™
 < 
maxfes
) {

1156 
	`log_w¬n
("You„equested maxclients of %d "

1158 
maxş›Ás
,

1159 (è
maxfes
);

1160 
	`log_w¬n
("Server can't set maximum open files "

1162 (è
maxfes
, 
	`¡»¼Ü
(
£Œlim™_”rÜ
));

1163 
	`log_w¬n
("Current maximum open files is %llu. ",

1164 (è
be¡lim™
);

1166 
	`log_w¬n
("Increased maximum‚umber of open files "

1168 (è
maxfes
,

1169 (è
Şdlim™
);

1172 
fš®lim™
 = 
maxfes
;

1176 
fš®maxş›Ás
 = 
fš®lim™
-
th»ads
*2-
CONFIG_MIN_RESERVED_FDS
;

1177 ià(
fš®maxş›Ás
 < 1) {

1178 
	`log_w¬n
("Your current 'ulimit -n' "

1182 (è
Şdlim™
,

1183 (è
maxfes
);

1187 ià(
fš®lim™
 < 
maxfes
) {

1188 
cÚf_v®ue
 *
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1189 
cv
->
v®ue
 = 
	`sdsäomlÚglÚg
(()
fš®maxş›Ás
);

1190 
	`cÚf_£rv”_£t
(
CONFIG_SOPN_MAXCLIENTS
,
cv
);

1191 
	`cÚf_v®ue_de¡roy
(
cv
);

1192 
	`log_w¬n
("maxclients has been„educedo %do compensate for "

1195 
fš®maxş›Ás
);

1198  ()
fš®lim™
;

1199 
	}
}

	@src/vr_server.h

1 #iâdeà
_VR_SERVER_H_


2 
	#_VR_SERVER_H_


	)

4 
	#CONFIG_MIN_RESERVED_FDS
 32

	)

7 
	#CONFIG_AUTHPASS_MAX_LEN
 512

	)

8 
	#PROTO_SHARED_SELECT_CMDS
 10

	)

9 
	#CRON_DBS_PER_CALL
 16

	)

11 
	#ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
 20

	)

12 
	#ACTIVE_EXPIRE_CYCLE_FAST_DURATION
 1000

	)

13 
	#ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
 25

	)

14 
	#ACTIVE_EXPIRE_CYCLE_SLOW
 0

	)

15 
	#ACTIVE_EXPIRE_CYCLE_FAST
 1

	)

17 
	#SCAN_TYPE_KEY
 0

	)

18 
	#SCAN_TYPE_HASH
 1

	)

19 
	#SCAN_TYPE_SET
 2

	)

20 
	#SCAN_TYPE_ZSET
 3

	)

23 
	#CONFIG_DEFAULT_MAXMEMORY_POLICY
 
MAXMEMORY_NO_EVICTION


	)

26 
	#OBJ_HASH_MAX_ZIPLIST_ENTRIES
 512

	)

27 
	#OBJ_HASH_MAX_ZIPLIST_VALUE
 64

	)

28 
	#OBJ_SET_MAX_INTSET_ENTRIES
 512

	)

29 
	#OBJ_ZSET_MAX_ZIPLIST_ENTRIES
 128

	)

30 
	#OBJ_ZSET_MAX_ZIPLIST_VALUE
 64

	)

33 
	#OBJ_LIST_MAX_ZIPLIST_SIZE
 -2

	)

34 
	#OBJ_LIST_COMPRESS_DEPTH
 0

	)

37 
	#CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
 3000

	)

40 
	#LIST_HEAD
 0

	)

41 
	#LIST_TAIL
 1

	)

43 
	#ZSKIPLIST_MAXLEVEL
 32

	)

44 
	#ZSKIPLIST_P
 0.25

	)

47 
	#UNIT_SECONDS
 0

	)

48 
	#UNIT_MILLISECONDS
 1

	)

51 
	#HASHTABLE_MIN_FILL
 10

	)

56 
	#run_w™h_³riod
(
_ms_
, 
üÚloİs
èià((_ms_ <ğ1000/
£rv”
.
hz
è|| !(üÚloİs%((_ms_)/(1000/£rv”.hz))))

	)

62 
	#LRU_CLOCK
(è((1000/
£rv”
.
hz
 <ğ
LRU_CLOCK_RESOLUTION
è? s”v”.
Ìuşock
 : 
	`g‘LRUClock
())

	)

75 
	s»adyLi¡
 {

76 
»disDb
 *
	mdb
;

77 
robj
 *
	mkey
;

78 } 
	t»adyLi¡
;

80 
	svr_£rv”
 {

81 
«Ev’tLoİ
 *
	m–
;

82 
dli¡
 *
	mş›Ás
;

85 
pid_t
 
	mpid
;

86 *
	mexecubË
;

87 *
	mcÚfigfe
;

88 
	mhz
;

90 
d¬¿y
 
	mdbs
;

91 
	mdbnum
;

92 
	mdbÊum
;

93 
	mdbšum
;

95 
diù
 *
	mcommªds
;

96 
diù
 *
	mÜig_commªds
;

98 
	mÌuşock
:
LRU_BITS
;

99 
	maùiv”ehashšg
;

101 *
	mpidfe
;

102 
	m¬ch_b™s
;

103 
	mrunid
[
CONFIG_RUN_ID_SIZE
+1];

106 
	mpÜt
;

107 
	mtı_backlog
;

109 
	mtık“·live
;

110 
size_t
 
	mş›Á_max_qu”ybuf_Ën
;

113 
size_t
 
	mhash_max_zli¡_’Œ›s
;

114 
size_t
 
	mhash_max_zli¡_v®ue
;

115 
size_t
 
	m£t_max_št£t_’Œ›s
;

116 
size_t
 
	mz£t_max_zli¡_’Œ›s
;

117 
size_t
 
	mz£t_max_zli¡_v®ue
;

118 
size_t
 
	mhÎ_¥¬£_max_by‹s
;

120 
	mli¡_max_zli¡_size
;

121 
	mli¡_com´ess_d•th
;

123 
ş›ÁBufãrLim™sCÚfig
 
	mş›Á_obuf_lim™s
[
CLIENT_TYPE_OBUF_COUNT
];

125 
dli¡
 *
	mmÚ™Üs
;

127 
time_t
 
	m¡¬‰ime
;

130 
time_t
 
	munixtime
;

131 
	mm¡ime
;

133 *
	munixsock‘
;

136 
	mlßdšg
;

137 
off_t
 
	mlßdšg_tÙ®_by‹s
;

138 
off_t
 
	mlßdšg_lßded_by‹s
;

139 
time_t
 
	mlßdšg_¡¬t_time
;

140 
off_t
 
	mlßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

143 
	maof_¡©e
;

144 
	maof_fsync
;

145 *
	maof_f’ame
;

146 
	maof_no_fsync_Ú_»wr™e
;

147 
	maof_»wr™e_³rc
;

148 
off_t
 
	maof_»wr™e_mš_size
;

149 
off_t
 
	maof_»wr™e_ba£_size
;

150 
off_t
 
	maof_cu¼’t_size
;

151 
	maof_»wr™e_scheduËd
;

152 
pid_t
 
	maof_chd_pid
;

153 
dli¡
 *
	maof_»wr™e_buf_blocks
;

154 
sds
 
	maof_buf
;

155 
	maof_fd
;

156 
	maof_£Ëùed_db
;

157 
time_t
 
	maof_æush_po¡pÚed_¡¬t
;

158 
time_t
 
	maof_Ï¡_fsync
;

159 
time_t
 
	maof_»wr™e_time_Ï¡
;

160 
time_t
 
	maof_»wr™e_time_¡¬t
;

161 
	maof_Ï¡bg»wr™e_¡©us
;

162 
	maof_d–ayed_fsync
;

163 
	maof_»wr™e_šüem’l_fsync
;

164 
	maof_Ï¡_wr™e_¡©us
;

165 
	maof_Ï¡_wr™e_”ºo
;

166 
	maof_lßd_Œunÿ‹d
;

168 
	maof_pe_wr™e_d©a_to_chd
;

169 
	maof_pe_»ad_d©a_äom_·»Á
;

170 
	maof_pe_wr™e_ack_to_·»Á
;

171 
	maof_pe_»ad_ack_äom_chd
;

172 
	maof_pe_wr™e_ack_to_chd
;

173 
	maof_pe_»ad_ack_äom_·»Á
;

174 
	maof_¡İ_£ndšg_diff
;

176 
sds
 
	maof_chd_diff
;

179 
	mdœty
;

180 
	mdœty_befÜe_bg§ve
;

181 
pid_t
 
	mrdb_chd_pid
;

182 
§v•¬am
 *
	m§v•¬ams
;

183 
	m§v•¬am¦’
;

184 *
	mrdb_f’ame
;

185 
	mrdb_com´essiÚ
;

186 
	mrdb_checksum
;

187 
time_t
 
	mÏ¡§ve
;

188 
time_t
 
	mÏ¡bg§ve_Œy
;

189 
time_t
 
	mrdb_§ve_time_Ï¡
;

190 
time_t
 
	mrdb_§ve_time_¡¬t
;

191 
	mrdb_chd_ty³
;

192 
	mÏ¡bg§ve_¡©us
;

193 
	m¡İ_wr™es_Ú_bg§ve_”r
;

194 
	mrdb_pe_wr™e_»suÉ_to_·»Á
;

195 
	mrdb_pe_»ad_»suÉ_äom_chd
;

199 
ş›Á
 *
	mlua_ş›Á
;

200 
ş›Á
 *
	mlua_ÿÎ”
;

201 
diù
 *
	mlua_süts
;

202 
m¡ime_t
 
	mlua_time_lim™
;

203 
m¡ime_t
 
	mlua_time_¡¬t
;

204 
	mlua_wr™e_dœty
;

206 
	mlua_¿ndom_dœty
;

208 
	mlua_»¶iÿ‹_commªds
;

209 
	mlua_muÉi_em™‹d
;

210 
	mlua_»¶
;

211 
	mlua_timedout
;

213 
	mlua_kl
;

214 
	mlua_®ways_»¶iÿ‹_commªds
;

217 
dli¡
 *
	m»ady_keys
;

220 
»disOpA¼ay
 
	m®so_´İag©e
;

223 
diù
 *
	mpubsub_chªÃls
;

224 
dli¡
 *
	mpubsub_·‰”ns
;

225 
	mnÙify_key¥aû_ev’ts
;

229 
»disCommªd
 *
	md–Commªd
, *
	mmuÉiCommªd
, *
	mÍushCommªd
, *
	mÍİCommªd
,

230 *
	m½İCommªd
, *
	m¤emCommªd
, *
	mexecCommªd
;

233 
size_t
 
	msy¡em_memÜy_size
;

237 
	szskli¡Node
 {

238 
robj
 *
	mobj
;

239 
	mscÜe
;

240 
zskli¡Node
 *
	mbackw¬d
;

241 
	szskli¡Lev–
 {

242 
zskli¡Node
 *
	mfÜw¬d
;

243 
	m¥ª
;

244 } 
	mËv–
[];

245 } 
	tzskli¡Node
;

247 
	szskli¡
 {

248 
zskli¡Node
 *
	mh—d”
, *
	m
;

249 
	mËngth
;

250 
	mËv–
;

251 } 
	tzskli¡
;

253 
	sz£t
 {

254 
diù
 *
	mdiù
;

255 
zskli¡
 *
	mz¦
;

256 } 
	tz£t
;

260 
robj
 *
	msubjeù
;

261 
	m’codšg
;

262 
	mdœeùiÚ
;

263 
quickli¡I‹r
 *
	m™”
;

264 } 
	tli¡Ty³I‹¿tÜ
;

268 
li¡Ty³I‹¿tÜ
 *
	mli
;

269 
quickli¡EÁry
 
	m’Œy
;

270 } 
	tli¡Ty³EÁry
;

274 
robj
 *
	msubjeù
;

275 
	m’codšg
;

276 
	mii
;

277 
diùI‹¿tÜ
 *
	mdi
;

278 } 
	t£tTy³I‹¿tÜ
;

285 
robj
 *
	msubjeù
;

286 
	m’codšg
;

288 *
	måŒ
, *
	mv±r
;

290 
diùI‹¿tÜ
 *
	mdi
;

291 
diùEÁry
 *
	mde
;

292 } 
	thashTy³I‹¿tÜ
;

294 
	ssh¬edObjeùsSŒuù
 {

295 
robj
 *
	mülf
, *
	mok
, *
	m”r
, *
	mem±ybulk
, *
	mcz”o
, *
	mcÚe
, *
	múegÚe
, *
	mpÚg
, *
	m¥aû
,

296 *
	mcŞÚ
, *
	mnuÎbulk
, *
	mnuÎmuÉibulk
, *
	mqueued
,

297 *
	mem±ymuÉibulk
, *
	mwrÚgty³”r
, *
	mnokey”r
, *
	msyÁax”r
, *
	m§meobjeù”r
,

298 *
	moutoäªg“¼
, *
	mnosü‹¼
, *
	mlßdšg”r
, *
	m¦owsü‹¼
, *
	mbg§v“¼
,

299 *
	mma¡”dowÃ¼
, *
	mro¦av“¼
, *
	mexeÿbÜ‹¼
, *
	mnßuth”r
, *
	mnßdmš”r
, *
	mnÜ•liÿ£¼
,

300 *
	mbusykey”r
, *
	moom”r
, *
	m¶us
, *
	mmes§gebulk
, *
	mpmes§gebulk
, *
	msubsüibebulk
,

301 *
	munsubsüibebulk
, *
	mpsubsüibebulk
, *
	mpunsubsüibebulk
, *
	md–
, *
	m½İ
, *
	mÍİ
,

302 *
	mÍush
, *
	mem±ysÿn
, *
	mmš¡ršg
, *
	mmax¡ršg
,

303 *
	m£Ëù
[
PROTO_SHARED_SELECT_CMDS
],

304 *
	mš‹g”s
[
OBJ_SHARED_INTEGERS
],

305 *
	mmbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
],

306 *
	mbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
],

307 *
	moutofcom¶ex™ylim™
,

308 *
	m£Áš–
;

312 
vr_£rv”
 
£rv”
;

313 
sh¬edObjeùsSŒuù
 
sh¬ed
;;

314 
diùTy³
 
hashDiùTy³
;

315 
diùTy³
 
£tDiùTy³
;

316 
diùTy³
 
z£tDiùTy³
;

318 
	#£rv”Pªic
(
_e
è
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 1, "as£¹ fad: %s", #_e)

	)

319 
	#£rv”As£¹W™hInfo
(
_c
,
_o
,
_e
è((_e)?()0 : (
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 1, "as£¹ fad: %s", #_e)))

	)

321 
diùSŒHash
(cÚ¡ *
key
);

322 
diùSŒCa£Hash
(cÚ¡ *
key
);

323 
diùSdsHash
(cÚ¡ *
key
);

324 
diùSdsCa£Hash
(cÚ¡ *
key
);

325 
diùSŒKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

326 
diùSŒKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

327 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

328 
diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

329 *
diùSdsKeyDupFromSŒ
(*
´ivd©a
, cÚ¡ *
key
);

330 
diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
);

331 
diùObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
);

332 
diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

333 
diùEncObjHash
(cÚ¡ *
key
);

334 
diùObjHash
(cÚ¡ *
key
);

335 
diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

336 
diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
);

338 
š™_£rv”
(
š¡ªû
 *
nci
);

340 
g‘LRUClock
();

342 
ä“MemÜyIfN“ded
(
vr_ev’oİ
 *
v–
);

343 
pšgCommªd
(
ş›Á
 *
c
);

344 
time_šd•’d’t_¡rcmp
(*
a
, *
b
);

345 
authCommªd
(
ş›Á
 *
c
) ;

346 
admšCommªd
(
ş›Á
 *
c
) ;

348 
htN“dsResize
(
diù
 *dict);

350 
sds
 
g’VœeInfoSŒšg
(
vr_ev’oİ
 *
v–
, *
£ùiÚ
);

351 
šfoCommªd
(
ş›Á
 *
c
);

352 
echoCommªd
(
ş›Á
 *
c
);

353 
timeCommªd
(
ş›Á
 *
c
);

355 
adju¡O³nFesLim™
(
maxş›Ás
);

	@src/vr_signal.c

1 
	~<¡dlib.h
>

2 
	~<sigÇl.h
>

4 
	~<vr_cÜe.h
>

5 
	~<vr_sigÇl.h
>

7 
sigÇl
 
	gsigÇls
[] = {

8 { 
SIGUSR1
, "SIGUSR1", 0, 
sigÇl_hªdËr
 },

9 { 
SIGUSR2
, "SIGUSR2", 0, 
sigÇl_hªdËr
 },

10 { 
SIGTTIN
, "SIGTTIN", 0, 
sigÇl_hªdËr
 },

11 { 
SIGTTOU
, "SIGTTOU", 0, 
sigÇl_hªdËr
 },

12 { 
SIGHUP
, "SIGHUP", 0, 
sigÇl_hªdËr
 },

13 { 
SIGINT
, "SIGINT", 0, 
sigÇl_hªdËr
 },

14 { 
SIGSEGV
, "SIGSEGV", ()
SA_RESETHAND
, 
sigÇl_hªdËr
 },

15 { 
SIGPIPE
, "SIGPIPE", 0, 
SIG_IGN
 },

16 { 0, 
NULL
, 0, NULL }

19 
r¡©us_t


20 
	$sigÇl_š™
()

22 
sigÇl
 *
sig
;

24 
sig
 = 
sigÇls
; sig->
signo
 != 0; sig++) {

25 
r¡©us_t
 
¡©us
;

26 
sigaùiÚ
 
§
;

28 
	`mem£t
(&
§
, 0, (sa));

29 
§
.
§_hªdËr
 = 
sig
->
hªdËr
;

30 
§
.
§_æags
 = 
sig
->
æags
;

31 
	`sigem±y£t
(&
§
.
§_mask
);

33 
¡©us
 = 
	`sigaùiÚ
(
sig
->
signo
, &
§
, 
NULL
);

34 ià(
¡©us
 < 0) {

35 
	`log_”rÜ
("sigaùiÚ(%sèçed: %s", 
sig
->
sigÇme
,

36 
	`¡»¼Ü
(
”ºo
));

37  
VR_ERROR
;

41  
VR_OK
;

42 
	}
}

45 
	$sigÇl_deš™
()

47 
	}
}

50 
	$sigÇl_hªdËr
(
signo
)

52 
sigÇl
 *
sig
;

53 (*
aùiÚ
)();

54 *
aùiÚ¡r
;

55 
boŞ
 
dÚe
;

57 
sig
 = 
sigÇls
; sig->
signo
 != 0; sig++) {

58 ià(
sig
->
signo
 == signo) {

62 
	`ASSERT
(
sig
->
signo
 != 0);

64 
aùiÚ¡r
 = "";

65 
aùiÚ
 = 
NULL
;

66 
dÚe
 = 
çl£
;

68 
signo
) {

69 
SIGUSR1
:

72 
SIGUSR2
:

75 
SIGTTIN
:

76 
aùiÚ¡r
 = ", up†ogging†evel";

77 
aùiÚ
 = 
log_Ëv–_up
;

80 
SIGTTOU
:

81 
aùiÚ¡r
 = ", down†ogging†evel";

82 
aùiÚ
 = 
log_Ëv–_down
;

85 
SIGHUP
:

86 
aùiÚ¡r
 = ",„eopening†og file";

87 
aùiÚ
 = 
log_»İ’
;

90 
SIGINT
:

91 
dÚe
 = 
Œue
;

92 
aùiÚ¡r
 = ",ƒxiting";

95 
SIGSEGV
:

96 
	`log_¡ackŒaû
();

97 
aùiÚ¡r
 = ", core dumping";

98 
	`¿i£
(
SIGSEGV
);

102 
	`NOT_REACHED
();

105 
	`log_§ã
("sigÇÈ%d (%sè»ûived%s", 
signo
, 
sig
->
sigÇme
, 
aùiÚ¡r
);

107 ià(
aùiÚ
 !ğ
NULL
) {

108 
	`aùiÚ
();

111 ià(
dÚe
) {

112 
	`ex™
(1);

114 
	}
}

	@src/vr_signal.h

1 #iâdeà
_VR_SIGNAL_H_


2 
	#_VR_SIGNAL_H_


	)

4 
	ssigÇl
 {

5 
	msigno
;

6 *
	msigÇme
;

7 
	mæags
;

8 (*
	mhªdËr
)(
	msigno
);

11 
r¡©us_t
 
sigÇl_š™
();

12 
sigÇl_deš™
();

13 
sigÇl_hªdËr
(
signo
);

	@src/vr_slowlog.c

1 
	~<vr_cÜe.h
>

3 
±h»ad_rwlock_t
 
	grwlock”
;

4 
dli¡
 *
	g¦owlog
;

5 
	g¦owlog_’Œy_id
;

10 
¦owlogEÁry
 *
	$¦owlogC»©eEÁry
(
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

11 
¦owlogEÁry
 *
£
 = 
	`d®loc
((*se));

12 
j
, 
¦¬gc
 = 
¬gc
;

14 ià(
¦¬gc
 > 
SLOWLOG_ENTRY_MAX_ARGC
) slargc = SLOWLOG_ENTRY_MAX_ARGC;

15 
£
->
¬gc
 = 
¦¬gc
;

16 
£
->
¬gv
 = 
	`d®loc
((
robj
*)*
¦¬gc
);

17 
j
 = 0; j < 
¦¬gc
; j++) {

21 ià(
¦¬gc
 !ğ
¬gc
 && 
j
 == slargc-1) {

22 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

23 
	`sdsÿrštf
(
	`sd£m±y
(),"... (%d more‡rguments)",

24 
¬gc
-
¦¬gc
+1));

27 ià(
¬gv
[
j
]->
ty³
 =ğ
OBJ_STRING
 &&

28 
	`sdsEncodedObjeù
(
¬gv
[
j
]) &&

29 
	`sd¦’
(
¬gv
[
j
]->
±r
è> 
SLOWLOG_ENTRY_MAX_STRING
)

31 
sds
 
s
 = 
	`sd¢ewËn
(
¬gv
[
j
]->
±r
, 
SLOWLOG_ENTRY_MAX_STRING
);

33 
s
 = 
	`sdsÿrštf
(s,"... (%lu more bytes)",

35 
	`sd¦’
(
¬gv
[
j
]->
±r
è- 
SLOWLOG_ENTRY_MAX_STRING
);

36 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

38 
£
->
¬gv
[
j
] = 
	`dupSŒšgObjeùUncÚ¡ªt
(argv[j]);

42 
£
->
time
 = 
	`time
(
NULL
);

43 
£
->
du¿tiÚ
 = duration;

44  
£
;

45 
	}
}

51 
	$¦owlogF»eEÁry
(*
£±r
) {

52 
¦owlogEÁry
 *
£
 = 
£±r
;

53 
j
;

55 
j
 = 0; j < 
£
->
¬gc
; j++)

56 
	`ä“Objeù
(
£
->
¬gv
[
j
]);

57 
	`dä“
(
£
->
¬gv
);

58 
	`dä“
(
£
);

59 
	}
}

63 
	$¦owlogIn™
() {

64 
	`±h»ad_rwlock_š™
(&
rwlock”
,
NULL
);

65 
¦owlog
 = 
	`dli¡C»©e
();

66 
¦owlog_’Œy_id
 = 0;

67 
	`dli¡S‘F»eM‘hod
(
¦owlog
,
¦owlogF»eEÁry
);

68 
	}
}

73 
	$¦owlogPushEÁryIfN“ded
(
vr_ev’oİ
 *
v–
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

74 
¦owlog_log_¦ow”_thª
;

75 
¦owlog_max_Ën
;

77 
¦owlog_log_¦ow”_thª
 = 
v–
->
cc
.slowlog_log_slower_than;

78 ià(
¦owlog_log_¦ow”_thª
 < 0) ;

79 ià(
du¿tiÚ
 >ğ
¦owlog_log_¦ow”_thª
) {

80 
¦owlogEÁry
 *
£
 = 
	`¦owlogC»©eEÁry
(
¬gv
,
¬gc
,
du¿tiÚ
);

81 
	`±h»ad_rwlock_w¾ock
(&
rwlock”
);

82 
£
->
id
 = 
¦owlog_’Œy_id
++;

83 
	`dli¡AddNodeH—d
(
¦owlog
,
£
);

84 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

87 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_SLOWLOGML
,&
¦owlog_max_Ën
);

89 
	`±h»ad_rwlock_w¾ock
(&
rwlock”
);

90 
	`dli¡L’gth
(
¦owlog
è> 
¦owlog_max_Ën
)

91 
	`dli¡D–Node
(
¦owlog
,
	`dli¡La¡
(slowlog));

92 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

93 
	}
}

96 
	$¦owlogRe£t
() {

97 
	`±h»ad_rwlock_w¾ock
(&
rwlock”
);

98 
	`dli¡L’gth
(
¦owlog
) > 0)

99 
	`dli¡D–Node
(
¦owlog
,
	`dli¡La¡
(slowlog));

100 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

101 
	}
}

105 
	$¦owlogCommªd
(
ş›Á
 *
c
) {

106 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"reset")) {

107 
	`¦owlogRe£t
();

108 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

109 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"len")) {

110 
Ën
;

111 
	`±h»ad_rwlock_rdlock
(&
rwlock”
);

112 
Ën
 = 
	`dli¡L’gth
(
¦owlog
);

113 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

114 
	`addR•lyLÚgLÚg
(
c
,
Ën
);

115 } ià((
c
->
¬gc
 == 2 || c->argc == 3) &&

116 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get"))

118 
couÁ
 = 10, 
£Á
 = 0;

119 
dli¡I‹r
 
li
;

120 *
tÙ’Œ›s
;

121 
dli¡Node
 *
Ê
;

122 
¦owlogEÁry
 *
£
;

124 ià(
c
->
¬gc
 == 3 &&

125 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
couÁ
,
NULL
è!ğ
VR_OK
)

128 
	`±h»ad_rwlock_rdlock
(&
rwlock”
);

129 
	`dli¡Rewšd
(
¦owlog
,&
li
);

130 
tÙ’Œ›s
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

131 
couÁ
-- && (
Ê
 = 
	`dli¡Next
(&
li
))) {

132 
j
;

134 
£
 = 
Ê
->
v®ue
;

135 
	`addR•lyMuÉiBulkL’
(
c
,4);

136 
	`addR•lyLÚgLÚg
(
c
,
£
->
id
);

137 
	`addR•lyLÚgLÚg
(
c
,
£
->
time
);

138 
	`addR•lyLÚgLÚg
(
c
,
£
->
du¿tiÚ
);

139 
	`addR•lyMuÉiBulkL’
(
c
,
£
->
¬gc
);

140 
j
 = 0; j < 
£
->
¬gc
; j++)

141 
	`addR•lyBulk
(
c
,
£
->
¬gv
[
j
]);

142 
£Á
++;

144 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

145 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
tÙ’Œ›s
,
£Á
);

147 
	`addR•lyE¼Ü
(
c
,

150 
	}
}

	@src/vr_slowlog.h

1 #iâdeà
_VR_SLOWLOG_H_


2 
	#_VR_SLOWLOG_H_


	)

4 
	#SLOWLOG_ENTRY_MAX_ARGC
 32

	)

5 
	#SLOWLOG_ENTRY_MAX_STRING
 128

	)

8 
	s¦owlogEÁry
 {

9 
robj
 **
	m¬gv
;

10 
	m¬gc
;

11 
	mid
;

12 
	mdu¿tiÚ
;

13 
time_t
 
	mtime
;

14 } 
	t¦owlogEÁry
;

17 
¦owlogIn™
();

18 
¦owlogPushEÁryIfN“ded
(
vr_ev’oİ
 *
v–
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
);

21 
¦owlogCommªd
(
ş›Á
 *
c
);

	@src/vr_stats.c

1 
	~<vr_cÜe.h
>

4 
	$vr_¡©s_š™
(
vr_¡©s
 *
¡©s
)

6 
r¡©us_t
 
»t
;

8 ià(
¡©s
 =ğ
NULL
) {

9  
VR_ERROR
;

12 
¡©s
->
¡¬‰ime
 = 0;

13 
¡©s
->
numcommªds
 = 0;

14 
¡©s
->
numcÚÃùiÚs
 = 0;

15 
¡©s
->
expœedkeys
 = 0;

16 
¡©s
->
eviùedkeys
 = 0;

17 
¡©s
->
key¥aû_h™s
 = 0;

18 
¡©s
->
key¥aû_mis£s
 = 0;

19 
¡©s
->
»jeùed_cÚn
 = 0;

20 
¡©s
->
sync_fuÎ
 = 0;

21 
¡©s
->
sync_·¹Ÿl_ok
 = 0;

22 
¡©s
->
sync_·¹Ÿl_”r
 = 0;

23 
¡©s
->
Ãt_šput_by‹s
 = 0;

24 
¡©s
->
Ãt_ouut_by‹s
 = 0;

25 
¡©s
->
³ak_memÜy
 = 0;

27 #ià!
	`defšed
(
STATS_ATOMIC_FIRST
è|| (!defšed(
__ATOMIC_RELAXED
è&& !defšed(
HAVE_ATOMIC
))

28 
»t
 = 
	`±h»ad_¥š_š™
(&
¡©s
->
¡©¦ock
, 0);

29 ià(
»t
 != 0) {

30  
VR_ERROR
;

34 
¡©s
->
¡¬‰ime
 = 
	`time
(
NULL
);

36  
VR_OK
;

37 
	}
}

40 
	$vr_¡©s_deš™
(
vr_¡©s
 *
¡©s
)

42 ià(
¡©s
 =ğ
NULL
) {

46 
¡©s
->
¡¬‰ime
 = 0;

47 
¡©s
->
numcommªds
 = 0;

48 
¡©s
->
numcÚÃùiÚs
 = 0;

49 
¡©s
->
expœedkeys
 = 0;

50 
¡©s
->
eviùedkeys
 = 0;

51 
¡©s
->
key¥aû_h™s
 = 0;

52 
¡©s
->
key¥aû_mis£s
 = 0;

53 
¡©s
->
»jeùed_cÚn
 = 0;

54 
¡©s
->
sync_fuÎ
 = 0;

55 
¡©s
->
sync_·¹Ÿl_ok
 = 0;

56 
¡©s
->
sync_·¹Ÿl_”r
 = 0;

57 
¡©s
->
Ãt_šput_by‹s
 = 0;

58 
¡©s
->
Ãt_ouut_by‹s
 = 0;

60 #ià!
	`defšed
(
STATS_ATOMIC_FIRST
è|| (!defšed(
__ATOMIC_RELAXED
è&& !defšed(
HAVE_ATOMIC
))

61 
	`±h»ad_¥š_de¡roy
(&
¡©s
->
¡©¦ock
);

63 
	}
}

66 
	$ŒackIn¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
, 
cu¼’t_»adšg
) {

67 
t
 = 
	`vr_m£c_now
(è- 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
;

68 
İs
 = 
cu¼’t_»adšg
 -

69 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
;

70 
İs_£c
;

72 
İs_£c
 = 
t
 > 0 ? (
İs
*1000/t) : 0;

74 
	`upd©e_¡©s_£t
(
¡©s
,
š¡_m‘ric
[
m‘ric
].
§m¶es
[¡©s->š¡_m‘ric[m‘ric].
idx
],
İs_£c
);

75 
¡©s
->
š¡_m‘ric
[
m‘ric
].
idx
++;

76 
¡©s
->
š¡_m‘ric
[
m‘ric
].
idx
 %ğ
STATS_METRIC_SAMPLES
;

77 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
 = 
	`vr_m£c_now
();

78 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
 = 
cu¼’t_»adšg
;

79 
	}
}

82 
	$g‘In¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
) {

83 
j
;

84 
sum
 = 0;

86 
j
 = 0; j < 
STATS_METRIC_SAMPLES
; j++) {

87 
v®ue
;

88 
	`upd©e_¡©s_g‘
(
¡©s
, 
š¡_m‘ric
[
m‘ric
].
§m¶es
[
j
], &
v®ue
);

89 
sum
 +ğ
v®ue
;

91  
sum
 / 
STATS_METRIC_SAMPLES
;

92 
	}
}

	@src/vr_stats.h

1 #iâdeà
_VR_STATS_H_


2 
	#_VR_STATS_H_


	)

5 
	#STATS_ATOMIC_FIRST
 1

	)

9 
	#STATS_METRIC_SAMPLES
 16

	)

10 
	#STATS_METRIC_COMMAND
 0

	)

11 
	#STATS_METRIC_NET_INPUT
 1

	)

12 
	#STATS_METRIC_NET_OUTPUT
 2

	)

13 
	#STATS_METRIC_COUNT
 3

	)

15 
	svr_¡©s
 {

17 
time_t
 
	m¡¬‰ime
;

18 
	mnumcommªds
;

19 
	mnumcÚÃùiÚs
;

20 
	mexpœedkeys
;

21 
	meviùedkeys
;

22 
	mkey¥aû_h™s
;

23 
	mkey¥aû_mis£s
;

24 
	m»jeùed_cÚn
;

25 
	msync_fuÎ
;

26 
	msync_·¹Ÿl_ok
;

27 
	msync_·¹Ÿl_”r
;

28 
	mÃt_šput_by‹s
;

29 
	mÃt_ouut_by‹s
;

30 
size_t
 
	m³ak_memÜy
;

35 
	mÏ¡_§m¶e_time
;

36 
	mÏ¡_§m¶e_couÁ
;

37 
	m§m¶es
[
STATS_METRIC_SAMPLES
];

38 
	midx
;

39 } 
	mš¡_m‘ric
[
STATS_METRIC_COUNT
];

41 #ià!
defšed
(
STATS_ATOMIC_FIRST
è|| (!defšed(
__ATOMIC_RELAXED
è&& !defšed(
HAVE_ATOMIC
))

42 
±h»ad_¥šlock_t
 
	m¡©¦ock
;

44 }
	tvr_¡©s
;

47 #ià
defšed
(
__ATOMIC_RELAXED
è&& defšed(
STATS_ATOMIC_FIRST
)

48 
	#upd©e_¡©s_add
(
_¡©s
, 
_f›ld
, 
_n
è
	`__©omic_add_ãtch
(&(_¡©s)->_f›ld, (_n), 
__ATOMIC_RELAXED
)

	)

49 
	#upd©e_¡©s_sub
(
_¡©s
, 
_f›ld
, 
_n
è
	`__©omic_sub_ãtch
(&(_¡©s)->_f›ld, (_n), 
__ATOMIC_RELAXED
)

	)

50 
	#upd©e_¡©s_£t
(
_¡©s
, 
_f›ld
, 
_n
è
	`__©omic_¡Üe_n
(&(_¡©s)->_f›ld, (_n), 
__ATOMIC_RELAXED
)

	)

51 
	#upd©e_¡©s_g‘
(
_¡©s
, 
_f›ld
, 
_v
) do { \

52 
	`__©omic_lßd
(&(
_¡©s
)->
_f›ld
, 
_v
, 
__ATOMIC_RELAXED
); \

53 } 0)

	)

55 
	#STATS_LOCK_TYPE
 "__ATOMIC_RELAXED"

	)

57 #–ià
defšed
(
HAVE_ATOMIC
è&& defšed(
STATS_ATOMIC_FIRST
)

58 
	#upd©e_¡©s_add
(
_¡©s
, 
_f›ld
, 
_n
è
	`__sync_add_ªd_ãtch
(&(_¡©s)->_f›ld, (_n))

	)

59 
	#upd©e_¡©s_sub
(
_¡©s
, 
_f›ld
, 
_n
è
	`__sync_sub_ªd_ãtch
(&(_¡©s)->_f›ld, (_n))

	)

60 
	#upd©e_¡©s_£t
(
_¡©s
, 
_f›ld
, 
_n
è
	`__sync_lock_‹¡_ªd_£t
(&(_¡©s)->_f›ld, (_n))

	)

61 
	#upd©e_¡©s_g‘
(
_¡©s
, 
_f›ld
, 
_v
) do { \

62 (*
_v
èğ
	`__sync_add_ªd_ãtch
(&(
_¡©s
)->
_f›ld
, 0); \

63 } 0)

	)

65 
	#STATS_LOCK_TYPE
 "HAVE_ATOMIC"

	)

67 
	#upd©e_¡©s_add
(
_¡©s
, 
_f›ld
, 
_n
) do { \

68 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

69 (
_¡©s
)->
_f›ld
 +ğ(
_n
); \

70 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

71 } 0)

	)

73 
	#upd©e_¡©s_sub
(
_¡©s
, 
_f›ld
, 
_n
) do { \

74 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

75 (
_¡©s
)->
_f›ld
 -ğ(
_n
); \

76 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

77 } 0)

	)

79 
	#upd©e_¡©s_£t
(
_¡©s
, 
_f›ld
, 
_n
) do { \

80 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

81 (
_¡©s
)->
_f›ld
 = (
_n
); \

82 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

83 } 0)

	)

85 
	#upd©e_¡©s_g‘
(
_¡©s
, 
_f›ld
, 
_v
) do { \

86 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

87 (*
_v
èğ(
_¡©s
)->
_f›ld
; \

88 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

89 } 0)

	)

91 
	#STATS_LOCK_TYPE
 "±h»ad_¥š_lock"

	)

94 
vr_¡©s_š™
(
vr_¡©s
 *
¡©s
);

95 
vr_¡©s_deš™
(
vr_¡©s
 *
¡©s
);

97 
ŒackIn¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
, 
cu¼’t_»adšg
);

98 
g‘In¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
);

	@src/vr_t_hash.c

1 
	~<m©h.h
>

3 
	~<vr_cÜe.h
>

12 
	$hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
) {

13 
i
;

15 ià(
o
->
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
) ;

17 
i
 = 
¡¬t
; i <ğ
’d
; i++) {

18 ià(
	`sdsEncodedObjeù
(
¬gv
[
i
]) &&

19 
	`sd¦’
(
¬gv
[
i
]->
±r
è> 
£rv”
.
hash_max_zli¡_v®ue
)

21 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

25 
	}
}

28 
	$hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
) {

29 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

30 ià(
o1
è*o1 = 
	`ŒyObjeùEncodšg
(*o1);

31 ià(
o2
è*o2 = 
	`ŒyObjeùEncodšg
(*o2);

33 
	}
}

37 
	$hashTy³G‘FromZli¡
(
robj
 *
o
,„obj *
f›ld
,

38 **
v¡r
,

39 *
vËn
,

40 *
vÎ
)

42 *
zl
, *
åŒ
 = 
NULL
, *
v±r
 = NULL;

43 
»t
;

44 
robj
 *
f›ld_Ãw
;

46 
	`ASSERT
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

48 
f›ld_Ãw
 = 
	`g‘DecodedObjeù
(
f›ld
);

50 
zl
 = 
o
->
±r
;

51 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

52 ià(
åŒ
 !ğ
NULL
) {

53 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(field_new->ptr), 1);

54 ià(
åŒ
 !ğ
NULL
) {

56 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

57 
	`ASSERT
(
v±r
 !ğ
NULL
);

61 ià(
f›ld_Ãw
 !ğ
f›ld
è
	`ä“Objeù
(field_new);

63 ià(
v±r
 !ğ
NULL
) {

64 
»t
 = 
	`zli¡G‘
(
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

65 
	`ASSERT
(
»t
);

70 
	}
}

74 
	$hashTy³G‘FromHashTabË
(
robj
 *
o
,„obj *
f›ld
,„obj **
v®ue
) {

75 
diùEÁry
 *
de
;

77 
	`ASSERT
(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

79 
de
 = 
	`diùFšd
(
o
->
±r
, 
f›ld
);

80 ià(
de
 =ğ
NULL
)  -1;

81 *
v®ue
 = 
	`diùG‘V®
(
de
);

83 
	}
}

91 
robj
 *
	$hashTy³G‘Objeù
(
robj
 *
o
,„obj *
f›ld
) {

92 
robj
 *
v®ue
 = 
NULL
;

94 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

95 *
v¡r
 = 
NULL
;

96 
vËn
 = 
UINT_MAX
;

97 
vÎ
 = 
LLONG_MAX
;

99 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0) {

100 ià(
v¡r
) {

101 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
, 
vËn
);

103 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

106 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

107 
robj
 *
aux
;

109 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0) {

110 
v®ue
 = 
aux
;

113 
	`£rv”Pªic
("Unknown hashƒncoding");

115  
v®ue
;

116 
	}
}

121 
size_t
 
	$hashTy³G‘V®ueL’gth
(
robj
 *
o
,„obj *
f›ld
) {

122 
size_t
 
Ën
 = 0;

123 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

124 *
v¡r
 = 
NULL
;

125 
vËn
 = 
UINT_MAX
;

126 
vÎ
 = 
LLONG_MAX
;

128 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)

129 
Ën
 = 
v¡r
 ? 
vËn
 : 
	`sdig™s10
(
vÎ
);

130 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

131 
robj
 *
aux
;

133 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0)

134 
Ën
 = 
	`¡ršgObjeùL’
(
aux
);

136 
	`£rv”Pªic
("Unknown hashƒncoding");

138  
Ën
;

139 
	}
}

143 
	$hashTy³Exi¡s
(
robj
 *
o
,„obj *
f›ld
) {

144 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

145 *
v¡r
 = 
NULL
;

146 
vËn
 = 
UINT_MAX
;

147 
vÎ
 = 
LLONG_MAX
;

149 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)  1;

150 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

151 
robj
 *
aux
;

153 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0)  1;

155 
	`£rv”Pªic
("Unknown hashƒncoding");

158 
	}
}

165 
	$hashTy³S‘
(
robj
 *
o
,„obj *
f›ld
,„obj *
v®ue
) {

166 
upd©e
 = 0;

167 
robj
 *
f›ld_Ãw
, *
v®ue_Ãw
;

169 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

170 *
zl
, *
åŒ
, *
v±r
;

172 
f›ld_Ãw
 = 
	`g‘DecodedObjeù
(
f›ld
);

173 
v®ue_Ãw
 = 
	`g‘DecodedObjeù
(
v®ue
);

175 
zl
 = 
o
->
±r
;

176 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

177 ià(
åŒ
 !ğ
NULL
) {

178 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(field_new->ptr), 1);

179 ià(
åŒ
 !ğ
NULL
) {

181 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

182 
	`ASSERT
(
v±r
 !ğ
NULL
);

183 
upd©e
 = 1;

186 
zl
 = 
	`zli¡D–‘e
(zl, &
v±r
);

189 
zl
 = 
	`zli¡In£¹
(zl, 
v±r
, 
v®ue_Ãw
->
±r
, 
	`sd¦’
(value_new->ptr));

193 ià(!
upd©e
) {

195 
zl
 = 
	`zli¡Push
(zl, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(f›ld_Ãw->±r), 
ZIPLIST_TAIL
);

196 
zl
 = 
	`zli¡Push
(zl, 
v®ue_Ãw
->
±r
, 
	`sd¦’
(v®ue_Ãw->±r), 
ZIPLIST_TAIL
);

198 
o
->
±r
 = 
zl
;

199 ià(
f›ld_Ãw
 !ğ
f›ld
è
	`ä“Objeù
(field_new);

200 ià(
v®ue_Ãw
 !ğ
v®ue
è
	`ä“Objeù
(value_new);

203 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

204 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

205 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

206 
f›ld_Ãw
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
f›ld
);

207 
v®ue_Ãw
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
v®ue
);

208 ià(
	`diùR•Ïû
(
o
->
±r
, 
f›ld_Ãw
, 
v®ue_Ãw
)) {

211 
upd©e
 = 1;

212 
	`ä“Objeù
(
f›ld_Ãw
);

215 
	`£rv”Pªic
("Unknown hashƒncoding");

217  
upd©e
;

218 
	}
}

222 
	$hashTy³D–‘e
(
robj
 *
o
,„obj *
f›ld
) {

223 
d–‘ed
 = 0;

225 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

226 *
zl
, *
åŒ
;

227 
robj
 *
f›ld_Ãw
;

229 
f›ld_Ãw
 = 
	`g‘DecodedObjeù
(
f›ld
);

231 
zl
 = 
o
->
±r
;

232 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

233 ià(
åŒ
 !ğ
NULL
) {

234 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(field_new->ptr), 1);

235 ià(
åŒ
 !ğ
NULL
) {

236 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

237 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

238 
o
->
±r
 = 
zl
;

239 
d–‘ed
 = 1;

243 ià(
f›ld_Ãw
 !ğ
f›ld
è
	`ä“Objeù
(field_new);

244 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

245 ià(
	`diùD–‘e
((
diù
*)
o
->
±r
, 
f›ld
è=ğ
VR_OK
) {

246 
d–‘ed
 = 1;

249 ià(
	`htN“dsResize
(
o
->
±r
)è
	`diùResize
(o->ptr);

253 
	`£rv”Pªic
("Unknown hashƒncoding");

256  
d–‘ed
;

257 
	}
}

260 
	$hashTy³L’gth
(
robj
 *
o
) {

261 
Ëngth
 = 
ULONG_MAX
;

263 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

264 
Ëngth
 = 
	`zli¡L’
(
o
->
±r
) / 2;

265 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

266 
Ëngth
 = 
	`diùSize
((
diù
*)
o
->
±r
);

268 
	`£rv”Pªic
("Unknown hashƒncoding");

271  
Ëngth
;

272 
	}
}

274 
hashTy³I‹¿tÜ
 *
	$hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

275 
hashTy³I‹¿tÜ
 *
hi
 = 
	`d®loc
((hashTypeIterator));

276 
hi
->
subjeù
 = subject;

277 
hi
->
’codšg
 = 
subjeù
->encoding;

279 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

280 
hi
->
åŒ
 = 
NULL
;

281 
hi
->
v±r
 = 
NULL
;

282 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

283 
hi
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

285 
	`£rv”Pªic
("Unknown hashƒncoding");

288  
hi
;

289 
	}
}

291 
	$hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
) {

292 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

293 
	`diùR–—£I‹¿tÜ
(
hi
->
di
);

296 
	`dä“
(
hi
);

297 
	}
}

301 
	$hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
) {

302 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

303 *
zl
;

304 *
åŒ
, *
v±r
;

306 
zl
 = 
hi
->
subjeù
->
±r
;

307 
åŒ
 = 
hi
->fptr;

308 
v±r
 = 
hi
->vptr;

310 ià(
åŒ
 =ğ
NULL
) {

312 
	`ASSERT
(
v±r
 =ğ
NULL
);

313 
åŒ
 = 
	`zli¡Index
(
zl
, 0);

316 
	`ASSERT
(
v±r
 !ğ
NULL
);

317 
åŒ
 = 
	`zli¡Next
(
zl
, 
v±r
);

319 ià(
åŒ
 =ğ
NULL
è 
VR_ERROR
;

322 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

323 
	`ASSERT
(
v±r
 !ğ
NULL
);

326 
hi
->
åŒ
 = fptr;

327 
hi
->
v±r
 = vptr;

328 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

329 ià((
hi
->
de
 = 
	`diùNext
(hi->
di
)è=ğ
NULL
è 
VR_ERROR
;

331 
	`£rv”Pªic
("Unknown hashƒncoding");

333  
VR_OK
;

334 
	}
}

338 
	$hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

339 **
v¡r
,

340 *
vËn
,

341 *
vÎ
)

343 
»t
;

345 
	`ASSERT
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

347 ià(
wh©
 & 
OBJ_HASH_KEY
) {

348 
»t
 = 
	`zli¡G‘
(
hi
->
åŒ
, 
v¡r
, 
vËn
, 
vÎ
);

349 
	`ASSERT
(
»t
);

351 
»t
 = 
	`zli¡G‘
(
hi
->
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

352 
	`ASSERT
(
»t
);

354 
	}
}

358 
	$hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, 
robj
 **
d¡
) {

359 
	`ASSERT
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

361 ià(
wh©
 & 
OBJ_HASH_KEY
) {

362 *
d¡
 = 
	`diùG‘Key
(
hi
->
de
);

364 *
d¡
 = 
	`diùG‘V®
(
hi
->
de
);

366 
	}
}

371 
robj
 *
	$hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

372 
robj
 *
d¡
;

374 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

375 *
v¡r
 = 
NULL
;

376 
vËn
 = 
UINT_MAX
;

377 
vÎ
 = 
LLONG_MAX
;

379 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

380 ià(
v¡r
) {

381 
d¡
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
, 
vËn
);

383 
d¡
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

385 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

386 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
, &
d¡
);

388 
	`£rv”Pªic
("Unknown hashƒncoding");

390  
d¡
;

391 
	}
}

393 
robj
 *
	$hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
, 
robj
 *
key
, *
expœed
) {

394 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
,
expœed
);

395 ià(
o
 =ğ
NULL
) {

396 
o
 = 
	`ü—‹HashObjeù
();

397 
	`dbAdd
(
c
->
db
,
key
,
o
);

399 ià(
o
->
ty³
 !ğ
OBJ_HASH
) {

400 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

401  
NULL
;

404  
o
;

405 
	}
}

407 
	$hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
) {

408 
	`ASSERT
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

410 ià(
’c
 =ğ
OBJ_ENCODING_ZIPLIST
) {

413 } ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

414 
hashTy³I‹¿tÜ
 *
hi
;

415 
diù
 *
d
;

416 
»t
;

418 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

419 
d
 = 
	`diùC»©e
(&
hashDiùTy³
, 
NULL
);

421 
	`hashTy³Next
(
hi
è!ğ
VR_ERROR
) {

422 
robj
 *
f›ld
, *
v®ue
;

424 
f›ld
 = 
	`hashTy³Cu¼’tObjeù
(
hi
, 
OBJ_HASH_KEY
);

425 
f›ld
 = 
	`ŒyObjeùEncodšg
(field);

426 
v®ue
 = 
	`hashTy³Cu¼’tObjeù
(
hi
, 
OBJ_HASH_VALUE
);

427 
v®ue
 = 
	`ŒyObjeùEncodšg
(value);

428 
»t
 = 
	`diùAdd
(
d
, 
f›ld
, 
v®ue
);

429 ià(
»t
 !ğ
DICT_OK
) {

432 
	`ASSERT
(
»t
 =ğ
DICT_OK
);

436 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

437 
	`dä“
(
o
->
±r
);

439 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

440 
o
->
±r
 = 
d
;

443 
	`£rv”Pªic
("Unknown hashƒncoding");

445 
	}
}

447 
	$hashTy³CÚv”t
(
robj
 *
o
, 
’c
) {

448 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

449 
	`hashTy³CÚv”tZli¡
(
o
, 
’c
);

450 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

451 
	`£rv”Pªic
("Not implemented");

453 
	`£rv”Pªic
("Unknown hashƒncoding");

455 
	}
}

461 
	$h£tCommªd
(
ş›Á
 *
c
) {

462 
upd©e
;

463 
robj
 *
o
;

464 
expœed
 = 0;

466 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

467 
	`lockDbWr™e
(
c
->
db
);

468 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

469 
	`uÆockDb
(
c
->
db
);

470 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

473 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

474 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2], &c->argv[3]);

475 
upd©e
 = 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],c->argv[3]);

476 
	`addR•ly
(
c
, 
upd©e
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
cÚe
);

477 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

478 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

479 
c
->
v–
->
dœty
++;

480 
	`uÆockDb
(
c
->
db
);

481 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

482 
	}
}

484 
	$h£ŠxCommªd
(
ş›Á
 *
c
) {

485 
robj
 *
o
;

486 
expœed
 = 0;

488 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

489 
	`lockDbWr™e
(
c
->
db
);

490 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

491 
	`uÆockDb
(
c
->
db
);

492 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

495 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

497 ià(
	`hashTy³Exi¡s
(
o
, 
c
->
¬gv
[2])) {

498 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

500 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2], &c->argv[3]);

501 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],c->argv[3]);

502 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

503 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

504 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

505 
£rv”
.
dœty
++;

508 
	`uÆockDb
(
c
->
db
);

509 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

510 
	}
}

512 
	$hm£tCommªd
(
ş›Á
 *
c
) {

513 
i
;

514 
robj
 *
o
;

515 
expœed
 = 0;

517 ià((
c
->
¬gc
 % 2) == 1) {

518 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for HMSET");

522 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

523 
	`lockDbWr™e
(
c
->
db
);

524 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

525 
	`uÆockDb
(
c
->
db
);

526 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

529 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,c->
¬gc
-1);

530 
i
 = 2; i < 
c
->
¬gc
; i += 2) {

531 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[
i
], &c->argv[i+1]);

532 
	`hashTy³S‘
(
o
,
c
->
¬gv
[
i
],c->argv[i+1]);

534 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

535 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

536 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

537 
c
->
v–
->
dœty
++;

539 
	`uÆockDb
(
c
->
db
);

540 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

541 
	}
}

543 
	$hšübyCommªd
(
ş›Á
 *
c
) {

544 
v®ue
, 
šü
, 
Şdv®ue
;

545 
robj
 *
o
, *
cu¼’t
, *
Ãw
;

546 
expœed
 = 0;

548 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
VR_OK
) ;

550 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

551 
	`lockDbWr™e
(
c
->
db
);

552 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
è
’d
;

553 ià((
cu¼’t
 = 
	`hashTy³G‘Objeù
(
o
,
c
->
¬gv
[2])è!ğ
NULL
) {

554 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
cu¼’t
,&
v®ue
,

555 "hash v®ui nÙ‡Àš‹g”"è!ğ
VR_OK
) {

556 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

557 
’d
;

559 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

561 
v®ue
 = 0;

564 
Şdv®ue
 = 
v®ue
;

565 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

566 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

567 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

568 
’d
;

570 
v®ue
 +ğ
šü
;

571 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

572 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2],
NULL
);

573 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],
Ãw
);

574 
	`ä“Objeù
(
Ãw
);

575 
	`addR•lyLÚgLÚg
(
c
,
v®ue
);

576 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

577 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšüby",
c
->
¬gv
[1],c->
db
->
id
);

578 
c
->
v–
->
dœty
++;

580 
’d
:

581 
	`uÆockDb
(
c
->
db
);

582 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

583 
	}
}

585 
	$hšübyæßtCommªd
(
ş›Á
 *
c
) {

586 
v®ue
, 
šü
;

587 
robj
 *
o
, *
cu¼’t
, *
Ãw
, *
aux
;

588 
expœed
 = 0;

590 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
VR_OK
) ;

592 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

593 
	`lockDbWr™e
(
c
->
db
);

594 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

595 
	`uÆockDb
(
c
->
db
);

596 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

599 ià((
cu¼’t
 = 
	`hashTy³G‘Objeù
(
o
,
c
->
¬gv
[2])è!ğ
NULL
) {

600 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
cu¼’t
,&
v®ue
,

601 "hash v®ui nÙ‡ v®id flßt"è!ğ
VR_OK
) {

602 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

603 
	`uÆockDb
(
c
->
db
);

604 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

607 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

609 
v®ue
 = 0;

612 
v®ue
 +ğ
šü
;

613 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

614 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2],
NULL
);

615 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],
Ãw
);

616 
	`addR•lyBulk
(
c
,
Ãw
);

617 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

618 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

619 
c
->
v–
->
dœty
++;

621 
	`uÆockDb
(
c
->
db
);

622 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

627 
aux
 = 
	`ü—‹SŒšgObjeù
("HSET",4);

628 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

629 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,3,
Ãw
);

630 
	}
}

632 
	$addHashF›ldToR•ly
(
ş›Á
 *
c
, 
robj
 *
o
,„obj *
f›ld
) {

633 
»t
;

635 ià(
o
 =ğ
NULL
) {

636 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

640 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

641 *
v¡r
 = 
NULL
;

642 
vËn
 = 
UINT_MAX
;

643 
vÎ
 = 
LLONG_MAX
;

645 
»t
 = 
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
);

646 ià(
»t
 < 0) {

647 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

649 ià(
v¡r
) {

650 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

652 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

656 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

657 
robj
 *
v®ue
;

659 
»t
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
v®ue
);

660 ià(
»t
 < 0) {

661 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

663 
	`addR•lyBulk
(
c
, 
v®ue
);

667 
	`£rv”Pªic
("Unknown hashƒncoding");

669 
	}
}

671 
	$hg‘Commªd
(
ş›Á
 *
c
) {

672 
robj
 *
o
;

674 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

675 
	`lockDbR—d
(
c
->
db
);

676 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

677 
	`uÆockDb
(
c
->
db
);

678 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

680 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

681 
	`uÆockDb
(
c
->
db
);

682 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

686 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[2]);

687 
	`uÆockDb
(
c
->
db
);

688 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

689 
	}
}

691 
	$hmg‘Commªd
(
ş›Á
 *
c
) {

692 
robj
 *
o
;

693 
i
;

695 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

696 
	`lockDbR—d
(
c
->
db
);

699 
o
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

700 ià(
o
 !ğ
NULL
 && o->
ty³
 !ğ
OBJ_HASH
) {

701 
	`uÆockDb
(
c
->
db
);

702 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

703 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

707 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

708 
i
 = 2; i < 
c
->
¬gc
; i++) {

709 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[
i
]);

712 ià(
o
 =ğ
NULL
) {

713 
	`uÆockDb
(
c
->
db
);

714 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

718 
	`uÆockDb
(
c
->
db
);

719 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

720 
	}
}

722 
	$hd–Commªd
(
ş›Á
 *
c
) {

723 
robj
 *
o
;

724 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

725 
expœed
 = 0;

727 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

728 
	`lockDbWr™e
(
c
->
db
);

729 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

730 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

731 
	`uÆockDb
(
c
->
db
);

732 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

736 
j
 = 2; j < 
c
->
¬gc
; j++) {

737 ià(
	`hashTy³D–‘e
(
o
,
c
->
¬gv
[
j
])) {

738 
d–‘ed
++;

739 ià(
	`hashTy³L’gth
(
o
) == 0) {

740 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

741 
key»moved
 = 1;

747 
	`uÆockDb
(
c
->
db
);

748 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

750 ià(
d–‘ed
) {

751 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

752 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hd–",
c
->
¬gv
[1],c->
db
->
id
);

753 ià(
key»moved
)

754 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

755 
c
->
db
->
id
);

756 
£rv”
.
dœty
 +ğ
d–‘ed
;

758 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

759 
	}
}

761 
	$hËnCommªd
(
ş›Á
 *
c
) {

762 
robj
 *
o
;

764 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

765 
	`lockDbR—d
(
c
->
db
);

766 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

767 
	`uÆockDb
(
c
->
db
);

768 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

770 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

771 
	`uÆockDb
(
c
->
db
);

772 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

776 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³L’gth
(
o
));

777 
	`uÆockDb
(
c
->
db
);

778 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

779 
	}
}

781 
	$h¡¾’Commªd
(
ş›Á
 *
c
) {

782 
robj
 *
o
;

784 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

785 
	`lockDbR—d
(
c
->
db
);

786 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

787 
	`uÆockDb
(
c
->
db
);

788 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

790 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

791 
	`uÆockDb
(
c
->
db
);

792 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

796 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³G‘V®ueL’gth
(
o
,c->
¬gv
[2]));

798 
	`uÆockDb
(
c
->
db
);

799 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

800 
	}
}

802 
	$addHashI‹¿tÜCursÜToR•ly
(
ş›Á
 *
c
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

803 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

804 *
v¡r
 = 
NULL
;

805 
vËn
 = 
UINT_MAX
;

806 
vÎ
 = 
LLONG_MAX
;

808 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

809 ià(
v¡r
) {

810 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

812 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

815 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

816 
robj
 *
v®ue
;

818 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
, &
v®ue
);

819 
	`addR•lyBulk
(
c
, 
v®ue
);

822 
	`£rv”Pªic
("Unknown hashƒncoding");

824 
	}
}

826 
	$g’”icHg‘®lCommªd
(
ş›Á
 *
c
, 
æags
) {

827 
robj
 *
o
;

828 
hashTy³I‹¿tÜ
 *
hi
;

829 
muÉl›r
 = 0;

830 
Ëngth
, 
couÁ
 = 0;

832 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

833 
	`lockDbR—d
(
c
->
db
);

834 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

835 
	`uÆockDb
(
c
->
db
);

836 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

838 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

839 
	`uÆockDb
(
c
->
db
);

840 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

843 ià(
æags
 & 
OBJ_HASH_KEY
è
muÉl›r
++;

844 ià(
æags
 & 
OBJ_HASH_VALUE
è
muÉl›r
++;

846 
Ëngth
 = 
	`hashTy³L’gth
(
o
è* 
muÉl›r
;

847 
	`addR•lyMuÉiBulkL’
(
c
, 
Ëngth
);

849 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

850 
	`hashTy³Next
(
hi
è!ğ
VR_ERROR
) {

851 ià(
æags
 & 
OBJ_HASH_KEY
) {

852 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_KEY
);

853 
couÁ
++;

855 ià(
æags
 & 
OBJ_HASH_VALUE
) {

856 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_VALUE
);

857 
couÁ
++;

861 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

862 
	`ASSERT
(
couÁ
 =ğ
Ëngth
);

864 
	`uÆockDb
(
c
->
db
);

865 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

866 
	}
}

868 
	$hkeysCommªd
(
ş›Á
 *
c
) {

869 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
);

870 
	}
}

872 
	$hv®sCommªd
(
ş›Á
 *
c
) {

873 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_VALUE
);

874 
	}
}

876 
	$hg‘®lCommªd
(
ş›Á
 *
c
) {

877 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
|
OBJ_HASH_VALUE
);

878 
	}
}

880 
	$hexi¡sCommªd
(
ş›Á
 *
c
) {

881 
robj
 *
o
;

883 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

884 
	`lockDbR—d
(
c
->
db
);

885 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

886 
	`uÆockDb
(
c
->
db
);

887 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

889 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

890 
	`uÆockDb
(
c
->
db
);

891 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

895 
	`addR•ly
(
c
, 
	`hashTy³Exi¡s
(
o
,c->
¬gv
[2]è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

896 
	`uÆockDb
(
c
->
db
);

897 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

898 
	}
}

900 
	$hsÿnCommªd
(
ş›Á
 *
c
) {

901 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_HASH
);

902 
	}
}

	@src/vr_t_hash.h

1 #iâdeà
_VR_T_HASH_H_


2 
	#_VR_T_HASH_H_


	)

4 
hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
);

5 
hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
);

6 
hashTy³G‘FromZli¡
(
robj
 *
o
,„obj *
f›ld
, **
v¡r
, *
vËn
, *
vÎ
);

7 
hashTy³G‘FromHashTabË
(
robj
 *
o
,„obj *
f›ld
,„obj **
v®ue
);

8 
robj
 *
hashTy³G‘Objeù
Ôobj *
o
,„obj *
f›ld
);

9 
size_t
 
hashTy³G‘V®ueL’gth
(
robj
 *
o
,„obj *
f›ld
);

10 
hashTy³Exi¡s
(
robj
 *
o
,„obj *
f›ld
);

11 
hashTy³S‘
(
robj
 *
o
,„obj *
f›ld
,„obj *
v®ue
);

12 
hashTy³D–‘e
(
robj
 *
o
,„obj *
f›ld
);

13 
hashTy³L’gth
(
robj
 *
o
);

14 
hashTy³I‹¿tÜ
 *
hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

15 
hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
);

16 
hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
);

17 
hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, **
v¡r
, *
vËn
, *
vÎ
);

18 
hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, 
robj
 **
d¡
);

19 
robj
 *
hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

20 
robj
 *
hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
,„obj *
key
, *
expœed
);

21 
hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
);

22 
hashTy³CÚv”t
(
robj
 *
o
, 
’c
);

23 
h£tCommªd
(
ş›Á
 *
c
);

24 
h£ŠxCommªd
(
ş›Á
 *
c
);

25 
hm£tCommªd
(
ş›Á
 *
c
);

26 
hšübyCommªd
(
ş›Á
 *
c
);

27 
hšübyæßtCommªd
(
ş›Á
 *
c
);

28 
hg‘Commªd
(
ş›Á
 *
c
);

29 
hmg‘Commªd
(
ş›Á
 *
c
);

30 
hd–Commªd
(
ş›Á
 *
c
);

31 
hËnCommªd
(
ş›Á
 *
c
);

32 
h¡¾’Commªd
(
ş›Á
 *
c
);

33 
g’”icHg‘®lCommªd
(
ş›Á
 *
c
, 
æags
);

34 
hkeysCommªd
(
ş›Á
 *
c
);

35 
hv®sCommªd
(
ş›Á
 *
c
);

36 
hg‘®lCommªd
(
ş›Á
 *
c
);

37 
hexi¡sCommªd
(
ş›Á
 *
c
);

38 
hsÿnCommªd
(
ş›Á
 *
c
);

	@src/vr_t_list.c

1 
	~<vr_cÜe.h
>

12 
	$li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
) {

13 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

14 
robj
 *
v®ue_Ãw
;

15 
pos
 = (
wh”e
 =ğ
LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

16 
v®ue_Ãw
 = 
	`g‘DecodedObjeù
(
v®ue
);

17 
size_t
 
Ën
 = 
	`sd¦’
(
v®ue_Ãw
->
±r
);

18 
	`quickli¡Push
(
subjeù
->
±r
, 
v®ue_Ãw
->±r, 
Ën
, 
pos
);

19 ià(
v®ue_Ãw
 !ğ
v®ue
è
	`ä“Objeù
(value_new);

21 
	`£rv”Pªic
("Unknown†istƒncoding");

23 
	}
}

25 *
	$li¡PİSav”
(*
d©a
, 
sz
) {

26  
	`ü—‹SŒšgObjeù
((*)
d©a
,
sz
);

27 
	}
}

29 
robj
 *
	$li¡Ty³Pİ
(
robj
 *
subjeù
, 
wh”e
) {

30 
vlÚg
;

31 
robj
 *
v®ue
 = 
NULL
;

33 
ql_wh”e
 = 
wh”e
 =ğ
LIST_HEAD
 ? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

34 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

35 ià(
	`quickli¡PİCu¡om
(
subjeù
->
±r
, 
ql_wh”e
, (**)&
v®ue
,

36 
NULL
, &
vlÚg
, 
li¡PİSav”
)) {

37 ià(!
v®ue
)

38 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

41 
	`£rv”Pªic
("Unknown†istƒncoding");

43  
v®ue
;

44 
	}
}

46 
	$li¡Ty³L’gth
(
robj
 *
subjeù
) {

47 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

48  
	`quickli¡CouÁ
(
subjeù
->
±r
);

50 
	`£rv”Pªic
("Unknown†istƒncoding");

52 
	}
}

55 
li¡Ty³I‹¿tÜ
 *
	$li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
,

56 
dœeùiÚ
) {

57 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`d®loc
((listTypeIterator));

58 
li
->
subjeù
 = subject;

59 
li
->
’codšg
 = 
subjeù
->encoding;

60 
li
->
dœeùiÚ
 = direction;

61 
li
->
™”
 = 
NULL
;

64 
™”_dœeùiÚ
 =

65 
dœeùiÚ
 =ğ
LIST_HEAD
 ? 
AL_START_TAIL
 : 
AL_START_HEAD
;

66 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

67 
li
->
™”
 = 
	`quickli¡G‘I‹¿tÜAtIdx
Öi->
subjeù
->
±r
,

68 
™”_dœeùiÚ
, 
šdex
);

70 
	`£rv”Pªic
("Unknown†istƒncoding");

72  
li
;

73 
	}
}

76 
	$li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
) {

77 
	`dä“
(
li
->
™”
);

78 
	`dä“
(
li
);

79 
	}
}

84 
	$li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
) {

86 
	`ASSERT
(
li
->
subjeù
->
’codšg
 ==†i->encoding);

88 
’Œy
->
li
 =†i;

89 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

90  
	`quickli¡Next
(
li
->
™”
, &
’Œy
->entry);

92 
	`£rv”Pªic
("Unknown†istƒncoding");

95 
	}
}

98 
robj
 *
	$li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
) {

99 
robj
 *
v®ue
 = 
NULL
;

100 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

101 ià(
’Œy
->’Œy.
v®ue
) {

102 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
->entry.value,

103 
’Œy
->’Œy.
sz
);

105 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
->’Œy.
lÚgv®
);

108 
	`£rv”Pªic
("Unknown†istƒncoding");

110  
v®ue
;

111 
	}
}

113 
	$li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
) {

114 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

115 
v®ue
 = 
	`g‘DecodedObjeù
(value);

116 
sds
 
¡r
 = 
v®ue
->
±r
;

117 
size_t
 
Ën
 = 
	`sd¦’
(
¡r
);

118 ià(
wh”e
 =ğ
LIST_TAIL
) {

119 
	`quickli¡In£¹Aá”
((
quickli¡
 *)
’Œy
->entry.quicklist,

120 &
’Œy
->’Œy, 
¡r
, 
Ën
);

121 } ià(
wh”e
 =ğ
LIST_HEAD
) {

122 
	`quickli¡In£¹BefÜe
((
quickli¡
 *)
’Œy
->entry.quicklist,

123 &
’Œy
->’Œy, 
¡r
, 
Ën
);

125 
	`deüRefCouÁ
(
v®ue
);

127 
	`£rv”Pªic
("Unknown†istƒncoding");

129 
	}
}

132 
	$li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
) {

133 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

134 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,
	`sdsEncodedObjeù
(o));

135  
	`quickli¡Com·»
(
’Œy
->’Œy.
zi
,
o
->
±r
,
	`sd¦’
(o->ptr));

137 
	`£rv”Pªic
("Unknown†istƒncoding");

139 
	}
}

142 
	$li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
) {

143 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

144 
	`quickli¡D–EÁry
(
™”
->™”, &
’Œy
->entry);

146 
	`£rv”Pªic
("Unknown†istƒncoding");

148 
	}
}

151 
	$li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
) {

152 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
ty³
==
OBJ_LIST
);

153 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
’codšg
==
OBJ_ENCODING_ZIPLIST
);

155 ià(
’c
 =ğ
OBJ_ENCODING_QUICKLIST
) {

156 
size_t
 
zËn
 = 
£rv”
.
li¡_max_zli¡_size
;

157 
d•th
 = 
£rv”
.
li¡_com´ess_d•th
;

158 
subjeù
->
±r
 = 
	`quickli¡C»©eFromZli¡
(
zËn
, 
d•th
, subject->ptr);

159 
subjeù
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

161 
	`£rv”Pªic
("Unsupported†ist conversion");

163 
	}
}

169 
	$pushG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

170 
j
, 
wa™šg
 = 0, 
pushed
 = 0;

171 
robj
 *
lobj
;

172 
expœed
 = 0;

174 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

175 
	`lockDbWr™e
(
c
->
db
);

176 
lobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

177 ià(
lobj
 &&†obj->
ty³
 !ğ
OBJ_LIST
) {

178 
	`uÆockDb
(
c
->
db
);

179 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

180 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

184 
j
 = 2; j < 
c
->
¬gc
; j++) {

185 
c
->
¬gv
[
j
] = 
	`ŒyObjeùEncodšg
(c->argv[j]);

186 ià(!
lobj
) {

187 
lobj
 = 
	`ü—‹Quickli¡Objeù
();

188 
	`quickli¡S‘O±iÚs
(
lobj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

189 
£rv”
.
li¡_com´ess_d•th
);

190 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
lobj
);

192 
	`li¡Ty³Push
(
lobj
,
c
->
¬gv
[
j
],
wh”e
);

193 
pushed
++;

195 
	`addR•lyLÚgLÚg
(
c
, 
wa™šg
 + (
lobj
 ? 
	`li¡Ty³L’gth
(lobj) : 0));

196 ià(
pushed
) {

197 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

199 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

200 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

202 
c
->
v–
->
dœty
 +ğ
pushed
;

204 
	`uÆockDb
(
c
->
db
);

205 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

206 
	}
}

208 
	$ÍushCommªd
(
ş›Á
 *
c
) {

209 
	`pushG’”icCommªd
(
c
,
LIST_HEAD
);

210 
	}
}

212 
	$½ushCommªd
(
ş›Á
 *
c
) {

213 
	`pushG’”icCommªd
(
c
,
LIST_TAIL
);

214 
	}
}

216 
	$pushxG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
»fv®
,„obj *
v®
, 
wh”e
) {

217 
robj
 *
subjeù
;

218 
li¡Ty³I‹¿tÜ
 *
™”
;

219 
li¡Ty³EÁry
 
’Œy
;

220 
š£¹ed
 = 0;

222 ià((
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,
NULL
)) == NULL ||

223 
	`checkTy³
(
c
,
subjeù
,
OBJ_LIST
)) ;

225 ià(
»fv®
 !ğ
NULL
) {

227 
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

228 
	`li¡Ty³Next
(
™”
,&
’Œy
)) {

229 ià(
	`li¡Ty³Equ®
(&
’Œy
,
»fv®
)) {

230 
	`li¡Ty³In£¹
(&
’Œy
,
v®
,
wh”e
);

231 
š£¹ed
 = 1;

235 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

237 ià(
š£¹ed
) {

238 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

239 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"linsert",

240 
c
->
¬gv
[1],c->
db
->
id
);

241 
£rv”
.
dœty
++;

244 
	`addR•ly
(
c
,
sh¬ed
.
úegÚe
);

248 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

250 
	`li¡Ty³Push
(
subjeù
,
v®
,
wh”e
);

251 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

252 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

253 
£rv”
.
dœty
++;

256 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

257 
	}
}

259 
	$ÍushxCommªd
(
ş›Á
 *
c
) {

260 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

261 
	`pushxG’”icCommªd
(
c
,
NULL
,c->
¬gv
[2],
LIST_HEAD
);

262 
	}
}

264 
	$½ushxCommªd
(
ş›Á
 *
c
) {

265 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

266 
	`pushxG’”icCommªd
(
c
,
NULL
,c->
¬gv
[2],
LIST_TAIL
);

267 
	}
}

269 
	$lš£¹Commªd
(
ş›Á
 *
c
) {

270 
c
->
¬gv
[4] = 
	`ŒyObjeùEncodšg
(c->argv[4]);

271 ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"after") == 0) {

272 
	`pushxG’”icCommªd
(
c
,c->
¬gv
[3],c->¬gv[4],
LIST_TAIL
);

273 } ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"before") == 0) {

274 
	`pushxG’”icCommªd
(
c
,c->
¬gv
[3],c->¬gv[4],
LIST_HEAD
);

276 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

278 
	}
}

280 
	$Î’Commªd
(
ş›Á
 *
c
) {

281 
robj
 *
o
;

283 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

284 
	`lockDbR—d
(
c
->
db
);

285 
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

286 ià(
o
 =ğ
NULL
) {

287 
	`uÆockDb
(
c
->
db
);

288 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

290 } if(
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

291 
	`uÆockDb
(
c
->
db
);

292 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

296 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
o
));

297 
	`uÆockDb
(
c
->
db
);

298 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

299 
	}
}

301 
	$lšdexCommªd
(
ş›Á
 *
c
) {

302 
robj
 *
o
;

303 
šdex
;

304 
robj
 *
v®ue
 = 
NULL
;

306 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
VR_OK
))

309 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[1]);

310 
	`lockDbR—d
(
c
->
db
);

311 
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

312 ià(
o
 =ğ
NULL
) {

313 
	`uÆockDb
(
c
->
db
);

314 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

316 } if(
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

317 
	`uÆockDb
(
c
->
db
);

318 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

321 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

322 
quickli¡EÁry
 
’Œy
;

323 ià(
	`quickli¡Index
(
o
->
±r
, 
šdex
, &
’Œy
)) {

324 ià(
’Œy
.
v®ue
) {

325 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
.v®ue,’Œy.
sz
);

327 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
.
lÚgv®
);

329 
	`addR•lyBulk
(
c
,
v®ue
);

330 
	`ä“Objeù
(
v®ue
);

332 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

335 
	`£rv”Pªic
("Unknown†istƒncoding");

337 
	`uÆockDb
(
c
->
db
);

338 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

339 
	}
}

341 
	$l£tCommªd
(
ş›Á
 *
c
) {

342 
robj
 *
o
;

343 
šdex
;

344 
robj
 *
v®ue
 = 
c
->
¬gv
[3];

345 
expœed
 = 0;

347 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
VR_OK
))

350 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

351 
	`lockDbWr™e
(
c
->
db
);

352 
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
,&
expœed
);

353 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) {

354 
	`uÆockDb
(
c
->
db
);

355 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

358 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

359 
quickli¡
 *
ql
 = 
o
->
±r
;

360 
»¶aûd
 = 
	`quickli¡R•ÏûAtIndex
(
ql
, 
šdex
,

361 
v®ue
->
±r
, 
	`sd¦’
(value->ptr));

362 ià(!
»¶aûd
) {

363 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

365 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

366 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

367 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"l£t",
c
->
¬gv
[1],c->
db
->
id
);

368 
c
->
v–
->
dœty
++;

371 
	`£rv”Pªic
("Unknown†istƒncoding");

374 
	`uÆockDb
(
c
->
db
);

375 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

376 
	}
}

378 
	$pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

379 
robj
 *
o
, *
v®ue
;

380 
expœed
 = 0;

382 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

383 
	`lockDbWr™e
(
c
->
db
);

384 
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
,&
expœed
);

385 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) {

386 
	`uÆockDb
(
c
->
db
);

387 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

391 
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

392 ià(
v®ue
 =ğ
NULL
) {

393 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

395 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

397 
	`addR•lyBulk
(
c
,
v®ue
);

398 
	`ä“Objeù
(
v®ue
);

399 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

400 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

401 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

402 
c
->
¬gv
[1],c->
db
->
id
);

403 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

405 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

406 
c
->
v–
->
dœty
++;

408 
	`uÆockDb
(
c
->
db
);

409 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

410 
	}
}

412 
	$ÍİCommªd
(
ş›Á
 *
c
) {

413 
	`pİG’”icCommªd
(
c
,
LIST_HEAD
);

414 
	}
}

416 
	$½İCommªd
(
ş›Á
 *
c
) {

417 
	`pİG’”icCommªd
(
c
,
LIST_TAIL
);

418 
	}
}

420 
	$ÌªgeCommªd
(
ş›Á
 *
c
) {

421 
robj
 *
o
;

422 
¡¬t
, 
’d
, 
Î’
, 
¿ng–’
;

424 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
VR_OK
) ||

425 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
VR_OK
)) ;

427 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

428 
	`lockDbR—d
(
c
->
db
);

429 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

430 
	`uÆockDb
(
c
->
db
);

431 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

433 } ià(
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

434 
	`uÆockDb
(
c
->
db
);

435 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

439 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

442 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

443 ià(
’d
 < 0è’d = 
Î’
+end;

444 ià(
¡¬t
 < 0) start = 0;

448 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

449 
	`uÆockDb
(
c
->
db
);

450 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

451 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

454 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

455 
¿ng–’
 = (
’d
-
¡¬t
)+1;

458 
	`addR•lyMuÉiBulkL’
(
c
,
¿ng–’
);

459 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

460 
li¡Ty³I‹¿tÜ
 *
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
, 
¡¬t
, 
LIST_TAIL
);

462 
¿ng–’
--) {

463 
li¡Ty³EÁry
 
’Œy
;

464 
	`li¡Ty³Next
(
™”
, &
’Œy
);

465 
quickli¡EÁry
 *
qe
 = &
’Œy
.entry;

466 ià(
qe
->
v®ue
) {

467 
	`addR•lyBulkCBufãr
(
c
,
qe
->
v®ue
,qe->
sz
);

469 
	`addR•lyBulkLÚgLÚg
(
c
,
qe
->
lÚgv®
);

472 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

474 
	`£rv”Pªic
("Listƒncoding is‚ot QUICKLIST!");

477 
	`uÆockDb
(
c
->
db
);

478 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

479 
	}
}

481 
	$ÉrimCommªd
(
ş›Á
 *
c
) {

482 
robj
 *
o
;

483 
¡¬t
, 
’d
, 
Î’
, 
Érim
, 
¹rim
;

484 
expœed
 = 0;

486 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
VR_OK
) ||

487 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
VR_OK
)) ;

489 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

490 
	`lockDbWr™e
(
c
->
db
);

491 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
ok
,&
expœed
)è=ğ
NULL
 ||

492 
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

493 
	`uÆockDb
(
c
->
db
);

494 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

497 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

500 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

501 ià(
’d
 < 0è’d = 
Î’
+end;

502 ià(
¡¬t
 < 0) start = 0;

506 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

508 
Érim
 = 
Î’
;

509 
¹rim
 = 0;

511 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

512 
Érim
 = 
¡¬t
;

513 
¹rim
 = 
Î’
-
’d
-1;

517 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

518 
	`quickli¡D–Rªge
(
o
->
±r
,0,
Érim
);

519 
	`quickli¡D–Rªge
(
o
->
±r
,-
¹rim
,rtrim);

521 
	`£rv”Pªic
("Unknown†istƒncoding");

524 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Érim",
c
->
¬gv
[1],c->
db
->
id
);

525 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

526 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

527 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

529 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

530 
c
->
v–
->
dœty
++;

531 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

532 
	`uÆockDb
(
c
->
db
);

533 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

534 
	}
}

536 
	$ÌemCommªd
(
ş›Á
 *
c
) {

537 
robj
 *
subjeù
, *
obj
;

538 
obj
 = 
c
->
¬gv
[3];

539 
tÜemove
;

540 
»moved
 = 0;

541 
expœed
 = 0;

543 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
tÜemove
, 
NULL
è!ğ
VR_OK
))

546 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

547 
	`lockDbWr™e
(
c
->
db
);

548 
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,&
expœed
);

549 ià(
subjeù
 =ğ
NULL
 || 
	`checkTy³
(
c
,subjeù,
OBJ_LIST
)) {

550 
	`uÆockDb
(
c
->
db
);

551 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

554 
li¡Ty³I‹¿tÜ
 *
li
;

555 ià(
tÜemove
 < 0) {

556 
tÜemove
 = -toremove;

557 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,-1,
LIST_HEAD
);

559 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

562 
li¡Ty³EÁry
 
’Œy
;

563 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

564 ià(
	`li¡Ty³Equ®
(&
’Œy
,
obj
)) {

565 
	`li¡Ty³D–‘e
(
li
, &
’Œy
);

566 
c
->
v–
->
dœty
++;

567 
»moved
++;

568 ià(
tÜemove
 && 
»moved
 ==oremove) ;

571 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

573 ià(
»moved
) {

574 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

575 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"Ìem",
c
->
¬gv
[1],c->
db
->
id
);

578 ià(
	`li¡Ty³L’gth
(
subjeù
) == 0) {

579 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

580 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

583 
	`addR•lyLÚgLÚg
(
c
,
»moved
);

584 
	`uÆockDb
(
c
->
db
);

585 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

586 
	}
}

604 
	$½İÍushHªdËPush
(
ş›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
) {

606 ià(!
d¡obj
) {

607 
d¡obj
 = 
	`ü—‹Quickli¡Objeù
();

608 
	`quickli¡S‘O±iÚs
(
d¡obj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

609 
£rv”
.
li¡_com´ess_d•th
);

610 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

612 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

613 
	`li¡Ty³Push
(
d¡obj
,
v®ue
,
LIST_HEAD
);

614 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Íush",
d¡key
,
c
->
db
->
id
);

616 
	`addR•lyBulk
(
c
,
v®ue
);

617 
	}
}

619 
	$½İÍushCommªd
(
ş›Á
 *
c
) {

620 
robj
 *
sobj
, *
v®ue
;

621 ià((
sobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
,
NULL
)) == NULL ||

622 
	`checkTy³
(
c
,
sobj
,
OBJ_LIST
)) ;

624 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

627 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

629 
robj
 *
dobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
);

630 
robj
 *
touchedkey
 = 
c
->
¬gv
[1];

632 ià(
dobj
 && 
	`checkTy³
(
c
,dobj,
OBJ_LIST
)) ;

633 
v®ue
 = 
	`li¡Ty³Pİ
(
sobj
,
LIST_TAIL
);

637 
	`šüRefCouÁ
(
touchedkey
);

638 
	`½İÍushHªdËPush
(
c
,c->
¬gv
[2],
dobj
,
v®ue
);

641 
	`deüRefCouÁ
(
v®ue
);

644 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"½İ",
touchedkey
,
c
->
db
->
id
);

645 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

646 
	`dbD–‘e
(
c
->
db
,
touchedkey
);

647 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

648 
touchedkey
,
c
->
db
->
id
);

650 
	`sigÇlModif›dKey
(
c
->
db
,
touchedkey
);

651 
	`deüRefCouÁ
(
touchedkey
);

652 
£rv”
.
dœty
++;

654 
	}
}

679 
	$blockFÜKeys
(
ş›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
) {

680 
diùEÁry
 *
de
;

681 
dli¡
 *
l
;

682 
j
;

684 
c
->
bpİ
.
timeout
 =imeout;

685 
c
->
bpİ
.
rg‘
 =arget;

687 ià(
rg‘
 !ğ
NULL
è
	`šüRefCouÁ
(target);

689 
j
 = 0; j < 
numkeys
; j++) {

691 ià(
	`diùAdd
(
c
->
bpİ
.
keys
,keys[
j
],
NULL
è!ğ
DICT_OK
) ;

692 
	`šüRefCouÁ
(
keys
[
j
]);

695 
de
 = 
	`diùFšd
(
c
->
db
->
blockšg_keys
,
keys
[
j
]);

696 ià(
de
 =ğ
NULL
) {

697 
»tv®
;

700 
l
 = 
	`dli¡C»©e
();

701 
»tv®
 = 
	`diùAdd
(
c
->
db
->
blockšg_keys
,
keys
[
j
],
l
);

702 
	`šüRefCouÁ
(
keys
[
j
]);

703 
	`£rv”As£¹W™hInfo
(
c
,
keys
[
j
],
»tv®
 =ğ
DICT_OK
);

705 
l
 = 
	`diùG‘V®
(
de
);

707 
	`dli¡AddNodeTa
(
l
,
c
);

709 
	`blockCl›Á
(
c
,
BLOCKED_LIST
);

710 
	}
}

714 
	$unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
) {

715 
diùEÁry
 *
de
;

716 
diùI‹¿tÜ
 *
di
;

717 
dli¡
 *
l
;

719 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`diùSize
(c->
bpİ
.
keys
) != 0);

720 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

722 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

723 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

726 
l
 = 
	`diùF‘chV®ue
(
c
->
db
->
blockšg_keys
,
key
);

727 
	`£rv”As£¹W™hInfo
(
c
,
key
,
l
 !ğ
NULL
);

728 
	`dli¡D–Node
(
l
,
	`dli¡S—rchKey
Ö,
c
));

730 ià(
	`dli¡L’gth
(
l
) == 0)

731 
	`diùD–‘e
(
c
->
db
->
blockšg_keys
,
key
);

733 
	`diùR–—£I‹¿tÜ
(
di
);

736 
	`diùEm±y
(
c
->
bpİ
.
keys
,
NULL
);

737 ià(
c
->
bpİ
.
rg‘
) {

738 
	`deüRefCouÁ
(
c
->
bpİ
.
rg‘
);

739 
c
->
bpİ
.
rg‘
 = 
NULL
;

741 
	}
}

750 
	$sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
) {

751 
»t
;

752 
»adyLi¡
 *
¾
;

755 ià(
	`diùFšd
(
db
->
blockšg_keys
,
key
è=ğ
NULL
) ;

758 ià(
	`diùFšd
(
db
->
»ady_keys
,
key
è!ğ
NULL
) ;

761 
¾
 = 
	`d®loc
((*rl));

762 
¾
->
key
 = key;

763 
¾
->
db
 = db;

764 
	`šüRefCouÁ
(
key
);

765 
	`dli¡AddNodeTa
(
£rv”
.
»ady_keys
,
¾
);

770 
	`šüRefCouÁ
(
key
);

771 
»t
 = 
	`diùAdd
(
db
->
»ady_keys
,
key
,
NULL
);

772 
	`ASSERT
(
»t
 =ğ
DICT_OK
);

773 
	}
}

794 
	$£rveCl›ÁBlockedOnLi¡
(
ş›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
)

796 
robj
 *
¬gv
[3];

798 ià(
d¡key
 =ğ
NULL
) {

800 
¬gv
[0] = (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 :

801 
sh¬ed
.
½İ
;

802 
¬gv
[1] = 
key
;

803 
	`´İag©e
((
wh”e
 =ğ
LIST_HEAD
) ?

804 
£rv”
.
ÍİCommªd
 : s”v”.
½İCommªd
,

805 
db
->
id
,
¬gv
,2,
PROPAGATE_AOF
|
PROPAGATE_REPL
);

808 
	`addR•lyMuÉiBulkL’
(
»ûiv”
,2);

809 
	`addR•lyBulk
(
»ûiv”
,
key
);

810 
	`addR•lyBulk
(
»ûiv”
,
v®ue
);

813 
robj
 *
d¡obj
 =

814 
	`lookupKeyWr™e
(
»ûiv”
->
db
,
d¡key
,
NULL
);

815 ià(!(
d¡obj
 &&

816 
	`checkTy³
(
»ûiv”
,
d¡obj
,
OBJ_LIST
)))

819 
¬gv
[0] = 
sh¬ed
.
½İ
;

820 
¬gv
[1] = 
key
;

821 
	`´İag©e
(
£rv”
.
½İCommªd
,

822 
db
->
id
,
¬gv
,2,

823 
PROPAGATE_AOF
|

824 
PROPAGATE_REPL
);

825 
	`½İÍushHªdËPush
(
»ûiv”
,
d¡key
,
d¡obj
,

826 
v®ue
);

828 
¬gv
[0] = 
sh¬ed
.
Íush
;

829 
¬gv
[1] = 
d¡key
;

830 
¬gv
[2] = 
v®ue
;

831 
	`´İag©e
(
£rv”
.
ÍushCommªd
,

832 
db
->
id
,
¬gv
,3,

833 
PROPAGATE_AOF
|

834 
PROPAGATE_REPL
);

838  
VR_ERROR
;

841  
VR_OK
;

842 
	}
}

854 
	$hªdËCl›ÁsBlockedOnLi¡s
() {

855 
	`dli¡L’gth
(
£rv”
.
»ady_keys
) != 0) {

856 
dli¡
 *
l
;

862 
l
 = 
£rv”
.
»ady_keys
;

863 
£rv”
.
»ady_keys
 = 
	`dli¡C»©e
();

865 
	`dli¡L’gth
(
l
) != 0) {

866 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
l
);

867 
»adyLi¡
 *
¾
 = 
Ê
->
v®ue
;

871 
	`diùD–‘e
(
¾
->
db
->
»ady_keys
,¾->
key
);

875 
robj
 *
o
 = 
	`lookupKeyWr™e
(
¾
->
db
,¾->
key
,
NULL
);

876 ià(
o
 !ğ
NULL
 && o->
ty³
 =ğ
OBJ_LIST
) {

877 
diùEÁry
 *
de
;

881 
de
 = 
	`diùFšd
(
¾
->
db
->
blockšg_keys
,¾->
key
);

882 ià(
de
) {

883 
dli¡
 *
ş›Ás
 = 
	`diùG‘V®
(
de
);

884 
numş›Ás
 = 
	`dli¡L’gth
(
ş›Ás
);

886 
numş›Ás
--) {

887 
dli¡Node
 *
ş›Ánode
 = 
	`dli¡Fœ¡
(
ş›Ás
);

888 
ş›Á
 *
»ûiv”
 = 
ş›Ánode
->
v®ue
;

889 
robj
 *
d¡key
 = 
»ûiv”
->
bpİ
.
rg‘
;

890 
wh”e
 = (
»ûiv”
->
Ï¡cmd
 &&

891 
»ûiv”
->
Ï¡cmd
->
´oc
 =ğ
bÍİCommªd
) ?

892 
LIST_HEAD
 : 
LIST_TAIL
;

893 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

895 ià(
v®ue
) {

899 ià(
d¡key
è
	`šüRefCouÁ
(dstkey);

900 
	`unblockCl›Á
(
»ûiv”
);

902 ià(
	`£rveCl›ÁBlockedOnLi¡
(
»ûiv”
,

903 
¾
->
key
,
d¡key
,¾->
db
,
v®ue
,

904 
wh”e
è=ğ
VR_ERROR
)

908 
	`li¡Ty³Push
(
o
,
v®ue
,
wh”e
);

911 ià(
d¡key
è
	`deüRefCouÁ
(dstkey);

912 
	`deüRefCouÁ
(
v®ue
);

919 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

920 
	`dbD–‘e
(
¾
->
db
,¾->
key
);

927 
	`deüRefCouÁ
(
¾
->
key
);

928 
	`dä“
(
¾
);

929 
	`dli¡D–Node
(
l
,
Ê
);

931 
	`dli¡R–—£
(
l
);

933 
	}
}

936 
	$blockšgPİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

937 
robj
 *
o
;

938 
m¡ime_t
 
timeout
;

939 
j
;

941 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[c->
¬gc
-1],&
timeout
,
UNIT_SECONDS
)

942 !ğ
VR_OK
) ;

944 
j
 = 1; j < 
c
->
¬gc
-1; j++) {

945 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
],
NULL
);

946 ià(
o
 !ğ
NULL
) {

947 ià(
o
->
ty³
 !ğ
OBJ_LIST
) {

948 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

951 ià(
	`li¡Ty³L’gth
(
o
) != 0) {

953 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

954 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

955 
	`ASSERT
(
v®ue
 !ğ
NULL
);

957 
	`addR•lyMuÉiBulkL’
(
c
,2);

958 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

959 
	`addR•lyBulk
(
c
,
v®ue
);

960 
	`deüRefCouÁ
(
v®ue
);

961 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,

962 
c
->
¬gv
[
j
],c->
db
->
id
);

963 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

964 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

965 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

966 
c
->
¬gv
[
j
],c->
db
->
id
);

968 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

969 
£rv”
.
dœty
++;

972 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,

973 (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 : sh¬ed.
½İ
,

974 
c
->
¬gv
[
j
]);

983 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

984 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

989 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, c->
¬gc
 - 2, 
timeout
, 
NULL
);

990 
	}
}

992 
	$bÍİCommªd
(
ş›Á
 *
c
) {

993 
	`blockšgPİG’”icCommªd
(
c
,
LIST_HEAD
);

994 
	}
}

996 
	$b½İCommªd
(
ş›Á
 *
c
) {

997 
	`blockšgPİG’”icCommªd
(
c
,
LIST_TAIL
);

998 
	}
}

1000 
	$b½İÍushCommªd
(
ş›Á
 *
c
) {

1001 
m¡ime_t
 
timeout
;

1003 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
timeout
,
UNIT_SECONDS
)

1004 !ğ
VR_OK
) ;

1006 
robj
 *
key
 = 
	`lookupKeyWr™e
(
c
->
db
, c->
¬gv
[1],
NULL
);

1008 ià(
key
 =ğ
NULL
) {

1009 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

1012 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

1015 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, 1, 
timeout
, c->argv[2]);

1018 ià(
key
->
ty³
 !ğ
OBJ_LIST
) {

1019 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

1023 
	`£rv”As£¹W™hInfo
(
c
,
key
,
	`li¡Ty³L’gth
(key) > 0);

1024 
	`½İÍushCommªd
(
c
);

1027 
	}
}

	@src/vr_t_list.h

1 #iâdeà
_VR_T_LIST_H_


2 
	#_VR_T_LIST_H_


	)

4 
li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
);

5 *
li¡PİSav”
(*
d©a
, 
sz
);

6 
robj
 *
li¡Ty³Pİ
Ôobj *
subjeù
, 
wh”e
);

7 
li¡Ty³L’gth
(
robj
 *
subjeù
);

8 
li¡Ty³I‹¿tÜ
 *
li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
, 
dœeùiÚ
);

9 
li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
);

10 
li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
);

11 
robj
 *
li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
);

12 
li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
);

13 
li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
);

14 
li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
);

15 
li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
);

16 
pushG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

17 
ÍushCommªd
(
ş›Á
 *
c
);

18 
½ushCommªd
(
ş›Á
 *
c
);

19 
pushxG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
»fv®
,„obj *
v®
, 
wh”e
);

20 
ÍushxCommªd
(
ş›Á
 *
c
);

21 
½ushxCommªd
(
ş›Á
 *
c
);

22 
lš£¹Commªd
(
ş›Á
 *
c
);

23 
Î’Commªd
(
ş›Á
 *
c
);

24 
lšdexCommªd
(
ş›Á
 *
c
);

25 
l£tCommªd
(
ş›Á
 *
c
);

26 
pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

27 
ÍİCommªd
(
ş›Á
 *
c
);

28 
½İCommªd
(
ş›Á
 *
c
);

29 
ÌªgeCommªd
(
ş›Á
 *
c
);

30 
ÉrimCommªd
(
ş›Á
 *
c
);

31 
ÌemCommªd
(
ş›Á
 *
c
);

32 
½İÍushHªdËPush
(
ş›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
);

33 
½İÍushCommªd
(
ş›Á
 *
c
);

34 
blockFÜKeys
(
ş›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
);

35 
unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
);

36 
sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
);

37 
£rveCl›ÁBlockedOnLi¡
(
ş›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
);

38 
hªdËCl›ÁsBlockedOnLi¡s
();

39 
blockšgPİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

40 
bÍİCommªd
(
ş›Á
 *
c
);

41 
b½İCommªd
(
ş›Á
 *
c
);

42 
b½İÍushCommªd
(
ş›Á
 *
c
);

	@src/vr_t_set.c

1 
	~<vr_cÜe.h
>

7 
suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

8 
robj
 *
d¡key
, 
İ
);

13 
robj
 *
	$£tTy³C»©e
(
robj
 *
v®ue
) {

14 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,
NULL
è=ğ
VR_OK
)

15  
	`ü—‹IÁ£tObjeù
();

16  
	`ü—‹S‘Objeù
();

17 
	}
}

24 
	$£tTy³Add
(
robj
 *
subjeù
,„obj *
v®ue
) {

25 
Îv®
;

26 
robj
 *
obj
;

27 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

28 
obj
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
v®ue
);

29 ià(
	`diùAdd
(
subjeù
->
±r
,
obj
,
NULL
è=ğ
DICT_OK
) {

32 
	`ä“Objeù
(
obj
);

34 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

35 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
VR_OK
) {

36 
ušt8_t
 
sucûss
 = 0;

37 
subjeù
->
±r
 = 
	`št£tAdd
(subjeù->±r,
Îv®
,&
sucûss
);

38 ià(
sucûss
) {

41 ià(
	`št£tL’
(
subjeù
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

42 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

47 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

48 
obj
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
v®ue
);

51 
	`£rv”As£¹W™hInfo
(
NULL
,
obj
,

52 
	`diùAdd
(
subjeù
->
±r
,
obj
,
NULL
è=ğ
DICT_OK
);

56 
	`£rv”Pªic
("Unknown setƒncoding");

59 
	}
}

61 
	$£tTy³Remove
(
robj
 *
£tobj
,„obj *
v®ue
) {

62 
Îv®
;

63 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

64 ià(
	`diùD–‘e
(
£tobj
->
±r
,
v®ue
è=ğ
DICT_OK
) {

65 ià(
	`htN“dsResize
(
£tobj
->
±r
)è
	`diùResize
(setobj->ptr);

68 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

69 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
VR_OK
) {

70 
sucûss
;

71 
£tobj
->
±r
 = 
	`št£tRemove
(£tobj->±r,
Îv®
,&
sucûss
);

72 ià(
sucûss
)  1;

75 
	`£rv”Pªic
("Unknown setƒncoding");

78 
	}
}

80 
	$£tTy³IsMemb”
(
robj
 *
subjeù
,„obj *
v®ue
) {

81 
Îv®
;

82 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

83  
	`diùFšd
((
diù
*)
subjeù
->
±r
,
v®ue
è!ğ
NULL
;

84 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

85 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
VR_OK
) {

86  
	`št£tFšd
((
št£t
*)
subjeù
->
±r
,
Îv®
);

89 
	`£rv”Pªic
("Unknown setƒncoding");

92 
	}
}

94 
£tTy³I‹¿tÜ
 *
	$£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

95 
£tTy³I‹¿tÜ
 *
si
 = 
	`d®loc
((setTypeIterator));

96 
si
->
subjeù
 = subject;

97 
si
->
’codšg
 = 
subjeù
->encoding;

98 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

99 
si
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

100 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

101 
si
->
ii
 = 0;

103 
	`£rv”Pªic
("Unknown setƒncoding");

105  
si
;

106 
	}
}

108 
	$£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
) {

109 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

110 
	`diùR–—£I‹¿tÜ
(
si
->
di
);

111 
	`dä“
(
si
);

112 
	}
}

129 
	$£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
robj
 **
obj–e
, 
št64_t
 *
Î–e
) {

130 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

131 
diùEÁry
 *
de
 = 
	`diùNext
(
si
->
di
);

132 ià(
de
 =ğ
NULL
)  -1;

133 *
obj–e
 = 
	`diùG‘Key
(
de
);

134 *
Î–e
 = -123456789;

135 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

136 ià(!
	`št£tG‘
(
si
->
subjeù
->
±r
,si->
ii
++,
Î–e
))

138 *
obj–e
 = 
NULL
;

140 
	`£rv”Pªic
("Wrong setƒncoding in setTypeNext");

142  
si
->
’codšg
;

143 
	}
}

153 
robj
 *
	$£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
) {

154 
št64_t
 
š‹Ë
;

155 
robj
 *
obj–e
;

156 
’codšg
;

158 
’codšg
 = 
	`£tTy³Next
(
si
,&
obj–e
,&
š‹Ë
);

159 
’codšg
) {

160 -1:  
NULL
;

161 
OBJ_ENCODING_INTSET
:

162  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
š‹Ë
);

163 
OBJ_ENCODING_HT
:

164  
obj–e
;

166 
	`£rv”Pªic
("Unsupportedƒncoding");

168  
NULL
;

169 
	}
}

188 
	$£tTy³RªdomEËm’t
(
robj
 *
£tobj
,„obj **
obj–e
, 
št64_t
 *
Î–e
) {

189 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

190 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£tobj
->
±r
);

191 *
obj–e
 = 
	`diùG‘Key
(
de
);

192 *
Î–e
 = -123456789;

193 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

194 *
Î–e
 = 
	`št£tRªdom
(
£tobj
->
±r
);

195 *
obj–e
 = 
NULL
;

197 
	`£rv”Pªic
("Unknown setƒncoding");

199  
£tobj
->
’codšg
;

200 
	}
}

202 
	$£tTy³Size
(
robj
 *
subjeù
) {

203 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

204  
	`diùSize
((
diù
*)
subjeù
->
±r
);

205 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

206  
	`št£tL’
((
št£t
*)
subjeù
->
±r
);

208 
	`£rv”Pªic
("Unknown setƒncoding");

210 
	}
}

215 
	$£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
) {

216 
£tTy³I‹¿tÜ
 *
si
;

217 
	`£rv”As£¹W™hInfo
(
NULL
,
£tobj
,£tobj->
ty³
 =ğ
OBJ_SET
 &&

218 
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
);

220 ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

221 
št64_t
 
š‹Ë
;

222 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

223 
robj
 *
–em’t
;

226 
	`diùEx·nd
(
d
,
	`št£tL’
(
£tobj
->
±r
));

229 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

230 
	`£tTy³Next
(
si
,&
–em’t
,&
š‹Ë
) != -1) {

231 
–em’t
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
š‹Ë
);

232 
	`£rv”As£¹W™hInfo
(
NULL
,
–em’t
,

233 
	`diùAdd
(
d
,
–em’t
,
NULL
è=ğ
DICT_OK
);

235 
	`£tTy³R–—£I‹¿tÜ
(
si
);

237 
£tobj
->
’codšg
 = 
OBJ_ENCODING_HT
;

238 
	`dä“
(
£tobj
->
±r
);

239 
£tobj
->
±r
 = 
d
;

241 
	`£rv”Pªic
("Unsupported set conversion");

243 
	}
}

245 
	$§ddCommªd
(
ş›Á
 *
c
) {

246 
robj
 *
£t
;

247 
j
, 
added
 = 0;

248 
expœed
 = 0;

250 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

251 
	`lockDbWr™e
(
c
->
db
);

252 
£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

253 ià(
£t
 =ğ
NULL
) {

254 
£t
 = 
	`£tTy³C»©e
(
c
->
¬gv
[2]);

255 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
£t
);

257 ià(
£t
->
ty³
 !ğ
OBJ_SET
) {

258 
	`uÆockDb
(
c
->
db
);

259 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

260 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

265 
j
 = 2; j < 
c
->
¬gc
; j++) {

266 
c
->
¬gv
[
j
] = 
	`ŒyObjeùEncodšg
(c->argv[j]);

267 ià(
	`£tTy³Add
(
£t
,
c
->
¬gv
[
j
])è
added
++;

269 ià(
added
) {

270 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

271 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[1],c->
db
->
id
);

273 
c
->
v–
->
dœty
 +ğ
added
;

274 
	`addR•lyLÚgLÚg
(
c
,
added
);

275 
	`uÆockDb
(
c
->
db
);

276 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

277 
	}
}

279 
	$¤emCommªd
(
ş›Á
 *
c
) {

280 
robj
 *
£t
;

281 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

282 
expœed
 = 0;

284 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

285 
	`lockDbWr™e
(
c
->
db
);

286 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

287 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

288 
	`uÆockDb
(
c
->
db
);

289 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

293 
j
 = 2; j < 
c
->
¬gc
; j++) {

294 ià(
	`£tTy³Remove
(
£t
,
c
->
¬gv
[
j
])) {

295 
d–‘ed
++;

296 ià(
	`£tTy³Size
(
£t
) == 0) {

297 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

298 
key»moved
 = 1;

303 ià(
d–‘ed
) {

304 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

305 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

306 ià(
key»moved
)

307 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

308 
c
->
db
->
id
);

309 
c
->
v–
->
dœty
 +ğ
d–‘ed
;

311 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

312 
	`uÆockDb
(
c
->
db
);

313 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

314 
	}
}

316 
	$smoveCommªd
(
ş›Á
 *
c
) {

317 
robj
 *
¤c£t
, *
d¡£t
, *
–e
;

318 
¤c£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
NULL
);

319 
d¡£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
);

320 
–e
 = 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

323 ià(
¤c£t
 =ğ
NULL
) {

324 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

330 ià(
	`checkTy³
(
c
,
¤c£t
,
OBJ_SET
) ||

331 (
d¡£t
 && 
	`checkTy³
(
c
,d¡£t,
OBJ_SET
))) ;

334 ià(
¤c£t
 =ğ
d¡£t
) {

335 
	`addR•ly
(
c
,
	`£tTy³IsMemb”
(
¤c£t
,
–e
è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

340 ià(!
	`£tTy³Remove
(
¤c£t
,
–e
)) {

341 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

344 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

347 ià(
	`£tTy³Size
(
¤c£t
) == 0) {

348 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

349 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

351 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

352 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

353 
£rv”
.
dœty
++;

356 ià(!
d¡£t
) {

357 
d¡£t
 = 
	`£tTy³C»©e
(
–e
);

358 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
d¡£t
);

362 ià(
	`£tTy³Add
(
d¡£t
,
–e
)) {

363 
£rv”
.
dœty
++;

364 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[2],c->
db
->
id
);

366 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

367 
	}
}

369 
	$sismemb”Commªd
(
ş›Á
 *
c
) {

370 
robj
 *
£t
;

372 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

373 
	`lockDbR—d
(
c
->
db
);

374 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

375 
	`uÆockDb
(
c
->
db
);

376 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

378 } ià(
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

379 
	`uÆockDb
(
c
->
db
);

380 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

384 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

385 ià(
	`£tTy³IsMemb”
(
£t
,
c
->
¬gv
[2]))

386 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

388 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

390 
	`uÆockDb
(
c
->
db
);

391 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

392 
	}
}

394 
	$sÿrdCommªd
(
ş›Á
 *
c
) {

395 
robj
 *
o
;

397 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

398 
	`lockDbR—d
(
c
->
db
);

399 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

400 
	`uÆockDb
(
c
->
db
);

401 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

403 } ià(
	`checkTy³
(
c
,
o
,
OBJ_SET
)) {

404 
	`uÆockDb
(
c
->
db
);

405 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

409 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
o
));

410 
	`uÆockDb
(
c
->
db
);

411 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

412 
	}
}

414 
	$smemb”sG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
£t
)

416 
£tTy³I‹¿tÜ
 *
si
;

417 
robj
 *
–eobj
;

418 
št64_t
 
štobj
;

419 
’codšg
;

421 
	`addR•lyMuÉiBulkL’
(
c
, 
	`£tTy³Size
(
£t
));

422 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

423 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–eobj
,&
štobj
)) != -1) {

424 ià(
’codšg
 =ğ
OBJ_ENCODING_HT
) {

425 
	`addR•lyBulk
(
c
, 
–eobj
);

426 } ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

427 
	`addR•lyBulkLÚgLÚg
(
c
, 
štobj
);

430 
	`£tTy³R–—£I‹¿tÜ
(
si
);

431 
	}
}

439 
	#SPOP_MOVE_STRATEGY_MUL
 5

	)

441 
	$¥İW™hCouÁCommªd
(
ş›Á
 *
c
) {

442 
l
;

443 
couÁ
, 
size
;

444 
robj
 *
£t
;

445 
expœed
 = 0;

448 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
VR_OK
) ;

449 ià(
l
 >= 0) {

450 
couÁ
 = (è
l
;

452 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

456 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

457 
	`lockDbWr™e
(
c
->
db
);

460 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
,&
expœed
))

461 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

462 
	`uÆockDb
(
c
->
db
);

463 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

469 ià(
couÁ
 == 0) {

470 
	`uÆockDb
(
c
->
db
);

471 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

472 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

476 
size
 = 
	`£tTy³Size
(
£t
);

479 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

480 
c
->
v–
->
dœty
 +ğ
couÁ
;

485 ià(
couÁ
 >ğ
size
) {

486 
robj
 *
aux
;

489 
	`smemb”sG’”icCommªd
(
c
, 
£t
);

492 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

493 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

496 
aux
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
c
->
¬gv
[1]);

497 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
sh¬ed
.
d–
,
aux
);

498 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

499 
c
->
v–
->
dœty
++;

500 
	`uÆockDb
(
c
->
db
);

501 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

508 
robj
 *
´İ¬gv
[3];

509 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("SREM",4);

510 
´İ¬gv
[1] = 
c
->
¬gv
[1];

511 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

514 
robj
 *
obj–e
;

515 
’codšg
;

516 
št64_t
 
Î–e
;

517 
»maššg
 = 
size
-
couÁ
;

526 ià(
»maššg
*
SPOP_MOVE_STRATEGY_MUL
 > 
couÁ
) {

527 
couÁ
--) {

528 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
obj–e
,&
Î–e
);

529 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

530 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

532 
obj–e
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(objele);

536 
	`addR•lyBulk
(
c
,
obj–e
);

537 
	`£tTy³Remove
(
£t
,
obj–e
);

540 
´İ¬gv
[2] = 
obj–e
;

541 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

542 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

543 
	`ä“Objeù
(
obj–e
);

554 
robj
 *
Ãw£t
 = 
NULL
;

557 
»maššg
--) {

558 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
obj–e
,&
Î–e
);

559 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

560 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

562 ià(!
Ãw£t
èÃw£ˆğ
	`£tTy³C»©e
(
obj–e
);

563 
	`£tTy³Add
(
Ãw£t
,
obj–e
);

564 
	`£tTy³Remove
(
£t
,
obj–e
);

565 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

566 
	`ä“Objeù
(
obj–e
);

570 
£tTy³I‹¿tÜ
 *
si
;

571 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

572 (
’codšg
 = 
	`£tTy³Next
(
si
,&
obj–e
,&
Î–e
)) != -1) {

573 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

574 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

575 
	`addR•lyBulk
(
c
,
obj–e
);

578 
´İ¬gv
[2] = 
obj–e
;

579 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

580 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

581 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

582 
	`ä“Objeù
(
obj–e
);

584 
	`£tTy³R–—£I‹¿tÜ
(
si
);

587 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw£t
);

594 
	`ä“Objeù
(
´İ¬gv
[0]);

595 
	`´ev’tCommªdPrİag©iÚ
(
c
);

596 
	`uÆockDb
(
c
->
db
);

597 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

598 
	}
}

600 
	$¥İCommªd
(
ş›Á
 *
c
) {

601 
robj
 *
£t
, *
–e
, *
aux1
, *
aux2
;

602 
št64_t
 
Î–e
;

603 
’codšg
;

604 
expœed
 = 0;

606 ià(
c
->
¬gc
 == 3) {

607 
	`¥İW™hCouÁCommªd
(
c
);

609 } ià(
c
->
¬gc
 > 3) {

610 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

614 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

615 
	`lockDbWr™e
(
c
->
db
);

618 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
,&
expœed
)è=ğ
NULL
 ||

619 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

620 
	`uÆockDb
(
c
->
db
);

621 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

626 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

629 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

630 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

631 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

633 
–e
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(ele);

634 
	`£tTy³Remove
(
£t
,
–e
);

637 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

640 
aux1
 = 
	`ü—‹SŒšgObjeù
("SREM",4);

641 
aux2
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
c
->
¬gv
[1]);

642 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,3,
aux1
,
aux2
,
–e
);

645 
	`addR•lyBulk
(
c
,
–e
);

648 ià(
	`£tTy³Size
(
£t
) == 0) {

649 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

650 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

654 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

655 
c
->
v–
->
dœty
++;

656 
	`uÆockDb
(
c
->
db
);

657 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

658 
	}
}

666 
	#SRANDMEMBER_SUB_STRATEGY_MUL
 3

	)

668 
	$¤ªdmemb”W™hCouÁCommªd
(
ş›Á
 *
c
) {

669 
l
;

670 
couÁ
, 
size
;

671 
uniq
 = 1;

672 
robj
 *
£t
, *
–e
;

673 
št64_t
 
Î–e
;

674 
’codšg
;

676 
diù
 *
d
;

678 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
VR_OK
) ;

679 ià(
l
 >= 0) {

680 
couÁ
 = (è
l
;

684 
couÁ
 = -
l
;

685 
uniq
 = 0;

688 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

689 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

690 
size
 = 
	`£tTy³Size
(
£t
);

693 ià(
couÁ
 == 0) {

694 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

702 ià(!
uniq
) {

703 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

704 
couÁ
--) {

705 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

706 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

707 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

709 
	`addR•lyBulk
(
c
,
–e
);

718 ià(
couÁ
 >ğ
size
) {

720 
	`smemb”sG’”icCommªd
(
c
, 
£t
);

725 
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

736 ià(
couÁ
*
SRANDMEMBER_SUB_STRATEGY_MUL
 > 
size
) {

737 
£tTy³I‹¿tÜ
 *
si
;

740 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

741 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–e
,&
Î–e
)) != -1) {

742 
»tv®
 = 
DICT_ERR
;

744 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

745 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
),
NULL
);

747 
»tv®
 = 
	`diùAdd
(
d
,
	`dupSŒšgObjeù
(
–e
),
NULL
);

749 
	`ASSERT
(
»tv®
 =ğ
DICT_OK
);

751 
	`£tTy³R–—£I‹¿tÜ
(
si
);

752 
	`ASSERT
(
	`diùSize
(
d
è=ğ
size
);

755 
size
 > 
couÁ
) {

756 
diùEÁry
 *
de
;

758 
de
 = 
	`diùG‘RªdomKey
(
d
);

759 
	`diùD–‘e
(
d
,
	`diùG‘Key
(
de
));

760 
size
--;

769 
added
 = 0;

771 
added
 < 
couÁ
) {

772 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

773 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

774 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

776 
–e
 = 
	`dupSŒšgObjeù
(ele);

781 ià(
	`diùAdd
(
d
,
–e
,
NULL
è=ğ
DICT_OK
)

782 
added
++;

784 
	`deüRefCouÁ
(
–e
);

790 
diùI‹¿tÜ
 *
di
;

791 
diùEÁry
 *
de
;

793 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

794 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

795 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

796 
	`addR•lyBulk
(
c
,
	`diùG‘Key
(
de
));

797 
	`diùR–—£I‹¿tÜ
(
di
);

798 
	`diùR–—£
(
d
);

800 
	}
}

802 
	$¤ªdmemb”Commªd
(
ş›Á
 *
c
) {

803 
robj
 *
£t
, *
–e
;

804 
št64_t
 
Î–e
;

805 
’codšg
;

807 ià(
c
->
¬gc
 == 3) {

808 
	`¤ªdmemb”W™hCouÁCommªd
(
c
);

810 } ià(
c
->
¬gc
 > 3) {

811 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

815 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

816 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

818 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

819 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

820 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

822 
	`addR•lyBulk
(
c
,
–e
);

824 
	}
}

826 
	$smemb”sCommªd
(
ş›Á
 *
c
) {

827 
robj
 *
£t
;

829 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

830 
	`lockDbR—d
(
c
->
db
);

831 
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
);

832 ià(
£t
 =ğ
NULL
) {

833 
	`uÆockDb
(
c
->
db
);

834 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

836 } if(
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

837 
	`uÆockDb
(
c
->
db
);

838 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

842 
	`smemb”sG’”icCommªd
(
c
, 
£t
);

843 
	`uÆockDb
(
c
->
db
);

844 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

845 
	}
}

847 
	$qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

848  
	`£tTy³Size
(*(
robj
**)
s1
)-£tTy³Size(*Ôobj**)
s2
);

849 
	}
}

853 
	$qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

854 
robj
 *
o1
 = *Ôobj**)
s1
, *
o2
 = *Ôobj**)
s2
;

856  (
o2
 ? 
	`£tTy³Size
(o2è: 0è- (
o1
 ? setTypeSize(o1) : 0);

857 
	}
}

859 
	$sš‹rG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
,

860 
£Šum
, 
robj
 *
d¡key
) {

861 
£tTy³I‹¿tÜ
 *
si
;

862 
robj
 *
–eobj
, *
d¡£t
 = 
NULL
;

863 
št64_t
 
štobj
;

864 
j
, 
ÿrdš®™y
 = 0;

865 
’codšg
;

866 
robj
 *
£tobj
, *
mš_Ën_£t
;

867 
mš_Ën
 = -1;

868 
mš_Ën_idx
 = 0;

870 
j
 = 0; j < 
£Šum
; j++) {

871 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

872 
	`lockDbR—d
(
c
->
db
);

873 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

874 ià(!
£tobj
) {

875 
	`uÆockDb
(
c
->
db
);

876 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_mis£s
,1);

877 ià(
d¡key
) {

878 
	`ãtchIÁ”ÇlDbByKey
(
c
,
d¡key
);

879 
	`lockDbWr™e
(
c
->
db
);

880 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

881 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

882 
c
->
v–
->
dœty
++;

884 
	`uÆockDb
(
c
->
db
);

885 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

887 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

891 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

892 
	`uÆockDb
(
c
->
db
);

893 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

897 ià(
mš_Ën
 =ğ-1 || 
	`£tTy³Size
(
£tobj
) < min_len) {

898 
mš_Ën
 = 
	`£tTy³Size
(
£tobj
);

899 
mš_Ën_idx
 = 
j
;

902 
	`uÆockDb
(
c
->
db
);

903 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

906 
mš_Ën_£t
 = 
	`ü—‹IÁ£tObjeù
();

907 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
mš_Ën_idx
]);

908 
	`lockDbR—d
(
c
->
db
);

909 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
mš_Ën_idx
]);

910 ià(!
£tobj
) {

911 
	`uÆockDb
(
c
->
db
);

912 
	`ä“Objeù
(
mš_Ën_£t
);

913 
dÚe
;

915 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

916 
	`uÆockDb
(
c
->
db
);

917 
	`ä“Objeù
(
mš_Ën_£t
);

920 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

921 (
–eobj
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

922 
	`£tTy³Add
(
mš_Ën_£t
,
–eobj
);

923 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

924 
	`ä“Objeù
(
–eobj
);

926 
	`£tTy³R–—£I‹¿tÜ
(
si
);

927 
	`uÆockDb
(
c
->
db
);

929 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

934 
si
 = 
	`£tTy³In™I‹¿tÜ
(
mš_Ën_£t
);

935 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–eobj
,&
štobj
)) != -1) {

936 
j
 = 0; j < 
£Šum
; j++) {

937 ià(
j
 =ğ
mš_Ën_idx
) ;

938 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

939 
	`lockDbR—d
(
c
->
db
);

940 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

941 ià(!
£tobj
) {

942 
	`uÆockDb
(
c
->
db
);

943 
	`ä“Objeù
(
mš_Ën_£t
);

944 ià(
d¡£t
) {

945 
	`ä“Objeù
(
d¡£t
);

946 
d¡£t
 = 
NULL
;

948 
	`£tTy³R–—£I‹¿tÜ
(
si
);

949 
dÚe
;

951 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

952 
	`uÆockDb
(
c
->
db
);

953 
	`ä“Objeù
(
mš_Ën_£t
);

954 ià(
d¡£t
) {

955 
	`ä“Objeù
(
d¡£t
);

956 
d¡£t
 = 
NULL
;

958 
	`£tTy³R–—£I‹¿tÜ
(
si
);

962 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

964 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
 &&

965 !
	`št£tFšd
((
št£t
*)
£tobj
->
±r
,
štobj
))

967 
	`uÆockDb
(
c
->
db
);

972 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

973 
–eobj
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
štobj
);

974 ià(!
	`£tTy³IsMemb”
(
£tobj
,
–eobj
)) {

975 
	`uÆockDb
(
c
->
db
);

976 
	`ä“Objeù
(
–eobj
);

979 
	`ä“Objeù
(
–eobj
);

981 } ià(
’codšg
 =ğ
OBJ_ENCODING_HT
) {

985 ià(
–eobj
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

986 
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
 &&

987 !
	`št£tFšd
((
št£t
*)
£tobj
->
±r
,()
–eobj
->ptr))

989 
	`uÆockDb
(
c
->
db
);

993 } ià(!
	`£tTy³IsMemb”
(
£tobj
,
–eobj
)) {

994 
	`uÆockDb
(
c
->
db
);

998 
	`uÆockDb
(
c
->
db
);

1002 ià(
j
 =ğ
£Šum
) {

1003 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1004 
–eobj
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
štobj
);

1005 
	`£tTy³Add
(
d¡£t
,
–eobj
);

1006 
	`ä“Objeù
(
–eobj
);

1008 
	`£tTy³Add
(
d¡£t
,
–eobj
);

1010 
ÿrdš®™y
 ++;

1013 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1014 
	`ä“Objeù
(
mš_Ën_£t
);

1016 
dÚe
:

1017 ià(
d¡key
) {

1018 
	`ãtchIÁ”ÇlDbByKey
(
c
,
d¡key
);

1019 
	`lockDbWr™e
(
c
->
db
);

1022 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

1023 ià(
d¡£t
 && 
	`£tTy³Size
(dstset) > 0) {

1024 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

1025 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

1026 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"sinterstore",

1027 
d¡key
,
c
->
db
->
id
);

1029 ià(
d¡£t
) {

1030 
	`ä“Objeù
(
d¡£t
);

1031 
d¡£t
 = 
NULL
;

1033 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1034 ià(
d–‘ed
)

1035 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

1036 
d¡key
,
c
->
db
->
id
);

1038 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

1039 
	`uÆockDb
(
c
->
db
);

1040 
c
->
v–
->
dœty
++;

1042 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

1043 ià(
d¡£t
 && 
	`£tTy³Size
(dstset) > 0) {

1044 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

1045 (
–eobj
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1046 
	`addR•lyBulk
(
c
,
–eobj
);

1047 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1048 
	`ä“Objeù
(
–eobj
);

1050 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1052 ià(
d¡£t
è
	`ä“Objeù
(dstset);

1054 
	}
}

1056 
	$sš‹rCommªd
(
ş›Á
 *
c
) {

1057 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
);

1058 
	}
}

1060 
	$sš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

1061 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->argv[1]);

1062 
	}
}

1064 
	#SET_OP_UNION
 0

	)

1065 
	#SET_OP_DIFF
 1

	)

1066 
	#SET_OP_INTER
 2

	)

1068 
	$suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

1069 
robj
 *
d¡key
, 
İ
) {

1070 
£tTy³I‹¿tÜ
 *
si
;

1071 
robj
 *
–e
, *
d¡£t
 = 
NULL
;

1072 
j
, 
ÿrdš®™y
 = 0;

1073 
diff_®go
 = 1;

1074 
robj
 *
£tobj
;

1075 
®go_Úe_wÜk
 = 0, 
®go_two_wÜk
 = 0;

1076 
fœ¡_Ëngth
 = 0;

1078 
j
 = 0; j < 
£Šum
; j++) {

1079 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

1080 
	`lockDbR—d
(
c
->
db
);

1081 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

1082 ià(!
£tobj
) {

1083 
	`uÆockDb
(
c
->
db
);

1084 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_mis£s
,1);

1087 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1088 
	`uÆockDb
(
c
->
db
);

1089 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

1093 ià(
İ
 =ğ
SET_OP_DIFF
) {

1094 ià(
j
 =ğ0è
fœ¡_Ëngth
 = 
	`£tTy³Size
(
£tobj
);

1095 
®go_Úe_wÜk
 +ğ
fœ¡_Ëngth
;

1096 
®go_two_wÜk
 +ğ
	`£tTy³Size
(
£tobj
);

1099 
	`uÆockDb
(
c
->
db
);

1100 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

1112 ià(
İ
 =ğ
SET_OP_DIFF
) {

1115 
®go_Úe_wÜk
 /= 2;

1116 
diff_®go
 = (
®go_Úe_wÜk
 <ğ
®go_two_wÜk
) ? 1 : 2;

1122 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

1124 ià(
İ
 =ğ
SET_OP_UNION
) {

1127 
j
 = 0; j < 
£Šum
; j++) {

1128 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

1129 
	`lockDbR—d
(
c
->
db
);

1130 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

1132 ià(!
£tobj
) {

1133 
	`uÆockDb
(
c
->
db
);

1136 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1137 
	`uÆockDb
(
c
->
db
);

1138 
	`ä“Objeù
(
d¡£t
);

1142 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

1143 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1144 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1145 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1146 
	`ä“Objeù
(
–e
);

1148 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1149 
	`uÆockDb
(
c
->
db
);

1151 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
diff_®go
 == 1) {

1160 
robj
 *
fœ¡_£t
;

1162 
fœ¡_£t
 = 
	`ü—‹IÁ£tObjeù
();

1163 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[0]);

1164 
	`lockDbR—d
(
c
->
db
);

1165 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[0]);

1166 ià(!
£tobj
) {

1167 
	`uÆockDb
(
c
->
db
);

1168 
	`ä“Objeù
(
fœ¡_£t
);

1169 
dÚe
;

1171 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1172 
	`uÆockDb
(
c
->
db
);

1173 
	`ä“Objeù
(
d¡£t
);

1174 
	`ä“Objeù
(
fœ¡_£t
);

1177 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

1178 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1179 
	`£tTy³Add
(
fœ¡_£t
,
–e
);

1180 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1181 
	`ä“Objeù
(
–e
);

1183 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1184 
	`uÆockDb
(
c
->
db
);

1186 
si
 = 
	`£tTy³In™I‹¿tÜ
(
fœ¡_£t
);

1187 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1188 
j
 = 1; j < 
£Šum
; j++) {

1189 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

1190 
	`lockDbR—d
(
c
->
db
);

1191 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

1192 ià(!
£tobj
) {

1193 
	`uÆockDb
(
c
->
db
);

1196 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1197 
	`uÆockDb
(
c
->
db
);

1198 
	`ä“Objeù
(
d¡£t
);

1199 
	`ä“Objeù
(
fœ¡_£t
);

1200 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1201 
	`ä“Objeù
(
–e
);

1202 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1205 ià(
	`£tTy³IsMemb”
(
£tobj
,
–e
)) {

1206 
	`uÆockDb
(
c
->
db
);

1209 
	`uÆockDb
(
c
->
db
);

1212 ià(
j
 =ğ
£Šum
) {

1214 
	`£tTy³Add
(
d¡£t
,
–e
);

1215 
ÿrdš®™y
++;

1218 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1219 
	`ä“Objeù
(
–e
);

1221 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1222 
	`ä“Objeù
(
fœ¡_£t
);

1223 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
diff_®go
 == 2) {

1231 
j
 = 0; j < 
£Šum
; j++) {

1232 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[0]);

1233 
	`lockDbR—d
(
c
->
db
);

1234 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[0]);

1235 ià(!
£tobj
) {

1236 ià(
j
 == 0) {

1237 
	`uÆockDb
(
c
->
db
);

1238 
dÚe
;

1241 
	`uÆockDb
(
c
->
db
);

1244 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1245 
	`uÆockDb
(
c
->
db
);

1246 
	`ä“Objeù
(
d¡£t
);

1250 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

1251 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1252 ià(
j
 == 0) {

1253 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1255 ià(
	`£tTy³Remove
(
d¡£t
,
–e
)è
ÿrdš®™y
--;

1257 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1258 
	`ä“Objeù
(
–e
);

1260 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1264 ià(
ÿrdš®™y
 == 0) {

1265 
	`uÆockDb
(
c
->
db
);

1268 
	`uÆockDb
(
c
->
db
);

1272 
dÚe
:

1274 ià(!
d¡key
) {

1275 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

1276 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

1277 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1278 
	`addR•lyBulk
(
c
,
–e
);

1279 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1280 
	`ä“Objeù
(
–e
);

1282 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1283 
	`ä“Objeù
(
d¡£t
);

1285 
	`ãtchIÁ”ÇlDbByKey
(
c
,
d¡key
);

1286 
	`lockDbWr™e
(
c
->
db
);

1289 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

1290 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

1291 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

1292 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

1293 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,

1294 
İ
 =ğ
SET_OP_UNION
 ? "sunionstore" : "sdiffstore",

1295 
d¡key
,
c
->
db
->
id
);

1297 
	`ä“Objeù
(
d¡£t
);

1298 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1299 ià(
d–‘ed
)

1300 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

1301 
d¡key
,
c
->
db
->
id
);

1303 
	`uÆockDb
(
c
->
db
);

1304 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

1305 
c
->
v–
->
dœty
++;

1307 
	}
}

1309 
	$suniÚCommªd
(
ş›Á
 *
c
) {

1310 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_UNION
);

1311 
	}
}

1313 
	$suniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

1314 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_UNION
);

1315 
	}
}

1317 
	$sdiffCommªd
(
ş›Á
 *
c
) {

1318 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_DIFF
);

1319 
	}
}

1321 
	$sdiff¡ÜeCommªd
(
ş›Á
 *
c
) {

1322 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_DIFF
);

1323 
	}
}

1325 
	$ssÿnCommªd
(
ş›Á
 *
c
) {

1326 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_SET
);

1327 
	}
}

	@src/vr_t_set.h

1 #iâdeà
_VR_T_SET_H_


2 
	#_VR_T_SET_H_


	)

4 
robj
 *
£tTy³C»©e
Ôobj *
v®ue
);

5 
£tTy³Add
(
robj
 *
subjeù
,„obj *
v®ue
);

6 
£tTy³Remove
(
robj
 *
£tobj
,„obj *
v®ue
);

7 
£tTy³IsMemb”
(
robj
 *
subjeù
,„obj *
v®ue
);

8 
£tTy³I‹¿tÜ
 *
£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

9 
£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
);

10 
£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
robj
 **
obj–e
, 
št64_t
 *
Î–e
);

11 
robj
 *
£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
);

12 
£tTy³RªdomEËm’t
(
robj
 *
£tobj
,„obj **
obj–e
, 
št64_t
 *
Î–e
);

14 
£tTy³Size
(
robj
 *
subjeù
);

15 
£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
);

16 
§ddCommªd
(
ş›Á
 *
c
);

17 
¤emCommªd
(
ş›Á
 *
c
);

18 
smoveCommªd
(
ş›Á
 *
c
);

19 
sismemb”Commªd
(
ş›Á
 *
c
);

20 
sÿrdCommªd
(
ş›Á
 *
c
);

21 
¥İW™hCouÁCommªd
(
ş›Á
 *
c
);

22 
¥İCommªd
(
ş›Á
 *
c
);

23 
¤ªdmemb”W™hCouÁCommªd
(
ş›Á
 *
c
);

24 
¤ªdmemb”Commªd
(
ş›Á
 *
c
);

25 
smemb”sCommªd
(
ş›Á
 *
c
);

26 
qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
);

27 
qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
);

28 
sš‹rG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,„obj *
d¡key
);

29 
sš‹rCommªd
(
ş›Á
 *
c
);

30 
sš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

31 
suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,„obj *
d¡key
, 
İ
);

32 
suniÚCommªd
(
ş›Á
 *
c
);

33 
suniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

34 
sdiffCommªd
(
ş›Á
 *
c
);

35 
sdiff¡ÜeCommªd
(
ş›Á
 *
c
);

36 
ssÿnCommªd
(
ş›Á
 *
c
);

	@src/vr_t_string.c

1 
	~<vr_cÜe.h
>

7 
	$checkSŒšgL’gth
(
ş›Á
 *
c
, 
size
) {

8 ià(
size
 > 512*1024*1024) {

9 
	`addR•lyE¼Ü
(
c
,"stringƒxceeds maximum‡llowed size (512MB)");

10  
VR_ERROR
;

12  
VR_OK
;

13 
	}
}

31 
	#OBJ_SET_NO_FLAGS
 0

	)

32 
	#OBJ_SET_NX
 (1<<0è

	)

33 
	#OBJ_SET_XX
 (1<<1è

	)

34 
	#OBJ_SET_EX
 (1<<2è

	)

35 
	#OBJ_SET_PX
 (1<<3è

	)

37 
	$£tG’”icCommªd
(
ş›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
) {

38 
mli£cÚds
 = 0;

39 
expœed
 = 0;

40 
exi¡
;

42 ià(
expœe
) {

43 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
expœe
, &
mli£cÚds
, 
NULL
è!ğ
VR_OK
)

45 ià(
mli£cÚds
 <= 0) {

46 
	`addR•lyE¼ÜFÜm©
(
c
,"šv®idƒxpœtimš %s",c->
cmd
->
Çme
);

49 ià(
un™
 =ğ
UNIT_SECONDS
è
mli£cÚds
 *= 1000;

52 
	`ãtchIÁ”ÇlDbByKey
(
c
,
key
);

53 
	`lockDbWr™e
(
c
->
db
);

54 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
,&
expœed
è=ğ
NULL
)

55 
exi¡
 = 0;

57 
exi¡
 = 1;

59 ià((
æags
 & 
OBJ_SET_NX
 && 
exi¡
) ||

60 (
æags
 & 
OBJ_SET_XX
 && !
exi¡
))

62 
	`uÆockDb
(
c
->
db
);

63 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

64 
	`addR•ly
(
c
, 
abÜt_»¶y
 ?‡bÜt_»¶y : 
sh¬ed
.
nuÎbulk
);

68 
	`£tKey
(
c
->
db
,
key
,
	`dupSŒšgObjeùUncÚ¡ªt
(
v®
),
NULL
);

69 
c
->
v–
->
dœty
++;

70 ià(
expœe
è
	`£tExpœe
(
c
->
db
,
key
,
	`vr_m£c_now
()+
mli£cÚds
);

71 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
key
,
c
->
db
->
id
);

72 ià(
expœe
è
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

73 "expœe",
key
,
c
->
db
->
id
);

74 
	`addR•ly
(
c
, 
ok_»¶y
 ? ok_»¶y : 
sh¬ed
.
ok
);

75 
	`uÆockDb
(
c
->
db
);

76 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

77 
	}
}

80 
	$£tCommªd
(
ş›Á
 *
c
) {

81 
j
;

82 
robj
 *
expœe
 = 
NULL
;

83 
un™
 = 
UNIT_SECONDS
;

84 
æags
 = 
OBJ_SET_NO_FLAGS
;

86 
j
 = 3; j < 
c
->
¬gc
; j++) {

87 *
a
 = 
c
->
¬gv
[
j
]->
±r
;

88 
robj
 *
Ãxt
 = (
j
 =ğ
c
->
¬gc
-1è? 
NULL
 : c->
¬gv
[j+1];

90 ià((
a
[0] == 'n' ||‡[0] == 'N') &&

91 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

92 !(
æags
 & 
OBJ_SET_XX
))

94 
æags
 |ğ
OBJ_SET_NX
;

95 } ià((
a
[0] == 'x' ||‡[0] == 'X') &&

96 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

97 !(
æags
 & 
OBJ_SET_NX
))

99 
æags
 |ğ
OBJ_SET_XX
;

100 } ià((
a
[0] == 'e' ||‡[0] == 'E') &&

101 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

102 !(
æags
 & 
OBJ_SET_PX
è&& 
Ãxt
)

104 
æags
 |ğ
OBJ_SET_EX
;

105 
un™
 = 
UNIT_SECONDS
;

106 
expœe
 = 
Ãxt
;

107 
j
++;

108 } ià((
a
[0] == 'p' ||‡[0] == 'P') &&

109 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

110 !(
æags
 & 
OBJ_SET_EX
è&& 
Ãxt
)

112 
æags
 |ğ
OBJ_SET_PX
;

113 
un™
 = 
UNIT_MILLISECONDS
;

114 
expœe
 = 
Ãxt
;

115 
j
++;

117 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

122 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

123 
	`£tG’”icCommªd
(
c
,
æags
,c->
¬gv
[1],c->¬gv[2],
expœe
,
un™
,
NULL
,NULL);

124 
	}
}

126 
	$£ŠxCommªd
(
ş›Á
 *
c
) {

127 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

128 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NX
,c->
¬gv
[1],c->¬gv[2],
NULL
,0,
sh¬ed
.
cÚe
,sh¬ed.
cz”o
);

129 
	}
}

131 
	$£‹xCommªd
(
ş›Á
 *
c
) {

132 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

133 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_SECONDS
,
NULL
,NULL);

134 
	}
}

136 
	$p£‹xCommªd
(
ş›Á
 *
c
) {

137 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

138 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_MILLISECONDS
,
NULL
,NULL);

139 
	}
}

141 
	$g‘G’”icCommªd
(
ş›Á
 *
c
) {

142 
robj
 *
o
;

144 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

145  
VR_OK
;

148 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

149 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

150  
VR_ERROR
;

152 
	`addR•lyBulk
(
c
,
o
);

153  
VR_OK
;

155 
	}
}

157 
	$g‘Commªd
(
ş›Á
 *
c
) {

158 
robj
 *
o
;

160 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[1]);

161 
	`lockDbR—d
(
c
->
db
);

162 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

163 
	`uÆockDb
(
c
->
db
);

164 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

168 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

169 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

171 
	`addR•lyBulk
(
c
,
o
);

174 
	`uÆockDb
(
c
->
db
);

175 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

176 
	}
}

178 
	$g‘£tCommªd
(
ş›Á
 *
c
) {

179 
robj
 *
key
, *
v®
;

180 
expœed
 = 0;

181 
exi¡
;

183 
key
 = 
c
->
¬gv
[1];

184 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

186 
	`ãtchIÁ”ÇlDbByKey
(
c
,
key
);

187 
	`lockDbWr™e
(
c
->
db
);

188 
v®
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
,&
expœed
);

189 ià(
v®
 =ğ
NULL
) {

190 
exi¡
 = 0;

191 
	`dbAdd
(
c
->
db
,
key
,
	`dupSŒšgObjeùUncÚ¡ªt
(c->
¬gv
[2]));

193 
exi¡
 = 1;

194 ià(
v®
->
ty³
 !ğ
OBJ_STRING
) {

195 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

196 
’d
;

199 
	`addR•lyBulk
(
c
,
v®
);

200 
	`dbOv”wr™e
(
c
->
db
,
key
,
	`dupSŒšgObjeùUncÚ¡ªt
(c->
¬gv
[2]));

201 
	`»moveExpœe
(
c
->
db
,
key
);

204 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[1],c->
db
->
id
);

205 
c
->
v–
->
dœty
++;

207 
’d
:

208 
	`uÆockDb
(
c
->
db
);

209 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

210 ià(
exi¡
)

211 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

213 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

214 
	}
}

216 
	$£ŒªgeCommªd
(
ş›Á
 *
c
) {

217 
robj
 *
o
;

218 
off£t
;

219 
sds
 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

220 
expœed
 = 0;

222 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
off£t
,
NULL
è!ğ
VR_OK
)

225 ià(
off£t
 < 0) {

226 
	`addR•lyE¼Ü
(
c
,"offset is out of„ange");

230 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

231 
	`lockDbWr™e
(
c
->
db
);

232 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

233 ià(
o
 =ğ
NULL
) {

235 ià(
	`sd¦’
(
v®ue
) == 0) {

236 
	`uÆockDb
(
c
->
db
);

237 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

238 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

243 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
VR_OK
) {

244 
	`uÆockDb
(
c
->
db
);

245 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

249 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
off£t
+
	`sd¦’
(
v®ue
)));

250 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

252 
size_t
 
Ş’
;

255 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

256 
	`uÆockDb
(
c
->
db
);

257 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

262 
Ş’
 = 
	`¡ršgObjeùL’
(
o
);

263 ià(
	`sd¦’
(
v®ue
) == 0) {

264 
	`uÆockDb
(
c
->
db
);

265 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

266 
	`addR•lyLÚgLÚg
(
c
,
Ş’
);

271 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
VR_OK
) {

272 
	`uÆockDb
(
c
->
db
);

273 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

278 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

281 ià(
	`sd¦’
(
v®ue
) > 0) {

282 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
off£t
+
	`sd¦’
(
v®ue
));

283 
	`memıy
((*)
o
->
±r
+
off£t
,
v®ue
,
	`sd¦’
(value));

284 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

285 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,

286 "£Œªge",
c
->
¬gv
[1],c->
db
->
id
);

287 
c
->
v–
->
dœty
++;

289 
	`addR•lyLÚgLÚg
(
c
,
	`sd¦’
(
o
->
±r
));

290 
	`uÆockDb
(
c
->
db
);

291 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

292 
	}
}

294 
	$g‘¿ngeCommªd
(
ş›Á
 *
c
) {

295 
robj
 *
o
;

296 
¡¬t
, 
’d
;

297 *
¡r
, 
Îbuf
[32];

298 
size_t
 
¡¾’
;

300 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
VR_OK
)

302 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
VR_OK
)

305 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

306 
	`lockDbR—d
(
c
->
db
);

307 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ybulk
)è=ğ
NULL
) {

308 
	`uÆockDb
(
c
->
db
);

309 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

311 } ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

312 
	`uÆockDb
(
c
->
db
);

313 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

317 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

318 
¡r
 = 
Îbuf
;

319 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

321 
¡r
 = 
o
->
±r
;

322 
¡¾’
 = 
	`sd¦’
(
¡r
);

326 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

327 ià(
’d
 < 0è’d = 
¡¾’
+end;

328 ià(
¡¬t
 < 0) start = 0;

329 ià(
’d
 < 0)ƒnd = 0;

330 ià(()
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

334 ià(
¡¬t
 > 
’d
 || 
¡¾’
 == 0) {

335 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

337 
	`addR•lyBulkCBufãr
(
c
,(*)
¡r
+
¡¬t
,
’d
-start+1);

339 
	`uÆockDb
(
c
->
db
);

340 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

341 
	}
}

343 
	$mg‘Commªd
(
ş›Á
 *
c
) {

344 
j
;

346 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-1);

347 
j
 = 1; j < 
c
->
¬gc
; j++) {

348 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

349 
	`lockDbR—d
(
c
->
db
);

350 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

351 ià(
o
 =ğ
NULL
) {

352 
	`uÆockDb
(
c
->
db
);

353 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

354 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

356 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

357 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

359 
	`addR•lyBulk
(
c
,
o
);

361 
	`uÆockDb
(
c
->
db
);

362 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

365 
	}
}

367 
	$m£tG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

368 
j
, 
busykeys
 = 0;

370 ià((
c
->
¬gc
 % 2) == 0) {

371 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

376 ià(
nx
) {

377 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

378 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
],
NULL
) != NULL) {

379 
busykeys
++;

382 ià(
busykeys
) {

383 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

388 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

389 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

390 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],c->¬gv[j+1],
NULL
);

391 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

393 
£rv”
.
dœty
 +ğ(
c
->
¬gc
-1)/2;

394 
	`addR•ly
(
c
, 
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

395 
	}
}

397 
	$m£tCommªd
(
ş›Á
 *
c
) {

398 
j
;

399 
expœed
 = 0, 
expœed_tÙ®
 = 0;

401 ià((
c
->
¬gc
 % 2) == 0) {

402 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

406 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

407 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

408 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

409 
	`lockDbWr™e
(
c
->
db
);

410 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],
	`dupSŒšgObjeùUncÚ¡ªt
(c->¬gv[j+1]),&
expœed
);

411 
	`uÆockDb
(
c
->
db
);

412 ià(
expœed
è
expœed_tÙ®
 ++;

413 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

416 ià(
expœed_tÙ®
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,expired_total);

417 
c
->
v–
->
dœty
 +ğ(c->
¬gc
-1)/2;

418 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

419 
	}
}

421 
	$m£ŠxCommªd
(
ş›Á
 *
c
) {

422 
	`m£tG’”icCommªd
(
c
,1);

423 
	}
}

425 
	$šüDeüCommªd
(
ş›Á
 *
c
, 
šü
) {

426 
v®ue
, 
Şdv®ue
;

427 
robj
 *
o
, *
Ãw
;

428 
expœed
 = 0;

430 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

431 
	`lockDbWr™e
(
c
->
db
);

432 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

433 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)è
’d
;

434 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
VR_OK
è
’d
;

436 
Şdv®ue
 = 
v®ue
;

437 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

438 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

439 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

440 
’d
;

442 
v®ue
 +ğ
šü
;

444 ià(
o
 && o->
»fcouÁ
 =ğ1 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

445 (
v®ue
 < 0 || v®u>ğ
OBJ_SHARED_INTEGERS
) &&

446 
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
)

448 
Ãw
 = 
o
;

449 
o
->
±r
 = (*)(()
v®ue
);

451 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

452 ià(
o
) {

453 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

455 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

458 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

459 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šüby",
c
->
¬gv
[1],c->
db
->
id
);

460 
c
->
v–
->
dœty
++;

461 
	`addR•ly
(
c
,
sh¬ed
.
cŞÚ
);

462 
	`addR•ly
(
c
,
Ãw
);

463 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

465 
’d
:

466 
	`uÆockDb
(
c
->
db
);

467 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

468 
	}
}

470 
	$šüCommªd
(
ş›Á
 *
c
) {

471 
	`šüDeüCommªd
(
c
,1);

472 
	}
}

474 
	$deüCommªd
(
ş›Á
 *
c
) {

475 
	`šüDeüCommªd
(
c
,-1);

476 
	}
}

478 
	$šübyCommªd
(
ş›Á
 *
c
) {

479 
šü
;

481 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
VR_OK
) ;

482 
	`šüDeüCommªd
(
c
,
šü
);

483 
	}
}

485 
	$deübyCommªd
(
ş›Á
 *
c
) {

486 
šü
;

488 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
VR_OK
) ;

489 
	`šüDeüCommªd
(
c
,-
šü
);

490 
	}
}

492 
	$šübyæßtCommªd
(
ş›Á
 *
c
) {

493 
šü
, 
v®ue
;

494 
robj
 *
o
, *
Ãw
, *
aux
;

495 
expœed
 = 0;

497 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

498 
	`lockDbWr™e
(
c
->
db
);

499 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

500 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)è
’d
;

501 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
VR_OK
 ||

502 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
šü
,
NULL
è!ğ
VR_OK
)

503 
’d
;

505 
v®ue
 +ğ
šü
;

506 ià(
	`i¢ª
(
v®ue
è|| 
	`isšf
(value)) {

507 
	`addR•lyE¼Ü
(
c
,"increment would…roduce NaN or Infinity");

508 
’d
;

510 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

511 ià(
o
)

512 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

514 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

515 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

516 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

517 
c
->
v–
->
dœty
++;

518 
	`addR•lyBulk
(
c
,
Ãw
);

523 
aux
 = 
	`ü—‹SŒšgObjeù
("SET",3);

524 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

525 
aux
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
Ãw
);

526 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,2,
aux
);

528 
’d
:

529 
	`uÆockDb
(
c
->
db
);

530 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

531 
	}
}

533 
	$­³ndCommªd
(
ş›Á
 *
c
) {

534 
size_t
 
tÙËn
;

535 
robj
 *
o
, *
­³nd
;

536 
expœed
 = 0;

538 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

539 
	`lockDbWr™e
(
c
->
db
);

540 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

541 ià(
o
 =ğ
NULL
) {

543 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

544 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
	`dupSŒšgObjeùUncÚ¡ªt
(c->argv[2]));

545 
tÙËn
 = 
	`¡ršgObjeùL’
(
c
->
¬gv
[2]);

548 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

549 
’d
;

552 
­³nd
 = 
c
->
¬gv
[2];

553 
tÙËn
 = 
	`¡ršgObjeùL’
(
o
)+
	`sd¦’
(
­³nd
->
±r
);

554 ià(
	`checkSŒšgL’gth
(
c
,
tÙËn
è!ğ
VR_OK
)

555 
’d
;

558 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

559 
o
->
±r
 = 
	`sdsÿ’
(o->±r,
­³nd
->±r,
	`sd¦’
(append->ptr));

560 
tÙËn
 = 
	`sd¦’
(
o
->
±r
);

562 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

563 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"­³nd",
c
->
¬gv
[1],c->
db
->
id
);

564 
c
->
v–
->
dœty
++;

565 
	`addR•lyLÚgLÚg
(
c
,
tÙËn
);

567 
’d
:

568 
	`uÆockDb
(
c
->
db
);

569 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

570 
	}
}

572 
	$¡¾’Commªd
(
ş›Á
 *
c
) {

573 
robj
 *
o
;

575 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

576 
	`lockDbR—d
(
c
->
db
);

577 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

578 
	`uÆockDb
(
c
->
db
);

579 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

581 } if(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

582 
	`uÆockDb
(
c
->
db
);

583 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

587 
	`addR•lyLÚgLÚg
(
c
,
	`¡ršgObjeùL’
(
o
));

588 
	`uÆockDb
(
c
->
db
);

589 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

590 
	}
}

	@src/vr_t_string.h

1 #iâdeà
_VR_T_STRING_H_


2 
	#_VR_T_STRING_H_


	)

4 
£tG’”icCommªd
(
ş›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
);

5 
£tCommªd
(
ş›Á
 *
c
);

6 
£ŠxCommªd
(
ş›Á
 *
c
);

7 
£‹xCommªd
(
ş›Á
 *
c
);

8 
p£‹xCommªd
(
ş›Á
 *
c
);

9 
g‘G’”icCommªd
(
ş›Á
 *
c
);

10 
g‘Commªd
(
ş›Á
 *
c
);

11 
g‘£tCommªd
(
ş›Á
 *
c
);

12 
£ŒªgeCommªd
(
ş›Á
 *
c
);

13 
g‘¿ngeCommªd
(
ş›Á
 *
c
);

14 
mg‘Commªd
(
ş›Á
 *
c
);

15 
m£tG’”icCommªd
(
ş›Á
 *
c
, 
nx
);

16 
m£tCommªd
(
ş›Á
 *
c
);

17 
m£ŠxCommªd
(
ş›Á
 *
c
);

18 
šüDeüCommªd
(
ş›Á
 *
c
, 
šü
);

19 
šüCommªd
(
ş›Á
 *
c
);

20 
deüCommªd
(
ş›Á
 *
c
);

21 
šübyCommªd
(
ş›Á
 *
c
);

22 
deübyCommªd
(
ş›Á
 *
c
);

23 
šübyæßtCommªd
(
ş›Á
 *
c
);

24 
­³ndCommªd
(
ş›Á
 *
c
);

25 
¡¾’Commªd
(
ş›Á
 *
c
);

	@src/vr_t_zset.c

1 
	~<vr_cÜe.h
>

3 
z¦LexV®ueG‹Mš
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

4 
z¦LexV®ueL‹Max
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

6 
zskli¡Node
 *
	$z¦C»©eNode
(
Ëv–
, 
scÜe
, 
robj
 *
obj
) {

7 
zskli¡Node
 *
zn
 = 
	`d®loc
((*zn)+
Ëv–
*(
zskli¡Lev–
));

8 
zn
->
scÜe
 = score;

9 
zn
->
obj
 = obj;

10  
zn
;

11 
	}
}

13 
zskli¡
 *
	$z¦C»©e
() {

14 
j
;

15 
zskli¡
 *
z¦
;

17 
z¦
 = 
	`d®loc
((*zsl));

18 
z¦
->
Ëv–
 = 1;

19 
z¦
->
Ëngth
 = 0;

20 
z¦
->
h—d”
 = 
	`z¦C»©eNode
(
ZSKIPLIST_MAXLEVEL
,0,
NULL
);

21 
j
 = 0; j < 
ZSKIPLIST_MAXLEVEL
; j++) {

22 
z¦
->
h—d”
->
Ëv–
[
j
].
fÜw¬d
 = 
NULL
;

23 
z¦
->
h—d”
->
Ëv–
[
j
].
¥ª
 = 0;

25 
z¦
->
h—d”
->
backw¬d
 = 
NULL
;

26 
z¦
->

 = 
NULL
;

27  
z¦
;

28 
	}
}

30 
	$z¦F»eNode
(
zskli¡Node
 *
node
) {

32 
	`dä“
(
node
);

33 
	}
}

35 
	$z¦F»e
(
zskli¡
 *
z¦
) {

36 
zskli¡Node
 *
node
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
, *
Ãxt
;

38 
	`dä“
(
z¦
->
h—d”
);

39 
node
) {

40 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

41 
	`z¦F»eNode
(
node
);

42 
node
 = 
Ãxt
;

44 
	`dä“
(
z¦
);

45 
	}
}

51 
	$z¦RªdomLev–
() {

52 
Ëv–
 = 1;

53 (
	`¿ndom
()&0xFFFFè< (
ZSKIPLIST_P
 * 0xFFFF))

54 
Ëv–
 += 1;

55  (
Ëv–
<
ZSKIPLIST_MAXLEVEL
) ?†evel : ZSKIPLIST_MAXLEVEL;

56 
	}
}

58 
zskli¡Node
 *
	$z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
) {

59 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

60 
¿nk
[
ZSKIPLIST_MAXLEVEL
];

61 
i
, 
Ëv–
;

63 
	`ASSERT
(!
	`i¢ª
(
scÜe
));

64 
x
 = 
z¦
->
h—d”
;

65 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

67 
¿nk
[
i
] = i =ğ(
z¦
->
Ëv–
-1) ? 0 :„ank[i+1];

68 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

69 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

70 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

71 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,obj) < 0))) {

72 
¿nk
[
i
] +ğ
x
->
Ëv–
[i].
¥ª
;

73 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

75 
upd©e
[
i
] = 
x
;

81 
Ëv–
 = 
	`z¦RªdomLev–
();

82 ià(
Ëv–
 > 
z¦
->level) {

83 
i
 = 
z¦
->
Ëv–
; i <†evel; i++) {

84 
¿nk
[
i
] = 0;

85 
upd©e
[
i
] = 
z¦
->
h—d”
;

86 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = 
z¦
->
Ëngth
;

88 
z¦
->
Ëv–
 =†evel;

90 
x
 = 
	`z¦C»©eNode
(
Ëv–
,
scÜe
,
obj
);

91 
i
 = 0; i < 
Ëv–
; i++) {

92 
x
->
Ëv–
[
i
].
fÜw¬d
 = 
upd©e
[i]->level[i].forward;

93 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
;

96 
x
->
Ëv–
[
i
].
¥ª
 = 
upd©e
[i]->Ëv–[i].¥ª - (
¿nk
[0] -„ank[i]);

97 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = (
¿nk
[0] -„ank[i]) + 1;

101 
i
 = 
Ëv–
; i < 
z¦
->level; i++) {

102 
upd©e
[
i
]->
Ëv–
[i].
¥ª
++;

105 
x
->
backw¬d
 = (
upd©e
[0] =ğ
z¦
->
h—d”
è? 
NULL
 : update[0];

106 ià(
x
->
Ëv–
[0].
fÜw¬d
)

107 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x;

109 
z¦
->

 = 
x
;

110 
z¦
->
Ëngth
++;

111  
x
;

112 
	}
}

115 
	$z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
) {

116 
i
;

117 
i
 = 0; i < 
z¦
->
Ëv–
; i++) {

118 ià(
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 =ğ
x
) {

119 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 +ğ
x
->level[i].span - 1;

120 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
->level[i].forward;

122 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 -= 1;

125 ià(
x
->
Ëv–
[0].
fÜw¬d
) {

126 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x->backward;

128 
z¦
->

 = 
x
->
backw¬d
;

130 
z¦
->
Ëv–
 > 1 && z¦->
h—d”
->Ëv–[z¦->Ëv–-1].
fÜw¬d
 =ğ
NULL
)

131 
z¦
->
Ëv–
--;

132 
z¦
->
Ëngth
--;

133 
	}
}

136 
	$z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
) {

137 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

138 
i
;

140 
x
 = 
z¦
->
h—d”
;

141 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

142 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

143 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

144 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

145 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,obj) < 0)))

146 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

147 
upd©e
[
i
] = 
x
;

151 
x
 = x->
Ëv–
[0].
fÜw¬d
;

152 ià(
x
 && 
scÜe
 =ğx->scÜ&& 
	`equ®SŒšgObjeùs
(x->
obj
,obj)) {

153 
	`z¦D–‘eNode
(
z¦
, 
x
, 
upd©e
);

154 
	`z¦F»eNode
(
x
);

158 
	}
}

160 
	$z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

161  
¥ec
->
mšex
 ? (
v®ue
 > s³c->
mš
) : (value >= spec->min);

162 
	}
}

164 
	$z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

165  
¥ec
->
maxex
 ? (
v®ue
 < s³c->
max
) : (value <= spec->max);

166 
	}
}

169 
	$z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

170 
zskli¡Node
 *
x
;

173 ià(
¿nge
->
mš
 >„ªge->
max
 ||

174 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

176 
x
 = 
z¦
->

;

177 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueG‹Mš
(x->
scÜe
,
¿nge
))

179 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

180 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueL‹Max
(x->
scÜe
,
¿nge
))

183 
	}
}

187 
zskli¡Node
 *
	$z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

188 
zskli¡Node
 *
x
;

189 
i
;

192 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

194 
x
 = 
z¦
->
h—d”
;

195 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

197 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

198 !
	`z¦V®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

199 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

203 
x
 = x->
Ëv–
[0].
fÜw¬d
;

204 
	`ASSERT
(
x
 !ğ
NULL
);

207 ià(!
	`z¦V®ueL‹Max
(
x
->
scÜe
,
¿nge
)è 
NULL
;

208  
x
;

209 
	}
}

213 
zskli¡Node
 *
	$z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

214 
zskli¡Node
 *
x
;

215 
i
;

218 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

220 
x
 = 
z¦
->
h—d”
;

221 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

223 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

224 
	`z¦V®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

225 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

229 
	`ASSERT
(
x
 !ğ
NULL
);

232 ià(!
	`z¦V®ueG‹Mš
(
x
->
scÜe
,
¿nge
)è 
NULL
;

233  
x
;

234 
	}
}

240 
	$z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

241 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

242 
»moved
 = 0;

243 
i
;

245 
x
 = 
z¦
->
h—d”
;

246 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

247 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
¿nge
->
mšex
 ?

248 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 <ğ
¿nge
->
mš
 :

249 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < 
¿nge
->
mš
))

250 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

251 
upd©e
[
i
] = 
x
;

255 
x
 = x->
Ëv–
[0].
fÜw¬d
;

258 
x
 &&

259 (
¿nge
->
maxex
 ? 
x
->
scÜe
 <„ªge->
max
 : x->score <=„ange->max))

261 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

262 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

263 
	`diùD–‘e
(
diù
,
x
->
obj
);

264 
	`z¦F»eNode
(
x
);

265 
»moved
++;

266 
x
 = 
Ãxt
;

268  
»moved
;

269 
	}
}

271 
	$z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

272 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

273 
»moved
 = 0;

274 
i
;

277 
x
 = 
z¦
->
h—d”
;

278 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

279 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

280 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

281 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

282 
upd©e
[
i
] = 
x
;

286 
x
 = x->
Ëv–
[0].
fÜw¬d
;

289 
x
 && 
	`z¦LexV®ueL‹Max
(x->
obj
,
¿nge
)) {

290 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

291 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

292 
	`diùD–‘e
(
diù
,
x
->
obj
);

293 
	`z¦F»eNode
(
x
);

294 
»moved
++;

295 
x
 = 
Ãxt
;

297  
»moved
;

298 
	}
}

302 
	$z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict) {

303 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

304 
Œav”£d
 = 0, 
»moved
 = 0;

305 
i
;

307 
x
 = 
z¦
->
h—d”
;

308 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

309 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è< 
¡¬t
) {

310 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

311 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

313 
upd©e
[
i
] = 
x
;

316 
Œav”£d
++;

317 
x
 = x->
Ëv–
[0].
fÜw¬d
;

318 
x
 && 
Œav”£d
 <ğ
’d
) {

319 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

320 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

321 
	`diùD–‘e
(
diù
,
x
->
obj
);

322 
	`z¦F»eNode
(
x
);

323 
»moved
++;

324 
Œav”£d
++;

325 
x
 = 
Ãxt
;

327  
»moved
;

328 
	}
}

334 
	$z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
o
) {

335 
zskli¡Node
 *
x
;

336 
¿nk
 = 0;

337 
i
;

339 
x
 = 
z¦
->
h—d”
;

340 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

341 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

342 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

343 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

344 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
o
) <= 0))) {

345 
¿nk
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

346 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

350 ià(
x
->
obj
 && 
	`equ®SŒšgObjeùs
(x->obj,
o
)) {

351  
¿nk
;

355 
	}
}

358 
zskli¡Node
* 
	$z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
) {

359 
zskli¡Node
 *
x
;

360 
Œav”£d
 = 0;

361 
i
;

363 
x
 = 
z¦
->
h—d”
;

364 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

365 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è<ğ
¿nk
)

367 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

368 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

370 ià(
Œav”£d
 =ğ
¿nk
) {

371  
x
;

374  
NULL
;

375 
	}
}

378 
	$z¦P¬£Rªge
(
robj
 *
mš
,„obj *
max
, 
z¿nge¥ec
 *
¥ec
) {

379 *
•Œ
;

380 
¥ec
->
mšex
 = s³c->
maxex
 = 0;

386 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

387 
¥ec
->
mš
 = ()mš->
±r
;

389 ià(((*)
mš
->
±r
)[0] == '(') {

390 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
+1,&
•Œ
);

391 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
VR_ERROR
;

392 
¥ec
->
mšex
 = 1;

394 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
,&
•Œ
);

395 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
VR_ERROR
;

398 ià(
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

399 
¥ec
->
max
 = ()max->
±r
;

401 ià(((*)
max
->
±r
)[0] == '(') {

402 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
+1,&
•Œ
);

403 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
VR_ERROR
;

404 
¥ec
->
maxex
 = 1;

406 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
,&
•Œ
);

407 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
VR_ERROR
;

411  
VR_OK
;

412 
	}
}

429 
	$z¦P¬£LexRªgeI‹m
(
robj
 *
™em
,„obj **
de¡
, *
ex
) {

430 *
c
 = 
™em
->
±r
;

432 
c
[0]) {

434 ià(
c
[1] !ğ'\0'è 
VR_ERROR
;

435 *
ex
 = 0;

436 *
de¡
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
sh¬ed
.
max¡ršg
);

437  
VR_OK
;

439 ià(
c
[1] !ğ'\0'è 
VR_ERROR
;

440 *
ex
 = 0;

441 *
de¡
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
sh¬ed
.
mš¡ršg
);

442  
VR_OK
;

444 *
ex
 = 1;

445 *
de¡
 = 
	`ü—‹SŒšgObjeù
(
c
+1,
	`sd¦’
(c)-1);

446  
VR_OK
;

448 *
ex
 = 0;

449 *
de¡
 = 
	`ü—‹SŒšgObjeù
(
c
+1,
	`sd¦’
(c)-1);

450  
VR_OK
;

452  
VR_ERROR
;

454 
	}
}

461 
	$z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
) {

464 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
 ||

465 
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
è 
VR_ERROR
;

467 
¥ec
->
mš
 = s³c->
max
 = 
NULL
;

468 ià(
	`z¦P¬£LexRªgeI‹m
(
mš
, &
¥ec
->mš, &¥ec->
mšex
è=ğ
VR_ERROR
 ||

469 
	`z¦P¬£LexRªgeI‹m
(
max
, &
¥ec
->max, &¥ec->
maxex
è=ğ
VR_ERROR
) {

470 ià(
¥ec
->
mš
è
	`ä“Objeù
(spec->min);

471 ià(
¥ec
->
max
è
	`ä“Objeù
(spec->max);

472  
VR_ERROR
;

474  
VR_OK
;

476 
	}
}

480 
	$z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
) {

481 
	`ä“Objeù
(
¥ec
->
mš
);

482 
	`ä“Objeù
(
¥ec
->
max
);

483 
	}
}

488 
	$com·»SŒšgObjeùsFÜLexRªge
(
robj
 *
a
,„obj *
b
) {

489 ià(
a
 =ğ
b
)  0;

491 ià(
a
 =ğ
sh¬ed
.
mš¡ršg
 || 
b
 =ğsh¬ed.
max¡ršg
)  -1;

492 ià(
a
 =ğ
sh¬ed
.
max¡ršg
 || 
b
 =ğsh¬ed.
mš¡ršg
)  1;

493  
	`com·»SŒšgObjeùs
(
a
,
b
);

494 
	}
}

496 
	$z¦LexV®ueG‹Mš
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

497  
¥ec
->
mšex
 ?

498 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
mš
) > 0) :

499 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
mš
) >= 0);

500 
	}
}

502 
	$z¦LexV®ueL‹Max
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

503  
¥ec
->
maxex
 ?

504 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
max
) < 0) :

505 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
max
) <= 0);

506 
	}
}

509 
	$z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

510 
zskli¡Node
 *
x
;

513 ià(
	`com·»SŒšgObjeùsFÜLexRªge
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

514 (
	`com·»SŒšgObjeùs
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

515 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

517 
x
 = 
z¦
->

;

518 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueG‹Mš
(x->
obj
,
¿nge
))

520 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

521 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueL‹Max
(x->
obj
,
¿nge
))

524 
	}
}

528 
zskli¡Node
 *
	$z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

529 
zskli¡Node
 *
x
;

530 
i
;

533 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

535 
x
 = 
z¦
->
h—d”
;

536 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

538 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

539 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

540 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

544 
x
 = x->
Ëv–
[0].
fÜw¬d
;

545 
	`ASSERT
(
x
 !ğ
NULL
);

548 ià(!
	`z¦LexV®ueL‹Max
(
x
->
obj
,
¿nge
)è 
NULL
;

549  
x
;

550 
	}
}

554 
zskli¡Node
 *
	$z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

555 
zskli¡Node
 *
x
;

556 
i
;

559 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

561 
x
 = 
z¦
->
h—d”
;

562 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

564 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

565 
	`z¦LexV®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

566 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

570 
	`ASSERT
(
x
 !ğ
NULL
);

573 ià(!
	`z¦LexV®ueG‹Mš
(
x
->
obj
,
¿nge
)è 
NULL
;

574  
x
;

575 
	}
}

581 
	$zzlG‘ScÜe
(*
¥Œ
) {

582 
»t
;

583 *
v¡r
;

584 
vËn
;

585 
vlÚg
;

586 
buf
[128];

587 
scÜe
;

589 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

591 
»t
 = ()
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
);

592 
	`ASSERT
(
»t
 > 0);

594 ià(
v¡r
) {

595 
	`memıy
(
buf
,
v¡r
,
vËn
);

596 
buf
[
vËn
] = '\0';

597 
scÜe
 = 
	`¡¹od
(
buf
,
NULL
);

599 
scÜe
 = 
vlÚg
;

602  
scÜe
;

603 
	}
}

608 
robj
 *
	$zli¡G‘Objeù
(*
¥Œ
) {

609 
»t
;

610 *
v¡r
;

611 
vËn
;

612 
vlÚg
;

614 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

616 
»t
 = ()
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
);

617 
	`ASSERT
(
»t
 > 0);

619 ià(
v¡r
) {

620  
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

622  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

624 
	}
}

627 
	$zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
) {

628 
»t
;

629 *
v¡r
;

630 
vËn
;

631 
vlÚg
;

632 
vbuf
[32];

633 
mšËn
, 
cmp
;

635 
»t
 = ()
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
);

636 
	`ASSERT
(
»t
 > 0);

637 ià(
v¡r
 =ğ
NULL
) {

639 
vËn
 = 
	`Î2¡ršg
((*)
vbuf
,(vbuf),
vlÚg
);

640 
v¡r
 = 
vbuf
;

643 
mšËn
 = (
vËn
 < 
ş’
) ? vlen : clen;

644 
cmp
 = 
	`memcmp
(
v¡r
,
c¡r
,
mšËn
);

645 ià(
cmp
 =ğ0è 
vËn
-
ş’
;

646  
cmp
;

647 
	}
}

649 
	$zzlL’gth
(*
zl
) {

650  
	`zli¡L’
(
zl
)/2;

651 
	}
}

655 
	$zzlNext
(*
zl
, **
•Œ
, **
¥Œ
) {

656 *
_•Œ
, *
_¥Œ
;

657 
	`ASSERT
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

659 
_•Œ
 = 
	`zli¡Next
(
zl
,*
¥Œ
);

660 ià(
_•Œ
 !ğ
NULL
) {

661 
_¥Œ
 = 
	`zli¡Next
(
zl
,
_•Œ
);

662 
	`ASSERT
(
_¥Œ
 !ğ
NULL
);

665 
_¥Œ
 = 
NULL
;

668 *
•Œ
 = 
_•Œ
;

669 *
¥Œ
 = 
_¥Œ
;

670 
	}
}

674 
	$zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
) {

675 *
_•Œ
, *
_¥Œ
;

676 
	`ASSERT
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

678 
_¥Œ
 = 
	`zli¡P»v
(
zl
,*
•Œ
);

679 ià(
_¥Œ
 !ğ
NULL
) {

680 
_•Œ
 = 
	`zli¡P»v
(
zl
,
_¥Œ
);

681 
	`ASSERT
(
_•Œ
 !ğ
NULL
);

684 
_•Œ
 = 
NULL
;

687 *
•Œ
 = 
_•Œ
;

688 *
¥Œ
 = 
_¥Œ
;

689 
	}
}

693 
	$zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

694 *
p
;

695 
scÜe
;

698 ià(
¿nge
->
mš
 >„ªge->
max
 ||

699 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

702 
p
 = 
	`zli¡Index
(
zl
,-1);

703 ià(
p
 =ğ
NULL
)  0;

704 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

705 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

708 
p
 = 
	`zli¡Index
(
zl
,1);

709 
	`ASSERT
(
p
 !ğ
NULL
);

710 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

711 ià(!
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

715 
	}
}

719 *
	$zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

720 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

721 
scÜe
;

724 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

726 
•Œ
 !ğ
NULL
) {

727 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

728 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

730 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

731 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
)) {

733 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

734  
•Œ
;

735  
NULL
;

739 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

742  
NULL
;

743 
	}
}

747 *
	$zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

748 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

749 
scÜe
;

752 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

754 
•Œ
 !ğ
NULL
) {

755 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

756 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

758 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

759 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

761 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

762  
•Œ
;

763  
NULL
;

768 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

769 ià(
¥Œ
 !ğ
NULL
) {

770 
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
);

771 
	`ASSERT
(
•Œ
 !ğ
NULL
);

773 
•Œ
 = 
NULL
;

777  
NULL
;

778 
	}
}

780 
	$zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

781 
robj
 *
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

782 
»s
 = 
	`z¦LexV®ueG‹Mš
(
v®ue
,
¥ec
);

783 
	`ä“Objeù
(
v®ue
);

784  
»s
;

785 
	}
}

787 
	$zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

788 
robj
 *
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

789 
»s
 = 
	`z¦LexV®ueL‹Max
(
v®ue
,
¥ec
);

790 
	`ä“Objeù
(
v®ue
);

791  
»s
;

792 
	}
}

796 
	$zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

797 *
p
;

800 ià(
	`com·»SŒšgObjeùsFÜLexRªge
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

801 (
	`com·»SŒšgObjeùs
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

802 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

805 
p
 = 
	`zli¡Index
(
zl
,-2);

806 ià(
p
 =ğ
NULL
)  0;

807 ià(!
	`zzlLexV®ueG‹Mš
(
p
,
¿nge
))

810 
p
 = 
	`zli¡Index
(
zl
,0);

811 
	`ASSERT
(
p
 !ğ
NULL
);

812 ià(!
	`zzlLexV®ueL‹Max
(
p
,
¿nge
))

816 
	}
}

820 *
	$zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

821 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

824 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

826 
•Œ
 !ğ
NULL
) {

827 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
)) {

829 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
))

830  
•Œ
;

831  
NULL
;

835 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

836 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

837 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

840  
NULL
;

841 
	}
}

845 *
	$zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

846 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

849 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

851 
•Œ
 !ğ
NULL
) {

852 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

854 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
))

855  
•Œ
;

856  
NULL
;

861 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

862 ià(
¥Œ
 !ğ
NULL
) {

863 
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
);

864 
	`ASSERT
(
•Œ
 !ğ
NULL
);

866 
•Œ
 = 
NULL
;

870  
NULL
;

871 
	}
}

873 *
	$zzlFšd
(*
zl
, 
robj
 *
–e
, *
scÜe
) {

874 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

875 
robj
 *
–e_Ãw
;

877 
–e_Ãw
 = 
	`g‘DecodedObjeù
(
–e
);

878 
•Œ
 !ğ
NULL
) {

879 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

880 
	`£rv”As£¹W™hInfo
(
NULL
,
–e_Ãw
,
¥Œ
 != NULL);

882 ià(
	`zli¡Com·»
(
•Œ
,
–e_Ãw
->
±r
,
	`sd¦’
(ele_new->ptr))) {

884 ià(
scÜe
 !ğ
NULL
è*scÜğ
	`zzlG‘ScÜe
(
¥Œ
);

885 ià(
–e_Ãw
!ğ
–e
è
	`ä“Objeù
(ele_new);

886  
•Œ
;

890 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

893 ià(
–e_Ãw
!ğ
–e
è
	`ä“Objeù
(ele_new);

894  
NULL
;

895 
	}
}

899 *
	$zzlD–‘e
(*
zl
, *
•Œ
) {

900 *
p
 = 
•Œ
;

903 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

904 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

905  
zl
;

906 
	}
}

908 *
	$zzlIn£¹At
(*
zl
, *
•Œ
, 
robj
 *
–e
, 
scÜe
) {

909 *
¥Œ
;

910 
scÜebuf
[128];

911 
scÜ–’
;

912 
size_t
 
off£t
;

914 
	`£rv”As£¹W™hInfo
(
NULL
,
–e
,
	`sdsEncodedObjeù
(ele));

915 
scÜ–’
 = 
	`d2¡ršg
(
scÜebuf
,(scÜebuf),
scÜe
);

916 ià(
•Œ
 =ğ
NULL
) {

917 
zl
 = 
	`zli¡Push
(zl,
–e
->
±r
,
	`sd¦’
ÓË->±r),
ZIPLIST_TAIL
);

918 
zl
 = 
	`zli¡Push
(zl,(*)
scÜebuf
,
scÜ–’
,
ZIPLIST_TAIL
);

921 
off£t
 = 
•Œ
-
zl
;

922 
zl
 = 
	`zli¡In£¹
(zl,
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr));

923 
•Œ
 = 
zl
+
off£t
;

926 
	`£rv”As£¹W™hInfo
(
NULL
,
–e
,(
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)) != NULL);

927 
zl
 = 
	`zli¡In£¹
(zl,
¥Œ
,(*)
scÜebuf
,
scÜ–’
);

930  
zl
;

931 
	}
}

935 *
	$zzlIn£¹
(*
zl
, 
robj
 *
–e
, 
scÜe
) {

936 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

937 
s
;

938 
robj
 *
–e_Ãw
;

940 
–e_Ãw
 = 
	`g‘DecodedObjeù
(
–e
);

941 
•Œ
 !ğ
NULL
) {

942 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

943 
	`£rv”As£¹W™hInfo
(
NULL
,
–e_Ãw
,
¥Œ
 != NULL);

944 
s
 = 
	`zzlG‘ScÜe
(
¥Œ
);

946 ià(
s
 > 
scÜe
) {

950 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e_Ãw
,
scÜe
);

952 } ià(
s
 =ğ
scÜe
) {

954 ià(
	`zzlCom·»EËm’ts
(
•Œ
,
–e_Ãw
->
±r
,
	`sd¦’
(ele_new->ptr)) > 0) {

955 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e_Ãw
,
scÜe
);

961 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

965 ià(
•Œ
 =ğ
NULL
)

966 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e_Ãw
,
scÜe
);

968 ià(
–e_Ãw
 !ğ
–e
è
	`ä“Objeù
(ele_new);

969  
zl
;

970 
	}
}

972 *
	$zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

973 *
•Œ
, *
¥Œ
;

974 
scÜe
;

975 
num
 = 0;

977 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

979 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,
¿nge
);

980 ià(
•Œ
 =ğ
NULL
è 
zl
;

984 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

985 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

986 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

988 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

989 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

990 
num
++;

997 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

998  
zl
;

999 
	}
}

1001 *
	$zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1002 *
•Œ
, *
¥Œ
;

1003 
num
 = 0;

1005 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1007 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,
¿nge
);

1008 ià(
•Œ
 =ğ
NULL
è 
zl
;

1012 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1013 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

1015 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1016 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1017 
num
++;

1024 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1025  
zl
;

1026 
	}
}

1030 *
	$zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
) {

1031 
num
 = (
’d
-
¡¬t
)+1;

1032 ià(
d–‘ed
è*d–‘ed = 
num
;

1033 
zl
 = 
	`zli¡D–‘eRªge
(zl,2*(
¡¬t
-1),2*
num
);

1034  
zl
;

1035 
	}
}

1041 
	$z£tL’gth
(
robj
 *
zobj
) {

1042 
Ëngth
 = -1;

1043 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1044 
Ëngth
 = 
	`zzlL’gth
(
zobj
->
±r
);

1045 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1046 
Ëngth
 = ((
z£t
*)
zobj
->
±r
)->
z¦
->length;

1048 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1050  
Ëngth
;

1051 
	}
}

1053 
	$z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
) {

1054 
z£t
 *
zs
;

1055 
zskli¡Node
 *
node
, *
Ãxt
;

1056 
robj
 *
–e
;

1057 
scÜe
;

1059 ià(
zobj
->
’codšg
 ==ƒncoding) ;

1060 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1061 *
zl
 = 
zobj
->
±r
;

1062 *
•Œ
, *
¥Œ
;

1063 *
v¡r
;

1064 
vËn
;

1065 
vlÚg
;

1067 ià(
’codšg
 !ğ
OBJ_ENCODING_SKIPLIST
)

1068 
	`£rv”Pªic
("Unknownargetƒncoding");

1070 
zs
 = 
	`d®loc
((*zs));

1071 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

1072 
zs
->
z¦
 = 
	`z¦C»©e
();

1074 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1075 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
•Œ
 != NULL);

1076 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1077 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
¥Œ
 != NULL);

1079 
•Œ
 !ğ
NULL
) {

1080 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1081 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

1082 ià(
v¡r
 =ğ
NULL
)

1083 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

1085 
–e
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

1088 
node
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1089 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
	`diùAdd
(
zs
->
diù
,
–e
,&
node
->
scÜe
è=ğ
DICT_OK
);

1090 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1093 
	`dä“
(
zobj
->
±r
);

1094 
zobj
->
±r
 = 
zs
;

1095 
zobj
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

1096 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1097 *
zl
 = 
	`zli¡New
();

1099 ià(
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
)

1100 
	`£rv”Pªic
("Unknownargetƒncoding");

1104 
zs
 = 
zobj
->
±r
;

1105 
node
 = 
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1106 
	`dä“
(
zs
->
z¦
->
h—d”
);

1107 
	`dä“
(
zs
->
z¦
);

1109 
node
) {

1110 
–e
 = 
	`g‘DecodedObjeù
(
node
->
obj
);

1111 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e
,
node
->
scÜe
);

1112 ià(
–e
 !ğ
node
->
obj
è
	`ä“Objeù
(ele);

1113 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

1114 
	`z¦F»eNode
(
node
);

1115 
node
 = 
Ãxt
;

1118 
	`diùR–—£
(
zs
->
diù
);

1119 
	`dä“
(
zs
);

1120 
zobj
->
±r
 = 
zl
;

1121 
zobj
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1123 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1125 
	}
}

1130 
	$z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
) {

1131 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) ;

1132 
z£t
 *z£ˆğ
zobj
->
±r
;

1134 ià(
z£t
->
z¦
->
Ëngth
 <ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

1135 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

1136 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_ZIPLIST
);

1137 
	}
}

1143 
	$z£tScÜe
(
robj
 *
zobj
,„obj *
memb”
, *
scÜe
) {

1144 ià(!
zobj
 || !
memb”
è 
VR_ERROR
;

1146 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1147 ià(
	`zzlFšd
(
zobj
->
±r
, 
memb”
, 
scÜe
è=ğ
NULL
è 
VR_ERROR
;

1148 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1149 
z£t
 *
zs
 = 
zobj
->
±r
;

1150 
diùEÁry
 *
de
 = 
	`diùFšd
(
zs
->
diù
, 
memb”
);

1151 ià(
de
 =ğ
NULL
è 
VR_ERROR
;

1152 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1154 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1156  
VR_OK
;

1157 
	}
}

1164 
	#ZADD_NONE
 0

	)

1165 
	#ZADD_INCR
 (1<<0è

	)

1166 
	#ZADD_NX
 (1<<1è

	)

1167 
	#ZADD_XX
 (1<<2è

	)

1168 
	#ZADD_CH
 (1<<3è

	)

1170 
	$zaddG’”icCommªd
(
ş›Á
 *
c
, 
æags
) {

1171 *
ÇÃ¼
 = "resulting score is‚ot‡‚umber (NaN)";

1172 
robj
 *
key
 = 
c
->
¬gv
[1];

1173 
robj
 *
–e
;

1174 
robj
 *
zobj
;

1175 
robj
 *
curobj
;

1176 
scÜe
 = 0, *
scÜes
 = 
NULL
, 
curscÜe
 = 0.0;

1177 
j
, 
–em’ts
;

1178 
scÜeidx
 = 0;

1182 
added
 = 0;

1183 
upd©ed
 = 0;

1184 
´oûs£d
 = 0;

1186 
expœed
 = 0;

1190 
scÜeidx
 = 2;

1191 
scÜeidx
 < 
c
->
¬gc
) {

1192 *
İt
 = 
c
->
¬gv
[
scÜeidx
]->
±r
;

1193 ià(!
	`¡rÿ£cmp
(
İt
,"nx")è
æags
 |ğ
ZADD_NX
;

1194 ià(!
	`¡rÿ£cmp
(
İt
,"xx")è
æags
 |ğ
ZADD_XX
;

1195 ià(!
	`¡rÿ£cmp
(
İt
,"ch")è
æags
 |ğ
ZADD_CH
;

1196 ià(!
	`¡rÿ£cmp
(
İt
,"šü")è
æags
 |ğ
ZADD_INCR
;

1198 
scÜeidx
++;

1202 
šü
 = (
æags
 & 
ZADD_INCR
) != 0;

1203 
nx
 = (
æags
 & 
ZADD_NX
) != 0;

1204 
xx
 = (
æags
 & 
ZADD_XX
) != 0;

1205 
ch
 = (
æags
 & 
ZADD_CH
) != 0;

1209 
–em’ts
 = 
c
->
¬gc
-
scÜeidx
;

1210 ià(
–em’ts
 % 2) {

1211 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1214 
–em’ts
 /= 2;

1217 ià(
nx
 && 
xx
) {

1218 
	`addR•lyE¼Ü
(
c
,

1223 ià(
šü
 && 
–em’ts
 > 1) {

1224 
	`addR•lyE¼Ü
(
c
,

1232 
scÜes
 = 
	`d®loc
(()*
–em’ts
);

1233 
j
 = 0; j < 
–em’ts
; j++) {

1234 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
scÜeidx
+
j
*2],&
scÜes
[j],
NULL
)

1235 !ğ
VR_OK
è
ş—nup
;

1238 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1239 
	`lockDbWr™e
(
c
->
db
);

1241 
zobj
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
,&
expœed
);

1242 ià(
zobj
 =ğ
NULL
) {

1243 ià(
xx
) {

1244 
	`uÆockDb
(
c
->
db
);

1245 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1246 
»¶y_to_ş›Á
;

1248 ià(
£rv”
.
z£t_max_zli¡_’Œ›s
 == 0 ||

1249 
£rv”
.
z£t_max_zli¡_v®ue
 < 
	`sd¦’
(
c
->
¬gv
[
scÜeidx
+1]->
±r
))

1251 
zobj
 = 
	`ü—‹Z£tObjeù
();

1253 
zobj
 = 
	`ü—‹Z£tZli¡Objeù
();

1255 
	`dbAdd
(
c
->
db
,
key
,
zobj
);

1257 ià(
zobj
->
ty³
 !ğ
OBJ_ZSET
) {

1258 
	`uÆockDb
(
c
->
db
);

1259 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1260 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1261 
ş—nup
;

1265 
j
 = 0; j < 
–em’ts
; j++) {

1266 
scÜe
 = 
scÜes
[
j
];

1268 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1269 *
•Œ
;

1272 
–e
 = 
c
->
¬gv
[
scÜeidx
+1+
j
*2];

1273 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,&
curscÜe
)è!ğ
NULL
) {

1274 ià(
nx
) ;

1275 ià(
šü
) {

1276 
scÜe
 +ğ
curscÜe
;

1277 ià(
	`i¢ª
(
scÜe
)) {

1278 
	`uÆockDb
(
c
->
db
);

1279 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1280 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1281 
ş—nup
;

1286 ià(
scÜe
 !ğ
curscÜe
) {

1287 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1288 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1289 
c
->
v–
->
dœty
++;

1290 
upd©ed
++;

1292 
´oûs£d
++;

1293 } ià(!
xx
) {

1296 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1297 ià(
	`zzlL’gth
(
zobj
->
±r
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1298 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1299 ià(
	`sd¦’
(
–e
->
±r
è> 
£rv”
.
z£t_max_zli¡_v®ue
)

1300 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1301 
c
->
v–
->
dœty
++;

1302 
added
++;

1303 
´oûs£d
++;

1305 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1306 
z£t
 *
zs
 = 
zobj
->
±r
;

1307 
zskli¡Node
 *
znode
;

1308 
diùEÁry
 *
de
;

1310 
–e
 = 
c
->
¬gv
[
scÜeidx
+1+
j
*2] =

1311 
	`ŒyObjeùEncodšg
(
c
->
¬gv
[
scÜeidx
+1+
j
*2]);

1312 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1313 ià(
de
 !ğ
NULL
) {

1314 ià(
nx
) ;

1315 
curobj
 = 
	`diùG‘Key
(
de
);

1316 
curscÜe
 = *(*)
	`diùG‘V®
(
de
);

1318 ià(
šü
) {

1319 
scÜe
 +ğ
curscÜe
;

1320 ià(
	`i¢ª
(
scÜe
)) {

1321 
	`uÆockDb
(
c
->
db
);

1322 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1323 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1326 
ş—nup
;

1333 ià(
scÜe
 !ğ
curscÜe
) {

1334 
	`£rv”As£¹W™hInfo
(
c
,
curobj
,
	`z¦D–‘e
(
zs
->
z¦
,
curscÜe
,curobj));

1335 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
curobj
);

1336 
	`diùG‘V®
(
de
èğ&
znode
->
scÜe
;

1337 
c
->
v–
->
dœty
++;

1338 
upd©ed
++;

1340 
´oûs£d
++;

1341 } ià(!
xx
) {

1342 
–e
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(ele);

1343 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1344 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`diùAdd
(
zs
->
diù
,
–e
,&
znode
->
scÜe
è=ğ
DICT_OK
);

1345 
c
->
v–
->
dœty
++;

1346 
added
++;

1347 
´oûs£d
++;

1350 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1354 
	`uÆockDb
(
c
->
db
);

1355 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1357 
»¶y_to_ş›Á
:

1358 ià(
šü
) {

1359 ià(
´oûs£d
)

1360 
	`addR•lyDoubË
(
c
,
scÜe
);

1362 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1364 
	`addR•lyLÚgLÚg
(
c
,
ch
 ? 
added
+
upd©ed
 :‡dded);

1367 
ş—nup
:

1368 
	`dä“
(
scÜes
);

1369 ià(
added
 || 
upd©ed
) {

1370 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1371 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

1372 
šü
 ? "zšü" : "zadd", 
key
, 
c
->
db
->
id
);

1374 
	}
}

1376 
	$zaddCommªd
(
ş›Á
 *
c
) {

1377 
	`zaddG’”icCommªd
(
c
,
ZADD_NONE
);

1378 
	}
}

1380 
	$zšübyCommªd
(
ş›Á
 *
c
) {

1381 
	`zaddG’”icCommªd
(
c
,
ZADD_INCR
);

1382 
	}
}

1384 
	$z»mCommªd
(
ş›Á
 *
c
) {

1385 
robj
 *
key
 = 
c
->
¬gv
[1];

1386 
robj
 *
zobj
;

1387 
d–‘ed
 = 0, 
key»moved
 = 0, 
j
;

1388 
expœed
 = 0;

1390 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1391 
	`lockDbWr™e
(
c
->
db
);

1392 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

1393 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

1394 
	`uÆockDb
(
c
->
db
);

1395 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1399 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1400 *
•Œ
;

1402 
j
 = 2; j < 
c
->
¬gc
; j++) {

1403 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
c
->
¬gv
[
j
],
NULL
)) != NULL) {

1404 
d–‘ed
++;

1405 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1406 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1407 
	`dbD–‘e
(
c
->
db
,
key
);

1408 
key»moved
 = 1;

1413 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1414 
z£t
 *
zs
 = 
zobj
->
±r
;

1415 
diùEÁry
 *
de
;

1416 
scÜe
;

1418 
j
 = 2; j < 
c
->
¬gc
; j++) {

1419 
de
 = 
	`diùFšd
(
zs
->
diù
,
c
->
¬gv
[
j
]);

1420 ià(
de
 !ğ
NULL
) {

1421 
d–‘ed
++;

1424 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1425 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[
j
],
	`z¦D–‘e
(
zs
->
z¦
,
scÜe
,c->argv[j]));

1428 
	`diùD–‘e
(
zs
->
diù
,
c
->
¬gv
[
j
]);

1429 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1430 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1431 
	`dbD–‘e
(
c
->
db
,
key
);

1432 
key»moved
 = 1;

1438 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1441 ià(
d–‘ed
) {

1442 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,"z»m",
key
,
c
->
db
->
id
);

1443 ià(
key»moved
)

1444 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1445 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1446 
c
->
v–
->
dœty
 +ğ
d–‘ed
;

1448 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1449 
	`uÆockDb
(
c
->
db
);

1450 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1451 
	}
}

1454 
	#ZRANGE_RANK
 0

	)

1455 
	#ZRANGE_SCORE
 1

	)

1456 
	#ZRANGE_LEX
 2

	)

1457 
	$z»m¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
¿ng‘y³
) {

1458 
robj
 *
key
 = 
c
->
¬gv
[1];

1459 
robj
 *
zobj
;

1460 
key»moved
 = 0;

1461 
d–‘ed
 = 0;

1462 
z¿nge¥ec
 
¿nge
;

1463 
zËx¿nge¥ec
 
Ëx¿nge
;

1464 
¡¬t
, 
’d
, 
Î’
;

1465 
expœed
 = 0;

1468 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1469 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
VR_OK
) ||

1470 (
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
VR_OK
))

1472 } ià(
¿ng‘y³
 =ğ
ZRANGE_SCORE
) {

1473 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
VR_OK
) {

1474 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

1477 } ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
) {

1478 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
Ëx¿nge
è!ğ
VR_OK
) {

1479 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

1484 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1485 
	`lockDbWr™e
(
c
->
db
);

1487 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

1488 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)è
ş—nup
;

1490 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1492 
Î’
 = 
	`z£tL’gth
(
zobj
);

1493 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

1494 ià(
’d
 < 0è’d = 
Î’
+end;

1495 ià(
¡¬t
 < 0) start = 0;

1499 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

1500 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1501 
ş—nup
;

1503 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

1507 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1508 
¿ng‘y³
) {

1509 
ZRANGE_RANK
:

1510 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByRªk
(zobj->±r,
¡¬t
+1,
’d
+1,&
d–‘ed
);

1512 
ZRANGE_SCORE
:

1513 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByScÜe
(zobj->±r,&
¿nge
,&
d–‘ed
);

1515 
ZRANGE_LEX
:

1516 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByLex
(zobj->±r,&
Ëx¿nge
,&
d–‘ed
);

1519 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1520 
	`dbD–‘e
(
c
->
db
,
key
);

1521 
key»moved
 = 1;

1523 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1524 
z£t
 *
zs
 = 
zobj
->
±r
;

1525 
¿ng‘y³
) {

1526 
ZRANGE_RANK
:

1527 
d–‘ed
 = 
	`z¦D–‘eRªgeByRªk
(
zs
->
z¦
,
¡¬t
+1,
’d
+1,zs->
diù
);

1529 
ZRANGE_SCORE
:

1530 
d–‘ed
 = 
	`z¦D–‘eRªgeByScÜe
(
zs
->
z¦
,&
¿nge
,zs->
diù
);

1532 
ZRANGE_LEX
:

1533 
d–‘ed
 = 
	`z¦D–‘eRªgeByLex
(
zs
->
z¦
,&
Ëx¿nge
,zs->
diù
);

1536 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1537 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1538 
	`dbD–‘e
(
c
->
db
,
key
);

1539 
key»moved
 = 1;

1542 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1546 ià(
d–‘ed
) {

1547 *
ev’t
[3] = {"zremrangebyrank","zremrangebyscore","zremrangebylex"};

1548 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1549 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,
ev’t
[
¿ng‘y³
],
key
,
c
->
db
->
id
);

1550 ià(
key»moved
)

1551 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1553 
c
->
v–
->
dœty
 +ğ
d–‘ed
;

1554 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1556 
ş—nup
:

1557 ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
è
	`z¦F»eLexRªge
(&
Ëx¿nge
);

1558 
	`uÆockDb
(
c
->
db
);

1559 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1560 
	}
}

1562 
	$z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
) {

1563 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_RANK
);

1564 
	}
}

1566 
	$z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

1567 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_SCORE
);

1568 
	}
}

1570 
	$z»m¿ngebyËxCommªd
(
ş›Á
 *
c
) {

1571 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_LEX
);

1572 
	}
}

1580 
	#OPVAL_DIRTY_ROBJ
 1

	)

1581 
	#OPVAL_DIRTY_LL
 2

	)

1582 
	#OPVAL_VALID_LL
 4

	)

1584 
_™”£t
 
	t™”£t
;

1585 
_™”z£t
 
	t™”z£t
;

1587 
	$zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1588 ià(
İ
->
subjeù
 =ğ
NULL
)

1591 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1592 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1593 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1594 
™
->
is
.i ğ
İ
->
subjeù
->
±r
;

1595 
™
->
is
.
ii
 = 0;

1596 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1597 
™
->
ht
.
diù
 = 
İ
->
subjeù
->
±r
;

1598 
™
->
ht
.
di
 = 
	`diùG‘I‹¿tÜ
(
İ
->
subjeù
->
±r
);

1599 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1601 
	`£rv”Pªic
("Unknown setƒncoding");

1603 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1604 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1605 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1606 
™
->
zl
.zÈğ
İ
->
subjeù
->
±r
;

1607 
™
->
zl
.
•Œ
 = 
	`zli¡Index
(it->zl.zl,0);

1608 ià(
™
->
zl
.
•Œ
 !ğ
NULL
) {

1609 
™
->
zl
.
¥Œ
 = 
	`zli¡Next
(™->zl.zl,™->zl.
•Œ
);

1610 
	`ASSERT
(
™
->
zl
.
¥Œ
 !ğ
NULL
);

1612 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1613 
™
->
¦
.
zs
 = 
İ
->
subjeù
->
±r
;

1614 
™
->
¦
.
node
 = it->¦.
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1616 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1619 
	`£rv”Pªic
("Unsupportedype");

1621 
	}
}

1623 
	$zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1624 ià(
İ
->
subjeù
 =ğ
NULL
)

1627 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1628 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1629 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1630 
	`UNUSED
(
™
);

1631 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1632 
	`diùR–—£I‹¿tÜ
(
™
->
ht
.
di
);

1634 
	`£rv”Pªic
("Unknown setƒncoding");

1636 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1637 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1638 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1639 
	`UNUSED
(
™
);

1640 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1641 
	`UNUSED
(
™
);

1643 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1646 
	`£rv”Pªic
("Unsupportedype");

1648 
	}
}

1650 
	$zuiL’gth
(
z£tİ¤c
 *
İ
) {

1651 ià(
İ
->
subjeù
 =ğ
NULL
)

1654 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1655 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1656  
	`št£tL’
(
İ
->
subjeù
->
±r
);

1657 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1658 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1659  
	`diùSize
(
ht
);

1661 
	`£rv”Pªic
("Unknown setƒncoding");

1663 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1664 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1665  
	`zzlL’gth
(
İ
->
subjeù
->
±r
);

1666 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1667 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1668  
zs
->
z¦
->
Ëngth
;

1670 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1673 
	`£rv”Pªic
("Unsupportedype");

1675 
	}
}

1680 
	$zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
) {

1681 
»t
;

1683 ià(
İ
->
subjeù
 =ğ
NULL
)

1686 ià(
v®
->
æags
 & 
OPVAL_DIRTY_ROBJ
)

1687 
	`deüRefCouÁ
(
v®
->
–e
);

1689 
	`mem£t
(
v®
,0,(
z£tİv®
));

1691 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1692 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1693 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1694 
št64_t
 
–l
;

1696 ià(!
	`št£tG‘
(
™
->
is
.is,™->is.
ii
,&
–l
))

1698 
v®
->
–l
 =ƒll;

1699 
v®
->
scÜe
 = 1.0;

1702 
™
->
is
.
ii
++;

1703 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1704 ià(
™
->
ht
.
de
 =ğ
NULL
)

1706 
v®
->
–e
 = 
	`diùG‘Key
(
™
->
ht
.
de
);

1707 
v®
->
scÜe
 = 1.0;

1710 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1712 
	`£rv”Pªic
("Unknown setƒncoding");

1714 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1715 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1716 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1718 ià(
™
->
zl
.
•Œ
 =ğ
NULL
 || it->zl.
¥Œ
 == NULL)

1720 
»t
 = (è
	`zli¡G‘
(
™
->
zl
.
•Œ
,&
v®
->
e¡r
,&v®->
–’
,&v®->
–l
);

1721 
	`ASSERT
(
»t
 > 0);

1722 
v®
->
scÜe
 = 
	`zzlG‘ScÜe
(
™
->
zl
.
¥Œ
);

1725 
	`zzlNext
(
™
->
zl
.zl,&™->zl.
•Œ
,&™->zl.
¥Œ
);

1726 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1727 ià(
™
->
¦
.
node
 =ğ
NULL
)

1729 
v®
->
–e
 = 
™
->
¦
.
node
->
obj
;

1730 
v®
->
scÜe
 = 
™
->
¦
.
node
->score;

1733 
™
->
¦
.
node
 = it->¦.node->
Ëv–
[0].
fÜw¬d
;

1735 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1738 
	`£rv”Pªic
("Unsupportedype");

1741 
	}
}

1743 
	$zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
) {

1744 ià(!(
v®
->
æags
 & 
OPVAL_DIRTY_LL
)) {

1745 
v®
->
æags
 |ğ
OPVAL_DIRTY_LL
;

1747 ià(
v®
->
–e
 !ğ
NULL
) {

1748 ià(
v®
->
–e
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

1749 
v®
->
–l
 = ()v®->
–e
->
±r
;

1750 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1751 } ià(
	`sdsEncodedObjeù
(
v®
->
–e
)) {

1752 ià(
	`¡ršg2Î
(
v®
->
–e
->
±r
,
	`sd¦’
(v®->–e->±r),&v®->
–l
))

1753 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1755 
	`£rv”Pªic
("Unsupportedƒlementƒncoding");

1757 } ià(
v®
->
e¡r
 !ğ
NULL
) {

1758 ià(
	`¡ršg2Î
((*)
v®
->
e¡r
,v®->
–’
,&v®->
–l
))

1759 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1762 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1765  
v®
->
æags
 & 
OPVAL_VALID_LL
;

1766 
	}
}

1768 
robj
 *
	$zuiObjeùFromV®ue
(
z£tİv®
 *
v®
) {

1769 ià(
v®
->
–e
 =ğ
NULL
) {

1770 ià(
v®
->
e¡r
 !ğ
NULL
) {

1771 
v®
->
–e
 = 
	`ü—‹SŒšgObjeù
((*)v®->
e¡r
,v®->
–’
);

1773 
v®
->
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(v®->
–l
);

1775 
v®
->
æags
 |ğ
OPVAL_DIRTY_ROBJ
;

1777  
v®
->
–e
;

1778 
	}
}

1780 
	$zuiBufãrFromV®ue
(
z£tİv®
 *
v®
) {

1781 ià(
v®
->
e¡r
 =ğ
NULL
) {

1782 ià(
v®
->
–e
 !ğ
NULL
) {

1783 ià(
v®
->
–e
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

1784 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),()v®->
–e
->
±r
);

1785 
v®
->
e¡r
 = v®->
_buf
;

1786 } ià(
	`sdsEncodedObjeù
(
v®
->
–e
)) {

1787 
v®
->
–’
 = 
	`sd¦’
(v®->
–e
->
±r
);

1788 
v®
->
e¡r
 = v®->
–e
->
±r
;

1790 
	`£rv”Pªic
("Unsupportedƒlementƒncoding");

1793 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),v®->
–l
);

1794 
v®
->
e¡r
 = v®->
_buf
;

1798 
	}
}

1802 
	$zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
) {

1803 ià(
İ
->
subjeù
 =ğ
NULL
)

1806 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1807 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1808 ià(
	`zuiLÚgLÚgFromV®ue
(
v®
) &&

1809 
	`št£tFšd
(
İ
->
subjeù
->
±r
,
v®
->
–l
))

1811 *
scÜe
 = 1.0;

1816 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1817 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1818 
	`zuiObjeùFromV®ue
(
v®
);

1819 ià(
	`diùFšd
(
ht
,
v®
->
–e
è!ğ
NULL
) {

1820 *
scÜe
 = 1.0;

1826 
	`£rv”Pªic
("Unknown setƒncoding");

1828 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1829 
	`zuiObjeùFromV®ue
(
v®
);

1831 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1832 ià(
	`zzlFšd
(
İ
->
subjeù
->
±r
,
v®
->
–e
,
scÜe
è!ğ
NULL
) {

1838 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1839 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1840 
diùEÁry
 *
de
;

1841 ià((
de
 = 
	`diùFšd
(
zs
->
diù
,
v®
->
–e
)è!ğ
NULL
) {

1842 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1848 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1851 
	`£rv”Pªic
("Unsupportedype");

1853 
	}
}

1855 
	$zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

1856  
	`zuiL’gth
((
z£tİ¤c
*)
s1
è- zuiL’gth((z£tİ¤c*)
s2
);

1857 
	}
}

1859 
	#REDIS_AGGR_SUM
 1

	)

1860 
	#REDIS_AGGR_MIN
 2

	)

1861 
	#REDIS_AGGR_MAX
 3

	)

1862 
	#zuniÚIÁ”DiùV®ue
(
_e
è(
	`diùG‘V®
(_eè=ğ
NULL
 ? 1.0 : *(*)diùG‘V®(_e))

	)

1864 
šlše
 
	$zuniÚIÁ”Agg»g©e
(*
rg‘
, 
v®
, 
agg»g©e
) {

1865 ià(
agg»g©e
 =ğ
REDIS_AGGR_SUM
) {

1866 *
rg‘
 = *rg‘ + 
v®
;

1870 ià(
	`i¢ª
(*
rg‘
)) *target = 0.0;

1871 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MIN
) {

1872 *
rg‘
 = 
v®
 < *target ? val : *target;

1873 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MAX
) {

1874 *
rg‘
 = 
v®
 > *target ? val : *target;

1877 
	`£rv”Pªic
("Unknown ZUNION/INTER‡ggregateype");

1879 
	}
}

1881 
	#SET_OP_UNION
 0

	)

1882 
	#SET_OP_DIFF
 1

	)

1883 
	#SET_OP_INTER
 2

	)

1885 
	$zuniÚIÁ”G’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
d¡key
, 
İ
) {

1886 
i
, 
j
;

1887 
£Šum
;

1888 
agg»g©e
 = 
REDIS_AGGR_SUM
;

1889 
z£tİ¤c
 *
¤c
;

1890 
z£tİv®
 
zv®
;

1891 
robj
 *
tmp
;

1892 
max––’
 = 0;

1893 
robj
 *
d¡obj
;

1894 
z£t
 *
d¡z£t
;

1895 
zskli¡Node
 *
znode
;

1896 
touched
 = 0;

1899 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
£Šum
, 
NULL
è!ğ
VR_OK
))

1902 ià(
£Šum
 < 1) {

1903 
	`addR•lyE¼Ü
(
c
,

1909 ià(
£Šum
 > 
c
->
¬gc
-3) {

1910 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1915 
¤c
 = 
	`dÿÎoc
(
£Šum
, (
z£tİ¤c
));

1916 
i
 = 0, 
j
 = 3; i < 
£Šum
; i++, j++) {

1917 
robj
 *
obj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
],
NULL
);

1918 ià(
obj
 !ğ
NULL
) {

1919 ià(
obj
->
ty³
 !ğ
OBJ_ZSET
 && obj->ty³ !ğ
OBJ_SET
) {

1920 
	`dä“
(
¤c
);

1921 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1925 
¤c
[
i
].
subjeù
 = 
obj
;

1926 
¤c
[
i
].
ty³
 = 
obj
->type;

1927 
¤c
[
i
].
’codšg
 = 
obj
->encoding;

1929 
¤c
[
i
].
subjeù
 = 
NULL
;

1933 
¤c
[
i
].
weight
 = 1.0;

1937 ià(
j
 < 
c
->
¬gc
) {

1938 
»maššg
 = 
c
->
¬gc
 - 
j
;

1940 
»maššg
) {

1941 ià(
»maššg
 >ğ(
£Šum
 + 1è&& !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"weights")) {

1942 
j
++; 
»maššg
--;

1943 
i
 = 0; i < 
£Šum
; i++, 
j
++, 
»maššg
--) {

1944 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
],&
¤c
[
i
].
weight
,

1945 "weighˆv®ui nÙ‡ flßt"è!ğ
VR_OK
)

1947 
	`dä“
(
¤c
);

1951 } ià(
»maššg
 >ğ2 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"aggregate")) {

1952 
j
++; 
»maššg
--;

1953 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"sum")) {

1954 
agg»g©e
 = 
REDIS_AGGR_SUM
;

1955 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"min")) {

1956 
agg»g©e
 = 
REDIS_AGGR_MIN
;

1957 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"max")) {

1958 
agg»g©e
 = 
REDIS_AGGR_MAX
;

1960 
	`dä“
(
¤c
);

1961 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1964 
j
++; 
»maššg
--;

1966 
	`dä“
(
¤c
);

1967 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1975 
	`qsÜt
(
¤c
,
£Šum
,(
z£tİ¤c
),
zuiCom·»ByC¬dš®™y
);

1977 
d¡obj
 = 
	`ü—‹Z£tObjeù
();

1978 
d¡z£t
 = 
d¡obj
->
±r
;

1979 
	`mem£t
(&
zv®
, 0, (zval));

1981 ià(
İ
 =ğ
SET_OP_INTER
) {

1983 ià(
	`zuiL’gth
(&
¤c
[0]) > 0) {

1986 
	`zuiIn™I‹¿tÜ
(&
¤c
[0]);

1987 
	`zuiNext
(&
¤c
[0],&
zv®
)) {

1988 
scÜe
, 
v®ue
;

1990 
scÜe
 = 
¤c
[0].
weight
 * 
zv®
.score;

1991 ià(
	`i¢ª
(
scÜe
)) score = 0;

1993 
j
 = 1; j < 
£Šum
; j++) {

1996 ià(
¤c
[
j
].
subjeù
 == src[0].subject) {

1997 
v®ue
 = 
zv®
.
scÜe
*
¤c
[
j
].
weight
;

1998 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

1999 } ià(
	`zuiFšd
(&
¤c
[
j
],&
zv®
,&
v®ue
)) {

2000 
v®ue
 *ğ
¤c
[
j
].
weight
;

2001 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

2008 ià(
j
 =ğ
£Šum
) {

2009 
tmp
 = 
	`zuiObjeùFromV®ue
(&
zv®
);

2010 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
tmp
);

2011 
	`šüRefCouÁ
(
tmp
);

2012 
	`diùAdd
(
d¡z£t
->
diù
,
tmp
,&
znode
->
scÜe
);

2013 
	`šüRefCouÁ
(
tmp
);

2015 ià(
	`sdsEncodedObjeù
(
tmp
)) {

2016 ià(
	`sd¦’
(
tmp
->
±r
è> 
max––’
)

2017 
max––’
 = 
	`sd¦’
(
tmp
->
±r
);

2021 
	`zuiCË¬I‹¿tÜ
(&
¤c
[0]);

2023 } ià(
İ
 =ğ
SET_OP_UNION
) {

2024 
diù
 *
accumuÏtÜ
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

2025 
diùI‹¿tÜ
 *
di
;

2026 
diùEÁry
 *
de
;

2027 
scÜe
;

2029 ià(
£Šum
) {

2032 
	`diùEx·nd
(
accumuÏtÜ
,
	`zuiL’gth
(&
¤c
[
£Šum
-1]));

2037 
i
 = 0; i < 
£Šum
; i++) {

2038 ià(
	`zuiL’gth
(&
¤c
[
i
]) == 0) ;

2040 
	`zuiIn™I‹¿tÜ
(&
¤c
[
i
]);

2041 
	`zuiNext
(&
¤c
[
i
],&
zv®
)) {

2043 
scÜe
 = 
¤c
[
i
].
weight
 * 
zv®
.score;

2044 ià(
	`i¢ª
(
scÜe
)) score = 0;

2047 
de
 = 
	`diùFšd
(
accumuÏtÜ
,
	`zuiObjeùFromV®ue
(&
zv®
));

2049 ià(
de
 =ğ
NULL
) {

2050 
tmp
 = 
	`zuiObjeùFromV®ue
(&
zv®
);

2054 ià(
	`sdsEncodedObjeù
(
tmp
)) {

2055 ià(
	`sd¦’
(
tmp
->
±r
è> 
max––’
)

2056 
max––’
 = 
	`sd¦’
(
tmp
->
±r
);

2059 
de
 = 
	`diùAddRaw
(
accumuÏtÜ
,
tmp
);

2060 
	`šüRefCouÁ
(
tmp
);

2061 
	`diùS‘DoubËV®
(
de
,
scÜe
);

2069 
	`zuniÚIÁ”Agg»g©e
(&
de
->
v
.
d
,
scÜe
,
agg»g©e
);

2072 
	`zuiCË¬I‹¿tÜ
(&
¤c
[
i
]);

2076 
di
 = 
	`diùG‘I‹¿tÜ
(
accumuÏtÜ
);

2081 
	`diùEx·nd
(
d¡z£t
->
diù
,
	`diùSize
(
accumuÏtÜ
));

2083 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2084 
robj
 *
–e
 = 
	`diùG‘Key
(
de
);

2085 
scÜe
 = 
	`diùG‘DoubËV®
(
de
);

2086 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
–e
);

2087 
	`šüRefCouÁ
(
–e
);

2088 
	`diùAdd
(
d¡z£t
->
diù
,
–e
,&
znode
->
scÜe
);

2089 
	`šüRefCouÁ
(
–e
);

2091 
	`diùR–—£I‹¿tÜ
(
di
);

2094 
	`diùR–—£
(
accumuÏtÜ
);

2096 
	`£rv”Pªic
("Unknown operator");

2099 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

2100 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2101 
touched
 = 1;

2102 
£rv”
.
dœty
++;

2104 ià(
d¡z£t
->
z¦
->
Ëngth
) {

2105 
	`z£tCÚv”tToZli¡IfN“ded
(
d¡obj
,
max––’
);

2106 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

2107 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
d¡obj
));

2108 ià(!
touched
è
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2109 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

2110 (
İ
 =ğ
SET_OP_UNION
) ? "zunionstore" : "zinterstore",

2111 
d¡key
,
c
->
db
->
id
);

2112 
£rv”
.
dœty
++;

2114 
	`deüRefCouÁ
(
d¡obj
);

2115 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

2116 ià(
touched
)

2117 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
d¡key
,
c
->
db
->
id
);

2119 
	`dä“
(
¤c
);

2120 
	}
}

2122 
	$zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

2123 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_UNION
);

2124 
	}
}

2126 
	$zš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

2127 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_INTER
);

2128 
	}
}

2130 
	$z¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2131 
robj
 *
key
 = 
c
->
¬gv
[1];

2132 
robj
 *
zobj
;

2133 
w™hscÜes
 = 0;

2134 
¡¬t
;

2135 
’d
;

2136 
Î’
;

2137 
¿ng–’
;

2139 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
VR_OK
) ||

2140 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
VR_OK
)) ;

2142 ià(
c
->
¬gc
 =ğ5 && !
	`¡rÿ£cmp
(c->
¬gv
[4]->
±r
,"withscores")) {

2143 
w™hscÜes
 = 1;

2144 } ià(
c
->
¬gc
 >= 5) {

2145 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2149 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2150 
	`lockDbR—d
(
c
->
db
);

2151 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

2152 
	`uÆockDb
(
c
->
db
);

2153 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2155 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2156 
	`uÆockDb
(
c
->
db
);

2157 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2162 
Î’
 = 
	`z£tL’gth
(
zobj
);

2163 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

2164 ià(
’d
 < 0è’d = 
Î’
+end;

2165 ià(
¡¬t
 < 0) start = 0;

2169 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

2170 
	`uÆockDb
(
c
->
db
);

2171 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2172 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

2175 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

2176 
¿ng–’
 = (
’d
-
¡¬t
)+1;

2179 
	`addR•lyMuÉiBulkL’
(
c
, 
w™hscÜes
 ? (
¿ng–’
*2) :„angelen);

2181 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2182 *
zl
 = 
zobj
->
±r
;

2183 *
•Œ
, *
¥Œ
;

2184 *
v¡r
;

2185 
vËn
;

2186 
vlÚg
;

2188 ià(
»v”£
)

2189 
•Œ
 = 
	`zli¡Index
(
zl
,-2-(2*
¡¬t
));

2191 
•Œ
 = 
	`zli¡Index
(
zl
,2*
¡¬t
);

2193 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2194 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2196 
¿ng–’
--) {

2197 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
 && 
¥Œ
 != NULL);

2198 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2199 ià(
v¡r
 =ğ
NULL
)

2200 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2202 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2204 ià(
w™hscÜes
)

2205 
	`addR•lyDoubË
(
c
,
	`zzlG‘ScÜe
(
¥Œ
));

2207 ià(
»v”£
)

2208 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2210 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2213 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2214 
z£t
 *
zs
 = 
zobj
->
±r
;

2215 
zskli¡
 *
z¦
 = 
zs
->zsl;

2216 
zskli¡Node
 *
Ê
;

2217 
robj
 *
–e
;

2220 ià(
»v”£
) {

2221 
Ê
 = 
z¦
->

;

2222 ià(
¡¬t
 > 0)

2223 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
Î’
-
¡¬t
);

2225 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

2226 ià(
¡¬t
 > 0)

2227 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

2230 
¿ng–’
--) {

2231 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
Ê
 !ğ
NULL
);

2232 
–e
 = 
Ê
->
obj
;

2233 
	`addR•lyBulk
(
c
,
–e
);

2234 ià(
w™hscÜes
)

2235 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2236 
Ê
 = 
»v”£
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

2239 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2242 
	`uÆockDb
(
c
->
db
);

2243 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2244 
	}
}

2246 
	$z¿ngeCommªd
(
ş›Á
 *
c
) {

2247 
	`z¿ngeG’”icCommªd
(
c
,0);

2248 
	}
}

2250 
	$z»v¿ngeCommªd
(
ş›Á
 *
c
) {

2251 
	`z¿ngeG’”icCommªd
(
c
,1);

2252 
	}
}

2255 
	$g’”icZ¿ngebyscÜeCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2256 
z¿nge¥ec
 
¿nge
;

2257 
robj
 *
key
 = 
c
->
¬gv
[1];

2258 
robj
 *
zobj
;

2259 
off£t
 = 0, 
lim™
 = -1;

2260 
w™hscÜes
 = 0;

2261 
¿ng–’
 = 0;

2262 *
»¶yËn
 = 
NULL
;

2263 
mšidx
, 
maxidx
;

2266 ià(
»v”£
) {

2268 
maxidx
 = 2; 
mšidx
 = 3;

2271 
mšidx
 = 2; 
maxidx
 = 3;

2274 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
VR_OK
) {

2275 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2281 ià(
c
->
¬gc
 > 4) {

2282 
»maššg
 = 
c
->
¬gc
 - 4;

2283 
pos
 = 4;

2285 
»maššg
) {

2286 ià(
»maššg
 >ğ1 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"withscores")) {

2287 
pos
++; 
»maššg
--;

2288 
w™hscÜes
 = 1;

2289 } ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2290 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
VR_OK
) ||

2291 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
VR_OK
)) ;

2292 
pos
 +ğ3; 
»maššg
 -= 3;

2294 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2300 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2301 
	`lockDbR—d
(
c
->
db
);

2303 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

2304 
	`uÆockDb
(
c
->
db
);

2305 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2307 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2308 
	`uÆockDb
(
c
->
db
);

2309 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2313 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2314 *
zl
 = 
zobj
->
±r
;

2315 *
•Œ
, *
¥Œ
;

2316 *
v¡r
;

2317 
vËn
;

2318 
vlÚg
;

2319 
scÜe
;

2322 ià(
»v”£
) {

2323 
•Œ
 = 
	`zzlLa¡InRªge
(
zl
,&
¿nge
);

2325 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2329 ià(
•Œ
 =ğ
NULL
) {

2330 
	`uÆockDb
(
c
->
db
);

2331 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2332 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2337 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2338 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2343 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2347 
•Œ
 && 
off£t
--) {

2348 ià(
»v”£
) {

2349 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2351 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2355 
•Œ
 && 
lim™
--) {

2356 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2359 ià(
»v”£
) {

2360 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
¿nge
)) ;

2362 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) ;

2366 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2368 
¿ng–’
++;

2369 ià(
v¡r
 =ğ
NULL
) {

2370 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2372 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2375 ià(
w™hscÜes
) {

2376 
	`addR•lyDoubË
(
c
,
scÜe
);

2380 ià(
»v”£
) {

2381 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2383 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2386 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2387 
z£t
 *
zs
 = 
zobj
->
±r
;

2388 
zskli¡
 *
z¦
 = 
zs
->zsl;

2389 
zskli¡Node
 *
Ê
;

2392 ià(
»v”£
) {

2393 
Ê
 = 
	`z¦La¡InRªge
(
z¦
,&
¿nge
);

2395 
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
,&
¿nge
);

2399 ià(
Ê
 =ğ
NULL
) {

2400 
	`uÆockDb
(
c
->
db
);

2401 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2402 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2409 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2413 
Ê
 && 
off£t
--) {

2414 ià(
»v”£
) {

2415 
Ê
 =†n->
backw¬d
;

2417 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2421 
Ê
 && 
lim™
--) {

2423 ià(
»v”£
) {

2424 ià(!
	`z¦V®ueG‹Mš
(
Ê
->
scÜe
,&
¿nge
)) ;

2426 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
,&
¿nge
)) ;

2429 
¿ng–’
++;

2430 
	`addR•lyBulk
(
c
,
Ê
->
obj
);

2432 ià(
w™hscÜes
) {

2433 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2437 ià(
»v”£
) {

2438 
Ê
 =†n->
backw¬d
;

2440 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2444 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2447 ià(
w™hscÜes
) {

2448 
¿ng–’
 *= 2;

2451 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2452 
	`uÆockDb
(
c
->
db
);

2453 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2454 
	}
}

2456 
	$z¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2457 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,0);

2458 
	}
}

2460 
	$z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2461 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,1);

2462 
	}
}

2464 
	$zcouÁCommªd
(
ş›Á
 *
c
) {

2465 
robj
 *
key
 = 
c
->
¬gv
[1];

2466 
robj
 *
zobj
;

2467 
z¿nge¥ec
 
¿nge
;

2468 
couÁ
 = 0;

2471 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
VR_OK
) {

2472 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2476 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2477 
	`lockDbR—d
(
c
->
db
);

2479 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
) {

2480 
	`uÆockDb
(
c
->
db
);

2481 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2483 } ià(
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) {

2484 
	`uÆockDb
(
c
->
db
);

2485 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2489 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2490 *
zl
 = 
zobj
->
±r
;

2491 *
•Œ
, *
¥Œ
;

2492 
scÜe
;

2495 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2498 ià(
•Œ
 =ğ
NULL
) {

2499 
	`uÆockDb
(
c
->
db
);

2500 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2501 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2506 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2507 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2508 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
));

2511 
•Œ
) {

2512 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2515 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) {

2518 
couÁ
++;

2519 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2522 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2523 
z£t
 *
zs
 = 
zobj
->
±r
;

2524 
zskli¡
 *
z¦
 = 
zs
->zsl;

2525 
zskli¡Node
 *
zn
;

2526 
¿nk
;

2529 
zn
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
);

2532 ià(
zn
 !ğ
NULL
) {

2533 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2534 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2537 
zn
 = 
	`z¦La¡InRªge
(
z¦
, &
¿nge
);

2540 ià(
zn
 !ğ
NULL
) {

2541 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2542 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2546 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2549 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2550 
	`uÆockDb
(
c
->
db
);

2551 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2552 
	}
}

2554 
	$zËxcouÁCommªd
(
ş›Á
 *
c
) {

2555 
robj
 *
key
 = 
c
->
¬gv
[1];

2556 
robj
 *
zobj
;

2557 
zËx¿nge¥ec
 
¿nge
;

2558 
couÁ
 = 0;

2561 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
VR_OK
) {

2562 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2567 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2568 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
))

2570 
	`z¦F»eLexRªge
(&
¿nge
);

2574 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2575 *
zl
 = 
zobj
->
±r
;

2576 *
•Œ
, *
¥Œ
;

2579 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2582 ià(
•Œ
 =ğ
NULL
) {

2583 
	`z¦F»eLexRªge
(&
¿nge
);

2584 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2589 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2590 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
));

2593 
•Œ
) {

2595 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) {

2598 
couÁ
++;

2599 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2602 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2603 
z£t
 *
zs
 = 
zobj
->
±r
;

2604 
zskli¡
 *
z¦
 = 
zs
->zsl;

2605 
zskli¡Node
 *
zn
;

2606 
¿nk
;

2609 
zn
 = 
	`z¦Fœ¡InLexRªge
(
z¦
, &
¿nge
);

2612 ià(
zn
 !ğ
NULL
) {

2613 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2614 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2617 
zn
 = 
	`z¦La¡InLexRªge
(
z¦
, &
¿nge
);

2620 ià(
zn
 !ğ
NULL
) {

2621 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2622 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2626 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2629 
	`z¦F»eLexRªge
(&
¿nge
);

2630 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2631 
	}
}

2634 
	$g’”icZ¿ngebyËxCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2635 
zËx¿nge¥ec
 
¿nge
;

2636 
robj
 *
key
 = 
c
->
¬gv
[1];

2637 
robj
 *
zobj
;

2638 
off£t
 = 0, 
lim™
 = -1;

2639 
¿ng–’
 = 0;

2640 *
»¶yËn
 = 
NULL
;

2641 
mšidx
, 
maxidx
;

2644 ià(
»v”£
) {

2646 
maxidx
 = 2; 
mšidx
 = 3;

2649 
mšidx
 = 2; 
maxidx
 = 3;

2652 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
VR_OK
) {

2653 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2659 ià(
c
->
¬gc
 > 4) {

2660 
»maššg
 = 
c
->
¬gc
 - 4;

2661 
pos
 = 4;

2663 
»maššg
) {

2664 ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2665 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
VR_OK
) ||

2666 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
VR_OK
)) ;

2667 
pos
 +ğ3; 
»maššg
 -= 3;

2669 
	`z¦F»eLexRªge
(&
¿nge
);

2670 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2677 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2678 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
))

2680 
	`z¦F»eLexRªge
(&
¿nge
);

2684 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2685 *
zl
 = 
zobj
->
±r
;

2686 *
•Œ
, *
¥Œ
;

2687 *
v¡r
;

2688 
vËn
;

2689 
vlÚg
;

2692 ià(
»v”£
) {

2693 
•Œ
 = 
	`zzlLa¡InLexRªge
(
zl
,&
¿nge
);

2695 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2699 ià(
•Œ
 =ğ
NULL
) {

2700 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2701 
	`z¦F»eLexRªge
(&
¿nge
);

2706 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2707 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2712 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2716 
•Œ
 && 
off£t
--) {

2717 ià(
»v”£
) {

2718 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2720 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2724 
•Œ
 && 
lim™
--) {

2726 ià(
»v”£
) {

2727 ià(!
	`zzlLexV®ueG‹Mš
(
•Œ
,&
¿nge
)) ;

2729 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) ;

2734 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2736 
¿ng–’
++;

2737 ià(
v¡r
 =ğ
NULL
) {

2738 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2740 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2744 ià(
»v”£
) {

2745 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2747 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2750 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2751 
z£t
 *
zs
 = 
zobj
->
±r
;

2752 
zskli¡
 *
z¦
 = 
zs
->zsl;

2753 
zskli¡Node
 *
Ê
;

2756 ià(
»v”£
) {

2757 
Ê
 = 
	`z¦La¡InLexRªge
(
z¦
,&
¿nge
);

2759 
Ê
 = 
	`z¦Fœ¡InLexRªge
(
z¦
,&
¿nge
);

2763 ià(
Ê
 =ğ
NULL
) {

2764 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2765 
	`z¦F»eLexRªge
(&
¿nge
);

2772 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2776 
Ê
 && 
off£t
--) {

2777 ià(
»v”£
) {

2778 
Ê
 =†n->
backw¬d
;

2780 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2784 
Ê
 && 
lim™
--) {

2786 ià(
»v”£
) {

2787 ià(!
	`z¦LexV®ueG‹Mš
(
Ê
->
obj
,&
¿nge
)) ;

2789 ià(!
	`z¦LexV®ueL‹Max
(
Ê
->
obj
,&
¿nge
)) ;

2792 
¿ng–’
++;

2793 
	`addR•lyBulk
(
c
,
Ê
->
obj
);

2796 ià(
»v”£
) {

2797 
Ê
 =†n->
backw¬d
;

2799 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2803 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2806 
	`z¦F»eLexRªge
(&
¿nge
);

2807 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2808 
	}
}

2810 
	$z¿ngebyËxCommªd
(
ş›Á
 *
c
) {

2811 
	`g’”icZ¿ngebyËxCommªd
(
c
,0);

2812 
	}
}

2814 
	$z»v¿ngebyËxCommªd
(
ş›Á
 *
c
) {

2815 
	`g’”icZ¿ngebyËxCommªd
(
c
,1);

2816 
	}
}

2818 
	$zÿrdCommªd
(
ş›Á
 *
c
) {

2819 
robj
 *
key
 = 
c
->
¬gv
[1];

2820 
robj
 *
zobj
;

2822 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2823 
	`lockDbR—d
(
c
->
db
);

2824 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
) {

2825 
	`uÆockDb
(
c
->
db
);

2826 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2828 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2829 
	`uÆockDb
(
c
->
db
);

2830 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2834 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
zobj
));

2836 
	`uÆockDb
(
c
->
db
);

2837 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2838 
	}
}

2840 
	$zscÜeCommªd
(
ş›Á
 *
c
) {

2841 
robj
 *
key
 = 
c
->
¬gv
[1];

2842 
robj
 *
zobj
;

2843 
scÜe
;

2845 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2846 
	`lockDbR—d
(
c
->
db
);

2847 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

2848 
	`uÆockDb
(
c
->
db
);

2849 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2851 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2852 
	`uÆockDb
(
c
->
db
);

2853 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2857 ià(
	`z£tScÜe
(
zobj
,
c
->
¬gv
[2],&
scÜe
è=ğ
VR_ERROR
) {

2858 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2860 
	`addR•lyDoubË
(
c
,
scÜe
);

2863 
	`uÆockDb
(
c
->
db
);

2864 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2865 
	}
}

2867 
	$z¿nkG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2868 
robj
 *
key
 = 
c
->
¬gv
[1];

2869 
robj
 *
–e
 = 
c
->
¬gv
[2];

2870 
robj
 *
zobj
;

2871 
Î’
;

2872 
¿nk
;

2874 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2875 
	`lockDbR—d
(
c
->
db
);

2876 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

2877 
	`uÆockDb
(
c
->
db
);

2878 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2880 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2881 
	`uÆockDb
(
c
->
db
);

2882 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2885 
Î’
 = 
	`z£tL’gth
(
zobj
);

2887 
	`£rv”As£¹W™hInfo
(
c
,
–e
,
	`sdsEncodedObjeù
(ele));

2889 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2890 *
zl
 = 
zobj
->
±r
;

2891 *
•Œ
, *
¥Œ
;

2893 
•Œ
 = 
	`zli¡Index
(
zl
,0);

2894 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2895 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2896 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
¥Œ
 !ğ
NULL
);

2898 
¿nk
 = 1;

2899 
•Œ
 !ğ
NULL
) {

2900 ià(
	`zli¡Com·»
(
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr)))

2902 
¿nk
++;

2903 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2906 ià(
•Œ
 !ğ
NULL
) {

2907 ià(
»v”£
)

2908 
	`addR•lyLÚgLÚg
(
c
,
Î’
-
¿nk
);

2910 
	`addR•lyLÚgLÚg
(
c
,
¿nk
-1);

2912 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2914 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2915 
z£t
 *
zs
 = 
zobj
->
±r
;

2916 
zskli¡
 *
z¦
 = 
zs
->zsl;

2917 
diùEÁry
 *
de
;

2918 
scÜe
;

2920 
–e
 = 
c
->
¬gv
[2];

2921 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

2922 ià(
de
 !ğ
NULL
) {

2923 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

2924 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
,
scÜe
,
–e
);

2925 
	`£rv”As£¹W™hInfo
(
c
,
–e
,
¿nk
);

2926 ià(
»v”£
)

2927 
	`addR•lyLÚgLÚg
(
c
,
Î’
-
¿nk
);

2929 
	`addR•lyLÚgLÚg
(
c
,
¿nk
-1);

2931 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2934 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2937 
	`uÆockDb
(
c
->
db
);

2938 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2939 
	}
}

2941 
	$z¿nkCommªd
(
ş›Á
 *
c
) {

2942 
	`z¿nkG’”icCommªd
(
c
, 0);

2943 
	}
}

2945 
	$z»v¿nkCommªd
(
ş›Á
 *
c
) {

2946 
	`z¿nkG’”icCommªd
(
c
, 1);

2947 
	}
}

2949 
	$zsÿnCommªd
(
ş›Á
 *
c
) {

2950 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_ZSET
);

2951 
	}
}

	@src/vr_t_zset.h

1 #iâdeà
_VR_T_ZSET_H_


2 
	#_VR_T_ZSET_H_


	)

6 
	mmš
, 
	mmax
;

7 
	mmšex
, 
	mmaxex
;

8 } 
	tz¿nge¥ec
;

12 
robj
 *
	mmš
, *
	mmax
;

13 
	mmšex
, 
	mmaxex
;

14 } 
	tzËx¿nge¥ec
;

17 
robj
 *
	msubjeù
;

18 
	mty³
;

19 
	m’codšg
;

20 
	mweight
;

24 
	u_™”£t
 {

26 
št£t
 *
	mis
;

27 
	mii
;

28 } 
	mis
;

30 
diù
 *
	mdiù
;

31 
diùI‹¿tÜ
 *
	mdi
;

32 
diùEÁry
 *
	mde
;

33 } 
	mht
;

34 } 
	m£t
;

37 
	u_™”z£t
 {

39 *
	mzl
;

40 *
	m•Œ
, *
	m¥Œ
;

41 } 
	mzl
;

43 
z£t
 *
	mzs
;

44 
zskli¡Node
 *
	mnode
;

45 } 
	m¦
;

46 } 
	mz£t
;

47 } 
	m™”
;

48 } 
	tz£tİ¤c
;

52 
	mæags
;

53 
	m_buf
[32];

54 
robj
 *
	m–e
;

55 *
	me¡r
;

56 
	m–’
;

57 
	m–l
;

58 
	mscÜe
;

59 } 
	tz£tİv®
;

61 
zskli¡Node
 *
z¦C»©eNode
(
Ëv–
, 
scÜe
, 
robj
 *
obj
);

62 
zskli¡
 *
z¦C»©e
();

63 
z¦F»eNode
(
zskli¡Node
 *
node
);

64 
z¦F»e
(
zskli¡
 *
z¦
);

65 
z¦RªdomLev–
();

66 
zskli¡Node
 *
z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
);

67 
z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
);

68 
z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
);

69 
z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

70 
z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

71 
zskli¡Node
 *
z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

72 
zskli¡Node
 *
z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

73 
z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict);

74 
z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict);

75 
z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict);

76 
z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
o
);

77 
zskli¡Node
* 
z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
);

78 
z¦P¬£LexRªgeI‹m
(
robj
 *
™em
,„obj **
de¡
, *
ex
);

79 
z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
);

80 
com·»SŒšgObjeùsFÜLexRªge
(
robj
 *
a
,„obj *
b
);

81 
z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

82 
zskli¡Node
 *
z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

83 
zskli¡Node
 *
z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

84 
zzlG‘ScÜe
(*
¥Œ
);

85 
robj
 *
zli¡G‘Objeù
(*
¥Œ
);

86 
zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
);

87 
zzlL’gth
(*
zl
);

88 
zzlNext
(*
zl
, **
•Œ
, **
¥Œ
);

89 
zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
);

90 
zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

91 *
zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

92 *
zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

93 
zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

94 *
zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

96 *
zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

97 *
zzlFšd
(*
zl
, 
robj
 *
–e
, *
scÜe
);

98 *
zzlD–‘e
(*
zl
, *
•Œ
);

99 *
zzlIn£¹At
(*
zl
, *
•Œ
, 
robj
 *
–e
, 
scÜe
);

100 *
zzlIn£¹
(*
zl
, 
robj
 *
–e
, 
scÜe
);

101 *
zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
);

102 *
zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
);

103 *
zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
);

104 
z£tL’gth
(
robj
 *
zobj
);

105 
z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
);

106 
z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
);

107 
z£tScÜe
(
robj
 *
zobj
,„obj *
memb”
, *
scÜe
);

109 
zaddG’”icCommªd
(
ş›Á
 *
c
, 
æags
);

110 
zaddCommªd
(
ş›Á
 *
c
);

111 
zšübyCommªd
(
ş›Á
 *
c
);

112 
z»mCommªd
(
ş›Á
 *
c
);

113 
z»m¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
¿ng‘y³
);

114 
z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
);

115 
z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

116 
z»m¿ngebyËxCommªd
(
ş›Á
 *
c
) ;

118 
zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
);

119 
zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
);

120 
zuiL’gth
(
z£tİ¤c
 *
İ
);

125 
zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
);

126 
zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
);

127 
robj
 *
zuiObjeùFromV®ue
(
z£tİv®
 *
v®
);

128 
zuiBufãrFromV®ue
(
z£tİv®
 *
v®
);

132 
zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
);

133 
zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
);

134 
zuniÚIÁ”G’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
d¡key
, 
İ
);

135 
zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

136 
zš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

137 
z¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
);

138 
z¿ngeCommªd
(
ş›Á
 *
c
);

139 
z»v¿ngeCommªd
(
ş›Á
 *
c
);

142 
g’”icZ¿ngebyscÜeCommªd
(
ş›Á
 *
c
, 
»v”£
);

143 
z¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

144 
z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

145 
zcouÁCommªd
(
ş›Á
 *
c
);

146 
zËxcouÁCommªd
(
ş›Á
 *
c
);

149 
g’”icZ¿ngebyËxCommªd
(
ş›Á
 *
c
, 
»v”£
);

150 
z¿ngebyËxCommªd
(
ş›Á
 *
c
);

151 
z»v¿ngebyËxCommªd
(
ş›Á
 *
c
);

152 
zÿrdCommªd
(
ş›Á
 *
c
);

153 
zscÜeCommªd
(
ş›Á
 *
c
);

154 
z¿nkG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
);

155 
z¿nkCommªd
(
ş›Á
 *
c
);

156 
z»v¿nkCommªd
(
ş›Á
 *
c
);

157 
zsÿnCommªd
(
ş›Á
 *
c
);

	@src/vr_thread.c

1 
	~<vr_cÜe.h
>

4 
	$vr_th»ad_š™
(
vr_th»ad
 *
th»ad
)

6 ià(
th»ad
 =ğ
NULL
) {

7  
VR_ERROR
;

10 
th»ad
->
id
 = 0;

11 
th»ad
->
th»ad_id
 = 0;

12 
th»ad
->
fun_run
 = 
NULL
;

13 
th»ad
->
d©a
 = 
NULL
;

15  
VR_OK
;

16 
	}
}

19 
	$vr_th»ad_deš™
(
vr_th»ad
 *
th»ad
)

21 ià(
th»ad
 =ğ
NULL
) {

25 
th»ad
->
id
 = 0;

26 
th»ad
->
th»ad_id
 = 0;

27 
th»ad
->
fun_run
 = 
NULL
;

28 
th»ad
->
d©a
 = 
NULL
;

29 
	}
}

31 *
	$vr_th»ad_run
(*
d©a
)

33 
vr_th»ad
 *
th»ad
 = 
d©a
;

34 
	`¤ªd
(
	`vr_u£c_now
()^()
	`±h»ad_£lf
());

36 
th»ad
->
	`fun_run
Ñh»ad->
d©a
);

37 
	}
}

39 
	$vr_th»ad_¡¬t
(
vr_th»ad
 *
th»ad
)

41 
±h»ad_©Œ_t
 
©Œ
;

42 
	`±h»ad_©Œ_š™
(&
©Œ
);

44 ià(
th»ad
 =ğ
NULL
 ||h»ad->
fun_run
 == NULL) {

45  
VR_ERROR
;

48 
	`±h»ad_ü—‹
(&
th»ad
->
th»ad_id
,

49 &
©Œ
, 
vr_th»ad_run
, 
th»ad
);

51  
VR_OK
;

52 
	}
}

	@src/vr_thread.h

1 #iâdeà
_VR_THREAD_H_


2 
	#_VR_THREAD_H_


	)

4 *(*
	tvr_th»ad_func_t
)(*
	td©a
);

6 
	svr_th»ad
 {

7 
	mid
;

8 
±h»ad_t
 
	mth»ad_id
;

10 
vr_th»ad_func_t
 
	mfun_run
;

11 *
	md©a
;

12 }
	tvr_th»ad
;

14 
vr_th»ad_š™
(
vr_th»ad
 *
th»ad
);

15 
vr_th»ad_deš™
(
vr_th»ad
 *
th»ad
);

16 
vr_th»ad_¡¬t
(
vr_th»ad
 *
th»ad
);

	@src/vr_util.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡d¬g.h
>

4 
	~<¡ršg.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<Ãtdb.h
>

9 
	~<sys/time.h
>

10 
	~<sys/ty³s.h
>

11 
	~<sys/sock‘.h
>

12 
	~<sys/ioùl.h
>

14 
	~<Ãtš‘/š.h
>

15 
	~<Ãtš‘/tı.h
>

17 
	~<vr_cÜe.h
>

19 #ifdeà
VR_HAVE_BACKTRACE


20 
	~<execšfo.h
>

24 
	$vr_£t_blockšg
(
sd
)

26 
æags
;

28 
æags
 = 
	`fú
(
sd
, 
F_GETFL
, 0);

29 ià(
æags
 < 0) {

30  
æags
;

33  
	`fú
(
sd
, 
F_SETFL
, 
æags
 & ~
O_NONBLOCK
);

34 
	}
}

37 
	$vr_£t_nÚblockšg
(
sd
)

39 
æags
;

41 
æags
 = 
	`fú
(
sd
, 
F_GETFL
, 0);

42 ià(
æags
 < 0) {

43  
æags
;

46  
	`fú
(
sd
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
);

47 
	}
}

50 
	$vr_£t_»u£addr
(
sd
)

52 
»u£
;

53 
sockËn_t
 
Ën
;

55 
»u£
 = 1;

56 
Ën
 = (
»u£
);

58  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
»u£
, 
Ën
);

59 
	}
}

70 
	$vr_£t_tınod–ay
(
sd
)

72 
nod–ay
;

73 
sockËn_t
 
Ën
;

75 
nod–ay
 = 1;

76 
Ën
 = (
nod–ay
);

78  
	`£tsockİt
(
sd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
nod–ay
, 
Ën
);

79 
	}
}

82 
	$vr_£t_lšg”
(
sd
, 
timeout
)

84 
lšg”
†inger;

85 
sockËn_t
 
Ën
;

87 
lšg”
.
l_Úoff
 = 1;

88 
lšg”
.
l_lšg”
 = 
timeout
;

90 
Ën
 = (
lšg”
);

92  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_LINGER
, &
lšg”
, 
Ën
);

93 
	}
}

96 
	$vr_£t_¢dbuf
(
sd
, 
size
)

98 
sockËn_t
 
Ën
;

100 
Ën
 = (
size
);

102  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
size
, 
Ën
);

103 
	}
}

106 
	$vr_£t_rcvbuf
(
sd
, 
size
)

108 
sockËn_t
 
Ën
;

110 
Ën
 = (
size
);

112  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
size
, 
Ën
);

113 
	}
}

116 
	$vr_g‘_sÛ¼Ü
(
sd
)

118 
¡©us
, 
”r
;

119 
sockËn_t
 
Ën
;

121 
”r
 = 0;

122 
Ën
 = (
”r
);

124 
¡©us
 = 
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”r
, &
Ën
);

125 ià(
¡©us
 == 0) {

126 
”ºo
 = 
”r
;

129  
¡©us
;

130 
	}
}

133 
	$vr_g‘_¢dbuf
(
sd
)

135 
¡©us
, 
size
;

136 
sockËn_t
 
Ën
;

138 
size
 = 0;

139 
Ën
 = (
size
);

141 
¡©us
 = 
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
size
, &
Ën
);

142 ià(
¡©us
 < 0) {

143  
¡©us
;

146  
size
;

147 
	}
}

150 
	$vr_g‘_rcvbuf
(
sd
)

152 
¡©us
, 
size
;

153 
sockËn_t
 
Ën
;

155 
size
 = 0;

156 
Ën
 = (
size
);

158 
¡©us
 = 
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
size
, &
Ën
);

159 ià(
¡©us
 < 0) {

160  
¡©us
;

163  
size
;

164 
	}
}

167 
	$vr_£t_tık“·live
(
sd
, 
k“pidË
, 
k“pš‹rv®
, 
k“pcouÁ
)

169 
r¡©us_t
 
¡©us
;

170 
tık“·live
;

171 
sockËn_t
 
Ën
;

173 
tık“·live
 = 1;

174 
Ën
 = (
tık“·live
);

176 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
tık“·live
, 
Ën
);

177 ià(
¡©us
 < 0) {

178 
	`log_”rÜ
("£tsockİˆSO_KEEPALIVE c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

179  
VR_ERROR
;

182 #ifdeà
SOL_TCP


183 ià(
k“pidË
 > 0) {

184 
Ën
 = (
k“pidË
);

185 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_TCP
, 
TCP_KEEPIDLE
, &
k“pidË
, 
Ën
);

186 ià(
¡©us
 < 0) {

187 
	`log_”rÜ
("£tsockİˆTCP_KEEPIDLE c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

188  
VR_ERROR
;

192 ià(
k“pš‹rv®
 > 0) {

193 
Ën
 = (
k“pš‹rv®
);

194 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_TCP
, 
TCP_KEEPINTVL
, &
k“pš‹rv®
, 
Ën
);

195 ià(
¡©us
 < 0) {

196 
	`log_”rÜ
("£tsockİˆTCP_KEEPINTVL c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

197  
VR_ERROR
;

201 ià(
k“pcouÁ
 > 0) {

202 
Ën
 = (
k“pcouÁ
);

203 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_TCP
, 
TCP_KEEPCNT
, &
k“pcouÁ
, 
Ën
);

204 ià(
¡©us
 < 0) {

205 
	`log_”rÜ
("£tsockİˆTCP_KEEPCNT c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

206  
VR_ERROR
;

211  
VR_OK
;

212 
	}
}

215 
	$_vr_©oi
(*
lše
, 
size_t
 
n
)

217 
v®ue
;

219 ià(
n
 == 0) {

223 
v®ue
 = 0; 
n
--; 
lše
++) {

224 ià(*
lše
 < '0' || *line > '9') {

228 
v®ue
 = v®u* 10 + (*
lše
 - '0');

231 ià(
v®ue
 < 0) {

235  
v®ue
;

236 
	}
}

240 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

241 ià(
v
 < 10)  1;

242 ià(
v
 < 100)  2;

243 ià(
v
 < 1000)  3;

244 ià(
v
 < 1000000000000UL) {

245 ià(
v
 < 100000000UL) {

246 ià(
v
 < 1000000) {

247 ià(
v
 < 10000)  4;

248  5 + (
v
 >= 100000);

250  7 + (
v
 >= 10000000UL);

252 ià(
v
 < 10000000000UL) {

253  9 + (
v
 >= 1000000000UL);

255  11 + (
v
 >= 100000000000UL);

257  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

258 
	}
}

261 
ušt32_t
 
	$sdig™s10
(
št64_t
 
v
) {

262 ià(
v
 < 0) {

264 
ušt64_t
 
uv
 = (
v
 !ğ
LLONG_MIN
) ?

265 (
ušt64_t
)-
v
 : ((ušt64_tè
LLONG_MAX
)+1;

266  
	`dig™s10
(
uv
)+1;

268  
	`dig™s10
(
v
);

270 
	}
}

284 
	$Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

285 cÚ¡ 
dig™s
[201] =

291 
Ãg©ive
;

292 
v®ue
;

296 ià(
sv®ue
 < 0) {

297 ià(
sv®ue
 !ğ
LLONG_MIN
) {

298 
v®ue
 = -
sv®ue
;

300 
v®ue
 = ((è
LLONG_MAX
)+1;

302 
Ãg©ive
 = 1;

304 
v®ue
 = 
sv®ue
;

305 
Ãg©ive
 = 0;

309 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

310 ià(
Ëngth
 >ğ
d¡Ën
)  0;

313 
ušt32_t
 
Ãxt
 = 
Ëngth
;

314 
d¡
[
Ãxt
] = '\0';

315 
Ãxt
--;

316 
v®ue
 >= 100) {

317 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

318 
v®ue
 /= 100;

319 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

320 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

321 
Ãxt
 -= 2;

325 ià(
v®ue
 < 10) {

326 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

328 
i
 = (
ušt32_t
è
v®ue
 * 2;

329 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

330 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

334 ià(
Ãg©ive
è
d¡
[0] = '-';

335  
Ëngth
;

336 
	}
}

342 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

343 cÚ¡ *
p
 = 
s
;

344 
size_t
 
¶’
 = 0;

345 
Ãg©ive
 = 0;

346 
v
;

348 ià(
¶’
 =ğ
¦’
)

352 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

353 ià(
v®ue
 !ğ
NULL
) *value = 0;

357 ià(
p
[0] == '-') {

358 
Ãg©ive
 = 1;

359 
p
++; 
¶’
++;

362 ià(
¶’
 =ğ
¦’
)

367 ià(
p
[0] >= '1' &&…[0] <= '9') {

368 
v
 = 
p
[0]-'0';

369 
p
++; 
¶’
++;

370 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

371 *
v®ue
 = 0;

377 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

378 ià(
v
 > (
ULLONG_MAX
 / 10))

380 
v
 *= 10;

382 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

384 
v
 +ğ
p
[0]-'0';

386 
p
++; 
¶’
++;

390 ià(
¶’
 < 
¦’
)

393 ià(
Ãg©ive
) {

394 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

396 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

398 ià(
v
 > 
LLONG_MAX
)

400 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

403 
	}
}

408 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

409 
Îv®
;

411 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

414 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

417 *
lv®
 = ()
Îv®
;

419 
	}
}

423 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

424 ià(
	`i¢ª
(
v®ue
)) {

425 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

426 } ià(
	`isšf
(
v®ue
)) {

427 ià(
v®ue
 < 0)

428 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

430 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

431 } ià(
v®ue
 == 0) {

433 ià(1.0/
v®ue
 < 0)

434 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

436 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

438 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

448 
mš
 = -4503599627370495;

449 
max
 = 4503599627370496;

450 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

451 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

454 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

457  
Ën
;

458 
	}
}

460 
boŞ


461 
	$vr_v®id_pÜt
(
n
)

463 ià(
n
 < 1 ||‚ > 
UINT16_MAX
) {

464  
çl£
;

467  
Œue
;

468 
	}
}

473 
ssize_t


474 
	$_vr_£ndn
(
sd
, cÚ¡ *
v±r
, 
size_t
 
n
)

476 
size_t
 
Æeá
;

477 
ssize_t
 
n£nd
;

478 cÚ¡ *
±r
;

480 
±r
 = 
v±r
;

481 
Æeá
 = 
n
;

482 
Æeá
 > 0) {

483 
n£nd
 = 
	`£nd
(
sd
, 
±r
, 
Æeá
, 0);

484 ià(
n£nd
 < 0) {

485 ià(
”ºo
 =ğ
EINTR
) {

488  
n£nd
;

490 ià(
n£nd
 == 0) {

494 
Æeá
 -ğ(
size_t
)
n£nd
;

495 
±r
 +ğ
n£nd
;

498  (
ssize_t
)
n
;

499 
	}
}

504 
ssize_t


505 
	$_vr_»cvn
(
sd
, *
v±r
, 
size_t
 
n
)

507 
size_t
 
Æeá
;

508 
ssize_t
 
Äecv
;

509 *
±r
;

511 
±r
 = 
v±r
;

512 
Æeá
 = 
n
;

513 
Æeá
 > 0) {

514 
Äecv
 = 
	`»cv
(
sd
, 
±r
, 
Æeá
, 0);

515 ià(
Äecv
 < 0) {

516 ià(
”ºo
 =ğ
EINTR
) {

519  
Äecv
;

521 ià(
Äecv
 == 0) {

525 
Æeá
 -ğ(
size_t
)
Äecv
;

526 
±r
 +ğ
Äecv
;

529  (
ssize_t
)(
n
 - 
Æeá
);

530 
	}
}

535 
št64_t


536 
	$vr_u£c_now
()

538 
timev®
 
now
;

539 
št64_t
 
u£c
;

540 
¡©us
;

542 
¡©us
 = 
	`g‘timeofday
(&
now
, 
NULL
);

543 ià(
¡©us
 < 0) {

544 
	`log_”rÜ
("g‘timeofday faed: %s", 
	`¡»¼Ü
(
”ºo
));

548 
u£c
 = (
št64_t
)
now
.
tv_£c
 * 1000000LL + (št64_têow.
tv_u£c
;

550  
u£c
;

551 
	}
}

556 
št64_t


557 
	$vr_m£c_now
()

559  
	`vr_u£c_now
() / 1000LL;

560 
	}
}

563 
	$vr_»sŞve_š‘
(
sds
 
Çme
, 
pÜt
, 
sockšfo
 *
si
)

565 
¡©us
;

566 
addršfo
 *
ai
, *
ÿi
;

567 
addršfo
 
hšts
;

568 *
node
, 
£rviû
[
VR_UINTMAX_MAXLEN
];

569 
boŞ
 
found
;

571 
	`ASSERT
(
	`vr_v®id_pÜt
(
pÜt
));

573 
	`mem£t
(&
hšts
, 0, (hints));

574 
hšts
.
ai_æags
 = 
AI_NUMERICSERV
;

575 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

576 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

577 
hšts
.
ai_´ÙocŞ
 = 0;

578 
hšts
.
ai_add¾’
 = 0;

579 
hšts
.
ai_addr
 = 
NULL
;

580 
hšts
.
ai_ÿnÚÇme
 = 
NULL
;

582 ià(
Çme
 !ğ
NULL
) {

583 
node
 = (*)
Çme
;

591 
node
 = 
NULL
;

592 
hšts
.
ai_æags
 |ğ
AI_PASSIVE
;

595 
	`d¢´štf
(
£rviû
, 
VR_UINTMAX_MAXLEN
, "%d", 
pÜt
);

601 
¡©us
 = 
	`g‘addršfo
(
node
, 
£rviû
, &
hšts
, &
ai
);

602 ià(
¡©us
 != 0) {

603 
	`log_”rÜ
("address„esolution of‚ode '%s' service '%s' failed: %s",

604 
node
, 
£rviû
, 
	`gai_¡»¼Ü
(
¡©us
));

619 
ÿi
 = 
ai
, 
found
 = 
çl£
; ca˜!ğ
NULL
; ca˜ğÿi->
ai_Ãxt
) {

620 
si
->
çmy
 = 
ÿi
->
ai_çmy
;

621 
si
->
add¾’
 = 
ÿi
->
ai_add¾’
;

622 
	`vr_memıy
(&
si
->
addr
, 
ÿi
->
ai_addr
, si->
add¾’
);

623 
found
 = 
Œue
;

627 
	`ä“addršfo
(
ai
);

629  !
found
 ? -1 : 0;

630 
	}
}

633 
	$vr_»sŞve_unix
(
sds
 
Çme
, 
sockšfo
 *
si
)

635 
sockaddr_un
 *
un
;

637 ià(
	`sd¦’
(
Çme
è>ğ
VR_UNIX_ADDRSTRLEN
) {

641 
un
 = &
si
->
addr
.un;

643 
un
->
sun_çmy
 = 
AF_UNIX
;

644 
	`vr_memıy
(
un
->
sun_·th
, 
Çme
, 
	`sd¦’
(name));

645 
un
->
sun_·th
[
	`sd¦’
(
Çme
)] = '\0';

647 
si
->
çmy
 = 
AF_UNIX
;

648 
si
->
add¾’
 = (*
un
);

652 
	}
}

661 
	$vr_»sŞve
(
sds
 
Çme
, 
pÜt
, 
sockšfo
 *
si
)

663 ià(
Çme
 !ğ
NULL
 &&‚ame[0] == '/') {

664  
	`vr_»sŞve_unix
(
Çme
, 
si
);

667  
	`vr_»sŞve_š‘
(
Çme
, 
pÜt
, 
si
);

668 
	}
}

670 
	$vr_Ãt_³”_to_¡ršg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

671 
sockaddr_¡Üage
 
§
;

672 
sockËn_t
 
§Ën
 = (
§
);

674 ià(
	`g‘³”Çme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
è=ğ-1è
”rÜ
;

675 ià(
_Ën
 =ğ0è
”rÜ
;

677 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

678 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

679 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

680 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

681 } ià(
§
.
ss_çmy
 =ğ
AF_INET6
) {

682 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

683 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

684 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

685 } ià(
§
.
ss_çmy
 =ğ
AF_UNIX
) {

686 ià(

è
	`¡ºıy
(,"/unixsock‘",
_Ën
);

687 ià(
pÜt
) *port = 0;

689 
”rÜ
;

693 
”rÜ
:

694 ià(

) {

695 ià(
_Ën
 >= 2) {

696 

[0] = '?';

697 

[1] = '\0';

698 } ià(
_Ën
 == 1) {

699 

[0] = '\0';

702 ià(
pÜt
) *port = 0;

704 
	}
}

709 
	$vr_Ãt_fÜm©_addr
(*
buf
, 
size_t
 
buf_Ën
, *

, 
pÜt
) {

710  
	`¢´štf
(
buf
,
buf_Ën
, 
	`¡rchr
(

,':') ?

711 "[%s]:%d" : "%s:%d", 

, 
pÜt
);

712 
	}
}

715 
	$vr_Ãt_fÜm©_³”
(
fd
, *
buf
, 
size_t
 
buf_Ën
) {

716 

[
VR_INET6_ADDRSTRLEN
];

717 
pÜt
;

719 
	`vr_Ãt_³”_to_¡ršg
(
fd
,

,(),&
pÜt
);

720  
	`vr_Ãt_fÜm©_addr
(
buf
, 
buf_Ën
, 

, 
pÜt
);

721 
	}
}

728 
	$g‘_¿ndom_hex_ch¬s
(*
p
, 
Ën
) {

729 *
ch¬£t
 = "0123456789abcdef";

730 
j
;

733 
£ed_š™Ÿlized
 = 0;

734 
£ed
[20];

735 
ušt64_t
 
couÁ”
 = 0;

737 ià(!
£ed_š™Ÿlized
) {

742 
FILE
 *
å
 = 
	`fİ’
("/dev/urandom","r");

743 ià(
å
 && 
	`ä—d
(
£ed
,(seed),1,fp) == 1)

744 
£ed_š™Ÿlized
 = 1;

745 ià(
å
è
	`fşo£
(fp);

748 ià(
£ed_š™Ÿlized
) {

749 
Ën
) {

750 
dige¡
[20];

751 
SHA1_CTX
 
ùx
;

752 
cİyËn
 = 
Ën
 > 20 ? 20 :†en;

754 
	`SHA1In™
(&
ùx
);

755 
	`SHA1Upd©e
(&
ùx
, 
£ed
, (seed));

756 
	`SHA1Upd©e
(&
ùx
, (*)&
couÁ”
,(counter));

757 
	`SHA1Fš®
(
dige¡
, &
ùx
);

758 
couÁ”
++;

760 
	`memıy
(
p
,
dige¡
,
cİyËn
);

762 
j
 = 0; j < 
cİyËn
; j++è
p
[j] = 
ch¬£t
[p[j] & 0x0F];

763 
Ën
 -ğ
cİyËn
;

764 
p
 +ğ
cİyËn
;

770 *
x
 = 
p
;

771 
l
 = 
Ën
;

772 
timev®
 
tv
;

773 
pid_t
 
pid
 = 
	`g‘pid
();

776 
	`g‘timeofday
(&
tv
,
NULL
);

777 ià(
l
 >ğ(
tv
.
tv_u£c
)) {

778 
	`memıy
(
x
,&
tv
.
tv_u£c
,(tv.tv_usec));

779 
l
 -ğ(
tv
.
tv_u£c
);

780 
x
 +ğ(
tv
.
tv_u£c
);

782 ià(
l
 >ğ(
tv
.
tv_£c
)) {

783 
	`memıy
(
x
,&
tv
.
tv_£c
,(tv.tv_sec));

784 
l
 -ğ(
tv
.
tv_£c
);

785 
x
 +ğ(
tv
.
tv_£c
);

787 ià(
l
 >ğ(
pid
)) {

788 
	`memıy
(
x
,&
pid
,(pid));

789 
l
 -ğ(
pid
);

790 
x
 +ğ(
pid
);

794 
j
 = 0; j < 
Ën
; j++) {

795 
p
[
j
] ^ğ
	`¿nd
();

796 
p
[
j
] = 
ch¬£t
[p[j] & 0x0F];

799 
	}
}

802 
	$¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

803 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

805 
·‰”nL’
) {

806 
·‰”n
[0]) {

808 
·‰”n
[1] == '*') {

809 
·‰”n
++;

810 
·‰”nL’
--;

812 ià(
·‰”nL’
 == 1)

814 
¡ršgL’
) {

815 ià(
	`¡ršgm©chËn
(
·‰”n
+1, 
·‰”nL’
-1,

816 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

818 
¡ršg
++;

819 
¡ršgL’
--;

824 ià(
¡ršgL’
 == 0)

826 
¡ršg
++;

827 
¡ršgL’
--;

831 
nÙ
, 
m©ch
;

833 
·‰”n
++;

834 
·‰”nL’
--;

835 
nÙ
 = 
·‰”n
[0] == '^';

836 ià(
nÙ
) {

837 
·‰”n
++;

838 
·‰”nL’
--;

840 
m©ch
 = 0;

842 ià(
·‰”n
[0] == '\\') {

843 
·‰”n
++;

844 
·‰”nL’
--;

845 ià(
·‰”n
[0] =ğ
¡ršg
[0])

846 
m©ch
 = 1;

847 } ià(
·‰”n
[0] == ']') {

849 } ià(
·‰”nL’
 == 0) {

850 
·‰”n
--;

851 
·‰”nL’
++;

853 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

854 
¡¬t
 = 
·‰”n
[0];

855 
’d
 = 
·‰”n
[2];

856 
c
 = 
¡ršg
[0];

857 ià(
¡¬t
 > 
’d
) {

858 
t
 = 
¡¬t
;

859 
¡¬t
 = 
’d
;

860 
’d
 = 
t
;

862 ià(
noÿ£
) {

863 
¡¬t
 = 
	`tŞow”
(start);

864 
’d
 = 
	`tŞow”
(end);

865 
c
 = 
	`tŞow”
(c);

867 
·‰”n
 += 2;

868 
·‰”nL’
 -= 2;

869 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

870 
m©ch
 = 1;

872 ià(!
noÿ£
) {

873 ià(
·‰”n
[0] =ğ
¡ršg
[0])

874 
m©ch
 = 1;

876 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

877 
m©ch
 = 1;

880 
·‰”n
++;

881 
·‰”nL’
--;

883 ià(
nÙ
)

884 
m©ch
 = !match;

885 ià(!
m©ch
)

887 
¡ršg
++;

888 
¡ršgL’
--;

892 ià(
·‰”nL’
 >= 2) {

893 
·‰”n
++;

894 
·‰”nL’
--;

898 ià(!
noÿ£
) {

899 ià(
·‰”n
[0] !ğ
¡ršg
[0])

902 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

905 
¡ršg
++;

906 
¡ršgL’
--;

909 
·‰”n
++;

910 
·‰”nL’
--;

911 ià(
¡ršgL’
 == 0) {

912 *
·‰”n
 == '*') {

913 
·‰”n
++;

914 
·‰”nL’
--;

919 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

922 
	}
}

924 
	$¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

925  
	`¡ršgm©chËn
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

926 
	}
}

930 
	$mem»v16
(*
p
) {

931 *
x
 = 
p
, 
t
;

933 
t
 = 
x
[0];

934 
x
[0] = x[1];

935 
x
[1] = 
t
;

936 
	}
}

940 
	$mem»v32
(*
p
) {

941 *
x
 = 
p
, 
t
;

943 
t
 = 
x
[0];

944 
x
[0] = x[3];

945 
x
[3] = 
t
;

946 
t
 = 
x
[1];

947 
x
[1] = x[2];

948 
x
[2] = 
t
;

949 
	}
}

953 
	$mem»v64
(*
p
) {

954 *
x
 = 
p
, 
t
;

956 
t
 = 
x
[0];

957 
x
[0] = x[7];

958 
x
[7] = 
t
;

959 
t
 = 
x
[1];

960 
x
[1] = x[6];

961 
x
[6] = 
t
;

962 
t
 = 
x
[2];

963 
x
[2] = x[5];

964 
x
[5] = 
t
;

965 
t
 = 
x
[3];

966 
x
[3] = x[4];

967 
x
[4] = 
t
;

968 
	}
}

970 
ušt16_t
 
	$šŒev16
(
ušt16_t
 
v
) {

971 
	`mem»v16
(&
v
);

972  
v
;

973 
	}
}

975 
ušt32_t
 
	$šŒev32
(
ušt32_t
 
v
) {

976 
	`mem»v32
(&
v
);

977  
v
;

978 
	}
}

980 
ušt64_t
 
	$šŒev64
(
ušt64_t
 
v
) {

981 
	`mem»v64
(&
v
);

982  
v
;

983 
	}
}

992 
	$memtŞl
(cÚ¡ *
p
, *
”r
) {

993 cÚ¡ *
u
;

994 
buf
[128];

995 
mul
;

996 
v®
;

997 
dig™s
;

999 ià(
”r
) *err = 0;

1002 
u
 = 
p
;

1003 ià(*
u
 == '-') u++;

1004 *
u
 && 
	`isdig™
(*u)) u++;

1005 ià(*
u
 =ğ'\0' || !
	`¡rÿ£cmp
(u,"b")) {

1006 
mul
 = 1;

1007 } ià(!
	`¡rÿ£cmp
(
u
,"k")) {

1008 
mul
 = 1000;

1009 } ià(!
	`¡rÿ£cmp
(
u
,"kb")) {

1010 
mul
 = 1024;

1011 } ià(!
	`¡rÿ£cmp
(
u
,"m")) {

1012 
mul
 = 1000*1000;

1013 } ià(!
	`¡rÿ£cmp
(
u
,"mb")) {

1014 
mul
 = 1024*1024;

1015 } ià(!
	`¡rÿ£cmp
(
u
,"g")) {

1016 
mul
 = 1000L*1000*1000;

1017 } ià(!
	`¡rÿ£cmp
(
u
,"gb")) {

1018 
mul
 = 1024L*1024*1024;

1020 ià(
”r
) *err = 1;

1026 
dig™s
 = 
u
-
p
;

1027 ià(
dig™s
 >ğ(
buf
)) {

1028 ià(
”r
) *err = 1;

1031 
	`memıy
(
buf
,
p
,
dig™s
);

1032 
buf
[
dig™s
] = '\0';

1034 *
’d±r
;

1035 
”ºo
 = 0;

1036 
v®
 = 
	`¡¹Şl
(
buf
,&
’d±r
,10);

1037 ià((
v®
 =ğ0 && 
”ºo
 =ğ
EINVAL
è|| *
’d±r
 != '\0') {

1038 ià(
”r
) *err = 1;

1041  
v®
*
mul
;

1042 
	}
}

1046 
	$by‹sToHumª
(*
s
, 
n
) {

1047 
d
;

1049 ià(
n
 < 1024) {

1051 
	`¥rštf
(
s
,"%ÎuB",
n
);

1053 } ià(
n
 < (1024*1024)) {

1054 
d
 = ()
n
/(1024);

1055 
	`¥rštf
(
s
,"%.2fK",
d
);

1056 } ià(
n
 < (1024LL*1024*1024)) {

1057 
d
 = ()
n
/(1024*1024);

1058 
	`¥rštf
(
s
,"%.2fM",
d
);

1059 } ià(
n
 < (1024LL*1024*1024*1024)) {

1060 
d
 = ()
n
/(1024LL*1024*1024);

1061 
	`¥rštf
(
s
,"%.2fG",
d
);

1062 } ià(
n
 < (1024LL*1024*1024*1024*1024)) {

1063 
d
 = ()
n
/(1024LL*1024*1024*1024);

1064 
	`¥rštf
(
s
,"%.2fT",
d
);

1065 } ià(
n
 < (1024LL*1024*1024*1024*1024*1024)) {

1066 
d
 = ()
n
/(1024LL*1024*1024*1024*1024);

1067 
	`¥rštf
(
s
,"%.2fP",
d
);

1070 
	`¥rštf
(
s
,"%ÎuB",
n
);

1072 
	}
}

1081 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

1082 
cwd
[1024];

1083 
sds
 
ab¥©h
;

1084 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

1086 
»Í©h
 = 
	`sd¡rim
(relpath," \r\n\t");

1087 ià(
»Í©h
[0] == '/') „elpath;

1090 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

1091 
	`sdsä“
(
»Í©h
);

1092  
NULL
;

1094 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

1095 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

1096 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

1104 
	`sd¦’
(
»Í©h
) >= 3 &&

1105 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

1107 
	`sd¤ªge
(
»Í©h
,3,-1);

1108 ià(
	`sd¦’
(
ab¥©h
) > 1) {

1109 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

1110 
ŒimËn
 = 1;

1112 *
p
 != '/') {

1113 
p
--;

1114 
ŒimËn
++;

1116 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

1121 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

1122 
	`sdsä“
(
»Í©h
);

1123  
ab¥©h
;

1124 
	}
}

	@src/vr_util.h

1 #iâdeà
_VR_UTIL_H_


2 
	#_VR_UTIL_H_


	)

4 
	~<¡d¬g.h
>

5 
	~<¡dšt.h
>

6 
	~<¡dboŞ.h
>

8 
	~<Ãtš‘/š.h
>

9 
	~<sys/un.h
>

12 
	#__x¡r
(
s
è
	`__¡r
(s)

	)

13 
	#__¡r
(
s
è#s

	)

15 
	#VR_INET4_ADDRSTRLEN
 (("255.255.255.255"è- 1)

	)

16 
	#VR_INET6_ADDRSTRLEN
 \

17 (("ffff:ffff:ffff:ffff:ffff:ffff:255.255.255.255"è- 1)

	)

18 
	#VR_INET_ADDRSTRLEN
 
	`MAX
(
VR_INET4_ADDRSTRLEN
, 
VR_INET6_ADDRSTRLEN
)

	)

19 
	#VR_UNIX_ADDRSTRLEN
 \

20 ((
sockaddr_un
è- 
	`off£tof
(sockaddr_un, 
sun_·th
))

	)

22 
	#VR_INET_PEER_ID_LEN
 (
VR_INET_ADDRSTRLEN
+32è

	)

24 
	#VR_MAXHOSTNAMELEN
 256

	)

36 
	#VR_UINT8_MAXLEN
 (3 + 1)

	)

37 
	#VR_UINT16_MAXLEN
 (5 + 1)

	)

38 
	#VR_UINT32_MAXLEN
 (10 + 1)

	)

39 
	#VR_UINT64_MAXLEN
 (20 + 1)

	)

40 
	#VR_UINTMAX_MAXLEN
 
VR_UINT64_MAXLEN


	)

42 
	#LONG_STR_SIZE
 21

	)

48 
	#VR_ALIGNMENT
 (è

	)

49 
	#VR_ALIGN
(
d
, 
n
è(((dè+ (À- 1)è& ~Ò - 1))

	)

50 
	#VR_ALIGN_PTR
(
p
, 
n
) \

51 (*è(((
ušŒ_t
è(
p
è+ ((ušŒ_tè
n
 - 1)è& ~((ušŒ_tèÀ- 1))

	)

57 
	#vr_g‘ho¡Çme
(
_Çme
, 
_Ën
) \

58 
	`g‘ho¡Çme
((*)
_Çme
, (
size_t
)
_Ën
)

	)

60 
	#vr_©oi
(
_lše
, 
_n
) \

61 
	`_vr_©oi
((*)
_lše
, (
size_t
)
_n
)

	)

63 
vr_£t_blockšg
(
sd
);

64 
vr_£t_nÚblockšg
(
sd
);

65 
vr_£t_»u£addr
(
sd
);

66 
vr_£t_tınod–ay
(
sd
);

67 
vr_£t_lšg”
(
sd
, 
timeout
);

68 
vr_£t_¢dbuf
(
sd
, 
size
);

69 
vr_£t_rcvbuf
(
sd
, 
size
);

70 
vr_g‘_sÛ¼Ü
(
sd
);

71 
vr_g‘_¢dbuf
(
sd
);

72 
vr_g‘_rcvbuf
(
sd
);

73 
vr_£t_tık“·live
(
sd
, 
k“pidË
, 
k“pš‹rv®
, 
k“pcouÁ
);

75 
_vr_©oi
(*
lše
, 
size_t
 
n
);

76 
ušt32_t
 
dig™s10
(
ušt64_t
 
v
);

77 
ušt32_t
 
sdig™s10
(
št64_t
 
v
);

78 
Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
);

79 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

80 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
);

81 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

83 
boŞ
 
vr_v®id_pÜt
(
n
);

89 
	#vr_£ndn
(
_s
, 
_b
, 
_n
) \

90 
	`_vr_£ndn
(
_s
, 
_b
, (
size_t
)(
_n
))

	)

92 
	#vr_»cvn
(
_s
, 
_b
, 
_n
) \

93 
	`_vr_»cvn
(
_s
, 
_b
, (
size_t
)(
_n
))

	)

99 
	#vr_»ad
(
_d
, 
_b
, 
_n
) \

100 
	`»ad
(
_d
, 
_b
, (
size_t
)(
_n
))

	)

102 
	#vr_»adv
(
_d
, 
_b
, 
_n
) \

103 
	`»adv
(
_d
, 
_b
, ()(
_n
))

	)

105 
	#vr_wr™e
(
_d
, 
_b
, 
_n
) \

106 
	`wr™e
(
_d
, 
_b
, (
size_t
)(
_n
))

	)

108 
	#vr_wr™ev
(
_d
, 
_b
, 
_n
) \

109 
	`wr™ev
(
_d
, 
_b
, ()(
_n
))

	)

111 
ssize_t
 
_vr_£ndn
(
sd
, cÚ¡ *
v±r
, 
size_t
 
n
);

112 
ssize_t
 
_vr_»cvn
(
sd
, *
v±r
, 
size_t
 
n
);

114 
št64_t
 
vr_u£c_now
();

115 
št64_t
 
vr_m£c_now
();

122 
	ssockšfo
 {

123 
	mçmy
;

124 
sockËn_t
 
	madd¾’
;

126 
sockaddr_š
 
	mš
;

127 
sockaddr_š6
 
	mš6
;

128 
sockaddr_un
 
	mun
;

129 } 
	maddr
;

132 
vr_»sŞve
(
sds
 
Çme
, 
pÜt
, 
sockšfo
 *
si
);

133 
vr_Ãt_fÜm©_³”
(
fd
, *
buf
, 
size_t
 
buf_Ën
);

135 
g‘_¿ndom_hex_ch¬s
(*
p
, 
Ën
);

137 
¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
, cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
);

138 
¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
);

144 
	#vr_memıy
(
_d
, 
_c
, 
_n
) \

145 
	`memıy
(
_d
, 
_c
, (
size_t
)(
_n
))

	)

147 
	#vr_memmove
(
_d
, 
_c
, 
_n
) \

148 
	`memmove
(
_d
, 
_c
, (
size_t
)(
_n
))

	)

150 
	#vr_memchr
(
_d
, 
_c
, 
_n
) \

151 
	`memchr
(
_d
, 
_c
, (
size_t
)(
_n
))

	)

153 
	#vr_¡¾’
(
_s
) \

154 
	`¡¾’
((*)(
_s
))

	)

156 
	#vr_¡ºcmp
(
_s1
, 
_s2
, 
_n
) \

157 
	`¡ºcmp
((*)(
_s1
), (*)(
_s2
), (
size_t
)(
_n
))

	)

159 
	#vr_¡rchr
(
_p
, 
_l
, 
_c
) \

160 
	`_vr_¡rchr
((
ušt8_t
 *)(
_p
), (ušt8_ˆ*)(
_l
), (ušt8_t)(
_c
))

	)

162 
	#vr_¡¼chr
(
_p
, 
_s
, 
_c
) \

163 
	`_vr_¡¼chr
((
ušt8_t
 *)(
_p
),(ušt8_ˆ*)(
_s
), (ušt8_t)(
_c
))

	)

165 
	#vr_¡ºdup
(
_s
, 
_n
) \

166 (
ušt8_t
 *)
	`¡ºdup
((*)(
_s
), (
size_t
)(
_n
));

	)

168 
šlše
 
ušt8_t
 *

169 
	$_vr_¡rchr
(
ušt8_t
 *
p
, ušt8_ˆ*
Ï¡
, ušt8_ˆ
c
)

171 
p
 < 
Ï¡
) {

172 ià(*
p
 =ğ
c
) {

173  
p
;

175 
p
++;

178  
NULL
;

179 
	}
}

181 
šlše
 
ušt8_t
 *

182 
	$_vr_¡¼chr
(
ušt8_t
 *
p
, ušt8_ˆ*
¡¬t
, ušt8_ˆ
c
)

184 
p
 >ğ
¡¬t
) {

185 ià(*
p
 =ğ
c
) {

186  
p
;

188 
p
--;

191  
NULL
;

192 
	}
}

194 
mem»v16
(*
p
);

195 
mem»v32
(*
p
);

196 
mem»v64
(*
p
);

197 
ušt16_t
 
šŒev16
(ušt16_ˆ
v
);

198 
ušt32_t
 
šŒev32
(ušt32_ˆ
v
);

199 
ušt64_t
 
šŒev64
(ušt64_ˆ
v
);

203 #ifdeà
VR_LITTLE_ENDIAN


204 
	#mem»v16ifbe
(
p
)

	)

205 
	#mem»v32ifbe
(
p
)

	)

206 
	#mem»v64ifbe
(
p
)

	)

207 
	#šŒev16ifbe
(
v
è(v)

	)

208 
	#šŒev32ifbe
(
v
è(v)

	)

209 
	#šŒev64ifbe
(
v
è(v)

	)

211 
	#mem»v16ifbe
(
p
è
	`mem»v16
Õ)

	)

212 
	#mem»v32ifbe
(
p
è
	`mem»v32
Õ)

	)

213 
	#mem»v64ifbe
(
p
è
	`mem»v64
Õ)

	)

214 
	#šŒev16ifbe
(
v
è
	`šŒev16
(v)

	)

215 
	#šŒev32ifbe
(
v
è
	`šŒev32
(v)

	)

216 
	#šŒev64ifbe
(
v
è
	`šŒev64
(v)

	)

219 
memtŞl
(cÚ¡ *
p
, *
”r
);

220 
by‹sToHumª
(*
s
, 
n
);

222 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

	@src/vr_worker.c

1 
	~<vr_cÜe.h
>

4 
	gÏ¡_wÜk”_th»ad
 = -1;

5 
	gnum_wÜk”_th»ads
;

7 
d¬¿y
 
	gwÜk”s
;

9 *
wÜk”_th»ad_run
(*
¬gs
);

11 
	#SU_PER_ALLOC
 64

	)

14 
cÚnsw­un™
 *
	gcsui_ä“li¡
;

15 
±h»ad_mu‹x_t
 
	gcsui_ä“li¡_lock
;

20 
cÚnsw­un™
 *

21 
	$csui_Ãw
() {

22 
cÚnsw­un™
 *
™em
 = 
NULL
;

23 
	`±h»ad_mu‹x_lock
(&
csui_ä“li¡_lock
);

24 ià(
csui_ä“li¡
) {

25 
™em
 = 
csui_ä“li¡
;

26 
csui_ä“li¡
 = 
™em
->
Ãxt
;

28 
	`±h»ad_mu‹x_uÆock
(&
csui_ä“li¡_lock
);

30 ià(
NULL
 =ğ
™em
) {

31 
i
;

34 
™em
 = 
	`d®loc
((
cÚnsw­un™
è* 
SU_PER_ALLOC
);

35 ià(
NULL
 =ğ
™em
) {

36  
NULL
;

44 
i
 = 2; i < 
SU_PER_ALLOC
; i++)

45 
™em
[
i
 - 1].
Ãxt
 = &item[i];

47 
	`±h»ad_mu‹x_lock
(&
csui_ä“li¡_lock
);

48 
™em
[
SU_PER_ALLOC
 - 1].
Ãxt
 = 
csui_ä“li¡
;

49 
csui_ä“li¡
 = &
™em
[1];

50 
	`±h»ad_mu‹x_uÆock
(&
csui_ä“li¡_lock
);

53  
™em
;

54 
	}
}

60 
	$csui_ä“
(
cÚnsw­un™
 *
™em
) {

61 
	`±h»ad_mu‹x_lock
(&
csui_ä“li¡_lock
);

62 
™em
->
Ãxt
 = 
csui_ä“li¡
;

63 
csui_ä“li¡
 = 
™em
;

64 
	`±h»ad_mu‹x_uÆock
(&
csui_ä“li¡_lock
);

65 
	}
}

68 
	$csul_push
(
vr_wÜk”
 *
wÜk”
, 
cÚnsw­un™
 *
su
)

70 
	`±h»ad_mu‹x_lock
(&
wÜk”
->
csuÎock
);

71 
	`dli¡Push
(
wÜk”
->
csul
, 
su
);

72 
	`±h»ad_mu‹x_uÆock
(&
wÜk”
->
csuÎock
);

73 
	}
}

75 
cÚnsw­un™
 *

76 
	$csul_pİ
(
vr_wÜk”
 *
wÜk”
)

78 
cÚnsw­un™
 *
su
 = 
NULL
;

80 
	`±h»ad_mu‹x_lock
(&
wÜk”
->
csuÎock
);

81 
su
 = 
	`dli¡Pİ
(
wÜk”
->
csul
);

82 
	`±h»ad_mu‹x_uÆock
(&
wÜk”
->
csuÎock
);

84  
su
;

85 
	}
}

88 
	$vr_wÜk”_š™
(
vr_wÜk”
 *
wÜk”
)

90 
r¡©us_t
 
¡©us
;

91 
maxş›Ás
, 
th»ads_num
;

92 
f–im™
;

94 ià(
wÜk”
 =ğ
NULL
) {

95  
VR_ERROR
;

98 
wÜk”
->
id
 = 0;

99 
wÜk”
->
sock‘·œs
[0] = -1;

100 
wÜk”
->
sock‘·œs
[1] = -1;

101 
wÜk”
->
csul
 = 
NULL
;

102 
	`±h»ad_mu‹x_š™
(&
wÜk”
->
csuÎock
, 
NULL
);

103 
wÜk”
->
cu¼’t_db
 = 0;

104 
wÜk”
->
tim–im™_ex™
 = 0;

105 
wÜk”
->
Ï¡_ç¡_cyşe
 = 0;

106 
wÜk”
->
»size_db
 = 0;

107 
wÜk”
->
»hash_db
 = 0;

109 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
maxş›Ás
);

110 
f–im™
 = 
	`adju¡O³nFesLim™
(
maxş›Ás
);

111 ià(
f–im™
 <= 0) {

112  
VR_ERROR
;

114 
	`vr_ev’oİ_š™
(&
wÜk”
->
v–
, 
f–im™
);

115 
wÜk”
->
v–
.
th»ad
.
fun_run
 = 
wÜk”_th»ad_run
;

116 
wÜk”
->
v–
.
th»ad
.
d©a
 = worker;

117 
wÜk”
->
v–
.
c¡abË
 = 
	`commªdStsTabËC»©e
();

119 
¡©us
 = 
	`sock‘·œ
(
AF_LOCAL
, 
SOCK_STREAM
, 0, 
wÜk”
->
sock‘·œs
);

120 ià(
¡©us
 < 0) {

121 
	`log_”rÜ
("ü—‹ sock‘·œ çed: %s", 
	`¡»¼Ü
(
”ºo
));

122  
VR_ERROR
;

124 
¡©us
 = 
	`vr_£t_nÚblockšg
(
wÜk”
->
sock‘·œs
[0]);

125 ià(
¡©us
 < 0) {

126 
	`log_”rÜ
("set socketpairs[0] %d‚onblocking failed: %s",

127 
wÜk”
->
sock‘·œs
[0], 
	`¡»¼Ü
(
”ºo
));

128 
	`şo£
(
wÜk”
->
sock‘·œs
[0]);

129 
wÜk”
->
sock‘·œs
[0] = -1;

130 
	`şo£
(
wÜk”
->
sock‘·œs
[1]);

131 
wÜk”
->
sock‘·œs
[1] = -1;

132  
VR_ERROR
;

134 
¡©us
 = 
	`vr_£t_nÚblockšg
(
wÜk”
->
sock‘·œs
[1]);

135 ià(
¡©us
 < 0) {

136 
	`log_”rÜ
("set socketpairs[1] %d‚onblocking failed: %s",

137 
wÜk”
->
sock‘·œs
[1], 
	`¡»¼Ü
(
”ºo
));

138 
	`şo£
(
wÜk”
->
sock‘·œs
[0]);

139 
wÜk”
->
sock‘·œs
[0] = -1;

140 
	`şo£
(
wÜk”
->
sock‘·œs
[1]);

141 
wÜk”
->
sock‘·œs
[1] = -1;

142  
VR_ERROR
;

145 
wÜk”
->
csul
 = 
	`dli¡C»©e
();

146 ià(
wÜk”
->
csul
 =ğ
NULL
) {

147 
	`log_”rÜ
("create†ist failed: out of memory");

148  
VR_ENOMEM
;

151  
VR_OK
;

152 
	}
}

155 
	$vr_wÜk”_deš™
(
vr_wÜk”
 *
wÜk”
)

157 ià(
wÜk”
 =ğ
NULL
) {

161 
	`vr_ev’oİ_deš™
(&
wÜk”
->
v–
);

163 ià(
wÜk”
->
sock‘·œs
[0] > 0){

164 
	`şo£
(
wÜk”
->
sock‘·œs
[0]);

165 
wÜk”
->
sock‘·œs
[0] = -1;

167 ià(
wÜk”
->
sock‘·œs
[1] > 0){

168 
	`şo£
(
wÜk”
->
sock‘·œs
[1]);

169 
wÜk”
->
sock‘·œs
[1] = -1;

172 ià(
wÜk”
->
csul
 !ğ
NULL
) {

173 
	`dli¡R–—£
(
wÜk”
->
csul
);

174 
wÜk”
->
csul
 = 
NULL
;

176 
	}
}

179 
	$wÜk”_g‘_Ãxt_idx
(
curidx
)

181 
idx
 = 
curidx
 + 1;

182  
idx
>=
num_wÜk”_th»ads
?0:idx;

183 
	}
}

186 
	$di¥©ch_cÚn_Ãw
(
vr_li¡’
 *
vli¡’
, 
sd
)

188 
cÚnsw­un™
 *
su
 = 
	`csui_Ãw
();

189 
buf
[1];

190 
vr_wÜk”
 *
wÜk”
;

192 ià(
su
 =ğ
NULL
) {

193 
	`şo£
(
sd
);

195 
	`log_”rÜ
("Failedo‡llocate memory for connection swap object\n");

199 
tid
 = (
Ï¡_wÜk”_th»ad
 + 1è% 
num_wÜk”_th»ads
;

200 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, (
ušt32_t
)
tid
);

202 
Ï¡_wÜk”_th»ad
 = 
tid
;

204 
su
->
num
 = 
sd
;

205 
su
->
d©a
 = 
vli¡’
;

207 
	`csul_push
(
wÜk”
, 
su
);

209 
buf
[0] = 'c';

210 ià(
	`vr_wr™e
(
wÜk”
->
sock‘·œs
[0], 
buf
, 1) != 1) {

211 
	`log_”rÜ
("Noticehe worker failed.");

214 
	`upd©e_cu¼_ş›Ás_add
(1);

215 
	}
}

218 
	$th»ad_ev’t_´oûss
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

220 
r¡©us_t
 
¡©us
;

221 
vr_wÜk”
 *
wÜk”
 = 
´ivd©a
;

222 
buf
[1];

223 
sd
;

224 
vr_li¡’
 *
vli¡’
;

225 
cÚn
 *conn;

226 
cÚnsw­un™
 *
csu
;

227 
ş›Á
 *
c
;

229 
	`ASSERT
(
–
 =ğ
wÜk”
->
v–
.el);

230 
	`ASSERT
(
fd
 =ğ
wÜk”
->
sock‘·œs
[1]);

232 ià(
	`vr_»ad
(
fd
, 
buf
, 1) != 1) {

233 
	`log_w¬n
("Can't„ead for worker(id:%d) socketpairs[1](%d)",

234 
wÜk”
->
v–
.
th»ad
.
id
, 
fd
);

235 
buf
[0] = 'c';

238 
buf
[0]) {

240 
csu
 = 
	`csul_pİ
(
wÜk”
);

241 ià(
csu
 =ğ
NULL
) {

244 
sd
 = 
csu
->
num
;

245 
vli¡’
 = 
csu
->
d©a
;

246 
	`csui_ä“
(
csu
);

247 
cÚn
 = 
	`cÚn_g‘
(
wÜk”
->
v–
.
cb
);

248 ià(
cÚn
 =ğ
NULL
) {

249 
	`log_”rÜ
("get conn for c %d failed: %s",

250 
sd
, 
	`¡»¼Ü
(
”ºo
));

251 
¡©us
 = 
	`şo£
(
sd
);

252 ià(
¡©us
 < 0) {

253 
	`log_”rÜ
("şo£ c %d faed, ignÜed: %s", 
sd
, 
	`¡»¼Ü
(
”ºo
));

257 
cÚn
->
sd
 = sd;

259 
¡©us
 = 
	`vr_£t_nÚblockšg
(
cÚn
->
sd
);

260 ià(
¡©us
 < 0) {

261 
	`log_”rÜ
("set‚onblock on c %d failed: %s",

262 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

263 
	`cÚn_put
(
cÚn
);

267 ià(
vli¡’
->
šfo
.
çmy
 =ğ
AF_INET
 || vli¡’->šfo.çmy =ğ
AF_INET6
) {

268 
¡©us
 = 
	`vr_£t_tınod–ay
(
cÚn
->
sd
);

269 ià(
¡©us
 < 0) {

270 
	`log_w¬n
("setcpnodelay on c %d failed, ignored: %s",

271 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

275 
c
 = 
	`ü—‹Cl›Á
(&
wÜk”
->
v–
, 
cÚn
);

276 ià(
c
 =ğ
NULL
) {

277 
	`log_”rÜ
("Create client failed");

278 
	`cÚn_put
(
cÚn
);

281 
c
->
curidx
 = 
wÜk”
->
id
;

282 
¡©us
 = 
	`«C»©eFeEv’t
(
wÜk”
->
v–
.
–
, 
cÚn
->
sd
, 
AE_READABLE
,

283 
»adQu”yFromCl›Á
, 
c
);

284 ià(
¡©us
 =ğ
AE_ERR
) {

285 
	`log_”rÜ
("Unrecoverableƒrror creating worker ipfd fileƒvent.");

289 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
numcÚÃùiÚs
, 1);

293 
csu
 = 
	`csul_pİ
(
wÜk”
);

294 ià(
csu
 =ğ
NULL
) {

297 
c
 = 
csu
->
d©a
;

298 
	`csui_ä“
(
csu
);

299 
c
->
v–
 = &
wÜk”
->vel;

300 
c
->
curidx
 = 
wÜk”
->
id
;

301 
c
->
¡•s
 ++;

302 
c
->
cmd
->
	`´oc
(c);

304 ià(
c
->
æags
&
CLIENT_JUMP
) {

305 
	`di¥©ch_cÚn_exi¡
(
c
,c->
ridx
);

307 
	`»£tCl›Á
(
c
);

308 
	`lškCl›ÁToEv’oİ
(
c
,c->
v–
);

312 
	`log_”rÜ
("readƒrror char '%c' for worker(id:%d) socketpairs[1](%d)",

313 
buf
[0], 
wÜk”
->
v–
.
th»ad
.
id
, wÜk”->
sock‘·œs
[1]);

316 
	}
}

319 
	$£tup_wÜk”
(
vr_wÜk”
 *
wÜk”
)

321 
r¡©us_t
 
¡©us
;

323 
¡©us
 = 
	`«C»©eFeEv’t
(
wÜk”
->
v–
.
–
, wÜk”->
sock‘·œs
[1], 
AE_READABLE
,

324 
th»ad_ev’t_´oûss
, 
wÜk”
);

325 ià(
¡©us
 =ğ
AE_ERR
) {

326 
	`log_”rÜ
("Unrecoverableƒrror creating worker ipfd fileƒvent.");

327  
VR_ERROR
;

330 
	`«S‘BefÜeSË•Proc
(
wÜk”
->
v–
.
–
, 
wÜk”_befÜe_¦“p
, worker);

334 if(
	`«C»©eTimeEv’t
(
wÜk”
->
v–
.
–
, 1, 
wÜk”_üÚ
, wÜk”, 
NULL
è=ğ
AE_ERR
) {

335 
	`£rv”Pªic
("Can't createhe serverCronimeƒvent.");

336  
VR_ERROR
;

339  
VR_OK
;

340 
	}
}

343 
	$wÜk”_th»ad_run
(*
¬gs
)

345 
vr_wÜk”
 *
wÜk”
 = 
¬gs
;

348 
	`«Maš
(
wÜk”
->
v–
.
–
);

350  
NULL
;

351 
	}
}

354 
	$wÜk”s_š™
(
ušt32_t
 
wÜk”_couÁ
)

356 
r¡©us_t
 
¡©us
;

357 
ušt32_t
 
idx
;

358 
vr_wÜk”
 *
wÜk”
;

360 
csui_ä“li¡
 = 
NULL
;

361 
	`±h»ad_mu‹x_š™
(&
csui_ä“li¡_lock
, 
NULL
);

363 
	`d¬¿y_š™
(&
wÜk”s
, 
wÜk”_couÁ
, (
vr_wÜk”
));

365 
idx
 = 0; idx < 
wÜk”_couÁ
; idx ++) {

366 
wÜk”
 = 
	`d¬¿y_push
(&
wÜk”s
);

367 
	`vr_wÜk”_š™
(
wÜk”
);

368 
wÜk”
->
id
 = 
idx
;

369 
¡©us
 = 
	`£tup_wÜk”
(
wÜk”
);

370 ià(
¡©us
 !ğ
VR_OK
) {

371 
	`ex™
(1);

375 
num_wÜk”_th»ads
 = ()
	`d¬¿y_n
(&
wÜk”s
);

377  
VR_OK
;

378 
	}
}

381 
	$wÜk”s_run
()

383 
ušt32_t
 
i
, 
th»ad_couÁ
;

384 
vr_wÜk”
 *
wÜk”
;

386 
th»ad_couÁ
 = (
ušt32_t
)
num_wÜk”_th»ads
;

388 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

389 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
i
);

390 
	`vr_th»ad_¡¬t
(&
wÜk”
->
v–
.
th»ad
);

393  
VR_OK
;

394 
	}
}

397 
	$wÜk”s_wa™
()

399 
ušt32_t
 
i
, 
th»ad_couÁ
;

400 
vr_wÜk”
 *
wÜk”
;

402 
th»ad_couÁ
 = (
ušt32_t
)
num_wÜk”_th»ads
;

404 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

405 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
i
);

406 
	`±h»ad_još
(
wÜk”
->
v–
.
th»ad
.
th»ad_id
, 
NULL
);

409  
VR_OK
;

410 
	}
}

413 
	$wÜk”s_deš™
()

415 
vr_wÜk”
 *
wÜk”
;

417 
	`d¬¿y_n
(&
wÜk”s
)) {

418 
wÜk”
 = 
	`d¬¿y_pİ
(&
wÜk”s
);

419 
	`vr_wÜk”_deš™
(
wÜk”
);

421 
	}
}

427 
	$wÜk”_befÜe_¦“p
(
«Ev’tLoİ
 *
ev’tLoİ
, *
´iv©e_d©a
) {

428 
vr_wÜk”
 *
wÜk”
 = 
´iv©e_d©a
;

430 
	`UNUSED
(
ev’tLoİ
);

431 
	`UNUSED
(
´iv©e_d©a
);

433 
	`ASSERT
(
ev’tLoİ
 =ğ
wÜk”
->
v–
.
–
);

436 
	`hªdËCl›ÁsW™hP’dšgWr™es
(&
wÜk”
->
v–
);

439 
	}
}

442 
	$wÜk”_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

443 
vr_wÜk”
 *
wÜk”
 = 
ş›ÁD©a
;

444 
vr_ev’oİ
 *
v–
 = &
wÜk”
->vel;

445 
size_t
 
¡©_u£d_memÜy
, 
¡©s_³ak_memÜy
;

447 
	`UNUSED
(
ev’tLoİ
);

448 
	`UNUSED
(
id
);

449 
	`UNUSED
(
ş›ÁD©a
);

451 
	`ASSERT
(
ev’tLoİ
 =ğ
v–
->
–
);

453 
v–
->
unixtime
 = 
	`time
(
NULL
);

454 
v–
->
m¡ime
 = 
	`vr_m£c_now
();

456 
	`run_w™h_³riod
(100, 
v–
->
üÚloİs
) {

457 
¡©s_v®ue
;

458 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
,
numcommªds
,&
¡©s_v®ue
);

459 
	`ŒackIn¡ªÃousM‘ric
(
v–
->
¡©s
,
STATS_METRIC_COMMAND
,
¡©s_v®ue
);

460 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
,
Ãt_šput_by‹s
,&
¡©s_v®ue
);

461 
	`ŒackIn¡ªÃousM‘ric
(
v–
->
¡©s
,
STATS_METRIC_NET_INPUT
,
¡©s_v®ue
);

462 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
,
Ãt_ouut_by‹s
,&
¡©s_v®ue
);

463 
	`ŒackIn¡ªÃousM‘ric
(
v–
->
¡©s
,
STATS_METRIC_NET_OUTPUT
,
¡©s_v®ue
);

467 
	`run_w™h_³riod
(1000, 
v–
->
üÚloİs
) {

468 
v–
->
»sid’t_£t_size
 = 
	`d®loc_g‘_rss
();

479 
	`ä“Cl›ÁsInAsyncF»eQueue
(
v–
);

484 
	`run_w™h_³riod
(1000, 
v–
->
üÚloİs
) {

485 
	`cÚf_ÿche_upd©e
(&
v–
->
cc
);

488 
v–
->
üÚloİs
 ++;

489  1000/
v–
->
hz
;

490 
	}
}

	@src/vr_worker.h

1 #iâdeà
_VR_WORKER_H_


2 
	#_VR_WORKER_H_


	)

4 
	svr_wÜk”
 {

6 
	mid
;

7 
vr_ev’oİ
 
	mv–
;

9 
	msock‘·œs
[2];

11 
dli¡
 *
	mcsul
;

12 
±h»ad_mu‹x_t
 
	mcsuÎock
;

16 
	mcu¼’t_db
;

17 
	mtim–im™_ex™
;

18 
	mÏ¡_ç¡_cyşe
;

23 
	m»size_db
;

24 
	m»hash_db
;

25 }
	tvr_wÜk”
;

27 
	scÚnsw­un™
 {

28 
	mnum
;

29 *
	md©a
;

30 
cÚnsw­un™
 *
	mÃxt
;

33 
d¬¿y
 
wÜk”s
;

35 
wÜk”s_š™
(
ušt32_t
 
wÜk”_couÁ
);

36 
wÜk”s_run
();

37 
wÜk”s_wa™
();

38 
wÜk”s_deš™
();

40 
cÚnsw­un™
 *
csui_Ãw
();

41 
csui_ä“
(
cÚnsw­un™
 *
™em
);

43 
csul_push
(
vr_wÜk”
 *
wÜk”
, 
cÚnsw­un™
 *
su
);

44 
cÚnsw­un™
 *
csul_pİ
(
vr_wÜk”
 *
wÜk”
);

46 
wÜk”_g‘_Ãxt_idx
(
curidx
);

48 
di¥©ch_cÚn_Ãw
(
vr_li¡’
 *
vli¡’
, 
sd
);

50 
wÜk”_befÜe_¦“p
(
«Ev’tLoİ
 *
ev’tLoİ
, *
´iv©e_d©a
);

51 
wÜk”_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
);

	@src/vr_ziplist.c

104 
	~<¡dio.h
>

105 
	~<¡dlib.h
>

106 
	~<¡ršg.h
>

107 
	~<¡dšt.h
>

108 
	~<lim™s.h
>

110 
	~<vr_cÜe.h
>

112 
	#ZIP_END
 255

	)

113 
	#ZIP_BIGLEN
 254

	)

116 
	#ZIP_STR_MASK
 0xc0

	)

117 
	#ZIP_INT_MASK
 0x30

	)

118 
	#ZIP_STR_06B
 (0 << 6)

	)

119 
	#ZIP_STR_14B
 (1 << 6)

	)

120 
	#ZIP_STR_32B
 (2 << 6)

	)

121 
	#ZIP_INT_16B
 (0xc0 | 0<<4)

	)

122 
	#ZIP_INT_32B
 (0xc0 | 1<<4)

	)

123 
	#ZIP_INT_64B
 (0xc0 | 2<<4)

	)

124 
	#ZIP_INT_24B
 (0xc0 | 3<<4)

	)

125 
	#ZIP_INT_8B
 0xã

	)

127 
	#ZIP_INT_IMM_MASK
 0x0f

	)

128 
	#ZIP_INT_IMM_MIN
 0xf1

	)

129 
	#ZIP_INT_IMM_MAX
 0xfd

	)

130 
	#ZIP_INT_IMM_VAL
(
v
è(v & 
ZIP_INT_IMM_MASK
)

	)

132 
	#INT24_MAX
 0x7fffff

	)

133 
	#INT24_MIN
 (-
INT24_MAX
 - 1)

	)

136 
	#ZIP_IS_STR
(
’c
è((Óncè& 
ZIP_STR_MASK
è< ZIP_STR_MASK)

	)

139 
	#ZIPLIST_BYTES
(
zl
è(*((
ušt32_t
*)(zl)))

	)

140 
	#ZIPLIST_TAIL_OFFSET
(
zl
è(*((
ušt32_t
*)((zl)+(ušt32_t))))

	)

141 
	#ZIPLIST_LENGTH
(
zl
è(*((
ušt16_t
*)((zl)+(
ušt32_t
)*2)))

	)

142 
	#ZIPLIST_HEADER_SIZE
 ((
ušt32_t
)*2+(
ušt16_t
))

	)

143 
	#ZIPLIST_END_SIZE
 ((
ušt8_t
))

	)

144 
	#ZIPLIST_ENTRY_HEAD
(
zl
è((zl)+
ZIPLIST_HEADER_SIZE
)

	)

145 
	#ZIPLIST_ENTRY_TAIL
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl)))

	)

146 
	#ZIPLIST_ENTRY_END
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-1)

	)

150 
	#ZIPLIST_INCR_LENGTH
(
zl
,
šü
) { \

151 ià(
	`ZIPLIST_LENGTH
(
zl
è< 
UINT16_MAX
) \

152 
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(šŒev16ifbe(ZIPLIST_LENGTH(zl))+
šü
); \

153 }

	)

155 
	szËÁry
 {

156 
	m´ev¿wËnsize
, 
	m´ev¿wËn
;

157 
	mËnsize
, 
	mËn
;

158 
	mh—d”size
;

159 
	m’codšg
;

160 *
	mp
;

161 } 
	tzËÁry
;

163 
	#ZIPLIST_ENTRY_ZERO
(
zË
) { \

164 (
zË
)->
´ev¿wËnsize
 = (zË)->
´ev¿wËn
 = 0; \

165 (
zË
)->
Ënsize
 = (zË)->
Ën
 = (zË)->
h—d”size
 = 0; \

166 (
zË
)->
’codšg
 = 0; \

167 (
zË
)->
p
 = 
NULL
; \

168 }

	)

172 
	#ZIP_ENTRY_ENCODING
(
±r
, 
’codšg
) do { \

173 (
’codšg
èğ(
±r
[0]); \

174 ià((
’codšg
è< 
ZIP_STR_MASK
) (encoding) &= ZIP_STR_MASK; \

175 } 0)

	)

177 
zli¡R•r
(*
zl
);

180 
	$zIÁSize
(
’codšg
) {

181 
’codšg
) {

182 
ZIP_INT_8B
:  1;

183 
ZIP_INT_16B
:  2;

184 
ZIP_INT_24B
:  3;

185 
ZIP_INT_32B
:  4;

186 
ZIP_INT_64B
:  8;

189 
	`ASSERT
(
NULL
);

191 
	}
}

195 
	$zEncodeL’gth
(*
p
, 
’codšg
, 
¿wËn
) {

196 
Ën
 = 1, 
buf
[5];

198 ià(
	`ZIP_IS_STR
(
’codšg
)) {

201 ià(
¿wËn
 <= 0x3f) {

202 ià(!
p
è 
Ën
;

203 
buf
[0] = 
ZIP_STR_06B
 | 
¿wËn
;

204 } ià(
¿wËn
 <= 0x3fff) {

205 
Ën
 += 1;

206 ià(!
p
è 
Ën
;

207 
buf
[0] = 
ZIP_STR_14B
 | ((
¿wËn
 >> 8) & 0x3f);

208 
buf
[1] = 
¿wËn
 & 0xff;

210 
Ën
 += 4;

211 ià(!
p
è 
Ën
;

212 
buf
[0] = 
ZIP_STR_32B
;

213 
buf
[1] = (
¿wËn
 >> 24) & 0xff;

214 
buf
[2] = (
¿wËn
 >> 16) & 0xff;

215 
buf
[3] = (
¿wËn
 >> 8) & 0xff;

216 
buf
[4] = 
¿wËn
 & 0xff;

220 ià(!
p
è 
Ën
;

221 
buf
[0] = 
’codšg
;

225 
	`memıy
(
p
,
buf
,
Ën
);

226  
Ën
;

227 
	}
}

233 
	#ZIP_DECODE_LENGTH
(
±r
, 
’codšg
, 
Ënsize
, 
Ën
) do { \

234 
	`ZIP_ENTRY_ENCODING
((
±r
), (
’codšg
)); \

235 ià((
’codšg
è< 
ZIP_STR_MASK
) { \

236 ià((
’codšg
è=ğ
ZIP_STR_06B
) { \

237 (
Ënsize
) = 1; \

238 (
Ën
èğ(
±r
)[0] & 0x3f; \

239 } ià((
’codšg
è=ğ
ZIP_STR_14B
) { \

240 (
Ënsize
) = 2; \

241 (
Ën
èğ(((
±r
)[0] & 0x3f) << 8) | (ptr)[1]; \

242 } ià(
’codšg
 =ğ
ZIP_STR_32B
) { \

243 (
Ënsize
) = 5; \

244 (
Ën
èğ((
±r
)[1] << 24) | \

245 ((
±r
)[2] << 16) | \

246 ((
±r
)[3] << 8) | \

247 ((
±r
)[4]); \

249 
	`ASSERT
(
NULL
); \

252 (
Ënsize
) = 1; \

253 (
Ën
èğ
	`zIÁSize
(
’codšg
); \

255 } 0);

	)

259 
	$zP»vEncodeL’gth
(*
p
, 
Ën
) {

260 ià(
p
 =ğ
NULL
) {

261  (
Ën
 < 
ZIP_BIGLEN
) ? 1 : (len)+1;

263 ià(
Ën
 < 
ZIP_BIGLEN
) {

264 
p
[0] = 
Ën
;

267 
p
[0] = 
ZIP_BIGLEN
;

268 
	`memıy
(
p
+1,&
Ën
,(len));

269 
	`mem»v32ifbe
(
p
+1);

270  1+(
Ën
);

273 
	}
}

277 
	$zP»vEncodeL’gthFÜûL¬ge
(*
p
, 
Ën
) {

278 ià(
p
 =ğ
NULL
) ;

279 
p
[0] = 
ZIP_BIGLEN
;

280 
	`memıy
(
p
+1,&
Ën
,(len));

281 
	`mem»v32ifbe
(
p
+1);

282 
	}
}

286 
	#ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
) do { \

287 ià((
±r
)[0] < 
ZIP_BIGLEN
) { \

288 (
´evËnsize
) = 1; \

290 (
´evËnsize
) = 5; \

292 } 0);

	)

296 
	#ZIP_DECODE_PREVLEN
(
±r
, 
´evËnsize
, 
´evËn
) do { \

297 
	`ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
); \

298 ià((
´evËnsize
) == 1) { \

299 (
´evËn
èğ(
±r
)[0]; \

300 } ià((
´evËnsize
) == 5) { \

301 
	`ASSERT
(((
´evËnsize
)) == 4); \

302 
	`memıy
(&(
´evËn
), ((*)(
±r
)) + 1, 4); \

303 
	`mem»v32ifbe
(&
´evËn
); \

305 } 0);

	)

309 
	$zP»vL’By‹Diff
(*
p
, 
Ën
) {

310 
´evËnsize
;

311 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

312  
	`zP»vEncodeL’gth
(
NULL
, 
Ën
è- 
´evËnsize
;

313 
	}
}

316 
	$zRawEÁryL’gth
(*
p
) {

317 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

318 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

319 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

320  
´evËnsize
 + 
Ënsize
 + 
Ën
;

321 
	}
}

325 
	$zTryEncodšg
(*
’Œy
, 
’ŒyËn
, *
v
, *
’codšg
) {

326 
v®ue
;

328 ià(
’ŒyËn
 >= 32 ||ƒntrylen == 0)  0;

329 ià(
	`¡ršg2Î
((*)
’Œy
,
’ŒyËn
,&
v®ue
)) {

332 ià(
v®ue
 >= 0 && value <= 12) {

333 *
’codšg
 = 
ZIP_INT_IMM_MIN
+
v®ue
;

334 } ià(
v®ue
 >ğ
INT8_MIN
 && v®u<ğ
INT8_MAX
) {

335 *
’codšg
 = 
ZIP_INT_8B
;

336 } ià(
v®ue
 >ğ
INT16_MIN
 && v®u<ğ
INT16_MAX
) {

337 *
’codšg
 = 
ZIP_INT_16B
;

338 } ià(
v®ue
 >ğ
INT24_MIN
 && v®u<ğ
INT24_MAX
) {

339 *
’codšg
 = 
ZIP_INT_24B
;

340 } ià(
v®ue
 >ğ
INT32_MIN
 && v®u<ğ
INT32_MAX
) {

341 *
’codšg
 = 
ZIP_INT_32B
;

343 *
’codšg
 = 
ZIP_INT_64B
;

345 *
v
 = 
v®ue
;

349 
	}
}

352 
	$zSaveIÁeg”
(*
p
, 
št64_t
 
v®ue
, 
’codšg
) {

353 
št16_t
 
i16
;

354 
št32_t
 
i32
;

355 
št64_t
 
i64
;

356 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

357 ((
št8_t
*)
p
)[0] = (št8_t)
v®ue
;

358 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

359 
i16
 = 
v®ue
;

360 
	`memıy
(
p
,&
i16
,(i16));

361 
	`mem»v16ifbe
(
p
);

362 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

363 
i32
 = 
v®ue
<<8;

364 
	`mem»v32ifbe
(&
i32
);

365 
	`memıy
(
p
,((
ušt8_t
*)&
i32
)+1,(i32)-(uint8_t));

366 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

367 
i32
 = 
v®ue
;

368 
	`memıy
(
p
,&
i32
,(i32));

369 
	`mem»v32ifbe
(
p
);

370 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

371 
i64
 = 
v®ue
;

372 
	`memıy
(
p
,&
i64
,(i64));

373 
	`mem»v64ifbe
(
p
);

374 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

377 
	`ASSERT
(
NULL
);

379 
	}
}

382 
št64_t
 
	$zLßdIÁeg”
(*
p
, 
’codšg
) {

383 
št16_t
 
i16
;

384 
št32_t
 
i32
;

385 
št64_t
 
i64
, 
»t
 = 0;

386 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

387 
»t
 = ((
št8_t
*)
p
)[0];

388 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

389 
	`memıy
(&
i16
,
p
,(i16));

390 
	`mem»v16ifbe
(&
i16
);

391 
»t
 = 
i16
;

392 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

393 
	`memıy
(&
i32
,
p
,(i32));

394 
	`mem»v32ifbe
(&
i32
);

395 
»t
 = 
i32
;

396 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

397 
i32
 = 0;

398 
	`memıy
(((
ušt8_t
*)&
i32
)+1,
p
,(i32)-(uint8_t));

399 
	`mem»v32ifbe
(&
i32
);

400 
»t
 = 
i32
>>8;

401 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

402 
	`memıy
(&
i64
,
p
,(i64));

403 
	`mem»v64ifbe
(&
i64
);

404 
»t
 = 
i64
;

405 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

406 
»t
 = (
’codšg
 & 
ZIP_INT_IMM_MASK
)-1;

408 
	`ASSERT
(
NULL
);

410  
»t
;

411 
	}
}

414 
	$zEÁry
(*
p
, 
zËÁry
 *
e
) {

416 
	`ZIP_DECODE_PREVLEN
(
p
, 
e
->
´ev¿wËnsize
,ƒ->
´ev¿wËn
);

417 
	`ZIP_DECODE_LENGTH
(
p
 + 
e
->
´ev¿wËnsize
,ƒ->
’codšg
,ƒ->
Ënsize
,ƒ->
Ën
);

418 
e
->
h—d”size
 =ƒ->
´ev¿wËnsize
 +ƒ->
Ënsize
;

419 
e
->
p
 =…;

420 
	}
}

423 *
	$zli¡New
() {

424 
by‹s
 = 
ZIPLIST_HEADER_SIZE
+1;

425 *
zl
 = 
	`d®loc
(
by‹s
);

426 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
by‹s
);

427 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
ZIPLIST_HEADER_SIZE
);

428 
	`ZIPLIST_LENGTH
(
zl
) = 0;

429 
zl
[
by‹s
-1] = 
ZIP_END
;

430  
zl
;

431 
	}
}

434 *
	$zli¡Resize
(*
zl
, 
Ën
) {

435 
zl
 = 
	`d»®loc
(zl,
Ën
);

436 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
Ën
);

437 
zl
[
Ën
-1] = 
ZIP_END
;

438  
zl
;

439 
	}
}

461 *
	$__zli¡CasÿdeUpd©e
(*
zl
, *
p
) {

462 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
¿wËn
, 
¿wËnsize
;

463 
size_t
 
off£t
, 
noff£t
, 
exŒa
;

464 *
Å
;

465 
zËÁry
 
cur
, 
Ãxt
;

467 
p
[0] !ğ
ZIP_END
) {

468 
	`zEÁry
(
p
, &
cur
);

469 
¿wËn
 = 
cur
.
h—d”size
 + cur.
Ën
;

470 
¿wËnsize
 = 
	`zP»vEncodeL’gth
(
NULL
,
¿wËn
);

473 ià(
p
[
¿wËn
] =ğ
ZIP_END
) ;

474 
	`zEÁry
(
p
+
¿wËn
, &
Ãxt
);

477 ià(
Ãxt
.
´ev¿wËn
 =ğ
¿wËn
) ;

479 ià(
Ãxt
.
´ev¿wËnsize
 < 
¿wËnsize
) {

482 
off£t
 = 
p
-
zl
;

483 
exŒa
 = 
¿wËnsize
-
Ãxt
.
´ev¿wËnsize
;

484 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
exŒa
);

485 
p
 = 
zl
+
off£t
;

488 
Å
 = 
p
+
¿wËn
;

489 
noff£t
 = 
Å
-
zl
;

492 ià((
zl
+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl))è!ğ
Å
) {

493 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

494 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
exŒa
);

498 
	`memmove
(
Å
+
¿wËnsize
,

499 
Å
+
Ãxt
.
´ev¿wËnsize
,

500 
cu¾’
-
noff£t
-
Ãxt
.
´ev¿wËnsize
-1);

501 
	`zP»vEncodeL’gth
(
Å
,
¿wËn
);

504 
p
 +ğ
¿wËn
;

505 
cu¾’
 +ğ
exŒa
;

507 ià(
Ãxt
.
´ev¿wËnsize
 > 
¿wËnsize
) {

510 
	`zP»vEncodeL’gthFÜûL¬ge
(
p
+
¿wËn
,rawlen);

512 
	`zP»vEncodeL’gth
(
p
+
¿wËn
,rawlen);

519  
zl
;

520 
	}
}

523 *
	$__zli¡D–‘e
(*
zl
, *
p
, 
num
) {

524 
i
, 
tÙËn
, 
d–‘ed
 = 0;

525 
size_t
 
off£t
;

526 
Ãxtdiff
 = 0;

527 
zËÁry
 
fœ¡
, 

;

529 
	`zEÁry
(
p
, &
fœ¡
);

530 
i
 = 0; 
p
[0] !ğ
ZIP_END
 && i < 
num
; i++) {

531 
p
 +ğ
	`zRawEÁryL’gth
(p);

532 
d–‘ed
++;

535 
tÙËn
 = 
p
-
fœ¡
.p;

536 ià(
tÙËn
 > 0) {

537 ià(
p
[0] !ğ
ZIP_END
) {

542 
Ãxtdiff
 = 
	`zP»vL’By‹Diff
(
p
,
fœ¡
.
´ev¿wËn
);

543 
p
 -ğ
Ãxtdiff
;

544 
	`zP»vEncodeL’gth
(
p
,
fœ¡
.
´ev¿wËn
);

547 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

548 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))-
tÙËn
);

553 
	`zEÁry
(
p
, &

);

554 ià(
p
[

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

555 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

556 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

560 
	`memmove
(
fœ¡
.
p
,p,

561 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
))-(
p
-zl)-1);

564 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

565 
	`šŒev32ifbe
((
fœ¡
.
p
-
zl
)-fœ¡.
´ev¿wËn
);

569 
off£t
 = 
fœ¡
.
p
-
zl
;

570 
zl
 = 
	`zli¡Resize
(zl, 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-
tÙËn
+
Ãxtdiff
);

571 
	`ZIPLIST_INCR_LENGTH
(
zl
,-
d–‘ed
);

572 
p
 = 
zl
+
off£t
;

576 ià(
Ãxtdiff
 != 0)

577 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
);

579  
zl
;

580 
	}
}

583 *
	$__zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

584 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
»qËn
;

585 
´evËnsize
, 
´evËn
 = 0;

586 
size_t
 
off£t
;

587 
Ãxtdiff
 = 0;

588 
’codšg
 = 0;

589 
v®ue
 = 123456789;

592 
zËÁry
 

;

595 ià(
p
[0] !ğ
ZIP_END
) {

596 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

598 *
±a
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

599 ià(
±a
[0] !ğ
ZIP_END
) {

600 
´evËn
 = 
	`zRawEÁryL’gth
(
±a
);

605 ià(
	`zTryEncodšg
(
s
,
¦’
,&
v®ue
,&
’codšg
)) {

607 
»qËn
 = 
	`zIÁSize
(
’codšg
);

611 
»qËn
 = 
¦’
;

615 
»qËn
 +ğ
	`zP»vEncodeL’gth
(
NULL
,
´evËn
);

616 
»qËn
 +ğ
	`zEncodeL’gth
(
NULL
,
’codšg
,
¦’
);

621 
Ãxtdiff
 = (
p
[0] !ğ
ZIP_END
è? 
	`zP»vL’By‹Diff
Õ,
»qËn
) : 0;

624 
off£t
 = 
p
-
zl
;

625 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
»qËn
+
Ãxtdiff
);

626 
p
 = 
zl
+
off£t
;

629 ià(
p
[0] !ğ
ZIP_END
) {

631 
	`memmove
(
p
+
»qËn
,p-
Ãxtdiff
,
cu¾’
-
off£t
-1+nextdiff);

634 
	`zP»vEncodeL’gth
(
p
+
»qËn
,reqlen);

637 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

638 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
»qËn
);

643 
	`zEÁry
(
p
+
»qËn
, &

);

644 ià(
p
[
»qËn
+

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

645 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

646 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

650 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
p
-zl);

655 ià(
Ãxtdiff
 != 0) {

656 
off£t
 = 
p
-
zl
;

657 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
+
»qËn
);

658 
p
 = 
zl
+
off£t
;

662 
p
 +ğ
	`zP»vEncodeL’gth
Õ,
´evËn
);

663 
p
 +ğ
	`zEncodeL’gth
Õ,
’codšg
,
¦’
);

664 ià(
	`ZIP_IS_STR
(
’codšg
)) {

665 
	`memıy
(
p
,
s
,
¦’
);

667 
	`zSaveIÁeg”
(
p
,
v®ue
,
’codšg
);

669 
	`ZIPLIST_INCR_LENGTH
(
zl
,1);

670  
zl
;

671 
	}
}

688 *
	$zli¡M”ge
(**
fœ¡
, **
£cÚd
) {

690 ià(
fœ¡
 =ğ
NULL
 || *fœ¡ =ğNULL || 
£cÚd
 == NULL || *second == NULL)

691  
NULL
;

694 ià(*
fœ¡
 =ğ*
£cÚd
)

695  
NULL
;

697 
size_t
 
fœ¡_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
fœ¡
));

698 
size_t
 
fœ¡_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
fœ¡
));

700 
size_t
 
£cÚd_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
£cÚd
));

701 
size_t
 
£cÚd_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
£cÚd
));

703 
­³nd
;

704 *
sourû
, *
rg‘
;

705 
size_t
 
rg‘_by‹s
, 
sourû_by‹s
;

709 ià(
fœ¡_Ën
 >ğ
£cÚd_Ën
) {

711 
rg‘
 = *
fœ¡
;

712 
rg‘_by‹s
 = 
fœ¡_by‹s
;

713 
sourû
 = *
£cÚd
;

714 
sourû_by‹s
 = 
£cÚd_by‹s
;

715 
­³nd
 = 1;

718 
rg‘
 = *
£cÚd
;

719 
rg‘_by‹s
 = 
£cÚd_by‹s
;

720 
sourû
 = *
fœ¡
;

721 
sourû_by‹s
 = 
fœ¡_by‹s
;

722 
­³nd
 = 0;

726 
size_t
 
zlby‹s
 = 
fœ¡_by‹s
 + 
£cÚd_by‹s
 -

727 
ZIPLIST_HEADER_SIZE
 - 
ZIPLIST_END_SIZE
;

728 
size_t
 
zÎ’gth
 = 
fœ¡_Ën
 + 
£cÚd_Ën
;

731 
zÎ’gth
 = zÎ’gth < 
UINT16_MAX
 ? zllength : UINT16_MAX;

734 
size_t
 
fœ¡_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
fœ¡
));

735 
size_t
 
£cÚd_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
£cÚd
));

738 
rg‘
 = 
	`d»®loc
Ñ¬g‘, 
zlby‹s
);

739 ià(
­³nd
) {

743 
	`memıy
(
rg‘
 + 
rg‘_by‹s
 - 
ZIPLIST_END_SIZE
,

744 
sourû
 + 
ZIPLIST_HEADER_SIZE
,

745 
sourû_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

751 
	`memmove
(
rg‘
 + 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
,

752 
rg‘
 + 
ZIPLIST_HEADER_SIZE
,

753 
rg‘_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

754 
	`memıy
(
rg‘
, 
sourû
, 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
);

758 
	`ZIPLIST_BYTES
(
rg‘
èğ
	`šŒev32ifbe
(
zlby‹s
);

759 
	`ZIPLIST_LENGTH
(
rg‘
èğ
	`šŒev16ifbe
(
zÎ’gth
);

765 
	`ZIPLIST_TAIL_OFFSET
(
rg‘
èğ
	`šŒev32ifbe
(

766 (
fœ¡_by‹s
 - 
ZIPLIST_END_SIZE
) +

767 (
£cÚd_off£t
 - 
ZIPLIST_HEADER_SIZE
));

773 
rg‘
 = 
	`__zli¡CasÿdeUpd©e
Ñ¬g‘,¬g‘+
fœ¡_off£t
);

776 ià(
­³nd
) {

777 
	`dä“
(*
£cÚd
);

778 *
£cÚd
 = 
NULL
;

779 *
fœ¡
 = 
rg‘
;

781 
	`dä“
(*
fœ¡
);

782 *
fœ¡
 = 
NULL
;

783 *
£cÚd
 = 
rg‘
;

785  
rg‘
;

786 
	}
}

788 *
	$zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
) {

789 *
p
;

790 
p
 = (
wh”e
 =ğ
ZIPLIST_HEAD
è? 
	`ZIPLIST_ENTRY_HEAD
(
zl
è: 
	`ZIPLIST_ENTRY_END
(zl);

791  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

792 
	}
}

797 *
	$zli¡Index
(*
zl
, 
šdex
) {

798 *
p
;

799 
´evËnsize
, 
´evËn
 = 0;

800 ià(
šdex
 < 0) {

801 
šdex
 = (-index)-1;

802 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

803 ià(
p
[0] !ğ
ZIP_END
) {

804 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

805 
´evËn
 > 0 && 
šdex
--) {

806 
p
 -ğ
´evËn
;

807 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

811 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

812 
p
[0] !ğ
ZIP_END
 && 
šdex
--) {

813 
p
 +ğ
	`zRawEÁryL’gth
(p);

816  (
p
[0] =ğ
ZIP_END
 || 
šdex
 > 0è? 
NULL
 :…;

817 
	}
}

825 *
	$zli¡Next
(*
zl
, *
p
) {

826 ((è
zl
);

831 ià(
p
[0] =ğ
ZIP_END
) {

832  
NULL
;

835 
p
 +ğ
	`zRawEÁryL’gth
(p);

836 ià(
p
[0] =ğ
ZIP_END
) {

837  
NULL
;

840  
p
;

841 
	}
}

844 *
	$zli¡P»v
(*
zl
, *
p
) {

845 
´evËnsize
, 
´evËn
 = 0;

850 ià(
p
[0] =ğ
ZIP_END
) {

851 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

852  (
p
[0] =ğ
ZIP_END
è? 
NULL
 :…;

853 } ià(
p
 =ğ
	`ZIPLIST_ENTRY_HEAD
(
zl
)) {

854  
NULL
;

856 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

857 
	`ASSERT
(
´evËn
 > 0);

858  
p
-
´evËn
;

860 
	}
}

866 
	$zli¡G‘
(*
p
, **
s¡r
, *
¦’
, *
sv®
) {

867 
zËÁry
 
’Œy
;

868 ià(
p
 =ğ
NULL
 ||…[0] =ğ
ZIP_END
)  0;

869 ià(
s¡r
è*s¡¸ğ
NULL
;

871 
	`zEÁry
(
p
, &
’Œy
);

872 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

873 ià(
s¡r
) {

874 *
¦’
 = 
’Œy
.
Ën
;

875 *
s¡r
 = 
p
+
’Œy
.
h—d”size
;

878 ià(
sv®
) {

879 *
sv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

883 
	}
}

886 *
	$zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

887  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

888 
	}
}

893 *
	$zli¡D–‘e
(*
zl
, **
p
) {

894 
size_t
 
off£t
 = *
p
-
zl
;

895 
zl
 = 
	`__zli¡D–‘e
(zl,*
p
,1);

901 *
p
 = 
zl
+
off£t
;

902  
zl
;

903 
	}
}

906 *
	$zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
) {

907 *
p
 = 
	`zli¡Index
(
zl
,
šdex
);

908  (
p
 =ğ
NULL
è? 
zl
 : 
	`__zli¡D–‘e
(zl,p,
num
);

909 
	}
}

913 
	$zli¡Com·»
(*
p
, *
s¡r
, 
¦’
) {

914 
zËÁry
 
’Œy
;

915 
£ncodšg
;

916 
zv®
, 
sv®
;

917 ià(
p
[0] =ğ
ZIP_END
)  0;

919 
	`zEÁry
(
p
, &
’Œy
);

920 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

922 ià(
’Œy
.
Ën
 =ğ
¦’
) {

923  
	`memcmp
(
p
+
’Œy
.
h—d”size
,
s¡r
,
¦’
) == 0;

930 ià(
	`zTryEncodšg
(
s¡r
,
¦’
,&
sv®
,&
£ncodšg
)) {

931 
zv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

932  
zv®
 =ğ
sv®
;

936 
	}
}

940 *
	$zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
) {

941 
skút
 = 0;

942 
v’codšg
 = 0;

943 
vÎ
 = 0;

945 
p
[0] !ğ
ZIP_END
) {

946 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

947 *
q
;

949 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

950 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

951 
q
 = 
p
 + 
´evËnsize
 + 
Ënsize
;

953 ià(
skút
 == 0) {

955 ià(
	`ZIP_IS_STR
(
’codšg
)) {

956 ià(
Ën
 =ğ
vËn
 && 
	`memcmp
(
q
, 
v¡r
, vlen) == 0) {

957  
p
;

963 ià(
v’codšg
 == 0) {

964 ià(!
	`zTryEncodšg
(
v¡r
, 
vËn
, &
vÎ
, &
v’codšg
)) {

968 
v’codšg
 = 
UCHAR_MAX
;

971 
	`ASSERT
(
v’codšg
);

977 ià(
v’codšg
 !ğ
UCHAR_MAX
) {

978 
Î
 = 
	`zLßdIÁeg”
(
q
, 
’codšg
);

979 ià(
Î
 =ğ
vÎ
) {

980  
p
;

986 
skút
 = 
sk
;

989 
skút
--;

993 
p
 = 
q
 + 
Ën
;

996  
NULL
;

997 
	}
}

1000 
	$zli¡L’
(*
zl
) {

1001 
Ën
 = 0;

1002 ià(
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)è< 
UINT16_MAX
) {

1003 
Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
));

1005 *
p
 = 
zl
+
ZIPLIST_HEADER_SIZE
;

1006 *
p
 !ğ
ZIP_END
) {

1007 
p
 +ğ
	`zRawEÁryL’gth
(p);

1008 
Ën
++;

1012 ià(
Ën
 < 
UINT16_MAX
è
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(len);

1014  
Ën
;

1015 
	}
}

1018 
size_t
 
	$zli¡BlobL’
(*
zl
) {

1019  
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
));

1020 
	}
}

1022 
	$zli¡R•r
(*
zl
) {

1023 *
p
;

1024 
šdex
 = 0;

1025 
zËÁry
 
’Œy
;

1027 
	`´štf
(

1031 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),

1032 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)),

1033 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(
zl
)));

1034 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

1035 *
p
 !ğ
ZIP_END
) {

1036 
	`zEÁry
(
p
, &
’Œy
);

1037 
	`´štf
(

1048 ()
p
,

1049 
šdex
,

1050 (è(
p
-
zl
),

1051 
’Œy
.
h—d”size
+’Œy.
Ën
,

1052 
’Œy
.
h—d”size
,

1053 
’Œy
.
´ev¿wËn
,

1054 
’Œy
.
´ev¿wËnsize
,

1055 
’Œy
.
Ën
);

1056 
p
 +ğ
’Œy
.
h—d”size
;

1057 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1058 ià(
’Œy
.
Ën
 > 40) {

1059 ià(
	`fwr™e
(
p
,40,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1060 
	`´štf
("...");

1062 ià(
’Œy
.
Ën
 &&

1063 
	`fwr™e
(
p
,
’Œy
.
Ën
,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1066 
	`´štf
("%Îd", (è
	`zLßdIÁeg”
(
p
,
’Œy
.
’codšg
));

1068 
	`´štf
("\n");

1069 
p
 +ğ
’Œy
.
Ën
;

1070 
šdex
++;

1072 
	`´štf
("{end}\n\n");

1073 
	}
}

1075 #ifdeà
REDIS_TEST


1076 
	~<sys/time.h
>

1077 
	~"adli¡.h
"

1078 
	~"sds.h
"

1080 
	#debug
(
f
, ...è{ ià(
DEBUG
è
	`´štf
(f, 
__VA_ARGS__
); }

	)

1082 *
	$ü—‹Li¡
() {

1083 *
zl
 = 
	`zli¡New
();

1084 
zl
 = 
	`zli¡Push
(zl, (*)"foo", 3, 
ZIPLIST_TAIL
);

1085 
zl
 = 
	`zli¡Push
(zl, (*)"quux", 4, 
ZIPLIST_TAIL
);

1086 
zl
 = 
	`zli¡Push
(zl, (*)"h–lo", 5, 
ZIPLIST_HEAD
);

1087 
zl
 = 
	`zli¡Push
(zl, (*)"1024", 4, 
ZIPLIST_TAIL
);

1088  
zl
;

1089 
	}
}

1091 *
	$ü—‹IÁLi¡
() {

1092 *
zl
 = 
	`zli¡New
();

1093 
buf
[32];

1095 
	`¥rštf
(
buf
, "100");

1096 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1097 
	`¥rštf
(
buf
, "128000");

1098 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1099 
	`¥rštf
(
buf
, "-100");

1100 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1101 
	`¥rštf
(
buf
, "4294967296");

1102 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1103 
	`¥rštf
(
buf
, "non integer");

1104 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1105 
	`¥rštf
(
buf
, "much much†onger‚on integer");

1106 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1107  
zl
;

1108 
	}
}

1110 
	$u£c
() {

1111 
timev®
 
tv
;

1112 
	`g‘timeofday
(&
tv
,
NULL
);

1113  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

1114 
	}
}

1116 
	$¡»ss
(
pos
, 
num
, 
maxsize
, 
dnum
) {

1117 
i
,
j
,
k
;

1118 *
zl
;

1119 
pos¡r
[2][5] = { "HEAD", "TAIL" };

1120 
¡¬t
;

1121 
i
 = 0; i < 
maxsize
; i+=
dnum
) {

1122 
zl
 = 
	`zli¡New
();

1123 
j
 = 0; j < 
i
; j++) {

1124 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
ZIPLIST_TAIL
);

1128 
¡¬t
 = 
	`u£c
();

1129 
k
 = 0; k < 
num
; k++) {

1130 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
pos
);

1131 
zl
 = 
	`zli¡D–‘eRªge
(zl,0,1);

1133 
	`´štf
("List size: %8d, bytes: %8d, %dx…ush+pop (%s): %6lld usec\n",

1134 
i
,
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),
num
,
pos¡r
[
pos
],
	`u£c
()-
¡¬t
);

1135 
	`dä“
(
zl
);

1137 
	}
}

1139 *
	$pİ
(*
zl
, 
wh”e
) {

1140 *
p
, *
v¡r
;

1141 
vËn
;

1142 
vlÚg
;

1144 
p
 = 
	`zli¡Index
(
zl
,
wh”e
 =ğ
ZIPLIST_HEAD
 ? 0 : -1);

1145 ià(
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

1146 ià(
wh”e
 =ğ
ZIPLIST_HEAD
)

1147 
	`´štf
("Pop head: ");

1149 
	`´štf
("Popail: ");

1151 ià(
v¡r
) {

1152 ià(
vËn
 && 
	`fwr™e
(
v¡r
,vËn,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1155 
	`´štf
("%Îd", 
vlÚg
);

1158 
	`´štf
("\n");

1159  
	`zli¡D–‘e
(
zl
,&
p
);

1161 
	`´štf
("ERROR: Could‚ot…op\n");

1162 
	`ex™
(1);

1164 
	}
}

1166 
	$¿nd¡ršg
(*
rg‘
, 
mš
, 
max
) {

1167 
p
 = 0;

1168 
Ën
 = 
mš
+
	`¿nd
()%(
max
-min+1);

1169 
mšv®
, 
maxv®
;

1170 
	`¿nd
() % 3) {

1172 
mšv®
 = 0;

1173 
maxv®
 = 255;

1176 
mšv®
 = 48;

1177 
maxv®
 = 122;

1180 
mšv®
 = 48;

1181 
maxv®
 = 52;

1184 
	`ASSERT
(
NULL
);

1187 
p
 < 
Ën
)

1188 
rg‘
[
p
++] = 
mšv®
+
	`¿nd
()%(
maxv®
-minval+1);

1189  
Ën
;

1190 
	}
}

1192 
	$v”ify
(*
zl
, 
zËÁry
 *
e
) {

1193 
Ën
 = 
	`zli¡L’
(
zl
);

1194 
zËÁry
 
_e
;

1196 
	`ZIPLIST_ENTRY_ZERO
(&
_e
);

1198 
i
 = 0; i < 
Ën
; i++) {

1199 
	`mem£t
(&
e
[
i
], 0, (
zËÁry
));

1200 
	`zEÁry
(
	`zli¡Index
(
zl
, 
i
), &
e
[i]);

1202 
	`mem£t
(&
_e
, 0, (
zËÁry
));

1203 
	`zEÁry
(
	`zli¡Index
(
zl
, -
Ën
+
i
), &
_e
);

1205 
	`ASSERT
(
	`memcmp
(&
e
[
i
], &
_e
, (
zËÁry
)) == 0);

1207 
	}
}

1209 
	$zli¡Te¡
(
¬gc
, **
¬gv
) {

1210 
»t
;

1211 *
zl
, *
p
;

1212 *
’Œy
;

1213 
–’
;

1214 
v®ue
;

1217 ià(
¬gc
 == 2)

1218 
	`¤ªd
(
	`©oi
(
¬gv
[1]));

1220 
zl
 = 
	`ü—‹IÁLi¡
();

1221 
	`zli¡R•r
(
zl
);

1223 
	`dä“
(
zl
);

1225 
zl
 = 
	`ü—‹Li¡
();

1226 
	`zli¡R•r
(
zl
);

1228 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1229 
	`zli¡R•r
(
zl
);

1231 
zl
 = 
	`pİ
(zl,
ZIPLIST_HEAD
);

1232 
	`zli¡R•r
(
zl
);

1234 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1235 
	`zli¡R•r
(
zl
);

1237 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1238 
	`zli¡R•r
(
zl
);

1240 
	`dä“
(
zl
);

1242 
	`´štf
("Getƒlement‡t index 3:\n");

1244 
zl
 = 
	`ü—‹Li¡
();

1245 
p
 = 
	`zli¡Index
(
zl
, 3);

1246 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1247 
	`´štf
("ERROR: Could‚ot‡ccess index 3\n");

1250 ià(
’Œy
) {

1251 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1252 
	`´štf
("\n");

1254 
	`´štf
("%Îd\n", 
v®ue
);

1256 
	`´štf
("\n");

1257 
	`dä“
(
zl
);

1260 
	`´štf
("Getƒlement‡t index 4 (out of„ange):\n");

1262 
zl
 = 
	`ü—‹Li¡
();

1263 
p
 = 
	`zli¡Index
(
zl
, 4);

1264 ià(
p
 =ğ
NULL
) {

1265 
	`´štf
("Noƒntry\n");

1267 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1270 
	`´štf
("\n");

1271 
	`dä“
(
zl
);

1274 
	`´štf
("Getƒlement‡t index -1 (lastƒlement):\n");

1276 
zl
 = 
	`ü—‹Li¡
();

1277 
p
 = 
	`zli¡Index
(
zl
, -1);

1278 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1279 
	`´štf
("ERROR: Could‚ot‡ccess index -1\n");

1282 ià(
’Œy
) {

1283 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1284 
	`´štf
("\n");

1286 
	`´štf
("%Îd\n", 
v®ue
);

1288 
	`´štf
("\n");

1289 
	`dä“
(
zl
);

1292 
	`´štf
("Getƒlement‡t index -4 (firstƒlement):\n");

1294 
zl
 = 
	`ü—‹Li¡
();

1295 
p
 = 
	`zli¡Index
(
zl
, -4);

1296 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1297 
	`´štf
("ERROR: Could‚ot‡ccess index -4\n");

1300 ià(
’Œy
) {

1301 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1302 
	`´štf
("\n");

1304 
	`´štf
("%Îd\n", 
v®ue
);

1306 
	`´štf
("\n");

1307 
	`dä“
(
zl
);

1310 
	`´štf
("Getƒlement‡t index -5 (reverse out of„ange):\n");

1312 
zl
 = 
	`ü—‹Li¡
();

1313 
p
 = 
	`zli¡Index
(
zl
, -5);

1314 ià(
p
 =ğ
NULL
) {

1315 
	`´štf
("Noƒntry\n");

1317 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1320 
	`´štf
("\n");

1321 
	`dä“
(
zl
);

1324 
	`´štf
("Iterate†ist from 0oƒnd:\n");

1326 
zl
 = 
	`ü—‹Li¡
();

1327 
p
 = 
	`zli¡Index
(
zl
, 0);

1328 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1329 
	`´štf
("Entry: ");

1330 ià(
’Œy
) {

1331 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1333 
	`´štf
("%Îd", 
v®ue
);

1335 
p
 = 
	`zli¡Next
(
zl
,p);

1336 
	`´štf
("\n");

1338 
	`´štf
("\n");

1339 
	`dä“
(
zl
);

1342 
	`´štf
("Iterate†ist from 1oƒnd:\n");

1344 
zl
 = 
	`ü—‹Li¡
();

1345 
p
 = 
	`zli¡Index
(
zl
, 1);

1346 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1347 
	`´štf
("Entry: ");

1348 ià(
’Œy
) {

1349 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1351 
	`´štf
("%Îd", 
v®ue
);

1353 
p
 = 
	`zli¡Next
(
zl
,p);

1354 
	`´štf
("\n");

1356 
	`´štf
("\n");

1357 
	`dä“
(
zl
);

1360 
	`´štf
("Iterate†ist from 2oƒnd:\n");

1362 
zl
 = 
	`ü—‹Li¡
();

1363 
p
 = 
	`zli¡Index
(
zl
, 2);

1364 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1365 
	`´štf
("Entry: ");

1366 ià(
’Œy
) {

1367 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1369 
	`´štf
("%Îd", 
v®ue
);

1371 
p
 = 
	`zli¡Next
(
zl
,p);

1372 
	`´štf
("\n");

1374 
	`´štf
("\n");

1375 
	`dä“
(
zl
);

1378 
	`´štf
("Iterate starting out of„ange:\n");

1380 
zl
 = 
	`ü—‹Li¡
();

1381 
p
 = 
	`zli¡Index
(
zl
, 4);

1382 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1383 
	`´štf
("Noƒntry\n");

1385 
	`´štf
("ERROR\n");

1387 
	`´štf
("\n");

1388 
	`dä“
(
zl
);

1391 
	`´štf
("Iterate from backo front:\n");

1393 
zl
 = 
	`ü—‹Li¡
();

1394 
p
 = 
	`zli¡Index
(
zl
, -1);

1395 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1396 
	`´štf
("Entry: ");

1397 ià(
’Œy
) {

1398 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1400 
	`´štf
("%Îd", 
v®ue
);

1402 
p
 = 
	`zli¡P»v
(
zl
,p);

1403 
	`´štf
("\n");

1405 
	`´štf
("\n");

1406 
	`dä“
(
zl
);

1409 
	`´štf
("Iterate from backo front, deleting‡ll items:\n");

1411 
zl
 = 
	`ü—‹Li¡
();

1412 
p
 = 
	`zli¡Index
(
zl
, -1);

1413 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1414 
	`´štf
("Entry: ");

1415 ià(
’Œy
) {

1416 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1418 
	`´štf
("%Îd", 
v®ue
);

1420 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1421 
p
 = 
	`zli¡P»v
(
zl
,p);

1422 
	`´štf
("\n");

1424 
	`´štf
("\n");

1425 
	`dä“
(
zl
);

1428 
	`´štf
("Delete inclusive„ange 0,0:\n");

1430 
zl
 = 
	`ü—‹Li¡
();

1431 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 1);

1432 
	`zli¡R•r
(
zl
);

1433 
	`dä“
(
zl
);

1436 
	`´štf
("Delete inclusive„ange 0,1:\n");

1438 
zl
 = 
	`ü—‹Li¡
();

1439 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 2);

1440 
	`zli¡R•r
(
zl
);

1441 
	`dä“
(
zl
);

1444 
	`´štf
("Delete inclusive„ange 1,2:\n");

1446 
zl
 = 
	`ü—‹Li¡
();

1447 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 2);

1448 
	`zli¡R•r
(
zl
);

1449 
	`dä“
(
zl
);

1452 
	`´štf
("Delete with start index out of„ange:\n");

1454 
zl
 = 
	`ü—‹Li¡
();

1455 
zl
 = 
	`zli¡D–‘eRªge
(zl, 5, 1);

1456 
	`zli¡R•r
(
zl
);

1457 
	`dä“
(
zl
);

1460 
	`´štf
("Delete with‚um overflow:\n");

1462 
zl
 = 
	`ü—‹Li¡
();

1463 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 5);

1464 
	`zli¡R•r
(
zl
);

1465 
	`dä“
(
zl
);

1468 
	`´štf
("Delete foo while iterating:\n");

1470 
zl
 = 
	`ü—‹Li¡
();

1471 
p
 = 
	`zli¡Index
(
zl
,0);

1472 
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
)) {

1473 ià(
’Œy
 && 
	`¡ºcmp
("foo",(*ëÁry,
–’
) == 0) {

1474 
	`´štf
("Delete foo\n");

1475 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1477 
	`´štf
("Entry: ");

1478 ià(
’Œy
) {

1479 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
) == 0)

1480 
	`³¼Ü
("fwrite");

1482 
	`´štf
("%Îd",
v®ue
);

1484 
p
 = 
	`zli¡Next
(
zl
,p);

1485 
	`´štf
("\n");

1488 
	`´štf
("\n");

1489 
	`zli¡R•r
(
zl
);

1490 
	`dä“
(
zl
);

1493 
	`´štf
("Regressionest for >255 byte strings:\n");

1495 
v1
[257] = {0}, 
v2
[257] = {0};

1496 
	`mem£t
(
v1
,'x',256);

1497 
	`mem£t
(
v2
,'y',256);

1498 
zl
 = 
	`zli¡New
();

1499 
zl
 = 
	`zli¡Push
(zl,(*)
v1
,
	`¡¾’
(v1),
ZIPLIST_TAIL
);

1500 
zl
 = 
	`zli¡Push
(zl,(*)
v2
,
	`¡¾’
(v2),
ZIPLIST_TAIL
);

1503 
p
 = 
	`zli¡Index
(
zl
,0);

1504 
»t
 = ()
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
);

1505 
	`ASSERT
(
»t
 > 0);

1506 
	`ASSERT
(
	`¡ºcmp
(
v1
,(*)
’Œy
,
–’
) == 0);

1507 
p
 = 
	`zli¡Index
(
zl
,1);

1508 
»t
 = ()
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
);

1509 
	`ASSERT
(
»t
 > 0);

1510 
	`ASSERT
(
	`¡ºcmp
(
v2
,(*)
’Œy
,
–’
) == 0);

1511 
	`´štf
("SUCCESS\n\n");

1512 
	`dä“
(
zl
);

1515 
	`´štf
("Regressionest deleting‚exto†astƒntries:\n");

1517 
v
[3][257] = {{0}};

1518 
zËÁry
 
e
[3] = {{.
´ev¿wËnsize
 = 0, .
´ev¿wËn
 = 0, .
Ënsize
 = 0,

1519 .
Ën
 = 0, .
h—d”size
 = 0, .
’codšg
 = 0, .
p
 = 
NULL
}};

1520 
size_t
 
i
;

1522 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1523 
	`mem£t
(
v
[
i
], 'a' + i, (v[0]));

1526 
v
[0][256] = '\0';

1527 
v
[1][ 1] = '\0';

1528 
v
[2][256] = '\0';

1530 
zl
 = 
	`zli¡New
();

1531 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1532 
zl
 = 
	`zli¡Push
(zl, (*è
v
[
i
], 
	`¡¾’
(v[i]), 
ZIPLIST_TAIL
);

1535 
	`v”ify
(
zl
, 
e
);

1537 
	`ASSERT
(
e
[0].
´ev¿wËnsize
 == 1);

1538 
	`ASSERT
(
e
[1].
´ev¿wËnsize
 == 5);

1539 
	`ASSERT
(
e
[2].
´ev¿wËnsize
 == 1);

1542 *
p
 = 
e
[1].p;

1543 
zl
 = 
	`zli¡D–‘e
(zl, &
p
);

1545 
	`v”ify
(
zl
, 
e
);

1547 
	`ASSERT
(
e
[0].
´ev¿wËnsize
 == 1);

1548 
	`ASSERT
(
e
[1].
´ev¿wËnsize
 == 5);

1550 
	`´štf
("SUCCESS\n\n");

1551 
	`dä“
(
zl
);

1554 
	`´štf
("Create†ong†ist‡nd check indices:\n");

1556 
zl
 = 
	`zli¡New
();

1557 
buf
[32];

1558 
i
,
Ën
;

1559 
i
 = 0; i < 1000; i++) {

1560 
Ën
 = 
	`¥rštf
(
buf
,"%d",
i
);

1561 
zl
 = 
	`zli¡Push
(zl,(*)
buf
,
Ën
,
ZIPLIST_TAIL
);

1563 
i
 = 0; i < 1000; i++) {

1564 
p
 = 
	`zli¡Index
(
zl
,
i
);

1565 
»t
 = ()
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
);

1566 
	`ASSERT
(
»t
 > 0);

1567 
	`ASSERT
(
i
 =ğ
v®ue
);

1569 
p
 = 
	`zli¡Index
(
zl
,-
i
-1);

1570 
»t
 = ()
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
);

1571 
	`ASSERT
(
»t
 > 0);

1572 
	`ASSERT
(999-
i
 =ğ
v®ue
);

1574 
	`´štf
("SUCCESS\n\n");

1575 
	`dä“
(
zl
);

1578 
	`´štf
("Compare strings with ziplistƒntries:\n");

1580 
zl
 = 
	`ü—‹Li¡
();

1581 
p
 = 
	`zli¡Index
(
zl
,0);

1582 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1583 
	`´štf
("ERROR:‚ot \"hello\"\n");

1586 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1587 
	`´štf
("ERROR: \"hella\"\n");

1591 
p
 = 
	`zli¡Index
(
zl
,3);

1592 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1593 
	`´štf
("ERROR:‚ot \"1024\"\n");

1596 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1597 
	`´štf
("ERROR: \"1025\"\n");

1600 
	`´štf
("SUCCESS\n\n");

1601 
	`dä“
(
zl
);

1604 
	`´štf
("Mergeest:\n");

1607 
zl
 = 
	`ü—‹Li¡
();

1608 *
zl2
 = 
	`ü—‹Li¡
();

1610 *
zl3
 = 
	`zli¡New
();

1611 *
zl4
 = 
	`zli¡New
();

1613 ià(
	`zli¡M”ge
(&
zl4
, &zl4)) {

1614 
	`´štf
("ERROR: Allowed merging of one ziplist into itself.\n");

1619 
zl4
 = 
	`zli¡M”ge
(&
zl3
, &zl4);

1620 
	`zli¡R•r
(
zl4
);

1621 ià(
	`zli¡L’
(
zl4
)) {

1622 
	`´štf
("ERROR: Mergingwoƒmpty ziplists createdƒntries.\n");

1625 
	`dä“
(
zl4
);

1627 
zl2
 = 
	`zli¡M”ge
(&
zl
, &zl2);

1629 
	`zli¡R•r
(
zl2
);

1631 ià(
	`zli¡L’
(
zl2
) != 8) {

1632 
	`´štf
("ERROR: M”ged†’gth‚Ù 8, but: %u\n", 
	`zli¡L’
(
zl2
));

1636 
p
 = 
	`zli¡Index
(
zl2
,0);

1637 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1638 
	`´štf
("ERROR:‚ot \"hello\"\n");

1641 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1642 
	`´štf
("ERROR: \"hella\"\n");

1646 
p
 = 
	`zli¡Index
(
zl2
,3);

1647 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1648 
	`´štf
("ERROR:‚ot \"1024\"\n");

1651 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1652 
	`´štf
("ERROR: \"1025\"\n");

1656 
p
 = 
	`zli¡Index
(
zl2
,4);

1657 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1658 
	`´štf
("ERROR:‚ot \"hello\"\n");

1661 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1662 
	`´štf
("ERROR: \"hella\"\n");

1666 
p
 = 
	`zli¡Index
(
zl2
,7);

1667 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1668 
	`´štf
("ERROR:‚ot \"1024\"\n");

1671 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1672 
	`´štf
("ERROR: \"1025\"\n");

1675 
	`´štf
("SUCCESS\n\n");

1676 
	`dä“
(
zl
);

1679 
	`´štf
("Stress with„andom…ayloads of differentƒncoding:\n");

1681 
i
,
j
,
Ën
,
wh”e
;

1682 *
p
;

1683 
buf
[1024];

1684 
buæ’
;

1685 
dli¡
 *
»f
;

1686 
dli¡Node
 *
»âode
;

1689 *
s¡r
;

1690 
¦’
;

1691 
sv®
;

1693 
i
 = 0; i < 20000; i++) {

1694 
zl
 = 
	`zli¡New
();

1695 
»f
 = 
	`dli¡C»©e
();

1696 
	`dli¡S‘F»eM‘hod
(
»f
,((*)(*))
sdsä“
);

1697 
Ën
 = 
	`¿nd
() % 256;

1700 
j
 = 0; j < 
Ën
; j++) {

1701 
wh”e
 = (
	`¿nd
(è& 1è? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
;

1702 ià(
	`¿nd
() % 2) {

1703 
buæ’
 = 
	`¿nd¡ršg
(
buf
,1,(buf)-1);

1705 
	`¿nd
() % 3) {

1707 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) >> 20);

1710 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()));

1713 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) << 20);

1716 
	`ASSERT
(
NULL
);

1721 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
buæ’
, 
wh”e
);

1724 ià(
wh”e
 =ğ
ZIPLIST_HEAD
) {

1725 
	`dli¡AddNodeH—d
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1726 } ià(
wh”e
 =ğ
ZIPLIST_TAIL
) {

1727 
	`dli¡AddNodeTa
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1729 
	`ASSERT
(
NULL
);

1733 
	`ASSERT
(
	`dli¡L’gth
(
»f
è=ğ
	`zli¡L’
(
zl
));

1734 
j
 = 0; j < 
Ën
; j++) {

1737 
p
 = 
	`zli¡Index
(
zl
,
j
);

1738 
»âode
 = 
	`dli¡Index
(
»f
,
j
);

1740 
»t
 = ()
	`zli¡G‘
(
p
,&
s¡r
,&
¦’
,&
sv®
);

1741 
	`ASSERT
(
»t
 > 0);

1742 ià(
s¡r
 =ğ
NULL
) {

1743 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",
sv®
);

1745 
buæ’
 = 
¦’
;

1746 
	`memıy
(
buf
,
s¡r
,
buæ’
);

1747 
buf
[
buæ’
] = '\0';

1749 
	`ASSERT
(
	`memcmp
(
buf
,
	`dli¡NodeV®ue
(
»âode
),
buæ’
) == 0);

1751 
	`dä“
(
zl
);

1752 
	`dli¡R–—£
(
»f
);

1754 
	`´štf
("SUCCESS\n\n");

1757 
	`´štf
("Stress with variable ziplist size:\n");

1759 
	`¡»ss
(
ZIPLIST_HEAD
,100000,16384,256);

1760 
	`¡»ss
(
ZIPLIST_TAIL
,100000,16384,256);

1764 
	}
}

	@src/vr_ziplist.h

1 #iâdeà
_ZIPLIST_H


2 
	#_ZIPLIST_H


	)

4 
	#ZIPLIST_HEAD
 0

	)

5 
	#ZIPLIST_TAIL
 1

	)

7 *
zli¡New
();

8 *
zli¡M”ge
(**
fœ¡
, **
£cÚd
);

9 *
zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
);

10 *
zli¡Index
(*
zl
, 
šdex
);

11 *
zli¡Next
(*
zl
, *
p
);

12 *
zli¡P»v
(*
zl
, *
p
);

13 
zli¡G‘
(*
p
, **
sv®
, *
¦’
, *
lv®
);

14 *
zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
);

15 *
zli¡D–‘e
(*
zl
, **
p
);

16 *
zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
);

17 
zli¡Com·»
(*
p
, *
s
, 
¦’
);

18 *
zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
);

19 
zli¡L’
(*
zl
);

20 
size_t
 
zli¡BlobL’
(*
zl
);

22 #ifdeà
REDIS_TEST


23 
zli¡Te¡
(
¬gc
, *
¬gv
[]);

	@src/vr_zipmap.c

78 
	~<¡dio.h
>

79 
	~<¡ršg.h
>

81 
	~<vr_cÜe.h
>

83 
	#ZIPMAP_BIGLEN
 254

	)

84 
	#ZIPMAP_END
 255

	)

88 
	#ZIPMAP_VALUE_MAX_FREE
 4

	)

93 
	#ZIPMAP_LEN_BYTES
(
_l
è(((_lè< 
ZIPMAP_BIGLEN
è? 1 : ()+1)

	)

96 *
	$zm­New
() {

97 *
zm
 = 
	`d®loc
(2);

99 
zm
[0] = 0;

100 
zm
[1] = 
ZIPMAP_END
;

101  
zm
;

102 
	}
}

105 
	$zm­DecodeL’gth
(*
p
) {

106 
Ën
 = *
p
;

108 ià(
Ën
 < 
ZIPMAP_BIGLEN
) †en;

109 
	`memıy
(&
Ën
,
p
+1,());

110 
	`mem»v32ifbe
(&
Ën
);

111  
Ën
;

112 
	}
}

116 
	$zm­EncodeL’gth
(*
p
, 
Ën
) {

117 ià(
p
 =ğ
NULL
) {

118  
	`ZIPMAP_LEN_BYTES
(
Ën
);

120 ià(
Ën
 < 
ZIPMAP_BIGLEN
) {

121 
p
[0] = 
Ën
;

124 
p
[0] = 
ZIPMAP_BIGLEN
;

125 
	`memıy
(
p
+1,&
Ën
,(len));

126 
	`mem»v32ifbe
(
p
+1);

127  1+(
Ën
);

130 
	}
}

138 *
	$zm­LookupRaw
(*
zm
, *
key
, 
kËn
, *
tÙËn
) {

139 *
p
 = 
zm
+1, *
k
 = 
NULL
;

140 
l
,
Î’
;

142 *
p
 !ğ
ZIPMAP_END
) {

143 
ä“
;

146 
l
 = 
	`zm­DecodeL’gth
(
p
);

147 
Î’
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

148 ià(
key
 !ğ
NULL
 && 
k
 =ğNULL && 
l
 =ğ
kËn
 && !
	`memcmp
(
p
+
Î’
,key,l)) {

151 ià(
tÙËn
 !ğ
NULL
) {

152 
k
 = 
p
;

154  
p
;

157 
p
 +ğ
Î’
+
l
;

159 
l
 = 
	`zm­DecodeL’gth
(
p
);

160 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

161 
ä“
 = 
p
[0];

162 
p
 +ğ
l
+1+
ä“
;

164 ià(
tÙËn
 !ğ
NULL
è*tÙËÀğ()(
p
-
zm
)+1;

165  
k
;

166 
	}
}

168 
	$zm­RequœedL’gth
(
kËn
, 
vËn
) {

169 
l
;

171 
l
 = 
kËn
+
vËn
+3;

172 ià(
kËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

173 ià(
vËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

174  
l
;

175 
	}
}

178 
	$zm­RawKeyL’gth
(*
p
) {

179 
l
 = 
	`zm­DecodeL’gth
(
p
);

180  
	`zm­EncodeL’gth
(
NULL
,
l
) +†;

181 
	}
}

185 
	$zm­RawV®ueL’gth
(*
p
) {

186 
l
 = 
	`zm­DecodeL’gth
(
p
);

187 
u£d
;

189 
u£d
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

190 
u£d
 +ğ
p
[u£d] + 1 + 
l
;

191  
u£d
;

192 
	}
}

197 
	$zm­RawEÁryL’gth
(*
p
) {

198 
l
 = 
	`zm­RawKeyL’gth
(
p
);

199  
l
 + 
	`zm­RawV®ueL’gth
(
p
+l);

200 
	}
}

202 
šlše
 *
	$zm­Resize
(*
zm
, 
Ën
) {

203 
zm
 = 
	`d»®loc
(zm, 
Ën
);

204 
zm
[
Ën
-1] = 
ZIPMAP_END
;

205  
zm
;

206 
	}
}

211 *
	$zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
) {

212 
zmËn
, 
off£t
;

213 
ä“Ën
, 
»qËn
 = 
	`zm­RequœedL’gth
(
kËn
,
vËn
);

214 
em±y
, 
vem±y
;

215 *
p
;

217 
ä“Ën
 = 
»qËn
;

218 ià(
upd©e
) *update = 0;

219 
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

220 ià(
p
 =ğ
NULL
) {

222 
zm
 = 
	`zm­Resize
(zm, 
zmËn
+
»qËn
);

223 
p
 = 
zm
+
zmËn
-1;

224 
zmËn
 = zmËn+
»qËn
;

227 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]++;

231 ià(
upd©e
) *update = 1;

232 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

233 ià(
ä“Ën
 < 
»qËn
) {

237 
off£t
 = 
p
-
zm
;

238 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
+
»qËn
);

239 
p
 = 
zm
+
off£t
;

243 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

244 
zmËn
 = zmËn-
ä“Ën
+
»qËn
;

245 
ä“Ën
 = 
»qËn
;

253 
em±y
 = 
ä“Ën
-
»qËn
;

254 ià(
em±y
 >ğ
ZIPMAP_VALUE_MAX_FREE
) {

257 
off£t
 = 
p
-
zm
;

258 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

259 
zmËn
 -ğ
em±y
;

260 
zm
 = 
	`zm­Resize
(zm, 
zmËn
);

261 
p
 = 
zm
+
off£t
;

262 
vem±y
 = 0;

264 
vem±y
 = 
em±y
;

269 
p
 +ğ
	`zm­EncodeL’gth
Õ,
kËn
);

270 
	`memıy
(
p
,
key
,
kËn
);

271 
p
 +ğ
kËn
;

273 
p
 +ğ
	`zm­EncodeL’gth
Õ,
vËn
);

274 *
p
++ = 
vem±y
;

275 
	`memıy
(
p
,
v®
,
vËn
);

276  
zm
;

277 
	}
}

281 *
	$zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
) {

282 
zmËn
, 
ä“Ën
;

283 *
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

284 ià(
p
) {

285 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

286 
	`memmove
(
p
,…+
ä“Ën
, 
zmËn
-(Õ-
zm
)+freelen+1));

287 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
);

290 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]--;

292 ià(
d–‘ed
) *deleted = 1;

294 ià(
d–‘ed
) *deleted = 0;

296  
zm
;

297 
	}
}

300 *
	$zm­Rewšd
(*
zm
) {

301  
zm
+1;

302 
	}
}

315 *
	$zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
) {

316 ià(
zm
[0] =ğ
ZIPMAP_END
è 
NULL
;

317 ià(
key
) {

318 *
key
 = 
zm
;

319 *
kËn
 = 
	`zm­DecodeL’gth
(
zm
);

320 *
key
 +ğ
	`ZIPMAP_LEN_BYTES
(*
kËn
);

322 
zm
 +ğ
	`zm­RawKeyL’gth
(zm);

323 ià(
v®ue
) {

324 *
v®ue
 = 
zm
+1;

325 *
vËn
 = 
	`zm­DecodeL’gth
(
zm
);

326 *
v®ue
 +ğ
	`ZIPMAP_LEN_BYTES
(*
vËn
);

328 
zm
 +ğ
	`zm­RawV®ueL’gth
(zm);

329  
zm
;

330 
	}
}

334 
	$zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
) {

335 *
p
;

337 ià((
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
)) == NULL)  0;

338 
p
 +ğ
	`zm­RawKeyL’gth
(p);

339 *
vËn
 = 
	`zm­DecodeL’gth
(
p
);

340 *
v®ue
 = 
p
 + 
	`ZIPMAP_LEN_BYTES
(*
vËn
) + 1;

342 
	}
}

345 
	$zm­Exi¡s
(*
zm
, *
key
, 
kËn
) {

346  
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
) != NULL;

347 
	}
}

350 
	$zm­L’
(*
zm
) {

351 
Ën
 = 0;

352 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) {

353 
Ën
 = 
zm
[0];

355 *
p
 = 
	`zm­Rewšd
(
zm
);

356 (
p
 = 
	`zm­Next
Õ,
NULL
,NULL,NULL,NULL)è!ğNULLè
Ën
++;

359 ià(
Ën
 < 
ZIPMAP_BIGLEN
è
zm
[0] =†en;

361  
Ën
;

362 
	}
}

367 
size_t
 
	$zm­BlobL’
(*
zm
) {

368 
tÙËn
;

369 
	`zm­LookupRaw
(
zm
,
NULL
,0,&
tÙËn
);

370  
tÙËn
;

371 
	}
}

	@src/vr_zipmap.h

1 #iâdeà
_ZIPMAP_H


2 
	#_ZIPMAP_H


	)

4 *
zm­New
();

5 *
zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
);

6 *
zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
);

7 *
zm­Rewšd
(*
zm
);

8 *
zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
);

9 
zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
);

10 
zm­Exi¡s
(*
zm
, *
key
, 
kËn
);

11 
zm­L’
(*
zm
);

12 
size_t
 
zm­BlobL’
(*
zm
);

13 
zm­R•r
(*
p
);

	@tests/vrabtest.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<fú.h
>

5 
	~<”ºo.h
>

6 
	~<sigÇl.h
>

7 
	~<as£¹.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

12 
	~<d¬¿y.h
>

13 
	~<dlog.h
>

15 
	~<v¹_ut.h
>

16 
	~<v¹_public.h
>

17 
	~<v¹_´oduû_d©a.h
>

18 
	~<v¹_di¥©ch_d©a.h
>

19 
	~<v¹_check_d©a.h
>

20 
	~<v¹_back’d.h
>

21 
	~<v¿b‹¡.h
>

23 
	#CONFIG_DEFAULT_PIDFILE
 
NULL


	)

24 
	#CONFIG_DEFAULT_CHECKER
 "my£lf"

	)

25 
	#CONFIG_DEFAULT_TEST_INTERVAL
 3600

	)

26 
	#CONFIG_DEFAULT_KEY_LENGTH_RANGE_BEGIN
 0

	)

27 
	#CONFIG_DEFAULT_KEY_LENGTH_RANGE_END
 100

	)

28 
	#CONFIG_DEFAULT_STRING_MAX_LENGTH
 512

	)

29 
	#CONFIG_DEFAULT_FIELDS_MAX_COUNT
 16

	)

30 
	#CONFIG_DEFAULT_TEST_TARGET
 ""

	)

31 
	#CONFIG_DEFAULT_PRODUCE_THREADS_COUNT
 1

	)

32 
	#CONFIG_DEFAULT_CACHED_KEYS_COUNT
 10000

	)

33 
	#CONFIG_DEFAULT_HIT_RATIO
 75

	)

34 
	#CONFIG_DEFAULT_DISPATCH_THREADS_COUNT
 1

	)

35 
	#CONFIG_DEFAULT_CLIENTS_PER_DISPATCH_THREAD
 10

	)

36 
	#CONFIG_DEFAULT_LOGFILE
 
NULL


	)

38 
	#VRABTEST_GROUP_TYPE_REDIS
 0

	)

39 
	#VRABTEST_GROUP_TYPE_VIRE
 1

	)

41 
	scÚfig
 {

42 *
	mcheck”
;

43 
	m‹¡_š‹rv®
;

44 
	mkey_Ëngth_¿nge_begš
;

45 
	mkey_Ëngth_¿nge_’d
;

46 
	m¡ršg_max_Ëngth
;

47 
	mf›lds_max_couÁ
;

48 
	mcmd_ty³
;

49 
d¬¿y
 *
	mcmd_bÏckli¡
;

50 
d¬¿y
 *
	mcmd_wh™–i¡
;

51 *
	m‹¡_rg‘s
;

52 
	m´oduû_d©a_th»ads
;

53 
	mÿched_keys_³r_´oduû_th»ad
;

54 
	mh™_¿tio
;

55 
	mdi¥©ch_d©a_th»ads
;

56 
	mş›Ás_³r_di¥©ch_th»ad
;

57 *
	mpid_f’ame
;

58 *
	mlog_f’ame
;

61 
cÚfig
 
	gcÚfig
;

63 
	gshow_h–p
;

64 
	gshow_v”siÚ
;

65 
	gd«mÚize
;

70 
	gexpœe_’abËd
;

74 
	g‹¡_š‹rv®
;

78 
	gÏ¡_‹¡_begš_time
;

80 
İtiÚ
 
	glÚg_İtiÚs
[] = {

81 { "h–p", 
no_¬gum’t
, 
NULL
, 'h' },

82 { "v”siÚ", 
no_¬gum’t
, 
NULL
, 'V' },

83 { "d«mÚize", 
no_¬gum’t
, 
NULL
, 'D' },

84 { "’abË-expœe", 
no_¬gum’t
, 
NULL
, 'E' },

85 { "pid-fe", 
»quœed_¬gum’t
, 
NULL
, 'P' },

86 { "check”", 
»quœed_¬gum’t
, 
NULL
, 'C' },

87 { "‹¡-š‹rv®", 
»quœed_¬gum’t
, 
NULL
, 'i' },

88 { "key-Ëngth-¿nge", 
»quœed_¬gum’t
, 
NULL
, 'k' },

89 { "¡ršg-max-Ëngth", 
»quœed_¬gum’t
, 
NULL
, 's' },

90 { "f›lds-max-couÁ", 
»quœed_¬gum’t
, 
NULL
, 'f' },

91 { "commªd-ty³s", 
»quœed_¬gum’t
, 
NULL
, 'T' },

92 { "commªd-bÏck-li¡", 
»quœed_¬gum’t
, 
NULL
, 'B' },

93 { "commªd-wh™e-li¡", 
»quœed_¬gum’t
, 
NULL
, 'W' },

94 { "‹¡-rg‘s", 
»quœed_¬gum’t
, 
NULL
, 't' },

95 { "´oduû-d©a-th»ads", 
»quœed_¬gum’t
, 
NULL
, 'p' },

96 { "ÿched-keys", 
»quœed_¬gum’t
, 
NULL
, 'K' },

97 { "h™-¿tio", 
»quœed_¬gum’t
, 
NULL
, 'H' },

98 { "di¥©ch-d©a-th»ads", 
»quœed_¬gum’t
, 
NULL
, 'd' },

99 { "ş›Ás", 
»quœed_¬gum’t
, 
NULL
, 'c' },

100 { "log-fe", 
»quœed_¬gum’t
, 
NULL
, 'o' },

101 { 
NULL
, 0, NULL, 0 }

104 
	gshÜt_İtiÚs
[] = "hVDEP:C:i:k:s:f:T:B:W:t:p:K:H:d:c:o:";

107 
	$v¹_show_u§ge
()

109 
	`´štf
(

110 "U§ge: vœ—b‹¡ [-?hVDE]" 
CRLF


111 "" 
CRLF
);

112 
	`´štf
(

113 "O±iÚs:" 
CRLF


114 " -h, --h–° :hi h–p" 
CRLF


115 " -V, --v”siÚ : show v”siÚ‡ndƒx™" 
CRLF


116 " -D, --d«mÚiz :„uÀa ¨d«mÚ" 
CRLF


117 " -E, --’abË-expœ :ƒÇbËhexpœe" 
CRLF
);

118 
	`´štf
(

119 " -P, --pid-f :…id fe" 
CRLF


120 " -C, --check” :hcheck”Øcheck d©¨cÚsi¡’cy" 
CRLF


121 " -i, --‹¡-š‹rv® :hš‹rv® fÜ checkšg d©¨cÚsi¡’cy, un™ i £cÚd" 
CRLF


122 " -k, --key-Ëngth-¿ng :hkey†’gth„ªgtØg’”©fÜe¡,†ik0-100" 
CRLF


123 " -s, --¡ršg-max-Ëngth :hmax sŒšg†’gthØg’”©fÜe¡, sŒšg i fÜ STRING/LIST... v®u–em’t" 
CRLF


124 " -f, --f›lds-max-couÁ :hmax f›ld couÁØg’”©fÜe¡, f›ld i thLIST/HASH...' –em’t" 
CRLF


125 " -T, --commªd-ty³  :hcommªdy³ tØg’”©fÜe¡,†ik¡ršg,hash,key" 
CRLF


126 " -B, --commªd-bÏck-li¡ :hcommªd nÙ wªˆtØ‹¡,†ikd–,Ìªge,mg‘" 
CRLF


127 " -W, --commªd-wh™e-li¡ :hcommªd Úly‡Îow tØ‹¡,†ikd–,Ìªge,mg‘" 
CRLF


128 " -t, --‹¡-rg‘  :h‹¡¬g‘ fÜe¡,†ikvœe[127.0.0.1:12301]-»dis[127.0.0.1:12311]" 
CRLF


129 " -p, --´oduû-d©a-th»ad  :hth»ad couÁØ´oduûe¡ d©a" 
CRLF


130 " -K, --ÿched-key  :hÿched key couÁ fÜƒv”y…roduû d©¨th»ad" 
CRLF


131 " -H, --h™-¿tiØ :hh™„©iØfÜ„—dÚly commªds, b‘w“À0‡nd 100" 
CRLF


132 " -d, --di¥©ch-d©a-th»ad  :hth»ad couÁØdi¥©che¡ d©¨tØrg‘ groups" 
CRLF


133 " -c, --ş›Á  :hş›Á couÁ fÜƒv”y di¥©ch d©¨th»ad" 
CRLF


134 " -o, --log-f : s‘†oggšg f(deçuÉ: %s)" 
CRLF


136 
CONFIG_DEFAULT_LOGFILE
 !ğ
NULL
 ? CONFIG_DEFAULT_LOGFILE : "stderr");

137 
	}
}

140 
	$v¹_£t_deçuÉ_İtiÚs
()

142 
cÚfig
.
pid_f’ame
 = 
CONFIG_DEFAULT_PIDFILE
;

143 
cÚfig
.
check”
 = 
CONFIG_DEFAULT_CHECKER
;

144 
cÚfig
.
‹¡_š‹rv®
 = 
CONFIG_DEFAULT_TEST_INTERVAL
;

145 
cÚfig
.
key_Ëngth_¿nge_begš
 = 
CONFIG_DEFAULT_KEY_LENGTH_RANGE_BEGIN
;

146 
cÚfig
.
key_Ëngth_¿nge_’d
 = 
CONFIG_DEFAULT_KEY_LENGTH_RANGE_END
;

147 
cÚfig
.
¡ršg_max_Ëngth
 = 
CONFIG_DEFAULT_STRING_MAX_LENGTH
;

148 
cÚfig
.
f›lds_max_couÁ
 = 
CONFIG_DEFAULT_FIELDS_MAX_COUNT
;

149 
cÚfig
.
cmd_ty³
 = 
TEST_CMD_TYPE_STRING
|
TEST_CMD_TYPE_LIST
|

150 
TEST_CMD_TYPE_SET
|
TEST_CMD_TYPE_ZSET
|
TEST_CMD_TYPE_HASH
|

151 
TEST_CMD_TYPE_SERVER
|
TEST_CMD_TYPE_KEY
;

152 
cÚfig
.
cmd_bÏckli¡
 = 
NULL
;

153 
cÚfig
.
cmd_wh™–i¡
 = 
NULL
;

154 
cÚfig
.
‹¡_rg‘s
 = 
CONFIG_DEFAULT_TEST_TARGET
;

155 
cÚfig
.
´oduû_d©a_th»ads
 = 
CONFIG_DEFAULT_PRODUCE_THREADS_COUNT
;

156 
cÚfig
.
ÿched_keys_³r_´oduû_th»ad
 = 
CONFIG_DEFAULT_CACHED_KEYS_COUNT
;

157 
cÚfig
.
h™_¿tio
 = 
CONFIG_DEFAULT_HIT_RATIO
;

158 
cÚfig
.
di¥©ch_d©a_th»ads
 = 
CONFIG_DEFAULT_DISPATCH_THREADS_COUNT
;

159 
cÚfig
.
ş›Ás_³r_di¥©ch_th»ad
 = 
CONFIG_DEFAULT_CLIENTS_PER_DISPATCH_THREAD
;

160 
cÚfig
.
log_f’ame
 = 
CONFIG_DEFAULT_LOGFILE
;

162 
expœe_’abËd
 = 0;

163 
	}
}

166 
	$v¹_ş—n_İtiÚs
()

168 ià(
cÚfig
.
cmd_bÏckli¡
 !ğ
NULL
) {

169 
sds
 *
commªd
;

170 
	`d¬¿y_n
(
cÚfig
.
cmd_bÏckli¡
) > 0) {

171 
commªd
 = 
	`d¬¿y_pİ
(
cÚfig
.
cmd_bÏckli¡
);

172 
	`sdsä“
(
commªd
);

174 
	`d¬¿y_de¡roy
(
cÚfig
.
cmd_bÏckli¡
);

175 
cÚfig
.
cmd_bÏckli¡
 = 
NULL
;

178 ià(
cÚfig
.
cmd_wh™–i¡
 !ğ
NULL
) {

179 
sds
 *
commªd
;

180 
	`d¬¿y_n
(
cÚfig
.
cmd_wh™–i¡
) > 0) {

181 
commªd
 = 
	`d¬¿y_pİ
(
cÚfig
.
cmd_wh™–i¡
);

182 
	`sdsä“
(
commªd
);

184 
	`d¬¿y_de¡roy
(
cÚfig
.
cmd_wh™–i¡
);

185 
cÚfig
.
cmd_wh™–i¡
 = 
NULL
;

187 
	}
}

190 
	$v¹_g‘_İtiÚs
(
¬gc
, **
¬gv
)

192 
c
;

193 
lv®ue
;

194 
Îv®ue
;

195 *
¿nge
;

196 
¿nge_couÁ
;

198 
İ‹¼
 = 0;

201 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İtiÚs
, 
lÚg_İtiÚs
, 
NULL
);

202 ià(
c
 == -1) {

207 
c
) {

209 
show_v”siÚ
 = 1;

210 
show_h–p
 = 1;

214 
show_v”siÚ
 = 1;

218 
d«mÚize
 = 1;

222 
expœe_’abËd
 = 1;

226 
cÚfig
.
check”
 = 
İrg
;

230 ià(
	`¡ršg2Î
(
İrg
,
	`¡¾’
(İrg),&
Îv®ue
) != 1) {

231 
	`log_¡d”r
("vireabtest: option -i„equires‡‚umber");

232  
VRT_ERROR
;

234 
cÚfig
.
‹¡_š‹rv®
 = 
Îv®ue
;

238 
¿nge
 = 
	`g‘_¿nge_äom_¡ršg
(
İrg
,
	`¡¾’
(İrg),&
¿nge_couÁ
);

239 ià(
¿nge
 =ğ
NULL
) {

240 
	`log_¡d”r
("vireabtest: option -k is invalid, you‚eed input‡„ange†ike 0-100");

241  
VRT_ERROR
;

243 
cÚfig
.
key_Ëngth_¿nge_begš
 = ()
¿nge
[0];

244 ià(
¿nge_couÁ
 =ğ1è
cÚfig
.
key_Ëngth_¿nge_’d
 = ()
¿nge
[0];

245 ià(
¿nge_couÁ
 =ğ2è
cÚfig
.
key_Ëngth_¿nge_’d
 = ()
¿nge
[1];

246 
	`as£¹
(0);

248 
	`ä“
(
¿nge
);

253 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

254 
	`log_¡d”r
("vireabtest: option -s„equires‡‚umber");

255  
VRT_ERROR
;

257 
cÚfig
.
¡ršg_max_Ëngth
 = ()
lv®ue
;

261 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

262 
	`log_¡d”r
("vireabtest: option -f„equires‡‚umber");

263  
VRT_ERROR
;

265 
cÚfig
.
f›lds_max_couÁ
 = ()
lv®ue
;

269 
cÚfig
.
cmd_ty³
 = 
	`·r£_commªd_ty³s
(
İrg
);

270 ià(
cÚfig
.
cmd_ty³
 <= 0) {

271 
	`log_¡d”r
("vireabtest: option -T„equireshe correct commandypes");

272  
VRT_ERROR
;

277 
cÚfig
.
cmd_bÏckli¡
 = 
	`·r£_commªd_li¡
(
İrg
);

278 ià(
cÚfig
.
cmd_bÏckli¡
 =ğ
NULL
) {

279 
	`log_¡d”r
("vireabtest: option -B„equireshe correct command†ist");

280  
VRT_ERROR
;

285 
cÚfig
.
cmd_wh™–i¡
 = 
	`·r£_commªd_li¡
(
İrg
);

286 ià(
cÚfig
.
cmd_wh™–i¡
 =ğ
NULL
) {

287 
	`log_¡d”r
("vireabtest: option -W„equireshe correct command†ist");

288  
VRT_ERROR
;

293 
cÚfig
.
‹¡_rg‘s
 = 
İrg
;

297 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

298 
	`log_¡d”r
("vireabtest: option -p„equires‡‚umber");

299  
VRT_ERROR
;

301 
cÚfig
.
´oduû_d©a_th»ads
 = ()
lv®ue
;

305 ià(
	`¡ršg2Î
(
İrg
,
	`¡¾’
(İrg),&
Îv®ue
) != 1) {

306 
	`log_¡d”r
("vireabtest: option -K„equires‡‚umber");

307  
VRT_ERROR
;

309 ià(
Îv®ue
 < 1000) {

310 
	`log_¡d”r
("vireabtest: option -K„equires‡‚umberhat must biggerhan 1000");

311  
VRT_ERROR
;

314 
cÚfig
.
ÿched_keys_³r_´oduû_th»ad
 = 
Îv®ue
;

318 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

319 
	`log_¡d”r
("vireabtest: option -H„equires‡‚umber");

320  
VRT_ERROR
;

322 ià(
lv®ue
 < 0 ||†value > 100) {

323 
	`log_¡d”r
("vireabtest: option hit-ratio‚eed between 0‡nd 100");

324  
VRT_ERROR
;

326 
cÚfig
.
h™_¿tio
 = ()
lv®ue
;

330 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

331 
	`log_¡d”r
("vireabtest: option -d„equires‡‚umber");

332  
VRT_ERROR
;

334 
cÚfig
.
di¥©ch_d©a_th»ads
 = ()
lv®ue
;

338 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

339 
	`log_¡d”r
("vireabtest: option -c„equires‡‚umber");

340  
VRT_ERROR
;

342 
cÚfig
.
ş›Ás_³r_di¥©ch_th»ad
 = ()
lv®ue
;

346 
cÚfig
.
pid_f’ame
 = 
İrg
;

350 
cÚfig
.
log_f’ame
 = 
İrg
;

354 
İtİt
) {

363 
	`log_¡d”r
("vire: option -%c„equires string",

364 
İtİt
);

372 
	`log_¡d”r
("vire: option -%c„equires‚umber",

373 
İtİt
);

377 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

380  
VRT_ERROR
;

383 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

384  
VRT_ERROR
;

389  
VRT_OK
;

390 
	}
}

392 
	$v¹_d«mÚize
(
dump_cÜe
)

394 
»t
;

395 
pid_t
 
pid
, 
sid
;

396 
fd
;

398 
pid
 = 
	`fÜk
();

399 
pid
) {

401 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

402  
VRT_ERROR
;

409 
	`_ex™
(0);

414 
sid
 = 
	`£tsid
();

415 ià(
sid
 < 0) {

416 
	`log_”rÜ
("£tsid(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

417  
VRT_ERROR
;

420 ià(
	`sigÇl
(
SIGHUP
, 
SIG_IGN
è=ğ
SIG_ERR
) {

421 
	`log_”rÜ
("sigÇl(SIGHUP, SIG_IGNèçed: %s", 
	`¡»¼Ü
(
”ºo
));

422  
VRT_ERROR
;

425 
pid
 = 
	`fÜk
();

426 
pid
) {

428 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

429  
VRT_ERROR
;

436 
	`_ex™
(0);

442 ià(
dump_cÜe
 == 0) {

443 
»t
 = 
	`chdœ
("/");

444 ià(
»t
 < 0) {

445 
	`log_”rÜ
("chdœ(\"/\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

446  
VRT_ERROR
;

451 
	`umask
(0);

455 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

456 ià(
fd
 < 0) {

457 
	`log_”rÜ
("İ’(\"/dev/nuÎ\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

458  
VRT_ERROR
;

461 
»t
 = 
	`dup2
(
fd
, 
STDIN_FILENO
);

462 ià(
»t
 < 0) {

463 
	`log_”rÜ
("dup2(%d, STDINèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

464 
	`şo£
(
fd
);

465  
VRT_ERROR
;

468 
»t
 = 
	`dup2
(
fd
, 
STDOUT_FILENO
);

469 ià(
»t
 < 0) {

470 
	`log_”rÜ
("dup2(%d, STDOUTèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

471 
	`şo£
(
fd
);

472  
VRT_ERROR
;

475 
»t
 = 
	`dup2
(
fd
, 
STDERR_FILENO
);

476 ià(
»t
 < 0) {

477 
	`log_”rÜ
("dup2(%d, STDERRèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

478 
	`şo£
(
fd
);

479  
VRT_ERROR
;

482 ià(
fd
 > 
STDERR_FILENO
) {

483 
»t
 = 
	`şo£
(
fd
);

484 ià(
»t
 < 0) {

485 
	`log_”rÜ
("şo£(%dèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

486  
VRT_ERROR
;

490  
VRT_OK
;

491 
	}
}

493 
	$ab‹¡_£rv”_š™
(
ab‹¡_£rv”
 *
abs
, *
add»ss
)

495 
sds
 *
ho¡_pÜt
;

496 
couÁ
;

497 
v®ue
;

499 
abs
->
ho¡
 = 
NULL
;

500 
abs
->
pÜt
 = 0;

501 
abs
->
cÚn_cÚ‹xts
 = 
NULL
;

502 
abs
->
d©a
 = 
NULL
;

504 
ho¡_pÜt
 = 
	`sds¥l™Ën
(
add»ss
,
	`¡¾’
×dd»ss),":",1,&
couÁ
);

505 ià(
ho¡_pÜt
 =ğ
NULL
) {

506  
VRT_ERROR
;

507 } ià(
couÁ
 != 2) {

508 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

509  
VRT_ERROR
;

512 
abs
->
ho¡
 = 
ho¡_pÜt
[0];

513 
ho¡_pÜt
[0] = 
NULL
;

515 ià(
	`¡ršg2l
(
ho¡_pÜt
[1],
	`sd¦’
(ho¡_pÜt[1]),&
v®ue
) != 1) {

516 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

517  
VRT_ERROR
;

520 
abs
->
pÜt
 = ()
v®ue
;

521 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

523  
VRT_OK
;

524 
	}
}

526 
	$ab‹¡_£rv”_deš™
(
ab‹¡_£rv”
 *
abs
)

528 ià(
abs
->
ho¡
) {

529 
	`sdsä“
(
abs
->
ho¡
);

530 
abs
->
ho¡
 = 
NULL
;

533 ià(
abs
->
pÜt
 > 0)‡bs->port = 0;

535 ià(
abs
->
cÚn_cÚ‹xts
) {

536 
	`ASSERT
(
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) == 0);

537 
	`d¬¿y_de¡roy
(
abs
->
cÚn_cÚ‹xts
);

538 
abs
->
cÚn_cÚ‹xts
 = 
NULL
;

540 
	}
}

542 
	$g‘_back’d_£rv”_idx
(
ab‹¡_group
 *
abg
, *
key
, 
size_t
 
keyËn
)

544 
hashv®ue
, 
£rv”s_couÁ
;

546 
£rv”s_couÁ
 = 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
);

547 ià(
£rv”s_couÁ
 == 1) {

551 
hashv®ue
 = ()
	`hash_üc32a
(
key
, 
keyËn
);

553  
hashv®ue
%
£rv”s_couÁ
;

554 
	}
}

556 
ab‹¡_£rv”
 *
	$g‘_back’d_£rv”
(
ab‹¡_group
 *
abg
, *
key
, 
size_t
 
keyËn
)

558 
ab‹¡_£rv”
 *
abs
;

559 
idx
;

561 
idx
 = 
abg
->
	`g‘_back’d_£rv”_idx
×bg,
key
,
keyËn
);

562 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
idx
);

564  
abs
;

565 
	}
}

567 
	$ab‹¡_group_š™
(
ab‹¡_group
 *
abg
, *
group_¡ršg
)

569 
sds
 *
ty³_addrs
, *
addrs
;

570 
ty³_addrs_couÁ
, 
addrs_couÁ
;

571 
j
;

573 
abg
->
ty³
 = 0;

574 
	`d¬¿y_š™
(&
abg
->
ab‹¡_£rv”s
, 1, (
ab‹¡_£rv”
));

576 
ty³_addrs
 = 
	`sds¥l™Ën
(
group_¡ršg
,
	`sd¦’
(group_¡ršg),"[",1,&
ty³_addrs_couÁ
);

577 ià(
ty³_addrs
 =ğ
NULL
) {

578  
VRT_ERROR
;

579 } ià(
ty³_addrs_couÁ
 != 2) {

580 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

581  
VRT_ERROR
;

584 ià(!
	`¡rÿ£cmp
(
ty³_addrs
[0],"vire")) {

585 
abg
->
ty³
 = 
VRABTEST_GROUP_TYPE_VIRE
;

586 } ià(!
	`¡rÿ£cmp
(
ty³_addrs
[0],"redis")) {

587 
abg
->
ty³
 = 
VRABTEST_GROUP_TYPE_REDIS
;

589 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

590  
VRT_ERROR
;

593 ià(
	`sd¦’
(
ty³_addrs
[1]) <= 1 ||

594 
ty³_addrs
[1][
	`sd¦’
(type_addrs[1])-1] != ']') {

595 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

596  
VRT_ERROR
;

599 
	`sd¤ªge
(
ty³_addrs
[1],0,-2);

601 
addrs
 = 
	`sds¥l™Ën
(
ty³_addrs
[1],
	`sd¦’
Ñy³_addrs[1]),",",1,&
addrs_couÁ
);

602 ià(
addrs
 =ğ
NULL
) {

603 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

604  
VRT_ERROR
;

605 } ià(
addrs_couÁ
 < 1) {

606 
	`sdsä“¥l™»s
(
addrs
,
addrs_couÁ
);

607 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

608  
VRT_ERROR
;

611 
j
 = 0; j < 
addrs_couÁ
; j ++) {

612 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_push
(&
abg
->
ab‹¡_£rv”s
);

613 ià(
	`ab‹¡_£rv”_š™
(
abs
,
addrs
[
j
]è!ğ
VRT_OK
) {

614 
	`sdsä“¥l™»s
(
addrs
,
addrs_couÁ
);

615 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

616  
VRT_ERROR
;

620 
	`sdsä“¥l™»s
(
addrs
,
addrs_couÁ
);

621 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

623 
abg
->
g‘_back’d_£rv”_idx
 = get_backend_server_idx;

624 
abg
->
g‘_back’d_£rv”
 = get_backend_server;

626  
VRT_OK
;

627 
	}
}

629 
	$ab‹¡_group_deš™
(
ab‹¡_group
 *
abg
)

631 
ab‹¡_£rv”
 *
abs
;

633 
abg
->
ty³
 = 0;

635 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
) > 0) {

636 
abs
 = 
	`d¬¿y_pİ
(&
abg
->
ab‹¡_£rv”s
);

637 
	`ab‹¡_£rv”_deš™
(
abs
);

639 
	`d¬¿y_deš™
(&
abg
->
ab‹¡_£rv”s
);

640 
	}
}

643 
d¬¿y
 *
	$ab‹¡_groups_ü—‹
(*
groups_¡ršg
)

645 
d¬¿y
 *
abgs
;

646 
sds
 *
group_¡ršgs
;

647 
group_couÁ
, 
j
;

649 
group_¡ršgs
 = 
	`sds¥l™Ën
(
groups_¡ršg
,
	`¡¾’
(groups_¡ršg),"-",1,&
group_couÁ
);

650 ià(
group_¡ršgs
 =ğ
NULL
) {

651  
NULL
;

652 } ià(
group_couÁ
 < 1) {

653 
	`sdsä“¥l™»s
(
group_¡ršgs
,
group_couÁ
);

654  
NULL
;

657 
abgs
 = 
	`d¬¿y_ü—‹
(2, (
ab‹¡_group
));

658 ià(
abgs
 =ğ
NULL
) {

659 
	`sdsä“¥l™»s
(
group_¡ršgs
,
group_couÁ
);

660  
NULL
;

663 
j
 = 0; j < 
group_couÁ
; j ++) {

664 
ab‹¡_group
 *
abg
;

665 
sds
 
group_¡ršg
 = 
group_¡ršgs
[
j
];

666 
sds
 *
ty³_addrs
;

667 
–em_couÁ
;

669 
abg
 = 
	`d¬¿y_push
(
abgs
);

670 ià(
	`ab‹¡_group_š™
(
abg
,
group_¡ršg
è!ğ
VRT_OK
) {

671 
	`sdsä“¥l™»s
(
group_¡ršgs
,
group_couÁ
);

672 
	`ab‹¡_groups_de¡roy
(
abgs
);

673  
NULL
;

677  
abgs
;

678 
	}
}

680 
	$ab‹¡_groups_de¡roy
(
d¬¿y
 *
abgs
)

682 
	`d¬¿y_n
(
abgs
) > 0) {

683 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_pİ
(
abgs
);

684 
	`ab‹¡_group_deš™
(
abg
);

687 
	`d¬¿y_de¡roy
(
abgs
);

688 
	}
}

691 
	$maš
(
¬gc
, **
¬gv
)

693 
»t
;

695 
	`v¹_£t_deçuÉ_İtiÚs
();

697 
»t
 = 
	`v¹_g‘_İtiÚs
(
¬gc
, 
¬gv
);

698 ià(
»t
 !ğ
VRT_OK
) {

699 
	`v¹_show_u§ge
();

700 
	`ex™
(1);

703 ià(
show_v”siÚ
) {

704 
	`log_¡dout
("Thi i vœ—b‹¡-%s", 
VR_VERSION_STRING
);

705 ià(
show_h–p
) {

706 
	`v¹_show_u§ge
();

708 
	`ex™
(0);

711 
»t
 = 
	`log_š™
(
LOG_INFO
, 
cÚfig
.
log_f’ame
);

712 ià(
»t
 < 0) {

713 
	`ex™
(1);

716 ià(
d«mÚize
) {

717 
»t
 = 
	`v¹_d«mÚize
(1);

718 ià(
»t
 !ğ
VRT_OK
) {

719 
	`ex™
(1);

723 
‹¡_š‹rv®
 = 
cÚfig
.test_interval;

725 
»t
 = 
	`v¹_´oduû_d©a_š™
(
cÚfig
.
key_Ëngth_¿nge_begš
,

726 
cÚfig
.
key_Ëngth_¿nge_’d
,

727 
cÚfig
.
¡ršg_max_Ëngth
,cÚfig.
f›lds_max_couÁ
,

728 
cÚfig
.
cmd_ty³
,cÚfig.
cmd_bÏckli¡
,cÚfig.
cmd_wh™–i¡
,

729 
cÚfig
.
´oduû_d©a_th»ads
,

730 
cÚfig
.
ÿched_keys_³r_´oduû_th»ad
,

731 
cÚfig
.
h™_¿tio
);

732 ià(
»t
 !ğ
VRT_OK
) {

733 
	`log_”rÜ
("Init data…roducer failed");

734 
	`ex™
(1);

736 
»t
 = 
	`v¹_di¥©ch_d©a_š™
(
cÚfig
.
di¥©ch_d©a_th»ads
,

737 
cÚfig
.
‹¡_rg‘s
, cÚfig.
ş›Ás_³r_di¥©ch_th»ad
);

738 ià(
»t
 !ğ
VRT_OK
) {

739 
	`log_”rÜ
("Init data dispatcher failed");

740 
	`ex™
(1);

742 
»t
 = 
	`v¹_back’d_š™
(
cÚfig
.
di¥©ch_d©a_th»ads
,

743 
cÚfig
.
‹¡_rg‘s
);

744 ià(
»t
 !ğ
VRT_OK
) {

745 
	`log_”rÜ
("Init backendhread failed");

746 
	`ex™
(1);

748 
»t
 = 
	`v¹_d©a_check”_š™
(
cÚfig
.
check”
, cÚfig.
‹¡_rg‘s
);

749 ià(
»t
 !ğ
VRT_OK
) {

750 
	`log_”rÜ
("Init check datahread failed");

751 
	`ex™
(1);

754 
	`log_debug
(
LOG_INFO
,"S‹†ocky³: %s", 
TEST_STATE_LOCK_TYPE
);

756 
	`v¹_¡¬t_´oduû_d©a
();

757 
	`v¹_¡¬t_di¥©ch_d©a
();

758 
	`v¹_¡¬t_back’d
();

759 
	`v¹_¡¬t_d©a_check”
();

761 
	`v¹_wa™_´oduû_d©a
();

762 
	`v¹_wa™_di¥©ch_d©a
();

763 
	`v¹_wa™_back’d
();

764 
	`v¹_wa™_d©a_check”
();

766 
	`v¹_d©a_check”_deš™
();

767 
	`v¹_back’d_deš™
();

768 
	`v¹_di¥©ch_d©a_deš™
();

769 
	`v¹_´oduû_d©a_deš™
();

771 
	`log_deš™
();

772 
	`v¹_ş—n_İtiÚs
();

774  
VRT_OK
;

775 
	}
}

	@tests/vrabtest.h

1 #iâdeà
_VRABTEST_H_


2 
	#_VRABTEST_H_


	)

4 
	~<d¬¿y.h
>

6 
	g»disCÚ‹xt
;

7 
	g»disAsyncCÚ‹xt
;

8 
	gab‹¡_group
;

10 
	scÚn_cÚ‹xt
 {

11 
»disCÚ‹xt
 *
	mùx
;

12 
»disAsyncCÚ‹xt
 *
	maùx
;

13 } 
	tcÚn_cÚ‹xt
;

15 
	sab‹¡_£rv”
 {

16 
sds
 
	mho¡
;

17 
	mpÜt
;

19 
d¬¿y
 *
	mcÚn_cÚ‹xts
;

21 *
	md©a
;

22 } 
	tab‹¡_£rv”
;

24 (*
	tback’d_£rv”_idx_t
)(
	tab‹¡_group
*, *, 
	tsize_t
);

25 
ab‹¡_£rv”
 *(*
	tback’d_£rv”_t
)(
	tab‹¡_group
*, *, 
	tsize_t
);

27 
	sab‹¡_group
 {

28 
ty³
;

30 
d¬¿y
 
ab‹¡_£rv”s
;

32 
back’d_£rv”_idx_t
 
g‘_back’d_£rv”_idx
;

33 
back’d_£rv”_t
 
g‘_back’d_£rv”
;

34 } 
	tab‹¡_group
;

36 
expœe_’abËd
;

37 
‹¡_š‹rv®
;

38 
Ï¡_‹¡_begš_time
;

40 
d¬¿y
 *
	`ab‹¡_groups_ü—‹
(*
groups_¡ršg
);

41 
	`ab‹¡_groups_de¡roy
(
d¬¿y
 *
abgs
);

	@tests/vrt_backend.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

12 
	~<async.h
>

13 
	~<ad­‹rs/«.h
>

15 
	~<dhashk™.h
>

16 
	~<dli¡.h
>

17 
	~<dmtqueue.h
>

19 
	~<v¹_ut.h
>

20 
	~<v¹_public.h
>

21 
	~<v¿b‹¡.h
>

22 
	~<v¹_´oduû_d©a.h
>

23 
	~<v¹_di¥©ch_d©a.h
>

24 
	~<v¹_back’d.h
>

26 
	ssk_d©a
 {

27 
	mmaxmemÜy
;

28 
	mu£d_memÜy
;

29 
	mtÙ®_sy¡em_memÜy
;

31 
	md–‘šg
;

32 
	mcursÜ
;

33 } 
	tsk_d©a
;

35 
	gback’d_th»ads_couÁ
;

36 
d¬¿y
 *
	gback’d_th»ads
 = 
NULL
;

38 
	gback’d_th»ads_·u£_fšished_couÁ
;

40 
	$sk_d©a_ü—‹
()

42 
sk_d©a
 *
td
;

44 
td
 = 
	`m®loc
((*td));

46 
td
->
maxmemÜy
 = 0;

47 
td
->
u£d_memÜy
 = 0;

48 
td
->
tÙ®_sy¡em_memÜy
 = 0;

49 
td
->
d–‘šg
 = 0;

50 
td
->
cursÜ
 = 0;

52  
td
;

53 
	}
}

55 
	$sk_d©a_de¡roy
(
sk_d©a
 *
td
)

57 
	`ä“
(
td
);

58 
	}
}

60 
	$back’d_cÚn_cÚ‹xt_š™
(
cÚn_cÚ‹xt
 *
cc
, *
ho¡
, 
pÜt
)

62 
cc
->
ùx
 = 
NULL
;

63 
cc
->
aùx
 = 
NULL
;

65 
cc
->
aùx
 = 
	`»disAsyncCÚÃù
(
ho¡
, 
pÜt
);

66 ià(
cc
->
aùx
 =ğ
NULL
) {

67  
VRT_ERROR
;

70  
VRT_OK
;

71 
	}
}

73 
	$back’d_cÚn_cÚ‹xt_deš™
(
cÚn_cÚ‹xt
 *
cc
)

75 ià(
cc
->
ùx
) {

76 
	`»disF»e
(
cc
->
ùx
);

77 
cc
->
ùx
 =ğ
NULL
;

80 ià(
cc
->
aùx
) {

81 
	`»disAsyncF»e
(
cc
->
aùx
);

82 
cc
->
aùx
 =ğ
NULL
;

84 
	}
}

86 
	$cÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

87 
back’d_th»ad
 *
bt
 = 
c
->
d©a
;

88 ià(
¡©us
 !ğ
REDIS_OK
) {

89 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

95 
	}
}

97 
	$discÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

98 
back’d_th»ad
 *
bt
 = 
c
->
d©a
;

99 ià(
¡©us
 !ğ
REDIS_OK
) {

100 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

107 
	}
}

109 
	$sÿn_fÜ_d–‘e_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

110 
»disR•ly
 *
»¶y
 = 
r
, *
»¶y_sub
, *
»¶y_–em
;

111 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

112 
sk_d©a
 *
td
 = 
abs
->
d©a
;

113 
cÚn_cÚ‹xt
 *
cc
;

114 
v®ue
;

115 
size_t
 
k
;

117 ià(
»¶y
 =ğ
NULL
) ;

119 ià(!
td
->
d–‘šg
) {

123 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

127 ià(
»¶y
->
–em’ts
 != 2) {

131 
»¶y_sub
 = 
»¶y
->
–em’t
[0];

132 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

133 
	`¡ršg2Î
(
»¶y_sub
->
¡r
,»¶y_sub->
Ën
,&
v®ue
) != 1) {

137 
td
->
cursÜ
 = 
v®ue
;

139 
»¶y_sub
 = 
»¶y
->
–em’t
[1];

140 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

144 
k
 = 0; k < 
»¶y_sub
->
–em’ts
; k ++) {

145 
»¶y_–em
 = 
»¶y_sub
->
–em’t
[
k
];

146 ià(
»¶y_–em
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

150 
d©a_un™
 *
du
 = 
	`d©a_un™_g‘
();

151 
du
->
dp
 = 
d–‘e_d©a_´oduûr
;

152 
du
->
¬gc
 = 2;

153 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

154 
du
->
¬gv
[0] = 
	`sd¢ew
(
d–‘e_d©a_´oduûr
->
Çme
);

155 
du
->
¬gv
[1] = 
	`sd¢ewËn
(
»¶y_–em
->
¡r
,»¶y_–em->
Ën
);

156 
	`d©a_di¥©ch
(
du
);

159 
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

160 
	`»disAsyncCommªd
(
cc
->
aùx
, 
sÿn_fÜ_d–‘e_ÿÎback
,

161 
abs
, "sÿÀ%Îd couÁ 1000", 
td
->
cursÜ
);

162 
	}
}

164 
	$upd©e_memÜy_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

165 
»disR•ly
 *
»¶y
 = 
r
;

166 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

167 
sk_d©a
 *
td
 = 
abs
->
d©a
;

169 ià(
»¶y
 =ğ
NULL
) ;

171 
td
->
u£d_memÜy
 = 
	`g‘_lÚglÚg_äom_šfo_»¶y
(
»¶y
, "used_memory");

173 ià(
td
->
maxmemÜy
 == 0) {

174 
td
->
tÙ®_sy¡em_memÜy
 = 
	`g‘_lÚglÚg_äom_šfo_»¶y
(
»¶y
, "total_system_memory");

176 
	}
}

178 
	$upd©e_maxmemÜy_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

179 
»disR•ly
 *
»¶y
 = 
r
;

180 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

181 
sk_d©a
 *
td
 = 
abs
->
d©a
;

182 
»disR•ly
 *
»¶y_sub
;

183 
v®ue
;

185 ià(
»¶y
 =ğ
NULL
) ;

187 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

191 ià(
»¶y
->
–em’ts
 != 2) {

195 
»¶y_sub
 = 
»¶y
->
–em’t
[0];

196 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

197 
	`¡rcmp
(
»¶y_sub
->
¡r
, "maxmemory")) {

201 
»¶y_sub
 = 
»¶y
->
–em’t
[1];

202 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

203 
	`¡ršg2Î
(
»¶y_sub
->
¡r
,»¶y_sub->
Ën
,&
v®ue
) != 1) {

207 
td
->
maxmemÜy
 = 
v®ue
;

208 
	}
}

210 
	$upd©e_memÜy_šfo
(
d¬¿y
 *
abgs
)

212 
i
, 
j
;

214 
i
 = 0; i < 
	`d¬¿y_n
(
abgs
); i ++) {

215 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
abgs
, 
i
);

216 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

217 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

218 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

220 
	`»disAsyncCommªd
(
cc
->
aùx
, 
upd©e_memÜy_ÿÎback
, 
abs
, "info memory");

221 
	`»disAsyncCommªd
(
cc
->
aùx
, 
upd©e_maxmemÜy_ÿÎback
, 
abs
, "config get maxmemory");

224 
	}
}

226 
	$check_memÜy_’ough
(
back’d_th»ad
 *
bt
)

228 
i
, 
j
;

229 
d¬¿y
 *
abgs
 = 
bt
->abgs;

231 
i
 = 0; i < 
	`d¬¿y_n
(
abgs
); i ++) {

232 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
abgs
, 
i
);

233 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

234 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

235 
sk_d©a
 *
td
 = 
abs
->
d©a
;

236 
max_memÜy_®lowed
 = 0;

238 ià(
td
->
u£d_memÜy
) {

239 ià(
td
->
maxmemÜy
) {

240 
max_memÜy_®lowed
 = 
td
->
maxmemÜy
;

241 } ià(
td
->
tÙ®_sy¡em_memÜy
) {

242 
max_memÜy_®lowed
 = 
td
->
tÙ®_sy¡em_memÜy
;

245 ià(
max_memÜy_®lowed
) {

246 ià(
td
->
u£d_memÜy
*100/
max_memÜy_®lowed
 > 80) {

247 ià(!
td
->
d–‘šg
) {

248 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

249 
	`»disAsyncCommªd
(
cc
->
aùx
, 
sÿn_fÜ_d–‘e_ÿÎback
,

250 
abs
, "sÿÀ%Îd couÁ 1000", 
td
->
cursÜ
);

251 
td
->
d–‘šg
 = 1;

252 
bt
->
d–‘šg
 ++;

254 } ià(
td
->
d–‘šg
) {

255 
td
->
d–‘šg
 = 0;

256 
bt
->
d–‘šg
 --;

262 
	}
}

264 
	$back’d_th»ad_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

266 
back’d_th»ad
 *
bt
 = 
ş›ÁD©a
;

268 
	`ASSERT
(
ev’tLoİ
 =ğ
bt
->
–
);

271 ià(
bt
->
·u£
) {

272 ià(!
	`‹¡_if_Ãed_·u£
()) {

273 
bt
->
·u£
 = 0;

275 
bt
->
üÚloİs
 ++;

280 
	`upd©e_memÜy_šfo
(
bt
->
abgs
);

281 
	`check_memÜy_’ough
(
bt
);

284 ià(!
bt
->
·u£
 && 
	`‹¡_if_Ãed_·u£
(è&& !bt->
d–‘šg
) {

285 
bt
->
·u£
 = 1;

286 
	`Úe_back’d_th»ad_·u£d
();

289 
bt
->
üÚloİs
 ++;

290  1000/
bt
->
hz
;

291 
	}
}

293 
	$back’d_th»ad_š™
(
back’d_th»ad
 *
bt
, *
‹¡_rg‘_groups
)

295 
i
, 
j
, 
k
;

297 
bt
->
id
 = 0;

298 
bt
->
th»ad_id
 = 0;

299 
bt
->
–
 = 
NULL
;

300 
bt
->
hz
 = 10;

301 
bt
->
üÚloİs
 = 0;

302 
bt
->
d–‘šg
 = 0;

303 
bt
->
·u£
 = 0;

305 
bt
->
–
 = 
	`«C»©eEv’tLoİ
(1);

306 ià(
bt
->
–
 =ğ
NULL
) {

307  
VRT_ERROR
;

310 
bt
->
abgs
 = 
	`ab‹¡_groups_ü—‹
(
‹¡_rg‘_groups
);

311 ià(
bt
->
abgs
 =ğ
NULL
) {

312  
VRT_ERROR
;

316 
i
 = 0; i < 
	`d¬¿y_n
(
bt
->
abgs
); i ++) {

317 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
bt
->
abgs
, 
i
);

318 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

319 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

321 
abs
->
cÚn_cÚ‹xts
 = 
	`d¬¿y_ü—‹
(1, (
cÚn_cÚ‹xt
));

322 
k
 = 0; k < 1; k ++) {

323 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_push
(
abs
->
cÚn_cÚ‹xts
);

324 ià(
	`back’d_cÚn_cÚ‹xt_š™
(
cc
,
abs
->
ho¡
,abs->
pÜt
è!ğ
VRT_OK
) {

325  
VRT_ERROR
;

327 
cc
->
aùx
->
d©a
 = 
bt
;

328 
	`»disAeA‰ach
(
bt
->
–
, 
cc
->
aùx
);

329 
	`»disAsyncS‘CÚÃùC®lback
(
cc
->
aùx
,
cÚÃù_ÿÎback
);

330 
	`»disAsyncS‘DiscÚÃùC®lback
(
cc
->
aùx
,
discÚÃù_ÿÎback
);

333 
abs
->
d©a
 = 
	`sk_d©a_ü—‹
();

337 ià(
	`«C»©eTimeEv’t
(
bt
->
–
, 1, 
back’d_th»ad_üÚ
, bt, 
NULL
è=ğ
AE_ERR
) {

338  
VRT_ERROR
;

341  
VRT_OK
;

342 
	}
}

344 
	$back’d_th»ad_deš™
(
back’d_th»ad
 *
bt
)

346 ià(
bt
->
–
) {

347 
	`«D–‘eEv’tLoİ
(
bt
->
–
);

348 
bt
->
–
 = 
NULL
;

351 ià(
bt
->
abgs
) {

352 
i
, 
j
, 
k
;

354 
i
 = 0; i < 
	`d¬¿y_n
(
bt
->
abgs
); i ++) {

355 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
bt
->
abgs
, 
i
);

356 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

357 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

358 
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) > 0) {

359 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_pİ
(
abs
->
cÚn_cÚ‹xts
);

360 
	`back’d_cÚn_cÚ‹xt_deš™
(
cc
);

363 ià(
abs
->
d©a
) {

364 
	`sk_d©a_de¡roy
(
abs
->
d©a
);

365 
abs
->
d©a
;

370 
	`ab‹¡_groups_de¡roy
(
bt
->
abgs
);

371 
bt
->
abgs
 = 
NULL
;

373 
	}
}

375 
	$v¹_back’d_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
)

377 
j
;

379 
back’d_th»ads_couÁ
 = 
th»ads_couÁ
;

380 
back’d_th»ads
 = 
	`d¬¿y_ü—‹
(
th»ads_couÁ
, (
back’d_th»ad
));

381 ià(
back’d_th»ads
 =ğ
NULL
) {

382  
VRT_ERROR
;

385 
j
 = 0; j < 
th»ads_couÁ
; j ++) {

386 
back’d_th»ad
 *
bt
 = 
	`d¬¿y_push
(
back’d_th»ads
);

387 ià(
	`back’d_th»ad_š™
(
bt
, 
‹¡_rg‘_groups
è!ğ
VRT_OK
) {

388  
VRT_ERROR
;

390 
bt
->
id
 = 
j
;

393  
VRT_OK
;

394 
	}
}

396 
	$v¹_back’d_deš™
()

398 ià(
back’d_th»ads
) {

399 
	`d¬¿y_n
(
back’d_th»ads
) > 0) {

400 
back’d_th»ad
 *
bt
 = 
	`d¬¿y_pİ
(
back’d_th»ads
);

401 
	`back’d_th»ad_deš™
(
bt
);

403 
	`d¬¿y_de¡roy
(
back’d_th»ads
);

404 
back’d_th»ads
 = 
NULL
;

406 
	}
}

408 *
	$v¹_back’d_th»ad_run
(*
¬gs
)

410 
back’d_th»ad
 *
bt
 = 
¬gs
;

411 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

413 
	`«Maš
(
bt
->
–
);

415  
NULL
;

416 
	}
}

418 
	$v¹_¡¬t_back’d
()

420 
i
;

421 
i
 = 0; i < 
	`d¬¿y_n
(
back’d_th»ads
); i ++) {

422 
±h»ad_©Œ_t
 
©Œ
;

423 
back’d_th»ad
 *
bt
;

424 
	`±h»ad_©Œ_š™
(&
©Œ
);

425 
bt
 = 
	`d¬¿y_g‘
(
back’d_th»ads
, 
i
);

426 
	`±h»ad_ü—‹
(&
bt
->
th»ad_id
,

427 &
©Œ
, 
v¹_back’d_th»ad_run
, 
bt
);

430  
VRT_OK
;

431 
	}
}

433 
	$v¹_wa™_back’d
()

435 
i
;

437 
i
 = 0; i < 
	`d¬¿y_n
(
back’d_th»ads
); i ++){

438 
back’d_th»ad
 *
bt
 = 
	`d¬¿y_g‘
(
back’d_th»ads
, 
i
);

439 
	`±h»ad_još
(
bt
->
th»ad_id
, 
NULL
);

442  
VRT_OK
;

443 
	}
}

	@tests/vrt_backend.h

1 #iâdeà
_VRT_BACKEND_H_


2 
	#_VRT_BACKEND_H_


	)

4 
	~<d¬¿y.h
>

6 
	gab‹¡_group
;

7 
	gdli¡
;

8 
	gdmi¡
;

9 
	gd©a_un™
;

10 
	g«Ev’tLoİ
;

12 
	sback’d_th»ad
 {

13 
	mid
;

14 
±h»ad_t
 
	mth»ad_id
;

16 
«Ev’tLoİ
 *
	m–
;

17 
	mhz
;

18 
	müÚloİs
;

20 
d¬¿y
 *
	mabgs
;

22 
	md–‘šg
;

23 
	m·u£
;

24 } 
	tback’d_th»ad
;

26 
back’d_th»ads_couÁ
;

28 
back’d_th»ads_·u£_fšished_couÁ
;

30 
v¹_back’d_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
);

31 
v¹_back’d_deš™
();

33 
v¹_¡¬t_back’d
();

34 
v¹_wa™_back’d
();

	@tests/vrt_benchmark.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<as£¹.h
>

9 
	~<sys/¡©.h
>

10 
	~<sys/ut¢ame.h
>

12 
	~<«.h
>

14 
	~<hœedis.h
>

15 
	~<sds.h
>

17 
	~<d¬¿y.h
>

18 
	~<dli¡.h
>

19 
	~<dut.h
>

20 
	~<dlog.h
>

22 
	~<v¹_ut.h
>

23 
	~<v¹_public.h
>

24 
	~<himemÿched.h
>

26 
	#TEST_CMD_PROTOCOL_REDIS
 0

	)

27 
	#TEST_CMD_PROTOCOL_MEMCACHE
 1

	)

29 
	#RANDPTR_INITIAL_SIZE
 8

	)

31 
	scÚfig
 {

32 cÚ¡ *
	mho¡
;

33 
	mho¡pÜt
;

34 cÚ¡ *
	mho¡sock‘
;

35 
	mnumş›Ás
;

36 
	mliveş›Ás
;

37 
	m»que¡s
;

38 
	m»que¡s_issued
;

39 
	m»que¡s_fšished
;

40 
	mkeysize
;

41 
	md©asize
;

42 
	m¿ndomkeys
;

43 
	m¿ndomkeys_key¥aûËn
;

44 
	mk“·live
;

45 
	mp–še
;

46 
	mshow”rÜs
;

47 
	m¡¬t
;

48 
	mtÙÏ‹ncy
;

49 *
	mÏ‹ncy
;

50 cÚ¡ *
	mt™Ë
;

51 
	mqu›t
;

52 
	mcsv
;

53 
	mloİ
;

54 
	midËmode
;

55 
	mdbnum
;

56 
sds
 
	mdbnum¡r
;

57 *
	m‹¡s
;

58 *
	mauth
;

59 
	mth»ads_couÁ
;

60 
	m´ÙocŞ
;

61 
	mnošlše
;

62 } 
	gcÚfig
;

64 
	sb’chm¬k_th»ad
 {

65 
	mid
;

66 
±h»ad_t
 
	mth»ad_id
;

68 
«Ev’tLoİ
 *
	m–
;

69 
	mhz
;

70 
	müÚloİs
;

72 
dli¡
 *
	mş›Ás
;

73 
	mnumş›Ás
;

74 
	mliveş›Ás
;

76 
	m»que¡s
;

77 
	m»que¡s_issued
;

78 
	m»que¡s_fšished
;

80 
	m¡¬t
;

81 
	mtÙÏ‹ncy
;

82 *
	mÏ‹ncy
;

83 } 
	tb’chm¬k_th»ad
;

85 
	s_b’chm¬k_ş›Á
 {

86 
b’chm¬k_th»ad
 *
	mbt
;

88 
»disCÚ‹xt
 *
	mrc
;

89 
mcCÚ‹xt
 *
	mmc
;

90 
sds
 
	mobuf
;

91 **
	m¿nd±r
;

92 
size_t
 
	m¿ndËn
;

93 
size_t
 
	m¿ndä“
;

94 
size_t
 
	mwr™‹n
;

95 
	m¡¬t
;

96 
	mÏ‹ncy
;

97 
	m³ndšg
;

98 
	m´efix_³ndšg
;

101 
	m´efixËn
;

102 } *
	tb’chm¬k_ş›Á
;

104 
d¬¿y
 *
	gbts
;

107 
wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

108 
b’chm¬k_ş›Á
 
ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, b’chm¬k_ş›Á 
äom
, 
b’chm¬k_th»ad
 *
th»ad
);

109 
ü—‹MissšgCl›Ás
(
b’chm¬k_ş›Á
 
c
);

110 
showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
);

112 
	$ä“Cl›Á
(
b’chm¬k_ş›Á
 
c
) {

113 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

114 
dli¡Node
 *
Ê
;

116 ià(
bt
->
–
) {

117 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
);

118 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
);

120 
	`»disF»e
(
c
->
rc
);

121 ià(
c
->
mc
) {

122 
c
->
mc
->
fd
 = -1;

123 
	`memÿchedF»e
(
c
->
mc
);

125 
	`sdsä“
(
c
->
obuf
);

126 
	`ä“
(
c
->
¿nd±r
);

127 
	`ä“
(
c
);

128 
	`upd©e_¡©e_sub
(
bt
->
liveş›Ás
,1);

129 
Ê
 = 
	`dli¡S—rchKey
(
bt
->
ş›Ás
,
c
);

130 
	`ASSERT
(
Ê
 !ğ
NULL
);

131 
	`dli¡D–Node
(
bt
->
ş›Ás
,
Ê
);

132 
	}
}

134 
	$ä“AÎCl›Ás
(
dli¡
 *
ş›Ás
) {

135 
dli¡Node
 *
Ê
 = 
ş›Ás
->
h—d
, *
Ãxt
;

137 
Ê
) {

138 
Ãxt
 = 
Ê
->next;

139 
	`ä“Cl›Á
(
Ê
->
v®ue
);

140 
Ê
 = 
Ãxt
;

142 
	}
}

144 
	$»£tCl›Á
(
b’chm¬k_ş›Á
 
c
) {

145 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

147 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
);

148 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
);

149 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

150 
c
->
wr™‹n
 = 0;

151 
c
->
³ndšg
 = 
cÚfig
.
p–še
;

152 
	}
}

154 
	$¿ndomizeCl›ÁKey
(
b’chm¬k_ş›Á
 
c
) {

155 
size_t
 
i
;

157 
i
 = 0; i < 
c
->
¿ndËn
; i++) {

158 *
p
 = 
c
->
¿nd±r
[
i
]+11;

159 
size_t
 
r
 = 
	`¿ndom
(è% 
cÚfig
.
¿ndomkeys_key¥aûËn
;

160 
size_t
 
j
;

162 
j
 = 0; j < 12; j++) {

163 *
p
 = '0'+
r
%10;

164 
r
/=10;

165 
p
--;

168 
	}
}

170 
	$ş›ÁDÚe
(
b’chm¬k_ş›Á
 
c
) {

171 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

172 
»que¡s_fšished
;

174 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&requests_finished);

175 ià(
»que¡s_fšished
 =ğ
bt
->
»que¡s
) {

176 
	`ä“Cl›Á
(
c
);

177 
	`«Stİ
(
bt
->
–
);

180 ià(
cÚfig
.
k“·live
) {

181 
	`»£tCl›Á
(
c
);

183 
	`upd©e_¡©e_sub
(
bt
->
liveş›Ás
,1);

184 
	`ü—‹MissšgCl›Ás
(
c
);

185 
	`upd©e_¡©e_add
(
bt
->
liveş›Ás
,1);

186 
	`ä“Cl›Á
(
c
);

188 
	}
}

190 
	$b’chm¬k_th»ad_š™
(
b’chm¬k_th»ad
 *
bt
, 
»que¡s
, 
numş›Ás
, *
cmd
, 
size_t
 
Ën
)

192 
b’chm¬k_ş›Á
 
c
;

194 
bt
->
th»ad_id
 = 0;

195 
bt
->
–
 = 
NULL
;

196 
bt
->
hz
 = 10;

197 
bt
->
üÚloİs
 = 0;

198 
bt
->
ş›Ás
 = 
NULL
;

199 
bt
->
numş›Ás
 =‚umclients;

200 
bt
->
liveş›Ás
 = 0;

201 
bt
->
»que¡s
 =„equests;

202 
bt
->
»que¡s_issued
 = 0;

203 
bt
->
»que¡s_fšished
 = 0;

204 
bt
->
¡¬t
 = 0;

205 
bt
->
tÙÏ‹ncy
 = 0;

206 
bt
->
Ï‹ncy
 = 
NULL
;

208 
bt
->
–
 = 
	`«C»©eEv’tLoİ
(1024*10);

209 ià(
bt
->
–
 =ğ
NULL
) {

210  
VRT_ERROR
;

213 
bt
->
ş›Ás
 = 
	`dli¡C»©e
();

214 ià(
bt
->
ş›Ás
 =ğ
NULL
) {

215  
VRT_ERROR
;

218 
bt
->
Ï‹ncy
 = 
	`m®loc
(()*bt->
»que¡s
);

220 
c
 = 
	`ü—‹Cl›Á
(
cmd
,
Ën
,
NULL
,
bt
);

221 
	`ü—‹MissšgCl›Ás
(
c
);

223 ià(
bt
->
id
 == 0) {

224 
	`«C»©eTimeEv’t
(
bt
->
–
,1,
showThroughput
,
NULL
,NULL);

227  
VRT_OK
;

228 
	}
}

230 
	$b’chm¬k_th»ad_deš™
(
b’chm¬k_th»ad
 *
bt
)

232 ià(
bt
->
ş›Ás
) {

233 
	`ä“AÎCl›Ás
(
bt
->
ş›Ás
);

234 
	`dli¡R–—£
(
bt
->
ş›Ás
);

235 
bt
->
ş›Ás
 = 
NULL
;

238 ià(
bt
->
–
) {

239 
	`«D–‘eEv’tLoİ
(
bt
->
–
);

240 
bt
->
–
 = 
NULL
;

243 ià(
bt
->
Ï‹ncy
) {

244 
	`ä“
(
bt
->
Ï‹ncy
);

245 
bt
->
Ï‹ncy
 = 
NULL
;

247 
	}
}

249 *
	$b’chm¬k_th»ad_run
(*
¬gs
)

251 
b’chm¬k_th»ad
 *
bt
 = 
¬gs
;

252 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

254 
	`«Maš
(
bt
->
–
);

256  
NULL
;

257 
	}
}

259 
	$¡¬t_b’chm¬k_th»ads_uÁ_fšish
()

261 
i
;

262 
b’chm¬k_th»ad
 *
bt
;

264 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

265 
±h»ad_©Œ_t
 
©Œ
;

266 
	`±h»ad_©Œ_š™
(&
©Œ
);

267 
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

268 
	`±h»ad_ü—‹
(&
bt
->
th»ad_id
,

269 &
©Œ
, 
b’chm¬k_th»ad_run
, 
bt
);

272 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

273 
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

274 
	`±h»ad_još
(
bt
->
th»ad_id
, 
NULL
);

277  
VRT_OK
;

278 
	}
}

280 
	$»adHªdËrMC
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

281 
b’chm¬k_ş›Á
 
c
 = 
´ivd©a
;

282 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

283 
mcCÚ‹xt
 *
mc
 = 
c
->mc;

284 
»que¡s_fšished
;

285 *
»¶y
 = 
NULL
;

286 
	`UNUSED
(
–
);

287 
	`UNUSED
(
fd
);

288 
	`UNUSED
(
mask
);

293 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`du£c_now
()-(c->
¡¬t
);

295 ià(
	`memÿchedBufãrR—d
(
mc
è!ğ
MC_OK
) {

296 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
mc
->
”r¡r
);

297 
	`ex™
(1);

299 
c
->
³ndšg
) {

300 ià(
	`memÿchedG‘R•ly
(
mc
,&
»¶y
è!ğ
MC_OK
) {

301 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
mc
->
”r¡r
);

302 
	`ex™
(1);

305 ià(
»¶y
 !ğ
NULL
) {

306 ià(
»¶y
 =ğ(*)
MC_REPLY_ERROR
) {

307 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

308 
	`ex™
(1);

311 ià(
cÚfig
.
show”rÜs
) {

312 
time_t
 
Ï¡”r_time
 = 0;

313 
time_t
 
now
 = 
	`time
(
NULL
);

314 
mcR•ly
 *
r
 = 
»¶y
;

315 ià(
r
->
ty³
 =ğ
MC_REPLY_ERROR
 && 
Ï¡”r_time
 !ğ
now
) {

316 
Ï¡”r_time
 = 
now
;

317 
	`´štf
("E¼Ü from s”v”: %s\n", 
r
->
¡r
);

321 
	`ä“McR•lyObjeù
(
»¶y
);

323 ià(
c
->
´efix_³ndšg
 > 0) {

324 
c
->
´efix_³ndšg
--;

325 
c
->
³ndšg
--;

327 ià(
c
->
´efixËn
 > 0) {

328 
size_t
 
j
;

329 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

332 
j
 = 0; j < 
c
->
¿ndËn
; j++)

333 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

334 
c
->
´efixËn
 = 0;

339 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&requests_finished);

340 ià(
»que¡s_fšished
 < 
bt
->
»que¡s
) {

341 
bt
->
Ï‹ncy
[
»que¡s_fšished
] = 
c
->latency;

342 
	`upd©e_¡©e_add
(
bt
->
»que¡s_fšished
,1);

344 
c
->
³ndšg
--;

345 ià(
c
->
³ndšg
 == 0) {

346 
	`ş›ÁDÚe
(
c
);

354 
	}
}

356 
	$»adHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

357 
b’chm¬k_ş›Á
 
c
 = 
´ivd©a
;

358 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

359 
»que¡s_fšished
;

360 *
»¶y
 = 
NULL
;

361 
	`UNUSED
(
–
);

362 
	`UNUSED
(
fd
);

363 
	`UNUSED
(
mask
);

368 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`du£c_now
()-(c->
¡¬t
);

370 ià(
	`»disBufãrR—d
(
c
->
rc
è!ğ
REDIS_OK
) {

371 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
rc
->
”r¡r
);

372 
	`ex™
(1);

374 
c
->
³ndšg
) {

375 ià(
	`»disG‘R•ly
(
c
->
rc
,&
»¶y
è!ğ
REDIS_OK
) {

376 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
rc
->
”r¡r
);

377 
	`ex™
(1);

379 ià(
»¶y
 !ğ
NULL
) {

380 ià(
»¶y
 =ğ(*)
REDIS_REPLY_ERROR
) {

381 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

382 
	`ex™
(1);

385 ià(
cÚfig
.
show”rÜs
) {

386 
time_t
 
Ï¡”r_time
 = 0;

387 
time_t
 
now
 = 
	`time
(
NULL
);

388 
»disR•ly
 *
r
 = 
»¶y
;

389 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
 && 
Ï¡”r_time
 !ğ
now
) {

390 
Ï¡”r_time
 = 
now
;

391 
	`´štf
("E¼Ü from s”v”: %s\n", 
r
->
¡r
);

395 
	`ä“R•lyObjeù
(
»¶y
);

397 ià(
c
->
´efix_³ndšg
 > 0) {

398 
c
->
´efix_³ndšg
--;

399 
c
->
³ndšg
--;

401 ià(
c
->
´efixËn
 > 0) {

402 
size_t
 
j
;

403 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

406 
j
 = 0; j < 
c
->
¿ndËn
; j++)

407 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

408 
c
->
´efixËn
 = 0;

413 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&requests_finished);

414 ià(
»que¡s_fšished
 < 
bt
->
»que¡s
) {

415 
bt
->
Ï‹ncy
[
»que¡s_fšished
] = 
c
->latency;

416 
	`upd©e_¡©e_add
(
bt
->
»que¡s_fšished
,1);

418 
c
->
³ndšg
--;

419 ià(
c
->
³ndšg
 == 0) {

420 
	`ş›ÁDÚe
(
c
);

428 
	}
}

430 
	$wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

431 
b’chm¬k_ş›Á
 
c
 = 
´ivd©a
;

432 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

433 
	`UNUSED
(
–
);

434 
	`UNUSED
(
fd
);

435 
	`UNUSED
(
mask
);

438 ià(
c
->
wr™‹n
 == 0) {

440 ià(
bt
->
»que¡s_issued
++ >ğbt->
»que¡s
) {

441 
	`ä“Cl›Á
(
c
);

446 ià(
cÚfig
.
¿ndomkeys
è
	`¿ndomizeCl›ÁKey
(
c
);

447 
c
->
¡¬t
 = 
	`du£c_now
();

448 
c
->
Ï‹ncy
 = -1;

451 ià(
	`sd¦’
(
c
->
obuf
è> c->
wr™‹n
) {

452 *
±r
 = 
c
->
obuf
+c->
wr™‹n
;

453 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
c
->
rc
->
fd
,
±r
,
	`sd¦’
(c->
obuf
)-c->
wr™‹n
);

455 ià(
nwr™‹n
 == -1) {

456 ià(
”ºo
 !ğ
EPIPE
)

457 
	`årštf
(
¡d”r
, "Wr™šgØsock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

458 
	`ä“Cl›Á
(
c
);

461 
c
->
wr™‹n
 +ğ
nwr™‹n
;

462 ià(
	`sd¦’
(
c
->
obuf
è=ğc->
wr™‹n
) {

463 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
);

464 ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_REDIS
) {

465 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
,
»adHªdËr
,c);

466 } ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_MEMCACHE
) {

467 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
,
»adHªdËrMC
,c);

469 
	`NOT_REACHED
();

473 
	}
}

496 
b’chm¬k_ş›Á
 
	$ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, 
b’chm¬k_ş›Á
 
äom
, 
b’chm¬k_th»ad
 *
th»ad
) {

497 
j
;

498 
b’chm¬k_th»ad
 *
bt
;

499 
b’chm¬k_ş›Á
 
c
 = 
	`m®loc
((
_b’chm¬k_ş›Á
));

501 
c
->
bt
 = 
NULL
;

502 
c
->
rc
 = 
NULL
;

503 
c
->
mc
 = 
NULL
;

504 
c
->
obuf
 = 
NULL
;

505 
c
->
¿nd±r
 = 
NULL
;

506 
c
->
¿ndËn
 = 0;

507 
c
->
¿ndä“
 = 0;

508 
c
->
wr™‹n
 = 0;

509 
c
->
¡¬t
 = 0;

510 
c
->
Ï‹ncy
 = 0;

511 
c
->
³ndšg
 = 0;

512 
c
->
´efix_³ndšg
 = 0;

513 
c
->
´efixËn
 = 0;

515 ià(
äom
 =ğ
NULL
) {

516 
	`ASSERT
(
th»ad
 !ğ
NULL
);

517 
bt
 = 
th»ad
;

519 
bt
 = 
äom
->bt;

522 
c
->
bt
 = bt;

524 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

525 
c
->
rc
 = 
	`»disCÚÃùNÚBlock
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

527 
c
->
rc
 = 
	`»disCÚÃùUnixNÚBlock
(
cÚfig
.
ho¡sock‘
);

529 ià(
c
->
rc
->
”r
) {

530 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

531 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

532 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
c
->
rc
->
”r¡r
);

534 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
c
->
rc
->
”r¡r
);

535 
	`ex™
(1);

538 
c
->
rc
->
»ad”
->
maxbuf
 = 0;

543 
c
->
obuf
 = 
	`sd£m±y
();

547 
c
->
´efix_³ndšg
 = 0;

548 ià(
cÚfig
.
auth
) {

549 *
buf
 = 
NULL
;

550 
Ën
 = 
	`»disFÜm©Commªd
(&
buf
, "AUTH %s", 
cÚfig
.
auth
);

551 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf, 
buf
, 
Ën
);

552 
	`ä“
(
buf
);

553 
c
->
´efix_³ndšg
++;

560 ià(
cÚfig
.
dbnum
 != 0) {

561 
c
->
obuf
 = 
	`sdsÿrštf
(c->obuf,"*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n",

562 ()
	`sd¦’
(
cÚfig
.
dbnum¡r
),config.dbnumstr);

563 
c
->
´efix_³ndšg
++;

565 
c
->
´efixËn
 = 
	`sd¦’
(c->
obuf
);

567 ià(
äom
) {

568 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,

569 
äom
->
obuf
+äom->
´efixËn
,

570 
	`sd¦’
(
äom
->
obuf
)-äom->
´efixËn
);

572 
j
 = 0; j < 
cÚfig
.
p–še
; j++)

573 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,
cmd
,
Ën
);

576 
c
->
wr™‹n
 = 0;

577 
c
->
³ndšg
 = 
cÚfig
.
p–še
+c->
´efix_³ndšg
;

578 
c
->
¿nd±r
 = 
NULL
;

579 
c
->
¿ndËn
 = 0;

582 ià(
cÚfig
.
¿ndomkeys
) {

583 ià(
äom
) {

584 
c
->
¿ndËn
 = 
äom
->randlen;

585 
c
->
¿ndä“
 = 0;

586 
c
->
¿nd±r
 = 
	`m®loc
((*)*c->
¿ndËn
);

588 
j
 = 0; j < ()
c
->
¿ndËn
; j++) {

589 
c
->
¿nd±r
[
j
] = c->
obuf
 + (
äom
->randptr[j]-from->obuf);

591 
c
->
¿nd±r
[
j
] +ğc->
´efixËn
 - 
äom
->prefixlen;

594 *
p
 = 
c
->
obuf
;

596 
c
->
¿ndËn
 = 0;

597 
c
->
¿ndä“
 = 
RANDPTR_INITIAL_SIZE
;

598 
c
->
¿nd±r
 = 
	`m®loc
((*)*c->
¿ndä“
);

599 (
p
 = 
	`¡r¡r
Õ,"__¿nd_št__")è!ğ
NULL
) {

600 ià(
c
->
¿ndä“
 == 0) {

601 
c
->
¿nd±r
 = 
	`»®loc
(c->¿nd±r,(*)*c->
¿ndËn
*2);

602 
c
->
¿ndä“
 +ğc->
¿ndËn
;

604 
c
->
¿nd±r
[c->
¿ndËn
++] = 
p
;

605 
c
->
¿ndä“
--;

606 
p
 += 12;

610 ià(
cÚfig
.
idËmode
 == 0)

611 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

614 ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_MEMCACHE
) {

615 
c
->
mc
 = 
	`memÿchedCÚ‹xtIn™
();

616 
c
->
mc
->
fd
 = c->
rc
->fd;

617 
c
->
mc
->
æags
 &ğ~
MC_BLOCK
;

620 
	`dli¡AddNodeTa
(
bt
->
ş›Ás
,
c
);

621 
	`upd©e_¡©e_add
(
bt
->
liveş›Ás
,1);

623  
c
;

624 
	}
}

626 
	$ü—‹MissšgCl›Ás
(
b’chm¬k_ş›Á
 
c
) {

627 
n
 = 0;

628 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

629 
liveş›Ás
;

631 
	`upd©e_¡©e_g‘
(
bt
->
liveş›Ás
,&liveclients);

633 
liveş›Ás
 < 
bt
->
numş›Ás
) {

634 
	`ü—‹Cl›Á
(
NULL
,0,
c
,NULL);

637 ià(++
n
 > 64) {

638 
	`u¦“p
(50000);

639 
n
 = 0;

641 
	`upd©e_¡©e_g‘
(
bt
->
liveş›Ás
,&liveclients);

643 
	}
}

645 
	$com·»L©’cy
(cÚ¡ *
a
, cÚ¡ *
b
) {

646  (*(*)
a
)-(*(*)
b
);

647 
	}
}

649 
	$upd©eB’chm¬kSts
()

651 
i
;

652 
couÁ
;

654 
cÚfig
.
liveş›Ás
 = 0;

655 
cÚfig
.
»que¡s_fšished
 = 0;

657 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

658 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

659 
	`upd©e_¡©e_g‘
(
bt
->
liveş›Ás
,&
couÁ
);

660 
cÚfig
.
liveş›Ás
 +ğ
couÁ
;

661 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&
couÁ
);

662 
cÚfig
.
»que¡s_fšished
 +ğ
couÁ
;

664 
	}
}

666 
	$showL©’cyR•Üt
() {

667 
i
, 
j
, 
cu¾©
 = 0;

668 
n
 = 0;

669 
³rc
, 
»q³r£c
;

671 
	`upd©eB’chm¬kSts
();

673 
»q³r£c
 = ()
cÚfig
.
»que¡s_fšished
/(()cÚfig.
tÙÏ‹ncy
/1000);

674 ià(!
cÚfig
.
qu›t
 && !cÚfig.
csv
) {

675 
	`´štf
("=====ğ% ======\n", 
cÚfig
.
t™Ë
);

676 
	`´štf
(" %d„eque¡ com¶‘ed iÀ%.2à£cÚds\n", 
cÚfig
.
»que¡s_fšished
,

677 ()
cÚfig
.
tÙÏ‹ncy
/1000);

678 
	`´štf
(" %d…¬®ËÈş›Ás\n", 
cÚfig
.
numş›Ás
);

679 
	`´štf
(" %d by‹ ·ylßd\n", 
cÚfig
.
d©asize
);

680 
	`´štf
(" k“°®ive: %d\n", 
cÚfig
.
k“·live
);

681 
	`´štf
("\n");

683 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i++) {

684 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

685 
j
 = 0; j < 
bt
->
»que¡s
; j ++) {

686 
cÚfig
.
Ï‹ncy
[
n
++] = 
bt
->Ï‹ncy[
j
];

690 
	`qsÜt
(
cÚfig
.
Ï‹ncy
,cÚfig.
»que¡s
,(),
com·»L©’cy
);

691 
i
 = 0; i < 
cÚfig
.
»que¡s
; i++) {

692 ià(
cÚfig
.
Ï‹ncy
[
i
]/1000 !ğ
cu¾©
 || i =ğ(cÚfig.
»que¡s
-1)) {

693 
cu¾©
 = 
cÚfig
.
Ï‹ncy
[
i
]/1000;

694 
³rc
 = (()(
i
+1)*100)/
cÚfig
.
»que¡s
;

695 
	`´štf
("%.2f%% <ğ%d mli£cÚds\n", 
³rc
, 
cu¾©
);

698 
	`´štf
("%.2à»que¡ ³¸£cÚd\n\n", 
»q³r£c
);

699 } ià(
cÚfig
.
csv
) {

700 
	`´štf
("\"%s\",\"%.2f\"\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

702 
	`´štf
("%s: %.2à»que¡ ³¸£cÚd\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

704 
	}
}

706 
	$b’chm¬k
(*
t™Ë
, *
cmd
, 
Ën
) {

707 
i
;

708 
»que¡s_³r_th»ad
, 
»que¡s_»mašd”
;

709 
ş›Ás_³r_th»ad
, 
ş›Ás_»mašd”
;

710 
b’chm¬k_ş›Á
 
c
;

712 
cÚfig
.
t™Ë
 =itle;

713 
cÚfig
.
»que¡s_issued
 = 0;

714 
cÚfig
.
»que¡s_fšished
 = 0;

717 ià(
cÚfig
.
th»ads_couÁ
 <= 0) {

718 
	`´štf
("ERROR:hreads count‚eed biggerhan zero\n");

720 
bts
 = 
	`d¬¿y_ü—‹
(
cÚfig
.
th»ads_couÁ
, (
b’chm¬k_th»ad
));

721 
»que¡s_³r_th»ad
 = 
cÚfig
.
»que¡s
/cÚfig.
th»ads_couÁ
;

722 
»que¡s_»mašd”
 = 
cÚfig
.
»que¡s
%cÚfig.
th»ads_couÁ
;

723 
ş›Ás_³r_th»ad
 = 
cÚfig
.
numş›Ás
/cÚfig.
th»ads_couÁ
;

724 
ş›Ás_»mašd”
 = 
cÚfig
.
numş›Ás
%cÚfig.
th»ads_couÁ
;

725 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

726 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_push
(
bts
);

727 
bt
->
id
 = 
i
;

728 
	`b’chm¬k_th»ad_š™
(
bt
,

729 
»que¡s_»mašd”
-->0?
»que¡s_³r_th»ad
+1:requests_per_thread,

730 
ş›Ás_»mašd”
-->0?
ş›Ás_³r_th»ad
+1:clients_per_thread,

731 
cmd
,
Ën
);

734 
cÚfig
.
¡¬t
 = 
	`dm£c_now
();

735 
	`¡¬t_b’chm¬k_th»ads_uÁ_fšish
();

736 
cÚfig
.
tÙÏ‹ncy
 = 
	`dm£c_now
()-cÚfig.
¡¬t
;

738 
	`showL©’cyR•Üt
();

740 
	`d¬¿y_n
(
bts
) > 0) {

741 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_pİ
(
bts
);

742 
	`b’chm¬k_th»ad_deš™
(
bt
);

744 
	`d¬¿y_de¡roy
(
bts
);

745 
bts
 = 
NULL
;

746 
	}
}

749 
	$·r£O±iÚs
(
¬gc
, cÚ¡ **
¬gv
) {

750 
i
;

751 
Ï¡¬g
;

752 
ex™_¡©us
 = 1;

754 
i
 = 1; i < 
¬gc
; i++) {

755 
Ï¡¬g
 = (
i
 =ğ(
¬gc
-1));

757 ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

758 ià(
Ï¡¬g
è
šv®id
;

759 
cÚfig
.
numş›Ás
 = 
	`©oi
(
¬gv
[++
i
]);

760 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n")) {

761 ià(
Ï¡¬g
è
šv®id
;

762 
cÚfig
.
»que¡s
 = 
	`©oi
(
¬gv
[++
i
]);

763 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-k")) {

764 ià(
Ï¡¬g
è
šv®id
;

765 
cÚfig
.
k“·live
 = 
	`©oi
(
¬gv
[++
i
]);

766 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h")) {

767 ià(
Ï¡¬g
è
šv®id
;

768 
cÚfig
.
ho¡
 = 
	`¡rdup
(
¬gv
[++
i
]);

769 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p")) {

770 ià(
Ï¡¬g
è
šv®id
;

771 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

772 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s")) {

773 ià(
Ï¡¬g
è
šv®id
;

774 
cÚfig
.
ho¡sock‘
 = 
	`¡rdup
(
¬gv
[++
i
]);

775 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a") ) {

776 ià(
Ï¡¬g
è
šv®id
;

777 
cÚfig
.
auth
 = 
	`¡rdup
(
¬gv
[++
i
]);

778 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d")) {

779 ià(
Ï¡¬g
è
šv®id
;

780 
cÚfig
.
d©asize
 = 
	`©oi
(
¬gv
[++
i
]);

781 ià(
cÚfig
.
d©asize
 < 1) config.datasize=1;

782 ià(
cÚfig
.
d©asize
 > 1024*1024*1024) config.datasize = 1024*1024*1024;

783 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-P")) {

784 ià(
Ï¡¬g
è
šv®id
;

785 
cÚfig
.
p–še
 = 
	`©oi
(
¬gv
[++
i
]);

786 ià(
cÚfig
.
p–še
 <= 0) config.pipeline=1;

787 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r")) {

788 ià(
Ï¡¬g
è
šv®id
;

789 
cÚfig
.
¿ndomkeys
 = 1;

790 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 
	`©oi
(
¬gv
[++
i
]);

791 ià(
cÚfig
.
¿ndomkeys_key¥aûËn
 < 0)

792 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

793 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-q")) {

794 
cÚfig
.
qu›t
 = 1;

795 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

796 
cÚfig
.
csv
 = 1;

797 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-l")) {

798 
cÚfig
.
loİ
 = 1;

799 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-I")) {

800 
cÚfig
.
idËmode
 = 1;

801 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-e")) {

802 
cÚfig
.
show”rÜs
 = 1;

803 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-t")) {

804 ià(
Ï¡¬g
è
šv®id
;

810 
cÚfig
.
‹¡s
 = 
	`sd¢ew
(",");

811 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(cÚfig.‹¡s,(*)
¬gv
[++
i
]);

812 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(config.tests,",");

813 
	`sd¡Şow”
(
cÚfig
.
‹¡s
);

814 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--dbnum")) {

815 ià(
Ï¡¬g
è
šv®id
;

816 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

817 
cÚfig
.
dbnum¡r
 = 
	`sdsäomlÚglÚg
(cÚfig.
dbnum
);

818 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-T")) {

819 ià(
Ï¡¬g
è
šv®id
;

820 
cÚfig
.
th»ads_couÁ
 = 
	`©oi
(
¬gv
[++
i
]);

821 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-m")) {

822 
cÚfig
.
´ÙocŞ
 = 
TEST_CMD_PROTOCOL_MEMCACHE
;

823 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--noinline")) {

824 
cÚfig
.
nošlše
 = 1;

825 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

826 
ex™_¡©us
 = 0;

827 
u§ge
;

832 ià(
¬gv
[
i
][0] =ğ'-'è
šv®id
;

833  
i
;

837  
i
;

839 
šv®id
:

840 
	`´štf
("Inv®id o±iÚ \"%s\" o¸İtiÚ‡rgum’ˆmissšg\n\n",
¬gv
[
i
]);

842 
u§ge
:

843 
	`´štf
(

888 
	`ex™
(
ex™_¡©us
);

889 
	}
}

891 
	$showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

892 
	`UNUSED
(
ev’tLoİ
);

893 
	`UNUSED
(
id
);

894 
	`UNUSED
(
ş›ÁD©a
);

896 
	`upd©eB’chm¬kSts
();

898 ià(
cÚfig
.
liveş›Ás
 == 0) {

899 
	`årštf
(
¡d”r
,"All clients disconnected...‡borting.\n");

900 
	`ex™
(1);

902 ià(
cÚfig
.
csv
)  250;

903 ià(
cÚfig
.
idËmode
 == 1) {

904 
	`´štf
("ş›Ás: %d\r", 
cÚfig
.
liveş›Ás
);

905 
	`fæush
(
¡dout
);

908 
dt
 = ()(
	`dm£c_now
()-
cÚfig
.
¡¬t
)/1000.0;

909 
½s
 = ()
cÚfig
.
»que¡s_fšished
/
dt
;

910 
	`´štf
("%s: %.2f\r", 
cÚfig
.
t™Ë
, 
½s
);

911 
	`fæush
(
¡dout
);

913 
	}
}

917 
	$‹¡_is_£Ëùed
(*
Çme
) {

918 
buf
[256];

919 
l
 = 
	`¡¾’
(
Çme
);

921 ià(
cÚfig
.
‹¡s
 =ğ
NULL
)  1;

922 
buf
[0] = ',';

923 
	`memıy
(
buf
+1,
Çme
,
l
);

924 
buf
[
l
+1] = ',';

925 
buf
[
l
+2] = '\0';

926  
	`¡r¡r
(
cÚfig
.
‹¡s
,
buf
è!ğ
NULL
;

927 
	}
}

929 
	$‹¡_»dis
(
¬gc
, cÚ¡ **
¬gv
)

931 
i
;

932 *
d©a
, *
cmd
;

933 
Ën
;

936 ià(
¬gc
) {

937 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

938 
i
 = 1; i < 
¬gc
; i++) {

939 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

940 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

944 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

945 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

946 
	`ä“
(
cmd
);

947 } 
cÚfig
.
loİ
);

953 
d©a
 = 
	`m®loc
(
cÚfig
.
d©asize
+1);

955 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

956 
d©a
[
cÚfig
.
d©asize
] = '\0';

958 ià(!
cÚfig
.
nošlše
 && (
	`‹¡_is_£Ëùed
("ping_inline") ||est_is_selected("ping")))

959 
	`b’chm¬k
("PING_INLINE","PING\r\n",6);

961 ià(
	`‹¡_is_£Ëùed
("ping_mbulk") ||est_is_selected("ping")) {

962 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"PING");

963 
	`b’chm¬k
("PING_BULK",
cmd
,
Ën
);

964 
	`ä“
(
cmd
);

967 ià(
	`‹¡_is_£Ëùed
("set")) {

968 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET key:__¿nd_št__ %s",
d©a
);

969 
	`b’chm¬k
("SET",
cmd
,
Ën
);

970 
	`ä“
(
cmd
);

973 ià(
	`‹¡_is_£Ëùed
("get")) {

974 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"GET key:__rand_int__");

975 
	`b’chm¬k
("GET",
cmd
,
Ën
);

976 
	`ä“
(
cmd
);

979 ià(
	`‹¡_is_£Ëùed
("incr")) {

980 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"INCR counter:__rand_int__");

981 
	`b’chm¬k
("INCR",
cmd
,
Ën
);

982 
	`ä“
(
cmd
);

985 ià(
	`‹¡_is_£Ëùed
("lpush")) {

986 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

987 
	`b’chm¬k
("LPUSH",
cmd
,
Ën
);

988 
	`ä“
(
cmd
);

991 ià(
	`‹¡_is_£Ëùed
("rpush")) {

992 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPUSH myli¡ %s",
d©a
);

993 
	`b’chm¬k
("RPUSH",
cmd
,
Ën
);

994 
	`ä“
(
cmd
);

997 ià(
	`‹¡_is_£Ëùed
("lpop")) {

998 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPOP mylist");

999 
	`b’chm¬k
("LPOP",
cmd
,
Ën
);

1000 
	`ä“
(
cmd
);

1003 ià(
	`‹¡_is_£Ëùed
("rpop")) {

1004 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPOP mylist");

1005 
	`b’chm¬k
("RPOP",
cmd
,
Ën
);

1006 
	`ä“
(
cmd
);

1009 ià(
	`‹¡_is_£Ëùed
("sadd")) {

1010 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,

1012 
	`b’chm¬k
("SADD",
cmd
,
Ën
);

1013 
	`ä“
(
cmd
);

1016 ià(
	`‹¡_is_£Ëùed
("spop")) {

1017 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SPOP myset");

1018 
	`b’chm¬k
("SPOP",
cmd
,
Ën
);

1019 
	`ä“
(
cmd
);

1022 ià(
	`‹¡_is_£Ëùed
("lrange") ||

1023 
	`‹¡_is_£Ëùed
("lrange_100") ||

1024 
	`‹¡_is_£Ëùed
("lrange_300") ||

1025 
	`‹¡_is_£Ëùed
("lrange_500") ||

1026 
	`‹¡_is_£Ëùed
("lrange_600"))

1028 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

1029 
	`b’chm¬k
("LPUSH (ÃededØb’chm¬k LRANGE)",
cmd
,
Ën
);

1030 
	`ä“
(
cmd
);

1033 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_100")) {

1034 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 99");

1035 
	`b’chm¬k
("LRANGE_100 (fœ¡ 100ƒËm’ts)",
cmd
,
Ën
);

1036 
	`ä“
(
cmd
);

1039 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_300")) {

1040 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 299");

1041 
	`b’chm¬k
("LRANGE_300 (fœ¡ 300ƒËm’ts)",
cmd
,
Ën
);

1042 
	`ä“
(
cmd
);

1045 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_500")) {

1046 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 449");

1047 
	`b’chm¬k
("LRANGE_500 (fœ¡ 450ƒËm’ts)",
cmd
,
Ën
);

1048 
	`ä“
(
cmd
);

1051 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_600")) {

1052 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 599");

1053 
	`b’chm¬k
("LRANGE_600 (fœ¡ 600ƒËm’ts)",
cmd
,
Ën
);

1054 
	`ä“
(
cmd
);

1057 ià(
	`‹¡_is_£Ëùed
("mset")) {

1058 cÚ¡ *
¬gv
[21];

1059 
¬gv
[0] = "MSET";

1060 
i
 = 1; i < 21; i += 2) {

1061 
¬gv
[
i
] = "key:__rand_int__";

1062 
¬gv
[
i
+1] = 
d©a
;

1064 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,21,
¬gv
,
NULL
);

1065 
	`b’chm¬k
("MSET (10 keys)",
cmd
,
Ën
);

1066 
	`ä“
(
cmd
);

1069 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

1070 } 
cÚfig
.
loİ
);

1072  
VRT_OK
;

1073 
	}
}

1075 
	$‹¡_memÿched
(
¬gc
, cÚ¡ **
¬gv
)

1077 
i
;

1078 *
d©a
, *
cmd
;

1079 
Ën
;

1082 ià(
¬gc
) {

1083 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

1084 
i
 = 1; i < 
¬gc
; i++) {

1085 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

1086 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

1090 
Ën
 = 
	`memÿchedFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

1091 ià(
Ën
 < 0) {

1095 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

1096 
	`ä“
(
cmd
);

1097 } 
cÚfig
.
loİ
);

1103 
d©a
 = 
	`m®loc
(
cÚfig
.
d©asize
+1);

1105 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

1106 
d©a
[
cÚfig
.
d©asize
] = '\0';

1108 ià(
	`‹¡_is_£Ëùed
("set")) {

1109 
Ën
 = 
	`memÿchedFÜm©Commªd
(&
cmd
,"£ˆkey:__¿nd_št__ 0 0 %d %s", 
cÚfig
.
d©asize
, 
d©a
);

1111 
	`b’chm¬k
("SET",
cmd
,
Ën
);

1112 
	`ä“
(
cmd
);

1115 ià(
	`‹¡_is_£Ëùed
("get")) {

1116 
Ën
 = 
	`memÿchedFÜm©Commªd
(&
cmd
,"get key:__rand_int__");

1117 
	`b’chm¬k
("GET",
cmd
,
Ën
);

1118 
	`ä“
(
cmd
);

1121 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

1122 } 
cÚfig
.
loİ
);

1124  
VRT_OK
;

1125 
	}
}

1127 
	$maš
(
¬gc
, cÚ¡ **
¬gv
) {

1128 
i
;

1130 
b’chm¬k_ş›Á
 
c
;

1132 
	`¤ªdom
(
	`time
(
NULL
));

1133 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

1134 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

1136 
cÚfig
.
numş›Ás
 = 50;

1137 
cÚfig
.
»que¡s
 = 100000;

1138 
cÚfig
.
liveş›Ás
 = 0;

1139 
cÚfig
.
k“·live
 = 1;

1140 
cÚfig
.
d©asize
 = 3;

1141 
cÚfig
.
p–še
 = 1;

1142 
cÚfig
.
show”rÜs
 = 0;

1143 
cÚfig
.
¿ndomkeys
 = 0;

1144 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

1145 
cÚfig
.
qu›t
 = 0;

1146 
cÚfig
.
csv
 = 0;

1147 
cÚfig
.
loİ
 = 0;

1148 
cÚfig
.
idËmode
 = 0;

1149 
cÚfig
.
Ï‹ncy
 = 
NULL
;

1150 
cÚfig
.
ho¡
 = "127.0.0.1";

1151 
cÚfig
.
ho¡pÜt
 = 6379;

1152 
cÚfig
.
ho¡sock‘
 = 
NULL
;

1153 
cÚfig
.
‹¡s
 = 
NULL
;

1154 
cÚfig
.
dbnum
 = 0;

1155 
cÚfig
.
auth
 = 
NULL
;

1156 
cÚfig
.
th»ads_couÁ
 = 1;

1157 
cÚfig
.
´ÙocŞ
 = 
TEST_CMD_PROTOCOL_REDIS
;

1158 
cÚfig
.
nošlše
 = 0;

1160 
i
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

1161 
¬gc
 -ğ
i
;

1162 
¬gv
 +ğ
i
;

1164 
cÚfig
.
Ï‹ncy
 = 
	`m®loc
(()*cÚfig.
»que¡s
);

1166 ià(
cÚfig
.
k“·live
 == 0) {

1167 
	`´štf
("WARNING: keepalive disabled, you…robably‚eed 'echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse' for Linux‡nd 'sudo sysctl -w‚et.inet.tcp.msl=1000' for Mac OS X in ordero use‡†ot of clients/requests\n");

1178 ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_REDIS
) {

1179 
	`‹¡_»dis
(
¬gc
, 
¬gv
);

1180 } ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_MEMCACHE
) {

1181 
	`‹¡_memÿched
(
¬gc
, 
¬gv
);

1183 
	`NOT_REACHED
();

1187 
	}
}

	@tests/vrt_check_data.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<±h»ad.h
>

9 
	~<sys/¡©.h
>

10 
	~<sys/ut¢ame.h
>

12 
	~<hœedis.h
>

13 
	~<async.h
>

14 
	~<ad­‹rs/«.h
>

16 
	~<dhashk™.h
>

17 
	~<dli¡.h
>

18 
	~<dmtqueue.h
>

19 
	~<dlog.h
>

21 
	~<v¹_ut.h
>

22 
	~<v¹_public.h
>

23 
	~<v¿b‹¡.h
>

24 
	~<v¹_´oduû_d©a.h
>

25 
	~<v¹_di¥©ch_d©a.h
>

26 
	~<v¹_back’d.h
>

27 
	~<v¹_check_d©a.h
>

29 
	#CHECK_DATA_FLAG_NONE
 (1<<0)

	)

30 
	#CHECK_DATA_FLAG_MASTER
 (1<<1)

	)

31 
	#CHECK_DATA_FLAG_SLAVE
 (1<<2)

	)

33 
	#CHECK_UNIT_STATE_NULL
 0

	)

34 
	#CHECK_UNIT_STATE_GET_EXPIRE
 1

	)

35 
	#CHECK_UNIT_STATE_GET_TYPE
 2

	)

36 
	#CHECK_UNIT_STATE_GET_VALUE
 3

	)

38 
	scheck_d©a_th»ad
 {

39 
	mid
;

40 
±h»ad_t
 
	mth»ad_id
;

42 
«Ev’tLoİ
 *
	m–
;

43 
	mhz
;

44 
	müÚloİs
;

46 
d¬¿y
 *
	mabgs
;

47 
	msÿn_group_idx
;

48 
d¬¿y
 *
	msÿn_£rv”s
;

49 
	msÿn_fšished_couÁ
;

50 
	mcursÜ
;

51 
dli¡
 *
	mcheck_un™s
;

53 
	mcheck_begš_time
;

54 
	msÿn_keys_couÁ
;

55 } 
	tcheck_d©a_th»ad
;

57 
	scheck_un™
 {

58 
check_d©a_th»ad
 *
	mcdt
;

60 
dli¡Node
 *
	mÊode
;

62 
sds
 
	mkey
;

64 
	mkey_³rsi¡
;

65 
	mmš_‰l
, 
	mmax_‰l_g­
;

67 
	mkey_ty³
;

68 
	m¡©e
;

70 
d¬¿y
 
	m£rv”s
;

71 
d¬¿y
 
	m»¶ys
;

73 
	m£rv”s_couÁ
;

74 
	m»¶ys_couÁ
;

75 
	mnÙ_exi¡_couÁ
;

76 } 
	tcheck_un™
;

78 
	sd©a_check”
 {

79 
±h»ad_t
 
	mth»ad_id
;

81 
«Ev’tLoİ
 *
	m–
;

82 
	mhz
;

83 
	müÚloİs
;

85 
sds
 
	m‹¡_rg‘_groups
;

87 
	mæags
;

88 
sds
 
	mcheck”
;

89 
cÚn_cÚ‹xt
 *
	mma¡”
;

91 
	mcheck_begš_time
;

92 } 
	td©a_check”
;

94 
d©a_check”
 
	gdc
;

98 
	gÏ¡_check_begš_time
;

100 
d¬¿y
 *
	gcdts
 = 
NULL
;

102 
check_un™
 *
	$check_un™_ü—‹
()

104 
check_un™
 *
cun™
;

106 
cun™
 = 
	`m®loc
((*cunit));

107 ià(
cun™
 =ğ
NULL
) {

108  
NULL
;

111 
cun™
->
cdt
 = 
NULL
;

113 
cun™
->
Êode
 = 
NULL
;

115 
cun™
->
key
 = 
NULL
;

116 
cun™
->
key_³rsi¡
 = 0;

117 
cun™
->
mš_‰l
 = 0;

118 
cun™
->
max_‰l_g­
 = 0;

119 
cun™
->
key_ty³
 = -1;

120 
cun™
->
¡©e
 = 
CHECK_UNIT_STATE_NULL
;

121 
	`d¬¿y_š™
(&
cun™
->
£rv”s
, 2, (
ab‹¡_£rv”
*));

122 
	`d¬¿y_š™
(&
cun™
->
»¶ys
, 2, (
»disR•ly
*));

124 
cun™
->
£rv”s_couÁ
 = 0;

125 
cun™
->
»¶ys_couÁ
 = 0;

126 
cun™
->
nÙ_exi¡_couÁ
 = 0;

128  
cun™
;

129 
	}
}

131 
	$check_un™_de¡roy
(
check_un™
 *
cun™
)

133 ià(
cun™
->
cdt
 !ğ
NULL
 && cun™->
Êode
 != NULL) {

134 
	`dli¡D–Node
(
cun™
->
cdt
->
check_un™s
,cun™->
Êode
);

135 
cun™
->
Êode
 = 
NULL
;

138 ià(
cun™
->
key
 !ğ
NULL
) {

139 
	`sdsä“
(
cun™
->
key
);

140 
cun™
->
key
 = 
NULL
;

143 
	`d¬¿y_n
(&
cun™
->
£rv”s
) > 0) {

144 
	`d¬¿y_pİ
(&
cun™
->
£rv”s
);

146 
	`d¬¿y_deš™
(&
cun™
->
£rv”s
);

148 
	`d¬¿y_n
(&
cun™
->
»¶ys
) > 0) {

149 
»disR•ly
 **
»¶y
 = 
	`d¬¿y_pİ
(&
cun™
->
»¶ys
);

150 
	`ä“R•lyObjeù
(*
»¶y
);

152 
	`d¬¿y_deš™
(&
cun™
->
»¶ys
);

154 
	`ä“
(
cun™
);

155 
	}
}

157 
	$check_cÚn_cÚ‹xt_š™
(
cÚn_cÚ‹xt
 *
cc
, *
ho¡
, 
pÜt
)

159 
cc
->
ùx
 = 
NULL
;

160 
cc
->
aùx
 = 
NULL
;

162 
cc
->
aùx
 = 
	`»disAsyncCÚÃù
(
ho¡
, 
pÜt
);

163 ià(
cc
->
aùx
 =ğ
NULL
) {

164  
VRT_ERROR
;

167  
VRT_OK
;

168 
	}
}

170 
	$check_cÚn_cÚ‹xt_deš™
(
cÚn_cÚ‹xt
 *
cc
)

172 ià(
cc
->
ùx
) {

173 
	`»disF»e
(
cc
->
ùx
);

174 
cc
->
ùx
 =ğ
NULL
;

177 ià(
cc
->
aùx
) {

178 
cc
->
aùx
->
ev
.
ş—nup
 = 
NULL
;

179 
	`»disAsyncF»e
(
cc
->
aùx
);

180 
cc
->
aùx
 =ğ
NULL
;

182 
	}
}

184 
	$cÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

185 
check_d©a_th»ad
 *
cdt
 = 
c
->
d©a
;

186 ià(
¡©us
 !ğ
REDIS_OK
) {

187 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

193 
	}
}

195 
	$discÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

196 
check_d©a_th»ad
 *
cdt
 = 
c
->
d©a
;

197 ià(
¡©us
 !ğ
REDIS_OK
) {

198 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

205 
	}
}

207 
	$sÜt_»¶ys_if_Ãeded
(
check_un™
 *
cun™
)

209 
¡•
 = 0, 
idx_cmp
 = 0;

211 ià(
cun™
->
key_ty³
 =ğ
REDIS_SET
) {

212 
¡•
 = 1;

213 } ià(
cun™
->
key_ty³
 =ğ
REDIS_HASH
) {

214 
¡•
 = 2;

217 ià(
¡•
 > 0) {

218 
i
;

219 
»disR•ly
 **
»¶y
;

220 
i
 = 0; i < 
	`d¬¿y_n
(&
cun™
->
»¶ys
); i ++) {

221 
»¶y
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
, 
i
);

222 ià((*
»¶y
)->
ty³
 !ğ
REDIS_REPLY_ARRAY
)

224 
	`sÜt_¬¿y_by_¡•
((*
»¶y
)->
–em’t
, (*»¶y)->
–em’ts
,

225 
¡•
, 
idx_cmp
, 
»¶y_¡ršg_bš¬y_com·»
);

229  
VRT_OK
;

230 
	}
}

234 
	$check_»¶ys_if_§me
(
check_un™
 *
cun™
)

236 
j
;

237 
»disR•ly
 **
»¶yb
, **
»¶y
;

239 
	`sÜt_»¶ys_if_Ãeded
(
cun™
);

241 
»¶yb
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
,0);

243 
j
 = 1; j < 
cun™
->
»¶ys_couÁ
 ; j ++) {

244 
»¶y
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
,
j
);

245 ià(
	`check_two_»¶ys_if_§me
(*
»¶yb
, *
»¶y
)) {

251 
	}
}

253 
	#TTL_MISTAKE_CAN_BE_ACCEPT
 3

	)

254 
	$check_d©a_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

255 
»disR•ly
 *
»¶y
 = 
r
, *
»¶y_sub
, *
»¶y_–em
;

256 
»disR•ly
 *
»¶y_şÚe
, **
–em
;

257 
check_un™
 *
cun™
 = 
´ivd©a
;

258 
check_d©a_th»ad
 *
cdt
 = 
cun™
->cdt;

259 
cÚn_cÚ‹xt
 *
cc
;

260 
v®ue
;

261 *
”rmsg
;

262 
j
;

264 ià(
»¶y
 =ğ
NULL
) ;

266 ià(
cun™
->
¡©e
 =ğ
CHECK_UNIT_STATE_GET_EXPIRE
) {

267 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

268 
”rmsg
 = "ttl command„eplyype is‚ot integer";

269 
”rÜ
;

272 
»¶y_şÚe
 = 
	`¡—l_hœedis_»di¤•ly
(
»¶y
);

273 
–em
 = 
	`d¬¿y_push
(&
cun™
->
»¶ys
);

274 *
–em
 = 
»¶y_şÚe
;

275 
cun™
->
»¶ys_couÁ
 ++;

277 ià(
cun™
->
»¶ys_couÁ
 >ğcun™->
£rv”s_couÁ
) {

278 *
¬gv
[2];

279 
size_t
 
¬gvËn
[2];

280 
mš
, 
max
;

281 
³rsi¡
;

283 
–em
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
, 0);

284 
»¶y_–em
 = *
–em
;

285 ià(
»¶y_–em
->
š‹g”
 == -1) {

286 
³rsi¡
 = 1;

287 } ià(
»¶y_–em
->
š‹g”
 == -2) {

288 
cun™
->
nÙ_exi¡_couÁ
 ++;

289 
mš
 = 
max
 = 0;

290 } ià(
»¶y_–em
->
š‹g”
 < -2) {

291 
”rmsg
 = "ttl command„eply integer is†esshan -2";

292 
”rÜ
;

294 
mš
 = 
max
 = 
»¶y_–em
->
š‹g”
;

297 
j
 = 1; j < 
	`d¬¿y_n
(&
cun™
->
»¶ys
); j ++) {

298 
–em
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
, 
j
);

299 
»¶y_–em
 = *
–em
;

300 ià(
³rsi¡
 && 
»¶y_–em
->
š‹g”
 != -1) {

301 
”rmsg
 = "key in some server is…ersist, but others‡re‚ot";

302 
”rÜ
;

305 ià(
»¶y_–em
->
š‹g”
 == -1) {

306 ià(
³rsi¡
 != 1) {

307 
”rmsg
 = "key in some server is…ersist, but others‡re‚ot";

308 
”rÜ
;

310 } ià(
»¶y_–em
->
š‹g”
 == -2) {

311 
cun™
->
nÙ_exi¡_couÁ
 ++;

312 ià(
mš
 > 0) min = 0;

313 } ià(
»¶y_–em
->
š‹g”
 < -2) {

314 
”rmsg
 = "ttl command„eply integer is†esshan -2";

315 
”rÜ
;

317 ià(
»¶y_–em
->
š‹g”
 < 
mš
) min =„eply_elem->integer;

318 ià(
»¶y_–em
->
š‹g”
 > 
max
) max =„eply_elem->integer;

322 ià(
cun™
->
nÙ_exi¡_couÁ
 >ğcun™->
£rv”s_couÁ
) {

324 
dÚe
;

327 ià(
³rsi¡
) {

328 
cun™
->
key_³rsi¡
 = 1;

330 
cun™
->
mš_‰l
 = 
mš
;

331 
cun™
->
max_‰l_g­
 = 
max
-
mš
;

332 ià(
cun™
->
max_‰l_g­
 > 
TTL_MISTAKE_CAN_BE_ACCEPT
) {

333 
”rmsg
 = "ttl mistake isoo big between groups";

334 
”rÜ
;

339 
¬gv
[0] = "type";

340 
¬gvËn
[0] = 4;

341 
¬gv
[1] = 
cun™
->
key
;

342 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

343 
j
 = 0; j < 
	`d¬¿y_n
(&
cun™
->
£rv”s
); j ++) {

344 
ab‹¡_£rv”
 **
abs
 = 
	`d¬¿y_g‘
(&
cun™
->
£rv”s
,
j
);

345 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
((*
abs
)->
cÚn_cÚ‹xts
, 0);

347 
	`»disAsyncCommªdArgv
(
cc
->
aùx
, 
check_d©a_ÿÎback
,

348 
cun™
, 2, 
¬gv
, 
¬gvËn
);

351 
cun™
->
¡©e
 = 
CHECK_UNIT_STATE_GET_TYPE
;

352 
Ãxt_¡•
;

358 ià(
cun™
->
¡©e
 =ğ
CHECK_UNIT_STATE_GET_TYPE
) {

359 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STATUS
) {

360 
”rmsg
 = "type command„eplyype is‚ot status";

361 
”rÜ
;

364 ià(!
	`¡rcmp
(
»¶y
->
¡r
, "none")) {

366 
cun™
->
nÙ_exi¡_couÁ
 ++;

368 
»¶y_şÚe
 = 
	`¡—l_hœedis_»di¤•ly
(
»¶y
);

369 
–em
 = 
	`d¬¿y_push
(&
cun™
->
»¶ys
);

370 *
–em
 = 
»¶y_şÚe
;

371 
cun™
->
»¶ys_couÁ
 ++;

374 ià(
cun™
->
nÙ_exi¡_couÁ
 >ğcun™->
£rv”s_couÁ
) {

376 
dÚe
;

377 } ià(
cun™
->
»¶ys_couÁ
 >ğ(cun™->
£rv”s_couÁ
-cun™->
nÙ_exi¡_couÁ
)) {

378 
¬gc
;

379 **
¬gv
;

380 
size_t
 *
¬gvËn
;

382 ià(
cun™
->
nÙ_exi¡_couÁ
 > 0 && cun™->
key_³rsi¡
) {

383 
”rmsg
 = "key is…ersist, but‚otƒxist in some servers";

384 
”rÜ
;

387 ià(
	`check_»¶ys_if_§me
(
cun™
) != 1) {

388 
”rmsg
 = "type command„eplys‡re‚ot same";

389 
”rÜ
;

392 
–em
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
,0);

393 ià(!
	`¡rcmp
((*
–em
)->
¡r
,"string")) {

394 
cun™
->
key_ty³
 = 
REDIS_STRING
;

396 
¬gc
 = 2;

397 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

398 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

400 
¬gv
[0] = "get";

401 
¬gvËn
[0] = 3;

402 
¬gv
[1] = 
cun™
->
key
;

403 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

404 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"list")) {

405 
cun™
->
key_ty³
 = 
REDIS_LIST
;

407 
¬gc
 = 4;

408 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

409 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

411 
¬gv
[0] = "lrange";

412 
¬gvËn
[0] = 6;

413 
¬gv
[1] = 
cun™
->
key
;

414 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

415 
¬gv
[2] = "0";

416 
¬gvËn
[2] = 1;

417 
¬gv
[3] = "-1";

418 
¬gvËn
[3] = 2;

419 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"set")) {

420 
cun™
->
key_ty³
 = 
REDIS_SET
;

422 
¬gc
 = 2;

423 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

424 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

426 
¬gv
[0] = "smembers";

427 
¬gvËn
[0] = 8;

428 
¬gv
[1] = 
cun™
->
key
;

429 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

430 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"zset")) {

431 
cun™
->
key_ty³
 = 
REDIS_ZSET
;

433 
¬gc
 = 4;

434 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

435 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

437 
¬gv
[0] = "zrange";

438 
¬gvËn
[0] = 6;

439 
¬gv
[1] = 
cun™
->
key
;

440 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

441 
¬gv
[2] = "0";

442 
¬gvËn
[2] = 1;

443 
¬gv
[3] = "-1";

444 
¬gvËn
[3] = 2;

445 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"hash")) {

446 
cun™
->
key_ty³
 = 
REDIS_HASH
;

448 
¬gc
 = 2;

449 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

450 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

452 
¬gv
[0] = "hgetall";

453 
¬gvËn
[0] = 7;

454 
¬gv
[1] = 
cun™
->
key
;

455 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

457 
”rmsg
 = "not supported keyype";

458 
”rÜ
;

462 
j
 = 0; j < 
	`d¬¿y_n
(&
cun™
->
£rv”s
); j ++) {

463 
ab‹¡_£rv”
 **
abs
 = 
	`d¬¿y_g‘
(&
cun™
->
£rv”s
,
j
);

464 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
((*
abs
)->
cÚn_cÚ‹xts
, 0);

466 
	`»disAsyncCommªdArgv
(
cc
->
aùx
, 
check_d©a_ÿÎback
,

467 
cun™
, 
¬gc
, 
¬gv
, 
¬gvËn
);

469 
	`ä“
(
¬gv
);

470 
	`ä“
(
¬gvËn
);

472 
cun™
->
¡©e
 = 
CHECK_UNIT_STATE_GET_VALUE
;

473 
Ãxt_¡•
;

479 ià(
cun™
->
¡©e
 =ğ
CHECK_UNIT_STATE_GET_VALUE
) {

480 
nÙ_exi¡
 = 0;

481 ià(
cun™
->
key_ty³
 =ğ
REDIS_STRING
) {

482 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_NIL
) {

483 
nÙ_exi¡
 = 1;

484 } ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

485 
”rmsg
 = "get command„eplyype is‚ot string";

486 
”rÜ
;

488 } ià(
cun™
->
key_ty³
 =ğ
REDIS_LIST
) {

489 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

490 
”rmsg
 = "lrange command„eplyype is‚ot‡rray";

491 
”rÜ
;

493 ià(
»¶y
->
–em’ts
 == 0) {

494 
nÙ_exi¡
 = 1;

496 } ià(
cun™
->
key_ty³
 =ğ
REDIS_SET
) {

497 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

498 
”rmsg
 = "smembers command„eplyype is‚ot‡rray";

499 
”rÜ
;

501 ià(
»¶y
->
–em’ts
 == 0) {

502 
nÙ_exi¡
 = 1;

504 } ià(
cun™
->
key_ty³
 =ğ
REDIS_ZSET
) {

505 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

506 
”rmsg
 = "zrange command„eplyype is‚ot‡rray";

507 
”rÜ
;

509 ià(
»¶y
->
–em’ts
 == 0) {

510 
nÙ_exi¡
 = 1;

512 } ià(
cun™
->
key_ty³
 =ğ
REDIS_HASH
) {

513 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

514 
”rmsg
 = "hgetall command„eplyype is‚ot‡rray";

515 
”rÜ
;

517 ià(
»¶y
->
–em’ts
 == 0) {

518 
nÙ_exi¡
 = 1;

521 
”rmsg
 = "not supported keyype";

522 
”rÜ
;

525 ià(
nÙ_exi¡
) {

526 
cun™
->
nÙ_exi¡_couÁ
 ++;

528 
»¶y_şÚe
 = 
	`¡—l_hœedis_»di¤•ly
(
»¶y
);

529 
–em
 = 
	`d¬¿y_push
(&
cun™
->
»¶ys
);

530 *
–em
 = 
»¶y_şÚe
;

531 
cun™
->
»¶ys_couÁ
 ++;

534 ià(
cun™
->
nÙ_exi¡_couÁ
 >ğcun™->
£rv”s_couÁ
) {

536 
dÚe
;

537 } ià(
cun™
->
»¶ys_couÁ
 >ğ(cun™->
£rv”s_couÁ
-cun™->
nÙ_exi¡_couÁ
)) {

538 ià(
cun™
->
nÙ_exi¡_couÁ
 > 0 && cun™->
key_³rsi¡
) {

539 
”rmsg
 = "key is…ersist, but‚otƒxist in some servers";

540 
”rÜ
;

543 ià(
	`check_»¶ys_if_§me
(
cun™
) != 1) {

544 
”rmsg
 = "values for„eply‡re‚ot same";

545 
”rÜ
;

548 
dÚe
;

554 
dÚe
:

556 
	`check_un™_de¡roy
(
cun™
);

560 
Ãxt_¡•
:

562 
cun™
->
»¶ys_couÁ
 = 0;

563 
cun™
->
nÙ_exi¡_couÁ
 = 0;

564 
	`d¬¿y_n
(&
cun™
->
»¶ys
) > 0) {

565 
–em
 = 
	`d¬¿y_pİ
(&
cun™
->
»¶ys
);

566 
	`ä“R•lyObjeù
(*
–em
);

571 
”rÜ
:

573 
	`log_hexdump
(
LOG_ERR
,
cun™
->
key
,
	`sd¦’
(cunit->key),

575 
”rmsg
,

576 
cdt
->
sÿn_group_idx
,

577 
	`sd¦’
(
cun™
->
key
),
	`g‘_key_ty³_¡ršg
(cun™->
key_ty³
));

579 
	`check_un™_de¡roy
(
cun™
);

580 
	}
}

582 
	$¡¬t_check_d©a
(*
key
, 
size_t
 
keyËn
, 
check_d©a_th»ad
 *
cdt
)

584 
check_un™
 *
cu
 = 
	`check_un™_ü—‹
();

585 
j
;

587 
cu
->
cdt
 = cdt;

588 
cu
->
key
 = 
	`sd¢ewËn
(key,
keyËn
);

589 
	`dli¡Push
(
cdt
->
check_un™s
,
cu
);

590 
cu
->
Êode
 = 
	`dli¡La¡
(
cdt
->
check_un™s
);

592 
j
 = 0; j < 
	`d¬¿y_n
(
cdt
->
abgs
); j ++) {

593 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, 
j
);

594 
ab‹¡_£rv”
 *
abs
 = 
abg
->
	`g‘_back’d_£rv”
×bg,
key
,
keyËn
);

595 
ab‹¡_£rv”
 **
–em
 = 
	`d¬¿y_push
(&
cu
->
£rv”s
);

596 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

597 *
¬gv
[2];

598 
size_t
 
¬gvËn
[2];

600 *
–em
 = 
abs
;

601 
cu
->
£rv”s_couÁ
 ++;

604 
¬gv
[0] = "ttl";

605 
¬gvËn
[0] = 3;

606 
¬gv
[1] = 
key
;

607 
¬gvËn
[1] = 
keyËn
;

608 
	`»disAsyncCommªdArgv
(
cc
->
aùx
, 
check_d©a_ÿÎback
,

609 
cu
, 2, 
¬gv
, 
¬gvËn
);

611 
cu
->
¡©e
 = 
CHECK_UNIT_STATE_GET_EXPIRE
;

613  
VRT_OK
;

614 
	}
}

616 
	$sÿn_fÜ_check_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

617 
»disR•ly
 *
»¶y
 = 
r
, *
»¶y_sub
, *
»¶y_–em
;

618 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

619 
check_d©a_th»ad
 *
cdt
 = 
abs
->
d©a
;

620 
cÚn_cÚ‹xt
 *
cc
;

621 
v®ue
;

622 
size_t
 
k
;

624 ià(
»¶y
 =ğ
NULL
) ;

627 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

631 ià(
»¶y
->
–em’ts
 != 2) {

635 
»¶y_sub
 = 
»¶y
->
–em’t
[0];

636 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

637 
	`¡ršg2Î
(
»¶y_sub
->
¡r
,»¶y_sub->
Ën
,&
v®ue
) != 1) {

641 
cdt
->
cursÜ
 = 
v®ue
;

643 
»¶y_sub
 = 
»¶y
->
–em’t
[1];

644 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

648 
k
 = 0; k < 
»¶y_sub
->
–em’ts
; k ++) {

649 
»¶y_–em
 = 
»¶y_sub
->
–em’t
[
k
];

650 ià(
»¶y_–em
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

654 
	`¡¬t_check_d©a
(
»¶y_–em
->
¡r
,»¶y_–em->
Ën
,
cdt
);

657 
cdt
->
sÿn_keys_couÁ
 +ğ
»¶y_sub
->
–em’ts
;

659 ià(
cdt
->
cursÜ
 == 0) {

660 
cdt
->
sÿn_fšished_couÁ
 ++;

662 
	}
}

664 
	gcheck_d©a_th»ads_fšished_couÁ
 = 0;

665 
	$Úe_check_d©a_th»ad_fšished
()

667 
	`upd©e_¡©e_add
(
check_d©a_th»ads_fšished_couÁ
,1);

668 
	}
}

670 
	$®l_check_d©a_th»ads_fšished
()

672 
fšished_couÁ
;

673 
	`upd©e_¡©e_g‘
(
check_d©a_th»ads_fšished_couÁ
,&
fšished_couÁ
);

675 ià(
fšished_couÁ
 >ğ
	`d¬¿y_n
(
cdts
)) {

680 
	}
}

682 
	$check_d©a_th»ad_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

684 
check_d©a_th»ad
 *
cdt
 = 
ş›ÁD©a
;

686 
	`ASSERT
(
ev’tLoİ
 =ğ
cdt
->
–
);

688 ià(
cdt
->
sÿn_fšished_couÁ
 >ğ
	`d¬¿y_n
(cdt->
sÿn_£rv”s
)) {

689 ià(
	`dli¡L’gth
(
cdt
->
check_un™s
) == 0) {

690 
	`«Stİ
(
cdt
->
–
);

691 
	`Úe_check_d©a_th»ad_fšished
();

692 
	`log_debug
(
LOG_NOTICE
, "One checkhread finished,scaned %lld keys",

693 
cdt
->
sÿn_keys_couÁ
);

696 } ià(
	`dli¡L’gth
(
cdt
->
check_un™s
) < 3000) {

697 
ab‹¡_group
 *
abg
;

698 
ab‹¡_£rv”
 **
abs
;

699 *
idx
;

700 
cÚn_cÚ‹xt
 *
cc
;

702 
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, cdt->
sÿn_group_idx
);

703 
abs
 = 
	`d¬¿y_g‘
(
cdt
->
sÿn_£rv”s
, cdt->
sÿn_fšished_couÁ
);

704 
cc
 = 
	`d¬¿y_g‘
((*
abs
)->
cÚn_cÚ‹xts
, 0);

706 
	`»disAsyncCommªd
(
cc
->
aùx
, 
sÿn_fÜ_check_ÿÎback
,

707 *
abs
, "sÿÀ%Îd couÁ 1000", 
cdt
->
cursÜ
);

710 
cdt
->
üÚloİs
 ++;

711  1000/
cdt
->
hz
;

712 
	}
}

714 
	$check_d©a_th»ad_š™
(
check_d©a_th»ad
 *
cdt
, *
‹¡_rg‘_groups
)

716 
i
, 
j
, 
k
;

718 
cdt
->
id
 = 0;

719 
cdt
->
th»ad_id
 = 0;

720 
cdt
->
–
 = 
NULL
;

721 
cdt
->
hz
 = 200;

722 
cdt
->
üÚloİs
 = 0;

724 
cdt
->
abgs
 = 
NULL
;

725 
cdt
->
sÿn_group_idx
 = 0;

726 
cdt
->
sÿn_£rv”s
 = 
NULL
;

727 
cdt
->
sÿn_fšished_couÁ
 = 0;

728 
cdt
->
cursÜ
 = 0;

729 
cdt
->
check_un™s
 = 
NULL
;

731 
cdt
->
check_begš_time
 = 0;

732 
cdt
->
sÿn_keys_couÁ
 = 0;

734 
cdt
->
–
 = 
	`«C»©eEv’tLoİ
(200);

735 ià(
cdt
->
–
 =ğ
NULL
) {

736  
VRT_ERROR
;

739 
cdt
->
sÿn_£rv”s
 = 
	`d¬¿y_ü—‹
(1,(
ab‹¡_£rv”
*));

741 
cdt
->
abgs
 = 
	`ab‹¡_groups_ü—‹
(
‹¡_rg‘_groups
);

742 ià(
cdt
->
abgs
 =ğ
NULL
) {

743  
VRT_ERROR
;

747 
i
 = 0; i < 
	`d¬¿y_n
(
cdt
->
abgs
); i ++) {

748 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, 
i
);

749 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

750 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

751 
abs
->
cÚn_cÚ‹xts
 = 
	`d¬¿y_ü—‹
(1, (
cÚn_cÚ‹xt
));

752 
k
 = 0; k < 1; k ++) {

753 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_push
(
abs
->
cÚn_cÚ‹xts
);

754 ià(
	`check_cÚn_cÚ‹xt_š™
(
cc
,
abs
->
ho¡
,abs->
pÜt
è!ğ
VRT_OK
) {

755  
VRT_ERROR
;

757 
cc
->
aùx
->
d©a
 = 
cdt
;

758 
	`»disAeA‰ach
(
cdt
->
–
, 
cc
->
aùx
);

759 
	`»disAsyncS‘CÚÃùC®lback
(
cc
->
aùx
,
cÚÃù_ÿÎback
);

760 
	`»disAsyncS‘DiscÚÃùC®lback
(
cc
->
aùx
,
discÚÃù_ÿÎback
);

765 ià(
	`«C»©eTimeEv’t
(
cdt
->
–
, 1, 
check_d©a_th»ad_üÚ
, cdt, 
NULL
è=ğ
AE_ERR
) {

766  
VRT_ERROR
;

769 
cdt
->
check_un™s
 = 
	`dli¡C»©e
();

771  
VRT_OK
;

772 
	}
}

774 
	$check_d©a_th»ad_deš™
(
check_d©a_th»ad
 *
cdt
)

776 ià(
cdt
->
–
) {

777 
	`«D–‘eEv’tLoİ
(
cdt
->
–
);

778 
cdt
->
–
 = 
NULL
;

781 ià(
cdt
->
sÿn_£rv”s
) {

782 
	`d¬¿y_n
(
cdt
->
sÿn_£rv”s
) > 0) {

783 
	`d¬¿y_pİ
(
cdt
->
sÿn_£rv”s
);

785 
	`d¬¿y_de¡roy
(
cdt
->
sÿn_£rv”s
);

786 
cdt
->
sÿn_£rv”s
 = 
NULL
;

789 ià(
cdt
->
abgs
) {

790 
i
, 
j
, 
k
;

792 
i
 = 0; i < 
	`d¬¿y_n
(
cdt
->
abgs
); i ++) {

793 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, 
i
);

794 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

795 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

796 
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) > 0) {

797 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_pİ
(
abs
->
cÚn_cÚ‹xts
);

798 
	`check_cÚn_cÚ‹xt_deš™
(
cc
);

803 
	`ab‹¡_groups_de¡roy
(
cdt
->
abgs
);

804 
cdt
->
abgs
 = 
NULL
;

807 ià(
cdt
->
check_un™s
) {

808 
	`dli¡L’gth
(
cdt
->
check_un™s
) > 0) {

809 
check_un™
 *
cu
 = 
	`dli¡Pİ
(
cdt
->
check_un™s
);

810 
	`check_un™_de¡roy
(
cu
);

812 
	`dli¡R–—£
(
cdt
->
check_un™s
);

813 
cdt
->
check_un™s
 = 
NULL
;

815 
	}
}

817 
	gcheckšg_d©a
;

818 
	$checkšg_d©a_Ü_nÙ
()

820 
checkšg
;

822 
	`upd©e_¡©e_g‘
(
checkšg_d©a
,&
checkšg
);

824 ià(
checkšg
)  1;

826 
	}
}

828 
	gcheck_d©a_th»ads_couÁ
 = 8;

829 
de¡roy_check_d©a_th»ads
();

834 
	$ü—‹_check_d©a_th»ads
()

836 
d¬¿y
 *
abgs
 = 
NULL
;

837 
ab‹¡_group
 *
abg
;

838 
groups_couÁ
;

839 
th»ads_couÁ_³r_group
;

840 
check_th»ad_id
 = 0;

841 
i
, 
j
, 
k
;

843 ià(
cdts
 !ğ
NULL
) {

844 
	`de¡roy_check_d©a_th»ads
();

847 
cdts
 = 
	`d¬¿y_ü—‹
(2,(
check_d©a_th»ad
));

848 ià(
cdts
 =ğ
NULL
) {

852 
abgs
 = 
	`ab‹¡_groups_ü—‹
(
dc
.
‹¡_rg‘_groups
);

853 ià(
abgs
 =ğ
NULL
) {

857 
groups_couÁ
 = 
	`d¬¿y_n
(
abgs
);

858 ià(
groups_couÁ
 == 1) {

859 
	`ab‹¡_groups_de¡roy
(
abgs
);

863 
th»ads_couÁ_³r_group
 = 
check_d©a_th»ads_couÁ
/
groups_couÁ
;

864 ià(
th»ads_couÁ_³r_group
 <= 0) {

865 
th»ads_couÁ_³r_group
 = 1;

868 
i
 = 0; i < 
groups_couÁ
; i ++) {

869 
£rv”s_couÁ
, 
th»ads_couÁ
;

870 
£rv”s_couÁ_³r_th»ad
;

871 
£rv”_idx
 = 0;

873 
th»ads_couÁ
 = 
th»ads_couÁ_³r_group
;

874 
abg
 = 
	`d¬¿y_g‘
(
abgs
, 
i
);

875 
£rv”s_couÁ
 = 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
);

876 
£rv”s_couÁ_³r_th»ad
 = 
£rv”s_couÁ
/
th»ads_couÁ
;

877 ià(
£rv”s_couÁ_³r_th»ad
 == 0) {

878 
£rv”s_couÁ_³r_th»ad
 = 1;

879 
th»ads_couÁ
 = 
£rv”s_couÁ
;

881 
j
 = 0; j < 
th»ads_couÁ
; j ++) {

882 
ab‹¡_£rv”
 *
abs
;

884 
check_d©a_th»ad
 *
cdt
 = 
	`d¬¿y_push
(
cdts
);

885 
	`check_d©a_th»ad_š™
(
cdt
,
dc
.
‹¡_rg‘_groups
);

886 
cdt
->
id
 = 
check_th»ad_id
++;

887 
cdt
->
sÿn_group_idx
 = 
i
;

889 
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, cdt->
id
);

891 
k
 = 0; k < 
£rv”s_couÁ_³r_th»ad
; k ++) {

892 
ab‹¡_£rv”
 **
–em
 = 
	`d¬¿y_push
(
cdt
->
sÿn_£rv”s
);

893 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
£rv”_idx
++);

894 
abs
->
d©a
 = 
cdt
;

895 *
–em
 = 
abs
;

898 ià(
j
 =ğ
th»ads_couÁ
-1) {

899 
£rv”_idx
 < 
£rv”s_couÁ
) {

900 
ab‹¡_£rv”
 **
–em
 = 
	`d¬¿y_push
(
cdt
->
sÿn_£rv”s
);

901 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
£rv”_idx
++);

902 
abs
->
d©a
 = 
cdt
;

903 *
–em
 = 
abs
;

909 
	`ab‹¡_groups_de¡roy
(
abgs
);

912 
	}
}

914 
	$de¡roy_check_d©a_th»ads
()

916 ià(
cdts
 !ğ
NULL
) {

917 
	`d¬¿y_n
(
cdts
) > 0) {

918 
check_d©a_th»ad
 *
cdt
 = 
	`d¬¿y_pİ
(
cdts
);

919 
	`check_d©a_th»ad_deš™
(
cdt
);

921 
	`d¬¿y_de¡roy
(
cdts
);

922 
cdts
 = 
NULL
;

924 
	}
}

926 *
	$check_d©a_th»ad_run
(*
¬gs
)

928 
check_d©a_th»ad
 *
cdt
 = 
¬gs
;

930 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

932 
	`«Maš
(
cdt
->
–
);

934  
NULL
;

935 
	}
}

937 
	$¡¬t_check_d©a_th»ads
()

939 
j
;

940 
check_d©a_th»ad
 *
cdt
;

942 ià(
cdts
 =ğ
NULL
è 
VRT_ERROR
;

944 
j
 = 0; j < 
	`d¬¿y_n
(
cdts
); j ++) {

945 
±h»ad_©Œ_t
 
©Œ
;

947 
cdt
 = 
	`d¬¿y_g‘
(
cdts
, 
j
);

948 
	`±h»ad_©Œ_š™
(&
©Œ
);

949 
	`±h»ad_ü—‹
(&
cdt
->
th»ad_id
,

950 &
©Œ
, 
check_d©a_th»ad_run
, 
cdt
);

953  
VRT_OK
;

954 
	}
}

956 
	$begš_check_d©a
()

958 
	`ü—‹_check_d©a_th»ads
();

959 
	`¡¬t_check_d©a_th»ads
();

961 
	`upd©e_¡©e_£t
(
checkšg_d©a
,1);

963  
VRT_OK
;

964 
	}
}

966 
	$’d_check_d©a
()

968 
	`upd©e_¡©e_£t
(
check_d©a_th»ads_fšished_couÁ
,0);

969 
	`upd©e_¡©e_£t
(
checkšg_d©a
,0);

970 
	}
}

972 
	$d©a_check”_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

974 
	`ASSERT
(
ev’tLoİ
 =ğ
dc
.
–
);

976 ià(!
	`‹¡_if_Ãed_·u£
(è&& 
	`v¹_£c_now
()-
Ï¡_‹¡_begš_time
 > 
‹¡_š‹rv®
) {

977 
	`‹¡_Ãed_to_·u£
();

978 
	`log_nÙiû
("Start…auseheest...");

981 ià(!
	`checkšg_d©a_Ü_nÙ
(è&& 
	`‹¡_if_Ãed_·u£
() &&

982 
	`®l_th»ads_·u£d
()) {

984 
	`log_nÙiû
("Finished…auseheest. Tested %lld commands, %lldƒrror„eply(%.2f%%).",

985 
	`g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
(),

986 
	`g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
(),

987 ()
	`g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
()/()
	`g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
()*100);

988 
	`»£t_tÙ®_couÁ_³r_cyşe
();

989 
	`¦“p
(1);

990 
Ï¡_check_begš_time
 = 
	`v¹_£c_now
();

991 
	`begš_check_d©a
();

992 
	`log_nÙiû
("Start checkinghe data...");

995 ià(
	`checkšg_d©a_Ü_nÙ
(è&& 
	`®l_check_d©a_th»ads_fšished
()) {

996 
	`’d_check_d©a
();

997 
	`log_nÙiû
("Finished checkinghe data\n");

998 
	`‹¡_ÿn_cÚtšue
();

999 
Ï¡_‹¡_begš_time
 = 
	`v¹_£c_now
();

1002 
dc
.
üÚloİs
 ++;

1003  1000/
dc
.
hz
;

1004 
	}
}

1006 
	$v¹_d©a_check”_š™
(*
check”
, *
‹¡_rg‘_groups
)

1008 
»t
;

1010 
dc
.
th»ad_id
 = 0;

1011 
dc
.
–
 = 
NULL
;

1012 
dc
.
hz
 = 10;

1013 
dc
.
üÚloİs
 = 0;

1014 
dc
.
‹¡_rg‘_groups
 = 
NULL
;

1015 
dc
.
æags
 = 
CHECK_DATA_FLAG_NONE
;

1016 
dc
.
check”
 = 
NULL
;

1017 
dc
.
ma¡”
 = 
NULL
;

1018 
dc
.
check_begš_time
 = 0;

1020 
dc
.
–
 = 
	`«C»©eEv’tLoİ
(10);

1021 ià(
dc
.
–
 =ğ
NULL
) {

1022  
VRT_ERROR
;

1025 ià(
	`«C»©eTimeEv’t
(
dc
.
–
, 1, 
d©a_check”_üÚ
, 
NULL
, NULLè=ğ
AE_ERR
) {

1026  
VRT_ERROR
;

1029 
dc
.
‹¡_rg‘_groups
 = 
	`sd¢ew
(test_target_groups);

1031 
dc
.
check”
 = 
	`sd¢ew
(checker);

1033 ià(!
	`¡rÿ£cmp
(
check”
,"myself")) {

1034 
dc
.
æags
 |ğ
CHECK_DATA_FLAG_MASTER
;

1036 
sds
 
ho¡
;

1037 
pÜt
;

1038 
dc
.
æags
 |ğ
CHECK_DATA_FLAG_SLAVE
;

1039 
ho¡
 = 
	`g‘_ho¡_pÜt_äom_add»ss_¡ršg
(
check”
, &
pÜt
);

1040 ià(
ho¡
 =ğ
NULL
) {

1041  
VRT_ERROR
;

1043 
dc
.
ma¡”
 = 
	`m®loc
((
cÚn_cÚ‹xt
));

1044 
»t
 = 
	`check_cÚn_cÚ‹xt_š™
(
dc
.
ma¡”
, 
ho¡
, 
pÜt
);

1045 
	`sdsä“
(
ho¡
);

1046 ià(
»t
 !ğ
VRT_OK
) {

1047  
VRT_ERROR
;

1051  
VRT_OK
;

1052 
	}
}

1054 
	$v¹_d©a_check”_deš™
()

1056 ià(
dc
.
–
) {

1057 
	`«D–‘eEv’tLoİ
(
dc
.
–
);

1058 
dc
.
–
 = 
NULL
;

1061 ià(
dc
.
‹¡_rg‘_groups
) {

1062 
	`sdsä“
(
dc
.
‹¡_rg‘_groups
);

1063 
dc
.
‹¡_rg‘_groups
 = 
NULL
;

1066 ià(
dc
.
check”
) {

1067 
	`sdsä“
(
dc
.
check”
);

1068 
dc
.
check”
 = 
NULL
;

1071 ià(
dc
.
ma¡”
) {

1072 
	`check_cÚn_cÚ‹xt_deš™
(
dc
.
ma¡”
);

1073 
	`ä“
(
dc
.
ma¡”
);

1074 
dc
.
ma¡”
 = 
NULL
;

1077 
	`de¡roy_check_d©a_th»ads
();

1078 
	}
}

1080 *
	$v¹_d©a_check”_run
(*
¬gs
)

1082 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

1084 
	`«Maš
(
dc
.
–
);

1086  
NULL
;

1087 
	}
}

1089 
	$v¹_¡¬t_d©a_check”
()

1091 
±h»ad_©Œ_t
 
©Œ
;

1092 
	`±h»ad_©Œ_š™
(&
©Œ
);

1093 
	`±h»ad_ü—‹
(&
dc
.
th»ad_id
,

1094 &
©Œ
, 
v¹_d©a_check”_run
, 
NULL
);

1095  
VRT_OK
;

1096 
	}
}

1098 
	$v¹_wa™_d©a_check”
()

1100 
	`±h»ad_još
(
dc
.
th»ad_id
, 
NULL
);

1102  
VRT_OK
;

1103 
	}
}

1105 
	g‹¡_Ãed_·u£
 = 0;

1107 
	$‹¡_if_Ãed_·u£
()

1109 
Ãed_·u£
;

1111 
	`upd©e_¡©e_g‘
(
‹¡_Ãed_·u£
,&
Ãed_·u£
);

1113 ià(
Ãed_·u£
)  1;

1115 
	}
}

1117 
	$‹¡_ÿn_cÚtšue
()

1119 
	`upd©e_¡©e_£t
(
‹¡_Ãed_·u£
,0);

1120 
	`upd©e_¡©e_£t
(
´oduû_th»ads_·u£_fšished_couÁ
,0);

1121 
	`upd©e_¡©e_£t
(
di¥©ch_th»ads_·u£_fšished_couÁ
,0);

1122 
	`upd©e_¡©e_£t
(
back’d_th»ads_·u£_fšished_couÁ
,0);

1123 
	}
}

1125 
	$‹¡_Ãed_to_·u£
()

1127 
	`upd©e_¡©e_£t
(
‹¡_Ãed_·u£
,1);

1128 
	}
}

1130 
	$Úe_´oduû_th»ad_·u£d
()

1132 
	`upd©e_¡©e_add
(
´oduû_th»ads_·u£_fšished_couÁ
,1);

1133 
	}
}

1135 
	$Úe_di¥©ch_th»ad_·u£d
()

1137 
	`upd©e_¡©e_add
(
di¥©ch_th»ads_·u£_fšished_couÁ
,1);

1138 
	}
}

1140 
	$Úe_back’d_th»ad_·u£d
()

1142 
	`upd©e_¡©e_add
(
back’d_th»ads_·u£_fšished_couÁ
,1);

1143 
	}
}

1145 
	$®l_´oduû_th»ads_·u£d
()

1147 
·u£d_th»ads
;

1149 
	`upd©e_¡©e_g‘
(
´oduû_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1150 ià(
·u£d_th»ads
 < 
´oduû_d©a_th»ads_couÁ
) {

1155 
	}
}

1157 
	$®l_di¥©ch_th»ads_·u£d
()

1159 
·u£d_th»ads
;

1161 
	`upd©e_¡©e_g‘
(
di¥©ch_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1162 ià(
·u£d_th»ads
 < 
di¥©ch_d©a_th»ads_couÁ
) {

1167 
	}
}

1169 
	$®l_back’d_th»ads_·u£d
()

1171 
·u£d_th»ads
;

1173 
	`upd©e_¡©e_g‘
(
back’d_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1174 ià(
·u£d_th»ads
 < 
back’d_th»ads_couÁ
) {

1179 
	}
}

1181 
	$®l_th»ads_·u£d
()

1183 
·u£d_th»ads
;

1185 
	`upd©e_¡©e_g‘
(
´oduû_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1186 ià(
·u£d_th»ads
 < 
´oduû_d©a_th»ads_couÁ
) {

1190 
	`upd©e_¡©e_g‘
(
di¥©ch_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1191 ià(
·u£d_th»ads
 < 
di¥©ch_d©a_th»ads_couÁ
) {

1195 
	`upd©e_¡©e_g‘
(
back’d_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1196 ià(
·u£d_th»ads
 < 
back’d_th»ads_couÁ
) {

1201 
	}
}

	@tests/vrt_check_data.h

1 #iâdeà
_VRT_CHECK_DATA_H_


2 
	#_VRT_CHECK_DATA_H_


	)

4 
v¹_d©a_check”_š™
(*
check”
, *
‹¡_rg‘_groups
);

5 
v¹_d©a_check”_deš™
();

7 
v¹_¡¬t_d©a_check”
();

8 
v¹_wa™_d©a_check”
();

10 
‹¡_if_Ãed_·u£
();

11 
‹¡_ÿn_cÚtšue
();

12 
‹¡_Ãed_to_·u£
();

14 
Úe_´oduû_th»ad_·u£d
();

15 
Úe_di¥©ch_th»ad_·u£d
();

16 
Úe_back’d_th»ad_·u£d
();

18 
®l_´oduû_th»ads_·u£d
();

19 
®l_di¥©ch_th»ads_·u£d
();

20 
®l_back’d_th»ads_·u£d
();

21 
®l_th»ads_·u£d
();

	@tests/vrt_dispatch_data.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

12 
	~<async.h
>

13 
	~<ad­‹rs/«.h
>

15 
	~<dhashk™.h
>

16 
	~<dli¡.h
>

17 
	~<dmtqueue.h
>

18 
	~<dlog.h
>

20 
	~<v¹_ut.h
>

21 
	~<v¹_public.h
>

22 
	~<v¿b‹¡.h
>

23 
	~<v¹_di¥©ch_d©a.h
>

24 
	~<v¹_´oduû_d©a.h
>

26 
	gdi¥©ch_d©a_th»ads_couÁ
;

27 
d¬¿y
 *
	gdi¥©ch_d©a_th»ads
 = 
NULL
;

29 
	gdi¥©ch_th»ads_·u£_fšished_couÁ
;

31 
	gtÙ®_‹¡ed_commªds_couÁ_³r_cyşe
 = 0;

32 
	gtÙ®_»¶y_”r_couÁ_³r_cyşe
 = 0;

33 
	gtÙ®_‹¡ed_commªds_couÁ
 = 0;

34 
	gtÙ®_»¶y_”r_couÁ
 = 0;

36 
	$g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
()

38 
couÁ
;

39 
	`upd©e_¡©e_g‘
(
tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
,&
couÁ
);

40  
couÁ
;

41 
	}
}

43 
	$g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
()

45 
couÁ
;

46 
	`upd©e_¡©e_g‘
(
tÙ®_»¶y_”r_couÁ_³r_cyşe
,&
couÁ
);

47  
couÁ
;

48 
	}
}

50 
	$»£t_tÙ®_couÁ_³r_cyşe
()

52 
	`upd©e_¡©e_£t
(
tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
,0);

53 
	`upd©e_¡©e_£t
(
tÙ®_»¶y_”r_couÁ_³r_cyşe
,0);

54 
	}
}

56 
	s»¶y_un™
 {

57 
	mtÙ®_couÁ
;

58 
	m»ûived_couÁ
;

59 
»disR•ly
 **
	m»¶ys
;

60 
d©a_un™
 *
	mdu
;

61 } 
	t»¶y_un™
;

63 
	$show_»¶ys_šcÚsi¡’cy_msg
(
d©a_un™
 *
du
, 
»disR•ly
 *
»¶y1
,„edisR•ly *
»¶y2
)

65 *
keyšdex
, 
numkeys
;

66 
sds
 
key
 = 
NULL
;

68 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
, du->
¬gv
, du->
¬gc
, &
numkeys
);

69 ià(
numkeys
 > 0) {

70 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

72 
	`ä“
(
keyšdex
);

74 ià(
key
) {

75 
	`log_hexdump
(
LOG_ERR
,
key
,
	`sd¦’
(key),

83 
du
->
dp
->
Çme
,

84 
»¶y1
->
ty³
, 
»¶y2
->type,

85 
»¶y1
->
ty³
==
REDIS_REPLY_STATUS
?»¶y1->
¡r
:"NULL",

86 
»¶y2
->
ty³
==
REDIS_REPLY_STATUS
?»¶y2->
¡r
:"NULL",

87 
»¶y1
->
ty³
==
REDIS_REPLY_ERROR
?»¶y1->
¡r
:"NULL",

88 
»¶y2
->
ty³
==
REDIS_REPLY_ERROR
?»¶y2->
¡r
:"NULL",

89 
»¶y1
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y1->
š‹g”
:0,

90 
»¶y2
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y2->
š‹g”
:0,

91 
»¶y1
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y1->
–em’ts
:0,

92 
»¶y2
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y2->
–em’ts
:0,

93 
	`sd¦’
(
key
));

95 
	`log_”rÜ
("%s command„eplys‡re inconsistency, "

101 
du
->
dp
->
Çme
,

102 
»¶y1
->
ty³
, 
»¶y2
->type,

103 
»¶y1
->
ty³
==
REDIS_REPLY_STATUS
?»¶y1->
¡r
:"NULL",

104 
»¶y2
->
ty³
==
REDIS_REPLY_STATUS
?»¶y2->
¡r
:"NULL",

105 
»¶y1
->
ty³
==
REDIS_REPLY_ERROR
?»¶y1->
¡r
:"NULL",

106 
»¶y2
->
ty³
==
REDIS_REPLY_ERROR
?»¶y2->
¡r
:"NULL",

107 
»¶y1
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y1->
š‹g”
:0,

108 
»¶y2
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y2->
š‹g”
:0,

109 
»¶y1
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y1->
–em’ts
:0,

110 
»¶y2
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y2->
–em’ts
:0);

113 
	}
}

115 
	$sÜt_»¶ys_if_Ãeded
(
»¶y_un™
 *
ru
)

117 
d©a_un™
 *
du
 = 
ru
->du;

118 
d©a_´oduûr
 *
dp
 = 
du
->dp;

119 
¡•
 = 0, 
idx_cmp
 = 0;

121 ià(
dp
->
cmd_ty³
&
TEST_CMD_TYPE_SET
) {

122 ià(!
	`¡rcmp
(
dp
->
Çme
,"smembers") ||

123 !
	`¡rcmp
(
dp
->
Çme
,"sunion") ||

124 !
	`¡rcmp
(
dp
->
Çme
,"sdiff") ||

125 !
	`¡rcmp
(
dp
->
Çme
,"sinter")) {

126 
¡•
 = 1;

128 } ià(
dp
->
cmd_ty³
&
TEST_CMD_TYPE_HASH
) {

129 ià(!
	`¡rcmp
(
dp
->
Çme
,"hkeys") ||

130 !
	`¡rcmp
(
dp
->
Çme
,"hvals")) {

131 
¡•
 = 1;

132 } ià(!
	`¡rcmp
(
dp
->
Çme
,"hgetall")) {

133 
¡•
 = 2;

134 
idx_cmp
 = 0;

138 ià(
¡•
 > 0) {

139 
i
;

140 
»disR•ly
 *
»¶y
;

141 
i
 = 0; i < 
ru
->
»ûived_couÁ
; i ++) {

142 
»¶y
 = 
ru
->
»¶ys
[
i
];

143 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
)

145 
	`sÜt_¬¿y_by_¡•
(
»¶y
->
–em’t
,„•ly->
–em’ts
,

146 
¡•
, 
idx_cmp
, 
»¶y_¡ršg_bš¬y_com·»
);

150  
VRT_OK
;

151 
	}
}

153 
	$check_»¶ys_if_§me
(
»¶y_un™
 *
ru
)

155 
j
;

156 
»disR•ly
 **
»¶ys
 = 
ru
->replys;

157 
»disR•ly
 *
»¶yb
, *
»¶y
;

159 
	`sÜt_»¶ys_if_Ãeded
(
ru
);

161 
»¶yb
 = 
»¶ys
[0];

163 
j
 = 1; j < 
ru
->
tÙ®_couÁ
 ; j ++) {

164 
»¶y
 = 
»¶ys
[
j
];

165 ià(
	`check_two_»¶ys_if_§me
(
»¶yb
, 
»¶y
)) {

166 
	`show_»¶ys_šcÚsi¡’cy_msg
(
ru
->
du
, 
»¶yb
, 
»¶y
);

172 
	}
}

174 
	sÿÎback_d©a
 {

175 
di¥©ch_d©a_th»ad
 *
	mddt
;

176 
»¶y_un™
 *
	mru
;

177 
	midx
;

180 
	$»¶y_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

181 
»t
;

182 
»disR•ly
 *
»¶y
;

183 
ÿÎback_d©a
 *
cbd
 = 
´ivd©a
;

184 
di¥©ch_d©a_th»ad
 *
ddt
 = 
cbd
->ddt;

185 
»¶y_un™
 *
ru
 = 
cbd
->ru;

187 ià(
r
 =ğ
NULL
) {

188 
»¶y
 = 
NULL
;

191 
»¶y
 = 
	`¡—l_hœedis_»di¤•ly
(
r
);

194 
ru
->
»¶ys
[
cbd
->
idx
] = 
»¶y
;

195 
ru
->
»ûived_couÁ
 ++;

196 
	`ä“
(
cbd
);

198 ià(
ru
->
»ûived_couÁ
 >ğru->
tÙ®_couÁ
) {

199 
j
;

201 
»t
 = 
	`check_»¶ys_if_§me
(
ru
);

202 ià(
»t
 =ğ1 && 
»¶y
 !ğ
NULL
) {

203 
d©a_un™
 *
du
 = 
ru
->du;

204 
d©a_´oduûr
 *
dp
 = 
du
->dp;

205 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

206 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
++;

210 ià(
dp
->
Ãed_ÿche_key_´oc
 !ğ
NULL
) {

211 
´oduû_scheme
 *
ps
 = 
du
->
d©a
;

212 ià(
dp
->
	`Ãed_ÿche_key_´oc
(
»¶y
)) {

213 
key_ÿche_¬¿y
 *
kı
 = 
	`kı_g‘_äom_ps
(
ps
, 
dp
);

214 
sds
 
key
 = 
	`g‘_Úe_key_äom_d©a_un™
(
du
);

215 
	`key_ÿche_¬¿y_šput
(
kı
,
key
,
	`sd¦’
(key));

221 
j
 = 0; j < 
ru
->
tÙ®_couÁ
; j ++) {

222 
	`ä“R•lyObjeù
(
ru
->
»¶ys
[
j
]);

223 
ru
->
»¶ys
[
j
] = 
NULL
;

225 
	`ä“
(
ru
->
»¶ys
);

226 
	`d©a_un™_put
(
ru
->
du
);

227 
	`ä“
(
ru
);

229 
ddt
->
couÁ_wa™_fÜ_»¶y
 --;

230 
	`ASSERT
(
ddt
->
couÁ_wa™_fÜ_»¶y
 >= 0);

232 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
++;

234 
	}
}

236 
	$di¥©ch_th»ad_£nd_d©a
(
di¥©ch_d©a_th»ad
 *
ddt
)

238 
couÁ_³r_time
 = 1000;

239 
d©a_un™
 *
du
;

241 (
du
 = 
	`dmtqueue_pİ
(
ddt
->
d©as
)è!ğ
NULL
) {

242 
»disAsyncCÚ‹xt
 *
aùx
;

243 
j
;

245 
size_t
 *
¬gvËn
 = 
	`m®loc
(
du
->
¬gc
*(size_t));

246 
»¶y_un™
 *
ru
 = 
	`m®loc
((reply_unit));

247 
ru
->
du
 = du;

248 
ru
->
tÙ®_couÁ
 = 
	`d¬¿y_n
(
ddt
->
abgs
);

249 
ru
->
»ûived_couÁ
 = 0;

250 
ru
->
»¶ys
 = 
	`m®loc
Ôu->
tÙ®_couÁ
*(
»disR•ly
 *));

251 
j
 = 0; j < 
du
->
¬gc
; j ++) {

252 
¬gvËn
[
j
] = 
	`sd¦’
(
du
->
¬gv
[j]);

254 
j
 = 0; j < 
	`d¬¿y_n
(
ddt
->
abgs
); j ++) {

255 
ÿÎback_d©a
 *
cbd
;

256 *
keyšdex
, 
numkeys
;

257 
ab‹¡_£rv”
 *
abs
;

259 
cbd
 = 
	`m®loc
((
ÿÎback_d©a
));

260 
cbd
->
ddt
 = ddt;

261 
cbd
->
ru
 =„u;

262 
cbd
->
idx
 = 
j
;

263 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
ddt
->
abgs
, 
j
);

265 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
, du->
¬gv
, du->
¬gc
, &
numkeys
);

266 ià(
numkeys
 == 0) {

267 
idx
;

268 
idx
 = ()
	`¿nd
()%
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
);

269 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
,
idx
);

271 
sds
 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

272 
abs
 = 
abg
->
	`g‘_back’d_£rv”
×bg,
key
,
	`sd¦’
(key));

274 
	`ä“
(
keyšdex
);

276 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
,

277 
du
->
hashv®ue
%
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
));

278 
aùx
 = 
cc
->actx;

279 
	`»disAsyncCommªdArgv
(
aùx
, 
»¶y_ÿÎback
, 
cbd
, 
du
->
¬gc
, du->
¬gv
, 
¬gvËn
);

281 
	`ä“
(
¬gvËn
);

283 
ddt
->
couÁ_wa™_fÜ_»¶y
 ++;

285 ià(
couÁ_³r_time
-- <= 0) ;

288  
VRT_OK
;

289 
	}
}

291 
	$di¥©ch_d©a_th»ad_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

293 
di¥©ch_d©a_th»ad
 *
ddt
 = 
ş›ÁD©a
;

295 
	`ASSERT
(
ev’tLoİ
 =ğ
ddt
->
–
);

298 ià(
ddt
->
·u£
) {

299 ià(!
	`‹¡_if_Ãed_·u£
()) {

300 
ddt
->
·u£
 = 0;

302 
ddt
->
üÚloİs
 ++;

307 ià(
ddt
->
couÁ_wa™_fÜ_»¶y
 < 4000 &&

308 !
	`dmtqueue_em±y
(
ddt
->
d©as
)) {

309 
	`di¥©ch_th»ad_£nd_d©a
(
ddt
);

313 ià(
	`‹¡_if_Ãed_·u£
() &&

314 
	`®l_´oduû_th»ads_·u£d
() &&

315 
	`®l_back’d_th»ads_·u£d
() &&

316 
	`dmtqueue_em±y
(
ddt
->
d©as
) &&

317 
	`dli¡L’gth
(
ddt
->
rd©as
) == 0) {

319 
ddt
->
·u£
 = 1;

322 
	`upd©e_¡©e_add
(
tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
,

323 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
);

324 
	`upd©e_¡©e_add
(
tÙ®_‹¡ed_commªds_couÁ
,

325 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
);

326 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
 = 0;

327 
	`upd©e_¡©e_add
(
tÙ®_»¶y_”r_couÁ_³r_cyşe
,

328 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
);

329 
	`upd©e_¡©e_add
(
tÙ®_»¶y_”r_couÁ
,

330 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
);

331 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
 = 0;

333 
	`Úe_di¥©ch_th»ad_·u£d
();

336 
ddt
->
üÚloİs
 ++;

337  1000/
ddt
->
hz
;

338 
	}
}

340 
	$cÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

341 
di¥©ch_d©a_th»ad
 *
ddt
 = 
c
->
d©a
;

342 ià(
¡©us
 !ğ
REDIS_OK
) {

343 
	`log_”rÜ
("E¼Ü: %s\n", 
c
->
”r¡r
);

349 
	}
}

351 
	$discÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

352 
di¥©ch_d©a_th»ad
 *
ddt
 = 
c
->
d©a
;

353 ià(
¡©us
 !ğ
REDIS_OK
) {

354 
	`log_”rÜ
("E¼Ü: %s\n", 
c
->
”r¡r
);

361 
	}
}

363 
	$di¥©ch_cÚn_cÚ‹xt_š™
(
cÚn_cÚ‹xt
 *
cc
, *
ho¡
, 
pÜt
)

365 
cc
->
ùx
 = 
NULL
;

366 
cc
->
aùx
 = 
NULL
;

368 
cc
->
aùx
 = 
	`»disAsyncCÚÃù
(
ho¡
, 
pÜt
);

369 ià(
cc
->
aùx
 =ğ
NULL
) {

370  
VRT_ERROR
;

373  
VRT_OK
;

374 
	}
}

376 
	$di¥©ch_cÚn_cÚ‹xt_deš™
(
cÚn_cÚ‹xt
 *
cc
)

378 ià(
cc
->
ùx
) {

379 
	`»disF»e
(
cc
->
ùx
);

380 
cc
->
ùx
 =ğ
NULL
;

383 ià(
cc
->
aùx
) {

384 
	`»disAsyncF»e
(
cc
->
aùx
);

385 
cc
->
aùx
 =ğ
NULL
;

387 
	}
}

389 
	$di¥©ch_d©a_th»ad_š™
(
di¥©ch_d©a_th»ad
 *
ddt
, *
‹¡_rg‘_groups
, 
cÚÃùiÚs
)

391 
i
, 
j
, 
k
;

393 
ddt
->
id
 = 0;

394 
ddt
->
th»ad_id
 = 0;

395 
ddt
->
–
 = 
NULL
;

396 
ddt
->
hz
 = 10;

397 
ddt
->
üÚloİs
 = 0;

398 
ddt
->
d©as
 = 
NULL
;

399 
ddt
->
rd©as
 = 
NULL
;

400 
ddt
->
abgs
 = 
NULL
;

401 
ddt
->
·u£
 = 0;

402 
ddt
->
couÁ_wa™_fÜ_»¶y
 = 0;

403 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
 = 0;

404 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
 = 0;

406 
ddt
->
–
 = 
	`«C»©eEv’tLoİ
(200);

407 ià(
ddt
->
–
 =ğ
NULL
) {

408  
VRT_ERROR
;

411 
ddt
->
d©as
 = 
	`dmtqueue_ü—‹
();

412 ià(
ddt
->
d©as
 =ğ
NULL
) {

413  
VRT_ERROR
;

416 ià(
	`dmtqueue_š™_w™h_lockqueue
(
ddt
->
d©as
, 
NULL
) != 0) {

417  
VRT_ERROR
;

420 
ddt
->
rd©as
 = 
	`dli¡C»©e
();

421 ià(
ddt
->
rd©as
 =ğ
NULL
) {

422  
VRT_ERROR
;

425 
ddt
->
abgs
 = 
	`ab‹¡_groups_ü—‹
(
‹¡_rg‘_groups
);

426 ià(
ddt
->
abgs
 =ğ
NULL
) {

427  
VRT_ERROR
;

431 
i
 = 0; i < 
	`d¬¿y_n
(
ddt
->
abgs
); i ++) {

432 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
ddt
->
abgs
, 
i
);

433 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

434 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

435 
abs
->
cÚn_cÚ‹xts
 = 
	`d¬¿y_ü—‹
(
cÚÃùiÚs
, (
cÚn_cÚ‹xt
));

436 
k
 = 0; k < 
cÚÃùiÚs
; k ++) {

437 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_push
(
abs
->
cÚn_cÚ‹xts
);

438 ià(
	`di¥©ch_cÚn_cÚ‹xt_š™
(
cc
,
abs
->
ho¡
,abs->
pÜt
è!ğ
VRT_OK
) {

439  
VRT_ERROR
;

441 
cc
->
aùx
->
d©a
 = 
ddt
;

442 
	`»disAeA‰ach
(
ddt
->
–
, 
cc
->
aùx
);

443 
	`»disAsyncS‘CÚÃùC®lback
(
cc
->
aùx
,
cÚÃù_ÿÎback
);

444 
	`»disAsyncS‘DiscÚÃùC®lback
(
cc
->
aùx
,
discÚÃù_ÿÎback
);

449 ià(
	`«C»©eTimeEv’t
(
ddt
->
–
, 1, 
di¥©ch_d©a_th»ad_üÚ
, ddt, 
NULL
è=ğ
AE_ERR
) {

450  
VRT_ERROR
;

453  
VRT_OK
;

454 
	}
}

456 
	$di¥©ch_d©a_th»ad_deš™
(
di¥©ch_d©a_th»ad
 *
ddt
)

458 ià(
ddt
->
–
) {

459 
	`«D–‘eEv’tLoİ
(
ddt
->
–
);

460 
ddt
->
–
 = 
NULL
;

463 ià(
ddt
->
d©as
) {

464 
	`dmtqueue_de¡roy
(
ddt
->
d©as
);

465 
ddt
->
d©as
 = 
NULL
;

468 ià(
ddt
->
abgs
) {

469 
i
, 
j
, 
k
;

471 
i
 = 0; i < 
	`d¬¿y_n
(
ddt
->
abgs
); i ++) {

472 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
ddt
->
abgs
, 
i
);

473 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

474 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

475 
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) > 0) {

476 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_pİ
(
abs
->
cÚn_cÚ‹xts
);

477 
	`di¥©ch_cÚn_cÚ‹xt_deš™
(
cc
);

482 
	`ab‹¡_groups_de¡roy
(
ddt
->
abgs
);

483 
ddt
->
abgs
 = 
NULL
;

485 
	}
}

487 
	$v¹_di¥©ch_d©a_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
, 
cÚÃùiÚs
)

489 
j
;

491 
di¥©ch_d©a_th»ads_couÁ
 = 
th»ads_couÁ
;

492 
di¥©ch_d©a_th»ads
 = 
	`d¬¿y_ü—‹
(
th»ads_couÁ
, (
di¥©ch_d©a_th»ad
));

493 ià(
di¥©ch_d©a_th»ads
 =ğ
NULL
) {

494  
VRT_ERROR
;

497 
j
 = 0; j < 
th»ads_couÁ
; j ++) {

498 
di¥©ch_d©a_th»ad
 *
ddt
 = 
	`d¬¿y_push
(
di¥©ch_d©a_th»ads
);

499 ià(
	`di¥©ch_d©a_th»ad_š™
(
ddt
, 
‹¡_rg‘_groups
, 
cÚÃùiÚs
è!ğ
VRT_OK
) {

500  
VRT_ERROR
;

502 
ddt
->
id
 = 
j
;

505  
VRT_OK
;

506 
	}
}

508 
	$v¹_di¥©ch_d©a_deš™
()

510 ià(
di¥©ch_d©a_th»ads
) {

511 
	`d¬¿y_n
(
di¥©ch_d©a_th»ads
) > 0) {

512 
di¥©ch_d©a_th»ad
 *
ddt
 = 
	`d¬¿y_pİ
(
di¥©ch_d©a_th»ads
);

513 
	`di¥©ch_d©a_th»ad_deš™
(
ddt
);

515 
	`d¬¿y_de¡roy
(
di¥©ch_d©a_th»ads
);

516 
di¥©ch_d©a_th»ads
 = 
NULL
;

518 
	}
}

520 *
	$v¹_di¥©ch_d©a_th»ad_run
(*
¬gs
)

522 
di¥©ch_d©a_th»ad
 *
ddt
 = 
¬gs
;

523 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

525 
	`«Maš
(
ddt
->
–
);

527  
NULL
;

528 
	}
}

530 
	$v¹_¡¬t_di¥©ch_d©a
()

532 
i
;

533 
i
 = 0; i < 
	`d¬¿y_n
(
di¥©ch_d©a_th»ads
); i ++) {

534 
±h»ad_©Œ_t
 
©Œ
;

535 
di¥©ch_d©a_th»ad
 *
ddt
;

536 
	`±h»ad_©Œ_š™
(&
©Œ
);

537 
ddt
 = 
	`d¬¿y_g‘
(
di¥©ch_d©a_th»ads
, 
i
);

538 
	`±h»ad_ü—‹
(&
ddt
->
th»ad_id
,

539 &
©Œ
, 
v¹_di¥©ch_d©a_th»ad_run
, 
ddt
);

542  
VRT_OK
;

543 
	}
}

545 
	$v¹_wa™_di¥©ch_d©a
()

547 
i
;

549 
i
 = 0; i < 
	`d¬¿y_n
(
di¥©ch_d©a_th»ads
); i ++){

550 
di¥©ch_d©a_th»ad
 *
ddt
 = 
	`d¬¿y_g‘
(
di¥©ch_d©a_th»ads
, 
i
);

551 
	`±h»ad_još
(
ddt
->
th»ad_id
, 
NULL
);

554  
VRT_OK
;

555 
	}
}

561 
	$d©a_di¥©ch
(
d©a_un™
 *
du
)

563 
th»ad_idx
;

564 
di¥©ch_d©a_th»ad
 *
ddt
;

565 
Ëngth
;

566 *
keyšdex
, 
numkeys
;

568 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
, du->
¬gv
, du->
¬gc
, &
numkeys
);

570 ià(
numkeys
 == 0) {

571 
du
->
hashv®ue
 = ()
	`¿nd
();

573 
sds
 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

574 
du
->
hashv®ue
 = ()
	`hash_üc32a
(
key
, 
	`sd¦’
(key));

576 
	`ä“
(
keyšdex
);

578 
th»ad_idx
 = 
du
->
hashv®ue
%
di¥©ch_d©a_th»ads_couÁ
;

579 
ddt
 = 
	`d¬¿y_g‘
(
di¥©ch_d©a_th»ads
, 
th»ad_idx
);

580 
Ëngth
 = 
	`dmtqueue_push
(
ddt
->
d©as
, 
du
);

581 ià(
Ëngth
 <= 0) {

582 
	`‹¡_log_”rÜ
("D©¨un™…ushØdi¥©chh»ad %d faed", 
ddt
->
id
);

584 } ià(
Ëngth
 > 2000) {

589 
	}
}

	@tests/vrt_dispatch_data.h

1 #iâdeà
_VRT_DISPATCH_DATA_H_


2 
	#_VRT_DISPATCH_DATA_H_


	)

4 
	~<d¬¿y.h
>

6 
	gab‹¡_group
;

7 
	gdli¡
;

8 
	gdmtqueue
;

9 
	gd©a_un™
;

10 
	g«Ev’tLoİ
;

12 
	sdi¥©ch_d©a_th»ad
 {

13 
	mid
;

14 
±h»ad_t
 
	mth»ad_id
;

16 
«Ev’tLoİ
 *
	m–
;

17 
	mhz
;

18 
	müÚloİs
;

20 
dmtqueue
 *
	md©as
;

22 
dli¡
 *
	mrd©as
;

25 
d¬¿y
 *
	mabgs
;

27 
	m·u£
;

29 
	mcouÁ_wa™_fÜ_»¶y
;

31 
	m»¶y_tÙ®_couÁ_³r_cyşe
;

32 
	m»¶y_ty³_”r_couÁ_³r_cyşe
;

33 } 
	tdi¥©ch_d©a_th»ad
;

35 
di¥©ch_d©a_th»ads_couÁ
;

37 
di¥©ch_th»ads_·u£_fšished_couÁ
;

39 
g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
();

40 
g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
();

41 
»£t_tÙ®_couÁ_³r_cyşe
();

43 
v¹_di¥©ch_d©a_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
, 
cÚÃùiÚs
);

44 
v¹_di¥©ch_d©a_deš™
();

46 
v¹_¡¬t_di¥©ch_d©a
();

47 
v¹_wa™_di¥©ch_d©a
();

49 
d©a_di¥©ch
(
d©a_un™
 *
du
);

	@tests/vrt_produce_data.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<as£¹.h
>

9 
	~<m©h.h
>

10 
	~<sys/¡©.h
>

11 
	~<sys/ut¢ame.h
>

13 
	~<d¥ecŸlcÚfig.h
>

15 
	~<hœedis.h
>

16 
	~<d¬¿y.h
>

17 
	~<dut.h
>

18 
	~<dlog.h
>

20 
	~<v¹_ut.h
>

21 
	~<v¹_public.h
>

22 
	~<v¿b‹¡.h
>

23 
	~<v¹_´oduû_d©a.h
>

25 
	#PRODUCE_KEY_CACHE_POOL_COUNT
 5

	)

27 
	s´oduû_th»ad
 {

28 
	mid
;

29 
±h»ad_t
 
	mth»ad_id
;

31 
´oduû_scheme
 *
	mps
;

33 
	m·u£
;

34 
	mloİtimes
;

35 } 
	t´oduû_th»ad
;

37 
d©a_´oduûr
 *
	gd–‘e_d©a_´oduûr
 = 
NULL
;

39 
	gkey_Ëngth_mš
;

40 
	gkey_Ëngth_max
;

41 
	gkey_Ëngth_¿nge_g­
;

42 
	gf›ld_Ëngth_max
;

43 
	g¡ršg_Ëngth_max
;

45 
	gcmd_ty³
;

47 
	gkey_ÿche_poŞs_couÁ
 = 0;

49 
d¬¿y
 
	gÃeded_cmd_ty³_´oduûr
;

50 
	gÃeded_cmd_ty³_´oduûr_couÁ
;

52 
	g´oduû_d©a_th»ads_couÁ
;

53 
d¬¿y
 
	g´oduû_th»ads
;

55 
	g´oduû_th»ads_·u£_fšished_couÁ
;

57 
	gnÚ_em±y_kıs_couÁ
 = 0;

58 
	gnÚ_em±y_kıs_idx
[
PRODUCE_KEY_CACHE_POOL_COUNT
] = {-1};

60 
sds
 
	$g‘_¿ndom_ÿched_key
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
)

62 
key_ÿche_¬¿y
 *
kı
 = 
	`kı_g‘_äom_ps
(
ps
,
dp
);

63  
	`key_ÿche_¬¿y_¿ndom
(
kı
);

64 
	}
}

66 
	$g‘_¿ndom_št
()

68 ià(
	`¿nd
()%2 == 1) {

69  0 - ()
	`¿nd
();

71  ()
	`¿nd
();

73 
	}
}

75 
	$g‘_¿ndom_unsigÃd_št
()

77  ()
	`¿nd
();

78 
	}
}

80 
	$g‘_¿ndom_ch¬
()

82  ()
	`¿nd
()%250 + 5;

84 
	}
}

86 
sds
 
	$g‘_¿ndom_key
()

88 
i
, 
Ën
;

89 
sds
 
¡r
 = 
	`sd£m±y
();

91 
Ën
 = 
key_Ëngth_¿nge_g­
==0?
key_Ëngth_mš
:

92 (
	`g‘_¿ndom_unsigÃd_št
()%
key_Ëngth_¿nge_g­
+
key_Ëngth_mš
);

93 ià(
Ën
 == 0)†en ++;

94 
¡r
 = 
	`sdsMakeRoomFÜ
(¡r,(
size_t
)
Ën
);

95 
	`sdsInüL’
(
¡r
, ()
Ën
);

97 
i
 = 0; i < 
Ën
; i ++) {

98 
¡r
[
i
] = ()
	`g‘_¿ndom_ch¬
();

101  
¡r
;

102 
	}
}

104 
sds
 
	$g‘_¿ndom_¡ršg
()

106 
i
, 
Ën
;

107 
sds
 
¡r
 = 
	`sd£m±y
();

109 
Ën
 = 
	`g‘_¿ndom_unsigÃd_št
()%
¡ršg_Ëngth_max
;

110 
¡r
 = 
	`sdsMakeRoomFÜ
(¡r,(
size_t
)
Ën
);

111 
	`sdsInüL’
(
¡r
, ()
Ën
);

113 
i
 = 0; i < 
Ën
; i ++) {

114 
¡r
[
i
] = 
	`g‘_¿ndom_ch¬
();

117  
¡r
;

118 
	}
}

120 
sds
 
	$g‘_¿ndom_æßt_¡r
()

122 
decim®_Ën
;

123 
sds
 
¡r
;

125 ià(
	`¿nd
()%2 == 1) {

126 
¡r
 = 
	`sd¢ew
("-");

128 
¡r
 = 
	`sd£m±y
();

131 ià(
	`¿nd
()%2 == 1) {

132 
¡r
 = 
	`sdsÿtfmt
(str,"%u.%u",

133 
	`g‘_¿ndom_unsigÃd_št
(),

134 
	`g‘_¿ndom_unsigÃd_št
());

136 
¡r
 = 
	`sdsÿtfmt
(str,"%u",

137 
	`g‘_¿ndom_unsigÃd_št
());

140  
¡r
;

141 
	}
}

143 
	#ZSET_RANGE_MIN_MAX_TYPE_RANK
 0

	)

144 
	#ZSET_RANGE_MIN_MAX_TYPE_SCORE
 1

	)

145 
	#ZSET_RANGE_MIN_MAX_TYPE_LEX
 2

	)

146 
sds
 *
	$g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
¿nge_ty³
)

148 
sds
 *
¿nge
;

149 
´obab™y
 = 
	`¿nd
()%100;

151 
¿nge
 = 
	`m®loc
(2*(
sds
));

152 ià(
¿nge_ty³
 =ğ
ZSET_RANGE_MIN_MAX_TYPE_RANK
) {

153 
mš
 = 
	`g‘_¿ndom_unsigÃd_št
();

154 
max
 = 
	`g‘_¿ndom_unsigÃd_št
();

156 ià(
´obab™y
 >ğ95 && 
mš
 <ğ
max
 ||

157 
´obab™y
 < 95 && 
mš
 > 
max
) {

158 
¿nge
[0] = 
	`sdsäomlÚglÚg
(()
max
);

159 
¿nge
[1] = 
	`sdsäomlÚglÚg
(()
mš
);

161 
¿nge
[0] = 
	`sdsäomlÚglÚg
(()
mš
);

162 
¿nge
[1] = 
	`sdsäomlÚglÚg
(()
max
);

164 } ià(
¿nge_ty³
 =ğ
ZSET_RANGE_MIN_MAX_TYPE_SCORE
) {

165 
sds
 
mš_¡r
 = 
	`g‘_¿ndom_æßt_¡r
();

166 
sds
 
max_¡r
 = 
	`g‘_¿ndom_æßt_¡r
();

167 
mš
, 
max
;

168 *
•Œ
;

169 
sds
 
sw­
;

170 
mš_´obab™y
 = 
	`¿nd
()%3;

171 
max_´obab™y
 = 
	`¿nd
()%3;

173 
mš
 = 
	`¡¹od
(
mš_¡r
,&
•Œ
);

174 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
mš
)) {

175 
	`sdsä“
(
mš_¡r
);

176 
	`sdsä“
(
max_¡r
);

177 
	`ä“
(
¿nge
);

178  
NULL
;

180 
max
 = 
	`¡¹od
(
max_¡r
,&
•Œ
);

181 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
max
)) {

182 
	`sdsä“
(
mš_¡r
);

183 
	`sdsä“
(
max_¡r
);

184 
	`ä“
(
¿nge
);

185  
NULL
;

187 ià(
´obab™y
 >ğ95 && 
mš
 <ğ
max
 ||

188 
´obab™y
 < 95 && 
mš
 > 
max
) {

189 
sw­
 = 
mš_¡r
;

190 
mš_¡r
 = 
max_¡r
;

191 
max_¡r
 = 
sw­
;

194 ià(
mš_´obab™y
 == 0) {

195 
¿nge
[0] = 
	`sd¢ew
("-inf");

196 } ià(
mš_´obab™y
 == 1) {

197 
¿nge
[0] = 
	`sd¢ew
("(");

198 
¿nge
[0] = 
	`sdsÿtfmt
Ôªge[0],"%S",
mš_¡r
);

199 
	`sdsä“
(
mš_¡r
);

201 
¿nge
[0] = 
mš_¡r
;

203 ià(
max_´obab™y
 == 0) {

204 
¿nge
[1] = 
	`sd¢ew
("+inf");

205 } ià(
max_´obab™y
 == 1) {

206 
¿nge
[1] = 
	`sd¢ew
("(");

207 
¿nge
[1] = 
	`sdsÿtfmt
Ôªge[1],"%S",
max_¡r
);

208 
	`sdsä“
(
max_¡r
);

210 
¿nge
[1] = 
max_¡r
;

212 } ià(
¿nge_ty³
 =ğ
ZSET_RANGE_MIN_MAX_TYPE_LEX
) {

213 
sds
 
mš_¡r
 = 
	`g‘_¿ndom_¡ršg
();

214 
sds
 
max_¡r
 = 
	`g‘_¿ndom_¡ršg
();

215 
sds
 
sw­
;

216 
mš_´obab™y
 = 
	`¿nd
()%3;

217 
max_´obab™y
 = 
	`¿nd
()%3;

219 ià(
´obab™y
 >ğ95 && 
	`sdscmp
(
mš_¡r
,
max_¡r
) < 0 ||

220 
´obab™y
 < 95 && 
	`sdscmp
(
mš_¡r
,
max_¡r
) > 0) {

221 
sw­
 = 
mš_¡r
;

222 
mš_¡r
 = 
max_¡r
;

223 
max_¡r
 = 
sw­
;

226 ià(
mš_´obab™y
 == 0) {

227 
¿nge
[0] = 
	`sd¢ew
("-");

228 } ià(
mš_´obab™y
 == 1) {

229 
¿nge
[0] = 
	`sd¢ew
("(");

230 
¿nge
[0] = 
	`sdsÿtfmt
Ôªge[0],"%S",
mš_¡r
);

231 
	`sdsä“
(
mš_¡r
);

233 
¿nge
[0] = 
	`sd¢ew
("[");

234 
¿nge
[0] = 
	`sdsÿtfmt
Ôªge[0],"%S",
mš_¡r
);

235 
	`sdsä“
(
mš_¡r
);

237 ià(
max_´obab™y
 == 0) {

238 
¿nge
[1] = 
	`sd¢ew
("+");

239 } ià(
max_´obab™y
 == 1) {

240 
¿nge
[1] = 
	`sd¢ew
("(");

241 
¿nge
[1] = 
	`sdsÿtfmt
Ôªge[1],"%S",
max_¡r
);

242 
	`sdsä“
(
max_¡r
);

244 
¿nge
[1] = 
	`sd¢ew
("[");

245 
¿nge
[1] = 
	`sdsÿtfmt
Ôªge[1],"%S",
max_¡r
);

246 
	`sdsä“
(
max_¡r
);

249 
	`ä“
(
¿nge
);

250 
¿nge
 = 
NULL
;

253  
¿nge
;

254 
	}
}

256 
	$g‘_¿ndom_f›ld_Ën
()

258  
	`g‘_¿ndom_unsigÃd_št
()%
f›ld_Ëngth_max
 + 1;

259 
	}
}

261 
sds
 
	$g‘_¿ndom_key_w™h_h™_¿tio
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
)

263 
sds
 
key
;

264 ià(
ps
->
h™_¿tio_¬¿y
[ps->
h™_¿tio_idx
++] == 0) {

265 
key
 = 
	`g‘_¿ndom_key
();

267 
key
 = 
	`g‘_¿ndom_ÿched_key
(
ps
,
dp
);

268 ià(
key
 =ğ
NULL
èkey = 
	`g‘_¿ndom_key
();

270 ià(
ps
->
h™_¿tio_idx
 >ğps->
h™_¿tio_¬¿y_Ën
) {

271 
ps
->
h™_¿tio_idx
 = 0;

273  
key
;

274 
	}
}

277 
	$nck_wh’_nÛ¼Ü
(
»disR•ly
 *
»¶y
)

279 ià(
»¶y
 =ğ
NULL
)  0;

281 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

286 
	}
}

288 
	$nck_wh’_ok
(
»disR•ly
 *
»¶y
)

290 ià(
»¶y
 =ğ
NULL
)  0;

292 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STATUS
 &&

293 !
	`¡rcmp
(
»¶y
->
¡r
, "OK")) {

298 
	}
}

300 
	$nck_wh’_¡r
(
»disR•ly
 *
»¶y
)

302 ià(
»¶y
 =ğ
NULL
)  0;

304 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
) {

309 
	}
}

311 
	$nck_wh’_unsigÃd_š‹g”
(
»disR•ly
 *
»¶y
)

313 ià(
»¶y
 =ğ
NULL
)  0;

315 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

316 
»¶y
->
š‹g”
 >= 0) {

321 
	}
}

323 
	$nck_wh’_nÚz”o_unsigÃd_š‹g”
(
»disR•ly
 *
»¶y
)

325 ià(
»¶y
 =ğ
NULL
)  0;

327 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

328 
»¶y
->
š‹g”
 > 0) {

333 
	}
}

335 
	$nck_wh’_z”o_Ü_Úe
(
»disR•ly
 *
»¶y
)

337 ià(
»¶y
 =ğ
NULL
)  0;

339 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

340 (
»¶y
->
š‹g”
 == 0 ||„eply->integer == 1)) {

345 
	}
}

347 
	$nck_wh’_Úe
(
»disR•ly
 *
»¶y
)

349 ià(
»¶y
 =ğ
NULL
)  0;

351 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

352 
»¶y
->
š‹g”
 == 1) {

357 
	}
}

361 
d©a_un™
 *
	$g‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

363 
d©a_un™
 *
du
;

365 
du
 = 
	`d©a_un™_g‘
();

366 
du
->
dp
 = dp;

367 
du
->
¬gc
 = 2;

368 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

369 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

370 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

372  
du
;

373 
	}
}

375 
d©a_un™
 *
	$£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

377 
d©a_un™
 *
du
;

379 
du
 = 
	`d©a_un™_g‘
();

380 
du
->
dp
 = dp;

381 
du
->
¬gc
 = 3;

382 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

383 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

384 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

385 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

387  
du
;

388 
	}
}

390 
d©a_un™
 *
	$£Šx_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

392 
d©a_un™
 *
du
;

394 
du
 = 
	`d©a_un™_g‘
();

395 
du
->
dp
 = dp;

396 
du
->
¬gc
 = 3;

397 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

398 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

399 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

400 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

402  
du
;

403 
	}
}

406 
	$£Šx_cmd_nck
(
»disR•ly
 *
»¶y
)

408 ià(
»¶y
 =ğ
NULL
)  0;

410 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

411 
»¶y
->
š‹g”
 == 1) {

416 
	}
}

418 
d©a_un™
 *
	$£‹x_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

420 
d©a_un™
 *
du
;

422 
du
 = 
	`d©a_un™_g‘
();

423 
du
->
dp
 = dp;

424 
du
->
¬gc
 = 4;

425 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

426 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

427 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

428 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

429 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

431  
du
;

432 
	}
}

434 
d©a_un™
 *
	$p£‹x_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

436 
d©a_un™
 *
du
;

438 
du
 = 
	`d©a_un™_g‘
();

439 
du
->
dp
 = dp;

440 
du
->
¬gc
 = 4;

441 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

442 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

443 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

444 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

445 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

447  
du
;

448 
	}
}

450 
d©a_un™
 *
	$d–_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

452 
d©a_un™
 *
du
;

454 
du
 = 
	`d©a_un™_g‘
();

455 
du
->
dp
 = dp;

456 
du
->
¬gc
 = 2;

457 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

458 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

459 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

461  
du
;

462 
	}
}

464 
d©a_un™
 *
	$expœe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

466 
d©a_un™
 *
du
;

468 
du
 = 
	`d©a_un™_g‘
();

469 
du
->
dp
 = dp;

470 
du
->
¬gc
 = 3;

471 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

472 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

473 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

474 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

476  
du
;

477 
	}
}

479 
d©a_un™
 *
	$expœ—t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

481 
d©a_un™
 *
du
;

483 
du
 = 
	`d©a_un™_g‘
();

484 
du
->
dp
 = dp;

485 
du
->
¬gc
 = 3;

486 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

487 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

488 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

489 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`v¹_m£c_now
()/1000LL+
	`¿nd
()%10000);

491  
du
;

492 
	}
}

494 
d©a_un™
 *
	$exi¡s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

496 
d©a_un™
 *
du
;

498 
du
 = 
	`d©a_un™_g‘
();

499 
du
->
dp
 = dp;

500 
du
->
¬gc
 = 2;

501 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

502 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

503 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

505  
du
;

506 
	}
}

508 
d©a_un™
 *
	$‰l_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

510 
d©a_un™
 *
du
;

512 
du
 = 
	`d©a_un™_g‘
();

513 
du
->
dp
 = dp;

514 
du
->
¬gc
 = 2;

515 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

516 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

517 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

519  
du
;

520 
	}
}

522 
d©a_un™
 *
	$±_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

524 
d©a_un™
 *
du
;

526 
du
 = 
	`d©a_un™_g‘
();

527 
du
->
dp
 = dp;

528 
du
->
¬gc
 = 2;

529 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

530 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

531 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

533  
du
;

534 
	}
}

536 
d©a_un™
 *
	$šü_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

538 
d©a_un™
 *
du
;

540 
du
 = 
	`d©a_un™_g‘
();

541 
du
->
dp
 = dp;

542 
du
->
¬gc
 = 2;

543 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

544 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

545 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

547  
du
;

548 
	}
}

550 
d©a_un™
 *
	$deü_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

552 
d©a_un™
 *
du
;

554 
du
 = 
	`d©a_un™_g‘
();

555 
du
->
dp
 = dp;

556 
du
->
¬gc
 = 2;

557 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

558 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

559 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

561  
du
;

562 
	}
}

564 
d©a_un™
 *
	$šüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

566 
d©a_un™
 *
du
;

568 
du
 = 
	`d©a_un™_g‘
();

569 
du
->
dp
 = dp;

570 
du
->
¬gc
 = 3;

571 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

572 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

573 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

574 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

576  
du
;

577 
	}
}

579 
d©a_un™
 *
	$deüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

581 
d©a_un™
 *
du
;

583 
du
 = 
	`d©a_un™_g‘
();

584 
du
->
dp
 = dp;

585 
du
->
¬gc
 = 3;

586 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

587 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

588 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

589 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

591  
du
;

592 
	}
}

594 
d©a_un™
 *
	$­³nd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

596 
d©a_un™
 *
du
;

598 
du
 = 
	`d©a_un™_g‘
();

599 
du
->
dp
 = dp;

600 
du
->
¬gc
 = 3;

601 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

602 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

603 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

604 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

606  
du
;

607 
	}
}

610 
	$­³nd_cmd_nck
(
»disR•ly
 *
»¶y
)

612 ià(
»¶y
 =ğ
NULL
)  0;

614 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

619 
	}
}

621 
d©a_un™
 *
	$¡¾’_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

623 
d©a_un™
 *
du
;

625 
du
 = 
	`d©a_un™_g‘
();

626 
du
->
dp
 = dp;

627 
du
->
¬gc
 = 2;

628 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

629 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

630 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

632  
du
;

633 
	}
}

635 
d©a_un™
 *
	$g‘£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

637 
d©a_un™
 *
du
;

639 
du
 = 
	`d©a_un™_g‘
();

640 
du
->
dp
 = dp;

641 
du
->
¬gc
 = 3;

642 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

643 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

644 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

645 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

647  
du
;

648 
	}
}

650 
d©a_un™
 *
	$šübyæßt_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

652 
d©a_un™
 *
du
;

654 
du
 = 
	`d©a_un™_g‘
();

655 
du
->
dp
 = dp;

656 
du
->
¬gc
 = 3;

657 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

658 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

659 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

660 
du
->
¬gv
[2] = 
	`g‘_¿ndom_æßt_¡r
();

662  
du
;

663 
	}
}

665 
d©a_un™
 *
	$£tb™_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

667 
d©a_un™
 *
du
;

669 
du
 = 
	`d©a_un™_g‘
();

670 
du
->
dp
 = dp;

671 
du
->
¬gc
 = 4;

672 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

673 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

674 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

675 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
()%30000);

676 ià(
	`¿nd
()%2) {

677 
du
->
¬gv
[3] = 
	`sd¢ew
("1");

679 
du
->
¬gv
[3] = 
	`sd¢ew
("0");

682  
du
;

683 
	}
}

685 
d©a_un™
 *
	$g‘b™_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

687 
d©a_un™
 *
du
;

689 
du
 = 
	`d©a_un™_g‘
();

690 
du
->
dp
 = dp;

691 
du
->
¬gc
 = 3;

692 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

693 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

694 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

695 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
()%30000);

697  
du
;

698 
	}
}

700 
d©a_un™
 *
	$£Œªge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

702 
d©a_un™
 *
du
;

704 
du
 = 
	`d©a_un™_g‘
();

705 
du
->
dp
 = dp;

706 
du
->
¬gc
 = 4;

707 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

708 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

709 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

710 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
()%30000);

711 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

713  
du
;

714 
	}
}

716 
d©a_un™
 *
	$g‘¿nge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

718 
d©a_un™
 *
du
;

720 
du
 = 
	`d©a_un™_g‘
();

721 
du
->
dp
 = dp;

722 
du
->
¬gc
 = 4;

723 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

724 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

725 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

726 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

727 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

729  
du
;

730 
	}
}

732 
d©a_un™
 *
	$b™couÁ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

734 
d©a_un™
 *
du
;

735 
w™h_¿nge
 = 0;

737 ià(
	`¿nd
()%2)

738 
w™h_¿nge
 = 1;

740 
du
 = 
	`d©a_un™_g‘
();

741 
du
->
dp
 = dp;

742 
du
->
¬gc
 = 
w™h_¿nge
?4:2;

743 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

744 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

745 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

746 ià(
w™h_¿nge
) {

747 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

748 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

750  
du
;

751 
	}
}

753 
d©a_un™
 *
	$b™pos_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

755 
d©a_un™
 *
du
;

756 
w™h_¿nge
 = 0;

757 
´obab™y
 = 
	`¿nd
()%3;

759 ià(
´obab™y
 == 0)

760 
w™h_¿nge
 = 0;

761 ià(
´obab™y
 == 1)

762 
w™h_¿nge
 = 1;

763 ià(
´obab™y
 == 2)

764 
w™h_¿nge
 = 2;

766 
du
 = 
	`d©a_un™_g‘
();

767 
du
->
dp
 = dp;

768 
du
->
¬gc
 = 
w™h_¿nge
==0?3:(with_range==1?4:5);

769 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

770 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

771 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

772 ià(
	`¿nd
()%2)

773 
du
->
¬gv
[2] = 
	`sd¢ew
("0");

775 
du
->
¬gv
[2] = 
	`sd¢ew
("1");

776 ià(
w™h_¿nge
 > 0)

777 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

778 ià(
w™h_¿nge
 == 2)

779 
du
->
¬gv
[4] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

781  
du
;

782 
	}
}

784 
d©a_un™
 *
	$mg‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

786 
d©a_un™
 *
du
;

788 
du
 = 
	`d©a_un™_g‘
();

789 
du
->
dp
 = dp;

790 
du
->
¬gc
 = 2;

791 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

792 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

793 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

795  
du
;

796 
	}
}

798 
d©a_un™
 *
	$m£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

800 
d©a_un™
 *
du
;

802 
du
 = 
	`d©a_un™_g‘
();

803 
du
->
dp
 = dp;

804 
du
->
¬gc
 = 3;

805 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

806 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

807 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

808 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

810  
du
;

811 
	}
}

813 
d©a_un™
 *
	$h£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

815 
d©a_un™
 *
du
;

817 
du
 = 
	`d©a_un™_g‘
();

818 
du
->
dp
 = dp;

819 
du
->
¬gc
 = 4;

820 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

821 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

822 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

823 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

824 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

826  
du
;

827 
	}
}

829 
d©a_un™
 *
	$hg‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

831 
d©a_un™
 *
du
;

833 
du
 = 
	`d©a_un™_g‘
();

834 
du
->
dp
 = dp;

835 
du
->
¬gc
 = 3;

836 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

837 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

838 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

839 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

841  
du
;

842 
	}
}

844 
d©a_un™
 *
	$hËn_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

846 
d©a_un™
 *
du
;

848 
du
 = 
	`d©a_un™_g‘
();

849 
du
->
dp
 = dp;

850 
du
->
¬gc
 = 2;

851 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

852 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

853 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

855  
du
;

856 
	}
}

858 
d©a_un™
 *
	$hd–_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

860 
d©a_un™
 *
du
;

861 
j
, 
f›ld_Ëngth
;

863 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

865 
du
 = 
	`d©a_un™_g‘
();

866 
du
->
dp
 = dp;

867 
du
->
¬gc
 = 2 + 
f›ld_Ëngth
;

868 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

869 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

870 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

871 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

872 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

875  
du
;

876 
	}
}

878 
d©a_un™
 *
	$hexi¡s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

880 
d©a_un™
 *
du
;

882 
du
 = 
	`d©a_un™_g‘
();

883 
du
->
dp
 = dp;

884 
du
->
¬gc
 = 3;

885 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

886 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

887 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

888 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

890  
du
;

891 
	}
}

893 
d©a_un™
 *
	$hkeys_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

895 
d©a_un™
 *
du
;

897 
du
 = 
	`d©a_un™_g‘
();

898 
du
->
dp
 = dp;

899 
du
->
¬gc
 = 2;

900 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

901 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

902 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

904  
du
;

905 
	}
}

907 
d©a_un™
 *
	$hv®s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

909 
d©a_un™
 *
du
;

911 
du
 = 
	`d©a_un™_g‘
();

912 
du
->
dp
 = dp;

913 
du
->
¬gc
 = 2;

914 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

915 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

916 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

918  
du
;

919 
	}
}

921 
d©a_un™
 *
	$hg‘®l_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

923 
d©a_un™
 *
du
;

925 
du
 = 
	`d©a_un™_g‘
();

926 
du
->
dp
 = dp;

927 
du
->
¬gc
 = 2;

928 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

929 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

930 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

932  
du
;

933 
	}
}

935 
d©a_un™
 *
	$hšüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

937 
d©a_un™
 *
du
;

939 
du
 = 
	`d©a_un™_g‘
();

940 
du
->
dp
 = dp;

941 
du
->
¬gc
 = 4;

942 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

943 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

944 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

945 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

946 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
());

948  
du
;

949 
	}
}

951 
d©a_un™
 *
	$hšübyæßt_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

953 
d©a_un™
 *
du
;

955 
du
 = 
	`d©a_un™_g‘
();

956 
du
->
dp
 = dp;

957 
du
->
¬gc
 = 4;

958 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

959 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

960 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

961 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

962 
du
->
¬gv
[3] = 
	`g‘_¿ndom_æßt_¡r
();

964  
du
;

965 
	}
}

967 
d©a_un™
 *
	$hmg‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

969 
d©a_un™
 *
du
;

970 
j
, 
f›ld_Ëngth
;

972 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

974 
du
 = 
	`d©a_un™_g‘
();

975 
du
->
dp
 = dp;

976 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

977 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

978 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

979 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

980 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

981 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

984  
du
;

985 
	}
}

987 
d©a_un™
 *
	$hm£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

989 
d©a_un™
 *
du
;

990 
j
, 
f›ld_Ëngth
;

992 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

994 
du
 = 
	`d©a_un™_g‘
();

995 
du
->
dp
 = dp;

996 
du
->
¬gc
 = 2+
f›ld_Ëngth
*2;

997 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

998 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

999 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1000 
j
 = 2; j < 2+
f›ld_Ëngth
*2; j += 2) {

1001 
du
->
¬gv
[
j
] = 
	`g‘_¿ndom_¡ršg
();

1002 
du
->
¬gv
[
j
+1] = 
	`g‘_¿ndom_¡ršg
();

1005  
du
;

1006 
	}
}

1008 
d©a_un™
 *
	$h£Šx_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1010 
d©a_un™
 *
du
;

1012 
du
 = 
	`d©a_un™_g‘
();

1013 
du
->
dp
 = dp;

1014 
du
->
¬gc
 = 4;

1015 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1016 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1017 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1018 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1019 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1021  
du
;

1022 
	}
}

1024 
d©a_un™
 *
	$h¡¾’_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1026 
d©a_un™
 *
du
;

1028 
du
 = 
	`d©a_un™_g‘
();

1029 
du
->
dp
 = dp;

1030 
du
->
¬gc
 = 3;

1031 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1032 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1033 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1034 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1036  
du
;

1037 
	}
}

1039 
d©a_un™
 *
	$½ush_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1041 
d©a_un™
 *
du
;

1042 
j
, 
f›ld_Ëngth
;

1044 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1046 
du
 = 
	`d©a_un™_g‘
();

1047 
du
->
dp
 = dp;

1048 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1049 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1050 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1051 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1052 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1053 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1056  
du
;

1057 
	}
}

1060 
	$½ush_cmd_nck
(
»disR•ly
 *
»¶y
)

1062 ià(
»¶y
 =ğ
NULL
)  0;

1064 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1069 
	}
}

1071 
d©a_un™
 *
	$Íush_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1073 
d©a_un™
 *
du
;

1074 
j
, 
f›ld_Ëngth
;

1076 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1078 
du
 = 
	`d©a_un™_g‘
();

1079 
du
->
dp
 = dp;

1080 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1081 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1082 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1083 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1085 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1086 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1089  
du
;

1090 
	}
}

1092 
d©a_un™
 *
	$Ìªge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1094 
d©a_un™
 *
du
;

1096 
du
 = 
	`d©a_un™_g‘
();

1097 
du
->
dp
 = dp;

1098 
du
->
¬gc
 = 4;

1099 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1100 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1101 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1102 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1103 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1105  
du
;

1106 
	}
}

1108 
d©a_un™
 *
	$½İ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1110 
d©a_un™
 *
du
;

1112 
du
 = 
	`d©a_un™_g‘
();

1113 
du
->
dp
 = dp;

1114 
du
->
¬gc
 = 2;

1115 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1116 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1117 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1119  
du
;

1120 
	}
}

1122 
d©a_un™
 *
	$Íİ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1124 
d©a_un™
 *
du
;

1126 
du
 = 
	`d©a_un™_g‘
();

1127 
du
->
dp
 = dp;

1128 
du
->
¬gc
 = 2;

1129 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1130 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1131 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1133  
du
;

1134 
	}
}

1136 
d©a_un™
 *
	$Î’_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1138 
d©a_un™
 *
du
;

1140 
du
 = 
	`d©a_un™_g‘
();

1141 
du
->
dp
 = dp;

1142 
du
->
¬gc
 = 2;

1143 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1144 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1145 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1147  
du
;

1148 
	}
}

1150 
d©a_un™
 *
	$Ìem_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1152 
d©a_un™
 *
du
;

1154 
du
 = 
	`d©a_un™_g‘
();

1155 
du
->
dp
 = dp;

1156 
du
->
¬gc
 = 4;

1157 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1158 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1159 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1160 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1161 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1163  
du
;

1164 
	}
}

1166 
d©a_un™
 *
	$Érim_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1168 
d©a_un™
 *
du
;

1170 
du
 = 
	`d©a_un™_g‘
();

1171 
du
->
dp
 = dp;

1172 
du
->
¬gc
 = 4;

1173 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1174 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1175 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1176 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1177 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1179  
du
;

1180 
	}
}

1182 
d©a_un™
 *
	$lšdex_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1184 
d©a_un™
 *
du
;

1186 
du
 = 
	`d©a_un™_g‘
();

1187 
du
->
dp
 = dp;

1188 
du
->
¬gc
 = 3;

1189 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1190 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1191 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1192 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1194  
du
;

1195 
	}
}

1197 
d©a_un™
 *
	$l£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1199 
d©a_un™
 *
du
;

1201 
du
 = 
	`d©a_un™_g‘
();

1202 
du
->
dp
 = dp;

1203 
du
->
¬gc
 = 4;

1204 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1205 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1206 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1207 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1208 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1210  
du
;

1211 
	}
}

1213 
d©a_un™
 *
	$§dd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1215 
d©a_un™
 *
du
;

1216 
j
, 
f›ld_Ëngth
;

1218 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1220 
du
 = 
	`d©a_un™_g‘
();

1221 
du
->
dp
 = dp;

1222 
du
->
¬gc
 = 2 + 
f›ld_Ëngth
;

1223 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1224 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1225 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1226 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1227 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1230  
du
;

1231 
	}
}

1233 
d©a_un™
 *
	$smemb”s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1235 
d©a_un™
 *
du
;

1237 
du
 = 
	`d©a_un™_g‘
();

1238 
du
->
dp
 = dp;

1239 
du
->
¬gc
 = 2;

1240 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1241 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1242 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1244  
du
;

1245 
	}
}

1247 
d©a_un™
 *
	$sÿrd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1249 
d©a_un™
 *
du
;

1251 
du
 = 
	`d©a_un™_g‘
();

1252 
du
->
dp
 = dp;

1253 
du
->
¬gc
 = 2;

1254 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1255 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1256 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1258  
du
;

1259 
	}
}

1261 
d©a_un™
 *
	$¤em_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1263 
d©a_un™
 *
du
;

1264 
j
, 
f›ld_Ëngth
;

1266 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1268 
du
 = 
	`d©a_un™_g‘
();

1269 
du
->
dp
 = dp;

1270 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1271 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1272 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1273 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1274 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1275 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1278  
du
;

1279 
	}
}

1281 
d©a_un™
 *
	$sismemb”_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1283 
d©a_un™
 *
du
;

1285 
du
 = 
	`d©a_un™_g‘
();

1286 
du
->
dp
 = dp;

1287 
du
->
¬gc
 = 3;

1288 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1289 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1290 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1291 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1293  
du
;

1294 
	}
}

1296 
d©a_un™
 *
	$suniÚ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1298 
d©a_un™
 *
du
;

1300 
du
 = 
	`d©a_un™_g‘
();

1301 
du
->
dp
 = dp;

1302 
du
->
¬gc
 = 2;

1303 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1304 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1305 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1307  
du
;

1308 
	}
}

1310 
d©a_un™
 *
	$sdiff_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1312 
d©a_un™
 *
du
;

1314 
du
 = 
	`d©a_un™_g‘
();

1315 
du
->
dp
 = dp;

1316 
du
->
¬gc
 = 2;

1317 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1318 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1319 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1321  
du
;

1322 
	}
}

1324 
d©a_un™
 *
	$sš‹r_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1326 
d©a_un™
 *
du
;

1328 
du
 = 
	`d©a_un™_g‘
();

1329 
du
->
dp
 = dp;

1330 
du
->
¬gc
 = 2;

1331 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1332 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1333 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1335  
du
;

1336 
	}
}

1339 
	$Íush_cmd_nck
(
»disR•ly
 *
»¶y
)

1341 ià(
»¶y
 =ğ
NULL
)  0;

1343 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1348 
	}
}

1350 
d©a_un™
 *
	$zadd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1352 
d©a_un™
 *
du
;

1353 
j
, 
f›ld_Ëngth
;

1355 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1357 
du
 = 
	`d©a_un™_g‘
();

1358 
du
->
dp
 = dp;

1359 
du
->
¬gc
 = 2+
f›ld_Ëngth
*2;

1360 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1361 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1362 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1364 
j
 = 2; j < 2+
f›ld_Ëngth
*2; j += 2) {

1365 
du
->
¬gv
[
j
] = 
	`g‘_¿ndom_æßt_¡r
();

1366 
du
->
¬gv
[
j
+1] = 
	`g‘_¿ndom_¡ršg
();

1369  
du
;

1370 
	}
}

1373 
	$zadd_cmd_nck
(
»disR•ly
 *
»¶y
)

1375 ià(
»¶y
 =ğ
NULL
)  0;

1377 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1382 
	}
}

1384 
d©a_un™
 *
	$zšüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1386 
d©a_un™
 *
du
;

1387 
j
, 
f›ld_Ëngth
;

1389 
du
 = 
	`d©a_un™_g‘
();

1390 
du
->
dp
 = dp;

1391 
du
->
¬gc
 = 4;

1392 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1393 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1394 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1395 
du
->
¬gv
[2] = 
	`g‘_¿ndom_æßt_¡r
();;

1396 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1398  
du
;

1399 
	}
}

1402 
	$zšüby_cmd_nck
(
»disR•ly
 *
»¶y
)

1404 ià(
»¶y
 =ğ
NULL
)  0;

1406 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1411 
	}
}

1413 
d©a_un™
 *
	$z¿nge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1415 
d©a_un™
 *
du
;

1416 
j
, 
f›ld_Ëngth
;

1417 
w™hscÜes
;

1419 ià(
	`¿nd
()%2 == 1) {

1420 
w™hscÜes
 = 1;

1422 
w™hscÜes
 = 0;

1425 
du
 = 
	`d©a_un™_g‘
();

1426 
du
->
dp
 = dp;

1427 
du
->
¬gc
 = 
w™hscÜes
?5:4;

1428 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1429 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1430 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1431 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(0);

1432 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%10000);

1433 ià(
w™hscÜes
è
du
->
¬gv
[4] = 
	`sd¢ew
("withscores");

1435  
du
;

1436 
	}
}

1438 
d©a_un™
 *
	$z»v¿nge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1440 
d©a_un™
 *
du
;

1441 
j
, 
f›ld_Ëngth
;

1442 
w™hscÜes
;

1444 ià(
	`¿nd
()%2 == 1) {

1445 
w™hscÜes
 = 1;

1447 
w™hscÜes
 = 0;

1450 
du
 = 
	`d©a_un™_g‘
();

1451 
du
->
dp
 = dp;

1452 
du
->
¬gc
 = 
w™hscÜes
?5:4;

1453 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1454 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1455 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1456 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(0);

1457 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%10000);

1458 ià(
w™hscÜes
è
du
->
¬gv
[4] = 
	`sd¢ew
("withscores");

1460  
du
;

1461 
	}
}

1463 
d©a_un™
 *
	$z»m_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1465 
d©a_un™
 *
du
;

1466 
j
, 
f›ld_Ëngth
;

1468 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1470 
du
 = 
	`d©a_un™_g‘
();

1471 
du
->
dp
 = dp;

1472 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1473 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1474 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1475 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1477 
j
 = 2; j < 2+
f›ld_Ëngth
; j ++) {

1478 
du
->
¬gv
[
j
] = 
	`g‘_¿ndom_¡ršg
();

1481  
du
;

1482 
	}
}

1484 
d©a_un™
 *
	$zÿrd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1486 
d©a_un™
 *
du
;

1488 
du
 = 
	`d©a_un™_g‘
();

1489 
du
->
dp
 = dp;

1490 
du
->
¬gc
 = 2;

1491 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1492 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1493 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1495  
du
;

1496 
	}
}

1498 
d©a_un™
 *
	$zcouÁ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1500 
d©a_un™
 *
du
;

1501 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1503 
du
 = 
	`d©a_un™_g‘
();

1504 
du
->
dp
 = dp;

1505 
du
->
¬gc
 = 4;

1506 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1507 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1508 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1509 
du
->
¬gv
[2] = 
¿nge
[0];

1510 
du
->
¬gv
[3] = 
¿nge
[1];

1512 
	`ä“
(
¿nge
);

1513  
du
;

1514 
	}
}

1516 
d©a_un™
 *
	$z¿ngebyscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1518 
d©a_un™
 *
du
;

1519 
idx
 = 0, 
¬g_couÁ
 = 0;

1520 
w™hscÜes
,
lim™
;

1521 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1523 
¬g_couÁ
 = 4;

1524 ià(
	`¿nd
()%2 == 1) {

1525 
w™hscÜes
 = 1;

1526 
¬g_couÁ
 ++;

1528 
w™hscÜes
 = 0;

1530 ià(
	`¿nd
()%2 == 1) {

1531 
lim™
 = 1;

1532 
¬g_couÁ
 += 3;

1534 
lim™
 = 0;

1537 
du
 = 
	`d©a_un™_g‘
();

1538 
du
->
dp
 = dp;

1539 
du
->
¬gc
 = 
¬g_couÁ
;

1540 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1541 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
(
dp
->
Çme
);

1542 
du
->
¬gv
[
idx
++] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1543 
du
->
¬gv
[
idx
++] = 
¿nge
[0];

1544 
du
->
¬gv
[
idx
++] = 
¿nge
[1];

1545 ià(
w™hscÜes
è
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("withscores");

1546 ià(
lim™
) {

1547 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("limit");

1548 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1549 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1552 
	`ASSERT
(
¬g_couÁ
 =ğ
idx
);

1554 
	`ä“
(
¿nge
);

1555  
du
;

1556 
	}
}

1558 
d©a_un™
 *
	$z»v¿ngebyscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1560 
d©a_un™
 *
du
;

1561 
idx
 = 0, 
¬g_couÁ
 = 0;

1562 
w™hscÜes
,
lim™
;

1563 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1565 
¬g_couÁ
 = 4;

1566 ià(
	`¿nd
()%2 == 1) {

1567 
w™hscÜes
 = 1;

1568 
¬g_couÁ
 ++;

1570 
w™hscÜes
 = 0;

1572 ià(
	`¿nd
()%2 == 1) {

1573 
lim™
 = 1;

1574 
¬g_couÁ
 += 3;

1576 
lim™
 = 0;

1579 
du
 = 
	`d©a_un™_g‘
();

1580 
du
->
dp
 = dp;

1581 
du
->
¬gc
 = 
¬g_couÁ
;

1582 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1583 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
(
dp
->
Çme
);

1584 
du
->
¬gv
[
idx
++] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1585 
du
->
¬gv
[
idx
++] = 
¿nge
[0];

1586 
du
->
¬gv
[
idx
++] = 
¿nge
[1];

1587 ià(
w™hscÜes
è
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("withscores");

1588 ià(
lim™
) {

1589 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("limit");

1590 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1591 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1594 
	`ASSERT
(
¬g_couÁ
 =ğ
idx
);

1596 
	`ä“
(
¿nge
);

1597  
du
;

1598 
	}
}

1600 
d©a_un™
 *
	$z¿nk_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1602 
d©a_un™
 *
du
;

1604 
du
 = 
	`d©a_un™_g‘
();

1605 
du
->
dp
 = dp;

1606 
du
->
¬gc
 = 3;

1607 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1608 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1609 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1610 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1612  
du
;

1613 
	}
}

1615 
d©a_un™
 *
	$z»v¿nk_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1617 
d©a_un™
 *
du
;

1619 
du
 = 
	`d©a_un™_g‘
();

1620 
du
->
dp
 = dp;

1621 
du
->
¬gc
 = 3;

1622 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1623 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1624 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1625 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1627  
du
;

1628 
	}
}

1630 
d©a_un™
 *
	$zscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1632 
d©a_un™
 *
du
;

1634 
du
 = 
	`d©a_un™_g‘
();

1635 
du
->
dp
 = dp;

1636 
du
->
¬gc
 = 3;

1637 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1638 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1639 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1640 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1642  
du
;

1643 
	}
}

1645 
d©a_un™
 *
	$z»m¿ngebyscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1647 
d©a_un™
 *
du
;

1648 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1650 
du
 = 
	`d©a_un™_g‘
();

1651 
du
->
dp
 = dp;

1652 
du
->
¬gc
 = 4;

1653 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1654 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1655 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1656 
du
->
¬gv
[2] = 
¿nge
[0];

1657 
du
->
¬gv
[3] = 
¿nge
[1];

1659 
	`ä“
(
¿nge
);

1660  
du
;

1661 
	}
}

1663 
d©a_un™
 *
	$z»m¿ngeby¿nk_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1665 
d©a_un™
 *
du
;

1666 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_RANK
);

1668 
du
 = 
	`d©a_un™_g‘
();

1669 
du
->
dp
 = dp;

1670 
du
->
¬gc
 = 4;

1671 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1672 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1673 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1674 
du
->
¬gv
[2] = 
¿nge
[0];

1675 
du
->
¬gv
[3] = 
¿nge
[1];

1677 
	`ä“
(
¿nge
);

1678  
du
;

1679 
	}
}

1681 
d©a_un™
 *
	$z»m¿ngebyËx_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1683 
d©a_un™
 *
du
;

1684 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_LEX
);

1686 
du
 = 
	`d©a_un™_g‘
();

1687 
du
->
dp
 = dp;

1688 
du
->
¬gc
 = 4;

1689 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1690 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1691 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1692 
du
->
¬gv
[2] = 
¿nge
[0];

1693 
du
->
¬gv
[3] = 
¿nge
[1];

1695 
	`ä“
(
¿nge
);

1696  
du
;

1697 
	}
}

1699 
	g´oduûrs_couÁ
;

1700 
d©a_´oduûr
 
	g»dis_d©a_´oduûr_bË
[] = {

1702 {"d–",
d–_cmd_´oduûr
,-2,"w",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_KEY
,NULL},

1703 {"exi¡s",
exi¡s_cmd_´oduûr
,-2,"rF",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_KEY
,NULL},

1704 {"‰l",
‰l_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1705 {"±",
±_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1706 {"expœe",
expœe_cmd_´oduûr
,3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1707 {"expœ—t",
expœ—t_cmd_´oduûr
,3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1709 {"g‘",
g‘_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1710 {"£t",
£t_cmd_´oduûr
,-3,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_ok
},

1711 {"£Šx",
£Šx_cmd_´oduûr
,3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
£Šx_cmd_nck
},

1712 {"£‹x",
£‹x_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,
nck_wh’_ok
},

1713 {"p£‹x",
p£‹x_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,
nck_wh’_ok
},

1714 {"šü",
šü_cmd_´oduûr
,2,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1715 {"deü",
deü_cmd_´oduûr
,2,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1716 {"šüby",
šüby_cmd_´oduûr
,3,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1717 {"deüby",
deüby_cmd_´oduûr
,3,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1718 {"­³nd",
­³nd_cmd_´oduûr
,3,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
­³nd_cmd_nck
},

1719 {"¡¾’",
¡¾’_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1720 {"g‘£t",
g‘£t_cmd_´oduûr
,3,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_nÛ¼Ü
},

1721 {"šübyæßt",
šübyæßt_cmd_´oduûr
,3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_¡r
},

1722 {"£tb™",
£tb™_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_z”o_Ü_Úe
},

1723 {"g‘b™",
g‘b™_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1724 {"£Œªge",
£Œªge_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_nÚz”o_unsigÃd_š‹g”
},

1725 {"g‘¿nge",
g‘¿nge_cmd_´oduûr
,4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1726 {"b™couÁ",
b™couÁ_cmd_´oduûr
,-2,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1727 {"b™pos",
b™pos_cmd_´oduûr
,-3,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1728 {"mg‘",
mg‘_cmd_´oduûr
,-2,"r",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_STRING
,NULL},

1729 {"m£t",
m£t_cmd_´oduûr
,-3,"wmA",0,
NULL
,1,-1,2,
TEST_CMD_TYPE_STRING
,
nck_wh’_ok
},

1731 {"h£t",
h£t_cmd_´oduûr
,4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,
nck_wh’_Úe
},

1732 {"hg‘",
hg‘_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1733 {"hËn",
hËn_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1734 {"hd–",
hd–_cmd_´oduûr
,-3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1735 {"hexi¡s",
hexi¡s_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1736 {"hkeys",
hkeys_cmd_´oduûr
,2,"rS",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1737 {"hv®s",
hv®s_cmd_´oduûr
,2,"rS",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1738 {"hg‘®l",
hg‘®l_cmd_´oduûr
,2,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1739 {"hšüby",
hšüby_cmd_´oduûr
,4,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1740 {"hšübyæßt",
hšübyæßt_cmd_´oduûr
,4,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1741 {"hmg‘",
hmg‘_cmd_´oduûr
,-3,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1742 {"hm£t",
hm£t_cmd_´oduûr
,-4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,
nck_wh’_ok
},

1743 {"h£Šx",
h£Šx_cmd_´oduûr
,4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,
nck_wh’_Úe
},

1744 {"h¡¾’",
h¡¾’_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1746 {"½ush",
½ush_cmd_´oduûr
,-3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,
½ush_cmd_nck
},

1747 {"Íush",
Íush_cmd_´oduûr
,-3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,
Íush_cmd_nck
},

1748 {"Ìªge",
Ìªge_cmd_´oduûr
,4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1749 {"½İ",
½İ_cmd_´oduûr
,2,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1750 {"Íİ",
Íİ_cmd_´oduûr
,2,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1751 {"Î’",
Î’_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1752 {"Ìem",
Ìem_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1753 {"Érim",
Érim_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1754 {"lšdex",
lšdex_cmd_´oduûr
,3,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1755 {"l£t",
l£t_cmd_´oduûr
,4,"wm",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1757 {"§dd",
§dd_cmd_´oduûr
,-3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,
nck_wh’_unsigÃd_š‹g”
},

1758 {"smemb”s",
smemb”s_cmd_´oduûr
,2,"rS",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1759 {"sÿrd",
sÿrd_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1760 {"¤em",
¤em_cmd_´oduûr
,-3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1761 {"sismemb”",
sismemb”_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1762 {"suniÚ",
suniÚ_cmd_´oduûr
,-2,"rS",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_SET
,NULL},

1763 {"sdiff",
sdiff_cmd_´oduûr
,-2,"rS",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_SET
,NULL},

1764 {"sš‹r",
sš‹r_cmd_´oduûr
,-2,"rS",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_SET
,NULL},

1766 {"zadd",
zadd_cmd_´oduûr
,-4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,
zadd_cmd_nck
},

1767 {"zšüby",
zšüby_cmd_´oduûr
,4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,
zšüby_cmd_nck
},

1768 {"z¿nge",
z¿nge_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1769 {"z»v¿nge",
z»v¿nge_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1770 {"z»m",
z»m_cmd_´oduûr
,-3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1771 {"zÿrd",
zÿrd_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1772 {"zcouÁ",
zcouÁ_cmd_´oduûr
,4,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1773 {"z¿ngebyscÜe",
z¿ngebyscÜe_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1774 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜe_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1775 {"z¿nk",
z¿nk_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1776 {"z»v¿nk",
z»v¿nk_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1777 {"zscÜe",
zscÜe_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1778 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜe_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1779 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nk_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL}

1782 
d©a_un™
 *
	$d©a_un™_g‘
()

1784 
d©a_un™
 *
du
 = 
	`m®loc
((data_unit));

1785 
du
->
dp
 = 
NULL
;

1786 
du
->
¬gc
 = 0;

1787 
du
->
¬gv
 = 
NULL
;

1788 
du
->
hashv®ue
 = 0;

1789 
du
->
d©a
 = 
NULL
;

1790  
du
;

1791 
	}
}

1793 
	$d©a_un™_put
(
d©a_un™
 *
du
)

1795 
idx
;

1797 
idx
 = 0; idx < 
du
->
¬gc
; idx ++) {

1798 ià(
du
->
¬gv
[
idx
])

1799 
	`sdsä“
(
du
->
¬gv
[
idx
]);

1801 
	`ä“
(
du
->
¬gv
);

1802 
	`ä“
(
du
);

1803 
	}
}

1805 
´oduû_scheme
 *
	$´oduû_scheme_ü—‹
(
max_ÿched_keys
, 
h™_¿tio
)

1807 
´oduû_scheme
 *
ps
;

1808 
couÁ
, 
idx
;

1809 
¿tio
;

1811 
ps
 = 
	`m®loc
((*ps));

1812 ià(
ps
 =ğ
NULL
)  NULL;

1813 
ps
->
kıs
 = 
NULL
;

1814 
ps
->
h™_¿tio_¬¿y
 = 
NULL
;

1816 
ps
->
kıs
 = 
	`d¬¿y_ü—‹
(
PRODUCE_KEY_CACHE_POOL_COUNT
,(
key_ÿche_¬¿y
 *));

1817 
idx
 = 0; idx < 
PRODUCE_KEY_CACHE_POOL_COUNT
; idx ++) {

1818 
key_ÿche_¬¿y
 **
kı
 = 
	`d¬¿y_push
(
ps
->
kıs
);

1819 *
kı
 = 
	`key_ÿche_¬¿y_ü—‹
(
max_ÿched_keys
/
PRODUCE_KEY_CACHE_POOL_COUNT
);

1820 ià(*
kı
 =ğ
NULL
) {

1821  
NULL
;

1826 
ps
->
h™_¿tio_¬¿y_Ën
 = 100;

1827 
ps
->
h™_¿tio
 = hit_ratio;

1828 
ps
->
h™_¿tio_idx
 = 0;

1829 
ps
->
h™_¿tio_¬¿y
 = 
	`m®loc
Õs->
h™_¿tio_¬¿y_Ën
*());

1830 
¿tio
 = 
ps
->
h™_¿tio_¬¿y_Ën
/ps->
h™_¿tio
;

1831 ià(
¿tio
 > 1) {

1832 
couÁ
 = 
ps
->
h™_¿tio
;

1833 
idx
 = 0; idx < 
ps
->
h™_¿tio_¬¿y_Ën
; idx ++) {

1834 
ps
->
h™_¿tio_¬¿y
[
idx
] = 0;

1837 
couÁ
 = 
ps
->
h™_¿tio_¬¿y_Ën
 -…s->
h™_¿tio
;

1838 
idx
 = 0; idx < 
ps
->
h™_¿tio_¬¿y_Ën
; idx ++) {

1839 
ps
->
h™_¿tio_¬¿y
[
idx
] = 1;

1842 
couÁ
 > 0) {

1843 
idx
 = 
	`¿nd
()%
ps
->
h™_¿tio_¬¿y_Ën
;

1844 ià(
¿tio
 > 1) {

1845 ià(
ps
->
h™_¿tio_¬¿y
[
idx
] == 0) {

1846 
couÁ
 --;

1847 
ps
->
h™_¿tio_¬¿y
[
idx
] = 1;

1850 ià(
ps
->
h™_¿tio_¬¿y
[
idx
] == 1) {

1851 
couÁ
 --;

1852 
ps
->
h™_¿tio_¬¿y
[
idx
] = 0;

1857  
ps
;

1858 
	}
}

1860 
	$´oduû_scheme_de¡roy
(
´oduû_scheme
 *
ps
)

1862 
j
;

1863 ià(
ps
->
kıs
) {

1864 
j
 = 0; j < 
PRODUCE_KEY_CACHE_POOL_COUNT
; j ++) {

1865 
key_ÿche_¬¿y
 **
kı
 = 
	`d¬¿y_pİ
(
ps
->
kıs
);

1866 ià(*
kı
)
	`key_ÿche_¬¿y_de¡roy
(*kcp);

1868 
	`d¬¿y_de¡roy
(
ps
->
kıs
);

1871 
	`ä“
(
ps
->
h™_¿tio_¬¿y
);

1873 
	`ä“
(
ps
);

1874 
	}
}

1876 
	$g‘_kı_idx
(
ty³
)

1878 
idx
;

1880 
ty³
)

1882 
TEST_CMD_TYPE_STRING
:

1883 
idx
 = 0;

1886 
TEST_CMD_TYPE_LIST
:

1887 
idx
 = 1;

1890 
TEST_CMD_TYPE_SET
:

1891 
idx
 = 2;

1894 
TEST_CMD_TYPE_ZSET
:

1895 
idx
 = 3;

1898 
TEST_CMD_TYPE_HASH
:

1899 
idx
 = 4;

1903 
idx
 = -1;

1907  
idx
;

1908 
	}
}

1910 
	$£t_nÚ_em±y_kıs_idx
()

1912 ià(
cmd_ty³
&
TEST_CMD_TYPE_STRING
) {

1913 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1914 
	`g‘_kı_idx
(
TEST_CMD_TYPE_STRING
);

1916 ià(
cmd_ty³
&
TEST_CMD_TYPE_LIST
) {

1917 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1918 
	`g‘_kı_idx
(
TEST_CMD_TYPE_LIST
);

1920 ià(
cmd_ty³
&
TEST_CMD_TYPE_SET
) {

1921 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1922 
	`g‘_kı_idx
(
TEST_CMD_TYPE_SET
);

1924 ià(
cmd_ty³
&
TEST_CMD_TYPE_ZSET
) {

1925 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1926 
	`g‘_kı_idx
(
TEST_CMD_TYPE_ZSET
);

1928 ià(
cmd_ty³
&
TEST_CMD_TYPE_HASH
) {

1929 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1930 
	`g‘_kı_idx
(
TEST_CMD_TYPE_HASH
);

1932 
	}
}

1935 
key_ÿche_¬¿y
 *
	$kı_g‘_äom_ps
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
)

1937 
idx
;

1938 
key_ÿche_¬¿y
 **
kı
;

1940 ià(
ps
 =ğ
NULL
 ||…s->
kıs
 =ğNULL || 
dp
 == NULL)  NULL;

1942 ià(
dp
->
cmd_ty³
 =ğ
TEST_CMD_TYPE_KEY
) {

1943 ià(
nÚ_em±y_kıs_couÁ
==0) {

1944 
idx
 = -1;

1946 
idx
 = 
	`¿nd
()%
nÚ_em±y_kıs_couÁ
;

1947 
idx
 = 
nÚ_em±y_kıs_idx
[idx];

1948 
	`ASSERT
(
idx
 >= 0);

1951 
idx
 = 
	`g‘_kı_idx
(
dp
->
cmd_ty³
);

1954 ià(
idx
 >ğ
PRODUCE_KEY_CACHE_POOL_COUNT
 || idx < 0) {

1955  
NULL
;

1958 
kı
 = 
	`d¬¿y_g‘
(
ps
->
kıs
, 
idx
);

1960  *
kı
;

1961 
	}
}

1963 
	$v¹_´oduû_th»ads_š™
(
´oduû_th»ads_couÁ
,

1964 
ÿched_keys
, 
h™_¿tio
)

1966 
idx
;

1967 
	`d¬¿y_š™
(&
´oduû_th»ads
, 
´oduû_th»ads_couÁ
, (
´oduû_th»ad
));

1968 
´oduû_d©a_th»ads_couÁ
 = 
´oduû_th»ads_couÁ
;

1969 
idx
 = 0; idx < 
´oduû_th»ads_couÁ
; idx ++) {

1970 
´oduû_th»ad
 *
±
 = 
	`d¬¿y_push
(&
´oduû_th»ads
);

1971 
±
->
id
 = 
idx
;

1972 
±
->
th»ad_id
 = 0;

1973 
±
->
ps
 = 
	`´oduû_scheme_ü—‹
(
ÿched_keys
, 
h™_¿tio
);

1974 
±
->
·u£
 = 0;

1975 
±
->
loİtimes
 = 0;

1978  
VRT_OK
;

1979 
	}
}

1981 
	$v¹_´oduû_th»ads_deš™
()

1983 
´oduû_th»ad
 *
±
;

1984 
	`d¬¿y_n
(&
´oduû_th»ads
) > 0) {

1985 
±
 = 
	`d¬¿y_pİ
(&
´oduû_th»ads
);

1986 ià(
±
->
ps
) {

1987 
	`´oduû_scheme_de¡roy
(
±
->
ps
);

1988 
±
->
ps
 = 
NULL
;

1991 
	`d¬¿y_deš™
(&
´oduû_th»ads
);

1992 
	}
}

1994 *
	$v¹_´oduû_th»ad_run
(*
¬gs
)

1996 
»t
;

1997 
´oduû_th»ad
 *
±
 = 
¬gs
;

1998 
idx
, 
j
;

1999 
d©a_´oduûr
 **
dp
;

2000 
d©a_un™
 *
du
;

2002 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

2006 ià(
±
->
·u£
) {

2007 
	`u¦“p
(1000000);

2008 ià(!
	`‹¡_if_Ãed_·u£
()) {

2009 
±
->
·u£
 = 0;

2013 } ià(
±
->
loİtimes
%10000 == 0) {

2014 ià(
	`‹¡_if_Ãed_·u£
()) {

2015 
±
->
·u£
 = 1;

2016 
	`Úe_´oduû_th»ad_·u£d
();

2021 
idx
 = 
	`¿nd
()%
Ãeded_cmd_ty³_´oduûr_couÁ
;

2022 
dp
 = 
	`d¬¿y_g‘
(&
Ãeded_cmd_ty³_´oduûr
,
idx
);

2023 
du
 = (*
dp
)->
	`´oc
(*dp,
±
->
ps
);

2025 
du
->
d©a
 = 
±
->
ps
;

2028 
»t
 = 
	`d©a_di¥©ch
(
du
);

2029 ià(
»t
 == -1) {

2030 
	`d©a_un™_put
(
du
);

2031 } ià(
»t
 == 1) {

2032 
	`u¦“p
(100000);

2035 
±
->
loİtimes
 ++;

2038  
NULL
;

2039 
	}
}

2041 
	$add_to_Ãeded_cmd_ty³_´oduûr
(
d©a_´oduûr
 *
dp
)

2043 
d©a_´oduûr
 **
dp_–em
 = 
	`d¬¿y_push
(&
Ãeded_cmd_ty³_´oduûr
);

2045 *
dp_–em
 = 
dp
;

2046 
Ãeded_cmd_ty³_´oduûr_couÁ
 ++;

2048  
VRT_OK
;

2049 
	}
}

2051 
	$v¹_´oduû_d©a_š™
(
key_Ëngth_¿nge_mš
,
key_Ëngth_¿nge_max
,

2052 
¡ršg_max_Ëngth
,
f›lds_max_couÁ
,

2053 
´oduû_cmd_ty³s
,
d¬¿y
 *
´oduû_cmd_bÏckli¡
,d¬¿y *
´oduû_cmd_wh™–i¡
,

2054 
´oduû_th»ads_couÁ
,
ÿched_keys
,

2055 
h™_¿tio
)

2057 
j
, 
k
;

2059 
key_Ëngth_mš
 = 
key_Ëngth_¿nge_mš
;

2060 
key_Ëngth_max
 = 
key_Ëngth_¿nge_max
;

2061 ià(
key_Ëngth_max
 < 
key_Ëngth_mš
è 
VRT_ERROR
;

2062 
key_Ëngth_¿nge_g­
 = 
key_Ëngth_max
-
key_Ëngth_mš
;

2063 
f›ld_Ëngth_max
 = 
f›lds_max_couÁ
;

2064 
¡ršg_Ëngth_max
 = 
¡ršg_max_Ëngth
;

2065 
cmd_ty³
 = 
´oduû_cmd_ty³s
;

2066 
	`d¬¿y_š™
(&
Ãeded_cmd_ty³_´oduûr
, 100, (
d©a_´oduûr
*));

2068 
´oduûrs_couÁ
 = (
»dis_d©a_´oduûr_bË
)/(
d©a_´oduûr
);

2069 
j
 = 0; j < 
´oduûrs_couÁ
; j++) {

2070 
d©a_´oduûr
 *
dp
 = 
»dis_d©a_´oduûr_bË
+
j
;

2071 *
f
 = 
dp
->
sæags
;

2073 *
f
 != '\0') {

2074 *
f
) {

2075 'w': 
dp
->
æags
 |ğ
PRO_WRITE
; ;

2076 'r': 
dp
->
æags
 |ğ
PRO_READONLY
; ;

2077 'm': 
dp
->
æags
 |ğ
PRO_DENYOOM
; ;

2078 'a': 
dp
->
æags
 |ğ
PRO_ADMIN
; ;

2079 'p': 
dp
->
æags
 |ğ
PRO_PUBSUB
; ;

2080 's': 
dp
->
æags
 |ğ
PRO_NOSCRIPT
; ;

2081 'R': 
dp
->
æags
 |ğ
PRO_RANDOM
; ;

2082 'S': 
dp
->
æags
 |ğ
PRO_SORT_FOR_SCRIPT
; ;

2083 'l': 
dp
->
æags
 |ğ
PRO_LOADING
; ;

2084 't': 
dp
->
æags
 |ğ
PRO_STALE
; ;

2085 'M': 
dp
->
æags
 |ğ
PRO_SKIP_MONITOR
; ;

2086 'k': 
dp
->
æags
 |ğ
PRO_ASKING
; ;

2087 'F': 
dp
->
æags
 |ğ
PRO_FAST
; ;

2088 'A': 
dp
->
æags
 |ğ
PRO_ADD
; ;

2089 :  
VRT_ERROR
;

2091 
f
++;

2094 ià(
d–‘e_d©a_´oduûr
 =ğ
NULL
 &&

2095 !
	`¡rcmp
(
dp
->
Çme
,"del")) {

2096 
d–‘e_d©a_´oduûr
 = 
dp
;

2099 ià(
´oduû_cmd_wh™–i¡
 !ğ
NULL
) {

2100 
k
 = 0; k < 
	`d¬¿y_n
(
´oduû_cmd_wh™–i¡
); k ++) {

2101 
sds
 *
cmdÇme
 = 
	`d¬¿y_g‘
(
´oduû_cmd_wh™–i¡
, 
k
);

2102 ià(!
	`¡rÿ£cmp
(
dp
->
Çme
,*
cmdÇme
)) {

2103 
	`add_to_Ãeded_cmd_ty³_´oduûr
(
dp
);

2111 ià(
´oduû_cmd_bÏckli¡
 !ğ
NULL
) {

2112 
is_š_bÏckli¡
 = 0;

2113 
k
 = 0; k < 
	`d¬¿y_n
(
´oduû_cmd_bÏckli¡
); k ++) {

2114 
sds
 *
cmdÇme
 = 
	`d¬¿y_g‘
(
´oduû_cmd_bÏckli¡
, 
k
);

2115 ià(!
	`¡rÿ£cmp
(
dp
->
Çme
,*
cmdÇme
)) {

2116 
is_š_bÏckli¡
 = 1;

2121 ià(
is_š_bÏckli¡
) {

2127 ià(
dp
->
cmd_ty³
&cmd_type) {

2128 
	`add_to_Ãeded_cmd_ty³_´oduûr
(
dp
);

2130 ià(
dp
->
cmd_ty³
&
TEST_CMD_TYPE_EXPIRE
 && 
expœe_’abËd
) {

2131 
	`add_to_Ãeded_cmd_ty³_´oduûr
(
dp
);

2135 
	`£t_nÚ_em±y_kıs_idx
();

2137 ià(
	`d¬¿y_n
(&
Ãeded_cmd_ty³_´oduûr
) == 0) {

2138 
	`log_”rÜ
("No command‚eedoest");

2139  
VRT_ERROR
;

2142 ià(
d–‘e_d©a_´oduûr
 =ğ
NULL
) {

2143  
VRT_ERROR
;

2146 ià(
Ãeded_cmd_ty³_´oduûr_couÁ
 == 0) {

2147  
VRT_ERROR
;

2150 
j
 = 0; j < 
Ãeded_cmd_ty³_´oduûr_couÁ
; j ++) {

2151 
d©a_´oduûr
 **
dp_–em
 = 
	`d¬¿y_g‘
(&
Ãeded_cmd_ty³_´oduûr
,
j
);

2152 
	`log_debug
(
LOG_INFO
, "Ãedede¡ commªd[%d]: %s", 
j
, (*
dp_–em
)->
Çme
);

2155 
	`v¹_´oduû_th»ads_š™
(
´oduû_th»ads_couÁ
, 
ÿched_keys
, 
h™_¿tio
);

2157  
VRT_OK
;

2158 
	}
}

2160 
	$v¹_´oduû_d©a_deš™
()

2162 
	`v¹_´oduû_th»ads_deš™
();

2164 
Ãeded_cmd_ty³_´oduûr
.
ÃËm
 = 0;

2165 
	`d¬¿y_deš™
(&
Ãeded_cmd_ty³_´oduûr
);

2166 
	}
}

2168 
	$v¹_¡¬t_´oduû_d©a
()

2170 
i
;

2171 
i
 = 0; i < 
	`d¬¿y_n
(&
´oduû_th»ads
); i ++) {

2172 
±h»ad_©Œ_t
 
©Œ
;

2173 
´oduû_th»ad
 *
±
;

2174 
	`±h»ad_©Œ_š™
(&
©Œ
);

2175 
±
 = 
	`d¬¿y_g‘
(&
´oduû_th»ads
, 
i
);

2176 
	`±h»ad_ü—‹
(&
±
->
th»ad_id
,

2177 &
©Œ
, 
v¹_´oduû_th»ad_run
, 
±
);

2180 
Ï¡_‹¡_begš_time
 = 
	`v¹_£c_now
();

2181  
VRT_OK
;

2182 
	}
}

2184 
	$v¹_wa™_´oduû_d©a
()

2186 
i
;

2188 
i
 = 0; i < 
	`d¬¿y_n
(&
´oduû_th»ads
); i ++){

2189 
´oduû_th»ad
 *
±
 = 
	`d¬¿y_g‘
(&
´oduû_th»ads
, 
i
);

2190 
	`±h»ad_još
(
±
->
th»ad_id
, 
NULL
);

2193  
VRT_OK
;

2194 
	}
}

2202 *
	$g‘_keys_usšg_d©a_´oduûr_bË
(
d©a_´oduûr
 *
dp
,
sds
 *
¬gv
, 
¬gc
, *
numkeys
) {

2203 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

2205 ià(
dp
->
fœ¡key
 == 0) {

2206 *
numkeys
 = 0;

2207  
NULL
;

2209 
Ï¡
 = 
dp
->
Ï¡key
;

2210 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

2211 
keys
 = 
	`m®loc
(()*((
Ï¡
 - 
dp
->
fœ¡key
)+1));

2212 
j
 = 
dp
->
fœ¡key
; j <ğ
Ï¡
; j +ğdp->
key¡•
) {

2213 
keys
[
i
++] = 
j
;

2215 *
numkeys
 = 
i
;

2216  
keys
;

2217 
	}
}

2230 *
	$g‘_keys_äom_d©a_´oduûr
(
d©a_´oduûr
 *
dp
, 
sds
 *
¬gv
, 
¬gc
, *
numkeys
) {

2231 ià(
dp
->
g‘keys_´oc
) {

2232  
dp
->
	`g‘keys_´oc
(dp,
¬gv
,
¬gc
,
numkeys
);

2234  
	`g‘_keys_usšg_d©a_´oduûr_bË
(
dp
,
¬gv
,
¬gc
,
numkeys
);

2236 
	}
}

2238 
sds
 
	$g‘_Úe_key_äom_d©a_un™
(
d©a_un™
 *
du
)

2240 
numkeys
;

2241 *
keyšdex
;

2242 
sds
 
key
;

2244 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
,du->
¬gv
,du->
¬gc
,&
numkeys
);

2245 ià(
numkeys
 <= 0) {

2246 
	`NOT_REACHED
();

2247  
NULL
;

2250 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

2251 
	`ä“
(
keyšdex
);

2253  
key
;

2254 
	}
}

2256 
	$´št_´oduûr_commªd
(
d©a_un™
 *
du
)

2258 
j
;

2259 
sds
 
cmd
 = 
	`sd£m±y
();

2261 
j
 = 0; j < 
du
->
¬gc
; j ++) {

2262 
cmd
 = 
	`sdsÿtsds
(cmd,
du
->
¬gv
[
j
]);

2263 
cmd
 = 
	`sdsÿt
(cmd," ");

2265 
cmd
 = 
	`sdsÿt
(cmd,"\n");

2266 
	`log_wr™e_Ën
(
cmd
,
	`sd¦’
(cmd));

2267 
	`sdsä“
(
cmd
);

2268 
	}
}

	@tests/vrt_produce_data.h

1 #iâdeà
_VRT_PRODUCE_DATA_H_


2 
	#_VRT_PRODUCE_DATA_H_


	)

34 
	#PRO_WRITE
 1

	)

35 
	#PRO_READONLY
 2

	)

36 
	#PRO_DENYOOM
 4

	)

37 
	#PRO_NOT_USED_1
 8

	)

38 
	#PRO_ADMIN
 16

	)

39 
	#PRO_PUBSUB
 32

	)

40 
	#PRO_NOSCRIPT
 64

	)

41 
	#PRO_RANDOM
 128

	)

42 
	#PRO_SORT_FOR_SCRIPT
 256

	)

43 
	#PRO_LOADING
 512

	)

44 
	#PRO_STALE
 1024

	)

45 
	#PRO_SKIP_MONITOR
 2048

	)

46 
	#PRO_ASKING
 4096

	)

47 
	#PRO_FAST
 8192

	)

48 
	#PRO_ADD
 16384

	)

50 
	gd©a_´oduûr
;

51 
	g´oduû_scheme
;

52 
	gkey_ÿche_¬¿y
;

54 
d©a_un™
 *
	t»dis_commªd_´oc
(
	td©a_´oduûr
 *
	tdp
, 
	t´oduû_scheme
 *
	tps
);

55 *
	t»dis_g‘_keys_´oc
(
	td©a_´oduûr
 *
	tdp
, 
	tsds
 *
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

56 
	t´oduû_Ãed_ÿche_key_´oc
(
	t»disR•ly
 *
	t»¶y
);

57 
	sd©a_´oduûr
 {

58 *
	mÇme
;

59 
»dis_commªd_´oc
 *
	m´oc
;

60 
	m¬™y
;

62 *
	msæags
;

63 
	mæags
;

66 
»dis_g‘_keys_´oc
 *
	mg‘keys_´oc
;

68 
	mfœ¡key
;

69 
	mÏ¡key
;

70 
	mkey¡•
;

71 
	mcmd_ty³
;

72 
´oduû_Ãed_ÿche_key_´oc
 *
	mÃed_ÿche_key_´oc
;

73 } 
	td©a_´oduûr
;

75 
	sd©a_un™
 {

76 
d©a_´oduûr
 *
	mdp
;

77 
	m¬gc
;

78 
sds
 *
	m¬gv
;

80 
	mhashv®ue
;

82 *
	md©a
;

83 } 
	td©a_un™
;

85 
	s´oduû_scheme
 {

86 
d¬¿y
 *
	mkıs
;

88 
	mh™_¿tio
;

89 
	mh™_¿tio_idx
;

90 
	mh™_¿tio_¬¿y_Ën
;

91 *
	mh™_¿tio_¬¿y
;

92 } 
	t´oduû_scheme
;

94 
d©a_´oduûr
 *
d–‘e_d©a_´oduûr
;

96 
´oduû_d©a_th»ads_couÁ
;

98 
´oduû_th»ads_·u£_fšished_couÁ
;

100 
key_ÿche_¬¿y
 *
kı_g‘_äom_ps
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
);

102 
d©a_un™
 *
d©a_un™_g‘
();

103 
d©a_un™_put
(
d©a_un™
 *
du
);

105 
v¹_´oduû_d©a_š™
(
key_Ëngth_¿nge_mš
, 
key_Ëngth_¿nge_max
,

106 
¡ršg_max_Ëngth
,
f›lds_max_couÁ
,

107 
´oduû_cmd_ty³s
,
d¬¿y
 *
´oduû_cmd_bÏckli¡
,d¬¿y *
´oduû_cmd_wh™–i¡
,

108 
´oduû_th»ads_couÁ
, 
ÿched_keys
,

109 
h™_¿tio
);

110 
v¹_´oduû_d©a_deš™
();

112 
v¹_¡¬t_´oduû_d©a
();

113 
v¹_wa™_´oduû_d©a
();

115 *
g‘_keys_äom_d©a_´oduûr
(
d©a_´oduûr
 *
dp
, 
sds
 *
¬gv
, 
¬gc
, *
numkeys
);

117 
sds
 
g‘_Úe_key_äom_d©a_un™
(
d©a_un™
 *
du
);

119 
´št_´oduûr_commªd
(
d©a_un™
 *
du
);

	@tests/vrt_public.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<fú.h
>

5 
	~<”ºo.h
>

6 
	~<sigÇl.h
>

7 
	~<±h»ad.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

13 
	~<d¬¿y.h
>

14 
	~<dlog.h
>

16 
	~<v¹_ut.h
>

17 
	~<v¹_public.h
>

20 #ià
defšed
(
__ATOMIC_RELAXED
)

22 #–ià
defšed
(
HAVE_ATOMIC
)

24 
±h»ad_mu‹x_t
 
	g¡©e_lock”
 = 
PTHREAD_MUTEX_INITIALIZER
;

27 
	#VIRE_TEST_CONFIG_DEFAULT_EXECUTE_FILE
 "¤c/vœe"

	)

29 *
	gexecu‹_fe
 = 
VIRE_TEST_CONFIG_DEFAULT_EXECUTE_FILE
;

31 
sds
 
	gwÜkdœ
 = 
NULL
;

33 
	gvœ•Üt
 = 55556;

35 
	$£t_execu‹_fe
(*
fe
)

37 
execu‹_fe
 = 
fe
;

38 
	}
}

40 
sds
 
	$vœe_cÚf_ü—‹
(*
dœ
, 
pÜt
)

42 
sds
 
cÚf_fe
;

43 
fd
;

44 
sds
 
lše
;

46 
cÚf_fe
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/vœe.cÚf",
dœ
);

48 
fd
 = 
	`İ’
(
cÚf_fe
,
O_WRONLY
|
O_CREAT
|
O_TRUNC
,0644);

49 ià(
fd
 < 0) {

50 
	`‹¡_log_”rÜ
("O³ÀcÚàf% çed: %s", 
cÚf_fe
, 
	`¡»¼Ü
(
”ºo
));

51 
	`sdsä“
(
cÚf_fe
);

52  
NULL
;

55 
lše
 = 
	`sd£m±y
();

57 
lše
 = 
	`sdsÿtfmt
Öše,"pÜˆ%i\n",
pÜt
);

58 
	`wr™e
(
fd
, 
lše
, 
	`sd¦’
(line));

60 
	`sdsş—r
(
lše
);

61 
lše
 = 
	`sdsÿtfmt
(line,"\n");

62 
	`wr™e
(
fd
, 
lše
, 
	`sd¦’
(line));

64 
	`şo£
(
fd
);

65 
	`sdsä“
(
lše
);

66  
cÚf_fe
;

67 
	}
}

69 
vœe_š¡ªû
 *
	$vœe_š¡ªû_ü—‹
(
pÜt
)

71 
vœe_š¡ªû
 *
vi
;

73 
vi
 = 
	`m®loc
((
vœe_š¡ªû
));

74 
vi
->
ho¡
 = 
NULL
;

75 
vi
->
pÜt
 = 0;

76 
vi
->
dœ
 = 
NULL
;

77 
vi
->
cÚf_fe
 = 
NULL
;

78 
vi
->
pid_fe
 = 
NULL
;

79 
vi
->
log_fe
 = 
NULL
;

80 
vi
->
ruÂšg
 = 0;

81 
vi
->
pid
 = -1;

82 
vi
->
ùx
 = 
NULL
;

84 
vi
->
ho¡
 = 
	`sd¢ew
("127.0.0.1");

85 
vi
->
pÜt
 =…ort;

86 
vi
->
dœ
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/%i",
wÜkdœ
,
pÜt
);

88 ià(
	`mkdœ
(
vi
->
dœ
,0755) < 0) {

89 
	`vœe_š¡ªû_de¡roy
(
vi
);

90  
NULL
;

93 
vi
->
cÚf_fe
 = 
	`vœe_cÚf_ü—‹
(vi->
dœ
, 
pÜt
);

94 ià(
vi
->
cÚf_fe
 =ğ
NULL
) {

95 
	`vœe_š¡ªû_de¡roy
(
vi
);

96  
NULL
;

99 
vi
->
pid_fe
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/vœe.pid",vi->
dœ
);

100 
vi
->
log_fe
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/vœe.log",vi->
dœ
);

102 
	`‹¡_log_debug
("vœho¡: %s", 
vi
->
ho¡
);

103 
	`‹¡_log_debug
("vœpÜt: %d", 
vi
->
pÜt
);

104 
	`‹¡_log_debug
("vœdœ: %s", 
vi
->
dœ
);

105 
	`‹¡_log_debug
("vœcÚf_fe: %s", 
vi
->
cÚf_fe
);

106 
	`‹¡_log_debug
("vœpid_fe: %s", 
vi
->
pid_fe
);

107 
	`‹¡_log_debug
("vœlog_fe: %s", 
vi
->
log_fe
);

109  
vi
;

110 
	}
}

112 
	$vœe_š¡ªû_de¡roy
(
vœe_š¡ªû
 *
vi
)

114 ià(
vi
->
ruÂšg
) {

115 
	`vœe_£rv”_¡İ
(
vi
);

118 ià(
vi
->
dœ
) {

119 
	`de¡roy_dœ
(
vi
->
dœ
);

120 
	`sdsä“
(
vi
->
dœ
);

123 ià(
vi
->
cÚf_fe
) {

124 
	`sdsä“
(
vi
->
cÚf_fe
);

127 ià(
vi
->
pid_fe
) {

128 
	`sdsä“
(
vi
->
pid_fe
);

131 ià(
vi
->
log_fe
) {

132 
	`sdsä“
(
vi
->
log_fe
);

135 ià(
vi
->
ùx
) {

136 
	`»disF»e
(
vi
->
ùx
);

139 ià(
vi
->
ho¡
) {

140 
	`sdsä“
(
vi
->
ho¡
);

143 
	`ä“
(
vi
);

144 
	}
}

146 
	$vœe_£rv”_run
(
vœe_š¡ªû
 *
vi
)

148 
»t
;

149 
pid_t
 
pid
;

150 
¡©us
;

151 
timev®
 
timeout
 = { 3, 500000 };

153 ià((
pid
 = 
	`fÜk
()) < 0) {

154 
	`‹¡_log_”rÜ
("FÜk‡ chšd faed: %s", 
	`¡»¼Ü
(
”ºo
));

155  
VRT_ERROR
;

156 } ià(
pid
 == 0) {

157 
»t
 = 
	`exeş
(
execu‹_fe
,"vœe","-c",
vi
->
cÚf_fe
,

158 "-p",
vi
->
pid_fe
,"-o",vi->
log_fe
,"-v","8",
NULL
);

159 ià(
»t
 < 0) {

160 
	`‹¡_log_”rÜ
("Exeşhvœ£rv” faed: %s", 
	`¡»¼Ü
(
”ºo
));

161  
VRT_ERROR
;

166 
	`¦“p
(1);

168 
»t
 = 
	`wa™pid
(
pid
,
NULL
,
WNOHANG
);

169 ià(
»t
 != 0) {

170 
	`‹¡_log_debug
("RuÀvœ£rv”ÕÜˆ%dèçed",
vi
->
pÜt
);

171  
VRT_ERROR
;

174 
vi
->
ùx
 = 
	`»disCÚÃùW™hTimeout
(vi->
ho¡
,vi->
pÜt
,
timeout
);

175 ià(
vi
->
ùx
 =ğ
NULL
 || vi->ùx->
”r
) {

176 
	`‹¡_log_”rÜ
("Connecto %s:%d failed: %s",

177 
vi
->
ho¡
, vi->
pÜt
, vi->
ùx
?vi->ùx->
”r¡r
:"out of memory");

178 ià(
vi
->
ùx
) {

179 
	`»disF»e
(
vi
->
ùx
);

180 
vi
->
ùx
 = 
NULL
;

182  
VRT_ERROR
;

185 
vi
->
pid
 = 
	`g‘_pid_äom_»¶y
(vi->
ùx
,vi->
ho¡
,vi->
pÜt
);

186 ià(
vi
->
pid
 < 0) {

187 
	`‹¡_log_”rÜ
("G‘…id from %s:%d„•lyƒ¼Ü", 
vi
->
ho¡
, vi->
pÜt
);

188  
VRT_ERROR
;

189 } ià(
vi
->
pid
 !=…id) {

190 
	`‹¡_log_”rÜ
("G‘ wrÚg…id from %s:%d„•ly", 
vi
->
ho¡
, vi->
pÜt
);

191  
VRT_ERROR
;

194 
	`‹¡_log_debug
("RuÀvœ£rv”ÕÜˆ%dèsucûss",
vi
->
pÜt
);

196 
vi
->
ruÂšg
 = 1;

198  
VRT_OK
;

199 
	}
}

201 
	$vœe_£rv”_¡İ
(
vœe_š¡ªû
 *
vi
)

203 
pid
;

205 ià(!
vi
->
ruÂšg
) ;

207 ià(
vi
->
pid
 > 0) {

208 
pid
 = 
vi
->pid;

209 } ià(
vi
->
pid_fe
) {

210 
fd
;

211 
pid_¡r
[20];

212 
size_t
 
Ä—d
;

213 
fd
 = 
	`İ’
(
vi
->
pid_fe
, 
O_RDONLY
);

214 ià(
fd
 < 0) {

215 
	`‹¡_log_”rÜ
("O³Àpid f% çed", 
vi
->
pid_fe
);

218 
Ä—d
 = 
	`»ad
(
fd
,
pid_¡r
,20);

219 ià(
	`¡ršg2l
(
pid_¡r
,
Ä—d
,&
pid
) == 0) {

220 
	`‹¡_log_”rÜ
("CÚv”ˆpid sŒšg %.* tØlÚg faed",
Ä—d
,
pid_¡r
);

224 
pid
 = 
	`g‘_pid_äom_»¶y
(
vi
->
ùx
, vi->
ho¡
, vi->
pÜt
);

227 ià(
pid
 < 0) {

228 
	`‹¡_log_”rÜ
("Get…id failed");

232 
	`kl
(
pid
,9);

234 
vi
->
ruÂšg
 = 0;

235 
vi
->
pid
 = -1;

236 ià(
vi
->
ùx
) {

237 
	`»disF»e
(
vi
->
ùx
);

238 
vi
->
ùx
 = 
NULL
;

240 
	}
}

242 
	$ü—‹_wÜk_dœ
()

244 
sds
 
dœÇme
;

245 
dœÇme
 = 
	`sdsÿtfmt
(
	`sd£m±y
(), "tmp_‹¡_%I", 
	`v¹_u£c_now
());

246 
wÜkdœ
 = 
	`g‘AbsŞu‹P©h
(
dœÇme
);

247 
	`sdsä“
(
dœÇme
);

249 ià(
	`ü—‹_dœ
(
wÜkdœ
è!ğ
VRT_OK
) {

250 
	`‹¡_log_”rÜ
("C»©wÜkdœ % çed",
wÜkdœ
);

251  
VRT_ERROR
;

254 
	`‹¡_log_debug
("C»©wÜkdœ: %s",
wÜkdœ
);

256  
VRT_OK
;

257 
	}
}

259 
	$de¡roy_wÜk_dœ
()

261 ià(
wÜkdœ
 =ğ
NULL
è 
VRT_OK
;

263 ià(
	`de¡roy_dœ
(
wÜkdœ
è!ğ
VRT_OK
) {

264 
	`‹¡_log_”rÜ
("D–‘thwÜkdœ % çed",
wÜkdœ
);

266 
	`‹¡_log_debug
("D–‘thwÜkdœ: %s",
wÜkdœ
);

269 
	`sdsä“
(
wÜkdœ
);

270 
wÜkdœ
 = 
NULL
;

272  
VRT_OK
;

273 
	}
}

275 
	$g‘_Ãxt_pÜt
()

277 
pÜt
 = 
vœ•Üt
;

278 
vœ•Üt
 += 11;

280  
pÜt
;

281 
	}
}

283 
vœe_š¡ªû
 *
	$¡¬t_Úe_vœe_š¡ªû
()

285 
»t
;

286 
»Œy
 = 0;

287 
vœe_š¡ªû
 *
vi
;

289 
vi
 = 
	`vœe_š¡ªû_ü—‹
(
	`g‘_Ãxt_pÜt
());

290 ià(
vi
 =ğ
NULL
) {

291  
NULL
;

294 
»t
 = 
	`vœe_£rv”_run
(
vi
);

295 
»t
 !ğ
VRT_OK
 && 
»Œy
++ < 10) {

296 
	`vœe_š¡ªû_de¡roy
(
vi
);

297 
vi
 = 
	`vœe_š¡ªû_ü—‹
(
	`g‘_Ãxt_pÜt
());

298 ià(
vi
 =ğ
NULL
) {

299  
NULL
;

301 
»t
 = 
	`vœe_£rv”_run
(
vi
);

304 ià(
»t
 !ğ
VRT_OK
) {

305 
	`vœe_š¡ªû_de¡roy
(
vi
);

306  
NULL
;

309  
vi
;

310 
	}
}

312 
	$show_‹¡_»suÉ
(
»suÉ
,*
‹¡_cÚ‹Á
,*
”rmsg
)

314 ià(
»suÉ
 =ğ
VRT_TEST_OK
) {

315 
	`‹¡_log_out
("[\033[32mOK\033[0m]: %s", 
‹¡_cÚ‹Á
);

316 } ià(
»suÉ
 =ğ
VRT_TEST_ERR
) {

317 
	`‹¡_log_out
("[\033[31mERR\033[0m]: %s, \033[33mç cau£: %s\033[0m", 
‹¡_cÚ‹Á
,

318 (
”rmsg
==
NULL
||
	`¡¾’
(errmsg)==0)?"unknown":errmsg);

320 
	}
}

323 
key_ÿche_¬¿y
 *
	$key_ÿche_¬¿y_ü—‹
(
max_poŞ_size
)

325 
idx
;

326 
key_ÿche_¬¿y
 *
kÿ
;

329 ià(
max_poŞ_size
 < 10è 
NULL
;

331 
kÿ
 = 
	`m®loc
((*kca));

332 ià(
kÿ
 =ğ
NULL
)  NULL;

334 
kÿ
->
ÿched_keys_couÁ
 = 0;

335 
kÿ
->
ckeys_wr™e_idx
 = 0;

336 
kÿ
->
max_poŞ_size
 = max_pool_size;

337 
kÿ
->
ckeys
 = 
NULL
;

338 
	`±h»ad_mu‹x_š™
(&
kÿ
->
pmu‹x
,
NULL
);

340 
kÿ
->
ckeys
 = 
	`m®loc
(
max_poŞ_size
*(
sds
));

341 
idx
 = 0; idx < 
max_poŞ_size
; idx ++) {

342 
kÿ
->
ckeys
[
idx
] = 
	`sd£m±y
();

345  
kÿ
;

346 
	}
}

348 
	$key_ÿche_¬¿y_de¡roy
(
key_ÿche_¬¿y
 *
kÿ
)

350 
idx
;

352 ià(
kÿ
 =ğ
NULL
) ;

354 
	`±h»ad_mu‹x_de¡roy
(&
kÿ
->
pmu‹x
);

356 ià(
kÿ
->
ckeys
) {

357 
idx
 = 0; idx < 
kÿ
->
max_poŞ_size
; idx ++) {

358 
	`sdsä“
(
kÿ
->
ckeys
[
idx
]);

360 
	`ä“
(
kÿ
->
ckeys
);

363 
	`ä“
(
kÿ
);

364 
	}
}

366 
	$key_ÿche_¬¿y_šput
(
key_ÿche_¬¿y
 *
kÿ
, *
key
, 
size_t
 
keyËn
)

368 ià(
kÿ
 =ğ
NULL
 || 
key
 =ğNULL || 
keyËn
 =ğ0è 
VRT_ERROR
;

370 
	`±h»ad_mu‹x_lock
(&
kÿ
->
pmu‹x
);

371 
kÿ
->
ckeys
[kÿ->
ckeys_wr™e_idx
]=
	`sdsıyËn
(kÿ->ckeys[kÿ->ckeys_wr™e_idx],
key
,
keyËn
);

372 
kÿ
->
ckeys_wr™e_idx
++;

373 ià(
kÿ
->
ckeys_wr™e_idx
 >ğkÿ->
max_poŞ_size
) {

374 
kÿ
->
ckeys_wr™e_idx
 = 0;

377 ià(
kÿ
->
ÿched_keys_couÁ
 < kÿ->
max_poŞ_size
) {

378 
kÿ
->
ÿched_keys_couÁ
++;

380 
	`±h»ad_mu‹x_uÆock
(&
kÿ
->
pmu‹x
);

382  
VRT_OK
;

383 
	}
}

385 
sds
 
	$key_ÿche_¬¿y_¿ndom
(
key_ÿche_¬¿y
 *
kÿ
)

387 
idx
, 
¿ndomv®
;

388 
sds
 
key
;

390 ià(
kÿ
 =ğ
NULL
) {

391  
NULL
;

394 
¿ndomv®
 = ()
	`¿nd
();

396 
	`±h»ad_mu‹x_lock
(&
kÿ
->
pmu‹x
);

397 ià(
kÿ
->
ÿched_keys_couÁ
 == 0) {

398 
	`±h»ad_mu‹x_uÆock
(&
kÿ
->
pmu‹x
);

399  
NULL
;

402 
idx
 = 
¿ndomv®
%()
kÿ
->
ÿched_keys_couÁ
;

404 
key
 = 
	`sdsdup
(
kÿ
->
ckeys
[
idx
]);

405 
	`±h»ad_mu‹x_uÆock
(&
kÿ
->
pmu‹x
);

407  
key
;

408 
	}
}

412 
	$g‘_lÚglÚg_äom_šfo_»¶y
(
»disR•ly
 *
»¶y
, *
Çme
)

414 
sds
 *
lšes
;

415 
size_t
 
lše_Ën
, 
Ën
;

416 
couÁ
, 
j
;

417 
v®ue
 = -1;

419 
Ën
 = 
	`¡¾’
(
Çme
);

421 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

422 
	`‹¡_log_”rÜ
("Reply for 'info' command from vireype %d isƒrror",

423 
»¶y
->
ty³
);

427 
lšes
 = 
	`sds¥l™Ën
(
»¶y
->
¡r
,»¶y->
Ën
,"\r\n",2,&
couÁ
);

428 ià(
lšes
 =ğ
NULL
) {

429 
	`‹¡_log_”rÜ
("Reply for 'info server' command from vire isƒrror");

433 
j
 = 0; j < 
couÁ
; j ++) {

434 
lše_Ën
 = 
	`sd¦’
(
lšes
[
j
]);

435 ià(
lše_Ën
 > 
Ën
+1 && !
	`¡ºcmp
(
Çme
, 
lšes
[
j
],†en)) {

436 ià(
	`¡ršg2Î
(
lšes
[
j
]+
Ën
+1,
lše_Ën
-Ën-1,&
v®ue
) == 0) {

437 
	`‹¡_log_”rÜ
("Convert…id string %.*so†ong failed",

438 
lše_Ën
-
Ën
-1,
lšes
[
j
]+len+1);

439 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

446 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

447  
v®ue
;

448 
	}
}

450 
»disR•ly
 *
	$¡—l_hœedis_»di¤•ly
(
»disR•ly
 *
r
)

452 
»disR•ly
 *
»¶y
;

454 
»¶y
 = 
	`ÿÎoc
(1,(*reply));

455 ià(
»¶y
 =ğ
NULL
) {

456  
NULL
;

459 
»¶y
->
ty³
 = 
r
->type;

460 
»¶y
->
š‹g”
 = 
r
->integer;

461 
»¶y
->
Ën
 = 
r
->len;

462 
»¶y
->
¡r
 = 
r
->str;

463 
»¶y
->
–em’ts
 = 
r
->elements;

464 
»¶y
->
–em’t
 = 
r
->element;

466 
r
->
Ën
 = 0;

467 
r
->
¡r
 = 
NULL
;

468 
r
->
–em’ts
 = 0;

469 
r
->
–em’t
 = 
NULL
;

471  
»¶y
;

472 
	}
}

474 
	$check_two_»¶ys_if_§me
(
»disR•ly
 *
»¶y1
,„edisR•ly *
»¶y2
)

476 ià(
»¶y1
 =ğ
NULL
 || 
»¶y2
 == NULL) {

480 ià(
»¶y1
->
ty³
 !ğ
»¶y2
->type) {

484 ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_STRING
 ||

485 
»¶y1
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

486 
»¶y1
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

487 ià(
»¶y1
->
Ën
 !ğ
»¶y2
->len) {

488  
»¶y1
->
Ën
-
»¶y2
->len;

491  
	`memcmp
(
»¶y1
->
¡r
, 
»¶y2
->¡r,„•ly1->
Ën
);

492 } ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_ARRAY
) {

493 
size_t
 
j
;

494 ià(
»¶y1
->
–em’ts
 !ğ
»¶y2
->elements) {

495  (
»¶y1
->
–em’ts
-
»¶y2
->elements);

498 
j
 = 0; j < 
»¶y1
->
–em’ts
; j ++) {

499 
»t
 = 
	`check_two_»¶ys_if_§me
(
»¶y1
->
–em’t
[
j
], 
»¶y2
->element[j]);

500 ià(
»t
 != 0) „et;

503 } ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

504  (
»¶y1
->
š‹g”
-
»¶y2
->integer);

505 } ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_NIL
) {

508 
	`‹¡_log_”rÜ
("»¶yy³ %d i ”rÜ", 
»¶y1
->
ty³
);

512 
	}
}

514 
	ssÜt_un™
 {

515 
size_t
 
	mnf›ld
;

516 **
	mf›lds
;

517 
	midx_cmp
;

518 (*
	mfcmp
)(const *,const *);

521 
	$–em’t_cmp_muÉi_¡•
(cÚ¡ *
–e1
,cÚ¡ *
–e2
)

523 
sÜt_un™
 *
su1
 = (sÜt_un™ *)
–e1
, *
su2
 = (sÜt_un™ *)
–e2
;

525 
	`ASSERT
(
su1
->
fcmp
 =ğ
su2
->fcmp);

526 
	`ASSERT
(
su1
->
nf›ld
 =ğ
su2
->nfield);

527 
	`ASSERT
(
su1
->
idx_cmp
 =ğ
su2
->idx_cmp);

528 
	`ASSERT
(
su1
->
idx_cmp
 < su1->
nf›ld
);

530  
su1
->
	`fcmp
(&(su1->
f›lds
[su1->
idx_cmp
]),&(
su2
->fields[su2->idx_cmp]));

531 
	}
}

534 
	$sÜt_¬¿y_by_¡•
(**
–em’t
, 
size_t
 
–em’ts
,

535 
¡•
, 
idx_cmp
, (*
fcmp
)(const *,const *))

537 
sÜt_un™
 *
sus
;

538 
size_t
 
couÁ
, 
j
, 
k
;

540 ià(
–em’ts
 <= 1)

541  
VRT_OK
;

543 ià(
¡•
 <= 0)

544  
VRT_ERROR
;

546 ià(
¡•
 == 1) {

547 
	`qsÜt
(
–em’t
, 
–em’ts
, (*), 
fcmp
);

548  
VRT_OK
;

551 ià(
–em’ts
%
¡•
 != 0)

552  
VRT_ERROR
;

554 
couÁ
 = 
–em’ts
/
¡•
;

555 ià(
couÁ
 == 0)

556  
VRT_ERROR
;

557 
sus
 = 
	`ÿÎoc
(
couÁ
,(
sÜt_un™
));

558 
j
 = 0; j < 
couÁ
; j ++) {

559 
sus
[
j
].
nf›ld
 = 
¡•
;

560 
sus
[
j
].
idx_cmp
 = idx_cmp;

561 
sus
[
j
].
fcmp
 = fcmp;

562 
sus
[
j
].
f›lds
 = 
	`m®loc
(
¡•
*(*));

563 
k
 = 0; k < 
¡•
; k ++) {

564 
sus
[
j
].
f›lds
[
k
] = 
–em’t
[j*
¡•
+k];

568 
	`qsÜt
(
sus
, 
couÁ
, (
sÜt_un™
), 
–em’t_cmp_muÉi_¡•
);

570 
j
 = 0; j < 
couÁ
; j ++) {

571 
k
 = 0; k < 
¡•
; k ++) {

572 
–em’t
[
j
*
¡•
+
k
] = 
sus
[j].
f›lds
[k];

574 
	`ä“
(
sus
[
j
].
f›lds
);

576 
	`ä“
(
sus
);

577  
VRT_OK
;

578 
	}
}

581 
	$»¶y_¡ršg_bš¬y_com·»
(cÚ¡ *
r1
,cÚ¡ *
r2
)

583 
»disR•ly
 *
»¶y1
 = *ÔedisR•ly **)
r1
, *
»¶y2
 = *ÔedisR•ly **)
r2
;

584 
mšËn
;

585 
cmp
;

587 
mšËn
 = (
»¶y1
->
Ën
 < 
»¶y2
->len) ?„eply1->len:reply2->len;

588 
cmp
 = 
	`memcmp
(
»¶y1
->
¡r
,
»¶y2
->¡r,
mšËn
);

589 ià(
cmp
 =ğ0è 
»¶y1
->
Ën
 - 
»¶y2
->len;

590  
cmp
;

591 
	}
}

594 
	$·r£_commªd_ty³s
(*
commªd_ty³s_¡r
)

596 
ty³s
 = 0;

597 
sds
 *
ty³s_¡rs
;

598 
ty³s_couÁ
, 
j
;

600 
ty³s_¡rs
 = 
	`sds¥l™Ën
(
commªd_ty³s_¡r
,
	`¡¾’
(commªd_ty³s_¡r),",",1,&
ty³s_couÁ
);

601 ià(
ty³s_¡rs
 =ğ
NULL
) {

603 } ià(
ty³s_couÁ
 <= 0) {

604 
	`sdsä“¥l™»s
(
ty³s_¡rs
,
ty³s_couÁ
);

608 
j
 = 0; j < 
ty³s_couÁ
; j ++) {

609 ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"string")) {

610 
ty³s
 |ğ
TEST_CMD_TYPE_STRING
;

611 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"list")) {

612 
ty³s
 |ğ
TEST_CMD_TYPE_LIST
;

613 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"set")) {

614 
ty³s
 |ğ
TEST_CMD_TYPE_SET
;

615 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"zset")) {

616 
ty³s
 |ğ
TEST_CMD_TYPE_ZSET
;

617 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"hash")) {

618 
ty³s
 |ğ
TEST_CMD_TYPE_HASH
;

619 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"server")) {

620 
ty³s
 |ğ
TEST_CMD_TYPE_SERVER
;

621 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"key")) {

622 
ty³s
 |ğ
TEST_CMD_TYPE_KEY
;

623 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"expire")) {

624 
ty³s
 |ğ
TEST_CMD_TYPE_EXPIRE
;

626 
	`sdsä“¥l™»s
(
ty³s_¡rs
,
ty³s_couÁ
);

631 
	`sdsä“¥l™»s
(
ty³s_¡rs
,
ty³s_couÁ
);

633  
ty³s
;

634 
	}
}

637 
d¬¿y
 *
	$·r£_commªd_li¡
(*
commªd_li¡_¡r
)

639 
d¬¿y
 *
commªds
;

640 
sds
 *
commªd_–em
;

641 
sds
 *
commªd_¡rs
;

642 
commªd_couÁ
, 
j
;

644 
commªd_¡rs
 = 
	`sds¥l™Ën
(
commªd_li¡_¡r
,
	`¡¾’
(commªd_li¡_¡r),",",1,&
commªd_couÁ
);

645 ià(
commªd_¡rs
 =ğ
NULL
) {

647 } ià(
commªd_couÁ
 <= 0) {

648 
	`sdsä“¥l™»s
(
commªd_¡rs
,
commªd_couÁ
);

652 
commªds
 = 
	`d¬¿y_ü—‹
(
commªd_couÁ
, (
sds
));

653 
j
 = 0; j < 
commªd_couÁ
; j ++) {

654 
commªd_–em
 = 
	`d¬¿y_push
(
commªds
);

655 *
commªd_–em
 = 
commªd_¡rs
[
j
];

656 
commªd_¡rs
[
j
] = 
NULL
;

659 
	`sdsä“¥l™»s
(
commªd_¡rs
,
commªd_couÁ
);

661  
commªds
;

662 
	}
}

665 
	$g‘_key_ty³_¡ršg
(
keyty³
)

667 
keyty³
) {

668 
REDIS_STRING
:

671 
REDIS_LIST
:

674 
REDIS_SET
:

677 
REDIS_ZSET
:

680 
REDIS_HASH
:

689 
	}
}

	@tests/vrt_public.h

1 #iâdeà
_VRT_PUBLIC_H_


2 
	#_VRT_PUBLIC_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	~<d¥ecŸlcÚfig.h
>

10 
	~<uni¡d.h
>

12 
	~<hœedis.h
>

14 
	gd¬¿y
;

15 
	gkey_ÿche_poŞ
;

17 
	#VRT_TEST_OK
 0

	)

18 
	#VRT_TEST_ERR
 1

	)

20 
	#TEST_CMD_TYPE_STRING
 (1<<0)

	)

21 
	#TEST_CMD_TYPE_LIST
 (1<<1)

	)

22 
	#TEST_CMD_TYPE_SET
 (1<<2)

	)

23 
	#TEST_CMD_TYPE_ZSET
 (1<<3)

	)

24 
	#TEST_CMD_TYPE_HASH
 (1<<4)

	)

25 
	#TEST_CMD_TYPE_SERVER
 (1<<5)

	)

26 
	#TEST_CMD_TYPE_KEY
 (1<<6)

	)

27 
	#TEST_CMD_TYPE_EXPIRE
 (1<<7)

	)

30 
	#REDIS_STRING
 0

	)

31 
	#REDIS_LIST
 1

	)

32 
	#REDIS_SET
 2

	)

33 
	#REDIS_ZSET
 3

	)

34 
	#REDIS_HASH
 4

	)

38 #ià
defšed
(
__ATOMIC_RELAXED
)

39 
	#upd©e_¡©e_add
(
_v®ue
, 
_n
è
	`__©omic_add_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

40 
	#upd©e_¡©e_sub
(
_v®ue
, 
_n
è
	`__©omic_sub_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

41 
	#upd©e_¡©e_£t
(
_v®ue
, 
_n
è
	`__©omic_¡Üe_n
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

42 
	#upd©e_¡©e_g‘
(
_v®ue
, 
_v
) do { \

43 
	`__©omic_lßd
(&
_v®ue
, 
_v
, 
__ATOMIC_RELAXED
); \

44 } 0)

	)

46 
	#TEST_STATE_LOCK_TYPE
 "__ATOMIC_RELAXED"

	)

48 #–ià
defšed
(
HAVE_ATOMIC
)

49 
	#upd©e_¡©e_add
(
_v®ue
, 
_n
è
	`__sync_add_ªd_ãtch
(&_v®ue, (_n))

	)

50 
	#upd©e_¡©e_sub
(
_v®ue
, 
_n
è
	`__sync_sub_ªd_ãtch
(&_v®ue, (_n))

	)

51 
	#upd©e_¡©e_£t
(
_v®ue
, 
_n
è
	`__sync_lock_‹¡_ªd_£t
(&_v®ue, (_n))

	)

52 
	#upd©e_¡©e_g‘
(
_v®ue
, 
_v
) do { \

53 (*
_v
èğ
	`__sync_add_ªd_ãtch
(&
_v®ue
, 0); \

54 } 0)

	)

56 
	#TEST_STATE_LOCK_TYPE
 "HAVE_ATOMIC"

	)

58 
±h»ad_mu‹x_t
 
¡©e_lock”
;

60 
	#upd©e_¡©e_add
(
_v®ue
, 
_n
) do { \

61 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

62 
_v®ue
 +ğ(
_n
); \

63 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

64 } 0)

	)

66 
	#upd©e_¡©e_sub
(
_v®ue
, 
_n
) do { \

67 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

68 
_v®ue
 -ğ(
_n
); \

69 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

70 } 0)

	)

72 
	#upd©e_¡©e_£t
(
_v®ue
, 
_n
) do { \

73 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

74 
_v®ue
 = (
_n
); \

75 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

76 } 0)

	)

78 
	#upd©e_¡©e_g‘
(
_v®ue
, 
_v
) do { \

79 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

80 (*
_v
èğ
_v®ue
; \

81 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

82 } 0)

	)

84 
	#TEST_STATE_LOCK_TYPE
 "±h»ad_mu‹x_lock"

	)

87 
	svœe_š¡ªû
 {

88 
sds
 
	mho¡
;

89 
	mpÜt
;

91 
sds
 
	mdœ
;

92 
sds
 
	mcÚf_fe
;

93 
sds
 
	mpid_fe
;

94 
sds
 
	mlog_fe
;

96 
	mruÂšg
;

97 
	mpid
;

98 
»disCÚ‹xt
 *
	mùx
;

99 } 
	tvœe_š¡ªû
;

101 
£t_execu‹_fe
(*
fe
);

103 
vœe_š¡ªû
 *
vœe_š¡ªû_ü—‹
(
pÜt
);

104 
vœe_š¡ªû_de¡roy
(
vœe_š¡ªû
 *
vi
);

106 
vœe_£rv”_run
(
vœe_š¡ªû
 *
vi
);

107 
vœe_£rv”_¡İ
(
vœe_š¡ªû
 *
vi
);

109 
ü—‹_wÜk_dœ
();

110 
de¡roy_wÜk_dœ
();

112 
vœe_š¡ªû
 *
¡¬t_Úe_vœe_š¡ªû
();

114 
show_‹¡_»suÉ
(
»suÉ
,*
‹¡_cÚ‹Á
,*
”rmsg
);

116 
	skey_ÿche_¬¿y
 {

117 
	mÿched_keys_couÁ
;

118 
	mckeys_wr™e_idx
;

119 
	mmax_poŞ_size
;

120 
sds
 *
	mckeys
;

121 
±h»ad_mu‹x_t
 
	mpmu‹x
;

122 } 
	tkey_ÿche_¬¿y
;

124 
key_ÿche_¬¿y
 *
key_ÿche_¬¿y_ü—‹
(
max_poŞ_size
);

125 
key_ÿche_¬¿y_de¡roy
(
key_ÿche_¬¿y
 *
kÿ
);

126 
key_ÿche_¬¿y_šput
(
key_ÿche_¬¿y
 *
kÿ
, *
key
, 
size_t
 
keyËn
);

127 
sds
 
key_ÿche_¬¿y_¿ndom
(
key_ÿche_¬¿y
 *
kÿ
);

129 
g‘_lÚglÚg_äom_šfo_»¶y
(
»disR•ly
 *
»¶y
, *
Çme
);

131 
»disR•ly
 *
¡—l_hœedis_»di¤•ly
ÔedisR•ly *
r
);

132 
check_two_»¶ys_if_§me
(
»disR•ly
 *
»¶y1
,„edisR•ly *
»¶y2
);

133 
sÜt_¬¿y_by_¡•
(**
–em’t
, 
size_t
 
–em’ts
, 
¡•
, 
idx_cmp
, (*
fcmp
)(const *,const *));

134 
	`»¶y_¡ršg_bš¬y_com·»
(cÚ¡ *
r1
,cÚ¡ *
r2
);

136 
	`·r£_commªd_ty³s
(*
commªd_ty³s_¡r
);

137 
d¬¿y
 *
	`·r£_commªd_li¡
(*
commªd_li¡_¡r
);

139 *
	`g‘_key_ty³_¡ršg
(
keyty³
);

	@tests/vrt_simple.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

13 
	~<v¹_ut.h
>

14 
	~<v¹_public.h
>

15 
	~<v¹_sim¶e.h
>

17 
	#ERRMSG_MAX_LEN
 
LOG_MAX_LEN
-100

	)

18 
	g”rmsg
[
ERRMSG_MAX_LEN
];

20 
	$sim¶e_‹¡_cmd_g‘_£t
(
vœe_š¡ªû
 *
vi
)

22 *
key
 = "test_cmd_get_set-key";

23 *
v®ue
 = "test_cmd_get_set-value";

24 *
MESSAGE
 = "GET/SET simpleest";

25 
»disR•ly
 * 
»¶y
 = 
NULL
;

27 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, 
v®ue
);

28 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

29 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

30 
”rÜ
;

32 
	`ä“R•lyObjeù
(
»¶y
);

34 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

35 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

36 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

37 
”rÜ
;

39 
	`ä“R•lyObjeù
(
»¶y
);

40 
»¶y
 = 
NULL
;

42 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

46 
”rÜ
:

48 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

50 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

51 
”rmsg
[0] = '\0';

54 
	}
}

56 
	$sim¶e_‹¡_cmd_£Šx
(
vœe_š¡ªû
 *
vi
)

58 *
key
 = "test_cmd_setnx-key";

59 *
v®ue
 = "test_cmd_setnx-value";

60 *
MESSAGE
 = "SETNX simpleest";

61 
»disR•ly
 * 
»¶y
 = 
NULL
;

63 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

64 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

65 
”rÜ
;

67 
	`ä“R•lyObjeù
(
»¶y
);

69 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£Šx % %s", 
key
, 
v®ue
);

70 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

71 
»¶y
->
š‹g”
 != 1) {

72 
”rÜ
;

74 
	`ä“R•lyObjeù
(
»¶y
);

76 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

77 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

78 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

79 
”rÜ
;

81 
	`ä“R•lyObjeù
(
»¶y
);

83 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£Šx % %s", 
key
, 
v®ue
);

84 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

85 
»¶y
->
š‹g”
 != 0) {

86 
”rÜ
;

88 
	`ä“R•lyObjeù
(
»¶y
);

90 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

94 
”rÜ
:

96 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

98 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

99 
”rmsg
[0] = '\0';

102 
	}
}

104 
	$sim¶e_‹¡_cmd_£‹x
(
vœe_š¡ªû
 *
vi
)

106 *
key
 = "test_cmd_setex-key";

107 *
v®ue
 = "test_cmd_setex-value";

108 
£cÚds
 = 100;

109 *
MESSAGE
 = "SETEX simpleest";

110 
»disR•ly
 * 
»¶y
 = 
NULL
;

112 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£‹x % %Îd %s", 
key
, 
£cÚds
, 
v®ue
);

113 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

114 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

115 
”rÜ
;

117 
	`ä“R•lyObjeù
(
»¶y
);

119 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

120 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

121 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

122 
”rÜ
;

124 
	`ä“R•lyObjeù
(
»¶y
);

126 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "‰È%s", 
key
);

127 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

128 
»¶y
->
š‹g”
 > 
£cÚds
 ||„eply->integer < seconds - 2) {

129 
”rÜ
;

131 
	`ä“R•lyObjeù
(
»¶y
);

133 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

137 
”rÜ
:

139 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

141 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

142 
”rmsg
[0] = '\0';

145 
	}
}

147 
	$sim¶e_‹¡_cmd_p£‹x
(
vœe_š¡ªû
 *
vi
)

149 *
key
 = "test_cmd_psetex-key";

150 *
v®ue
 = "test_cmd_psetex-value";

151 
mli£cÚds
 = 100000;

152 *
MESSAGE
 = "PSETEX simpleest";

153 
»disR•ly
 * 
»¶y
 = 
NULL
;

155 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "p£‹x % %Îd %s", 
key
, 
mli£cÚds
, 
v®ue
);

156 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

157 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

158 
”rÜ
;

160 
	`ä“R•lyObjeù
(
»¶y
);

162 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

163 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

164 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

165 
”rÜ
;

167 
	`ä“R•lyObjeù
(
»¶y
);

169 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "± %s", 
key
);

170 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

171 
»¶y
->
š‹g”
 > 
mli£cÚds
 ||„eply->integer < milliseconds - 2000) {

172 
”rÜ
;

174 
	`ä“R•lyObjeù
(
»¶y
);

176 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

180 
”rÜ
:

182 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

184 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

185 
”rmsg
[0] = '\0';

188 
	}
}

190 
	$sim¶e_‹¡_cmd_šü
(
vœe_š¡ªû
 *
vi
)

192 *
key
 = "test_cmd_incr-key";

193 
n
 = 0, 
šü_times
 = 100;

194 *
MESSAGE
 = "INCR simpleest";

195 
»disR•ly
 * 
»¶y
 = 
NULL
;

197 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

198 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

199 
”rÜ
;

201 
	`ä“R•lyObjeù
(
»¶y
);

203 
n
 < 
šü_times
) {

204 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šü %s", 
key
);

205 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

206 
»¶y
->
š‹g”
 !ğ
n
+1) {

207 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "šü %Îdime ”rÜ", 
n
+1);

208 
”rÜ
;

210 
	`ä“R•lyObjeù
(
»¶y
);

212 
n
 ++;

215 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

216 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

217 
”rÜ
;

219 
v®ue
;

220 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
è|| v®u!ğ
šü_times
) {

221 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incro %lldƒrror, %s in fact",

222 
šü_times
, 
»¶y
->
¡r
);

223 
”rÜ
;

226 
	`ä“R•lyObjeù
(
»¶y
);

228 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

229 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

230 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

231 
”rÜ
;

233 
	`ä“R•lyObjeù
(
»¶y
);

235 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šü %s", 
key
);

236 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

237 
”rÜ
;

239 
	`ä“R•lyObjeù
(
»¶y
);

241 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

245 
”rÜ
:

247 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

249 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

250 
”rmsg
[0] = '\0';

253 
	}
}

255 
	$sim¶e_‹¡_cmd_deü
(
vœe_š¡ªû
 *
vi
)

257 *
key
 = "test_cmd_decr-key";

258 
n
 = 0, 
deü_times
 = 100;

259 *
MESSAGE
 = "DECR simpleest";

260 
»disR•ly
 * 
»¶y
 = 
NULL
;

262 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

263 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

264 
”rÜ
;

266 
	`ä“R•lyObjeù
(
»¶y
);

268 
n
 < 
deü_times
) {

269 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "deü %s", 
key
);

270 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

271 
»¶y
->
š‹g”
 + 
n
 != -1) {

272 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "šü %Îdime ”rÜ", 
n
+1);

273 
”rÜ
;

275 
	`ä“R•lyObjeù
(
»¶y
);

277 
n
 ++;

280 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

281 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

282 
”rÜ
;

284 
v®ue
;

285 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
è|| v®u+ 
deü_times
 != 0) {

286 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "decro -%lldƒrror, %s in fact",

287 
deü_times
, 
»¶y
->
¡r
);

288 
”rÜ
;

291 
	`ä“R•lyObjeù
(
»¶y
);

293 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

294 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

295 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

296 
”rÜ
;

298 
	`ä“R•lyObjeù
(
»¶y
);

300 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šü %s", 
key
);

301 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

302 
”rÜ
;

304 
	`ä“R•lyObjeù
(
»¶y
);

306 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

310 
”rÜ
:

312 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

314 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

315 
”rmsg
[0] = '\0';

318 
	}
}

320 
	$sim¶e_‹¡_cmd_šüby
(
vœe_š¡ªû
 *
vi
)

322 *
key
 = "test_cmd_incrby-key";

323 
n
 = 0, 
šüby_times
 = 100, 
šüby_¡•
 = 3;

324 *
MESSAGE
 = "INCRBY simpleest";

325 
»disR•ly
 * 
»¶y
 = 
NULL
;

327 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

328 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

329 
”rÜ
;

331 
	`ä“R•lyObjeù
(
»¶y
);

333 
n
 < 
šüby_times
) {

334 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šüby % %Îd", 
key
, 
šüby_¡•
);

335 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

336 
»¶y
->
š‹g”
 !ğ(
n
+1)*
šüby_¡•
) {

337 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incrby %lld %lldimesƒrror",

338 
šüby_¡•
, 
n
+1);

339 
”rÜ
;

341 
	`ä“R•lyObjeù
(
»¶y
);

343 
n
 ++;

346 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

347 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

348 
”rÜ
;

350 
v®ue
;

351 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
) ||

352 
v®ue
 !ğ
šüby_times
*
šüby_¡•
) {

353 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incrbyo %lldƒrror, %s in fact",

354 
šüby_times
*
šüby_¡•
, 
»¶y
->
¡r
);

355 
”rÜ
;

358 
	`ä“R•lyObjeù
(
»¶y
);

360 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

361 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

362 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

363 
”rÜ
;

365 
	`ä“R•lyObjeù
(
»¶y
);

367 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šüby % %Îd", 
key
, 
šüby_¡•
);

368 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

369 
”rÜ
;

371 
	`ä“R•lyObjeù
(
»¶y
);

373 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

377 
”rÜ
:

379 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

381 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

382 
”rmsg
[0] = '\0';

385 
	}
}

387 
	$sim¶e_‹¡_cmd_deüby
(
vœe_š¡ªû
 *
vi
)

389 *
key
 = "test_cmd_decrby-key";

390 
n
 = 0, 
deüby_times
 = 100, 
deüby_¡•
 = 3;

391 *
MESSAGE
 = "DECRBY simpleest";

392 
»disR•ly
 * 
»¶y
 = 
NULL
;

394 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

395 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

396 
”rÜ
;

398 
	`ä“R•lyObjeù
(
»¶y
);

400 
n
 < 
deüby_times
) {

401 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "deüby % %Îd", 
key
, 
deüby_¡•
);

402 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

403 
»¶y
->
š‹g”
 + (
n
+1)*
deüby_¡•
 != 0) {

404 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "decrby %lld %lldimesƒrror",

405 
deüby_¡•
, 
n
+1);

406 
”rÜ
;

408 
	`ä“R•lyObjeù
(
»¶y
);

410 
n
 ++;

413 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

414 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

415 
”rÜ
;

417 
v®ue
;

418 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
) ||

419 
v®ue
 + 
deüby_times
*
deüby_¡•
 != 0) {

420 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "decrbyo -%lldƒrror, %s in fact",

421 
deüby_times
*
deüby_¡•
, 
»¶y
->
¡r
);

422 
”rÜ
;

425 
	`ä“R•lyObjeù
(
»¶y
);

427 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

428 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

429 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

430 
”rÜ
;

432 
	`ä“R•lyObjeù
(
»¶y
);

434 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "deüby % %Îd", 
key
, 
deüby_¡•
);

435 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

436 
”rÜ
;

438 
	`ä“R•lyObjeù
(
»¶y
);

440 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

444 
”rÜ
:

446 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

448 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

449 
”rmsg
[0] = '\0';

452 
	}
}

454 
	$sim¶e_‹¡_cmd_­³nd
(
vœe_š¡ªû
 *
vi
)

456 *
key
 = "test_cmd_append-key";

457 *
fš®_v®ue
 = "pqwpioqjqwoiuqiorueljsakhdflkqueuquewqwei[oqfiqpq-0ewrq0hdalkjz.zhjaidhfioahd";

458 *
¡¬t
 = 
fš®_v®ue
, *
pos
 = s¹, *
’d
 = fš®_v®ue+
	`¡¾’
(final_value);

459 
¡•
 = 3, 
Ën
;

460 
buf
[20];

461 *
MESSAGE
 = "APPEND simpleest";

462 
»disR•ly
 * 
»¶y
 = 
NULL
;

464 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

465 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

466 
”rÜ
;

468 
	`ä“R•lyObjeù
(
»¶y
);

470 
pos
 < 
’d
) {

471 
Ën
 = (
’d
-
pos
 >ğ
¡•
) ? step : (end-pos);

472 
	`memıy
(
buf
,
pos
,
Ën
);

473 
buf
[
Ën
] = '\0';

474 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "­³nd % %s", 
key
, 
buf
);

475 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

476 
”rÜ
;

477 } ià(
»¶y
->
š‹g”
 !ğ
pos
-
¡¬t
+
Ën
) {

478 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "append %s %sƒrror",

479 
key
, 
buf
);

480 
”rÜ
;

482 
	`ä“R•lyObjeù
(
»¶y
);

484 
pos
 +ğ
Ën
;

487 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

488 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

489 
»¶y
->
Ën
 !ğ
	`¡¾’
(
fš®_v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,final_value)) {

490 
”rÜ
;

492 
	`ä“R•lyObjeù
(
»¶y
);

494 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

498 
”rÜ
:

500 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

502 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

503 
”rmsg
[0] = '\0';

506 
	}
}

508 
	$sim¶e_‹¡_cmd_¡¾’
(
vœe_š¡ªû
 *
vi
)

510 *
key
 = "test_cmd_strlen-key";

511 *
v®ue
 = "test_cmd_strlen-value";

512 *
MESSAGE
 = "STRLEN simpleest";

513 
»disR•ly
 * 
»¶y
 = 
NULL
;

515 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, 
v®ue
);

516 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

517 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

518 
”rÜ
;

520 
	`ä“R•lyObjeù
(
»¶y
);

522 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "¡¾’ %s", 
key
);

523 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

524 
»¶y
->
š‹g”
 !ğ
	`¡¾’
(
v®ue
)) {

525 
”rÜ
;

527 
	`ä“R•lyObjeù
(
»¶y
);

528 
»¶y
 = 
NULL
;

530 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

534 
”rÜ
:

536 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

538 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

539 
”rmsg
[0] = '\0';

542 
	}
}

544 
	$sim¶e_‹¡_cmd_g‘£t
(
vœe_š¡ªû
 *
vi
)

546 *
key
 = "test_cmd_getset-key";

547 *
Şdv®ue
 = "test_cmd_getset-oldvalue";

548 *
Ãwv®ue
 = "test_cmd_getset-newvalue";

549 *
MESSAGE
 = "GETSET simpleest";

550 
»disR•ly
 * 
»¶y
 = 
NULL
;

552 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, 
Şdv®ue
);

553 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

554 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

555 
”rÜ
;

557 
	`ä“R•lyObjeù
(
»¶y
);

559 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘£ˆ% %s", 
key
, 
Ãwv®ue
);

560 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

561 
»¶y
->
Ën
 !ğ
	`¡¾’
(
Şdv®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,oldvalue)) {

562 
”rÜ
;

564 
	`ä“R•lyObjeù
(
»¶y
);

566 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

567 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

568 
»¶y
->
Ën
 !ğ
	`¡¾’
(
Ãwv®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,newvalue)) {

569 
”rÜ
;

571 
	`ä“R•lyObjeù
(
»¶y
);

573 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

577 
”rÜ
:

579 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

581 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

582 
”rmsg
[0] = '\0';

585 
	}
}

587 
	$sim¶e_‹¡_cmd_šübyæßt
(
vœe_š¡ªû
 *
vi
)

589 *
key
 = "test_cmd_incrbyfloat-key";

590 *
fš®_v®ue
 = "314.00000000000000022";

591 
n
 = 0, 
šüby_times
 = 100;

592 
šübyæßt_¡•
 = 3.14;

593 *
MESSAGE
 = "INCRBYFLOAT simpleest";

594 
»disR•ly
 * 
»¶y
 = 
NULL
;

596 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

597 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

598 
”rÜ
;

600 
	`ä“R•lyObjeù
(
»¶y
);

602 
n
 < 
šüby_times
) {

603 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šübyæßˆ% %f", 
key
, 
šübyæßt_¡•
);

604 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

605 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incrbyfloat %f %lldimesƒrror",

606 
šübyæßt_¡•
, 
n
+1);

607 
”rÜ
;

609 
	`ä“R•lyObjeù
(
»¶y
);

611 
n
 ++;

614 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

615 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

616 
	`¡rcmp
(
»¶y
->
¡r
,
fš®_v®ue
)) {

617 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "šübyæßˆtØ% ”rÜ", 
fš®_v®ue
);

618 
”rÜ
;

620 
	`ä“R•lyObjeù
(
»¶y
);

622 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

623 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

624 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

625 
”rÜ
;

627 
	`ä“R•lyObjeù
(
»¶y
);

629 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šübyæßˆ% %f", 
key
, 
šübyæßt_¡•
);

630 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

631 
”rÜ
;

633 
	`ä“R•lyObjeù
(
»¶y
);

635 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

639 
”rÜ
:

641 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

643 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

644 
”rmsg
[0] = '\0';

647 
	}
}

649 
	$sim¶e_‹¡_cmd_g‘b™_£tb™_b™couÁ
(
vœe_š¡ªû
 *
vi
)

651 *
key
 = "test_cmd_getbit_setbit_bitcount-key";

652 *
MESSAGE
 = "GETBIT/SETBIT/BITCOUNT simpleest";

653 
begš
 = 11, 
¡•
 = 3, 
times
 = 79, 
n
;

654 
»disR•ly
 * 
»¶y
 = 
NULL
;

656 
n
 = 0;

657 
n
 < 
times
) {

658 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£tb™ % %d 1", 
key
, 
begš
+
n
*
¡•
);

659 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

660 
»¶y
->
š‹g”
 != 0) {

661 
”rÜ
;

663 
	`ä“R•lyObjeù
(
»¶y
);

665 
n
 ++;

668 
n
 = 0;

669 
n
 < 
times
) {

670 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘b™ % %d", 
key
, 
begš
+
n
*
¡•
);

671 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

672 
»¶y
->
š‹g”
 != 1) {

673 
”rÜ
;

675 
	`ä“R•lyObjeù
(
»¶y
);

677 
n
 ++;

680 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™couÁ %s", 
key
);

681 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

682 
»¶y
->
š‹g”
 !ğ
times
) {

683 
”rÜ
;

685 
	`ä“R•lyObjeù
(
»¶y
);

687 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

691 
”rÜ
:

693 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

695 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

696 
”rmsg
[0] = '\0';

699 
	}
}

701 
	$sim¶e_‹¡_cmd_g‘¿nge_£Œªge
(
vœe_š¡ªû
 *
vi
)

703 *
key
 = "test_cmd_getrange_setrange-key";

704 *
MESSAGE
 = "GETRANGE/SETRANGE simpleest";

705 *
¿nge_v®ue
 = "o090pl[]m,187h";

706 
begš
 = 11, 
¡•
 = 53, 
times
 = 79, 
n
;

707 
»disR•ly
 * 
»¶y
 = 
NULL
;

709 
n
 = 0;

710 
n
 < 
times
) {

711 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "setrange %s %d %s",

712 
key
, 
begš
+
n
*
¡•
, 
¿nge_v®ue
);

713 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

714 
»¶y
->
š‹g”
 !ğ
begš
+
n
*
¡•
+
	`¡¾’
(
¿nge_v®ue
)) {

715 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "setrange %s %d %sƒrror",

716 
key
, 
begš
+
n
*
¡•
, 
¿nge_v®ue
);

717 
”rÜ
;

719 
	`ä“R•lyObjeù
(
»¶y
);

721 
n
 ++;

724 
n
 = 0;

725 
n
 < 
times
) {

726 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘¿ng% %d %d", 
key
,

727 
begš
+
n
*
¡•
, begš+n*¡•+
	`¡¾’
(
¿nge_v®ue
)-1);

728 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

729 
»¶y
->
Ën
 !ğ
	`¡¾’
(
¿nge_v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,„ange_value)) {

730 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "getrange %s %d %dƒrror",

731 
key
, 
begš
+
n
*
¡•
, begš+n*¡•+
	`¡¾’
(
¿nge_v®ue
)-1);

732 
”rÜ
;

734 
	`ä“R•lyObjeù
(
»¶y
);

736 
n
 ++;

739 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

743 
”rÜ
:

745 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

747 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

748 
”rmsg
[0] = '\0';

751 
	}
}

753 
	$sim¶e_‹¡_cmd_b™pos
(
vœe_š¡ªû
 *
vi
)

755 *
key
 = "test_cmd_bitpos-key";

756 *
MESSAGE
 = "BITPOS simpleest";

757 
pos
 = 11;

758 
»disR•ly
 * 
»¶y
 = 
NULL
;

760 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

761 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

762 
”rÜ
;

764 
	`ä“R•lyObjeù
(
»¶y
);

766 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™po % 1", 
key
);

767 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

768 
»¶y
->
š‹g”
 != -1) {

769 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "bitpos %s 1 firstimeƒrror",

770 
key
);

771 
”rÜ
;

773 
	`ä“R•lyObjeù
(
»¶y
);

775 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£tb™ % 1 0", 
key
);

776 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

777 
»¶y
->
š‹g”
 != 0) {

778 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "setbit %s 1 0ƒrror",

779 
key
);

780 
”rÜ
;

782 
	`ä“R•lyObjeù
(
»¶y
);

784 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™po % 1", 
key
);

785 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

786 
»¶y
->
š‹g”
 != -1) {

787 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "bitpos %s 1 secondimeƒrror",

788 
key
);

789 
”rÜ
;

791 
	`ä“R•lyObjeù
(
»¶y
);

793 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£tb™ % %d 1", 
key
, 
pos
);

794 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

795 
»¶y
->
š‹g”
 != 0) {

796 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "setbit %s %d 1ƒrror",

797 
key
, 
pos
);

798 
”rÜ
;

800 
	`ä“R•lyObjeù
(
»¶y
);

802 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™po % 1", 
key
);

803 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

804 
»¶y
->
š‹g”
 !ğ
pos
) {

805 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "bitpos %s 1hirdimeƒrror",

806 
key
);

807 
”rÜ
;

809 
	`ä“R•lyObjeù
(
»¶y
);

811 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

815 
”rÜ
:

817 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

819 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

820 
”rmsg
[0] = '\0';

823 
	}
}

825 
	#MGET_MSET_KEYS_COUNT
 333

	)

826 
	$sim¶e_‹¡_cmd_mg‘_m£t
(
vœe_š¡ªû
 *
vi
)

828 *
key
 = "test_cmd_mget_mset-key";

829 *
v®ue
 = "test_cmd_mget_mset-value";

830 *
MESSAGE
 = "MGET/MSET simpleest";

831 
keys
[
MGET_MSET_KEYS_COUNT
][30];

832 
v®ues
[
MGET_MSET_KEYS_COUNT
][30];

833 *
¬gv
[1+2*
MGET_MSET_KEYS_COUNT
];

834 
size_t
 
¬gvËn
[1+2*
MGET_MSET_KEYS_COUNT
];

835 
j
, 
idx
;

836 
»disR•ly
 *
»¶y
 = 
NULL
;

838 
j
 = 0; j < 
MGET_MSET_KEYS_COUNT
; j ++) {

839 
	`v¹_sú´štf
(
keys
[
j
], 30,"%s%d", 
key
, j);

840 
	`v¹_sú´štf
(
v®ues
[
j
], 30,"%s%d", 
v®ue
, j);

843 
¬gv
[0] = "mset";

844 
¬gvËn
[0] = 
	`¡¾’
(
¬gv
[0]);

845 
idx
 = 1;

846 
j
 = 0; j < 
MGET_MSET_KEYS_COUNT
; j ++) {

847 
¬gv
[
idx
] = 
keys
[
j
];

848 
¬gvËn
[
idx
++] = 
	`¡¾’
(
keys
[
j
]);

849 
¬gv
[
idx
] = 
v®ues
[
j
];

850 
¬gvËn
[
idx
++] = 
	`¡¾’
(
v®ues
[
j
]);

853 
»¶y
 = 
	`»disCommªdArgv
(
vi
->
ùx
, 1+2*
MGET_MSET_KEYS_COUNT
, 
¬gv
, 
¬gvËn
);

854 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

855 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

856 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "mset %d keysƒrror",

857 
MGET_MSET_KEYS_COUNT
);

858 
”rÜ
;

860 
	`ä“R•lyObjeù
(
»¶y
);

862 
¬gv
[0] = "mget";

863 
¬gvËn
[0] = 
	`¡¾’
(
¬gv
[0]);

864 
j
 = 1; j < 1+
MGET_MSET_KEYS_COUNT
; j ++) {

865 
¬gv
[
j
] = 
keys
[j-1];

866 
¬gvËn
[
j
] = 
	`¡¾’
(
¬gv
[j]);

869 
»¶y
 = 
	`»disCommªdArgv
(
vi
->
ùx
, 1+
MGET_MSET_KEYS_COUNT
, 
¬gv
, 
¬gvËn
);

870 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ARRAY
 ||

871 
»¶y
->
–em’ts
 !ğ
MGET_MSET_KEYS_COUNT
) {

872 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "mget %d keysƒrror",

873 
MGET_MSET_KEYS_COUNT
);

874 
”rÜ
;

876 
j
 = 0; j < 
MGET_MSET_KEYS_COUNT
; j ++) {

877 
»disR•ly
 *
»¶y_sub
 = 
»¶y
->
–em’t
[
j
];

878 ià(
»¶y_sub
 =ğ
NULL
 ||

879 
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

880 
»¶y_sub
->
Ën
 !ğ
	`¡¾’
(
v®ues
[
j
]) ||

881 
	`¡rcmp
(
»¶y_sub
->
¡r
, 
v®ues
[
j
]))

882 
”rÜ
;

884 
	`ä“R•lyObjeù
(
»¶y
);

885 
»¶y
 = 
NULL
;

887 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

891 
”rÜ
:

893 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

895 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

896 
”rmsg
[0] = '\0';

899 
	}
}

901 
	#TEST_HASH_ENCODED_ZIPLIST
 0

	)

902 
	#TEST_HASH_ENCODED_HT
 1

	)

903 
	#TEST_HASH_ENCODED_CAUSED_BY_FILED
 0

	)

904 
	#TEST_HASH_ENCODED_CAUSED_BY_VALUE
 1

	)

905 
	#TEST_HASH_ENCODED_CAUSED_BY_ALL
 2

	)

906 
	#TEST_HASH_ENCODED_ZIPLIST_FIELD_COUNT
 56

	)

907 
	#TEST_HASH_ENCODED_HT_FIELD_COUNT
 678

	)

908 
	#TEST_HASH_ENCODED_ZIPLIST_VALUE_LEN
 21

	)

909 
	#TEST_HASH_ENCODED_HT_VALUE_LEN
 111

	)

911 
	s‹¡_hash_memb”
 {

912 *
	mf›ld
;

913 *
	mv®ue
;

916 
	$‹¡_hash_memb”_Ëngth
(
‹¡_hash_memb”
 **
thms
)

918 
j
 = 0;

919 
thms
[
j
]) {

920 
j
 ++;

922  
j
;

923 
	}
}

925 
	$‹¡_hash_memb”s_de¡roy
(
‹¡_hash_memb”
 **
thms
)

927 
j
 = 0;

928 
thms
[
j
]) {

929 
	`ä“
(
thms
[
j
]->
f›ld
);

930 
	`ä“
(
thms
[
j
]->
v®ue
);

931 
	`ä“
(
thms
[
j
]);

932 
j
 ++;

934 
	`ä“
(
thms
);

935 
	}
}

937 
‹¡_hash_memb”
 **
	$sim¶e_‹¡_hash_š™
(
vœe_š¡ªû
 *
vi
, *
key
, 
hash_’code
, 
’code_ÿu£
)

939 *
f›ld
 = "test_hash-field";

940 *
v®ue
 = "test_hash-value";

941 
f›ld_couÁ
, 
v®ue_Ën
;

942 
j
,
n
;

943 
‹¡_hash_memb”
 **
thms
 = 
NULL
;

944 
»disR•ly
 *
»¶y
 = 
NULL
;

946 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

947 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

948 
”rÜ
;

950 
	`ä“R•lyObjeù
(
»¶y
);

952 ià(
hash_’code
 =ğ
TEST_HASH_ENCODED_ZIPLIST
) {

953 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_ZIPLIST_FIELD_COUNT
;

954 
v®ue_Ën
 = 
TEST_HASH_ENCODED_ZIPLIST_VALUE_LEN
;

955 } ià(
’code_ÿu£
 =ğ
TEST_HASH_ENCODED_CAUSED_BY_FILED
) {

956 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_HT_FIELD_COUNT
;

957 
v®ue_Ën
 = 
TEST_HASH_ENCODED_ZIPLIST_VALUE_LEN
;

958 } ià(
’code_ÿu£
 =ğ
TEST_HASH_ENCODED_CAUSED_BY_VALUE
) {

959 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_ZIPLIST_FIELD_COUNT
;

960 
v®ue_Ën
 = 
TEST_HASH_ENCODED_HT_VALUE_LEN
;

961 } ià(
’code_ÿu£
 =ğ
TEST_HASH_ENCODED_CAUSED_BY_ALL
) {

962 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_HT_FIELD_COUNT
;

963 
v®ue_Ën
 = 
TEST_HASH_ENCODED_HT_VALUE_LEN
;

966 
thms
 = 
	`m®loc
((
f›ld_couÁ
+1)*(
‹¡_hash_memb”
*));

967 
j
 = 0; j < 
f›ld_couÁ
; j ++) {

968 
thms
[
j
] = 
	`m®loc
((
‹¡_hash_memb”
));

969 
thms
[
j
]->
f›ld
 = 
	`m®loc
(30*());

970 
thms
[
j
]->
v®ue
 = 
	`m®loc
((
v®ue_Ën
+1)*());

971 
	`v¹_sú´štf
(
thms
[
j
]->
f›ld
, 30, "%s%d", field, j);

972 
n
 = 
	`v¹_sú´štf
(
thms
[
j
]->
v®ue
, 
v®ue_Ën
, "%s%d", value, j);

973 ià(
n
 < 
v®ue_Ën
) {

974 
	`mem£t
(
thms
[
j
]->
v®ue
,'x',
v®ue_Ën
-
n
);

975 
thms
[
j
]->
v®ue
[
v®ue_Ën
] = '\0';

978 
thms
[
f›ld_couÁ
] = 
NULL
;

980 
j
 = 0; j < 
f›ld_couÁ
; j ++) {

981 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hset %s %s %s",

982 
key
, 
thms
[
j
]->
f›ld
,hms[j]->
v®ue
);

983 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

984 
»¶y
->
š‹g”
 != 1) {

985 
”rÜ
;

987 
	`ä“R•lyObjeù
(
»¶y
);

990 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hËÀ%s", 
key
);

991 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

992 
»¶y
->
š‹g”
 !ğ
f›ld_couÁ
) {

993 
”rÜ
;

995 
	`ä“R•lyObjeù
(
»¶y
);

997 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "objeùƒncodšg %s", 
key
);

998 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

999 
”rÜ
;

1001 ià(
hash_’code
 =ğ
TEST_HASH_ENCODED_ZIPLIST
) {

1002 if(
»¶y
->
Ën
 !ğ7 || 
	`¡rcmp
Ô•ly->
¡r
, "ziplist")) {

1003 
”rÜ
;

1006 if(
»¶y
->
Ën
 !ğ9 || 
	`¡rcmp
Ô•ly->
¡r
, "hashtable")) {

1007 
”rÜ
;

1011 
	`ä“R•lyObjeù
(
»¶y
);

1013  
thms
;

1015 
”rÜ
:

1017 ià(
thms
) {

1018 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1019 
thms
 = 
NULL
;

1022 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1024  
NULL
;

1025 
	}
}

1027 
	$sim¶e_‹¡_hash_’code
(
vœe_š¡ªû
 *
vi
)

1029 *
key
 = "test_hash_encode";

1030 *
MESSAGE
 = "HASH ENCODE simpleest";

1031 
‹¡_hash_memb”
 **
thms
;

1033 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_ZIPLIST
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1034 ià(
thms
 =ğ
NULL
) {

1035 
”rÜ
;

1037 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1038 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_ZIPLIST
,
TEST_HASH_ENCODED_CAUSED_BY_VALUE
);

1039 ià(
thms
 =ğ
NULL
) {

1040 
”rÜ
;

1042 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1043 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1044 ià(
thms
 =ğ
NULL
) {

1045 
”rÜ
;

1047 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1048 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_VALUE
);

1049 ià(
thms
 =ğ
NULL
) {

1050 
”rÜ
;

1052 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1053 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_ALL
);

1054 ià(
thms
 =ğ
NULL
) {

1055 
”rÜ
;

1057 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1059 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1063 
”rÜ
:

1065 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1066 
”rmsg
[0] = '\0';

1069 
	}
}

1071 
	$sim¶e_‹¡_cmd_hg‘_h£t
(
vœe_š¡ªû
 *
vi
)

1073 *
key
 = "test_cmd_hget_hset-key";

1074 *
f›ld
 = "test_cmd_hget_hset-field";

1075 *
v®ue
 = "test_cmd_hget_hset-value";

1076 *
MESSAGE
 = "HGET/HSET simpleest";

1077 
»disR•ly
 * 
»¶y
 = 
NULL
;

1078 
‹¡_hash_memb”
 **
thms
 = 
NULL
;

1079 
idx
;

1081 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1082 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1083 
”rÜ
;

1085 
	`ä“R•lyObjeù
(
»¶y
);

1087 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% % %s", 
key
, 
f›ld
, 
v®ue
);

1088 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1089 
»¶y
->
š‹g”
 != 1) {

1090 
”rÜ
;

1092 
	`ä“R•lyObjeù
(
»¶y
);

1094 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
f›ld
);

1095 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1096 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

1097 
”rÜ
;

1099 
	`ä“R•lyObjeù
(
»¶y
);

1101 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1102 ià(
thms
 =ğ
NULL
) {

1103 
”rÜ
;

1105 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% % %s", 
key
, 
f›ld
, 
v®ue
);

1106 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1107 
»¶y
->
š‹g”
 != 1) {

1108 
”rÜ
;

1110 
	`ä“R•lyObjeù
(
»¶y
);

1111 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
f›ld
);

1112 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1113 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

1114 
”rÜ
;

1116 
	`ä“R•lyObjeù
(
»¶y
);

1117 
idx
 = 
	`‹¡_hash_memb”_Ëngth
(
thms
)/2;

1118 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
thms
[
idx
]->
f›ld
);

1119 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1120 
»¶y
->
Ën
 !ğ
	`¡¾’
(
thms
[
idx
]->
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,thms[idx]->value)) {

1121 
”rÜ
;

1123 
	`ä“R•lyObjeù
(
»¶y
);

1124 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1126 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1130 
”rÜ
:

1132 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1133 ià(
thms
è
	`‹¡_hash_memb”s_de¡roy
(thms);

1135 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1136 
”rmsg
[0] = '\0';

1139 
	}
}

1141 
	$sim¶e_‹¡_cmd_hËn
(
vœe_š¡ªû
 *
vi
)

1143 *
key
 = "test_cmd_hlen-key";

1144 *
f›ld
 = "test_cmd_hlen-field";

1145 *
v®ue
 = "test_cmd_hlen-value";

1146 *
MESSAGE
 = "HLEN simpleest";

1147 
»disR•ly
 * 
»¶y
 = 
NULL
;

1148 
hash_Ën
, 
j
;

1150 
hash_Ën
 = 51;

1151 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1152 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1153 
”rÜ
;

1155 
	`ä“R•lyObjeù
(
»¶y
);

1156 
j
 = 0; j < 
hash_Ën
; j ++) {

1157 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 
j
, 
v®ue
);

1158 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1159 
»¶y
->
š‹g”
 != 1) {

1160 
”rÜ
;

1162 
	`ä“R•lyObjeù
(
»¶y
);

1164 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hËÀ%s", 
key
);

1165 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1166 
»¶y
->
š‹g”
 !ğ
hash_Ën
) {

1167 
”rÜ
;

1169 
	`ä“R•lyObjeù
(
»¶y
);

1171 
hash_Ën
 = 5111;

1172 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1173 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1174 
”rÜ
;

1176 
	`ä“R•lyObjeù
(
»¶y
);

1177 
j
 = 0; j < 
hash_Ën
; j ++) {

1178 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 
j
, 
v®ue
);

1179 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1180 
»¶y
->
š‹g”
 != 1) {

1181 
”rÜ
;

1183 
	`ä“R•lyObjeù
(
»¶y
);

1185 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hËÀ%s", 
key
);

1186 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1187 
»¶y
->
š‹g”
 !ğ
hash_Ën
) {

1188 
”rÜ
;

1190 
	`ä“R•lyObjeù
(
»¶y
);

1192 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1196 
”rÜ
:

1198 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1200 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1201 
”rmsg
[0] = '\0';

1204 
	}
}

1206 
	$sim¶e_‹¡_cmd_hd–
(
vœe_š¡ªû
 *
vi
)

1208 *
key
 = "test_cmd_hdel-key";

1209 *
f›ld
 = "test_cmd_hdel-field";

1210 *
v®ue
 = "test_cmd_hdel-value";

1211 *
MESSAGE
 = "HDEL simpleest";

1212 
»disR•ly
 * 
»¶y
 = 
NULL
;

1213 
‹¡_hash_memb”
 **
thms
 = 
NULL
;

1214 
idx
;

1216 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1217 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1218 
”rÜ
;

1220 
	`ä“R•lyObjeù
(
»¶y
);

1222 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 1, 
v®ue
);

1223 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1224 
»¶y
->
š‹g”
 != 1) {

1225 
”rÜ
;

1227 
	`ä“R•lyObjeù
(
»¶y
);

1228 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 2, 
v®ue
);

1229 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1230 
»¶y
->
š‹g”
 != 1) {

1231 
”rÜ
;

1233 
	`ä“R•lyObjeù
(
»¶y
);

1235 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s%d", 
key
, 
f›ld
, 1);

1236 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1237 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
, value)) {

1238 
”rÜ
;

1240 
	`ä“R•lyObjeù
(
»¶y
);

1241 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hd– % %s%d", 
key
, 
f›ld
, 1);

1242 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1243 
»¶y
->
š‹g”
 != 1) {

1244 
”rÜ
;

1246 
	`ä“R•lyObjeù
(
»¶y
);

1247 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s%d", 
key
, 
f›ld
, 1);

1248 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_NIL
) {

1249 
”rÜ
;

1251 
	`ä“R•lyObjeù
(
»¶y
);

1253 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hd– % %s%d", 
key
, 
f›ld
, 2);

1254 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1255 
»¶y
->
š‹g”
 != 1) {

1256 
”rÜ
;

1258 
	`ä“R•lyObjeù
(
»¶y
);

1259 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "exi¡ %s", 
key
);

1260 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1261 
»¶y
->
š‹g”
 != 0) {

1262 
”rÜ
;

1264 
	`ä“R•lyObjeù
(
»¶y
);

1266 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1267 ià(
thms
 =ğ
NULL
) {

1268 
”rÜ
;

1270 
idx
 = 
	`‹¡_hash_memb”_Ëngth
(
thms
)/2;

1271 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hd– % %s", 
key
, 
thms
[
idx
]->
f›ld
);

1272 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1273 
»¶y
->
š‹g”
 != 1) {

1274 
”rÜ
;

1276 
	`ä“R•lyObjeù
(
»¶y
);

1277 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
thms
[
idx
]->
f›ld
);

1278 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_NIL
) {

1279 
”rÜ
;

1281 
	`ä“R•lyObjeù
(
»¶y
);

1282 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1284 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1288 
”rÜ
:

1290 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1291 ià(
thms
è
	`‹¡_hash_memb”s_de¡roy
(thms);

1293 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1294 
”rmsg
[0] = '\0';

1297 
	}
}

1299 
	$sim¶e_‹¡_cmd_pçdd_pfcouÁ
(
vœe_š¡ªû
 *
vi
)

1301 *
key
 = "test_cmd_pfadd_pfcount-key";

1302 *
v®ue
 = "test_cmd_pfadd_pfcount-value";

1303 *
MESSAGE
 = "PFADD/PFCOUNT simpleest";

1304 
»disR•ly
 * 
»¶y
 = 
NULL
;

1305 
n
 = 0, 
couÁ
 = 20329, 
»³©
;

1307 
»³©
 < 2) {

1308 
ex³ù_couÁ
;

1309 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "pçdd % %s%d", 
key
, 
v®ue
, 
n
++);

1310 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

1311 
”rÜ
;

1313 
	`ä“R•lyObjeù
(
»¶y
);

1314 ià(
n
 >ğ
couÁ
) {

1315 
»³©
++;

1316 
n
 = 0;

1319 ià(
»³©
 == 0) {

1320 
ex³ù_couÁ
 = 
n
;

1322 
ex³ù_couÁ
 = 
couÁ
;

1325 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "pfcouÁ %s", 
key
);

1326 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

1327 
”rÜ
;

1329 ià(
»¶y
->
š‹g”
 !ğ()
ex³ù_couÁ
) {

1330 
mi¡ake
 = (()
ex³ù_couÁ
-()
»¶y
->
š‹g”
)/()expect_count;

1331 ià(
mi¡ake
 < -0.02 || mistake > 0.02) {

1332 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "pfadd %d differentƒlements is‚ot‡pproximated…fcount„eturned %lld, mistake %f",

1333 
ex³ù_couÁ
, 
»¶y
->
š‹g”
, 
mi¡ake
);

1334 
”rÜ
;

1337 
	`ä“R•lyObjeù
(
»¶y
);

1340 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1344 
”rÜ
:

1346 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1348 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1349 
”rmsg
[0] = '\0';

1352 
	}
}

1354 
	$sim¶e_‹¡
()

1356 
vœe_š¡ªû
 *
vi
;

1357 
ok_couÁ
 = 0, 
®l_couÁ
 = 0;

1359 
vi
 = 
	`¡¬t_Úe_vœe_š¡ªû
();

1360 ià(
vi
 =ğ
NULL
) {

1361 
	`‹¡_log_”rÜ
("Run vire instance failed");

1365 
”rmsg
[0] = '\0';

1368 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘_£t
(
vi
); 
®l_couÁ
++;

1369 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_£Šx
(
vi
); 
®l_couÁ
++;

1370 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_£‹x
(
vi
); 
®l_couÁ
++;

1371 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_p£‹x
(
vi
); 
®l_couÁ
++;

1372 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_šü
(
vi
); 
®l_couÁ
++;

1373 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_deü
(
vi
); 
®l_couÁ
++;

1374 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_šüby
(
vi
); 
®l_couÁ
++;

1375 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_deüby
(
vi
); 
®l_couÁ
++;

1376 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_­³nd
(
vi
); 
®l_couÁ
++;

1377 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_¡¾’
(
vi
); 
®l_couÁ
++;

1378 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘£t
(
vi
); 
®l_couÁ
++;

1379 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_šübyæßt
(
vi
); 
®l_couÁ
++;

1380 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘b™_£tb™_b™couÁ
(
vi
); 
®l_couÁ
++;

1381 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘¿nge_£Œªge
(
vi
); 
®l_couÁ
++;

1382 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_b™pos
(
vi
); 
®l_couÁ
++;

1383 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_mg‘_m£t
(
vi
); 
®l_couÁ
++;

1385 
ok_couÁ
+=
	`sim¶e_‹¡_hash_’code
(
vi
); 
®l_couÁ
++;

1386 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_hg‘_h£t
(
vi
); 
®l_couÁ
++;

1387 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_hËn
(
vi
); 
®l_couÁ
++;

1388 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_hd–
(
vi
); 
®l_couÁ
++;

1390 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_pçdd_pfcouÁ
(
vi
); 
®l_couÁ
++;

1392 
	`vœe_š¡ªû_de¡roy
(
vi
);

1394  
ok_couÁ
==
®l_couÁ
?1:0;

1395 
	}
}

	@tests/vrt_simple.h

1 #iâdeà
_VRT_SIMPLE_H_


2 
	#_VRT_SIMPLE_H_


	)

4 
sim¶e_‹¡
();

	@tests/vrt_util.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<”ºo.h
>

5 
	~<fú.h
>

6 
	~<uni¡d.h
>

7 
	~<dœ’t.h
>

8 
	~<¡ršg.h
>

9 
	~<ùy³.h
>

10 
	~<lim™s.h
>

11 
	~<sys/¡©.h
>

12 
	~<sys/ty³s.h
>

14 
	~<hœedis.h
>

16 
	~<v¹_ut.h
>

19 
	$v¹_as£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
)

21 
	`‹¡_log_”rÜ
("as£¹ '%s' faed @ (%s, %d)", 
cÚd
, 
fe
, 
lše
);

22 ià(
·nic
) {

23 
	`abÜt
();

25 
	}
}

28 
	$v¹_vsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
)

30 
n
;

32 
n
 = 
	`v¢´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

44 ià(
n
 <= 0) {

48 ià(
n
 < (è
size
) {

49  
n
;

52  ()(
size
 - 1);

53 
	}
}

56 
	$v¹_sú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...)

58 
va_li¡
 
¬gs
;

59 
n
;

61 
	`va_¡¬t
(
¬gs
, 
fmt
);

62 
n
 = 
	`v¹_vsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

63 
	`va_’d
(
¬gs
);

65  
n
;

66 
	}
}

69 
	$_‹¡_log_”rÜ
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
fmt
, ...)

71 
Ën
, 
size
, 
”ºo_§ve
;

72 
buf
[
LOG_MAX_LEN
];

73 
va_li¡
 
¬gs
;

75 
”ºo_§ve
 = 
”ºo
;

76 
Ën
 = 0;

77 
size
 = 
LOG_MAX_LEN
;

79 
Ën
 +ğ
	`v¹_sú´štf
(
buf
 +†’, 
size
 -†’, "%s:%d ", 
fe
, 
lše
);

81 
	`va_¡¬t
(
¬gs
, 
fmt
);

82 
Ën
 +ğ
	`v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

83 
	`va_’d
(
¬gs
);

85 
buf
[
Ën
++] = '\n';

87 
	`wr™e
(
STDERR_FILENO
, 
buf
, 
Ën
);

89 
”ºo
 = 
”ºo_§ve
;

90 
	}
}

93 
	$_‹¡_log_out
(cÚ¡ *
fmt
, ...)

95 
Ën
, 
size
, 
”ºo_§ve
;

96 
buf
[
LOG_MAX_LEN
];

97 
va_li¡
 
¬gs
;

99 
”ºo_§ve
 = 
”ºo
;

100 
Ën
 = 0;

101 
size
 = 
LOG_MAX_LEN
;

103 
	`va_¡¬t
(
¬gs
, 
fmt
);

104 
Ën
 +ğ
	`v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

105 
	`va_’d
(
¬gs
);

107 
buf
[
Ën
++] = '\n';

109 
	`wr™e
(
STDOUT_FILENO
, 
buf
, 
Ën
);

111 
”ºo
 = 
”ºo_§ve
;

112 
	}
}

117 
št64_t


118 
	$v¹_u£c_now
()

120 
timev®
 
now
;

121 
št64_t
 
u£c
;

122 
¡©us
;

124 
¡©us
 = 
	`g‘timeofday
(&
now
, 
NULL
);

125 ià(
¡©us
 < 0) {

129 
u£c
 = (
št64_t
)
now
.
tv_£c
 * 1000000LL + (št64_têow.
tv_u£c
;

131  
u£c
;

132 
	}
}

137 
št64_t


138 
	$v¹_m£c_now
()

140  
	`v¹_u£c_now
() / 1000LL;

141 
	}
}

146 
št64_t


147 
	$v¹_£c_now
()

149  
	`v¹_u£c_now
() / 1000000LL;

150 
	}
}

159 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

160 
cwd
[1024];

161 
sds
 
ab¥©h
;

162 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

164 
	`sd¡rim
(
»Í©h
," \r\n\t");

165 ià(
»Í©h
[0] == '/') „elpath;

168 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

169 
	`sdsä“
(
»Í©h
);

170  
NULL
;

172 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

173 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

174 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

182 
	`sd¦’
(
»Í©h
) >= 3 &&

183 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

185 
	`sd¤ªge
(
»Í©h
,3,-1);

186 ià(
	`sd¦’
(
ab¥©h
) > 1) {

187 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

188 
ŒimËn
 = 1;

190 *
p
 != '/') {

191 
p
--;

192 
ŒimËn
++;

194 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

199 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

200 
	`sdsä“
(
»Í©h
);

201  
ab¥©h
;

202 
	}
}

206 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

207 ià(
v
 < 10)  1;

208 ià(
v
 < 100)  2;

209 ià(
v
 < 1000)  3;

210 ià(
v
 < 1000000000000UL) {

211 ià(
v
 < 100000000UL) {

212 ià(
v
 < 1000000) {

213 ià(
v
 < 10000)  4;

214  5 + (
v
 >= 100000);

216  7 + (
v
 >= 10000000UL);

218 ià(
v
 < 10000000000UL) {

219  9 + (
v
 >= 1000000000UL);

221  11 + (
v
 >= 100000000000UL);

223  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

224 
	}
}

227 
ušt32_t
 
	$sdig™s10
(
št64_t
 
v
) {

228 ià(
v
 < 0) {

230 
ušt64_t
 
uv
 = (
v
 !ğ
LLONG_MIN
) ?

231 (
ušt64_t
)-
v
 : ((ušt64_tè
LLONG_MAX
)+1;

232  
	`dig™s10
(
uv
)+1;

234  
	`dig™s10
(
v
);

236 
	}
}

249 
	$Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

250 cÚ¡ 
dig™s
[201] =

256 
Ãg©ive
;

257 
v®ue
;

261 ià(
sv®ue
 < 0) {

262 ià(
sv®ue
 !ğ
LLONG_MIN
) {

263 
v®ue
 = -
sv®ue
;

265 
v®ue
 = ((è
LLONG_MAX
)+1;

267 
Ãg©ive
 = 1;

269 
v®ue
 = 
sv®ue
;

270 
Ãg©ive
 = 0;

274 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

275 ià(
Ëngth
 >ğ
d¡Ën
)  0;

278 
ušt32_t
 
Ãxt
 = 
Ëngth
;

279 
d¡
[
Ãxt
] = '\0';

280 
Ãxt
--;

281 
v®ue
 >= 100) {

282 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

283 
v®ue
 /= 100;

284 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

285 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

286 
Ãxt
 -= 2;

290 ià(
v®ue
 < 10) {

291 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

293 
i
 = (
ušt32_t
è
v®ue
 * 2;

294 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

295 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

299 ià(
Ãg©ive
è
d¡
[0] = '-';

300  
Ëngth
;

301 
	}
}

306 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

307 cÚ¡ *
p
 = 
s
;

308 
size_t
 
¶’
 = 0;

309 
Ãg©ive
 = 0;

310 
v
;

312 ià(
¶’
 =ğ
¦’
)

316 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

317 ià(
v®ue
 !ğ
NULL
) *value = 0;

321 ià(
p
[0] == '-') {

322 
Ãg©ive
 = 1;

323 
p
++; 
¶’
++;

326 ià(
¶’
 =ğ
¦’
)

331 ià(
p
[0] >= '1' &&…[0] <= '9') {

332 
v
 = 
p
[0]-'0';

333 
p
++; 
¶’
++;

334 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

335 *
v®ue
 = 0;

341 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

342 ià(
v
 > (
ULLONG_MAX
 / 10))

344 
v
 *= 10;

346 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

348 
v
 +ğ
p
[0]-'0';

350 
p
++; 
¶’
++;

354 ià(
¶’
 < 
¦’
)

357 ià(
Ãg©ive
) {

358 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

360 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

362 ià(
v
 > 
LLONG_MAX
)

364 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

367 
	}
}

372 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

373 
Îv®
;

375 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

378 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

381 *
lv®
 = ()
Îv®
;

383 
	}
}

387 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

388 ià(
	`i¢ª
(
v®ue
)) {

389 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

390 } ià(
	`isšf
(
v®ue
)) {

391 ià(
v®ue
 < 0)

392 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

394 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

395 } ià(
v®ue
 == 0) {

397 ià(1.0/
v®ue
 < 0)

398 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

400 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

402 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

412 
mš
 = -4503599627370495;

413 
max
 = 4503599627370496;

414 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

415 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

418 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

421  
Ën
;

422 
	}
}

424 
	$ü—‹_dœ
(*
·th
)

426 ià(
	`mkdœ
(
·th
,0755) < 0) {

427  
VRT_ERROR
;

430  
VRT_OK
;

431 
	}
}

433 
	$de¡roy_dœ
(*
·th
)

435 
DIR
 *
dp
;

436 
dœ’t
 *
’Œy
;

437 
¡©
 
¡©buf
;

438 
cwd
[1024];

440 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

441  
VRT_ERROR
;

444 ià((
dp
 = 
	`İ’dœ
(
·th
)è=ğ
NULL
) {

445 
	`‹¡_log_”rÜ
("Cª'ˆİ’ dœ: %s", 
·th
);

446  
VRT_ERROR
;

449 
	`chdœ
 (
·th
);

450 (
’Œy
 = 
	`»addœ
(
dp
)è!ğ
NULL
) {

451 
	`l¡©
(
’Œy
->
d_Çme
, &
¡©buf
);

452 ià(
S_IFDIR
 & 
¡©buf
.
¡_mode
) {

453 ià(
	`¡rcmp
(".", 
’Œy
->
d_Çme
) == 0 || strcmp("..",ƒntry->d_name) == 0)

456 
	`de¡roy_dœ
(
’Œy
->
d_Çme
);

458 
	`»move
(
’Œy
->
d_Çme
);

462 
	`chdœ
(
cwd
);

463 
	`şo£dœ
(
dp
);

465 
	`»move
(
·th
);

466  
VRT_OK
;

467 
	}
}

469 
	$g‘_pid_äom_»¶y
(
»disCÚ‹xt
 *
»disùx
, *
ho¡
, 
pÜt
)

471 
»disCÚ‹xt
 *
ùx
 = 
»disùx
;

472 
»disR•ly
 * 
»¶y
;

473 
sds
 *
lšes
;

474 
size_t
 
lše_Ën
;

475 
couÁ
, 
j
;

476 
pid
 = -1;

478 ià(
ùx
 =ğ
NULL
) {

479 
ùx
 = 
	`»disCÚÃù
(
ho¡
,
pÜt
);

482 ià(
ùx
 =ğ
NULL
) {

483 
	`‹¡_log_”rÜ
("G‘…id from in¡ªû faed: cª'ˆcÚÃùØ%s:%d",
ho¡
,
pÜt
);

487 
»¶y
 = 
	`»disCommªd
(
ùx
, "info server");

488 ià(
»¶y
 =ğ
NULL
) {

489 
	`‹¡_log_”rÜ
("Execute 'info server' command on vire failed: %s\n",

490 
ùx
->
”r
?ùx->
”r¡r
:"");

491 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

495 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

496 
	`‹¡_log_”rÜ
("Reply for 'info server' command from vireype %d isƒrror",

497 
»¶y
->
ty³
);

498 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

499 
	`ä“R•lyObjeù
(
»¶y
);

503 
lšes
 = 
	`sds¥l™Ën
(
»¶y
->
¡r
,»¶y->
Ën
,"\r\n",2,&
couÁ
);

504 ià(
lšes
 =ğ
NULL
) {

505 
	`‹¡_log_”rÜ
("Reply for 'info server' command from vire isƒrror");

506 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

507 
	`ä“R•lyObjeù
(
»¶y
);

511 
j
 = 0; j < 
couÁ
; j ++) {

512 
lše_Ën
 = 
	`sd¦’
(
lšes
[
j
]);

513 ià(
lše_Ën
 > 11 && !
	`¡ºcmp
("´oûss_id", 
lšes
[
j
], 10)) {

514 ià(
	`¡ršg2l
(
lšes
[
j
]+11,
lše_Ën
-11,&
pid
) == 0) {

515 
	`‹¡_log_”rÜ
("Convert…id string %.*so†ong failed",

516 
lše_Ën
-11,
lšes
[
j
]+11);

517 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

518 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

519 
	`ä“R•lyObjeù
(
»¶y
);

526 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

527 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

528 
	`ä“R•lyObjeù
(
»¶y
);

530  
pid
;

531 
	}
}

535 *
	$g‘_¿nge_äom_¡ršg
(*
¡r
, 
size_t
 
Ën
, *
couÁ
)

537 
–em_couÁ
;

538 
sds
 *
–ems
;

539 
v®ue
;

540 *
¿nge
;

542 
–ems
 = 
	`sds¥l™Ën
(
İrg
,
	`¡¾’
(İrg),"-",1,&
–em_couÁ
);

543 ià(
–ems
 =ğ
NULL
) {

544 
”rÜ
;

545 } ià(
–em_couÁ
 <= 0 ||ƒlem_count >= 3) {

546 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

547 
”rÜ
;

550 ià(
–em_couÁ
 == 1) {

551 ià(
	`¡ršg2Î
(
–ems
[0],
	`sd¦’
ÓËms[0]),&
v®ue
) != 1) {

552 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

553 
”rÜ
;

556 
¿nge
 = 
	`m®loc
(1*(*range));

557 
¿nge
[0] = 
v®ue
;

558 *
couÁ
 = 1;

559 } ià(
–em_couÁ
 == 2) {

560 ià(
	`¡ršg2Î
(
–ems
[0],
	`sd¦’
ÓËms[0]),&
v®ue
) != 1) {

561 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

562 
”rÜ
;

565 
¿nge
 = 
	`m®loc
(2*(*range));

566 
¿nge
[0] = 
v®ue
;

568 ià(
	`¡ršg2Î
(
–ems
[1],
	`sd¦’
ÓËms[1]),&
v®ue
) != 1) {

569 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

570 
	`ä“
(
¿nge
);

571 
”rÜ
;

574 
¿nge
[1] = 
v®ue
;

575 *
couÁ
 = 2;

577 ià(
¿nge
[0] >„ange[1]) {

578 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

579 
	`ä“
(
¿nge
);

580 
”rÜ
;

584 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

586  
¿nge
;

588 
”rÜ
:

590 *
couÁ
 = -1;

591  
NULL
;

592 
	}
}

594 
sds
 
	$g‘_ho¡_pÜt_äom_add»ss_¡ršg
(*
add»ss
, *
pÜt
)

596 
sds
 *
ho¡_pÜt
;

597 
couÁ
 = 0;

598 
sds
 
ho¡
;

599 
v®ue
;

601 *
pÜt
 = 0;

603 
ho¡_pÜt
 = 
	`sds¥l™Ën
(
add»ss
,
	`¡¾’
×dd»ss),":",1,&
couÁ
);

604 ià(
ho¡_pÜt
 =ğ
NULL
) {

605  
NULL
;

606 } ià(
couÁ
 != 2) {

607 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

608  
NULL
;

611 ià(
	`¡ršg2l
(
ho¡_pÜt
[1],
	`sd¦’
(ho¡_pÜt[1]),&
v®ue
) != 1 ||

612 
v®ue
 <= 0 || value >= 65535) {

613 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

614  
NULL
;

617 *
pÜt
 = ()
v®ue
;

618 
ho¡
 = 
ho¡_pÜt
[0];

619 
ho¡_pÜt
[0] = 
NULL
;

620 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

622  
ho¡
;

623 
	}
}

	@tests/vrt_util.h

1 #iâdeà
_VRT_UTIL_H_


2 
	#_VRT_UTIL_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 #ifdeà
HAVE_DEBUG_LOG


9 
	#VRT_DEBUG_LOG
 1

	)

12 
	~<d¥ecŸlcÚfig.h
>

14 
	~<sds.h
>

16 
	#VRT_OK
 0

	)

17 
	#VRT_ERROR
 -1

	)

19 
	#VRT_UINT8_MAXLEN
 (3 + 1)

	)

20 
	#VRT_UINT16_MAXLEN
 (5 + 1)

	)

21 
	#VRT_UINT32_MAXLEN
 (10 + 1)

	)

22 
	#VRT_UINT64_MAXLEN
 (20 + 1)

	)

23 
	#VRT_UINTMAX_MAXLEN
 
VRT_UINT64_MAXLEN


	)

25 
	#VRT_MAXHOSTNAMELEN
 256

	)

27 
	#LF
 (
ušt8_t
è10

	)

28 
	#CR
 (
ušt8_t
è13

	)

29 
	#CRLF
 "\x0d\x0a"

	)

30 
	#CRLF_LEN
 (("\x0d\x0a"è- 1)

	)

32 
	#LOG_MAX_LEN
 256

	)

34 
_‹¡_log_”rÜ
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
fmt
, ...);

35 
_‹¡_log_out
(cÚ¡ *
fmt
, ...);

36 #ià
defšed
(
VRT_DEBUG_LOG
)

37 
	#‹¡_log_debug
(...) do { \

38 
	`_‹¡_log_”rÜ
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
); \

39 } 0)

	)

41 
	#‹¡_log_debug
(...)

	)

43 
	#‹¡_log_”rÜ
(...) do { \

44 
	`_‹¡_log_”rÜ
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
); \

45 } 0)

	)

46 
	#‹¡_log_out
(...) do { \

47 
	`_‹¡_log_out
(
__VA_ARGS__
); \

48 } 0)

	)

50 
v¹_as£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
);

52 
	#ASSERT
(
_x
) do { \

53 ià(!(
_x
)) { \

54 
	`v¹_as£¹
(#_x, 
__FILE__
, 
__LINE__
, 1); \

56 } 0)

	)

58 
v¹_sú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...);

60 
št64_t
 
v¹_u£c_now
();

61 
št64_t
 
v¹_m£c_now
();

62 
št64_t
 
v¹_£c_now
();

64 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

66 
Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
);

67 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

68 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
);

69 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

71 
ü—‹_dœ
(*
·th
);

72 
de¡roy_dœ
(*
dœ
);

74 
g‘_pid_äom_»¶y
(
»disCÚ‹xt
 *
»disùx
, *
ho¡
, 
pÜt
);

76 *
g‘_¿nge_äom_¡ršg
(*
¡r
, 
size_t
 
Ën
, *
couÁ
);

78 
sds
 
g‘_ho¡_pÜt_äom_add»ss_¡ršg
(*
add»ss
, *
pÜt
);

	@tests/vrtest.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<fú.h
>

5 
	~<”ºo.h
>

6 
	~<sigÇl.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/ut¢ame.h
>

10 
	~<hœedis.h
>

12 
	~<v¹_ut.h
>

13 
	~<v¹_public.h
>

14 
	~<v¹_sim¶e.h
>

16 
	scÚfig
 {

17 *
	mpid_f’ame
;

19 
	mpidfe
;

20 
	mpid
;

23 
cÚfig
 
	gcÚfig
;

25 
	gshow_h–p
;

26 
	gshow_v”siÚ
;

28 
İtiÚ
 
	glÚg_İtiÚs
[] = {

29 { "h–p", 
no_¬gum’t
, 
NULL
, 'h' },

30 { "v”siÚ", 
no_¬gum’t
, 
NULL
, 'V' },

31 { "execu‹-fe", 
»quœed_¬gum’t
, 
NULL
, 'e' },

32 { "pid-fe", 
»quœed_¬gum’t
, 
NULL
, 'p' },

33 { 
NULL
, 0, NULL, 0 }

36 
	gshÜt_İtiÚs
[] = "hVe:p:";

39 
	$vr_show_u§ge
()

41 
	`´štf
(

42 "U§ge: vœ‘e¡ [-?hV] [-execu‹-fe] [-°pid-fe]" 
CRLF


43 "" 
CRLF
);

44 
	`´štf
(

45 "O±iÚs:" 
CRLF


46 " -h, --h–° :hi h–p" 
CRLF


47 " -V, --v”siÚ : show v”siÚ‡ndƒx™" 
CRLF


48 " -e, --execu‹-f : vœexecu‹ fe, deçuÉ i ¤c/vœe" 
CRLF


49 " -p, --pid-f :…id fe" 
CRLF


50 "" 
CRLF
);

51 
	}
}

54 
	$vr_£t_deçuÉ_İtiÚs
()

56 
cÚfig
.
pid_f’ame
 = 
NULL
;

57 
	}
}

60 
	$vr_g‘_İtiÚs
(
¬gc
, **
¬gv
)

62 
c
;

64 
İ‹¼
 = 0;

67 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İtiÚs
, 
lÚg_İtiÚs
, 
NULL
);

68 ià(
c
 == -1) {

73 
c
) {

75 
show_v”siÚ
 = 1;

76 
show_h–p
 = 1;

80 
show_v”siÚ
 = 1;

84 
	`£t_execu‹_fe
(
İrg
);

88 
cÚfig
.
pid_f’ame
 = 
İrg
;

92 
İtİt
) {

95 
	`‹¡_log_”rÜ
("vire: option -%c„equires string",

96 
İtİt
);

100 
	`‹¡_log_”rÜ
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

103  
VRT_ERROR
;

106 
	`‹¡_log_”rÜ
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

107  
VRT_ERROR
;

112  
VRT_OK
;

113 
	}
}

116 
	$maš
(
¬gc
, **
¬gv
)

118 
»t
;

119 
ok_couÁ
 = 0, 
®l_couÁ
 = 0;

121 
	`vr_£t_deçuÉ_İtiÚs
();

123 
»t
 = 
	`vr_g‘_İtiÚs
(
¬gc
, 
¬gv
);

124 ià(
»t
 !ğ
VRT_OK
) {

125 
	`vr_show_u§ge
();

126 
	`ex™
(1);

129 ià(
show_v”siÚ
) {

130 
	`‹¡_log_out
("Thi i vœ‘e¡-%s", 
VR_VERSION_STRING
);

131 ià(
show_h–p
) {

132 
	`vr_show_u§ge
();

134 
	`ex™
(0);

137 
	`ü—‹_wÜk_dœ
();

139 
	`‹¡_log_out
("Te¡šg Vœv”siÚ % \n", 
VR_VERSION_STRING
);

141 
ok_couÁ
+=
	`sim¶e_‹¡
(); 
®l_couÁ
++;

143 
ş—n
:

144 
	`de¡roy_wÜk_dœ
();

146 ià(
ok_couÁ
 =ğ
®l_couÁ
)

147 
	`‹¡_log_out
("\n\\o/ \033[32;1mAllests…assed withoutƒrrors!\033[0m\n");

148  
VRT_OK
;

149 
	}
}

	@
1
.
0
144
2650
dep/ae/ae.c
dep/ae/ae.h
dep/ae/ae_epoll.c
dep/ae/ae_evport.c
dep/ae/ae_kqueue.c
dep/ae/ae_select.c
dep/darray/darray.c
dep/darray/darray.h
dep/dhashkit/dcrc16.c
dep/dhashkit/dcrc32.c
dep/dhashkit/dfnv.c
dep/dhashkit/dhashkit.h
dep/dhashkit/dhsieh.c
dep/dhashkit/djenkins.c
dep/dhashkit/dketama.c
dep/dhashkit/dmd5.c
dep/dhashkit/dmodula.c
dep/dhashkit/dmurmur.c
dep/dhashkit/done_at_a_time.c
dep/dhashkit/drandom.c
dep/dhashkit/dsha1.c
dep/dlist/dlist.c
dep/dlist/dlist.h
dep/dlist/dlockqueue.c
dep/dlist/dlockqueue.h
dep/dlist/dmtqueue.c
dep/dlist/dmtqueue.h
dep/dmalloc/dmalloc.c
dep/dmalloc/dmalloc.h
dep/himemcached-0.1.0/himcdep/sds.c
dep/himemcached-0.1.0/himcdep/sds.h
dep/himemcached-0.1.0/himcread.c
dep/himemcached-0.1.0/himcread.h
dep/himemcached-0.1.0/himemcached.c
dep/himemcached-0.1.0/himemcached.h
dep/sds/sds.c
dep/sds/sds.h
dep/sds/sdsalloc.h
dep/util/dlog.c
dep/util/dlog.h
dep/util/dspecialconfig.h
dep/util/dutil.c
dep/util/dutil.h
src/vr.c
src/vr_aof.c
src/vr_aof.h
src/vr_backend.c
src/vr_backend.h
src/vr_bitops.c
src/vr_bitops.h
src/vr_block.c
src/vr_block.h
src/vr_client.c
src/vr_client.h
src/vr_command.c
src/vr_command.h
src/vr_conf.c
src/vr_conf.h
src/vr_connection.c
src/vr_connection.h
src/vr_core.c
src/vr_core.h
src/vr_db.c
src/vr_db.h
src/vr_dict.c
src/vr_dict.h
src/vr_eventloop.c
src/vr_eventloop.h
src/vr_hyperloglog.c
src/vr_hyperloglog.h
src/vr_intset.c
src/vr_intset.h
src/vr_listen.c
src/vr_listen.h
src/vr_lzf.h
src/vr_lzfP.h
src/vr_lzf_c.c
src/vr_lzf_d.c
src/vr_master.c
src/vr_master.h
src/vr_multi.c
src/vr_multi.h
src/vr_notify.c
src/vr_notify.h
src/vr_object.c
src/vr_object.h
src/vr_pubsub.c
src/vr_pubsub.h
src/vr_quicklist.c
src/vr_quicklist.h
src/vr_rbtree.c
src/vr_rbtree.h
src/vr_rdb.c
src/vr_rdb.h
src/vr_replication.c
src/vr_replication.h
src/vr_scripting.c
src/vr_scripting.h
src/vr_server.c
src/vr_server.h
src/vr_signal.c
src/vr_signal.h
src/vr_slowlog.c
src/vr_slowlog.h
src/vr_stats.c
src/vr_stats.h
src/vr_t_hash.c
src/vr_t_hash.h
src/vr_t_list.c
src/vr_t_list.h
src/vr_t_set.c
src/vr_t_set.h
src/vr_t_string.c
src/vr_t_string.h
src/vr_t_zset.c
src/vr_t_zset.h
src/vr_thread.c
src/vr_thread.h
src/vr_util.c
src/vr_util.h
src/vr_worker.c
src/vr_worker.h
src/vr_ziplist.c
src/vr_ziplist.h
src/vr_zipmap.c
src/vr_zipmap.h
tests/vrabtest.c
tests/vrabtest.h
tests/vrt_backend.c
tests/vrt_backend.h
tests/vrt_benchmark.c
tests/vrt_check_data.c
tests/vrt_check_data.h
tests/vrt_dispatch_data.c
tests/vrt_dispatch_data.h
tests/vrt_produce_data.c
tests/vrt_produce_data.h
tests/vrt_public.c
tests/vrt_public.h
tests/vrt_simple.c
tests/vrt_simple.h
tests/vrt_util.c
tests/vrt_util.h
tests/vrtest.c
