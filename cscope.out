cscope 15 $HOME/myownproject -q 0000009739 0003476305
	@config.h

5 
	#HAVE_ARPA_INET_H
 1

	)

11 
	#HAVE_ASSERT_PANIC
 1

	)

14 
	#HAVE_BACKTRACE
 1

	)

17 
	#HAVE_DEBUG_LOG
 1

	)

20 
	#HAVE_DLFCN_H
 1

	)

23 
	#HAVE_DUP2
 1

	)

26 
	#HAVE_EPOLL
 1

	)

32 
	#HAVE_EXECINFO_H
 1

	)

35 
	#HAVE_FCNTL_H
 1

	)

38 
	#HAVE_FLOAT_H
 1

	)

41 
	#HAVE_FORK
 1

	)

44 
	#HAVE_GETHOSTNAME
 1

	)

47 
	#HAVE_GETTIMEOFDAY
 1

	)

50 
	#HAVE_INTMAX_T
 1

	)

53 
	#HAVE_INTPTR_T
 1

	)

56 
	#HAVE_INTTYPES_H
 1

	)

59 
	#HAVE_JEMALLOC
 1

	)

65 
	#HAVE_LIBM
 1

	)

68 
	#HAVE_LIBPTHREAD
 1

	)

71 
	#HAVE_LIMITS_H
 1

	)

74 
	#HAVE_LITTLE_ENDIAN
 1

	)

77 
	#HAVE_LONG_LONG_INT
 1

	)

81 
	#HAVE_MALLOC
 1

	)

84 
	#HAVE_MEMCHR
 1

	)

87 
	#HAVE_MEMMOVE
 1

	)

90 
	#HAVE_MEMORY_H
 1

	)

93 
	#HAVE_MEMSET
 1

	)

96 
	#HAVE_NETDB_H
 1

	)

99 
	#HAVE_NETINET_IN_H
 1

	)

103 
	#HAVE_REALLOC
 1

	)

106 
	#HAVE_SOCKET
 1

	)

109 
	#HAVE_SPINLOCK
 1

	)

112 
	#HAVE_STDBOOL_H
 1

	)

115 
	#HAVE_STDDEF_H
 1

	)

118 
	#HAVE_STDINT_H
 1

	)

121 
	#HAVE_STDLIB_H
 1

	)

124 
	#HAVE_STRCHR
 1

	)

127 
	#HAVE_STRERROR
 1

	)

130 
	#HAVE_STRINGS_H
 1

	)

133 
	#HAVE_STRING_H
 1

	)

136 
	#HAVE_STRNDUP
 1

	)

139 
	#HAVE_STRTOUL
 1

	)

142 
	#HAVE_SYS_EPOLL_H
 1

	)

148 
	#HAVE_SYS_IOCTL_H
 1

	)

151 
	#HAVE_SYS_SOCKET_H
 1

	)

154 
	#HAVE_SYS_STAT_H
 1

	)

157 
	#HAVE_SYS_TIME_H
 1

	)

160 
	#HAVE_SYS_TYPES_H
 1

	)

163 
	#HAVE_SYS_UIO_H
 1

	)

166 
	#HAVE_SYS_UN_H
 1

	)

169 
	#HAVE_UINTMAX_T
 1

	)

172 
	#HAVE_UINTPTR_T
 1

	)

175 
	#HAVE_UNISTD_H
 1

	)

178 
	#HAVE_UNSIGNED_LONG_LONG_INT
 1

	)

181 
	#HAVE_VFORK
 1

	)

187 
	#HAVE_WORKING_FORK
 1

	)

190 
	#HAVE_WORKING_VFORK
 1

	)

193 
	#HAVE__BOOL
 1

	)

196 
	#LT_OBJDIR
 ".libs/"

	)

199 
	#PACKAGE
 "vœe"

	)

202 
	#PACKAGE_BUGREPORT
 "diguo58@gma.com"

	)

205 
	#PACKAGE_NAME
 "vœe"

	)

208 
	#PACKAGE_STRING
 "vœ1.0.0"

	)

211 
	#PACKAGE_TARNAME
 "vœe"

	)

214 
	#PACKAGE_URL
 ""

	)

217 
	#PACKAGE_VERSION
 "1.0.0"

	)

220 
	#STDC_HEADERS
 1

	)

223 
	#VERSION
 "1.0.0"

	)

226 
	#VR_VERSION_MAJOR
 1

	)

229 
	#VR_VERSION_MINOR
 0

	)

232 
	#VR_VERSION_PATCH
 0

	)

235 
	#VR_VERSION_STRING
 "1.0.0"

	)

239 #ià
defšed
 
AC_APPLE_UNIVERSAL_BUILD


240 #ià
defšed
 
__BIG_ENDIAN__


241 
	#WORDS_BIGENDIAN
 1

	)

244 #iâdeà
WORDS_BIGENDIAN


266 #iâdeà
__ılu¥lus


	@dep/ae/ae.c

33 
	~<¡dio.h
>

34 
	~<sys/time.h
>

35 
	~<sys/ty³s.h
>

36 
	~<uni¡d.h
>

37 
	~<¡dlib.h
>

38 
	~<pŞl.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

41 
	~<”ºo.h
>

43 
	~<dm®loc.h
>

45 
	~<«.h
>

47 #ifdeà
HAVE_CONFIG_H


48 
	~<cÚfig.h
>

53 #ifdeà
HAVE_EVENT_PORTS


54 
	~"«_evpÜt.c
"

56 #ifdeà
HAVE_EPOLL


57 
	~"«_•Şl.c
"

59 #ifdeà
HAVE_KQUEUE


60 
	~"«_kqueue.c
"

62 
	~"«_£Ëù.c
"

67 
«Ev’tLoİ
 *
	$«C»©eEv’tLoİ
(
£tsize
) {

68 
«Ev’tLoİ
 *
ev’tLoİ
;

69 
i
;

71 ià((
ev’tLoİ
 = 
	`d®loc
((*ev’tLoİ))è=ğ
NULL
è
”r
;

72 
ev’tLoİ
->
ev’ts
 = 
	`d®loc
((
«FeEv’t
)*
£tsize
);

73 
ev’tLoİ
->
fœed
 = 
	`d®loc
((
«FœedEv’t
)*
£tsize
);

74 ià(
ev’tLoİ
->
ev’ts
 =ğ
NULL
 ||ƒv’tLoİ->
fœed
 =ğNULLè
”r
;

75 
ev’tLoİ
->
£tsize
 = setsize;

76 
ev’tLoİ
->
Ï¡Time
 = 
	`time
(
NULL
);

77 
ev’tLoİ
->
timeEv’tH—d
 = 
NULL
;

78 
ev’tLoİ
->
timeEv’tNextId
 = 0;

79 
ev’tLoİ
->
¡İ
 = 0;

80 
ev’tLoİ
->
maxfd
 = -1;

81 
ev’tLoİ
->
befÜe¦“p
 = 
NULL
;

82 
ev’tLoİ
->
bsd©a
 = 
NULL
;

83 ià(
	`«ApiC»©e
(
ev’tLoİ
è=ğ-1è
”r
;

86 
i
 = 0; i < 
£tsize
; i++)

87 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

88  
ev’tLoİ
;

90 
”r
:

91 ià(
ev’tLoİ
) {

92 
	`dä“
(
ev’tLoİ
->
ev’ts
);

93 
	`dä“
(
ev’tLoİ
->
fœed
);

94 
	`dä“
(
ev’tLoİ
);

96  
NULL
;

97 
	}
}

100 
	$«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
) {

101  
ev’tLoİ
->
£tsize
;

102 
	}
}

111 
	$«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

112 
i
;

114 ià(
£tsize
 =ğ
ev’tLoİ
->£tsizeè 
AE_OK
;

115 ià(
ev’tLoİ
->
maxfd
 >ğ
£tsize
è 
AE_ERR
;

116 ià(
	`«ApiResize
(
ev’tLoİ
,
£tsize
è=ğ-1è 
AE_ERR
;

118 
ev’tLoİ
->
ev’ts
 = 
	`d»®loc
Óv’tLoİ->ev’ts,(
«FeEv’t
)*
£tsize
);

119 
ev’tLoİ
->
fœed
 = 
	`d»®loc
Óv’tLoİ->fœed,(
«FœedEv’t
)*
£tsize
);

120 
ev’tLoİ
->
£tsize
 = setsize;

124 
i
 = 
ev’tLoİ
->
maxfd
+1; i < 
£tsize
; i++)

125 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

126  
AE_OK
;

127 
	}
}

129 
	$«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

130 
	`«ApiF»e
(
ev’tLoİ
);

131 
	`dä“
(
ev’tLoİ
->
ev’ts
);

132 
	`dä“
(
ev’tLoİ
->
fœed
);

133 
	`dä“
(
ev’tLoİ
);

134 
	}
}

136 
	$«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

137 
ev’tLoİ
->
¡İ
 = 1;

138 
	}
}

140 
	$«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

141 
«FeProc
 *
´oc
, *
ş›ÁD©a
)

143 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) {

144 ià(
	`«ResizeS‘Size
(
ev’tLoİ
,
fd
+1000è!ğ
AE_OK
) {

145  
AE_ERR
;

148 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

150 ià(
	`«ApiAddEv’t
(
ev’tLoİ
, 
fd
, 
mask
) == -1)

151  
AE_ERR
;

152 
ã
->
mask
 |= mask;

153 ià(
mask
 & 
AE_READABLE
è
ã
->
rfeProc
 = 
´oc
;

154 ià(
mask
 & 
AE_WRITABLE
è
ã
->
wfeProc
 = 
´oc
;

155 
ã
->
ş›ÁD©a
 = clientData;

156 ià(
fd
 > 
ev’tLoİ
->
maxfd
)

157 
ev’tLoİ
->
maxfd
 = 
fd
;

158  
AE_OK
;

159 
	}
}

161 
	$«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
)

163 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) ;

164 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

165 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

167 
	`«ApiD–Ev’t
(
ev’tLoİ
, 
fd
, 
mask
);

168 
ã
->
mask
 = fe->mask & (~mask);

169 ià(
fd
 =ğ
ev’tLoİ
->
maxfd
 && 
ã
->
mask
 =ğ
AE_NONE
) {

171 
j
;

173 
j
 = 
ev’tLoİ
->
maxfd
-1; j >= 0; j--)

174 ià(
ev’tLoİ
->
ev’ts
[
j
].
mask
 !ğ
AE_NONE
) ;

175 
ev’tLoİ
->
maxfd
 = 
j
;

177 
	}
}

179 
	$«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
) {

180 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
)  0;

181 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

183  
ã
->
mask
;

184 
	}
}

186 
	$«G‘Time
(*
£cÚds
, *
mli£cÚds
)

188 
timev®
 
tv
;

190 
	`g‘timeofday
(&
tv
, 
NULL
);

191 *
£cÚds
 = 
tv
.
tv_£c
;

192 *
mli£cÚds
 = 
tv
.
tv_u£c
/1000;

193 
	}
}

195 
	$«AddMli£cÚdsToNow
(
mli£cÚds
, *
£c
, *
ms
) {

196 
cur_£c
, 
cur_ms
, 
wh’_£c
, 
wh’_ms
;

198 
	`«G‘Time
(&
cur_£c
, &
cur_ms
);

199 
wh’_£c
 = 
cur_£c
 + 
mli£cÚds
/1000;

200 
wh’_ms
 = 
cur_ms
 + 
mli£cÚds
%1000;

201 ià(
wh’_ms
 >= 1000) {

202 
wh’_£c
 ++;

203 
wh’_ms
 -= 1000;

205 *
£c
 = 
wh’_£c
;

206 *
ms
 = 
wh’_ms
;

207 
	}
}

209 
	$«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

210 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

211 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
)

213 
id
 = 
ev’tLoİ
->
timeEv’tNextId
++;

214 
«TimeEv’t
 *
‹
;

216 
‹
 = 
	`d®loc
((*te));

217 ià(
‹
 =ğ
NULL
è 
AE_ERR
;

218 
‹
->
id
 = id;

219 
	`«AddMli£cÚdsToNow
(
mli£cÚds
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

220 
‹
->
timeProc
 = 
´oc
;

221 
‹
->
fš®iz”Proc
 = finalizerProc;

222 
‹
->
ş›ÁD©a
 = clientData;

223 
‹
->
Ãxt
 = 
ev’tLoİ
->
timeEv’tH—d
;

224 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
;

225  
id
;

226 
	}
}

228 
	$«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
)

230 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

231 
‹
) {

232 ià(
‹
->
id
 == id) {

233 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

234  
AE_OK
;

236 
‹
 =e->
Ãxt
;

238  
AE_ERR
;

239 
	}
}

252 
«TimeEv’t
 *
	$«S—rchN—»¡Tim”
(
«Ev’tLoİ
 *
ev’tLoİ
)

254 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

255 
«TimeEv’t
 *
Ã¬e¡
 = 
NULL
;

257 
‹
) {

258 ià(!
Ã¬e¡
 || 
‹
->
wh’_£c
 <‚earest->when_sec ||

259 (
‹
->
wh’_£c
 =ğ
Ã¬e¡
->when_sec &&

260 
‹
->
wh’_ms
 < 
Ã¬e¡
->when_ms))

261 
Ã¬e¡
 = 
‹
;

262 
‹
 =e->
Ãxt
;

264  
Ã¬e¡
;

265 
	}
}

268 
	$´oûssTimeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
) {

269 
´oûs£d
 = 0;

270 
«TimeEv’t
 *
‹
, *
´ev
;

271 
maxId
;

272 
time_t
 
now
 = 
	`time
(
NULL
);

282 ià(
now
 < 
ev’tLoİ
->
Ï¡Time
) {

283 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

284 
‹
) {

285 
‹
->
wh’_£c
 = 0;

286 
‹
 =e->
Ãxt
;

289 
ev’tLoİ
->
Ï¡Time
 = 
now
;

291 
´ev
 = 
NULL
;

292 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

293 
maxId
 = 
ev’tLoİ
->
timeEv’tNextId
-1;

294 
‹
) {

295 
now_£c
, 
now_ms
;

296 
id
;

299 ià(
‹
->
id
 =ğ
AE_DELETED_EVENT_ID
) {

300 
«TimeEv’t
 *
Ãxt
 = 
‹
->next;

301 ià(
´ev
 =ğ
NULL
)

302 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
->
Ãxt
;

304 
´ev
->
Ãxt
 = 
‹
->next;

305 ià(
‹
->
fš®iz”Proc
)

306 
‹
->
	`fš®iz”Proc
(
ev’tLoİ
,e->
ş›ÁD©a
);

307 
	`dä“
(
‹
);

308 
‹
 = 
Ãxt
;

317 ià(
‹
->
id
 > 
maxId
) {

318 
‹
 =e->
Ãxt
;

321 
	`«G‘Time
(&
now_£c
, &
now_ms
);

322 ià(
now_£c
 > 
‹
->
wh’_£c
 ||

323 (
now_£c
 =ğ
‹
->
wh’_£c
 && 
now_ms
 >ğ‹->
wh’_ms
))

325 
»tv®
;

327 
id
 = 
‹
->id;

328 
»tv®
 = 
‹
->
	`timeProc
(
ev’tLoİ
, 
id
,e->
ş›ÁD©a
);

329 
´oûs£d
++;

330 ià(
»tv®
 !ğ
AE_NOMORE
) {

331 
	`«AddMli£cÚdsToNow
(
»tv®
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

333 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

336 
´ev
 = 
‹
;

337 
‹
 =e->
Ãxt
;

339  
´oûs£d
;

340 
	}
}

355 
	$«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
)

357 
´oûs£d
 = 0, 
numev’ts
;

360 ià(!(
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_FILE_EVENTS
))  0;

366 ià(
ev’tLoİ
->
maxfd
 != -1 ||

367 ((
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_DONT_WAIT
))) {

368 
j
;

369 
«TimeEv’t
 *
shÜ‹¡
 = 
NULL
;

370 
timev®
 
tv
, *
tvp
;

372 ià(
æags
 & 
AE_TIME_EVENTS
 && !(æag & 
AE_DONT_WAIT
))

373 
shÜ‹¡
 = 
	`«S—rchN—»¡Tim”
(
ev’tLoİ
);

374 ià(
shÜ‹¡
) {

375 
now_£c
, 
now_ms
;

377 
	`«G‘Time
(&
now_£c
, &
now_ms
);

378 
tvp
 = &
tv
;

382 
ms
 =

383 (
shÜ‹¡
->
wh’_£c
 - 
now_£c
)*1000 +

384 
shÜ‹¡
->
wh’_ms
 - 
now_ms
;

386 ià(
ms
 > 0) {

387 
tvp
->
tv_£c
 = 
ms
/1000;

388 
tvp
->
tv_u£c
 = (
ms
 % 1000)*1000;

390 
tvp
->
tv_£c
 = 0;

391 
tvp
->
tv_u£c
 = 0;

397 ià(
æags
 & 
AE_DONT_WAIT
) {

398 
tv
.
tv_£c
 =v.
tv_u£c
 = 0;

399 
tvp
 = &
tv
;

402 
tvp
 = 
NULL
;

406 
numev’ts
 = 
	`«ApiPŞl
(
ev’tLoİ
, 
tvp
);

407 
j
 = 0; j < 
numev’ts
; j++) {

408 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[ev’tLoİ->
fœed
[
j
].
fd
];

409 
mask
 = 
ev’tLoİ
->
fœed
[
j
].mask;

410 
fd
 = 
ev’tLoİ
->
fœed
[
j
].fd;

411 
rfœed
 = 0;

416 ià(
ã
->
mask
 & mask & 
AE_READABLE
) {

417 
rfœed
 = 1;

418 
ã
->
	`rfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

420 ià(
ã
->
mask
 & mask & 
AE_WRITABLE
) {

421 ià(!
rfœed
 || 
ã
->
wfeProc
 !ğã->
rfeProc
)

422 
ã
->
	`wfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

424 
´oûs£d
++;

428 ià(
æags
 & 
AE_TIME_EVENTS
)

429 
´oûs£d
 +ğ
	`´oûssTimeEv’ts
(
ev’tLoİ
);

431  
´oûs£d
;

432 
	}
}

436 
	$«Wa™
(
fd
, 
mask
, 
mli£cÚds
) {

437 
pŞlfd
 
pfd
;

438 
»tmask
 = 0, 
»tv®
;

440 
	`mem£t
(&
pfd
, 0, (pfd));

441 
pfd
.
fd
 = fd;

442 ià(
mask
 & 
AE_READABLE
è
pfd
.
ev’ts
 |ğ
POLLIN
;

443 ià(
mask
 & 
AE_WRITABLE
è
pfd
.
ev’ts
 |ğ
POLLOUT
;

445 ià((
»tv®
 = 
	`pŞl
(&
pfd
, 1, 
mli£cÚds
))== 1) {

446 ià(
pfd
.
»v’ts
 & 
POLLIN
è
»tmask
 |ğ
AE_READABLE
;

447 ià(
pfd
.
»v’ts
 & 
POLLOUT
è
»tmask
 |ğ
AE_WRITABLE
;

448 ià(
pfd
.
»v’ts
 & 
POLLERR
è
»tmask
 |ğ
AE_WRITABLE
;

449 ià(
pfd
.
»v’ts
 & 
POLLHUP
è
»tmask
 |ğ
AE_WRITABLE
;

450  
»tmask
;

452  
»tv®
;

454 
	}
}

456 
	$«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
) {

457 
ev’tLoİ
->
¡İ
 = 0;

458 !
ev’tLoİ
->
¡İ
) {

459 ià(
ev’tLoİ
->
befÜe¦“p
 !ğ
NULL
)

460 
ev’tLoİ
->
	`befÜe¦“p
Óv’tLoİ,ƒv’tLoİ->
bsd©a
);

461 
	`«ProûssEv’ts
(
ev’tLoİ
, 
AE_ALL_EVENTS
);

463 
	}
}

465 *
	$«G‘ApiName
() {

466  
	`«ApiName
();

467 
	}
}

469 
	$«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
, *
´iv©e_d©a
) {

470 
ev’tLoİ
->
befÜe¦“p
 = beforesleep;

471 
ev’tLoİ
->
bsd©a
 = 
´iv©e_d©a
;

472 
	}
}

	@dep/ae/ae.c

33 
	~<¡dio.h
>

34 
	~<sys/time.h
>

35 
	~<sys/ty³s.h
>

36 
	~<uni¡d.h
>

37 
	~<¡dlib.h
>

38 
	~<pŞl.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

41 
	~<”ºo.h
>

43 
	~<dm®loc.h
>

45 
	~<«.h
>

47 #ifdeà
HAVE_CONFIG_H


48 
	~<cÚfig.h
>

53 #ifdeà
HAVE_EVENT_PORTS


54 
	~"«_evpÜt.c
"

56 #ifdeà
HAVE_EPOLL


57 
	~"«_•Şl.c
"

59 #ifdeà
HAVE_KQUEUE


60 
	~"«_kqueue.c
"

62 
	~"«_£Ëù.c
"

67 
«Ev’tLoİ
 *
	$«C»©eEv’tLoİ
(
£tsize
) {

68 
«Ev’tLoİ
 *
ev’tLoİ
;

69 
i
;

71 ià((
ev’tLoİ
 = 
	`d®loc
((*ev’tLoİ))è=ğ
NULL
è
”r
;

72 
ev’tLoİ
->
ev’ts
 = 
	`d®loc
((
«FeEv’t
)*
£tsize
);

73 
ev’tLoİ
->
fœed
 = 
	`d®loc
((
«FœedEv’t
)*
£tsize
);

74 ià(
ev’tLoİ
->
ev’ts
 =ğ
NULL
 ||ƒv’tLoİ->
fœed
 =ğNULLè
”r
;

75 
ev’tLoİ
->
£tsize
 = setsize;

76 
ev’tLoİ
->
Ï¡Time
 = 
	`time
(
NULL
);

77 
ev’tLoİ
->
timeEv’tH—d
 = 
NULL
;

78 
ev’tLoİ
->
timeEv’tNextId
 = 0;

79 
ev’tLoİ
->
¡İ
 = 0;

80 
ev’tLoİ
->
maxfd
 = -1;

81 
ev’tLoİ
->
befÜe¦“p
 = 
NULL
;

82 
ev’tLoİ
->
bsd©a
 = 
NULL
;

83 ià(
	`«ApiC»©e
(
ev’tLoİ
è=ğ-1è
”r
;

86 
i
 = 0; i < 
£tsize
; i++)

87 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

88  
ev’tLoİ
;

90 
”r
:

91 ià(
ev’tLoİ
) {

92 
	`dä“
(
ev’tLoİ
->
ev’ts
);

93 
	`dä“
(
ev’tLoİ
->
fœed
);

94 
	`dä“
(
ev’tLoİ
);

96  
NULL
;

97 
	}
}

100 
	$«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
) {

101  
ev’tLoİ
->
£tsize
;

102 
	}
}

111 
	$«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

112 
i
;

114 ià(
£tsize
 =ğ
ev’tLoİ
->£tsizeè 
AE_OK
;

115 ià(
ev’tLoİ
->
maxfd
 >ğ
£tsize
è 
AE_ERR
;

116 ià(
	`«ApiResize
(
ev’tLoİ
,
£tsize
è=ğ-1è 
AE_ERR
;

118 
ev’tLoİ
->
ev’ts
 = 
	`d»®loc
Óv’tLoİ->ev’ts,(
«FeEv’t
)*
£tsize
);

119 
ev’tLoİ
->
fœed
 = 
	`d»®loc
Óv’tLoİ->fœed,(
«FœedEv’t
)*
£tsize
);

120 
ev’tLoİ
->
£tsize
 = setsize;

124 
i
 = 
ev’tLoİ
->
maxfd
+1; i < 
£tsize
; i++)

125 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

126  
AE_OK
;

127 
	}
}

129 
	$«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

130 
	`«ApiF»e
(
ev’tLoİ
);

131 
	`dä“
(
ev’tLoİ
->
ev’ts
);

132 
	`dä“
(
ev’tLoİ
->
fœed
);

133 
	`dä“
(
ev’tLoİ
);

134 
	}
}

136 
	$«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

137 
ev’tLoİ
->
¡İ
 = 1;

138 
	}
}

140 
	$«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

141 
«FeProc
 *
´oc
, *
ş›ÁD©a
)

143 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) {

144 ià(
	`«ResizeS‘Size
(
ev’tLoİ
,
fd
+1000è!ğ
AE_OK
) {

145  
AE_ERR
;

148 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

150 ià(
	`«ApiAddEv’t
(
ev’tLoİ
, 
fd
, 
mask
) == -1)

151  
AE_ERR
;

152 
ã
->
mask
 |= mask;

153 ià(
mask
 & 
AE_READABLE
è
ã
->
rfeProc
 = 
´oc
;

154 ià(
mask
 & 
AE_WRITABLE
è
ã
->
wfeProc
 = 
´oc
;

155 
ã
->
ş›ÁD©a
 = clientData;

156 ià(
fd
 > 
ev’tLoİ
->
maxfd
)

157 
ev’tLoİ
->
maxfd
 = 
fd
;

158  
AE_OK
;

159 
	}
}

161 
	$«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
)

163 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) ;

164 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

165 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

167 
	`«ApiD–Ev’t
(
ev’tLoİ
, 
fd
, 
mask
);

168 
ã
->
mask
 = fe->mask & (~mask);

169 ià(
fd
 =ğ
ev’tLoİ
->
maxfd
 && 
ã
->
mask
 =ğ
AE_NONE
) {

171 
j
;

173 
j
 = 
ev’tLoİ
->
maxfd
-1; j >= 0; j--)

174 ià(
ev’tLoİ
->
ev’ts
[
j
].
mask
 !ğ
AE_NONE
) ;

175 
ev’tLoİ
->
maxfd
 = 
j
;

177 
	}
}

179 
	$«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
) {

180 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
)  0;

181 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

183  
ã
->
mask
;

184 
	}
}

186 
	$«G‘Time
(*
£cÚds
, *
mli£cÚds
)

188 
timev®
 
tv
;

190 
	`g‘timeofday
(&
tv
, 
NULL
);

191 *
£cÚds
 = 
tv
.
tv_£c
;

192 *
mli£cÚds
 = 
tv
.
tv_u£c
/1000;

193 
	}
}

195 
	$«AddMli£cÚdsToNow
(
mli£cÚds
, *
£c
, *
ms
) {

196 
cur_£c
, 
cur_ms
, 
wh’_£c
, 
wh’_ms
;

198 
	`«G‘Time
(&
cur_£c
, &
cur_ms
);

199 
wh’_£c
 = 
cur_£c
 + 
mli£cÚds
/1000;

200 
wh’_ms
 = 
cur_ms
 + 
mli£cÚds
%1000;

201 ià(
wh’_ms
 >= 1000) {

202 
wh’_£c
 ++;

203 
wh’_ms
 -= 1000;

205 *
£c
 = 
wh’_£c
;

206 *
ms
 = 
wh’_ms
;

207 
	}
}

209 
	$«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

210 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

211 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
)

213 
id
 = 
ev’tLoİ
->
timeEv’tNextId
++;

214 
«TimeEv’t
 *
‹
;

216 
‹
 = 
	`d®loc
((*te));

217 ià(
‹
 =ğ
NULL
è 
AE_ERR
;

218 
‹
->
id
 = id;

219 
	`«AddMli£cÚdsToNow
(
mli£cÚds
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

220 
‹
->
timeProc
 = 
´oc
;

221 
‹
->
fš®iz”Proc
 = finalizerProc;

222 
‹
->
ş›ÁD©a
 = clientData;

223 
‹
->
Ãxt
 = 
ev’tLoİ
->
timeEv’tH—d
;

224 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
;

225  
id
;

226 
	}
}

228 
	$«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
)

230 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

231 
‹
) {

232 ià(
‹
->
id
 == id) {

233 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

234  
AE_OK
;

236 
‹
 =e->
Ãxt
;

238  
AE_ERR
;

239 
	}
}

252 
«TimeEv’t
 *
	$«S—rchN—»¡Tim”
(
«Ev’tLoİ
 *
ev’tLoİ
)

254 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

255 
«TimeEv’t
 *
Ã¬e¡
 = 
NULL
;

257 
‹
) {

258 ià(!
Ã¬e¡
 || 
‹
->
wh’_£c
 <‚earest->when_sec ||

259 (
‹
->
wh’_£c
 =ğ
Ã¬e¡
->when_sec &&

260 
‹
->
wh’_ms
 < 
Ã¬e¡
->when_ms))

261 
Ã¬e¡
 = 
‹
;

262 
‹
 =e->
Ãxt
;

264  
Ã¬e¡
;

265 
	}
}

268 
	$´oûssTimeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
) {

269 
´oûs£d
 = 0;

270 
«TimeEv’t
 *
‹
, *
´ev
;

271 
maxId
;

272 
time_t
 
now
 = 
	`time
(
NULL
);

282 ià(
now
 < 
ev’tLoİ
->
Ï¡Time
) {

283 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

284 
‹
) {

285 
‹
->
wh’_£c
 = 0;

286 
‹
 =e->
Ãxt
;

289 
ev’tLoİ
->
Ï¡Time
 = 
now
;

291 
´ev
 = 
NULL
;

292 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

293 
maxId
 = 
ev’tLoİ
->
timeEv’tNextId
-1;

294 
‹
) {

295 
now_£c
, 
now_ms
;

296 
id
;

299 ià(
‹
->
id
 =ğ
AE_DELETED_EVENT_ID
) {

300 
«TimeEv’t
 *
Ãxt
 = 
‹
->next;

301 ià(
´ev
 =ğ
NULL
)

302 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
->
Ãxt
;

304 
´ev
->
Ãxt
 = 
‹
->next;

305 ià(
‹
->
fš®iz”Proc
)

306 
‹
->
	`fš®iz”Proc
(
ev’tLoİ
,e->
ş›ÁD©a
);

307 
	`dä“
(
‹
);

308 
‹
 = 
Ãxt
;

317 ià(
‹
->
id
 > 
maxId
) {

318 
‹
 =e->
Ãxt
;

321 
	`«G‘Time
(&
now_£c
, &
now_ms
);

322 ià(
now_£c
 > 
‹
->
wh’_£c
 ||

323 (
now_£c
 =ğ
‹
->
wh’_£c
 && 
now_ms
 >ğ‹->
wh’_ms
))

325 
»tv®
;

327 
id
 = 
‹
->id;

328 
»tv®
 = 
‹
->
	`timeProc
(
ev’tLoİ
, 
id
,e->
ş›ÁD©a
);

329 
´oûs£d
++;

330 ià(
»tv®
 !ğ
AE_NOMORE
) {

331 
	`«AddMli£cÚdsToNow
(
»tv®
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

333 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

336 
´ev
 = 
‹
;

337 
‹
 =e->
Ãxt
;

339  
´oûs£d
;

340 
	}
}

355 
	$«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
)

357 
´oûs£d
 = 0, 
numev’ts
;

360 ià(!(
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_FILE_EVENTS
))  0;

366 ià(
ev’tLoİ
->
maxfd
 != -1 ||

367 ((
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_DONT_WAIT
))) {

368 
j
;

369 
«TimeEv’t
 *
shÜ‹¡
 = 
NULL
;

370 
timev®
 
tv
, *
tvp
;

372 ià(
æags
 & 
AE_TIME_EVENTS
 && !(æag & 
AE_DONT_WAIT
))

373 
shÜ‹¡
 = 
	`«S—rchN—»¡Tim”
(
ev’tLoİ
);

374 ià(
shÜ‹¡
) {

375 
now_£c
, 
now_ms
;

377 
	`«G‘Time
(&
now_£c
, &
now_ms
);

378 
tvp
 = &
tv
;

382 
ms
 =

383 (
shÜ‹¡
->
wh’_£c
 - 
now_£c
)*1000 +

384 
shÜ‹¡
->
wh’_ms
 - 
now_ms
;

386 ià(
ms
 > 0) {

387 
tvp
->
tv_£c
 = 
ms
/1000;

388 
tvp
->
tv_u£c
 = (
ms
 % 1000)*1000;

390 
tvp
->
tv_£c
 = 0;

391 
tvp
->
tv_u£c
 = 0;

397 ià(
æags
 & 
AE_DONT_WAIT
) {

398 
tv
.
tv_£c
 =v.
tv_u£c
 = 0;

399 
tvp
 = &
tv
;

402 
tvp
 = 
NULL
;

406 
numev’ts
 = 
	`«ApiPŞl
(
ev’tLoİ
, 
tvp
);

407 
j
 = 0; j < 
numev’ts
; j++) {

408 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[ev’tLoİ->
fœed
[
j
].
fd
];

409 
mask
 = 
ev’tLoİ
->
fœed
[
j
].mask;

410 
fd
 = 
ev’tLoİ
->
fœed
[
j
].fd;

411 
rfœed
 = 0;

416 ià(
ã
->
mask
 & mask & 
AE_READABLE
) {

417 
rfœed
 = 1;

418 
ã
->
	`rfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

420 ià(
ã
->
mask
 & mask & 
AE_WRITABLE
) {

421 ià(!
rfœed
 || 
ã
->
wfeProc
 !ğã->
rfeProc
)

422 
ã
->
	`wfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

424 
´oûs£d
++;

428 ià(
æags
 & 
AE_TIME_EVENTS
)

429 
´oûs£d
 +ğ
	`´oûssTimeEv’ts
(
ev’tLoİ
);

431  
´oûs£d
;

432 
	}
}

436 
	$«Wa™
(
fd
, 
mask
, 
mli£cÚds
) {

437 
pŞlfd
 
pfd
;

438 
»tmask
 = 0, 
»tv®
;

440 
	`mem£t
(&
pfd
, 0, (pfd));

441 
pfd
.
fd
 = fd;

442 ià(
mask
 & 
AE_READABLE
è
pfd
.
ev’ts
 |ğ
POLLIN
;

443 ià(
mask
 & 
AE_WRITABLE
è
pfd
.
ev’ts
 |ğ
POLLOUT
;

445 ià((
»tv®
 = 
	`pŞl
(&
pfd
, 1, 
mli£cÚds
))== 1) {

446 ià(
pfd
.
»v’ts
 & 
POLLIN
è
»tmask
 |ğ
AE_READABLE
;

447 ià(
pfd
.
»v’ts
 & 
POLLOUT
è
»tmask
 |ğ
AE_WRITABLE
;

448 ià(
pfd
.
»v’ts
 & 
POLLERR
è
»tmask
 |ğ
AE_WRITABLE
;

449 ià(
pfd
.
»v’ts
 & 
POLLHUP
è
»tmask
 |ğ
AE_WRITABLE
;

450  
»tmask
;

452  
»tv®
;

454 
	}
}

456 
	$«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
) {

457 
ev’tLoİ
->
¡İ
 = 0;

458 !
ev’tLoİ
->
¡İ
) {

459 ià(
ev’tLoİ
->
befÜe¦“p
 !ğ
NULL
)

460 
ev’tLoİ
->
	`befÜe¦“p
Óv’tLoİ,ƒv’tLoİ->
bsd©a
);

461 
	`«ProûssEv’ts
(
ev’tLoİ
, 
AE_ALL_EVENTS
);

463 
	}
}

465 *
	$«G‘ApiName
() {

466  
	`«ApiName
();

467 
	}
}

469 
	$«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
, *
´iv©e_d©a
) {

470 
ev’tLoİ
->
befÜe¦“p
 = beforesleep;

471 
ev’tLoİ
->
bsd©a
 = 
´iv©e_d©a
;

472 
	}
}

	@dep/ae/ae.h

33 #iâdeà
__AE_H__


34 
	#__AE_H__


	)

36 
	~<time.h
>

38 
	#AE_OK
 0

	)

39 
	#AE_ERR
 -1

	)

41 
	#AE_NONE
 0

	)

42 
	#AE_READABLE
 1

	)

43 
	#AE_WRITABLE
 2

	)

45 
	#AE_FILE_EVENTS
 1

	)

46 
	#AE_TIME_EVENTS
 2

	)

47 
	#AE_ALL_EVENTS
 (
AE_FILE_EVENTS
|
AE_TIME_EVENTS
)

	)

48 
	#AE_DONT_WAIT
 4

	)

50 
	#AE_NOMORE
 -1

	)

51 
	#AE_DELETED_EVENT_ID
 -1

	)

54 
	#AE_NOTUSED
(
V
è((èV)

	)

56 
	g«Ev’tLoİ
;

59 
	t«FeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tfd
, *
	tş›ÁD©a
, 
	tmask
);

60 
	t«TimeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tid
, *
	tş›ÁD©a
);

61 
	t«Ev’tFš®iz”Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	tş›ÁD©a
);

62 
	t«BefÜeSË•Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	t´iv©e_d©a
);

65 
	s«FeEv’t
 {

66 
	mmask
;

67 
«FeProc
 *
	mrfeProc
;

68 
«FeProc
 *
	mwfeProc
;

69 *
	mş›ÁD©a
;

70 } 
	t«FeEv’t
;

73 
	s«TimeEv’t
 {

74 
	mid
;

75 
	mwh’_£c
;

76 
	mwh’_ms
;

77 
«TimeProc
 *
	mtimeProc
;

78 
«Ev’tFš®iz”Proc
 *
	mfš®iz”Proc
;

79 *
	mş›ÁD©a
;

80 
«TimeEv’t
 *
	mÃxt
;

81 } 
	t«TimeEv’t
;

84 
	s«FœedEv’t
 {

85 
	mfd
;

86 
	mmask
;

87 } 
	t«FœedEv’t
;

90 
	s«Ev’tLoİ
 {

91 
	mmaxfd
;

92 
	m£tsize
;

93 
	mtimeEv’tNextId
;

94 
time_t
 
	mÏ¡Time
;

95 
«FeEv’t
 *
	mev’ts
;

96 
«FœedEv’t
 *
	mfœed
;

97 
«TimeEv’t
 *
	mtimeEv’tH—d
;

98 
	m¡İ
;

99 *
	m­id©a
;

100 
«BefÜeSË•Proc
 *
	mbefÜe¦“p
;

101 *
	mbsd©a
;

102 } 
	t«Ev’tLoİ
;

107 
«Ev’tLoİ
 *
«C»©eEv’tLoİ
(
£tsize
);

108 
«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

109 
«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

110 
«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

111 
«FeProc
 *
´oc
, *
ş›ÁD©a
);

112 
«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
);

113 
«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
);

114 
«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

115 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

116 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
);

117 
«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
);

118 
«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
);

119 
«Wa™
(
fd
, 
mask
, 
mli£cÚds
);

120 
«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
);

121 *
«G‘ApiName
();

122 
«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
, *
´iv©e_d©a
);

123 
«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
);

124 
«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
);

	@dep/ae/ae.h

33 #iâdeà
__AE_H__


34 
	#__AE_H__


	)

36 
	~<time.h
>

38 
	#AE_OK
 0

	)

39 
	#AE_ERR
 -1

	)

41 
	#AE_NONE
 0

	)

42 
	#AE_READABLE
 1

	)

43 
	#AE_WRITABLE
 2

	)

45 
	#AE_FILE_EVENTS
 1

	)

46 
	#AE_TIME_EVENTS
 2

	)

47 
	#AE_ALL_EVENTS
 (
AE_FILE_EVENTS
|
AE_TIME_EVENTS
)

	)

48 
	#AE_DONT_WAIT
 4

	)

50 
	#AE_NOMORE
 -1

	)

51 
	#AE_DELETED_EVENT_ID
 -1

	)

54 
	#AE_NOTUSED
(
V
è((èV)

	)

56 
	g«Ev’tLoİ
;

59 
	t«FeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tfd
, *
	tş›ÁD©a
, 
	tmask
);

60 
	t«TimeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tid
, *
	tş›ÁD©a
);

61 
	t«Ev’tFš®iz”Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	tş›ÁD©a
);

62 
	t«BefÜeSË•Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	t´iv©e_d©a
);

65 
	s«FeEv’t
 {

66 
	mmask
;

67 
«FeProc
 *
	mrfeProc
;

68 
«FeProc
 *
	mwfeProc
;

69 *
	mş›ÁD©a
;

70 } 
	t«FeEv’t
;

73 
	s«TimeEv’t
 {

74 
	mid
;

75 
	mwh’_£c
;

76 
	mwh’_ms
;

77 
«TimeProc
 *
	mtimeProc
;

78 
«Ev’tFš®iz”Proc
 *
	mfš®iz”Proc
;

79 *
	mş›ÁD©a
;

80 
«TimeEv’t
 *
	mÃxt
;

81 } 
	t«TimeEv’t
;

84 
	s«FœedEv’t
 {

85 
	mfd
;

86 
	mmask
;

87 } 
	t«FœedEv’t
;

90 
	s«Ev’tLoİ
 {

91 
	mmaxfd
;

92 
	m£tsize
;

93 
	mtimeEv’tNextId
;

94 
time_t
 
	mÏ¡Time
;

95 
«FeEv’t
 *
	mev’ts
;

96 
«FœedEv’t
 *
	mfœed
;

97 
«TimeEv’t
 *
	mtimeEv’tH—d
;

98 
	m¡İ
;

99 *
	m­id©a
;

100 
«BefÜeSË•Proc
 *
	mbefÜe¦“p
;

101 *
	mbsd©a
;

102 } 
	t«Ev’tLoİ
;

107 
«Ev’tLoİ
 *
«C»©eEv’tLoİ
(
£tsize
);

108 
«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

109 
«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

110 
«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

111 
«FeProc
 *
´oc
, *
ş›ÁD©a
);

112 
«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
);

113 
«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
);

114 
«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

115 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

116 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
);

117 
«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
);

118 
«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
);

119 
«Wa™
(
fd
, 
mask
, 
mli£cÚds
);

120 
«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
);

121 *
«G‘ApiName
();

122 
«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
, *
´iv©e_d©a
);

123 
«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
);

124 
«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
);

	@dep/ae/ae_epoll.c

32 
	~<sys/•Şl.h
>

34 
	s«ApiS‹
 {

35 
	m•fd
;

36 
•Şl_ev’t
 *
	mev’ts
;

37 } 
	t«ApiS‹
;

39 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

40 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

42 ià(!
¡©e
)  -1;

43 
¡©e
->
ev’ts
 = 
	`d®loc
((
•Şl_ev’t
)*
ev’tLoİ
->
£tsize
);

44 ià(!
¡©e
->
ev’ts
) {

45 
	`dä“
(
¡©e
);

48 
¡©e
->
•fd
 = 
	`•Şl_ü—‹
(1024);

49 ià(
¡©e
->
•fd
 == -1) {

50 
	`dä“
(
¡©e
->
ev’ts
);

51 
	`dä“
(
¡©e
);

54 
ev’tLoİ
->
­id©a
 = 
¡©e
;

56 
	}
}

58 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

59 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

61 
¡©e
->
ev’ts
 = 
	`d»®loc
(¡©e->ev’ts, (
•Şl_ev’t
)*
£tsize
);

63 
	}
}

65 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

66 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

68 
	`şo£
(
¡©e
->
•fd
);

69 
	`dä“
(
¡©e
->
ev’ts
);

70 
	`dä“
(
¡©e
);

71 
	}
}

73 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

74 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

75 
•Şl_ev’t
 
“
 = {0};

78 
İ
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
 =ğ
AE_NONE
 ?

79 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
;

81 
“
.
ev’ts
 = 0;

82 
mask
 |ğ
ev’tLoİ
->
ev’ts
[
fd
].mask;

83 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

84 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

85 
“
.
d©a
.
fd
 = fd;

86 ià(
	`•Şl_ùl
(
¡©e
->
•fd
,
İ
,
fd
,&
“
) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
d–mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
•Şl_ev’t
 
“
 = {0};

93 
mask
 = 
ev’tLoİ
->
ev’ts
[
fd
].mask & (~
d–mask
);

95 
“
.
ev’ts
 = 0;

96 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

97 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

98 
“
.
d©a
.
fd
 = fd;

99 ià(
mask
 !ğ
AE_NONE
) {

100 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_MOD
,
fd
,&
“
);

104 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_DEL
,
fd
,&
“
);

106 
	}
}

108 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

109 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

110 
»tv®
, 
numev’ts
 = 0;

112 
»tv®
 = 
	`•Şl_wa™
(
¡©e
->
•fd
,¡©e->
ev’ts
,
ev’tLoİ
->
£tsize
,

113 
tvp
 ? (tvp->
tv_£c
*1000 +vp->
tv_u£c
/1000) : -1);

114 ià(
»tv®
 > 0) {

115 
j
;

117 
numev’ts
 = 
»tv®
;

118 
j
 = 0; j < 
numev’ts
; j++) {

119 
mask
 = 0;

120 
•Şl_ev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

122 ià(
e
->
ev’ts
 & 
EPOLLIN
è
mask
 |ğ
AE_READABLE
;

123 ià(
e
->
ev’ts
 & 
EPOLLOUT
è
mask
 |ğ
AE_WRITABLE
;

124 ià(
e
->
ev’ts
 & 
EPOLLERR
è
mask
 |ğ
AE_WRITABLE
;

125 ià(
e
->
ev’ts
 & 
EPOLLHUP
è
mask
 |ğ
AE_WRITABLE
;

126 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
d©a
.fd;

127 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

130  
numev’ts
;

131 
	}
}

133 *
	$«ApiName
() {

135 
	}
}

	@dep/ae/ae_epoll.c

32 
	~<sys/•Şl.h
>

34 
	s«ApiS‹
 {

35 
	m•fd
;

36 
•Şl_ev’t
 *
	mev’ts
;

37 } 
	t«ApiS‹
;

39 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

40 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

42 ià(!
¡©e
)  -1;

43 
¡©e
->
ev’ts
 = 
	`d®loc
((
•Şl_ev’t
)*
ev’tLoİ
->
£tsize
);

44 ià(!
¡©e
->
ev’ts
) {

45 
	`dä“
(
¡©e
);

48 
¡©e
->
•fd
 = 
	`•Şl_ü—‹
(1024);

49 ià(
¡©e
->
•fd
 == -1) {

50 
	`dä“
(
¡©e
->
ev’ts
);

51 
	`dä“
(
¡©e
);

54 
ev’tLoİ
->
­id©a
 = 
¡©e
;

56 
	}
}

58 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

59 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

61 
¡©e
->
ev’ts
 = 
	`d»®loc
(¡©e->ev’ts, (
•Şl_ev’t
)*
£tsize
);

63 
	}
}

65 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

66 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

68 
	`şo£
(
¡©e
->
•fd
);

69 
	`dä“
(
¡©e
->
ev’ts
);

70 
	`dä“
(
¡©e
);

71 
	}
}

73 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

74 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

75 
•Şl_ev’t
 
“
 = {0};

78 
İ
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
 =ğ
AE_NONE
 ?

79 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
;

81 
“
.
ev’ts
 = 0;

82 
mask
 |ğ
ev’tLoİ
->
ev’ts
[
fd
].mask;

83 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

84 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

85 
“
.
d©a
.
fd
 = fd;

86 ià(
	`•Şl_ùl
(
¡©e
->
•fd
,
İ
,
fd
,&
“
) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
d–mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
•Şl_ev’t
 
“
 = {0};

93 
mask
 = 
ev’tLoİ
->
ev’ts
[
fd
].mask & (~
d–mask
);

95 
“
.
ev’ts
 = 0;

96 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

97 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

98 
“
.
d©a
.
fd
 = fd;

99 ià(
mask
 !ğ
AE_NONE
) {

100 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_MOD
,
fd
,&
“
);

104 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_DEL
,
fd
,&
“
);

106 
	}
}

108 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

109 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

110 
»tv®
, 
numev’ts
 = 0;

112 
»tv®
 = 
	`•Şl_wa™
(
¡©e
->
•fd
,¡©e->
ev’ts
,
ev’tLoİ
->
£tsize
,

113 
tvp
 ? (tvp->
tv_£c
*1000 +vp->
tv_u£c
/1000) : -1);

114 ià(
»tv®
 > 0) {

115 
j
;

117 
numev’ts
 = 
»tv®
;

118 
j
 = 0; j < 
numev’ts
; j++) {

119 
mask
 = 0;

120 
•Şl_ev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

122 ià(
e
->
ev’ts
 & 
EPOLLIN
è
mask
 |ğ
AE_READABLE
;

123 ià(
e
->
ev’ts
 & 
EPOLLOUT
è
mask
 |ğ
AE_WRITABLE
;

124 ià(
e
->
ev’ts
 & 
EPOLLERR
è
mask
 |ğ
AE_WRITABLE
;

125 ià(
e
->
ev’ts
 & 
EPOLLHUP
è
mask
 |ğ
AE_WRITABLE
;

126 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
d©a
.fd;

127 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

130  
numev’ts
;

131 
	}
}

133 *
	$«ApiName
() {

135 
	}
}

	@dep/ae/ae_evport.c

31 
	~<as£¹.h
>

32 
	~<”ºo.h
>

33 
	~<pÜt.h
>

34 
	~<pŞl.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

39 
	~<¡dio.h
>

41 
	gevpÜt_debug
 = 0;

66 
	#MAX_EVENT_BATCHSZ
 512

	)

68 
	s«ApiS‹
 {

69 
	mpÜtfd
;

70 
	mÅ’dšg
;

71 
	m³ndšg_fds
[
MAX_EVENT_BATCHSZ
];

72 
	m³ndšg_masks
[
MAX_EVENT_BATCHSZ
];

73 } 
	t«ApiS‹
;

75 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

76 
i
;

77 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

78 ià(!
¡©e
)  -1;

80 
¡©e
->
pÜtfd
 = 
	`pÜt_ü—‹
();

81 ià(
¡©e
->
pÜtfd
 == -1) {

82 
	`dä“
(
¡©e
);

86 
¡©e
->
Å’dšg
 = 0;

88 
i
 = 0; i < 
MAX_EVENT_BATCHSZ
; i++) {

89 
¡©e
->
³ndšg_fds
[
i
] = -1;

90 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

93 
ev’tLoİ
->
­id©a
 = 
¡©e
;

95 
	}
}

97 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

100 
	}
}

102 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

103 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

105 
	`şo£
(
¡©e
->
pÜtfd
);

106 
	`dä“
(
¡©e
);

107 
	}
}

109 
	$«ApiLookupP’dšg
(
«ApiS‹
 *
¡©e
, 
fd
) {

110 
i
;

112 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

113 ià(
¡©e
->
³ndšg_fds
[
i
] =ğ
fd
)

114  (
i
);

118 
	}
}

123 
	$«ApiAssocŸ‹
(cÚ¡ *
wh”e
, 
pÜtfd
, 
fd
, 
mask
) {

124 
ev’ts
 = 0;

125 
rv
, 
”r
;

127 ià(
mask
 & 
AE_READABLE
)

128 
ev’ts
 |ğ
POLLIN
;

129 ià(
mask
 & 
AE_WRITABLE
)

130 
ev’ts
 |ğ
POLLOUT
;

132 ià(
evpÜt_debug
)

133 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹(%d, 0x%xèğ", 
wh”e
, 
fd
, 
ev’ts
);

135 
rv
 = 
	`pÜt_assocŸ‹
(
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
, 
ev’ts
,

136 (*)(
ušŒ_t
)
mask
);

137 
”r
 = 
”ºo
;

139 ià(
evpÜt_debug
)

140 
	`årštf
(
¡d”r
, "%d (%s)\n", 
rv
,„v =ğ0 ? "nØ”rÜ" : 
	`¡»¼Ü
(
”r
));

142 ià(
rv
 == -1) {

143 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹: %s\n", 
wh”e
, 
	`¡»¼Ü
(
”r
));

145 ià(
”r
 =ğ
EAGAIN
)

146 
	`årštf
(
¡d”r
, "aeApiAssociate:ƒvent…ort†imitƒxceeded.");

149  
rv
;

150 
	}
}

152 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

153 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

154 
fuÎmask
, 
pfd
;

156 ià(
evpÜt_debug
)

157 
	`årštf
(
¡d”r
, "«ApiAddEv’t: fd %d mask 0x%x\n", 
fd
, 
mask
);

164 
fuÎmask
 = 
mask
 | 
ev’tLoİ
->
ev’ts
[
fd
].mask;

165 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

167 ià(
pfd
 != -1) {

174 ià(
evpÜt_debug
)

175 
	`årštf
(
¡d”r
, "«ApiAddEv’t:‡ddšgØ³ndšg fd %d\n", 
fd
);

176 
¡©e
->
³ndšg_masks
[
pfd
] |ğ
fuÎmask
;

180  (
	`«ApiAssocŸ‹
("«ApiAddEv’t", 
¡©e
->
pÜtfd
, 
fd
, 
fuÎmask
));

181 
	}
}

183 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

184 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

185 
fuÎmask
, 
pfd
;

187 ià(
evpÜt_debug
)

188 
	`årštf
(
¡d”r
, "d– fd %d mask 0x%x\n", 
fd
, 
mask
);

190 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

192 ià(
pfd
 != -1) {

193 ià(
evpÜt_debug
)

194 
	`årštf
(
¡d”r
, "d–‘šgƒv’ˆäom…’dšg fd %d\n", 
fd
);

201 
¡©e
->
³ndšg_masks
[
pfd
] &ğ~
mask
;

203 ià(
¡©e
->
³ndšg_masks
[
pfd
] =ğ
AE_NONE
)

204 
¡©e
->
³ndšg_fds
[
pfd
] = -1;

217 
fuÎmask
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
;

218 ià(
fuÎmask
 =ğ
AE_NONE
) {

223 ià(
evpÜt_debug
)

224 
	`årštf
(
¡d”r
, "«ApiD–Ev’t:…Üt_dissocŸ‹(%d)\n", 
fd
);

226 ià(
	`pÜt_dissocŸ‹
(
¡©e
->
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
) != 0) {

227 
	`³¼Ü
("aeApiDelEvent:…ort_dissociate");

228 
	`abÜt
();

230 } ià(
	`«ApiAssocŸ‹
("«ApiD–Ev’t", 
¡©e
->
pÜtfd
, 
fd
,

231 
fuÎmask
) != 0) {

239 
	`abÜt
();

241 
	}
}

243 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

244 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

245 
time¥ec
 
timeout
, *
t¥
;

246 
mask
, 
i
;

247 
ušt_t
 
Ãv’ts
;

248 
pÜt_ev’t_t
 
ev’t
[
MAX_EVENT_BATCHSZ
];

255 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

256 ià(
¡©e
->
³ndšg_fds
[
i
] == -1)

260 ià(
	`«ApiAssocŸ‹
("«ApiPŞl", 
¡©e
->
pÜtfd
,

261 
¡©e
->
³ndšg_fds
[
i
], s‹->
³ndšg_masks
[i]) != 0) {

263 
	`abÜt
();

266 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

267 
¡©e
->
³ndšg_fds
[
i
] = -1;

270 
¡©e
->
Å’dšg
 = 0;

272 ià(
tvp
 !ğ
NULL
) {

273 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

274 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

275 
t¥
 = &
timeout
;

277 
t¥
 = 
NULL
;

284 
Ãv’ts
 = 1;

285 ià(
	`pÜt_g‘n
(
¡©e
->
pÜtfd
, 
ev’t
, 
MAX_EVENT_BATCHSZ
, &
Ãv’ts
,

286 
t¥
è=ğ-1 && (
”ºo
 !ğ
ETIME
 || 
Ãv’ts
 == 0)) {

287 ià(
”ºo
 =ğ
ETIME
 ||ƒ¼nØ=ğ
EINTR
)

291 
	`³¼Ü
("aeApiPoll:…ort_get");

292 
	`abÜt
();

295 
¡©e
->
Å’dšg
 = 
Ãv’ts
;

297 
i
 = 0; i < 
Ãv’ts
; i++) {

298 
mask
 = 0;

299 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLIN
)

300 
mask
 |ğ
AE_READABLE
;

301 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLOUT
)

302 
mask
 |ğ
AE_WRITABLE
;

304 
ev’tLoİ
->
fœed
[
i
].
fd
 = 
ev’t
[i].
pÜ‹v_objeù
;

305 
ev’tLoİ
->
fœed
[
i
].
mask
 = mask;

307 ià(
evpÜt_debug
)

308 
	`årštf
(
¡d”r
, "aeApiPoll: fd %d mask 0x%x\n",

309 ()
ev’t
[
i
].
pÜ‹v_objeù
, 
mask
);

311 
¡©e
->
³ndšg_fds
[
i
] = 
ev’t
[i].
pÜ‹v_objeù
;

312 
¡©e
->
³ndšg_masks
[
i
] = (
ušŒ_t
)
ev’t
[i].
pÜ‹v_u£r
;

315  
Ãv’ts
;

316 
	}
}

318 *
	$«ApiName
() {

320 
	}
}

	@dep/ae/ae_evport.c

31 
	~<as£¹.h
>

32 
	~<”ºo.h
>

33 
	~<pÜt.h
>

34 
	~<pŞl.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

39 
	~<¡dio.h
>

41 
	gevpÜt_debug
 = 0;

66 
	#MAX_EVENT_BATCHSZ
 512

	)

68 
	s«ApiS‹
 {

69 
	mpÜtfd
;

70 
	mÅ’dšg
;

71 
	m³ndšg_fds
[
MAX_EVENT_BATCHSZ
];

72 
	m³ndšg_masks
[
MAX_EVENT_BATCHSZ
];

73 } 
	t«ApiS‹
;

75 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

76 
i
;

77 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

78 ià(!
¡©e
)  -1;

80 
¡©e
->
pÜtfd
 = 
	`pÜt_ü—‹
();

81 ià(
¡©e
->
pÜtfd
 == -1) {

82 
	`dä“
(
¡©e
);

86 
¡©e
->
Å’dšg
 = 0;

88 
i
 = 0; i < 
MAX_EVENT_BATCHSZ
; i++) {

89 
¡©e
->
³ndšg_fds
[
i
] = -1;

90 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

93 
ev’tLoİ
->
­id©a
 = 
¡©e
;

95 
	}
}

97 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

100 
	}
}

102 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

103 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

105 
	`şo£
(
¡©e
->
pÜtfd
);

106 
	`dä“
(
¡©e
);

107 
	}
}

109 
	$«ApiLookupP’dšg
(
«ApiS‹
 *
¡©e
, 
fd
) {

110 
i
;

112 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

113 ià(
¡©e
->
³ndšg_fds
[
i
] =ğ
fd
)

114  (
i
);

118 
	}
}

123 
	$«ApiAssocŸ‹
(cÚ¡ *
wh”e
, 
pÜtfd
, 
fd
, 
mask
) {

124 
ev’ts
 = 0;

125 
rv
, 
”r
;

127 ià(
mask
 & 
AE_READABLE
)

128 
ev’ts
 |ğ
POLLIN
;

129 ià(
mask
 & 
AE_WRITABLE
)

130 
ev’ts
 |ğ
POLLOUT
;

132 ià(
evpÜt_debug
)

133 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹(%d, 0x%xèğ", 
wh”e
, 
fd
, 
ev’ts
);

135 
rv
 = 
	`pÜt_assocŸ‹
(
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
, 
ev’ts
,

136 (*)(
ušŒ_t
)
mask
);

137 
”r
 = 
”ºo
;

139 ià(
evpÜt_debug
)

140 
	`årštf
(
¡d”r
, "%d (%s)\n", 
rv
,„v =ğ0 ? "nØ”rÜ" : 
	`¡»¼Ü
(
”r
));

142 ià(
rv
 == -1) {

143 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹: %s\n", 
wh”e
, 
	`¡»¼Ü
(
”r
));

145 ià(
”r
 =ğ
EAGAIN
)

146 
	`årštf
(
¡d”r
, "aeApiAssociate:ƒvent…ort†imitƒxceeded.");

149  
rv
;

150 
	}
}

152 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

153 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

154 
fuÎmask
, 
pfd
;

156 ià(
evpÜt_debug
)

157 
	`årštf
(
¡d”r
, "«ApiAddEv’t: fd %d mask 0x%x\n", 
fd
, 
mask
);

164 
fuÎmask
 = 
mask
 | 
ev’tLoİ
->
ev’ts
[
fd
].mask;

165 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

167 ià(
pfd
 != -1) {

174 ià(
evpÜt_debug
)

175 
	`årštf
(
¡d”r
, "«ApiAddEv’t:‡ddšgØ³ndšg fd %d\n", 
fd
);

176 
¡©e
->
³ndšg_masks
[
pfd
] |ğ
fuÎmask
;

180  (
	`«ApiAssocŸ‹
("«ApiAddEv’t", 
¡©e
->
pÜtfd
, 
fd
, 
fuÎmask
));

181 
	}
}

183 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

184 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

185 
fuÎmask
, 
pfd
;

187 ià(
evpÜt_debug
)

188 
	`årštf
(
¡d”r
, "d– fd %d mask 0x%x\n", 
fd
, 
mask
);

190 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

192 ià(
pfd
 != -1) {

193 ià(
evpÜt_debug
)

194 
	`årštf
(
¡d”r
, "d–‘šgƒv’ˆäom…’dšg fd %d\n", 
fd
);

201 
¡©e
->
³ndšg_masks
[
pfd
] &ğ~
mask
;

203 ià(
¡©e
->
³ndšg_masks
[
pfd
] =ğ
AE_NONE
)

204 
¡©e
->
³ndšg_fds
[
pfd
] = -1;

217 
fuÎmask
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
;

218 ià(
fuÎmask
 =ğ
AE_NONE
) {

223 ià(
evpÜt_debug
)

224 
	`årštf
(
¡d”r
, "«ApiD–Ev’t:…Üt_dissocŸ‹(%d)\n", 
fd
);

226 ià(
	`pÜt_dissocŸ‹
(
¡©e
->
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
) != 0) {

227 
	`³¼Ü
("aeApiDelEvent:…ort_dissociate");

228 
	`abÜt
();

230 } ià(
	`«ApiAssocŸ‹
("«ApiD–Ev’t", 
¡©e
->
pÜtfd
, 
fd
,

231 
fuÎmask
) != 0) {

239 
	`abÜt
();

241 
	}
}

243 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

244 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

245 
time¥ec
 
timeout
, *
t¥
;

246 
mask
, 
i
;

247 
ušt_t
 
Ãv’ts
;

248 
pÜt_ev’t_t
 
ev’t
[
MAX_EVENT_BATCHSZ
];

255 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

256 ià(
¡©e
->
³ndšg_fds
[
i
] == -1)

260 ià(
	`«ApiAssocŸ‹
("«ApiPŞl", 
¡©e
->
pÜtfd
,

261 
¡©e
->
³ndšg_fds
[
i
], s‹->
³ndšg_masks
[i]) != 0) {

263 
	`abÜt
();

266 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

267 
¡©e
->
³ndšg_fds
[
i
] = -1;

270 
¡©e
->
Å’dšg
 = 0;

272 ià(
tvp
 !ğ
NULL
) {

273 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

274 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

275 
t¥
 = &
timeout
;

277 
t¥
 = 
NULL
;

284 
Ãv’ts
 = 1;

285 ià(
	`pÜt_g‘n
(
¡©e
->
pÜtfd
, 
ev’t
, 
MAX_EVENT_BATCHSZ
, &
Ãv’ts
,

286 
t¥
è=ğ-1 && (
”ºo
 !ğ
ETIME
 || 
Ãv’ts
 == 0)) {

287 ià(
”ºo
 =ğ
ETIME
 ||ƒ¼nØ=ğ
EINTR
)

291 
	`³¼Ü
("aeApiPoll:…ort_get");

292 
	`abÜt
();

295 
¡©e
->
Å’dšg
 = 
Ãv’ts
;

297 
i
 = 0; i < 
Ãv’ts
; i++) {

298 
mask
 = 0;

299 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLIN
)

300 
mask
 |ğ
AE_READABLE
;

301 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLOUT
)

302 
mask
 |ğ
AE_WRITABLE
;

304 
ev’tLoİ
->
fœed
[
i
].
fd
 = 
ev’t
[i].
pÜ‹v_objeù
;

305 
ev’tLoİ
->
fœed
[
i
].
mask
 = mask;

307 ià(
evpÜt_debug
)

308 
	`årštf
(
¡d”r
, "aeApiPoll: fd %d mask 0x%x\n",

309 ()
ev’t
[
i
].
pÜ‹v_objeù
, 
mask
);

311 
¡©e
->
³ndšg_fds
[
i
] = 
ev’t
[i].
pÜ‹v_objeù
;

312 
¡©e
->
³ndšg_masks
[
i
] = (
ušŒ_t
)
ev’t
[i].
pÜ‹v_u£r
;

315  
Ãv’ts
;

316 
	}
}

318 *
	$«ApiName
() {

320 
	}
}

	@dep/ae/ae_kqueue.c

32 
	~<sys/ty³s.h
>

33 
	~<sys/ev’t.h
>

34 
	~<sys/time.h
>

36 
	s«ApiS‹
 {

37 
	mkqfd
;

38 
kev’t
 *
	mev’ts
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
¡©e
->
ev’ts
 = 
	`d®loc
((
kev’t
)*
ev’tLoİ
->
£tsize
);

46 ià(!
¡©e
->
ev’ts
) {

47 
	`dä“
(
¡©e
);

50 
¡©e
->
kqfd
 = 
	`kqueue
();

51 ià(
¡©e
->
kqfd
 == -1) {

52 
	`dä“
(
¡©e
->
ev’ts
);

53 
	`dä“
(
¡©e
);

56 
ev’tLoİ
->
­id©a
 = 
¡©e
;

58 
	}
}

60 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

61 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

63 
¡©e
->
ev’ts
 = 
	`d»®loc
(¡©e->ev’ts, (
kev’t
)*
£tsize
);

65 
	}
}

67 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

68 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

70 
	`şo£
(
¡©e
->
kqfd
);

71 
	`dä“
(
¡©e
->
ev’ts
);

72 
	`dä“
(
¡©e
);

73 
	}
}

75 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

76 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

77 
kev’t
 
ke
;

79 ià(
mask
 & 
AE_READABLE
) {

80 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_ADD
, 0, 0, 
NULL
);

81 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

83 ià(
mask
 & 
AE_WRITABLE
) {

84 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_ADD
, 0, 0, 
NULL
);

85 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
kev’t
 
ke
;

94 ià(
mask
 & 
AE_READABLE
) {

95 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

96 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

98 ià(
mask
 & 
AE_WRITABLE
) {

99 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

100 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

102 
	}
}

104 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

105 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

106 
»tv®
, 
numev’ts
 = 0;

108 ià(
tvp
 !ğ
NULL
) {

109 
time¥ec
 
timeout
;

110 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

111 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

112 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

113 &
timeout
);

115 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

116 
NULL
);

119 ià(
»tv®
 > 0) {

120 
j
;

122 
numev’ts
 = 
»tv®
;

123 
j
 = 0; j < 
numev’ts
; j++) {

124 
mask
 = 0;

125 
kev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

127 ià(
e
->
f‹r
 =ğ
EVFILT_READ
è
mask
 |ğ
AE_READABLE
;

128 ià(
e
->
f‹r
 =ğ
EVFILT_WRITE
è
mask
 |ğ
AE_WRITABLE
;

129 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
id’t
;

130 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

133  
numev’ts
;

134 
	}
}

136 *
	$«ApiName
() {

138 
	}
}

	@dep/ae/ae_kqueue.c

32 
	~<sys/ty³s.h
>

33 
	~<sys/ev’t.h
>

34 
	~<sys/time.h
>

36 
	s«ApiS‹
 {

37 
	mkqfd
;

38 
kev’t
 *
	mev’ts
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
¡©e
->
ev’ts
 = 
	`d®loc
((
kev’t
)*
ev’tLoİ
->
£tsize
);

46 ià(!
¡©e
->
ev’ts
) {

47 
	`dä“
(
¡©e
);

50 
¡©e
->
kqfd
 = 
	`kqueue
();

51 ià(
¡©e
->
kqfd
 == -1) {

52 
	`dä“
(
¡©e
->
ev’ts
);

53 
	`dä“
(
¡©e
);

56 
ev’tLoİ
->
­id©a
 = 
¡©e
;

58 
	}
}

60 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

61 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

63 
¡©e
->
ev’ts
 = 
	`d»®loc
(¡©e->ev’ts, (
kev’t
)*
£tsize
);

65 
	}
}

67 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

68 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

70 
	`şo£
(
¡©e
->
kqfd
);

71 
	`dä“
(
¡©e
->
ev’ts
);

72 
	`dä“
(
¡©e
);

73 
	}
}

75 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

76 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

77 
kev’t
 
ke
;

79 ià(
mask
 & 
AE_READABLE
) {

80 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_ADD
, 0, 0, 
NULL
);

81 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

83 ià(
mask
 & 
AE_WRITABLE
) {

84 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_ADD
, 0, 0, 
NULL
);

85 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
kev’t
 
ke
;

94 ià(
mask
 & 
AE_READABLE
) {

95 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

96 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

98 ià(
mask
 & 
AE_WRITABLE
) {

99 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

100 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

102 
	}
}

104 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

105 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

106 
»tv®
, 
numev’ts
 = 0;

108 ià(
tvp
 !ğ
NULL
) {

109 
time¥ec
 
timeout
;

110 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

111 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

112 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

113 &
timeout
);

115 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

116 
NULL
);

119 ià(
»tv®
 > 0) {

120 
j
;

122 
numev’ts
 = 
»tv®
;

123 
j
 = 0; j < 
numev’ts
; j++) {

124 
mask
 = 0;

125 
kev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

127 ià(
e
->
f‹r
 =ğ
EVFILT_READ
è
mask
 |ğ
AE_READABLE
;

128 ià(
e
->
f‹r
 =ğ
EVFILT_WRITE
è
mask
 |ğ
AE_WRITABLE
;

129 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
id’t
;

130 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

133  
numev’ts
;

134 
	}
}

136 *
	$«ApiName
() {

138 
	}
}

	@dep/ae/ae_select.c

32 
	~<¡ršg.h
>

34 
	s«ApiS‹
 {

35 
fd_£t
 
	mrfds
, 
	mwfds
;

38 
fd_£t
 
	m_rfds
, 
	m_wfds
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
	`FD_ZERO
(&
¡©e
->
rfds
);

46 
	`FD_ZERO
(&
¡©e
->
wfds
);

47 
ev’tLoİ
->
­id©a
 = 
¡©e
;

49 
	}
}

51 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

53 ià(
£tsize
 >ğ
FD_SETSIZE
)  -1;

55 
	}
}

57 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

58 
	`dä“
(
ev’tLoİ
->
­id©a
);

59 
	}
}

61 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

62 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

64 ià(
mask
 & 
AE_READABLE
è
	`FD_SET
(
fd
,&
¡©e
->
rfds
);

65 ià(
mask
 & 
AE_WRITABLE
è
	`FD_SET
(
fd
,&
¡©e
->
wfds
);

67 
	}
}

69 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

70 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

72 ià(
mask
 & 
AE_READABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
rfds
);

73 ià(
mask
 & 
AE_WRITABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
wfds
);

74 
	}
}

76 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

77 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

78 
»tv®
, 
j
, 
numev’ts
 = 0;

80 
	`memıy
(&
¡©e
->
_rfds
,&¡©e->
rfds
,(
fd_£t
));

81 
	`memıy
(&
¡©e
->
_wfds
,&¡©e->
wfds
,(
fd_£t
));

83 
»tv®
 = 
	`£Ëù
(
ev’tLoİ
->
maxfd
+1,

84 &
¡©e
->
_rfds
,&¡©e->
_wfds
,
NULL
,
tvp
);

85 ià(
»tv®
 > 0) {

86 
j
 = 0; j <ğ
ev’tLoİ
->
maxfd
; j++) {

87 
mask
 = 0;

88 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
j
];

90 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

91 ià(
ã
->
mask
 & 
AE_READABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_rfds
))

92 
mask
 |ğ
AE_READABLE
;

93 ià(
ã
->
mask
 & 
AE_WRITABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_wfds
))

94 
mask
 |ğ
AE_WRITABLE
;

95 
ev’tLoİ
->
fœed
[
numev’ts
].
fd
 = 
j
;

96 
ev’tLoİ
->
fœed
[
numev’ts
].
mask
 = mask;

97 
numev’ts
++;

100  
numev’ts
;

101 
	}
}

103 *
	$«ApiName
() {

105 
	}
}

	@dep/ae/ae_select.c

32 
	~<¡ršg.h
>

34 
	s«ApiS‹
 {

35 
fd_£t
 
	mrfds
, 
	mwfds
;

38 
fd_£t
 
	m_rfds
, 
	m_wfds
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`d®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
	`FD_ZERO
(&
¡©e
->
rfds
);

46 
	`FD_ZERO
(&
¡©e
->
wfds
);

47 
ev’tLoİ
->
­id©a
 = 
¡©e
;

49 
	}
}

51 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

53 ià(
£tsize
 >ğ
FD_SETSIZE
)  -1;

55 
	}
}

57 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

58 
	`dä“
(
ev’tLoİ
->
­id©a
);

59 
	}
}

61 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

62 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

64 ià(
mask
 & 
AE_READABLE
è
	`FD_SET
(
fd
,&
¡©e
->
rfds
);

65 ià(
mask
 & 
AE_WRITABLE
è
	`FD_SET
(
fd
,&
¡©e
->
wfds
);

67 
	}
}

69 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

70 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

72 ià(
mask
 & 
AE_READABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
rfds
);

73 ià(
mask
 & 
AE_WRITABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
wfds
);

74 
	}
}

76 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

77 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

78 
»tv®
, 
j
, 
numev’ts
 = 0;

80 
	`memıy
(&
¡©e
->
_rfds
,&¡©e->
rfds
,(
fd_£t
));

81 
	`memıy
(&
¡©e
->
_wfds
,&¡©e->
wfds
,(
fd_£t
));

83 
»tv®
 = 
	`£Ëù
(
ev’tLoİ
->
maxfd
+1,

84 &
¡©e
->
_rfds
,&¡©e->
_wfds
,
NULL
,
tvp
);

85 ià(
»tv®
 > 0) {

86 
j
 = 0; j <ğ
ev’tLoİ
->
maxfd
; j++) {

87 
mask
 = 0;

88 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
j
];

90 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

91 ià(
ã
->
mask
 & 
AE_READABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_rfds
))

92 
mask
 |ğ
AE_READABLE
;

93 ià(
ã
->
mask
 & 
AE_WRITABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_wfds
))

94 
mask
 |ğ
AE_WRITABLE
;

95 
ev’tLoİ
->
fœed
[
numev’ts
].
fd
 = 
j
;

96 
ev’tLoİ
->
fœed
[
numev’ts
].
mask
 = mask;

97 
numev’ts
++;

100  
numev’ts
;

101 
	}
}

103 *
	$«ApiName
() {

105 
	}
}

	@dep/darray/darray.c

1 
	~<¡dlib.h
>

3 
	~<dm®loc.h
>

5 
	~<d¬¿y.h
>

8 
d¬¿y
 *

9 
	$d¬¿y_ü—‹
(
n
, 
size_t
 
size
)

11 
d¬¿y
 *
a
;

13 
a
 = 
	`d®loc
((*a));

14 ià(
a
 =ğ
NULL
) {

15  
NULL
;

18 
a
->
–em
 = 
	`d®loc
(
n
 * 
size
);

19 ià(
a
->
–em
 =ğ
NULL
) {

20 
	`dä“
(
a
);

21  
NULL
;

24 
a
->
ÃËm
 = 0;

25 
a
->
size
 = size;

26 
a
->
ÇÎoc
 = 
n
;

28  
a
;

29 
	}
}

32 
	$d¬¿y_de¡roy
(
d¬¿y
 *
a
)

34 
	`d¬¿y_deš™
(
a
);

35 
	`dä“
(
a
);

36 
	}
}

40 
	$d¬¿y_š™
(
d¬¿y
 *
a
, 
n
, 
size_t
 
size
)

42 
a
->
–em
 = 
	`d®loc
(
n
 * 
size
);

43 ià(
a
->
–em
 =ğ
NULL
) {

47 
a
->
ÃËm
 = 0;

48 
a
->
size
 = size;

49 
a
->
ÇÎoc
 = 
n
;

52 
	}
}

56 
	$d¬¿y_deš™
(
d¬¿y
 *
a
)

58 ià(
a
->
–em
 !ğ
NULL
) {

59 
	`dä“
(
a
->
–em
);

61 
	}
}

65 
	$d¬¿y_idx
(
d¬¿y
 *
a
, *
–em
)

67 *
p
, *
q
;

68 
off
, 
idx
;

70 
p
 = 
a
->
–em
;

71 
q
 = 
–em
;

73 
off
 = ()(
q
 - 
p
);

75 
idx
 = 
off
 / ()
a
->
size
;

77  
idx
;

78 
	}
}

81 
	$d¬¿y_push
(
d¬¿y
 *
a
)

83 *
–em
, *
Ãw
;

84 
size_t
 
size
;

86 ià(
a
->
ÃËm
 =ğa->
ÇÎoc
) {

89 
size
 = 
a
->siz*‡->
ÇÎoc
;

90 
Ãw
 = 
	`d»®loc
(
a
->
–em
, 2 * 
size
);

91 ià(
Ãw
 =ğ
NULL
) {

92  
NULL
;

95 
a
->
–em
 = 
Ãw
;

96 
a
->
ÇÎoc
 *= 2;

99 
–em
 = (*)
a
->–em +‡->
size
 *‡->
ÃËm
;

100 
a
->
ÃËm
++;

102  
–em
;

103 
	}
}

106 
	$d¬¿y_pİ
(
d¬¿y
 *
a
)

108 *
–em
;

110 
a
->
ÃËm
--;

111 
–em
 = (*)
a
->–em +‡->
size
 *‡->
ÃËm
;

113  
–em
;

114 
	}
}

118 
	$d¬¿y_g‘
(
d¬¿y
 *
a
, 
idx
)

120 *
–em
;

122 
–em
 = (*)
a
->–em + (a->
size
 * 
idx
);

124  
–em
;

125 
	}
}

128 
	$d¬¿y_tİ
(
d¬¿y
 *
a
)

130  
	`d¬¿y_g‘
(
a
,‡->
ÃËm
 - 1);

131 
	}
}

134 
	$d¬¿y_sw­
(
d¬¿y
 *
a
, d¬¿y *
b
)

136 
d¬¿y
 
tmp
;

138 
tmp
 = *
a
;

139 *
a
 = *
b
;

140 *
b
 = 
tmp
;

141 
	}
}

148 
	$d¬¿y_sÜt
(
d¬¿y
 *
a
, 
d¬¿y_com·»_t
 
com·»
)

150 
	`qsÜt
(
a
->
–em
,‡->
ÃËm
,‡->
size
, 
com·»
);

151 
	}
}

159 
	$d¬¿y_—ch
(
d¬¿y
 *
a
, 
d¬¿y_—ch_t
 
func
, *
d©a
)

161 
i
, 
ÃËm
;

163 
i
 = 0, 
ÃËm
 = 
	`d¬¿y_n
(
a
); i <‚elem; i++) {

164 *
–em
 = 
	`d¬¿y_g‘
(
a
, 
i
);

165 
»t
;

167 
»t
 = 
	`func
(
–em
, 
d©a
);

168 ià(
»t
 != 0) {

174 
	}
}

	@dep/darray/darray.c

1 
	~<¡dlib.h
>

3 
	~<dm®loc.h
>

5 
	~<d¬¿y.h
>

8 
d¬¿y
 *

9 
	$d¬¿y_ü—‹
(
n
, 
size_t
 
size
)

11 
d¬¿y
 *
a
;

13 
a
 = 
	`d®loc
((*a));

14 ià(
a
 =ğ
NULL
) {

15  
NULL
;

18 
a
->
–em
 = 
	`d®loc
(
n
 * 
size
);

19 ià(
a
->
–em
 =ğ
NULL
) {

20 
	`dä“
(
a
);

21  
NULL
;

24 
a
->
ÃËm
 = 0;

25 
a
->
size
 = size;

26 
a
->
ÇÎoc
 = 
n
;

28  
a
;

29 
	}
}

32 
	$d¬¿y_de¡roy
(
d¬¿y
 *
a
)

34 
	`d¬¿y_deš™
(
a
);

35 
	`dä“
(
a
);

36 
	}
}

40 
	$d¬¿y_š™
(
d¬¿y
 *
a
, 
n
, 
size_t
 
size
)

42 
a
->
–em
 = 
	`d®loc
(
n
 * 
size
);

43 ià(
a
->
–em
 =ğ
NULL
) {

47 
a
->
ÃËm
 = 0;

48 
a
->
size
 = size;

49 
a
->
ÇÎoc
 = 
n
;

52 
	}
}

56 
	$d¬¿y_deš™
(
d¬¿y
 *
a
)

58 ià(
a
->
–em
 !ğ
NULL
) {

59 
	`dä“
(
a
->
–em
);

61 
	}
}

65 
	$d¬¿y_idx
(
d¬¿y
 *
a
, *
–em
)

67 *
p
, *
q
;

68 
off
, 
idx
;

70 
p
 = 
a
->
–em
;

71 
q
 = 
–em
;

73 
off
 = ()(
q
 - 
p
);

75 
idx
 = 
off
 / ()
a
->
size
;

77  
idx
;

78 
	}
}

81 
	$d¬¿y_push
(
d¬¿y
 *
a
)

83 *
–em
, *
Ãw
;

84 
size_t
 
size
;

86 ià(
a
->
ÃËm
 =ğa->
ÇÎoc
) {

89 
size
 = 
a
->siz*‡->
ÇÎoc
;

90 
Ãw
 = 
	`d»®loc
(
a
->
–em
, 2 * 
size
);

91 ià(
Ãw
 =ğ
NULL
) {

92  
NULL
;

95 
a
->
–em
 = 
Ãw
;

96 
a
->
ÇÎoc
 *= 2;

99 
–em
 = (*)
a
->–em +‡->
size
 *‡->
ÃËm
;

100 
a
->
ÃËm
++;

102  
–em
;

103 
	}
}

106 
	$d¬¿y_pİ
(
d¬¿y
 *
a
)

108 *
–em
;

110 
a
->
ÃËm
--;

111 
–em
 = (*)
a
->–em +‡->
size
 *‡->
ÃËm
;

113  
–em
;

114 
	}
}

118 
	$d¬¿y_g‘
(
d¬¿y
 *
a
, 
idx
)

120 *
–em
;

122 
–em
 = (*)
a
->–em + (a->
size
 * 
idx
);

124  
–em
;

125 
	}
}

128 
	$d¬¿y_tİ
(
d¬¿y
 *
a
)

130  
	`d¬¿y_g‘
(
a
,‡->
ÃËm
 - 1);

131 
	}
}

134 
	$d¬¿y_sw­
(
d¬¿y
 *
a
, d¬¿y *
b
)

136 
d¬¿y
 
tmp
;

138 
tmp
 = *
a
;

139 *
a
 = *
b
;

140 *
b
 = 
tmp
;

141 
	}
}

148 
	$d¬¿y_sÜt
(
d¬¿y
 *
a
, 
d¬¿y_com·»_t
 
com·»
)

150 
	`qsÜt
(
a
->
–em
,‡->
ÃËm
,‡->
size
, 
com·»
);

151 
	}
}

159 
	$d¬¿y_—ch
(
d¬¿y
 *
a
, 
d¬¿y_—ch_t
 
func
, *
d©a
)

161 
i
, 
ÃËm
;

163 
i
 = 0, 
ÃËm
 = 
	`d¬¿y_n
(
a
); i <‚elem; i++) {

164 *
–em
 = 
	`d¬¿y_g‘
(
a
, 
i
);

165 
»t
;

167 
»t
 = 
	`func
(
–em
, 
d©a
);

168 ià(
»t
 != 0) {

174 
	}
}

	@dep/darray/darray.h

1 #iâdeà
_DARRAY_H_


2 
	#_DARRAY_H_


	)

4 (*
	td¬¿y_com·»_t
)(const *, const *);

5 (*
	td¬¿y_—ch_t
)(*, *);

7 
	sd¬¿y
 {

8 
ÃËm
;

9 *
–em
;

10 
size_t
 
size
;

11 
ÇÎoc
;

12 } 
	td¬¿y
;

14 
	#nuÎ_d¬¿y
 { 0, 
NULL
, 0, 0 
	}

	)
}

17 
šlše
 

18 
	$d¬¿y_nuÎ
(
d¬¿y
 *
a
)

20 
a
->
ÃËm
 = 0;

21 
a
->
–em
 = 
NULL
;

22 
a
->
size
 = 0;

23 
a
->
ÇÎoc
 = 0;

24 
	}
}

27 
šlše
 

28 
	$d¬¿y_£t
(
d¬¿y
 *
a
, *
–em
, 
size_t
 
size
, 
ÇÎoc
)

30 
a
->
ÃËm
 = 0;

31 
a
->
–em
 =ƒlem;

32 
a
->
size
 = size;

33 
a
->
ÇÎoc
 =‚alloc;

34 
	}
}

37 
šlše
 

38 
	$d¬¿y_n
(cÚ¡ 
d¬¿y
 *
a
)

40  
a
->
ÃËm
;

41 
	}
}

43 
d¬¿y
 *
d¬¿y_ü—‹
(
n
, 
size_t
 
size
);

44 
d¬¿y_de¡roy
(
d¬¿y
 *
a
);

45 
d¬¿y_š™
(
d¬¿y
 *
a
, 
n
, 
size_t
 
size
);

46 
d¬¿y_deš™
(
d¬¿y
 *
a
);

48 
d¬¿y_idx
(
d¬¿y
 *
a
, *
–em
);

49 *
d¬¿y_push
(
d¬¿y
 *
a
);

50 *
d¬¿y_pİ
(
d¬¿y
 *
a
);

51 *
d¬¿y_g‘
(
d¬¿y
 *
a
, 
idx
);

52 *
d¬¿y_tİ
(
d¬¿y
 *
a
);

53 
d¬¿y_sw­
(
d¬¿y
 *
a
, d¬¿y *
b
);

54 
d¬¿y_sÜt
(
d¬¿y
 *
a
, 
d¬¿y_com·»_t
 
com·»
);

55 
d¬¿y_—ch
(
d¬¿y
 *
a
, 
d¬¿y_—ch_t
 
func
, *
d©a
);

	@dep/darray/darray.h

1 #iâdeà
_DARRAY_H_


2 
	#_DARRAY_H_


	)

4 (*
	td¬¿y_com·»_t
)(const *, const *);

5 (*
	td¬¿y_—ch_t
)(*, *);

7 
	sd¬¿y
 {

8 
ÃËm
;

9 *
–em
;

10 
size_t
 
size
;

11 
ÇÎoc
;

12 } 
	td¬¿y
;

14 
	#nuÎ_d¬¿y
 { 0, 
NULL
, 0, 0 
	}

	)
}

17 
šlše
 

18 
	$d¬¿y_nuÎ
(
d¬¿y
 *
a
)

20 
a
->
ÃËm
 = 0;

21 
a
->
–em
 = 
NULL
;

22 
a
->
size
 = 0;

23 
a
->
ÇÎoc
 = 0;

24 
	}
}

27 
šlše
 

28 
	$d¬¿y_£t
(
d¬¿y
 *
a
, *
–em
, 
size_t
 
size
, 
ÇÎoc
)

30 
a
->
ÃËm
 = 0;

31 
a
->
–em
 =ƒlem;

32 
a
->
size
 = size;

33 
a
->
ÇÎoc
 =‚alloc;

34 
	}
}

37 
šlše
 

38 
	$d¬¿y_n
(cÚ¡ 
d¬¿y
 *
a
)

40  
a
->
ÃËm
;

41 
	}
}

43 
d¬¿y
 *
d¬¿y_ü—‹
(
n
, 
size_t
 
size
);

44 
d¬¿y_de¡roy
(
d¬¿y
 *
a
);

45 
d¬¿y_š™
(
d¬¿y
 *
a
, 
n
, 
size_t
 
size
);

46 
d¬¿y_deš™
(
d¬¿y
 *
a
);

48 
d¬¿y_idx
(
d¬¿y
 *
a
, *
–em
);

49 *
d¬¿y_push
(
d¬¿y
 *
a
);

50 *
d¬¿y_pİ
(
d¬¿y
 *
a
);

51 *
d¬¿y_g‘
(
d¬¿y
 *
a
, 
idx
);

52 *
d¬¿y_tİ
(
d¬¿y
 *
a
);

53 
d¬¿y_sw­
(
d¬¿y
 *
a
, d¬¿y *
b
);

54 
d¬¿y_sÜt
(
d¬¿y
 *
a
, 
d¬¿y_com·»_t
 
com·»
);

55 
d¬¿y_—ch
(
d¬¿y
 *
a
, 
d¬¿y_—ch_t
 
func
, *
d©a
);

	@dep/dhashkit/dcrc16.c

1 
	~<dhashk™.h
>

3 cÚ¡ 
ušt16_t
 
	güc16b
[256] = {

38 
ušt32_t


39 
	$hash_üc16
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

41 
ušt64_t
 
x
;

42 
ušt32_t
 
üc
 = 0;

44 
x
=0; x < 
key_Ëngth
; x++) {

45 
üc
 = (üø<< 8è^ 
üc16b
[((üø>> 8è^ *
key
++) & 0x00ff];

48  
üc
;

49 
	}
}

	@dep/dhashkit/dcrc16.c

1 
	~<dhashk™.h
>

3 cÚ¡ 
ušt16_t
 
	güc16b
[256] = {

38 
ušt32_t


39 
	$hash_üc16
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

41 
ušt64_t
 
x
;

42 
ušt32_t
 
üc
 = 0;

44 
x
=0; x < 
key_Ëngth
; x++) {

45 
üc
 = (üø<< 8è^ 
üc16b
[((üø>> 8è^ *
key
++) & 0x00ff];

48  
üc
;

49 
	}
}

	@dep/dhashkit/dcrc32.c

1 
	~<dhashk™.h
>

3 cÚ¡ 
ušt32_t
 
	güc32b
[256] = {

74 
ušt32_t


75 
	$hash_üc32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

77 
ušt64_t
 
x
;

78 
ušt32_t
 
üc
 = 
UINT32_MAX
;

80 
x
 = 0; x < 
key_Ëngth
; x++) {

81 
üc
 = (üø>> 8è^ 
üc32b
[(üø^ (
ušt64_t
)
key
[
x
]) & 0xff];

84  ((~
üc
) >> 16) & 0x7fff;

85 
	}
}

87 
ušt32_t


88 
	$hash_üc32a
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

90 cÚ¡ 
ušt8_t
 *
p
 = 
key
;

91 
ušt32_t
 
üc
;

93 
üc
 = ~0U;

94 
key_Ëngth
--) {

95 
üc
 = 
üc32b
[(üø^ *
p
++) & 0xFF] ^ (crc >> 8);

98  
üc
 ^ ~0U;

99 
	}
}

	@dep/dhashkit/dcrc32.c

1 
	~<dhashk™.h
>

3 cÚ¡ 
ušt32_t
 
	güc32b
[256] = {

74 
ušt32_t


75 
	$hash_üc32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

77 
ušt64_t
 
x
;

78 
ušt32_t
 
üc
 = 
UINT32_MAX
;

80 
x
 = 0; x < 
key_Ëngth
; x++) {

81 
üc
 = (üø>> 8è^ 
üc32b
[(üø^ (
ušt64_t
)
key
[
x
]) & 0xff];

84  ((~
üc
) >> 16) & 0x7fff;

85 
	}
}

87 
ušt32_t


88 
	$hash_üc32a
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

90 cÚ¡ 
ušt8_t
 *
p
 = 
key
;

91 
ušt32_t
 
üc
;

93 
üc
 = ~0U;

94 
key_Ëngth
--) {

95 
üc
 = 
üc32b
[(üø^ *
p
++) & 0xFF] ^ (crc >> 8);

98  
üc
 ^ ~0U;

99 
	}
}

	@dep/dhashkit/dfnv.c

1 
	~<dhashk™.h
>

3 
ušt64_t
 
	gFNV_64_INIT
 = 
UINT64_C
(0xcbf29ce484222325);

4 
ušt64_t
 
	gFNV_64_PRIME
 = 
UINT64_C
(0x100000001b3);

5 
ušt32_t
 
	gFNV_32_INIT
 = 2166136261UL;

6 
ušt32_t
 
	gFNV_32_PRIME
 = 16777619;

8 
ušt32_t


9 
	$hash_âv1_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

11 
ušt64_t
 
hash
 = 
FNV_64_INIT
;

12 
size_t
 
x
;

14 
x
 = 0; x < 
key_Ëngth
; x++) {

15 
hash
 *ğ
FNV_64_PRIME
;

16 
hash
 ^ğ(
ušt64_t
)
key
[
x
];

19  (
ušt32_t
)
hash
;

20 
	}
}

22 
ušt32_t


23 
	$hash_âv1a_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

25 
ušt32_t
 
hash
 = (ušt32_tè
FNV_64_INIT
;

26 
size_t
 
x
;

28 
x
 = 0; x < 
key_Ëngth
; x++) {

29 
ušt32_t
 
v®
 = (ušt32_t)
key
[
x
];

30 
hash
 ^ğ
v®
;

31 
hash
 *ğ(
ušt32_t
è
FNV_64_PRIME
;

34  
hash
;

35 
	}
}

37 
ušt32_t


38 
	$hash_âv1_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

40 
ušt32_t
 
hash
 = 
FNV_32_INIT
;

41 
size_t
 
x
;

43 
x
 = 0; x < 
key_Ëngth
; x++) {

44 
ušt32_t
 
v®
 = (ušt32_t)
key
[
x
];

45 
hash
 *ğ
FNV_32_PRIME
;

46 
hash
 ^ğ
v®
;

49  
hash
;

50 
	}
}

52 
ušt32_t


53 
	$hash_âv1a_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

55 
ušt32_t
 
hash
 = 
FNV_32_INIT
;

56 
size_t
 
x
;

58 
x
ğ0; x < 
key_Ëngth
; x++) {

59 
ušt32_t
 
v®
 = (ušt32_t)
key
[
x
];

60 
hash
 ^ğ
v®
;

61 
hash
 *ğ
FNV_32_PRIME
;

64  
hash
;

65 
	}
}

	@dep/dhashkit/dfnv.c

1 
	~<dhashk™.h
>

3 
ušt64_t
 
	gFNV_64_INIT
 = 
UINT64_C
(0xcbf29ce484222325);

4 
ušt64_t
 
	gFNV_64_PRIME
 = 
UINT64_C
(0x100000001b3);

5 
ušt32_t
 
	gFNV_32_INIT
 = 2166136261UL;

6 
ušt32_t
 
	gFNV_32_PRIME
 = 16777619;

8 
ušt32_t


9 
	$hash_âv1_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

11 
ušt64_t
 
hash
 = 
FNV_64_INIT
;

12 
size_t
 
x
;

14 
x
 = 0; x < 
key_Ëngth
; x++) {

15 
hash
 *ğ
FNV_64_PRIME
;

16 
hash
 ^ğ(
ušt64_t
)
key
[
x
];

19  (
ušt32_t
)
hash
;

20 
	}
}

22 
ušt32_t


23 
	$hash_âv1a_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

25 
ušt32_t
 
hash
 = (ušt32_tè
FNV_64_INIT
;

26 
size_t
 
x
;

28 
x
 = 0; x < 
key_Ëngth
; x++) {

29 
ušt32_t
 
v®
 = (ušt32_t)
key
[
x
];

30 
hash
 ^ğ
v®
;

31 
hash
 *ğ(
ušt32_t
è
FNV_64_PRIME
;

34  
hash
;

35 
	}
}

37 
ušt32_t


38 
	$hash_âv1_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

40 
ušt32_t
 
hash
 = 
FNV_32_INIT
;

41 
size_t
 
x
;

43 
x
 = 0; x < 
key_Ëngth
; x++) {

44 
ušt32_t
 
v®
 = (ušt32_t)
key
[
x
];

45 
hash
 *ğ
FNV_32_PRIME
;

46 
hash
 ^ğ
v®
;

49  
hash
;

50 
	}
}

52 
ušt32_t


53 
	$hash_âv1a_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

55 
ušt32_t
 
hash
 = 
FNV_32_INIT
;

56 
size_t
 
x
;

58 
x
ğ0; x < 
key_Ëngth
; x++) {

59 
ušt32_t
 
v®
 = (ušt32_t)
key
[
x
];

60 
hash
 ^ğ
v®
;

61 
hash
 *ğ
FNV_32_PRIME
;

64  
hash
;

65 
	}
}

	@dep/dhashkit/dhashkit.h

1 #iâdeà
_DHASHKIT_H_


2 
	#_DHASHKIT_H_


	)

4 
	~<¡dšt.h
>

5 
	~<¡dio.h
>

7 
	~<sys/ty³s.h
>

9 
	scÚtšuum
 {

10 
ušt32_t
 
	mšdex
;

11 
ušt32_t
 
	mv®ue
;

14 
	#HASH_CODEC
(
ACTION
) \

15 
	`ACTION
Ğ
HASH_ONE_AT_A_TIME
, 
Úe_©_a_time
 ) \

16 
	`ACTION
Ğ
HASH_MD5
, 
md5
 ) \

17 
	`ACTION
Ğ
HASH_CRC16
, 
üc16
 ) \

18 
	`ACTION
Ğ
HASH_CRC32
, 
üc32
 ) \

19 
	`ACTION
Ğ
HASH_CRC32A
, 
üc32a
 ) \

20 
	`ACTION
Ğ
HASH_FNV1_64
, 
âv1_64
 ) \

21 
	`ACTION
Ğ
HASH_FNV1A_64
, 
âv1a_64
 ) \

22 
	`ACTION
Ğ
HASH_FNV1_32
, 
âv1_32
 ) \

23 
	`ACTION
Ğ
HASH_FNV1A_32
, 
âv1a_32
 ) \

24 
	`ACTION
Ğ
HASH_HSIEH
, 
hs›h
 ) \

25 
	`ACTION
Ğ
HASH_MURMUR
, 
murmur
 ) \

26 
	`ACTION
Ğ
HASH_JENKINS
, 
j’kšs
 ) \

27 

	)

28 
	#DIST_CODEC
(
ACTION
) \

29 
	`ACTION
Ğ
DIST_KETAMA
, 
k‘ama
 ) \

30 
	`ACTION
Ğ
DIST_MODULA
, 
moduÏ
 ) \

31 
	`ACTION
Ğ
DIST_RANDOM
, 
¿ndom
 ) \

32 

	)

33 
	#DEFINE_ACTION
(
_hash
, 
_Çme
è_hash,

	)

34 
	ehash_ty³
 {

35 
HASH_CODEC
Ğ
DEFINE_ACTION
 )

36 
	mHASH_SENTINEL


37 } 
	thash_ty³_t
;

38 #undeà
DEFINE_ACTION


40 
	#DEFINE_ACTION
(
_di¡
, 
_Çme
è_di¡,

	)

41 
	edi¡_ty³
 {

42 
DIST_CODEC
Ğ
DEFINE_ACTION
 )

43 
	mDIST_SENTINEL


44 } 
	tdi¡_ty³_t
;

45 #undeà
DEFINE_ACTION


47 
ušt32_t
 
hash_Úe_©_a_time
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

48 
md5_sigÇtu»
(cÚ¡ *
key
, 
Ëngth
, *
»suÉ
);

49 
ušt32_t
 
hash_md5
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

50 
ušt32_t
 
hash_üc16
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

51 
ušt32_t
 
hash_üc32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

52 
ušt32_t
 
hash_üc32a
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

53 
ušt32_t
 
hash_âv1_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

54 
ušt32_t
 
hash_âv1a_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

55 
ušt32_t
 
hash_âv1_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

56 
ušt32_t
 
hash_âv1a_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

57 
ušt32_t
 
hash_hs›h
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

58 
ušt32_t
 
hash_j’kšs
(cÚ¡ *
key
, 
size_t
 
Ëngth
);

59 
ušt32_t
 
hash_murmur
(cÚ¡ *
key
, 
size_t
 
Ëngth
);

61 
ušt32_t
 
k‘ama_di¥©ch
(
cÚtšuum
 *cÚtšuum, ušt32_ˆ
ncÚtšuum
, ušt32_ˆ
hash
);

62 
ušt32_t
 
moduÏ_di¥©ch
(
cÚtšuum
 *cÚtšuum, ušt32_ˆ
ncÚtšuum
, ušt32_ˆ
hash
);

63 
ušt32_t
 
¿ndom_di¥©ch
(
cÚtšuum
 *cÚtšuum, ušt32_ˆ
ncÚtšuum
, ušt32_ˆ
hash
);

68 
ušt32_t
 
	m¡©e
[5];

69 
ušt32_t
 
	mcouÁ
[2];

70 
	mbufãr
[64];

71 } 
	tSHA1_CTX
;

73 
SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64]);

74 
SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
);

75 
SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
);

76 
SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
);

	@dep/dhashkit/dhashkit.h

1 #iâdeà
_DHASHKIT_H_


2 
	#_DHASHKIT_H_


	)

4 
	~<¡dšt.h
>

5 
	~<¡dio.h
>

7 
	~<sys/ty³s.h
>

9 
	scÚtšuum
 {

10 
ušt32_t
 
	mšdex
;

11 
ušt32_t
 
	mv®ue
;

14 
	#HASH_CODEC
(
ACTION
) \

15 
	`ACTION
Ğ
HASH_ONE_AT_A_TIME
, 
Úe_©_a_time
 ) \

16 
	`ACTION
Ğ
HASH_MD5
, 
md5
 ) \

17 
	`ACTION
Ğ
HASH_CRC16
, 
üc16
 ) \

18 
	`ACTION
Ğ
HASH_CRC32
, 
üc32
 ) \

19 
	`ACTION
Ğ
HASH_CRC32A
, 
üc32a
 ) \

20 
	`ACTION
Ğ
HASH_FNV1_64
, 
âv1_64
 ) \

21 
	`ACTION
Ğ
HASH_FNV1A_64
, 
âv1a_64
 ) \

22 
	`ACTION
Ğ
HASH_FNV1_32
, 
âv1_32
 ) \

23 
	`ACTION
Ğ
HASH_FNV1A_32
, 
âv1a_32
 ) \

24 
	`ACTION
Ğ
HASH_HSIEH
, 
hs›h
 ) \

25 
	`ACTION
Ğ
HASH_MURMUR
, 
murmur
 ) \

26 
	`ACTION
Ğ
HASH_JENKINS
, 
j’kšs
 ) \

27 

	)

28 
	#DIST_CODEC
(
ACTION
) \

29 
	`ACTION
Ğ
DIST_KETAMA
, 
k‘ama
 ) \

30 
	`ACTION
Ğ
DIST_MODULA
, 
moduÏ
 ) \

31 
	`ACTION
Ğ
DIST_RANDOM
, 
¿ndom
 ) \

32 

	)

33 
	#DEFINE_ACTION
(
_hash
, 
_Çme
è_hash,

	)

34 
	ehash_ty³
 {

35 
HASH_CODEC
Ğ
DEFINE_ACTION
 )

36 
	mHASH_SENTINEL


37 } 
	thash_ty³_t
;

38 #undeà
DEFINE_ACTION


40 
	#DEFINE_ACTION
(
_di¡
, 
_Çme
è_di¡,

	)

41 
	edi¡_ty³
 {

42 
DIST_CODEC
Ğ
DEFINE_ACTION
 )

43 
	mDIST_SENTINEL


44 } 
	tdi¡_ty³_t
;

45 #undeà
DEFINE_ACTION


47 
ušt32_t
 
hash_Úe_©_a_time
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

48 
md5_sigÇtu»
(cÚ¡ *
key
, 
Ëngth
, *
»suÉ
);

49 
ušt32_t
 
hash_md5
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

50 
ušt32_t
 
hash_üc16
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

51 
ušt32_t
 
hash_üc32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

52 
ušt32_t
 
hash_üc32a
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

53 
ušt32_t
 
hash_âv1_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

54 
ušt32_t
 
hash_âv1a_64
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

55 
ušt32_t
 
hash_âv1_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

56 
ušt32_t
 
hash_âv1a_32
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

57 
ušt32_t
 
hash_hs›h
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
);

58 
ušt32_t
 
hash_j’kšs
(cÚ¡ *
key
, 
size_t
 
Ëngth
);

59 
ušt32_t
 
hash_murmur
(cÚ¡ *
key
, 
size_t
 
Ëngth
);

61 
ušt32_t
 
k‘ama_di¥©ch
(
cÚtšuum
 *cÚtšuum, ušt32_ˆ
ncÚtšuum
, ušt32_ˆ
hash
);

62 
ušt32_t
 
moduÏ_di¥©ch
(
cÚtšuum
 *cÚtšuum, ušt32_ˆ
ncÚtšuum
, ušt32_ˆ
hash
);

63 
ušt32_t
 
¿ndom_di¥©ch
(
cÚtšuum
 *cÚtšuum, ušt32_ˆ
ncÚtšuum
, ušt32_ˆ
hash
);

68 
ušt32_t
 
	m¡©e
[5];

69 
ušt32_t
 
	mcouÁ
[2];

70 
	mbufãr
[64];

71 } 
	tSHA1_CTX
;

73 
SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64]);

74 
SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
);

75 
SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
);

76 
SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
);

	@dep/dhashkit/dhsieh.c

1 
	~<dhashk™.h
>

3 #undeà
g‘16b™s


4 #ià(
defšed
(
__GNUC__
è&& defšed(
__i386__
))

5 
	#g‘16b™s
(
d
è(*((cÚ¡ 
ušt16_t
 *è(d)))

	)

8 #ià!
defšed
 (
g‘16b™s
)

9 
	#g‘16b™s
(
d
è((((
ušt32_t
)(((cÚ¡ 
ušt8_t
 *)(d))[1])) << 8)\

10 +(
ušt32_t
)(((cÚ¡ 
ušt8_t
 *)(
d
))[0]è)

	)

13 
ušt32_t


14 
	$hash_hs›h
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

16 
ušt32_t
 
hash
 = 0, 
tmp
;

17 
»m
;

19 ià(
key_Ëngth
 <ğ0 || 
key
 =ğ
NULL
) {

23 
»m
 = 
key_Ëngth
 & 3;

24 
key_Ëngth
 >>= 2;

27 ;
key_Ëngth
 > 0; key_length--) {

28 
hash
 +ğ
	`g‘16b™s
 (
key
);

29 
tmp
 = (
	`g‘16b™s
 (
key
+2è<< 11è^ 
hash
;

30 
hash
 = (hash << 16è^ 
tmp
;

31 
key
 +ğ2* (
ušt16_t
);

32 
hash
 += hash >> 11;

36 
»m
) {

38 
hash
 +ğ
	`g‘16b™s
 (
key
);

39 
hash
 ^= hash << 16;

40 
hash
 ^ğ(
ušt32_t
)
key
[ (
ušt16_t
)] << 18;

41 
hash
 += hash >> 11;

45 
hash
 +ğ
	`g‘16b™s
 (
key
);

46 
hash
 ^= hash << 11;

47 
hash
 += hash >> 17;

51 
hash
 +ğ()(*
key
);

52 
hash
 ^= hash << 10;

53 
hash
 += hash >> 1;

60 
hash
 ^= hash << 3;

61 
hash
 += hash >> 5;

62 
hash
 ^= hash << 4;

63 
hash
 += hash >> 17;

64 
hash
 ^= hash << 25;

65 
hash
 += hash >> 6;

67  
hash
;

68 
	}
}

	@dep/dhashkit/dhsieh.c

1 
	~<dhashk™.h
>

3 #undeà
g‘16b™s


4 #ià(
defšed
(
__GNUC__
è&& defšed(
__i386__
))

5 
	#g‘16b™s
(
d
è(*((cÚ¡ 
ušt16_t
 *è(d)))

	)

8 #ià!
defšed
 (
g‘16b™s
)

9 
	#g‘16b™s
(
d
è((((
ušt32_t
)(((cÚ¡ 
ušt8_t
 *)(d))[1])) << 8)\

10 +(
ušt32_t
)(((cÚ¡ 
ušt8_t
 *)(
d
))[0]è)

	)

13 
ušt32_t


14 
	$hash_hs›h
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

16 
ušt32_t
 
hash
 = 0, 
tmp
;

17 
»m
;

19 ià(
key_Ëngth
 <ğ0 || 
key
 =ğ
NULL
) {

23 
»m
 = 
key_Ëngth
 & 3;

24 
key_Ëngth
 >>= 2;

27 ;
key_Ëngth
 > 0; key_length--) {

28 
hash
 +ğ
	`g‘16b™s
 (
key
);

29 
tmp
 = (
	`g‘16b™s
 (
key
+2è<< 11è^ 
hash
;

30 
hash
 = (hash << 16è^ 
tmp
;

31 
key
 +ğ2* (
ušt16_t
);

32 
hash
 += hash >> 11;

36 
»m
) {

38 
hash
 +ğ
	`g‘16b™s
 (
key
);

39 
hash
 ^= hash << 16;

40 
hash
 ^ğ(
ušt32_t
)
key
[ (
ušt16_t
)] << 18;

41 
hash
 += hash >> 11;

45 
hash
 +ğ
	`g‘16b™s
 (
key
);

46 
hash
 ^= hash << 11;

47 
hash
 += hash >> 17;

51 
hash
 +ğ()(*
key
);

52 
hash
 ^= hash << 10;

53 
hash
 += hash >> 1;

60 
hash
 ^= hash << 3;

61 
hash
 += hash >> 5;

62 
hash
 ^= hash << 4;

63 
hash
 += hash >> 17;

64 
hash
 ^= hash << 25;

65 
hash
 += hash >> 6;

67  
hash
;

68 
	}
}

	@dep/dhashkit/djenkins.c

1 
	~<dhashk™.h
>

3 
	#hashsize
(
n
è((
ušt32_t
)1<<Ò))

	)

4 
	#hashmask
(
n
è(
	`hashsize
Ò)-1)

	)

5 
	#rÙ
(
x
,
k
è(((x)<<(k)è| ((x)>>(32-(k))))

	)

7 
	#mix
(
a
,
b
,
c
) \

9 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c, 4); c +ğ
b
; \

10 
b
 -ğ
a
; b ^ğ
	`rÙ
×, 6);‡ +ğ
c
; \

11 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 8); b +ğ
a
; \

12 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c,16); c +ğ
b
; \

13 
b
 -ğ
a
; b ^ğ
	`rÙ
×,19);‡ +ğ
c
; \

14 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 4); b +ğ
a
; \

15 }

	)

17 
	#fš®
(
a
,
b
,
c
) \

19 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,14); \

20 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,11); \

21 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,25); \

22 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,16); \

23 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,4); \

24 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,14); \

25 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,24); \

26 }

	)

28 
	#JENKINS_INITVAL
 13

	)

46 
ušt32_t


47 
	$hash_j’kšs
(cÚ¡ *
key
, 
size_t
 
Ëngth
)

49 
ušt32_t
 
a
,
b
,
c
;

50 uniÚ { cÚ¡ *
±r
; 
size_t
 
i
; } 
u
;

53 
a
 = 
b
 = 
c
 = 0xd—db“à+ ((
ušt32_t
)
Ëngth
è+ 
JENKINS_INITVAL
;

55 
u
.
±r
 = 
key
;

56 #iâdeà
WORDS_BIGENDIAN


57 ià((
u
.
i
 & 0x3) == 0)

59 cÚ¡ 
ušt32_t
 *
k
 = (cÚ¡ ušt32_ˆ*)
key
;

62 
Ëngth
 > 12)

64 
a
 +ğ
k
[0];

65 
b
 +ğ
k
[1];

66 
c
 +ğ
k
[2];

67 
	`mix
(
a
,
b
,
c
);

68 
Ëngth
 -= 12;

69 
k
 += 3;

82 
Ëngth
)

84 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

85 11: 
c
+=
k
[2]&0xffffff; 
b
+=k[1]; 
a
+=k[0]; ;

86 10: 
c
+=
k
[2]&0xffff; 
b
+=k[1]; 
a
+=k[0]; ;

87 9 : 
c
+=
k
[2]&0xff; 
b
+=k[1]; 
a
+=k[0]; ;

88 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

89 7 : 
b
+=
k
[1]&0xffffff; 
a
+=k[0]; ;

90 6 : 
b
+=
k
[1]&0xffff; 
a
+=k[0]; ;

91 5 : 
b
+=
k
[1]&0xff; 
a
+=k[0]; ;

92 4 : 
a
+=
k
[0]; ;

93 3 : 
a
+=
k
[0]&0xffffff; ;

94 2 : 
a
+=
k
[0]&0xffff; ;

95 1 : 
a
+=
k
[0]&0xff; ;

96 0 :  
c
;

97 :  
c
;

101 ià((
u
.
i
 & 0x1) == 0)

103 cÚ¡ 
ušt16_t
 *
k
 = (cÚ¡ ušt16_ˆ*)
key
;

104 cÚ¡ 
ušt8_t
 *
k8
;

107 
Ëngth
 > 12)

109 
a
 +ğ
k
[0] + (((
ušt32_t
)k[1])<<16);

110 
b
 +ğ
k
[2] + (((
ušt32_t
)k[3])<<16);

111 
c
 +ğ
k
[4] + (((
ušt32_t
)k[5])<<16);

112 
	`mix
(
a
,
b
,
c
);

113 
Ëngth
 -= 12;

114 
k
 += 6;

118 
k8
 = (cÚ¡ 
ušt8_t
 *)
k
;

119 
Ëngth
)

121 12: 
c
+=
k
[4]+(((
ušt32_t
)k[5])<<16);

122 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

123 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

125 11: 
c
+=((
ušt32_t
)
k8
[10])<<16;

126 10: 
c
+=
k
[4];

127 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

128 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

130 9 : 
c
+=
k8
[8];

131 8 : 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

132 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

134 7 : 
b
+=((
ušt32_t
)
k8
[6])<<16;

135 6 : 
b
+=
k
[2];

136 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

138 5 : 
b
+=
k8
[4];

139 4 : 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

141 3 : 
a
+=((
ušt32_t
)
k8
[2])<<16;

142 2 : 
a
+=
k
[0];

144 1 : 
a
+=
k8
[0];

146 0 :  
c
;

147 :  
c
;

154 cÚ¡ 
ušt8_t
 *
k
 = (cÚ¡ ušt8_ˆ*)
key
;

157 
Ëngth
 > 12)

159 
a
 +ğ
k
[0];

160 
a
 +ğ((
ušt32_t
)
k
[1])<<8;

161 
a
 +ğ((
ušt32_t
)
k
[2])<<16;

162 
a
 +ğ((
ušt32_t
)
k
[3])<<24;

163 
b
 +ğ
k
[4];

164 
b
 +ğ((
ušt32_t
)
k
[5])<<8;

165 
b
 +ğ((
ušt32_t
)
k
[6])<<16;

166 
b
 +ğ((
ušt32_t
)
k
[7])<<24;

167 
c
 +ğ
k
[8];

168 
c
 +ğ((
ušt32_t
)
k
[9])<<8;

169 
c
 +ğ((
ušt32_t
)
k
[10])<<16;

170 
c
 +ğ((
ušt32_t
)
k
[11])<<24;

171 
	`mix
(
a
,
b
,
c
);

172 
Ëngth
 -= 12;

173 
k
 += 12;

177 
Ëngth
)

179 12: 
c
+=((
ušt32_t
)
k
[11])<<24;

180 11: 
c
+=((
ušt32_t
)
k
[10])<<16;

181 10: 
c
+=((
ušt32_t
)
k
[9])<<8;

182 9 : 
c
+=
k
[8];

183 8 : 
b
+=((
ušt32_t
)
k
[7])<<24;

184 7 : 
b
+=((
ušt32_t
)
k
[6])<<16;

185 6 : 
b
+=((
ušt32_t
)
k
[5])<<8;

186 5 : 
b
+=
k
[4];

187 4 : 
a
+=((
ušt32_t
)
k
[3])<<24;

188 3 : 
a
+=((
ušt32_t
)
k
[2])<<16;

189 2 : 
a
+=((
ušt32_t
)
k
[1])<<8;

190 1 : 
a
+=
k
[0];

192 0 :  
c
;

193  :  
c
;

195 #iâdeà
WORDS_BIGENDIAN


199 
	`fš®
(
a
,
b
,
c
);

200  
c
;

201 
	}
}

	@dep/dhashkit/djenkins.c

1 
	~<dhashk™.h
>

3 
	#hashsize
(
n
è((
ušt32_t
)1<<Ò))

	)

4 
	#hashmask
(
n
è(
	`hashsize
Ò)-1)

	)

5 
	#rÙ
(
x
,
k
è(((x)<<(k)è| ((x)>>(32-(k))))

	)

7 
	#mix
(
a
,
b
,
c
) \

9 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c, 4); c +ğ
b
; \

10 
b
 -ğ
a
; b ^ğ
	`rÙ
×, 6);‡ +ğ
c
; \

11 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 8); b +ğ
a
; \

12 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c,16); c +ğ
b
; \

13 
b
 -ğ
a
; b ^ğ
	`rÙ
×,19);‡ +ğ
c
; \

14 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 4); b +ğ
a
; \

15 }

	)

17 
	#fš®
(
a
,
b
,
c
) \

19 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,14); \

20 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,11); \

21 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,25); \

22 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,16); \

23 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,4); \

24 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,14); \

25 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,24); \

26 }

	)

28 
	#JENKINS_INITVAL
 13

	)

46 
ušt32_t


47 
	$hash_j’kšs
(cÚ¡ *
key
, 
size_t
 
Ëngth
)

49 
ušt32_t
 
a
,
b
,
c
;

50 uniÚ { cÚ¡ *
±r
; 
size_t
 
i
; } 
u
;

53 
a
 = 
b
 = 
c
 = 0xd—db“à+ ((
ušt32_t
)
Ëngth
è+ 
JENKINS_INITVAL
;

55 
u
.
±r
 = 
key
;

56 #iâdeà
WORDS_BIGENDIAN


57 ià((
u
.
i
 & 0x3) == 0)

59 cÚ¡ 
ušt32_t
 *
k
 = (cÚ¡ ušt32_ˆ*)
key
;

62 
Ëngth
 > 12)

64 
a
 +ğ
k
[0];

65 
b
 +ğ
k
[1];

66 
c
 +ğ
k
[2];

67 
	`mix
(
a
,
b
,
c
);

68 
Ëngth
 -= 12;

69 
k
 += 3;

82 
Ëngth
)

84 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

85 11: 
c
+=
k
[2]&0xffffff; 
b
+=k[1]; 
a
+=k[0]; ;

86 10: 
c
+=
k
[2]&0xffff; 
b
+=k[1]; 
a
+=k[0]; ;

87 9 : 
c
+=
k
[2]&0xff; 
b
+=k[1]; 
a
+=k[0]; ;

88 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

89 7 : 
b
+=
k
[1]&0xffffff; 
a
+=k[0]; ;

90 6 : 
b
+=
k
[1]&0xffff; 
a
+=k[0]; ;

91 5 : 
b
+=
k
[1]&0xff; 
a
+=k[0]; ;

92 4 : 
a
+=
k
[0]; ;

93 3 : 
a
+=
k
[0]&0xffffff; ;

94 2 : 
a
+=
k
[0]&0xffff; ;

95 1 : 
a
+=
k
[0]&0xff; ;

96 0 :  
c
;

97 :  
c
;

101 ià((
u
.
i
 & 0x1) == 0)

103 cÚ¡ 
ušt16_t
 *
k
 = (cÚ¡ ušt16_ˆ*)
key
;

104 cÚ¡ 
ušt8_t
 *
k8
;

107 
Ëngth
 > 12)

109 
a
 +ğ
k
[0] + (((
ušt32_t
)k[1])<<16);

110 
b
 +ğ
k
[2] + (((
ušt32_t
)k[3])<<16);

111 
c
 +ğ
k
[4] + (((
ušt32_t
)k[5])<<16);

112 
	`mix
(
a
,
b
,
c
);

113 
Ëngth
 -= 12;

114 
k
 += 6;

118 
k8
 = (cÚ¡ 
ušt8_t
 *)
k
;

119 
Ëngth
)

121 12: 
c
+=
k
[4]+(((
ušt32_t
)k[5])<<16);

122 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

123 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

125 11: 
c
+=((
ušt32_t
)
k8
[10])<<16;

126 10: 
c
+=
k
[4];

127 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

128 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

130 9 : 
c
+=
k8
[8];

131 8 : 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

132 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

134 7 : 
b
+=((
ušt32_t
)
k8
[6])<<16;

135 6 : 
b
+=
k
[2];

136 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

138 5 : 
b
+=
k8
[4];

139 4 : 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

141 3 : 
a
+=((
ušt32_t
)
k8
[2])<<16;

142 2 : 
a
+=
k
[0];

144 1 : 
a
+=
k8
[0];

146 0 :  
c
;

147 :  
c
;

154 cÚ¡ 
ušt8_t
 *
k
 = (cÚ¡ ušt8_ˆ*)
key
;

157 
Ëngth
 > 12)

159 
a
 +ğ
k
[0];

160 
a
 +ğ((
ušt32_t
)
k
[1])<<8;

161 
a
 +ğ((
ušt32_t
)
k
[2])<<16;

162 
a
 +ğ((
ušt32_t
)
k
[3])<<24;

163 
b
 +ğ
k
[4];

164 
b
 +ğ((
ušt32_t
)
k
[5])<<8;

165 
b
 +ğ((
ušt32_t
)
k
[6])<<16;

166 
b
 +ğ((
ušt32_t
)
k
[7])<<24;

167 
c
 +ğ
k
[8];

168 
c
 +ğ((
ušt32_t
)
k
[9])<<8;

169 
c
 +ğ((
ušt32_t
)
k
[10])<<16;

170 
c
 +ğ((
ušt32_t
)
k
[11])<<24;

171 
	`mix
(
a
,
b
,
c
);

172 
Ëngth
 -= 12;

173 
k
 += 12;

177 
Ëngth
)

179 12: 
c
+=((
ušt32_t
)
k
[11])<<24;

180 11: 
c
+=((
ušt32_t
)
k
[10])<<16;

181 10: 
c
+=((
ušt32_t
)
k
[9])<<8;

182 9 : 
c
+=
k
[8];

183 8 : 
b
+=((
ušt32_t
)
k
[7])<<24;

184 7 : 
b
+=((
ušt32_t
)
k
[6])<<16;

185 6 : 
b
+=((
ušt32_t
)
k
[5])<<8;

186 5 : 
b
+=
k
[4];

187 4 : 
a
+=((
ušt32_t
)
k
[3])<<24;

188 3 : 
a
+=((
ušt32_t
)
k
[2])<<16;

189 2 : 
a
+=((
ušt32_t
)
k
[1])<<8;

190 1 : 
a
+=
k
[0];

192 0 :  
c
;

193  :  
c
;

195 #iâdeà
WORDS_BIGENDIAN


199 
	`fš®
(
a
,
b
,
c
);

200  
c
;

201 
	}
}

	@dep/dhashkit/dketama.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<m©h.h
>

5 
	~<dhashk™.h
>

7 
	#KETAMA_CONTINUUM_ADDITION
 10

	)

8 
	#KETAMA_POINTS_PER_SERVER
 160

	)

9 
	#KETAMA_MAX_HOSTLEN
 86

	)

11 
ušt32_t


12 
	$k‘ama_hash
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
, 
ušt32_t
 
®ignm’t
)

14 
»suÉs
[16];

16 
	`md5_sigÇtu»
((cÚ¡ *)
key
, ()
key_Ëngth
, 
»suÉs
);

18  ((
ušt32_t
è(
»suÉs
[3 + 
®ignm’t
 * 4] & 0xFF) << 24)

19 | ((
ušt32_t
è(
»suÉs
[2 + 
®ignm’t
 * 4] & 0xFF) << 16)

20 | ((
ušt32_t
è(
»suÉs
[1 + 
®ignm’t
 * 4] & 0xFF) << 8)

21 | (
»suÉs
[0 + 
®ignm’t
 * 4] & 0xFF);

22 
	}
}

25 
	$k‘ama_™em_cmp
(cÚ¡ *
t1
, cÚ¡ *
t2
)

27 cÚ¡ 
cÚtšuum
 *
ù1
 = 
t1
, *
ù2
 = 
t2
;

29 ià(
ù1
->
v®ue
 =ğ
ù2
->value) {

31 } ià(
ù1
->
v®ue
 > 
ù2
->value) {

36 
	}
}

38 
ušt32_t


39 
	$k‘ama_di¥©ch
(
cÚtšuum
 *cÚtšuum, 
ušt32_t
 
ncÚtšuum
, ušt32_ˆ
hash
)

41 
cÚtšuum
 *
begš
, *
’d
, *
Ëá
, *
right
, *
middË
;

43 
	`ASSERT
(
cÚtšuum
 !ğ
NULL
);

44 
	`ASSERT
(
ncÚtšuum
 != 0);

46 
begš
 = 
Ëá
 = 
cÚtšuum
;

47 
’d
 = 
right
 = 
cÚtšuum
 + 
ncÚtšuum
;

49 
Ëá
 < 
right
) {

50 
middË
 = 
Ëá
 + (
right
 -†eft) / 2;

51 ià(
middË
->
v®ue
 < 
hash
) {

52 
Ëá
 = 
middË
 + 1;

54 
right
 = 
middË
;

58 ià(
right
 =ğ
’d
) {

59 
right
 = 
begš
;

62  
right
->
šdex
;

63 
	}
}

	@dep/dhashkit/dketama.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<m©h.h
>

5 
	~<dhashk™.h
>

7 
	#KETAMA_CONTINUUM_ADDITION
 10

	)

8 
	#KETAMA_POINTS_PER_SERVER
 160

	)

9 
	#KETAMA_MAX_HOSTLEN
 86

	)

11 
ušt32_t


12 
	$k‘ama_hash
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
, 
ušt32_t
 
®ignm’t
)

14 
»suÉs
[16];

16 
	`md5_sigÇtu»
((cÚ¡ *)
key
, ()
key_Ëngth
, 
»suÉs
);

18  ((
ušt32_t
è(
»suÉs
[3 + 
®ignm’t
 * 4] & 0xFF) << 24)

19 | ((
ušt32_t
è(
»suÉs
[2 + 
®ignm’t
 * 4] & 0xFF) << 16)

20 | ((
ušt32_t
è(
»suÉs
[1 + 
®ignm’t
 * 4] & 0xFF) << 8)

21 | (
»suÉs
[0 + 
®ignm’t
 * 4] & 0xFF);

22 
	}
}

25 
	$k‘ama_™em_cmp
(cÚ¡ *
t1
, cÚ¡ *
t2
)

27 cÚ¡ 
cÚtšuum
 *
ù1
 = 
t1
, *
ù2
 = 
t2
;

29 ià(
ù1
->
v®ue
 =ğ
ù2
->value) {

31 } ià(
ù1
->
v®ue
 > 
ù2
->value) {

36 
	}
}

38 
ušt32_t


39 
	$k‘ama_di¥©ch
(
cÚtšuum
 *cÚtšuum, 
ušt32_t
 
ncÚtšuum
, ušt32_ˆ
hash
)

41 
cÚtšuum
 *
begš
, *
’d
, *
Ëá
, *
right
, *
middË
;

43 
	`ASSERT
(
cÚtšuum
 !ğ
NULL
);

44 
	`ASSERT
(
ncÚtšuum
 != 0);

46 
begš
 = 
Ëá
 = 
cÚtšuum
;

47 
’d
 = 
right
 = 
cÚtšuum
 + 
ncÚtšuum
;

49 
Ëá
 < 
right
) {

50 
middË
 = 
Ëá
 + (
right
 -†eft) / 2;

51 ià(
middË
->
v®ue
 < 
hash
) {

52 
Ëá
 = 
middË
 + 1;

54 
right
 = 
middË
;

58 ià(
right
 =ğ
’d
) {

59 
right
 = 
begš
;

62  
right
->
šdex
;

63 
	}
}

	@dep/dhashkit/dmd5.c

1 
	~<¡ršg.h
>

3 
	~<dhashk™.h
>

14 
	tMD5_u32¶us
;

17 
MD5_u32¶us
 
	mlo
, 
	mhi
;

18 
MD5_u32¶us
 
	ma
, 
	mb
, 
	mc
, 
	md
;

19 
	mbufãr
[64];

20 
MD5_u32¶us
 
	mblock
[16];

21 } 
	tMD5_CTX
;

30 
	#F
(
x
, 
y
, 
z
è((zè^ ((xè& ((yè^ (z))))

	)

31 
	#G
(
x
, 
y
, 
z
è((yè^ ((zè& ((xè^ (y))))

	)

32 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

33 
	#I
(
x
, 
y
, 
z
è((yè^ ((xè| ~(z)))

	)

38 
	#STEP
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
t
, 
s
) \

39 (
a
è+ğ
	`f
((
b
), (
c
), (
d
)è+ (
x
è+ (
t
); \

40 (
a
èğ((×è<< (
s
)) | (((a) & 0xffffffff) >> (32 - (s)))); \

41 (
a
è+ğ(
b
);

	)

51 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
è|| defšed(
__vax__
)

52 
	#SET
(
n
) \

53 (*(
MD5_u32¶us
 *)&
±r
[(
n
è* 4])

	)

54 
	#GET
(
n
) \

55 
	`SET
(
n
)

	)

57 
	#SET
(
n
) \

58 (
ùx
->
block
[(
n
)] = \

59 (
MD5_u32¶us
)
±r
[(
n
) * 4] | \

60 ((
MD5_u32¶us
)
±r
[(
n
) * 4 + 1] << 8) | \

61 ((
MD5_u32¶us
)
±r
[(
n
) * 4 + 2] << 16) | \

62 ((
MD5_u32¶us
)
±r
[(
n
è* 4 + 3] << 24))

	)

63 
	#GET
(
n
) \

64 (
ùx
->
block
[(
n
)])

	)

72 
	$body
(
MD5_CTX
 *
ùx
, *
d©a
, 
size
)

74 *
±r
;

75 
MD5_u32¶us
 
a
, 
b
, 
c
, 
d
;

76 
MD5_u32¶us
 
§ved_a
, 
§ved_b
, 
§ved_c
, 
§ved_d
;

78 
±r
 = 
d©a
;

80 
a
 = 
ùx
->a;

81 
b
 = 
ùx
->b;

82 
c
 = 
ùx
->c;

83 
d
 = 
ùx
->d;

86 
§ved_a
 = 
a
;

87 
§ved_b
 = 
b
;

88 
§ved_c
 = 
c
;

89 
§ved_d
 = 
d
;

92 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(0), 0xd76aa478, 7)

93 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(1), 0xe8c7b756, 12)

94 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(2), 0x242070db, 17)

95 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(3), 0xc1bdceee, 22)

96 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(4), 0xf57c0faf, 7)

97 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(5), 0x4787c62a, 12)

98 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(6), 0xa8304613, 17)

99 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(7), 0xfd469501, 22)

100 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(8), 0x698098d8, 7)

101 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(9), 0x8b44f7af, 12)

102 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(10), 0xffff5bb1, 17)

103 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(11), 0x895cd7be, 22)

104 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(12), 0x6b901122, 7)

105 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(13), 0xfd987193, 12)

106 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(14), 0xa679438e, 17)

107 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(15), 0x49b40821, 22)

110 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xf61e2562, 5)

111 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(6), 0xc040b340, 9)

112 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x265e5a51, 14)

113 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(0), 0xe9b6c7aa, 20)

114 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xd62f105d, 5)

115 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(10), 0x02441453, 9)

116 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0xd8a1e681, 14)

117 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(4), 0xe7d3fbc8, 20)

118 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0x21e1cde6, 5)

119 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(14), 0xc33707d6, 9)

120 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xf4d50d87, 14)

121 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(8), 0x455a14ed, 20)

122 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0xa9e3e905, 5)

123 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(2), 0xfcefa3f8, 9)

124 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0x676f02d9, 14)

125 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(12), 0x8d2a4c8a, 20)

128 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xfffa3942, 4)

129 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(8), 0x8771f681, 11)

130 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x6d9d6122, 16)

131 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(14), 0xfde5380c, 23)

132 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xa4beea44, 4)

133 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(4), 0x4bdecfa9, 11)

134 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0xf6bb4b60, 16)

135 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(10), 0xbebfbc70, 23)

136 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0x289b7ec6, 4)

137 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(0), 0xeaa127fa, 11)

138 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xd4ef3085, 16)

139 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(6), 0x04881d05, 23)

140 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0xd9d4d039, 4)

141 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(12), 0xe6db99e5, 11)

142 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0x1fa27cf8, 16)

143 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(2), 0xc4ac5665, 23)

146 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(0), 0xf4292244, 6)

147 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(7), 0x432aff97, 10)

148 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(14), 0xab9423a7, 15)

149 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(5), 0xfc93a039, 21)

150 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(12), 0x655b59c3, 6)

151 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(3), 0x8f0ccc92, 10)

152 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(10), 0xffeff47d, 15)

153 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(1), 0x85845dd1, 21)

154 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(8), 0x6fa87e4f, 6)

155 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(15), 0xfe2ce6e0, 10)

156 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(6), 0xa3014314, 15)

157 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(13), 0x4e0811a1, 21)

158 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(4), 0xf7537e82, 6)

159 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(11), 0xbd3af235, 10)

160 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(2), 0x2ad7d2bb, 15)

161 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(9), 0xeb86d391, 21)

163 
a
 +ğ
§ved_a
;

164 
b
 +ğ
§ved_b
;

165 
c
 +ğ
§ved_c
;

166 
d
 +ğ
§ved_d
;

168 
±r
 += 64;

169 } 
size
 -= 64);

171 
ùx
->
a
 =‡;

172 
ùx
->
b
 = b;

173 
ùx
->
c
 = c;

174 
ùx
->
d
 = d;

176  
±r
;

177 
	}
}

180 
	$MD5_In™
(
MD5_CTX
 *
ùx
)

182 
ùx
->
a
 = 0x67452301;

183 
ùx
->
b
 = 0xefcdab89;

184 
ùx
->
c
 = 0x98badcfe;

185 
ùx
->
d
 = 0x10325476;

187 
ùx
->
lo
 = 0;

188 
ùx
->
hi
 = 0;

189 
	}
}

192 
	$MD5_Upd©e
(
MD5_CTX
 *
ùx
, *
d©a
, 
size
)

194 
MD5_u32¶us
 
§ved_lo
;

195 
u£d
, 
ä“
;

197 
§ved_lo
 = 
ùx
->
lo
;

198 ià((
ùx
->
lo
 = (
§ved_lo
 + 
size
) & 0x1fffffff) < saved_lo) {

199 
ùx
->
hi
++;

201 
ùx
->
hi
 +ğ
size
 >> 29;

203 
u£d
 = 
§ved_lo
 & 0x3f;

205 ià(
u£d
) {

206 
ä“
 = 64 - 
u£d
;

208 ià(
size
 < 
ä“
) {

209 
	`memıy
(&
ùx
->
bufãr
[
u£d
], 
d©a
, 
size
);

213 
	`memıy
(&
ùx
->
bufãr
[
u£d
], 
d©a
, 
ä“
);

214 
d©a
 = (*)d©¨+ 
ä“
;

215 
size
 -ğ
ä“
;

216 
	`body
(
ùx
, ctx->
bufãr
, 64);

219 ià(
size
 >= 64) {

220 
d©a
 = 
	`body
(
ùx
, d©a, 
size
 & ~()0x3f);

221 
size
 &= 0x3f;

224 
	`memıy
(
ùx
->
bufãr
, 
d©a
, 
size
);

225 
	}
}

228 
	$MD5_Fš®
(*
»suÉ
, 
MD5_CTX
 *
ùx
)

230 
u£d
, 
ä“
;

232 
u£d
 = 
ùx
->
lo
 & 0x3f;

234 
ùx
->
bufãr
[
u£d
++] = 0x80;

236 
ä“
 = 64 - 
u£d
;

238 ià(
ä“
 < 8) {

239 
	`mem£t
(&
ùx
->
bufãr
[
u£d
], 0, 
ä“
);

240 
	`body
(
ùx
, ctx->
bufãr
, 64);

241 
u£d
 = 0;

242 
ä“
 = 64;

245 
	`mem£t
(&
ùx
->
bufãr
[
u£d
], 0, 
ä“
 - 8);

247 
ùx
->
lo
 <<= 3;

248 
ùx
->
bufãr
[56] = ctx->
lo
;

249 
ùx
->
bufãr
[57] = ctx->
lo
 >> 8;

250 
ùx
->
bufãr
[58] = ctx->
lo
 >> 16;

251 
ùx
->
bufãr
[59] = ctx->
lo
 >> 24;

252 
ùx
->
bufãr
[60] = ctx->
hi
;

253 
ùx
->
bufãr
[61] = ctx->
hi
 >> 8;

254 
ùx
->
bufãr
[62] = ctx->
hi
 >> 16;

255 
ùx
->
bufãr
[63] = ctx->
hi
 >> 24;

257 
	`body
(
ùx
, ctx->
bufãr
, 64);

259 
»suÉ
[0] = 
ùx
->
a
;

260 
»suÉ
[1] = 
ùx
->
a
 >> 8;

261 
»suÉ
[2] = 
ùx
->
a
 >> 16;

262 
»suÉ
[3] = 
ùx
->
a
 >> 24;

263 
»suÉ
[4] = 
ùx
->
b
;

264 
»suÉ
[5] = 
ùx
->
b
 >> 8;

265 
»suÉ
[6] = 
ùx
->
b
 >> 16;

266 
»suÉ
[7] = 
ùx
->
b
 >> 24;

267 
»suÉ
[8] = 
ùx
->
c
;

268 
»suÉ
[9] = 
ùx
->
c
 >> 8;

269 
»suÉ
[10] = 
ùx
->
c
 >> 16;

270 
»suÉ
[11] = 
ùx
->
c
 >> 24;

271 
»suÉ
[12] = 
ùx
->
d
;

272 
»suÉ
[13] = 
ùx
->
d
 >> 8;

273 
»suÉ
[14] = 
ùx
->
d
 >> 16;

274 
»suÉ
[15] = 
ùx
->
d
 >> 24;

276 
	`mem£t
(
ùx
, 0, (*ctx));

277 
	}
}

284 
	$md5_sigÇtu»
(cÚ¡ *
key
, 
Ëngth
, *
»suÉ
)

286 
MD5_CTX
 
my_md5
;

288 
	`MD5_In™
(&
my_md5
);

289 ()
	`MD5_Upd©e
(&
my_md5
, 
key
, 
Ëngth
);

290 
	`MD5_Fš®
(
»suÉ
, &
my_md5
);

291 
	}
}

293 
ušt32_t


294 
	$hash_md5
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

296 
»suÉs
[16];

298 
	`md5_sigÇtu»
((cÚ¡ *)
key
, ()
key_Ëngth
, 
»suÉs
);

300  ((
ušt32_t
è(
»suÉs
[3] & 0xFF) << 24) |

301 ((
ušt32_t
è(
»suÉs
[2] & 0xFF) << 16) |

302 ((
ušt32_t
è(
»suÉs
[1] & 0xFF) << 8) |

303 (
»suÉs
[0] & 0xFF);

304 
	}
}

	@dep/dhashkit/dmd5.c

1 
	~<¡ršg.h
>

3 
	~<dhashk™.h
>

14 
	tMD5_u32¶us
;

17 
MD5_u32¶us
 
	mlo
, 
	mhi
;

18 
MD5_u32¶us
 
	ma
, 
	mb
, 
	mc
, 
	md
;

19 
	mbufãr
[64];

20 
MD5_u32¶us
 
	mblock
[16];

21 } 
	tMD5_CTX
;

30 
	#F
(
x
, 
y
, 
z
è((zè^ ((xè& ((yè^ (z))))

	)

31 
	#G
(
x
, 
y
, 
z
è((yè^ ((zè& ((xè^ (y))))

	)

32 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

33 
	#I
(
x
, 
y
, 
z
è((yè^ ((xè| ~(z)))

	)

38 
	#STEP
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
t
, 
s
) \

39 (
a
è+ğ
	`f
((
b
), (
c
), (
d
)è+ (
x
è+ (
t
); \

40 (
a
èğ((×è<< (
s
)) | (((a) & 0xffffffff) >> (32 - (s)))); \

41 (
a
è+ğ(
b
);

	)

51 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
è|| defšed(
__vax__
)

52 
	#SET
(
n
) \

53 (*(
MD5_u32¶us
 *)&
±r
[(
n
è* 4])

	)

54 
	#GET
(
n
) \

55 
	`SET
(
n
)

	)

57 
	#SET
(
n
) \

58 (
ùx
->
block
[(
n
)] = \

59 (
MD5_u32¶us
)
±r
[(
n
) * 4] | \

60 ((
MD5_u32¶us
)
±r
[(
n
) * 4 + 1] << 8) | \

61 ((
MD5_u32¶us
)
±r
[(
n
) * 4 + 2] << 16) | \

62 ((
MD5_u32¶us
)
±r
[(
n
è* 4 + 3] << 24))

	)

63 
	#GET
(
n
) \

64 (
ùx
->
block
[(
n
)])

	)

72 
	$body
(
MD5_CTX
 *
ùx
, *
d©a
, 
size
)

74 *
±r
;

75 
MD5_u32¶us
 
a
, 
b
, 
c
, 
d
;

76 
MD5_u32¶us
 
§ved_a
, 
§ved_b
, 
§ved_c
, 
§ved_d
;

78 
±r
 = 
d©a
;

80 
a
 = 
ùx
->a;

81 
b
 = 
ùx
->b;

82 
c
 = 
ùx
->c;

83 
d
 = 
ùx
->d;

86 
§ved_a
 = 
a
;

87 
§ved_b
 = 
b
;

88 
§ved_c
 = 
c
;

89 
§ved_d
 = 
d
;

92 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(0), 0xd76aa478, 7)

93 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(1), 0xe8c7b756, 12)

94 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(2), 0x242070db, 17)

95 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(3), 0xc1bdceee, 22)

96 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(4), 0xf57c0faf, 7)

97 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(5), 0x4787c62a, 12)

98 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(6), 0xa8304613, 17)

99 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(7), 0xfd469501, 22)

100 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(8), 0x698098d8, 7)

101 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(9), 0x8b44f7af, 12)

102 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(10), 0xffff5bb1, 17)

103 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(11), 0x895cd7be, 22)

104 
	`STEP
(
F
, 
a
, 
b
, 
c
, 
d
, 
	`SET
(12), 0x6b901122, 7)

105 
	`STEP
(
F
, 
d
, 
a
, 
b
, 
c
, 
	`SET
(13), 0xfd987193, 12)

106 
	`STEP
(
F
, 
c
, 
d
, 
a
, 
b
, 
	`SET
(14), 0xa679438e, 17)

107 
	`STEP
(
F
, 
b
, 
c
, 
d
, 
a
, 
	`SET
(15), 0x49b40821, 22)

110 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xf61e2562, 5)

111 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(6), 0xc040b340, 9)

112 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x265e5a51, 14)

113 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(0), 0xe9b6c7aa, 20)

114 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xd62f105d, 5)

115 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(10), 0x02441453, 9)

116 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0xd8a1e681, 14)

117 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(4), 0xe7d3fbc8, 20)

118 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0x21e1cde6, 5)

119 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(14), 0xc33707d6, 9)

120 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xf4d50d87, 14)

121 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(8), 0x455a14ed, 20)

122 
	`STEP
(
G
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0xa9e3e905, 5)

123 
	`STEP
(
G
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(2), 0xfcefa3f8, 9)

124 
	`STEP
(
G
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0x676f02d9, 14)

125 
	`STEP
(
G
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(12), 0x8d2a4c8a, 20)

128 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(5), 0xfffa3942, 4)

129 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(8), 0x8771f681, 11)

130 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(11), 0x6d9d6122, 16)

131 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(14), 0xfde5380c, 23)

132 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(1), 0xa4beea44, 4)

133 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(4), 0x4bdecfa9, 11)

134 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(7), 0xf6bb4b60, 16)

135 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(10), 0xbebfbc70, 23)

136 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(13), 0x289b7ec6, 4)

137 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(0), 0xeaa127fa, 11)

138 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(3), 0xd4ef3085, 16)

139 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(6), 0x04881d05, 23)

140 
	`STEP
(
H
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(9), 0xd9d4d039, 4)

141 
	`STEP
(
H
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(12), 0xe6db99e5, 11)

142 
	`STEP
(
H
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(15), 0x1fa27cf8, 16)

143 
	`STEP
(
H
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(2), 0xc4ac5665, 23)

146 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(0), 0xf4292244, 6)

147 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(7), 0x432aff97, 10)

148 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(14), 0xab9423a7, 15)

149 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(5), 0xfc93a039, 21)

150 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(12), 0x655b59c3, 6)

151 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(3), 0x8f0ccc92, 10)

152 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(10), 0xffeff47d, 15)

153 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(1), 0x85845dd1, 21)

154 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(8), 0x6fa87e4f, 6)

155 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(15), 0xfe2ce6e0, 10)

156 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(6), 0xa3014314, 15)

157 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(13), 0x4e0811a1, 21)

158 
	`STEP
(
I
, 
a
, 
b
, 
c
, 
d
, 
	`GET
(4), 0xf7537e82, 6)

159 
	`STEP
(
I
, 
d
, 
a
, 
b
, 
c
, 
	`GET
(11), 0xbd3af235, 10)

160 
	`STEP
(
I
, 
c
, 
d
, 
a
, 
b
, 
	`GET
(2), 0x2ad7d2bb, 15)

161 
	`STEP
(
I
, 
b
, 
c
, 
d
, 
a
, 
	`GET
(9), 0xeb86d391, 21)

163 
a
 +ğ
§ved_a
;

164 
b
 +ğ
§ved_b
;

165 
c
 +ğ
§ved_c
;

166 
d
 +ğ
§ved_d
;

168 
±r
 += 64;

169 } 
size
 -= 64);

171 
ùx
->
a
 =‡;

172 
ùx
->
b
 = b;

173 
ùx
->
c
 = c;

174 
ùx
->
d
 = d;

176  
±r
;

177 
	}
}

180 
	$MD5_In™
(
MD5_CTX
 *
ùx
)

182 
ùx
->
a
 = 0x67452301;

183 
ùx
->
b
 = 0xefcdab89;

184 
ùx
->
c
 = 0x98badcfe;

185 
ùx
->
d
 = 0x10325476;

187 
ùx
->
lo
 = 0;

188 
ùx
->
hi
 = 0;

189 
	}
}

192 
	$MD5_Upd©e
(
MD5_CTX
 *
ùx
, *
d©a
, 
size
)

194 
MD5_u32¶us
 
§ved_lo
;

195 
u£d
, 
ä“
;

197 
§ved_lo
 = 
ùx
->
lo
;

198 ià((
ùx
->
lo
 = (
§ved_lo
 + 
size
) & 0x1fffffff) < saved_lo) {

199 
ùx
->
hi
++;

201 
ùx
->
hi
 +ğ
size
 >> 29;

203 
u£d
 = 
§ved_lo
 & 0x3f;

205 ià(
u£d
) {

206 
ä“
 = 64 - 
u£d
;

208 ià(
size
 < 
ä“
) {

209 
	`memıy
(&
ùx
->
bufãr
[
u£d
], 
d©a
, 
size
);

213 
	`memıy
(&
ùx
->
bufãr
[
u£d
], 
d©a
, 
ä“
);

214 
d©a
 = (*)d©¨+ 
ä“
;

215 
size
 -ğ
ä“
;

216 
	`body
(
ùx
, ctx->
bufãr
, 64);

219 ià(
size
 >= 64) {

220 
d©a
 = 
	`body
(
ùx
, d©a, 
size
 & ~()0x3f);

221 
size
 &= 0x3f;

224 
	`memıy
(
ùx
->
bufãr
, 
d©a
, 
size
);

225 
	}
}

228 
	$MD5_Fš®
(*
»suÉ
, 
MD5_CTX
 *
ùx
)

230 
u£d
, 
ä“
;

232 
u£d
 = 
ùx
->
lo
 & 0x3f;

234 
ùx
->
bufãr
[
u£d
++] = 0x80;

236 
ä“
 = 64 - 
u£d
;

238 ià(
ä“
 < 8) {

239 
	`mem£t
(&
ùx
->
bufãr
[
u£d
], 0, 
ä“
);

240 
	`body
(
ùx
, ctx->
bufãr
, 64);

241 
u£d
 = 0;

242 
ä“
 = 64;

245 
	`mem£t
(&
ùx
->
bufãr
[
u£d
], 0, 
ä“
 - 8);

247 
ùx
->
lo
 <<= 3;

248 
ùx
->
bufãr
[56] = ctx->
lo
;

249 
ùx
->
bufãr
[57] = ctx->
lo
 >> 8;

250 
ùx
->
bufãr
[58] = ctx->
lo
 >> 16;

251 
ùx
->
bufãr
[59] = ctx->
lo
 >> 24;

252 
ùx
->
bufãr
[60] = ctx->
hi
;

253 
ùx
->
bufãr
[61] = ctx->
hi
 >> 8;

254 
ùx
->
bufãr
[62] = ctx->
hi
 >> 16;

255 
ùx
->
bufãr
[63] = ctx->
hi
 >> 24;

257 
	`body
(
ùx
, ctx->
bufãr
, 64);

259 
»suÉ
[0] = 
ùx
->
a
;

260 
»suÉ
[1] = 
ùx
->
a
 >> 8;

261 
»suÉ
[2] = 
ùx
->
a
 >> 16;

262 
»suÉ
[3] = 
ùx
->
a
 >> 24;

263 
»suÉ
[4] = 
ùx
->
b
;

264 
»suÉ
[5] = 
ùx
->
b
 >> 8;

265 
»suÉ
[6] = 
ùx
->
b
 >> 16;

266 
»suÉ
[7] = 
ùx
->
b
 >> 24;

267 
»suÉ
[8] = 
ùx
->
c
;

268 
»suÉ
[9] = 
ùx
->
c
 >> 8;

269 
»suÉ
[10] = 
ùx
->
c
 >> 16;

270 
»suÉ
[11] = 
ùx
->
c
 >> 24;

271 
»suÉ
[12] = 
ùx
->
d
;

272 
»suÉ
[13] = 
ùx
->
d
 >> 8;

273 
»suÉ
[14] = 
ùx
->
d
 >> 16;

274 
»suÉ
[15] = 
ùx
->
d
 >> 24;

276 
	`mem£t
(
ùx
, 0, (*ctx));

277 
	}
}

284 
	$md5_sigÇtu»
(cÚ¡ *
key
, 
Ëngth
, *
»suÉ
)

286 
MD5_CTX
 
my_md5
;

288 
	`MD5_In™
(&
my_md5
);

289 ()
	`MD5_Upd©e
(&
my_md5
, 
key
, 
Ëngth
);

290 
	`MD5_Fš®
(
»suÉ
, &
my_md5
);

291 
	}
}

293 
ušt32_t


294 
	$hash_md5
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

296 
»suÉs
[16];

298 
	`md5_sigÇtu»
((cÚ¡ *)
key
, ()
key_Ëngth
, 
»suÉs
);

300  ((
ušt32_t
è(
»suÉs
[3] & 0xFF) << 24) |

301 ((
ušt32_t
è(
»suÉs
[2] & 0xFF) << 16) |

302 ((
ušt32_t
è(
»suÉs
[1] & 0xFF) << 8) |

303 (
»suÉs
[0] & 0xFF);

304 
	}
}

	@dep/dhashkit/dmodula.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

4 
	~<dhashk™.h
>

6 
	#MODULA_CONTINUUM_ADDITION
 10

	)

7 
	#MODULA_POINTS_PER_SERVER
 1

	)

9 
ušt32_t


10 
	$moduÏ_di¥©ch
(
cÚtšuum
 *cÚtšuum, 
ušt32_t
 
ncÚtšuum
, ušt32_ˆ
hash
)

12 
cÚtšuum
 *
c
;

14 
	`ASSERT
(
cÚtšuum
 !ğ
NULL
);

15 
	`ASSERT
(
ncÚtšuum
 != 0);

17 
c
 = 
cÚtšuum
 + 
hash
 % 
ncÚtšuum
;

19  
c
->
šdex
;

20 
	}
}

	@dep/dhashkit/dmodula.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

4 
	~<dhashk™.h
>

6 
	#MODULA_CONTINUUM_ADDITION
 10

	)

7 
	#MODULA_POINTS_PER_SERVER
 1

	)

9 
ušt32_t


10 
	$moduÏ_di¥©ch
(
cÚtšuum
 *cÚtšuum, 
ušt32_t
 
ncÚtšuum
, ušt32_ˆ
hash
)

12 
cÚtšuum
 *
c
;

14 
	`ASSERT
(
cÚtšuum
 !ğ
NULL
);

15 
	`ASSERT
(
ncÚtšuum
 != 0);

17 
c
 = 
cÚtšuum
 + 
hash
 % 
ncÚtšuum
;

19  
c
->
šdex
;

20 
	}
}

	@dep/dhashkit/dmurmur.c

18 
	~<dhashk™.h
>

20 
ušt32_t


21 
	$hash_murmur
(cÚ¡ *
key
, 
size_t
 
Ëngth
)

28 cÚ¡ 
m
 = 0x5bd1e995;

29 cÚ¡ 
ušt32_t
 
£ed
 = (0xd—db“à* (ušt32_t)
Ëngth
);

30 cÚ¡ 
r
 = 24;

35 
ušt32_t
 
h
 = 
£ed
 ^ (ušt32_t)
Ëngth
;

39 cÚ¡ * 
d©a
 = (cÚ¡ *)
key
;

41 
Ëngth
 >= 4) {

42 
k
 = *(*)
d©a
;

44 
k
 *ğ
m
;

45 
k
 ^ğk >> 
r
;

46 
k
 *ğ
m
;

48 
h
 *ğ
m
;

49 
h
 ^ğ
k
;

51 
d©a
 += 4;

52 
Ëngth
 -= 4;

57 
Ëngth
) {

59 
h
 ^ğ((
ušt32_t
)
d©a
[2]) << 16;

62 
h
 ^ğ((
ušt32_t
)
d©a
[1]) << 8;

65 
h
 ^ğ
d©a
[0];

66 
h
 *ğ
m
;

77 
h
 ^= h >> 13;

78 
h
 *ğ
m
;

79 
h
 ^= h >> 15;

81  
h
;

82 
	}
}

	@dep/dhashkit/dmurmur.c

18 
	~<dhashk™.h
>

20 
ušt32_t


21 
	$hash_murmur
(cÚ¡ *
key
, 
size_t
 
Ëngth
)

28 cÚ¡ 
m
 = 0x5bd1e995;

29 cÚ¡ 
ušt32_t
 
£ed
 = (0xd—db“à* (ušt32_t)
Ëngth
);

30 cÚ¡ 
r
 = 24;

35 
ušt32_t
 
h
 = 
£ed
 ^ (ušt32_t)
Ëngth
;

39 cÚ¡ * 
d©a
 = (cÚ¡ *)
key
;

41 
Ëngth
 >= 4) {

42 
k
 = *(*)
d©a
;

44 
k
 *ğ
m
;

45 
k
 ^ğk >> 
r
;

46 
k
 *ğ
m
;

48 
h
 *ğ
m
;

49 
h
 ^ğ
k
;

51 
d©a
 += 4;

52 
Ëngth
 -= 4;

57 
Ëngth
) {

59 
h
 ^ğ((
ušt32_t
)
d©a
[2]) << 16;

62 
h
 ^ğ((
ušt32_t
)
d©a
[1]) << 8;

65 
h
 ^ğ
d©a
[0];

66 
h
 *ğ
m
;

77 
h
 ^= h >> 13;

78 
h
 *ğ
m
;

79 
h
 ^= h >> 15;

81  
h
;

82 
	}
}

	@dep/dhashkit/done_at_a_time.c

15 
	~<dhashk™.h
>

17 
ušt32_t


18 
	$hash_Úe_©_a_time
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

20 cÚ¡ *
±r
 = 
key
;

21 
ušt32_t
 
v®ue
 = 0;

23 
key_Ëngth
--) {

24 
ušt32_t
 
v®
 = (ušt32_tè*
±r
++;

25 
v®ue
 +ğ
v®
;

26 
v®ue
 += (value << 10);

27 
v®ue
 ^= (value >> 6);

29 
v®ue
 += (value << 3);

30 
v®ue
 ^= (value >> 11);

31 
v®ue
 += (value << 15);

33  
v®ue
;

34 
	}
}

	@dep/dhashkit/done_at_a_time.c

15 
	~<dhashk™.h
>

17 
ušt32_t


18 
	$hash_Úe_©_a_time
(cÚ¡ *
key
, 
size_t
 
key_Ëngth
)

20 cÚ¡ *
±r
 = 
key
;

21 
ušt32_t
 
v®ue
 = 0;

23 
key_Ëngth
--) {

24 
ušt32_t
 
v®
 = (ušt32_tè*
±r
++;

25 
v®ue
 +ğ
v®
;

26 
v®ue
 += (value << 10);

27 
v®ue
 ^= (value >> 6);

29 
v®ue
 += (value << 3);

30 
v®ue
 ^= (value >> 11);

31 
v®ue
 += (value << 15);

33  
v®ue
;

34 
	}
}

	@dep/dhashkit/drandom.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

4 
	~<dhashk™.h
>

6 
	#RANDOM_CONTINUUM_ADDITION
 10

	)

7 
	#RANDOM_POINTS_PER_SERVER
 1

	)

9 
ušt32_t


10 
	$¿ndom_di¥©ch
(
cÚtšuum
 *cÚtšuum, 
ušt32_t
 
ncÚtšuum
, ušt32_ˆ
hash
)

12 
cÚtšuum
 *
c
;

14 
	`ASSERT
(
cÚtšuum
 !ğ
NULL
);

15 
	`ASSERT
(
ncÚtšuum
 != 0);

17 
c
 = 
cÚtšuum
 + 
	`¿ndom
(è% 
ncÚtšuum
;

19  
c
->
šdex
;

20 
	}
}

	@dep/dhashkit/drandom.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

4 
	~<dhashk™.h
>

6 
	#RANDOM_CONTINUUM_ADDITION
 10

	)

7 
	#RANDOM_POINTS_PER_SERVER
 1

	)

9 
ušt32_t


10 
	$¿ndom_di¥©ch
(
cÚtšuum
 *cÚtšuum, 
ušt32_t
 
ncÚtšuum
, ušt32_ˆ
hash
)

12 
cÚtšuum
 *
c
;

14 
	`ASSERT
(
cÚtšuum
 !ğ
NULL
);

15 
	`ASSERT
(
ncÚtšuum
 != 0);

17 
c
 = 
cÚtšuum
 + 
	`¿ndom
(è% 
ncÚtšuum
;

19  
c
->
šdex
;

20 
	}
}

	@dep/dhashkit/dsha1.c

22 
	#SHA1HANDSOFF


	)

24 
	~<¡dio.h
>

25 
	~<¡ršg.h
>

26 
	~<¡dšt.h
>

28 
	~<dhashk™.h
>

30 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

34 #ifdeà
VR_LITTLE_ENDIAN


35 
	#blk0
(
i
è(
block
->
l
[i] = (
	`rŞ
(block->l[i],24)&0xFF00FF00) \

36 |(
	`rŞ
(
block
->
l
[
i
],8)&0x00FF00FF))

	)

38 
	#blk0
(
i
è
block
->
l
[i]

	)

40 
	#blk
(
i
è(
block
->
l
[i&15] = 
	`rŞ
(block->l[(i+13)&15]^block->l[(i+8)&15] \

41 ^
block
->
l
[(
i
+2)&15]^block->l[i&15],1))

	)

44 
	#R0
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk0
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

45 
	#R1
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

46 
	#R2
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0x6ED9EBA1+
	`rŞ
(v,5);wôŞ(w,30);

	)

47 
	#R3
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(((w|x)&y)|(w&x))+
	`blk
(i)+0x8F1BBCDC+
	`rŞ
(v,5);wôŞ(w,30);

	)

48 
	#R4
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0xCA62C1D6+
	`rŞ
(v,5);wôŞ(w,30);

	)

53 
	$SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64])

55 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

57 
c
[64];

58 
ušt32_t
 
l
[16];

59 } 
	tCHAR64LONG16
;

60 #ifdeà
SHA1HANDSOFF


61 
CHAR64LONG16
 
block
[1];

62 
	`memıy
(
block
, 
bufãr
, 64);

69 
CHAR64LONG16
* 
block
 = (cÚ¡ CHAR64LONG16*)
bufãr
;

72 
a
 = 
¡©e
[0];

73 
b
 = 
¡©e
[1];

74 
c
 = 
¡©e
[2];

75 
d
 = 
¡©e
[3];

76 
e
 = 
¡©e
[4];

78 
	`R0
(
a
,
b
,
c
,
d
,
e
, 0); R0(e,a,b,c,d, 1); R0(d,e,a,b,c, 2); R0(c,d,e,a,b, 3);

79 
	`R0
(
b
,
c
,
d
,
e
,
a
, 4); R0(a,b,c,d,e, 5); R0(e,a,b,c,d, 6); R0(d,e,a,b,c, 7);

80 
	`R0
(
c
,
d
,
e
,
a
,
b
, 8); R0(b,c,d,e,a, 9); R0(a,b,c,d,e,10); R0(e,a,b,c,d,11);

81 
	`R0
(
d
,
e
,
a
,
b
,
c
,12); R0(c,d,e,a,b,13); R0(b,c,d,e,a,14); R0(a,b,c,d,e,15);

82 
	`R1
(
e
,
a
,
b
,
c
,
d
,16); R1(d,e,a,b,c,17); R1(c,d,e,a,b,18); R1(b,c,d,e,a,19);

83 
	`R2
(
a
,
b
,
c
,
d
,
e
,20); R2(e,a,b,c,d,21); R2(d,e,a,b,c,22); R2(c,d,e,a,b,23);

84 
	`R2
(
b
,
c
,
d
,
e
,
a
,24); R2(a,b,c,d,e,25); R2(e,a,b,c,d,26); R2(d,e,a,b,c,27);

85 
	`R2
(
c
,
d
,
e
,
a
,
b
,28); R2(b,c,d,e,a,29); R2(a,b,c,d,e,30); R2(e,a,b,c,d,31);

86 
	`R2
(
d
,
e
,
a
,
b
,
c
,32); R2(c,d,e,a,b,33); R2(b,c,d,e,a,34); R2(a,b,c,d,e,35);

87 
	`R2
(
e
,
a
,
b
,
c
,
d
,36); R2(d,e,a,b,c,37); R2(c,d,e,a,b,38); R2(b,c,d,e,a,39);

88 
	`R3
(
a
,
b
,
c
,
d
,
e
,40); R3(e,a,b,c,d,41); R3(d,e,a,b,c,42); R3(c,d,e,a,b,43);

89 
	`R3
(
b
,
c
,
d
,
e
,
a
,44); R3(a,b,c,d,e,45); R3(e,a,b,c,d,46); R3(d,e,a,b,c,47);

90 
	`R3
(
c
,
d
,
e
,
a
,
b
,48); R3(b,c,d,e,a,49); R3(a,b,c,d,e,50); R3(e,a,b,c,d,51);

91 
	`R3
(
d
,
e
,
a
,
b
,
c
,52); R3(c,d,e,a,b,53); R3(b,c,d,e,a,54); R3(a,b,c,d,e,55);

92 
	`R3
(
e
,
a
,
b
,
c
,
d
,56); R3(d,e,a,b,c,57); R3(c,d,e,a,b,58); R3(b,c,d,e,a,59);

93 
	`R4
(
a
,
b
,
c
,
d
,
e
,60); R4(e,a,b,c,d,61); R4(d,e,a,b,c,62); R4(c,d,e,a,b,63);

94 
	`R4
(
b
,
c
,
d
,
e
,
a
,64); R4(a,b,c,d,e,65); R4(e,a,b,c,d,66); R4(d,e,a,b,c,67);

95 
	`R4
(
c
,
d
,
e
,
a
,
b
,68); R4(b,c,d,e,a,69); R4(a,b,c,d,e,70); R4(e,a,b,c,d,71);

96 
	`R4
(
d
,
e
,
a
,
b
,
c
,72); R4(c,d,e,a,b,73); R4(b,c,d,e,a,74); R4(a,b,c,d,e,75);

97 
	`R4
(
e
,
a
,
b
,
c
,
d
,76); R4(d,e,a,b,c,77); R4(c,d,e,a,b,78); R4(b,c,d,e,a,79);

99 
¡©e
[0] +ğ
a
;

100 
¡©e
[1] +ğ
b
;

101 
¡©e
[2] +ğ
c
;

102 
¡©e
[3] +ğ
d
;

103 
¡©e
[4] +ğ
e
;

105 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

106 #ifdeà
SHA1HANDSOFF


107 
	`mem£t
(
block
, '\0', (block));

109 
	}
}

114 
	$SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
)

117 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

118 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

119 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

120 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

121 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

122 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

123 
	}
}

128 
	$SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
)

130 
ušt32_t
 
i
, 
j
;

132 
j
 = 
cÚ‹xt
->
couÁ
[0];

133 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3è< 
j
)

134 
cÚ‹xt
->
couÁ
[1]++;

135 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
>>29);

136 
j
 = (j >> 3) & 63;

137 ià((
j
 + 
Ën
) > 63) {

138 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64-j));

139 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

140  ; 
i
 + 63 < 
Ën
; i += 64) {

141 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, &
d©a
[
i
]);

143 
j
 = 0;

145 
i
 = 0;

146 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

147 
	}
}

152 
	$SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
)

154 
i
;

155 
fš®couÁ
[8];

156 
c
;

164 *
fı
 = &
fš®couÁ
[8];

166 
i
 = 0; i < 2; i++)

168 
ušt32_t
 
t
 = 
cÚ‹xt
->
couÁ
[
i
];

169 
j
;

171 
j
 = 0; j < 4; 
t
 >>= 8, j++)

172 *--
fı
 = (è
t
;

175 
i
 = 0; i < 8; i++) {

176 
fš®couÁ
[
i
] = ()((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)]

177 >> ((3-(
i
 & 3)) * 8) ) & 255);

180 
c
 = 0200;

181 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

182 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

183 
c
 = 0000;

184 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

186 
	`SHA1Upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

187 
i
 = 0; i < 20; i++) {

188 
dige¡
[
i
] = ()

189 ((
cÚ‹xt
->
¡©e
[
i
>>2] >> ((3-(i & 3)) * 8) ) & 255);

192 
	`mem£t
(
cÚ‹xt
, '\0', (*context));

193 
	`mem£t
(&
fš®couÁ
, '\0', (finalcount));

194 
	}
}

	@dep/dhashkit/dsha1.c

22 
	#SHA1HANDSOFF


	)

24 
	~<¡dio.h
>

25 
	~<¡ršg.h
>

26 
	~<¡dšt.h
>

28 
	~<dhashk™.h
>

30 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

34 #ifdeà
VR_LITTLE_ENDIAN


35 
	#blk0
(
i
è(
block
->
l
[i] = (
	`rŞ
(block->l[i],24)&0xFF00FF00) \

36 |(
	`rŞ
(
block
->
l
[
i
],8)&0x00FF00FF))

	)

38 
	#blk0
(
i
è
block
->
l
[i]

	)

40 
	#blk
(
i
è(
block
->
l
[i&15] = 
	`rŞ
(block->l[(i+13)&15]^block->l[(i+8)&15] \

41 ^
block
->
l
[(
i
+2)&15]^block->l[i&15],1))

	)

44 
	#R0
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk0
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

45 
	#R1
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

46 
	#R2
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0x6ED9EBA1+
	`rŞ
(v,5);wôŞ(w,30);

	)

47 
	#R3
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(((w|x)&y)|(w&x))+
	`blk
(i)+0x8F1BBCDC+
	`rŞ
(v,5);wôŞ(w,30);

	)

48 
	#R4
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0xCA62C1D6+
	`rŞ
(v,5);wôŞ(w,30);

	)

53 
	$SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64])

55 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

57 
c
[64];

58 
ušt32_t
 
l
[16];

59 } 
	tCHAR64LONG16
;

60 #ifdeà
SHA1HANDSOFF


61 
CHAR64LONG16
 
block
[1];

62 
	`memıy
(
block
, 
bufãr
, 64);

69 
CHAR64LONG16
* 
block
 = (cÚ¡ CHAR64LONG16*)
bufãr
;

72 
a
 = 
¡©e
[0];

73 
b
 = 
¡©e
[1];

74 
c
 = 
¡©e
[2];

75 
d
 = 
¡©e
[3];

76 
e
 = 
¡©e
[4];

78 
	`R0
(
a
,
b
,
c
,
d
,
e
, 0); R0(e,a,b,c,d, 1); R0(d,e,a,b,c, 2); R0(c,d,e,a,b, 3);

79 
	`R0
(
b
,
c
,
d
,
e
,
a
, 4); R0(a,b,c,d,e, 5); R0(e,a,b,c,d, 6); R0(d,e,a,b,c, 7);

80 
	`R0
(
c
,
d
,
e
,
a
,
b
, 8); R0(b,c,d,e,a, 9); R0(a,b,c,d,e,10); R0(e,a,b,c,d,11);

81 
	`R0
(
d
,
e
,
a
,
b
,
c
,12); R0(c,d,e,a,b,13); R0(b,c,d,e,a,14); R0(a,b,c,d,e,15);

82 
	`R1
(
e
,
a
,
b
,
c
,
d
,16); R1(d,e,a,b,c,17); R1(c,d,e,a,b,18); R1(b,c,d,e,a,19);

83 
	`R2
(
a
,
b
,
c
,
d
,
e
,20); R2(e,a,b,c,d,21); R2(d,e,a,b,c,22); R2(c,d,e,a,b,23);

84 
	`R2
(
b
,
c
,
d
,
e
,
a
,24); R2(a,b,c,d,e,25); R2(e,a,b,c,d,26); R2(d,e,a,b,c,27);

85 
	`R2
(
c
,
d
,
e
,
a
,
b
,28); R2(b,c,d,e,a,29); R2(a,b,c,d,e,30); R2(e,a,b,c,d,31);

86 
	`R2
(
d
,
e
,
a
,
b
,
c
,32); R2(c,d,e,a,b,33); R2(b,c,d,e,a,34); R2(a,b,c,d,e,35);

87 
	`R2
(
e
,
a
,
b
,
c
,
d
,36); R2(d,e,a,b,c,37); R2(c,d,e,a,b,38); R2(b,c,d,e,a,39);

88 
	`R3
(
a
,
b
,
c
,
d
,
e
,40); R3(e,a,b,c,d,41); R3(d,e,a,b,c,42); R3(c,d,e,a,b,43);

89 
	`R3
(
b
,
c
,
d
,
e
,
a
,44); R3(a,b,c,d,e,45); R3(e,a,b,c,d,46); R3(d,e,a,b,c,47);

90 
	`R3
(
c
,
d
,
e
,
a
,
b
,48); R3(b,c,d,e,a,49); R3(a,b,c,d,e,50); R3(e,a,b,c,d,51);

91 
	`R3
(
d
,
e
,
a
,
b
,
c
,52); R3(c,d,e,a,b,53); R3(b,c,d,e,a,54); R3(a,b,c,d,e,55);

92 
	`R3
(
e
,
a
,
b
,
c
,
d
,56); R3(d,e,a,b,c,57); R3(c,d,e,a,b,58); R3(b,c,d,e,a,59);

93 
	`R4
(
a
,
b
,
c
,
d
,
e
,60); R4(e,a,b,c,d,61); R4(d,e,a,b,c,62); R4(c,d,e,a,b,63);

94 
	`R4
(
b
,
c
,
d
,
e
,
a
,64); R4(a,b,c,d,e,65); R4(e,a,b,c,d,66); R4(d,e,a,b,c,67);

95 
	`R4
(
c
,
d
,
e
,
a
,
b
,68); R4(b,c,d,e,a,69); R4(a,b,c,d,e,70); R4(e,a,b,c,d,71);

96 
	`R4
(
d
,
e
,
a
,
b
,
c
,72); R4(c,d,e,a,b,73); R4(b,c,d,e,a,74); R4(a,b,c,d,e,75);

97 
	`R4
(
e
,
a
,
b
,
c
,
d
,76); R4(d,e,a,b,c,77); R4(c,d,e,a,b,78); R4(b,c,d,e,a,79);

99 
¡©e
[0] +ğ
a
;

100 
¡©e
[1] +ğ
b
;

101 
¡©e
[2] +ğ
c
;

102 
¡©e
[3] +ğ
d
;

103 
¡©e
[4] +ğ
e
;

105 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

106 #ifdeà
SHA1HANDSOFF


107 
	`mem£t
(
block
, '\0', (block));

109 
	}
}

114 
	$SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
)

117 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

118 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

119 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

120 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

121 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

122 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

123 
	}
}

128 
	$SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
)

130 
ušt32_t
 
i
, 
j
;

132 
j
 = 
cÚ‹xt
->
couÁ
[0];

133 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3è< 
j
)

134 
cÚ‹xt
->
couÁ
[1]++;

135 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
>>29);

136 
j
 = (j >> 3) & 63;

137 ià((
j
 + 
Ën
) > 63) {

138 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64-j));

139 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

140  ; 
i
 + 63 < 
Ën
; i += 64) {

141 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, &
d©a
[
i
]);

143 
j
 = 0;

145 
i
 = 0;

146 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

147 
	}
}

152 
	$SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
)

154 
i
;

155 
fš®couÁ
[8];

156 
c
;

164 *
fı
 = &
fš®couÁ
[8];

166 
i
 = 0; i < 2; i++)

168 
ušt32_t
 
t
 = 
cÚ‹xt
->
couÁ
[
i
];

169 
j
;

171 
j
 = 0; j < 4; 
t
 >>= 8, j++)

172 *--
fı
 = (è
t
;

175 
i
 = 0; i < 8; i++) {

176 
fš®couÁ
[
i
] = ()((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)]

177 >> ((3-(
i
 & 3)) * 8) ) & 255);

180 
c
 = 0200;

181 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

182 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

183 
c
 = 0000;

184 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

186 
	`SHA1Upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

187 
i
 = 0; i < 20; i++) {

188 
dige¡
[
i
] = ()

189 ((
cÚ‹xt
->
¡©e
[
i
>>2] >> ((3-(i & 3)) * 8) ) & 255);

192 
	`mem£t
(
cÚ‹xt
, '\0', (*context));

193 
	`mem£t
(&
fš®couÁ
, '\0', (finalcount));

194 
	}
}

	@dep/dlist/dlist.c

1 
	~<¡dlib.h
>

3 
	~<dm®loc.h
>

5 
	~<dli¡.h
>

13 
dli¡
 *
	$dli¡C»©e
()

15 
dli¡
 *
li¡
;

17 ià((
li¡
 = 
	`d®loc
((*li¡))è=ğ
NULL
)

18  
NULL
;

19 
li¡
->
h—d
 =†i¡->

 = 
NULL
;

20 
li¡
->
Ën
 = 0;

21 
li¡
->
dup
 = 
NULL
;

22 
li¡
->
ä“
 = 
NULL
;

23 
li¡
->
m©ch
 = 
NULL
;

24  
li¡
;

25 
	}
}

31 
	$dli¡R–—£
(
dli¡
 *
li¡
)

33 
Ën
;

34 
dli¡Node
 *
cu¼’t
, *
Ãxt
;

36 
cu¼’t
 = 
li¡
->
h—d
;

37 
Ën
 = 
li¡
->len;

38 
Ën
--) {

39 
Ãxt
 = 
cu¼’t
->next;

40 ià(
li¡
->
ä“
èli¡->
	`ä“
(
cu¼’t
->
v®ue
);

41 
	`dä“
(
cu¼’t
);

42 
cu¼’t
 = 
Ãxt
;

44 
	`dä“
(
li¡
);

45 
	}
}

54 
dli¡
 *
	$dli¡AddNodeH—d
(
dli¡
 *
li¡
, *
v®ue
)

56 
dli¡Node
 *
node
;

58 ià((
node
 = 
	`d®loc
((*node))è=ğ
NULL
)

59  
NULL
;

60 
node
->
v®ue
 = value;

61 ià(
li¡
->
Ën
 == 0) {

62 
li¡
->
h—d
 =†i¡->

 = 
node
;

63 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

65 
node
->
´ev
 = 
NULL
;

66 
node
->
Ãxt
 = 
li¡
->
h—d
;

67 
li¡
->
h—d
->
´ev
 = 
node
;

68 
li¡
->
h—d
 = 
node
;

70 
li¡
->
Ën
++;

71  
li¡
;

72 
	}
}

81 
dli¡
 *
	$dli¡AddNodeTa
(
dli¡
 *
li¡
, *
v®ue
)

83 
dli¡Node
 *
node
;

85 ià((
node
 = 
	`d®loc
((*node))è=ğ
NULL
)

86  
NULL
;

87 
node
->
v®ue
 = value;

88 ià(
li¡
->
Ën
 == 0) {

89 
li¡
->
h—d
 =†i¡->

 = 
node
;

90 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

92 
node
->
´ev
 = 
li¡
->

;

93 
node
->
Ãxt
 = 
NULL
;

94 
li¡
->

->
Ãxt
 = 
node
;

95 
li¡
->

 = 
node
;

97 
li¡
->
Ën
++;

98  
li¡
;

99 
	}
}

101 
dli¡
 *
	$dli¡In£¹Node
(
dli¡
 *
li¡
, 
dli¡Node
 *
Şd_node
, *
v®ue
, 
aá”
) {

102 
dli¡Node
 *
node
;

104 ià((
node
 = 
	`d®loc
((*node))è=ğ
NULL
)

105  
NULL
;

106 
node
->
v®ue
 = value;

107 ià(
aá”
) {

108 
node
->
´ev
 = 
Şd_node
;

109 
node
->
Ãxt
 = 
Şd_node
->next;

110 ià(
li¡
->

 =ğ
Şd_node
) {

111 
li¡
->

 = 
node
;

114 
node
->
Ãxt
 = 
Şd_node
;

115 
node
->
´ev
 = 
Şd_node
->prev;

116 ià(
li¡
->
h—d
 =ğ
Şd_node
) {

117 
li¡
->
h—d
 = 
node
;

120 ià(
node
->
´ev
 !ğ
NULL
) {

121 
node
->
´ev
->
Ãxt
 =‚ode;

123 ià(
node
->
Ãxt
 !ğ
NULL
) {

124 
node
->
Ãxt
->
´ev
 =‚ode;

126 
li¡
->
Ën
++;

127  
li¡
;

128 
	}
}

135 
	$dli¡D–Node
(
dli¡
 *
li¡
, 
dli¡Node
 *
node
)

137 ià(
node
->
´ev
)

138 
node
->
´ev
->
Ãxt
 =‚ode->next;

140 
li¡
->
h—d
 = 
node
->
Ãxt
;

141 ià(
node
->
Ãxt
)

142 
node
->
Ãxt
->
´ev
 =‚ode->prev;

144 
li¡
->

 = 
node
->
´ev
;

145 ià(
li¡
->
ä“
èli¡->
	`ä“
(
node
->
v®ue
);

146 
	`dä“
(
node
);

147 
li¡
->
Ën
--;

148 
	}
}

155 
dli¡I‹r
 *
	$dli¡G‘I‹¿tÜ
(
dli¡
 *
li¡
, 
dœeùiÚ
)

157 
dli¡I‹r
 *
™”
;

159 ià((
™”
 = 
	`d®loc
((*™”))è=ğ
NULL
)  NULL;

160 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
)

161 
™”
->
Ãxt
 = 
li¡
->
h—d
;

163 
™”
->
Ãxt
 = 
li¡
->

;

164 
™”
->
dœeùiÚ
 = direction;

165  
™”
;

166 
	}
}

170 
	$dli¡R–—£I‹¿tÜ
(
dli¡I‹r
 *
™”
) {

171 
	`dä“
(
™”
);

172 
	}
}

176 
	$dli¡Rewšd
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
) {

177 
li
->
Ãxt
 = 
li¡
->
h—d
;

178 
li
->
dœeùiÚ
 = 
AL_START_HEAD
;

179 
	}
}

181 
	$dli¡RewšdTa
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
) {

182 
li
->
Ãxt
 = 
li¡
->

;

183 
li
->
dœeùiÚ
 = 
AL_START_TAIL
;

184 
	}
}

201 
dli¡Node
 *
	$dli¡Next
(
dli¡I‹r
 *
™”
)

203 
dli¡Node
 *
cu¼’t
 = 
™”
->
Ãxt
;

205 ià(
cu¼’t
 !ğ
NULL
) {

206 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
)

207 
™”
->
Ãxt
 = 
cu¼’t
->next;

209 
™”
->
Ãxt
 = 
cu¼’t
->
´ev
;

211  
cu¼’t
;

212 
	}
}

223 
dli¡
 *
	$dli¡Dup
(
dli¡
 *
Üig
)

225 
dli¡
 *
cİy
;

226 
dli¡I‹r
 
™”
;

227 
dli¡Node
 *
node
;

229 ià((
cİy
 = 
	`dli¡C»©e
()è=ğ
NULL
)

230  
NULL
;

231 
cİy
->
dup
 = 
Üig
->dup;

232 
cİy
->
ä“
 = 
Üig
->free;

233 
cİy
->
m©ch
 = 
Üig
->match;

234 
	`dli¡Rewšd
(
Üig
, &
™”
);

235 (
node
 = 
	`dli¡Next
(&
™”
)è!ğ
NULL
) {

236 *
v®ue
;

238 ià(
cİy
->
dup
) {

239 
v®ue
 = 
cİy
->
	`dup
(
node
->value);

240 ià(
v®ue
 =ğ
NULL
) {

241 
	`dli¡R–—£
(
cİy
);

242  
NULL
;

245 
v®ue
 = 
node
->value;

246 ià(
	`dli¡AddNodeTa
(
cİy
, 
v®ue
è=ğ
NULL
) {

247 
	`dli¡R–—£
(
cİy
);

248  
NULL
;

251  
cİy
;

252 
	}
}

264 
dli¡Node
 *
	$dli¡S—rchKey
(
dli¡
 *
li¡
, *
key
)

266 
dli¡I‹r
 
™”
;

267 
dli¡Node
 *
node
;

269 
	`dli¡Rewšd
(
li¡
, &
™”
);

270 (
node
 = 
	`dli¡Next
(&
™”
)è!ğ
NULL
) {

271 ià(
li¡
->
m©ch
) {

272 ià(
li¡
->
	`m©ch
(
node
->
v®ue
, 
key
)) {

273  
node
;

276 ià(
key
 =ğ
node
->
v®ue
) {

277  
node
;

281  
NULL
;

282 
	}
}

290 
dli¡Node
 *
	$dli¡Index
(
dli¡
 *
li¡
, 
šdex
) {

291 
dli¡Node
 *
n
;

293 ià(
šdex
 < 0) {

294 
šdex
 = (-index)-1;

295 
n
 = 
li¡
->

;

296 
šdex
-- && 
n
èÀğn->
´ev
;

298 
n
 = 
li¡
->
h—d
;

299 
šdex
-- && 
n
èÀğn->
Ãxt
;

301  
n
;

302 
	}
}

306 
	$dli¡RÙ©e
(
dli¡
 *
li¡
) {

307 
dli¡Node
 *

 = 
li¡
->tail;

309 ià(
	`dli¡L’gth
(
li¡
) <= 1) ;

312 
li¡
->

 =a->
´ev
;

313 
li¡
->

->
Ãxt
 = 
NULL
;

315 
li¡
->
h—d
->
´ev
 = 

;

316 

->
´ev
 = 
NULL
;

317 

->
Ãxt
 = 
li¡
->
h—d
;

318 
li¡
->
h—d
 = 

;

319 
	}
}

322 
dli¡
 *
	$dli¡Push
(
dli¡
 *
li¡
, *
v®ue
) {

323 
	`dli¡AddNodeTa
(
li¡
, 
v®ue
);

324  
li¡
;

325 
	}
}

328 *
	$dli¡Pİ
(
dli¡
 *
li¡
) {

329 
dli¡Node
 *
node
;

330 *
v®ue
;

332 
node
 = 
	`dli¡Fœ¡
(
li¡
);

333 ià(
node
 =ğ
NULL
) {

334  
NULL
;

337 
v®ue
 = 
	`dli¡NodeV®ue
(
node
);

338 
	`dli¡D–Node
(
li¡
, 
node
);

340 ià(
li¡
->
ä“
è 
NULL
;

342  
v®ue
;

343 
	}
}

	@dep/dlist/dlist.c

1 
	~<¡dlib.h
>

3 
	~<dm®loc.h
>

5 
	~<dli¡.h
>

13 
dli¡
 *
	$dli¡C»©e
()

15 
dli¡
 *
li¡
;

17 ià((
li¡
 = 
	`d®loc
((*li¡))è=ğ
NULL
)

18  
NULL
;

19 
li¡
->
h—d
 =†i¡->

 = 
NULL
;

20 
li¡
->
Ën
 = 0;

21 
li¡
->
dup
 = 
NULL
;

22 
li¡
->
ä“
 = 
NULL
;

23 
li¡
->
m©ch
 = 
NULL
;

24  
li¡
;

25 
	}
}

31 
	$dli¡R–—£
(
dli¡
 *
li¡
)

33 
Ën
;

34 
dli¡Node
 *
cu¼’t
, *
Ãxt
;

36 
cu¼’t
 = 
li¡
->
h—d
;

37 
Ën
 = 
li¡
->len;

38 
Ën
--) {

39 
Ãxt
 = 
cu¼’t
->next;

40 ià(
li¡
->
ä“
èli¡->
	`ä“
(
cu¼’t
->
v®ue
);

41 
	`dä“
(
cu¼’t
);

42 
cu¼’t
 = 
Ãxt
;

44 
	`dä“
(
li¡
);

45 
	}
}

54 
dli¡
 *
	$dli¡AddNodeH—d
(
dli¡
 *
li¡
, *
v®ue
)

56 
dli¡Node
 *
node
;

58 ià((
node
 = 
	`d®loc
((*node))è=ğ
NULL
)

59  
NULL
;

60 
node
->
v®ue
 = value;

61 ià(
li¡
->
Ën
 == 0) {

62 
li¡
->
h—d
 =†i¡->

 = 
node
;

63 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

65 
node
->
´ev
 = 
NULL
;

66 
node
->
Ãxt
 = 
li¡
->
h—d
;

67 
li¡
->
h—d
->
´ev
 = 
node
;

68 
li¡
->
h—d
 = 
node
;

70 
li¡
->
Ën
++;

71  
li¡
;

72 
	}
}

81 
dli¡
 *
	$dli¡AddNodeTa
(
dli¡
 *
li¡
, *
v®ue
)

83 
dli¡Node
 *
node
;

85 ià((
node
 = 
	`d®loc
((*node))è=ğ
NULL
)

86  
NULL
;

87 
node
->
v®ue
 = value;

88 ià(
li¡
->
Ën
 == 0) {

89 
li¡
->
h—d
 =†i¡->

 = 
node
;

90 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

92 
node
->
´ev
 = 
li¡
->

;

93 
node
->
Ãxt
 = 
NULL
;

94 
li¡
->

->
Ãxt
 = 
node
;

95 
li¡
->

 = 
node
;

97 
li¡
->
Ën
++;

98  
li¡
;

99 
	}
}

101 
dli¡
 *
	$dli¡In£¹Node
(
dli¡
 *
li¡
, 
dli¡Node
 *
Şd_node
, *
v®ue
, 
aá”
) {

102 
dli¡Node
 *
node
;

104 ià((
node
 = 
	`d®loc
((*node))è=ğ
NULL
)

105  
NULL
;

106 
node
->
v®ue
 = value;

107 ià(
aá”
) {

108 
node
->
´ev
 = 
Şd_node
;

109 
node
->
Ãxt
 = 
Şd_node
->next;

110 ià(
li¡
->

 =ğ
Şd_node
) {

111 
li¡
->

 = 
node
;

114 
node
->
Ãxt
 = 
Şd_node
;

115 
node
->
´ev
 = 
Şd_node
->prev;

116 ià(
li¡
->
h—d
 =ğ
Şd_node
) {

117 
li¡
->
h—d
 = 
node
;

120 ià(
node
->
´ev
 !ğ
NULL
) {

121 
node
->
´ev
->
Ãxt
 =‚ode;

123 ià(
node
->
Ãxt
 !ğ
NULL
) {

124 
node
->
Ãxt
->
´ev
 =‚ode;

126 
li¡
->
Ën
++;

127  
li¡
;

128 
	}
}

135 
	$dli¡D–Node
(
dli¡
 *
li¡
, 
dli¡Node
 *
node
)

137 ià(
node
->
´ev
)

138 
node
->
´ev
->
Ãxt
 =‚ode->next;

140 
li¡
->
h—d
 = 
node
->
Ãxt
;

141 ià(
node
->
Ãxt
)

142 
node
->
Ãxt
->
´ev
 =‚ode->prev;

144 
li¡
->

 = 
node
->
´ev
;

145 ià(
li¡
->
ä“
èli¡->
	`ä“
(
node
->
v®ue
);

146 
	`dä“
(
node
);

147 
li¡
->
Ën
--;

148 
	}
}

155 
dli¡I‹r
 *
	$dli¡G‘I‹¿tÜ
(
dli¡
 *
li¡
, 
dœeùiÚ
)

157 
dli¡I‹r
 *
™”
;

159 ià((
™”
 = 
	`d®loc
((*™”))è=ğ
NULL
)  NULL;

160 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
)

161 
™”
->
Ãxt
 = 
li¡
->
h—d
;

163 
™”
->
Ãxt
 = 
li¡
->

;

164 
™”
->
dœeùiÚ
 = direction;

165  
™”
;

166 
	}
}

170 
	$dli¡R–—£I‹¿tÜ
(
dli¡I‹r
 *
™”
) {

171 
	`dä“
(
™”
);

172 
	}
}

176 
	$dli¡Rewšd
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
) {

177 
li
->
Ãxt
 = 
li¡
->
h—d
;

178 
li
->
dœeùiÚ
 = 
AL_START_HEAD
;

179 
	}
}

181 
	$dli¡RewšdTa
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
) {

182 
li
->
Ãxt
 = 
li¡
->

;

183 
li
->
dœeùiÚ
 = 
AL_START_TAIL
;

184 
	}
}

201 
dli¡Node
 *
	$dli¡Next
(
dli¡I‹r
 *
™”
)

203 
dli¡Node
 *
cu¼’t
 = 
™”
->
Ãxt
;

205 ià(
cu¼’t
 !ğ
NULL
) {

206 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
)

207 
™”
->
Ãxt
 = 
cu¼’t
->next;

209 
™”
->
Ãxt
 = 
cu¼’t
->
´ev
;

211  
cu¼’t
;

212 
	}
}

223 
dli¡
 *
	$dli¡Dup
(
dli¡
 *
Üig
)

225 
dli¡
 *
cİy
;

226 
dli¡I‹r
 
™”
;

227 
dli¡Node
 *
node
;

229 ià((
cİy
 = 
	`dli¡C»©e
()è=ğ
NULL
)

230  
NULL
;

231 
cİy
->
dup
 = 
Üig
->dup;

232 
cİy
->
ä“
 = 
Üig
->free;

233 
cİy
->
m©ch
 = 
Üig
->match;

234 
	`dli¡Rewšd
(
Üig
, &
™”
);

235 (
node
 = 
	`dli¡Next
(&
™”
)è!ğ
NULL
) {

236 *
v®ue
;

238 ià(
cİy
->
dup
) {

239 
v®ue
 = 
cİy
->
	`dup
(
node
->value);

240 ià(
v®ue
 =ğ
NULL
) {

241 
	`dli¡R–—£
(
cİy
);

242  
NULL
;

245 
v®ue
 = 
node
->value;

246 ià(
	`dli¡AddNodeTa
(
cİy
, 
v®ue
è=ğ
NULL
) {

247 
	`dli¡R–—£
(
cİy
);

248  
NULL
;

251  
cİy
;

252 
	}
}

264 
dli¡Node
 *
	$dli¡S—rchKey
(
dli¡
 *
li¡
, *
key
)

266 
dli¡I‹r
 
™”
;

267 
dli¡Node
 *
node
;

269 
	`dli¡Rewšd
(
li¡
, &
™”
);

270 (
node
 = 
	`dli¡Next
(&
™”
)è!ğ
NULL
) {

271 ià(
li¡
->
m©ch
) {

272 ià(
li¡
->
	`m©ch
(
node
->
v®ue
, 
key
)) {

273  
node
;

276 ià(
key
 =ğ
node
->
v®ue
) {

277  
node
;

281  
NULL
;

282 
	}
}

290 
dli¡Node
 *
	$dli¡Index
(
dli¡
 *
li¡
, 
šdex
) {

291 
dli¡Node
 *
n
;

293 ià(
šdex
 < 0) {

294 
šdex
 = (-index)-1;

295 
n
 = 
li¡
->

;

296 
šdex
-- && 
n
èÀğn->
´ev
;

298 
n
 = 
li¡
->
h—d
;

299 
šdex
-- && 
n
èÀğn->
Ãxt
;

301  
n
;

302 
	}
}

306 
	$dli¡RÙ©e
(
dli¡
 *
li¡
) {

307 
dli¡Node
 *

 = 
li¡
->tail;

309 ià(
	`dli¡L’gth
(
li¡
) <= 1) ;

312 
li¡
->

 =a->
´ev
;

313 
li¡
->

->
Ãxt
 = 
NULL
;

315 
li¡
->
h—d
->
´ev
 = 

;

316 

->
´ev
 = 
NULL
;

317 

->
Ãxt
 = 
li¡
->
h—d
;

318 
li¡
->
h—d
 = 

;

319 
	}
}

322 
dli¡
 *
	$dli¡Push
(
dli¡
 *
li¡
, *
v®ue
) {

323 
	`dli¡AddNodeTa
(
li¡
, 
v®ue
);

324  
li¡
;

325 
	}
}

328 *
	$dli¡Pİ
(
dli¡
 *
li¡
) {

329 
dli¡Node
 *
node
;

330 *
v®ue
;

332 
node
 = 
	`dli¡Fœ¡
(
li¡
);

333 ià(
node
 =ğ
NULL
) {

334  
NULL
;

337 
v®ue
 = 
	`dli¡NodeV®ue
(
node
);

338 
	`dli¡D–Node
(
li¡
, 
node
);

340 ià(
li¡
->
ä“
è 
NULL
;

342  
v®ue
;

343 
	}
}

	@dep/dlist/dlist.h

1 #iâdeà
_DLIST_H__


2 
	#_DLIST_H__


	)

6 
	sdli¡Node
 {

7 
dli¡Node
 *
	m´ev
;

8 
dli¡Node
 *
	mÃxt
;

9 *
	mv®ue
;

10 } 
	tdli¡Node
;

13 
	sdli¡I‹r
 {

15 
dli¡Node
 *
	mÃxt
;

17 
	mdœeùiÚ
;

18 } 
	tdli¡I‹r
;

20 
	sdli¡
 {

21 
dli¡Node
 *
	mh—d
;

22 
dli¡Node
 *
	m
;

23 *(*
	mdup
)(*
	m±r
);

24 (*
	mä“
)(*
	m±r
);

25 (*
	mm©ch
)(*
	m±r
, *
	mkey
);

26 
	mËn
;

27 } 
	tdli¡
;

31 
	#dli¡L’gth
(
l
è(Ö)->
Ën
)

	)

32 
	#dli¡Fœ¡
(
l
è(Ö)->
h—d
)

	)

33 
	#dli¡La¡
(
l
è(Ö)->

)

	)

34 
	#dli¡P»vNode
(
n
è(Ò)->
´ev
)

	)

35 
	#dli¡NextNode
(
n
è(Ò)->
Ãxt
)

	)

36 
	#dli¡NodeV®ue
(
n
è(Ò)->
v®ue
)

	)

38 
	#dli¡S‘DupM‘hod
(
l
,
m
è(Ö)->
dup
 = (m))

	)

39 
	#dli¡S‘F»eM‘hod
(
l
,
m
è(Ö)->
ä“
 = (m))

	)

40 
	#dli¡S‘M©chM‘hod
(
l
,
m
è(Ö)->
m©ch
 = (m))

	)

42 
	#dli¡G‘DupM‘hod
(
l
è(Ö)->
dup
)

	)

43 
	#dli¡G‘F»e
(
l
è(Ö)->
ä“
)

	)

44 
	#dli¡G‘M©chM‘hod
(
l
è(Ö)->
m©ch
)

	)

47 
dli¡
 *
dli¡C»©e
();

48 
dli¡R–—£
(
dli¡
 *
li¡
);

49 
dli¡
 *
dli¡AddNodeH—d
(dli¡ *
li¡
, *
v®ue
);

50 
dli¡
 *
dli¡AddNodeTa
(dli¡ *
li¡
, *
v®ue
);

51 
dli¡
 *
dli¡In£¹Node
(dli¡ *
li¡
, 
dli¡Node
 *
Şd_node
, *
v®ue
, 
aá”
);

52 
dli¡D–Node
(
dli¡
 *
li¡
, 
dli¡Node
 *
node
);

53 
dli¡I‹r
 *
dli¡G‘I‹¿tÜ
(
dli¡
 *
li¡
, 
dœeùiÚ
);

54 
dli¡Node
 *
dli¡Next
(
dli¡I‹r
 *
™”
);

55 
dli¡R–—£I‹¿tÜ
(
dli¡I‹r
 *
™”
);

56 
dli¡
 *
dli¡Dup
(dli¡ *
Üig
);

57 
dli¡Node
 *
dli¡S—rchKey
(
dli¡
 *
li¡
, *
key
);

58 
dli¡Node
 *
dli¡Index
(
dli¡
 *
li¡
, 
šdex
);

59 
dli¡Rewšd
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
);

60 
dli¡RewšdTa
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
);

61 
dli¡RÙ©e
(
dli¡
 *
li¡
);

62 
dli¡
 *
dli¡Push
(dli¡ *
li¡
, *
v®ue
);

63 *
dli¡Pİ
(
dli¡
 *
li¡
);

66 
	#AL_START_HEAD
 0

	)

67 
	#AL_START_TAIL
 1

	)

	@dep/dlist/dlist.h

1 #iâdeà
_DLIST_H__


2 
	#_DLIST_H__


	)

6 
	sdli¡Node
 {

7 
dli¡Node
 *
	m´ev
;

8 
dli¡Node
 *
	mÃxt
;

9 *
	mv®ue
;

10 } 
	tdli¡Node
;

13 
	sdli¡I‹r
 {

15 
dli¡Node
 *
	mÃxt
;

17 
	mdœeùiÚ
;

18 } 
	tdli¡I‹r
;

20 
	sdli¡
 {

21 
dli¡Node
 *
	mh—d
;

22 
dli¡Node
 *
	m
;

23 *(*
	mdup
)(*
	m±r
);

24 (*
	mä“
)(*
	m±r
);

25 (*
	mm©ch
)(*
	m±r
, *
	mkey
);

26 
	mËn
;

27 } 
	tdli¡
;

31 
	#dli¡L’gth
(
l
è(Ö)->
Ën
)

	)

32 
	#dli¡Fœ¡
(
l
è(Ö)->
h—d
)

	)

33 
	#dli¡La¡
(
l
è(Ö)->

)

	)

34 
	#dli¡P»vNode
(
n
è(Ò)->
´ev
)

	)

35 
	#dli¡NextNode
(
n
è(Ò)->
Ãxt
)

	)

36 
	#dli¡NodeV®ue
(
n
è(Ò)->
v®ue
)

	)

38 
	#dli¡S‘DupM‘hod
(
l
,
m
è(Ö)->
dup
 = (m))

	)

39 
	#dli¡S‘F»eM‘hod
(
l
,
m
è(Ö)->
ä“
 = (m))

	)

40 
	#dli¡S‘M©chM‘hod
(
l
,
m
è(Ö)->
m©ch
 = (m))

	)

42 
	#dli¡G‘DupM‘hod
(
l
è(Ö)->
dup
)

	)

43 
	#dli¡G‘F»e
(
l
è(Ö)->
ä“
)

	)

44 
	#dli¡G‘M©chM‘hod
(
l
è(Ö)->
m©ch
)

	)

47 
dli¡
 *
dli¡C»©e
();

48 
dli¡R–—£
(
dli¡
 *
li¡
);

49 
dli¡
 *
dli¡AddNodeH—d
(dli¡ *
li¡
, *
v®ue
);

50 
dli¡
 *
dli¡AddNodeTa
(dli¡ *
li¡
, *
v®ue
);

51 
dli¡
 *
dli¡In£¹Node
(dli¡ *
li¡
, 
dli¡Node
 *
Şd_node
, *
v®ue
, 
aá”
);

52 
dli¡D–Node
(
dli¡
 *
li¡
, 
dli¡Node
 *
node
);

53 
dli¡I‹r
 *
dli¡G‘I‹¿tÜ
(
dli¡
 *
li¡
, 
dœeùiÚ
);

54 
dli¡Node
 *
dli¡Next
(
dli¡I‹r
 *
™”
);

55 
dli¡R–—£I‹¿tÜ
(
dli¡I‹r
 *
™”
);

56 
dli¡
 *
dli¡Dup
(dli¡ *
Üig
);

57 
dli¡Node
 *
dli¡S—rchKey
(
dli¡
 *
li¡
, *
key
);

58 
dli¡Node
 *
dli¡Index
(
dli¡
 *
li¡
, 
šdex
);

59 
dli¡Rewšd
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
);

60 
dli¡RewšdTa
(
dli¡
 *
li¡
, 
dli¡I‹r
 *
li
);

61 
dli¡RÙ©e
(
dli¡
 *
li¡
);

62 
dli¡
 *
dli¡Push
(dli¡ *
li¡
, *
v®ue
);

63 *
dli¡Pİ
(
dli¡
 *
li¡
);

66 
	#AL_START_HEAD
 0

	)

67 
	#AL_START_TAIL
 1

	)

	@dep/dlist/dlockqueue.c

1 
	~<±h»ad.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dio.h
>

5 
	~<dm®loc.h
>

7 
	~<dli¡.h
>

8 
	~<dmtqueue.h
>

9 
	~<dlockqueue.h
>

11 
dlockqueue
 *
	$dlockqueue_ü—‹
()

13 
dlockqueue
 *
lqueue
;

15 
lqueue
 = 
	`d®loc
((*lqueue));

16 ià(
lqueue
 =ğ
NULL
) {

17  
NULL
;

20 
lqueue
->
maxËn
 = -1;

22 
lqueue
->
maxËn_pŞicy
 = 
MAX_LENGTH_POLICY_REJECT
;

24 
	`±h»ad_mu‹x_š™
(&
lqueue
->
lmu‹x
,
NULL
);

26 
lqueue
->
l
 = 
	`dli¡C»©e
();

27 ià(
lqueue
->
l
 =ğ
NULL
) {

28 
	`dlockqueue_de¡roy
(
lqueue
);

29  
NULL
;

32  
lqueue
;

33 
	}
}

35 
	$dlockqueue_push
(*
q
, *
v®ue
)

37 
dlockqueue
 *
lqueue
 = 
q
;

38 
dli¡
 *
li¡
;

39 
Ëngth
;

41 
	`±h»ad_mu‹x_lock
(&
lqueue
->
lmu‹x
);

42 
Ëngth
 = ()
	`dli¡L’gth
(
lqueue
->
l
);

44 ià(
lqueue
->
maxËn
 >0 && 
Ëngth
 >=†queue->maxlen) {

46 ià(
lqueue
->
maxËn_pŞicy
 =ğ
MAX_LENGTH_POLICY_REJECT
) {

47 
Ëngth
 = -1;

50 } ià(
lqueue
->
maxËn_pŞicy
 =ğ
MAX_LENGTH_POLICY_EVICT_HEAD
) {

51 
Ëngth
 >ğ
lqueue
->
maxËn
) {

52 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
lqueue
->
l
);

53 
	`dli¡D–Node
(
lqueue
->
l
,
Ê
);

54 
Ëngth
 = ()
	`dli¡L’gth
(
lqueue
->
l
);

56 
li¡
 = 
	`dli¡AddNodeTa
(
lqueue
->
l
, 
v®ue
);

57 
Ëngth
 ++;

59 } ià(
lqueue
->
maxËn_pŞicy
 =ğ
MAX_LENGTH_POLICY_EVICT_END
) {

60 
Ëngth
 >ğ
lqueue
->
maxËn
) {

61 
dli¡Node
 *
Ê
 = 
	`dli¡La¡
(
lqueue
->
l
);

62 
	`dli¡D–Node
(
lqueue
->
l
,
Ê
);

63 
Ëngth
 = ()
	`dli¡L’gth
(
lqueue
->
l
);

65 
li¡
 = 
	`dli¡AddNodeTa
(
lqueue
->
l
, 
v®ue
);

66 
Ëngth
 ++;

70 
li¡
 = 
	`dli¡AddNodeTa
(
lqueue
->
l
, 
v®ue
);

71 
Ëngth
 ++;

74 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

76 ià(
li¡
 =ğ
NULL
) {

80  
Ëngth
;

81 
	}
}

83 *
	$dlockqueue_pİ
(*
q
)

85 
dlockqueue
 *
lqueue
 = 
q
;

86 
dli¡Node
 *
node
;

87 *
v®ue
;

89 ià(
lqueue
 =ğ
NULL
 ||†queue->
l
 == NULL) {

90  
NULL
;

93 
	`±h»ad_mu‹x_lock
(&
lqueue
->
lmu‹x
);

95 
node
 = 
	`dli¡Fœ¡
(
lqueue
->
l
);

96 ià(
node
 =ğ
NULL
) {

98 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

99  
NULL
;

102 
v®ue
 = 
	`dli¡NodeV®ue
(
node
);

104 
	`dli¡D–Node
(
lqueue
->
l
, 
node
);

106 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

108  
v®ue
;

109 
	}
}

112 
	$dlockqueue_de¡roy
(*
q
)

114 
dlockqueue
 *
lqueue
 = 
q
;

115 ià(
lqueue
 =ğ
NULL
) {

119 ià(
lqueue
->
l
 !ğ
NULL
) {

120 
	`dli¡R–—£
(
lqueue
->
l
);

123 
	`±h»ad_mu‹x_de¡roy
(&
lqueue
->
lmu‹x
);

125 
	`dä“
(
lqueue
);

126 
	}
}

128 
	$dlockqueue_Ëngth
(*
q
)

130 
dlockqueue
 *
lqueue
 = 
q
;

131 
Ëngth
;

133 ià(
lqueue
 =ğ
NULL
 ||†queue->
l
 == NULL) {

137 
	`±h»ad_mu‹x_lock
(&
lqueue
->
lmu‹x
);

138 
Ëngth
 = 
	`dli¡L’gth
(
lqueue
->
l
);

139 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

141  
Ëngth
;

142 
	}
}

	@dep/dlist/dlockqueue.c

1 
	~<±h»ad.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dio.h
>

5 
	~<dm®loc.h
>

7 
	~<dli¡.h
>

8 
	~<dmtqueue.h
>

9 
	~<dlockqueue.h
>

11 
dlockqueue
 *
	$dlockqueue_ü—‹
()

13 
dlockqueue
 *
lqueue
;

15 
lqueue
 = 
	`d®loc
((*lqueue));

16 ià(
lqueue
 =ğ
NULL
) {

17  
NULL
;

20 
lqueue
->
maxËn
 = -1;

22 
lqueue
->
maxËn_pŞicy
 = 
MAX_LENGTH_POLICY_REJECT
;

24 
	`±h»ad_mu‹x_š™
(&
lqueue
->
lmu‹x
,
NULL
);

26 
lqueue
->
l
 = 
	`dli¡C»©e
();

27 ià(
lqueue
->
l
 =ğ
NULL
) {

28 
	`dlockqueue_de¡roy
(
lqueue
);

29  
NULL
;

32  
lqueue
;

33 
	}
}

35 
	$dlockqueue_push
(*
q
, *
v®ue
)

37 
dlockqueue
 *
lqueue
 = 
q
;

38 
dli¡
 *
li¡
;

39 
Ëngth
;

41 
	`±h»ad_mu‹x_lock
(&
lqueue
->
lmu‹x
);

42 
Ëngth
 = ()
	`dli¡L’gth
(
lqueue
->
l
);

44 ià(
lqueue
->
maxËn
 >0 && 
Ëngth
 >=†queue->maxlen) {

46 ià(
lqueue
->
maxËn_pŞicy
 =ğ
MAX_LENGTH_POLICY_REJECT
) {

47 
Ëngth
 = -1;

50 } ià(
lqueue
->
maxËn_pŞicy
 =ğ
MAX_LENGTH_POLICY_EVICT_HEAD
) {

51 
Ëngth
 >ğ
lqueue
->
maxËn
) {

52 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
lqueue
->
l
);

53 
	`dli¡D–Node
(
lqueue
->
l
,
Ê
);

54 
Ëngth
 = ()
	`dli¡L’gth
(
lqueue
->
l
);

56 
li¡
 = 
	`dli¡AddNodeTa
(
lqueue
->
l
, 
v®ue
);

57 
Ëngth
 ++;

59 } ià(
lqueue
->
maxËn_pŞicy
 =ğ
MAX_LENGTH_POLICY_EVICT_END
) {

60 
Ëngth
 >ğ
lqueue
->
maxËn
) {

61 
dli¡Node
 *
Ê
 = 
	`dli¡La¡
(
lqueue
->
l
);

62 
	`dli¡D–Node
(
lqueue
->
l
,
Ê
);

63 
Ëngth
 = ()
	`dli¡L’gth
(
lqueue
->
l
);

65 
li¡
 = 
	`dli¡AddNodeTa
(
lqueue
->
l
, 
v®ue
);

66 
Ëngth
 ++;

70 
li¡
 = 
	`dli¡AddNodeTa
(
lqueue
->
l
, 
v®ue
);

71 
Ëngth
 ++;

74 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

76 ià(
li¡
 =ğ
NULL
) {

80  
Ëngth
;

81 
	}
}

83 *
	$dlockqueue_pİ
(*
q
)

85 
dlockqueue
 *
lqueue
 = 
q
;

86 
dli¡Node
 *
node
;

87 *
v®ue
;

89 ià(
lqueue
 =ğ
NULL
 ||†queue->
l
 == NULL) {

90  
NULL
;

93 
	`±h»ad_mu‹x_lock
(&
lqueue
->
lmu‹x
);

95 
node
 = 
	`dli¡Fœ¡
(
lqueue
->
l
);

96 ià(
node
 =ğ
NULL
) {

98 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

99  
NULL
;

102 
v®ue
 = 
	`dli¡NodeV®ue
(
node
);

104 
	`dli¡D–Node
(
lqueue
->
l
, 
node
);

106 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

108  
v®ue
;

109 
	}
}

112 
	$dlockqueue_de¡roy
(*
q
)

114 
dlockqueue
 *
lqueue
 = 
q
;

115 ià(
lqueue
 =ğ
NULL
) {

119 ià(
lqueue
->
l
 !ğ
NULL
) {

120 
	`dli¡R–—£
(
lqueue
->
l
);

123 
	`±h»ad_mu‹x_de¡roy
(&
lqueue
->
lmu‹x
);

125 
	`dä“
(
lqueue
);

126 
	}
}

128 
	$dlockqueue_Ëngth
(*
q
)

130 
dlockqueue
 *
lqueue
 = 
q
;

131 
Ëngth
;

133 ià(
lqueue
 =ğ
NULL
 ||†queue->
l
 == NULL) {

137 
	`±h»ad_mu‹x_lock
(&
lqueue
->
lmu‹x
);

138 
Ëngth
 = 
	`dli¡L’gth
(
lqueue
->
l
);

139 
	`±h»ad_mu‹x_uÆock
(&
lqueue
->
lmu‹x
);

141  
Ëngth
;

142 
	}
}

	@dep/dlist/dlockqueue.h

1 #iâdeà
_DLOCKQUEUE_H_


2 
	#_DLOCKQUEUE_H_


	)

4 
	gdli¡
;

6 
	sdlockqueue
{

7 
dli¡
 *
	ml
;

8 
	mmaxËn
;

9 
	mmaxËn_pŞicy
;

10 
±h»ad_mu‹x_t
 
	mlmu‹x
;

11 } 
	tdlockqueue
;

13 
dlockqueue
 *
dlockqueue_ü—‹
();

14 
dlockqueue_push
(*
q
, *
v®ue
);

15 *
dlockqueue_pİ
(*
q
);

16 
dlockqueue_de¡roy
(*
q
);

17 
dlockqueue_Ëngth
(*
q
);

	@dep/dlist/dlockqueue.h

1 #iâdeà
_DLOCKQUEUE_H_


2 
	#_DLOCKQUEUE_H_


	)

4 
	gdli¡
;

6 
	sdlockqueue
{

7 
dli¡
 *
	ml
;

8 
	mmaxËn
;

9 
	mmaxËn_pŞicy
;

10 
±h»ad_mu‹x_t
 
	mlmu‹x
;

11 } 
	tdlockqueue
;

13 
dlockqueue
 *
dlockqueue_ü—‹
();

14 
dlockqueue_push
(*
q
, *
v®ue
);

15 *
dlockqueue_pİ
(*
q
);

16 
dlockqueue_de¡roy
(*
q
);

17 
dlockqueue_Ëngth
(*
q
);

	@dep/dlist/dmtqueue.c

1 
	~<¡dlib.h
>

3 
	~<dm®loc.h
>

5 
	~<dli¡.h
>

6 
	~<dmtqueue.h
>

7 
	~<dlockqueue.h
>

10 
dmtqueue
 *
	$dmtqueue_ü—‹
()

12 
dmtqueue
 *
q
;

14 
q
 = 
	`d®loc
((*q));

15 ià(
q
 =ğ
NULL
) {

16  
NULL
;

19 
q
->
l
 = 
NULL
;

20 
q
->
lock_push
 = 
NULL
;

21 
q
->
lock_pİ
 = 
NULL
;

22 
q
->
de¡roy
 = 
NULL
;

23 
q
->
Ëngth
 = 
NULL
;

25  
q
;

26 
	}
}

28 
	$dmtqueue_de¡roy
(
dmtqueue
 *
q
)

30 ià(
q
 =ğ
NULL
) {

34 ià(
q
->
de¡roy
) {

35 
q
->
	`de¡roy
(q->
l
);

38 
	`dä“
(
q
);

39 
	}
}

41 
	$dmtqueue_push
(
dmtqueue
 *
q
, *
v®ue
)

43 if(
q
 =ğ
NULL
 || q->
l
 == NULL

44 || 
q
->
lock_push
 =ğ
NULL
)

49  
q
->
	`lock_push
(q->
l
, 
v®ue
);

50 
	}
}

52 *
	$dmtqueue_pİ
(
dmtqueue
 *
q
)

54 if(
q
 =ğ
NULL
 || q->
l
 == NULL

55 || 
q
->
lock_pİ
 =ğ
NULL
)

57  
NULL
;

60  
q
->
	`lock_pİ
(q->
l
);

61 
	}
}

63 
	$dmtqueue_em±y
(
dmtqueue
 *
q
)

65 if(
q
 =ğ
NULL
 || q->
l
 == NULL

66 || 
q
->
Ëngth
 =ğ
NULL
)

71 if(
q
->
	`Ëngth
(q->
l
) > 0)

77 
	}
}

79 
	$dmtqueue_Ëngth
(
dmtqueue
 *
q
)

81 if(
q
 =ğ
NULL
 || q->
l
 == NULL

82 || 
q
->
Ëngth
 =ğ
NULL
)

87  
q
->
	`Ëngth
(q->
l
);

88 
	}
}

96 
	$dmtqueue_š™_w™h_lockqueue
(
dmtqueue
 *
q
, 
dlockqueue_ä“func
 
ä“func
)

98 
dlockqueue
 *
lq
;

100 ià(
q
 =ğ
NULL
) {

104 
lq
 = 
	`dlockqueue_ü—‹
();

105 ià(
lq
 =ğ
NULL
) {

109 
lq
->
l
->
ä“
 = 
ä“func
;

111 
q
->
l
 = 
lq
;

112 
q
->
lock_push
 = 
dlockqueue_push
;

113 
q
->
lock_pİ
 = 
dlockqueue_pİ
;

114 
q
->
de¡roy
 = 
dlockqueue_de¡roy
;

115 
q
->
Ëngth
 = 
dlockqueue_Ëngth
;

118 
	}
}

	@dep/dlist/dmtqueue.c

1 
	~<¡dlib.h
>

3 
	~<dm®loc.h
>

5 
	~<dli¡.h
>

6 
	~<dmtqueue.h
>

7 
	~<dlockqueue.h
>

10 
dmtqueue
 *
	$dmtqueue_ü—‹
()

12 
dmtqueue
 *
q
;

14 
q
 = 
	`d®loc
((*q));

15 ià(
q
 =ğ
NULL
) {

16  
NULL
;

19 
q
->
l
 = 
NULL
;

20 
q
->
lock_push
 = 
NULL
;

21 
q
->
lock_pİ
 = 
NULL
;

22 
q
->
de¡roy
 = 
NULL
;

23 
q
->
Ëngth
 = 
NULL
;

25  
q
;

26 
	}
}

28 
	$dmtqueue_de¡roy
(
dmtqueue
 *
q
)

30 ià(
q
 =ğ
NULL
) {

34 ià(
q
->
de¡roy
) {

35 
q
->
	`de¡roy
(q->
l
);

38 
	`dä“
(
q
);

39 
	}
}

41 
	$dmtqueue_push
(
dmtqueue
 *
q
, *
v®ue
)

43 if(
q
 =ğ
NULL
 || q->
l
 == NULL

44 || 
q
->
lock_push
 =ğ
NULL
)

49  
q
->
	`lock_push
(q->
l
, 
v®ue
);

50 
	}
}

52 *
	$dmtqueue_pİ
(
dmtqueue
 *
q
)

54 if(
q
 =ğ
NULL
 || q->
l
 == NULL

55 || 
q
->
lock_pİ
 =ğ
NULL
)

57  
NULL
;

60  
q
->
	`lock_pİ
(q->
l
);

61 
	}
}

63 
	$dmtqueue_em±y
(
dmtqueue
 *
q
)

65 if(
q
 =ğ
NULL
 || q->
l
 == NULL

66 || 
q
->
Ëngth
 =ğ
NULL
)

71 if(
q
->
	`Ëngth
(q->
l
) > 0)

77 
	}
}

79 
	$dmtqueue_Ëngth
(
dmtqueue
 *
q
)

81 if(
q
 =ğ
NULL
 || q->
l
 == NULL

82 || 
q
->
Ëngth
 =ğ
NULL
)

87  
q
->
	`Ëngth
(q->
l
);

88 
	}
}

96 
	$dmtqueue_š™_w™h_lockqueue
(
dmtqueue
 *
q
, 
dlockqueue_ä“func
 
ä“func
)

98 
dlockqueue
 *
lq
;

100 ià(
q
 =ğ
NULL
) {

104 
lq
 = 
	`dlockqueue_ü—‹
();

105 ià(
lq
 =ğ
NULL
) {

109 
lq
->
l
->
ä“
 = 
ä“func
;

111 
q
->
l
 = 
lq
;

112 
q
->
lock_push
 = 
dlockqueue_push
;

113 
q
->
lock_pİ
 = 
dlockqueue_pİ
;

114 
q
->
de¡roy
 = 
dlockqueue_de¡roy
;

115 
q
->
Ëngth
 = 
dlockqueue_Ëngth
;

118 
	}
}

	@dep/dlist/dmtqueue.h

1 #iâdeà
_DMTQUEUE_H_


2 
	#_DMTQUEUE_H_


	)

4 
	#MAX_LENGTH_POLICY_REJECT
 0

	)

5 
	#MAX_LENGTH_POLICY_EVICT_HEAD
 1

	)

6 
	#MAX_LENGTH_POLICY_EVICT_END
 2

	)

10 
	sdmtqueue
{

11 *
	ml
;

12 (*
	mlock_push
)(*
	mq
, *
	mv®ue
);

13 *(*
	mlock_pİ
)(*
	mq
);

14 (*
	mde¡roy
)(*
	mq
);

15 (*
	mËngth
)(*
	mq
);

16 } 
	tdmtqueue
;

18 
	#dmtqueueS‘MaxËngth
(
q
,
l
è((q)->l->
maxËn
 = (l))

	)

19 
	#dmtqueueS‘MaxËngthPŞicy
(
q
,
p
è((q)->
l
->
maxËn
 = (p))

	)

21 (*
	tdmtqueue_š™
)(
	tdmtqueue
 *);

25 
dmtqueue
 *
	`dmtqueue_ü—‹
();

26 
	`dmtqueue_de¡roy
(
dmtqueue
 *
q
);

27 
	`dmtqueue_push
(
dmtqueue
 *
q
, *
v®ue
);

28 *
	`dmtqueue_pİ
(
dmtqueue
 *
q
);

29 
	`dmtqueue_em±y
(
dmtqueue
 *
q
);

30 
	`dmtqueue_Ëngth
(
dmtqueue
 *
q
);

34 (*
	tdlockqueue_ä“func
)(*);

35 
	`dmtqueue_š™_w™h_lockqueue
(
dmtqueue
 *
l
, 
dlockqueue_ä“func
 
ä“func
);

	@dep/dlist/dmtqueue.h

1 #iâdeà
_DMTQUEUE_H_


2 
	#_DMTQUEUE_H_


	)

4 
	#MAX_LENGTH_POLICY_REJECT
 0

	)

5 
	#MAX_LENGTH_POLICY_EVICT_HEAD
 1

	)

6 
	#MAX_LENGTH_POLICY_EVICT_END
 2

	)

10 
	sdmtqueue
{

11 *
	ml
;

12 (*
	mlock_push
)(*
	mq
, *
	mv®ue
);

13 *(*
	mlock_pİ
)(*
	mq
);

14 (*
	mde¡roy
)(*
	mq
);

15 (*
	mËngth
)(*
	mq
);

16 } 
	tdmtqueue
;

18 
	#dmtqueueS‘MaxËngth
(
q
,
l
è((q)->l->
maxËn
 = (l))

	)

19 
	#dmtqueueS‘MaxËngthPŞicy
(
q
,
p
è((q)->
l
->
maxËn
 = (p))

	)

21 (*
	tdmtqueue_š™
)(
	tdmtqueue
 *);

25 
dmtqueue
 *
	`dmtqueue_ü—‹
();

26 
	`dmtqueue_de¡roy
(
dmtqueue
 *
q
);

27 
	`dmtqueue_push
(
dmtqueue
 *
q
, *
v®ue
);

28 *
	`dmtqueue_pİ
(
dmtqueue
 *
q
);

29 
	`dmtqueue_em±y
(
dmtqueue
 *
q
);

30 
	`dmtqueue_Ëngth
(
dmtqueue
 *
q
);

34 (*
	tdlockqueue_ä“func
)(*);

35 
	`dmtqueue_š™_w™h_lockqueue
(
dmtqueue
 *
l
, 
dlockqueue_ä“func
 
ä“func
);

	@dep/dmalloc/dmalloc.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<”ºo.h
>

5 
	~<±h»ad.h
>

7 
	~<uni¡d.h
>

9 
	~<dut.h
>

10 
	~<dlog.h
>

12 
	~<dm®loc.h
>

15 
size_t
 
	gu£d_memÜy
 = 0;

16 
±h»ad_mu‹x_t
 
	gu£d_memÜy_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

18 #ià
defšed
(
__ATOMIC_RELAXED
)

19 
	#upd©e_u£d_mem_¡©_add
(
__n
è
	`__©omic_add_ãtch
(&
u£d_memÜy
, (__n), 
__ATOMIC_RELAXED
)

	)

20 
	#upd©e_u£d_mem_¡©_sub
(
__n
è
	`__©omic_sub_ãtch
(&
u£d_memÜy
, (__n), 
__ATOMIC_RELAXED
)

	)

21 *
	$m®loc_lock_ty³
(è{ "__ATOMIC_RELAXED";
	}
}

22 #–ià
defšed
(
HAVE_ATOMIC
)

23 
	#upd©e_u£d_mem_¡©_add
(
__n
è
	`__sync_add_ªd_ãtch
(&
u£d_memÜy
, (__n))

	)

24 
	#upd©e_u£d_mem_¡©_sub
(
__n
è
	`__sync_sub_ªd_ãtch
(&
u£d_memÜy
, (__n))

	)

25 *
	$m®loc_lock_ty³
(è{ "HAVE_ATOMIC";
	}
}

27 
	#upd©e_u£d_mem_¡©_add
(
__n
) do { \

28 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
); \

29 
u£d_memÜy
 +ğ(
__n
); \

30 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
); \

31 } 0)

	)

33 
	#upd©e_u£d_mem_¡©_sub
(
__n
) do { \

34 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
); \

35 
u£d_memÜy
 -ğ(
__n
); \

36 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
); \

37 } 0)

	)

39 *
	$m®loc_lock_ty³
(è{ "±h»ad_mu‹x_t";
	}
}

42 
	#upd©e_dm®loc_¡©_®loc
(
__n
) do { \

43 
size_t
 
_n
 = (
__n
); \

44 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

45 
	`upd©e_u£d_mem_¡©_add
(
_n
); \

46 } 0)

	)

48 
	#upd©e_dm®loc_¡©_ä“
(
__n
) do { \

49 
size_t
 
_n
 = (
__n
); \

50 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

51 
	`upd©e_u£d_mem_¡©_sub
(
_n
); \

52 } 0)

	)

54 #ifdeà
HAVE_MALLOC_SIZE


55 
	#PREFIX_SIZE
 (0)

	)

57 #ià
defšed
(
__sun
è|| defšed(
__¥¬c
è|| defšed(
__¥¬c__
)

58 
	#PREFIX_SIZE
 (())

	)

60 
	#PREFIX_SIZE
 ((
size_t
))

	)

67 #iâdeà
HAVE_MALLOC_SIZE


68 
size_t
 
	$dm®loc_size
(*
±r
) {

69 *
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

70 
size_t
 
size
 = *((size_t*)
»®±r
);

73 ià(
size
&(()-1)) size += ()-(size&(()-1));

74  
size
+
PREFIX_SIZE
;

75 
	}
}

79 
	$_d®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
)

81 *
p
;

83 
	`ASSERT
(
size
 != 0);

85 #ifdeà
DUSE_JEMALLOC


86 
p
 = 
	`je_m®loc
(
size
+
PREFIX_SIZE
);

88 
p
 = 
	`m®loc
(
size
+
PREFIX_SIZE
);

90 ià(
p
 =ğ
NULL
) {

91 
	`log_”rÜ
("m®loc(%zuèçed @ %s:%d", 
size
, 
Çme
, 
lše
);

93 #ifdeà
HAVE_MALLOC_SIZE


94 
	`upd©e_dm®loc_¡©_®loc
(
	`dm®loc_size
(
p
));

95  
p
;

97 *((
size_t
*)
p
èğ
size
;

98 
	`upd©e_dm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

99  (*)
p
+
PREFIX_SIZE
;

101 
	`log_debug
(
LOG_VVERB
, "m®loc(%zuè© %°@ %s:%d", 
size
, 
p
, 
Çme
, 
lše
);

104  
p
;

105 
	}
}

108 
	$_dz®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
)

110 *
p
;

112 
p
 = 
	`_d®loc
(
size
, 
Çme
, 
lše
);

113 ià(
p
 !ğ
NULL
) {

114 
	`mem£t
(
p
, 0, 
size
);

117  
p
;

118 
	}
}

121 
	$_dÿÎoc
(
size_t
 
nmemb
, size_ˆ
size
, cÚ¡ *
Çme
, 
lše
)

123  
	`_dz®loc
(
nmemb
 * 
size
, 
Çme
, 
lše
);

124 
	}
}

127 
	$_d»®loc
(*
±r
, 
size_t
 
size
, cÚ¡ *
Çme
, 
lše
)

129 #iâdeà
HAVE_MALLOC_SIZE


130 *
»®p
;

132 *
p
;

133 
size_t
 
Şdsize
;

135 
	`ASSERT
(
size
 != 0);

137 ià(
±r
 =ğ
NULL
è 
	`_d®loc
(
size
, 
Çme
, 
lše
);

139 #ifdeà
HAVE_MALLOC_SIZE


140 
Şdsize
 = 
	`dm®loc_size
(
±r
);

141 #ifdeà
DUSE_JEMALLOC


142 
p
 = 
	`je_»®loc
(
±r
, 
size
);

144 
p
 = 
	`»®loc
(
±r
, 
size
);

147 
»®p
 = (*)
±r
-
PREFIX_SIZE
;

148 
Şdsize
 = *((
size_t
*)
»®p
);

149 #ifdeà
DUSE_JEMALLOC


150 
p
 = 
	`je_»®loc
(
±r
, 
size
+
PREFIX_SIZE
);

152 
p
 = 
	`»®loc
(
±r
, 
size
+
PREFIX_SIZE
);

155 ià(
p
 =ğ
NULL
) {

156 
	`log_”rÜ
("»®loc(%zuèçed @ %s:%d", 
size
, 
Çme
, 
lše
);

157  
NULL
;

159 
	`log_debug
(
LOG_VVERB
, "»®loc(%zuè© %°@ %s:%d", 
size
, 
p
, 
Çme
, 
lše
);

160 #ifdeà
HAVE_MALLOC_SIZE


161 
	`upd©e_dm®loc_¡©_ä“
(
Şdsize
);

162 
	`upd©e_dm®loc_¡©_®loc
(
	`dm®loc_size
(
p
));

163  
p
;

165 *((
size_t
*)
p
èğ
size
;

166 
	`upd©e_dm®loc_¡©_ä“
(
Şdsize
);

167 
	`upd©e_dm®loc_¡©_®loc
(
size
);

168  
p
+
PREFIX_SIZE
;

172  
NULL
;

173 
	}
}

176 
	$_dä“
(*
±r
, cÚ¡ *
Çme
, 
lše
)

178 #iâdeà
HAVE_MALLOC_SIZE


179 *
»®p
;

180 
size_t
 
Şdsize
;

183 
	`ASSERT
(
±r
 !ğ
NULL
);

184 
	`log_debug
(
LOG_VVERB
, "ä“(%pè@ %s:%d", 
±r
, 
Çme
, 
lše
);

186 #ifdeà
HAVE_MALLOC_SIZE


187 
	`upd©e_dm®loc_¡©_ä“
(
	`dm®loc_size
(
±r
));

188 #ifdeà
DUSE_JEMALLOC


189 
	`je_ä“
(
±r
);

191 
	`ä“
(
±r
);

194 
»®p
 = (*)
±r
-
PREFIX_SIZE
;

195 
Şdsize
 = *((
size_t
*)
»®p
);

196 
	`upd©e_dm®loc_¡©_ä“
(
Şdsize
+
PREFIX_SIZE
);

197 
	`ä“
(
»®p
);

198 #ifdeà
DUSE_JEMALLOC


199 
	`je_ä“
(
»®p
);

201 
	`ä“
(
»®p
);

204 
	}
}

206 
size_t


207 
	$d®loc_u£d_memÜy
()

209 
size_t
 
um
;

211 #ià
	`defšed
(
__ATOMIC_RELAXED
è|| defšed(
HAVE_ATOMIC
)

212 
um
 = 
	`upd©e_u£d_mem_¡©_add
(0);

214 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
);

215 
um
 = 
u£d_memÜy
;

216 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
);

219  
um
;

220 
	}
}

235 
size_t
 
	$d®loc_g‘_memÜy_size
() {

236 #ià
	`defšed
(
__unix__
è|| defšed(
__unix
è|| defšed(
unix
) || \

237 (
	`defšed
(
__APPLE__
è&& defšed(
__MACH__
))

238 #ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_MEMSIZE
è|| defšed(
HW_PHYSMEM64
))

239 
mib
[2];

240 
mib
[0] = 
CTL_HW
;

241 #ià
	`defšed
(
HW_MEMSIZE
)

242 
mib
[1] = 
HW_MEMSIZE
;

243 #–ià
	`defšed
(
HW_PHYSMEM64
)

244 
mib
[1] = 
HW_PHYSMEM64
;

246 
št64_t
 
size
 = 0;

247 
size_t
 
Ën
 = (
size
);

248 ià(
	`sysùl
Ğ
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

249  (
size_t
)
size
;

252 #–ià
	`defšed
(
_SC_PHYS_PAGES
è&& defšed(
_SC_PAGESIZE
)

254  (
size_t
)
	`syscÚf
(
_SC_PHYS_PAGES
è* (size_t)syscÚf(
_SC_PAGESIZE
);

256 #–ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_PHYSMEM
è|| defšed(
HW_REALMEM
))

258 
mib
[2];

259 
mib
[0] = 
CTL_HW
;

260 #ià
	`defšed
(
HW_REALMEM
)

261 
mib
[1] = 
HW_REALMEM
;

262 #–ià
	`defšed
(
HW_PYSMEM
)

263 
mib
[1] = 
HW_PHYSMEM
;

265 
size
 = 0;

266 
size_t
 
Ën
 = (
size
);

267 ià(
	`sysùl
(
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

268  (
size_t
)
size
;

275 
	}
}

287 #ià
defšed
(
HAVE_PROC_STAT
)

288 
	~<uni¡d.h
>

289 
	~<sys/ty³s.h
>

290 
	~<sys/¡©.h
>

291 
	~<fú.h
>

293 
size_t
 
	$d®loc_g‘_rss
() {

294 
·ge
 = 
	`syscÚf
(
_SC_PAGESIZE
);

295 
size_t
 
rss
;

296 
buf
[4096];

297 
f’ame
[256];

298 
fd
, 
couÁ
;

299 *
p
, *
x
;

301 
	`¢´štf
(
f’ame
,256,"/´oc/%d/¡©",
	`g‘pid
());

302 ià((
fd
 = 
	`İ’
(
f’ame
,
O_RDONLY
)) == -1)  0;

303 ià(
	`»ad
(
fd
,
buf
,4096) <= 0) {

304 
	`şo£
(
fd
);

307 
	`şo£
(
fd
);

309 
p
 = 
buf
;

310 
couÁ
 = 23;

311 
p
 && 
couÁ
--) {

312 
p
 = 
	`¡rchr
(p,' ');

313 ià(
p
)…++;

315 ià(!
p
)  0;

316 
x
 = 
	`¡rchr
(
p
,' ');

317 ià(!
x
)  0;

318 *
x
 = '\0';

320 
rss
 = 
	`¡¹Şl
(
p
,
NULL
,10);

321 
rss
 *ğ
·ge
;

322  
rss
;

323 
	}
}

324 #–ià
defšed
(
HAVE_TASKINFO
)

325 
	~<uni¡d.h
>

326 
	~<¡dio.h
>

327 
	~<¡dlib.h
>

328 
	~<sys/ty³s.h
>

329 
	~<sys/sysùl.h
>

330 
	~<mach/sk.h
>

331 
	~<mach/mach_š™.h
>

333 
size_t
 
	$d®loc_g‘_rss
() {

334 
sk_t
 
sk
 = 
MACH_PORT_NULL
;

335 
sk_basic_šfo
 
t_šfo
;

336 
mach_msg_ty³_numb”_t
 
t_šfo_couÁ
 = 
TASK_BASIC_INFO_COUNT
;

338 ià(
	`sk_fÜ_pid
(
	`cu¼’t_sk
(), 
	`g‘pid
(), &
sk
è!ğ
KERN_SUCCESS
)

340 
	`sk_šfo
(
sk
, 
TASK_BASIC_INFO
, (
sk_šfo_t
)&
t_šfo
, &
t_šfo_couÁ
);

342  
t_šfo
.
»sid’t_size
;

343 
	}
}

345 
size_t
 
	$d®loc_g‘_rss
() {

351  
	`d®loc_u£d_memÜy
();

352 
	}
}

356 
	$d®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
) {

357  ()
rss
/
	`d®loc_u£d_memÜy
();

358 
	}
}

	@dep/dmalloc/dmalloc.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<”ºo.h
>

5 
	~<±h»ad.h
>

7 
	~<uni¡d.h
>

9 
	~<dut.h
>

10 
	~<dlog.h
>

12 
	~<dm®loc.h
>

15 
size_t
 
	gu£d_memÜy
 = 0;

16 
±h»ad_mu‹x_t
 
	gu£d_memÜy_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

18 #ià
defšed
(
__ATOMIC_RELAXED
)

19 
	#upd©e_u£d_mem_¡©_add
(
__n
è
	`__©omic_add_ãtch
(&
u£d_memÜy
, (__n), 
__ATOMIC_RELAXED
)

	)

20 
	#upd©e_u£d_mem_¡©_sub
(
__n
è
	`__©omic_sub_ãtch
(&
u£d_memÜy
, (__n), 
__ATOMIC_RELAXED
)

	)

21 *
	$m®loc_lock_ty³
(è{ "__ATOMIC_RELAXED";
	}
}

22 #–ià
defšed
(
HAVE_ATOMIC
)

23 
	#upd©e_u£d_mem_¡©_add
(
__n
è
	`__sync_add_ªd_ãtch
(&
u£d_memÜy
, (__n))

	)

24 
	#upd©e_u£d_mem_¡©_sub
(
__n
è
	`__sync_sub_ªd_ãtch
(&
u£d_memÜy
, (__n))

	)

25 *
	$m®loc_lock_ty³
(è{ "HAVE_ATOMIC";
	}
}

27 
	#upd©e_u£d_mem_¡©_add
(
__n
) do { \

28 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
); \

29 
u£d_memÜy
 +ğ(
__n
); \

30 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
); \

31 } 0)

	)

33 
	#upd©e_u£d_mem_¡©_sub
(
__n
) do { \

34 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
); \

35 
u£d_memÜy
 -ğ(
__n
); \

36 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
); \

37 } 0)

	)

39 *
	$m®loc_lock_ty³
(è{ "±h»ad_mu‹x_t";
	}
}

42 
	#upd©e_dm®loc_¡©_®loc
(
__n
) do { \

43 
size_t
 
_n
 = (
__n
); \

44 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

45 
	`upd©e_u£d_mem_¡©_add
(
_n
); \

46 } 0)

	)

48 
	#upd©e_dm®loc_¡©_ä“
(
__n
) do { \

49 
size_t
 
_n
 = (
__n
); \

50 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

51 
	`upd©e_u£d_mem_¡©_sub
(
_n
); \

52 } 0)

	)

54 #ifdeà
HAVE_MALLOC_SIZE


55 
	#PREFIX_SIZE
 (0)

	)

57 #ià
defšed
(
__sun
è|| defšed(
__¥¬c
è|| defšed(
__¥¬c__
)

58 
	#PREFIX_SIZE
 (())

	)

60 
	#PREFIX_SIZE
 ((
size_t
))

	)

67 #iâdeà
HAVE_MALLOC_SIZE


68 
size_t
 
	$dm®loc_size
(*
±r
) {

69 *
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

70 
size_t
 
size
 = *((size_t*)
»®±r
);

73 ià(
size
&(()-1)) size += ()-(size&(()-1));

74  
size
+
PREFIX_SIZE
;

75 
	}
}

79 
	$_d®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
)

81 *
p
;

83 
	`ASSERT
(
size
 != 0);

85 #ifdeà
DUSE_JEMALLOC


86 
p
 = 
	`je_m®loc
(
size
+
PREFIX_SIZE
);

88 
p
 = 
	`m®loc
(
size
+
PREFIX_SIZE
);

90 ià(
p
 =ğ
NULL
) {

91 
	`log_”rÜ
("m®loc(%zuèçed @ %s:%d", 
size
, 
Çme
, 
lše
);

93 #ifdeà
HAVE_MALLOC_SIZE


94 
	`upd©e_dm®loc_¡©_®loc
(
	`dm®loc_size
(
p
));

95  
p
;

97 *((
size_t
*)
p
èğ
size
;

98 
	`upd©e_dm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

99  (*)
p
+
PREFIX_SIZE
;

101 
	`log_debug
(
LOG_VVERB
, "m®loc(%zuè© %°@ %s:%d", 
size
, 
p
, 
Çme
, 
lše
);

104  
p
;

105 
	}
}

108 
	$_dz®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
)

110 *
p
;

112 
p
 = 
	`_d®loc
(
size
, 
Çme
, 
lše
);

113 ià(
p
 !ğ
NULL
) {

114 
	`mem£t
(
p
, 0, 
size
);

117  
p
;

118 
	}
}

121 
	$_dÿÎoc
(
size_t
 
nmemb
, size_ˆ
size
, cÚ¡ *
Çme
, 
lše
)

123  
	`_dz®loc
(
nmemb
 * 
size
, 
Çme
, 
lše
);

124 
	}
}

127 
	$_d»®loc
(*
±r
, 
size_t
 
size
, cÚ¡ *
Çme
, 
lše
)

129 #iâdeà
HAVE_MALLOC_SIZE


130 *
»®p
;

132 *
p
;

133 
size_t
 
Şdsize
;

135 
	`ASSERT
(
size
 != 0);

137 ià(
±r
 =ğ
NULL
è 
	`_d®loc
(
size
, 
Çme
, 
lše
);

139 #ifdeà
HAVE_MALLOC_SIZE


140 
Şdsize
 = 
	`dm®loc_size
(
±r
);

141 #ifdeà
DUSE_JEMALLOC


142 
p
 = 
	`je_»®loc
(
±r
, 
size
);

144 
p
 = 
	`»®loc
(
±r
, 
size
);

147 
»®p
 = (*)
±r
-
PREFIX_SIZE
;

148 
Şdsize
 = *((
size_t
*)
»®p
);

149 #ifdeà
DUSE_JEMALLOC


150 
p
 = 
	`je_»®loc
(
±r
, 
size
+
PREFIX_SIZE
);

152 
p
 = 
	`»®loc
(
±r
, 
size
+
PREFIX_SIZE
);

155 ià(
p
 =ğ
NULL
) {

156 
	`log_”rÜ
("»®loc(%zuèçed @ %s:%d", 
size
, 
Çme
, 
lše
);

157  
NULL
;

159 
	`log_debug
(
LOG_VVERB
, "»®loc(%zuè© %°@ %s:%d", 
size
, 
p
, 
Çme
, 
lše
);

160 #ifdeà
HAVE_MALLOC_SIZE


161 
	`upd©e_dm®loc_¡©_ä“
(
Şdsize
);

162 
	`upd©e_dm®loc_¡©_®loc
(
	`dm®loc_size
(
p
));

163  
p
;

165 *((
size_t
*)
p
èğ
size
;

166 
	`upd©e_dm®loc_¡©_ä“
(
Şdsize
);

167 
	`upd©e_dm®loc_¡©_®loc
(
size
);

168  
p
+
PREFIX_SIZE
;

172  
NULL
;

173 
	}
}

176 
	$_dä“
(*
±r
, cÚ¡ *
Çme
, 
lše
)

178 #iâdeà
HAVE_MALLOC_SIZE


179 *
»®p
;

180 
size_t
 
Şdsize
;

183 
	`ASSERT
(
±r
 !ğ
NULL
);

184 
	`log_debug
(
LOG_VVERB
, "ä“(%pè@ %s:%d", 
±r
, 
Çme
, 
lše
);

186 #ifdeà
HAVE_MALLOC_SIZE


187 
	`upd©e_dm®loc_¡©_ä“
(
	`dm®loc_size
(
±r
));

188 #ifdeà
DUSE_JEMALLOC


189 
	`je_ä“
(
±r
);

191 
	`ä“
(
±r
);

194 
»®p
 = (*)
±r
-
PREFIX_SIZE
;

195 
Şdsize
 = *((
size_t
*)
»®p
);

196 
	`upd©e_dm®loc_¡©_ä“
(
Şdsize
+
PREFIX_SIZE
);

197 
	`ä“
(
»®p
);

198 #ifdeà
DUSE_JEMALLOC


199 
	`je_ä“
(
»®p
);

201 
	`ä“
(
»®p
);

204 
	}
}

206 
size_t


207 
	$d®loc_u£d_memÜy
()

209 
size_t
 
um
;

211 #ià
	`defšed
(
__ATOMIC_RELAXED
è|| defšed(
HAVE_ATOMIC
)

212 
um
 = 
	`upd©e_u£d_mem_¡©_add
(0);

214 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
);

215 
um
 = 
u£d_memÜy
;

216 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
);

219  
um
;

220 
	}
}

235 
size_t
 
	$d®loc_g‘_memÜy_size
() {

236 #ià
	`defšed
(
__unix__
è|| defšed(
__unix
è|| defšed(
unix
) || \

237 (
	`defšed
(
__APPLE__
è&& defšed(
__MACH__
))

238 #ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_MEMSIZE
è|| defšed(
HW_PHYSMEM64
))

239 
mib
[2];

240 
mib
[0] = 
CTL_HW
;

241 #ià
	`defšed
(
HW_MEMSIZE
)

242 
mib
[1] = 
HW_MEMSIZE
;

243 #–ià
	`defšed
(
HW_PHYSMEM64
)

244 
mib
[1] = 
HW_PHYSMEM64
;

246 
št64_t
 
size
 = 0;

247 
size_t
 
Ën
 = (
size
);

248 ià(
	`sysùl
Ğ
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

249  (
size_t
)
size
;

252 #–ià
	`defšed
(
_SC_PHYS_PAGES
è&& defšed(
_SC_PAGESIZE
)

254  (
size_t
)
	`syscÚf
(
_SC_PHYS_PAGES
è* (size_t)syscÚf(
_SC_PAGESIZE
);

256 #–ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_PHYSMEM
è|| defšed(
HW_REALMEM
))

258 
mib
[2];

259 
mib
[0] = 
CTL_HW
;

260 #ià
	`defšed
(
HW_REALMEM
)

261 
mib
[1] = 
HW_REALMEM
;

262 #–ià
	`defšed
(
HW_PYSMEM
)

263 
mib
[1] = 
HW_PHYSMEM
;

265 
size
 = 0;

266 
size_t
 
Ën
 = (
size
);

267 ià(
	`sysùl
(
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

268  (
size_t
)
size
;

275 
	}
}

287 #ià
defšed
(
HAVE_PROC_STAT
)

288 
	~<uni¡d.h
>

289 
	~<sys/ty³s.h
>

290 
	~<sys/¡©.h
>

291 
	~<fú.h
>

293 
size_t
 
	$d®loc_g‘_rss
() {

294 
·ge
 = 
	`syscÚf
(
_SC_PAGESIZE
);

295 
size_t
 
rss
;

296 
buf
[4096];

297 
f’ame
[256];

298 
fd
, 
couÁ
;

299 *
p
, *
x
;

301 
	`¢´štf
(
f’ame
,256,"/´oc/%d/¡©",
	`g‘pid
());

302 ià((
fd
 = 
	`İ’
(
f’ame
,
O_RDONLY
)) == -1)  0;

303 ià(
	`»ad
(
fd
,
buf
,4096) <= 0) {

304 
	`şo£
(
fd
);

307 
	`şo£
(
fd
);

309 
p
 = 
buf
;

310 
couÁ
 = 23;

311 
p
 && 
couÁ
--) {

312 
p
 = 
	`¡rchr
(p,' ');

313 ià(
p
)…++;

315 ià(!
p
)  0;

316 
x
 = 
	`¡rchr
(
p
,' ');

317 ià(!
x
)  0;

318 *
x
 = '\0';

320 
rss
 = 
	`¡¹Şl
(
p
,
NULL
,10);

321 
rss
 *ğ
·ge
;

322  
rss
;

323 
	}
}

324 #–ià
defšed
(
HAVE_TASKINFO
)

325 
	~<uni¡d.h
>

326 
	~<¡dio.h
>

327 
	~<¡dlib.h
>

328 
	~<sys/ty³s.h
>

329 
	~<sys/sysùl.h
>

330 
	~<mach/sk.h
>

331 
	~<mach/mach_š™.h
>

333 
size_t
 
	$d®loc_g‘_rss
() {

334 
sk_t
 
sk
 = 
MACH_PORT_NULL
;

335 
sk_basic_šfo
 
t_šfo
;

336 
mach_msg_ty³_numb”_t
 
t_šfo_couÁ
 = 
TASK_BASIC_INFO_COUNT
;

338 ià(
	`sk_fÜ_pid
(
	`cu¼’t_sk
(), 
	`g‘pid
(), &
sk
è!ğ
KERN_SUCCESS
)

340 
	`sk_šfo
(
sk
, 
TASK_BASIC_INFO
, (
sk_šfo_t
)&
t_šfo
, &
t_šfo_couÁ
);

342  
t_šfo
.
»sid’t_size
;

343 
	}
}

345 
size_t
 
	$d®loc_g‘_rss
() {

351  
	`d®loc_u£d_memÜy
();

352 
	}
}

356 
	$d®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
) {

357  ()
rss
/
	`d®loc_u£d_memÜy
();

358 
	}
}

	@dep/dmalloc/dmalloc.h

1 #iâdeà
_DMALLOC_H_


2 
	#_DMALLOC_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	~<d¥ecŸlcÚfig.h
>

10 #ifdeà
HAVE_JEMALLOC


11 
	#DUSE_JEMALLOC
 1

	)

20 #ià
defšed
(
DUSE_JEMALLOC
)

21 
	#DMALLOC_LIB
 ("jem®loc-" 
	`__x¡r
(
JEMALLOC_VERSION_MAJOR
è"." __x¡r(
JEMALLOC_VERSION_MINOR
è"." __x¡r(
JEMALLOC_VERSION_BUGFIX
))

	)

22 
	~<jem®loc/jem®loc.h
>

23 #ià(
JEMALLOC_VERSION_MAJOR
 =ğ2 && 
JEMALLOC_VERSION_MINOR
 >= 1) || (JEMALLOC_VERSION_MAJOR > 2)

24 
	#HAVE_MALLOC_SIZE
 1

	)

25 
	#dm®loc_size
(
p
è
	`je_m®loc_u§bË_size
Õ)

	)

29 #–ià
defšed
(
__APPLE__
)

30 
	~<m®loc/m®loc.h
>

31 
	#HAVE_MALLOC_SIZE
 1

	)

32 
	#dm®loc_size
(
p
è
	`m®loc_size
Õ)

	)

35 #iâdeà
DMALLOC_LIB


36 
	#DMALLOC_LIB
 "libc"

	)

39 
	#d®loc
(
_s
) \

40 
	`_d®loc
((
size_t
)(
_s
), 
__FILE__
, 
__LINE__
)

	)

42 
	#dz®loc
(
_s
) \

43 
	`_dz®loc
((
size_t
)(
_s
), 
__FILE__
, 
__LINE__
)

	)

45 
	#dÿÎoc
(
_n
, 
_s
) \

46 
	`_dÿÎoc
((
size_t
)(
_n
), (size_t)(
_s
), 
__FILE__
, 
__LINE__
)

	)

48 
	#d»®loc
(
_p
, 
_s
) \

49 
	`_d»®loc
(
_p
, (
size_t
)(
_s
), 
__FILE__
, 
__LINE__
)

	)

51 
	#dä“
(
_p
) do { \

52 
	`_dä“
(
_p
, 
__FILE__
, 
__LINE__
); \

53 } 0)

	)

55 *
dm®loc_lock_ty³
();

57 #iâdeà
HAVE_MALLOC_SIZE


58 
size_t
 
dm®loc_size
(*
±r
);

61 *
_d®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
);

62 *
_dz®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
);

63 *
_dÿÎoc
(
size_t
 
nmemb
, size_ˆ
size
, cÚ¡ *
Çme
, 
lše
);

64 *
_d»®loc
(*
±r
, 
size_t
 
size
, cÚ¡ *
Çme
, 
lše
);

65 
_dä“
(*
±r
, cÚ¡ *
Çme
, 
lše
);

67 
size_t
 
d®loc_u£d_memÜy
();

69 
size_t
 
d®loc_g‘_memÜy_size
();

71 
size_t
 
d®loc_g‘_rss
();

72 
d®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
);

	@dep/dmalloc/dmalloc.h

1 #iâdeà
_DMALLOC_H_


2 
	#_DMALLOC_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	~<d¥ecŸlcÚfig.h
>

10 #ifdeà
HAVE_JEMALLOC


11 
	#DUSE_JEMALLOC
 1

	)

20 #ià
defšed
(
DUSE_JEMALLOC
)

21 
	#DMALLOC_LIB
 ("jem®loc-" 
	`__x¡r
(
JEMALLOC_VERSION_MAJOR
è"." __x¡r(
JEMALLOC_VERSION_MINOR
è"." __x¡r(
JEMALLOC_VERSION_BUGFIX
))

	)

22 
	~<jem®loc/jem®loc.h
>

23 #ià(
JEMALLOC_VERSION_MAJOR
 =ğ2 && 
JEMALLOC_VERSION_MINOR
 >= 1) || (JEMALLOC_VERSION_MAJOR > 2)

24 
	#HAVE_MALLOC_SIZE
 1

	)

25 
	#dm®loc_size
(
p
è
	`je_m®loc_u§bË_size
Õ)

	)

29 #–ià
defšed
(
__APPLE__
)

30 
	~<m®loc/m®loc.h
>

31 
	#HAVE_MALLOC_SIZE
 1

	)

32 
	#dm®loc_size
(
p
è
	`m®loc_size
Õ)

	)

35 #iâdeà
DMALLOC_LIB


36 
	#DMALLOC_LIB
 "libc"

	)

39 
	#d®loc
(
_s
) \

40 
	`_d®loc
((
size_t
)(
_s
), 
__FILE__
, 
__LINE__
)

	)

42 
	#dz®loc
(
_s
) \

43 
	`_dz®loc
((
size_t
)(
_s
), 
__FILE__
, 
__LINE__
)

	)

45 
	#dÿÎoc
(
_n
, 
_s
) \

46 
	`_dÿÎoc
((
size_t
)(
_n
), (size_t)(
_s
), 
__FILE__
, 
__LINE__
)

	)

48 
	#d»®loc
(
_p
, 
_s
) \

49 
	`_d»®loc
(
_p
, (
size_t
)(
_s
), 
__FILE__
, 
__LINE__
)

	)

51 
	#dä“
(
_p
) do { \

52 
	`_dä“
(
_p
, 
__FILE__
, 
__LINE__
); \

53 } 0)

	)

55 *
dm®loc_lock_ty³
();

57 #iâdeà
HAVE_MALLOC_SIZE


58 
size_t
 
dm®loc_size
(*
±r
);

61 *
_d®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
);

62 *
_dz®loc
(
size_t
 
size
, cÚ¡ *
Çme
, 
lše
);

63 *
_dÿÎoc
(
size_t
 
nmemb
, size_ˆ
size
, cÚ¡ *
Çme
, 
lše
);

64 *
_d»®loc
(*
±r
, 
size_t
 
size
, cÚ¡ *
Çme
, 
lše
);

65 
_dä“
(*
±r
, cÚ¡ *
Çme
, 
lše
);

67 
size_t
 
d®loc_u£d_memÜy
();

69 
size_t
 
d®loc_g‘_memÜy_size
();

71 
size_t
 
d®loc_g‘_rss
();

72 
d®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
);

	@dep/himemcached-0.1.0/himcdep/sds.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 
	~<ùy³.h
>

35 
	~<as£¹.h
>

37 
	~"sds.h
"

51 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

52 
sdshdr
 *
sh
;

54 ià(
š™
) {

55 
sh
 = 
	`m®loc
( *sh+
š™Ën
+1);

57 
sh
 = 
	`ÿÎoc
( *sh+
š™Ën
+1,1);

59 ià(
sh
 =ğ
NULL
)  NULL;

60 
sh
->
Ën
 = 
š™Ën
;

61 
sh
->
ä“
 = 0;

62 ià(
š™Ën
 && 
š™
)

63 
	`memıy
(
sh
->
buf
, 
š™
, 
š™Ën
);

64 
sh
->
buf
[
š™Ën
] = '\0';

65  (*)
sh
->
buf
;

66 
	}
}

70 
sds
 
	$sd£m±y
() {

71  
	`sd¢ewËn
("",0);

72 
	}
}

75 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

76 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

77  
	`sd¢ewËn
(
š™
, 
š™Ën
);

78 
	}
}

81 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

82  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

83 
	}
}

86 
	$sdsä“
(
sds
 
s
) {

87 ià(
s
 =ğ
NULL
) ;

88 
	`ä“
(
s
-(
sdshdr
));

89 
	}
}

105 
	$sdsupd©–’
(
sds
 
s
) {

106 
sdshdr
 *
sh
 = (*è(
s
- *sh);

107 
»®Ën
 = 
	`¡¾’
(
s
);

108 
sh
->
ä“
 +ğ(sh->
Ën
-
»®Ën
);

109 
sh
->
Ën
 = 
»®Ën
;

110 
	}
}

116 
	$sdsş—r
(
sds
 
s
) {

117 
sdshdr
 *
sh
 = (*è(
s
- *sh);

118 
sh
->
ä“
 +ğsh->
Ën
;

119 
sh
->
Ën
 = 0;

120 
sh
->
buf
[0] = '\0';

121 
	}
}

129 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

130 
sdshdr
 *
sh
, *
Ãwsh
;

131 
size_t
 
ä“
 = 
	`sd§va
(
s
);

132 
size_t
 
Ën
, 
ÃwËn
;

134 ià(
ä“
 >ğ
addËn
è 
s
;

135 
Ën
 = 
	`sd¦’
(
s
);

136 
sh
 = (*è(
s
- *sh);

137 
ÃwËn
 = (
Ën
+
addËn
);

138 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

139 
ÃwËn
 *= 2;

141 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

142 
Ãwsh
 = 
	`»®loc
(
sh
,  *Ãwsh+
ÃwËn
+1);

143 ià(
Ãwsh
 =ğ
NULL
)  NULL;

145 
Ãwsh
->
ä“
 = 
ÃwËn
 - 
Ën
;

146  
Ãwsh
->
buf
;

147 
	}
}

155 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

156 
sdshdr
 *
sh
;

158 
sh
 = (*è(
s
- *sh);

159 
sh
 = 
	`»®loc
(sh,  *sh+sh->
Ën
+1);

160 
sh
->
ä“
 = 0;

161  
sh
->
buf
;

162 
	}
}

171 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

172 
sdshdr
 *
sh
 = (*è(
s
- *sh);

174  (*
sh
)+sh->
Ën
+sh->
ä“
+1;

175 
	}
}

200 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

201 
sdshdr
 *
sh
 = (*è(
s
- *sh);

203 
	`as£¹
(
sh
->
ä“
 >ğ
šü
);

204 
sh
->
Ën
 +ğ
šü
;

205 
sh
->
ä“
 -ğ
šü
;

206 
	`as£¹
(
sh
->
ä“
 >= 0);

207 
s
[
sh
->
Ën
] = '\0';

208 
	}
}

215 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

216 
sdshdr
 *
sh
 = (*è(
s
- *sh);

217 
size_t
 
tÙËn
, 
cu¾’
 = 
sh
->
Ën
;

219 ià(
Ën
 <ğ
cu¾’
è 
s
;

220 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

221 ià(
s
 =ğ
NULL
)  NULL;

224 
sh
 = (*)(
s
- *sh);

225 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

226 
tÙËn
 = 
sh
->
Ën
+sh->
ä“
;

227 
sh
->
Ën
 =†en;

228 
sh
->
ä“
 = 
tÙËn
-sh->
Ën
;

229  
s
;

230 
	}
}

237 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

238 
sdshdr
 *
sh
;

239 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

241 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

242 ià(
s
 =ğ
NULL
)  NULL;

243 
sh
 = (*è(
s
- *sh);

244 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

245 
sh
->
Ën
 = 
cu¾’
+len;

246 
sh
->
ä“
 = sh->ä“-
Ën
;

247 
s
[
cu¾’
+
Ën
] = '\0';

248  
s
;

249 
	}
}

255 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

256  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

257 
	}
}

263 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

264  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

265 
	}
}

269 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

270 
sdshdr
 *
sh
 = (*è(
s
- *sh);

271 
size_t
 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

273 ià(
tÙËn
 < 
Ën
) {

274 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
sh
->len);

275 ià(
s
 =ğ
NULL
)  NULL;

276 
sh
 = (*è(
s
- *sh);

277 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

279 
	`memıy
(
s
, 
t
, 
Ën
);

280 
s
[
Ën
] = '\0';

281 
sh
->
Ën
 =†en;

282 
sh
->
ä“
 = 
tÙËn
-
Ën
;

283  
s
;

284 
	}
}

288 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

289  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

290 
	}
}

298 
	#SDS_LLSTR_SIZE
 21

	)

299 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

300 *
p
, 
aux
;

301 
v
;

302 
size_t
 
l
;

306 
v
 = (
v®ue
 < 0) ? -value : value;

307 
p
 = 
s
;

309 *
p
++ = '0'+(
v
%10);

310 
v
 /= 10;

311 } 
v
);

312 ià(
v®ue
 < 0è*
p
++ = '-';

315 
l
 = 
p
-
s
;

316 *
p
 = '\0';

319 
p
--;

320 
s
 < 
p
) {

321 
aux
 = *
s
;

322 *
s
 = *
p
;

323 *
p
 = 
aux
;

324 
s
++;

325 
p
--;

327  
l
;

328 
	}
}

331 
	$sdsuÎ2¡r
(*
s
, 
v
) {

332 *
p
, 
aux
;

333 
size_t
 
l
;

337 
p
 = 
s
;

339 *
p
++ = '0'+(
v
%10);

340 
v
 /= 10;

341 } 
v
);

344 
l
 = 
p
-
s
;

345 *
p
 = '\0';

348 
p
--;

349 
s
 < 
p
) {

350 
aux
 = *
s
;

351 *
s
 = *
p
;

352 *
p
 = 
aux
;

353 
s
++;

354 
p
--;

356  
l
;

357 
	}
}

360 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

361 
va_li¡
 
ıy
;

362 *
buf
, *
t
;

363 
size_t
 
buæ’
 = 16;

366 
buf
 = 
	`m®loc
(
buæ’
);

367 ià(
buf
 =ğ
NULL
)  NULL;

368 
buf
[
buæ’
-2] = '\0';

369 
	`va_cİy
(
ıy
,
­
);

370 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

371 ià(
buf
[
buæ’
-2] != '\0') {

372 
	`ä“
(
buf
);

373 
buæ’
 *= 2;

378 
t
 = 
	`sdsÿt
(
s
, 
buf
);

379 
	`ä“
(
buf
);

380  
t
;

381 
	}
}

399 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

400 
va_li¡
 
­
;

401 *
t
;

402 
	`va_¡¬t
(
­
, 
fmt
);

403 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

404 
	`va_’d
(
­
);

405  
t
;

406 
	}
}

425 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

426 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

427 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

428 cÚ¡ *
f
 = 
fmt
;

429 
i
;

430 
va_li¡
 
­
;

432 
	`va_¡¬t
(
­
,
fmt
);

433 
f
 = 
fmt
;

434 
i
 = 
š™Ën
;

435 *
f
) {

436 
Ãxt
, *
¡r
;

437 
l
;

438 
num
;

439 
unum
;

442 ià(
sh
->
ä“
 == 0) {

443 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

444 
sh
 = (*è(
s
-((
sdshdr
)));

447 *
f
) {

449 
Ãxt
 = *(
f
+1);

450 
f
++;

451 
Ãxt
) {

454 
¡r
 = 
	`va_¬g
(
­
,*);

455 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

456 ià(
sh
->
ä“
 < 
l
) {

457 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

458 
sh
 = (*è(
s
-((
sdshdr
)));

460 
	`memıy
(
s
+
i
,
¡r
,
l
);

461 
sh
->
Ën
 +ğ
l
;

462 
sh
->
ä“
 -ğ
l
;

463 
i
 +ğ
l
;

467 ià(
Ãxt
 == 'i')

468 
num
 = 
	`va_¬g
(
­
,);

470 
num
 = 
	`va_¬g
(
­
,);

472 
buf
[
SDS_LLSTR_SIZE
];

473 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

474 ià(
sh
->
ä“
 < 
l
) {

475 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

476 
sh
 = (*è(
s
-((
sdshdr
)));

478 
	`memıy
(
s
+
i
,
buf
,
l
);

479 
sh
->
Ën
 +ğ
l
;

480 
sh
->
ä“
 -ğ
l
;

481 
i
 +ğ
l
;

487 ià(
Ãxt
 == 'u')

488 
unum
 = 
	`va_¬g
(
­
,);

489 if(
Ãxt
 == 'U')

490 
unum
 = 
	`va_¬g
(
­
,);

492 
unum
 = ()
	`va_¬g
(
­
,
size_t
);

494 
buf
[
SDS_LLSTR_SIZE
];

495 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

496 ià(
sh
->
ä“
 < 
l
) {

497 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

498 
sh
 = (*è(
s
-((
sdshdr
)));

500 
	`memıy
(
s
+
i
,
buf
,
l
);

501 
sh
->
Ën
 +ğ
l
;

502 
sh
->
ä“
 -ğ
l
;

503 
i
 +ğ
l
;

507 
s
[
i
++] = 
Ãxt
;

508 
sh
->
Ën
 += 1;

509 
sh
->
ä“
 -= 1;

514 
s
[
i
++] = *
f
;

515 
sh
->
Ën
 += 1;

516 
sh
->
ä“
 -= 1;

519 
f
++;

521 
	`va_’d
(
­
);

524 
s
[
i
] = '\0';

525  
s
;

526 
	}
}

543 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

544 
sdshdr
 *
sh
 = (*è(
s
- *sh);

545 *
¡¬t
, *
’d
, *
¥
, *
•
;

546 
size_t
 
Ën
;

548 
¥
 = 
¡¬t
 = 
s
;

549 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

550 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

551 
•
 > 
¡¬t
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

552 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

553 ià(
sh
->
buf
 !ğ
¥
è
	`memmove
(sh->buf, sp, 
Ën
);

554 
sh
->
buf
[
Ën
] = '\0';

555 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-len);

556 
sh
->
Ën
 =†en;

557 
	}
}

575 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

576 
sdshdr
 *
sh
 = (*è(
s
- *sh);

577 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

579 ià(
Ën
 == 0) ;

580 ià(
¡¬t
 < 0) {

581 
¡¬t
 = 
Ën
+start;

582 ià(
¡¬t
 < 0) start = 0;

584 ià(
’d
 < 0) {

585 
’d
 = 
Ën
+end;

586 ià(
’d
 < 0)ƒnd = 0;

588 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

589 ià(
ÃwËn
 != 0) {

590 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

591 
ÃwËn
 = 0;

592 } ià(
’d
 >ğ(sigÃd)
Ën
) {

593 
’d
 = 
Ën
-1;

594 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

597 
¡¬t
 = 0;

599 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
sh
->
buf
, sh->buf+start,‚ewlen);

600 
sh
->
buf
[
ÃwËn
] = 0;

601 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-
ÃwËn
);

602 
sh
->
Ën
 = 
ÃwËn
;

603 
	}
}

606 
	$sd¡Şow”
(
sds
 
s
) {

607 
Ën
 = 
	`sd¦’
(
s
), 
j
;

609 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

610 
	}
}

613 
	$sd¡ouµ”
(
sds
 
s
) {

614 
Ën
 = 
	`sd¦’
(
s
), 
j
;

616 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

617 
	}
}

630 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

631 
size_t
 
l1
, 
l2
, 
mšËn
;

632 
cmp
;

634 
l1
 = 
	`sd¦’
(
s1
);

635 
l2
 = 
	`sd¦’
(
s2
);

636 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

637 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

638 ià(
cmp
 =ğ0è 
l1
-
l2
;

639  
cmp
;

640 
	}
}

658 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

659 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

660 
sds
 *
tok’s
;

662 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

664 
tok’s
 = 
	`m®loc
((
sds
)*
¦Ùs
);

665 ià(
tok’s
 =ğ
NULL
)  NULL;

667 ià(
Ën
 == 0) {

668 *
couÁ
 = 0;

669  
tok’s
;

671 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

673 ià(
¦Ùs
 < 
–em’ts
+2) {

674 
sds
 *
Ãwtok’s
;

676 
¦Ùs
 *= 2;

677 
Ãwtok’s
 = 
	`»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

678 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

679 
tok’s
 = 
Ãwtok’s
;

682 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

683 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

684 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

685 
–em’ts
++;

686 
¡¬t
 = 
j
+
£¶’
;

687 
j
 = j+
£¶’
-1;

691 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

692 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

693 
–em’ts
++;

694 *
couÁ
 = 
–em’ts
;

695  
tok’s
;

697 
ş—nup
:

699 
i
;

700 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

701 
	`ä“
(
tok’s
);

702 *
couÁ
 = 0;

703  
NULL
;

705 
	}
}

708 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

709 ià(!
tok’s
) ;

710 
couÁ
--)

711 
	`sdsä“
(
tok’s
[
couÁ
]);

712 
	`ä“
(
tok’s
);

713 
	}
}

719 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

720 
buf
[32], *
p
;

721 
v
;

723 
v
 = (
v®ue
 < 0) ? -value : value;

724 
p
 = 
buf
+31;

726 *
p
-- = '0'+(
v
%10);

727 
v
 /= 10;

728 } 
v
);

729 ià(
v®ue
 < 0è*
p
-- = '-';

730 
p
++;

731  
	`sd¢ewËn
(
p
,32-Õ-
buf
));

732 
	}
}

740 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

741 
s
 = 
	`sdsÿ’
(s,"\"",1);

742 
Ën
--) {

743 *
p
) {

746 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

748 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

749 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

750 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

751 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

752 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

754 ià(
	`i¥ršt
(*
p
))

755 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

757 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

760 
p
++;

762  
	`sdsÿ’
(
s
,"\"",1);

763 
	}
}

767 
	$is_hex_dig™
(
c
) {

768  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

769 (
c
 >= 'A' && c <= 'F');

770 
	}
}

774 
	$hex_dig™_to_št
(
c
) {

775 
c
) {

794 
	}
}

815 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

816 cÚ¡ *
p
 = 
lše
;

817 *
cu¼’t
 = 
NULL
;

818 **
veùÜ
 = 
NULL
;

820 *
¬gc
 = 0;

823 *
p
 && 
	`is¥aû
(*p))…++;

824 ià(*
p
) {

826 
šq
=0;

827 
šsq
=0;

828 
dÚe
=0;

830 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

831 !
dÚe
) {

832 ià(
šq
) {

833 ià(*
p
 == '\\' && *(p+1) == 'x' &&

834 
	`is_hex_dig™
(*(
p
+2)) &&

835 
	`is_hex_dig™
(*(
p
+3)))

837 
by‹
;

839 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

840 
	`hex_dig™_to_št
(*(
p
+3));

841 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

842 
p
 += 3;

843 } ià(*
p
 == '\\' && *(p+1)) {

844 
c
;

846 
p
++;

847 *
p
) {

848 'n': 
c
 = '\n'; ;

849 'r': 
c
 = '\r'; ;

850 't': 
c
 = '\t'; ;

851 'b': 
c
 = '\b'; ;

852 'a': 
c
 = '\a'; ;

853 : 
c
 = *
p
; ;

855 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

856 } ià(*
p
 == '"') {

859 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

860 
dÚe
=1;

861 } ià(!*
p
) {

863 
”r
;

865 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

867 } ià(
šsq
) {

868 ià(*
p
 == '\\' && *(p+1) == '\'') {

869 
p
++;

870 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

871 } ià(*
p
 == '\'') {

874 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

875 
dÚe
=1;

876 } ià(!*
p
) {

878 
”r
;

880 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

883 *
p
) {

889 
dÚe
=1;

892 
šq
=1;

895 
šsq
=1;

898 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

902 ià(*
p
)…++;

905 
veùÜ
 = 
	`»®loc
(veùÜ,((*
¬gc
)+1)*(*));

906 
veùÜ
[*
¬gc
] = 
cu¼’t
;

907 (*
¬gc
)++;

908 
cu¼’t
 = 
NULL
;

911 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`m®loc
((*));

912  
veùÜ
;

916 
”r
:

917 (*
¬gc
)--)

918 
	`sdsä“
(
veùÜ
[*
¬gc
]);

919 
	`ä“
(
veùÜ
);

920 ià(
cu¼’t
è
	`sdsä“
(current);

921 *
¬gc
 = 0;

922  
NULL
;

923 
	}
}

934 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

935 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

937 
j
 = 0; j < 
l
; j++) {

938 
i
 = 0; i < 
£’
; i++) {

939 ià(
s
[
j
] =ğ
äom
[
i
]) {

940 
s
[
j
] = 
to
[
i
];

945  
s
;

946 
	}
}

950 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
, 
size_t
 
£¶’
) {

951 
sds
 
još
 = 
	`sd£m±y
();

952 
j
;

954 
j
 = 0; j < 
¬gc
; j++) {

955 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

956 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

958  
još
;

959 
	}
}

962 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

963 
sds
 
još
 = 
	`sd£m±y
();

964 
j
;

966 
j
 = 0; j < 
¬gc
; j++) {

967 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

968 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

970  
još
;

971 
	}
}

973 #ifdeà
SDS_TEST_MAIN


974 
	~<¡dio.h
>

975 
	~"‹¡h–p.h
"

977 
	$maš
() {

979 
sdshdr
 *
sh
;

980 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

982 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

983 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

985 
	`sdsä“
(
x
);

986 
x
 = 
	`sd¢ewËn
("foo",2);

987 
	`‹¡_cÚd
("Create‡ string with specified†ength",

988 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

990 
x
 = 
	`sdsÿt
(x,"bar");

991 
	`‹¡_cÚd
("Strings concatenation",

992 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

994 
x
 = 
	`sdsıy
(x,"a");

995 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

996 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

998 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

999 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1000 
	`sd¦’
(
x
) == 33 &&

1001 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1003 
	`sdsä“
(
x
);

1004 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1005 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1006 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) ==0)

1008 
	`sdsä“
(
x
);

1009 
x
 = 
	`sd¢ew
("xxciaoyyy");

1010 
	`sd¡rim
(
x
,"xy");

1011 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1012 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1014 
y
 = 
	`sdsdup
(
x
);

1015 
	`sd¤ªge
(
y
,1,1);

1016 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1017 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1019 
	`sdsä“
(
y
);

1020 
y
 = 
	`sdsdup
(
x
);

1021 
	`sd¤ªge
(
y
,1,-1);

1022 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1023 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1025 
	`sdsä“
(
y
);

1026 
y
 = 
	`sdsdup
(
x
);

1027 
	`sd¤ªge
(
y
,-2,-1);

1028 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1029 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1031 
	`sdsä“
(
y
);

1032 
y
 = 
	`sdsdup
(
x
);

1033 
	`sd¤ªge
(
y
,2,1);

1034 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1035 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1037 
	`sdsä“
(
y
);

1038 
y
 = 
	`sdsdup
(
x
);

1039 
	`sd¤ªge
(
y
,1,100);

1040 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1041 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1043 
	`sdsä“
(
y
);

1044 
y
 = 
	`sdsdup
(
x
);

1045 
	`sd¤ªge
(
y
,100,100);

1046 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1047 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1049 
	`sdsä“
(
y
);

1050 
	`sdsä“
(
x
);

1051 
x
 = 
	`sd¢ew
("foo");

1052 
y
 = 
	`sd¢ew
("foa");

1053 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1055 
	`sdsä“
(
y
);

1056 
	`sdsä“
(
x
);

1057 
x
 = 
	`sd¢ew
("bar");

1058 
y
 = 
	`sd¢ew
("bar");

1059 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1061 
	`sdsä“
(
y
);

1062 
	`sdsä“
(
x
);

1063 
x
 = 
	`sd¢ew
("aar");

1064 
y
 = 
	`sd¢ew
("bar");

1065 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1067 
	`sdsä“
(
y
);

1068 
	`sdsä“
(
x
);

1069 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1070 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1071 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1072 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1075 
Şdä“
;

1077 
	`sdsä“
(
x
);

1078 
x
 = 
	`sd¢ew
("0");

1079 
sh
 = (*è(
x
-((
sdshdr
)));

1080 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
sh
->
Ën
 =ğ1 && sh->
ä“
 == 0);

1081 
x
 = 
	`sdsMakeRoomFÜ
(x,1);

1082 
sh
 = (*è(
x
-((
sdshdr
)));

1083 
	`‹¡_cÚd
("sdsMakeRoomFÜ()", 
sh
->
Ën
 =ğ1 && sh->
ä“
 > 0);

1084 
Şdä“
 = 
sh
->
ä“
;

1085 
x
[1] = '1';

1086 
	`sdsInüL’
(
x
,1);

1087 
	`‹¡_cÚd
("sdsInüL’(è-- cÚ‹Á", 
x
[0] == '0' && x[1] == '1');

1088 
	`‹¡_cÚd
("sdsInüL’(è--†’", 
sh
->
Ën
 == 2);

1089 
	`‹¡_cÚd
("sdsInüL’(è-- f»e", 
sh
->
ä“
 =ğ
Şdä“
-1);

1092 
	`‹¡_»pÜt
()

1094 
	}
}

	@dep/himemcached-0.1.0/himcdep/sds.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 
	~<ùy³.h
>

35 
	~<as£¹.h
>

37 
	~"sds.h
"

51 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

52 
sdshdr
 *
sh
;

54 ià(
š™
) {

55 
sh
 = 
	`m®loc
( *sh+
š™Ën
+1);

57 
sh
 = 
	`ÿÎoc
( *sh+
š™Ën
+1,1);

59 ià(
sh
 =ğ
NULL
)  NULL;

60 
sh
->
Ën
 = 
š™Ën
;

61 
sh
->
ä“
 = 0;

62 ià(
š™Ën
 && 
š™
)

63 
	`memıy
(
sh
->
buf
, 
š™
, 
š™Ën
);

64 
sh
->
buf
[
š™Ën
] = '\0';

65  (*)
sh
->
buf
;

66 
	}
}

70 
sds
 
	$sd£m±y
() {

71  
	`sd¢ewËn
("",0);

72 
	}
}

75 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

76 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

77  
	`sd¢ewËn
(
š™
, 
š™Ën
);

78 
	}
}

81 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

82  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

83 
	}
}

86 
	$sdsä“
(
sds
 
s
) {

87 ià(
s
 =ğ
NULL
) ;

88 
	`ä“
(
s
-(
sdshdr
));

89 
	}
}

105 
	$sdsupd©–’
(
sds
 
s
) {

106 
sdshdr
 *
sh
 = (*è(
s
- *sh);

107 
»®Ën
 = 
	`¡¾’
(
s
);

108 
sh
->
ä“
 +ğ(sh->
Ën
-
»®Ën
);

109 
sh
->
Ën
 = 
»®Ën
;

110 
	}
}

116 
	$sdsş—r
(
sds
 
s
) {

117 
sdshdr
 *
sh
 = (*è(
s
- *sh);

118 
sh
->
ä“
 +ğsh->
Ën
;

119 
sh
->
Ën
 = 0;

120 
sh
->
buf
[0] = '\0';

121 
	}
}

129 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

130 
sdshdr
 *
sh
, *
Ãwsh
;

131 
size_t
 
ä“
 = 
	`sd§va
(
s
);

132 
size_t
 
Ën
, 
ÃwËn
;

134 ià(
ä“
 >ğ
addËn
è 
s
;

135 
Ën
 = 
	`sd¦’
(
s
);

136 
sh
 = (*è(
s
- *sh);

137 
ÃwËn
 = (
Ën
+
addËn
);

138 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

139 
ÃwËn
 *= 2;

141 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

142 
Ãwsh
 = 
	`»®loc
(
sh
,  *Ãwsh+
ÃwËn
+1);

143 ià(
Ãwsh
 =ğ
NULL
)  NULL;

145 
Ãwsh
->
ä“
 = 
ÃwËn
 - 
Ën
;

146  
Ãwsh
->
buf
;

147 
	}
}

155 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

156 
sdshdr
 *
sh
;

158 
sh
 = (*è(
s
- *sh);

159 
sh
 = 
	`»®loc
(sh,  *sh+sh->
Ën
+1);

160 
sh
->
ä“
 = 0;

161  
sh
->
buf
;

162 
	}
}

171 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

172 
sdshdr
 *
sh
 = (*è(
s
- *sh);

174  (*
sh
)+sh->
Ën
+sh->
ä“
+1;

175 
	}
}

200 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

201 
sdshdr
 *
sh
 = (*è(
s
- *sh);

203 
	`as£¹
(
sh
->
ä“
 >ğ
šü
);

204 
sh
->
Ën
 +ğ
šü
;

205 
sh
->
ä“
 -ğ
šü
;

206 
	`as£¹
(
sh
->
ä“
 >= 0);

207 
s
[
sh
->
Ën
] = '\0';

208 
	}
}

215 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

216 
sdshdr
 *
sh
 = (*è(
s
- *sh);

217 
size_t
 
tÙËn
, 
cu¾’
 = 
sh
->
Ën
;

219 ià(
Ën
 <ğ
cu¾’
è 
s
;

220 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

221 ià(
s
 =ğ
NULL
)  NULL;

224 
sh
 = (*)(
s
- *sh);

225 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

226 
tÙËn
 = 
sh
->
Ën
+sh->
ä“
;

227 
sh
->
Ën
 =†en;

228 
sh
->
ä“
 = 
tÙËn
-sh->
Ën
;

229  
s
;

230 
	}
}

237 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

238 
sdshdr
 *
sh
;

239 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

241 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

242 ià(
s
 =ğ
NULL
)  NULL;

243 
sh
 = (*è(
s
- *sh);

244 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

245 
sh
->
Ën
 = 
cu¾’
+len;

246 
sh
->
ä“
 = sh->ä“-
Ën
;

247 
s
[
cu¾’
+
Ën
] = '\0';

248  
s
;

249 
	}
}

255 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

256  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

257 
	}
}

263 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

264  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

265 
	}
}

269 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

270 
sdshdr
 *
sh
 = (*è(
s
- *sh);

271 
size_t
 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

273 ià(
tÙËn
 < 
Ën
) {

274 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
sh
->len);

275 ià(
s
 =ğ
NULL
)  NULL;

276 
sh
 = (*è(
s
- *sh);

277 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

279 
	`memıy
(
s
, 
t
, 
Ën
);

280 
s
[
Ën
] = '\0';

281 
sh
->
Ën
 =†en;

282 
sh
->
ä“
 = 
tÙËn
-
Ën
;

283  
s
;

284 
	}
}

288 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

289  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

290 
	}
}

298 
	#SDS_LLSTR_SIZE
 21

	)

299 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

300 *
p
, 
aux
;

301 
v
;

302 
size_t
 
l
;

306 
v
 = (
v®ue
 < 0) ? -value : value;

307 
p
 = 
s
;

309 *
p
++ = '0'+(
v
%10);

310 
v
 /= 10;

311 } 
v
);

312 ià(
v®ue
 < 0è*
p
++ = '-';

315 
l
 = 
p
-
s
;

316 *
p
 = '\0';

319 
p
--;

320 
s
 < 
p
) {

321 
aux
 = *
s
;

322 *
s
 = *
p
;

323 *
p
 = 
aux
;

324 
s
++;

325 
p
--;

327  
l
;

328 
	}
}

331 
	$sdsuÎ2¡r
(*
s
, 
v
) {

332 *
p
, 
aux
;

333 
size_t
 
l
;

337 
p
 = 
s
;

339 *
p
++ = '0'+(
v
%10);

340 
v
 /= 10;

341 } 
v
);

344 
l
 = 
p
-
s
;

345 *
p
 = '\0';

348 
p
--;

349 
s
 < 
p
) {

350 
aux
 = *
s
;

351 *
s
 = *
p
;

352 *
p
 = 
aux
;

353 
s
++;

354 
p
--;

356  
l
;

357 
	}
}

360 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

361 
va_li¡
 
ıy
;

362 *
buf
, *
t
;

363 
size_t
 
buæ’
 = 16;

366 
buf
 = 
	`m®loc
(
buæ’
);

367 ià(
buf
 =ğ
NULL
)  NULL;

368 
buf
[
buæ’
-2] = '\0';

369 
	`va_cİy
(
ıy
,
­
);

370 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

371 ià(
buf
[
buæ’
-2] != '\0') {

372 
	`ä“
(
buf
);

373 
buæ’
 *= 2;

378 
t
 = 
	`sdsÿt
(
s
, 
buf
);

379 
	`ä“
(
buf
);

380  
t
;

381 
	}
}

399 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

400 
va_li¡
 
­
;

401 *
t
;

402 
	`va_¡¬t
(
­
, 
fmt
);

403 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

404 
	`va_’d
(
­
);

405  
t
;

406 
	}
}

425 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

426 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

427 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

428 cÚ¡ *
f
 = 
fmt
;

429 
i
;

430 
va_li¡
 
­
;

432 
	`va_¡¬t
(
­
,
fmt
);

433 
f
 = 
fmt
;

434 
i
 = 
š™Ën
;

435 *
f
) {

436 
Ãxt
, *
¡r
;

437 
l
;

438 
num
;

439 
unum
;

442 ià(
sh
->
ä“
 == 0) {

443 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

444 
sh
 = (*è(
s
-((
sdshdr
)));

447 *
f
) {

449 
Ãxt
 = *(
f
+1);

450 
f
++;

451 
Ãxt
) {

454 
¡r
 = 
	`va_¬g
(
­
,*);

455 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

456 ià(
sh
->
ä“
 < 
l
) {

457 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

458 
sh
 = (*è(
s
-((
sdshdr
)));

460 
	`memıy
(
s
+
i
,
¡r
,
l
);

461 
sh
->
Ën
 +ğ
l
;

462 
sh
->
ä“
 -ğ
l
;

463 
i
 +ğ
l
;

467 ià(
Ãxt
 == 'i')

468 
num
 = 
	`va_¬g
(
­
,);

470 
num
 = 
	`va_¬g
(
­
,);

472 
buf
[
SDS_LLSTR_SIZE
];

473 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

474 ià(
sh
->
ä“
 < 
l
) {

475 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

476 
sh
 = (*è(
s
-((
sdshdr
)));

478 
	`memıy
(
s
+
i
,
buf
,
l
);

479 
sh
->
Ën
 +ğ
l
;

480 
sh
->
ä“
 -ğ
l
;

481 
i
 +ğ
l
;

487 ià(
Ãxt
 == 'u')

488 
unum
 = 
	`va_¬g
(
­
,);

489 if(
Ãxt
 == 'U')

490 
unum
 = 
	`va_¬g
(
­
,);

492 
unum
 = ()
	`va_¬g
(
­
,
size_t
);

494 
buf
[
SDS_LLSTR_SIZE
];

495 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

496 ià(
sh
->
ä“
 < 
l
) {

497 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

498 
sh
 = (*è(
s
-((
sdshdr
)));

500 
	`memıy
(
s
+
i
,
buf
,
l
);

501 
sh
->
Ën
 +ğ
l
;

502 
sh
->
ä“
 -ğ
l
;

503 
i
 +ğ
l
;

507 
s
[
i
++] = 
Ãxt
;

508 
sh
->
Ën
 += 1;

509 
sh
->
ä“
 -= 1;

514 
s
[
i
++] = *
f
;

515 
sh
->
Ën
 += 1;

516 
sh
->
ä“
 -= 1;

519 
f
++;

521 
	`va_’d
(
­
);

524 
s
[
i
] = '\0';

525  
s
;

526 
	}
}

543 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

544 
sdshdr
 *
sh
 = (*è(
s
- *sh);

545 *
¡¬t
, *
’d
, *
¥
, *
•
;

546 
size_t
 
Ën
;

548 
¥
 = 
¡¬t
 = 
s
;

549 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

550 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

551 
•
 > 
¡¬t
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

552 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

553 ià(
sh
->
buf
 !ğ
¥
è
	`memmove
(sh->buf, sp, 
Ën
);

554 
sh
->
buf
[
Ën
] = '\0';

555 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-len);

556 
sh
->
Ën
 =†en;

557 
	}
}

575 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

576 
sdshdr
 *
sh
 = (*è(
s
- *sh);

577 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

579 ià(
Ën
 == 0) ;

580 ià(
¡¬t
 < 0) {

581 
¡¬t
 = 
Ën
+start;

582 ià(
¡¬t
 < 0) start = 0;

584 ià(
’d
 < 0) {

585 
’d
 = 
Ën
+end;

586 ià(
’d
 < 0)ƒnd = 0;

588 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

589 ià(
ÃwËn
 != 0) {

590 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

591 
ÃwËn
 = 0;

592 } ià(
’d
 >ğ(sigÃd)
Ën
) {

593 
’d
 = 
Ën
-1;

594 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

597 
¡¬t
 = 0;

599 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
sh
->
buf
, sh->buf+start,‚ewlen);

600 
sh
->
buf
[
ÃwËn
] = 0;

601 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-
ÃwËn
);

602 
sh
->
Ën
 = 
ÃwËn
;

603 
	}
}

606 
	$sd¡Şow”
(
sds
 
s
) {

607 
Ën
 = 
	`sd¦’
(
s
), 
j
;

609 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

610 
	}
}

613 
	$sd¡ouµ”
(
sds
 
s
) {

614 
Ën
 = 
	`sd¦’
(
s
), 
j
;

616 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

617 
	}
}

630 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

631 
size_t
 
l1
, 
l2
, 
mšËn
;

632 
cmp
;

634 
l1
 = 
	`sd¦’
(
s1
);

635 
l2
 = 
	`sd¦’
(
s2
);

636 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

637 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

638 ià(
cmp
 =ğ0è 
l1
-
l2
;

639  
cmp
;

640 
	}
}

658 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

659 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

660 
sds
 *
tok’s
;

662 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

664 
tok’s
 = 
	`m®loc
((
sds
)*
¦Ùs
);

665 ià(
tok’s
 =ğ
NULL
)  NULL;

667 ià(
Ën
 == 0) {

668 *
couÁ
 = 0;

669  
tok’s
;

671 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

673 ià(
¦Ùs
 < 
–em’ts
+2) {

674 
sds
 *
Ãwtok’s
;

676 
¦Ùs
 *= 2;

677 
Ãwtok’s
 = 
	`»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

678 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

679 
tok’s
 = 
Ãwtok’s
;

682 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

683 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

684 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

685 
–em’ts
++;

686 
¡¬t
 = 
j
+
£¶’
;

687 
j
 = j+
£¶’
-1;

691 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

692 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

693 
–em’ts
++;

694 *
couÁ
 = 
–em’ts
;

695  
tok’s
;

697 
ş—nup
:

699 
i
;

700 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

701 
	`ä“
(
tok’s
);

702 *
couÁ
 = 0;

703  
NULL
;

705 
	}
}

708 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

709 ià(!
tok’s
) ;

710 
couÁ
--)

711 
	`sdsä“
(
tok’s
[
couÁ
]);

712 
	`ä“
(
tok’s
);

713 
	}
}

719 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

720 
buf
[32], *
p
;

721 
v
;

723 
v
 = (
v®ue
 < 0) ? -value : value;

724 
p
 = 
buf
+31;

726 *
p
-- = '0'+(
v
%10);

727 
v
 /= 10;

728 } 
v
);

729 ià(
v®ue
 < 0è*
p
-- = '-';

730 
p
++;

731  
	`sd¢ewËn
(
p
,32-Õ-
buf
));

732 
	}
}

740 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

741 
s
 = 
	`sdsÿ’
(s,"\"",1);

742 
Ën
--) {

743 *
p
) {

746 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

748 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

749 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

750 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

751 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

752 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

754 ià(
	`i¥ršt
(*
p
))

755 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

757 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

760 
p
++;

762  
	`sdsÿ’
(
s
,"\"",1);

763 
	}
}

767 
	$is_hex_dig™
(
c
) {

768  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

769 (
c
 >= 'A' && c <= 'F');

770 
	}
}

774 
	$hex_dig™_to_št
(
c
) {

775 
c
) {

794 
	}
}

815 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

816 cÚ¡ *
p
 = 
lše
;

817 *
cu¼’t
 = 
NULL
;

818 **
veùÜ
 = 
NULL
;

820 *
¬gc
 = 0;

823 *
p
 && 
	`is¥aû
(*p))…++;

824 ià(*
p
) {

826 
šq
=0;

827 
šsq
=0;

828 
dÚe
=0;

830 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

831 !
dÚe
) {

832 ià(
šq
) {

833 ià(*
p
 == '\\' && *(p+1) == 'x' &&

834 
	`is_hex_dig™
(*(
p
+2)) &&

835 
	`is_hex_dig™
(*(
p
+3)))

837 
by‹
;

839 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

840 
	`hex_dig™_to_št
(*(
p
+3));

841 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

842 
p
 += 3;

843 } ià(*
p
 == '\\' && *(p+1)) {

844 
c
;

846 
p
++;

847 *
p
) {

848 'n': 
c
 = '\n'; ;

849 'r': 
c
 = '\r'; ;

850 't': 
c
 = '\t'; ;

851 'b': 
c
 = '\b'; ;

852 'a': 
c
 = '\a'; ;

853 : 
c
 = *
p
; ;

855 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

856 } ià(*
p
 == '"') {

859 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

860 
dÚe
=1;

861 } ià(!*
p
) {

863 
”r
;

865 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

867 } ià(
šsq
) {

868 ià(*
p
 == '\\' && *(p+1) == '\'') {

869 
p
++;

870 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

871 } ià(*
p
 == '\'') {

874 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

875 
dÚe
=1;

876 } ià(!*
p
) {

878 
”r
;

880 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

883 *
p
) {

889 
dÚe
=1;

892 
šq
=1;

895 
šsq
=1;

898 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

902 ià(*
p
)…++;

905 
veùÜ
 = 
	`»®loc
(veùÜ,((*
¬gc
)+1)*(*));

906 
veùÜ
[*
¬gc
] = 
cu¼’t
;

907 (*
¬gc
)++;

908 
cu¼’t
 = 
NULL
;

911 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`m®loc
((*));

912  
veùÜ
;

916 
”r
:

917 (*
¬gc
)--)

918 
	`sdsä“
(
veùÜ
[*
¬gc
]);

919 
	`ä“
(
veùÜ
);

920 ià(
cu¼’t
è
	`sdsä“
(current);

921 *
¬gc
 = 0;

922  
NULL
;

923 
	}
}

934 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

935 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

937 
j
 = 0; j < 
l
; j++) {

938 
i
 = 0; i < 
£’
; i++) {

939 ià(
s
[
j
] =ğ
äom
[
i
]) {

940 
s
[
j
] = 
to
[
i
];

945  
s
;

946 
	}
}

950 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
, 
size_t
 
£¶’
) {

951 
sds
 
još
 = 
	`sd£m±y
();

952 
j
;

954 
j
 = 0; j < 
¬gc
; j++) {

955 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

956 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

958  
još
;

959 
	}
}

962 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

963 
sds
 
još
 = 
	`sd£m±y
();

964 
j
;

966 
j
 = 0; j < 
¬gc
; j++) {

967 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

968 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

970  
još
;

971 
	}
}

973 #ifdeà
SDS_TEST_MAIN


974 
	~<¡dio.h
>

975 
	~"‹¡h–p.h
"

977 
	$maš
() {

979 
sdshdr
 *
sh
;

980 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

982 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

983 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

985 
	`sdsä“
(
x
);

986 
x
 = 
	`sd¢ewËn
("foo",2);

987 
	`‹¡_cÚd
("Create‡ string with specified†ength",

988 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

990 
x
 = 
	`sdsÿt
(x,"bar");

991 
	`‹¡_cÚd
("Strings concatenation",

992 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

994 
x
 = 
	`sdsıy
(x,"a");

995 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

996 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

998 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

999 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1000 
	`sd¦’
(
x
) == 33 &&

1001 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1003 
	`sdsä“
(
x
);

1004 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1005 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1006 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) ==0)

1008 
	`sdsä“
(
x
);

1009 
x
 = 
	`sd¢ew
("xxciaoyyy");

1010 
	`sd¡rim
(
x
,"xy");

1011 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1012 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1014 
y
 = 
	`sdsdup
(
x
);

1015 
	`sd¤ªge
(
y
,1,1);

1016 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1017 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1019 
	`sdsä“
(
y
);

1020 
y
 = 
	`sdsdup
(
x
);

1021 
	`sd¤ªge
(
y
,1,-1);

1022 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1023 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1025 
	`sdsä“
(
y
);

1026 
y
 = 
	`sdsdup
(
x
);

1027 
	`sd¤ªge
(
y
,-2,-1);

1028 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1029 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1031 
	`sdsä“
(
y
);

1032 
y
 = 
	`sdsdup
(
x
);

1033 
	`sd¤ªge
(
y
,2,1);

1034 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1035 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1037 
	`sdsä“
(
y
);

1038 
y
 = 
	`sdsdup
(
x
);

1039 
	`sd¤ªge
(
y
,1,100);

1040 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1041 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1043 
	`sdsä“
(
y
);

1044 
y
 = 
	`sdsdup
(
x
);

1045 
	`sd¤ªge
(
y
,100,100);

1046 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1047 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1049 
	`sdsä“
(
y
);

1050 
	`sdsä“
(
x
);

1051 
x
 = 
	`sd¢ew
("foo");

1052 
y
 = 
	`sd¢ew
("foa");

1053 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1055 
	`sdsä“
(
y
);

1056 
	`sdsä“
(
x
);

1057 
x
 = 
	`sd¢ew
("bar");

1058 
y
 = 
	`sd¢ew
("bar");

1059 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1061 
	`sdsä“
(
y
);

1062 
	`sdsä“
(
x
);

1063 
x
 = 
	`sd¢ew
("aar");

1064 
y
 = 
	`sd¢ew
("bar");

1065 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1067 
	`sdsä“
(
y
);

1068 
	`sdsä“
(
x
);

1069 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1070 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1071 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1072 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1075 
Şdä“
;

1077 
	`sdsä“
(
x
);

1078 
x
 = 
	`sd¢ew
("0");

1079 
sh
 = (*è(
x
-((
sdshdr
)));

1080 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
sh
->
Ën
 =ğ1 && sh->
ä“
 == 0);

1081 
x
 = 
	`sdsMakeRoomFÜ
(x,1);

1082 
sh
 = (*è(
x
-((
sdshdr
)));

1083 
	`‹¡_cÚd
("sdsMakeRoomFÜ()", 
sh
->
Ën
 =ğ1 && sh->
ä“
 > 0);

1084 
Şdä“
 = 
sh
->
ä“
;

1085 
x
[1] = '1';

1086 
	`sdsInüL’
(
x
,1);

1087 
	`‹¡_cÚd
("sdsInüL’(è-- cÚ‹Á", 
x
[0] == '0' && x[1] == '1');

1088 
	`‹¡_cÚd
("sdsInüL’(è--†’", 
sh
->
Ën
 == 2);

1089 
	`‹¡_cÚd
("sdsInüL’(è-- f»e", 
sh
->
ä“
 =ğ
Şdä“
-1);

1092 
	`‹¡_»pÜt
()

1094 
	}
}

	@dep/himemcached-0.1.0/himcdep/sds.h

31 #iâdeà
__SDS_H


32 
	#__SDS_H


	)

34 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

36 
	~<sys/ty³s.h
>

37 
	~<¡d¬g.h
>

38 #ifdeà
_MSC_VER


39 
	~"wš32.h
"

42 *
	tsds
;

44 
	ssdshdr
 {

45 
	mËn
;

46 
	mä“
;

47 
	mbuf
[];

50 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

51 
sdshdr
 *
sh
 = (sdshd¸*)(
s
- *sh);

52  
sh
->
Ën
;

53 
	}
}

55 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

56 
sdshdr
 *
sh
 = (sdshd¸*)(
s
- *sh);

57  
sh
->
ä“
;

58 
	}
}

60 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

61 
sds
 
sd¢ew
(cÚ¡ *
š™
);

62 
sds
 
sd£m±y
();

63 
size_t
 
sd¦’
(cÚ¡ 
sds
 
s
);

64 
sds
 
sdsdup
(cÚ¡ sd 
s
);

65 
sdsä“
(
sds
 
s
);

66 
size_t
 
sd§va
(cÚ¡ 
sds
 
s
);

67 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

68 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

69 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

70 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

71 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

72 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

74 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

75 #ifdeà
__GNUC__


76 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

77 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

79 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

82 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

83 
	`sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
);

84 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

85 
	`sdsupd©–’
(
sds
 
s
);

86 
	`sdsş—r
(
sds
 
s
);

87 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

88 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

89 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

90 
	`sd¡Şow”
(
sds
 
s
);

91 
	`sd¡ouµ”
(
sds
 
s
);

92 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

93 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

94 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

95 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

96 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
, 
size_t
 
£¶’
);

97 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

100 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

101 
	`sdsInüL’
(
sds
 
s
, 
šü
);

102 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

103 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

	@dep/himemcached-0.1.0/himcdep/sds.h

31 #iâdeà
__SDS_H


32 
	#__SDS_H


	)

34 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

36 
	~<sys/ty³s.h
>

37 
	~<¡d¬g.h
>

38 #ifdeà
_MSC_VER


39 
	~"wš32.h
"

42 *
	tsds
;

44 
	ssdshdr
 {

45 
	mËn
;

46 
	mä“
;

47 
	mbuf
[];

50 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

51 
sdshdr
 *
sh
 = (sdshd¸*)(
s
- *sh);

52  
sh
->
Ën
;

53 
	}
}

55 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

56 
sdshdr
 *
sh
 = (sdshd¸*)(
s
- *sh);

57  
sh
->
ä“
;

58 
	}
}

60 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

61 
sds
 
sd¢ew
(cÚ¡ *
š™
);

62 
sds
 
sd£m±y
();

63 
size_t
 
sd¦’
(cÚ¡ 
sds
 
s
);

64 
sds
 
sdsdup
(cÚ¡ sd 
s
);

65 
sdsä“
(
sds
 
s
);

66 
size_t
 
sd§va
(cÚ¡ 
sds
 
s
);

67 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

68 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

69 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

70 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

71 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

72 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

74 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

75 #ifdeà
__GNUC__


76 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

77 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

79 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

82 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

83 
	`sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
);

84 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

85 
	`sdsupd©–’
(
sds
 
s
);

86 
	`sdsş—r
(
sds
 
s
);

87 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

88 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

89 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

90 
	`sd¡Şow”
(
sds
 
s
);

91 
	`sd¡ouµ”
(
sds
 
s
);

92 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

93 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

94 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

95 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

96 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
, 
size_t
 
£¶’
);

97 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

100 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

101 
	`sdsInüL’
(
sds
 
s
, 
šü
);

102 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

103 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

	@dep/himemcached-0.1.0/himcread.c

1 
	~<¡ršg.h
>

2 
	~<¡dlib.h
>

3 #iâdeà
_MSC_VER


4 
	~<uni¡d.h
>

6 
	~<as£¹.h
>

7 
	~<”ºo.h
>

8 
	~<ùy³.h
>

10 
	~"himü—d.h
"

11 
	~"himcd•/sds.h
"

13 
	#PARSE_OK
 0

	)

14 
	#PARSE_ERROR
 1

	)

15 
	#PARSE_AGAIN
 3

	)

17 
	#RSP_TYPE_UNKNOWN
 0

	)

18 
	#RSP_TYPE_NUM
 1

	)

19 
	#RSP_TYPE_STORED
 2

	)

20 
	#RSP_TYPE_NOT_STORED
 3

	)

21 
	#RSP_TYPE_EXISTS
 4

	)

22 
	#RSP_TYPE_NOT_FOUND
 5

	)

23 
	#RSP_TYPE_END
 6

	)

24 
	#RSP_TYPE_VALUE
 7

	)

25 
	#RSP_TYPE_DELETED
 8

	)

26 
	#RSP_TYPE_ERROR
 9

	)

27 
	#RSP_TYPE_CLIENT_ERROR
 10

	)

28 
	#RSP_TYPE_SERVER_ERROR
 11

	)

30 
memÿchedR—d”Re£t
(
mcR—d”
 *
r
);

32 
	$__memÿchedR—d”S‘E¼Ü
(
mcR—d”
 *
r
, 
ty³
, cÚ¡ *
¡r
) {

33 
size_t
 
Ën
;

35 
	`memÿchedR—d”Re£t
(
r
);

38 ià(
r
->
buf
 !ğ
NULL
) {

39 
	`sdsä“
(
r
->
buf
);

40 
r
->
buf
 = 
NULL
;

41 
r
->
pos
 =„->
Ën
 = 0;

45 
r
->
”r
 = 
ty³
;

46 
Ën
 = 
	`¡¾’
(
¡r
);

47 
Ën
 =†’ < ((
r
->
”r¡r
)-1) ?†en : ((r->errstr)-1);

48 
	`memıy
(
r
->
”r¡r
,
¡r
,
Ën
);

49 
r
->
”r¡r
[
Ën
] = '\0';

50 
	}
}

52 
size_t
 
	$ch¹os
(*
buf
, 
size_t
 
size
, 
by‹
)

54 
size_t
 
Ën
 = 0;

56 
by‹
) {

59 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\%c\"",
by‹
);

61 '\n': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\n\""); ;

62 '\r': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\r\""); ;

63 '\t': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\t\""); ;

64 '\a': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\a\""); ;

65 '\b': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\b\""); ;

67 ià(
	`i¥ršt
(
by‹
))

68 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"%c\"",
by‹
);

70 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\x%02x\"",()
by‹
);

74  
Ën
;

75 
	}
}

77 
	$__memÿchedR—d”S‘E¼ÜPrÙocŞBy‹
(
mcR—d”
 *
r
, 
by‹
) {

78 
cbuf
[8], 
sbuf
[128];

80 
	`ch¹os
(
cbuf
,(cbuf),
by‹
);

81 
	`¢´štf
(
sbuf
,(sbuf),

82 "PrÙocŞƒ¼Ü, gÙ % a »¶yy³ by‹", 
cbuf
);

83 
	`__memÿchedR—d”S‘E¼Ü
(
r
,
MC_ERR_PROTOCOL
,
sbuf
);

84 
	}
}

86 
	$__memÿchedR—d”S‘E¼ÜOOM
(
mcR—d”
 *
r
) {

87 
	`__memÿchedR—d”S‘E¼Ü
(
r
,
MC_ERR_OOM
,"Out of memory");

88 
	}
}

90 
	$–em’tA¼ayC»©e
(
mcR—d”
 *
r
)

92 
	`as£¹
(
r
->
®loc_Ën
 == 0);

93 
	`as£¹
(
r
->
–em’t
 =ğ
NULL
);

94 
	`as£¹
(
r
->
–em’ts
 == 0);

96 
r
->
–em’t
 = 
	`m®loc
(10*(*));

97 ià(
r
->
–em’t
 =ğ
NULL
) {

98 
	`__memÿchedR—d”S‘E¼ÜOOM
(
r
);

99  
MC_ERR
;

101 
r
->
®loc_Ën
 = 10;

102 
r
->
–em’ts
 = 0;

104  
MC_OK
;

105 
	}
}

107 
	$–em’tA¼ayDe¡roy
(
mcR—d”
 *
r
)

109 
i
;

111 ià(
r
->
–em’t
 =ğ
NULL
)

114 ià(
r
->
â
 &&„->â->
ä“Objeù
) {

115 
i
 = 0; i < 
r
->
–em’ts
; i ++) {

116 ià(
r
->
–em’t
[
i
])

117 
r
->
â
->
	`ä“Objeù
Ô->
–em’t
[
i
]);

120 
	`ä“
(
r
->
–em’t
);

121 
r
->
–em’t
 = 
NULL
;

122 
r
->
–em’ts
 = 0;

123 
r
->
®loc_Ën
 = 0;

125  
MC_OK
;

126 
	}
}

128 
	#EXPAND_MAX_SIZE_PER_TIME
 300

	)

129 
	$–em’tA¼ayEx·nd
(
mcR—d”
 *
r
)

131 
size_t
 
Ãw_Ëngth
;

132 ià(
r
->
®loc_Ën
 <= 150) {

133 
Ãw_Ëngth
 = 
r
->
®loc_Ën
*2;

134 } ià(
r
->
®loc_Ën
 <= 500) {

135 
Ãw_Ëngth
 = 
r
->
®loc_Ën
+
EXPAND_MAX_SIZE_PER_TIME
;

137 
r
->
–em’t
 = 
	`»®loc
Ô->–em’t,
Ãw_Ëngth
*(*));

138 ià(
r
->
–em’t
 =ğ
NULL
) {

139 
	`__memÿchedR—d”S‘E¼ÜOOM
(
r
);

140  
MC_ERR
;

142 
r
->
®loc_Ën
 = 
Ãw_Ëngth
;

144  
MC_OK
;

145 
	}
}

147 
	$–em’tA¼ayAdd
(
mcR—d”
 *
r
, *
»¶y
)

149 
	`as£¹
(
r
->
–em’ts
 <ğr->
®loc_Ën
);

150 ià(
r
->
–em’ts
 =ğr->
®loc_Ën
) {

151 ià(
	`–em’tA¼ayEx·nd
(
r
è!ğ
MC_OK
)

152  
MC_ERR
;

154 
r
->
–em’t
[r->
–em’ts
++] = 
»¶y
;

156  
MC_OK
;

157 
	}
}

159 
	$memÿchedP¬£Re¥Ú£
(
mcR—d”
 *
r
)

161 *
obj
;

162 *
p
, *
m
;

163 
ch
;

165 
SW_START
,

166 
SW_RSP_NUM
,

167 
SW_RSP_STR
,

168 
SW_SPACES_BEFORE_KEY
,

169 
SW_KEY
,

170 
SW_SPACES_BEFORE_FLAGS
,

171 
SW_FLAGS
,

172 
SW_SPACES_BEFORE_VLEN
,

173 
SW_VLEN
,

174 
SW_RUNTO_VAL
,

175 
SW_VAL
,

176 
SW_VAL_LF
,

177 
SW_END
,

178 
SW_RUNTO_CRLF
,

179 
SW_CRLF
,

180 
SW_ALMOST_DONE
,

181 
SW_SENTINEL


182 } 
¡©e
;

184 
¡©e
 = 
r
->state;

186 
	`as£¹
(
¡©e
 >ğ
SW_START
 && s‹ < 
SW_SENTINEL
);

189 
	`as£¹
(
r
->
buf
 !ğ
NULL
);

190 
	`as£¹
(
r
->
pos
 <„->
Ën
);

192 
p
 = 
r
->
buf
+r->
pos
;… <ğr->buf+r->
Ën
;…++) {

193 
ch
 = *
p
;

195 
¡©e
) {

196 
SW_START
:

197 ià(
	`isdig™
(
ch
)) {

198 
¡©e
 = 
SW_RSP_NUM
;

200 
¡©e
 = 
SW_RSP_STR
;

202 
p
 =… - 1;

206 
SW_RSP_NUM
:

207 ià(
r
->
tok’
 =ğ
NULL
) {

209 
r
->
tok’
 = 
p
;

212 ià(
	`isdig™
(
ch
)) {

214 
r
->
š‹g”
 =„->š‹g”*10 + ()(
ch
-'0');

215 } ià(
ch
 == ' ' || ch == '\r') {

217 
r
->
tok’
 = 
NULL
;

218 
r
->
š‹g”
 = 0;

219 
r
->
ty³
 = 
RSP_TYPE_NUM
;

220 
p
 =… - 1;

221 
¡©e
 = 
SW_CRLF
;

223 
”rÜ
;

228 
SW_RSP_STR
:

229 ià(
r
->
tok’
 =ğ
NULL
) {

231 
r
->
tok’
 = 
p
;

234 ià(
ch
 == ' ' || ch == '\r') {

236 
m
 = 
r
->
tok’
;

238 
r
->
ty³
 = 
RSP_TYPE_UNKNOWN
;

239 
	`as£¹
(
r
->
¡r
 =ğ
NULL
 &&„->
¡¾’
 == 0);

241 
p
 - 
m
) {

243 ià(!
	`¡ºcmp
(
m
,"END\r",4)) {

244 
r
->
ty³
 = 
RSP_TYPE_END
;

251 ià(!
	`¡ºcmp
(
m
,"VALUE",5)) {

256 
r
->
ty³
 = 
RSP_TYPE_VALUE
;

260 ià(!
	`¡ºcmp
(
m
,"ERROR",5)) {

261 
r
->
ty³
 = 
RSP_TYPE_ERROR
;

268 ià(!
	`¡ºcmp
(
m
,"STORED",6)) {

269 
r
->
ty³
 = 
RSP_TYPE_STORED
;

271 
r
->
¡r
 = 
m
;

272 
r
->
¡¾’
 = 6;

276 ià(!
	`¡ºcmp
(
m
,"EXISTS",6)) {

277 
r
->
ty³
 = 
RSP_TYPE_EXISTS
;

279 
r
->
¡r
 = 
m
;

280 
r
->
¡¾’
 = 6;

287 ià(!
	`¡ºcmp
(
m
,"DELETED",7)) {

288 
r
->
ty³
 = 
RSP_TYPE_DELETED
;

290 
r
->
¡r
 = 
m
;

291 
r
->
¡¾’
 = 7;

298 ià(!
	`¡ºcmp
(
m
,"NOT_FOUND",9)) {

299 
r
->
ty³
 = 
RSP_TYPE_NOT_FOUND
;

301 
r
->
¡r
 = 
m
;

302 
r
->
¡¾’
 = 9;

309 ià(!
	`¡ºcmp
(
m
,"NOT_STORED",10)) {

310 
r
->
ty³
 = 
RSP_TYPE_NOT_STORED
;

312 
r
->
¡r
 = 
m
;

313 
r
->
¡¾’
 = 10;

320 ià(!
	`¡ºcmp
(
m
,"CLIENT_ERROR",12)) {

321 
r
->
ty³
 = 
RSP_TYPE_CLIENT_ERROR
;

325 ià(!
	`¡ºcmp
(
m
,"SERVER_ERROR",12)) {

326 
r
->
ty³
 = 
RSP_TYPE_SERVER_ERROR
;

333 
r
->
ty³
) {

334 
RSP_TYPE_UNKNOWN
:

335 
”rÜ
;

337 
RSP_TYPE_STORED
:

338 
RSP_TYPE_NOT_STORED
:

339 
RSP_TYPE_EXISTS
:

340 
RSP_TYPE_NOT_FOUND
:

341 
RSP_TYPE_DELETED
:

342 
¡©e
 = 
SW_CRLF
;

345 
RSP_TYPE_END
:

346 
¡©e
 = 
SW_CRLF
;

349 
RSP_TYPE_VALUE
:

350 
¡©e
 = 
SW_SPACES_BEFORE_KEY
;

353 
RSP_TYPE_ERROR
:

354 
¡©e
 = 
SW_CRLF
;

357 
RSP_TYPE_CLIENT_ERROR
:

358 
RSP_TYPE_SERVER_ERROR
:

359 
r
->
tok’
 = 
NULL
;

360 
¡©e
 = 
SW_RUNTO_CRLF
;

364 
	`NOT_REACHED
();

367 
p
 =… - 1;

372 
SW_SPACES_BEFORE_KEY
:

373 ià(
ch
 != ' ') {

374 
¡©e
 = 
SW_KEY
;

375 
p
 =… - 1;

376 
r
->
tok’
 = 
NULL
;

381 
SW_KEY
:

382 ià(
r
->
tok’
 =ğ
NULL
) {

383 
r
->
tok’
 = 
p
;

386 ià(
ch
 == ' ') {

387 
	`as£¹
(
r
->
¡r
 =ğ
NULL
 &&„->
¡¾’
 == 0);

388 
m
 = 
r
->
tok’
;

389 
r
->
tok’
 = 
NULL
;

390 
¡©e
 = 
SW_SPACES_BEFORE_FLAGS
;

391 
r
->
¡¾’
 = 
p
-
m
;

392 
r
->
¡r
 = 
m
;

397 
SW_SPACES_BEFORE_FLAGS
:

398 ià(
ch
 != ' ') {

399 ià(!
	`isdig™
(
ch
)) {

400 
”rÜ
;

402 
¡©e
 = 
SW_FLAGS
;

403 
p
 =… - 1;

404 
r
->
kæags
 = 0;

409 
SW_FLAGS
:

410 ià(
	`isdig™
(
ch
)) {

412 
r
->
kæags
 =„->kæags*10 + ()(
ch
-'0');

413 } ià(
ch
 == ' ') {

416 
¡©e
 = 
SW_SPACES_BEFORE_VLEN
;

418 
”rÜ
;

423 
SW_SPACES_BEFORE_VLEN
:

424 ià(
ch
 != ' ') {

425 ià(!
	`isdig™
(
ch
)) {

426 
”rÜ
;

428 
p
 =… - 1;

429 
¡©e
 = 
SW_VLEN
;

430 
r
->
š‹g”
 = 0;

435 
SW_VLEN
:

436 ià(
	`isdig™
(
ch
)) {

437 
r
->
š‹g”
 =„->š‹g”*10 + ()(
ch
-'0');

438 } ià(
ch
 == ' ' || ch == '\r') {

440 
p
 =… - 1;

442 
¡©e
 = 
SW_RUNTO_CRLF
;

444 
”rÜ
;

449 
SW_RUNTO_VAL
:

450 
ch
) {

453 
¡©e
 = 
SW_VAL
;

454 
r
->
tok’
 = 
NULL
;

458 
”rÜ
;

463 
SW_VAL
:

464 ià(
r
->
tok’
 =ğ
NULL
) {

466 
r
->
tok’
 = 
p
;

469 
m
 = 
r
->
tok’
 +„->
š‹g”
;

470 ià(
m
 > 
r
->
buf
+r->
Ën
) {

471 
p
 = 
r
->
buf
 +„->
Ën
;

475 *
m
) {

478 
p
 = 
m
;

479 
¡©e
 = 
SW_VAL_LF
;

483 
”rÜ
;

488 
SW_VAL_LF
:

489 
ch
) {

492 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

493 
obj
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_STRING
,r->
¡r
,r->
¡¾’
,

494 
r
->
tok’
,r->
š‹g”
,r->
kæags
,r->
kv”siÚ
);

496 
obj
 = (*)
MC_REPLY_STRING
;

497 ià(
r
->
–em’t
) {

498 
	`as£¹
(
r
->
sub»¶y
 =ğ
NULL
);

499 
	`–em’tA¼ayAdd
(
r
,r->
sub»¶y
);

500 } ià(
r
->
sub»¶y
) {

501 
	`–em’tA¼ayC»©e
(
r
);

502 
	`–em’tA¼ayAdd
(
r
,r->
sub»¶y
);

503 
r
->
sub»¶y
 = 
NULL
;

504 
	`–em’tA¼ayAdd
(
r
,
obj
);

506 
r
->
sub»¶y
 = 
obj
;

509 
r
->
tok’
 = 
NULL
;

510 
r
->
¡r
 = 
NULL
;

511 
r
->
¡¾’
 = 0;

512 
r
->
kæags
 = 0;

513 
r
->
kv”siÚ
 = -1;

514 
¡©e
 = 
SW_RSP_STR
;

518 
”rÜ
;

523 
SW_END
:

524 ià(
r
->
tok’
 =ğ
NULL
) {

525 ià(
ch
 != 'E') {

526 
”rÜ
;

529 
r
->
tok’
 = 
p
;

530 } ià(
ch
 == '\r') {

532 
m
 = 
r
->
tok’
;

533 
r
->
tok’
 = 
NULL
;

535 
p
 - 
m
) {

537 ià(!
	`¡ºcmp
(
m
,"END\r",4)) {

538 
¡©e
 = 
SW_ALMOST_DONE
;

543 
”rÜ
;

549 
SW_RUNTO_CRLF
:

550 
ch
) {

552 ià(
r
->
ty³
 =ğ
RSP_TYPE_VALUE
) {

553 
¡©e
 = 
SW_RUNTO_VAL
;

555 ià(
r
->
ty³
 =ğ
RSP_TYPE_CLIENT_ERROR
 ||

556 
r
->
ty³
 =ğ
RSP_TYPE_SERVER_ERROR
) {

557 
m
 = 
r
->
tok’
;

558 
r
->
tok’
 = 
NULL
;

559 
r
->
¡¾’
 = 
p
-
m
;

560 
r
->
¡r
 = 
m
;

562 
¡©e
 = 
SW_ALMOST_DONE
;

573 
SW_CRLF
:

574 
ch
) {

579 
¡©e
 = 
SW_ALMOST_DONE
;

583 
”rÜ
;

588 
SW_ALMOST_DONE
:

589 
ch
) {

592 
dÚe
;

595 
”rÜ
;

600 
SW_SENTINEL
:

602 
	`NOT_REACHED
();

608 
	`as£¹
(
p
 =ğ
r
->
buf
+r->
Ën
);

609 
r
->
pos
 =„->
Ën
;

610 
r
->
¡©e
 = state;

612 
r
->
»suÉ
 = 
PARSE_AGAIN
;

616 
dÚe
:

617 
r
->
pos
 = 
p
-r->
buf
+1;

618 
	`as£¹
(
r
->
pos
 <ğr->
Ën
);

619 
r
->
¡©e
 = 
SW_START
;

620 
r
->
tok’
 = 
NULL
;

621 
r
->
»suÉ
 = 
PARSE_OK
;

625 
”rÜ
:

626 
r
->
»suÉ
 = 
PARSE_ERROR
;

627 
r
->
¡©e
 = state;

628 
”ºo
 = 
EINVAL
;

629 
	}
}

631 
mcR—d”
 *
	$memÿchedR—d”C»©eW™hFunùiÚs
(
mcR•lyObjeùFunùiÚs
 *
â
)

633 
mcR—d”
 *
r
;

635 
r
 = 
	`ÿÎoc
((
mcR—d”
),1);

636 ià(
r
 =ğ
NULL
)

637  
NULL
;

639 
r
->
”r
 = 0;

640 
r
->
”r¡r
[0] = '\0';

641 
r
->
buf
 = 
	`sd£m±y
();

642 
r
->
maxbuf
 = 
MC_READER_MAX_BUF
;

643 ià(
r
->
buf
 =ğ
NULL
) {

644 
	`ä“
(
r
);

645  
NULL
;

648 
r
->
sub»¶y
 = 
NULL
;

649 
r
->
®loc_Ën
 = 0;

650 
r
->
–em’ts
 = 0;

651 
r
->
–em’t
 = 
NULL
;

653 
r
->
¡©e
 = 0;

654 
r
->
tok’
 = 
NULL
;

656 
r
->
¡r
 = 
NULL
;

657 
r
->
¡¾’
 = 0;

658 
r
->
kæags
 = 0;

659 
r
->
kv”siÚ
 = -1;

660 
r
->
š‹g”
 = 0;

661 
r
->
ty³
 = 
RSP_TYPE_UNKNOWN
;

662 
r
->
»suÉ
 = 
PARSE_OK
;

664 
r
->
â
 = fn;

666  
r
;

667 
	}
}

669 
	$memÿchedR—d”F»e
(
mcR—d”
 *
r
)

671 
	`memÿchedR—d”Re£t
(
r
);

673 ià(
r
->
buf
 !ğ
NULL
)

674 
	`sdsä“
(
r
->
buf
);

675 
	`ä“
(
r
);

676 
	}
}

678 
	$memÿchedR—d”F“d
(
mcR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
)

680 
sds
 
Ãwbuf
;

683 ià(
r
->
”r
)

684  
MC_ERR
;

687 ià(
buf
 !ğ
NULL
 && 
Ën
 >= 1) {

689 ià(
r
->
Ën
 =ğ0 &&„->
maxbuf
 !ğ0 && 
	`sd§va
Ô->
buf
) >„->maxbuf) {

690 
	`sdsä“
(
r
->
buf
);

691 
r
->
buf
 = 
	`sd£m±y
();

692 
r
->
pos
 = 0;

695 
	`as£¹
(
r
->
buf
 !ğ
NULL
);

698 
Ãwbuf
 = 
	`sdsÿ’
(
r
->
buf
,buf,
Ën
);

699 ià(
Ãwbuf
 =ğ
NULL
) {

700 
	`__memÿchedR—d”S‘E¼ÜOOM
(
r
);

701  
MC_ERR
;

704 
r
->
buf
 = 
Ãwbuf
;

705 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

708  
MC_OK
;

709 
	}
}

711 
	$memÿchedR—d”Re£t
(
mcR—d”
 *
r
)

713 
r
->
¡r
 = 
NULL
;

714 
r
->
¡¾’
 = 0;

715 
r
->
kæags
 = 0;

716 
r
->
kv”siÚ
 = -1;

718 
r
->
¡©e
 = 0;

719 
r
->
tok’
 = 0;

721 
r
->
š‹g”
 = 0;

723 
r
->
ty³
 = 
RSP_TYPE_UNKNOWN
;

724 
r
->
»suÉ
 = 
PARSE_OK
;

726 ià(
r
->
sub»¶y
 !ğ
NULL
) {

727 ià(
r
->
â
 &&„->â->
ä“Objeù
)

728 
r
->
â
->
	`ä“Objeù
Ô->
sub»¶y
);

730 
r
->
sub»¶y
 = 
NULL
;

733 
	`–em’tA¼ayDe¡roy
(
r
);

735 
r
->
”r
 = 0;

736 
r
->
”r¡r
[0] = '\0';

737 
	}
}

739 *
	$g‘R•lyFromR—d”
(
mcR—d”
 *
r
)

741 *
»¶y
;

743 
r
->
ty³
) {

744 
RSP_TYPE_VALUE
:

745 ià(
r
->
–em’t
) {

746 
	`as£¹
(
r
->
sub»¶y
 =ğ
NULL
);

747 ià(
r
->
â
 &&„->â->
ü—‹A¼ay
) {

748 
»¶y
 = 
r
->
â
->
	`ü—‹A¼ay
Ô->
–em’ts
,r->
–em’t
);

749 
r
->
–em’t
 = 
NULL
;

750 
r
->
–em’ts
 = 0;

751 
r
->
®loc_Ën
 = 0;

753 
»¶y
 = (*)
MC_REPLY_ARRAY
;

755 } ià(
r
->
sub»¶y
) {

756 
»¶y
 = 
r
->
sub»¶y
;

759 
RSP_TYPE_NUM
:

760 ià(
r
->
â
 &&„->â->
ü—‹IÁeg”
)

761 
»¶y
 = 
r
->
â
->
	`ü—‹IÁeg”
Ô->
š‹g”
);

763 
»¶y
 = (*)
MC_REPLY_INTEGER
;

765 
RSP_TYPE_END
:

766 ià(
r
->
â
 &&„->â->
ü—‹N
)

767 
»¶y
 = 
r
->
â
->
	`ü—‹N
();

769 
»¶y
 = (*)
MC_REPLY_NIL
;

771 
RSP_TYPE_CLIENT_ERROR
:

772 
RSP_TYPE_SERVER_ERROR
:

773 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

774 
»¶y
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_ERROR
,

775 
NULL
,0,
r
->
¡r
,r->
¡¾’
,0,0);

777 
»¶y
 = (*)
MC_REPLY_ERROR
;

779 
RSP_TYPE_ERROR
:

780 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

781 
»¶y
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_ERROR
,

782 
NULL
,0,"",0,0,0);

784 
»¶y
 = (*)
MC_REPLY_ERROR
;

786 
RSP_TYPE_STORED
:

787 
RSP_TYPE_NOT_STORED
:

788 
RSP_TYPE_EXISTS
:

789 
RSP_TYPE_NOT_FOUND
:

790 
RSP_TYPE_DELETED
:

791 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

792 
»¶y
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_STATUS
,

793 
NULL
,0,
r
->
¡r
,r->
¡¾’
,0,0);

795 
»¶y
 = (*)
MC_REPLY_STATUS
;

798 
»¶y
 = 
NULL
;

802  
»¶y
;

803 
	}
}

805 
	$memÿchedR—d”G‘R•ly
(
mcR—d”
 *
r
, **
»¶y
) {

807 ià(
»¶y
 !ğ
NULL
)

808 *
»¶y
 = 
NULL
;

811 ià(
r
->
”r
)

812  
MC_ERR
;

815 ià(
r
->
Ën
 == 0)

816  
MC_OK
;

818 
	`memÿchedP¬£Re¥Ú£
(
r
);

821 ià(
r
->
”r
)

822  
MC_ERR
;

831 ià(
r
->
»suÉ
 =ğ
PARSE_OK
) {

832 ià(
»¶y
 !ğ
NULL
) {

833 *
»¶y
 = 
	`g‘R•lyFromR—d”
(
r
);

835 
	`memÿchedR—d”Re£t
(
r
);

840 ià(
r
->
pos
 >ğ1024 &&„->
tok’
 =ğ
NULL
 &&„->
¡r
 == NULL) {

841 
	`sd¤ªge
(
r
->
buf
,r->
pos
,-1);

842 
r
->
pos
 = 0;

843 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

846  
MC_OK
;

847 
	}
}

	@dep/himemcached-0.1.0/himcread.c

1 
	~<¡ršg.h
>

2 
	~<¡dlib.h
>

3 #iâdeà
_MSC_VER


4 
	~<uni¡d.h
>

6 
	~<as£¹.h
>

7 
	~<”ºo.h
>

8 
	~<ùy³.h
>

10 
	~"himü—d.h
"

11 
	~"himcd•/sds.h
"

13 
	#PARSE_OK
 0

	)

14 
	#PARSE_ERROR
 1

	)

15 
	#PARSE_AGAIN
 3

	)

17 
	#RSP_TYPE_UNKNOWN
 0

	)

18 
	#RSP_TYPE_NUM
 1

	)

19 
	#RSP_TYPE_STORED
 2

	)

20 
	#RSP_TYPE_NOT_STORED
 3

	)

21 
	#RSP_TYPE_EXISTS
 4

	)

22 
	#RSP_TYPE_NOT_FOUND
 5

	)

23 
	#RSP_TYPE_END
 6

	)

24 
	#RSP_TYPE_VALUE
 7

	)

25 
	#RSP_TYPE_DELETED
 8

	)

26 
	#RSP_TYPE_ERROR
 9

	)

27 
	#RSP_TYPE_CLIENT_ERROR
 10

	)

28 
	#RSP_TYPE_SERVER_ERROR
 11

	)

30 
memÿchedR—d”Re£t
(
mcR—d”
 *
r
);

32 
	$__memÿchedR—d”S‘E¼Ü
(
mcR—d”
 *
r
, 
ty³
, cÚ¡ *
¡r
) {

33 
size_t
 
Ën
;

35 
	`memÿchedR—d”Re£t
(
r
);

38 ià(
r
->
buf
 !ğ
NULL
) {

39 
	`sdsä“
(
r
->
buf
);

40 
r
->
buf
 = 
NULL
;

41 
r
->
pos
 =„->
Ën
 = 0;

45 
r
->
”r
 = 
ty³
;

46 
Ën
 = 
	`¡¾’
(
¡r
);

47 
Ën
 =†’ < ((
r
->
”r¡r
)-1) ?†en : ((r->errstr)-1);

48 
	`memıy
(
r
->
”r¡r
,
¡r
,
Ën
);

49 
r
->
”r¡r
[
Ën
] = '\0';

50 
	}
}

52 
size_t
 
	$ch¹os
(*
buf
, 
size_t
 
size
, 
by‹
)

54 
size_t
 
Ën
 = 0;

56 
by‹
) {

59 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\%c\"",
by‹
);

61 '\n': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\n\""); ;

62 '\r': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\r\""); ;

63 '\t': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\t\""); ;

64 '\a': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\a\""); ;

65 '\b': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\b\""); ;

67 ià(
	`i¥ršt
(
by‹
))

68 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"%c\"",
by‹
);

70 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\x%02x\"",()
by‹
);

74  
Ën
;

75 
	}
}

77 
	$__memÿchedR—d”S‘E¼ÜPrÙocŞBy‹
(
mcR—d”
 *
r
, 
by‹
) {

78 
cbuf
[8], 
sbuf
[128];

80 
	`ch¹os
(
cbuf
,(cbuf),
by‹
);

81 
	`¢´štf
(
sbuf
,(sbuf),

82 "PrÙocŞƒ¼Ü, gÙ % a »¶yy³ by‹", 
cbuf
);

83 
	`__memÿchedR—d”S‘E¼Ü
(
r
,
MC_ERR_PROTOCOL
,
sbuf
);

84 
	}
}

86 
	$__memÿchedR—d”S‘E¼ÜOOM
(
mcR—d”
 *
r
) {

87 
	`__memÿchedR—d”S‘E¼Ü
(
r
,
MC_ERR_OOM
,"Out of memory");

88 
	}
}

90 
	$–em’tA¼ayC»©e
(
mcR—d”
 *
r
)

92 
	`as£¹
(
r
->
®loc_Ën
 == 0);

93 
	`as£¹
(
r
->
–em’t
 =ğ
NULL
);

94 
	`as£¹
(
r
->
–em’ts
 == 0);

96 
r
->
–em’t
 = 
	`m®loc
(10*(*));

97 ià(
r
->
–em’t
 =ğ
NULL
) {

98 
	`__memÿchedR—d”S‘E¼ÜOOM
(
r
);

99  
MC_ERR
;

101 
r
->
®loc_Ën
 = 10;

102 
r
->
–em’ts
 = 0;

104  
MC_OK
;

105 
	}
}

107 
	$–em’tA¼ayDe¡roy
(
mcR—d”
 *
r
)

109 
i
;

111 ià(
r
->
–em’t
 =ğ
NULL
)

114 ià(
r
->
â
 &&„->â->
ä“Objeù
) {

115 
i
 = 0; i < 
r
->
–em’ts
; i ++) {

116 ià(
r
->
–em’t
[
i
])

117 
r
->
â
->
	`ä“Objeù
Ô->
–em’t
[
i
]);

120 
	`ä“
(
r
->
–em’t
);

121 
r
->
–em’t
 = 
NULL
;

122 
r
->
–em’ts
 = 0;

123 
r
->
®loc_Ën
 = 0;

125  
MC_OK
;

126 
	}
}

128 
	#EXPAND_MAX_SIZE_PER_TIME
 300

	)

129 
	$–em’tA¼ayEx·nd
(
mcR—d”
 *
r
)

131 
size_t
 
Ãw_Ëngth
;

132 ià(
r
->
®loc_Ën
 <= 150) {

133 
Ãw_Ëngth
 = 
r
->
®loc_Ën
*2;

134 } ià(
r
->
®loc_Ën
 <= 500) {

135 
Ãw_Ëngth
 = 
r
->
®loc_Ën
+
EXPAND_MAX_SIZE_PER_TIME
;

137 
r
->
–em’t
 = 
	`»®loc
Ô->–em’t,
Ãw_Ëngth
*(*));

138 ià(
r
->
–em’t
 =ğ
NULL
) {

139 
	`__memÿchedR—d”S‘E¼ÜOOM
(
r
);

140  
MC_ERR
;

142 
r
->
®loc_Ën
 = 
Ãw_Ëngth
;

144  
MC_OK
;

145 
	}
}

147 
	$–em’tA¼ayAdd
(
mcR—d”
 *
r
, *
»¶y
)

149 
	`as£¹
(
r
->
–em’ts
 <ğr->
®loc_Ën
);

150 ià(
r
->
–em’ts
 =ğr->
®loc_Ën
) {

151 ià(
	`–em’tA¼ayEx·nd
(
r
è!ğ
MC_OK
)

152  
MC_ERR
;

154 
r
->
–em’t
[r->
–em’ts
++] = 
»¶y
;

156  
MC_OK
;

157 
	}
}

159 
	$memÿchedP¬£Re¥Ú£
(
mcR—d”
 *
r
)

161 *
obj
;

162 *
p
, *
m
;

163 
ch
;

165 
SW_START
,

166 
SW_RSP_NUM
,

167 
SW_RSP_STR
,

168 
SW_SPACES_BEFORE_KEY
,

169 
SW_KEY
,

170 
SW_SPACES_BEFORE_FLAGS
,

171 
SW_FLAGS
,

172 
SW_SPACES_BEFORE_VLEN
,

173 
SW_VLEN
,

174 
SW_RUNTO_VAL
,

175 
SW_VAL
,

176 
SW_VAL_LF
,

177 
SW_END
,

178 
SW_RUNTO_CRLF
,

179 
SW_CRLF
,

180 
SW_ALMOST_DONE
,

181 
SW_SENTINEL


182 } 
¡©e
;

184 
¡©e
 = 
r
->state;

186 
	`as£¹
(
¡©e
 >ğ
SW_START
 && s‹ < 
SW_SENTINEL
);

189 
	`as£¹
(
r
->
buf
 !ğ
NULL
);

190 
	`as£¹
(
r
->
pos
 <„->
Ën
);

192 
p
 = 
r
->
buf
+r->
pos
;… <ğr->buf+r->
Ën
;…++) {

193 
ch
 = *
p
;

195 
¡©e
) {

196 
SW_START
:

197 ià(
	`isdig™
(
ch
)) {

198 
¡©e
 = 
SW_RSP_NUM
;

200 
¡©e
 = 
SW_RSP_STR
;

202 
p
 =… - 1;

206 
SW_RSP_NUM
:

207 ià(
r
->
tok’
 =ğ
NULL
) {

209 
r
->
tok’
 = 
p
;

212 ià(
	`isdig™
(
ch
)) {

214 
r
->
š‹g”
 =„->š‹g”*10 + ()(
ch
-'0');

215 } ià(
ch
 == ' ' || ch == '\r') {

217 
r
->
tok’
 = 
NULL
;

218 
r
->
š‹g”
 = 0;

219 
r
->
ty³
 = 
RSP_TYPE_NUM
;

220 
p
 =… - 1;

221 
¡©e
 = 
SW_CRLF
;

223 
”rÜ
;

228 
SW_RSP_STR
:

229 ià(
r
->
tok’
 =ğ
NULL
) {

231 
r
->
tok’
 = 
p
;

234 ià(
ch
 == ' ' || ch == '\r') {

236 
m
 = 
r
->
tok’
;

238 
r
->
ty³
 = 
RSP_TYPE_UNKNOWN
;

239 
	`as£¹
(
r
->
¡r
 =ğ
NULL
 &&„->
¡¾’
 == 0);

241 
p
 - 
m
) {

243 ià(!
	`¡ºcmp
(
m
,"END\r",4)) {

244 
r
->
ty³
 = 
RSP_TYPE_END
;

251 ià(!
	`¡ºcmp
(
m
,"VALUE",5)) {

256 
r
->
ty³
 = 
RSP_TYPE_VALUE
;

260 ià(!
	`¡ºcmp
(
m
,"ERROR",5)) {

261 
r
->
ty³
 = 
RSP_TYPE_ERROR
;

268 ià(!
	`¡ºcmp
(
m
,"STORED",6)) {

269 
r
->
ty³
 = 
RSP_TYPE_STORED
;

271 
r
->
¡r
 = 
m
;

272 
r
->
¡¾’
 = 6;

276 ià(!
	`¡ºcmp
(
m
,"EXISTS",6)) {

277 
r
->
ty³
 = 
RSP_TYPE_EXISTS
;

279 
r
->
¡r
 = 
m
;

280 
r
->
¡¾’
 = 6;

287 ià(!
	`¡ºcmp
(
m
,"DELETED",7)) {

288 
r
->
ty³
 = 
RSP_TYPE_DELETED
;

290 
r
->
¡r
 = 
m
;

291 
r
->
¡¾’
 = 7;

298 ià(!
	`¡ºcmp
(
m
,"NOT_FOUND",9)) {

299 
r
->
ty³
 = 
RSP_TYPE_NOT_FOUND
;

301 
r
->
¡r
 = 
m
;

302 
r
->
¡¾’
 = 9;

309 ià(!
	`¡ºcmp
(
m
,"NOT_STORED",10)) {

310 
r
->
ty³
 = 
RSP_TYPE_NOT_STORED
;

312 
r
->
¡r
 = 
m
;

313 
r
->
¡¾’
 = 10;

320 ià(!
	`¡ºcmp
(
m
,"CLIENT_ERROR",12)) {

321 
r
->
ty³
 = 
RSP_TYPE_CLIENT_ERROR
;

325 ià(!
	`¡ºcmp
(
m
,"SERVER_ERROR",12)) {

326 
r
->
ty³
 = 
RSP_TYPE_SERVER_ERROR
;

333 
r
->
ty³
) {

334 
RSP_TYPE_UNKNOWN
:

335 
”rÜ
;

337 
RSP_TYPE_STORED
:

338 
RSP_TYPE_NOT_STORED
:

339 
RSP_TYPE_EXISTS
:

340 
RSP_TYPE_NOT_FOUND
:

341 
RSP_TYPE_DELETED
:

342 
¡©e
 = 
SW_CRLF
;

345 
RSP_TYPE_END
:

346 
¡©e
 = 
SW_CRLF
;

349 
RSP_TYPE_VALUE
:

350 
¡©e
 = 
SW_SPACES_BEFORE_KEY
;

353 
RSP_TYPE_ERROR
:

354 
¡©e
 = 
SW_CRLF
;

357 
RSP_TYPE_CLIENT_ERROR
:

358 
RSP_TYPE_SERVER_ERROR
:

359 
r
->
tok’
 = 
NULL
;

360 
¡©e
 = 
SW_RUNTO_CRLF
;

364 
	`NOT_REACHED
();

367 
p
 =… - 1;

372 
SW_SPACES_BEFORE_KEY
:

373 ià(
ch
 != ' ') {

374 
¡©e
 = 
SW_KEY
;

375 
p
 =… - 1;

376 
r
->
tok’
 = 
NULL
;

381 
SW_KEY
:

382 ià(
r
->
tok’
 =ğ
NULL
) {

383 
r
->
tok’
 = 
p
;

386 ià(
ch
 == ' ') {

387 
	`as£¹
(
r
->
¡r
 =ğ
NULL
 &&„->
¡¾’
 == 0);

388 
m
 = 
r
->
tok’
;

389 
r
->
tok’
 = 
NULL
;

390 
¡©e
 = 
SW_SPACES_BEFORE_FLAGS
;

391 
r
->
¡¾’
 = 
p
-
m
;

392 
r
->
¡r
 = 
m
;

397 
SW_SPACES_BEFORE_FLAGS
:

398 ià(
ch
 != ' ') {

399 ià(!
	`isdig™
(
ch
)) {

400 
”rÜ
;

402 
¡©e
 = 
SW_FLAGS
;

403 
p
 =… - 1;

404 
r
->
kæags
 = 0;

409 
SW_FLAGS
:

410 ià(
	`isdig™
(
ch
)) {

412 
r
->
kæags
 =„->kæags*10 + ()(
ch
-'0');

413 } ià(
ch
 == ' ') {

416 
¡©e
 = 
SW_SPACES_BEFORE_VLEN
;

418 
”rÜ
;

423 
SW_SPACES_BEFORE_VLEN
:

424 ià(
ch
 != ' ') {

425 ià(!
	`isdig™
(
ch
)) {

426 
”rÜ
;

428 
p
 =… - 1;

429 
¡©e
 = 
SW_VLEN
;

430 
r
->
š‹g”
 = 0;

435 
SW_VLEN
:

436 ià(
	`isdig™
(
ch
)) {

437 
r
->
š‹g”
 =„->š‹g”*10 + ()(
ch
-'0');

438 } ià(
ch
 == ' ' || ch == '\r') {

440 
p
 =… - 1;

442 
¡©e
 = 
SW_RUNTO_CRLF
;

444 
”rÜ
;

449 
SW_RUNTO_VAL
:

450 
ch
) {

453 
¡©e
 = 
SW_VAL
;

454 
r
->
tok’
 = 
NULL
;

458 
”rÜ
;

463 
SW_VAL
:

464 ià(
r
->
tok’
 =ğ
NULL
) {

466 
r
->
tok’
 = 
p
;

469 
m
 = 
r
->
tok’
 +„->
š‹g”
;

470 ià(
m
 > 
r
->
buf
+r->
Ën
) {

471 
p
 = 
r
->
buf
 +„->
Ën
;

475 *
m
) {

478 
p
 = 
m
;

479 
¡©e
 = 
SW_VAL_LF
;

483 
”rÜ
;

488 
SW_VAL_LF
:

489 
ch
) {

492 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

493 
obj
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_STRING
,r->
¡r
,r->
¡¾’
,

494 
r
->
tok’
,r->
š‹g”
,r->
kæags
,r->
kv”siÚ
);

496 
obj
 = (*)
MC_REPLY_STRING
;

497 ià(
r
->
–em’t
) {

498 
	`as£¹
(
r
->
sub»¶y
 =ğ
NULL
);

499 
	`–em’tA¼ayAdd
(
r
,r->
sub»¶y
);

500 } ià(
r
->
sub»¶y
) {

501 
	`–em’tA¼ayC»©e
(
r
);

502 
	`–em’tA¼ayAdd
(
r
,r->
sub»¶y
);

503 
r
->
sub»¶y
 = 
NULL
;

504 
	`–em’tA¼ayAdd
(
r
,
obj
);

506 
r
->
sub»¶y
 = 
obj
;

509 
r
->
tok’
 = 
NULL
;

510 
r
->
¡r
 = 
NULL
;

511 
r
->
¡¾’
 = 0;

512 
r
->
kæags
 = 0;

513 
r
->
kv”siÚ
 = -1;

514 
¡©e
 = 
SW_RSP_STR
;

518 
”rÜ
;

523 
SW_END
:

524 ià(
r
->
tok’
 =ğ
NULL
) {

525 ià(
ch
 != 'E') {

526 
”rÜ
;

529 
r
->
tok’
 = 
p
;

530 } ià(
ch
 == '\r') {

532 
m
 = 
r
->
tok’
;

533 
r
->
tok’
 = 
NULL
;

535 
p
 - 
m
) {

537 ià(!
	`¡ºcmp
(
m
,"END\r",4)) {

538 
¡©e
 = 
SW_ALMOST_DONE
;

543 
”rÜ
;

549 
SW_RUNTO_CRLF
:

550 
ch
) {

552 ià(
r
->
ty³
 =ğ
RSP_TYPE_VALUE
) {

553 
¡©e
 = 
SW_RUNTO_VAL
;

555 ià(
r
->
ty³
 =ğ
RSP_TYPE_CLIENT_ERROR
 ||

556 
r
->
ty³
 =ğ
RSP_TYPE_SERVER_ERROR
) {

557 
m
 = 
r
->
tok’
;

558 
r
->
tok’
 = 
NULL
;

559 
r
->
¡¾’
 = 
p
-
m
;

560 
r
->
¡r
 = 
m
;

562 
¡©e
 = 
SW_ALMOST_DONE
;

573 
SW_CRLF
:

574 
ch
) {

579 
¡©e
 = 
SW_ALMOST_DONE
;

583 
”rÜ
;

588 
SW_ALMOST_DONE
:

589 
ch
) {

592 
dÚe
;

595 
”rÜ
;

600 
SW_SENTINEL
:

602 
	`NOT_REACHED
();

608 
	`as£¹
(
p
 =ğ
r
->
buf
+r->
Ën
);

609 
r
->
pos
 =„->
Ën
;

610 
r
->
¡©e
 = state;

612 
r
->
»suÉ
 = 
PARSE_AGAIN
;

616 
dÚe
:

617 
r
->
pos
 = 
p
-r->
buf
+1;

618 
	`as£¹
(
r
->
pos
 <ğr->
Ën
);

619 
r
->
¡©e
 = 
SW_START
;

620 
r
->
tok’
 = 
NULL
;

621 
r
->
»suÉ
 = 
PARSE_OK
;

625 
”rÜ
:

626 
r
->
»suÉ
 = 
PARSE_ERROR
;

627 
r
->
¡©e
 = state;

628 
”ºo
 = 
EINVAL
;

629 
	}
}

631 
mcR—d”
 *
	$memÿchedR—d”C»©eW™hFunùiÚs
(
mcR•lyObjeùFunùiÚs
 *
â
)

633 
mcR—d”
 *
r
;

635 
r
 = 
	`ÿÎoc
((
mcR—d”
),1);

636 ià(
r
 =ğ
NULL
)

637  
NULL
;

639 
r
->
”r
 = 0;

640 
r
->
”r¡r
[0] = '\0';

641 
r
->
buf
 = 
	`sd£m±y
();

642 
r
->
maxbuf
 = 
MC_READER_MAX_BUF
;

643 ià(
r
->
buf
 =ğ
NULL
) {

644 
	`ä“
(
r
);

645  
NULL
;

648 
r
->
sub»¶y
 = 
NULL
;

649 
r
->
®loc_Ën
 = 0;

650 
r
->
–em’ts
 = 0;

651 
r
->
–em’t
 = 
NULL
;

653 
r
->
¡©e
 = 0;

654 
r
->
tok’
 = 
NULL
;

656 
r
->
¡r
 = 
NULL
;

657 
r
->
¡¾’
 = 0;

658 
r
->
kæags
 = 0;

659 
r
->
kv”siÚ
 = -1;

660 
r
->
š‹g”
 = 0;

661 
r
->
ty³
 = 
RSP_TYPE_UNKNOWN
;

662 
r
->
»suÉ
 = 
PARSE_OK
;

664 
r
->
â
 = fn;

666  
r
;

667 
	}
}

669 
	$memÿchedR—d”F»e
(
mcR—d”
 *
r
)

671 
	`memÿchedR—d”Re£t
(
r
);

673 ià(
r
->
buf
 !ğ
NULL
)

674 
	`sdsä“
(
r
->
buf
);

675 
	`ä“
(
r
);

676 
	}
}

678 
	$memÿchedR—d”F“d
(
mcR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
)

680 
sds
 
Ãwbuf
;

683 ià(
r
->
”r
)

684  
MC_ERR
;

687 ià(
buf
 !ğ
NULL
 && 
Ën
 >= 1) {

689 ià(
r
->
Ën
 =ğ0 &&„->
maxbuf
 !ğ0 && 
	`sd§va
Ô->
buf
) >„->maxbuf) {

690 
	`sdsä“
(
r
->
buf
);

691 
r
->
buf
 = 
	`sd£m±y
();

692 
r
->
pos
 = 0;

695 
	`as£¹
(
r
->
buf
 !ğ
NULL
);

698 
Ãwbuf
 = 
	`sdsÿ’
(
r
->
buf
,buf,
Ën
);

699 ià(
Ãwbuf
 =ğ
NULL
) {

700 
	`__memÿchedR—d”S‘E¼ÜOOM
(
r
);

701  
MC_ERR
;

704 
r
->
buf
 = 
Ãwbuf
;

705 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

708  
MC_OK
;

709 
	}
}

711 
	$memÿchedR—d”Re£t
(
mcR—d”
 *
r
)

713 
r
->
¡r
 = 
NULL
;

714 
r
->
¡¾’
 = 0;

715 
r
->
kæags
 = 0;

716 
r
->
kv”siÚ
 = -1;

718 
r
->
¡©e
 = 0;

719 
r
->
tok’
 = 0;

721 
r
->
š‹g”
 = 0;

723 
r
->
ty³
 = 
RSP_TYPE_UNKNOWN
;

724 
r
->
»suÉ
 = 
PARSE_OK
;

726 ià(
r
->
sub»¶y
 !ğ
NULL
) {

727 ià(
r
->
â
 &&„->â->
ä“Objeù
)

728 
r
->
â
->
	`ä“Objeù
Ô->
sub»¶y
);

730 
r
->
sub»¶y
 = 
NULL
;

733 
	`–em’tA¼ayDe¡roy
(
r
);

735 
r
->
”r
 = 0;

736 
r
->
”r¡r
[0] = '\0';

737 
	}
}

739 *
	$g‘R•lyFromR—d”
(
mcR—d”
 *
r
)

741 *
»¶y
;

743 
r
->
ty³
) {

744 
RSP_TYPE_VALUE
:

745 ià(
r
->
–em’t
) {

746 
	`as£¹
(
r
->
sub»¶y
 =ğ
NULL
);

747 ià(
r
->
â
 &&„->â->
ü—‹A¼ay
) {

748 
»¶y
 = 
r
->
â
->
	`ü—‹A¼ay
Ô->
–em’ts
,r->
–em’t
);

749 
r
->
–em’t
 = 
NULL
;

750 
r
->
–em’ts
 = 0;

751 
r
->
®loc_Ën
 = 0;

753 
»¶y
 = (*)
MC_REPLY_ARRAY
;

755 } ià(
r
->
sub»¶y
) {

756 
»¶y
 = 
r
->
sub»¶y
;

759 
RSP_TYPE_NUM
:

760 ià(
r
->
â
 &&„->â->
ü—‹IÁeg”
)

761 
»¶y
 = 
r
->
â
->
	`ü—‹IÁeg”
Ô->
š‹g”
);

763 
»¶y
 = (*)
MC_REPLY_INTEGER
;

765 
RSP_TYPE_END
:

766 ià(
r
->
â
 &&„->â->
ü—‹N
)

767 
»¶y
 = 
r
->
â
->
	`ü—‹N
();

769 
»¶y
 = (*)
MC_REPLY_NIL
;

771 
RSP_TYPE_CLIENT_ERROR
:

772 
RSP_TYPE_SERVER_ERROR
:

773 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

774 
»¶y
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_ERROR
,

775 
NULL
,0,
r
->
¡r
,r->
¡¾’
,0,0);

777 
»¶y
 = (*)
MC_REPLY_ERROR
;

779 
RSP_TYPE_ERROR
:

780 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

781 
»¶y
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_ERROR
,

782 
NULL
,0,"",0,0,0);

784 
»¶y
 = (*)
MC_REPLY_ERROR
;

786 
RSP_TYPE_STORED
:

787 
RSP_TYPE_NOT_STORED
:

788 
RSP_TYPE_EXISTS
:

789 
RSP_TYPE_NOT_FOUND
:

790 
RSP_TYPE_DELETED
:

791 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

792 
»¶y
 = 
r
->
â
->
	`ü—‹SŒšg
(
MC_REPLY_STATUS
,

793 
NULL
,0,
r
->
¡r
,r->
¡¾’
,0,0);

795 
»¶y
 = (*)
MC_REPLY_STATUS
;

798 
»¶y
 = 
NULL
;

802  
»¶y
;

803 
	}
}

805 
	$memÿchedR—d”G‘R•ly
(
mcR—d”
 *
r
, **
»¶y
) {

807 ià(
»¶y
 !ğ
NULL
)

808 *
»¶y
 = 
NULL
;

811 ià(
r
->
”r
)

812  
MC_ERR
;

815 ià(
r
->
Ën
 == 0)

816  
MC_OK
;

818 
	`memÿchedP¬£Re¥Ú£
(
r
);

821 ià(
r
->
”r
)

822  
MC_ERR
;

831 ià(
r
->
»suÉ
 =ğ
PARSE_OK
) {

832 ià(
»¶y
 !ğ
NULL
) {

833 *
»¶y
 = 
	`g‘R•lyFromR—d”
(
r
);

835 
	`memÿchedR—d”Re£t
(
r
);

840 ià(
r
->
pos
 >ğ1024 &&„->
tok’
 =ğ
NULL
 &&„->
¡r
 == NULL) {

841 
	`sd¤ªge
(
r
->
buf
,r->
pos
,-1);

842 
r
->
pos
 = 0;

843 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

846  
MC_OK
;

847 
	}
}

	@dep/himemcached-0.1.0/himcread.h

1 #iâdeà
_HIMC_READ_H_


2 
	#_HIMC_READ_H_


	)

3 
	~<¡dio.h
>

5 
	~<himü—d.h
>

7 
	#MC_ERR
 -1

	)

8 
	#MC_OK
 0

	)

14 
	#MC_ERR_IO
 1

	)

15 
	#MC_ERR_EOF
 3

	)

16 
	#MC_ERR_PROTOCOL
 4

	)

17 
	#MC_ERR_OOM
 5

	)

18 
	#MC_ERR_OTHER
 2

	)

20 
	#MC_REPLY_STRING
 1

	)

21 
	#MC_REPLY_ARRAY
 2

	)

22 
	#MC_REPLY_INTEGER
 3

	)

23 
	#MC_REPLY_NIL
 4

	)

24 
	#MC_REPLY_STATUS
 5

	)

25 
	#MC_REPLY_ERROR
 6

	)

27 
	#MC_READER_MAX_BUF
 (1024*16è

	)

29 #ifdeà
__ılu¥lus


33 
	smcR•lyObjeùFunùiÚs
 {

34 *(*
ü—‹SŒšg
)(, *, 
size_t
, *, size_t, , );

35 *(*
ü—‹A¼ay
)(
size_t
, **);

36 *(*
ü—‹IÁeg”
)();

37 *(*
ü—‹N
)();

38 (*
ä“Objeù
)(*);

39 } 
	tmcR•lyObjeùFunùiÚs
;

41 
	smcR—d”
 {

42 
”r
;

43 
”r¡r
[128];

45 *
buf
;

46 
size_t
 
pos
;

47 
size_t
 
Ën
;

48 
size_t
 
maxbuf
;

50 *
sub»¶y
;

51 
size_t
 
®loc_Ën
;

52 
size_t
 
–em’ts
;

53 **
–em’t
;

55 *
¡r
;

56 
size_t
 
¡¾’
;

57 
kæags
;

58 
kv”siÚ
;

60 
¡©e
;

61 *
tok’
;

63 
š‹g”
;

65 
ty³
;

66 
»suÉ
;

68 
mcR•lyObjeùFunùiÚs
 *
â
;

69 *
´ivd©a
;

70 } 
	tmcR—d”
;

73 
mcR—d”
 *
memÿchedR—d”C»©eW™hFunùiÚs
(
mcR•lyObjeùFunùiÚs
 *
â
);

74 
memÿchedR—d”F»e
(
mcR—d”
 *
r
);

75 
memÿchedR—d”F“d
(
mcR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

76 
memÿchedR—d”G‘R•ly
(
mcR—d”
 *
r
, **
»¶y
);

78 #ifdeà
__ılu¥lus


	@dep/himemcached-0.1.0/himcread.h

1 #iâdeà
_HIMC_READ_H_


2 
	#_HIMC_READ_H_


	)

3 
	~<¡dio.h
>

5 
	~<himü—d.h
>

7 
	#MC_ERR
 -1

	)

8 
	#MC_OK
 0

	)

14 
	#MC_ERR_IO
 1

	)

15 
	#MC_ERR_EOF
 3

	)

16 
	#MC_ERR_PROTOCOL
 4

	)

17 
	#MC_ERR_OOM
 5

	)

18 
	#MC_ERR_OTHER
 2

	)

20 
	#MC_REPLY_STRING
 1

	)

21 
	#MC_REPLY_ARRAY
 2

	)

22 
	#MC_REPLY_INTEGER
 3

	)

23 
	#MC_REPLY_NIL
 4

	)

24 
	#MC_REPLY_STATUS
 5

	)

25 
	#MC_REPLY_ERROR
 6

	)

27 
	#MC_READER_MAX_BUF
 (1024*16è

	)

29 #ifdeà
__ılu¥lus


33 
	smcR•lyObjeùFunùiÚs
 {

34 *(*
ü—‹SŒšg
)(, *, 
size_t
, *, size_t, , );

35 *(*
ü—‹A¼ay
)(
size_t
, **);

36 *(*
ü—‹IÁeg”
)();

37 *(*
ü—‹N
)();

38 (*
ä“Objeù
)(*);

39 } 
	tmcR•lyObjeùFunùiÚs
;

41 
	smcR—d”
 {

42 
”r
;

43 
”r¡r
[128];

45 *
buf
;

46 
size_t
 
pos
;

47 
size_t
 
Ën
;

48 
size_t
 
maxbuf
;

50 *
sub»¶y
;

51 
size_t
 
®loc_Ën
;

52 
size_t
 
–em’ts
;

53 **
–em’t
;

55 *
¡r
;

56 
size_t
 
¡¾’
;

57 
kæags
;

58 
kv”siÚ
;

60 
¡©e
;

61 *
tok’
;

63 
š‹g”
;

65 
ty³
;

66 
»suÉ
;

68 
mcR•lyObjeùFunùiÚs
 *
â
;

69 *
´ivd©a
;

70 } 
	tmcR—d”
;

73 
mcR—d”
 *
memÿchedR—d”C»©eW™hFunùiÚs
(
mcR•lyObjeùFunùiÚs
 *
â
);

74 
memÿchedR—d”F»e
(
mcR—d”
 *
r
);

75 
memÿchedR—d”F“d
(
mcR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

76 
memÿchedR—d”G‘R•ly
(
mcR—d”
 *
r
, **
»¶y
);

78 #ifdeà
__ılu¥lus


	@dep/himemcached-0.1.0/himemcached.c

1 
	~<¡dlib.h
>

2 
	~<”ºo.h
>

3 
	~<as£¹.h
>

5 
	~"himemÿched.h
"

7 
	#REQ_TYPE_UNKNOWN
 0

	)

8 
	#REQ_TYPE_STORAGE
 1

	)

9 
	#REQ_TYPE_CAS
 2

	)

10 
	#REQ_TYPE_RETRIEVAL
 3

	)

11 
	#REQ_TYPE_ARITHMETIC
 4

	)

12 
	#REQ_TYPE_DELETE
 5

	)

14 
mcR•ly
 *
ü—‹R•lyObjeù
(
ty³
);

15 *
ü—‹SŒšgObjeù
(
ty³
, *
key
, 
size_t
 
keyËn
, *
¡r
, size_ˆ
Ën
, 
æags
, 
v”siÚ
);

16 *
ü—‹A¼ayObjeù
(
size_t
 
–em’ts
, **
–em’t
);

17 *
ü—‹IÁeg”Objeù
(
v®ue
);

18 *
ü—‹NObjeù
();

22 
mcR•lyObjeùFunùiÚs
 
	gdeçuÉFunùiÚs
 = {

23 
ü—‹SŒšgObjeù
,

24 
ü—‹A¼ayObjeù
,

25 
ü—‹IÁeg”Objeù
,

26 
ü—‹NObjeù
,

27 
ä“McR•lyObjeù


31 
mcR•ly
 *
	$ü—‹R•lyObjeù
(
ty³
) {

32 
mcR•ly
 *
r
 = 
	`ÿÎoc
(1,(*r));

34 ià(
r
 =ğ
NULL
)

35  
NULL
;

37 
r
->
ty³
 =ype;

39  
r
;

40 
	}
}

43 
	$ä“McR•lyObjeù
(*
»¶y
) {

44 
mcR•ly
 *
r
 = 
»¶y
;

45 
size_t
 
j
;

47 ià(
r
 =ğ
NULL
)

50 
r
->
ty³
) {

51 
MC_REPLY_INTEGER
:

52 
MC_REPLY_NIL
:

54 
MC_REPLY_ARRAY
:

55 ià(
r
->
–em’t
 !ğ
NULL
) {

56 
j
 = 0; j < 
r
->
–em’ts
; j++)

57 ià(
r
->
–em’t
[
j
] !ğ
NULL
)

58 
	`ä“McR•lyObjeù
(
r
->
–em’t
[
j
]);

59 
	`ä“
(
r
->
–em’t
);

62 
MC_REPLY_ERROR
:

63 
MC_REPLY_STATUS
:

64 
MC_REPLY_STRING
:

65 ià(
r
->
key
 !ğ
NULL
)

66 
	`ä“
(
r
->
key
);

67 ià(
r
->
¡r
 !ğ
NULL
)

68 
	`ä“
(
r
->
¡r
);

71 
	`as£¹
(0);

74 
	`ä“
(
r
);

75 
	}
}

77 *
	$ü—‹SŒšgObjeù
(
ty³
, *
key
, 
size_t
 
keyËn
, *
¡r
, size_ˆ
Ën
, 
æags
, 
v”siÚ
) {

78 
mcR•ly
 *
r
, *
·»Á
;

79 *
buf
;

81 
	`as£¹
(
ty³
 =ğ
MC_REPLY_ERROR
 ||

82 
ty³
 =ğ
MC_REPLY_STATUS
 ||

83 
ty³
 =ğ
MC_REPLY_STRING
);

85 
r
 = 
	`ü—‹R•lyObjeù
(
ty³
);

86 ià(
r
 =ğ
NULL
)

87  
NULL
;

89 ià(
key
 !ğ
NULL
) {

90 
r
->
key
 = 
	`m®loc
(
keyËn
+1);

91 ià(
r
->
key
 =ğ
NULL
) {

92 
	`ä“McR•lyObjeù
(
r
);

93  
NULL
;

95 ià(
keyËn
 > 0)

97 
	`memıy
(
r
->
key
,key,
keyËn
);

98 
r
->
key
[
keyËn
] = '\0';

99 
r
->
keyËn
 = keylen;

102 
buf
 = 
	`m®loc
(
Ën
+1);

103 ià(
buf
 =ğ
NULL
) {

104 
	`ä“McR•lyObjeù
(
r
);

105  
NULL
;

107 ià(
Ën
 > 0)

109 
	`memıy
(
buf
,
¡r
,
Ën
);

110 
buf
[
Ën
] = '\0';

111 
r
->
¡r
 = 
buf
;

112 
r
->
Ën
 =†en;

114 
r
->
æags
 = flags;

115 
r
->
v”siÚ
 = version;

117  
r
;

118 
	}
}

120 *
	$ü—‹A¼ayObjeù
(
size_t
 
–em’ts
, **
–em’t
) {

121 
mcR•ly
 *
r
;

123 
r
 = 
	`ü—‹R•lyObjeù
(
MC_REPLY_ARRAY
);

124 ià(
r
 =ğ
NULL
)

125  
NULL
;

127 
r
->
–em’ts
 =ƒlements;

128 
r
->
–em’t
 = (
mcR•ly
 **)element;

130  
r
;

131 
	}
}

133 *
	$ü—‹IÁeg”Objeù
(
v®ue
) {

134 
mcR•ly
 *
r
;

136 
r
 = 
	`ü—‹R•lyObjeù
(
MC_REPLY_INTEGER
);

137 ià(
r
 =ğ
NULL
)

138  
NULL
;

140 
r
->
š‹g”
 = 
v®ue
;

142  
r
;

143 
	}
}

145 *
	$ü—‹NObjeù
() {

146 
mcR•ly
 *
r
;

148 
r
 = 
	`ü—‹R•lyObjeù
(
MC_REPLY_NIL
);

149 ià(
r
 =ğ
NULL
)

150  
NULL
;

152  
r
;

153 
	}
}

155 
	$__memÿchedS‘E¼Ü
(
mcCÚ‹xt
 *
c
, 
ty³
, cÚ¡ *
¡r
) {

156 
size_t
 
Ën
;

158 
c
->
”r
 = 
ty³
;

159 ià(
¡r
 !ğ
NULL
) {

160 
Ën
 = 
	`¡¾’
(
¡r
);

161 
Ën
 =†’ < ((
c
->
”r¡r
)-1) ?†en : ((c->errstr)-1);

162 
	`memıy
(
c
->
”r¡r
,
¡r
,
Ën
);

163 
c
->
”r¡r
[
Ën
] = '\0';

166 
	`as£¹
(
ty³
 =ğ
MC_ERR_IO
);

169 
	}
}

181 
	$memÿchedBufãrWr™e
(
mcCÚ‹xt
 *
c
, *
dÚe
) {

182 
nwr™‹n
;

185 ià(
c
->
”r
)

186  
MC_ERR
;

188 ià(
	`sd¦’
(
c
->
obuf
) > 0) {

189 
nwr™‹n
 = 
	`wr™e
(
c
->
fd
,c->
obuf
,
	`sd¦’
(c->obuf));

190 ià(
nwr™‹n
 == -1) {

191 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
MC_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

194 
	`__memÿchedS‘E¼Ü
(
c
,
MC_ERR_IO
,
NULL
);

195  
MC_ERR
;

197 } ià(
nwr™‹n
 > 0) {

198 ià(
nwr™‹n
 =ğ(sigÃd)
	`sd¦’
(
c
->
obuf
)) {

199 
	`sdsä“
(
c
->
obuf
);

200 
c
->
obuf
 = 
	`sd£m±y
();

202 
	`sd¤ªge
(
c
->
obuf
,
nwr™‹n
,-1);

206 ià(
dÚe
 !ğ
NULL
è*dÚğ(
	`sd¦’
(
c
->
obuf
) == 0);

207  
MC_OK
;

208 
	}
}

212 
	$memÿchedG‘R•lyFromR—d”
(
mcCÚ‹xt
 *
c
, **
»¶y
) {

213 ià(
	`memÿchedR—d”G‘R•ly
(
c
->
»ad”
,
»¶y
è=ğ
MC_ERR
) {

214 
	`__memÿchedS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

215  
MC_ERR
;

217  
MC_OK
;

218 
	}
}

220 
	$memÿchedG‘R•ly
(
mcCÚ‹xt
 *
c
, **
»¶y
) {

221 
wdÚe
 = 0;

222 *
aux
 = 
NULL
;

225 ià(
	`memÿchedG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
MC_ERR
)

226  
MC_ERR
;

229 ià(
aux
 =ğ
NULL
 && 
c
->
æags
 & 
MC_BLOCK
) {

232 ià(
	`memÿchedBufãrWr™e
(
c
,&
wdÚe
è=ğ
MC_ERR
)

233  
MC_ERR
;

234 } !
wdÚe
);

238 ià(
	`memÿchedBufãrR—d
(
c
è=ğ
MC_ERR
)

239  
MC_ERR
;

240 ià(
	`memÿchedG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
MC_ERR
)

241  
MC_ERR
;

242 } 
aux
 =ğ
NULL
);

246 ià(
»¶y
 !ğ
NULL
è*»¶y = 
aux
;

247  
MC_OK
;

248 
	}
}

250 
mcR—d”
 *
	$memÿchedR—d”C»©e
() {

251  
	`memÿchedR—d”C»©eW™hFunùiÚs
(&
deçuÉFunùiÚs
);

252 
	}
}

254 
mcCÚ‹xt
 *
	$memÿchedCÚ‹xtIn™
() {

255 
mcCÚ‹xt
 *
c
;

257 
c
 = 
	`ÿÎoc
(1,(
mcCÚ‹xt
));

258 ià(
c
 =ğ
NULL
)

259  
NULL
;

261 
c
->
”r
 = 0;

262 
c
->
”r¡r
[0] = '\0';

263 
c
->
obuf
 = 
	`sd£m±y
();

264 
c
->
»ad”
 = 
	`memÿchedR—d”C»©e
();

265 
c
->
tı
.
ho¡
 = 
NULL
;

266 
c
->
tı
.
sourû_addr
 = 
NULL
;

267 
c
->
unix_sock
.
·th
 = 
NULL
;

268 
c
->
timeout
 = 
NULL
;

270 ià(
c
->
obuf
 =ğ
NULL
 || c->
»ad”
 == NULL) {

271 
	`memÿchedF»e
(
c
);

272  
NULL
;

275  
c
;

276 
	}
}

278 
	$memÿchedF»e
(
mcCÚ‹xt
 *
c
) {

279 ià(
c
 =ğ
NULL
)

281 ià(
c
->
fd
 > 0)

282 
	`şo£
(
c
->
fd
);

283 ià(
c
->
obuf
 !ğ
NULL
)

284 
	`sdsä“
(
c
->
obuf
);

285 ià(
c
->
»ad”
 !ğ
NULL
)

286 
	`memÿchedR—d”F»e
(
c
->
»ad”
);

287 ià(
c
->
tı
.
ho¡
)

288 
	`ä“
(
c
->
tı
.
ho¡
);

289 ià(
c
->
tı
.
sourû_addr
)

290 
	`ä“
(
c
->
tı
.
sourû_addr
);

291 ià(
c
->
unix_sock
.
·th
)

292 
	`ä“
(
c
->
unix_sock
.
·th
);

293 ià(
c
->
timeout
)

294 
	`ä“
(
c
->
timeout
);

295 
	`ä“
(
c
);

296 
	}
}

303 
	$memÿchedBufãrR—d
(
mcCÚ‹xt
 *
c
) {

304 
buf
[1024*16];

305 
Ä—d
;

308 ià(
c
->
”r
)

309  
MC_ERR
;

311 
Ä—d
 = 
	`»ad
(
c
->
fd
,
buf
,(buf));

312 ià(
Ä—d
 == -1) {

313 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
MC_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

316 
	`__memÿchedS‘E¼Ü
(
c
,
MC_ERR_IO
,
NULL
);

317  
MC_ERR
;

319 } ià(
Ä—d
 == 0) {

320 
	`__memÿchedS‘E¼Ü
(
c
,
MC_ERR_EOF
,"Server closedhe connection");

321  
MC_ERR
;

323 ià(
	`memÿchedR—d”F“d
(
c
->
»ad”
,
buf
,
Ä—d
è!ğ
MC_OK
) {

324 
	`__memÿchedS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

325  
MC_ERR
;

328  
MC_OK
;

329 
	}
}

331 
	$g‘Reque¡Ty³FromSŒšg
(*
¡r
, 
size_t
 
Ën
)

333 ià(
¡r
 =ğ
NULL
 || 
Ën
 == 0)

336 ià(
Ën
 == 3) {

337 ià(!
	`¡ºÿ£cmp
(
¡r
,"set",3) ||

338 !
	`¡ºÿ£cmp
(
¡r
,"add",3)) {

339  
REQ_TYPE_STORAGE
;

340 } ià(!
	`¡ºÿ£cmp
(
¡r
,"cas",3)) {

341  
REQ_TYPE_CAS
;

342 } ià(!
	`¡ºÿ£cmp
(
¡r
,"get",3)) {

343  
REQ_TYPE_RETRIEVAL
;

347 } ià(
Ën
 == 4) {

348 ià(!
	`¡ºÿ£cmp
(
¡r
,"gets",4)) {

349  
REQ_TYPE_RETRIEVAL
;

350 } ià(!
	`¡ºÿ£cmp
(
¡r
,"incr",4) ||

351 !
	`¡ºÿ£cmp
(
¡r
,"decr",4)) {

352  
REQ_TYPE_ARITHMETIC
;

356 } ià(
Ën
 == 6) {

357 ià(!
	`¡ºÿ£cmp
(
¡r
,"append",6)) {

358  
REQ_TYPE_STORAGE
;

359 } ià(!
	`¡ºÿ£cmp
(
¡r
,"delete",6)) {

360  
REQ_TYPE_DELETE
;

364 } ià(
Ën
 == 7) {

365 ià(!
	`¡ºÿ£cmp
(
¡r
,"replace",7) ||

366 !
	`¡ºÿ£cmp
(
¡r
,"prepend",7)) {

367  
REQ_TYPE_STORAGE
;

374 
	}
}

376 
	#ARGUMENTLEN
(
_¬gty³
,
_¬gv
,
_¬gvËn
,
_idx
) \

377 (
_¬gty³
==0?
	`sd¦’
(
_¬gv
[
_idx
]):(
_¬gvËn
==
NULL
?
	`¡¾’
(_¬gv[_idx]):_¬gvËn[_idx]))

	)

384 
	$checkCmdV®idAndG‘TÙ®L’
(
cmdty³
, 
¬gty³
, 
¬gc
, **
¬gv
, 
size_t
 *
¬gvËn
)

386 
size_t
 
Ën
;

387 
tÙËn
, 
j
;

389 
cmdty³
) {

390 
REQ_TYPE_STORAGE
:

391 ià(
¬gc
 != 6 &&‡rgc != 7) {

394 ià(
¬gc
 =ğ7 && (
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,5) != 7 ||

395 
	`¡ºÿ£cmp
(
¬gv
[5],"noreply",7))) {

399 
tÙËn
 = 0;

400 
j
 = 0; j < 
¬gc
-1; j ++) {

401 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
) + 1;

403 
tÙËn
 +ğ2 + 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1) + 2;

405 
REQ_TYPE_CAS
:

406 ià(
¬gc
 != 7 &&‡rgc != 8) {

409 ià(
¬gc
 =ğ8 && (
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,6) != 7 ||

410 
	`¡ºÿ£cmp
(
¬gv
[6],"noreply",7))) {

414 
tÙËn
 = 0;

415 
j
 = 0; j < 
¬gc
-1; j ++) {

416 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
) + 1;

418 
tÙËn
 +ğ2 + 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1) + 2;

420 
REQ_TYPE_ARITHMETIC
:

421 ià(
¬gc
 != 3) {

424 
tÙËn
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,0) + 1 +

425 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,1) + 1 +

426 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,2) + 2;

428 
REQ_TYPE_RETRIEVAL
:

429 ià(
¬gc
 <= 1) {

433 
tÙËn
 = 0;

434 
j
 = 0; j < 
¬gc
-1; j ++) {

435 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
) + 1;

437 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1) + 2;

439 
REQ_TYPE_DELETE
:

440 ià(
¬gc
 != 2 &&‡rgc != 3) {

444 
tÙËn
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,0) + 1 +

445 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,1);

446 ià(
¬gc
 == 3) {

447 ià(
	`¡ºÿ£cmp
(
¬gv
[2],"noreply",7)) {

450 
tÙËn
 +ğ1 + 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,2);

452 
tÙËn
 += 2;

455 
tÙËn
 = -1;

459  
tÙËn
;

460 
	}
}

463 
	$g’”icMemÿchedCommªd
(
cmdty³
, *
cmd
, 
¬gty³
, 
¬gc
, **
¬gv
, 
size_t
 *
¬gvËn
)

465 
j
;

466 
size_t
 
Ën
;

467 
pos
 = 0;

469 
cmdty³
) {

470 
REQ_TYPE_STORAGE
:

471 
REQ_TYPE_CAS
:

472 
j
 = 0; j < 
¬gc
-1; j ++) {

473 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
);

474 
	`memıy
(
cmd
+
pos
,
¬gv
[
j
],
Ën
);

475 
pos
 +ğ()
Ën
;

476 
cmd
[
pos
++] = ' ';

478 
cmd
[
pos
++] = '\r';

479 
cmd
[
pos
++] = '\n';

480 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1);

481 
	`memıy
(
cmd
+
pos
,
¬gv
[
¬gc
-1],
Ën
);

482 
pos
 +ğ()
Ën
;

483 
cmd
[
pos
++] = '\r';

484 
cmd
[
pos
++] = '\n';

486 
REQ_TYPE_ARITHMETIC
:

487 
REQ_TYPE_RETRIEVAL
:

488 
REQ_TYPE_DELETE
:

489 
j
 = 0; j < 
¬gc
-1; j ++) {

490 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
);

491 
	`memıy
(
cmd
+
pos
,
¬gv
[
j
],
Ën
);

492 
pos
 +ğ
Ën
;

493 
cmd
[
pos
++] = ' ';

495 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1);

496 
	`memıy
(
cmd
+
pos
,
¬gv
[
¬gc
-1],
Ën
);

497 
pos
 +ğ()
Ën
;

498 
cmd
[
pos
++] = '\r';

499 
cmd
[
pos
++] = '\n';

502 
pos
 = -1;

506  
pos
;

507 
	}
}

512 
	$memÿchedFÜm©CommªdSdsArgv
(**
rg‘
, 
¬gc
, cÚ¡ 
sds
 *
¬gv
) {

513 *
cmd
 = 
NULL
;

514 
pos
;

515 
tÙËn
;

516 
ty³
;

519 ià(
rg‘
 =ğ
NULL
 || 
¬gc
 < 1)

522 
ty³
 = 
	`g‘Reque¡Ty³FromSŒšg
(
¬gv
[0], 
	`sd¦’
(argv[0]));

523 ià(
ty³
 < 0)

524 
fÜm©_”r
;

526 
tÙËn
 = 
	`checkCmdV®idAndG‘TÙ®L’
(
ty³
, 0, 
¬gc
, 
¬gv
, 
NULL
);

527 ià(
tÙËn
 < 0) {

528 
fÜm©_”r
;

532 
cmd
 = 
	`m®loc
(
tÙËn
+1);

533 ià(
cmd
 =ğ
NULL
è
memÜy_”r
;

535 
pos
 = 
	`g’”icMemÿchedCommªd
(
ty³
, 
cmd
, 0, 
¬gc
, 
¬gv
, 
NULL
);

536 ià(
pos
 < 0è
fÜm©_”r
;

538 
	`as£¹
(
pos
 =ğ
tÙËn
);

539 
cmd
[
pos
] = '\0';

541 *
rg‘
 = 
cmd
;

542  
tÙËn
;

544 
fÜm©_”r
:

545 ià(
cmd
è
	`ä“
(cmd);

548 
memÜy_”r
:

550 
	}
}

552 
	$memÿchedvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

554 cÚ¡ *
c
 = 
fÜm©
;

555 *
cmd
 = 
NULL
;

556 
pos
;

557 
sds
 
cu¿rg
, 
Ãw¬g
;

558 
touched
 = 0;

559 **
cu¿rgv
 = 
NULL
, **
Ãw¬gv
 = NULL;

560 
¬gc
 = 0;

561 
tÙËn
;

562 
”rÜ_ty³
 = 0;

563 
j
;

566 ià(
rg‘
 =ğ
NULL
)

570 
cu¿rg
 = 
	`sd£m±y
();

571 ià(
cu¿rg
 =ğ
NULL
)

574 *
c
 != '\0') {

575 ià(*
c
 != '%' || c[1] == '\0') {

576 ià(*
c
 == ' ') {

577 ià(
touched
) {

578 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

579 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

580 
cu¿rgv
 = 
Ãw¬gv
;

581 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

584 
cu¿rg
 = 
	`sd£m±y
();

585 ià(
cu¿rg
 =ğ
NULL
è
memÜy_”r
;

586 
touched
 = 0;

589 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
c
,1);

590 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

591 
cu¿rg
 = 
Ãw¬g
;

592 
touched
 = 1;

595 *
¬g
;

596 
size_t
 
size
;

599 
Ãw¬g
 = 
cu¿rg
;

601 
c
[1]) {

603 
¬g
 = 
	`va_¬g
(
­
,*);

604 
size
 = 
	`¡¾’
(
¬g
);

605 ià(
size
 > 0)

606 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

609 
¬g
 = 
	`va_¬g
(
­
,*);

610 
size
 = 
	`va_¬g
(
­
,
size_t
);

611 ià(
size
 > 0)

612 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

615 
Ãw¬g
 = 
	`sdsÿt
(
cu¿rg
,"%");

620 cÚ¡ 
štfmts
[] = "diouxX";

621 cÚ¡ 
æags
[] = "#0-+ ";

622 
_fÜm©
[16];

623 cÚ¡ *
_p
 = 
c
+1;

624 
size_t
 
_l
 = 0;

625 
va_li¡
 
_ıy
;

628 *
_p
 !ğ'\0' && 
	`¡rchr
(
æags
,*_pè!ğ
NULL
) _p++;

631 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

634 ià(*
_p
 == '.') {

635 
_p
++;

636 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

640 
	`va_cİy
(
_ıy
,
­
);

643 ià(
	`¡rchr
(
štfmts
,*
_p
è!ğ
NULL
) {

644 
	`va_¬g
(
­
,);

645 
fmt_v®id
;

649 ià(
	`¡rchr
("eEfFgGaA",*
_p
è!ğ
NULL
) {

650 
	`va_¬g
(
­
,);

651 
fmt_v®id
;

655 ià(
_p
[0] == 'h' && _p[1] == 'h') {

656 
_p
 += 2;

657 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

658 
	`va_¬g
(
­
,);

659 
fmt_v®id
;

661 
fmt_šv®id
;

665 ià(
_p
[0] == 'h') {

666 
_p
 += 1;

667 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

668 
	`va_¬g
(
­
,);

669 
fmt_v®id
;

671 
fmt_šv®id
;

675 ià(
_p
[0] == 'l' && _p[1] == 'l') {

676 
_p
 += 2;

677 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

678 
	`va_¬g
(
­
,);

679 
fmt_v®id
;

681 
fmt_šv®id
;

685 ià(
_p
[0] == 'l') {

686 
_p
 += 1;

687 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

688 
	`va_¬g
(
­
,);

689 
fmt_v®id
;

691 
fmt_šv®id
;

694 
fmt_šv®id
:

695 
	`va_’d
(
_ıy
);

696 
fÜm©_”r
;

698 
fmt_v®id
:

699 
_l
 = (
_p
+1)-
c
;

700 ià(
_l
 < (
_fÜm©
)-2) {

701 
	`memıy
(
_fÜm©
,
c
,
_l
);

702 
_fÜm©
[
_l
] = '\0';

703 
Ãw¬g
 = 
	`sdsÿtv´štf
(
cu¿rg
,
_fÜm©
,
_ıy
);

707 
c
 = 
_p
-1;

710 
	`va_’d
(
_ıy
);

715 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

716 
cu¿rg
 = 
Ãw¬g
;

718 
touched
 = 1;

719 
c
++;

721 
c
++;

725 ià(
touched
) {

726 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

727 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

728 
cu¿rgv
 = 
Ãw¬gv
;

729 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

731 
	`sdsä“
(
cu¿rg
);

735 
cu¿rg
 = 
NULL
;

737 
tÙËn
 = 
	`memÿchedFÜm©CommªdSdsArgv
(&
cmd
, 
¬gc
,
cu¿rgv
);

738 ià(
tÙËn
 < 0) {

739 
”rÜ_ty³
 = 
tÙËn
;

740 
ş—nup
;

743 
	`ä“
(
cu¿rgv
);

744 *
rg‘
 = 
cmd
;

745  
tÙËn
;

747 
fÜm©_”r
:

748 
”rÜ_ty³
 = -2;

749 
ş—nup
;

751 
memÜy_”r
:

752 
”rÜ_ty³
 = -1;

753 
ş—nup
;

755 
ş—nup
:

756 ià(
cu¿rgv
) {

757 
¬gc
--)

758 
	`sdsä“
(
cu¿rgv
[
¬gc
]);

759 
	`ä“
(
cu¿rgv
);

762 
	`sdsä“
(
cu¿rg
);

766 ià(
cmd
 !ğ
NULL
)

767 
	`ä“
(
cmd
);

769  
”rÜ_ty³
;

770 
	}
}

784 
	$memÿchedFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...) {

785 
va_li¡
 
­
;

786 
Ën
;

787 
	`va_¡¬t
(
­
,
fÜm©
);

788 
Ën
 = 
	`memÿchedvFÜm©Commªd
(
rg‘
,
fÜm©
,
­
);

789 
	`va_’d
(
­
);

793 ià(
Ën
 < 0)

794 
Ën
 = -1;

796  
Ën
;

797 
	}
}

804 
	$memÿchedFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

805 *
cmd
 = 
NULL
;

806 
pos
;

807 
tÙËn
;

808 
ty³
;

811 ià(
rg‘
 =ğ
NULL
 || 
¬gc
 < 1)

814 
ty³
 = 
	`g‘Reque¡Ty³FromSŒšg
(
¬gv
[0], 
¬gvËn
==
NULL
?
	`¡¾’
(argv[0]):argvlen[0]);

815 ià(
ty³
 < 0) {

816 
fÜm©_”r
;

819 
tÙËn
 = 
	`checkCmdV®idAndG‘TÙ®L’
(
ty³
, 1, 
¬gc
, 
¬gv
, 
¬gvËn
);

820 ià(
tÙËn
 < 0) {

821 
fÜm©_”r
;

825 
cmd
 = 
	`m®loc
(
tÙËn
+1);

826 ià(
cmd
 =ğ
NULL
è
memÜy_”r
;

828 
pos
 = 
	`g’”icMemÿchedCommªd
(
ty³
, 
cmd
, 1, 
¬gc
, 
¬gv
, 
¬gvËn
);

829 ià(
pos
 < 0) {

830 
fÜm©_”r
;

833 
	`as£¹
(
pos
 =ğ
tÙËn
);

834 
cmd
[
pos
] = '\0';

836 *
rg‘
 = 
cmd
;

837  
tÙËn
;

839 
fÜm©_”r
:

840 ià(
cmd
è
	`ä“
(cmd);

843 
memÜy_”r
:

845 
	}
}

	@dep/himemcached-0.1.0/himemcached.c

1 
	~<¡dlib.h
>

2 
	~<”ºo.h
>

3 
	~<as£¹.h
>

5 
	~"himemÿched.h
"

7 
	#REQ_TYPE_UNKNOWN
 0

	)

8 
	#REQ_TYPE_STORAGE
 1

	)

9 
	#REQ_TYPE_CAS
 2

	)

10 
	#REQ_TYPE_RETRIEVAL
 3

	)

11 
	#REQ_TYPE_ARITHMETIC
 4

	)

12 
	#REQ_TYPE_DELETE
 5

	)

14 
mcR•ly
 *
ü—‹R•lyObjeù
(
ty³
);

15 *
ü—‹SŒšgObjeù
(
ty³
, *
key
, 
size_t
 
keyËn
, *
¡r
, size_ˆ
Ën
, 
æags
, 
v”siÚ
);

16 *
ü—‹A¼ayObjeù
(
size_t
 
–em’ts
, **
–em’t
);

17 *
ü—‹IÁeg”Objeù
(
v®ue
);

18 *
ü—‹NObjeù
();

22 
mcR•lyObjeùFunùiÚs
 
	gdeçuÉFunùiÚs
 = {

23 
ü—‹SŒšgObjeù
,

24 
ü—‹A¼ayObjeù
,

25 
ü—‹IÁeg”Objeù
,

26 
ü—‹NObjeù
,

27 
ä“McR•lyObjeù


31 
mcR•ly
 *
	$ü—‹R•lyObjeù
(
ty³
) {

32 
mcR•ly
 *
r
 = 
	`ÿÎoc
(1,(*r));

34 ià(
r
 =ğ
NULL
)

35  
NULL
;

37 
r
->
ty³
 =ype;

39  
r
;

40 
	}
}

43 
	$ä“McR•lyObjeù
(*
»¶y
) {

44 
mcR•ly
 *
r
 = 
»¶y
;

45 
size_t
 
j
;

47 ià(
r
 =ğ
NULL
)

50 
r
->
ty³
) {

51 
MC_REPLY_INTEGER
:

52 
MC_REPLY_NIL
:

54 
MC_REPLY_ARRAY
:

55 ià(
r
->
–em’t
 !ğ
NULL
) {

56 
j
 = 0; j < 
r
->
–em’ts
; j++)

57 ià(
r
->
–em’t
[
j
] !ğ
NULL
)

58 
	`ä“McR•lyObjeù
(
r
->
–em’t
[
j
]);

59 
	`ä“
(
r
->
–em’t
);

62 
MC_REPLY_ERROR
:

63 
MC_REPLY_STATUS
:

64 
MC_REPLY_STRING
:

65 ià(
r
->
key
 !ğ
NULL
)

66 
	`ä“
(
r
->
key
);

67 ià(
r
->
¡r
 !ğ
NULL
)

68 
	`ä“
(
r
->
¡r
);

71 
	`as£¹
(0);

74 
	`ä“
(
r
);

75 
	}
}

77 *
	$ü—‹SŒšgObjeù
(
ty³
, *
key
, 
size_t
 
keyËn
, *
¡r
, size_ˆ
Ën
, 
æags
, 
v”siÚ
) {

78 
mcR•ly
 *
r
, *
·»Á
;

79 *
buf
;

81 
	`as£¹
(
ty³
 =ğ
MC_REPLY_ERROR
 ||

82 
ty³
 =ğ
MC_REPLY_STATUS
 ||

83 
ty³
 =ğ
MC_REPLY_STRING
);

85 
r
 = 
	`ü—‹R•lyObjeù
(
ty³
);

86 ià(
r
 =ğ
NULL
)

87  
NULL
;

89 ià(
key
 !ğ
NULL
) {

90 
r
->
key
 = 
	`m®loc
(
keyËn
+1);

91 ià(
r
->
key
 =ğ
NULL
) {

92 
	`ä“McR•lyObjeù
(
r
);

93  
NULL
;

95 ià(
keyËn
 > 0)

97 
	`memıy
(
r
->
key
,key,
keyËn
);

98 
r
->
key
[
keyËn
] = '\0';

99 
r
->
keyËn
 = keylen;

102 
buf
 = 
	`m®loc
(
Ën
+1);

103 ià(
buf
 =ğ
NULL
) {

104 
	`ä“McR•lyObjeù
(
r
);

105  
NULL
;

107 ià(
Ën
 > 0)

109 
	`memıy
(
buf
,
¡r
,
Ën
);

110 
buf
[
Ën
] = '\0';

111 
r
->
¡r
 = 
buf
;

112 
r
->
Ën
 =†en;

114 
r
->
æags
 = flags;

115 
r
->
v”siÚ
 = version;

117  
r
;

118 
	}
}

120 *
	$ü—‹A¼ayObjeù
(
size_t
 
–em’ts
, **
–em’t
) {

121 
mcR•ly
 *
r
;

123 
r
 = 
	`ü—‹R•lyObjeù
(
MC_REPLY_ARRAY
);

124 ià(
r
 =ğ
NULL
)

125  
NULL
;

127 
r
->
–em’ts
 =ƒlements;

128 
r
->
–em’t
 = (
mcR•ly
 **)element;

130  
r
;

131 
	}
}

133 *
	$ü—‹IÁeg”Objeù
(
v®ue
) {

134 
mcR•ly
 *
r
;

136 
r
 = 
	`ü—‹R•lyObjeù
(
MC_REPLY_INTEGER
);

137 ià(
r
 =ğ
NULL
)

138  
NULL
;

140 
r
->
š‹g”
 = 
v®ue
;

142  
r
;

143 
	}
}

145 *
	$ü—‹NObjeù
() {

146 
mcR•ly
 *
r
;

148 
r
 = 
	`ü—‹R•lyObjeù
(
MC_REPLY_NIL
);

149 ià(
r
 =ğ
NULL
)

150  
NULL
;

152  
r
;

153 
	}
}

155 
	$__memÿchedS‘E¼Ü
(
mcCÚ‹xt
 *
c
, 
ty³
, cÚ¡ *
¡r
) {

156 
size_t
 
Ën
;

158 
c
->
”r
 = 
ty³
;

159 ià(
¡r
 !ğ
NULL
) {

160 
Ën
 = 
	`¡¾’
(
¡r
);

161 
Ën
 =†’ < ((
c
->
”r¡r
)-1) ?†en : ((c->errstr)-1);

162 
	`memıy
(
c
->
”r¡r
,
¡r
,
Ën
);

163 
c
->
”r¡r
[
Ën
] = '\0';

166 
	`as£¹
(
ty³
 =ğ
MC_ERR_IO
);

169 
	}
}

181 
	$memÿchedBufãrWr™e
(
mcCÚ‹xt
 *
c
, *
dÚe
) {

182 
nwr™‹n
;

185 ià(
c
->
”r
)

186  
MC_ERR
;

188 ià(
	`sd¦’
(
c
->
obuf
) > 0) {

189 
nwr™‹n
 = 
	`wr™e
(
c
->
fd
,c->
obuf
,
	`sd¦’
(c->obuf));

190 ià(
nwr™‹n
 == -1) {

191 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
MC_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

194 
	`__memÿchedS‘E¼Ü
(
c
,
MC_ERR_IO
,
NULL
);

195  
MC_ERR
;

197 } ià(
nwr™‹n
 > 0) {

198 ià(
nwr™‹n
 =ğ(sigÃd)
	`sd¦’
(
c
->
obuf
)) {

199 
	`sdsä“
(
c
->
obuf
);

200 
c
->
obuf
 = 
	`sd£m±y
();

202 
	`sd¤ªge
(
c
->
obuf
,
nwr™‹n
,-1);

206 ià(
dÚe
 !ğ
NULL
è*dÚğ(
	`sd¦’
(
c
->
obuf
) == 0);

207  
MC_OK
;

208 
	}
}

212 
	$memÿchedG‘R•lyFromR—d”
(
mcCÚ‹xt
 *
c
, **
»¶y
) {

213 ià(
	`memÿchedR—d”G‘R•ly
(
c
->
»ad”
,
»¶y
è=ğ
MC_ERR
) {

214 
	`__memÿchedS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

215  
MC_ERR
;

217  
MC_OK
;

218 
	}
}

220 
	$memÿchedG‘R•ly
(
mcCÚ‹xt
 *
c
, **
»¶y
) {

221 
wdÚe
 = 0;

222 *
aux
 = 
NULL
;

225 ià(
	`memÿchedG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
MC_ERR
)

226  
MC_ERR
;

229 ià(
aux
 =ğ
NULL
 && 
c
->
æags
 & 
MC_BLOCK
) {

232 ià(
	`memÿchedBufãrWr™e
(
c
,&
wdÚe
è=ğ
MC_ERR
)

233  
MC_ERR
;

234 } !
wdÚe
);

238 ià(
	`memÿchedBufãrR—d
(
c
è=ğ
MC_ERR
)

239  
MC_ERR
;

240 ià(
	`memÿchedG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
MC_ERR
)

241  
MC_ERR
;

242 } 
aux
 =ğ
NULL
);

246 ià(
»¶y
 !ğ
NULL
è*»¶y = 
aux
;

247  
MC_OK
;

248 
	}
}

250 
mcR—d”
 *
	$memÿchedR—d”C»©e
() {

251  
	`memÿchedR—d”C»©eW™hFunùiÚs
(&
deçuÉFunùiÚs
);

252 
	}
}

254 
mcCÚ‹xt
 *
	$memÿchedCÚ‹xtIn™
() {

255 
mcCÚ‹xt
 *
c
;

257 
c
 = 
	`ÿÎoc
(1,(
mcCÚ‹xt
));

258 ià(
c
 =ğ
NULL
)

259  
NULL
;

261 
c
->
”r
 = 0;

262 
c
->
”r¡r
[0] = '\0';

263 
c
->
obuf
 = 
	`sd£m±y
();

264 
c
->
»ad”
 = 
	`memÿchedR—d”C»©e
();

265 
c
->
tı
.
ho¡
 = 
NULL
;

266 
c
->
tı
.
sourû_addr
 = 
NULL
;

267 
c
->
unix_sock
.
·th
 = 
NULL
;

268 
c
->
timeout
 = 
NULL
;

270 ià(
c
->
obuf
 =ğ
NULL
 || c->
»ad”
 == NULL) {

271 
	`memÿchedF»e
(
c
);

272  
NULL
;

275  
c
;

276 
	}
}

278 
	$memÿchedF»e
(
mcCÚ‹xt
 *
c
) {

279 ià(
c
 =ğ
NULL
)

281 ià(
c
->
fd
 > 0)

282 
	`şo£
(
c
->
fd
);

283 ià(
c
->
obuf
 !ğ
NULL
)

284 
	`sdsä“
(
c
->
obuf
);

285 ià(
c
->
»ad”
 !ğ
NULL
)

286 
	`memÿchedR—d”F»e
(
c
->
»ad”
);

287 ià(
c
->
tı
.
ho¡
)

288 
	`ä“
(
c
->
tı
.
ho¡
);

289 ià(
c
->
tı
.
sourû_addr
)

290 
	`ä“
(
c
->
tı
.
sourû_addr
);

291 ià(
c
->
unix_sock
.
·th
)

292 
	`ä“
(
c
->
unix_sock
.
·th
);

293 ià(
c
->
timeout
)

294 
	`ä“
(
c
->
timeout
);

295 
	`ä“
(
c
);

296 
	}
}

303 
	$memÿchedBufãrR—d
(
mcCÚ‹xt
 *
c
) {

304 
buf
[1024*16];

305 
Ä—d
;

308 ià(
c
->
”r
)

309  
MC_ERR
;

311 
Ä—d
 = 
	`»ad
(
c
->
fd
,
buf
,(buf));

312 ià(
Ä—d
 == -1) {

313 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
MC_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

316 
	`__memÿchedS‘E¼Ü
(
c
,
MC_ERR_IO
,
NULL
);

317  
MC_ERR
;

319 } ià(
Ä—d
 == 0) {

320 
	`__memÿchedS‘E¼Ü
(
c
,
MC_ERR_EOF
,"Server closedhe connection");

321  
MC_ERR
;

323 ià(
	`memÿchedR—d”F“d
(
c
->
»ad”
,
buf
,
Ä—d
è!ğ
MC_OK
) {

324 
	`__memÿchedS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

325  
MC_ERR
;

328  
MC_OK
;

329 
	}
}

331 
	$g‘Reque¡Ty³FromSŒšg
(*
¡r
, 
size_t
 
Ën
)

333 ià(
¡r
 =ğ
NULL
 || 
Ën
 == 0)

336 ià(
Ën
 == 3) {

337 ià(!
	`¡ºÿ£cmp
(
¡r
,"set",3) ||

338 !
	`¡ºÿ£cmp
(
¡r
,"add",3)) {

339  
REQ_TYPE_STORAGE
;

340 } ià(!
	`¡ºÿ£cmp
(
¡r
,"cas",3)) {

341  
REQ_TYPE_CAS
;

342 } ià(!
	`¡ºÿ£cmp
(
¡r
,"get",3)) {

343  
REQ_TYPE_RETRIEVAL
;

347 } ià(
Ën
 == 4) {

348 ià(!
	`¡ºÿ£cmp
(
¡r
,"gets",4)) {

349  
REQ_TYPE_RETRIEVAL
;

350 } ià(!
	`¡ºÿ£cmp
(
¡r
,"incr",4) ||

351 !
	`¡ºÿ£cmp
(
¡r
,"decr",4)) {

352  
REQ_TYPE_ARITHMETIC
;

356 } ià(
Ën
 == 6) {

357 ià(!
	`¡ºÿ£cmp
(
¡r
,"append",6)) {

358  
REQ_TYPE_STORAGE
;

359 } ià(!
	`¡ºÿ£cmp
(
¡r
,"delete",6)) {

360  
REQ_TYPE_DELETE
;

364 } ià(
Ën
 == 7) {

365 ià(!
	`¡ºÿ£cmp
(
¡r
,"replace",7) ||

366 !
	`¡ºÿ£cmp
(
¡r
,"prepend",7)) {

367  
REQ_TYPE_STORAGE
;

374 
	}
}

376 
	#ARGUMENTLEN
(
_¬gty³
,
_¬gv
,
_¬gvËn
,
_idx
) \

377 (
_¬gty³
==0?
	`sd¦’
(
_¬gv
[
_idx
]):(
_¬gvËn
==
NULL
?
	`¡¾’
(_¬gv[_idx]):_¬gvËn[_idx]))

	)

384 
	$checkCmdV®idAndG‘TÙ®L’
(
cmdty³
, 
¬gty³
, 
¬gc
, **
¬gv
, 
size_t
 *
¬gvËn
)

386 
size_t
 
Ën
;

387 
tÙËn
, 
j
;

389 
cmdty³
) {

390 
REQ_TYPE_STORAGE
:

391 ià(
¬gc
 != 6 &&‡rgc != 7) {

394 ià(
¬gc
 =ğ7 && (
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,5) != 7 ||

395 
	`¡ºÿ£cmp
(
¬gv
[5],"noreply",7))) {

399 
tÙËn
 = 0;

400 
j
 = 0; j < 
¬gc
-1; j ++) {

401 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
) + 1;

403 
tÙËn
 +ğ2 + 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1) + 2;

405 
REQ_TYPE_CAS
:

406 ià(
¬gc
 != 7 &&‡rgc != 8) {

409 ià(
¬gc
 =ğ8 && (
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,6) != 7 ||

410 
	`¡ºÿ£cmp
(
¬gv
[6],"noreply",7))) {

414 
tÙËn
 = 0;

415 
j
 = 0; j < 
¬gc
-1; j ++) {

416 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
) + 1;

418 
tÙËn
 +ğ2 + 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1) + 2;

420 
REQ_TYPE_ARITHMETIC
:

421 ià(
¬gc
 != 3) {

424 
tÙËn
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,0) + 1 +

425 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,1) + 1 +

426 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,2) + 2;

428 
REQ_TYPE_RETRIEVAL
:

429 ià(
¬gc
 <= 1) {

433 
tÙËn
 = 0;

434 
j
 = 0; j < 
¬gc
-1; j ++) {

435 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
) + 1;

437 
tÙËn
 +ğ
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1) + 2;

439 
REQ_TYPE_DELETE
:

440 ià(
¬gc
 != 2 &&‡rgc != 3) {

444 
tÙËn
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,0) + 1 +

445 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,1);

446 ià(
¬gc
 == 3) {

447 ià(
	`¡ºÿ£cmp
(
¬gv
[2],"noreply",7)) {

450 
tÙËn
 +ğ1 + 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,2);

452 
tÙËn
 += 2;

455 
tÙËn
 = -1;

459  
tÙËn
;

460 
	}
}

463 
	$g’”icMemÿchedCommªd
(
cmdty³
, *
cmd
, 
¬gty³
, 
¬gc
, **
¬gv
, 
size_t
 *
¬gvËn
)

465 
j
;

466 
size_t
 
Ën
;

467 
pos
 = 0;

469 
cmdty³
) {

470 
REQ_TYPE_STORAGE
:

471 
REQ_TYPE_CAS
:

472 
j
 = 0; j < 
¬gc
-1; j ++) {

473 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
);

474 
	`memıy
(
cmd
+
pos
,
¬gv
[
j
],
Ën
);

475 
pos
 +ğ()
Ën
;

476 
cmd
[
pos
++] = ' ';

478 
cmd
[
pos
++] = '\r';

479 
cmd
[
pos
++] = '\n';

480 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1);

481 
	`memıy
(
cmd
+
pos
,
¬gv
[
¬gc
-1],
Ën
);

482 
pos
 +ğ()
Ën
;

483 
cmd
[
pos
++] = '\r';

484 
cmd
[
pos
++] = '\n';

486 
REQ_TYPE_ARITHMETIC
:

487 
REQ_TYPE_RETRIEVAL
:

488 
REQ_TYPE_DELETE
:

489 
j
 = 0; j < 
¬gc
-1; j ++) {

490 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
j
);

491 
	`memıy
(
cmd
+
pos
,
¬gv
[
j
],
Ën
);

492 
pos
 +ğ
Ën
;

493 
cmd
[
pos
++] = ' ';

495 
Ën
 = 
	`ARGUMENTLEN
(
¬gty³
,
¬gv
,
¬gvËn
,
¬gc
-1);

496 
	`memıy
(
cmd
+
pos
,
¬gv
[
¬gc
-1],
Ën
);

497 
pos
 +ğ()
Ën
;

498 
cmd
[
pos
++] = '\r';

499 
cmd
[
pos
++] = '\n';

502 
pos
 = -1;

506  
pos
;

507 
	}
}

512 
	$memÿchedFÜm©CommªdSdsArgv
(**
rg‘
, 
¬gc
, cÚ¡ 
sds
 *
¬gv
) {

513 *
cmd
 = 
NULL
;

514 
pos
;

515 
tÙËn
;

516 
ty³
;

519 ià(
rg‘
 =ğ
NULL
 || 
¬gc
 < 1)

522 
ty³
 = 
	`g‘Reque¡Ty³FromSŒšg
(
¬gv
[0], 
	`sd¦’
(argv[0]));

523 ià(
ty³
 < 0)

524 
fÜm©_”r
;

526 
tÙËn
 = 
	`checkCmdV®idAndG‘TÙ®L’
(
ty³
, 0, 
¬gc
, 
¬gv
, 
NULL
);

527 ià(
tÙËn
 < 0) {

528 
fÜm©_”r
;

532 
cmd
 = 
	`m®loc
(
tÙËn
+1);

533 ià(
cmd
 =ğ
NULL
è
memÜy_”r
;

535 
pos
 = 
	`g’”icMemÿchedCommªd
(
ty³
, 
cmd
, 0, 
¬gc
, 
¬gv
, 
NULL
);

536 ià(
pos
 < 0è
fÜm©_”r
;

538 
	`as£¹
(
pos
 =ğ
tÙËn
);

539 
cmd
[
pos
] = '\0';

541 *
rg‘
 = 
cmd
;

542  
tÙËn
;

544 
fÜm©_”r
:

545 ià(
cmd
è
	`ä“
(cmd);

548 
memÜy_”r
:

550 
	}
}

552 
	$memÿchedvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

554 cÚ¡ *
c
 = 
fÜm©
;

555 *
cmd
 = 
NULL
;

556 
pos
;

557 
sds
 
cu¿rg
, 
Ãw¬g
;

558 
touched
 = 0;

559 **
cu¿rgv
 = 
NULL
, **
Ãw¬gv
 = NULL;

560 
¬gc
 = 0;

561 
tÙËn
;

562 
”rÜ_ty³
 = 0;

563 
j
;

566 ià(
rg‘
 =ğ
NULL
)

570 
cu¿rg
 = 
	`sd£m±y
();

571 ià(
cu¿rg
 =ğ
NULL
)

574 *
c
 != '\0') {

575 ià(*
c
 != '%' || c[1] == '\0') {

576 ià(*
c
 == ' ') {

577 ià(
touched
) {

578 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

579 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

580 
cu¿rgv
 = 
Ãw¬gv
;

581 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

584 
cu¿rg
 = 
	`sd£m±y
();

585 ià(
cu¿rg
 =ğ
NULL
è
memÜy_”r
;

586 
touched
 = 0;

589 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
c
,1);

590 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

591 
cu¿rg
 = 
Ãw¬g
;

592 
touched
 = 1;

595 *
¬g
;

596 
size_t
 
size
;

599 
Ãw¬g
 = 
cu¿rg
;

601 
c
[1]) {

603 
¬g
 = 
	`va_¬g
(
­
,*);

604 
size
 = 
	`¡¾’
(
¬g
);

605 ià(
size
 > 0)

606 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

609 
¬g
 = 
	`va_¬g
(
­
,*);

610 
size
 = 
	`va_¬g
(
­
,
size_t
);

611 ià(
size
 > 0)

612 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

615 
Ãw¬g
 = 
	`sdsÿt
(
cu¿rg
,"%");

620 cÚ¡ 
štfmts
[] = "diouxX";

621 cÚ¡ 
æags
[] = "#0-+ ";

622 
_fÜm©
[16];

623 cÚ¡ *
_p
 = 
c
+1;

624 
size_t
 
_l
 = 0;

625 
va_li¡
 
_ıy
;

628 *
_p
 !ğ'\0' && 
	`¡rchr
(
æags
,*_pè!ğ
NULL
) _p++;

631 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

634 ià(*
_p
 == '.') {

635 
_p
++;

636 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

640 
	`va_cİy
(
_ıy
,
­
);

643 ià(
	`¡rchr
(
štfmts
,*
_p
è!ğ
NULL
) {

644 
	`va_¬g
(
­
,);

645 
fmt_v®id
;

649 ià(
	`¡rchr
("eEfFgGaA",*
_p
è!ğ
NULL
) {

650 
	`va_¬g
(
­
,);

651 
fmt_v®id
;

655 ià(
_p
[0] == 'h' && _p[1] == 'h') {

656 
_p
 += 2;

657 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

658 
	`va_¬g
(
­
,);

659 
fmt_v®id
;

661 
fmt_šv®id
;

665 ià(
_p
[0] == 'h') {

666 
_p
 += 1;

667 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

668 
	`va_¬g
(
­
,);

669 
fmt_v®id
;

671 
fmt_šv®id
;

675 ià(
_p
[0] == 'l' && _p[1] == 'l') {

676 
_p
 += 2;

677 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

678 
	`va_¬g
(
­
,);

679 
fmt_v®id
;

681 
fmt_šv®id
;

685 ià(
_p
[0] == 'l') {

686 
_p
 += 1;

687 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

688 
	`va_¬g
(
­
,);

689 
fmt_v®id
;

691 
fmt_šv®id
;

694 
fmt_šv®id
:

695 
	`va_’d
(
_ıy
);

696 
fÜm©_”r
;

698 
fmt_v®id
:

699 
_l
 = (
_p
+1)-
c
;

700 ià(
_l
 < (
_fÜm©
)-2) {

701 
	`memıy
(
_fÜm©
,
c
,
_l
);

702 
_fÜm©
[
_l
] = '\0';

703 
Ãw¬g
 = 
	`sdsÿtv´štf
(
cu¿rg
,
_fÜm©
,
_ıy
);

707 
c
 = 
_p
-1;

710 
	`va_’d
(
_ıy
);

715 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

716 
cu¿rg
 = 
Ãw¬g
;

718 
touched
 = 1;

719 
c
++;

721 
c
++;

725 ià(
touched
) {

726 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

727 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

728 
cu¿rgv
 = 
Ãw¬gv
;

729 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

731 
	`sdsä“
(
cu¿rg
);

735 
cu¿rg
 = 
NULL
;

737 
tÙËn
 = 
	`memÿchedFÜm©CommªdSdsArgv
(&
cmd
, 
¬gc
,
cu¿rgv
);

738 ià(
tÙËn
 < 0) {

739 
”rÜ_ty³
 = 
tÙËn
;

740 
ş—nup
;

743 
	`ä“
(
cu¿rgv
);

744 *
rg‘
 = 
cmd
;

745  
tÙËn
;

747 
fÜm©_”r
:

748 
”rÜ_ty³
 = -2;

749 
ş—nup
;

751 
memÜy_”r
:

752 
”rÜ_ty³
 = -1;

753 
ş—nup
;

755 
ş—nup
:

756 ià(
cu¿rgv
) {

757 
¬gc
--)

758 
	`sdsä“
(
cu¿rgv
[
¬gc
]);

759 
	`ä“
(
cu¿rgv
);

762 
	`sdsä“
(
cu¿rg
);

766 ià(
cmd
 !ğ
NULL
)

767 
	`ä“
(
cmd
);

769  
”rÜ_ty³
;

770 
	}
}

784 
	$memÿchedFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...) {

785 
va_li¡
 
­
;

786 
Ën
;

787 
	`va_¡¬t
(
­
,
fÜm©
);

788 
Ën
 = 
	`memÿchedvFÜm©Commªd
(
rg‘
,
fÜm©
,
­
);

789 
	`va_’d
(
­
);

793 ià(
Ën
 < 0)

794 
Ën
 = -1;

796  
Ën
;

797 
	}
}

804 
	$memÿchedFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

805 *
cmd
 = 
NULL
;

806 
pos
;

807 
tÙËn
;

808 
ty³
;

811 ià(
rg‘
 =ğ
NULL
 || 
¬gc
 < 1)

814 
ty³
 = 
	`g‘Reque¡Ty³FromSŒšg
(
¬gv
[0], 
¬gvËn
==
NULL
?
	`¡¾’
(argv[0]):argvlen[0]);

815 ià(
ty³
 < 0) {

816 
fÜm©_”r
;

819 
tÙËn
 = 
	`checkCmdV®idAndG‘TÙ®L’
(
ty³
, 1, 
¬gc
, 
¬gv
, 
¬gvËn
);

820 ià(
tÙËn
 < 0) {

821 
fÜm©_”r
;

825 
cmd
 = 
	`m®loc
(
tÙËn
+1);

826 ià(
cmd
 =ğ
NULL
è
memÜy_”r
;

828 
pos
 = 
	`g’”icMemÿchedCommªd
(
ty³
, 
cmd
, 1, 
¬gc
, 
¬gv
, 
¬gvËn
);

829 ià(
pos
 < 0) {

830 
fÜm©_”r
;

833 
	`as£¹
(
pos
 =ğ
tÙËn
);

834 
cmd
[
pos
] = '\0';

836 *
rg‘
 = 
cmd
;

837  
tÙËn
;

839 
fÜm©_”r
:

840 ià(
cmd
è
	`ä“
(cmd);

843 
memÜy_”r
:

845 
	}
}

	@dep/himemcached-0.1.0/himemcached.h

1 #iâdeà
_HIMEMCACHED_H_


2 
	#_HIMEMCACHED_H_


	)

4 
	~"himü—d.h
"

5 
	~"himcd•/sds.h
"

7 
	#HIMC_MAJOR
 0

	)

8 
	#HIMC_MINOR
 13

	)

9 
	#HIMC_PATCH
 1

	)

13 
	#MC_BLOCK
 0x1

	)

17 
	#MC_CONNECTED
 0x2

	)

23 
	#MC_DISCONNECTING
 0x4

	)

27 
	#MC_FREEING
 0x8

	)

30 
	#MC_IN_CALLBACK
 0x10

	)

33 
	#MC_SUBSCRIBED
 0x20

	)

36 
	#MC_MONITORING
 0x40

	)

39 
	#MC_REUSEADDR
 0x80

	)

41 
	#MC_KEEPALIVE_INTERVAL
 15

	)

45 
	#MC_CONNECT_RETRIES
 10

	)

48 
	smcR•ly
 {

49 
	mty³
;

50 
	mš‹g”
;

51 
	mkeyËn
;

52 *
	mkey
;

53 
	mËn
;

54 *
	m¡r
;

55 
	mæags
;

56 
	mv”siÚ
;

57 
size_t
 
	m–em’ts
;

58 
mcR•ly
 **
	m–em’t
;

59 } 
	tmcR•ly
;

61 
mcR—d”
 *
memÿchedR—d”C»©e
();

64 
ä“McR•lyObjeù
(*
»¶y
);

66 
	emcCÚÃùiÚTy³
 {

67 
	mMC_CONN_TCP
,

68 
	mMC_CONN_UNIX
,

72 
	smcCÚ‹xt
 {

73 
	m”r
;

74 
	m”r¡r
[128];

75 
	mfd
;

76 
	mæags
;

77 *
	mobuf
;

78 
mcR—d”
 *
	m»ad”
;

80 
mcCÚÃùiÚTy³
 
	mcÚÃùiÚ_ty³
;

81 
timev®
 *
	mtimeout
;

84 *
	mho¡
;

85 *
	msourû_addr
;

86 
	mpÜt
;

87 } 
	mtı
;

90 *
	m·th
;

91 } 
	munix_sock
;

92 } 
	tmcCÚ‹xt
;

94 
memÿchedBufãrWr™e
(
mcCÚ‹xt
 *
c
, *
dÚe
);

95 
memÿchedBufãrR—d
(
mcCÚ‹xt
 *
c
);

97 
memÿchedG‘R•lyFromR—d”
(
mcCÚ‹xt
 *
c
, **
»¶y
);

98 
memÿchedG‘R•ly
(
mcCÚ‹xt
 *
c
, **
»¶y
);

100 
mcCÚ‹xt
 *
memÿchedCÚ‹xtIn™
();

101 
memÿchedF»e
(
mcCÚ‹xt
 *
c
) ;

103 
memÿchedFÜm©CommªdSdsArgv
(**
rg‘
, 
¬gc
, cÚ¡ 
sds
 *
¬gv
);

104 
memÿchedvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

105 
memÿchedFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...);

106 
memÿchedFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

	@dep/himemcached-0.1.0/himemcached.h

1 #iâdeà
_HIMEMCACHED_H_


2 
	#_HIMEMCACHED_H_


	)

4 
	~"himü—d.h
"

5 
	~"himcd•/sds.h
"

7 
	#HIMC_MAJOR
 0

	)

8 
	#HIMC_MINOR
 13

	)

9 
	#HIMC_PATCH
 1

	)

13 
	#MC_BLOCK
 0x1

	)

17 
	#MC_CONNECTED
 0x2

	)

23 
	#MC_DISCONNECTING
 0x4

	)

27 
	#MC_FREEING
 0x8

	)

30 
	#MC_IN_CALLBACK
 0x10

	)

33 
	#MC_SUBSCRIBED
 0x20

	)

36 
	#MC_MONITORING
 0x40

	)

39 
	#MC_REUSEADDR
 0x80

	)

41 
	#MC_KEEPALIVE_INTERVAL
 15

	)

45 
	#MC_CONNECT_RETRIES
 10

	)

48 
	smcR•ly
 {

49 
	mty³
;

50 
	mš‹g”
;

51 
	mkeyËn
;

52 *
	mkey
;

53 
	mËn
;

54 *
	m¡r
;

55 
	mæags
;

56 
	mv”siÚ
;

57 
size_t
 
	m–em’ts
;

58 
mcR•ly
 **
	m–em’t
;

59 } 
	tmcR•ly
;

61 
mcR—d”
 *
memÿchedR—d”C»©e
();

64 
ä“McR•lyObjeù
(*
»¶y
);

66 
	emcCÚÃùiÚTy³
 {

67 
	mMC_CONN_TCP
,

68 
	mMC_CONN_UNIX
,

72 
	smcCÚ‹xt
 {

73 
	m”r
;

74 
	m”r¡r
[128];

75 
	mfd
;

76 
	mæags
;

77 *
	mobuf
;

78 
mcR—d”
 *
	m»ad”
;

80 
mcCÚÃùiÚTy³
 
	mcÚÃùiÚ_ty³
;

81 
timev®
 *
	mtimeout
;

84 *
	mho¡
;

85 *
	msourû_addr
;

86 
	mpÜt
;

87 } 
	mtı
;

90 *
	m·th
;

91 } 
	munix_sock
;

92 } 
	tmcCÚ‹xt
;

94 
memÿchedBufãrWr™e
(
mcCÚ‹xt
 *
c
, *
dÚe
);

95 
memÿchedBufãrR—d
(
mcCÚ‹xt
 *
c
);

97 
memÿchedG‘R•lyFromR—d”
(
mcCÚ‹xt
 *
c
, **
»¶y
);

98 
memÿchedG‘R•ly
(
mcCÚ‹xt
 *
c
, **
»¶y
);

100 
mcCÚ‹xt
 *
memÿchedCÚ‹xtIn™
();

101 
memÿchedF»e
(
mcCÚ‹xt
 *
c
) ;

103 
memÿchedFÜm©CommªdSdsArgv
(**
rg‘
, 
¬gc
, cÚ¡ 
sds
 *
¬gv
);

104 
memÿchedvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

105 
memÿchedFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...);

106 
memÿchedFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

	@dep/hiredis-0.13.3/adapters/ae.h

31 #iâdeà
__HIREDIS_AE_H__


32 
	#__HIREDIS_AE_H__


	)

33 
	~<sys/ty³s.h
>

34 
	~<«.h
>

35 
	~"../hœedis.h
"

36 
	~"../async.h
"

38 
	s»disAeEv’ts
 {

39 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

40 
«Ev’tLoİ
 *
	mloİ
;

41 
	mfd
;

42 
	m»adšg
, 
	mwr™šg
;

43 } 
	t»disAeEv’ts
;

45 
	$»disAeR—dEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

46 (()
–
); (()
fd
); (()
mask
);

48 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

49 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

50 
	}
}

52 
	$»disAeWr™eEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

53 (()
–
); (()
fd
); (()
mask
);

55 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

56 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

57 
	}
}

59 
	$»disAeAddR—d
(*
´ivd©a
) {

60 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

61 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

62 ià(!
e
->
»adšg
) {

63 
e
->
»adšg
 = 1;

64 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
,
»disAeR—dEv’t
,e);

66 
	}
}

68 
	$»disAeD–R—d
(*
´ivd©a
) {

69 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

70 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

71 ià(
e
->
»adšg
) {

72 
e
->
»adšg
 = 0;

73 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
);

75 
	}
}

77 
	$»disAeAddWr™e
(*
´ivd©a
) {

78 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

79 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

80 ià(!
e
->
wr™šg
) {

81 
e
->
wr™šg
 = 1;

82 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
,
»disAeWr™eEv’t
,e);

84 
	}
}

86 
	$»disAeD–Wr™e
(*
´ivd©a
) {

87 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

88 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

89 ià(
e
->
wr™šg
) {

90 
e
->
wr™šg
 = 0;

91 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
);

93 
	}
}

95 
	$»disAeCËªup
(*
´ivd©a
) {

96 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

97 
	`»disAeD–R—d
(
´ivd©a
);

98 
	`»disAeD–Wr™e
(
´ivd©a
);

99 
	`ä“
(
e
);

100 
	}
}

102 
	$»disAeA‰ach
(
«Ev’tLoİ
 *
loİ
, 
»disAsyncCÚ‹xt
 *
ac
) {

103 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

104 
»disAeEv’ts
 *
e
;

107 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

108  
REDIS_ERR
;

111 
e
 = (
»disAeEv’ts
*)
	`m®loc
((*e));

112 
e
->
cÚ‹xt
 = 
ac
;

113 
e
->
loİ
 =†oop;

114 
e
->
fd
 = 
c
->fd;

115 
e
->
»adšg
 =ƒ->
wr™šg
 = 0;

118 
ac
->
ev
.
addR—d
 = 
»disAeAddR—d
;

119 
ac
->
ev
.
d–R—d
 = 
»disAeD–R—d
;

120 
ac
->
ev
.
addWr™e
 = 
»disAeAddWr™e
;

121 
ac
->
ev
.
d–Wr™e
 = 
»disAeD–Wr™e
;

122 
ac
->
ev
.
ş—nup
 = 
»disAeCËªup
;

123 
ac
->
ev
.
d©a
 = 
e
;

125  
REDIS_OK
;

126 
	}
}

	@dep/hiredis-0.13.3/adapters/glib.h

1 #iâdeà
__HIREDIS_GLIB_H__


2 
	#__HIREDIS_GLIB_H__


	)

4 
	~<glib.h
>

6 
	~"../hœedis.h
"

7 
	~"../async.h
"

11 
GSourû
 
	msourû
;

12 
»disAsyncCÚ‹xt
 *
	mac
;

13 
GPŞlFD
 
	mpŞl_fd
;

14 } 
	tRedisSourû
;

17 
	$»dis_sourû_add_»ad
 (
gpoš‹r
 
d©a
)

19 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

20 
	`g_»tuº_if_ç
(
sourû
);

21 
sourû
->
pŞl_fd
.
ev’ts
 |ğ
G_IO_IN
;

22 
	`g_maš_cÚ‹xt_wakeup
(
	`g_sourû_g‘_cÚ‹xt
((
GSourû
 *)
d©a
));

23 
	}
}

26 
	$»dis_sourû_d–_»ad
 (
gpoš‹r
 
d©a
)

28 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

29 
	`g_»tuº_if_ç
(
sourû
);

30 
sourû
->
pŞl_fd
.
ev’ts
 &ğ~
G_IO_IN
;

31 
	`g_maš_cÚ‹xt_wakeup
(
	`g_sourû_g‘_cÚ‹xt
((
GSourû
 *)
d©a
));

32 
	}
}

35 
	$»dis_sourû_add_wr™e
 (
gpoš‹r
 
d©a
)

37 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

38 
	`g_»tuº_if_ç
(
sourû
);

39 
sourû
->
pŞl_fd
.
ev’ts
 |ğ
G_IO_OUT
;

40 
	`g_maš_cÚ‹xt_wakeup
(
	`g_sourû_g‘_cÚ‹xt
((
GSourû
 *)
d©a
));

41 
	}
}

44 
	$»dis_sourû_d–_wr™e
 (
gpoš‹r
 
d©a
)

46 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

47 
	`g_»tuº_if_ç
(
sourû
);

48 
sourû
->
pŞl_fd
.
ev’ts
 &ğ~
G_IO_OUT
;

49 
	`g_maš_cÚ‹xt_wakeup
(
	`g_sourû_g‘_cÚ‹xt
((
GSourû
 *)
d©a
));

50 
	}
}

53 
	$»dis_sourû_ş—nup
 (
gpoš‹r
 
d©a
)

55 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

57 
	`g_»tuº_if_ç
(
sourû
);

59 
	`»dis_sourû_d–_»ad
(
sourû
);

60 
	`»dis_sourû_d–_wr™e
(
sourû
);

65 ià(
sourû
->
pŞl_fd
.
fd
 >= 0) {

66 
	`g_sourû_»move_pŞl
((
GSourû
 *)
d©a
, &
sourû
->
pŞl_fd
);

67 
sourû
->
pŞl_fd
.
fd
 = -1;

69 
	}
}

71 
gboŞ—n


72 
	$»dis_sourû_´•¬e
 (
GSourû
 *
sourû
,

73 
gšt
 *
timeout_
)

75 
RedisSourû
 *
»dis
 = (RedisSourû *)
sourû
;

76 *
timeout_
 = -1;

77  !!(
»dis
->
pŞl_fd
.
ev’ts
 &„edis->pŞl_fd.
»v’ts
);

78 
	}
}

80 
gboŞ—n


81 
	$»dis_sourû_check
 (
GSourû
 *
sourû
)

83 
RedisSourû
 *
»dis
 = (RedisSourû *)
sourû
;

84  !!(
»dis
->
pŞl_fd
.
ev’ts
 &„edis->pŞl_fd.
»v’ts
);

85 
	}
}

87 
gboŞ—n


88 
	$»dis_sourû_di¥©ch
 (
GSourû
 *
sourû
,

89 
GSourûFunc
 
ÿÎback
,

90 
gpoš‹r
 
u£r_d©a
)

92 
RedisSourû
 *
»dis
 = (RedisSourû *)
sourû
;

94 ià((
»dis
->
pŞl_fd
.
»v’ts
 & 
G_IO_OUT
)) {

95 
	`»disAsyncHªdËWr™e
(
»dis
->
ac
);

96 
»dis
->
pŞl_fd
.
»v’ts
 &ğ~
G_IO_OUT
;

99 ià((
»dis
->
pŞl_fd
.
»v’ts
 & 
G_IO_IN
)) {

100 
	`»disAsyncHªdËR—d
(
»dis
->
ac
);

101 
»dis
->
pŞl_fd
.
»v’ts
 &ğ~
G_IO_IN
;

104 ià(
ÿÎback
) {

105  
	`ÿÎback
(
u£r_d©a
);

108  
TRUE
;

109 
	}
}

112 
	$»dis_sourû_fš®ize
 (
GSourû
 *
sourû
)

114 
RedisSourû
 *
»dis
 = (RedisSourû *)
sourû
;

116 ià(
»dis
->
pŞl_fd
.
fd
 >= 0) {

117 
	`g_sourû_»move_pŞl
(
sourû
, &
»dis
->
pŞl_fd
);

118 
»dis
->
pŞl_fd
.
fd
 = -1;

120 
	}
}

122 
GSourû
 *

123 
	$»dis_sourû_Ãw
 (
»disAsyncCÚ‹xt
 *
ac
)

125 
GSourûFuncs
 
sourû_funcs
 = {

126 .
´•¬e
 = 
»dis_sourû_´•¬e
,

127 .
check
 = 
»dis_sourû_check
,

128 .
di¥©ch
 = 
»dis_sourû_di¥©ch
,

129 .
fš®ize
 = 
»dis_sourû_fš®ize
,

131 
»disCÚ‹xt
 *
c
 = &
ac
->c;

132 
RedisSourû
 *
sourû
;

134 
	`g_»tuº_v®_if_ç
(
ac
 !ğ
NULL
, NULL);

136 
sourû
 = (
RedisSourû
 *)
	`g_sourû_Ãw
(&
sourû_funcs
,  *source);

137 
sourû
->
ac
 =‡c;

138 
sourû
->
pŞl_fd
.
fd
 = 
c
->fd;

139 
sourû
->
pŞl_fd
.
ev’ts
 = 0;

140 
sourû
->
pŞl_fd
.
»v’ts
 = 0;

141 
	`g_sourû_add_pŞl
((
GSourû
 *)
sourû
, &sourû->
pŞl_fd
);

143 
ac
->
ev
.
addR—d
 = 
»dis_sourû_add_»ad
;

144 
ac
->
ev
.
d–R—d
 = 
»dis_sourû_d–_»ad
;

145 
ac
->
ev
.
addWr™e
 = 
»dis_sourû_add_wr™e
;

146 
ac
->
ev
.
d–Wr™e
 = 
»dis_sourû_d–_wr™e
;

147 
ac
->
ev
.
ş—nup
 = 
»dis_sourû_ş—nup
;

148 
ac
->
ev
.
d©a
 = 
sourû
;

150  (
GSourû
 *)
sourû
;

151 
	}
}

	@dep/hiredis-0.13.3/adapters/ivykis.h

1 #iâdeà
__HIREDIS_IVYKIS_H__


2 
	#__HIREDIS_IVYKIS_H__


	)

3 
	~<iv.h
>

4 
	~"../hœedis.h
"

5 
	~"../async.h
"

7 
	s»disIvykisEv’ts
 {

8 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

9 
iv_fd
 
	mfd
;

10 } 
	t»disIvykisEv’ts
;

12 
	$»disIvykisR—dEv’t
(*
¬g
) {

13 
»disAsyncCÚ‹xt
 *
cÚ‹xt
 = (»disAsyncCÚ‹xˆ*)
¬g
;

14 
	`»disAsyncHªdËR—d
(
cÚ‹xt
);

15 
	}
}

17 
	$»disIvykisWr™eEv’t
(*
¬g
) {

18 
»disAsyncCÚ‹xt
 *
cÚ‹xt
 = (»disAsyncCÚ‹xˆ*)
¬g
;

19 
	`»disAsyncHªdËWr™e
(
cÚ‹xt
);

20 
	}
}

22 
	$»disIvykisAddR—d
(*
´ivd©a
) {

23 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

24 
	`iv_fd_£t_hªdËr_š
(&
e
->
fd
, 
»disIvykisR—dEv’t
);

25 
	}
}

27 
	$»disIvykisD–R—d
(*
´ivd©a
) {

28 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

29 
	`iv_fd_£t_hªdËr_š
(&
e
->
fd
, 
NULL
);

30 
	}
}

32 
	$»disIvykisAddWr™e
(*
´ivd©a
) {

33 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

34 
	`iv_fd_£t_hªdËr_out
(&
e
->
fd
, 
»disIvykisWr™eEv’t
);

35 
	}
}

37 
	$»disIvykisD–Wr™e
(*
´ivd©a
) {

38 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

39 
	`iv_fd_£t_hªdËr_out
(&
e
->
fd
, 
NULL
);

40 
	}
}

42 
	$»disIvykisCËªup
(*
´ivd©a
) {

43 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

45 
	`iv_fd_uÄegi¡”
(&
e
->
fd
);

46 
	`ä“
(
e
);

47 
	}
}

49 
	$»disIvykisA‰ach
(
»disAsyncCÚ‹xt
 *
ac
) {

50 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

51 
»disIvykisEv’ts
 *
e
;

54 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

55  
REDIS_ERR
;

58 
e
 = (
»disIvykisEv’ts
*)
	`m®loc
((*e));

59 
e
->
cÚ‹xt
 = 
ac
;

62 
ac
->
ev
.
addR—d
 = 
»disIvykisAddR—d
;

63 
ac
->
ev
.
d–R—d
 = 
»disIvykisD–R—d
;

64 
ac
->
ev
.
addWr™e
 = 
»disIvykisAddWr™e
;

65 
ac
->
ev
.
d–Wr™e
 = 
»disIvykisD–Wr™e
;

66 
ac
->
ev
.
ş—nup
 = 
»disIvykisCËªup
;

67 
ac
->
ev
.
d©a
 = 
e
;

70 
	`IV_FD_INIT
(&
e
->
fd
);

71 
e
->
fd
.fd = 
c
->fd;

72 
e
->
fd
.
hªdËr_š
 = 
»disIvykisR—dEv’t
;

73 
e
->
fd
.
hªdËr_out
 = 
»disIvykisWr™eEv’t
;

74 
e
->
fd
.
hªdËr_”r
 = 
NULL
;

75 
e
->
fd
.
cook›
 =ƒ->
cÚ‹xt
;

77 
	`iv_fd_»gi¡”
(&
e
->
fd
);

79  
REDIS_OK
;

80 
	}
}

	@dep/hiredis-0.13.3/adapters/libev.h

31 #iâdeà
__HIREDIS_LIBEV_H__


32 
	#__HIREDIS_LIBEV_H__


	)

33 
	~<¡dlib.h
>

34 
	~<sys/ty³s.h
>

35 
	~<ev.h
>

36 
	~"../hœedis.h
"

37 
	~"../async.h
"

39 
	s»disLibevEv’ts
 {

40 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

41 
ev_loİ
 *
	mloİ
;

42 
	m»adšg
, 
	mwr™šg
;

43 
ev_io
 
	m»v
, 
	mwev
;

44 } 
	t»disLibevEv’ts
;

46 
	$»disLibevR—dEv’t
(
EV_P_
 
ev_io
 *
w©ch”
, 
»v’ts
) {

47 #ià
EV_MULTIPLICITY


48 (()
loİ
);

50 (()
»v’ts
);

52 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
w©ch”
->
d©a
;

53 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

54 
	}
}

56 
	$»disLibevWr™eEv’t
(
EV_P_
 
ev_io
 *
w©ch”
, 
»v’ts
) {

57 #ià
EV_MULTIPLICITY


58 (()
loİ
);

60 (()
»v’ts
);

62 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
w©ch”
->
d©a
;

63 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

64 
	}
}

66 
	$»disLibevAddR—d
(*
´ivd©a
) {

67 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

68 
ev_loİ
 *
loİ
 = 
e
->loop;

69 (()
loİ
);

70 ià(!
e
->
»adšg
) {

71 
e
->
»adšg
 = 1;

72 
	`ev_io_¡¬t
(
EV_A_
 &
e
->
»v
);

74 
	}
}

76 
	$»disLibevD–R—d
(*
´ivd©a
) {

77 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

78 
ev_loİ
 *
loİ
 = 
e
->loop;

79 (()
loİ
);

80 ià(
e
->
»adšg
) {

81 
e
->
»adšg
 = 0;

82 
	`ev_io_¡İ
(
EV_A_
 &
e
->
»v
);

84 
	}
}

86 
	$»disLibevAddWr™e
(*
´ivd©a
) {

87 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

88 
ev_loİ
 *
loİ
 = 
e
->loop;

89 (()
loİ
);

90 ià(!
e
->
wr™šg
) {

91 
e
->
wr™šg
 = 1;

92 
	`ev_io_¡¬t
(
EV_A_
 &
e
->
wev
);

94 
	}
}

96 
	$»disLibevD–Wr™e
(*
´ivd©a
) {

97 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

98 
ev_loİ
 *
loİ
 = 
e
->loop;

99 (()
loİ
);

100 ià(
e
->
wr™šg
) {

101 
e
->
wr™šg
 = 0;

102 
	`ev_io_¡İ
(
EV_A_
 &
e
->
wev
);

104 
	}
}

106 
	$»disLibevCËªup
(*
´ivd©a
) {

107 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

108 
	`»disLibevD–R—d
(
´ivd©a
);

109 
	`»disLibevD–Wr™e
(
´ivd©a
);

110 
	`ä“
(
e
);

111 
	}
}

113 
	$»disLibevA‰ach
(
EV_P_
 
»disAsyncCÚ‹xt
 *
ac
) {

114 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

115 
»disLibevEv’ts
 *
e
;

118 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

119  
REDIS_ERR
;

122 
e
 = (
»disLibevEv’ts
*)
	`m®loc
((*e));

123 
e
->
cÚ‹xt
 = 
ac
;

124 #ià
EV_MULTIPLICITY


125 
e
->
loİ
 =†oop;

127 
e
->
loİ
 = 
NULL
;

129 
e
->
»adšg
 =ƒ->
wr™šg
 = 0;

130 
e
->
»v
.
d©a
 =ƒ;

131 
e
->
wev
.
d©a
 =ƒ;

134 
ac
->
ev
.
addR—d
 = 
»disLibevAddR—d
;

135 
ac
->
ev
.
d–R—d
 = 
»disLibevD–R—d
;

136 
ac
->
ev
.
addWr™e
 = 
»disLibevAddWr™e
;

137 
ac
->
ev
.
d–Wr™e
 = 
»disLibevD–Wr™e
;

138 
ac
->
ev
.
ş—nup
 = 
»disLibevCËªup
;

139 
ac
->
ev
.
d©a
 = 
e
;

142 
	`ev_io_š™
(&
e
->
»v
,
»disLibevR—dEv’t
,
c
->
fd
,
EV_READ
);

143 
	`ev_io_š™
(&
e
->
wev
,
»disLibevWr™eEv’t
,
c
->
fd
,
EV_WRITE
);

144  
REDIS_OK
;

145 
	}
}

	@dep/hiredis-0.13.3/adapters/libevent.h

31 #iâdeà
__HIREDIS_LIBEVENT_H__


32 
	#__HIREDIS_LIBEVENT_H__


	)

33 
	~<ev’t.h
>

34 
	~"../hœedis.h
"

35 
	~"../async.h
"

37 
	s»disLibev’tEv’ts
 {

38 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

39 
ev’t
 
	m»v
, 
	mwev
;

40 } 
	t»disLibev’tEv’ts
;

42 
	$»disLibev’tR—dEv’t
(
fd
, 
ev’t
, *
¬g
) {

43 (()
fd
); (()
ev’t
);

44 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
¬g
;

45 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

46 
	}
}

48 
	$»disLibev’tWr™eEv’t
(
fd
, 
ev’t
, *
¬g
) {

49 (()
fd
); (()
ev’t
);

50 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
¬g
;

51 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

52 
	}
}

54 
	$»disLibev’tAddR—d
(*
´ivd©a
) {

55 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

56 
	`ev’t_add
(&
e
->
»v
,
NULL
);

57 
	}
}

59 
	$»disLibev’tD–R—d
(*
´ivd©a
) {

60 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

61 
	`ev’t_d–
(&
e
->
»v
);

62 
	}
}

64 
	$»disLibev’tAddWr™e
(*
´ivd©a
) {

65 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

66 
	`ev’t_add
(&
e
->
wev
,
NULL
);

67 
	}
}

69 
	$»disLibev’tD–Wr™e
(*
´ivd©a
) {

70 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

71 
	`ev’t_d–
(&
e
->
wev
);

72 
	}
}

74 
	$»disLibev’tCËªup
(*
´ivd©a
) {

75 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

76 
	`ev’t_d–
(&
e
->
»v
);

77 
	`ev’t_d–
(&
e
->
wev
);

78 
	`ä“
(
e
);

79 
	}
}

81 
	$»disLibev’tA‰ach
(
»disAsyncCÚ‹xt
 *
ac
, 
ev’t_ba£
 *
ba£
) {

82 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

83 
»disLibev’tEv’ts
 *
e
;

86 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

87  
REDIS_ERR
;

90 
e
 = (
»disLibev’tEv’ts
*)
	`m®loc
((*e));

91 
e
->
cÚ‹xt
 = 
ac
;

94 
ac
->
ev
.
addR—d
 = 
»disLibev’tAddR—d
;

95 
ac
->
ev
.
d–R—d
 = 
»disLibev’tD–R—d
;

96 
ac
->
ev
.
addWr™e
 = 
»disLibev’tAddWr™e
;

97 
ac
->
ev
.
d–Wr™e
 = 
»disLibev’tD–Wr™e
;

98 
ac
->
ev
.
ş—nup
 = 
»disLibev’tCËªup
;

99 
ac
->
ev
.
d©a
 = 
e
;

102 
	`ev’t_£t
(&
e
->
»v
,
c
->
fd
,
EV_READ
,
»disLibev’tR—dEv’t
,e);

103 
	`ev’t_£t
(&
e
->
wev
,
c
->
fd
,
EV_WRITE
,
»disLibev’tWr™eEv’t
,e);

104 
	`ev’t_ba£_£t
(
ba£
,&
e
->
»v
);

105 
	`ev’t_ba£_£t
(
ba£
,&
e
->
wev
);

106  
REDIS_OK
;

107 
	}
}

	@dep/hiredis-0.13.3/adapters/libuv.h

1 #iâdeà
__HIREDIS_LIBUV_H__


2 
	#__HIREDIS_LIBUV_H__


	)

3 
	~<¡dlib.h
>

4 
	~<uv.h
>

5 
	~"../hœedis.h
"

6 
	~"../async.h
"

7 
	~<¡ršg.h
>

9 
	s»disLibuvEv’ts
 {

10 
»disAsyncCÚ‹xt
* 
	mcÚ‹xt
;

11 
uv_pŞl_t
 
	mhªdË
;

12 
	mev’ts
;

13 } 
	t»disLibuvEv’ts
;

16 
	$»disLibuvPŞl
(
uv_pŞl_t
* 
hªdË
, 
¡©us
, 
ev’ts
) {

17 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
hªdË
->
d©a
;

19 ià(
¡©us
 != 0) {

23 ià(
ev’ts
 & 
UV_READABLE
) {

24 
	`»disAsyncHªdËR—d
(
p
->
cÚ‹xt
);

26 ià(
ev’ts
 & 
UV_WRITABLE
) {

27 
	`»disAsyncHªdËWr™e
(
p
->
cÚ‹xt
);

29 
	}
}

32 
	$»disLibuvAddR—d
(*
´ivd©a
) {

33 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

35 
p
->
ev’ts
 |ğ
UV_READABLE
;

37 
	`uv_pŞl_¡¬t
(&
p
->
hªdË
,…->
ev’ts
, 
»disLibuvPŞl
);

38 
	}
}

41 
	$»disLibuvD–R—d
(*
´ivd©a
) {

42 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

44 
p
->
ev’ts
 &ğ~
UV_READABLE
;

46 ià(
p
->
ev’ts
) {

47 
	`uv_pŞl_¡¬t
(&
p
->
hªdË
,…->
ev’ts
, 
»disLibuvPŞl
);

49 
	`uv_pŞl_¡İ
(&
p
->
hªdË
);

51 
	}
}

54 
	$»disLibuvAddWr™e
(*
´ivd©a
) {

55 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

57 
p
->
ev’ts
 |ğ
UV_WRITABLE
;

59 
	`uv_pŞl_¡¬t
(&
p
->
hªdË
,…->
ev’ts
, 
»disLibuvPŞl
);

60 
	}
}

63 
	$»disLibuvD–Wr™e
(*
´ivd©a
) {

64 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

66 
p
->
ev’ts
 &ğ~
UV_WRITABLE
;

68 ià(
p
->
ev’ts
) {

69 
	`uv_pŞl_¡¬t
(&
p
->
hªdË
,…->
ev’ts
, 
»disLibuvPŞl
);

71 
	`uv_pŞl_¡İ
(&
p
->
hªdË
);

73 
	}
}

76 
	$Ú_şo£
(
uv_hªdË_t
* 
hªdË
) {

77 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
hªdË
->
d©a
;

79 
	`ä“
(
p
);

80 
	}
}

83 
	$»disLibuvCËªup
(*
´ivd©a
) {

84 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

86 
	`uv_şo£
((
uv_hªdË_t
*)&
p
->
hªdË
, 
Ú_şo£
);

87 
	}
}

90 
	$»disLibuvA‰ach
(
»disAsyncCÚ‹xt
* 
ac
, 
uv_loİ_t
* 
loİ
) {

91 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

93 ià(
ac
->
ev
.
d©a
 !ğ
NULL
) {

94  
REDIS_ERR
;

97 
ac
->
ev
.
addR—d
 = 
»disLibuvAddR—d
;

98 
ac
->
ev
.
d–R—d
 = 
»disLibuvD–R—d
;

99 
ac
->
ev
.
addWr™e
 = 
»disLibuvAddWr™e
;

100 
ac
->
ev
.
d–Wr™e
 = 
»disLibuvD–Wr™e
;

101 
ac
->
ev
.
ş—nup
 = 
»disLibuvCËªup
;

103 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
	`m®loc
((*p));

105 ià(!
p
) {

106  
REDIS_ERR
;

109 
	`mem£t
(
p
, 0, (*p));

111 ià(
	`uv_pŞl_š™
(
loİ
, &
p
->
hªdË
, 
c
->
fd
) != 0) {

112  
REDIS_ERR
;

115 
ac
->
ev
.
d©a
 = 
p
;

116 
p
->
hªdË
.
d©a
 =…;

117 
p
->
cÚ‹xt
 = 
ac
;

119  
REDIS_OK
;

120 
	}
}

	@dep/hiredis-0.13.3/adapters/macosx.h

6 #iâdeà
__HIREDIS_MACOSX_H__


7 
	#__HIREDIS_MACOSX_H__


	)

9 
	~<CÜeFound©iÚ/CÜeFound©iÚ.h
>

11 
	~"../hœedis.h
"

12 
	~"../async.h
"

15 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

16 
CFSock‘Ref
 
	msock‘Ref
;

17 
CFRunLoİSourûRef
 
	msourûRef
;

18 } 
	tRedisRunLoİ
;

20 
	$ä“RedisRunLoİ
(
RedisRunLoİ
* 
»disRunLoİ
) {

21 ifĞ
»disRunLoİ
 !ğ
NULL
 ) {

22 ifĞ
»disRunLoİ
->
sourûRef
 !ğ
NULL
 ) {

23 
	`CFRunLoİSourûInv®id©e
(
»disRunLoİ
->
sourûRef
);

24 
	`CFR–—£
(
»disRunLoİ
->
sourûRef
);

26 ifĞ
»disRunLoİ
->
sock‘Ref
 !ğ
NULL
 ) {

27 
	`CFSock‘Inv®id©e
(
»disRunLoİ
->
sock‘Ref
);

28 
	`CFR–—£
(
»disRunLoİ
->
sock‘Ref
);

30 
	`ä“
(
»disRunLoİ
);

32  
REDIS_ERR
;

33 
	}
}

35 
	$»disMacOSAddR—d
(*
´ivd©a
) {

36 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

37 
	`CFSock‘EÇbËC®lBacks
(
»disRunLoİ
->
sock‘Ref
, 
kCFSock‘R—dC®lBack
);

38 
	}
}

40 
	$»disMacOSD–R—d
(*
´ivd©a
) {

41 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

42 
	`CFSock‘Di§bËC®lBacks
(
»disRunLoİ
->
sock‘Ref
, 
kCFSock‘R—dC®lBack
);

43 
	}
}

45 
	$»disMacOSAddWr™e
(*
´ivd©a
) {

46 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

47 
	`CFSock‘EÇbËC®lBacks
(
»disRunLoİ
->
sock‘Ref
, 
kCFSock‘Wr™eC®lBack
);

48 
	}
}

50 
	$»disMacOSD–Wr™e
(*
´ivd©a
) {

51 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

52 
	`CFSock‘Di§bËC®lBacks
(
»disRunLoİ
->
sock‘Ref
, 
kCFSock‘Wr™eC®lBack
);

53 
	}
}

55 
	$»disMacOSCËªup
(*
´ivd©a
) {

56 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

57 
	`ä“RedisRunLoİ
(
»disRunLoİ
);

58 
	}
}

60 
	$»disMacOSAsyncC®lback
(
CFSock‘Ref
 
__unu£d
 
s
, 
CFSock‘C®lBackTy³
 
ÿÎbackTy³
, 
CFD©aRef
 __unu£d 
add»ss
, cÚ¡ __unu£d *
d©a
, *
šfo
) {

61 
»disAsyncCÚ‹xt
* 
cÚ‹xt
 = (»disAsyncCÚ‹xt*è
šfo
;

63 
ÿÎbackTy³
) {

64 
kCFSock‘R—dC®lBack
:

65 
	`»disAsyncHªdËR—d
(
cÚ‹xt
);

68 
kCFSock‘Wr™eC®lBack
:

69 
	`»disAsyncHªdËWr™e
(
cÚ‹xt
);

75 
	}
}

77 
	$»disMacOSA‰ach
(
»disAsyncCÚ‹xt
 *
»disAsyncCtx
, 
CFRunLoİRef
 
runLoİ
) {

78 
»disCÚ‹xt
 *
»disCtx
 = &(
»disAsyncCtx
->
c
);

81 ifĞ
»disAsyncCtx
->
ev
.
d©a
 !ğ
NULL
 )  
REDIS_ERR
;

83 
RedisRunLoİ
* 
»disRunLoİ
 = (RedisRunLoİ*è
	`ÿÎoc
(1, (RedisRunLoop));

84 ifĞ!
»disRunLoİ
 )  
REDIS_ERR
;

87 
»disRunLoİ
->
cÚ‹xt
 = 
»disAsyncCtx
;

89 
»disAsyncCtx
->
ev
.
addR—d
 = 
»disMacOSAddR—d
;

90 
»disAsyncCtx
->
ev
.
d–R—d
 = 
»disMacOSD–R—d
;

91 
»disAsyncCtx
->
ev
.
addWr™e
 = 
»disMacOSAddWr™e
;

92 
»disAsyncCtx
->
ev
.
d–Wr™e
 = 
»disMacOSD–Wr™e
;

93 
»disAsyncCtx
->
ev
.
ş—nup
 = 
»disMacOSCËªup
;

94 
»disAsyncCtx
->
ev
.
d©a
 = 
»disRunLoİ
;

97 
CFSock‘CÚ‹xt
 
sock‘Ctx
 = { 0, 
»disAsyncCtx
, 
NULL
, NULL, NULL };

99 
»disRunLoİ
->
sock‘Ref
 = 
	`CFSock‘C»©eW™hN©ive
(
NULL
, 
»disCtx
->
fd
,

100 
kCFSock‘R—dC®lBack
 | 
kCFSock‘Wr™eC®lBack
,

101 
»disMacOSAsyncC®lback
,

102 &
sock‘Ctx
);

103 ifĞ!
»disRunLoİ
->
sock‘Ref
 )  
	`ä“RedisRunLoİ
(redisRunLoop);

105 
»disRunLoİ
->
sourûRef
 = 
	`CFSock‘C»©eRunLoİSourû
(
NULL
,„edisRunLoİ->
sock‘Ref
, 0);

106 ifĞ!
»disRunLoİ
->
sourûRef
 )  
	`ä“RedisRunLoİ
(redisRunLoop);

108 
	`CFRunLoİAddSourû
(
runLoİ
, 
»disRunLoİ
->
sourûRef
, 
kCFRunLoİDeçuÉMode
);

110  
REDIS_OK
;

111 
	}
}

	@dep/hiredis-0.13.3/adapters/qt.h

26 #iâdeà
__HIREDIS_QT_H__


27 
	#__HIREDIS_QT_H__


	)

28 
	~<QSock‘NÙif›r
>

29 
	~"../async.h
"

31 
RedisQtAddR—d
(*);

32 
RedisQtD–R—d
(*);

33 
RedisQtAddWr™e
(*);

34 
RedisQtD–Wr™e
(*);

35 
RedisQtCËªup
(*);

37 şas 
	cRedisQtAd­‹r
 : 
public
 
QObjeù
 {

39 
Q_OBJECT


41 
ä›nd


42 
	$RedisQtAddR—d
(* 
ad­‹r
) {

43 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

44 
a
->
	`addR—d
();

47 
ä›nd


48 
	$RedisQtD–R—d
(* 
ad­‹r
) {

49 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

50 
a
->
	`d–R—d
();

51 
	}
}

53 
ä›nd


54 
	$RedisQtAddWr™e
(* 
ad­‹r
) {

55 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

56 
a
->
	`addWr™e
();

57 
	}
}

59 
ä›nd


60 
	$RedisQtD–Wr™e
(* 
ad­‹r
) {

61 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

62 
a
->
	`d–Wr™e
();

63 
	}
}

65 
ä›nd


66 
	$RedisQtCËªup
(* 
ad­‹r
) {

67 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

68 
a
->
	`ş—nup
();

69 
	}
}

71 
	gpublic
:

72 
	$RedisQtAd­‹r
(
QObjeù
 * 
·»Á
 = 0)

73 : 
	`QObjeù
(
·»Á
), 
	`m_ùx
(0), 
	`m_»ad
(0), 
	$m_wr™e
(0è{ 
	}
}

75 ~
	$RedisQtAd­‹r
() {

76 ià(
m_ùx
 != 0) {

77 
m_ùx
->
ev
.
d©a
 = 
NULL
;

79 
	}
}

81 
	$£tCÚ‹xt
(
»disAsyncCÚ‹xt
 * 
ac
) {

82 ià(
ac
->
ev
.
d©a
 !ğ
NULL
) {

83  
REDIS_ERR
;

85 
m_ùx
 = 
ac
;

86 
m_ùx
->
ev
.
d©a
 = 
this
;

87 
m_ùx
->
ev
.
addR—d
 = 
RedisQtAddR—d
;

88 
m_ùx
->
ev
.
d–R—d
 = 
RedisQtD–R—d
;

89 
m_ùx
->
ev
.
addWr™e
 = 
RedisQtAddWr™e
;

90 
m_ùx
->
ev
.
d–Wr™e
 = 
RedisQtD–Wr™e
;

91 
m_ùx
->
ev
.
ş—nup
 = 
RedisQtCËªup
;

92  
REDIS_OK
;

93 
	}
}

95 
	g´iv©e
:

96 
	$addR—d
() {

97 ià(
m_»ad
) ;

98 
m_»ad
 = 
Ãw
 
	`QSock‘NÙif›r
(
m_ùx
->
c
.
fd
, 
QSock‘NÙif›r
::
R—d
, 0);

99 
	`cÚÃù
(
m_»ad
, 
	`SIGNAL
(
	`aùiv©ed
()), 
this
, 
	`SLOT
(
	`»ad
()));

100 
	}
}

102 
	$d–R—d
() {

103 ià(!
m_»ad
) ;

104 
d–‘e
 
m_»ad
;

105 
m_»ad
 = 0;

106 
	}
}

108 
	$addWr™e
() {

109 ià(
m_wr™e
) ;

110 
m_wr™e
 = 
Ãw
 
	`QSock‘NÙif›r
(
m_ùx
->
c
.
fd
, 
QSock‘NÙif›r
::
Wr™e
, 0);

111 
	`cÚÃù
(
m_wr™e
, 
	`SIGNAL
(
	`aùiv©ed
()), 
this
, 
	`SLOT
(
	`wr™e
()));

112 
	}
}

114 
	$d–Wr™e
() {

115 ià(!
m_wr™e
) ;

116 
d–‘e
 
m_wr™e
;

117 
m_wr™e
 = 0;

118 
	}
}

120 
	$ş—nup
() {

121 
	`d–R—d
();

122 
	`d–Wr™e
();

123 
	}
}

125 
´iv©e
 
	g¦Ùs
:

126 
	$»ad
(è{ 
	`»disAsyncHªdËR—d
(
m_ùx
); 
	}
}

127 
	$wr™e
(è{ 
	`»disAsyncHªdËWr™e
(
m_ùx
); 
	}
}

129 
	g´iv©e
:

130 
»disAsyncCÚ‹xt
 * 
m_ùx
;

131 
QSock‘NÙif›r
 * 
	gm_»ad
;

132 
QSock‘NÙif›r
 * 
	gm_wr™e
;

	@dep/hiredis-0.13.3/async.c

32 
	~"fmaüos.h
"

33 
	~<¡dlib.h
>

34 
	~<¡ršg.h
>

35 
	~<¡ršgs.h
>

36 
	~<as£¹.h
>

37 
	~<ùy³.h
>

38 
	~<”ºo.h
>

39 
	~"async.h
"

40 
	~"Ãt.h
"

41 
	~"diù.c
"

42 
	~"sds.h
"

44 
	#_EL_ADD_READ
(
ùx
) do { \

45 ià((
ùx
)->
ev
.
addR—d
è(ùx)->ev.
	`addR—d
((ùx)->ev.
d©a
); \

46 } 0)

	)

47 
	#_EL_DEL_READ
(
ùx
) do { \

48 ià((
ùx
)->
ev
.
d–R—d
è(ùx)->ev.
	`d–R—d
((ùx)->ev.
d©a
); \

49 } 0)

	)

50 
	#_EL_ADD_WRITE
(
ùx
) do { \

51 ià((
ùx
)->
ev
.
addWr™e
è(ùx)->ev.
	`addWr™e
((ùx)->ev.
d©a
); \

52 } 0)

	)

53 
	#_EL_DEL_WRITE
(
ùx
) do { \

54 ià((
ùx
)->
ev
.
d–Wr™e
è(ùx)->ev.
	`d–Wr™e
((ùx)->ev.
d©a
); \

55 } 0)

	)

56 
	#_EL_CLEANUP
(
ùx
) do { \

57 ià((
ùx
)->
ev
.
ş—nup
è(ùx)->ev.
	`ş—nup
((ùx)->ev.
d©a
); \

58 } 0);

	)

61 
__»disAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
cmd
, 
size_t
 
Ën
);

64 
	$ÿÎbackHash
(cÚ¡ *
key
) {

65  
	`diùG’HashFunùiÚ
((cÚ¡ *)
key
,

66 
	`sd¦’
((cÚ¡ 
sds
)
key
));

67 
	}
}

69 *
	$ÿÎbackV®Dup
(*
´ivd©a
, cÚ¡ *
¤c
) {

70 ((è
´ivd©a
);

71 
»disC®lback
 *
dup
 = 
	`m®loc
((*dup));

72 
	`memıy
(
dup
,
¤c
,(*dup));

73  
dup
;

74 
	}
}

76 
	$ÿÎbackKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

77 
l1
, 
l2
;

78 ((è
´ivd©a
);

80 
l1
 = 
	`sd¦’
((cÚ¡ 
sds
)
key1
);

81 
l2
 = 
	`sd¦’
((cÚ¡ 
sds
)
key2
);

82 ià(
l1
 !ğ
l2
)  0;

83  
	`memcmp
(
key1
,
key2
,
l1
) == 0;

84 
	}
}

86 
	$ÿÎbackKeyDe¡ruùÜ
(*
´ivd©a
, *
key
) {

87 ((è
´ivd©a
);

88 
	`sdsä“
((
sds
)
key
);

89 
	}
}

91 
	$ÿÎbackV®De¡ruùÜ
(*
´ivd©a
, *
v®
) {

92 ((è
´ivd©a
);

93 
	`ä“
(
v®
);

94 
	}
}

96 
diùTy³
 
	gÿÎbackDiù
 = {

97 
ÿÎbackHash
,

98 
NULL
,

99 
ÿÎbackV®Dup
,

100 
ÿÎbackKeyCom·»
,

101 
ÿÎbackKeyDe¡ruùÜ
,

102 
ÿÎbackV®De¡ruùÜ


105 
»disAsyncCÚ‹xt
 *
	$»disAsyncIn™Ÿlize
(
»disCÚ‹xt
 *
c
) {

106 
»disAsyncCÚ‹xt
 *
ac
;

108 
ac
 = 
	`»®loc
(
c
,(
»disAsyncCÚ‹xt
));

109 ià(
ac
 =ğ
NULL
)

110  
NULL
;

112 
c
 = &(
ac
->c);

117 
c
->
æags
 &ğ~
REDIS_CONNECTED
;

119 
ac
->
”r
 = 0;

120 
ac
->
”r¡r
 = 
NULL
;

121 
ac
->
d©a
 = 
NULL
;

123 
ac
->
ev
.
d©a
 = 
NULL
;

124 
ac
->
ev
.
addR—d
 = 
NULL
;

125 
ac
->
ev
.
d–R—d
 = 
NULL
;

126 
ac
->
ev
.
addWr™e
 = 
NULL
;

127 
ac
->
ev
.
d–Wr™e
 = 
NULL
;

128 
ac
->
ev
.
ş—nup
 = 
NULL
;

130 
ac
->
ÚCÚÃù
 = 
NULL
;

131 
ac
->
ÚDiscÚÃù
 = 
NULL
;

133 
ac
->
»¶›s
.
h—d
 = 
NULL
;

134 
ac
->
»¶›s
.

 = 
NULL
;

135 
ac
->
sub
.
šv®id
.
h—d
 = 
NULL
;

136 
ac
->
sub
.
šv®id
.

 = 
NULL
;

137 
ac
->
sub
.
chªÃls
 = 
	`diùC»©e
(&
ÿÎbackDiù
,
NULL
);

138 
ac
->
sub
.
·‰”ns
 = 
	`diùC»©e
(&
ÿÎbackDiù
,
NULL
);

139  
ac
;

140 
	}
}

144 
	$__»disAsyncCİyE¼Ü
(
»disAsyncCÚ‹xt
 *
ac
) {

145 ià(!
ac
)

148 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

149 
ac
->
”r
 = 
c
->err;

150 
ac
->
”r¡r
 = 
c
->errstr;

151 
	}
}

153 
»disAsyncCÚ‹xt
 *
	$»disAsyncCÚÃù
(cÚ¡ *

, 
pÜt
) {

154 
»disCÚ‹xt
 *
c
;

155 
»disAsyncCÚ‹xt
 *
ac
;

157 
c
 = 
	`»disCÚÃùNÚBlock
(

,
pÜt
);

158 ià(
c
 =ğ
NULL
)

159  
NULL
;

161 
ac
 = 
	`»disAsyncIn™Ÿlize
(
c
);

162 ià(
ac
 =ğ
NULL
) {

163 
	`»disF»e
(
c
);

164  
NULL
;

167 
	`__»disAsyncCİyE¼Ü
(
ac
);

168  
ac
;

169 
	}
}

171 
»disAsyncCÚ‹xt
 *
	$»disAsyncCÚÃùBšd
(cÚ¡ *

, 
pÜt
,

172 cÚ¡ *
sourû_addr
) {

173 
»disCÚ‹xt
 *
c
 = 
	`»disCÚÃùBšdNÚBlock
(

,
pÜt
,
sourû_addr
);

174 
»disAsyncCÚ‹xt
 *
ac
 = 
	`»disAsyncIn™Ÿlize
(
c
);

175 
	`__»disAsyncCİyE¼Ü
(
ac
);

176  
ac
;

177 
	}
}

179 
»disAsyncCÚ‹xt
 *
	$»disAsyncCÚÃùBšdW™hReu£
(cÚ¡ *

, 
pÜt
,

180 cÚ¡ *
sourû_addr
) {

181 
»disCÚ‹xt
 *
c
 = 
	`»disCÚÃùBšdNÚBlockW™hReu£
(

,
pÜt
,
sourû_addr
);

182 
»disAsyncCÚ‹xt
 *
ac
 = 
	`»disAsyncIn™Ÿlize
(
c
);

183 
	`__»disAsyncCİyE¼Ü
(
ac
);

184  
ac
;

185 
	}
}

187 
»disAsyncCÚ‹xt
 *
	$»disAsyncCÚÃùUnix
(cÚ¡ *
·th
) {

188 
»disCÚ‹xt
 *
c
;

189 
»disAsyncCÚ‹xt
 *
ac
;

191 
c
 = 
	`»disCÚÃùUnixNÚBlock
(
·th
);

192 ià(
c
 =ğ
NULL
)

193  
NULL
;

195 
ac
 = 
	`»disAsyncIn™Ÿlize
(
c
);

196 ià(
ac
 =ğ
NULL
) {

197 
	`»disF»e
(
c
);

198  
NULL
;

201 
	`__»disAsyncCİyE¼Ü
(
ac
);

202  
ac
;

203 
	}
}

205 
	$»disAsyncS‘CÚÃùC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disCÚÃùC®lback
 *
â
) {

206 ià(
ac
->
ÚCÚÃù
 =ğ
NULL
) {

207 
ac
->
ÚCÚÃù
 = 
â
;

212 
	`_EL_ADD_WRITE
(
ac
);

213  
REDIS_OK
;

215  
REDIS_ERR
;

216 
	}
}

218 
	$»disAsyncS‘DiscÚÃùC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disDiscÚÃùC®lback
 *
â
) {

219 ià(
ac
->
ÚDiscÚÃù
 =ğ
NULL
) {

220 
ac
->
ÚDiscÚÃù
 = 
â
;

221  
REDIS_OK
;

223  
REDIS_ERR
;

224 
	}
}

227 
	$__»disPushC®lback
(
»disC®lbackLi¡
 *
li¡
, 
»disC®lback
 *
sourû
) {

228 
»disC®lback
 *
cb
;

231 
cb
 = 
	`m®loc
((*cb));

232 ià(
cb
 =ğ
NULL
)

233  
REDIS_ERR_OOM
;

235 ià(
sourû
 !ğ
NULL
) {

236 
	`memıy
(
cb
,
sourû
,(*cb));

237 
cb
->
Ãxt
 = 
NULL
;

241 ià(
li¡
->
h—d
 =ğ
NULL
)

242 
li¡
->
h—d
 = 
cb
;

243 ià(
li¡
->

 !ğ
NULL
)

244 
li¡
->

->
Ãxt
 = 
cb
;

245 
li¡
->

 = 
cb
;

246  
REDIS_OK
;

247 
	}
}

249 
	$__»disShiáC®lback
(
»disC®lbackLi¡
 *
li¡
, 
»disC®lback
 *
rg‘
) {

250 
»disC®lback
 *
cb
 = 
li¡
->
h—d
;

251 ià(
cb
 !ğ
NULL
) {

252 
li¡
->
h—d
 = 
cb
->
Ãxt
;

253 ià(
cb
 =ğ
li¡
->

)

254 
li¡
->

 = 
NULL
;

257 ià(
rg‘
 !ğ
NULL
)

258 
	`memıy
(
rg‘
,
cb
,(*cb));

259 
	`ä“
(
cb
);

260  
REDIS_OK
;

262  
REDIS_ERR
;

263 
	}
}

265 
	$__»disRunC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lback
 *
cb
, 
»disR•ly
 *
»¶y
) {

266 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

267 ià(
cb
->
â
 !ğ
NULL
) {

268 
c
->
æags
 |ğ
REDIS_IN_CALLBACK
;

269 
cb
->
	`â
(
ac
,
»¶y
,cb->
´ivd©a
);

270 
c
->
æags
 &ğ~
REDIS_IN_CALLBACK
;

272 
	}
}

275 
	$__»disAsyncF»e
(
»disAsyncCÚ‹xt
 *
ac
) {

276 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

277 
»disC®lback
 
cb
;

278 
diùI‹¿tÜ
 *
™
;

279 
diùEÁry
 *
de
;

282 
	`__»disShiáC®lback
(&
ac
->
»¶›s
,&
cb
è=ğ
REDIS_OK
)

283 
	`__»disRunC®lback
(
ac
,&
cb
,
NULL
);

286 
	`__»disShiáC®lback
(&
ac
->
sub
.
šv®id
,&
cb
è=ğ
REDIS_OK
)

287 
	`__»disRunC®lback
(
ac
,&
cb
,
NULL
);

290 
™
 = 
	`diùG‘I‹¿tÜ
(
ac
->
sub
.
chªÃls
);

291 (
de
 = 
	`diùNext
(
™
)è!ğ
NULL
)

292 
	`__»disRunC®lback
(
ac
,
	`diùG‘EÁryV®
(
de
),
NULL
);

293 
	`diùR–—£I‹¿tÜ
(
™
);

294 
	`diùR–—£
(
ac
->
sub
.
chªÃls
);

296 
™
 = 
	`diùG‘I‹¿tÜ
(
ac
->
sub
.
·‰”ns
);

297 (
de
 = 
	`diùNext
(
™
)è!ğ
NULL
)

298 
	`__»disRunC®lback
(
ac
,
	`diùG‘EÁryV®
(
de
),
NULL
);

299 
	`diùR–—£I‹¿tÜ
(
™
);

300 
	`diùR–—£
(
ac
->
sub
.
·‰”ns
);

303 
	`_EL_CLEANUP
(
ac
);

307 ià(
ac
->
ÚDiscÚÃù
 && (
c
->
æags
 & 
REDIS_CONNECTED
)) {

308 ià(
c
->
æags
 & 
REDIS_FREEING
) {

309 
ac
->
	`ÚDiscÚÃù
×c,
REDIS_OK
);

311 
ac
->
	`ÚDiscÚÃù
×c,×c->
”r
 =ğ0è? 
REDIS_OK
 : 
REDIS_ERR
);

316 
	`»disF»e
(
c
);

317 
	}
}

323 
	$»disAsyncF»e
(
»disAsyncCÚ‹xt
 *
ac
) {

324 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

325 
c
->
æags
 |ğ
REDIS_FREEING
;

326 ià(!(
c
->
æags
 & 
REDIS_IN_CALLBACK
))

327 
	`__»disAsyncF»e
(
ac
);

328 
	}
}

331 
	$__»disAsyncDiscÚÃù
(
»disAsyncCÚ‹xt
 *
ac
) {

332 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

335 
	`__»disAsyncCİyE¼Ü
(
ac
);

337 ià(
ac
->
”r
 == 0) {

339 
	`as£¹
(
	`__»disShiáC®lback
(&
ac
->
»¶›s
,
NULL
è=ğ
REDIS_ERR
);

343 
c
->
æags
 |ğ
REDIS_DISCONNECTING
;

348 
	`__»disAsyncF»e
(
ac
);

349 
	}
}

357 
	$»disAsyncDiscÚÃù
(
»disAsyncCÚ‹xt
 *
ac
) {

358 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

359 
c
->
æags
 |ğ
REDIS_DISCONNECTING
;

360 ià(!(
c
->
æags
 & 
REDIS_IN_CALLBACK
è&& 
ac
->
»¶›s
.
h—d
 =ğ
NULL
)

361 
	`__»disAsyncDiscÚÃù
(
ac
);

362 
	}
}

364 
	$__»disG‘SubsüibeC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disR•ly
 *
»¶y
, 
»disC®lback
 *
d¡cb
) {

365 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

366 
diù
 *
ÿÎbacks
;

367 
diùEÁry
 *
de
;

368 
pv¬ŸÁ
;

369 *
¡y³
;

370 
sds
 
¢ame
;

374 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ARRAY
) {

375 
	`as£¹
(
»¶y
->
–em’ts
 >= 2);

376 
	`as£¹
(
»¶y
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_STRING
);

377 
¡y³
 = 
»¶y
->
–em’t
[0]->
¡r
;

378 
pv¬ŸÁ
 = (
	`tŞow”
(
¡y³
[0]) == 'p') ? 1 : 0;

380 ià(
pv¬ŸÁ
)

381 
ÿÎbacks
 = 
ac
->
sub
.
·‰”ns
;

383 
ÿÎbacks
 = 
ac
->
sub
.
chªÃls
;

386 
	`as£¹
(
»¶y
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_STRING
);

387 
¢ame
 = 
	`sd¢ewËn
(
»¶y
->
–em’t
[1]->
¡r
,»¶y->–em’t[1]->
Ën
);

388 
de
 = 
	`diùFšd
(
ÿÎbacks
,
¢ame
);

389 ià(
de
 !ğ
NULL
) {

390 
	`memıy
(
d¡cb
,
	`diùG‘EÁryV®
(
de
),(*dstcb));

393 ià(
	`¡rÿ£cmp
(
¡y³
+
pv¬ŸÁ
,"unsubscribe") == 0) {

394 
	`diùD–‘e
(
ÿÎbacks
,
¢ame
);

398 
	`as£¹
(
»¶y
->
–em’t
[2]->
ty³
 =ğ
REDIS_REPLY_INTEGER
);

399 ià(
»¶y
->
–em’t
[2]->
š‹g”
 == 0)

400 
c
->
æags
 &ğ~
REDIS_SUBSCRIBED
;

403 
	`sdsä“
(
¢ame
);

406 
	`__»disShiáC®lback
(&
ac
->
sub
.
šv®id
,
d¡cb
);

408  
REDIS_OK
;

409 
	}
}

411 
	$»disProûssC®lbacks
(
»disAsyncCÚ‹xt
 *
ac
) {

412 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

413 
»disC®lback
 
cb
 = {
NULL
, NULL, NULL};

414 *
»¶y
 = 
NULL
;

415 
¡©us
;

417 (
¡©us
 = 
	`»disG‘R•ly
(
c
,&
»¶y
)è=ğ
REDIS_OK
) {

418 ià(
»¶y
 =ğ
NULL
) {

421 ià(
c
->
æags
 & 
REDIS_DISCONNECTING
 && 
	`sd¦’
(c->
obuf
) == 0

422 && 
ac
->
»¶›s
.
h—d
 =ğ
NULL
) {

423 
	`__»disAsyncDiscÚÃù
(
ac
);

428 if(
c
->
æags
 & 
REDIS_MONITORING
) {

429 
	`__»disPushC®lback
(&
ac
->
»¶›s
,&
cb
);

439 ià(
	`__»disShiáC®lback
(&
ac
->
»¶›s
,&
cb
è!ğ
REDIS_OK
) {

455 ià(((
»disR•ly
*)
»¶y
)->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

456 
c
->
”r
 = 
REDIS_ERR_OTHER
;

457 
	`¢´štf
(
c
->
”r¡r
,(c->”r¡r),"%s",((
»disR•ly
*)
»¶y
)->
¡r
);

458 
c
->
»ad”
->
â
->
	`ä“Objeù
(
»¶y
);

459 
	`__»disAsyncDiscÚÃù
(
ac
);

463 
	`as£¹
((
c
->
æags
 & 
REDIS_SUBSCRIBED
 || c->æag & 
REDIS_MONITORING
));

464 if(
c
->
æags
 & 
REDIS_SUBSCRIBED
)

465 
	`__»disG‘SubsüibeC®lback
(
ac
,
»¶y
,&
cb
);

468 ià(
cb
.
â
 !ğ
NULL
) {

469 
	`__»disRunC®lback
(
ac
,&
cb
,
»¶y
);

470 
c
->
»ad”
->
â
->
	`ä“Objeù
(
»¶y
);

473 ià(
c
->
æags
 & 
REDIS_FREEING
) {

474 
	`__»disAsyncF»e
(
ac
);

482 
c
->
»ad”
->
â
->
	`ä“Objeù
(
»¶y
);

487 ià(
¡©us
 !ğ
REDIS_OK
)

488 
	`__»disAsyncDiscÚÃù
(
ac
);

489 
	}
}

494 
	$__»disAsyncHªdËCÚÃù
(
»disAsyncCÚ‹xt
 *
ac
) {

495 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

497 ià(
	`»disCheckSock‘E¼Ü
(
c
è=ğ
REDIS_ERR
) {

499 ià(
”ºo
 =ğ
EINPROGRESS
)

500  
REDIS_OK
;

502 ià(
ac
->
ÚCÚÃù
èac->
	`ÚCÚÃù
×c,
REDIS_ERR
);

503 
	`__»disAsyncDiscÚÃù
(
ac
);

504  
REDIS_ERR
;

508 
c
->
æags
 |ğ
REDIS_CONNECTED
;

509 ià(
ac
->
ÚCÚÃù
èac->
	`ÚCÚÃù
×c,
REDIS_OK
);

510  
REDIS_OK
;

511 
	}
}

516 
	$»disAsyncHªdËR—d
(
»disAsyncCÚ‹xt
 *
ac
) {

517 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

519 ià(!(
c
->
æags
 & 
REDIS_CONNECTED
)) {

521 ià(
	`__»disAsyncHªdËCÚÃù
(
ac
è!ğ
REDIS_OK
)

524 ià(!(
c
->
æags
 & 
REDIS_CONNECTED
))

528 ià(
	`»disBufãrR—d
(
c
è=ğ
REDIS_ERR
) {

529 
	`__»disAsyncDiscÚÃù
(
ac
);

532 
	`_EL_ADD_READ
(
ac
);

533 
	`»disProûssC®lbacks
(
ac
);

535 
	}
}

537 
	$»disAsyncHªdËWr™e
(
»disAsyncCÚ‹xt
 *
ac
) {

538 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

539 
dÚe
 = 0;

541 ià(!(
c
->
æags
 & 
REDIS_CONNECTED
)) {

543 ià(
	`__»disAsyncHªdËCÚÃù
(
ac
è!ğ
REDIS_OK
)

546 ià(!(
c
->
æags
 & 
REDIS_CONNECTED
))

550 ià(
	`»disBufãrWr™e
(
c
,&
dÚe
è=ğ
REDIS_ERR
) {

551 
	`__»disAsyncDiscÚÃù
(
ac
);

554 ià(!
dÚe
)

555 
	`_EL_ADD_WRITE
(
ac
);

557 
	`_EL_DEL_WRITE
(
ac
);

560 
	`_EL_ADD_READ
(
ac
);

562 
	}
}

566 cÚ¡ *
	$ÃxtArgum’t
(cÚ¡ *
¡¬t
, cÚ¡ **
¡r
, 
size_t
 *
Ën
) {

567 cÚ¡ *
p
 = 
¡¬t
;

568 ià(
p
[0] != '$') {

569 
p
 = 
	`¡rchr
(p,'$');

570 ià(
p
 =ğ
NULL
)  NULL;

573 *
Ën
 = ()
	`¡¹Ş
(
p
+1,
NULL
,10);

574 
p
 = 
	`¡rchr
(p,'\r');

575 
	`as£¹
(
p
);

576 *
¡r
 = 
p
+2;

577  
p
+2+(*
Ën
)+2;

578 
	}
}

583 
	$__»disAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
cmd
, 
size_t
 
Ën
) {

584 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

585 
»disC®lback
 
cb
;

586 
pv¬ŸÁ
, 
ha¢ext
;

587 cÚ¡ *
c¡r
, *
a¡r
;

588 
size_t
 
ş’
, 
®’
;

589 cÚ¡ *
p
;

590 
sds
 
¢ame
;

591 
»t
;

594 ià(
c
->
æags
 & (
REDIS_DISCONNECTING
 | 
REDIS_FREEING
)è 
REDIS_ERR
;

597 
cb
.
â
 = fn;

598 
cb
.
´ivd©a
 =…rivdata;

601 
p
 = 
	`ÃxtArgum’t
(
cmd
,&
c¡r
,&
ş’
);

602 
	`as£¹
(
p
 !ğ
NULL
);

603 
ha¢ext
 = (
p
[0] == '$');

604 
pv¬ŸÁ
 = (
	`tŞow”
(
c¡r
[0]) == 'p') ? 1 : 0;

605 
c¡r
 +ğ
pv¬ŸÁ
;

606 
ş’
 -ğ
pv¬ŸÁ
;

608 ià(
ha¢ext
 && 
	`¡ºÿ£cmp
(
c¡r
,"subscribe\r\n",11) == 0) {

609 
c
->
æags
 |ğ
REDIS_SUBSCRIBED
;

612 (
p
 = 
	`ÃxtArgum’t
Õ,&
a¡r
,&
®’
)è!ğ
NULL
) {

613 
¢ame
 = 
	`sd¢ewËn
(
a¡r
,
®’
);

614 ià(
pv¬ŸÁ
)

615 
»t
 = 
	`diùR•Ïû
(
ac
->
sub
.
·‰”ns
,
¢ame
,&
cb
);

617 
»t
 = 
	`diùR•Ïû
(
ac
->
sub
.
chªÃls
,
¢ame
,&
cb
);

619 ià(
»t
 =ğ0è
	`sdsä“
(
¢ame
);

621 } ià(
	`¡ºÿ£cmp
(
c¡r
,"unsubscribe\r\n",13) == 0) {

624 ià(!(
c
->
æags
 & 
REDIS_SUBSCRIBED
)è 
REDIS_ERR
;

629 } if(
	`¡ºÿ£cmp
(
c¡r
,"monitor\r\n",9) == 0) {

631 
c
->
æags
 |ğ
REDIS_MONITORING
;

632 
	`__»disPushC®lback
(&
ac
->
»¶›s
,&
cb
);

634 ià(
c
->
æags
 & 
REDIS_SUBSCRIBED
)

637 
	`__»disPushC®lback
(&
ac
->
sub
.
šv®id
,&
cb
);

639 
	`__»disPushC®lback
(&
ac
->
»¶›s
,&
cb
);

642 
	`__»disAµ’dCommªd
(
c
,
cmd
,
Ën
);

645 
	`_EL_ADD_WRITE
(
ac
);

647  
REDIS_OK
;

648 
	}
}

650 
	$»disvAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
) {

651 *
cmd
;

652 
Ën
;

653 
¡©us
;

654 
Ën
 = 
	`»disvFÜm©Commªd
(&
cmd
,
fÜm©
,
­
);

657 ià(
Ën
 < 0)

658  
REDIS_ERR
;

660 
¡©us
 = 
	`__»disAsyncCommªd
(
ac
,
â
,
´ivd©a
,
cmd
,
Ën
);

661 
	`ä“
(
cmd
);

662  
¡©us
;

663 
	}
}

665 
	$»disAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
fÜm©
, ...) {

666 
va_li¡
 
­
;

667 
¡©us
;

668 
	`va_¡¬t
(
­
,
fÜm©
);

669 
¡©us
 = 
	`»disvAsyncCommªd
(
ac
,
â
,
´ivd©a
,
fÜm©
,
­
);

670 
	`va_’d
(
­
);

671  
¡©us
;

672 
	}
}

674 
	$»disAsyncCommªdArgv
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

675 
sds
 
cmd
;

676 
Ën
;

677 
¡©us
;

678 
Ën
 = 
	`»disFÜm©SdsCommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
¬gvËn
);

679 
¡©us
 = 
	`__»disAsyncCommªd
(
ac
,
â
,
´ivd©a
,
cmd
,
Ën
);

680 
	`sdsä“
(
cmd
);

681  
¡©us
;

682 
	}
}

684 
	$»disAsyncFÜm©‹dCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
cmd
, 
size_t
 
Ën
) {

685 
¡©us
 = 
	`__»disAsyncCommªd
(
ac
,
â
,
´ivd©a
,
cmd
,
Ën
);

686  
¡©us
;

687 
	}
}

	@dep/hiredis-0.13.3/async.h

32 #iâdeà
__HIREDIS_ASYNC_H


33 
	#__HIREDIS_ASYNC_H


	)

34 
	~"hœedis.h
"

36 #ifdeà
__ılu¥lus


40 
»disAsyncCÚ‹xt
;

41 
diù
;

44 (
»disC®lbackFn
)(
	t»disAsyncCÚ‹xt
*, *, *);

45 
	s»disC®lback
 {

46 
»disC®lback
 *
Ãxt
;

47 
»disC®lbackFn
 *
â
;

48 *
´ivd©a
;

49 } 
	t»disC®lback
;

52 
	s»disC®lbackLi¡
 {

53 
»disC®lback
 *
h—d
, *

;

54 } 
	t»disC®lbackLi¡
;

57 (
»disDiscÚÃùC®lback
)(cÚ¡ 
	t»disAsyncCÚ‹xt
*, 
	t¡©us
);

58 (
»disCÚÃùC®lback
)(cÚ¡ 
	t»disAsyncCÚ‹xt
*, 
	t¡©us
);

61 
	s»disAsyncCÚ‹xt
 {

63 
»disCÚ‹xt
 
c
;

66 
”r
;

67 *
”r¡r
;

70 *
d©a
;

74 *
d©a
;

78 (*
addR—d
)(*
´ivd©a
);

79 (*
d–R—d
)(*
´ivd©a
);

80 (*
addWr™e
)(*
´ivd©a
);

81 (*
d–Wr™e
)(*
´ivd©a
);

82 (*
ş—nup
)(*
´ivd©a
);

83 } 
ev
;

87 
»disDiscÚÃùC®lback
 *
ÚDiscÚÃù
;

90 
»disCÚÃùC®lback
 *
ÚCÚÃù
;

93 
»disC®lbackLi¡
 
»¶›s
;

97 
»disC®lbackLi¡
 
šv®id
;

98 
diù
 *
chªÃls
;

99 
diù
 *
·‰”ns
;

100 } 
sub
;

101 } 
	t»disAsyncCÚ‹xt
;

104 
»disAsyncCÚ‹xt
 *
»disAsyncCÚÃù
(cÚ¡ *

, 
pÜt
);

105 
»disAsyncCÚ‹xt
 *
»disAsyncCÚÃùBšd
(cÚ¡ *

, 
pÜt
, cÚ¡ *
sourû_addr
);

106 
»disAsyncCÚ‹xt
 *
»disAsyncCÚÃùBšdW™hReu£
(cÚ¡ *

, 
pÜt
,

107 cÚ¡ *
sourû_addr
);

108 
»disAsyncCÚ‹xt
 *
»disAsyncCÚÃùUnix
(cÚ¡ *
·th
);

109 
»disAsyncS‘CÚÃùC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disCÚÃùC®lback
 *
â
);

110 
»disAsyncS‘DiscÚÃùC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disDiscÚÃùC®lback
 *
â
);

111 
»disAsyncDiscÚÃù
(
»disAsyncCÚ‹xt
 *
ac
);

112 
»disAsyncF»e
(
»disAsyncCÚ‹xt
 *
ac
);

115 
»disAsyncHªdËR—d
(
»disAsyncCÚ‹xt
 *
ac
);

116 
»disAsyncHªdËWr™e
(
»disAsyncCÚ‹xt
 *
ac
);

120 
»disvAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

121 
»disAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
fÜm©
, ...);

122 
»disAsyncCommªdArgv
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

123 
»disAsyncFÜm©‹dCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
cmd
, 
size_t
 
Ën
);

125 #ifdeà
__ılu¥lus


	@dep/hiredis-0.13.3/dict.c

36 
	~"fmaüos.h
"

37 
	~<¡dlib.h
>

38 
	~<as£¹.h
>

39 
	~<lim™s.h
>

40 
	~"diù.h
"

44 
_diùEx·ndIfN“ded
(
diù
 *
ht
);

45 
_diùNextPow”
(
size
);

46 
_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
);

47 
_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

53 
	$diùG’HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
) {

54 
hash
 = 5381;

56 
Ën
--)

57 
hash
 = ((hash << 5è+ hashè+ (*
buf
++);

58  
hash
;

59 
	}
}

65 
	$_diùRe£t
(
diù
 *
ht
) {

66 
ht
->
bË
 = 
NULL
;

67 
ht
->
size
 = 0;

68 
ht
->
sizemask
 = 0;

69 
ht
->
u£d
 = 0;

70 
	}
}

73 
diù
 *
	$diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
) {

74 
diù
 *
ht
 = 
	`m®loc
((*ht));

75 
	`_diùIn™
(
ht
,
ty³
,
´ivD©aPŒ
);

76  
ht
;

77 
	}
}

80 
	$_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
) {

81 
	`_diùRe£t
(
ht
);

82 
ht
->
ty³
 =ype;

83 
ht
->
´ivd©a
 = 
´ivD©aPŒ
;

84  
DICT_OK
;

85 
	}
}

88 
	$diùEx·nd
(
diù
 *
ht
, 
size
) {

89 
diù
 
n
;

90 
»®size
 = 
	`_diùNextPow”
(
size
), 
i
;

94 ià(
ht
->
u£d
 > 
size
)

95  
DICT_ERR
;

97 
	`_diùIn™
(&
n
, 
ht
->
ty³
, ht->
´ivd©a
);

98 
n
.
size
 = 
»®size
;

99 
n
.
sizemask
 = 
»®size
-1;

100 
n
.
bË
 = 
	`ÿÎoc
(
»®size
,(
diùEÁry
*));

105 
n
.
u£d
 = 
ht
->used;

106 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

107 
diùEÁry
 *
he
, *
ÃxtHe
;

109 ià(
ht
->
bË
[
i
] =ğ
NULL
) ;

112 
he
 = 
ht
->
bË
[
i
];

113 
he
) {

114 
h
;

116 
ÃxtHe
 = 
he
->
Ãxt
;

118 
h
 = 
	`diùHashKey
(
ht
, 
he
->
key
è& 
n
.
sizemask
;

119 
he
->
Ãxt
 = 
n
.
bË
[
h
];

120 
n
.
bË
[
h
] = 
he
;

121 
ht
->
u£d
--;

123 
he
 = 
ÃxtHe
;

126 
	`as£¹
(
ht
->
u£d
 == 0);

127 
	`ä“
(
ht
->
bË
);

130 *
ht
 = 
n
;

131  
DICT_OK
;

132 
	}
}

135 
	$diùAdd
(
diù
 *
ht
, *
key
, *
v®
) {

136 
šdex
;

137 
diùEÁry
 *
’Œy
;

141 ià((
šdex
 = 
	`_diùKeyIndex
(
ht
, 
key
)) == -1)

142  
DICT_ERR
;

145 
’Œy
 = 
	`m®loc
((*entry));

146 
’Œy
->
Ãxt
 = 
ht
->
bË
[
šdex
];

147 
ht
->
bË
[
šdex
] = 
’Œy
;

150 
	`diùS‘HashKey
(
ht
, 
’Œy
, 
key
);

151 
	`diùS‘HashV®
(
ht
, 
’Œy
, 
v®
);

152 
ht
->
u£d
++;

153  
DICT_OK
;

154 
	}
}

160 
	$diùR•Ïû
(
diù
 *
ht
, *
key
, *
v®
) {

161 
diùEÁry
 *
’Œy
, 
aux’Œy
;

165 ià(
	`diùAdd
(
ht
, 
key
, 
v®
è=ğ
DICT_OK
)

168 
’Œy
 = 
	`diùFšd
(
ht
, 
key
);

175 
aux’Œy
 = *
’Œy
;

176 
	`diùS‘HashV®
(
ht
, 
’Œy
, 
v®
);

177 
	`diùF»eEÁryV®
(
ht
, &
aux’Œy
);

179 
	}
}

182 
	$diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
) {

183 
h
;

184 
diùEÁry
 *
de
, *
´evde
;

186 ià(
ht
->
size
 == 0)

187  
DICT_ERR
;

188 
h
 = 
	`diùHashKey
(
ht
, 
key
è& ht->
sizemask
;

189 
de
 = 
ht
->
bË
[
h
];

191 
´evde
 = 
NULL
;

192 
de
) {

193 ià(
	`diùCom·»HashKeys
(
ht
,
key
,
de
->key)) {

195 ià(
´evde
)

196 
´evde
->
Ãxt
 = 
de
->next;

198 
ht
->
bË
[
h
] = 
de
->
Ãxt
;

200 
	`diùF»eEÁryKey
(
ht
,
de
);

201 
	`diùF»eEÁryV®
(
ht
,
de
);

202 
	`ä“
(
de
);

203 
ht
->
u£d
--;

204  
DICT_OK
;

206 
´evde
 = 
de
;

207 
de
 = de->
Ãxt
;

209  
DICT_ERR
;

210 
	}
}

213 
	$_diùCË¬
(
diù
 *
ht
) {

214 
i
;

217 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

218 
diùEÁry
 *
he
, *
ÃxtHe
;

220 ià((
he
 = 
ht
->
bË
[
i
]è=ğ
NULL
) ;

221 
he
) {

222 
ÃxtHe
 = 
he
->
Ãxt
;

223 
	`diùF»eEÁryKey
(
ht
, 
he
);

224 
	`diùF»eEÁryV®
(
ht
, 
he
);

225 
	`ä“
(
he
);

226 
ht
->
u£d
--;

227 
he
 = 
ÃxtHe
;

231 
	`ä“
(
ht
->
bË
);

233 
	`_diùRe£t
(
ht
);

234  
DICT_OK
;

235 
	}
}

238 
	$diùR–—£
(
diù
 *
ht
) {

239 
	`_diùCË¬
(
ht
);

240 
	`ä“
(
ht
);

241 
	}
}

243 
diùEÁry
 *
	$diùFšd
(
diù
 *
ht
, cÚ¡ *
key
) {

244 
diùEÁry
 *
he
;

245 
h
;

247 ià(
ht
->
size
 =ğ0è 
NULL
;

248 
h
 = 
	`diùHashKey
(
ht
, 
key
è& ht->
sizemask
;

249 
he
 = 
ht
->
bË
[
h
];

250 
he
) {

251 ià(
	`diùCom·»HashKeys
(
ht
, 
key
, 
he
->key))

252  
he
;

253 
he
 = he->
Ãxt
;

255  
NULL
;

256 
	}
}

258 
diùI‹¿tÜ
 *
	$diùG‘I‹¿tÜ
(
diù
 *
ht
) {

259 
diùI‹¿tÜ
 *
™”
 = 
	`m®loc
((*iter));

261 
™”
->
ht
 = ht;

262 
™”
->
šdex
 = -1;

263 
™”
->
’Œy
 = 
NULL
;

264 
™”
->
ÃxtEÁry
 = 
NULL
;

265  
™”
;

266 
	}
}

268 
diùEÁry
 *
	$diùNext
(
diùI‹¿tÜ
 *
™”
) {

270 ià(
™”
->
’Œy
 =ğ
NULL
) {

271 
™”
->
šdex
++;

272 ià(
™”
->
šdex
 >=

273 (sigÃd)
™”
->
ht
->
size
) ;

274 
™”
->
’Œy
 = i‹r->
ht
->
bË
[™”->
šdex
];

276 
™”
->
’Œy
 = i‹r->
ÃxtEÁry
;

278 ià(
™”
->
’Œy
) {

281 
™”
->
ÃxtEÁry
 = i‹r->
’Œy
->
Ãxt
;

282  
™”
->
’Œy
;

285  
NULL
;

286 
	}
}

288 
	$diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
) {

289 
	`ä“
(
™”
);

290 
	}
}

295 
	$_diùEx·ndIfN“ded
(
diù
 *
ht
) {

298 ià(
ht
->
size
 == 0)

299  
	`diùEx·nd
(
ht
, 
DICT_HT_INITIAL_SIZE
);

300 ià(
ht
->
u£d
 =ğht->
size
)

301  
	`diùEx·nd
(
ht
, ht->
size
*2);

302  
DICT_OK
;

303 
	}
}

306 
	$_diùNextPow”
(
size
) {

307 
i
 = 
DICT_HT_INITIAL_SIZE
;

309 ià(
size
 >ğ
LONG_MAX
)  LONG_MAX;

311 ià(
i
 >ğ
size
)

312  
i
;

313 
i
 *= 2;

315 
	}
}

320 
	$_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
) {

321 
h
;

322 
diùEÁry
 *
he
;

325 ià(
	`_diùEx·ndIfN“ded
(
ht
è=ğ
DICT_ERR
)

328 
h
 = 
	`diùHashKey
(
ht
, 
key
è& ht->
sizemask
;

330 
he
 = 
ht
->
bË
[
h
];

331 
he
) {

332 ià(
	`diùCom·»HashKeys
(
ht
, 
key
, 
he
->key))

334 
he
 = he->
Ãxt
;

336  
h
;

337 
	}
}

	@dep/hiredis-0.13.3/dict.h

36 #iâdeà
__DICT_H


37 
	#__DICT_H


	)

39 
	#DICT_OK
 0

	)

40 
	#DICT_ERR
 1

	)

43 
	#DICT_NOTUSED
(
V
è((èV)

	)

45 
	sdiùEÁry
 {

46 *
	mkey
;

47 *
	mv®
;

48 
diùEÁry
 *
	mÃxt
;

49 } 
	tdiùEÁry
;

51 
	sdiùTy³
 {

52 (*
	mhashFunùiÚ
)(cÚ¡ *
	mkey
);

53 *(*
	mkeyDup
)(*
	m´ivd©a
, cÚ¡ *
	mkey
);

54 *(*
	mv®Dup
)(*
	m´ivd©a
, cÚ¡ *
	mobj
);

55 (*
	mkeyCom·»
)(*
	m´ivd©a
, cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

56 (*
	mkeyDe¡ruùÜ
)(*
	m´ivd©a
, *
	mkey
);

57 (*
	mv®De¡ruùÜ
)(*
	m´ivd©a
, *
	mobj
);

58 } 
	tdiùTy³
;

60 
	sdiù
 {

61 
diùEÁry
 **
	mbË
;

62 
diùTy³
 *
	mty³
;

63 
	msize
;

64 
	msizemask
;

65 
	mu£d
;

66 *
	m´ivd©a
;

67 } 
	tdiù
;

69 
	sdiùI‹¿tÜ
 {

70 
diù
 *
	mht
;

71 
	mšdex
;

72 
diùEÁry
 *
	m’Œy
, *
	mÃxtEÁry
;

73 } 
	tdiùI‹¿tÜ
;

76 
	#DICT_HT_INITIAL_SIZE
 4

	)

79 
	#diùF»eEÁryV®
(
ht
, 
’Œy
) \

80 ià((
ht
)->
ty³
->
v®De¡ruùÜ
) \

81 (
ht
)->
ty³
->
	`v®De¡ruùÜ
((ht)->
´ivd©a
, (
’Œy
)->
v®
)

	)

83 
	#diùS‘HashV®
(
ht
, 
’Œy
, 
_v®_
) do { \

84 ià((
ht
)->
ty³
->
v®Dup
) \

85 
’Œy
->
v®
 = (
ht
)->
ty³
->
	`v®Dup
((ht)->
´ivd©a
, 
_v®_
); \

87 
’Œy
->
v®
 = (
_v®_
); \

88 } 0)

	)

90 
	#diùF»eEÁryKey
(
ht
, 
’Œy
) \

91 ià((
ht
)->
ty³
->
keyDe¡ruùÜ
) \

92 (
ht
)->
ty³
->
	`keyDe¡ruùÜ
((ht)->
´ivd©a
, (
’Œy
)->
key
)

	)

94 
	#diùS‘HashKey
(
ht
, 
’Œy
, 
_key_
) do { \

95 ià((
ht
)->
ty³
->
keyDup
) \

96 
’Œy
->
key
 = (
ht
)->
ty³
->
	`keyDup
((ht)->
´ivd©a
, 
_key_
); \

98 
’Œy
->
key
 = (
_key_
); \

99 } 0)

	)

101 
	#diùCom·»HashKeys
(
ht
, 
key1
, 
key2
) \

102 (((
ht
)->
ty³
->
keyCom·»
) ? \

103 (
ht
)->
ty³
->
	`keyCom·»
((ht)->
´ivd©a
, 
key1
, 
key2
) : \

104 (
key1
è=ğ(
key2
))

	)

106 
	#diùHashKey
(
ht
, 
key
è(ht)->
ty³
->
	`hashFunùiÚ
(key)

	)

108 
	#diùG‘EÁryKey
(
he
è((he)->
key
)

	)

109 
	#diùG‘EÁryV®
(
he
è((he)->
v®
)

	)

110 
	#diùSlÙs
(
ht
è((ht)->
size
)

	)

111 
	#diùSize
(
ht
è((ht)->
u£d
)

	)

114 
diùG’HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
);

115 
diù
 *
diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

116 
diùEx·nd
(
diù
 *
ht
, 
size
);

117 
diùAdd
(
diù
 *
ht
, *
key
, *
v®
);

118 
diùR•Ïû
(
diù
 *
ht
, *
key
, *
v®
);

119 
diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
);

120 
diùR–—£
(
diù
 *
ht
);

121 
diùEÁry
 * 
diùFšd
(
diù
 *
ht
, cÚ¡ *
key
);

122 
diùI‹¿tÜ
 *
diùG‘I‹¿tÜ
(
diù
 *
ht
);

123 
diùEÁry
 *
diùNext
(
diùI‹¿tÜ
 *
™”
);

124 
diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
);

	@dep/hiredis-0.13.3/examples/example-ae.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/«.h
>

11 
«Ev’tLoİ
 *
	gloİ
;

13 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

14 
»disR•ly
 *
»¶y
 = 
r
;

15 ià(
»¶y
 =ğ
NULL
) ;

16 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

19 
	`»disAsyncDiscÚÃù
(
c
);

20 
	}
}

22 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

23 ià(
¡©us
 !ğ
REDIS_OK
) {

24 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

25 
	`«Stİ
(
loİ
);

29 
	`´štf
("Connected...\n");

30 
	}
}

32 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

33 ià(
¡©us
 !ğ
REDIS_OK
) {

34 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

35 
	`«Stİ
(
loİ
);

39 
	`´štf
("Disconnected...\n");

40 
	`«Stİ
(
loİ
);

41 
	}
}

43 
	$maš
 (
¬gc
, **
¬gv
) {

44 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

46 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

47 ià(
c
->
”r
) {

49 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

53 
loİ
 = 
	`«C»©eEv’tLoİ
(64);

54 
	`»disAeA‰ach
(
loİ
, 
c
);

55 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

56 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

57 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

58 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

59 
	`«Maš
(
loİ
);

61 
	}
}

	@dep/hiredis-0.13.3/examples/example-glib.c

1 
	~<¡dlib.h
>

3 
	~<hœedis.h
>

4 
	~<async.h
>

5 
	~<ad­‹rs/glib.h
>

7 
GMašLoİ
 *
	gmašloİ
;

10 
	$cÚÃù_cb
 (cÚ¡ 
»disAsyncCÚ‹xt
 *
ac
 
G_GNUC_UNUSED
,

11 
¡©us
)

13 ià(
¡©us
 !ğ
REDIS_OK
) {

14 
	`g_´š‹¼
("FaedØcÚÃù: %s\n", 
ac
->
”r¡r
);

15 
	`g_maš_loİ_qu™
(
mašloİ
);

17 
	`g_´š‹¼
("Connected...\n");

19 
	}
}

22 
	$discÚÃù_cb
 (cÚ¡ 
»disAsyncCÚ‹xt
 *
ac
 
G_GNUC_UNUSED
,

23 
¡©us
)

25 ià(
¡©us
 !ğ
REDIS_OK
) {

26 
	`g_”rÜ
("FaedØdiscÚÃù: %s", 
ac
->
”r¡r
);

28 
	`g_´š‹¼
("Disconnected...\n");

29 
	`g_maš_loİ_qu™
(
mašloİ
);

31 
	}
}

34 
	$commªd_cb
(
»disAsyncCÚ‹xt
 *
ac
,

35 
gpoš‹r
 
r
,

36 
gpoš‹r
 
u£r_d©a
 
G_GNUC_UNUSED
)

38 
»disR•ly
 *
»¶y
 = 
r
;

40 ià(
»¶y
) {

41 
	`g_´št
("REPLY: %s\n", 
»¶y
->
¡r
);

44 
	`»disAsyncDiscÚÃù
(
ac
);

45 
	}
}

47 
gšt


48 
	$maš
 (
gšt
 
¬gc
 
G_GNUC_UNUSED
,

49 
gch¬
 *
¬gv
[] 
G_GNUC_UNUSED
)

51 
»disAsyncCÚ‹xt
 *
ac
;

52 
GMašCÚ‹xt
 *
cÚ‹xt
 = 
NULL
;

53 
GSourû
 *
sourû
;

55 
ac
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

56 ià(
ac
->
”r
) {

57 
	`g_´š‹¼
("%s\n", 
ac
->
”r¡r
);

58 
	`ex™
(
EXIT_FAILURE
);

61 
sourû
 = 
	`»dis_sourû_Ãw
(
ac
);

62 
mašloİ
 = 
	`g_maš_loİ_Ãw
(
cÚ‹xt
, 
FALSE
);

63 
	`g_sourû_©ch
(
sourû
, 
cÚ‹xt
);

65 
	`»disAsyncS‘CÚÃùC®lback
(
ac
, 
cÚÃù_cb
);

66 
	`»disAsyncS‘DiscÚÃùC®lback
(
ac
, 
discÚÃù_cb
);

67 
	`»disAsyncCommªd
(
ac
, 
commªd_cb
, 
NULL
, "SET key 1234");

68 
	`»disAsyncCommªd
(
ac
, 
commªd_cb
, 
NULL
, "GET key");

70 
	`g_maš_loİ_run
(
mašloİ
);

72  
EXIT_SUCCESS
;

73 
	}
}

	@dep/hiredis-0.13.3/examples/example-ivykis.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/ivykis.h
>

10 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

11 
»disR•ly
 *
»¶y
 = 
r
;

12 ià(
»¶y
 =ğ
NULL
) ;

13 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

16 
	`»disAsyncDiscÚÃù
(
c
);

17 
	}
}

19 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

20 ià(
¡©us
 !ğ
REDIS_OK
) {

21 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

24 
	`´štf
("Connected...\n");

25 
	}
}

27 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

28 ià(
¡©us
 !ğ
REDIS_OK
) {

29 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

32 
	`´štf
("Disconnected...\n");

33 
	}
}

35 
	$maš
 (
¬gc
, **
¬gv
) {

36 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

38 
	`iv_š™
();

40 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

41 ià(
c
->
”r
) {

43 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

47 
	`»disIvykisA‰ach
(
c
);

48 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

49 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

50 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

51 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

53 
	`iv_maš
();

55 
	`iv_deš™
();

58 
	}
}

	@dep/hiredis-0.13.3/examples/example-libev.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/libev.h
>

10 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

11 
»disR•ly
 *
»¶y
 = 
r
;

12 ià(
»¶y
 =ğ
NULL
) ;

13 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

16 
	`»disAsyncDiscÚÃù
(
c
);

17 
	}
}

19 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

20 ià(
¡©us
 !ğ
REDIS_OK
) {

21 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

24 
	`´štf
("Connected...\n");

25 
	}
}

27 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

28 ià(
¡©us
 !ğ
REDIS_OK
) {

29 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

32 
	`´štf
("Disconnected...\n");

33 
	}
}

35 
	$maš
 (
¬gc
, **
¬gv
) {

36 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

38 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

39 ià(
c
->
”r
) {

41 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

45 
	`»disLibevA‰ach
(
EV_DEFAULT_
 
c
);

46 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

47 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

48 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

49 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

50 
	`ev_loİ
(
EV_DEFAULT_
 0);

52 
	}
}

	@dep/hiredis-0.13.3/examples/example-libevent.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/libev’t.h
>

10 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

11 
»disR•ly
 *
»¶y
 = 
r
;

12 ià(
»¶y
 =ğ
NULL
) ;

13 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

16 
	`»disAsyncDiscÚÃù
(
c
);

17 
	}
}

19 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

20 ià(
¡©us
 !ğ
REDIS_OK
) {

21 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

24 
	`´štf
("Connected...\n");

25 
	}
}

27 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

28 ià(
¡©us
 !ğ
REDIS_OK
) {

29 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

32 
	`´štf
("Disconnected...\n");

33 
	}
}

35 
	$maš
 (
¬gc
, **
¬gv
) {

36 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

37 
ev’t_ba£
 *
ba£
 = 
	`ev’t_ba£_Ãw
();

39 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

40 ià(
c
->
”r
) {

42 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

46 
	`»disLibev’tA‰ach
(
c
,
ba£
);

47 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

48 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

49 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

50 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

51 
	`ev’t_ba£_di¥©ch
(
ba£
);

53 
	}
}

	@dep/hiredis-0.13.3/examples/example-libuv.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/libuv.h
>

10 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

11 
»disR•ly
 *
»¶y
 = 
r
;

12 ià(
»¶y
 =ğ
NULL
) ;

13 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

16 
	`»disAsyncDiscÚÃù
(
c
);

17 
	}
}

19 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

20 ià(
¡©us
 !ğ
REDIS_OK
) {

21 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

24 
	`´štf
("Connected...\n");

25 
	}
}

27 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

28 ià(
¡©us
 !ğ
REDIS_OK
) {

29 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

32 
	`´štf
("Disconnected...\n");

33 
	}
}

35 
	$maš
 (
¬gc
, **
¬gv
) {

36 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

37 
uv_loİ_t
* 
loİ
 = 
	`uv_deçuÉ_loİ
();

39 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

40 ià(
c
->
”r
) {

42 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

46 
	`»disLibuvA‰ach
(
c
,
loİ
);

47 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

48 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

49 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

50 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

51 
	`uv_run
(
loİ
, 
UV_RUN_DEFAULT
);

53 
	}
}

	@dep/hiredis-0.13.3/examples/example-macosx.c

6 
	~<¡dio.h
>

8 
	~<hœedis.h
>

9 
	~<async.h
>

10 
	~<ad­‹rs/macosx.h
>

12 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

13 
»disR•ly
 *
»¶y
 = 
r
;

14 ià(
»¶y
 =ğ
NULL
) ;

15 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

18 
	`»disAsyncDiscÚÃù
(
c
);

19 
	}
}

21 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

22 ià(
¡©us
 !ğ
REDIS_OK
) {

23 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

26 
	`´štf
("Connected...\n");

27 
	}
}

29 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

30 ià(
¡©us
 !ğ
REDIS_OK
) {

31 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

34 
	`CFRunLoİStİ
(
	`CFRunLoİG‘Cu¼’t
());

35 
	`´štf
("Disconnected...\n");

36 
	}
}

38 
	$maš
 (
¬gc
, **
¬gv
) {

39 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

41 
CFRunLoİRef
 
loİ
 = 
	`CFRunLoİG‘Cu¼’t
();

42 ifĞ!
loİ
 ) {

43 
	`´štf
("Error: Cannot get current„un†oop\n");

47 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

48 ià(
c
->
”r
) {

50 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

54 
	`»disMacOSA‰ach
(
c
, 
loİ
);

56 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

57 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

59 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

60 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

62 
	`CFRunLoİRun
();

65 
	}
}

	@dep/hiredis-0.13.3/examples/example-qt.cpp

1 
	~<io¡»am
>

2 
usšg
 
Çme¥aû
 
	g¡d
;

4 
	~<QCÜeAµliÿtiÚ
>

5 
	~<QTim”
>

7 
	~"exam¶e-qt.h
"

9 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *, * 
r
, * 
´ivd©a
) {

11 
»disR•ly
 * 
»¶y
 = 
¡©ic_ÿ¡
<»disR•ly *>(
r
);

12 
Exam¶eQt
 * 
ex
 = 
¡©ic_ÿ¡
<Exam¶eQˆ*>(
´ivd©a
);

13 ià(
»¶y
 =ğ
nuÎ±r
 || 
ex
 ==‚ullptr) ;

15 
cout
 << "key: " << 
»¶y
->
¡r
 << 
’dl
;

17 
ex
->
	`fšish
();

18 
	}
}

20 
	gExam¶eQt
::
	$run
() {

22 
m_ùx
 = 
	`»disAsyncCÚÃù
("localhost", 6379);

24 ià(
m_ùx
->
”r
) {

25 
û¼
 << "E¼Ü: " << 
m_ùx
->
”r¡r
 << 
’dl
;

26 
	`»disAsyncF»e
(
m_ùx
);

27 
em™
 
	`fšished
();

30 
m_ad­‹r
.
	`£tCÚ‹xt
(
m_ùx
);

32 
	`»disAsyncCommªd
(
m_ùx
, 
NULL
, NULL, "SET key %s", 
m_v®ue
);

33 
	`»disAsyncCommªd
(
m_ùx
, 
g‘C®lback
, 
this
, "GET key");

34 
	}
}

36 
	$maš
 (
¬gc
, **
¬gv
) {

38 
QCÜeAµliÿtiÚ
 
	`­p
(
¬gc
, 
¬gv
);

40 
Exam¶eQt
 
	`exam¶e
(
¬gv
[
¬gc
-1]);

42 
QObjeù
::
	`cÚÃù
(&
exam¶e
, 
	`SIGNAL
(
	`fšished
()), &
­p
, 
	`SLOT
(
	`qu™
()));

43 
QTim”
::
	`sšgËShÙ
(0, &
exam¶e
, 
	`SLOT
(
	`run
()));

45  
­p
.
	`exec
();

46 
	}
}

	@dep/hiredis-0.13.3/examples/example-qt.h

1 #iâdeà
__HIREDIS_EXAMPLE_QT_H


2 
	#__HIREDIS_EXAMPLE_QT_H


	)

4 
	~<ad­‹rs/qt.h
>

6 şas 
	cExam¶eQt
 : 
public
 
QObjeù
 {

8 
Q_OBJECT


10 
public
:

11 
	$Exam¶eQt
(cÚ¡ * 
v®ue
, 
QObjeù
 * 
·»Á
 = 0)

12 : 
	`QObjeù
(
·»Á
), 
	$m_v®ue
(
v®ue
) {}

14 
sigÇls
:

15 
	`fšished
();

17 
public
 
¦Ùs
:

18 
	`run
();

20 
´iv©e
:

21 
	$fšish
(è{ 
em™
 
	`fšished
(); 
	}
}

23 
	g´iv©e
:

24 cÚ¡ * 
m_v®ue
;

25 
»disAsyncCÚ‹xt
 * 
	gm_ùx
;

26 
RedisQtAd­‹r
 
	gm_ad­‹r
;

28 
ä›nd


29 
g‘C®lback
(
»disAsyncCÚ‹xt
 *, *, *);

	@dep/hiredis-0.13.3/examples/example.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

5 
	~<hœedis.h
>

7 
	$maš
(
¬gc
, **
¬gv
) {

8 
j
;

9 
»disCÚ‹xt
 *
c
;

10 
»disR•ly
 *
»¶y
;

11 cÚ¡ *
ho¡Çme
 = (
¬gc
 > 1è? 
¬gv
[1] : "127.0.0.1";

12 
pÜt
 = (
¬gc
 > 2è? 
	`©oi
(
¬gv
[2]) : 6379;

14 
timev®
 
timeout
 = { 1, 500000 };

15 
c
 = 
	`»disCÚÃùW™hTimeout
(
ho¡Çme
, 
pÜt
, 
timeout
);

16 ià(
c
 =ğ
NULL
 || c->
”r
) {

17 ià(
c
) {

18 
	`´štf
("CÚÃùiÚƒ¼Ü: %s\n", 
c
->
”r¡r
);

19 
	`»disF»e
(
c
);

21 
	`´štf
("Connectionƒrror: can't‡llocate„edis context\n");

23 
	`ex™
(1);

27 
»¶y
 = 
	`»disCommªd
(
c
,"PING");

28 
	`´štf
("PING: %s\n", 
»¶y
->
¡r
);

29 
	`ä“R•lyObjeù
(
»¶y
);

32 
»¶y
 = 
	`»disCommªd
(
c
,"SET %s %s", "foo", "hello world");

33 
	`´štf
("SET: %s\n", 
»¶y
->
¡r
);

34 
	`ä“R•lyObjeù
(
»¶y
);

37 
»¶y
 = 
	`»disCommªd
(
c
,"SET %b %b", "b¬", (
size_t
) 3, "hello", (size_t) 5);

38 
	`´štf
("SET (bš¬y API): %s\n", 
»¶y
->
¡r
);

39 
	`ä“R•lyObjeù
(
»¶y
);

42 
»¶y
 = 
	`»disCommªd
(
c
,"GET foo");

43 
	`´štf
("GET foo: %s\n", 
»¶y
->
¡r
);

44 
	`ä“R•lyObjeù
(
»¶y
);

46 
»¶y
 = 
	`»disCommªd
(
c
,"INCR counter");

47 
	`´štf
("INCR couÁ”: %Îd\n", 
»¶y
->
š‹g”
);

48 
	`ä“R•lyObjeù
(
»¶y
);

50 
»¶y
 = 
	`»disCommªd
(
c
,"INCR counter");

51 
	`´štf
("INCR couÁ”: %Îd\n", 
»¶y
->
š‹g”
);

52 
	`ä“R•lyObjeù
(
»¶y
);

55 
»¶y
 = 
	`»disCommªd
(
c
,"DEL mylist");

56 
	`ä“R•lyObjeù
(
»¶y
);

57 
j
 = 0; j < 10; j++) {

58 
buf
[64];

60 
	`¢´štf
(
buf
,64,"%d",
j
);

61 
»¶y
 = 
	`»disCommªd
(
c
,"LPUSH myli¡ƒËm’t-%s", 
buf
);

62 
	`ä“R•lyObjeù
(
»¶y
);

66 
»¶y
 = 
	`»disCommªd
(
c
,"LRANGE mylist 0 -1");

67 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ARRAY
) {

68 
j
 = 0; j < 
»¶y
->
–em’ts
; j++) {

69 
	`´štf
("%uè%s\n", 
j
, 
»¶y
->
–em’t
[j]->
¡r
);

72 
	`ä“R•lyObjeù
(
»¶y
);

75 
	`»disF»e
(
c
);

78 
	}
}

	@dep/hiredis-0.13.3/fmacros.h

1 #iâdeà
__HIREDIS_FMACRO_H


2 
	#__HIREDIS_FMACRO_H


	)

4 #ià
defšed
(
__lšux__
)

5 
	#_BSD_SOURCE


	)

6 
	#_DEFAULT_SOURCE


	)

9 #ià
defšed
(
__sun__
)

10 
	#_POSIX_C_SOURCE
 200112L

	)

11 #–ià
defšed
(
__lšux__
è|| defšed(
__O³nBSD__
è|| defšed(
__N‘BSD__
)

12 
	#_XOPEN_SOURCE
 600

	)

14 
	#_XOPEN_SOURCE


	)

17 #ià
__APPLE__
 && 
__MACH__


18 
	#_OSX


	)

	@dep/hiredis-0.13.3/hiredis.c

34 
	~"fmaüos.h
"

35 
	~<¡ršg.h
>

36 
	~<¡dlib.h
>

37 
	~<uni¡d.h
>

38 
	~<as£¹.h
>

39 
	~<”ºo.h
>

40 
	~<ùy³.h
>

42 
	~"hœedis.h
"

43 
	~"Ãt.h
"

44 
	~"sds.h
"

46 
»disR•ly
 *
ü—‹R•lyObjeù
(
ty³
);

47 *
ü—‹SŒšgObjeù
(cÚ¡ 
»disR—dTask
 *
sk
, *
¡r
, 
size_t
 
Ën
);

48 *
ü—‹A¼ayObjeù
(cÚ¡ 
»disR—dTask
 *
sk
, 
–em’ts
);

49 *
ü—‹IÁeg”Objeù
(cÚ¡ 
»disR—dTask
 *
sk
, 
v®ue
);

50 *
ü—‹NObjeù
(cÚ¡ 
»disR—dTask
 *
sk
);

54 
»disR•lyObjeùFunùiÚs
 
	gdeçuÉFunùiÚs
 = {

55 
ü—‹SŒšgObjeù
,

56 
ü—‹A¼ayObjeù
,

57 
ü—‹IÁeg”Objeù
,

58 
ü—‹NObjeù
,

59 
ä“R•lyObjeù


63 
»disR•ly
 *
	$ü—‹R•lyObjeù
(
ty³
) {

64 
»disR•ly
 *
r
 = 
	`ÿÎoc
(1,(*r));

66 ià(
r
 =ğ
NULL
)

67  
NULL
;

69 
r
->
ty³
 =ype;

70  
r
;

71 
	}
}

74 
	$ä“R•lyObjeù
(*
»¶y
) {

75 
»disR•ly
 *
r
 = 
»¶y
;

76 
size_t
 
j
;

78 ià(
r
 =ğ
NULL
)

81 
r
->
ty³
) {

82 
REDIS_REPLY_INTEGER
:

84 
REDIS_REPLY_ARRAY
:

85 ià(
r
->
–em’t
 !ğ
NULL
) {

86 
j
 = 0; j < 
r
->
–em’ts
; j++)

87 ià(
r
->
–em’t
[
j
] !ğ
NULL
)

88 
	`ä“R•lyObjeù
(
r
->
–em’t
[
j
]);

89 
	`ä“
(
r
->
–em’t
);

92 
REDIS_REPLY_ERROR
:

93 
REDIS_REPLY_STATUS
:

94 
REDIS_REPLY_STRING
:

95 ià(
r
->
¡r
 !ğ
NULL
)

96 
	`ä“
(
r
->
¡r
);

99 
	`ä“
(
r
);

100 
	}
}

102 *
	$ü—‹SŒšgObjeù
(cÚ¡ 
»disR—dTask
 *
sk
, *
¡r
, 
size_t
 
Ën
) {

103 
»disR•ly
 *
r
, *
·»Á
;

104 *
buf
;

106 
r
 = 
	`ü—‹R•lyObjeù
(
sk
->
ty³
);

107 ià(
r
 =ğ
NULL
)

108  
NULL
;

110 
buf
 = 
	`m®loc
(
Ën
+1);

111 ià(
buf
 =ğ
NULL
) {

112 
	`ä“R•lyObjeù
(
r
);

113  
NULL
;

116 
	`as£¹
(
sk
->
ty³
 =ğ
REDIS_REPLY_ERROR
 ||

117 
sk
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

118 
sk
->
ty³
 =ğ
REDIS_REPLY_STRING
);

121 
	`memıy
(
buf
,
¡r
,
Ën
);

122 
buf
[
Ën
] = '\0';

123 
r
->
¡r
 = 
buf
;

124 
r
->
Ën
 =†en;

126 ià(
sk
->
·»Á
) {

127 
·»Á
 = 
sk
->·»Á->
obj
;

128 
	`as£¹
(
·»Á
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

129 
·»Á
->
–em’t
[
sk
->
idx
] = 
r
;

131  
r
;

132 
	}
}

134 *
	$ü—‹A¼ayObjeù
(cÚ¡ 
»disR—dTask
 *
sk
, 
–em’ts
) {

135 
»disR•ly
 *
r
, *
·»Á
;

137 
r
 = 
	`ü—‹R•lyObjeù
(
REDIS_REPLY_ARRAY
);

138 ià(
r
 =ğ
NULL
)

139  
NULL
;

141 ià(
–em’ts
 > 0) {

142 
r
->
–em’t
 = 
	`ÿÎoc
(
–em’ts
,(
»disR•ly
*));

143 ià(
r
->
–em’t
 =ğ
NULL
) {

144 
	`ä“R•lyObjeù
(
r
);

145  
NULL
;

149 
r
->
–em’ts
 =ƒlements;

151 ià(
sk
->
·»Á
) {

152 
·»Á
 = 
sk
->·»Á->
obj
;

153 
	`as£¹
(
·»Á
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

154 
·»Á
->
–em’t
[
sk
->
idx
] = 
r
;

156  
r
;

157 
	}
}

159 *
	$ü—‹IÁeg”Objeù
(cÚ¡ 
»disR—dTask
 *
sk
, 
v®ue
) {

160 
»disR•ly
 *
r
, *
·»Á
;

162 
r
 = 
	`ü—‹R•lyObjeù
(
REDIS_REPLY_INTEGER
);

163 ià(
r
 =ğ
NULL
)

164  
NULL
;

166 
r
->
š‹g”
 = 
v®ue
;

168 ià(
sk
->
·»Á
) {

169 
·»Á
 = 
sk
->·»Á->
obj
;

170 
	`as£¹
(
·»Á
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

171 
·»Á
->
–em’t
[
sk
->
idx
] = 
r
;

173  
r
;

174 
	}
}

176 *
	$ü—‹NObjeù
(cÚ¡ 
»disR—dTask
 *
sk
) {

177 
»disR•ly
 *
r
, *
·»Á
;

179 
r
 = 
	`ü—‹R•lyObjeù
(
REDIS_REPLY_NIL
);

180 ià(
r
 =ğ
NULL
)

181  
NULL
;

183 ià(
sk
->
·»Á
) {

184 
·»Á
 = 
sk
->·»Á->
obj
;

185 
	`as£¹
(
·»Á
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

186 
·»Á
->
–em’t
[
sk
->
idx
] = 
r
;

188  
r
;

189 
	}
}

193 
ušt32_t
 
	$couÁDig™s
(
ušt64_t
 
v
) {

194 
ušt32_t
 
»suÉ
 = 1;

196 ià(
v
 < 10è 
»suÉ
;

197 ià(
v
 < 100è 
»suÉ
 + 1;

198 ià(
v
 < 1000è 
»suÉ
 + 2;

199 ià(
v
 < 10000è 
»suÉ
 + 3;

200 
v
 /= 10000U;

201 
»suÉ
 += 4;

203 
	}
}

206 
size_t
 
	$bulkËn
(
size_t
 
Ën
) {

207  1+
	`couÁDig™s
(
Ën
)+2+len+2;

208 
	}
}

210 
	$»disvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
) {

211 cÚ¡ *
c
 = 
fÜm©
;

212 *
cmd
 = 
NULL
;

213 
pos
;

214 
sds
 
cu¿rg
, 
Ãw¬g
;

215 
touched
 = 0;

216 **
cu¿rgv
 = 
NULL
, **
Ãw¬gv
 = NULL;

217 
¬gc
 = 0;

218 
tÙËn
 = 0;

219 
”rÜ_ty³
 = 0;

220 
j
;

223 ià(
rg‘
 =ğ
NULL
)

227 
cu¿rg
 = 
	`sd£m±y
();

228 ià(
cu¿rg
 =ğ
NULL
)

231 *
c
 != '\0') {

232 ià(*
c
 != '%' || c[1] == '\0') {

233 ià(*
c
 == ' ') {

234 ià(
touched
) {

235 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

236 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

237 
cu¿rgv
 = 
Ãw¬gv
;

238 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

239 
tÙËn
 +ğ
	`bulkËn
(
	`sd¦’
(
cu¿rg
));

242 
cu¿rg
 = 
	`sd£m±y
();

243 ià(
cu¿rg
 =ğ
NULL
è
memÜy_”r
;

244 
touched
 = 0;

247 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
c
,1);

248 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

249 
cu¿rg
 = 
Ãw¬g
;

250 
touched
 = 1;

253 *
¬g
;

254 
size_t
 
size
;

257 
Ãw¬g
 = 
cu¿rg
;

259 
c
[1]) {

261 
¬g
 = 
	`va_¬g
(
­
,*);

262 
size
 = 
	`¡¾’
(
¬g
);

263 ià(
size
 > 0)

264 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

267 
¬g
 = 
	`va_¬g
(
­
,*);

268 
size
 = 
	`va_¬g
(
­
,
size_t
);

269 ià(
size
 > 0)

270 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

273 
Ãw¬g
 = 
	`sdsÿt
(
cu¿rg
,"%");

278 cÚ¡ 
štfmts
[] = "diouxX";

279 cÚ¡ 
æags
[] = "#0-+ ";

280 
_fÜm©
[16];

281 cÚ¡ *
_p
 = 
c
+1;

282 
size_t
 
_l
 = 0;

283 
va_li¡
 
_ıy
;

286 *
_p
 !ğ'\0' && 
	`¡rchr
(
æags
,*_pè!ğ
NULL
) _p++;

289 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

292 ià(*
_p
 == '.') {

293 
_p
++;

294 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

298 
	`va_cİy
(
_ıy
,
­
);

301 ià(
	`¡rchr
(
štfmts
,*
_p
è!ğ
NULL
) {

302 
	`va_¬g
(
­
,);

303 
fmt_v®id
;

307 ià(
	`¡rchr
("eEfFgGaA",*
_p
è!ğ
NULL
) {

308 
	`va_¬g
(
­
,);

309 
fmt_v®id
;

313 ià(
_p
[0] == 'h' && _p[1] == 'h') {

314 
_p
 += 2;

315 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

316 
	`va_¬g
(
­
,);

317 
fmt_v®id
;

319 
fmt_šv®id
;

323 ià(
_p
[0] == 'h') {

324 
_p
 += 1;

325 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

326 
	`va_¬g
(
­
,);

327 
fmt_v®id
;

329 
fmt_šv®id
;

333 ià(
_p
[0] == 'l' && _p[1] == 'l') {

334 
_p
 += 2;

335 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

336 
	`va_¬g
(
­
,);

337 
fmt_v®id
;

339 
fmt_šv®id
;

343 ià(
_p
[0] == 'l') {

344 
_p
 += 1;

345 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

346 
	`va_¬g
(
­
,);

347 
fmt_v®id
;

349 
fmt_šv®id
;

352 
fmt_šv®id
:

353 
	`va_’d
(
_ıy
);

354 
fÜm©_”r
;

356 
fmt_v®id
:

357 
_l
 = (
_p
+1)-
c
;

358 ià(
_l
 < (
_fÜm©
)-2) {

359 
	`memıy
(
_fÜm©
,
c
,
_l
);

360 
_fÜm©
[
_l
] = '\0';

361 
Ãw¬g
 = 
	`sdsÿtv´štf
(
cu¿rg
,
_fÜm©
,
_ıy
);

365 
c
 = 
_p
-1;

368 
	`va_’d
(
_ıy
);

373 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

374 
cu¿rg
 = 
Ãw¬g
;

376 
touched
 = 1;

377 
c
++;

379 
c
++;

383 ià(
touched
) {

384 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

385 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

386 
cu¿rgv
 = 
Ãw¬gv
;

387 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

388 
tÙËn
 +ğ
	`bulkËn
(
	`sd¦’
(
cu¿rg
));

390 
	`sdsä“
(
cu¿rg
);

394 
cu¿rg
 = 
NULL
;

397 
tÙËn
 +ğ1+
	`couÁDig™s
(
¬gc
)+2;

400 
cmd
 = 
	`m®loc
(
tÙËn
+1);

401 ià(
cmd
 =ğ
NULL
è
memÜy_”r
;

403 
pos
 = 
	`¥rštf
(
cmd
,"*%d\r\n",
¬gc
);

404 
j
 = 0; j < 
¬gc
; j++) {

405 
pos
 +ğ
	`¥rštf
(
cmd
+pos,"$%zu\r\n",
	`sd¦’
(
cu¿rgv
[
j
]));

406 
	`memıy
(
cmd
+
pos
,
cu¿rgv
[
j
],
	`sd¦’
(curargv[j]));

407 
pos
 +ğ
	`sd¦’
(
cu¿rgv
[
j
]);

408 
	`sdsä“
(
cu¿rgv
[
j
]);

409 
cmd
[
pos
++] = '\r';

410 
cmd
[
pos
++] = '\n';

412 
	`as£¹
(
pos
 =ğ
tÙËn
);

413 
cmd
[
pos
] = '\0';

415 
	`ä“
(
cu¿rgv
);

416 *
rg‘
 = 
cmd
;

417  
tÙËn
;

419 
fÜm©_”r
:

420 
”rÜ_ty³
 = -2;

421 
ş—nup
;

423 
memÜy_”r
:

424 
”rÜ_ty³
 = -1;

425 
ş—nup
;

427 
ş—nup
:

428 ià(
cu¿rgv
) {

429 
¬gc
--)

430 
	`sdsä“
(
cu¿rgv
[
¬gc
]);

431 
	`ä“
(
cu¿rgv
);

434 
	`sdsä“
(
cu¿rg
);

438 ià(
cmd
 !ğ
NULL
)

439 
	`ä“
(
cmd
);

441  
”rÜ_ty³
;

442 
	}
}

456 
	$»disFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...) {

457 
va_li¡
 
­
;

458 
Ën
;

459 
	`va_¡¬t
(
­
,
fÜm©
);

460 
Ën
 = 
	`»disvFÜm©Commªd
(
rg‘
,
fÜm©
,
­
);

461 
	`va_’d
(
­
);

465 ià(
Ën
 < 0)

466 
Ën
 = -1;

468  
Ën
;

469 
	}
}

477 
	$»disFÜm©SdsCommªdArgv
(
sds
 *
rg‘
, 
¬gc
, cÚ¡ **
¬gv
,

478 cÚ¡ 
size_t
 *
¬gvËn
)

480 
sds
 
cmd
;

481 
tÙËn
;

482 
j
;

483 
size_t
 
Ën
;

486 ià(
rg‘
 =ğ
NULL
)

490 
tÙËn
 = 1+
	`couÁDig™s
(
¬gc
)+2;

491 
j
 = 0; j < 
¬gc
; j++) {

492 
Ën
 = 
¬gvËn
 ?‡rgvËn[
j
] : 
	`¡¾’
(
¬gv
[j]);

493 
tÙËn
 +ğ
	`bulkËn
(
Ën
);

497 
cmd
 = 
	`sd£m±y
();

498 ià(
cmd
 =ğ
NULL
)

502 
cmd
 = 
	`sdsMakeRoomFÜ
(cmd, 
tÙËn
);

503 ià(
cmd
 =ğ
NULL
)

507 
cmd
 = 
	`sdsÿtfmt
(cmd, "*%i\r\n", 
¬gc
);

508 
j
=0; j < 
¬gc
; j++) {

509 
Ën
 = 
¬gvËn
 ?‡rgvËn[
j
] : 
	`¡¾’
(
¬gv
[j]);

510 
cmd
 = 
	`sdsÿtfmt
(cmd, "$%T\r\n", 
Ën
);

511 
cmd
 = 
	`sdsÿ’
(cmd, 
¬gv
[
j
], 
Ën
);

512 
cmd
 = 
	`sdsÿ’
(cmd, "\r\n", ("\r\n")-1);

515 
	`as£¹
(
	`sd¦’
(
cmd
)==
tÙËn
);

517 *
rg‘
 = 
cmd
;

518  
tÙËn
;

519 
	}
}

521 
	$»disF»eSdsCommªd
(
sds
 
cmd
) {

522 
	`sdsä“
(
cmd
);

523 
	}
}

530 
	$»disFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

531 *
cmd
 = 
NULL
;

532 
pos
;

533 
size_t
 
Ën
;

534 
tÙËn
, 
j
;

537 ià(
rg‘
 =ğ
NULL
)

541 
tÙËn
 = 1+
	`couÁDig™s
(
¬gc
)+2;

542 
j
 = 0; j < 
¬gc
; j++) {

543 
Ën
 = 
¬gvËn
 ?‡rgvËn[
j
] : 
	`¡¾’
(
¬gv
[j]);

544 
tÙËn
 +ğ
	`bulkËn
(
Ën
);

548 
cmd
 = 
	`m®loc
(
tÙËn
+1);

549 ià(
cmd
 =ğ
NULL
)

552 
pos
 = 
	`¥rštf
(
cmd
,"*%d\r\n",
¬gc
);

553 
j
 = 0; j < 
¬gc
; j++) {

554 
Ën
 = 
¬gvËn
 ?‡rgvËn[
j
] : 
	`¡¾’
(
¬gv
[j]);

555 
pos
 +ğ
	`¥rštf
(
cmd
+pos,"$%zu\r\n",
Ën
);

556 
	`memıy
(
cmd
+
pos
,
¬gv
[
j
],
Ën
);

557 
pos
 +ğ
Ën
;

558 
cmd
[
pos
++] = '\r';

559 
cmd
[
pos
++] = '\n';

561 
	`as£¹
(
pos
 =ğ
tÙËn
);

562 
cmd
[
pos
] = '\0';

564 *
rg‘
 = 
cmd
;

565  
tÙËn
;

566 
	}
}

568 
	$»disF»eCommªd
(*
cmd
) {

569 
	`ä“
(
cmd
);

570 
	}
}

572 
	$__»disS‘E¼Ü
(
»disCÚ‹xt
 *
c
, 
ty³
, cÚ¡ *
¡r
) {

573 
size_t
 
Ën
;

575 
c
->
”r
 = 
ty³
;

576 ià(
¡r
 !ğ
NULL
) {

577 
Ën
 = 
	`¡¾’
(
¡r
);

578 
Ën
 =†’ < ((
c
->
”r¡r
)-1) ?†en : ((c->errstr)-1);

579 
	`memıy
(
c
->
”r¡r
,
¡r
,
Ën
);

580 
c
->
”r¡r
[
Ën
] = '\0';

583 
	`as£¹
(
ty³
 =ğ
REDIS_ERR_IO
);

584 
	`__»dis_¡»¼Ü_r
(
”ºo
, 
c
->
”r¡r
, (c->errstr));

586 
	}
}

588 
»disR—d”
 *
	$»disR—d”C»©e
() {

589  
	`»disR—d”C»©eW™hFunùiÚs
(&
deçuÉFunùiÚs
);

590 
	}
}

592 
»disCÚ‹xt
 *
	$»disCÚ‹xtIn™
() {

593 
»disCÚ‹xt
 *
c
;

595 
c
 = 
	`ÿÎoc
(1,(
»disCÚ‹xt
));

596 ià(
c
 =ğ
NULL
)

597  
NULL
;

599 
c
->
”r
 = 0;

600 
c
->
”r¡r
[0] = '\0';

601 
c
->
obuf
 = 
	`sd£m±y
();

602 
c
->
»ad”
 = 
	`»disR—d”C»©e
();

603 
c
->
tı
.
ho¡
 = 
NULL
;

604 
c
->
tı
.
sourû_addr
 = 
NULL
;

605 
c
->
unix_sock
.
·th
 = 
NULL
;

606 
c
->
timeout
 = 
NULL
;

608 ià(
c
->
obuf
 =ğ
NULL
 || c->
»ad”
 == NULL) {

609 
	`»disF»e
(
c
);

610  
NULL
;

613  
c
;

614 
	}
}

616 
	$»disF»e
(
»disCÚ‹xt
 *
c
) {

617 ià(
c
 =ğ
NULL
)

619 ià(
c
->
fd
 > 0)

620 
	`şo£
(
c
->
fd
);

621 ià(
c
->
obuf
 !ğ
NULL
)

622 
	`sdsä“
(
c
->
obuf
);

623 ià(
c
->
»ad”
 !ğ
NULL
)

624 
	`»disR—d”F»e
(
c
->
»ad”
);

625 ià(
c
->
tı
.
ho¡
)

626 
	`ä“
(
c
->
tı
.
ho¡
);

627 ià(
c
->
tı
.
sourû_addr
)

628 
	`ä“
(
c
->
tı
.
sourû_addr
);

629 ià(
c
->
unix_sock
.
·th
)

630 
	`ä“
(
c
->
unix_sock
.
·th
);

631 ià(
c
->
timeout
)

632 
	`ä“
(
c
->
timeout
);

633 
	`ä“
(
c
);

634 
	}
}

636 
	$»disF»eK“pFd
(
»disCÚ‹xt
 *
c
) {

637 
fd
 = 
c
->fd;

638 
c
->
fd
 = -1;

639 
	`»disF»e
(
c
);

640  
fd
;

641 
	}
}

643 
	$»disRecÚÃù
(
»disCÚ‹xt
 *
c
) {

644 
c
->
”r
 = 0;

645 
	`mem£t
(
c
->
”r¡r
, '\0', 
	`¡¾’
(c->errstr));

647 ià(
c
->
fd
 > 0) {

648 
	`şo£
(
c
->
fd
);

651 
	`sdsä“
(
c
->
obuf
);

652 
	`»disR—d”F»e
(
c
->
»ad”
);

654 
c
->
obuf
 = 
	`sd£m±y
();

655 
c
->
»ad”
 = 
	`»disR—d”C»©e
();

657 ià(
c
->
cÚÃùiÚ_ty³
 =ğ
REDIS_CONN_TCP
) {

658  
	`»disCÚ‹xtCÚÃùBšdTı
(
c
, c->
tı
.
ho¡
, c->tı.
pÜt
,

659 
c
->
timeout
, c->
tı
.
sourû_addr
);

660 } ià(
c
->
cÚÃùiÚ_ty³
 =ğ
REDIS_CONN_UNIX
) {

661  
	`»disCÚ‹xtCÚÃùUnix
(
c
, c->
unix_sock
.
·th
, c->
timeout
);

665 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,"Notƒnough informationo„econnect");

668  
REDIS_ERR
;

669 
	}
}

674 
»disCÚ‹xt
 *
	$»disCÚÃù
(cÚ¡ *

, 
pÜt
) {

675 
»disCÚ‹xt
 *
c
;

677 
c
 = 
	`»disCÚ‹xtIn™
();

678 ià(
c
 =ğ
NULL
)

679  
NULL
;

681 
c
->
æags
 |ğ
REDIS_BLOCK
;

682 
	`»disCÚ‹xtCÚÃùTı
(
c
,

,
pÜt
,
NULL
);

683  
c
;

684 
	}
}

686 
»disCÚ‹xt
 *
	$»disCÚÃùW™hTimeout
(cÚ¡ *

, 
pÜt
, cÚ¡ 
timev®
 
tv
) {

687 
»disCÚ‹xt
 *
c
;

689 
c
 = 
	`»disCÚ‹xtIn™
();

690 ià(
c
 =ğ
NULL
)

691  
NULL
;

693 
c
->
æags
 |ğ
REDIS_BLOCK
;

694 
	`»disCÚ‹xtCÚÃùTı
(
c
,

,
pÜt
,&
tv
);

695  
c
;

696 
	}
}

698 
»disCÚ‹xt
 *
	$»disCÚÃùNÚBlock
(cÚ¡ *

, 
pÜt
) {

699 
»disCÚ‹xt
 *
c
;

701 
c
 = 
	`»disCÚ‹xtIn™
();

702 ià(
c
 =ğ
NULL
)

703  
NULL
;

705 
c
->
æags
 &ğ~
REDIS_BLOCK
;

706 
	`»disCÚ‹xtCÚÃùTı
(
c
,

,
pÜt
,
NULL
);

707  
c
;

708 
	}
}

710 
»disCÚ‹xt
 *
	$»disCÚÃùBšdNÚBlock
(cÚ¡ *

, 
pÜt
,

711 cÚ¡ *
sourû_addr
) {

712 
»disCÚ‹xt
 *
c
 = 
	`»disCÚ‹xtIn™
();

713 
c
->
æags
 &ğ~
REDIS_BLOCK
;

714 
	`»disCÚ‹xtCÚÃùBšdTı
(
c
,

,
pÜt
,
NULL
,
sourû_addr
);

715  
c
;

716 
	}
}

718 
»disCÚ‹xt
 *
	$»disCÚÃùBšdNÚBlockW™hReu£
(cÚ¡ *

, 
pÜt
,

719 cÚ¡ *
sourû_addr
) {

720 
»disCÚ‹xt
 *
c
 = 
	`»disCÚ‹xtIn™
();

721 
c
->
æags
 &ğ~
REDIS_BLOCK
;

722 
c
->
æags
 |ğ
REDIS_REUSEADDR
;

723 
	`»disCÚ‹xtCÚÃùBšdTı
(
c
,

,
pÜt
,
NULL
,
sourû_addr
);

724  
c
;

725 
	}
}

727 
»disCÚ‹xt
 *
	$»disCÚÃùUnix
(cÚ¡ *
·th
) {

728 
»disCÚ‹xt
 *
c
;

730 
c
 = 
	`»disCÚ‹xtIn™
();

731 ià(
c
 =ğ
NULL
)

732  
NULL
;

734 
c
->
æags
 |ğ
REDIS_BLOCK
;

735 
	`»disCÚ‹xtCÚÃùUnix
(
c
,
·th
,
NULL
);

736  
c
;

737 
	}
}

739 
»disCÚ‹xt
 *
	$»disCÚÃùUnixW™hTimeout
(cÚ¡ *
·th
, cÚ¡ 
timev®
 
tv
) {

740 
»disCÚ‹xt
 *
c
;

742 
c
 = 
	`»disCÚ‹xtIn™
();

743 ià(
c
 =ğ
NULL
)

744  
NULL
;

746 
c
->
æags
 |ğ
REDIS_BLOCK
;

747 
	`»disCÚ‹xtCÚÃùUnix
(
c
,
·th
,&
tv
);

748  
c
;

749 
	}
}

751 
»disCÚ‹xt
 *
	$»disCÚÃùUnixNÚBlock
(cÚ¡ *
·th
) {

752 
»disCÚ‹xt
 *
c
;

754 
c
 = 
	`»disCÚ‹xtIn™
();

755 ià(
c
 =ğ
NULL
)

756  
NULL
;

758 
c
->
æags
 &ğ~
REDIS_BLOCK
;

759 
	`»disCÚ‹xtCÚÃùUnix
(
c
,
·th
,
NULL
);

760  
c
;

761 
	}
}

763 
»disCÚ‹xt
 *
	$»disCÚÃùFd
(
fd
) {

764 
»disCÚ‹xt
 *
c
;

766 
c
 = 
	`»disCÚ‹xtIn™
();

767 ià(
c
 =ğ
NULL
)

768  
NULL
;

770 
c
->
fd
 = fd;

771 
c
->
æags
 |ğ
REDIS_BLOCK
 | 
REDIS_CONNECTED
;

772  
c
;

773 
	}
}

776 
	$»disS‘Timeout
(
»disCÚ‹xt
 *
c
, cÚ¡ 
timev®
 
tv
) {

777 ià(
c
->
æags
 & 
REDIS_BLOCK
)

778  
	`»disCÚ‹xtS‘Timeout
(
c
,
tv
);

779  
REDIS_ERR
;

780 
	}
}

783 
	$»disEÇbËK“pAlive
(
»disCÚ‹xt
 *
c
) {

784 ià(
	`»disK“pAlive
(
c
, 
REDIS_KEEPALIVE_INTERVAL
è!ğ
REDIS_OK
)

785  
REDIS_ERR
;

786  
REDIS_OK
;

787 
	}
}

794 
	$»disBufãrR—d
(
»disCÚ‹xt
 *
c
) {

795 
buf
[1024*16];

796 
Ä—d
;

799 ià(
c
->
”r
)

800  
REDIS_ERR
;

802 
Ä—d
 = 
	`»ad
(
c
->
fd
,
buf
,(buf));

803 ià(
Ä—d
 == -1) {

804 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
REDIS_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

807 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_IO
,
NULL
);

808  
REDIS_ERR
;

810 } ià(
Ä—d
 == 0) {

811 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_EOF
,"Server closedhe connection");

812  
REDIS_ERR
;

814 ià(
	`»disR—d”F“d
(
c
->
»ad”
,
buf
,
Ä—d
è!ğ
REDIS_OK
) {

815 
	`__»disS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

816  
REDIS_ERR
;

819  
REDIS_OK
;

820 
	}
}

831 
	$»disBufãrWr™e
(
»disCÚ‹xt
 *
c
, *
dÚe
) {

832 
nwr™‹n
;

835 ià(
c
->
”r
)

836  
REDIS_ERR
;

838 ià(
	`sd¦’
(
c
->
obuf
) > 0) {

839 
nwr™‹n
 = 
	`wr™e
(
c
->
fd
,c->
obuf
,
	`sd¦’
(c->obuf));

840 ià(
nwr™‹n
 == -1) {

841 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
REDIS_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

844 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_IO
,
NULL
);

845  
REDIS_ERR
;

847 } ià(
nwr™‹n
 > 0) {

848 ià(
nwr™‹n
 =ğ(sigÃd)
	`sd¦’
(
c
->
obuf
)) {

849 
	`sdsä“
(
c
->
obuf
);

850 
c
->
obuf
 = 
	`sd£m±y
();

852 
	`sd¤ªge
(
c
->
obuf
,
nwr™‹n
,-1);

856 ià(
dÚe
 !ğ
NULL
è*dÚğ(
	`sd¦’
(
c
->
obuf
) == 0);

857  
REDIS_OK
;

858 
	}
}

862 
	$»disG‘R•lyFromR—d”
(
»disCÚ‹xt
 *
c
, **
»¶y
) {

863 ià(
	`»disR—d”G‘R•ly
(
c
->
»ad”
,
»¶y
è=ğ
REDIS_ERR
) {

864 
	`__»disS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

865  
REDIS_ERR
;

867  
REDIS_OK
;

868 
	}
}

870 
	$»disG‘R•ly
(
»disCÚ‹xt
 *
c
, **
»¶y
) {

871 
wdÚe
 = 0;

872 *
aux
 = 
NULL
;

875 ià(
	`»disG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
REDIS_ERR
)

876  
REDIS_ERR
;

879 ià(
aux
 =ğ
NULL
 && 
c
->
æags
 & 
REDIS_BLOCK
) {

882 ià(
	`»disBufãrWr™e
(
c
,&
wdÚe
è=ğ
REDIS_ERR
)

883  
REDIS_ERR
;

884 } !
wdÚe
);

888 ià(
	`»disBufãrR—d
(
c
è=ğ
REDIS_ERR
)

889  
REDIS_ERR
;

890 ià(
	`»disG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
REDIS_ERR
)

891  
REDIS_ERR
;

892 } 
aux
 =ğ
NULL
);

896 ià(
»¶y
 !ğ
NULL
è*»¶y = 
aux
;

897  
REDIS_OK
;

898 
	}
}

907 
	$__»disAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
cmd
, 
size_t
 
Ën
) {

908 
sds
 
Ãwbuf
;

910 
Ãwbuf
 = 
	`sdsÿ’
(
c
->
obuf
,
cmd
,
Ën
);

911 ià(
Ãwbuf
 =ğ
NULL
) {

912 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OOM
,"Out of memory");

913  
REDIS_ERR
;

916 
c
->
obuf
 = 
Ãwbuf
;

917  
REDIS_OK
;

918 
	}
}

920 
	$»disAµ’dFÜm©‹dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
cmd
, 
size_t
 
Ën
) {

922 ià(
	`__»disAµ’dCommªd
(
c
, 
cmd
, 
Ën
è!ğ
REDIS_OK
) {

923  
REDIS_ERR
;

926  
REDIS_OK
;

927 
	}
}

929 
	$»disvAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
) {

930 *
cmd
;

931 
Ën
;

933 
Ën
 = 
	`»disvFÜm©Commªd
(&
cmd
,
fÜm©
,
­
);

934 ià(
Ën
 == -1) {

935 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OOM
,"Out of memory");

936  
REDIS_ERR
;

937 } ià(
Ën
 == -2) {

938 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,"Invalid format string");

939  
REDIS_ERR
;

942 ià(
	`__»disAµ’dCommªd
(
c
,
cmd
,
Ën
è!ğ
REDIS_OK
) {

943 
	`ä“
(
cmd
);

944  
REDIS_ERR
;

947 
	`ä“
(
cmd
);

948  
REDIS_OK
;

949 
	}
}

951 
	$»disAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, ...) {

952 
va_li¡
 
­
;

953 
»t
;

955 
	`va_¡¬t
(
­
,
fÜm©
);

956 
»t
 = 
	`»disvAµ’dCommªd
(
c
,
fÜm©
,
­
);

957 
	`va_’d
(
­
);

958  
»t
;

959 
	}
}

961 
	$»disAµ’dCommªdArgv
(
»disCÚ‹xt
 *
c
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

962 
sds
 
cmd
;

963 
Ën
;

965 
Ën
 = 
	`»disFÜm©SdsCommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
¬gvËn
);

966 ià(
Ën
 == -1) {

967 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OOM
,"Out of memory");

968  
REDIS_ERR
;

971 ià(
	`__»disAµ’dCommªd
(
c
,
cmd
,
Ën
è!ğ
REDIS_OK
) {

972 
	`sdsä“
(
cmd
);

973  
REDIS_ERR
;

976 
	`sdsä“
(
cmd
);

977  
REDIS_OK
;

978 
	}
}

991 *
	$__»disBlockFÜR•ly
(
»disCÚ‹xt
 *
c
) {

992 *
»¶y
;

994 ià(
c
->
æags
 & 
REDIS_BLOCK
) {

995 ià(
	`»disG‘R•ly
(
c
,&
»¶y
è!ğ
REDIS_OK
)

996  
NULL
;

997  
»¶y
;

999  
NULL
;

1000 
	}
}

1002 *
	$»disvCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
) {

1003 ià(
	`»disvAµ’dCommªd
(
c
,
fÜm©
,
­
è!ğ
REDIS_OK
)

1004  
NULL
;

1005  
	`__»disBlockFÜR•ly
(
c
);

1006 
	}
}

1008 *
	$»disCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, ...) {

1009 
va_li¡
 
­
;

1010 *
»¶y
 = 
NULL
;

1011 
	`va_¡¬t
(
­
,
fÜm©
);

1012 
»¶y
 = 
	`»disvCommªd
(
c
,
fÜm©
,
­
);

1013 
	`va_’d
(
­
);

1014  
»¶y
;

1015 
	}
}

1017 *
	$»disCommªdArgv
(
»disCÚ‹xt
 *
c
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

1018 ià(
	`»disAµ’dCommªdArgv
(
c
,
¬gc
,
¬gv
,
¬gvËn
è!ğ
REDIS_OK
)

1019  
NULL
;

1020  
	`__»disBlockFÜR•ly
(
c
);

1021 
	}
}

	@dep/hiredis-0.13.3/hiredis.h

34 #iâdeà
__HIREDIS_H


35 
	#__HIREDIS_H


	)

36 
	~"»ad.h
"

37 
	~<¡d¬g.h
>

38 
	~<sys/time.h
>

39 
	~<¡dšt.h
>

40 
	~"sds.h
"

42 
	#HIREDIS_MAJOR
 0

	)

43 
	#HIREDIS_MINOR
 13

	)

44 
	#HIREDIS_PATCH
 3

	)

45 
	#HIREDIS_SONAME
 0.13

	)

49 
	#REDIS_BLOCK
 0x1

	)

53 
	#REDIS_CONNECTED
 0x2

	)

59 
	#REDIS_DISCONNECTING
 0x4

	)

63 
	#REDIS_FREEING
 0x8

	)

66 
	#REDIS_IN_CALLBACK
 0x10

	)

69 
	#REDIS_SUBSCRIBED
 0x20

	)

72 
	#REDIS_MONITORING
 0x40

	)

75 
	#REDIS_REUSEADDR
 0x80

	)

77 
	#REDIS_KEEPALIVE_INTERVAL
 15

	)

81 
	#REDIS_CONNECT_RETRIES
 10

	)

86 #iâdeà
_GNU_SOURCE


88 
	#__»dis_¡»¼Ü_r
(
”ºo
, 
buf
, 
Ën
) \

90 
	`¡»¼Ü_r
((
”ºo
), (
buf
), (
Ën
)); \

91 } 0)

	)

94 
	#__»dis_¡»¼Ü_r
(
”ºo
, 
buf
, 
Ën
) \

96 *
”r_¡r
 = 
	`¡»¼Ü_r
((
”ºo
), (
buf
), (
Ën
)); \

100 ià(
”r_¡r
 !ğ(
buf
)) { \

101 
buf
[(
Ën
)] = '\0'; \

102 
	`¡ºÿt
((
buf
), 
”r_¡r
, ((
Ën
) - 1)); \

104 } 0)

	)

107 #ifdeà
__ılu¥lus


112 
	s»disR•ly
 {

113 
ty³
;

114 
š‹g”
;

115 
Ën
;

116 *
¡r
;

117 
size_t
 
–em’ts
;

118 
»disR•ly
 **
–em’t
;

119 } 
	t»disR•ly
;

121 
»disR—d”
 *
»disR—d”C»©e
();

124 
ä“R•lyObjeù
(*
»¶y
);

127 
»disvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

128 
»disFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...);

129 
»disFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

130 
»disFÜm©SdsCommªdArgv
(
sds
 *
rg‘
, 
¬gc
, cÚ¡ ** 
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

131 
»disF»eCommªd
(*
cmd
);

132 
»disF»eSdsCommªd
(
sds
 
cmd
);

134 
	e»disCÚÃùiÚTy³
 {

135 
REDIS_CONN_TCP
,

136 
REDIS_CONN_UNIX
,

140 
	s»disCÚ‹xt
 {

141 
”r
;

142 
”r¡r
[128];

143 
fd
;

144 
æags
;

145 *
obuf
;

146 
»disR—d”
 *
»ad”
;

148 
»disCÚÃùiÚTy³
 
cÚÃùiÚ_ty³
;

149 
timev®
 *
timeout
;

152 *
ho¡
;

153 *
sourû_addr
;

154 
pÜt
;

155 } 
tı
;

158 *
·th
;

159 } 
unix_sock
;

161 } 
	t»disCÚ‹xt
;

163 
»disCÚ‹xt
 *
»disCÚÃù
(cÚ¡ *

, 
pÜt
);

164 
»disCÚ‹xt
 *
»disCÚÃùW™hTimeout
(cÚ¡ *

, 
pÜt
, cÚ¡ 
timev®
 
tv
);

165 
»disCÚ‹xt
 *
»disCÚÃùNÚBlock
(cÚ¡ *

, 
pÜt
);

166 
»disCÚ‹xt
 *
»disCÚÃùBšdNÚBlock
(cÚ¡ *

, 
pÜt
,

167 cÚ¡ *
sourû_addr
);

168 
»disCÚ‹xt
 *
»disCÚÃùBšdNÚBlockW™hReu£
(cÚ¡ *

, 
pÜt
,

169 cÚ¡ *
sourû_addr
);

170 
»disCÚ‹xt
 *
»disCÚÃùUnix
(cÚ¡ *
·th
);

171 
»disCÚ‹xt
 *
»disCÚÃùUnixW™hTimeout
(cÚ¡ *
·th
, cÚ¡ 
timev®
 
tv
);

172 
»disCÚ‹xt
 *
»disCÚÃùUnixNÚBlock
(cÚ¡ *
·th
);

173 
»disCÚ‹xt
 *
»disCÚÃùFd
(
fd
);

184 
»disRecÚÃù
(
»disCÚ‹xt
 *
c
);

186 
»disS‘Timeout
(
»disCÚ‹xt
 *
c
, cÚ¡ 
timev®
 
tv
);

187 
»disEÇbËK“pAlive
(
»disCÚ‹xt
 *
c
);

188 
»disF»e
(
»disCÚ‹xt
 *
c
);

189 
»disF»eK“pFd
(
»disCÚ‹xt
 *
c
);

190 
»disBufãrR—d
(
»disCÚ‹xt
 *
c
);

191 
»disBufãrWr™e
(
»disCÚ‹xt
 *
c
, *
dÚe
);

197 
»disG‘R•ly
(
»disCÚ‹xt
 *
c
, **
»¶y
);

198 
»disG‘R•lyFromR—d”
(
»disCÚ‹xt
 *
c
, **
»¶y
);

202 
»disAµ’dFÜm©‹dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
cmd
, 
size_t
 
Ën
);

206 
»disvAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

207 
»disAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, ...);

208 
»disAµ’dCommªdArgv
(
»disCÚ‹xt
 *
c
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

215 *
»disvCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

216 *
»disCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, ...);

217 *
»disCommªdArgv
(
»disCÚ‹xt
 *
c
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

219 #ifdeà
__ılu¥lus


	@dep/hiredis-0.13.3/net.c

35 
	~"fmaüos.h
"

36 
	~<sys/ty³s.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/£Ëù.h
>

39 
	~<sys/un.h
>

40 
	~<Ãtš‘/š.h
>

41 
	~<Ãtš‘/tı.h
>

42 
	~<¬·/š‘.h
>

43 
	~<uni¡d.h
>

44 
	~<fú.h
>

45 
	~<¡ršg.h
>

46 
	~<Ãtdb.h
>

47 
	~<”ºo.h
>

48 
	~<¡d¬g.h
>

49 
	~<¡dio.h
>

50 
	~<pŞl.h
>

51 
	~<lim™s.h
>

52 
	~<¡dlib.h
>

54 
	~"Ãt.h
"

55 
	~"sds.h
"

58 
__»disS‘E¼Ü
(
»disCÚ‹xt
 *
c
, 
ty³
, cÚ¡ *
¡r
);

60 
	$»disCÚ‹xtClo£Fd
(
»disCÚ‹xt
 *
c
) {

61 ià(
c
 && c->
fd
 >= 0) {

62 
	`şo£
(
c
->
fd
);

63 
c
->
fd
 = -1;

65 
	}
}

67 
	$__»disS‘E¼ÜFromE¼no
(
»disCÚ‹xt
 *
c
, 
ty³
, cÚ¡ *
´efix
) {

68 
buf
[128] = { 0 };

69 
size_t
 
Ën
 = 0;

71 ià(
´efix
 !ğ
NULL
)

72 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%s: ",
´efix
);

73 
	`__»dis_¡»¼Ü_r
(
”ºo
, (*)(
buf
 + 
Ën
), (buf) -†en);

74 
	`__»disS‘E¼Ü
(
c
,
ty³
,
buf
);

75 
	}
}

77 
	$»disS‘Reu£Addr
(
»disCÚ‹xt
 *
c
) {

78 
Ú
 = 1;

79 ià(
	`£tsockİt
(
c
->
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
Ú
, (on)) == -1) {

80 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

81 
	`»disCÚ‹xtClo£Fd
(
c
);

82  
REDIS_ERR
;

84  
REDIS_OK
;

85 
	}
}

87 
	$»disC»©eSock‘
(
»disCÚ‹xt
 *
c
, 
ty³
) {

88 
s
;

89 ià((
s
 = 
	`sock‘
(
ty³
, 
SOCK_STREAM
, 0)) == -1) {

90 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

91  
REDIS_ERR
;

93 
c
->
fd
 = 
s
;

94 ià(
ty³
 =ğ
AF_INET
) {

95 ià(
	`»disS‘Reu£Addr
(
c
è=ğ
REDIS_ERR
) {

96  
REDIS_ERR
;

99  
REDIS_OK
;

100 
	}
}

102 
	$»disS‘Blockšg
(
»disCÚ‹xt
 *
c
, 
blockšg
) {

103 
æags
;

108 ià((
æags
 = 
	`fú
(
c
->
fd
, 
F_GETFL
)) == -1) {

109 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"fcntl(F_GETFL)");

110 
	`»disCÚ‹xtClo£Fd
(
c
);

111  
REDIS_ERR
;

114 ià(
blockšg
)

115 
æags
 &ğ~
O_NONBLOCK
;

117 
æags
 |ğ
O_NONBLOCK
;

119 ià(
	`fú
(
c
->
fd
, 
F_SETFL
, 
æags
) == -1) {

120 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"fcntl(F_SETFL)");

121 
	`»disCÚ‹xtClo£Fd
(
c
);

122  
REDIS_ERR
;

124  
REDIS_OK
;

125 
	}
}

127 
	$»disK“pAlive
(
»disCÚ‹xt
 *
c
, 
š‹rv®
) {

128 
v®
 = 1;

129 
fd
 = 
c
->fd;

131 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
v®
, (val)) == -1){

132 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

133  
REDIS_ERR
;

136 
v®
 = 
š‹rv®
;

138 #ifdeà
_OSX


139 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPALIVE
, &
v®
, (val)) < 0) {

140 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

141  
REDIS_ERR
;

144 #ià
	`defšed
(
__GLIBC__
è&& !defšed(
__F»eBSD_k”Ãl__
)

145 
v®
 = 
š‹rv®
;

146 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPIDLE
, &
v®
, (val)) < 0) {

147 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

148  
REDIS_ERR
;

151 
v®
 = 
š‹rv®
/3;

152 ià(
v®
 == 0) val = 1;

153 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPINTVL
, &
v®
, (val)) < 0) {

154 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

155  
REDIS_ERR
;

158 
v®
 = 3;

159 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPCNT
, &
v®
, (val)) < 0) {

160 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

161  
REDIS_ERR
;

166  
REDIS_OK
;

167 
	}
}

169 
	$»disS‘TıNoD–ay
(
»disCÚ‹xt
 *
c
) {

170 
yes
 = 1;

171 ià(
	`£tsockİt
(
c
->
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
yes
, (yes)) == -1) {

172 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"setsockopt(TCP_NODELAY)");

173 
	`»disCÚ‹xtClo£Fd
(
c
);

174  
REDIS_ERR
;

176  
REDIS_OK
;

177 
	}
}

179 
	#__MAX_MSEC
 (((
LONG_MAX
è- 999è/ 1000)

	)

181 
	$»disCÚ‹xtWa™R—dy
(
»disCÚ‹xt
 *
c
, cÚ¡ 
timev®
 *
timeout
) {

182 
pŞlfd
 
wfd
[1];

183 
m£c
;

185 
m£c
 = -1;

186 
wfd
[0].
fd
 = 
c
->fd;

187 
wfd
[0].
ev’ts
 = 
POLLOUT
;

190 ià(
timeout
 !ğ
NULL
) {

191 ià(
timeout
->
tv_u£c
 > 1000000 ||imeout->
tv_£c
 > 
__MAX_MSEC
) {

192 
	`__»disS‘E¼ÜFromE¼no
(
c
, 
REDIS_ERR_IO
, 
NULL
);

193 
	`»disCÚ‹xtClo£Fd
(
c
);

194  
REDIS_ERR
;

197 
m£c
 = (
timeout
->
tv_£c
 * 1000è+ (Ñimeout->
tv_u£c
 + 999) / 1000);

199 ià(
m£c
 < 0 || m£ø> 
INT_MAX
) {

200 
m£c
 = 
INT_MAX
;

204 ià(
”ºo
 =ğ
EINPROGRESS
) {

205 
»s
;

207 ià((
»s
 = 
	`pŞl
(
wfd
, 1, 
m£c
)) == -1) {

208 
	`__»disS‘E¼ÜFromE¼no
(
c
, 
REDIS_ERR_IO
, "poll(2)");

209 
	`»disCÚ‹xtClo£Fd
(
c
);

210  
REDIS_ERR
;

211 } ià(
»s
 == 0) {

212 
”ºo
 = 
ETIMEDOUT
;

213 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

214 
	`»disCÚ‹xtClo£Fd
(
c
);

215  
REDIS_ERR
;

218 ià(
	`»disCheckSock‘E¼Ü
(
c
è!ğ
REDIS_OK
)

219  
REDIS_ERR
;

221  
REDIS_OK
;

224 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

225 
	`»disCÚ‹xtClo£Fd
(
c
);

226  
REDIS_ERR
;

227 
	}
}

229 
	$»disCheckSock‘E¼Ü
(
»disCÚ‹xt
 *
c
) {

230 
”r
 = 0;

231 
sockËn_t
 
”¾’
 = (
”r
);

233 ià(
	`g‘sockİt
(
c
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”r
, &
”¾’
) == -1) {

234 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"getsockopt(SO_ERROR)");

235  
REDIS_ERR
;

238 ià(
”r
) {

239 
”ºo
 = 
”r
;

240 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

241  
REDIS_ERR
;

244  
REDIS_OK
;

245 
	}
}

247 
	$»disCÚ‹xtS‘Timeout
(
»disCÚ‹xt
 *
c
, cÚ¡ 
timev®
 
tv
) {

248 ià(
	`£tsockİt
(
c
->
fd
,
SOL_SOCKET
,
SO_RCVTIMEO
,&
tv
,(tv)) == -1) {

249 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"setsockopt(SO_RCVTIMEO)");

250  
REDIS_ERR
;

252 ià(
	`£tsockİt
(
c
->
fd
,
SOL_SOCKET
,
SO_SNDTIMEO
,&
tv
,(tv)) == -1) {

253 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"setsockopt(SO_SNDTIMEO)");

254  
REDIS_ERR
;

256  
REDIS_OK
;

257 
	}
}

259 
	$_»disCÚ‹xtCÚÃùTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
,

260 cÚ¡ 
timev®
 *
timeout
,

261 cÚ¡ *
sourû_addr
) {

262 
s
, 
rv
, 
n
;

263 
_pÜt
[6];

264 
addršfo
 
hšts
, *
£rvšfo
, *
b£rvšfo
, *
p
, *
b
;

265 
blockšg
 = (
c
->
æags
 & 
REDIS_BLOCK
);

266 
»u£addr
 = (
c
->
æags
 & 
REDIS_REUSEADDR
);

267 
»u£s
 = 0;

269 
c
->
cÚÃùiÚ_ty³
 = 
REDIS_CONN_TCP
;

270 
c
->
tı
.
pÜt
 =…ort;

279 ià(
c
->
tı
.
ho¡
 !ğ
addr
) {

280 ià(
c
->
tı
.
ho¡
)

281 
	`ä“
(
c
->
tı
.
ho¡
);

283 
c
->
tı
.
ho¡
 = 
	`¡rdup
(
addr
);

286 ià(
timeout
) {

287 ià(
c
->
timeout
 !=imeout) {

288 ià(
c
->
timeout
 =ğ
NULL
)

289 
c
->
timeout
 = 
	`m®loc
((
timev®
));

291 
	`memıy
(
c
->
timeout
,imeout, (
timev®
));

294 ià(
c
->
timeout
)

295 
	`ä“
(
c
->
timeout
);

296 
c
->
timeout
 = 
NULL
;

299 ià(
sourû_addr
 =ğ
NULL
) {

300 
	`ä“
(
c
->
tı
.
sourû_addr
);

301 
c
->
tı
.
sourû_addr
 = 
NULL
;

302 } ià(
c
->
tı
.
sourû_addr
 != source_addr) {

303 
	`ä“
(
c
->
tı
.
sourû_addr
);

304 
c
->
tı
.
sourû_addr
 = 
	`¡rdup
(source_addr);

307 
	`¢´štf
(
_pÜt
, 6, "%d", 
pÜt
);

308 
	`mem£t
(&
hšts
,0,(hints));

309 
hšts
.
ai_çmy
 = 
AF_INET
;

310 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

317 ià((
rv
 = 
	`g‘addršfo
(
c
->
tı
.
ho¡
,
_pÜt
,&
hšts
,&
£rvšfo
)) != 0) {

318 
hšts
.
ai_çmy
 = 
AF_INET6
;

319 ià((
rv
 = 
	`g‘addršfo
(
addr
,
_pÜt
,&
hšts
,&
£rvšfo
)) != 0) {

320 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`gai_¡»¼Ü
(
rv
));

321  
REDIS_ERR
;

324 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

325 
add¼‘ry
:

326 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

329 
c
->
fd
 = 
s
;

330 ià(
	`»disS‘Blockšg
(
c
,0è!ğ
REDIS_OK
)

331 
”rÜ
;

332 ià(
c
->
tı
.
sourû_addr
) {

333 
bound
 = 0;

335 ià((
rv
 = 
	`g‘addršfo
(
c
->
tı
.
sourû_addr
, 
NULL
, &
hšts
, &
b£rvšfo
)) != 0) {

336 
buf
[128];

337 
	`¢´štf
(
buf
,(buf),"Cª'ˆg‘‡ddr: %s",
	`gai_¡»¼Ü
(
rv
));

338 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
buf
);

339 
”rÜ
;

342 ià(
»u£addr
) {

343 
n
 = 1;

344 ià(
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*è&
n
,

345 (
n
)) < 0) {

346 
”rÜ
;

350 
b
 = 
b£rvšfo
; b !ğ
NULL
; b = b->
ai_Ãxt
) {

351 ià(
	`bšd
(
s
,
b
->
ai_addr
,b->
ai_add¾’
) != -1) {

352 
bound
 = 1;

356 
	`ä“addršfo
(
b£rvšfo
);

357 ià(!
bound
) {

358 
buf
[128];

359 
	`¢´štf
(
buf
,(buf),"Cª'ˆbšd sock‘: %s",
	`¡»¼Ü
(
”ºo
));

360 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
buf
);

361 
”rÜ
;

364 ià(
	`cÚÃù
(
s
,
p
->
ai_addr
,p->
ai_add¾’
) == -1) {

365 ià(
”ºo
 =ğ
EHOSTUNREACH
) {

366 
	`»disCÚ‹xtClo£Fd
(
c
);

368 } ià(
”ºo
 =ğ
EINPROGRESS
 && !
blockšg
) {

370 } ià(
”ºo
 =ğ
EADDRNOTAVAIL
 && 
»u£addr
) {

371 ià(++
»u£s
 >ğ
REDIS_CONNECT_RETRIES
) {

372 
”rÜ
;

374 
add¼‘ry
;

377 ià(
	`»disCÚ‹xtWa™R—dy
(
c
,c->
timeout
è!ğ
REDIS_OK
)

378 
”rÜ
;

381 ià(
blockšg
 && 
	`»disS‘Blockšg
(
c
,1è!ğ
REDIS_OK
)

382 
”rÜ
;

383 ià(
	`»disS‘TıNoD–ay
(
c
è!ğ
REDIS_OK
)

384 
”rÜ
;

386 
c
->
æags
 |ğ
REDIS_CONNECTED
;

387 
rv
 = 
REDIS_OK
;

388 
’d
;

390 ià(
p
 =ğ
NULL
) {

391 
buf
[128];

392 
	`¢´štf
(
buf
,(buf),"Cª'ˆü—‹ sock‘: %s",
	`¡»¼Ü
(
”ºo
));

393 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
buf
);

394 
”rÜ
;

397 
”rÜ
:

398 
rv
 = 
REDIS_ERR
;

399 
’d
:

400 
	`ä“addršfo
(
£rvšfo
);

401  
rv
;

402 
	}
}

404 
	$»disCÚ‹xtCÚÃùTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
,

405 cÚ¡ 
timev®
 *
timeout
) {

406  
	`_»disCÚ‹xtCÚÃùTı
(
c
, 
addr
, 
pÜt
, 
timeout
, 
NULL
);

407 
	}
}

409 
	$»disCÚ‹xtCÚÃùBšdTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
,

410 cÚ¡ 
timev®
 *
timeout
,

411 cÚ¡ *
sourû_addr
) {

412  
	`_»disCÚ‹xtCÚÃùTı
(
c
, 
addr
, 
pÜt
, 
timeout
, 
sourû_addr
);

413 
	}
}

415 
	$»disCÚ‹xtCÚÃùUnix
(
»disCÚ‹xt
 *
c
, cÚ¡ *
·th
, cÚ¡ 
timev®
 *
timeout
) {

416 
blockšg
 = (
c
->
æags
 & 
REDIS_BLOCK
);

417 
sockaddr_un
 
§
;

419 ià(
	`»disC»©eSock‘
(
c
,
AF_LOCAL
) < 0)

420  
REDIS_ERR
;

421 ià(
	`»disS‘Blockšg
(
c
,0è!ğ
REDIS_OK
)

422  
REDIS_ERR
;

424 
c
->
cÚÃùiÚ_ty³
 = 
REDIS_CONN_UNIX
;

425 ià(
c
->
unix_sock
.
·th
 !=…ath)

426 
c
->
unix_sock
.
·th
 = 
	`¡rdup
(path);

428 ià(
timeout
) {

429 ià(
c
->
timeout
 !=imeout) {

430 ià(
c
->
timeout
 =ğ
NULL
)

431 
c
->
timeout
 = 
	`m®loc
((
timev®
));

433 
	`memıy
(
c
->
timeout
,imeout, (
timev®
));

436 ià(
c
->
timeout
)

437 
	`ä“
(
c
->
timeout
);

438 
c
->
timeout
 = 
NULL
;

441 
§
.
sun_çmy
 = 
AF_LOCAL
;

442 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

443 ià(
	`cÚÃù
(
c
->
fd
, (
sockaddr
*)&
§
, (sa)) == -1) {

444 ià(
”ºo
 =ğ
EINPROGRESS
 && !
blockšg
) {

447 ià(
	`»disCÚ‹xtWa™R—dy
(
c
,c->
timeout
è!ğ
REDIS_OK
)

448  
REDIS_ERR
;

453 ià(
blockšg
 && 
	`»disS‘Blockšg
(
c
,1è!ğ
REDIS_OK
)

454  
REDIS_ERR
;

456 
c
->
æags
 |ğ
REDIS_CONNECTED
;

457  
REDIS_OK
;

458 
	}
}

	@dep/hiredis-0.13.3/net.h

35 #iâdeà
__NET_H


36 
	#__NET_H


	)

38 
	~"hœedis.h
"

40 #ià
defšed
(
__sun
)

41 
	#AF_LOCAL
 
AF_UNIX


	)

44 
»disCheckSock‘E¼Ü
(
»disCÚ‹xt
 *
c
);

45 
»disCÚ‹xtS‘Timeout
(
»disCÚ‹xt
 *
c
, cÚ¡ 
timev®
 
tv
);

46 
»disCÚ‹xtCÚÃùTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
, cÚ¡ 
timev®
 *
timeout
);

47 
»disCÚ‹xtCÚÃùBšdTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
,

48 cÚ¡ 
timev®
 *
timeout
,

49 cÚ¡ *
sourû_addr
);

50 
»disCÚ‹xtCÚÃùUnix
(
»disCÚ‹xt
 *
c
, cÚ¡ *
·th
, cÚ¡ 
timev®
 *
timeout
);

51 
»disK“pAlive
(
»disCÚ‹xt
 *
c
, 
š‹rv®
);

	@dep/hiredis-0.13.3/read.c

33 
	~"fmaüos.h
"

34 
	~<¡ršg.h
>

35 
	~<¡dlib.h
>

36 #iâdeà
_MSC_VER


37 
	~<uni¡d.h
>

39 
	~<as£¹.h
>

40 
	~<”ºo.h
>

41 
	~<ùy³.h
>

43 
	~"»ad.h
"

44 
	~"sds.h
"

46 
	$__»disR—d”S‘E¼Ü
(
»disR—d”
 *
r
, 
ty³
, cÚ¡ *
¡r
) {

47 
size_t
 
Ën
;

49 ià(
r
->
»¶y
 !ğ
NULL
 &&„->
â
 &&„->â->
ä“Objeù
) {

50 
r
->
â
->
	`ä“Objeù
Ô->
»¶y
);

51 
r
->
»¶y
 = 
NULL
;

55 ià(
r
->
buf
 !ğ
NULL
) {

56 
	`sdsä“
(
r
->
buf
);

57 
r
->
buf
 = 
NULL
;

58 
r
->
pos
 =„->
Ën
 = 0;

62 
r
->
ridx
 = -1;

65 
r
->
”r
 = 
ty³
;

66 
Ën
 = 
	`¡¾’
(
¡r
);

67 
Ën
 =†’ < ((
r
->
”r¡r
)-1) ?†en : ((r->errstr)-1);

68 
	`memıy
(
r
->
”r¡r
,
¡r
,
Ën
);

69 
r
->
”r¡r
[
Ën
] = '\0';

70 
	}
}

72 
size_t
 
	$ch¹os
(*
buf
, 
size_t
 
size
, 
by‹
) {

73 
size_t
 
Ën
 = 0;

75 
by‹
) {

78 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\%c\"",
by‹
);

80 '\n': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\n\""); ;

81 '\r': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\r\""); ;

82 '\t': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\t\""); ;

83 '\a': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\a\""); ;

84 '\b': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\b\""); ;

86 ià(
	`i¥ršt
(
by‹
))

87 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"%c\"",
by‹
);

89 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\x%02x\"",()
by‹
);

93  
Ën
;

94 
	}
}

96 
	$__»disR—d”S‘E¼ÜPrÙocŞBy‹
(
»disR—d”
 *
r
, 
by‹
) {

97 
cbuf
[8], 
sbuf
[128];

99 
	`ch¹os
(
cbuf
,(cbuf),
by‹
);

100 
	`¢´štf
(
sbuf
,(sbuf),

101 "PrÙocŞƒ¼Ü, gÙ % a »¶yy³ by‹", 
cbuf
);

102 
	`__»disR—d”S‘E¼Ü
(
r
,
REDIS_ERR_PROTOCOL
,
sbuf
);

103 
	}
}

105 
	$__»disR—d”S‘E¼ÜOOM
(
»disR—d”
 *
r
) {

106 
	`__»disR—d”S‘E¼Ü
(
r
,
REDIS_ERR_OOM
,"Out of memory");

107 
	}
}

109 *
	$»adBy‹s
(
»disR—d”
 *
r
, 
by‹s
) {

110 *
p
;

111 ià(
r
->
Ën
-r->
pos
 >ğ
by‹s
) {

112 
p
 = 
r
->
buf
+r->
pos
;

113 
r
->
pos
 +ğ
by‹s
;

114  
p
;

116  
NULL
;

117 
	}
}

120 *
	$£ekNewlše
(*
s
, 
size_t
 
Ën
) {

121 
pos
 = 0;

122 
_Ën
 = 
Ën
-1;

128 
pos
 < 
_Ën
) {

129 
pos
 < 
_Ën
 && 
s
[pos] != '\r')…os++;

130 ià(
s
[
pos
] != '\r') {

132  
NULL
;

134 ià(
s
[
pos
+1] == '\n') {

136  
s
+
pos
;

139 
pos
++;

143  
NULL
;

144 
	}
}

148 
	$»adLÚgLÚg
(*
s
) {

149 
v
 = 0;

150 
dec
, 
muÉ
 = 1;

151 
c
;

153 ià(*
s
 == '-') {

154 
muÉ
 = -1;

155 
s
++;

156 } ià(*
s
 == '+') {

157 
muÉ
 = 1;

158 
s
++;

161 (
c
 = *(
s
++)) != '\r') {

162 
dec
 = 
c
 - '0';

163 ià(
dec
 >= 0 && dec < 10) {

164 
v
 *= 10;

165 
v
 +ğ
dec
;

172  
muÉ
*
v
;

173 
	}
}

175 *
	$»adLše
(
»disR—d”
 *
r
, *
_Ën
) {

176 *
p
, *
s
;

177 
Ën
;

179 
p
 = 
r
->
buf
+r->
pos
;

180 
s
 = 
	`£ekNewlše
(
p
,(
r
->
Ën
-r->
pos
));

181 ià(
s
 !ğ
NULL
) {

182 
Ën
 = 
s
-(
r
->
buf
+r->
pos
);

183 
r
->
pos
 +ğ
Ën
+2;

184 ià(
_Ën
è*_ËÀğ
Ën
;

185  
p
;

187  
NULL
;

188 
	}
}

190 
	$moveToNextTask
(
»disR—d”
 *
r
) {

191 
»disR—dTask
 *
cur
, *
´v
;

192 
r
->
ridx
 >= 0) {

194 ià(
r
->
ridx
 == 0) {

195 
r
->
ridx
--;

199 
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

200 
´v
 = &(
r
->
r¡ack
[r->
ridx
-1]);

201 
	`as£¹
(
´v
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

202 ià(
cur
->
idx
 =ğ
´v
->
–em’ts
-1) {

203 
r
->
ridx
--;

206 
	`as£¹
(
cur
->
idx
 < 
´v
->
–em’ts
);

207 
cur
->
ty³
 = -1;

208 
cur
->
–em’ts
 = -1;

209 
cur
->
idx
++;

213 
	}
}

215 
	$´oûssLšeI‹m
(
»disR—d”
 *
r
) {

216 
»disR—dTask
 *
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

217 *
obj
;

218 *
p
;

219 
Ën
;

221 ià((
p
 = 
	`»adLše
(
r
,&
Ën
)è!ğ
NULL
) {

222 ià(
cur
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

223 ià(
r
->
â
 &&„->â->
ü—‹IÁeg”
)

224 
obj
 = 
r
->
â
->
	`ü—‹IÁeg”
(
cur
,
	`»adLÚgLÚg
(
p
));

226 
obj
 = (*)
REDIS_REPLY_INTEGER
;

229 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

230 
obj
 = 
r
->
â
->
	`ü—‹SŒšg
(
cur
,
p
,
Ën
);

232 
obj
 = (*)(
size_t
)(
cur
->
ty³
);

235 ià(
obj
 =ğ
NULL
) {

236 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

237  
REDIS_ERR
;

241 ià(
r
->
ridx
 =ğ0èr->
»¶y
 = 
obj
;

242 
	`moveToNextTask
(
r
);

243  
REDIS_OK
;

246  
REDIS_ERR
;

247 
	}
}

249 
	$´oûssBulkI‹m
(
»disR—d”
 *
r
) {

250 
»disR—dTask
 *
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

251 *
obj
 = 
NULL
;

252 *
p
, *
s
;

253 
Ën
;

254 
by‹Ën
;

255 
sucûss
 = 0;

257 
p
 = 
r
->
buf
+r->
pos
;

258 
s
 = 
	`£ekNewlše
(
p
,
r
->
Ën
-r->
pos
);

259 ià(
s
 !ğ
NULL
) {

260 
p
 = 
r
->
buf
+r->
pos
;

261 
by‹Ën
 = 
s
-(
r
->
buf
+r->
pos
)+2;

262 
Ën
 = 
	`»adLÚgLÚg
(
p
);

264 ià(
Ën
 < 0) {

266 ià(
r
->
â
 &&„->â->
ü—‹N
)

267 
obj
 = 
r
->
â
->
	`ü—‹N
(
cur
);

269 
obj
 = (*)
REDIS_REPLY_NIL
;

270 
sucûss
 = 1;

273 
by‹Ën
 +ğ
Ën
+2;

274 ià(
r
->
pos
+
by‹Ën
 <ğr->
Ën
) {

275 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

276 
obj
 = 
r
->
â
->
	`ü—‹SŒšg
(
cur
,
s
+2,
Ën
);

278 
obj
 = (*)
REDIS_REPLY_STRING
;

279 
sucûss
 = 1;

284 ià(
sucûss
) {

285 ià(
obj
 =ğ
NULL
) {

286 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

287  
REDIS_ERR
;

290 
r
->
pos
 +ğ
by‹Ën
;

293 ià(
r
->
ridx
 =ğ0èr->
»¶y
 = 
obj
;

294 
	`moveToNextTask
(
r
);

295  
REDIS_OK
;

299  
REDIS_ERR
;

300 
	}
}

302 
	$´oûssMuÉiBulkI‹m
(
»disR—d”
 *
r
) {

303 
»disR—dTask
 *
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

304 *
obj
;

305 *
p
;

306 
–em’ts
;

307 
roÙ
 = 0;

310 ià(
r
->
ridx
 == 8) {

311 
	`__»disR—d”S‘E¼Ü
(
r
,
REDIS_ERR_PROTOCOL
,

313  
REDIS_ERR
;

316 ià((
p
 = 
	`»adLše
(
r
,
NULL
)) != NULL) {

317 
–em’ts
 = 
	`»adLÚgLÚg
(
p
);

318 
roÙ
 = (
r
->
ridx
 == 0);

320 ià(
–em’ts
 == -1) {

321 ià(
r
->
â
 &&„->â->
ü—‹N
)

322 
obj
 = 
r
->
â
->
	`ü—‹N
(
cur
);

324 
obj
 = (*)
REDIS_REPLY_NIL
;

326 ià(
obj
 =ğ
NULL
) {

327 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

328  
REDIS_ERR
;

331 
	`moveToNextTask
(
r
);

333 ià(
r
->
â
 &&„->â->
ü—‹A¼ay
)

334 
obj
 = 
r
->
â
->
	`ü—‹A¼ay
(
cur
,
–em’ts
);

336 
obj
 = (*)
REDIS_REPLY_ARRAY
;

338 ià(
obj
 =ğ
NULL
) {

339 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

340  
REDIS_ERR
;

344 ià(
–em’ts
 > 0) {

345 
cur
->
–em’ts
 =ƒlements;

346 
cur
->
obj
 = obj;

347 
r
->
ridx
++;

348 
r
->
r¡ack
[r->
ridx
].
ty³
 = -1;

349 
r
->
r¡ack
[r->
ridx
].
–em’ts
 = -1;

350 
r
->
r¡ack
[r->
ridx
].
idx
 = 0;

351 
r
->
r¡ack
[r->
ridx
].
obj
 = 
NULL
;

352 
r
->
r¡ack
[r->
ridx
].
·»Á
 = 
cur
;

353 
r
->
r¡ack
[r->
ridx
].
´ivd©a
 =„->privdata;

355 
	`moveToNextTask
(
r
);

360 ià(
roÙ
è
r
->
»¶y
 = 
obj
;

361  
REDIS_OK
;

364  
REDIS_ERR
;

365 
	}
}

367 
	$´oûssI‹m
(
»disR—d”
 *
r
) {

368 
»disR—dTask
 *
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

369 *
p
;

372 ià(
cur
->
ty³
 < 0) {

373 ià((
p
 = 
	`»adBy‹s
(
r
,1)è!ğ
NULL
) {

374 
p
[0]) {

376 
cur
->
ty³
 = 
REDIS_REPLY_ERROR
;

379 
cur
->
ty³
 = 
REDIS_REPLY_STATUS
;

382 
cur
->
ty³
 = 
REDIS_REPLY_INTEGER
;

385 
cur
->
ty³
 = 
REDIS_REPLY_STRING
;

388 
cur
->
ty³
 = 
REDIS_REPLY_ARRAY
;

391 
	`__»disR—d”S‘E¼ÜPrÙocŞBy‹
(
r
,*
p
);

392  
REDIS_ERR
;

396  
REDIS_ERR
;

401 
cur
->
ty³
) {

402 
REDIS_REPLY_ERROR
:

403 
REDIS_REPLY_STATUS
:

404 
REDIS_REPLY_INTEGER
:

405  
	`´oûssLšeI‹m
(
r
);

406 
REDIS_REPLY_STRING
:

407  
	`´oûssBulkI‹m
(
r
);

408 
REDIS_REPLY_ARRAY
:

409  
	`´oûssMuÉiBulkI‹m
(
r
);

411 
	`as£¹
(
NULL
);

412  
REDIS_ERR
;

414 
	}
}

416 
»disR—d”
 *
	$»disR—d”C»©eW™hFunùiÚs
(
»disR•lyObjeùFunùiÚs
 *
â
) {

417 
»disR—d”
 *
r
;

419 
r
 = 
	`ÿÎoc
((
»disR—d”
),1);

420 ià(
r
 =ğ
NULL
)

421  
NULL
;

423 
r
->
”r
 = 0;

424 
r
->
”r¡r
[0] = '\0';

425 
r
->
â
 = fn;

426 
r
->
buf
 = 
	`sd£m±y
();

427 
r
->
maxbuf
 = 
REDIS_READER_MAX_BUF
;

428 ià(
r
->
buf
 =ğ
NULL
) {

429 
	`ä“
(
r
);

430  
NULL
;

433 
r
->
ridx
 = -1;

434  
r
;

435 
	}
}

437 
	$»disR—d”F»e
(
»disR—d”
 *
r
) {

438 ià(
r
->
»¶y
 !ğ
NULL
 &&„->
â
 &&„->â->
ä“Objeù
)

439 
r
->
â
->
	`ä“Objeù
Ô->
»¶y
);

440 ià(
r
->
buf
 !ğ
NULL
)

441 
	`sdsä“
(
r
->
buf
);

442 
	`ä“
(
r
);

443 
	}
}

445 
	$»disR—d”F“d
(
»disR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

446 
sds
 
Ãwbuf
;

449 ià(
r
->
”r
)

450  
REDIS_ERR
;

453 ià(
buf
 !ğ
NULL
 && 
Ën
 >= 1) {

455 ià(
r
->
Ën
 =ğ0 &&„->
maxbuf
 !ğ0 && 
	`sd§va
Ô->
buf
) >„->maxbuf) {

456 
	`sdsä“
(
r
->
buf
);

457 
r
->
buf
 = 
	`sd£m±y
();

458 
r
->
pos
 = 0;

461 
	`as£¹
(
r
->
buf
 !ğ
NULL
);

464 
Ãwbuf
 = 
	`sdsÿ’
(
r
->
buf
,buf,
Ën
);

465 ià(
Ãwbuf
 =ğ
NULL
) {

466 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

467  
REDIS_ERR
;

470 
r
->
buf
 = 
Ãwbuf
;

471 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

474  
REDIS_OK
;

475 
	}
}

477 
	$»disR—d”G‘R•ly
(
»disR—d”
 *
r
, **
»¶y
) {

479 ià(
»¶y
 !ğ
NULL
)

480 *
»¶y
 = 
NULL
;

483 ià(
r
->
”r
)

484  
REDIS_ERR
;

487 ià(
r
->
Ën
 == 0)

488  
REDIS_OK
;

491 ià(
r
->
ridx
 == -1) {

492 
r
->
r¡ack
[0].
ty³
 = -1;

493 
r
->
r¡ack
[0].
–em’ts
 = -1;

494 
r
->
r¡ack
[0].
idx
 = -1;

495 
r
->
r¡ack
[0].
obj
 = 
NULL
;

496 
r
->
r¡ack
[0].
·»Á
 = 
NULL
;

497 
r
->
r¡ack
[0].
´ivd©a
 =„->privdata;

498 
r
->
ridx
 = 0;

502 
r
->
ridx
 >= 0)

503 ià(
	`´oûssI‹m
(
r
è!ğ
REDIS_OK
)

507 ià(
r
->
”r
)

508  
REDIS_ERR
;

512 ià(
r
->
pos
 >= 1024) {

513 
	`sd¤ªge
(
r
->
buf
,r->
pos
,-1);

514 
r
->
pos
 = 0;

515 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

519 ià(
r
->
ridx
 == -1) {

520 ià(
»¶y
 !ğ
NULL
)

521 *
»¶y
 = 
r
->reply;

522 
r
->
»¶y
 = 
NULL
;

524  
REDIS_OK
;

525 
	}
}

	@dep/hiredis-0.13.3/read.h

33 #iâdeà
__HIREDIS_READ_H


34 
	#__HIREDIS_READ_H


	)

35 
	~<¡dio.h
>

37 
	#REDIS_ERR
 -1

	)

38 
	#REDIS_OK
 0

	)

44 
	#REDIS_ERR_IO
 1

	)

45 
	#REDIS_ERR_EOF
 3

	)

46 
	#REDIS_ERR_PROTOCOL
 4

	)

47 
	#REDIS_ERR_OOM
 5

	)

48 
	#REDIS_ERR_OTHER
 2

	)

50 
	#REDIS_REPLY_STRING
 1

	)

51 
	#REDIS_REPLY_ARRAY
 2

	)

52 
	#REDIS_REPLY_INTEGER
 3

	)

53 
	#REDIS_REPLY_NIL
 4

	)

54 
	#REDIS_REPLY_STATUS
 5

	)

55 
	#REDIS_REPLY_ERROR
 6

	)

57 
	#REDIS_READER_MAX_BUF
 (1024*16è

	)

59 #ifdeà
__ılu¥lus


63 
	s»disR—dTask
 {

64 
ty³
;

65 
–em’ts
;

66 
idx
;

67 *
obj
;

68 
»disR—dTask
 *
·»Á
;

69 *
´ivd©a
;

70 } 
	t»disR—dTask
;

72 
	s»disR•lyObjeùFunùiÚs
 {

73 *(*
ü—‹SŒšg
)(cÚ¡ 
»disR—dTask
*, *, 
size_t
);

74 *(*
ü—‹A¼ay
)(cÚ¡ 
»disR—dTask
*, );

75 *(*
ü—‹IÁeg”
)(cÚ¡ 
»disR—dTask
*, );

76 *(*
ü—‹N
)(cÚ¡ 
»disR—dTask
*);

77 (*
ä“Objeù
)(*);

78 } 
	t»disR•lyObjeùFunùiÚs
;

80 
	s»disR—d”
 {

81 
”r
;

82 
”r¡r
[128];

84 *
buf
;

85 
size_t
 
pos
;

86 
size_t
 
Ën
;

87 
size_t
 
maxbuf
;

89 
»disR—dTask
 
r¡ack
[9];

90 
ridx
;

91 *
»¶y
;

93 
»disR•lyObjeùFunùiÚs
 *
â
;

94 *
´ivd©a
;

95 } 
	t»disR—d”
;

98 
»disR—d”
 *
»disR—d”C»©eW™hFunùiÚs
(
»disR•lyObjeùFunùiÚs
 *
â
);

99 
»disR—d”F»e
(
»disR—d”
 *
r
);

100 
»disR—d”F“d
(
»disR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

101 
»disR—d”G‘R•ly
(
»disR—d”
 *
r
, **
»¶y
);

104 
	#»disR•lyR—d”C»©e
 
»disR—d”C»©e


	)

105 
	#»disR•lyR—d”F»e
 
»disR—d”F»e


	)

106 
	#»disR•lyR—d”F“d
 
»disR—d”F“d


	)

107 
	#»disR•lyR—d”G‘R•ly
 
»disR—d”G‘R•ly


	)

108 
	#»disR•lyR—d”S‘Privd©a
(
_r
, 
_p
è()(((
»disR—d”
*)(_r))->
´ivd©a
 = (_p))

	)

109 
	#»disR•lyR—d”G‘Objeù
(
_r
è(((
»disR—d”
*)(_r))->
»¶y
)

	)

110 
	#»disR•lyR—d”G‘E¼Ü
(
_r
è(((
»disR—d”
*)(_r))->
”r¡r
)

	)

112 #ifdeà
__ılu¥lus


	@dep/hiredis-0.13.3/sds.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 
	~<ùy³.h
>

35 
	~<as£¹.h
>

37 
	~"sds.h
"

51 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

52 
sdshdr
 *
sh
;

54 ià(
š™
) {

55 
sh
 = 
	`m®loc
( *sh+
š™Ën
+1);

57 
sh
 = 
	`ÿÎoc
( *sh+
š™Ën
+1,1);

59 ià(
sh
 =ğ
NULL
)  NULL;

60 
sh
->
Ën
 = 
š™Ën
;

61 
sh
->
ä“
 = 0;

62 ià(
š™Ën
 && 
š™
)

63 
	`memıy
(
sh
->
buf
, 
š™
, 
š™Ën
);

64 
sh
->
buf
[
š™Ën
] = '\0';

65  (*)
sh
->
buf
;

66 
	}
}

70 
sds
 
	$sd£m±y
() {

71  
	`sd¢ewËn
("",0);

72 
	}
}

75 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

76 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

77  
	`sd¢ewËn
(
š™
, 
š™Ën
);

78 
	}
}

81 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

82  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

83 
	}
}

86 
	$sdsä“
(
sds
 
s
) {

87 ià(
s
 =ğ
NULL
) ;

88 
	`ä“
(
s
-(
sdshdr
));

89 
	}
}

105 
	$sdsupd©–’
(
sds
 
s
) {

106 
sdshdr
 *
sh
 = (*è(
s
- *sh);

107 
»®Ën
 = 
	`¡¾’
(
s
);

108 
sh
->
ä“
 +ğ(sh->
Ën
-
»®Ën
);

109 
sh
->
Ën
 = 
»®Ën
;

110 
	}
}

116 
	$sdsş—r
(
sds
 
s
) {

117 
sdshdr
 *
sh
 = (*è(
s
- *sh);

118 
sh
->
ä“
 +ğsh->
Ën
;

119 
sh
->
Ën
 = 0;

120 
sh
->
buf
[0] = '\0';

121 
	}
}

129 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

130 
sdshdr
 *
sh
, *
Ãwsh
;

131 
size_t
 
ä“
 = 
	`sd§va
(
s
);

132 
size_t
 
Ën
, 
ÃwËn
;

134 ià(
ä“
 >ğ
addËn
è 
s
;

135 
Ën
 = 
	`sd¦’
(
s
);

136 
sh
 = (*è(
s
- *sh);

137 
ÃwËn
 = (
Ën
+
addËn
);

138 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

139 
ÃwËn
 *= 2;

141 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

142 
Ãwsh
 = 
	`»®loc
(
sh
,  *Ãwsh+
ÃwËn
+1);

143 ià(
Ãwsh
 =ğ
NULL
)  NULL;

145 
Ãwsh
->
ä“
 = 
ÃwËn
 - 
Ën
;

146  
Ãwsh
->
buf
;

147 
	}
}

155 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

156 
sdshdr
 *
sh
;

158 
sh
 = (*è(
s
- *sh);

159 
sh
 = 
	`»®loc
(sh,  *sh+sh->
Ën
+1);

160 
sh
->
ä“
 = 0;

161  
sh
->
buf
;

162 
	}
}

171 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

172 
sdshdr
 *
sh
 = (*è(
s
- *sh);

174  (*
sh
)+sh->
Ën
+sh->
ä“
+1;

175 
	}
}

200 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

201 
sdshdr
 *
sh
 = (*è(
s
- *sh);

203 
	`as£¹
(
sh
->
ä“
 >ğ
šü
);

204 
sh
->
Ën
 +ğ
šü
;

205 
sh
->
ä“
 -ğ
šü
;

206 
	`as£¹
(
sh
->
ä“
 >= 0);

207 
s
[
sh
->
Ën
] = '\0';

208 
	}
}

215 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

216 
sdshdr
 *
sh
 = (*è(
s
- *sh);

217 
size_t
 
tÙËn
, 
cu¾’
 = 
sh
->
Ën
;

219 ià(
Ën
 <ğ
cu¾’
è 
s
;

220 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

221 ià(
s
 =ğ
NULL
)  NULL;

224 
sh
 = (*)(
s
- *sh);

225 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

226 
tÙËn
 = 
sh
->
Ën
+sh->
ä“
;

227 
sh
->
Ën
 =†en;

228 
sh
->
ä“
 = 
tÙËn
-sh->
Ën
;

229  
s
;

230 
	}
}

237 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

238 
sdshdr
 *
sh
;

239 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

241 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

242 ià(
s
 =ğ
NULL
)  NULL;

243 
sh
 = (*è(
s
- *sh);

244 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

245 
sh
->
Ën
 = 
cu¾’
+len;

246 
sh
->
ä“
 = sh->ä“-
Ën
;

247 
s
[
cu¾’
+
Ën
] = '\0';

248  
s
;

249 
	}
}

255 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

256  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

257 
	}
}

263 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

264  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

265 
	}
}

269 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

270 
sdshdr
 *
sh
 = (*è(
s
- *sh);

271 
size_t
 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

273 ià(
tÙËn
 < 
Ën
) {

274 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
sh
->len);

275 ià(
s
 =ğ
NULL
)  NULL;

276 
sh
 = (*è(
s
- *sh);

277 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

279 
	`memıy
(
s
, 
t
, 
Ën
);

280 
s
[
Ën
] = '\0';

281 
sh
->
Ën
 =†en;

282 
sh
->
ä“
 = 
tÙËn
-
Ën
;

283  
s
;

284 
	}
}

288 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

289  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

290 
	}
}

298 
	#SDS_LLSTR_SIZE
 21

	)

299 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

300 *
p
, 
aux
;

301 
v
;

302 
size_t
 
l
;

306 
v
 = (
v®ue
 < 0) ? -value : value;

307 
p
 = 
s
;

309 *
p
++ = '0'+(
v
%10);

310 
v
 /= 10;

311 } 
v
);

312 ià(
v®ue
 < 0è*
p
++ = '-';

315 
l
 = 
p
-
s
;

316 *
p
 = '\0';

319 
p
--;

320 
s
 < 
p
) {

321 
aux
 = *
s
;

322 *
s
 = *
p
;

323 *
p
 = 
aux
;

324 
s
++;

325 
p
--;

327  
l
;

328 
	}
}

331 
	$sdsuÎ2¡r
(*
s
, 
v
) {

332 *
p
, 
aux
;

333 
size_t
 
l
;

337 
p
 = 
s
;

339 *
p
++ = '0'+(
v
%10);

340 
v
 /= 10;

341 } 
v
);

344 
l
 = 
p
-
s
;

345 *
p
 = '\0';

348 
p
--;

349 
s
 < 
p
) {

350 
aux
 = *
s
;

351 *
s
 = *
p
;

352 *
p
 = 
aux
;

353 
s
++;

354 
p
--;

356  
l
;

357 
	}
}

360 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

361 
va_li¡
 
ıy
;

362 *
buf
, *
t
;

363 
size_t
 
buæ’
 = 16;

366 
buf
 = 
	`m®loc
(
buæ’
);

367 ià(
buf
 =ğ
NULL
)  NULL;

368 
buf
[
buæ’
-2] = '\0';

369 
	`va_cİy
(
ıy
,
­
);

370 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

371 ià(
buf
[
buæ’
-2] != '\0') {

372 
	`ä“
(
buf
);

373 
buæ’
 *= 2;

378 
t
 = 
	`sdsÿt
(
s
, 
buf
);

379 
	`ä“
(
buf
);

380  
t
;

381 
	}
}

399 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

400 
va_li¡
 
­
;

401 *
t
;

402 
	`va_¡¬t
(
­
, 
fmt
);

403 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

404 
	`va_’d
(
­
);

405  
t
;

406 
	}
}

425 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

426 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

427 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

428 cÚ¡ *
f
 = 
fmt
;

429 
i
;

430 
va_li¡
 
­
;

432 
	`va_¡¬t
(
­
,
fmt
);

433 
f
 = 
fmt
;

434 
i
 = 
š™Ën
;

435 *
f
) {

436 
Ãxt
, *
¡r
;

437 
l
;

438 
num
;

439 
unum
;

442 ià(
sh
->
ä“
 == 0) {

443 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

444 
sh
 = (*è(
s
-((
sdshdr
)));

447 *
f
) {

449 
Ãxt
 = *(
f
+1);

450 
f
++;

451 
Ãxt
) {

454 
¡r
 = 
	`va_¬g
(
­
,*);

455 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

456 ià(
sh
->
ä“
 < 
l
) {

457 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

458 
sh
 = (*è(
s
-((
sdshdr
)));

460 
	`memıy
(
s
+
i
,
¡r
,
l
);

461 
sh
->
Ën
 +ğ
l
;

462 
sh
->
ä“
 -ğ
l
;

463 
i
 +ğ
l
;

467 ià(
Ãxt
 == 'i')

468 
num
 = 
	`va_¬g
(
­
,);

470 
num
 = 
	`va_¬g
(
­
,);

472 
buf
[
SDS_LLSTR_SIZE
];

473 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

474 ià(
sh
->
ä“
 < 
l
) {

475 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

476 
sh
 = (*è(
s
-((
sdshdr
)));

478 
	`memıy
(
s
+
i
,
buf
,
l
);

479 
sh
->
Ën
 +ğ
l
;

480 
sh
->
ä“
 -ğ
l
;

481 
i
 +ğ
l
;

487 ià(
Ãxt
 == 'u')

488 
unum
 = 
	`va_¬g
(
­
,);

489 if(
Ãxt
 == 'U')

490 
unum
 = 
	`va_¬g
(
­
,);

492 
unum
 = ()
	`va_¬g
(
­
,
size_t
);

494 
buf
[
SDS_LLSTR_SIZE
];

495 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

496 ià(
sh
->
ä“
 < 
l
) {

497 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

498 
sh
 = (*è(
s
-((
sdshdr
)));

500 
	`memıy
(
s
+
i
,
buf
,
l
);

501 
sh
->
Ën
 +ğ
l
;

502 
sh
->
ä“
 -ğ
l
;

503 
i
 +ğ
l
;

507 
s
[
i
++] = 
Ãxt
;

508 
sh
->
Ën
 += 1;

509 
sh
->
ä“
 -= 1;

514 
s
[
i
++] = *
f
;

515 
sh
->
Ën
 += 1;

516 
sh
->
ä“
 -= 1;

519 
f
++;

521 
	`va_’d
(
­
);

524 
s
[
i
] = '\0';

525  
s
;

526 
	}
}

543 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

544 
sdshdr
 *
sh
 = (*è(
s
- *sh);

545 *
¡¬t
, *
’d
, *
¥
, *
•
;

546 
size_t
 
Ën
;

548 
¥
 = 
¡¬t
 = 
s
;

549 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

550 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

551 
•
 > 
¡¬t
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

552 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

553 ià(
sh
->
buf
 !ğ
¥
è
	`memmove
(sh->buf, sp, 
Ën
);

554 
sh
->
buf
[
Ën
] = '\0';

555 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-len);

556 
sh
->
Ën
 =†en;

557 
	}
}

575 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

576 
sdshdr
 *
sh
 = (*è(
s
- *sh);

577 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

579 ià(
Ën
 == 0) ;

580 ià(
¡¬t
 < 0) {

581 
¡¬t
 = 
Ën
+start;

582 ià(
¡¬t
 < 0) start = 0;

584 ià(
’d
 < 0) {

585 
’d
 = 
Ën
+end;

586 ià(
’d
 < 0)ƒnd = 0;

588 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

589 ià(
ÃwËn
 != 0) {

590 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

591 
ÃwËn
 = 0;

592 } ià(
’d
 >ğ(sigÃd)
Ën
) {

593 
’d
 = 
Ën
-1;

594 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

597 
¡¬t
 = 0;

599 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
sh
->
buf
, sh->buf+start,‚ewlen);

600 
sh
->
buf
[
ÃwËn
] = 0;

601 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-
ÃwËn
);

602 
sh
->
Ën
 = 
ÃwËn
;

603 
	}
}

606 
	$sd¡Şow”
(
sds
 
s
) {

607 
Ën
 = 
	`sd¦’
(
s
), 
j
;

609 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

610 
	}
}

613 
	$sd¡ouµ”
(
sds
 
s
) {

614 
Ën
 = 
	`sd¦’
(
s
), 
j
;

616 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

617 
	}
}

630 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

631 
size_t
 
l1
, 
l2
, 
mšËn
;

632 
cmp
;

634 
l1
 = 
	`sd¦’
(
s1
);

635 
l2
 = 
	`sd¦’
(
s2
);

636 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

637 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

638 ià(
cmp
 =ğ0è 
l1
-
l2
;

639  
cmp
;

640 
	}
}

658 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

659 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

660 
sds
 *
tok’s
;

662 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

664 
tok’s
 = 
	`m®loc
((
sds
)*
¦Ùs
);

665 ià(
tok’s
 =ğ
NULL
)  NULL;

667 ià(
Ën
 == 0) {

668 *
couÁ
 = 0;

669  
tok’s
;

671 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

673 ià(
¦Ùs
 < 
–em’ts
+2) {

674 
sds
 *
Ãwtok’s
;

676 
¦Ùs
 *= 2;

677 
Ãwtok’s
 = 
	`»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

678 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

679 
tok’s
 = 
Ãwtok’s
;

682 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

683 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

684 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

685 
–em’ts
++;

686 
¡¬t
 = 
j
+
£¶’
;

687 
j
 = j+
£¶’
-1;

691 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

692 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

693 
–em’ts
++;

694 *
couÁ
 = 
–em’ts
;

695  
tok’s
;

697 
ş—nup
:

699 
i
;

700 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

701 
	`ä“
(
tok’s
);

702 *
couÁ
 = 0;

703  
NULL
;

705 
	}
}

708 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

709 ià(!
tok’s
) ;

710 
couÁ
--)

711 
	`sdsä“
(
tok’s
[
couÁ
]);

712 
	`ä“
(
tok’s
);

713 
	}
}

719 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

720 
buf
[32], *
p
;

721 
v
;

723 
v
 = (
v®ue
 < 0) ? -value : value;

724 
p
 = 
buf
+31;

726 *
p
-- = '0'+(
v
%10);

727 
v
 /= 10;

728 } 
v
);

729 ià(
v®ue
 < 0è*
p
-- = '-';

730 
p
++;

731  
	`sd¢ewËn
(
p
,32-Õ-
buf
));

732 
	}
}

740 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

741 
s
 = 
	`sdsÿ’
(s,"\"",1);

742 
Ën
--) {

743 *
p
) {

746 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

748 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

749 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

750 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

751 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

752 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

754 ià(
	`i¥ršt
(*
p
))

755 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

757 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

760 
p
++;

762  
	`sdsÿ’
(
s
,"\"",1);

763 
	}
}

767 
	$is_hex_dig™
(
c
) {

768  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

769 (
c
 >= 'A' && c <= 'F');

770 
	}
}

774 
	$hex_dig™_to_št
(
c
) {

775 
c
) {

794 
	}
}

815 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

816 cÚ¡ *
p
 = 
lše
;

817 *
cu¼’t
 = 
NULL
;

818 **
veùÜ
 = 
NULL
;

820 *
¬gc
 = 0;

823 *
p
 && 
	`is¥aû
(*p))…++;

824 ià(*
p
) {

826 
šq
=0;

827 
šsq
=0;

828 
dÚe
=0;

830 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

831 !
dÚe
) {

832 ià(
šq
) {

833 ià(*
p
 == '\\' && *(p+1) == 'x' &&

834 
	`is_hex_dig™
(*(
p
+2)) &&

835 
	`is_hex_dig™
(*(
p
+3)))

837 
by‹
;

839 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

840 
	`hex_dig™_to_št
(*(
p
+3));

841 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

842 
p
 += 3;

843 } ià(*
p
 == '\\' && *(p+1)) {

844 
c
;

846 
p
++;

847 *
p
) {

848 'n': 
c
 = '\n'; ;

849 'r': 
c
 = '\r'; ;

850 't': 
c
 = '\t'; ;

851 'b': 
c
 = '\b'; ;

852 'a': 
c
 = '\a'; ;

853 : 
c
 = *
p
; ;

855 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

856 } ià(*
p
 == '"') {

859 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

860 
dÚe
=1;

861 } ià(!*
p
) {

863 
”r
;

865 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

867 } ià(
šsq
) {

868 ià(*
p
 == '\\' && *(p+1) == '\'') {

869 
p
++;

870 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

871 } ià(*
p
 == '\'') {

874 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

875 
dÚe
=1;

876 } ià(!*
p
) {

878 
”r
;

880 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

883 *
p
) {

889 
dÚe
=1;

892 
šq
=1;

895 
šsq
=1;

898 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

902 ià(*
p
)…++;

905 
veùÜ
 = 
	`»®loc
(veùÜ,((*
¬gc
)+1)*(*));

906 
veùÜ
[*
¬gc
] = 
cu¼’t
;

907 (*
¬gc
)++;

908 
cu¼’t
 = 
NULL
;

911 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`m®loc
((*));

912  
veùÜ
;

916 
”r
:

917 (*
¬gc
)--)

918 
	`sdsä“
(
veùÜ
[*
¬gc
]);

919 
	`ä“
(
veùÜ
);

920 ià(
cu¼’t
è
	`sdsä“
(current);

921 *
¬gc
 = 0;

922  
NULL
;

923 
	}
}

934 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

935 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

937 
j
 = 0; j < 
l
; j++) {

938 
i
 = 0; i < 
£’
; i++) {

939 ià(
s
[
j
] =ğ
äom
[
i
]) {

940 
s
[
j
] = 
to
[
i
];

945  
s
;

946 
	}
}

950 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
, 
size_t
 
£¶’
) {

951 
sds
 
još
 = 
	`sd£m±y
();

952 
j
;

954 
j
 = 0; j < 
¬gc
; j++) {

955 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

956 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

958  
još
;

959 
	}
}

962 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

963 
sds
 
još
 = 
	`sd£m±y
();

964 
j
;

966 
j
 = 0; j < 
¬gc
; j++) {

967 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

968 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

970  
još
;

971 
	}
}

973 #ifdeà
SDS_TEST_MAIN


974 
	~<¡dio.h
>

975 
	~"‹¡h–p.h
"

977 
	$maš
() {

979 
sdshdr
 *
sh
;

980 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

982 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

983 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

985 
	`sdsä“
(
x
);

986 
x
 = 
	`sd¢ewËn
("foo",2);

987 
	`‹¡_cÚd
("Create‡ string with specified†ength",

988 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

990 
x
 = 
	`sdsÿt
(x,"bar");

991 
	`‹¡_cÚd
("Strings concatenation",

992 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

994 
x
 = 
	`sdsıy
(x,"a");

995 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

996 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

998 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

999 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1000 
	`sd¦’
(
x
) == 33 &&

1001 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1003 
	`sdsä“
(
x
);

1004 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1005 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1006 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) ==0)

1008 
	`sdsä“
(
x
);

1009 
x
 = 
	`sd¢ew
("xxciaoyyy");

1010 
	`sd¡rim
(
x
,"xy");

1011 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1012 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1014 
y
 = 
	`sdsdup
(
x
);

1015 
	`sd¤ªge
(
y
,1,1);

1016 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1017 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1019 
	`sdsä“
(
y
);

1020 
y
 = 
	`sdsdup
(
x
);

1021 
	`sd¤ªge
(
y
,1,-1);

1022 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1023 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1025 
	`sdsä“
(
y
);

1026 
y
 = 
	`sdsdup
(
x
);

1027 
	`sd¤ªge
(
y
,-2,-1);

1028 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1029 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1031 
	`sdsä“
(
y
);

1032 
y
 = 
	`sdsdup
(
x
);

1033 
	`sd¤ªge
(
y
,2,1);

1034 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1035 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1037 
	`sdsä“
(
y
);

1038 
y
 = 
	`sdsdup
(
x
);

1039 
	`sd¤ªge
(
y
,1,100);

1040 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1041 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1043 
	`sdsä“
(
y
);

1044 
y
 = 
	`sdsdup
(
x
);

1045 
	`sd¤ªge
(
y
,100,100);

1046 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1047 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1049 
	`sdsä“
(
y
);

1050 
	`sdsä“
(
x
);

1051 
x
 = 
	`sd¢ew
("foo");

1052 
y
 = 
	`sd¢ew
("foa");

1053 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1055 
	`sdsä“
(
y
);

1056 
	`sdsä“
(
x
);

1057 
x
 = 
	`sd¢ew
("bar");

1058 
y
 = 
	`sd¢ew
("bar");

1059 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1061 
	`sdsä“
(
y
);

1062 
	`sdsä“
(
x
);

1063 
x
 = 
	`sd¢ew
("aar");

1064 
y
 = 
	`sd¢ew
("bar");

1065 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1067 
	`sdsä“
(
y
);

1068 
	`sdsä“
(
x
);

1069 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1070 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1071 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1072 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1075 
Şdä“
;

1077 
	`sdsä“
(
x
);

1078 
x
 = 
	`sd¢ew
("0");

1079 
sh
 = (*è(
x
-((
sdshdr
)));

1080 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
sh
->
Ën
 =ğ1 && sh->
ä“
 == 0);

1081 
x
 = 
	`sdsMakeRoomFÜ
(x,1);

1082 
sh
 = (*è(
x
-((
sdshdr
)));

1083 
	`‹¡_cÚd
("sdsMakeRoomFÜ()", 
sh
->
Ën
 =ğ1 && sh->
ä“
 > 0);

1084 
Şdä“
 = 
sh
->
ä“
;

1085 
x
[1] = '1';

1086 
	`sdsInüL’
(
x
,1);

1087 
	`‹¡_cÚd
("sdsInüL’(è-- cÚ‹Á", 
x
[0] == '0' && x[1] == '1');

1088 
	`‹¡_cÚd
("sdsInüL’(è--†’", 
sh
->
Ën
 == 2);

1089 
	`‹¡_cÚd
("sdsInüL’(è-- f»e", 
sh
->
ä“
 =ğ
Şdä“
-1);

1092 
	`‹¡_»pÜt
()

1094 
	}
}

	@dep/hiredis-0.13.3/sds.h

31 #iâdeà
__SDS_H


32 
	#__SDS_H


	)

34 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

36 
	~<sys/ty³s.h
>

37 
	~<¡d¬g.h
>

38 #ifdeà
_MSC_VER


39 
	~"wš32.h
"

42 *
	tsds
;

44 
	ssdshdr
 {

45 
	mËn
;

46 
	mä“
;

47 
	mbuf
[];

50 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

51 
sdshdr
 *
sh
 = (sdshd¸*)(
s
- *sh);

52  
sh
->
Ën
;

53 
	}
}

55 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

56 
sdshdr
 *
sh
 = (sdshd¸*)(
s
- *sh);

57  
sh
->
ä“
;

58 
	}
}

60 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

61 
sds
 
sd¢ew
(cÚ¡ *
š™
);

62 
sds
 
sd£m±y
();

63 
size_t
 
sd¦’
(cÚ¡ 
sds
 
s
);

64 
sds
 
sdsdup
(cÚ¡ sd 
s
);

65 
sdsä“
(
sds
 
s
);

66 
size_t
 
sd§va
(cÚ¡ 
sds
 
s
);

67 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

68 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

69 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

70 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

71 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

72 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

74 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

75 #ifdeà
__GNUC__


76 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

77 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

79 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

82 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

83 
	`sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
);

84 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

85 
	`sdsupd©–’
(
sds
 
s
);

86 
	`sdsş—r
(
sds
 
s
);

87 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

88 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

89 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

90 
	`sd¡Şow”
(
sds
 
s
);

91 
	`sd¡ouµ”
(
sds
 
s
);

92 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

93 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

94 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

95 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

96 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
, 
size_t
 
£¶’
);

97 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

100 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

101 
	`sdsInüL’
(
sds
 
s
, 
šü
);

102 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

103 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

	@dep/hiredis-0.13.3/test.c

1 
	~"fmaüos.h
"

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~<¡ršg.h
>

5 
	~<¡ršgs.h
>

6 
	~<sys/time.h
>

7 
	~<as£¹.h
>

8 
	~<uni¡d.h
>

9 
	~<sigÇl.h
>

10 
	~<”ºo.h
>

11 
	~<lim™s.h
>

13 
	~"hœedis.h
"

14 
	~"Ãt.h
"

16 
	ecÚÃùiÚ_ty³
 {

17 
	mCONN_TCP
,

18 
	mCONN_UNIX
,

19 
	mCONN_FD


22 
	scÚfig
 {

23 
cÚÃùiÚ_ty³
 
	mty³
;

26 cÚ¡ *
	mho¡
;

27 
	mpÜt
;

28 
timev®
 
	mtimeout
;

29 } 
	mtı
;

32 cÚ¡ *
	m·th
;

33 } 
	munix
;

37 
	g‹¡s
 = 0, 
	gçs
 = 0;

38 
	#‹¡
(
_s
è{ 
	`´štf
("#%02d ", ++
‹¡s
);…rštf(_s); }

	)

39 
	#‹¡_cÚd
(
_c
èif(_cè
	`´štf
("\033[0;32mPASSED\033[0;0m\n"); {´štf("\033[0;31mFAILED\033[0;0m\n"); 
çs
++;}

	)

41 
	$u£c
() {

42 
timev®
 
tv
;

43 
	`g‘timeofday
(&
tv
,
NULL
);

44  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

45 
	}
}

49 #ifdeà
NDEBUG


50 #undeà
as£¹


51 
	#as£¹
(
e
è()Ó)

	)

54 
»disCÚ‹xt
 *
	$£Ëù_d©aba£
(
»disCÚ‹xt
 *
c
) {

55 
»disR•ly
 *
»¶y
;

58 
»¶y
 = 
	`»disCommªd
(
c
,"SELECT 9");

59 
	`as£¹
(
»¶y
 !ğ
NULL
);

60 
	`ä“R•lyObjeù
(
»¶y
);

63 
»¶y
 = 
	`»disCommªd
(
c
,"DBSIZE");

64 
	`as£¹
(
»¶y
 !ğ
NULL
);

65 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&„•ly->
š‹g”
 == 0) {

67 
	`ä“R•lyObjeù
(
»¶y
);

69 
	`´štf
("Database #9 is‚otƒmpty,est can‚ot continue\n");

70 
	`ex™
(1);

73  
c
;

74 
	}
}

76 
	$discÚÃù
(
»disCÚ‹xt
 *
c
, 
k“p_fd
) {

77 
»disR•ly
 *
»¶y
;

80 
»¶y
 = 
	`»disCommªd
(
c
,"SELECT 9");

81 
	`as£¹
(
»¶y
 !ğ
NULL
);

82 
	`ä“R•lyObjeù
(
»¶y
);

83 
»¶y
 = 
	`»disCommªd
(
c
,"FLUSHDB");

84 
	`as£¹
(
»¶y
 !ğ
NULL
);

85 
	`ä“R•lyObjeù
(
»¶y
);

88 ià(
k“p_fd
)

89  
	`»disF»eK“pFd
(
c
);

90 
	`»disF»e
(
c
);

92 
	}
}

94 
»disCÚ‹xt
 *
	$cÚÃù
(
cÚfig
 config) {

95 
»disCÚ‹xt
 *
c
 = 
NULL
;

97 ià(
cÚfig
.
ty³
 =ğ
CONN_TCP
) {

98 
c
 = 
	`»disCÚÃù
(
cÚfig
.
tı
.
ho¡
, cÚfig.tı.
pÜt
);

99 } ià(
cÚfig
.
ty³
 =ğ
CONN_UNIX
) {

100 
c
 = 
	`»disCÚÃùUnix
(
cÚfig
.
unix
.
·th
);

101 } ià(
cÚfig
.
ty³
 =ğ
CONN_FD
) {

103 
»disCÚ‹xt
 *
dummy_ùx
 = 
	`»disCÚÃùUnix
(
cÚfig
.
unix
.
·th
);

104 ià(
dummy_ùx
) {

105 
fd
 = 
	`discÚÃù
(
dummy_ùx
, 1);

106 
	`´štf
("CÚÃùšgØšh”™ed fd %d\n", 
fd
);

107 
c
 = 
	`»disCÚÃùFd
(
fd
);

110 
	`as£¹
(
NULL
);

113 ià(
c
 =ğ
NULL
) {

114 
	`´štf
("Connectionƒrror: can't‡llocate„edis context\n");

115 
	`ex™
(1);

116 } ià(
c
->
”r
) {

117 
	`´štf
("CÚÃùiÚƒ¼Ü: %s\n", 
c
->
”r¡r
);

118 
	`»disF»e
(
c
);

119 
	`ex™
(1);

122  
	`£Ëù_d©aba£
(
c
);

123 
	}
}

125 
	$‹¡_fÜm©_commªds
() {

126 *
cmd
;

127 
Ën
;

129 
	`‹¡
("Format command without interpolation: ");

130 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET foo bar");

131 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

132 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(3+2));

133 
	`ä“
(
cmd
);

135 
	`‹¡
("Format command with %%s string interpolation: ");

136 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %s %s","foo","bar");

137 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

138 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(3+2));

139 
	`ä“
(
cmd
);

141 
	`‹¡
("Format command with %%s‡nd‡nƒmpty string: ");

142 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %s %s","foo","");

143 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$0\r\n\r\n",
Ën
) == 0 &&

144 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(0+2));

145 
	`ä“
(
cmd
);

147 
	`‹¡
("Format command with‡nƒmpty string in between…roper interpolations: ");

148 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %s %s","","foo");

149 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$0\r\n\r\n$3\r\nfoo\r\n",
Ën
) == 0 &&

150 
Ën
 == 4+4+(3+2)+4+(0+2)+4+(3+2));

151 
	`ä“
(
cmd
);

153 
	`‹¡
("Format command with %%b string interpolation: ");

154 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %b %b","foo",(
size_t
)3,"b\0r",(size_t)3);

155 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3\r\nb\0r\r\n",
Ën
) == 0 &&

156 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(3+2));

157 
	`ä“
(
cmd
);

159 
	`‹¡
("Format command with %%b‡nd‡nƒmpty string: ");

160 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %b %b","foo",(
size_t
)3,"",(size_t)0);

161 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$0\r\n\r\n",
Ën
) == 0 &&

162 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(0+2));

163 
	`ä“
(
cmd
);

165 
	`‹¡
("Format command with†iteral %%: ");

166 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %% %%");

167 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$1\r\n%\r\n$1\r\n%\r\n",
Ën
) == 0 &&

168 
Ën
 == 4+4+(3+2)+4+(1+2)+4+(1+2));

169 
	`ä“
(
cmd
);

174 
	#INTEGER_WIDTH_TEST
(
fmt
, 
ty³
) do { \

175 
ty³
 
v®ue
 = 123; \

176 
	`‹¡
("Format command with…rintf-delegation (" #type "): "); \

177 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"key:%08" 
fmt
 " sŒ:%s", 
v®ue
, "hello"); \

178 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*2\r\n$12\r\nkey:00000123\r\n$9\r\n¡r:h–lo\r\n",
Ën
) == 0 && \

179 
Ën
 == 4+5+(12+2)+4+(9+2)); \

180 
	`ä“
(
cmd
); \

181 } 0)

	)

183 
	#FLOAT_WIDTH_TEST
(
ty³
) do { \

184 
ty³
 
v®ue
 = 123.0; \

185 
	`‹¡
("Format command with…rintf-delegation (" #type "): "); \

186 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"key:%08.3à¡r:%s", 
v®ue
, "hello"); \

187 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*2\r\n$12\r\nkey:0123.000\r\n$9\r\n¡r:h–lo\r\n",
Ën
) == 0 && \

188 
Ën
 == 4+5+(12+2)+4+(9+2)); \

189 
	`ä“
(
cmd
); \

190 } 0)

	)

192 
	`INTEGER_WIDTH_TEST
("d", );

193 
	`INTEGER_WIDTH_TEST
("hhd", );

194 
	`INTEGER_WIDTH_TEST
("hd", );

195 
	`INTEGER_WIDTH_TEST
("ld", );

196 
	`INTEGER_WIDTH_TEST
("lld", );

197 
	`INTEGER_WIDTH_TEST
("u", );

198 
	`INTEGER_WIDTH_TEST
("hhu", );

199 
	`INTEGER_WIDTH_TEST
("hu", );

200 
	`INTEGER_WIDTH_TEST
("lu", );

201 
	`INTEGER_WIDTH_TEST
("llu", );

202 
	`FLOAT_WIDTH_TEST
();

203 
	`FLOAT_WIDTH_TEST
();

205 
	`‹¡
("Format command with invalid…rintf format: ");

206 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"key:%08°%b",(*)1234,"foo",(
size_t
)3);

207 
	`‹¡_cÚd
(
Ën
 == -1);

209 cÚ¡ *
¬gv
[3];

210 
¬gv
[0] = "SET";

211 
¬gv
[1] = "foo\0xxx";

212 
¬gv
[2] = "bar";

213 
size_t
 
Ëns
[3] = { 3, 7, 3 };

214 
¬gc
 = 3;

216 
	`‹¡
("Format command by…assing‡rgc/argv without†engths: ");

217 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

218 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

219 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(3+2));

220 
	`ä“
(
cmd
);

222 
	`‹¡
("Format command by…assing‡rgc/argv with†engths: ");

223 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
Ëns
);

224 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$7\r\nfoo\0xxx\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

225 
Ën
 == 4+4+(3+2)+4+(7+2)+4+(3+2));

226 
	`ä“
(
cmd
);

227 
	}
}

229 
	$‹¡_­³nd_fÜm©‹d_commªds
(
cÚfig
 config) {

230 
»disCÚ‹xt
 *
c
;

231 
»disR•ly
 *
»¶y
;

232 *
cmd
;

233 
Ën
;

235 
c
 = 
	`cÚÃù
(
cÚfig
);

237 
	`‹¡
("Append format command: ");

239 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
, "SET foo bar");

241 
	`‹¡_cÚd
(
	`»disAµ’dFÜm©‹dCommªd
(
c
, 
cmd
, 
Ën
è=ğ
REDIS_OK
);

243 
	`as£¹
(
	`»disG‘R•ly
(
c
, (*)&
»¶y
è=ğ
REDIS_OK
);

245 
	`ä“
(
cmd
);

246 
	`ä“R•lyObjeù
(
»¶y
);

248 
	`discÚÃù
(
c
, 0);

249 
	}
}

251 
	$‹¡_»¶y_»ad”
() {

252 
»disR—d”
 *
»ad”
;

253 *
»¶y
;

254 
»t
;

255 
i
;

257 
	`‹¡
("Error handling in„eply…arser: ");

258 
»ad”
 = 
	`»disR—d”C»©e
();

259 
	`»disR—d”F“d
(
»ad”
,(*)"@foo\r\n",6);

260 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,
NULL
);

261 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_ERR
 &&

262 
	`¡rÿ£cmp
(
»ad”
->
”r¡r
,"Protocolƒrror, got \"@\"‡s„eplyype byte") == 0);

263 
	`»disR—d”F»e
(
»ad”
);

267 
	`‹¡
("Memory cleanup in„eply…arser: ");

268 
»ad”
 = 
	`»disR—d”C»©e
();

269 
	`»disR—d”F“d
(
»ad”
,(*)"*2\r\n",4);

270 
	`»disR—d”F“d
(
»ad”
,(*)"$5\r\nhello\r\n",11);

271 
	`»disR—d”F“d
(
»ad”
,(*)"@foo\r\n",6);

272 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,
NULL
);

273 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_ERR
 &&

274 
	`¡rÿ£cmp
(
»ad”
->
”r¡r
,"Protocolƒrror, got \"@\"‡s„eplyype byte") == 0);

275 
	`»disR—d”F»e
(
»ad”
);

277 
	`‹¡
("Setƒrror on‚ested multi bulks with depth > 7: ");

278 
»ad”
 = 
	`»disR—d”C»©e
();

280 
i
 = 0; i < 9; i++) {

281 
	`»disR—d”F“d
(
»ad”
,(*)"*1\r\n",4);

284 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,
NULL
);

285 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_ERR
 &&

286 
	`¡ºÿ£cmp
(
»ad”
->
”r¡r
,"No support for",14) == 0);

287 
	`»disR—d”F»e
(
»ad”
);

289 
	`‹¡
("Works with NULL functions for„eply: ");

290 
»ad”
 = 
	`»disR—d”C»©e
();

291 
»ad”
->
â
 = 
NULL
;

292 
	`»disR—d”F“d
(
»ad”
,(*)"+OK\r\n",5);

293 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

294 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_OK
 && 
»¶y
 =ğ(*)
REDIS_REPLY_STATUS
);

295 
	`»disR—d”F»e
(
»ad”
);

297 
	`‹¡
("Works when‡ single‚ewline (\\r\\n) coverswo callso feed: ");

298 
»ad”
 = 
	`»disR—d”C»©e
();

299 
»ad”
->
â
 = 
NULL
;

300 
	`»disR—d”F“d
(
»ad”
,(*)"+OK\r",4);

301 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

302 
	`as£¹
(
»t
 =ğ
REDIS_OK
 && 
»¶y
 =ğ
NULL
);

303 
	`»disR—d”F“d
(
»ad”
,(*)"\n",1);

304 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

305 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_OK
 && 
»¶y
 =ğ(*)
REDIS_REPLY_STATUS
);

306 
	`»disR—d”F»e
(
»ad”
);

308 
	`‹¡
("Don't„eset state‡fter…rotocolƒrror: ");

309 
»ad”
 = 
	`»disR—d”C»©e
();

310 
»ad”
->
â
 = 
NULL
;

311 
	`»disR—d”F“d
(
»ad”
,(*)"x",1);

312 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

313 
	`as£¹
(
»t
 =ğ
REDIS_ERR
);

314 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

315 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_ERR
 && 
»¶y
 =ğ
NULL
);

316 
	`»disR—d”F»e
(
»ad”
);

319 
	`‹¡
("Don't doƒmpty‡llocation forƒmpty multi bulk: ");

320 
»ad”
 = 
	`»disR—d”C»©e
();

321 
	`»disR—d”F“d
(
»ad”
,(*)"*0\r\n",4);

322 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

323 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_OK
 &&

324 ((
»disR•ly
*)
»¶y
)->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&

325 ((
»disR•ly
*)
»¶y
)->
–em’ts
 == 0);

326 
	`ä“R•lyObjeù
(
»¶y
);

327 
	`»disR—d”F»e
(
»ad”
);

328 
	}
}

330 
	$‹¡_ä“_nuÎ
() {

331 *
»disCÚ‹xt
 = 
NULL
;

332 *
»¶y
 = 
NULL
;

334 
	`‹¡
("Don't fail when„edisFree is…assed‡ NULL value: ");

335 
	`»disF»e
(
»disCÚ‹xt
);

336 
	`‹¡_cÚd
(
»disCÚ‹xt
 =ğ
NULL
);

338 
	`‹¡
("Don't fail when freeReplyObject is…assed‡ NULL value: ");

339 
	`ä“R•lyObjeù
(
»¶y
);

340 
	`‹¡_cÚd
(
»¶y
 =ğ
NULL
);

341 
	}
}

343 
	$‹¡_blockšg_cÚÃùiÚ_”rÜs
() {

344 
»disCÚ‹xt
 *
c
;

346 
	`‹¡
("Returnsƒrror when host cannot be„esolved: ");

347 
c
 = 
	`»disCÚÃù
((*)"idontexist.test", 6379);

348 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_OTHER
 &&

349 (
	`¡rcmp
(
c
->
”r¡r
,"Name or service‚ot known") == 0 ||

350 
	`¡rcmp
(
c
->
”r¡r
,"Can't„esolve: idontexist.test") == 0 ||

351 
	`¡rcmp
(
c
->
”r¡r
,"nodename‚or servname…rovided, or‚ot known") == 0 ||

352 
	`¡rcmp
(
c
->
”r¡r
,"No‡ddress‡ssociated with hostname") == 0 ||

353 
	`¡rcmp
(
c
->
”r¡r
,"Temporary failure in‚ame„esolution") == 0 ||

354 
	`¡rcmp
(
c
->
”r¡r
,"hostname‚or servname…rovided, or‚ot known") == 0 ||

355 
	`¡rcmp
(
c
->
”r¡r
,"no‡ddress‡ssociated with‚ame") == 0));

356 
	`»disF»e
(
c
);

358 
	`‹¡
("Returnsƒrror whenhe…ort is‚ot open: ");

359 
c
 = 
	`»disCÚÃù
((*)"localhost", 1);

360 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_IO
 &&

361 
	`¡rcmp
(
c
->
”r¡r
,"Connection„efused") == 0);

362 
	`»disF»e
(
c
);

364 
	`‹¡
("Returnsƒrror whenhe unix socket…ath doesn't‡ccept connections: ");

365 
c
 = 
	`»disCÚÃùUnix
((*)"/tmp/idontexist.sock");

366 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_IO
);

367 
	`»disF»e
(
c
);

368 
	}
}

370 
	$‹¡_blockšg_cÚÃùiÚ
(
cÚfig
 config) {

371 
»disCÚ‹xt
 *
c
;

372 
»disR•ly
 *
»¶y
;

374 
c
 = 
	`cÚÃù
(
cÚfig
);

376 
	`‹¡
("Is‡bleo deliver commands: ");

377 
»¶y
 = 
	`»disCommªd
(
c
,"PING");

378 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STATUS
 &&

379 
	`¡rÿ£cmp
(
»¶y
->
¡r
,"pong") == 0)

380 
	`ä“R•lyObjeù
(
»¶y
);

382 
	`‹¡
("Is‡‡bleo send commands verbatim: ");

383 
»¶y
 = 
	`»disCommªd
(
c
,"SET foo bar");

384 
	`‹¡_cÚd
 (
»¶y
->
ty³
 =ğ
REDIS_REPLY_STATUS
 &&

385 
	`¡rÿ£cmp
(
»¶y
->
¡r
,"ok") == 0)

386 
	`ä“R•lyObjeù
(
»¶y
);

388 
	`‹¡
("%%s String interpolation works: ");

389 
»¶y
 = 
	`»disCommªd
(
c
,"SET %s %s","foo","hello world");

390 
	`ä“R•lyObjeù
(
»¶y
);

391 
»¶y
 = 
	`»disCommªd
(
c
,"GET foo");

392 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

393 
	`¡rcmp
(
»¶y
->
¡r
,"hello world") == 0);

394 
	`ä“R•lyObjeù
(
»¶y
);

396 
	`‹¡
("%%b String interpolation works: ");

397 
»¶y
 = 
	`»disCommªd
(
c
,"SET %b %b","foo",(
size_t
)3,"hello\x00world",(size_t)11);

398 
	`ä“R•lyObjeù
(
»¶y
);

399 
»¶y
 = 
	`»disCommªd
(
c
,"GET foo");

400 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

401 
	`memcmp
(
»¶y
->
¡r
,"hello\x00world",11) == 0)

403 
	`‹¡
("Binary„eply†ength is correct: ");

404 
	`‹¡_cÚd
(
»¶y
->
Ën
 == 11)

405 
	`ä“R•lyObjeù
(
»¶y
);

407 
	`‹¡
("Can…arse‚il„eplies: ");

408 
»¶y
 = 
	`»disCommªd
(
c
,"GET‚okey");

409 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_NIL
)

410 
	`ä“R•lyObjeù
(
»¶y
);

413 
	`‹¡
("Can…arse integer„eplies: ");

414 
»¶y
 = 
	`»disCommªd
(
c
,"INCR mycounter");

415 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&„•ly->
š‹g”
 == 1)

416 
	`ä“R•lyObjeù
(
»¶y
);

418 
	`‹¡
("Can…arse multi bulk„eplies: ");

419 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"LPUSH mylist foo"));

420 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"LPUSH mylist bar"));

421 
»¶y
 = 
	`»disCommªd
(
c
,"LRANGE mylist 0 -1");

422 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&

423 
»¶y
->
–em’ts
 == 2 &&

424 !
	`memcmp
(
»¶y
->
–em’t
[0]->
¡r
,"bar",3) &&

425 !
	`memcmp
(
»¶y
->
–em’t
[1]->
¡r
,"foo",3))

426 
	`ä“R•lyObjeù
(
»¶y
);

430 
	`‹¡
("Can handle‚ested multi bulk„eplies: ");

431 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"MULTI"));

432 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"LRANGE mylist 0 -1"));

433 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"PING"));

434 
»¶y
 = (
	`»disCommªd
(
c
,"EXEC"));

435 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&

436 
»¶y
->
–em’ts
 == 2 &&

437 
»¶y
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&

438 
»¶y
->
–em’t
[0]->
–em’ts
 == 2 &&

439 !
	`memcmp
(
»¶y
->
–em’t
[0]->–em’t[0]->
¡r
,"bar",3) &&

440 !
	`memcmp
(
»¶y
->
–em’t
[0]->–em’t[1]->
¡r
,"foo",3) &&

441 
»¶y
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_STATUS
 &&

442 
	`¡rÿ£cmp
(
»¶y
->
–em’t
[1]->
¡r
,"pong") == 0);

443 
	`ä“R•lyObjeù
(
»¶y
);

445 
	`discÚÃù
(
c
, 0);

446 
	}
}

448 
	$‹¡_blockšg_cÚÃùiÚ_timeouts
(
cÚfig
 config) {

449 
»disCÚ‹xt
 *
c
;

450 
»disR•ly
 *
»¶y
;

451 
ssize_t
 
s
;

452 cÚ¡ *
cmd
 = "DEBUG SLEEP 3\r\n";

453 
timev®
 
tv
;

455 
c
 = 
	`cÚÃù
(
cÚfig
);

456 
	`‹¡
("Successfully completes‡ command whenheimeout is‚otƒxceeded: ");

457 
»¶y
 = 
	`»disCommªd
(
c
,"SET foo fast");

458 
	`ä“R•lyObjeù
(
»¶y
);

459 
tv
.
tv_£c
 = 0;

460 
tv
.
tv_u£c
 = 10000;

461 
	`»disS‘Timeout
(
c
, 
tv
);

462 
»¶y
 = 
	`»disCommªd
(
c
, "GET foo");

463 
	`‹¡_cÚd
(
»¶y
 !ğ
NULL
 &&„•ly->
ty³
 =ğ
REDIS_REPLY_STRING
 && 
	`memcmp
Ô•ly->
¡r
, "fast", 4) == 0);

464 
	`ä“R•lyObjeù
(
»¶y
);

465 
	`discÚÃù
(
c
, 0);

467 
c
 = 
	`cÚÃù
(
cÚfig
);

468 
	`‹¡
("Does‚ot„eturn‡„eply whenhe commandimes out: ");

469 
s
 = 
	`wr™e
(
c
->
fd
, 
cmd
, 
	`¡¾’
(cmd));

470 
tv
.
tv_£c
 = 0;

471 
tv
.
tv_u£c
 = 10000;

472 
	`»disS‘Timeout
(
c
, 
tv
);

473 
»¶y
 = 
	`»disCommªd
(
c
, "GET foo");

474 
	`‹¡_cÚd
(
s
 > 0 && 
»¶y
 =ğ
NULL
 && 
c
->
”r
 =ğ
REDIS_ERR_IO
 && 
	`¡rcmp
(c->
”r¡r
, "Resourceemporarily unavailable") == 0);

475 
	`ä“R•lyObjeù
(
»¶y
);

477 
	`‹¡
("Reconnect…roperly„econnects‡fter‡imeout: ");

478 
	`»disRecÚÃù
(
c
);

479 
»¶y
 = 
	`»disCommªd
(
c
, "PING");

480 
	`‹¡_cÚd
(
»¶y
 !ğ
NULL
 &&„•ly->
ty³
 =ğ
REDIS_REPLY_STATUS
 && 
	`¡rcmp
Ô•ly->
¡r
, "PONG") == 0);

481 
	`ä“R•lyObjeù
(
»¶y
);

483 
	`‹¡
("Reconnect…roperly uses owned…arameters: ");

484 
cÚfig
.
tı
.
ho¡
 = "foo";

485 
cÚfig
.
unix
.
·th
 = "foo";

486 
	`»disRecÚÃù
(
c
);

487 
»¶y
 = 
	`»disCommªd
(
c
, "PING");

488 
	`‹¡_cÚd
(
»¶y
 !ğ
NULL
 &&„•ly->
ty³
 =ğ
REDIS_REPLY_STATUS
 && 
	`¡rcmp
Ô•ly->
¡r
, "PONG") == 0);

489 
	`ä“R•lyObjeù
(
»¶y
);

491 
	`discÚÃù
(
c
, 0);

492 
	}
}

494 
	$‹¡_blockšg_io_”rÜs
(
cÚfig
 config) {

495 
»disCÚ‹xt
 *
c
;

496 
»disR•ly
 *
»¶y
;

497 *
_»¶y
;

498 
majÜ
, 
mšÜ
;

501 
c
 = 
	`cÚÃù
(
cÚfig
);

504 cÚ¡ *
f›ld
 = "redis_version:";

505 *
p
, *
•Œ
;

507 
»¶y
 = 
	`»disCommªd
(
c
,"INFO");

508 
p
 = 
	`¡r¡r
(
»¶y
->
¡r
,
f›ld
);

509 
majÜ
 = 
	`¡¹Ş
(
p
+
	`¡¾’
(
f›ld
),&
•Œ
,10);

510 
p
 = 
•Œ
+1;

511 
mšÜ
 = 
	`¡¹Ş
(
p
,&
•Œ
,10);

512 
	`ä“R•lyObjeù
(
»¶y
);

515 
	`‹¡
("Returns I/Oƒrror whenhe connection is†ost: ");

516 
»¶y
 = 
	`»disCommªd
(
c
,"QUIT");

517 ià(
majÜ
 > 2 || (majÜ =ğ2 && 
mšÜ
 > 0)) {

520 
	`‹¡_cÚd
(
	`¡rÿ£cmp
(
»¶y
->
¡r
,"OK") == 0 &&

521 
	`»disG‘R•ly
(
c
,&
_»¶y
è=ğ
REDIS_ERR
);

522 
	`ä“R•lyObjeù
(
»¶y
);

524 
	`‹¡_cÚd
(
»¶y
 =ğ
NULL
);

532 
	`as£¹
(
c
->
”r
 =ğ
REDIS_ERR_EOF
 &&

533 
	`¡rcmp
(
c
->
”r¡r
,"Server closedhe connection") == 0);

534 
	`»disF»e
(
c
);

536 
c
 = 
	`cÚÃù
(
cÚfig
);

537 
	`‹¡
("Returns I/Oƒrror on socketimeout: ");

538 
timev®
 
tv
 = { 0, 1000 };

539 
	`as£¹
(
	`»disS‘Timeout
(
c
,
tv
è=ğ
REDIS_OK
);

540 
	`‹¡_cÚd
(
	`»disG‘R•ly
(
c
,&
_»¶y
è=ğ
REDIS_ERR
 &&

541 
c
->
”r
 =ğ
REDIS_ERR_IO
 && 
”ºo
 =ğ
EAGAIN
);

542 
	`»disF»e
(
c
);

543 
	}
}

545 
	$‹¡_šv®id_timeout_”rÜs
(
cÚfig
 config) {

546 
»disCÚ‹xt
 *
c
;

548 
	`‹¡
("Setƒrror when‡n invalidimeout usec value is giveno„edisConnectWithTimeout: ");

550 
cÚfig
.
tı
.
timeout
.
tv_£c
 = 0;

551 
cÚfig
.
tı
.
timeout
.
tv_u£c
 = 10000001;

553 
c
 = 
	`»disCÚÃùW™hTimeout
(
cÚfig
.
tı
.
ho¡
, cÚfig.tı.
pÜt
, cÚfig.tı.
timeout
);

555 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_IO
);

556 
	`»disF»e
(
c
);

558 
	`‹¡
("Setƒrror when‡n invalidimeout sec value is giveno„edisConnectWithTimeout: ");

560 
cÚfig
.
tı
.
timeout
.
tv_£c
 = (((
LONG_MAX
) - 999) / 1000) + 1;

561 
cÚfig
.
tı
.
timeout
.
tv_u£c
 = 0;

563 
c
 = 
	`»disCÚÃùW™hTimeout
(
cÚfig
.
tı
.
ho¡
, cÚfig.tı.
pÜt
, cÚfig.tı.
timeout
);

565 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_IO
);

566 
	`»disF»e
(
c
);

567 
	}
}

569 
	$‹¡_throughput
(
cÚfig
 config) {

570 
»disCÚ‹xt
 *
c
 = 
	`cÚÃù
(
cÚfig
);

571 
»disR•ly
 **
»¶›s
;

572 
i
, 
num
;

573 
t1
, 
t2
;

575 
	`‹¡
("Throughput:\n");

576 
i
 = 0; i < 500; i++)

577 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"LPUSH mylist foo"));

579 
num
 = 1000;

580 
»¶›s
 = 
	`m®loc
((
»disR•ly
*)*
num
);

581 
t1
 = 
	`u£c
();

582 
i
 = 0; i < 
num
; i++) {

583 
»¶›s
[
i
] = 
	`»disCommªd
(
c
,"PING");

584 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
ty³
 =ğ
REDIS_REPLY_STATUS
);

586 
t2
 = 
	`u£c
();

587 
i
 = 0; i < 
num
; i++è
	`ä“R•lyObjeù
(
»¶›s
[i]);

588 
	`ä“
(
»¶›s
);

589 
	`´štf
("\t(%dx PING: %.3fs)\n", 
num
, (
t2
-
t1
)/1000000.0);

591 
»¶›s
 = 
	`m®loc
((
»disR•ly
*)*
num
);

592 
t1
 = 
	`u£c
();

593 
i
 = 0; i < 
num
; i++) {

594 
»¶›s
[
i
] = 
	`»disCommªd
(
c
,"LRANGE mylist 0 499");

595 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

596 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
–em’ts
 == 500);

598 
t2
 = 
	`u£c
();

599 
i
 = 0; i < 
num
; i++è
	`ä“R•lyObjeù
(
»¶›s
[i]);

600 
	`ä“
(
»¶›s
);

601 
	`´štf
("\t(%dx LRANGE w™h 500ƒËm’ts: %.3fs)\n", 
num
, (
t2
-
t1
)/1000000.0);

603 
num
 = 10000;

604 
»¶›s
 = 
	`m®loc
((
»disR•ly
*)*
num
);

605 
i
 = 0; i < 
num
; i++)

606 
	`»disAµ’dCommªd
(
c
,"PING");

607 
t1
 = 
	`u£c
();

608 
i
 = 0; i < 
num
; i++) {

609 
	`as£¹
(
	`»disG‘R•ly
(
c
, (*)&
»¶›s
[
i
]è=ğ
REDIS_OK
);

610 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
ty³
 =ğ
REDIS_REPLY_STATUS
);

612 
t2
 = 
	`u£c
();

613 
i
 = 0; i < 
num
; i++è
	`ä“R•lyObjeù
(
»¶›s
[i]);

614 
	`ä“
(
»¶›s
);

615 
	`´štf
("\t(%dx PING (p–šed): %.3fs)\n", 
num
, (
t2
-
t1
)/1000000.0);

617 
»¶›s
 = 
	`m®loc
((
»disR•ly
*)*
num
);

618 
i
 = 0; i < 
num
; i++)

619 
	`»disAµ’dCommªd
(
c
,"LRANGE mylist 0 499");

620 
t1
 = 
	`u£c
();

621 
i
 = 0; i < 
num
; i++) {

622 
	`as£¹
(
	`»disG‘R•ly
(
c
, (*)&
»¶›s
[
i
]è=ğ
REDIS_OK
);

623 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

624 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
–em’ts
 == 500);

626 
t2
 = 
	`u£c
();

627 
i
 = 0; i < 
num
; i++è
	`ä“R•lyObjeù
(
»¶›s
[i]);

628 
	`ä“
(
»¶›s
);

629 
	`´štf
("\t(%dx LRANGE w™h 500ƒËm’t Õ–šed): %.3fs)\n", 
num
, (
t2
-
t1
)/1000000.0);

631 
	`discÚÃù
(
c
, 0);

632 
	}
}

733 
	$maš
(
¬gc
, **
¬gv
) {

734 
cÚfig
 
cfg
 = {

735 .
tı
 = {

736 .
ho¡
 = "127.0.0.1",

737 .
pÜt
 = 6379

739 .
unix
 = {

740 .
·th
 = "/tmp/redis.sock"

743 
throughput
 = 1;

744 
‹¡_šh”™_fd
 = 1;

747 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

750 
¬gv
++; 
¬gc
--;

751 
¬gc
) {

752 ià(
¬gc
 >ğ2 && !
	`¡rcmp
(
¬gv
[0],"-h")) {

753 
¬gv
++; 
¬gc
--;

754 
cfg
.
tı
.
ho¡
 = 
¬gv
[0];

755 } ià(
¬gc
 >ğ2 && !
	`¡rcmp
(
¬gv
[0],"-p")) {

756 
¬gv
++; 
¬gc
--;

757 
cfg
.
tı
.
pÜt
 = 
	`©oi
(
¬gv
[0]);

758 } ià(
¬gc
 >ğ2 && !
	`¡rcmp
(
¬gv
[0],"-s")) {

759 
¬gv
++; 
¬gc
--;

760 
cfg
.
unix
.
·th
 = 
¬gv
[0];

761 } ià(
¬gc
 >ğ1 && !
	`¡rcmp
(
¬gv
[0],"--skip-throughput")) {

762 
throughput
 = 0;

763 } ià(
¬gc
 >ğ1 && !
	`¡rcmp
(
¬gv
[0],"--skip-inherit-fd")) {

764 
‹¡_šh”™_fd
 = 0;

766 
	`årštf
(
¡d”r
, "Inv®id‡rgum’t: %s\n", 
¬gv
[0]);

767 
	`ex™
(1);

769 
¬gv
++; 
¬gc
--;

772 
	`‹¡_fÜm©_commªds
();

773 
	`‹¡_»¶y_»ad”
();

774 
	`‹¡_blockšg_cÚÃùiÚ_”rÜs
();

775 
	`‹¡_ä“_nuÎ
();

777 
	`´štf
("\nTe¡šg‡gaš¡ TCP cÚÃùiÚ (%s:%d):\n", 
cfg
.
tı
.
ho¡
, cfg.tı.
pÜt
);

778 
cfg
.
ty³
 = 
CONN_TCP
;

779 
	`‹¡_blockšg_cÚÃùiÚ
(
cfg
);

780 
	`‹¡_blockšg_cÚÃùiÚ_timeouts
(
cfg
);

781 
	`‹¡_blockšg_io_”rÜs
(
cfg
);

782 
	`‹¡_šv®id_timeout_”rÜs
(
cfg
);

783 
	`‹¡_­³nd_fÜm©‹d_commªds
(
cfg
);

784 ià(
throughput
è
	`‹¡_throughput
(
cfg
);

786 
	`´štf
("\nTe¡šg‡gaš¡ Unix sock‘ cÚÃùiÚ (%s):\n", 
cfg
.
unix
.
·th
);

787 
cfg
.
ty³
 = 
CONN_UNIX
;

788 
	`‹¡_blockšg_cÚÃùiÚ
(
cfg
);

789 
	`‹¡_blockšg_cÚÃùiÚ_timeouts
(
cfg
);

790 
	`‹¡_blockšg_io_”rÜs
(
cfg
);

791 ià(
throughput
è
	`‹¡_throughput
(
cfg
);

793 ià(
‹¡_šh”™_fd
) {

794 
	`´štf
("\nTe¡šg‡gaš¡ inh”™ed fd (%s):\n", 
cfg
.
unix
.
·th
);

795 
cfg
.
ty³
 = 
CONN_FD
;

796 
	`‹¡_blockšg_cÚÃùiÚ
(
cfg
);

800 ià(
çs
) {

801 
	`´štf
("*** %d TESTS FAILED ***\n", 
çs
);

805 
	`´štf
("ALL TESTS PASSED\n");

807 
	}
}

	@dep/hiredis-0.13.3/win32.h

1 #iâdeà
_WIN32_HELPER_INCLUDE


2 
	#_WIN32_HELPER_INCLUDE


	)

3 #ifdeà
_MSC_VER


5 #iâdeà
šlše


6 
	#šlše
 
__šlše


	)

9 #iâdeà
va_cİy


10 
	#va_cİy
(
d
,
s
è((dèğ(s))

	)

13 #iâdeà
¢´štf


14 
	#¢´štf
 
c99_¢´štf


	)

16 
__šlše
 
	$c99_v¢´štf
(* 
¡r
, 
size_t
 
size
, cÚ¡ * 
fÜm©
, 
va_li¡
 
­
)

18 
couÁ
 = -1;

20 ià(
size
 != 0)

21 
couÁ
 = 
	`_v¢´štf_s
(
¡r
, 
size
, 
_TRUNCATE
, 
fÜm©
, 
­
);

22 ià(
couÁ
 == -1)

23 
couÁ
 = 
	`_vsırštf
(
fÜm©
, 
­
);

25  
couÁ
;

26 
	}
}

28 
__šlše
 
	$c99_¢´štf
(* 
¡r
, 
size_t
 
size
, cÚ¡ * 
fÜm©
, ...)

30 
couÁ
;

31 
va_li¡
 
­
;

33 
	`va_¡¬t
(
­
, 
fÜm©
);

34 
couÁ
 = 
	`c99_v¢´štf
(
¡r
, 
size
, 
fÜm©
, 
­
);

35 
	`va_’d
(
­
);

37  
couÁ
;

38 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/arena.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
	#LARGE_MINCLASS
 (
	`ZU
(1è<< 
LG_LARGE_MINCLASS
)

	)

7 
	#LG_RUN_MAXREGS
 (
LG_PAGE
 - 
LG_TINY_MIN
)

	)

8 
	#RUN_MAXREGS
 (1U << 
LG_RUN_MAXREGS
)

	)

14 
	#REDZONE_MINSIZE
 16

	)

24 
	#LG_DIRTY_MULT_DEFAULT
 3

	)

27 
	mpurge_mode_¿tio
 = 0,

28 
	mpurge_mode_deÿy
 = 1,

30 
	mpurge_mode_lim™
 = 2

31 } 
	tpurge_mode_t
;

32 
	#PURGE_DEFAULT
 
purge_mode_¿tio


	)

34 
	#DECAY_TIME_DEFAULT
 10

	)

36 
	#DECAY_NTICKS_PER_UPDATE
 1000

	)

38 
¬’a_runs_dœty_lšk_s
 
	t¬’a_runs_dœty_lšk_t
;

39 
¬’a_ava_lšks_s
 
	t¬’a_ava_lšks_t
;

40 
¬’a_run_s
 
	t¬’a_run_t
;

41 
¬’a_chunk_m­_b™s_s
 
	t¬’a_chunk_m­_b™s_t
;

42 
¬’a_chunk_m­_misc_s
 
	t¬’a_chunk_m­_misc_t
;

43 
¬’a_chunk_s
 
	t¬’a_chunk_t
;

44 
¬’a_bš_šfo_s
 
	t¬’a_bš_šfo_t
;

45 
¬’a_bš_s
 
	t¬’a_bš_t
;

46 
¬’a_s
 
	t¬’a_t
;

47 
¬’a_td©a_s
 
	t¬’a_td©a_t
;

51 #ifdeà
JEMALLOC_H_STRUCTS


53 #ifdeà
JEMALLOC_ARENA_STRUCTS_A


54 
	s¬’a_run_s
 {

56 
szšd_t
 
	mbššd
;

59 
	mnä“
;

62 
b™m­_t
 
	mb™m­
[
BITMAP_GROUPS_MAX
];

66 
	s¬’a_chunk_m­_b™s_s
 {

125 
size_t
 
	mb™s
;

126 
	#CHUNK_MAP_ALLOCATED
 ((
size_t
)0x01U)

	)

127 
	#CHUNK_MAP_LARGE
 ((
size_t
)0x02U)

	)

128 
	#CHUNK_MAP_STATE_MASK
 ((
size_t
)0x3U)

	)

130 
	#CHUNK_MAP_DECOMMITTED
 ((
size_t
)0x04U)

	)

131 
	#CHUNK_MAP_UNZEROED
 ((
size_t
)0x08U)

	)

132 
	#CHUNK_MAP_DIRTY
 ((
size_t
)0x10U)

	)

133 
	#CHUNK_MAP_FLAGS_MASK
 ((
size_t
)0x1cU)

	)

135 
	#CHUNK_MAP_BININD_SHIFT
 5

	)

136 
	#BININD_INVALID
 ((
size_t
)0xffU)

	)

137 
	#CHUNK_MAP_BININD_MASK
 (
BININD_INVALID
 << 
CHUNK_MAP_BININD_SHIFT
)

	)

138 
	#CHUNK_MAP_BININD_INVALID
 
CHUNK_MAP_BININD_MASK


	)

140 
	#CHUNK_MAP_RUNIND_SHIFT
 (
CHUNK_MAP_BININD_SHIFT
 + 8)

	)

141 
	#CHUNK_MAP_SIZE_SHIFT
 (
CHUNK_MAP_RUNIND_SHIFT
 - 
LG_PAGE
)

	)

142 
	#CHUNK_MAP_SIZE_MASK
 \

143 (~(
CHUNK_MAP_BININD_MASK
 | 
CHUNK_MAP_FLAGS_MASK
 | 
CHUNK_MAP_STATE_MASK
))

	)

146 
	s¬’a_runs_dœty_lšk_s
 {

147 
qr
(
¬’a_runs_dœty_lšk_t
è
	mrd_lšk
;

155 
	s¬’a_chunk_m­_misc_s
 {

163 
phn
(
¬’a_chunk_m­_misc_t
è
	mph_lšk
;

167 
¬’a_runs_dœty_lšk_t
 
	mrd
;

171 *
	m´of_tùx_pun
;

172 
´of_tùx_t
 *
	m´of_tùx
;

176 
¬’a_run_t
 
	mrun
;

179 
	$ph
(
	t¬’a_chunk_m­_misc_t
è
	t¬’a_run_h—p_t
;

182 #ifdeà
JEMALLOC_ARENA_STRUCTS_B


184 
	s¬’a_chunk_s
 {

190 
ex‹Á_node_t
 
node
;

198 
¬’a_chunk_m­_b™s_t
 
m­_b™s
[1];

234 
	s¬’a_bš_šfo_s
 {

236 
size_t
 
»g_size
;

239 
size_t
 
»dzÚe_size
;

242 
size_t
 
»g_š‹rv®
;

245 
size_t
 
run_size
;

248 
ušt32_t
 
Äegs
;

254 
b™m­_šfo_t
 
b™m­_šfo
;

257 
ušt32_t
 
»g0_off£t
;

260 
	s¬’a_bš_s
 {

267 
m®loc_mu‹x_t
 
lock
;

273 
¬’a_run_t
 *
runcur
;

282 
¬’a_run_h—p_t
 
runs
;

285 
m®loc_bš_¡©s_t
 
¡©s
;

288 
	s¬’a_s
 {

290 
šd
;

304 
Áh»ads
[2];

313 
m®loc_mu‹x_t
 
lock
;

315 
¬’a_¡©s_t
 
¡©s
;

321 
	`ql_h—d
(
tÿche_t
è
tÿche_ql
;

323 
ušt64_t
 
´of_accumby‹s
;

329 
ušt64_t
 
off£t_¡©e
;

331 
dss_´ec_t
 
dss_´ec
;

335 
	`ql_h—d
(
ex‹Á_node_t
è
achunks
;

347 
¬’a_chunk_t
 *
¥¬e
;

350 
ssize_t
 
lg_dœty_muÉ
;

353 
boŞ
 
purgšg
;

356 
size_t
 
Çùive
;

364 
size_t
 
ndœty
;

394 
¬’a_runs_dœty_lšk_t
 
runs_dœty
;

395 
ex‹Á_node_t
 
chunks_ÿche
;

402 
ssize_t
 
deÿy_time
;

404 
n¡ime_t
 
deÿy_š‹rv®
;

412 
n¡ime_t
 
deÿy_•och
;

414 
ušt64_t
 
deÿy_j™‹r_¡©e
;

422 
n¡ime_t
 
deÿy_d—dlše
;

429 
size_t
 
deÿy_ndœty
;

435 
size_t
 
deÿy_backlog_Åages_lim™
;

442 
size_t
 
deÿy_backlog
[
SMOOTHSTEP_NSTEPS
];

445 
	`ql_h—d
(
ex‹Á_node_t
è
huge
;

447 
m®loc_mu‹x_t
 
huge_mtx
;

456 
ex‹Á_Œ“_t
 
chunks_szad_ÿched
;

457 
ex‹Á_Œ“_t
 
chunks_ad_ÿched
;

458 
ex‹Á_Œ“_t
 
chunks_szad_»šed
;

459 
ex‹Á_Œ“_t
 
chunks_ad_»šed
;

461 
m®loc_mu‹x_t
 
chunks_mtx
;

463 
	`ql_h—d
(
ex‹Á_node_t
è
node_ÿche
;

464 
m®loc_mu‹x_t
 
node_ÿche_mtx
;

467 
chunk_hooks_t
 
chunk_hooks
;

470 
¬’a_bš_t
 
bšs
[
NBINS
];

476 
¬’a_run_h—p_t
 
runs_ava
[1];

480 
	s¬’a_td©a_s
 {

481 
tick”_t
 
deÿy_tick”
;

487 #ifdeà
JEMALLOC_H_EXTERNS


489 cÚ¡ 
size_t
 
Ïrge_·d
 =

490 #ifdeà
JEMALLOC_CACHE_OBLIVIOUS


491 
PAGE


497 
purge_mode_t
 
İt_purge
;

498 cÚ¡ *
purge_mode_Çmes
[];

499 
ssize_t
 
İt_lg_dœty_muÉ
;

500 
ssize_t
 
İt_deÿy_time
;

502 
¬’a_bš_šfo_t
 
¬’a_bš_šfo
[
NBINS
];

504 
size_t
 
m­_bŸs
;

505 
size_t
 
m­_misc_off£t
;

506 
size_t
 
¬’a_maxrun
;

507 
size_t
 
Ïrge_maxşass
;

508 
size_t
 
run_quªtize_max
;

509 
Æşas£s
;

510 
nhşas£s
;

512 #ifdeà
JEMALLOC_JET


513 
	$size_t
 (
	trun_quªtize_t
)(
	tsize_t
);

514 
run_quªtize_t
 *
run_quªtize_æoÜ
;

515 
run_quªtize_t
 *
run_quªtize_û
;

517 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
,

518 
boŞ
 
ÿche
);

519 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
,

520 
boŞ
 
ÿche
);

521 
ex‹Á_node_t
 *
	`¬’a_node_®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

522 
	`¬’a_node_d®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
);

523 *
	`¬’a_chunk_®loc_huge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
,

524 
size_t
 
®ignm’t
, 
boŞ
 *
z”o
);

525 
	`¬’a_chunk_d®loc_huge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
chunk
,

526 
size_t
 
usize
);

527 
	`¬’a_chunk_¿Îoc_huge_sim¬
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

528 *
chunk
, 
size_t
 
Şdsize
, size_ˆ
usize
);

529 
	`¬’a_chunk_¿Îoc_huge_shršk
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

530 *
chunk
, 
size_t
 
Şdsize
, size_ˆ
usize
);

531 
boŞ
 
	`¬’a_chunk_¿Îoc_huge_ex·nd
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

532 *
chunk
, 
size_t
 
Şdsize
, size_ˆ
usize
, 
boŞ
 *
z”o
);

533 
ssize_t
 
	`¬’a_lg_dœty_muÉ_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

534 
boŞ
 
	`¬’a_lg_dœty_muÉ_£t
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

535 
ssize_t
 
lg_dœty_muÉ
);

536 
ssize_t
 
	`¬’a_deÿy_time_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

537 
boŞ
 
	`¬’a_deÿy_time_£t
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
ssize_t
 
deÿy_time
);

538 
	`¬’a_purge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
boŞ
 
®l
);

539 
	`¬’a_maybe_purge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

540 
	`¬’a_»£t
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
);

541 
	`¬’a_tÿche_fl_sm®l
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

542 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
, 
ušt64_t
 
´of_accumby‹s
);

543 
	`¬’a_®loc_junk_sm®l
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
,

544 
boŞ
 
z”o
);

545 #ifdeà
JEMALLOC_JET


546 (
	t¬’a_»dzÚe_cÜru±iÚ_t
)(*, 
	tsize_t
, 
	tboŞ
, size_t,

547 
	tušt8_t
);

548 
¬’a_»dzÚe_cÜru±iÚ_t
 *
¬’a_»dzÚe_cÜru±iÚ
;

549 (
	t¬’a_d®loc_junk_sm®l_t
)(*, 
	t¬’a_bš_šfo_t
 *);

550 
¬’a_d®loc_junk_sm®l_t
 *
¬’a_d®loc_junk_sm®l
;

552 
	`¬’a_d®loc_junk_sm®l
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
);

554 
	`¬’a_qu¬ªtše_junk_sm®l
(*
±r
, 
size_t
 
usize
);

555 *
	`¬’a_m®loc_Ïrge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
szšd_t
 
šd
,

556 
boŞ
 
z”o
);

557 *
	`¬’a_m®loc_h¬d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
,

558 
szšd_t
 
šd
, 
boŞ
 
z”o
);

559 *
	`¬’a_·Îoc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
,

560 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
);

561 
	`¬’a_´of_´omÙed
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
size
);

562 
	`¬’a_d®loc_bš_junked_locked
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

563 
¬’a_chunk_t
 *
chunk
, *
±r
, 
¬’a_chunk_m­_b™s_t
 *
b™£lm
);

564 
	`¬’a_d®loc_bš
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

565 *
±r
, 
size_t
 
·gešd
, 
¬’a_chunk_m­_b™s_t
 *
b™£lm
);

566 
	`¬’a_d®loc_sm®l
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

567 *
±r
, 
size_t
 
·gešd
);

568 #ifdeà
JEMALLOC_JET


569 (
	t¬’a_d®loc_junk_Ïrge_t
)(*, 
	tsize_t
);

570 
¬’a_d®loc_junk_Ïrge_t
 *
¬’a_d®loc_junk_Ïrge
;

572 
	`¬’a_d®loc_junk_Ïrge
(*
±r
, 
size_t
 
usize
);

574 
	`¬’a_d®loc_Ïrge_junked_locked
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

575 
¬’a_chunk_t
 *
chunk
, *
±r
);

576 
	`¬’a_d®loc_Ïrge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

577 *
±r
);

578 #ifdeà
JEMALLOC_JET


579 (
	t¬’a_¿Îoc_junk_Ïrge_t
)(*, 
	tsize_t
, size_t);

580 
¬’a_¿Îoc_junk_Ïrge_t
 *
¬’a_¿Îoc_junk_Ïrge
;

582 
boŞ
 
	`¬’a_¿Îoc_no_move
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
,

583 
size_t
 
size
, size_ˆ
exŒa
, 
boŞ
 
z”o
);

584 *
	`¬’a_¿Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, *
±r
, 
size_t
 
Şdsize
,

585 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
);

586 
dss_´ec_t
 
	`¬’a_dss_´ec_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

587 
boŞ
 
	`¬’a_dss_´ec_£t
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
dss_´ec_t
 
dss_´ec
);

588 
ssize_t
 
	`¬’a_lg_dœty_muÉ_deçuÉ_g‘
();

589 
boŞ
 
	`¬’a_lg_dœty_muÉ_deçuÉ_£t
(
ssize_t
 
lg_dœty_muÉ
);

590 
ssize_t
 
	`¬’a_deÿy_time_deçuÉ_g‘
();

591 
boŞ
 
	`¬’a_deÿy_time_deçuÉ_£t
(
ssize_t
 
deÿy_time
);

592 
	`¬’a_basic_¡©s_m”ge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

593 *
Áh»ads
, cÚ¡ **
dss
, 
ssize_t
 *
lg_dœty_muÉ
,

594 
ssize_t
 *
deÿy_time
, 
size_t
 *
Çùive
, size_ˆ*
ndœty
);

595 
	`¬’a_¡©s_m”ge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
Áh»ads
,

596 cÚ¡ **
dss
, 
ssize_t
 *
lg_dœty_muÉ
, ssize_ˆ*
deÿy_time
,

597 
size_t
 *
Çùive
, size_ˆ*
ndœty
, 
¬’a_¡©s_t
 *
a¡©s
,

598 
m®loc_bš_¡©s_t
 *
b¡©s
, 
m®loc_Ïrge_¡©s_t
 *
l¡©s
,

599 
m®loc_huge_¡©s_t
 *
h¡©s
);

600 
	`¬’a_Áh»ads_g‘
(
¬’a_t
 *
¬’a
, 
boŞ
 
š‹º®
);

601 
	`¬’a_Áh»ads_šc
(
¬’a_t
 *
¬’a
, 
boŞ
 
š‹º®
);

602 
	`¬’a_Áh»ads_dec
(
¬’a_t
 *
¬’a
, 
boŞ
 
š‹º®
);

603 
¬’a_t
 *
	`¬’a_Ãw
(
tsdn_t
 *
tsdn
, 
šd
);

604 
boŞ
 
	`¬’a_boÙ
();

605 
	`¬’a_´efÜk0
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

606 
	`¬’a_´efÜk1
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

607 
	`¬’a_´efÜk2
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

608 
	`¬’a_´efÜk3
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

609 
	`¬’a_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

610 
	`¬’a_po¡fÜk_chd
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

614 #ifdeà
JEMALLOC_H_INLINES


616 #iâdeà
JEMALLOC_ENABLE_INLINE


617 
¬’a_chunk_m­_b™s_t
 *
	`¬’a_b™£lm_g‘_mubË
(
¬’a_chunk_t
 *
chunk
,

618 
size_t
 
·gešd
);

619 cÚ¡ 
¬’a_chunk_m­_b™s_t
 *
	`¬’a_b™£lm_g‘_cÚ¡
(

620 cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
);

621 
¬’a_chunk_m­_misc_t
 *
	`¬’a_misûlm_g‘_mubË
(
¬’a_chunk_t
 *
chunk
,

622 
size_t
 
·gešd
);

623 cÚ¡ 
¬’a_chunk_m­_misc_t
 *
	`¬’a_misûlm_g‘_cÚ¡
(

624 cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
);

625 
size_t
 
	`¬’a_misûlm_to_·gešd
(cÚ¡ 
¬’a_chunk_m­_misc_t
 *
misûlm
);

626 *
	`¬’a_misûlm_to_½ages
(cÚ¡ 
¬’a_chunk_m­_misc_t
 *
misûlm
);

627 
¬’a_chunk_m­_misc_t
 *
	`¬’a_rd_to_misûlm
(
¬’a_runs_dœty_lšk_t
 *
rd
);

628 
¬’a_chunk_m­_misc_t
 *
	`¬’a_run_to_misûlm
(
¬’a_run_t
 *
run
);

629 
size_t
 *
	`¬’a_m­b™¥_g‘_mubË
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

630 cÚ¡ 
size_t
 *
	`¬’a_m­b™¥_g‘_cÚ¡
(cÚ¡ 
¬’a_chunk_t
 *
chunk
,

631 
size_t
 
·gešd
);

632 
size_t
 
	`¬’a_m­b™¥_»ad
(cÚ¡ size_ˆ*
m­b™¥
);

633 
size_t
 
	`¬’a_m­b™s_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

634 
size_t
 
	`¬’a_m­b™s_size_decode
(size_ˆ
m­b™s
);

635 
size_t
 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
,

636 
size_t
 
·gešd
);

637 
size_t
 
	`¬’a_m­b™s_Ïrge_size_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
,

638 
size_t
 
·gešd
);

639 
size_t
 
	`¬’a_m­b™s_sm®l_runšd_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
,

640 
size_t
 
·gešd
);

641 
szšd_t
 
	`¬’a_m­b™s_bššd_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
);

642 
size_t
 
	`¬’a_m­b™s_dœty_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

643 
size_t
 
	`¬’a_m­b™s_unz”Ûd_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

644 
size_t
 
	`¬’a_m­b™s_decomm™‹d_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
,

645 
size_t
 
·gešd
);

646 
size_t
 
	`¬’a_m­b™s_Ïrge_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

647 
size_t
 
	`¬’a_m­b™s_®loÿ‹d_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

648 
	`¬’a_m­b™¥_wr™e
(
size_t
 *
m­b™¥
, size_ˆ
m­b™s
);

649 
size_t
 
	`¬’a_m­b™s_size_’code
(size_ˆ
size
);

650 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

651 
size_t
 
size
, size_ˆ
æags
);

652 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

653 
size_t
 
size
);

654 
	`¬’a_m­b™s_š‹º®_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

655 
size_t
 
æags
);

656 
	`¬’a_m­b™s_Ïrge_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

657 
size_t
 
size
, size_ˆ
æags
);

658 
	`¬’a_m­b™s_Ïrge_bššd_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

659 
szšd_t
 
bššd
);

660 
	`¬’a_m­b™s_sm®l_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

661 
size_t
 
runšd
, 
szšd_t
 
bššd
, size_ˆ
æags
);

662 
	`¬’a_m‘ad©a_®loÿ‹d_add
(
¬’a_t
 *
¬’a
, 
size_t
 
size
);

663 
	`¬’a_m‘ad©a_®loÿ‹d_sub
(
¬’a_t
 *
¬’a
, 
size_t
 
size
);

664 
size_t
 
	`¬’a_m‘ad©a_®loÿ‹d_g‘
(
¬’a_t
 *
¬’a
);

665 
boŞ
 
	`¬’a_´of_accum_im¶
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
);

666 
boŞ
 
	`¬’a_´of_accum_locked
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
);

667 
boŞ
 
	`¬’a_´of_accum
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
);

668 
szšd_t
 
	`¬’a_±r_sm®l_bššd_g‘
(cÚ¡ *
±r
, 
size_t
 
m­b™s
);

669 
szšd_t
 
	`¬’a_bš_šdex
(
¬’a_t
 *
¬’a
, 
¬’a_bš_t
 *
bš
);

670 
size_t
 
	`¬’a_run_»gšd
(
¬’a_run_t
 *
run
, 
¬’a_bš_šfo_t
 *
bš_šfo
,

671 cÚ¡ *
±r
);

672 
´of_tùx_t
 *
	`¬’a_´of_tùx_g‘
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
);

673 
	`¬’a_´of_tùx_£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
,

674 
´of_tùx_t
 *
tùx
);

675 
	`¬’a_´of_tùx_»£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
,

676 cÚ¡ *
Şd_±r
, 
´of_tùx_t
 *
Şd_tùx
);

677 
	`¬’a_deÿy_ticks
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
Áicks
);

678 
	`¬’a_deÿy_tick
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

679 *
	`¬’a_m®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
szšd_t
 
šd
,

680 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, boŞ 
¦ow_·th
);

681 
¬’a_t
 *
	`¬’a_¯Îoc
(cÚ¡ *
±r
);

682 
size_t
 
	`¬’a_§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
boŞ
 
demÙe
);

683 
	`¬’a_d®loc
(
tsdn_t
 *
tsdn
, *
±r
, 
tÿche_t
 *
tÿche
, 
boŞ
 
¦ow_·th
);

684 
	`¬’a_sd®loc
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
,

685 
boŞ
 
¦ow_·th
);

688 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_ARENA_C_
))

689 #ifdeà
JEMALLOC_ARENA_INLINE_A


690 
JEMALLOC_ALWAYS_INLINE
 
¬’a_chunk_m­_b™s_t
 *

691 
	$¬’a_b™£lm_g‘_mubË
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

694 
	`as£¹
(
·gešd
 >ğ
m­_bŸs
);

695 
	`as£¹
(
·gešd
 < 
chunk_Åages
);

697  (&
chunk
->
m­_b™s
[
·gešd
-
m­_bŸs
]);

698 
	}
}

700 
JEMALLOC_ALWAYS_INLINE
 cÚ¡ 
¬’a_chunk_m­_b™s_t
 *

701 
	$¬’a_b™£lm_g‘_cÚ¡
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

704  (
	`¬’a_b™£lm_g‘_mubË
((
¬’a_chunk_t
 *)
chunk
, 
·gešd
));

705 
	}
}

707 
JEMALLOC_ALWAYS_INLINE
 
¬’a_chunk_m­_misc_t
 *

708 
	$¬’a_misûlm_g‘_mubË
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

711 
	`as£¹
(
·gešd
 >ğ
m­_bŸs
);

712 
	`as£¹
(
·gešd
 < 
chunk_Åages
);

714  ((
¬’a_chunk_m­_misc_t
 *)((
ušŒ_t
)
chunk
 +

715 (
ušŒ_t
)
m­_misc_off£t
è+ 
·gešd
-
m­_bŸs
);

716 
	}
}

718 
JEMALLOC_ALWAYS_INLINE
 cÚ¡ 
¬’a_chunk_m­_misc_t
 *

719 
	$¬’a_misûlm_g‘_cÚ¡
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

722  (
	`¬’a_misûlm_g‘_mubË
((
¬’a_chunk_t
 *)
chunk
, 
·gešd
));

723 
	}
}

725 
JEMALLOC_ALWAYS_INLINE
 
size_t


726 
	$¬’a_misûlm_to_·gešd
(cÚ¡ 
¬’a_chunk_m­_misc_t
 *
misûlm
)

728 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(
misûlm
);

729 
size_t
 
·gešd
 = ((
ušŒ_t
)
misûlm
 - ((ušŒ_t)
chunk
 +

730 
m­_misc_off£t
)è/ (
¬’a_chunk_m­_misc_t
è+ 
m­_bŸs
;

732 
	`as£¹
(
·gešd
 >ğ
m­_bŸs
);

733 
	`as£¹
(
·gešd
 < 
chunk_Åages
);

735  (
·gešd
);

736 
	}
}

738 
JEMALLOC_ALWAYS_INLINE
 *

739 
	$¬’a_misûlm_to_½ages
(cÚ¡ 
¬’a_chunk_m­_misc_t
 *
misûlm
)

741 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(
misûlm
);

742 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

744  ((*)((
ušŒ_t
)
chunk
 + (
·gešd
 << 
LG_PAGE
)));

745 
	}
}

747 
JEMALLOC_ALWAYS_INLINE
 
¬’a_chunk_m­_misc_t
 *

748 
	$¬’a_rd_to_misûlm
(
¬’a_runs_dœty_lšk_t
 *
rd
)

750 
¬’a_chunk_m­_misc_t
 *
misûlm
 = (arena_chunk_map_misc_t

751 *)((
ušŒ_t
)
rd
 - 
	`off£tof
(
¬’a_chunk_m­_misc_t
,„d));

753 
	`as£¹
(
	`¬’a_misûlm_to_·gešd
(
misûlm
è>ğ
m­_bŸs
);

754 
	`as£¹
(
	`¬’a_misûlm_to_·gešd
(
misûlm
è< 
chunk_Åages
);

756  (
misûlm
);

757 
	}
}

759 
JEMALLOC_ALWAYS_INLINE
 
¬’a_chunk_m­_misc_t
 *

760 
	$¬’a_run_to_misûlm
(
¬’a_run_t
 *
run
)

762 
¬’a_chunk_m­_misc_t
 *
misûlm
 = (arena_chunk_map_misc_t

763 *)((
ušŒ_t
)
run
 - 
	`off£tof
(
¬’a_chunk_m­_misc_t
,„un));

765 
	`as£¹
(
	`¬’a_misûlm_to_·gešd
(
misûlm
è>ğ
m­_bŸs
);

766 
	`as£¹
(
	`¬’a_misûlm_to_·gešd
(
misûlm
è< 
chunk_Åages
);

768  (
misûlm
);

769 
	}
}

771 
JEMALLOC_ALWAYS_INLINE
 
size_t
 *

772 
	$¬’a_m­b™¥_g‘_mubË
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

775  (&
	`¬’a_b™£lm_g‘_mubË
(
chunk
, 
·gešd
)->
b™s
);

776 
	}
}

778 
JEMALLOC_ALWAYS_INLINE
 cÚ¡ 
size_t
 *

779 
	$¬’a_m­b™¥_g‘_cÚ¡
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

782  (
	`¬’a_m­b™¥_g‘_mubË
((
¬’a_chunk_t
 *)
chunk
, 
·gešd
));

783 
	}
}

785 
JEMALLOC_ALWAYS_INLINE
 
size_t


786 
	$¬’a_m­b™¥_»ad
(cÚ¡ 
size_t
 *
m­b™¥
)

789  (*
m­b™¥
);

790 
	}
}

792 
JEMALLOC_ALWAYS_INLINE
 
size_t


793 
	$¬’a_m­b™s_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

796  (
	`¬’a_m­b™¥_»ad
(
	`¬’a_m­b™¥_g‘_cÚ¡
(
chunk
, 
·gešd
)));

797 
	}
}

799 
JEMALLOC_ALWAYS_INLINE
 
size_t


800 
	$¬’a_m­b™s_size_decode
(
size_t
 
m­b™s
)

802 
size_t
 
size
;

804 #ià
CHUNK_MAP_SIZE_SHIFT
 > 0

805 
size
 = (
m­b™s
 & 
CHUNK_MAP_SIZE_MASK
è>> 
CHUNK_MAP_SIZE_SHIFT
;

806 #–ià
CHUNK_MAP_SIZE_SHIFT
 == 0

807 
size
 = 
m­b™s
 & 
CHUNK_MAP_SIZE_MASK
;

809 
size
 = (
m­b™s
 & 
CHUNK_MAP_SIZE_MASK
è<< -
CHUNK_MAP_SIZE_SHIFT
;

812  (
size
);

813 
	}
}

815 
JEMALLOC_ALWAYS_INLINE
 
size_t


816 
	$¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

818 
size_t
 
m­b™s
;

820 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

821 
	`as£¹
((
m­b™s
 & (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
)) == 0);

822  (
	`¬’a_m­b™s_size_decode
(
m­b™s
));

823 
	}
}

825 
JEMALLOC_ALWAYS_INLINE
 
size_t


826 
	$¬’a_m­b™s_Ïrge_size_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

828 
size_t
 
m­b™s
;

830 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

831 
	`as£¹
((
m­b™s
 & (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
)) ==

832 (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
));

833  (
	`¬’a_m­b™s_size_decode
(
m­b™s
));

834 
	}
}

836 
JEMALLOC_ALWAYS_INLINE
 
size_t


837 
	$¬’a_m­b™s_sm®l_runšd_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

839 
size_t
 
m­b™s
;

841 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

842 
	`as£¹
((
m­b™s
 & (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
)) ==

843 
CHUNK_MAP_ALLOCATED
);

844  (
m­b™s
 >> 
CHUNK_MAP_RUNIND_SHIFT
);

845 
	}
}

847 
JEMALLOC_ALWAYS_INLINE
 
szšd_t


848 
	$¬’a_m­b™s_bššd_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

850 
size_t
 
m­b™s
;

851 
szšd_t
 
bššd
;

853 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

854 
bššd
 = (
m­b™s
 & 
CHUNK_MAP_BININD_MASK
è>> 
CHUNK_MAP_BININD_SHIFT
;

855 
	`as£¹
(
bššd
 < 
NBINS
 || bššd =ğ
BININD_INVALID
);

856  (
bššd
);

857 
	}
}

859 
JEMALLOC_ALWAYS_INLINE
 
size_t


860 
	$¬’a_m­b™s_dœty_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

862 
size_t
 
m­b™s
;

864 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

865 
	`as£¹
((
m­b™s
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (mapbits &

866 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

867  (
m­b™s
 & 
CHUNK_MAP_DIRTY
);

868 
	}
}

870 
JEMALLOC_ALWAYS_INLINE
 
size_t


871 
	$¬’a_m­b™s_unz”Ûd_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

873 
size_t
 
m­b™s
;

875 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

876 
	`as£¹
((
m­b™s
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (mapbits &

877 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

878  (
m­b™s
 & 
CHUNK_MAP_UNZEROED
);

879 
	}
}

881 
JEMALLOC_ALWAYS_INLINE
 
size_t


882 
	$¬’a_m­b™s_decomm™‹d_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

884 
size_t
 
m­b™s
;

886 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

887 
	`as£¹
((
m­b™s
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (mapbits &

888 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

889  (
m­b™s
 & 
CHUNK_MAP_DECOMMITTED
);

890 
	}
}

892 
JEMALLOC_ALWAYS_INLINE
 
size_t


893 
	$¬’a_m­b™s_Ïrge_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

895 
size_t
 
m­b™s
;

897 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

898  (
m­b™s
 & 
CHUNK_MAP_LARGE
);

899 
	}
}

901 
JEMALLOC_ALWAYS_INLINE
 
size_t


902 
	$¬’a_m­b™s_®loÿ‹d_g‘
(cÚ¡ 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

904 
size_t
 
m­b™s
;

906 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

907  (
m­b™s
 & 
CHUNK_MAP_ALLOCATED
);

908 
	}
}

910 
JEMALLOC_ALWAYS_INLINE
 

911 
	$¬’a_m­b™¥_wr™e
(
size_t
 *
m­b™¥
, size_ˆ
m­b™s
)

914 *
m­b™¥
 = 
m­b™s
;

915 
	}
}

917 
JEMALLOC_ALWAYS_INLINE
 
size_t


918 
	$¬’a_m­b™s_size_’code
(
size_t
 
size
)

920 
size_t
 
m­b™s
;

922 #ià
CHUNK_MAP_SIZE_SHIFT
 > 0

923 
m­b™s
 = 
size
 << 
CHUNK_MAP_SIZE_SHIFT
;

924 #–ià
CHUNK_MAP_SIZE_SHIFT
 == 0

925 
m­b™s
 = 
size
;

927 
m­b™s
 = 
size
 >> -
CHUNK_MAP_SIZE_SHIFT
;

930 
	`as£¹
((
m­b™s
 & ~
CHUNK_MAP_SIZE_MASK
) == 0);

931  (
m­b™s
);

932 
	}
}

934 
JEMALLOC_ALWAYS_INLINE
 

935 
	$¬’a_m­b™s_uÇÎoÿ‹d_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
, size_ˆ
size
,

936 
size_t
 
æags
)

938 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘_mubË
(
chunk
, 
·gešd
);

940 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

941 
	`as£¹
((
æags
 & 
CHUNK_MAP_FLAGS_MASK
) == flags);

942 
	`as£¹
((
æags
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (flags &

943 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

944 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, 
	`¬’a_m­b™s_size_’code
(
size
) |

945 
CHUNK_MAP_BININD_INVALID
 | 
æags
);

946 
	}
}

948 
JEMALLOC_ALWAYS_INLINE
 

949 
	$¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

950 
size_t
 
size
)

952 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘_mubË
(
chunk
, 
·gešd
);

953 
size_t
 
m­b™s
 = 
	`¬’a_m­b™¥_»ad
(
m­b™¥
);

955 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

956 
	`as£¹
((
m­b™s
 & (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
)) == 0);

957 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, 
	`¬’a_m­b™s_size_’code
(
size
) |

958 (
m­b™s
 & ~
CHUNK_MAP_SIZE_MASK
));

959 
	}
}

961 
JEMALLOC_ALWAYS_INLINE
 

962 
	$¬’a_m­b™s_š‹º®_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
, size_ˆ
æags
)

964 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘_mubË
(
chunk
, 
·gešd
);

966 
	`as£¹
((
æags
 & 
CHUNK_MAP_UNZEROED
) == flags);

967 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, 
æags
);

968 
	}
}

970 
JEMALLOC_ALWAYS_INLINE
 

971 
	$¬’a_m­b™s_Ïrge_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
, size_ˆ
size
,

972 
size_t
 
æags
)

974 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘_mubË
(
chunk
, 
·gešd
);

976 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

977 
	`as£¹
((
æags
 & 
CHUNK_MAP_FLAGS_MASK
) == flags);

978 
	`as£¹
((
æags
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (flags &

979 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

980 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, 
	`¬’a_m­b™s_size_’code
(
size
) |

981 
CHUNK_MAP_BININD_INVALID
 | 
æags
 | 
CHUNK_MAP_LARGE
 |

982 
CHUNK_MAP_ALLOCATED
);

983 
	}
}

985 
JEMALLOC_ALWAYS_INLINE
 

986 
	$¬’a_m­b™s_Ïrge_bššd_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

987 
szšd_t
 
bššd
)

989 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘_mubË
(
chunk
, 
·gešd
);

990 
size_t
 
m­b™s
 = 
	`¬’a_m­b™¥_»ad
(
m­b™¥
);

992 
	`as£¹
(
bššd
 <ğ
BININD_INVALID
);

993 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
è=ğ
LARGE_MINCLASS
 +

994 
Ïrge_·d
);

995 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, (
m­b™s
 & ~
CHUNK_MAP_BININD_MASK
) |

996 (
bššd
 << 
CHUNK_MAP_BININD_SHIFT
));

997 
	}
}

999 
JEMALLOC_ALWAYS_INLINE
 

1000 
	$¬’a_m­b™s_sm®l_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
, size_ˆ
runšd
,

1001 
szšd_t
 
bššd
, 
size_t
 
æags
)

1003 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘_mubË
(
chunk
, 
·gešd
);

1005 
	`as£¹
(
bššd
 < 
BININD_INVALID
);

1006 
	`as£¹
(
·gešd
 - 
runšd
 >ğ
m­_bŸs
);

1007 
	`as£¹
((
æags
 & 
CHUNK_MAP_UNZEROED
) == flags);

1008 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, (
runšd
 << 
CHUNK_MAP_RUNIND_SHIFT
) |

1009 (
bššd
 << 
CHUNK_MAP_BININD_SHIFT
è| 
æags
 | 
CHUNK_MAP_ALLOCATED
);

1010 
	}
}

1012 
JEMALLOC_INLINE
 

1013 
	$¬’a_m‘ad©a_®loÿ‹d_add
(
¬’a_t
 *
¬’a
, 
size_t
 
size
)

1016 
	`©omic_add_z
(&
¬’a
->
¡©s
.
m‘ad©a_®loÿ‹d
, 
size
);

1017 
	}
}

1019 
JEMALLOC_INLINE
 

1020 
	$¬’a_m‘ad©a_®loÿ‹d_sub
(
¬’a_t
 *
¬’a
, 
size_t
 
size
)

1023 
	`©omic_sub_z
(&
¬’a
->
¡©s
.
m‘ad©a_®loÿ‹d
, 
size
);

1024 
	}
}

1026 
JEMALLOC_INLINE
 
size_t


1027 
	$¬’a_m‘ad©a_®loÿ‹d_g‘
(
¬’a_t
 *
¬’a
)

1030  (
	`©omic_»ad_z
(&
¬’a
->
¡©s
.
m‘ad©a_®loÿ‹d
));

1031 
	}
}

1033 
JEMALLOC_INLINE
 
boŞ


1034 
	$¬’a_´of_accum_im¶
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
)

1037 
	`ÿs£¹
(
cÚfig_´of
);

1038 
	`as£¹
(
´of_š‹rv®
 != 0);

1040 
¬’a
->
´of_accumby‹s
 +ğ
accumby‹s
;

1041 ià(
¬’a
->
´of_accumby‹s
 >ğ
´of_š‹rv®
) {

1042 
¬’a
->
´of_accumby‹s
 -ğ
´of_š‹rv®
;

1043  (
Œue
);

1045  (
çl£
);

1046 
	}
}

1048 
JEMALLOC_INLINE
 
boŞ


1049 
	$¬’a_´of_accum_locked
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
)

1052 
	`ÿs£¹
(
cÚfig_´of
);

1054 ià(
	`lik–y
(
´of_š‹rv®
 == 0))

1055  (
çl£
);

1056  (
	`¬’a_´of_accum_im¶
(
¬’a
, 
accumby‹s
));

1057 
	}
}

1059 
JEMALLOC_INLINE
 
boŞ


1060 
	$¬’a_´of_accum
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
)

1063 
	`ÿs£¹
(
cÚfig_´of
);

1065 ià(
	`lik–y
(
´of_š‹rv®
 == 0))

1066  (
çl£
);

1069 
boŞ
 
»t
;

1071 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1072 
»t
 = 
	`¬’a_´of_accum_im¶
(
¬’a
, 
accumby‹s
);

1073 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1074  (
»t
);

1076 
	}
}

1078 
JEMALLOC_ALWAYS_INLINE
 
szšd_t


1079 
	$¬’a_±r_sm®l_bššd_g‘
(cÚ¡ *
±r
, 
size_t
 
m­b™s
)

1081 
szšd_t
 
bššd
;

1083 
bššd
 = (
m­b™s
 & 
CHUNK_MAP_BININD_MASK
è>> 
CHUNK_MAP_BININD_SHIFT
;

1085 ià(
cÚfig_debug
) {

1086 
¬’a_chunk_t
 *
chunk
;

1087 
¬’a_t
 *
¬’a
;

1088 
size_t
 
·gešd
;

1089 
size_t
 
aùu®_m­b™s
;

1090 
size_t
 
½ages_šd
;

1091 cÚ¡ 
¬’a_run_t
 *
run
;

1092 
¬’a_bš_t
 *
bš
;

1093 
szšd_t
 
run_bššd
, 
aùu®_bššd
;

1094 
¬’a_bš_šfo_t
 *
bš_šfo
;

1095 cÚ¡ 
¬’a_chunk_m­_misc_t
 *
misûlm
;

1096 cÚ¡ *
½ages
;

1098 
	`as£¹
(
bššd
 !ğ
BININD_INVALID
);

1099 
	`as£¹
(
bššd
 < 
NBINS
);

1100 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1101 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
);

1102 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

1103 
aùu®_m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

1104 
	`as£¹
(
m­b™s
 =ğ
aùu®_m­b™s
);

1105 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) == 0);

1106 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0);

1107 
½ages_šd
 = 
·gešd
 - 
	`¬’a_m­b™s_sm®l_runšd_g‘
(
chunk
,

1108 
·gešd
);

1109 
misûlm
 = 
	`¬’a_misûlm_g‘_cÚ¡
(
chunk
, 
½ages_šd
);

1110 
run
 = &
misûlm
->run;

1111 
run_bššd
 = 
run
->
bššd
;

1112 
bš
 = &
¬’a
->
bšs
[
run_bššd
];

1113 
aùu®_bššd
 = (
szšd_t
)(
bš
 - 
¬’a
->
bšs
);

1114 
	`as£¹
(
run_bššd
 =ğ
aùu®_bššd
);

1115 
bš_šfo
 = &
¬’a_bš_šfo
[
aùu®_bššd
];

1116 
½ages
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

1117 
	`as£¹
(((
ušŒ_t
)
±r
 - ((ušŒ_t)
½ages
 +

1118 (
ušŒ_t
)
bš_šfo
->
»g0_off£t
)è% bš_šfo->
»g_š‹rv®


1122  (
bššd
);

1123 
	}
}

1126 #ifdeà
JEMALLOC_ARENA_INLINE_B


1127 
JEMALLOC_INLINE
 
szšd_t


1128 
	$¬’a_bš_šdex
(
¬’a_t
 *
¬’a
, 
¬’a_bš_t
 *
bš
)

1130 
szšd_t
 
bššd
 = (szšd_t)(
bš
 - 
¬’a
->
bšs
);

1131 
	`as£¹
(
bššd
 < 
NBINS
);

1132  (
bššd
);

1133 
	}
}

1135 
JEMALLOC_INLINE
 
size_t


1136 
	$¬’a_run_»gšd
(
¬’a_run_t
 *
run
, 
¬’a_bš_šfo_t
 *
bš_šfo
, cÚ¡ *
±r
)

1138 
size_t
 
diff
, 
š‹rv®
, 
shiá
, 
»gšd
;

1139 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

1140 *
½ages
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

1146 
	`as£¹
((
ušŒ_t
)
±r
 >ğ(ušŒ_t)
½ages
 +

1147 (
ušŒ_t
)
bš_šfo
->
»g0_off£t
);

1153 
diff
 = (
size_t
)((
ušŒ_t
)
±r
 - (ušŒ_t)
½ages
 -

1154 
bš_šfo
->
»g0_off£t
);

1157 
š‹rv®
 = 
bš_šfo
->
»g_š‹rv®
;

1158 
shiá
 = 
	`ffs_zu
(
š‹rv®
) - 1;

1159 
diff
 >>ğ
shiá
;

1160 
š‹rv®
 >>ğ
shiá
;

1162 ià(
š‹rv®
 == 1) {

1164 
»gšd
 = 
diff
;

1180 
	#SIZE_INV_SHIFT
 (((
size_t
è<< 3è- 
LG_RUN_MAXREGS
)

	)

1181 
	#SIZE_INV
(
s
è(((
	`ZU
(1è<< 
SIZE_INV_SHIFT
è/ (s)è+ 1)

	)

1182 cÚ¡ 
size_t
 
š‹rv®_švs
[] = {

1183 
	`SIZE_INV
(3),

1184 
	`SIZE_INV
(4), SIZE_INV(5), SIZE_INV(6), SIZE_INV(7),

1185 
	`SIZE_INV
(8), SIZE_INV(9), SIZE_INV(10), SIZE_INV(11),

1186 
	`SIZE_INV
(12), SIZE_INV(13), SIZE_INV(14), SIZE_INV(15),

1187 
	`SIZE_INV
(16), SIZE_INV(17), SIZE_INV(18), SIZE_INV(19),

1188 
	`SIZE_INV
(20), SIZE_INV(21), SIZE_INV(22), SIZE_INV(23),

1189 
	`SIZE_INV
(24), SIZE_INV(25), SIZE_INV(26), SIZE_INV(27),

1190 
	`SIZE_INV
(28), SIZE_INV(29), SIZE_INV(30), SIZE_INV(31)

1193 ià(
	`lik–y
(
š‹rv®
 <ğ(((
š‹rv®_švs
è/ (
size_t
))

1195 
»gšd
 = (
diff
 * 
š‹rv®_švs
[
š‹rv®
 - 3]) >>

1196 
SIZE_INV_SHIFT
;

1198 
»gšd
 = 
diff
 / 
š‹rv®
;

1199 #undeà
SIZE_INV


1200 #undeà
SIZE_INV_SHIFT


1202 
	`as£¹
(
diff
 =ğ
»gšd
 * 
š‹rv®
);

1203 
	`as£¹
(
»gšd
 < 
bš_šfo
->
Äegs
);

1205  (
»gšd
);

1206 
	}
}

1208 
JEMALLOC_INLINE
 
´of_tùx_t
 *

1209 
	$¬’a_´of_tùx_g‘
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
)

1211 
´of_tùx_t
 *
»t
;

1212 
¬’a_chunk_t
 *
chunk
;

1214 
	`ÿs£¹
(
cÚfig_´of
);

1215 
	`as£¹
(
±r
 !ğ
NULL
);

1217 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1218 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1219 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

1220 
size_t
 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

1221 
	`as£¹
((
m­b™s
 & 
CHUNK_MAP_ALLOCATED
) != 0);

1222 ià(
	`lik–y
((
m­b™s
 & 
CHUNK_MAP_LARGE
) == 0))

1223 
»t
 = (
´of_tùx_t
 *)(
ušŒ_t
)1U;

1225 
¬’a_chunk_m­_misc_t
 *
–m
 =

1226 
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
·gešd
);

1227 
»t
 = 
	`©omic_»ad_p
(&
–m
->
´of_tùx_pun
);

1230 
»t
 = 
	`huge_´of_tùx_g‘
(
tsdn
, 
±r
);

1232  (
»t
);

1233 
	}
}

1235 
JEMALLOC_INLINE
 

1236 
	$¬’a_´of_tùx_£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
,

1237 
´of_tùx_t
 *
tùx
)

1239 
¬’a_chunk_t
 *
chunk
;

1241 
	`ÿs£¹
(
cÚfig_´of
);

1242 
	`as£¹
(
±r
 !ğ
NULL
);

1244 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1245 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1246 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

1248 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0);

1250 ià(
	`uÆik–y
(
usize
 > 
SMALL_MAXCLASS
 || (
ušŒ_t
)
tùx
 >

1251 (
ušŒ_t
)1U)) {

1252 
¬’a_chunk_m­_misc_t
 *
–m
;

1254 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0);

1256 
–m
 = 
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
·gešd
);

1257 
	`©omic_wr™e_p
(&
–m
->
´of_tùx_pun
, 
tùx
);

1265 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) == 0);

1268 
	`huge_´of_tùx_£t
(
tsdn
, 
±r
, 
tùx
);

1269 
	}
}

1271 
JEMALLOC_INLINE
 

1272 
	$¬’a_´of_tùx_»£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
,

1273 cÚ¡ *
Şd_±r
, 
´of_tùx_t
 *
Şd_tùx
)

1276 
	`ÿs£¹
(
cÚfig_´of
);

1277 
	`as£¹
(
±r
 !ğ
NULL
);

1279 ià(
	`uÆik–y
(
usize
 > 
SMALL_MAXCLASS
 || (
±r
 =ğ
Şd_±r
 &&

1280 (
ušŒ_t
)
Şd_tùx
 > (uintptr_t)1U))) {

1281 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(
±r
);

1282 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1283 
size_t
 
·gešd
;

1284 
¬’a_chunk_m­_misc_t
 *
–m
;

1286 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
) >>

1287 
LG_PAGE
;

1288 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) !=

1290 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0);

1292 
–m
 = 
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
·gešd
);

1293 
	`©omic_wr™e_p
(&
–m
->
´of_tùx_pun
,

1294 (
´of_tùx_t
 *)(
ušŒ_t
)1U);

1296 
	`huge_´of_tùx_»£t
(
tsdn
, 
±r
);

1298 
	}
}

1300 
JEMALLOC_ALWAYS_INLINE
 

1301 
	$¬’a_deÿy_ticks
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
Áicks
)

1303 
tsd_t
 *
tsd
;

1304 
tick”_t
 *
deÿy_tick”
;

1306 ià(
	`uÆik–y
(
	`tsdn_nuÎ
(
tsdn
)))

1308 
tsd
 = 
	`tsdn_tsd
(
tsdn
);

1309 
deÿy_tick”
 = 
	`deÿy_tick”_g‘
(
tsd
, 
¬’a
->
šd
);

1310 ià(
	`uÆik–y
(
deÿy_tick”
 =ğ
NULL
))

1312 ià(
	`uÆik–y
(
	`tick”_ticks
(
deÿy_tick”
, 
Áicks
)))

1313 
	`¬’a_purge
(
tsdn
, 
¬’a
, 
çl£
);

1314 
	}
}

1316 
JEMALLOC_ALWAYS_INLINE
 

1317 
	$¬’a_deÿy_tick
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

1320 
	`¬’a_deÿy_ticks
(
tsdn
, 
¬’a
, 1);

1321 
	}
}

1323 
JEMALLOC_ALWAYS_INLINE
 *

1324 
	$¬’a_m®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
szšd_t
 
šd
, 
boŞ
 
z”o
,

1325 
tÿche_t
 *
tÿche
, 
boŞ
 
¦ow_·th
)

1328 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
è|| 
tÿche
 =ğ
NULL
);

1329 
	`as£¹
(
size
 != 0);

1331 ià(
	`lik–y
(
tÿche
 !ğ
NULL
)) {

1332 ià(
	`lik–y
(
size
 <ğ
SMALL_MAXCLASS
)) {

1333  (
	`tÿche_®loc_sm®l
(
	`tsdn_tsd
(
tsdn
), 
¬’a
,

1334 
tÿche
, 
size
, 
šd
, 
z”o
, 
¦ow_·th
));

1336 ià(
	`lik–y
(
size
 <ğ
tÿche_maxşass
)) {

1337  (
	`tÿche_®loc_Ïrge
(
	`tsdn_tsd
(
tsdn
), 
¬’a
,

1338 
tÿche
, 
size
, 
šd
, 
z”o
, 
¦ow_·th
));

1341 
	`as£¹
(
size
 > 
tÿche_maxşass
);

1344  (
	`¬’a_m®loc_h¬d
(
tsdn
, 
¬’a
, 
size
, 
šd
, 
z”o
));

1345 
	}
}

1347 
JEMALLOC_ALWAYS_INLINE
 
¬’a_t
 *

1348 
	$¬’a_¯Îoc
(cÚ¡ *
±r
)

1350 
¬’a_chunk_t
 *
chunk
;

1352 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1353 ià(
	`lik–y
(
chunk
 !ğ
±r
))

1354  (
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
));

1356  (
	`huge_¯Îoc
(
±r
));

1357 
	}
}

1360 
JEMALLOC_ALWAYS_INLINE
 
size_t


1361 
	$¬’a_§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
boŞ
 
demÙe
)

1363 
size_t
 
»t
;

1364 
¬’a_chunk_t
 *
chunk
;

1365 
size_t
 
·gešd
;

1366 
szšd_t
 
bššd
;

1368 
	`as£¹
(
±r
 !ğ
NULL
);

1370 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1371 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1372 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

1373 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0);

1374 
bššd
 = 
	`¬’a_m­b™s_bššd_g‘
(
chunk
, 
·gešd
);

1375 ià(
	`uÆik–y
(
bššd
 =ğ
BININD_INVALID
 || (
cÚfig_´of
 && !
demÙe


1376 && 
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0))) {

1383 
	`as£¹
(
cÚfig_ÿche_oblivious
 || ((
ušŒ_t
)
±r
 &

1384 
PAGE_MASK
) == 0);

1385 
»t
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
) -

1386 
Ïrge_·d
;

1387 
	`as£¹
(
»t
 != 0);

1388 
	`as£¹
(
·gešd
 + ((
»t
+
Ïrge_·d
)>>
LG_PAGE
) <=

1389 
chunk_Åages
);

1390 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
) ==

1391 
	`¬’a_m­b™s_dœty_g‘
(
chunk
,

1392 
·gešd
+((
»t
+
Ïrge_·d
)>>
LG_PAGE
)-1));

1398 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0 ||

1399 
	`¬’a_±r_sm®l_bššd_g‘
(
±r
,

1400 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
)è=ğ
bššd
);

1401 
»t
 = 
	`šdex2size
(
bššd
);

1404 
»t
 = 
	`huge_§Îoc
(
tsdn
, 
±r
);

1406  (
»t
);

1407 
	}
}

1409 
JEMALLOC_ALWAYS_INLINE
 

1410 
	$¬’a_d®loc
(
tsdn_t
 *
tsdn
, *
±r
, 
tÿche_t
 *
tÿche
, 
boŞ
 
¦ow_·th
)

1412 
¬’a_chunk_t
 *
chunk
;

1413 
size_t
 
·gešd
, 
m­b™s
;

1415 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
è|| 
tÿche
 =ğ
NULL
);

1416 
	`as£¹
(
±r
 !ğ
NULL
);

1418 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1419 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1420 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

1421 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

1422 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0);

1423 ià(
	`lik–y
((
m­b™s
 & 
CHUNK_MAP_LARGE
) == 0)) {

1425 ià(
	`lik–y
(
tÿche
 !ğ
NULL
)) {

1426 
szšd_t
 
bššd
 = 
	`¬’a_±r_sm®l_bššd_g‘
(
±r
,

1427 
m­b™s
);

1428 
	`tÿche_d®loc_sm®l
(
	`tsdn_tsd
(
tsdn
), 
tÿche
, 
±r
,

1429 
bššd
, 
¦ow_·th
);

1431 
	`¬’a_d®loc_sm®l
(
tsdn
,

1432 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
), chunk,

1433 
±r
, 
·gešd
);

1436 
size_t
 
size
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

1437 
·gešd
);

1439 
	`as£¹
(
cÚfig_ÿche_oblivious
 || ((
ušŒ_t
)
±r
 &

1440 
PAGE_MASK
) == 0);

1442 ià(
	`lik–y
(
tÿche
 !ğ
NULL
è&& 
size
 - 
Ïrge_·d
 <=

1443 
tÿche_maxşass
) {

1444 
	`tÿche_d®loc_Ïrge
(
	`tsdn_tsd
(
tsdn
), 
tÿche
, 
±r
,

1445 
size
 - 
Ïrge_·d
, 
¦ow_·th
);

1447 
	`¬’a_d®loc_Ïrge
(
tsdn
,

1448 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
), chunk,

1449 
±r
);

1453 
	`huge_d®loc
(
tsdn
, 
±r
);

1454 
	}
}

1456 
JEMALLOC_ALWAYS_INLINE
 

1457 
	$¬’a_sd®loc
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
,

1458 
boŞ
 
¦ow_·th
)

1460 
¬’a_chunk_t
 *
chunk
;

1462 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
è|| 
tÿche
 =ğ
NULL
);

1464 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1465 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1466 ià(
cÚfig_´of
 && 
İt_´of
) {

1467 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
) >>

1468 
LG_PAGE
;

1469 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) !=

1471 ià(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0) {

1476 
size
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

1477 
·gešd
è- 
Ïrge_·d
;

1480 
	`as£¹
(
	`s2u
(
size
è=ğs2u(
	`¬’a_§Îoc
(
tsdn
, 
±r
, 
çl£
)));

1482 ià(
	`lik–y
(
size
 <ğ
SMALL_MAXCLASS
)) {

1484 ià(
	`lik–y
(
tÿche
 !ğ
NULL
)) {

1485 
szšd_t
 
bššd
 = 
	`size2šdex
(
size
);

1486 
	`tÿche_d®loc_sm®l
(
	`tsdn_tsd
(
tsdn
), 
tÿche
, 
±r
,

1487 
bššd
, 
¦ow_·th
);

1489 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 -

1490 (
ušŒ_t
)
chunk
è>> 
LG_PAGE
;

1491 
	`¬’a_d®loc_sm®l
(
tsdn
,

1492 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
), chunk,

1493 
±r
, 
·gešd
);

1496 
	`as£¹
(
cÚfig_ÿche_oblivious
 || ((
ušŒ_t
)
±r
 &

1497 
PAGE_MASK
) == 0);

1499 ià(
	`lik–y
(
tÿche
 !ğ
NULL
è&& 
size
 <ğ
tÿche_maxşass
) {

1500 
	`tÿche_d®loc_Ïrge
(
	`tsdn_tsd
(
tsdn
), 
tÿche
, 
±r
,

1501 
size
, 
¦ow_·th
);

1503 
	`¬’a_d®loc_Ïrge
(
tsdn
,

1504 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
), chunk,

1505 
±r
);

1509 
	`huge_d®loc
(
tsdn
, 
±r
);

1510 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/assert.h

5 #iâdeà
as£¹


6 
	#as£¹
(
e
) do { \

7 ià(
	`uÆik–y
(
cÚfig_debug
 && !(
e
))) { \

8 
	`m®loc_´štf
( \

10 
__FILE__
, 
__LINE__
, #e); \

11 
	`abÜt
(); \

13 } 0)

	)

16 #iâdeà
nÙ_»ached


17 
	#nÙ_»ached
() do { \

18 ià(
cÚfig_debug
) { \

19 
	`m®loc_´štf
( \

21 
__FILE__
, 
__LINE__
); \

22 
	`abÜt
(); \

24 
	`uÄ—chabË
(); \

25 } 0)

	)

28 #iâdeà
nÙ_im¶em’‹d


29 
	#nÙ_im¶em’‹d
() do { \

30 ià(
cÚfig_debug
) { \

31 
	`m®loc_´štf
("<jemalloc>: %s:%d: Not implemented\n", \

32 
__FILE__
, 
__LINE__
); \

33 
	`abÜt
(); \

35 } 0)

	)

38 #iâdeà
as£¹_nÙ_im¶em’‹d


39 
	#as£¹_nÙ_im¶em’‹d
(
e
) do { \

40 ià(
	`uÆik–y
(
cÚfig_debug
 && !(
e
))) \

41 
	`nÙ_im¶em’‹d
(); \

42 } 0)

	)

	@dep/jemalloc-4.2.0/include/jemalloc/internal/atomic.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 
	#©omic_»ad_ušt64
(
p
è
	`©omic_add_ušt64
Õ, 0)

	)

13 
	#©omic_»ad_ušt32
(
p
è
	`©omic_add_ušt32
Õ, 0)

	)

14 
	#©omic_»ad_p
(
p
è
	`©omic_add_p
Õ, 
NULL
)

	)

15 
	#©omic_»ad_z
(
p
è
	`©omic_add_z
Õ, 0)

	)

16 
	#©omic_»ad_u
(
p
è
	`©omic_add_u
Õ, 0)

	)

20 #ifdeà
JEMALLOC_H_INLINES


43 #iâdeà
JEMALLOC_ENABLE_INLINE


44 
ušt64_t
 
©omic_add_ušt64
(ušt64_ˆ*
p
, ušt64_ˆ
x
);

45 
ušt64_t
 
©omic_sub_ušt64
(ušt64_ˆ*
p
, ušt64_ˆ
x
);

46 
boŞ
 
©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
);

47 
©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
);

48 
ušt32_t
 
©omic_add_ušt32
(ušt32_ˆ*
p
, ušt32_ˆ
x
);

49 
ušt32_t
 
©omic_sub_ušt32
(ušt32_ˆ*
p
, ušt32_ˆ
x
);

50 
boŞ
 
©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
);

51 
©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
);

52 *
©omic_add_p
(**
p
, *
x
);

53 *
©omic_sub_p
(**
p
, *
x
);

54 
boŞ
 
©omic_ÿs_p
(**
p
, *
c
, *
s
);

55 
©omic_wr™e_p
(**
p
, cÚ¡ *
x
);

56 
size_t
 
©omic_add_z
(size_ˆ*
p
, size_ˆ
x
);

57 
size_t
 
©omic_sub_z
(size_ˆ*
p
, size_ˆ
x
);

58 
boŞ
 
©omic_ÿs_z
(
size_t
 *
p
, size_ˆ
c
, size_ˆ
s
);

59 
©omic_wr™e_z
(
size_t
 *
p
, size_ˆ
x
);

60 
©omic_add_u
(*
p
, 
x
);

61 
©omic_sub_u
(*
p
, 
x
);

62 
boŞ
 
©omic_ÿs_u
(*
p
, 
c
, 
s
);

63 
©omic_wr™e_u
(*
p
, 
x
);

66 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_ATOMIC_C_
))

69 #ià(
LG_SIZEOF_PTR
 =ğ3 || 
LG_SIZEOF_INT
 == 3)

70 #ià(
defšed
(
__amd64__
è|| defšed(
__x86_64__
))

71 
JEMALLOC_INLINE
 
ušt64_t


72 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

74 
ušt64_t
 
t
 = 
x
;

76 
asm
 volatile (

78 : "+r" (
t
), "=m" (*
p
)

79 : "m" (*
p
)

82  (
t
 + 
x
);

83 
	}
}

85 
JEMALLOC_INLINE
 
ušt64_t


86 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

88 
ušt64_t
 
t
;

90 
x
 = (
ušt64_t
)(-(
št64_t
)x);

91 
t
 = 
x
;

92 
asm
 volatile (

94 : "+r" (
t
), "=m" (*
p
)

95 : "m" (*
p
)

98  (
t
 + 
x
);

99 
	}
}

101 
JEMALLOC_INLINE
 
boŞ


102 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

104 
ušt8_t
 
sucûss
;

106 
asm
 volatile (

109 : "=m" (*
p
), "÷" (
sucûss
)

110 : "m" (*
p
), "a" (
c
), "r" (
s
)

114  (!(
boŞ
)
sucûss
);

115 
	}
}

117 
JEMALLOC_INLINE
 

118 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

121 
asm
 volatile (

123 : "=m" (*
p
), "+r" (
x
)

124 : "m" (*
p
)

127 
	}
}

128 #–ià(
defšed
(
JEMALLOC_C11ATOMICS
))

129 
JEMALLOC_INLINE
 
ušt64_t


130 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

132 vŞ©
©omic_ušt_Ëa¡64_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡64_ˆ*)
p
;

133  (
	`©omic_ãtch_add
(
a
, 
x
) + x);

134 
	}
}

136 
JEMALLOC_INLINE
 
ušt64_t


137 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

139 vŞ©
©omic_ušt_Ëa¡64_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡64_ˆ*)
p
;

140  (
	`©omic_ãtch_sub
(
a
, 
x
) - x);

141 
	}
}

143 
JEMALLOC_INLINE
 
boŞ


144 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

146 vŞ©
©omic_ušt_Ëa¡64_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡64_ˆ*)
p
;

147  (!
	`©omic_com·»_exchªge_¡rÚg
(
a
, &
c
, 
s
));

148 
	}
}

150 
JEMALLOC_INLINE
 

151 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

153 vŞ©
©omic_ušt_Ëa¡64_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡64_ˆ*)
p
;

154 
	`©omic_¡Üe
(
a
, 
x
);

155 
	}
}

156 #–ià(
defšed
(
JEMALLOC_ATOMIC9
))

157 
JEMALLOC_INLINE
 
ušt64_t


158 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

165 
	`as£¹
((
ušt64_t
) == ());

167  (
	`©omic_ãtchadd_lÚg
(
p
, ()
x
) + x);

168 
	}
}

170 
JEMALLOC_INLINE
 
ušt64_t


171 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

174 
	`as£¹
((
ušt64_t
) == ());

176  (
	`©omic_ãtchadd_lÚg
(
p
, ()(-()
x
)) - x);

177 
	}
}

179 
JEMALLOC_INLINE
 
boŞ


180 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

183 
	`as£¹
((
ušt64_t
) == ());

185  (!
	`©omic_cmp£t_lÚg
(
p
, ()
c
, ()
s
));

186 
	}
}

188 
JEMALLOC_INLINE
 

189 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

192 
	`as£¹
((
ušt64_t
) == ());

194 
	`©omic_¡Üe_»l_lÚg
(
p
, 
x
);

195 
	}
}

196 #–ià(
defšed
(
JEMALLOC_OSATOMIC
))

197 
JEMALLOC_INLINE
 
ušt64_t


198 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

201  (
	`OSAtomicAdd64
((
št64_t
)
x
, (št64_ˆ*)
p
));

202 
	}
}

204 
JEMALLOC_INLINE
 
ušt64_t


205 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

208  (
	`OSAtomicAdd64
(-((
št64_t
)
x
), (št64_ˆ*)
p
));

209 
	}
}

211 
JEMALLOC_INLINE
 
boŞ


212 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

215  (!
	`OSAtomicCom·»AndSw­64
(
c
, 
s
, (
št64_t
 *)
p
));

216 
	}
}

218 
JEMALLOC_INLINE
 

219 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

221 
ušt64_t
 
o
;

225 
o
 = 
	`©omic_»ad_ušt64
(
p
);

226 } 
	`©omic_ÿs_ušt64
(
p
, 
o
, 
x
));

227 
	}
}

228 #–ià(
defšed
(
_MSC_VER
))

229 
JEMALLOC_INLINE
 
ušt64_t


230 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

233  (
	`IÁ”lockedExchªgeAdd64
(
p
, 
x
) + x);

234 
	}
}

236 
JEMALLOC_INLINE
 
ušt64_t


237 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

240  (
	`IÁ”lockedExchªgeAdd64
(
p
, -((
št64_t
)
x
)) - x);

241 
	}
}

243 
JEMALLOC_INLINE
 
boŞ


244 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

246 
ušt64_t
 
o
;

248 
o
 = 
	`IÁ”lockedCom·»Exchªge64
(
p
, 
s
, 
c
);

249  (
o
 !ğ
c
);

250 
	}
}

252 
JEMALLOC_INLINE
 

253 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

256 
	`IÁ”lockedExchªge64
(
p
, 
x
);

257 
	}
}

258 #–ià(
defšed
(
__GCC_HAVE_SYNC_COMPARE_AND_SWAP_8
) || \

259 
	$defšed
(
JE_FORCE_SYNC_COMPARE_AND_SWAP_8
))

260 
JEMALLOC_INLINE
 
ušt64_t


261 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

264  (
	`__sync_add_ªd_ãtch
(
p
, 
x
));

265 
	}
}

267 
JEMALLOC_INLINE
 
ušt64_t


268 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

271  (
	`__sync_sub_ªd_ãtch
(
p
, 
x
));

272 
	}
}

274 
JEMALLOC_INLINE
 
boŞ


275 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

278  (!
	`__sync_boŞ_com·»_ªd_sw­
(
p
, 
c
, 
s
));

279 
	}
}

281 
JEMALLOC_INLINE
 

282 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

285 
	`__sync_lock_‹¡_ªd_£t
(
p
, 
x
);

286 
	}
}

294 #ià(
defšed
(
__i386__
è|| defšed(
__amd64__
è|| defšed(
__x86_64__
))

295 
JEMALLOC_INLINE
 
ušt32_t


296 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

298 
ušt32_t
 
t
 = 
x
;

300 
asm
 volatile (

302 : "+r" (
t
), "=m" (*
p
)

303 : "m" (*
p
)

306  (
t
 + 
x
);

307 
	}
}

309 
JEMALLOC_INLINE
 
ušt32_t


310 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

312 
ušt32_t
 
t
;

314 
x
 = (
ušt32_t
)(-(
št32_t
)x);

315 
t
 = 
x
;

316 
asm
 volatile (

318 : "+r" (
t
), "=m" (*
p
)

319 : "m" (*
p
)

322  (
t
 + 
x
);

323 
	}
}

325 
JEMALLOC_INLINE
 
boŞ


326 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

328 
ušt8_t
 
sucûss
;

330 
asm
 volatile (

333 : "=m" (*
p
), "÷" (
sucûss
)

334 : "m" (*
p
), "a" (
c
), "r" (
s
)

338  (!(
boŞ
)
sucûss
);

339 
	}
}

341 
JEMALLOC_INLINE
 

342 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

345 
asm
 volatile (

347 : "=m" (*
p
), "+r" (
x
)

348 : "m" (*
p
)

351 
	}
}

352 #–ià(
defšed
(
JEMALLOC_C11ATOMICS
))

353 
JEMALLOC_INLINE
 
ušt32_t


354 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

356 vŞ©
©omic_ušt_Ëa¡32_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡32_ˆ*)
p
;

357  (
	`©omic_ãtch_add
(
a
, 
x
) + x);

358 
	}
}

360 
JEMALLOC_INLINE
 
ušt32_t


361 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

363 vŞ©
©omic_ušt_Ëa¡32_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡32_ˆ*)
p
;

364  (
	`©omic_ãtch_sub
(
a
, 
x
) - x);

365 
	}
}

367 
JEMALLOC_INLINE
 
boŞ


368 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

370 vŞ©
©omic_ušt_Ëa¡32_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡32_ˆ*)
p
;

371  (!
	`©omic_com·»_exchªge_¡rÚg
(
a
, &
c
, 
s
));

372 
	}
}

374 
JEMALLOC_INLINE
 

375 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

377 vŞ©
©omic_ušt_Ëa¡32_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡32_ˆ*)
p
;

378 
	`©omic_¡Üe
(
a
, 
x
);

379 
	}
}

380 #–ià(
defšed
(
JEMALLOC_ATOMIC9
))

381 
JEMALLOC_INLINE
 
ušt32_t


382 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

385  (
	`©omic_ãtchadd_32
(
p
, 
x
) + x);

386 
	}
}

388 
JEMALLOC_INLINE
 
ušt32_t


389 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

392  (
	`©omic_ãtchadd_32
(
p
, (
ušt32_t
)(-(
št32_t
)
x
)) - x);

393 
	}
}

395 
JEMALLOC_INLINE
 
boŞ


396 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

399  (!
	`©omic_cmp£t_32
(
p
, 
c
, 
s
));

400 
	}
}

402 
JEMALLOC_INLINE
 

403 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

406 
	`©omic_¡Üe_»l_32
(
p
, 
x
);

407 
	}
}

408 #–ià(
defšed
(
JEMALLOC_OSATOMIC
))

409 
JEMALLOC_INLINE
 
ušt32_t


410 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

413  (
	`OSAtomicAdd32
((
št32_t
)
x
, (št32_ˆ*)
p
));

414 
	}
}

416 
JEMALLOC_INLINE
 
ušt32_t


417 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

420  (
	`OSAtomicAdd32
(-((
št32_t
)
x
), (št32_ˆ*)
p
));

421 
	}
}

423 
JEMALLOC_INLINE
 
boŞ


424 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

427  (!
	`OSAtomicCom·»AndSw­32
(
c
, 
s
, (
št32_t
 *)
p
));

428 
	}
}

430 
JEMALLOC_INLINE
 

431 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

433 
ušt32_t
 
o
;

437 
o
 = 
	`©omic_»ad_ušt32
(
p
);

438 } 
	`©omic_ÿs_ušt32
(
p
, 
o
, 
x
));

439 
	}
}

440 #–ià(
defšed
(
_MSC_VER
))

441 
JEMALLOC_INLINE
 
ušt32_t


442 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

445  (
	`IÁ”lockedExchªgeAdd
(
p
, 
x
) + x);

446 
	}
}

448 
JEMALLOC_INLINE
 
ušt32_t


449 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

452  (
	`IÁ”lockedExchªgeAdd
(
p
, -((
št32_t
)
x
)) - x);

453 
	}
}

455 
JEMALLOC_INLINE
 
boŞ


456 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

458 
ušt32_t
 
o
;

460 
o
 = 
	`IÁ”lockedCom·»Exchªge
(
p
, 
s
, 
c
);

461  (
o
 !ğ
c
);

462 
	}
}

464 
JEMALLOC_INLINE
 

465 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

468 
	`IÁ”lockedExchªge
(
p
, 
x
);

469 
	}
}

470 #–ià(
defšed
(
__GCC_HAVE_SYNC_COMPARE_AND_SWAP_4
) || \

471 
	$defšed
(
JE_FORCE_SYNC_COMPARE_AND_SWAP_4
))

472 
JEMALLOC_INLINE
 
ušt32_t


473 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

476  (
	`__sync_add_ªd_ãtch
(
p
, 
x
));

477 
	}
}

479 
JEMALLOC_INLINE
 
ušt32_t


480 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

483  (
	`__sync_sub_ªd_ãtch
(
p
, 
x
));

484 
	}
}

486 
JEMALLOC_INLINE
 
boŞ


487 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

490  (!
	`__sync_boŞ_com·»_ªd_sw­
(
p
, 
c
, 
s
));

491 
	}
}

493 
JEMALLOC_INLINE
 

494 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

497 
	`__sync_lock_‹¡_ªd_£t
(
p
, 
x
);

498 
	}
}

505 
JEMALLOC_INLINE
 *

506 
	$©omic_add_p
(**
p
, *
x
)

509 #ià(
LG_SIZEOF_PTR
 == 3)

510  ((*)
	`©omic_add_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
));

511 #–ià(
LG_SIZEOF_PTR
 == 2)

512  ((*)
	`©omic_add_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
));

514 
	}
}

516 
JEMALLOC_INLINE
 *

517 
	$©omic_sub_p
(**
p
, *
x
)

520 #ià(
LG_SIZEOF_PTR
 == 3)

521  ((*)
	`©omic_add_ušt64
((
ušt64_t
 *)
p
,

522 (
ušt64_t
)-((
št64_t
)
x
)));

523 #–ià(
LG_SIZEOF_PTR
 == 2)

524  ((*)
	`©omic_add_ušt32
((
ušt32_t
 *)
p
,

525 (
ušt32_t
)-((
št32_t
)
x
)));

527 
	}
}

529 
JEMALLOC_INLINE
 
boŞ


530 
	$©omic_ÿs_p
(**
p
, *
c
, *
s
)

533 #ià(
LG_SIZEOF_PTR
 == 3)

534  (
	`©omic_ÿs_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
c
, (ušt64_t)
s
));

535 #–ià(
LG_SIZEOF_PTR
 == 2)

536  (
	`©omic_ÿs_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
c
, (ušt32_t)
s
));

538 
	}
}

540 
JEMALLOC_INLINE
 

541 
	$©omic_wr™e_p
(**
p
, cÚ¡ *
x
)

544 #ià(
LG_SIZEOF_PTR
 == 3)

545 
	`©omic_wr™e_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
);

546 #–ià(
LG_SIZEOF_PTR
 == 2)

547 
	`©omic_wr™e_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
);

549 
	}
}

553 
JEMALLOC_INLINE
 
size_t


554 
	$©omic_add_z
(
size_t
 *
p
, size_ˆ
x
)

557 #ià(
LG_SIZEOF_PTR
 == 3)

558  ((
size_t
)
	`©omic_add_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
));

559 #–ià(
LG_SIZEOF_PTR
 == 2)

560  ((
size_t
)
	`©omic_add_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
));

562 
	}
}

564 
JEMALLOC_INLINE
 
size_t


565 
	$©omic_sub_z
(
size_t
 *
p
, size_ˆ
x
)

568 #ià(
LG_SIZEOF_PTR
 == 3)

569  ((
size_t
)
	`©omic_add_ušt64
((
ušt64_t
 *)
p
,

570 (
ušt64_t
)-((
št64_t
)
x
)));

571 #–ià(
LG_SIZEOF_PTR
 == 2)

572  ((
size_t
)
	`©omic_add_ušt32
((
ušt32_t
 *)
p
,

573 (
ušt32_t
)-((
št32_t
)
x
)));

575 
	}
}

577 
JEMALLOC_INLINE
 
boŞ


578 
	$©omic_ÿs_z
(
size_t
 *
p
, size_ˆ
c
, size_ˆ
s
)

581 #ià(
LG_SIZEOF_PTR
 == 3)

582  (
	`©omic_ÿs_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
c
, (ušt64_t)
s
));

583 #–ià(
LG_SIZEOF_PTR
 == 2)

584  (
	`©omic_ÿs_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
c
, (ušt32_t)
s
));

586 
	}
}

588 
JEMALLOC_INLINE
 

589 
	$©omic_wr™e_z
(
size_t
 *
p
, size_ˆ
x
)

592 #ià(
LG_SIZEOF_PTR
 == 3)

593 
	`©omic_wr™e_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
);

594 #–ià(
LG_SIZEOF_PTR
 == 2)

595 
	`©omic_wr™e_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
);

597 
	}
}

601 
JEMALLOC_INLINE
 

602 
	$©omic_add_u
(*
p
, 
x
)

605 #ià(
LG_SIZEOF_INT
 == 3)

606  (()
	`©omic_add_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
));

607 #–ià(
LG_SIZEOF_INT
 == 2)

608  (()
	`©omic_add_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
));

610 
	}
}

612 
JEMALLOC_INLINE
 

613 
	$©omic_sub_u
(*
p
, 
x
)

616 #ià(
LG_SIZEOF_INT
 == 3)

617  (()
	`©omic_add_ušt64
((
ušt64_t
 *)
p
,

618 (
ušt64_t
)-((
št64_t
)
x
)));

619 #–ià(
LG_SIZEOF_INT
 == 2)

620  (()
	`©omic_add_ušt32
((
ušt32_t
 *)
p
,

621 (
ušt32_t
)-((
št32_t
)
x
)));

623 
	}
}

625 
JEMALLOC_INLINE
 
boŞ


626 
	$©omic_ÿs_u
(*
p
, 
c
, 
s
)

629 #ià(
LG_SIZEOF_INT
 == 3)

630  (
	`©omic_ÿs_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
c
, (ušt64_t)
s
));

631 #–ià(
LG_SIZEOF_INT
 == 2)

632  (
	`©omic_ÿs_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
c
, (ušt32_t)
s
));

634 
	}
}

636 
JEMALLOC_INLINE
 

637 
	$©omic_wr™e_u
(*
p
, 
x
)

640 #ià(
LG_SIZEOF_INT
 == 3)

641 
	`©omic_wr™e_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
);

642 #–ià(
LG_SIZEOF_INT
 == 2)

643 
	`©omic_wr™e_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
);

645 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/base.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 *
ba£_®loc
(
tsdn_t
 *
tsdn
, 
size_t
 
size
);

13 
ba£_¡©s_g‘
(
tsdn_t
 *
tsdn
, 
size_t
 *
®loÿ‹d
, size_ˆ*
»sid’t
,

14 
size_t
 *
m­³d
);

15 
boŞ
 
ba£_boÙ
();

16 
ba£_´efÜk
(
tsdn_t
 *
tsdn
);

17 
ba£_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
);

18 
ba£_po¡fÜk_chd
(
tsdn_t
 *
tsdn
);

22 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/bitmap.h

2 #ifdeà
JEMALLOC_H_TYPES


5 
	#LG_BITMAP_MAXBITS
 
LG_RUN_MAXREGS


	)

6 
	#BITMAP_MAXBITS
 (
	`ZU
(1è<< 
LG_BITMAP_MAXBITS
)

	)

8 
b™m­_Ëv–_s
 
	tb™m­_Ëv–_t
;

9 
b™m­_šfo_s
 
	tb™m­_šfo_t
;

10 
	tb™m­_t
;

11 
	#LG_SIZEOF_BITMAP
 
LG_SIZEOF_LONG


	)

14 
	#LG_BITMAP_GROUP_NBITS
 (
LG_SIZEOF_BITMAP
 + 3)

	)

15 
	#BITMAP_GROUP_NBITS
 (
	`ZU
(1è<< 
LG_BITMAP_GROUP_NBITS
)

	)

16 
	#BITMAP_GROUP_NBITS_MASK
 (
BITMAP_GROUP_NBITS
-1)

	)

23 #ià
LG_BITMAP_MAXBITS
 - 
LG_BITMAP_GROUP_NBITS
 > 3

24 
	#USE_TREE


	)

28 
	#BITMAP_BITS2GROUPS
(
nb™s
) \

29 ((
nb™s
 + 
BITMAP_GROUP_NBITS_MASK
è>> 
LG_BITMAP_GROUP_NBITS
)

	)

34 
	#BITMAP_GROUPS_L0
(
nb™s
) \

35 
	`BITMAP_BITS2GROUPS
(
nb™s
)

	)

36 
	#BITMAP_GROUPS_L1
(
nb™s
) \

37 
	`BITMAP_BITS2GROUPS
(BITMAP_BITS2GROUPS(
nb™s
))

	)

38 
	#BITMAP_GROUPS_L2
(
nb™s
) \

39 
	`BITMAP_BITS2GROUPS
(BITMAP_BITS2GROUPS(BITMAP_BITS2GROUPS((
nb™s
))))

	)

40 
	#BITMAP_GROUPS_L3
(
nb™s
) \

41 
	`BITMAP_BITS2GROUPS
(BITMAP_BITS2GROUPS(BITMAP_BITS2GROUPS( \

42 
	`BITMAP_BITS2GROUPS
((
nb™s
)))))

	)

48 
	#BITMAP_GROUPS_1_LEVEL
(
nb™s
) \

49 
	`BITMAP_GROUPS_L0
(
nb™s
)

	)

50 
	#BITMAP_GROUPS_2_LEVEL
(
nb™s
) \

51 (
	`BITMAP_GROUPS_1_LEVEL
(
nb™s
è+ 
	`BITMAP_GROUPS_L1
Òb™s))

	)

52 
	#BITMAP_GROUPS_3_LEVEL
(
nb™s
) \

53 (
	`BITMAP_GROUPS_2_LEVEL
(
nb™s
è+ 
	`BITMAP_GROUPS_L2
Òb™s))

	)

54 
	#BITMAP_GROUPS_4_LEVEL
(
nb™s
) \

55 (
	`BITMAP_GROUPS_3_LEVEL
(
nb™s
è+ 
	`BITMAP_GROUPS_L3
Òb™s))

	)

60 #ifdeà
USE_TREE


62 #ià
LG_BITMAP_MAXBITS
 <ğ
LG_BITMAP_GROUP_NBITS


63 
	#BITMAP_GROUPS_MAX
 
	`BITMAP_GROUPS_1_LEVEL
(
BITMAP_MAXBITS
)

	)

64 #–ià
LG_BITMAP_MAXBITS
 <ğ
LG_BITMAP_GROUP_NBITS
 * 2

65 
	#BITMAP_GROUPS_MAX
 
	`BITMAP_GROUPS_2_LEVEL
(
BITMAP_MAXBITS
)

	)

66 #–ià
LG_BITMAP_MAXBITS
 <ğ
LG_BITMAP_GROUP_NBITS
 * 3

67 
	#BITMAP_GROUPS_MAX
 
	`BITMAP_GROUPS_3_LEVEL
(
BITMAP_MAXBITS
)

	)

68 #–ià
LG_BITMAP_MAXBITS
 <ğ
LG_BITMAP_GROUP_NBITS
 * 4

69 
	#BITMAP_GROUPS_MAX
 
	`BITMAP_GROUPS_4_LEVEL
(
BITMAP_MAXBITS
)

	)

75 
	#BITMAP_MAX_LEVELS
 \

76 (
LG_BITMAP_MAXBITS
 / 
LG_SIZEOF_BITMAP
) \

77 + !!(
LG_BITMAP_MAXBITS
 % 
LG_SIZEOF_BITMAP
)

	)

81 
	#BITMAP_GROUPS_MAX
 
	`BITMAP_BITS2GROUPS
(
BITMAP_MAXBITS
)

	)

87 #ifdeà
JEMALLOC_H_STRUCTS


89 
	sb™m­_Ëv–_s
 {

91 
size_t
 
	mgroup_off£t
;

94 
	sb™m­_šfo_s
 {

96 
size_t
 
	mnb™s
;

98 #ifdeà
USE_TREE


100 
	mÆev–s
;

106 
b™m­_Ëv–_t
 
	mËv–s
[
BITMAP_MAX_LEVELS
+1];

109 
size_t
 
	mngroups
;

115 #ifdeà
JEMALLOC_H_EXTERNS


117 
b™m­_šfo_š™
(
b™m­_šfo_t
 *
bšfo
, 
size_t
 
nb™s
);

118 
b™m­_š™
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
);

119 
size_t
 
b™m­_size
(cÚ¡ 
b™m­_šfo_t
 *
bšfo
);

123 #ifdeà
JEMALLOC_H_INLINES


125 #iâdeà
JEMALLOC_ENABLE_INLINE


126 
boŞ
 
b™m­_fuÎ
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
);

127 
boŞ
 
b™m­_g‘
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
);

128 
b™m­_£t
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
);

129 
size_t
 
b™m­_sfu
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
);

130 
b™m­_un£t
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
);

133 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_BITMAP_C_
))

134 
JEMALLOC_INLINE
 
boŞ


135 
	$b™m­_fuÎ
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

137 #ifdeà
USE_TREE


138 
size_t
 
rgoff
 = 
bšfo
->
Ëv–s
[bšfo->
Æev–s
].
group_off£t
 - 1;

139 
b™m­_t
 
rg
 = 
b™m­
[
rgoff
];

141  (
rg
 == 0);

143 
size_t
 
i
;

145 
i
 = 0; i < 
bšfo
->
ngroups
; i++) {

146 ià(
b™m­
[
i
] != 0)

147  (
çl£
);

149  (
Œue
);

151 
	}
}

153 
JEMALLOC_INLINE
 
boŞ


154 
	$b™m­_g‘
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
)

156 
size_t
 
goff
;

157 
b™m­_t
 
g
;

159 
	`as£¹
(
b™
 < 
bšfo
->
nb™s
);

160 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

161 
g
 = 
b™m­
[
goff
];

162  (!(
g
 & (
	`ZU
(1è<< (
b™
 & 
BITMAP_GROUP_NBITS_MASK
))));

163 
	}
}

165 
JEMALLOC_INLINE
 

166 
	$b™m­_£t
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
)

168 
size_t
 
goff
;

169 
b™m­_t
 *
gp
;

170 
b™m­_t
 
g
;

172 
	`as£¹
(
b™
 < 
bšfo
->
nb™s
);

173 
	`as£¹
(!
	`b™m­_g‘
(
b™m­
, 
bšfo
, 
b™
));

174 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

175 
gp
 = &
b™m­
[
goff
];

176 
g
 = *
gp
;

177 
	`as£¹
(
g
 & (
	`ZU
(1è<< (
b™
 & 
BITMAP_GROUP_NBITS_MASK
)));

178 
g
 ^ğ
	`ZU
(1è<< (
b™
 & 
BITMAP_GROUP_NBITS_MASK
);

179 *
gp
 = 
g
;

180 
	`as£¹
(
	`b™m­_g‘
(
b™m­
, 
bšfo
, 
b™
));

181 #ifdeà
USE_TREE


183 ià(
g
 == 0) {

184 
i
;

185 
i
 = 1; i < 
bšfo
->
Æev–s
; i++) {

186 
b™
 = 
goff
;

187 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

188 
gp
 = &
b™m­
[
bšfo
->
Ëv–s
[
i
].
group_off£t
 + 
goff
];

189 
g
 = *
gp
;

190 
	`as£¹
(
g
 & (
	`ZU
(1è<< (
b™
 & 
BITMAP_GROUP_NBITS_MASK
)));

191 
g
 ^ğ
	`ZU
(1è<< (
b™
 & 
BITMAP_GROUP_NBITS_MASK
);

192 *
gp
 = 
g
;

193 ià(
g
 != 0)

198 
	}
}

201 
JEMALLOC_INLINE
 
size_t


202 
	$b™m­_sfu
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

204 
size_t
 
b™
;

205 
b™m­_t
 
g
;

206 
i
;

208 
	`as£¹
(!
	`b™m­_fuÎ
(
b™m­
, 
bšfo
));

210 #ifdeà
USE_TREE


211 
i
 = 
bšfo
->
Æev–s
 - 1;

212 
g
 = 
b™m­
[
bšfo
->
Ëv–s
[
i
].
group_off£t
];

213 
b™
 = 
	`ffs_lu
(
g
) - 1;

214 
i
 > 0) {

215 
i
--;

216 
g
 = 
b™m­
[
bšfo
->
Ëv–s
[
i
].
group_off£t
 + 
b™
];

217 
b™
 = (b™ << 
LG_BITMAP_GROUP_NBITS
è+ (
	`ffs_lu
(
g
) - 1);

220 
i
 = 0;

221 
g
 = 
b™m­
[0];

222 (
b™
 = 
	`ffs_lu
(
g
)) == 0) {

223 
i
++;

224 
g
 = 
b™m­
[
i
];

226 
b™
 = (
i
 << 
LG_BITMAP_GROUP_NBITS
) + (bit - 1);

228 
	`b™m­_£t
(
b™m­
, 
bšfo
, 
b™
);

229  (
b™
);

230 
	}
}

232 
JEMALLOC_INLINE
 

233 
	$b™m­_un£t
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
)

235 
size_t
 
goff
;

236 
b™m­_t
 *
gp
;

237 
b™m­_t
 
g
;

238 
UNUSED
 
boŞ
 
´İag©e
;

240 
	`as£¹
(
b™
 < 
bšfo
->
nb™s
);

241 
	`as£¹
(
	`b™m­_g‘
(
b™m­
, 
bšfo
, 
b™
));

242 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

243 
gp
 = &
b™m­
[
goff
];

244 
g
 = *
gp
;

245 
´İag©e
 = (
g
 == 0);

246 
	`as£¹
((
g
 & (
	`ZU
(1è<< (
b™
 & 
BITMAP_GROUP_NBITS_MASK
))) == 0);

247 
g
 ^ğ
	`ZU
(1è<< (
b™
 & 
BITMAP_GROUP_NBITS_MASK
);

248 *
gp
 = 
g
;

249 
	`as£¹
(!
	`b™m­_g‘
(
b™m­
, 
bšfo
, 
b™
));

250 #ifdeà
USE_TREE


252 ià(
´İag©e
) {

253 
i
;

254 
i
 = 1; i < 
bšfo
->
Æev–s
; i++) {

255 
b™
 = 
goff
;

256 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

257 
gp
 = &
b™m­
[
bšfo
->
Ëv–s
[
i
].
group_off£t
 + 
goff
];

258 
g
 = *
gp
;

259 
´İag©e
 = (
g
 == 0);

260 
	`as£¹
((
g
 & (
	`ZU
(1è<< (
b™
 & 
BITMAP_GROUP_NBITS_MASK
)))

262 
g
 ^ğ
	`ZU
(1è<< (
b™
 & 
BITMAP_GROUP_NBITS_MASK
);

263 *
gp
 = 
g
;

264 ià(!
´İag©e
)

269 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/chunk.h

2 #ifdeà
JEMALLOC_H_TYPES


8 
	#LG_CHUNK_DEFAULT
 21

	)

11 
	#CHUNK_ADDR2BASE
(
a
) \

12 ((*)((
ušŒ_t
)(
a
è& ~
chunksize_mask
))

	)

15 
	#CHUNK_ADDR2OFFSET
(
a
) \

16 ((
size_t
)((
ušŒ_t
)(
a
è& 
chunksize_mask
))

	)

19 
	#CHUNK_CEILING
(
s
) \

20 (((
s
è+ 
chunksize_mask
è& ~chunksize_mask)

	)

22 
	#CHUNK_HOOKS_INITIALIZER
 { \

23 
NULL
, \

24 
NULL
, \

25 
NULL
, \

26 
NULL
, \

27 
NULL
, \

28 
NULL
, \

29 
NULL
 \

30 }

	)

34 #ifdeà
JEMALLOC_H_STRUCTS


38 #ifdeà
JEMALLOC_H_EXTERNS


40 
size_t
 
İt_lg_chunk
;

41 cÚ¡ *
İt_dss
;

43 
¹»e_t
 
chunks_¹»e
;

45 
size_t
 
chunksize
;

46 
size_t
 
chunksize_mask
;

47 
size_t
 
chunk_Åages
;

49 cÚ¡ 
chunk_hooks_t
 
chunk_hooks_deçuÉ
;

51 
chunk_hooks_t
 
chunk_hooks_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

52 
chunk_hooks_t
 
chunk_hooks_£t
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

53 cÚ¡ 
chunk_hooks_t
 *
chunk_hooks
);

55 
boŞ
 
chunk_»gi¡”
(
tsdn_t
 *
tsdn
, cÚ¡ *
chunk
,

56 cÚ¡ 
ex‹Á_node_t
 *
node
);

57 
chunk_d”egi¡”
(cÚ¡ *
chunk
, cÚ¡ 
ex‹Á_node_t
 *
node
);

58 *
chunk_®loc_ba£
(
size_t
 
size
);

59 *
chunk_®loc_ÿche
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

60 
chunk_hooks_t
 *
chunk_hooks
, *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
,

61 
boŞ
 *
z”o
, boŞ 
d®loc_node
);

62 *
chunk_®loc_w¿µ”
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

63 
chunk_hooks_t
 *
chunk_hooks
, *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
,

64 
boŞ
 *
z”o
, boŞ *
comm™
);

65 
chunk_d®loc_ÿche
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

66 
chunk_hooks_t
 *
chunk_hooks
, *
chunk
, 
size_t
 
size
, 
boŞ
 
comm™‹d
);

67 
chunk_d®loc_w¿µ”
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

68 
chunk_hooks_t
 *
chunk_hooks
, *
chunk
, 
size_t
 
size
, 
boŞ
 
z”Ûd
,

69 
boŞ
 
comm™‹d
);

70 
boŞ
 
chunk_purge_w¿µ”
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

71 
chunk_hooks_t
 *
chunk_hooks
, *
chunk
, 
size_t
 
size
, size_ˆ
off£t
,

72 
size_t
 
Ëngth
);

73 
boŞ
 
chunk_boÙ
();

74 
chunk_´efÜk
(
tsdn_t
 *
tsdn
);

75 
chunk_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
);

76 
chunk_po¡fÜk_chd
(
tsdn_t
 *
tsdn
);

80 #ifdeà
JEMALLOC_H_INLINES


82 #iâdeà
JEMALLOC_ENABLE_INLINE


83 
ex‹Á_node_t
 *
chunk_lookup
(cÚ¡ *
chunk
, 
boŞ
 
d•’d’t
);

86 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_CHUNK_C_
))

87 
JEMALLOC_INLINE
 
ex‹Á_node_t
 *

88 
	$chunk_lookup
(cÚ¡ *
±r
, 
boŞ
 
d•’d’t
)

91  (
	`¹»e_g‘
(&
chunks_¹»e
, (
ušŒ_t
)
±r
, 
d•’d’t
));

92 
	}
}

98 
	~"jem®loc/š‹º®/chunk_dss.h
"

99 
	~"jem®loc/š‹º®/chunk_mm­.h
"

	@dep/jemalloc-4.2.0/include/jemalloc/internal/chunk_dss.h

2 #ifdeà
JEMALLOC_H_TYPES


5 
	mdss_´ec_di§bËd
 = 0,

6 
	mdss_´ec_´im¬y
 = 1,

7 
	mdss_´ec_£cÚd¬y
 = 2,

9 
	mdss_´ec_lim™
 = 3

10 } 
	tdss_´ec_t
;

11 
	#DSS_PREC_DEFAULT
 
dss_´ec_£cÚd¬y


	)

12 
	#DSS_DEFAULT
 "£cÚd¬y"

	)

16 #ifdeà
JEMALLOC_H_STRUCTS


18 cÚ¡ *
dss_´ec_Çmes
[];

22 #ifdeà
JEMALLOC_H_EXTERNS


24 
dss_´ec_t
 
chunk_dss_´ec_g‘
(
tsdn_t
 *
tsdn
);

25 
boŞ
 
chunk_dss_´ec_£t
(
tsdn_t
 *
tsdn
, 
dss_´ec_t
 
dss_´ec
);

26 *
chunk_®loc_dss
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
Ãw_addr
,

27 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
);

28 
boŞ
 
chunk_š_dss
(
tsdn_t
 *
tsdn
, *
chunk
);

29 
boŞ
 
chunk_dss_boÙ
();

30 
chunk_dss_´efÜk
(
tsdn_t
 *
tsdn
);

31 
chunk_dss_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
);

32 
chunk_dss_po¡fÜk_chd
(
tsdn_t
 *
tsdn
);

36 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/chunk_mmap.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 *
chunk_®loc_mm­
(*
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
,

13 
boŞ
 *
z”o
, boŞ *
comm™
);

14 
boŞ
 
chunk_d®loc_mm­
(*
chunk
, 
size_t
 
size
);

18 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/ckh.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
ckh_s
 
	tckh_t
;

5 
ckhc_s
 
	tckhc_t
;

8 
	tckh_hash_t
 (cÚ¡ *, 
	tsize_t
[2]);

9 
boŞ
 
	tckh_keycomp_t
 (const *, const *);

20 
	#LG_CKH_BUCKET_CELLS
 (
LG_CACHELINE
 - 
LG_SIZEOF_PTR
 - 1)

	)

24 #ifdeà
JEMALLOC_H_STRUCTS


27 
	sckhc_s
 {

28 cÚ¡ *
	mkey
;

29 cÚ¡ *
	md©a
;

32 
	sckh_s
 {

33 #ifdeà
CKH_COUNT


35 
ušt64_t
 
	mngrows
;

36 
ušt64_t
 
	mnshršks
;

37 
ušt64_t
 
	mnshrškçs
;

38 
ušt64_t
 
	mnš£¹s
;

39 
ušt64_t
 
	mÄ–ocs
;

43 
ušt64_t
 
	m´ng_¡©e
;

46 
size_t
 
	mcouÁ
;

52 
	mlg_mšbuck‘s
;

53 
	mlg_curbuck‘s
;

56 
ckh_hash_t
 *
	mhash
;

57 
ckh_keycomp_t
 *
	mkeycomp
;

60 
ckhc_t
 *
	mb
;

65 #ifdeà
JEMALLOC_H_EXTERNS


67 
boŞ
 
ckh_Ãw
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
, 
size_t
 
mš™ems
, 
ckh_hash_t
 *
hash
,

68 
ckh_keycomp_t
 *
keycomp
);

69 
ckh_d–‘e
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
);

70 
size_t
 
ckh_couÁ
(
ckh_t
 *
ckh
);

71 
boŞ
 
ckh_™”
(
ckh_t
 *
ckh
, 
size_t
 *
bšd
, **
key
, **
d©a
);

72 
boŞ
 
ckh_š£¹
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
, cÚ¡ *
key
, cÚ¡ *
d©a
);

73 
boŞ
 
ckh_»move
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
, cÚ¡ *
£¬chkey
, **
key
,

74 **
d©a
);

75 
boŞ
 
ckh_£¬ch
(
ckh_t
 *
ckh
, cÚ¡ *
£¬chkey
, **
key
, **
d©a
);

76 
ckh_¡ršg_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2]);

77 
boŞ
 
ckh_¡ršg_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
);

78 
ckh_poš‹r_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2]);

79 
boŞ
 
ckh_poš‹r_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
);

83 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/ctl.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
ùl_node_s
 
	tùl_node_t
;

5 
ùl_Çmed_node_s
 
	tùl_Çmed_node_t
;

6 
ùl_šdexed_node_s
 
	tùl_šdexed_node_t
;

7 
ùl_¬’a_¡©s_s
 
	tùl_¬’a_¡©s_t
;

8 
ùl_¡©s_s
 
	tùl_¡©s_t
;

12 #ifdeà
JEMALLOC_H_STRUCTS


14 
	sùl_node_s
 {

15 
boŞ
 
	mÇmed
;

18 
	sùl_Çmed_node_s
 {

19 
ùl_node_s
 
	mnode
;

20 cÚ¡ *
	mÇme
;

22 
	mnchd»n
;

23 cÚ¡ 
ùl_node_t
 *
	mchd»n
;

24 (*
	mùl
)(
	mtsd_t
 *, cÚ¡ 
	msize_t
 *, size_t, *,

25 
	msize_t
 *, *, size_t);

28 
	sùl_šdexed_node_s
 {

29 
ùl_node_s
 
	mnode
;

30 cÚ¡ 
	mùl_Çmed_node_t
 *(*
	mšdex
)(
	mtsdn_t
 *, cÚ¡ 
	msize_t
 *, size_t,

31 
	msize_t
);

34 
	sùl_¬’a_¡©s_s
 {

35 
boŞ
 
	mš™Ÿlized
;

36 
	mÁh»ads
;

37 cÚ¡ *
	mdss
;

38 
ssize_t
 
	mlg_dœty_muÉ
;

39 
ssize_t
 
	mdeÿy_time
;

40 
size_t
 
	m·ùive
;

41 
size_t
 
	mpdœty
;

45 
¬’a_¡©s_t
 
	ma¡©s
;

48 
size_t
 
	m®loÿ‹d_sm®l
;

49 
ušt64_t
 
	mnm®loc_sm®l
;

50 
ušt64_t
 
	mnd®loc_sm®l
;

51 
ušt64_t
 
	mÄeque¡s_sm®l
;

53 
m®loc_bš_¡©s_t
 
	mb¡©s
[
NBINS
];

54 
m®loc_Ïrge_¡©s_t
 *
	ml¡©s
;

55 
m®loc_huge_¡©s_t
 *
	mh¡©s
;

58 
	sùl_¡©s_s
 {

59 
size_t
 
	m®loÿ‹d
;

60 
size_t
 
	maùive
;

61 
size_t
 
	mm‘ad©a
;

62 
size_t
 
	m»sid’t
;

63 
size_t
 
	mm­³d
;

64 
size_t
 
	m»šed
;

65 
	mÇ»Çs
;

66 
ùl_¬’a_¡©s_t
 *
	m¬’as
;

71 #ifdeà
JEMALLOC_H_EXTERNS


73 
ùl_byÇme
(
tsd_t
 *
tsd
, cÚ¡ *
Çme
, *
Şdp
, 
size_t
 *
ŞdËÅ
,

74 *
Ãwp
, 
size_t
 
ÃwËn
);

75 
ùl_Çm‘omib
(
tsdn_t
 *
tsdn
, cÚ¡ *
Çme
, 
size_t
 *
mibp
,

76 
size_t
 *
mibËÅ
);

78 
ùl_bymib
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

79 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

80 
boŞ
 
ùl_boÙ
();

81 
ùl_´efÜk
(
tsdn_t
 *
tsdn
);

82 
ùl_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
);

83 
ùl_po¡fÜk_chd
(
tsdn_t
 *
tsdn
);

85 
	#xm®lùl
(
Çme
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
) do { \

86 ià(
	`je_m®lùl
(
Çme
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
) \

88 
	`m®loc_´štf
( \

90 
Çme
); \

91 
	`abÜt
(); \

93 } 0)

	)

95 
	#xm®lùÊam‘omib
(
Çme
, 
mibp
, 
mibËÅ
) do { \

96 ià(
	`je_m®lùÊam‘omib
(
Çme
, 
mibp
, 
mibËÅ
) != 0) { \

97 
	`m®loc_´štf
("<jemalloc>: Failure in " \

98 "xm®lùÊam‘omib(\"%s\", ...)\n", 
Çme
); \

99 
	`abÜt
(); \

101 } 0)

	)

103 
	#xm®lùlbymib
(
mib
, 
mibËn
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
) do { \

104 ià(
	`je_m®lùlbymib
(
mib
, 
mibËn
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, \

105 
ÃwËn
) != 0) { \

106 
	`m®loc_wr™e
( \

108 
	`abÜt
(); \

110 } 0)

	)

114 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/extent.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
ex‹Á_node_s
 
	tex‹Á_node_t
;

8 #ifdeà
JEMALLOC_H_STRUCTS


11 
	sex‹Á_node_s
 {

13 
¬’a_t
 *
	m’_¬’a
;

16 *
	m’_addr
;

19 
size_t
 
	m’_size
;

25 
boŞ
 
	m’_z”Ûd
;

32 
boŞ
 
	m’_comm™‹d
;

38 
boŞ
 
	m’_achunk
;

41 
´of_tùx_t
 *
	m’_´of_tùx
;

44 
¬’a_runs_dœty_lšk_t
 
	mrd
;

45 
qr
(
ex‹Á_node_t
è
	mcc_lšk
;

49 
rb_node
(
ex‹Á_node_t
è
	mszad_lšk
;

52 
ql_–m
(
ex‹Á_node_t
è
	mql_lšk
;

56 
rb_node
(
ex‹Á_node_t
è
	mad_lšk
;

58 
	$rb_Œ“
(
	tex‹Á_node_t
è
	tex‹Á_Œ“_t
;

62 #ifdeà
JEMALLOC_H_EXTERNS


64 
	$rb_´Ùo
(, 
ex‹Á_Œ“_szad_
, 
ex‹Á_Œ“_t
, 
ex‹Á_node_t
)

66 
	$rb_´Ùo
(, 
ex‹Á_Œ“_ad_
, 
ex‹Á_Œ“_t
, 
ex‹Á_node_t
)

70 #ifdeà
JEMALLOC_H_INLINES


72 #iâdeà
JEMALLOC_ENABLE_INLINE


73 
¬’a_t
 *
	`ex‹Á_node_¬’a_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

74 *
	`ex‹Á_node_addr_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

75 
size_t
 
	`ex‹Á_node_size_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

76 
boŞ
 
	`ex‹Á_node_z”Ûd_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

77 
boŞ
 
	`ex‹Á_node_comm™‹d_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

78 
boŞ
 
	`ex‹Á_node_achunk_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

79 
´of_tùx_t
 *
	`ex‹Á_node_´of_tùx_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

80 
	`ex‹Á_node_¬’a_£t
(
ex‹Á_node_t
 *
node
, 
¬’a_t
 *
¬’a
);

81 
	`ex‹Á_node_addr_£t
(
ex‹Á_node_t
 *
node
, *
addr
);

82 
	`ex‹Á_node_size_£t
(
ex‹Á_node_t
 *
node
, 
size_t
 
size
);

83 
	`ex‹Á_node_z”Ûd_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
z”Ûd
);

84 
	`ex‹Á_node_comm™‹d_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
comm™‹d
);

85 
	`ex‹Á_node_achunk_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
achunk
);

86 
	`ex‹Á_node_´of_tùx_£t
(
ex‹Á_node_t
 *
node
, 
´of_tùx_t
 *
tùx
);

87 
	`ex‹Á_node_š™
(
ex‹Á_node_t
 *
node
, 
¬’a_t
 *
¬’a
, *
addr
,

88 
size_t
 
size
, 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
);

89 
	`ex‹Á_node_dœty_lškage_š™
(
ex‹Á_node_t
 *
node
);

90 
	`ex‹Á_node_dœty_š£¹
(
ex‹Á_node_t
 *
node
,

91 
¬’a_runs_dœty_lšk_t
 *
runs_dœty
, 
ex‹Á_node_t
 *
chunks_dœty
);

92 
	`ex‹Á_node_dœty_»move
(
ex‹Á_node_t
 *
node
);

95 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_EXTENT_C_
))

96 
JEMALLOC_INLINE
 
¬’a_t
 *

97 
	$ex‹Á_node_¬’a_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

100  (
node
->
’_¬’a
);

101 
	}
}

103 
JEMALLOC_INLINE
 *

104 
	$ex‹Á_node_addr_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

107  (
node
->
’_addr
);

108 
	}
}

110 
JEMALLOC_INLINE
 
size_t


111 
	$ex‹Á_node_size_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

114  (
node
->
’_size
);

115 
	}
}

117 
JEMALLOC_INLINE
 
boŞ


118 
	$ex‹Á_node_z”Ûd_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

121  (
node
->
’_z”Ûd
);

122 
	}
}

124 
JEMALLOC_INLINE
 
boŞ


125 
	$ex‹Á_node_comm™‹d_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

128 
	`as£¹
(!
node
->
’_achunk
);

129  (
node
->
’_comm™‹d
);

130 
	}
}

132 
JEMALLOC_INLINE
 
boŞ


133 
	$ex‹Á_node_achunk_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

136  (
node
->
’_achunk
);

137 
	}
}

139 
JEMALLOC_INLINE
 
´of_tùx_t
 *

140 
	$ex‹Á_node_´of_tùx_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

143  (
node
->
’_´of_tùx
);

144 
	}
}

146 
JEMALLOC_INLINE
 

147 
	$ex‹Á_node_¬’a_£t
(
ex‹Á_node_t
 *
node
, 
¬’a_t
 *
¬’a
)

150 
node
->
’_¬’a
 = 
¬’a
;

151 
	}
}

153 
JEMALLOC_INLINE
 

154 
	$ex‹Á_node_addr_£t
(
ex‹Á_node_t
 *
node
, *
addr
)

157 
node
->
’_addr
 = 
addr
;

158 
	}
}

160 
JEMALLOC_INLINE
 

161 
	$ex‹Á_node_size_£t
(
ex‹Á_node_t
 *
node
, 
size_t
 
size
)

164 
node
->
’_size
 = 
size
;

165 
	}
}

167 
JEMALLOC_INLINE
 

168 
	$ex‹Á_node_z”Ûd_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
z”Ûd
)

171 
node
->
’_z”Ûd
 = 
z”Ûd
;

172 
	}
}

174 
JEMALLOC_INLINE
 

175 
	$ex‹Á_node_comm™‹d_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
comm™‹d
)

178 
node
->
’_comm™‹d
 = 
comm™‹d
;

179 
	}
}

181 
JEMALLOC_INLINE
 

182 
	$ex‹Á_node_achunk_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
achunk
)

185 
node
->
’_achunk
 = 
achunk
;

186 
	}
}

188 
JEMALLOC_INLINE
 

189 
	$ex‹Á_node_´of_tùx_£t
(
ex‹Á_node_t
 *
node
, 
´of_tùx_t
 *
tùx
)

192 
node
->
’_´of_tùx
 = 
tùx
;

193 
	}
}

195 
JEMALLOC_INLINE
 

196 
	$ex‹Á_node_š™
(
ex‹Á_node_t
 *
node
, 
¬’a_t
 *
¬’a
, *
addr
, 
size_t
 
size
,

197 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
)

200 
	`ex‹Á_node_¬’a_£t
(
node
, 
¬’a
);

201 
	`ex‹Á_node_addr_£t
(
node
, 
addr
);

202 
	`ex‹Á_node_size_£t
(
node
, 
size
);

203 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
z”Ûd
);

204 
	`ex‹Á_node_comm™‹d_£t
(
node
, 
comm™‹d
);

205 
	`ex‹Á_node_achunk_£t
(
node
, 
çl£
);

206 ià(
cÚfig_´of
)

207 
	`ex‹Á_node_´of_tùx_£t
(
node
, 
NULL
);

208 
	}
}

210 
JEMALLOC_INLINE
 

211 
	$ex‹Á_node_dœty_lškage_š™
(
ex‹Á_node_t
 *
node
)

214 
	`qr_Ãw
(&
node
->
rd
, 
rd_lšk
);

215 
	`qr_Ãw
(
node
, 
cc_lšk
);

216 
	}
}

218 
JEMALLOC_INLINE
 

219 
	$ex‹Á_node_dœty_š£¹
(
ex‹Á_node_t
 *
node
,

220 
¬’a_runs_dœty_lšk_t
 *
runs_dœty
, 
ex‹Á_node_t
 *
chunks_dœty
)

223 
	`qr_m–d
(
runs_dœty
, &
node
->
rd
, 
rd_lšk
);

224 
	`qr_m–d
(
chunks_dœty
, 
node
, 
cc_lšk
);

225 
	}
}

227 
JEMALLOC_INLINE
 

228 
	$ex‹Á_node_dœty_»move
(
ex‹Á_node_t
 *
node
)

231 
	`qr_»move
(&
node
->
rd
, 
rd_lšk
);

232 
	`qr_»move
(
node
, 
cc_lšk
);

233 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/hash.h

7 #ifdeà
JEMALLOC_H_TYPES


11 #ifdeà
JEMALLOC_H_STRUCTS


15 #ifdeà
JEMALLOC_H_EXTERNS


19 #ifdeà
JEMALLOC_H_INLINES


21 #iâdeà
JEMALLOC_ENABLE_INLINE


22 
ušt32_t
 
hash_x86_32
(cÚ¡ *
key
, 
Ën
, ušt32_ˆ
£ed
);

23 
hash_x86_128
(cÚ¡ *
key
, cÚ¡ 
Ën
, 
ušt32_t
 
£ed
,

24 
ušt64_t
 
r_out
[2]);

25 
hash_x64_128
(cÚ¡ *
key
, cÚ¡ 
Ën
, cÚ¡ 
ušt32_t
 
£ed
,

26 
ušt64_t
 
r_out
[2]);

27 
hash
(cÚ¡ *
key
, 
size_t
 
Ën
, cÚ¡ 
ušt32_t
 
£ed
,

28 
size_t
 
r_hash
[2]);

31 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_HASH_C_
))

34 
JEMALLOC_INLINE
 
ušt32_t


35 
	$hash_rÙl_32
(
ušt32_t
 
x
, 
št8_t
 
r
)

38  ((
x
 << 
r
) | (x >> (32 -„)));

39 
	}
}

41 
JEMALLOC_INLINE
 
ušt64_t


42 
	$hash_rÙl_64
(
ušt64_t
 
x
, 
št8_t
 
r
)

45  ((
x
 << 
r
) | (x >> (64 -„)));

46 
	}
}

48 
JEMALLOC_INLINE
 
ušt32_t


49 
	$hash_g‘_block_32
(cÚ¡ 
ušt32_t
 *
p
, 
i
)

53 ià(
	`uÆik–y
((
ušŒ_t
)
p
 & ((
ušt32_t
)-1)) != 0) {

54 
ušt32_t
 
»t
;

56 
	`memıy
(&
»t
, (
ušt8_t
 *)(
p
 + 
i
), (
ušt32_t
));

57  (
»t
);

60  (
p
[
i
]);

61 
	}
}

63 
JEMALLOC_INLINE
 
ušt64_t


64 
	$hash_g‘_block_64
(cÚ¡ 
ušt64_t
 *
p
, 
i
)

68 ià(
	`uÆik–y
((
ušŒ_t
)
p
 & ((
ušt64_t
)-1)) != 0) {

69 
ušt64_t
 
»t
;

71 
	`memıy
(&
»t
, (
ušt8_t
 *)(
p
 + 
i
), (
ušt64_t
));

72  (
»t
);

75  (
p
[
i
]);

76 
	}
}

78 
JEMALLOC_INLINE
 
ušt32_t


79 
	$hash_fmix_32
(
ušt32_t
 
h
)

82 
h
 ^= h >> 16;

83 
h
 *= 0x85ebca6b;

84 
h
 ^= h >> 13;

85 
h
 *= 0xc2b2ae35;

86 
h
 ^= h >> 16;

88  (
h
);

89 
	}
}

91 
JEMALLOC_INLINE
 
ušt64_t


92 
	$hash_fmix_64
(
ušt64_t
 
k
)

95 
k
 ^= k >> 33;

96 
k
 *ğ
	`KQU
(0xff51afd7ed558ccd);

97 
k
 ^= k >> 33;

98 
k
 *ğ
	`KQU
(0xc4ceb9fe1a85ec53);

99 
k
 ^= k >> 33;

101  (
k
);

102 
	}
}

104 
JEMALLOC_INLINE
 
ušt32_t


105 
	$hash_x86_32
(cÚ¡ *
key
, 
Ën
, 
ušt32_t
 
£ed
)

107 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*è
key
;

108 cÚ¡ 
nblocks
 = 
Ën
 / 4;

110 
ušt32_t
 
h1
 = 
£ed
;

112 cÚ¡ 
ušt32_t
 
c1
 = 0xcc9e2d51;

113 cÚ¡ 
ušt32_t
 
c2
 = 0x1b873593;

117 cÚ¡ 
ušt32_t
 *
blocks
 = (cÚ¡ ušt32_ˆ*è(
d©a
 + 
nblocks
*4);

118 
i
;

120 
i
 = -
nblocks
; i; i++) {

121 
ušt32_t
 
k1
 = 
	`hash_g‘_block_32
(
blocks
, 
i
);

123 
k1
 *ğ
c1
;

124 
k1
 = 
	`hash_rÙl_32
(k1, 15);

125 
k1
 *ğ
c2
;

127 
h1
 ^ğ
k1
;

128 
h1
 = 
	`hash_rÙl_32
(h1, 13);

129 
h1
 = h1*5 + 0xe6546b64;

135 cÚ¡ 
ušt8_t
 *

 = (cÚ¡ ušt8_ˆ*è(
d©a
 + 
nblocks
*4);

137 
ušt32_t
 
k1
 = 0;

139 
Ën
 & 3) {

140 3: 
k1
 ^ğ

[2] << 16;

141 2: 
k1
 ^ğ

[1] << 8;

142 1: 
k1
 ^ğ

[0]; k1 *ğ
c1
; k1 = 
	`hash_rÙl_32
(k1, 15);

143 
k1
 *ğ
c2
; 
h1
 ^= k1;

148 
h1
 ^ğ
Ën
;

150 
h1
 = 
	`hash_fmix_32
(h1);

152  (
h1
);

153 
	}
}

155 
UNUSED
 
JEMALLOC_INLINE
 

156 
	$hash_x86_128
(cÚ¡ *
key
, cÚ¡ 
Ën
, 
ušt32_t
 
£ed
,

157 
ušt64_t
 
r_out
[2])

159 cÚ¡ 
ušt8_t
 * 
d©a
 = (cÚ¡ ušt8_ˆ*è
key
;

160 cÚ¡ 
nblocks
 = 
Ën
 / 16;

162 
ušt32_t
 
h1
 = 
£ed
;

163 
ušt32_t
 
h2
 = 
£ed
;

164 
ušt32_t
 
h3
 = 
£ed
;

165 
ušt32_t
 
h4
 = 
£ed
;

167 cÚ¡ 
ušt32_t
 
c1
 = 0x239b961b;

168 cÚ¡ 
ušt32_t
 
c2
 = 0xab0e9789;

169 cÚ¡ 
ušt32_t
 
c3
 = 0x38b34ae5;

170 cÚ¡ 
ušt32_t
 
c4
 = 0xa1e38b93;

174 cÚ¡ 
ušt32_t
 *
blocks
 = (cÚ¡ ušt32_ˆ*è(
d©a
 + 
nblocks
*16);

175 
i
;

177 
i
 = -
nblocks
; i; i++) {

178 
ušt32_t
 
k1
 = 
	`hash_g‘_block_32
(
blocks
, 
i
*4 + 0);

179 
ušt32_t
 
k2
 = 
	`hash_g‘_block_32
(
blocks
, 
i
*4 + 1);

180 
ušt32_t
 
k3
 = 
	`hash_g‘_block_32
(
blocks
, 
i
*4 + 2);

181 
ušt32_t
 
k4
 = 
	`hash_g‘_block_32
(
blocks
, 
i
*4 + 3);

183 
k1
 *ğ
c1
; k1 = 
	`hash_rÙl_32
(k1, 15); k1 *ğ
c2
; 
h1
 ^= k1;

185 
h1
 = 
	`hash_rÙl_32
(h1, 19); h1 +ğ
h2
;

186 
h1
 = h1*5 + 0x561ccd1b;

188 
k2
 *ğ
c2
; k2 = 
	`hash_rÙl_32
(k2, 16); k2 *ğ
c3
; 
h2
 ^= k2;

190 
h2
 = 
	`hash_rÙl_32
(h2, 17); h2 +ğ
h3
;

191 
h2
 = h2*5 + 0x0bcaa747;

193 
k3
 *ğ
c3
; k3 = 
	`hash_rÙl_32
(k3, 17); k3 *ğ
c4
; 
h3
 ^= k3;

195 
h3
 = 
	`hash_rÙl_32
(h3, 15); h3 +ğ
h4
;

196 
h3
 = h3*5 + 0x96cd1c35;

198 
k4
 *ğ
c4
; k4 = 
	`hash_rÙl_32
(k4, 18); k4 *ğ
c1
; 
h4
 ^= k4;

200 
h4
 = 
	`hash_rÙl_32
(h4, 13); h4 +ğ
h1
;

201 
h4
 = h4*5 + 0x32ac3b17;

207 cÚ¡ 
ušt8_t
 *

 = (cÚ¡ ušt8_ˆ*è(
d©a
 + 
nblocks
*16);

208 
ušt32_t
 
k1
 = 0;

209 
ušt32_t
 
k2
 = 0;

210 
ušt32_t
 
k3
 = 0;

211 
ušt32_t
 
k4
 = 0;

213 
Ën
 & 15) {

214 15: 
k4
 ^ğ

[14] << 16;

215 14: 
k4
 ^ğ

[13] << 8;

216 13: 
k4
 ^ğ

[12] << 0;

217 
k4
 *ğ
c4
; k4 = 
	`hash_rÙl_32
(k4, 18); k4 *ğ
c1
; 
h4
 ^= k4;

219 12: 
k3
 ^ğ

[11] << 24;

220 11: 
k3
 ^ğ

[10] << 16;

221 10: 
k3
 ^ğ

[ 9] << 8;

222 9: 
k3
 ^ğ

[ 8] << 0;

223 
k3
 *ğ
c3
; k3 = 
	`hash_rÙl_32
(k3, 17); k3 *ğ
c4
; 
h3
 ^= k3;

225 8: 
k2
 ^ğ

[ 7] << 24;

226 7: 
k2
 ^ğ

[ 6] << 16;

227 6: 
k2
 ^ğ

[ 5] << 8;

228 5: 
k2
 ^ğ

[ 4] << 0;

229 
k2
 *ğ
c2
; k2 = 
	`hash_rÙl_32
(k2, 16); k2 *ğ
c3
; 
h2
 ^= k2;

231 4: 
k1
 ^ğ

[ 3] << 24;

232 3: 
k1
 ^ğ

[ 2] << 16;

233 2: 
k1
 ^ğ

[ 1] << 8;

234 1: 
k1
 ^ğ

[ 0] << 0;

235 
k1
 *ğ
c1
; k1 = 
	`hash_rÙl_32
(k1, 15); k1 *ğ
c2
; 
h1
 ^= k1;

240 
h1
 ^ğ
Ën
; 
h2
 ^ğËn; 
h3
 ^ğËn; 
h4
 ^=†en;

242 
h1
 +ğ
h2
; h1 +ğ
h3
; h1 +ğ
h4
;

243 
h2
 +ğ
h1
; 
h3
 +ğh1; 
h4
 += h1;

245 
h1
 = 
	`hash_fmix_32
(h1);

246 
h2
 = 
	`hash_fmix_32
(h2);

247 
h3
 = 
	`hash_fmix_32
(h3);

248 
h4
 = 
	`hash_fmix_32
(h4);

250 
h1
 +ğ
h2
; h1 +ğ
h3
; h1 +ğ
h4
;

251 
h2
 +ğ
h1
; 
h3
 +ğh1; 
h4
 += h1;

253 
r_out
[0] = (((
ušt64_t
è
h2
è<< 32è| 
h1
;

254 
r_out
[1] = (((
ušt64_t
è
h4
è<< 32è| 
h3
;

255 
	}
}

257 
UNUSED
 
JEMALLOC_INLINE
 

258 
	$hash_x64_128
(cÚ¡ *
key
, cÚ¡ 
Ën
, cÚ¡ 
ušt32_t
 
£ed
,

259 
ušt64_t
 
r_out
[2])

261 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*è
key
;

262 cÚ¡ 
nblocks
 = 
Ën
 / 16;

264 
ušt64_t
 
h1
 = 
£ed
;

265 
ušt64_t
 
h2
 = 
£ed
;

267 cÚ¡ 
ušt64_t
 
c1
 = 
	`KQU
(0x87c37b91114253d5);

268 cÚ¡ 
ušt64_t
 
c2
 = 
	`KQU
(0x4cf5ad432745937f);

272 cÚ¡ 
ušt64_t
 *
blocks
 = (cÚ¡ ušt64_ˆ*è(
d©a
);

273 
i
;

275 
i
 = 0; i < 
nblocks
; i++) {

276 
ušt64_t
 
k1
 = 
	`hash_g‘_block_64
(
blocks
, 
i
*2 + 0);

277 
ušt64_t
 
k2
 = 
	`hash_g‘_block_64
(
blocks
, 
i
*2 + 1);

279 
k1
 *ğ
c1
; k1 = 
	`hash_rÙl_64
(k1, 31); k1 *ğ
c2
; 
h1
 ^= k1;

281 
h1
 = 
	`hash_rÙl_64
(h1, 27); h1 +ğ
h2
;

282 
h1
 = h1*5 + 0x52dce729;

284 
k2
 *ğ
c2
; k2 = 
	`hash_rÙl_64
(k2, 33); k2 *ğ
c1
; 
h2
 ^= k2;

286 
h2
 = 
	`hash_rÙl_64
(h2, 31); h2 +ğ
h1
;

287 
h2
 = h2*5 + 0x38495ab5;

293 cÚ¡ 
ušt8_t
 *

 = (cÚ¡ ušt8_t*)(
d©a
 + 
nblocks
*16);

294 
ušt64_t
 
k1
 = 0;

295 
ušt64_t
 
k2
 = 0;

297 
Ën
 & 15) {

298 15: 
k2
 ^ğ((
ušt64_t
)(

[14])) << 48;

299 14: 
k2
 ^ğ((
ušt64_t
)(

[13])) << 40;

300 13: 
k2
 ^ğ((
ušt64_t
)(

[12])) << 32;

301 12: 
k2
 ^ğ((
ušt64_t
)(

[11])) << 24;

302 11: 
k2
 ^ğ((
ušt64_t
)(

[10])) << 16;

303 10: 
k2
 ^ğ((
ušt64_t
)(

[ 9])) << 8;

304 9: 
k2
 ^ğ((
ušt64_t
)(

[ 8])) << 0;

305 
k2
 *ğ
c2
; k2 = 
	`hash_rÙl_64
(k2, 33); k2 *ğ
c1
; 
h2
 ^= k2;

307 8: 
k1
 ^ğ((
ušt64_t
)(

[ 7])) << 56;

308 7: 
k1
 ^ğ((
ušt64_t
)(

[ 6])) << 48;

309 6: 
k1
 ^ğ((
ušt64_t
)(

[ 5])) << 40;

310 5: 
k1
 ^ğ((
ušt64_t
)(

[ 4])) << 32;

311 4: 
k1
 ^ğ((
ušt64_t
)(

[ 3])) << 24;

312 3: 
k1
 ^ğ((
ušt64_t
)(

[ 2])) << 16;

313 2: 
k1
 ^ğ((
ušt64_t
)(

[ 1])) << 8;

314 1: 
k1
 ^ğ((
ušt64_t
)(

[ 0])) << 0;

315 
k1
 *ğ
c1
; k1 = 
	`hash_rÙl_64
(k1, 31); k1 *ğ
c2
; 
h1
 ^= k1;

320 
h1
 ^ğ
Ën
; 
h2
 ^=†en;

322 
h1
 +ğ
h2
;

323 
h2
 +ğ
h1
;

325 
h1
 = 
	`hash_fmix_64
(h1);

326 
h2
 = 
	`hash_fmix_64
(h2);

328 
h1
 +ğ
h2
;

329 
h2
 +ğ
h1
;

331 
r_out
[0] = 
h1
;

332 
r_out
[1] = 
h2
;

333 
	}
}

337 
JEMALLOC_INLINE
 

338 
	$hash
(cÚ¡ *
key
, 
size_t
 
Ën
, cÚ¡ 
ušt32_t
 
£ed
, size_ˆ
r_hash
[2])

341 
	`as£¹
(
Ën
 <ğ
INT_MAX
);

343 #ià(
LG_SIZEOF_PTR
 =ğ3 && !
	`defšed
(
JEMALLOC_BIG_ENDIAN
))

344 
	`hash_x64_128
(
key
, ()
Ën
, 
£ed
, (
ušt64_t
 *)
r_hash
);

347 
ušt64_t
 
hashes
[2];

348 
	`hash_x86_128
(
key
, ()
Ën
, 
£ed
, 
hashes
);

349 
r_hash
[0] = (
size_t
)
hashes
[0];

350 
r_hash
[1] = (
size_t
)
hashes
[1];

353 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/huge.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 *
huge_m®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
, 
boŞ
 
z”o
);

13 *
huge_·Îoc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
,

14 
size_t
 
®ignm’t
, 
boŞ
 
z”o
);

15 
boŞ
 
huge_¿Îoc_no_move
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
,

16 
size_t
 
usize_mš
, size_ˆ
usize_max
, 
boŞ
 
z”o
);

17 *
huge_¿Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, *
±r
, 
size_t
 
Şdsize
,

18 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
);

19 #ifdeà
JEMALLOC_JET


20 (
	thuge_d®loc_junk_t
)(
	ttsdn_t
 *, *, 
	tsize_t
);

21 
huge_d®loc_junk_t
 *
huge_d®loc_junk
;

23 
	`huge_d®loc
(
tsdn_t
 *
tsdn
, *
±r
);

24 
¬’a_t
 *
	`huge_¯Îoc
(cÚ¡ *
±r
);

25 
size_t
 
	`huge_§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
);

26 
´of_tùx_t
 *
	`huge_´of_tùx_g‘
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
);

27 
	`huge_´of_tùx_£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
´of_tùx_t
 *
tùx
);

28 
	`huge_´of_tùx_»£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
);

32 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/jemalloc_internal.h

1 #iâdeà
JEMALLOC_INTERNAL_H


2 
	#JEMALLOC_INTERNAL_H


	)

4 
	~"jem®loc_š‹º®_defs.h
"

5 
	~"jem®loc/š‹º®/jem®loc_š‹º®_deşs.h
"

7 #ifdeà
JEMALLOC_UTRACE


8 
	~<sys/kŒaû.h
>

11 
	#JEMALLOC_NO_DEMANGLE


	)

12 #ifdeà
JEMALLOC_JET


13 
	#JEMALLOC_N
(
n
è
j‘_
##
	)
n

14 
	~"jem®loc/š‹º®/public_Çme¥aû.h
"

15 
	#JEMALLOC_NO_RENAME


	)

16 
	~"../jem®loc.h
"

17 #undeà
JEMALLOC_NO_RENAME


19 
	#JEMALLOC_N
(
n
è
je_
##
	)
n

20 
	~"../jem®loc.h
"

22 
	~"jem®loc/š‹º®/´iv©e_Çme¥aû.h
"

24 cÚ¡ 
boŞ
 
	gcÚfig_debug
 =

25 #ifdeà
JEMALLOC_DEBUG


26 
Œue


28 
çl£


31 cÚ¡ 
boŞ
 
	ghave_dss
 =

32 #ifdeà
JEMALLOC_DSS


33 
Œue


35 
çl£


38 cÚ¡ 
boŞ
 
	gcÚfig_fl
 =

39 #ifdeà
JEMALLOC_FILL


40 
Œue


42 
çl£


45 cÚ¡ 
boŞ
 
	gcÚfig_Ïzy_lock
 =

46 #ifdeà
JEMALLOC_LAZY_LOCK


47 
Œue


49 
çl£


52 cÚ¡ * cÚ¡ 
	gcÚfig_m®loc_cÚf
 = 
JEMALLOC_CONFIG_MALLOC_CONF
;

53 cÚ¡ 
boŞ
 
	gcÚfig_´of
 =

54 #ifdeà
JEMALLOC_PROF


55 
Œue


57 
çl£


60 cÚ¡ 
boŞ
 
	gcÚfig_´of_libgcc
 =

61 #ifdeà
JEMALLOC_PROF_LIBGCC


62 
Œue


64 
çl£


67 cÚ¡ 
boŞ
 
	gcÚfig_´of_libunwšd
 =

68 #ifdeà
JEMALLOC_PROF_LIBUNWIND


69 
Œue


71 
çl£


74 cÚ¡ 
boŞ
 
	gm­s_cßËsû
 =

75 #ifdeà
JEMALLOC_MAPS_COALESCE


76 
Œue


78 
çl£


81 cÚ¡ 
boŞ
 
	gcÚfig_munm­
 =

82 #ifdeà
JEMALLOC_MUNMAP


83 
Œue


85 
çl£


88 cÚ¡ 
boŞ
 
	gcÚfig_¡©s
 =

89 #ifdeà
JEMALLOC_STATS


90 
Œue


92 
çl£


95 cÚ¡ 
boŞ
 
	gcÚfig_tÿche
 =

96 #ifdeà
JEMALLOC_TCACHE


97 
Œue


99 
çl£


102 cÚ¡ 
boŞ
 
	gcÚfig_s
 =

103 #ifdeà
JEMALLOC_TLS


104 
Œue


106 
çl£


109 cÚ¡ 
boŞ
 
	gcÚfig_uŒaû
 =

110 #ifdeà
JEMALLOC_UTRACE


111 
Œue


113 
çl£


116 cÚ¡ 
boŞ
 
	gcÚfig_v®gršd
 =

117 #ifdeà
JEMALLOC_VALGRIND


118 
Œue


120 
çl£


123 cÚ¡ 
boŞ
 
	gcÚfig_xm®loc
 =

124 #ifdeà
JEMALLOC_XMALLOC


125 
Œue


127 
çl£


130 cÚ¡ 
boŞ
 
	gcÚfig_iv§Îoc
 =

131 #ifdeà
JEMALLOC_IVSALLOC


132 
Œue


134 
çl£


137 cÚ¡ 
boŞ
 
	gcÚfig_ÿche_oblivious
 =

138 #ifdeà
JEMALLOC_CACHE_OBLIVIOUS


139 
Œue


141 
çl£


145 #ifdeà
JEMALLOC_C11ATOMICS


146 
	~<¡d©omic.h
>

149 #ifdeà
JEMALLOC_ATOMIC9


150 
	~<machše/©omic.h
>

153 #ià(
defšed
(
JEMALLOC_OSATOMIC
è|| defšed(
JEMALLOC_OSSPIN
))

154 
	~<libk”n/OSAtomic.h
>

157 #ifdeà
JEMALLOC_ZONE


158 
	~<mach/mach_”rÜ.h
>

159 
	~<mach/mach_š™.h
>

160 
	~<mach/vm_m­.h
>

161 
	~<m®loc/m®loc.h
>

164 
	~"jem®loc/š‹º®/ph.h
"

165 
	#RB_COMPACT


	)

166 
	~"jem®loc/š‹º®/rb.h
"

167 
	~"jem®loc/š‹º®/qr.h
"

168 
	~"jem®loc/š‹º®/ql.h
"

184 
	#JEMALLOC_H_TYPES


	)

186 
	~"jem®loc/š‹º®/jem®loc_š‹º®_maüos.h
"

189 
	tszšd_t
;

202 
	#MALLOCX_ARENA_MASK
 (()~0xfffff)

	)

203 
	#MALLOCX_ARENA_MAX
 0xfã

	)

204 
	#MALLOCX_TCACHE_MASK
 (()~0xfff000ffU)

	)

205 
	#MALLOCX_TCACHE_MAX
 0xffd

	)

206 
	#MALLOCX_LG_ALIGN_MASK
 (()0x3f)

	)

208 
	#MALLOCX_ALIGN_GET_SPECIFIED
(
æags
) \

209 (
	`ZU
(1è<< (
æags
 & 
MALLOCX_LG_ALIGN_MASK
))

	)

210 
	#MALLOCX_ALIGN_GET
(
æags
) \

211 (
	`MALLOCX_ALIGN_GET_SPECIFIED
(
æags
è& (
SIZE_T_MAX
-1))

	)

212 
	#MALLOCX_ZERO_GET
(
æags
) \

213 ((
boŞ
)(
æags
 & 
MALLOCX_ZERO
))

	)

215 
	#MALLOCX_TCACHE_GET
(
æags
) \

216 ((()((
æags
 & 
MALLOCX_TCACHE_MASK
è>> 8)è- 2)

	)

217 
	#MALLOCX_ARENA_GET
(
æags
) \

218 ((()((()
æags
è>> 20)è- 1)

	)

221 
	#TINY_MIN
 (1U << 
LG_TINY_MIN
)

	)

227 #iâdeà
LG_QUANTUM


228 #ià(
defšed
(
__i386__
è|| defšed(
_M_IX86
))

229 
	#LG_QUANTUM
 4

	)

231 #ifdeà
__Ÿ64__


232 
	#LG_QUANTUM
 4

	)

234 #ifdeà
__®pha__


235 
	#LG_QUANTUM
 4

	)

237 #ià(
defšed
(
__¥¬c64__
è|| defšed(
__¥¬cv9
))

238 
	#LG_QUANTUM
 4

	)

240 #ià(
defšed
(
__amd64__
è|| defšed(
__x86_64__
è|| defšed(
_M_X64
))

241 
	#LG_QUANTUM
 4

	)

243 #ifdeà
__¬m__


244 
	#LG_QUANTUM
 3

	)

246 #ifdeà
__¯rch64__


247 
	#LG_QUANTUM
 4

	)

249 #ifdeà
__hµa__


250 
	#LG_QUANTUM
 4

	)

252 #ifdeà
__ms__


253 
	#LG_QUANTUM
 3

	)

255 #ifdeà
__Ü1k__


256 
	#LG_QUANTUM
 3

	)

258 #ifdeà
__pow”pc__


259 
	#LG_QUANTUM
 4

	)

261 #ifdeà
__riscv__


262 
	#LG_QUANTUM
 4

	)

264 #ifdeà
__s390__


265 
	#LG_QUANTUM
 4

	)

267 #ifdeà
__SH4__


268 
	#LG_QUANTUM
 4

	)

270 #ifdeà
__te__


271 
	#LG_QUANTUM
 4

	)

273 #ifdeà
__Ë32__


274 
	#LG_QUANTUM
 4

	)

276 #iâdeà
LG_QUANTUM


282 
	#QUANTUM
 ((
size_t
)(1U << 
LG_QUANTUM
))

	)

283 
	#QUANTUM_MASK
 (
QUANTUM
 - 1)

	)

286 
	#QUANTUM_CEILING
(
a
) \

287 (((
a
è+ 
QUANTUM_MASK
è& ~QUANTUM_MASK)

	)

289 
	#LONG
 ((
size_t
)(1U << 
LG_SIZEOF_LONG
))

	)

290 
	#LONG_MASK
 (
LONG
 - 1)

	)

293 
	#LONG_CEILING
(
a
) \

294 (((
a
è+ 
LONG_MASK
è& ~LONG_MASK)

	)

296 
	#SIZEOF_PTR
 (1U << 
LG_SIZEOF_PTR
)

	)

297 
	#PTR_MASK
 (
SIZEOF_PTR
 - 1)

	)

300 
	#PTR_CEILING
(
a
) \

301 (((
a
è+ 
PTR_MASK
è& ~PTR_MASK)

	)

310 
	#LG_CACHELINE
 6

	)

311 
	#CACHELINE
 64

	)

312 
	#CACHELINE_MASK
 (
CACHELINE
 - 1)

	)

315 
	#CACHELINE_CEILING
(
s
) \

316 (((
s
è+ 
CACHELINE_MASK
è& ~CACHELINE_MASK)

	)

319 #ifdeà
PAGE_MASK


320 #undeà
PAGE_MASK


322 
	#PAGE
 ((
size_t
)(1U << 
LG_PAGE
))

	)

323 
	#PAGE_MASK
 ((
size_t
)(
PAGE
 - 1))

	)

326 
	#PAGE_ADDR2BASE
(
a
) \

327 ((*)((
ušŒ_t
)(
a
è& ~
PAGE_MASK
))

	)

330 
	#PAGE_CEILING
(
s
) \

331 (((
s
è+ 
PAGE_MASK
è& ~PAGE_MASK)

	)

334 
	#ALIGNMENT_ADDR2BASE
(
a
, 
®ignm’t
) \

335 ((*)((
ušŒ_t
)(
a
è& (-(
®ignm’t
))))

	)

338 
	#ALIGNMENT_ADDR2OFFSET
(
a
, 
®ignm’t
) \

339 ((
size_t
)((
ušŒ_t
)(
a
è& (
®ignm’t
 - 1)))

	)

342 
	#ALIGNMENT_CEILING
(
s
, 
®ignm’t
) \

343 (((
s
è+ (
®ignm’t
 - 1)è& (-×lignm’t)))

	)

346 #ià
__STDC_VERSION__
 < 199901L

347 #ifdeà
_MSC_VER


348 
	~<m®loc.h
>

349 
	#®loÿ
 
_®loÿ


	)

351 #ifdeà
JEMALLOC_HAS_ALLOCA_H


352 
	~<®loÿ.h
>

354 
	~<¡dlib.h
>

357 
	#VARIABLE_ARRAY
(
ty³
, 
Çme
, 
couÁ
) \

358 
ty³
 *
Çme
 = 
	`®loÿ
(Ñy³è* (
couÁ
))

	)

360 
	#VARIABLE_ARRAY
(
ty³
, 
Çme
, 
couÁ
èty³‚ame[(couÁ)]

	)

363 
	~"jem®loc/š‹º®/n¡ime.h
"

364 
	~"jem®loc/š‹º®/v®gršd.h
"

365 
	~"jem®loc/š‹º®/ut.h
"

366 
	~"jem®loc/š‹º®/©omic.h
"

367 
	~"jem®loc/š‹º®/´ng.h
"

368 
	~"jem®loc/š‹º®/tick”.h
"

369 
	~"jem®loc/š‹º®/ckh.h
"

370 
	~"jem®loc/š‹º®/size_şas£s.h
"

371 
	~"jem®loc/š‹º®/smoÙh¡•.h
"

372 
	~"jem®loc/š‹º®/¡©s.h
"

373 
	~"jem®loc/š‹º®/ùl.h
"

374 
	~"jem®loc/š‹º®/w™Ãss.h
"

375 
	~"jem®loc/š‹º®/mu‹x.h
"

376 
	~"jem®loc/š‹º®/tsd.h
"

377 
	~"jem®loc/š‹º®/mb.h
"

378 
	~"jem®loc/š‹º®/ex‹Á.h
"

379 
	~"jem®loc/š‹º®/¬’a.h
"

380 
	~"jem®loc/š‹º®/b™m­.h
"

381 
	~"jem®loc/š‹º®/ba£.h
"

382 
	~"jem®loc/š‹º®/¹»e.h
"

383 
	~"jem®loc/š‹º®/·ges.h
"

384 
	~"jem®loc/š‹º®/chunk.h
"

385 
	~"jem®loc/š‹º®/huge.h
"

386 
	~"jem®loc/š‹º®/tÿche.h
"

387 
	~"jem®loc/š‹º®/hash.h
"

388 
	~"jem®loc/š‹º®/qu¬ªtše.h
"

389 
	~"jem®loc/š‹º®/´of.h
"

391 #undeà
JEMALLOC_H_TYPES


393 
	#JEMALLOC_H_STRUCTS


	)

395 
	~"jem®loc/š‹º®/n¡ime.h
"

396 
	~"jem®loc/š‹º®/v®gršd.h
"

397 
	~"jem®loc/š‹º®/ut.h
"

398 
	~"jem®loc/š‹º®/©omic.h
"

399 
	~"jem®loc/š‹º®/´ng.h
"

400 
	~"jem®loc/š‹º®/tick”.h
"

401 
	~"jem®loc/š‹º®/ckh.h
"

402 
	~"jem®loc/š‹º®/size_şas£s.h
"

403 
	~"jem®loc/š‹º®/smoÙh¡•.h
"

404 
	~"jem®loc/š‹º®/¡©s.h
"

405 
	~"jem®loc/š‹º®/ùl.h
"

406 
	~"jem®loc/š‹º®/w™Ãss.h
"

407 
	~"jem®loc/š‹º®/mu‹x.h
"

408 
	~"jem®loc/š‹º®/mb.h
"

409 
	~"jem®loc/š‹º®/b™m­.h
"

410 
	#JEMALLOC_ARENA_STRUCTS_A


	)

411 
	~"jem®loc/š‹º®/¬’a.h
"

412 #undeà
JEMALLOC_ARENA_STRUCTS_A


413 
	~"jem®loc/š‹º®/ex‹Á.h
"

414 
	#JEMALLOC_ARENA_STRUCTS_B


	)

415 
	~"jem®loc/š‹º®/¬’a.h
"

416 #undeà
JEMALLOC_ARENA_STRUCTS_B


417 
	~"jem®loc/š‹º®/ba£.h
"

418 
	~"jem®loc/š‹º®/¹»e.h
"

419 
	~"jem®loc/š‹º®/·ges.h
"

420 
	~"jem®loc/š‹º®/chunk.h
"

421 
	~"jem®loc/š‹º®/huge.h
"

422 
	~"jem®loc/š‹º®/tÿche.h
"

423 
	~"jem®loc/š‹º®/hash.h
"

424 
	~"jem®loc/š‹º®/qu¬ªtše.h
"

425 
	~"jem®loc/š‹º®/´of.h
"

427 
	~"jem®loc/š‹º®/tsd.h
"

429 #undeà
JEMALLOC_H_STRUCTS


431 
	#JEMALLOC_H_EXTERNS


	)

433 
boŞ
 
İt_abÜt
;

434 cÚ¡ *
İt_junk
;

435 
boŞ
 
İt_junk_®loc
;

436 
boŞ
 
İt_junk_ä“
;

437 
size_t
 
İt_qu¬ªtše
;

438 
boŞ
 
İt_»dzÚe
;

439 
boŞ
 
İt_uŒaû
;

440 
boŞ
 
İt_xm®loc
;

441 
boŞ
 
İt_z”o
;

442 
İt_Ç»Çs
;

444 
boŞ
 
š_v®gršd
;

447 
nıus
;

450 
Ç»Çs_auto
;

456 
¬’a_t
 **
¬’as
;

462 
size_t
 cÚ¡ 
šdex2size_b
[
NSIZES
+1];

468 
ušt8_t
 cÚ¡ 
size2šdex_b
[];

470 *
a0m®loc
(
size_t
 
size
);

471 
a0d®loc
(*
±r
);

472 *
boÙ¡¿p_m®loc
(
size_t
 
size
);

473 *
boÙ¡¿p_ÿÎoc
(
size_t
 
num
, size_ˆ
size
);

474 
boÙ¡¿p_ä“
(*
±r
);

475 
Ç»Çs_tÙ®_g‘
();

476 
¬’a_t
 *
¬’a_š™
(
tsdn_t
 *
tsdn
, 
šd
);

477 
¬’a_td©a_t
 *
¬’a_td©a_g‘_h¬d
(
tsd_t
 *
tsd
, 
šd
);

478 
¬’a_t
 *
¬’a_choo£_h¬d
(
tsd_t
 *
tsd
, 
boŞ
 
š‹º®
);

479 
¬’a_mig¿‹
(
tsd_t
 *
tsd
, 
Şdšd
, 
Ãwšd
);

480 
th»ad_®loÿ‹d_ş—nup
(
tsd_t
 *
tsd
);

481 
th»ad_d—Îoÿ‹d_ş—nup
(
tsd_t
 *
tsd
);

482 
Ÿ»Ç_ş—nup
(
tsd_t
 *
tsd
);

483 
¬’a_ş—nup
(
tsd_t
 *
tsd
);

484 
¬’as_td©a_ş—nup
(
tsd_t
 *
tsd
);

485 
Ç»Çs_td©a_ş—nup
(
tsd_t
 *
tsd
);

486 
¬’as_td©a_by·ss_ş—nup
(
tsd_t
 *
tsd
);

487 
jem®loc_´efÜk
();

488 
jem®loc_po¡fÜk_·»Á
();

489 
jem®loc_po¡fÜk_chd
();

491 
	~"jem®loc/š‹º®/n¡ime.h
"

492 
	~"jem®loc/š‹º®/v®gršd.h
"

493 
	~"jem®loc/š‹º®/ut.h
"

494 
	~"jem®loc/š‹º®/©omic.h
"

495 
	~"jem®loc/š‹º®/´ng.h
"

496 
	~"jem®loc/š‹º®/tick”.h
"

497 
	~"jem®loc/š‹º®/ckh.h
"

498 
	~"jem®loc/š‹º®/size_şas£s.h
"

499 
	~"jem®loc/š‹º®/smoÙh¡•.h
"

500 
	~"jem®loc/š‹º®/¡©s.h
"

501 
	~"jem®loc/š‹º®/ùl.h
"

502 
	~"jem®loc/š‹º®/w™Ãss.h
"

503 
	~"jem®loc/š‹º®/mu‹x.h
"

504 
	~"jem®loc/š‹º®/mb.h
"

505 
	~"jem®loc/š‹º®/b™m­.h
"

506 
	~"jem®loc/š‹º®/ex‹Á.h
"

507 
	~"jem®loc/š‹º®/¬’a.h
"

508 
	~"jem®loc/š‹º®/ba£.h
"

509 
	~"jem®loc/š‹º®/¹»e.h
"

510 
	~"jem®loc/š‹º®/·ges.h
"

511 
	~"jem®loc/š‹º®/chunk.h
"

512 
	~"jem®loc/š‹º®/huge.h
"

513 
	~"jem®loc/š‹º®/tÿche.h
"

514 
	~"jem®loc/š‹º®/hash.h
"

515 
	~"jem®loc/š‹º®/qu¬ªtše.h
"

516 
	~"jem®loc/š‹º®/´of.h
"

517 
	~"jem®loc/š‹º®/tsd.h
"

519 #undeà
JEMALLOC_H_EXTERNS


521 
	#JEMALLOC_H_INLINES


	)

523 
	~"jem®loc/š‹º®/n¡ime.h
"

524 
	~"jem®loc/š‹º®/v®gršd.h
"

525 
	~"jem®loc/š‹º®/ut.h
"

526 
	~"jem®loc/š‹º®/©omic.h
"

527 
	~"jem®loc/š‹º®/´ng.h
"

528 
	~"jem®loc/š‹º®/tick”.h
"

529 
	~"jem®loc/š‹º®/ckh.h
"

530 
	~"jem®loc/š‹º®/size_şas£s.h
"

531 
	~"jem®loc/š‹º®/smoÙh¡•.h
"

532 
	~"jem®loc/š‹º®/¡©s.h
"

533 
	~"jem®loc/š‹º®/ùl.h
"

534 
	~"jem®loc/š‹º®/tsd.h
"

535 
	~"jem®loc/š‹º®/w™Ãss.h
"

536 
	~"jem®loc/š‹º®/mu‹x.h
"

537 
	~"jem®loc/š‹º®/mb.h
"

538 
	~"jem®loc/š‹º®/ex‹Á.h
"

539 
	~"jem®loc/š‹º®/ba£.h
"

540 
	~"jem®loc/š‹º®/¹»e.h
"

541 
	~"jem®loc/š‹º®/·ges.h
"

542 
	~"jem®loc/š‹º®/chunk.h
"

543 
	~"jem®loc/š‹º®/huge.h
"

545 #iâdeà
JEMALLOC_ENABLE_INLINE


546 
szšd_t
 
size2šdex_compu‹
(
size_t
 
size
);

547 
szšd_t
 
size2šdex_lookup
(
size_t
 
size
);

548 
szšd_t
 
size2šdex
(
size_t
 
size
);

549 
size_t
 
šdex2size_compu‹
(
szšd_t
 
šdex
);

550 
size_t
 
šdex2size_lookup
(
szšd_t
 
šdex
);

551 
size_t
 
šdex2size
(
szšd_t
 
šdex
);

552 
size_t
 
s2u_compu‹
(size_ˆ
size
);

553 
size_t
 
s2u_lookup
(size_ˆ
size
);

554 
size_t
 
s2u
(size_ˆ
size
);

555 
size_t
 
§2u
(size_ˆ
size
, size_ˆ
®ignm’t
);

556 
¬’a_t
 *
¬’a_choo£_im¶
(
tsd_t
 *
tsd
,‡»Ç_ˆ*
¬’a
, 
boŞ
 
š‹º®
);

557 
¬’a_t
 *
¬’a_choo£
(
tsd_t
 *
tsd
,‡»Ç_ˆ*
¬’a
);

558 
¬’a_t
 *
¬’a_ichoo£
(
tsdn_t
 *
tsdn
,‡»Ç_ˆ*
¬’a
);

559 
¬’a_td©a_t
 *
¬’a_td©a_g‘
(
tsd_t
 *
tsd
, 
šd
,

560 
boŞ
 
»äesh_if_missšg
);

561 
¬’a_t
 *
¬’a_g‘
(
tsdn_t
 *
tsdn
, 
šd
, 
boŞ
 
š™_if_missšg
);

562 
tick”_t
 *
deÿy_tick”_g‘
(
tsd_t
 *
tsd
, 
šd
);

565 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_C_
))

566 
JEMALLOC_INLINE
 
szšd_t


567 
	$size2šdex_compu‹
(
size_t
 
size
)

570 #ià(
NTBINS
 != 0)

571 ià(
size
 <ğ(
	`ZU
(1è<< 
LG_TINY_MAXCLASS
)) {

572 
szšd_t
 
lg_tmš
 = 
LG_TINY_MAXCLASS
 - 
NTBINS
 + 1;

573 
szšd_t
 
lg_û
 = 
	`lg_æoÜ
(
	`pow2_û_zu
(
size
));

574  (
lg_û
 < 
lg_tmš
 ? 0 :†g_ceil -†g_tmin);

578 
szšd_t
 
x
 = 
	`uÆik–y
(
	`ZI
(
size
) < 0) ? ((size<<1) ?

579 (
	`ZU
(1)<<(
LG_SIZEOF_PTR
+3)) : ((ZU(1)<<(LG_SIZEOF_PTR+3))-1))

580 : 
	`lg_æoÜ
((
size
<<1)-1);

581 
szšd_t
 
shiá
 = (
x
 < 
LG_SIZE_CLASS_GROUP
 + 
LG_QUANTUM
) ? 0 :

582 
x
 - (
LG_SIZE_CLASS_GROUP
 + 
LG_QUANTUM
);

583 
szšd_t
 
g½
 = 
shiá
 << 
LG_SIZE_CLASS_GROUP
;

585 
szšd_t
 
lg_d–
 = (
x
 < 
LG_SIZE_CLASS_GROUP
 + 
LG_QUANTUM
 + 1)

586 ? 
LG_QUANTUM
 : 
x
 - 
LG_SIZE_CLASS_GROUP
 - 1;

588 
size_t
 
d–_šv”£_mask
 = 
	`ZI
(-1è<< 
lg_d–
;

589 
szšd_t
 
mod
 = ((((
size
-1è& 
d–_šv”£_mask
è>> 
lg_d–
)) &

590 ((
	`ZU
(1è<< 
LG_SIZE_CLASS_GROUP
) - 1);

592 
szšd_t
 
šdex
 = 
NTBINS
 + 
g½
 + 
mod
;

593  (
šdex
);

595 
	}
}

597 
JEMALLOC_ALWAYS_INLINE
 
szšd_t


598 
	$size2šdex_lookup
(
size_t
 
size
)

601 
	`as£¹
(
size
 <ğ
LOOKUP_MAXCLASS
);

603 
szšd_t
 
»t
 = (
size2šdex_b
[(
size
-1è>> 
LG_TINY_MIN
]);

604 
	`as£¹
(
»t
 =ğ
	`size2šdex_compu‹
(
size
));

605  (
»t
);

607 
	}
}

609 
JEMALLOC_ALWAYS_INLINE
 
szšd_t


610 
	$size2šdex
(
size_t
 
size
)

613 
	`as£¹
(
size
 > 0);

614 ià(
	`lik–y
(
size
 <ğ
LOOKUP_MAXCLASS
))

615  (
	`size2šdex_lookup
(
size
));

616  (
	`size2šdex_compu‹
(
size
));

617 
	}
}

619 
JEMALLOC_INLINE
 
size_t


620 
	$šdex2size_compu‹
(
szšd_t
 
šdex
)

623 #ià(
NTBINS
 > 0)

624 ià(
šdex
 < 
NTBINS
)

625  (
	`ZU
(1è<< (
LG_TINY_MAXCLASS
 - 
NTBINS
 + 1 + 
šdex
));

628 
size_t
 
»duûd_šdex
 = 
šdex
 - 
NTBINS
;

629 
size_t
 
g½
 = 
»duûd_šdex
 >> 
LG_SIZE_CLASS_GROUP
;

630 
size_t
 
mod
 = 
»duûd_šdex
 & ((
	`ZU
(1è<< 
LG_SIZE_CLASS_GROUP
) -

633 
size_t
 
g½_size_mask
 = ~((!!
g½
)-1);

634 
size_t
 
g½_size
 = ((
	`ZU
(1è<< (
LG_QUANTUM
 +

635 (
LG_SIZE_CLASS_GROUP
-1))è<< 
g½
è& 
g½_size_mask
;

637 
size_t
 
shiá
 = (
g½
 == 0) ? 1 : grp;

638 
size_t
 
lg_d–
 = 
shiá
 + (
LG_QUANTUM
-1);

639 
size_t
 
mod_size
 = (
mod
+1è<< 
lg_d–
;

641 
size_t
 
usize
 = 
g½_size
 + 
mod_size
;

642  (
usize
);

644 
	}
}

646 
JEMALLOC_ALWAYS_INLINE
 
size_t


647 
	$šdex2size_lookup
(
szšd_t
 
šdex
)

649 
size_t
 
»t
 = (size_t)
šdex2size_b
[
šdex
];

650 
	`as£¹
(
»t
 =ğ
	`šdex2size_compu‹
(
šdex
));

651  (
»t
);

652 
	}
}

654 
JEMALLOC_ALWAYS_INLINE
 
size_t


655 
	$šdex2size
(
szšd_t
 
šdex
)

658 
	`as£¹
(
šdex
 < 
NSIZES
);

659  (
	`šdex2size_lookup
(
šdex
));

660 
	}
}

662 
JEMALLOC_ALWAYS_INLINE
 
size_t


663 
	$s2u_compu‹
(
size_t
 
size
)

666 #ià(
NTBINS
 > 0)

667 ià(
size
 <ğ(
	`ZU
(1è<< 
LG_TINY_MAXCLASS
)) {

668 
size_t
 
lg_tmš
 = 
LG_TINY_MAXCLASS
 - 
NTBINS
 + 1;

669 
size_t
 
lg_û
 = 
	`lg_æoÜ
(
	`pow2_û_zu
(
size
));

670  (
lg_û
 < 
lg_tmš
 ? (
	`ZU
(1) <<†g_tmin) :

671 (
	`ZU
(1è<< 
lg_û
));

675 
size_t
 
x
 = 
	`uÆik–y
(
	`ZI
(
size
) < 0) ? ((size<<1) ?

676 (
	`ZU
(1)<<(
LG_SIZEOF_PTR
+3)) : ((ZU(1)<<(LG_SIZEOF_PTR+3))-1))

677 : 
	`lg_æoÜ
((
size
<<1)-1);

678 
size_t
 
lg_d–
 = (
x
 < 
LG_SIZE_CLASS_GROUP
 + 
LG_QUANTUM
 + 1)

679 ? 
LG_QUANTUM
 : 
x
 - 
LG_SIZE_CLASS_GROUP
 - 1;

680 
size_t
 
d–
 = 
	`ZU
(1è<< 
lg_d–
;

681 
size_t
 
d–_mask
 = 
d–
 - 1;

682 
size_t
 
usize
 = (
size
 + 
d–_mask
) & ~delta_mask;

683  (
usize
);

685 
	}
}

687 
JEMALLOC_ALWAYS_INLINE
 
size_t


688 
	$s2u_lookup
(
size_t
 
size
)

690 
size_t
 
»t
 = 
	`šdex2size_lookup
(
	`size2šdex_lookup
(
size
));

692 
	`as£¹
(
»t
 =ğ
	`s2u_compu‹
(
size
));

693  (
»t
);

694 
	}
}

700 
JEMALLOC_ALWAYS_INLINE
 
size_t


701 
	$s2u
(
size_t
 
size
)

704 
	`as£¹
(
size
 > 0);

705 ià(
	`lik–y
(
size
 <ğ
LOOKUP_MAXCLASS
))

706  (
	`s2u_lookup
(
size
));

707  (
	`s2u_compu‹
(
size
));

708 
	}
}

714 
JEMALLOC_ALWAYS_INLINE
 
size_t


715 
	$§2u
(
size_t
 
size
, size_ˆ
®ignm’t
)

717 
size_t
 
usize
;

719 
	`as£¹
(
®ignm’t
 != 0 && ((alignment - 1) &‡lignment) == 0);

722 ià(
size
 <ğ
SMALL_MAXCLASS
 && 
®ignm’t
 < 
PAGE
) {

737 
usize
 = 
	`s2u
(
	`ALIGNMENT_CEILING
(
size
, 
®ignm’t
));

738 ià(
usize
 < 
LARGE_MINCLASS
)

739  (
usize
);

743 ià(
	`lik–y
(
size
 <ğ
Ïrge_maxşass
è&&†ik–y(
®ignm’t
 < 
chunksize
)) {

748 
®ignm’t
 = 
	`PAGE_CEILING
(alignment);

751 
usize
 = (
size
 <ğ
LARGE_MINCLASS
è? LARGE_MINCLASS : 
	`s2u
(size);

757 ià(
usize
 + 
Ïrge_·d
 + 
®ignm’t
 <ğ
¬’a_maxrun
)

758  (
usize
);

763 ià(
	`uÆik–y
(
®ignm’t
 > 
HUGE_MAXCLASS
))

770 
®ignm’t
 = 
	`CHUNK_CEILING
(alignment);

773 ià(
size
 <ğ
chunksize
)

774 
usize
 = 
chunksize
;

776 
usize
 = 
	`s2u
(
size
);

777 ià(
usize
 < 
size
) {

787 ià(
usize
 + 
®ignm’t
 < usize) {

791  (
usize
);

792 
	}
}

795 
JEMALLOC_INLINE
 
¬’a_t
 *

796 
	$¬’a_choo£_im¶
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
boŞ
 
š‹º®
)

798 
¬’a_t
 *
»t
;

800 ià(
¬’a
 !ğ
NULL
)

801  (
¬’a
);

803 
»t
 = 
š‹º®
 ? 
	`tsd_Ÿ»Ç_g‘
(
tsd
è: 
	`tsd_¬’a_g‘
(tsd);

804 ià(
	`uÆik–y
(
»t
 =ğ
NULL
))

805 
»t
 = 
	`¬’a_choo£_h¬d
(
tsd
, 
š‹º®
);

807  (
»t
);

808 
	}
}

810 
JEMALLOC_INLINE
 
¬’a_t
 *

811 
	$¬’a_choo£
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
)

814  (
	`¬’a_choo£_im¶
(
tsd
, 
¬’a
, 
çl£
));

815 
	}
}

817 
JEMALLOC_INLINE
 
¬’a_t
 *

818 
	$¬’a_ichoo£
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

821 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
è|| 
¬’a
 !ğ
NULL
);

823 ià(!
	`tsdn_nuÎ
(
tsdn
))

824  (
	`¬’a_choo£_im¶
(
	`tsdn_tsd
(
tsdn
), 
NULL
, 
Œue
));

825  (
¬’a
);

826 
	}
}

828 
JEMALLOC_INLINE
 
¬’a_td©a_t
 *

829 
	$¬’a_td©a_g‘
(
tsd_t
 *
tsd
, 
šd
, 
boŞ
 
»äesh_if_missšg
)

831 
¬’a_td©a_t
 *
td©a
;

832 
¬’a_td©a_t
 *
¬’as_td©a
 = 
	`tsd_¬’as_td©a_g‘
(
tsd
);

834 ià(
	`uÆik–y
(
¬’as_td©a
 =ğ
NULL
)) {

836  (
	`¬’a_td©a_g‘_h¬d
(
tsd
, 
šd
));

838 ià(
	`uÆik–y
(
šd
 >ğ
	`tsd_Ç»Çs_td©a_g‘
(
tsd
))) {

843  (
»äesh_if_missšg
 ? 
	`¬’a_td©a_g‘_h¬d
(
tsd
, 
šd
) :

844 
NULL
);

847 
td©a
 = &
¬’as_td©a
[
šd
];

848 ià(
	`lik–y
(
td©a
 !ğ
NULL
è|| !
»äesh_if_missšg
)

849  (
td©a
);

850  (
	`¬’a_td©a_g‘_h¬d
(
tsd
, 
šd
));

851 
	}
}

853 
JEMALLOC_INLINE
 
¬’a_t
 *

854 
	$¬’a_g‘
(
tsdn_t
 *
tsdn
, 
šd
, 
boŞ
 
š™_if_missšg
)

856 
¬’a_t
 *
»t
;

858 
	`as£¹
(
šd
 <ğ
MALLOCX_ARENA_MAX
);

860 
»t
 = 
¬’as
[
šd
];

861 ià(
	`uÆik–y
(
»t
 =ğ
NULL
)) {

862 
»t
 = 
	`©omic_»ad_p
((*)&
¬’as
[
šd
]);

863 ià(
š™_if_missšg
 && 
	`uÆik–y
(
»t
 =ğ
NULL
))

864 
»t
 = 
	`¬’a_š™
(
tsdn
, 
šd
);

866  (
»t
);

867 
	}
}

869 
JEMALLOC_INLINE
 
tick”_t
 *

870 
	$deÿy_tick”_g‘
(
tsd_t
 *
tsd
, 
šd
)

872 
¬’a_td©a_t
 *
td©a
;

874 
td©a
 = 
	`¬’a_td©a_g‘
(
tsd
, 
šd
, 
Œue
);

875 ià(
	`uÆik–y
(
td©a
 =ğ
NULL
))

876  (
NULL
);

877  (&
td©a
->
deÿy_tick”
);

878 
	}
}

881 
	~"jem®loc/š‹º®/b™m­.h
"

886 
	#JEMALLOC_ARENA_INLINE_A


	)

887 
	~"jem®loc/š‹º®/¬’a.h
"

888 #undeà
JEMALLOC_ARENA_INLINE_A


889 
	~"jem®loc/š‹º®/tÿche.h
"

890 
	#JEMALLOC_ARENA_INLINE_B


	)

891 
	~"jem®loc/š‹º®/¬’a.h
"

892 #undeà
JEMALLOC_ARENA_INLINE_B


893 
	~"jem®loc/š‹º®/hash.h
"

894 
	~"jem®loc/š‹º®/qu¬ªtše.h
"

896 #iâdeà
JEMALLOC_ENABLE_INLINE


897 
¬’a_t
 *
Ÿ®loc
(cÚ¡ *
±r
);

898 
size_t
 
i§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
boŞ
 
demÙe
);

899 *
ŸÎocztm
(
tsdn_t
 *
tsdn
, 
size_t
 
size
, 
szšd_t
 
šd
, 
boŞ
 
z”o
,

900 
tÿche_t
 *
tÿche
, 
boŞ
 
is_m‘ad©a
, 
¬’a_t
 *
¬’a
, boŞ 
¦ow_·th
);

901 *
ŸÎoc
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
szšd_t
 
šd
, 
boŞ
 
z”o
,

902 
boŞ
 
¦ow_·th
);

903 *
®locztm
(
tsdn_t
 *
tsdn
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

904 
tÿche_t
 *
tÿche
, 
boŞ
 
is_m‘ad©a
, 
¬’a_t
 *
¬’a
);

905 *
®loù
(
tsdn_t
 *
tsdn
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

906 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

907 *
®loc
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
);

908 
size_t
 
iv§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
boŞ
 
demÙe
);

909 
size_t
 
u2rz
(size_ˆ
usize
);

910 
size_t
 
p2rz
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
);

911 
id®loùm
(
tsdn_t
 *
tsdn
, *
±r
, 
tÿche_t
 *
tÿche
, 
boŞ
 
is_m‘ad©a
,

912 
boŞ
 
¦ow_·th
);

913 
id®loc
(
tsd_t
 *
tsd
, *
±r
);

914 
iq®loc
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
, 
boŞ
 
¦ow_·th
);

915 
isd®loù
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
,

916 
boŞ
 
¦ow_·th
);

917 
isq®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
,

918 
boŞ
 
¦ow_·th
);

919 *
œ®loù_»®ign
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

920 
size_t
 
exŒa
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
,

921 
¬’a_t
 *
¬’a
);

922 *
œ®loù
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

923 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

924 *
œ®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

925 
size_t
 
®ignm’t
, 
boŞ
 
z”o
);

926 
boŞ
 
ix®loc
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

927 
size_t
 
exŒa
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
);

930 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_C_
))

931 
JEMALLOC_ALWAYS_INLINE
 
¬’a_t
 *

932 
	$Ÿ®loc
(cÚ¡ *
±r
)

935 
	`as£¹
(
±r
 !ğ
NULL
);

937  (
	`¬’a_¯Îoc
(
±r
));

938 
	}
}

946 
JEMALLOC_ALWAYS_INLINE
 
size_t


947 
	$i§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
boŞ
 
demÙe
)

950 
	`as£¹
(
±r
 !ğ
NULL
);

952 
	`as£¹
(
cÚfig_´of
 || !
demÙe
);

954  (
	`¬’a_§Îoc
(
tsdn
, 
±r
, 
demÙe
));

955 
	}
}

957 
JEMALLOC_ALWAYS_INLINE
 *

958 
	$ŸÎocztm
(
tsdn_t
 *
tsdn
, 
size_t
 
size
, 
szšd_t
 
šd
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
,

959 
boŞ
 
is_m‘ad©a
, 
¬’a_t
 *
¬’a
, boŞ 
¦ow_·th
)

961 *
»t
;

963 
	`as£¹
(
size
 != 0);

964 
	`as£¹
(!
is_m‘ad©a
 || 
tÿche
 =ğ
NULL
);

965 
	`as£¹
(!
is_m‘ad©a
 || 
¬’a
 =ğ
NULL
 ||‡»Ç->
šd
 < 
Ç»Çs_auto
);

967 
»t
 = 
	`¬’a_m®loc
(
tsdn
, 
¬’a
, 
size
, 
šd
, 
z”o
, 
tÿche
, 
¦ow_·th
);

968 ià(
cÚfig_¡©s
 && 
is_m‘ad©a
 && 
	`lik–y
(
»t
 !ğ
NULL
)) {

969 
	`¬’a_m‘ad©a_®loÿ‹d_add
(
	`Ÿ®loc
(
»t
),

970 
	`i§Îoc
(
tsdn
, 
»t
, 
cÚfig_´of
));

972  (
»t
);

973 
	}
}

975 
JEMALLOC_ALWAYS_INLINE
 *

976 
	$ŸÎoc
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
szšd_t
 
šd
, 
boŞ
 
z”o
, boŞ 
¦ow_·th
)

979  (
	`ŸÎocztm
(
	`tsd_tsdn
(
tsd
), 
size
, 
šd
, 
z”o
, 
	`tÿche_g‘
Ñsd, 
Œue
),

980 
çl£
, 
NULL
, 
¦ow_·th
));

981 
	}
}

983 
JEMALLOC_ALWAYS_INLINE
 *

984 
	$®locztm
(
tsdn_t
 *
tsdn
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

985 
tÿche_t
 *
tÿche
, 
boŞ
 
is_m‘ad©a
, 
¬’a_t
 *
¬’a
)

987 *
»t
;

989 
	`as£¹
(
usize
 != 0);

990 
	`as£¹
(
usize
 =ğ
	`§2u
(usize, 
®ignm’t
));

991 
	`as£¹
(!
is_m‘ad©a
 || 
tÿche
 =ğ
NULL
);

992 
	`as£¹
(!
is_m‘ad©a
 || 
¬’a
 =ğ
NULL
 ||‡»Ç->
šd
 < 
Ç»Çs_auto
);

994 
»t
 = 
	`¬’a_·Îoc
(
tsdn
, 
¬’a
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
);

995 
	`as£¹
(
	`ALIGNMENT_ADDR2BASE
(
»t
, 
®ignm’t
) ==„et);

996 ià(
cÚfig_¡©s
 && 
is_m‘ad©a
 && 
	`lik–y
(
»t
 !ğ
NULL
)) {

997 
	`¬’a_m‘ad©a_®loÿ‹d_add
(
	`Ÿ®loc
(
»t
), 
	`i§Îoc
(
tsdn
,„et,

998 
cÚfig_´of
));

1000  (
»t
);

1001 
	}
}

1003 
JEMALLOC_ALWAYS_INLINE
 *

1004 
	$®loù
(
tsdn_t
 *
tsdn
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

1005 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

1008  (
	`®locztm
(
tsdn
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
çl£
, 
¬’a
));

1009 
	}
}

1011 
JEMALLOC_ALWAYS_INLINE
 *

1012 
	$®loc
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
)

1015  (
	`®locztm
(
	`tsd_tsdn
(
tsd
), 
usize
, 
®ignm’t
, 
z”o
,

1016 
	`tÿche_g‘
(
tsd
, 
Œue
), 
çl£
, 
NULL
));

1017 
	}
}

1019 
JEMALLOC_ALWAYS_INLINE
 
size_t


1020 
	$iv§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
boŞ
 
demÙe
)

1022 
ex‹Á_node_t
 *
node
;

1025 
node
 = 
	`chunk_lookup
(
±r
, 
çl£
);

1026 ià(
node
 =ğ
NULL
)

1029 
	`as£¹
(
	`ex‹Á_node_addr_g‘
(
node
è=ğ
±r
 ||

1030 
	`ex‹Á_node_achunk_g‘
(
node
));

1032  (
	`i§Îoc
(
tsdn
, 
±r
, 
demÙe
));

1033 
	}
}

1035 
JEMALLOC_INLINE
 
size_t


1036 
	$u2rz
(
size_t
 
usize
)

1038 
size_t
 
»t
;

1040 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

1041 
szšd_t
 
bššd
 = 
	`size2šdex
(
usize
);

1042 
»t
 = 
¬’a_bš_šfo
[
bššd
].
»dzÚe_size
;

1044 
»t
 = 0;

1046  (
»t
);

1047 
	}
}

1049 
JEMALLOC_INLINE
 
size_t


1050 
	$p2rz
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
)

1052 
size_t
 
usize
 = 
	`i§Îoc
(
tsdn
, 
±r
, 
çl£
);

1054  (
	`u2rz
(
usize
));

1055 
	}
}

1057 
JEMALLOC_ALWAYS_INLINE
 

1058 
	$id®loùm
(
tsdn_t
 *
tsdn
, *
±r
, 
tÿche_t
 *
tÿche
, 
boŞ
 
is_m‘ad©a
,

1059 
boŞ
 
¦ow_·th
)

1062 
	`as£¹
(
±r
 !ğ
NULL
);

1063 
	`as£¹
(!
is_m‘ad©a
 || 
tÿche
 =ğ
NULL
);

1064 
	`as£¹
(!
is_m‘ad©a
 || 
	`Ÿ®loc
(
±r
)->
šd
 < 
Ç»Çs_auto
);

1065 ià(
cÚfig_¡©s
 && 
is_m‘ad©a
) {

1066 
	`¬’a_m‘ad©a_®loÿ‹d_sub
(
	`Ÿ®loc
(
±r
), 
	`i§Îoc
(
tsdn
,…tr,

1067 
cÚfig_´of
));

1070 
	`¬’a_d®loc
(
tsdn
, 
±r
, 
tÿche
, 
¦ow_·th
);

1071 
	}
}

1073 
JEMALLOC_ALWAYS_INLINE
 

1074 
	$id®loc
(
tsd_t
 *
tsd
, *
±r
)

1077 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
±r
, 
	`tÿche_g‘
Ñsd, 
çl£
), f®£, 
Œue
);

1078 
	}
}

1080 
JEMALLOC_ALWAYS_INLINE
 

1081 
	$iq®loc
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
, 
boŞ
 
¦ow_·th
)

1084 ià(
¦ow_·th
 && 
cÚfig_fl
 && 
	`uÆik–y
(
İt_qu¬ªtše
))

1085 
	`qu¬ªtše
(
tsd
, 
±r
);

1087 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
±r
, 
tÿche
, 
çl£
, 
¦ow_·th
);

1088 
	}
}

1090 
JEMALLOC_ALWAYS_INLINE
 

1091 
	$isd®loù
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
,

1092 
boŞ
 
¦ow_·th
)

1095 
	`¬’a_sd®loc
(
tsdn
, 
±r
, 
size
, 
tÿche
, 
¦ow_·th
);

1096 
	}
}

1098 
JEMALLOC_ALWAYS_INLINE
 

1099 
	$isq®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
, 
boŞ
 
¦ow_·th
)

1102 ià(
¦ow_·th
 && 
cÚfig_fl
 && 
	`uÆik–y
(
İt_qu¬ªtše
))

1103 
	`qu¬ªtše
(
tsd
, 
±r
);

1105 
	`isd®loù
(
	`tsd_tsdn
(
tsd
), 
±r
, 
size
, 
tÿche
, 
¦ow_·th
);

1106 
	}
}

1108 
JEMALLOC_ALWAYS_INLINE
 *

1109 
	$œ®loù_»®ign
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

1110 
size_t
 
exŒa
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

1112 *
p
;

1113 
size_t
 
usize
, 
cİysize
;

1115 
usize
 = 
	`§2u
(
size
 + 
exŒa
, 
®ignm’t
);

1116 ià(
	`uÆik–y
(
usize
 =ğ0 || usiz> 
HUGE_MAXCLASS
))

1117  (
NULL
);

1118 
p
 = 
	`®loù
(
	`tsd_tsdn
(
tsd
), 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
);

1119 ià(
p
 =ğ
NULL
) {

1120 ià(
exŒa
 == 0)

1121  (
NULL
);

1123 
usize
 = 
	`§2u
(
size
, 
®ignm’t
);

1124 ià(
	`uÆik–y
(
usize
 =ğ0 || usiz> 
HUGE_MAXCLASS
))

1125  (
NULL
);

1126 
p
 = 
	`®loù
(
	`tsd_tsdn
(
tsd
), 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
,

1127 
¬’a
);

1128 ià(
p
 =ğ
NULL
)

1129  (
NULL
);

1135 
cİysize
 = (
size
 < 
Şdsize
) ? size : oldsize;

1136 
	`memıy
(
p
, 
±r
, 
cİysize
);

1137 
	`isq®loc
(
tsd
, 
±r
, 
Şdsize
, 
tÿche
, 
Œue
);

1138  (
p
);

1139 
	}
}

1141 
JEMALLOC_ALWAYS_INLINE
 *

1142 
	$œ®loù
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
, size_ˆ
®ignm’t
,

1143 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

1146 
	`as£¹
(
±r
 !ğ
NULL
);

1147 
	`as£¹
(
size
 != 0);

1149 ià(
®ignm’t
 !ğ0 && ((
ušŒ_t
)
±r
 & ((uintptr_t)alignment-1))

1155  (
	`œ®loù_»®ign
(
tsd
, 
±r
, 
Şdsize
, 
size
, 0, 
®ignm’t
,

1156 
z”o
, 
tÿche
, 
¬’a
));

1159  (
	`¬’a_¿Îoc
(
tsd
, 
¬’a
, 
±r
, 
Şdsize
, 
size
, 
®ignm’t
, 
z”o
,

1160 
tÿche
));

1161 
	}
}

1163 
JEMALLOC_ALWAYS_INLINE
 *

1164 
	$œ®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
, size_ˆ
®ignm’t
,

1165 
boŞ
 
z”o
)

1168  (
	`œ®loù
(
tsd
, 
±r
, 
Şdsize
, 
size
, 
®ignm’t
, 
z”o
,

1169 
	`tÿche_g‘
(
tsd
, 
Œue
), 
NULL
));

1170 
	}
}

1172 
JEMALLOC_ALWAYS_INLINE
 
boŞ


1173 
	$ix®loc
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
, size_ˆ
exŒa
,

1174 
size_t
 
®ignm’t
, 
boŞ
 
z”o
)

1177 
	`as£¹
(
±r
 !ğ
NULL
);

1178 
	`as£¹
(
size
 != 0);

1180 ià(
®ignm’t
 !ğ0 && ((
ušŒ_t
)
±r
 & ((uintptr_t)alignment-1))

1183  (
Œue
);

1186  (
	`¬’a_¿Îoc_no_move
(
tsdn
, 
±r
, 
Şdsize
, 
size
, 
exŒa
, 
z”o
));

1187 
	}
}

1190 
	~"jem®loc/š‹º®/´of.h
"

1192 #undeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/jemalloc_internal_decls.h

1 #iâdeà
JEMALLOC_INTERNAL_DECLS_H


2 
	#JEMALLOC_INTERNAL_DECLS_H


	)

4 
	~<m©h.h
>

5 #ifdeà
_WIN32


6 
	~<wšdows.h
>

7 
	~"msvc_com·t/wšdows_exŒa.h
"

10 
	~<sys/·¿m.h
>

11 
	~<sys/mmª.h
>

12 #ià!
defšed
(
__²aş__
è&& !defšed(
__Çtive_ş›Á__
)

13 
	~<sys/sysÿÎ.h
>

14 #ià!
defšed
(
SYS_wr™e
è&& defšed(
__NR_wr™e
)

15 
	#SYS_wr™e
 
__NR_wr™e


	)

17 
	~<sys/uio.h
>

19 
	~<±h»ad.h
>

20 
	~<”ºo.h
>

21 
	~<sys/time.h
>

23 
	~<sys/ty³s.h
>

25 
	~<lim™s.h
>

26 #iâdeà
SIZE_T_MAX


27 
	#SIZE_T_MAX
 
SIZE_MAX


	)

29 
	~<¡d¬g.h
>

30 
	~<¡dboŞ.h
>

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡dšt.h
>

34 
	~<¡ddef.h
>

35 #iâdeà
off£tof


36 
	#off£tof
(
ty³
, 
memb”
è((
size_t
)&((Ñy³ *)
NULL
)->memb”))

	)

38 
	~<¡ršg.h
>

39 
	~<¡ršgs.h
>

40 
	~<ùy³.h
>

41 #ifdeà
_MSC_VER


42 
	~<io.h
>

43 
šŒ_t
 
	tssize_t
;

44 
	#PATH_MAX
 1024

	)

45 
	#STDERR_FILENO
 2

	)

46 
	#__func__
 
__FUNCTION__


	)

47 #ifdeà
JEMALLOC_HAS_RESTRICT


48 
	#»¡riù
 
__»¡riù


	)

51 #´agm¨
w¬nšg
(
di§bË
: 4996)

52 #ià
_MSC_VER
 < 1800

54 
	$isbÏnk
(
c
)

57  (
c
 == '\t' || c == ' ');

58 
	}
}

61 
	~<uni¡d.h
>

63 
	~<fú.h
>

	@dep/jemalloc-4.2.0/include/jemalloc/internal/jemalloc_internal_defs.h

2 #iâdeà
JEMALLOC_INTERNAL_DEFS_H_


3 
	#JEMALLOC_INTERNAL_DEFS_H_


	)

9 
	#JEMALLOC_PREFIX
 "je_"

	)

10 
	#JEMALLOC_CPREFIX
 "JE_"

	)

18 
	#JEMALLOC_PRIVATE_NAMESPACE
 
je_


	)

24 
	#CPU_SPINWAIT
 
__asm__
 vŞ©e("·u£")

	)

57 
	#JEMALLOC_HAVE_BUILTIN_CLZ


	)

62 
	#JEMALLOC_HAVE_MADVISE


	)

73 
	#JEMALLOC_HAVE_SECURE_GETENV


	)

94 
	#JEMALLOC_THREADED_INIT


	)

104 
	#JEMALLOC_TLS_MODEL
 
	`__©Œibu‹__
((
	`s_mod–
("š™Ÿl-exec")))

	)

107 
	#JEMALLOC_CC_SILENCE


	)

119 
	#JEMALLOC_STATS


	)

138 
	#JEMALLOC_TCACHE


	)

144 
	#JEMALLOC_DSS


	)

147 
	#JEMALLOC_FILL


	)

162 
	#LG_TINY_MIN
 3

	)

171 
	#LG_PAGE
 12

	)

180 
	#JEMALLOC_MAPS_COALESCE


	)

190 
	#JEMALLOC_TLS


	)

196 
	#JEMALLOC_INTERNAL_FFSLL
 
__butš_ff¦l


	)

197 
	#JEMALLOC_INTERNAL_FFSL
 
__butš_ff¦


	)

198 
	#JEMALLOC_INTERNAL_FFS
 
__butš_ffs


	)

210 
	#JEMALLOC_CACHE_OBLIVIOUS


	)

225 
	#JEMALLOC_PROC_SYS_VM_OVERCOMMIT_MEMORY


	)

237 
	#JEMALLOC_PURGE_MADVISE_DONTNEED


	)

241 
	#JEMALLOC_HAS_ALLOCA_H
 1

	)

244 
	#JEMALLOC_HAS_RESTRICT
 1

	)

250 
	#LG_SIZEOF_INT
 2

	)

253 
	#LG_SIZEOF_LONG
 3

	)

256 
	#LG_SIZEOF_LONG_LONG
 3

	)

259 
	#LG_SIZEOF_INTMAX_T
 3

	)

262 
	#JEMALLOC_GLIBC_MALLOC_HOOK


	)

265 
	#JEMALLOC_GLIBC_MEMALIGN_HOOK


	)

268 
	#JEMALLOC_HAVE_PTHREAD_MUTEX_ADAPTIVE_NP


	)

277 
	#JEMALLOC_CONFIG_MALLOC_CONF
 ""

	)

	@dep/jemalloc-4.2.0/include/jemalloc/internal/jemalloc_internal_macros.h

10 #ià
defšed
(
JEMALLOC_DEBUG
è|| defšed(
JEMALLOC_CODE_COVERAGE
)

12 
	#JEMALLOC_ALWAYS_INLINE


	)

13 
	#JEMALLOC_ALWAYS_INLINE_C
 

	)

14 
	#JEMALLOC_INLINE


	)

15 
	#JEMALLOC_INLINE_C
 

	)

16 
	#šlše


	)

18 
	#JEMALLOC_ENABLE_INLINE


	)

19 #ifdeà
JEMALLOC_HAVE_ATTR


20 
	#JEMALLOC_ALWAYS_INLINE
 \

21 
šlše
 
	`JEMALLOC_ATTR
(
unu£d
èJEMALLOC_ATTR(
®ways_šlše
)

	)

22 
	#JEMALLOC_ALWAYS_INLINE_C
 \

23 
šlše
 
	`JEMALLOC_ATTR
(
®ways_šlše
)

	)

25 
	#JEMALLOC_ALWAYS_INLINE
 
šlše


	)

26 
	#JEMALLOC_ALWAYS_INLINE_C
 
šlše


	)

28 
	#JEMALLOC_INLINE
 
šlše


	)

29 
	#JEMALLOC_INLINE_C
 
šlše


	)

30 #ifdeà
_MSC_VER


31 
	#šlše
 
_šlše


	)

35 #ifdeà
JEMALLOC_CC_SILENCE


36 
	#UNUSED
 
	`JEMALLOC_ATTR
(
unu£d
)

	)

38 
	#UNUSED


	)

41 
	#ZU
(
z
è((
size_t
)z)

	)

42 
	#ZI
(
z
è((
ssize_t
)z)

	)

43 
	#QU
(
q
è((
ušt64_t
)q)

	)

44 
	#QI
(
q
è((
št64_t
)q)

	)

46 
	#KZU
(
z
è
	`ZU
(z##
ULL
)

	)

47 
	#KZI
(
z
è
	`ZI
(z##
LL
)

	)

48 
	#KQU
(
q
è
	`QU
(q##
ULL
)

	)

49 
	#KQI
(
q
è
	`QI
(q##
LL
)

	)

51 #iâdeà
__DECONST


52 
	#__DECONST
(
ty³
, 
v¬
è(Ñy³)(
ušŒ_t
)(cÚ¡ *)(v¬))

	)

55 #iâdeà
JEMALLOC_HAS_RESTRICT


56 
	#»¡riù


	)

	@dep/jemalloc-4.2.0/include/jemalloc/internal/mb.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


14 #ifdeà
JEMALLOC_H_INLINES


16 #iâdeà
JEMALLOC_ENABLE_INLINE


17 
mb_wr™e
();

20 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_MB_C_
))

21 #ifdeà
__i386__


31 
JEMALLOC_INLINE
 

32 
	$mb_wr™e
()

37 
asm
 volatile ("pusha;"

50 
asm
 volatile ("nop;"

56 
	}
}

57 #–ià(
defšed
(
__amd64__
è|| defšed(
__x86_64__
))

58 
JEMALLOC_INLINE
 

59 
	$mb_wr™e
()

62 
asm
 volatile ("sfence"

67 
	}
}

68 #–ià
defšed
(
__pow”pc__
)

69 
JEMALLOC_INLINE
 

70 
	$mb_wr™e
()

73 
asm
 volatile ("eieio"

78 
	}
}

79 #–ià
defšed
(
__¥¬c64__
)

80 
JEMALLOC_INLINE
 

81 
	$mb_wr™e
()

84 
asm
 volatile ("membar #StoreStore"

89 
	}
}

90 #–ià
defšed
(
__te__
)

91 
JEMALLOC_INLINE
 

92 
	$mb_wr™e
()

95 
	`__sync_synchrÚize
();

96 
	}
}

102 
JEMALLOC_INLINE
 

103 
	$mb_wr™e
()

105 
m®loc_mu‹x_t
 
mtx
;

107 
	`m®loc_mu‹x_š™
(&
mtx
, "mb", 
WITNESS_RANK_OMIT
);

108 
	`m®loc_mu‹x_lock
(
NULL
, &
mtx
);

109 
	`m®loc_mu‹x_uÆock
(
NULL
, &
mtx
);

110 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/mutex.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
m®loc_mu‹x_s
 
	tm®loc_mu‹x_t
;

6 #ifdeà
_WIN32


7 
	#MALLOC_MUTEX_INITIALIZER


	)

8 #–ià(
defšed
(
JEMALLOC_OSSPIN
))

9 
	#MALLOC_MUTEX_INITIALIZER
 {0, 
	`WITNESS_INITIALIZER
(
WITNESS_RANK_OMIT
)}

	)

10 #–ià(
defšed
(
JEMALLOC_MUTEX_INIT_CB
))

11 
	#MALLOC_MUTEX_INITIALIZER
 \

12 {
PTHREAD_MUTEX_INITIALIZER
, 
NULL
, 
	`WITNESS_INITIALIZER
(
WITNESS_RANK_OMIT
)}

	)

14 #ià(
defšed
(
JEMALLOC_HAVE_PTHREAD_MUTEX_ADAPTIVE_NP
) && \

15 
	$defšed
(
PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
))

16 
	#MALLOC_MUTEX_TYPE
 
PTHREAD_MUTEX_ADAPTIVE_NP


	)

17 
	#MALLOC_MUTEX_INITIALIZER
 \

18 {
PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
, \

19 
	`WITNESS_INITIALIZER
(
WITNESS_RANK_OMIT
)
	}

	)
}

21 
	#MALLOC_MUTEX_TYPE
 
PTHREAD_MUTEX_DEFAULT


	)

22 
	#MALLOC_MUTEX_INITIALIZER
 \

23 {
PTHREAD_MUTEX_INITIALIZER
, 
	`WITNESS_INITIALIZER
(
WITNESS_RANK_OMIT
)}

	)

29 #ifdeà
JEMALLOC_H_STRUCTS


31 
	sm®loc_mu‹x_s
 {

32 #ifdeà
_WIN32


33 #ià
_WIN32_WINNT
 >= 0x0600

34 
SRWLOCK
 
	mlock
;

36 
CRITICAL_SECTION
 
	mlock
;

38 #–ià(
defšed
(
JEMALLOC_OSSPIN
))

39 
OSSpšLock
 
	mlock
;

40 #–ià(
defšed
(
JEMALLOC_MUTEX_INIT_CB
))

41 
±h»ad_mu‹x_t
 
	mlock
;

42 
m®loc_mu‹x_t
 *
	mpo¡pÚed_Ãxt
;

44 
±h»ad_mu‹x_t
 
	mlock
;

46 
w™Ãss_t
 
	mw™Ãss
;

51 #ifdeà
JEMALLOC_H_EXTERNS


53 #ifdeà
JEMALLOC_LAZY_LOCK


54 
boŞ
 
i¡h»aded
;

56 #undeà
i¡h»aded


57 
	#i¡h»aded
 
Œue


	)

60 
boŞ
 
m®loc_mu‹x_š™
(
m®loc_mu‹x_t
 *
mu‹x
, cÚ¡ *
Çme
,

61 
w™Ãss_¿nk_t
 
¿nk
);

62 
m®loc_mu‹x_´efÜk
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
);

63 
m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
);

64 
m®loc_mu‹x_po¡fÜk_chd
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
);

65 
boŞ
 
m®loc_mu‹x_boÙ
();

69 #ifdeà
JEMALLOC_H_INLINES


71 #iâdeà
JEMALLOC_ENABLE_INLINE


72 
m®loc_mu‹x_lock
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
);

73 
m®loc_mu‹x_uÆock
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
);

74 
m®loc_mu‹x_as£¹_owÃr
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
);

75 
m®loc_mu‹x_as£¹_nÙ_owÃr
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
);

78 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_MUTEX_C_
))

79 
JEMALLOC_INLINE
 

80 
	$m®loc_mu‹x_lock
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
)

83 ià(
i¡h»aded
) {

84 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn
, &
mu‹x
->
w™Ãss
);

85 #ifdeà
_WIN32


86 #ià
_WIN32_WINNT
 >= 0x0600

87 
	`AcquœeSRWLockExşusive
(&
mu‹x
->
lock
);

89 
	`EÁ”Cr™iÿlSeùiÚ
(&
mu‹x
->
lock
);

91 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

92 
	`OSSpšLockLock
(&
mu‹x
->
lock
);

94 
	`±h»ad_mu‹x_lock
(&
mu‹x
->
lock
);

96 
	`w™Ãss_lock
(
tsdn
, &
mu‹x
->
w™Ãss
);

98 
	}
}

100 
JEMALLOC_INLINE
 

101 
	$m®loc_mu‹x_uÆock
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
)

104 ià(
i¡h»aded
) {

105 
	`w™Ãss_uÆock
(
tsdn
, &
mu‹x
->
w™Ãss
);

106 #ifdeà
_WIN32


107 #ià
_WIN32_WINNT
 >= 0x0600

108 
	`R–—£SRWLockExşusive
(&
mu‹x
->
lock
);

110 
	`L—veCr™iÿlSeùiÚ
(&
mu‹x
->
lock
);

112 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

113 
	`OSSpšLockUÆock
(&
mu‹x
->
lock
);

115 
	`±h»ad_mu‹x_uÆock
(&
mu‹x
->
lock
);

118 
	}
}

120 
JEMALLOC_INLINE
 

121 
	$m®loc_mu‹x_as£¹_owÃr
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
)

124 ià(
i¡h»aded
)

125 
	`w™Ãss_as£¹_owÃr
(
tsdn
, &
mu‹x
->
w™Ãss
);

126 
	}
}

128 
JEMALLOC_INLINE
 

129 
	$m®loc_mu‹x_as£¹_nÙ_owÃr
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
)

132 ià(
i¡h»aded
)

133 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn
, &
mu‹x
->
w™Ãss
);

134 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/nstime.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
	#JEMALLOC_CLOCK_GETTIME
 
	`defšed
(
_POSIX_MONOTONIC_CLOCK
) \

5 && 
_POSIX_MONOTONIC_CLOCK
 >ğ0

	)

7 
n¡ime_s
 
	tn¡ime_t
;

10 
	#NSTIME_SEC_MAX
 
	`KQU
(18446744072)

	)

14 #ifdeà
JEMALLOC_H_STRUCTS


16 
	sn¡ime_s
 {

17 
ušt64_t
 
	mns
;

22 #ifdeà
JEMALLOC_H_EXTERNS


24 
n¡ime_š™
(
n¡ime_t
 *
time
, 
ušt64_t
 
ns
);

25 
n¡ime_š™2
(
n¡ime_t
 *
time
, 
ušt64_t
 
£c
, ušt64_ˆ
n£c
);

26 
ušt64_t
 
n¡ime_ns
(cÚ¡ 
n¡ime_t
 *
time
);

27 
ušt64_t
 
n¡ime_£c
(cÚ¡ 
n¡ime_t
 *
time
);

28 
ušt64_t
 
n¡ime_n£c
(cÚ¡ 
n¡ime_t
 *
time
);

29 
n¡ime_cİy
(
n¡ime_t
 *
time
, cÚ¡‚¡ime_ˆ*
sourû
);

30 
n¡ime_com·»
(cÚ¡ 
n¡ime_t
 *
a
, cÚ¡‚¡ime_ˆ*
b
);

31 
n¡ime_add
(
n¡ime_t
 *
time
, cÚ¡‚¡ime_ˆ*
add’d
);

32 
n¡ime_subŒaù
(
n¡ime_t
 *
time
, cÚ¡‚¡ime_ˆ*
subŒah’d
);

33 
n¡ime_imuÉly
(
n¡ime_t
 *
time
, 
ušt64_t
 
muÉl›r
);

34 
n¡ime_idivide
(
n¡ime_t
 *
time
, 
ušt64_t
 
divisÜ
);

35 
ušt64_t
 
n¡ime_divide
(cÚ¡ 
n¡ime_t
 *
time
, cÚ¡‚¡ime_ˆ*
divisÜ
);

36 #ifdeà
JEMALLOC_JET


37 
	$boŞ
 (
	tn¡ime_upd©e_t
)(
	tn¡ime_t
 *);

38 
n¡ime_upd©e_t
 *
n¡ime_upd©e
;

40 
boŞ
 
	`n¡ime_upd©e
(
n¡ime_t
 *
time
);

45 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/pages.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 *
·ges_m­
(*
addr
, 
size_t
 
size
, 
boŞ
 *
comm™
);

13 
·ges_unm­
(*
addr
, 
size_t
 
size
);

14 *
·ges_Œim
(*
addr
, 
size_t
 
®loc_size
, size_ˆ
Ëadsize
,

15 
size_t
 
size
, 
boŞ
 *
comm™
);

16 
boŞ
 
·ges_comm™
(*
addr
, 
size_t
 
size
);

17 
boŞ
 
·ges_decomm™
(*
addr
, 
size_t
 
size
);

18 
boŞ
 
·ges_purge
(*
addr
, 
size_t
 
size
);

19 
·ges_boÙ
();

23 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/ph.h

15 #iâdeà
PH_H_


16 
	#PH_H_


	)

19 
	#phn
(
a_ty³
) \

21 
a_ty³
 *
phn_´ev
; \

22 
a_ty³
 *
phn_Ãxt
; \

23 
a_ty³
 *
phn_lchd
; \

24 }

	)

27 
	#ph
(
a_ty³
) \

29 
a_ty³
 *
ph_roÙ
; \

30 }

	)

33 
	#phn_lchd_g‘
(
a_ty³
, 
a_f›ld
, 
a_phn
) \

34 (
a_phn
->
a_f›ld
.
phn_lchd
)

	)

35 
	#phn_lchd_£t
(
a_ty³
, 
a_f›ld
, 
a_phn
, 
a_lchd
) do { \

36 
a_phn
->
a_f›ld
.
phn_lchd
 = 
a_lchd
; \

37 } 0)

	)

39 
	#phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
a_phn
) \

40 (
a_phn
->
a_f›ld
.
phn_Ãxt
)

	)

41 
	#phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
a_phn
, 
a_´ev
) do { \

42 
a_phn
->
a_f›ld
.
phn_´ev
 = 
a_´ev
; \

43 } 0)

	)

45 
	#phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, 
a_phn
) \

46 (
a_phn
->
a_f›ld
.
phn_´ev
)

	)

47 
	#phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
a_phn
, 
a_Ãxt
) do { \

48 
a_phn
->
a_f›ld
.
phn_Ãxt
 = 
a_Ãxt
; \

49 } 0)

	)

51 
	#phn_m”ge_Üd”ed
(
a_ty³
, 
a_f›ld
, 
a_phn0
, 
a_phn1
, 
a_cmp
) do { \

52 
a_ty³
 *
phn0chd
; \

54 
	`as£¹
(
a_phn0
 !ğ
NULL
); \

55 
	`as£¹
(
a_phn1
 !ğ
NULL
); \

56 
	`as£¹
(
	`a_cmp
(
a_phn0
, 
a_phn1
) <= 0); \

58 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
a_phn1
, 
a_phn0
); \

59 
phn0chd
 = 
	`phn_lchd_g‘
(
a_ty³
, 
a_f›ld
, 
a_phn0
); \

60 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
a_phn1
, 
phn0chd
); \

61 ià(
phn0chd
 !ğ
NULL
) \

62 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
phn0chd
, 
a_phn1
); \

63 
	`phn_lchd_£t
(
a_ty³
, 
a_f›ld
, 
a_phn0
, 
a_phn1
); \

64 } 0)

	)

66 
	#phn_m”ge
(
a_ty³
, 
a_f›ld
, 
a_phn0
, 
a_phn1
, 
a_cmp
, 
r_phn
) do { \

67 ià(
a_phn0
 =ğ
NULL
) \

68 
r_phn
 = 
a_phn1
; \

69 ià(
a_phn1
 =ğ
NULL
) \

70 
r_phn
 = 
a_phn0
; \

71 ià(
	`a_cmp
(
a_phn0
, 
a_phn1
) < 0) { \

72 
	`phn_m”ge_Üd”ed
(
a_ty³
, 
a_f›ld
, 
a_phn0
, 
a_phn1
, \

73 
a_cmp
); \

74 
r_phn
 = 
a_phn0
; \

76 
	`phn_m”ge_Üd”ed
(
a_ty³
, 
a_f›ld
, 
a_phn1
, 
a_phn0
, \

77 
a_cmp
); \

78 
r_phn
 = 
a_phn1
; \

80 } 0)

	)

82 
	#ph_m”ge_siblšgs
(
a_ty³
, 
a_f›ld
, 
a_phn
, 
a_cmp
, 
r_phn
) do { \

83 
a_ty³
 *
h—d
 = 
NULL
; \

84 
a_ty³
 *

 = 
NULL
; \

85 
a_ty³
 *
phn0
 = 
a_phn
; \

86 
a_ty³
 *
phn1
 = 
	`phn_Ãxt_g‘
×_ty³, 
a_f›ld
, 
phn0
); \

96 ià(
phn1
 !ğ
NULL
) { \

97 
a_ty³
 *
phÄe¡
 = 
	`phn_Ãxt_g‘
×_ty³, 
a_f›ld
, 
phn1
); \

98 ià(
phÄe¡
 !ğ
NULL
) \

99 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
phÄe¡
, 
NULL
); \

100 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
phn0
, 
NULL
); \

101 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
phn0
, 
NULL
); \

102 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
phn1
, 
NULL
); \

103 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
phn1
, 
NULL
); \

104 
	`phn_m”ge
(
a_ty³
, 
a_f›ld
, 
phn0
, 
phn1
, 
a_cmp
,…hn0); \

105 
h—d
 = 

 = 
phn0
; \

106 
phn0
 = 
phÄe¡
; \

107 
phn0
 !ğ
NULL
) { \

108 
phn1
 = 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
phn0
); \

109 ià(
phn1
 !ğ
NULL
) { \

110 
phÄe¡
 = 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, \

111 
phn1
); \

112 ià(
phÄe¡
 !ğ
NULL
) { \

113 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, \

114 
phÄe¡
, 
NULL
); \

116 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
phn0
, \

117 
NULL
); \

118 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
phn0
, \

119 
NULL
); \

120 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
phn1
, \

121 
NULL
); \

122 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
phn1
, \

123 
NULL
); \

124 
	`phn_m”ge
(
a_ty³
, 
a_f›ld
, 
phn0
, 
phn1
, \

125 
a_cmp
, 
phn0
); \

126 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 

, \

127 
phn0
); \

128 

 = 
phn0
; \

129 
phn0
 = 
phÄe¡
; \

131 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 

, \

132 
phn0
); \

133 

 = 
phn0
; \

134 
phn0
 = 
NULL
; \

137 
phn0
 = 
h—d
; \

138 
phn1
 = 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
phn0
); \

139 ià(
phn1
 !ğ
NULL
) { \

140 
Œue
) { \

141 
h—d
 = 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, \

142 
phn1
); \

143 
	`as£¹
(
	`phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, \

144 
phn0
è=ğ
NULL
); \

145 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
phn0
, \

146 
NULL
); \

147 
	`as£¹
(
	`phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, \

148 
phn1
è=ğ
NULL
); \

149 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
phn1
, \

150 
NULL
); \

151 
	`phn_m”ge
(
a_ty³
, 
a_f›ld
, 
phn0
, 
phn1
, \

152 
a_cmp
, 
phn0
); \

153 ià(
h—d
 =ğ
NULL
) \

155 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 

, \

156 
phn0
); \

157 

 = 
phn0
; \

158 
phn0
 = 
h—d
; \

159 
phn1
 = 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, \

160 
phn0
); \

164 
r_phn
 = 
phn0
; \

165 } 0)

	)

167 
	#ph_m”ge_aux
(
a_ty³
, 
a_f›ld
, 
a_ph
, 
a_cmp
) do { \

168 
a_ty³
 *
phn
 = 
	`phn_Ãxt_g‘
×_ty³, 
a_f›ld
, 
a_ph
->
ph_roÙ
); \

169 ià(
phn
 !ğ
NULL
) { \

170 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
a_ph
->
ph_roÙ
, 
NULL
); \

171 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
a_ph
->
ph_roÙ
, 
NULL
); \

172 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
phn
, 
NULL
); \

173 
	`ph_m”ge_siblšgs
(
a_ty³
, 
a_f›ld
, 
phn
, 
a_cmp
,…hn); \

174 
	`as£¹
(
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
phn
è=ğ
NULL
); \

175 
	`phn_m”ge
(
a_ty³
, 
a_f›ld
, 
a_ph
->
ph_roÙ
, 
phn
, 
a_cmp
, \

176 
a_ph
->
ph_roÙ
); \

178 } 0)

	)

180 
	#ph_m”ge_chd»n
(
a_ty³
, 
a_f›ld
, 
a_phn
, 
a_cmp
, 
r_phn
) do { \

181 
a_ty³
 *
lchd
 = 
	`phn_lchd_g‘
×_ty³, 
a_f›ld
, 
a_phn
); \

182 ià(
lchd
 =ğ
NULL
) \

183 
r_phn
 = 
NULL
; \

185 
	`ph_m”ge_siblšgs
(
a_ty³
, 
a_f›ld
, 
lchd
, 
a_cmp
, \

186 
r_phn
); \

188 } 0)

	)

194 
	#ph_´Ùo
(
a_©Œ
, 
a_´efix
, 
a_ph_ty³
, 
a_ty³
) \

195 
a_©Œ
 
a_´efix
##
	`Ãw
(
a_ph_ty³
 *
ph
); \

196 
a_©Œ
 
boŞ
 
a_´efix
##
	`em±y
(
a_ph_ty³
 *
ph
); \

197 
a_©Œ
 
a_ty³
 *
a_´efix
##
	`fœ¡
(
a_ph_ty³
 *
ph
); \

198 
a_©Œ
 
a_´efix
##
	`š£¹
(
a_ph_ty³
 *
ph
, 
a_ty³
 *
phn
); \

199 
a_©Œ
 
a_ty³
 *
a_´efix
##
	`»move_fœ¡
(
a_ph_ty³
 *
ph
); \

200 
a_©Œ
 
a_´efix
##
	`»move
(
a_ph_ty³
 *
ph
, 
a_ty³
 *
phn
);

	)

206 
	#ph_g’
(
a_©Œ
, 
a_´efix
, 
a_ph_ty³
, 
a_ty³
, 
a_f›ld
, 
a_cmp
) \

207 
a_©Œ
 \

208 
a_´efix
##
	`Ãw
(
a_ph_ty³
 *
ph
) \

211 
	`mem£t
(
ph
, 0, (
	`ph
(
a_ty³
))); \

213 
a_©Œ
 
boŞ
 \

214 
a_´efix
##
	`em±y
(
a_ph_ty³
 *
ph
) \

217  (
ph
->
ph_roÙ
 =ğ
NULL
); \

219 
a_©Œ
 
a_ty³
 * \

220 
a_´efix
##
	`fœ¡
(
a_ph_ty³
 *
ph
) \

223 ià(
ph
->
ph_roÙ
 =ğ
NULL
) \

224  (
NULL
); \

225 
	`ph_m”ge_aux
(
a_ty³
, 
a_f›ld
, 
ph
, 
a_cmp
); \

226  (
ph
->
ph_roÙ
); \

228 
a_©Œ
 \

229 
a_´efix
##
	`š£¹
(
a_ph_ty³
 *
ph
, 
a_ty³
 *
phn
) \

232 
	`mem£t
(&
phn
->
a_f›ld
, 0, (
	`phn
(
a_ty³
))); \

242 ià(
ph
->
ph_roÙ
 =ğ
NULL
) \

243 
ph
->
ph_roÙ
 = 
phn
; \

245 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
phn
, 
	`phn_Ãxt_g‘
(a_type, \

246 
a_f›ld
, 
ph
->
ph_roÙ
)); \

247 ià(
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
ph
->
ph_roÙ
) != \

248 
NULL
) { \

249 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, \

250 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
ph
->
ph_roÙ
), \

251 
phn
); \

253 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
phn
, 
ph
->
ph_roÙ
); \

254 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
ph
->
ph_roÙ
, 
phn
); \

257 
a_©Œ
 
a_ty³
 * \

258 
a_´efix
##
	`»move_fœ¡
(
a_ph_ty³
 *
ph
) \

260 
a_ty³
 *
»t
; \

262 ià(
ph
->
ph_roÙ
 =ğ
NULL
) \

263  (
NULL
); \

264 
	`ph_m”ge_aux
(
a_ty³
, 
a_f›ld
, 
ph
, 
a_cmp
); \

266 
»t
 = 
ph
->
ph_roÙ
; \

268 
	`ph_m”ge_chd»n
(
a_ty³
, 
a_f›ld
, 
ph
->
ph_roÙ
, 
a_cmp
, \

269 
ph
->
ph_roÙ
); \

271  (
»t
); \

273 
a_©Œ
 \

274 
a_´efix
##
	`»move
(
a_ph_ty³
 *
ph
, 
a_ty³
 *
phn
) \

276 
a_ty³
 *
»¶aû
, *
·»Á
; \

282 ià(
ph
->
ph_roÙ
 =ğ
phn
) { \

283 
	`ph_m”ge_aux
(
a_ty³
, 
a_f›ld
, 
ph
, 
a_cmp
); \

284 ià(
ph
->
ph_roÙ
 =ğ
phn
) { \

285 
	`ph_m”ge_chd»n
(
a_ty³
, 
a_f›ld
, 
ph
->
ph_roÙ
, \

286 
a_cmp
, 
ph
->
ph_roÙ
); \

292 ià((
·»Á
 = 
	`phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, 
phn
)è!ğ
NULL
) { \

293 ià(
	`phn_lchd_g‘
(
a_ty³
, 
a_f›ld
, 
·»Á
è!ğ
phn
) \

294 
·»Á
 = 
NULL
; \

297 
	`ph_m”ge_chd»n
(
a_ty³
, 
a_f›ld
, 
phn
, 
a_cmp
, 
»¶aû
); \

299 ià(
»¶aû
 !ğ
NULL
) { \

300 ià(
·»Á
 !ğ
NULL
) { \

301 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
»¶aû
, 
·»Á
); \

302 
	`phn_lchd_£t
(
a_ty³
, 
a_f›ld
, 
·»Á
, \

303 
»¶aû
); \

305 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
»¶aû
, \

306 
	`phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, 
phn
)); \

307 ià(
	`phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, 
phn
) != \

308 
NULL
) { \

309 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, \

310 
	`phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, 
phn
), \

311 
»¶aû
); \

314 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, 
»¶aû
, \

315 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
phn
)); \

316 ià(
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
phn
è!ğ
NULL
) { \

317 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, \

318 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
phn
), \

319 
»¶aû
); \

322 ià(
·»Á
 !ğ
NULL
) { \

323 
a_ty³
 *
Ãxt
 = 
	`phn_Ãxt_g‘
×_ty³, 
a_f›ld
, \

324 
phn
); \

325 
	`phn_lchd_£t
(
a_ty³
, 
a_f›ld
, 
·»Á
, 
Ãxt
); \

326 ià(
Ãxt
 !ğ
NULL
) { \

327 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, 
Ãxt
, \

328 
·»Á
); \

331 
	`as£¹
(
	`phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, 
phn
) != \

332 
NULL
); \

333 
	`phn_Ãxt_£t
(
a_ty³
, 
a_f›ld
, \

334 
	`phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, 
phn
), \

335 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
phn
)); \

337 ià(
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
phn
è!ğ
NULL
) { \

338 
	`phn_´ev_£t
(
a_ty³
, 
a_f›ld
, \

339 
	`phn_Ãxt_g‘
(
a_ty³
, 
a_f›ld
, 
phn
), \

340 
	`phn_´ev_g‘
(
a_ty³
, 
a_f›ld
, 
phn
)); \

343 }

	)

	@dep/jemalloc-4.2.0/include/jemalloc/internal/private_namespace.h

1 
	#a0d®loc
 
	`JEMALLOC_N
(
a0d®loc
)

	)

2 
	#a0m®loc
 
	`JEMALLOC_N
(
a0m®loc
)

	)

3 
	#¬’a_¯Îoc
 
	`JEMALLOC_N
(
¬’a_¯Îoc
)

	)

4 
	#¬’a_®loc_junk_sm®l
 
	`JEMALLOC_N
(
¬’a_®loc_junk_sm®l
)

	)

5 
	#¬’a_basic_¡©s_m”ge
 
	`JEMALLOC_N
(
¬’a_basic_¡©s_m”ge
)

	)

6 
	#¬’a_bš_šdex
 
	`JEMALLOC_N
(
¬’a_bš_šdex
)

	)

7 
	#¬’a_bš_šfo
 
	`JEMALLOC_N
(
¬’a_bš_šfo
)

	)

8 
	#¬’a_b™£lm_g‘_cÚ¡
 
	`JEMALLOC_N
(
¬’a_b™£lm_g‘_cÚ¡
)

	)

9 
	#¬’a_b™£lm_g‘_mubË
 
	`JEMALLOC_N
(
¬’a_b™£lm_g‘_mubË
)

	)

10 
	#¬’a_boÙ
 
	`JEMALLOC_N
(
¬’a_boÙ
)

	)

11 
	#¬’a_choo£
 
	`JEMALLOC_N
(
¬’a_choo£
)

	)

12 
	#¬’a_choo£_h¬d
 
	`JEMALLOC_N
(
¬’a_choo£_h¬d
)

	)

13 
	#¬’a_choo£_im¶
 
	`JEMALLOC_N
(
¬’a_choo£_im¶
)

	)

14 
	#¬’a_chunk_®loc_huge
 
	`JEMALLOC_N
(
¬’a_chunk_®loc_huge
)

	)

15 
	#¬’a_chunk_ÿche_maybe_š£¹
 
	`JEMALLOC_N
(
¬’a_chunk_ÿche_maybe_š£¹
)

	)

16 
	#¬’a_chunk_ÿche_maybe_»move
 
	`JEMALLOC_N
(
¬’a_chunk_ÿche_maybe_»move
)

	)

17 
	#¬’a_chunk_d®loc_huge
 
	`JEMALLOC_N
(
¬’a_chunk_d®loc_huge
)

	)

18 
	#¬’a_chunk_¿Îoc_huge_ex·nd
 
	`JEMALLOC_N
(
¬’a_chunk_¿Îoc_huge_ex·nd
)

	)

19 
	#¬’a_chunk_¿Îoc_huge_shršk
 
	`JEMALLOC_N
(
¬’a_chunk_¿Îoc_huge_shršk
)

	)

20 
	#¬’a_chunk_¿Îoc_huge_sim¬
 
	`JEMALLOC_N
(
¬’a_chunk_¿Îoc_huge_sim¬
)

	)

21 
	#¬’a_ş—nup
 
	`JEMALLOC_N
(
¬’a_ş—nup
)

	)

22 
	#¬’a_d®loc
 
	`JEMALLOC_N
(
¬’a_d®loc
)

	)

23 
	#¬’a_d®loc_bš
 
	`JEMALLOC_N
(
¬’a_d®loc_bš
)

	)

24 
	#¬’a_d®loc_bš_junked_locked
 
	`JEMALLOC_N
(
¬’a_d®loc_bš_junked_locked
)

	)

25 
	#¬’a_d®loc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_Ïrge
)

	)

26 
	#¬’a_d®loc_junk_sm®l
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_sm®l
)

	)

27 
	#¬’a_d®loc_Ïrge
 
	`JEMALLOC_N
(
¬’a_d®loc_Ïrge
)

	)

28 
	#¬’a_d®loc_Ïrge_junked_locked
 
	`JEMALLOC_N
(
¬’a_d®loc_Ïrge_junked_locked
)

	)

29 
	#¬’a_d®loc_sm®l
 
	`JEMALLOC_N
(
¬’a_d®loc_sm®l
)

	)

30 
	#¬’a_deÿy_tick
 
	`JEMALLOC_N
(
¬’a_deÿy_tick
)

	)

31 
	#¬’a_deÿy_ticks
 
	`JEMALLOC_N
(
¬’a_deÿy_ticks
)

	)

32 
	#¬’a_deÿy_time_deçuÉ_g‘
 
	`JEMALLOC_N
(
¬’a_deÿy_time_deçuÉ_g‘
)

	)

33 
	#¬’a_deÿy_time_deçuÉ_£t
 
	`JEMALLOC_N
(
¬’a_deÿy_time_deçuÉ_£t
)

	)

34 
	#¬’a_deÿy_time_g‘
 
	`JEMALLOC_N
(
¬’a_deÿy_time_g‘
)

	)

35 
	#¬’a_deÿy_time_£t
 
	`JEMALLOC_N
(
¬’a_deÿy_time_£t
)

	)

36 
	#¬’a_dss_´ec_g‘
 
	`JEMALLOC_N
(
¬’a_dss_´ec_g‘
)

	)

37 
	#¬’a_dss_´ec_£t
 
	`JEMALLOC_N
(
¬’a_dss_´ec_£t
)

	)

38 
	#¬’a_g‘
 
	`JEMALLOC_N
(
¬’a_g‘
)

	)

39 
	#¬’a_ichoo£
 
	`JEMALLOC_N
(
¬’a_ichoo£
)

	)

40 
	#¬’a_š™
 
	`JEMALLOC_N
(
¬’a_š™
)

	)

41 
	#¬’a_lg_dœty_muÉ_deçuÉ_g‘
 
	`JEMALLOC_N
(
¬’a_lg_dœty_muÉ_deçuÉ_g‘
)

	)

42 
	#¬’a_lg_dœty_muÉ_deçuÉ_£t
 
	`JEMALLOC_N
(
¬’a_lg_dœty_muÉ_deçuÉ_£t
)

	)

43 
	#¬’a_lg_dœty_muÉ_g‘
 
	`JEMALLOC_N
(
¬’a_lg_dœty_muÉ_g‘
)

	)

44 
	#¬’a_lg_dœty_muÉ_£t
 
	`JEMALLOC_N
(
¬’a_lg_dœty_muÉ_£t
)

	)

45 
	#¬’a_m®loc
 
	`JEMALLOC_N
(
¬’a_m®loc
)

	)

46 
	#¬’a_m®loc_h¬d
 
	`JEMALLOC_N
(
¬’a_m®loc_h¬d
)

	)

47 
	#¬’a_m®loc_Ïrge
 
	`JEMALLOC_N
(
¬’a_m®loc_Ïrge
)

	)

48 
	#¬’a_m­b™s_®loÿ‹d_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_®loÿ‹d_g‘
)

	)

49 
	#¬’a_m­b™s_bššd_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_bššd_g‘
)

	)

50 
	#¬’a_m­b™s_decomm™‹d_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_decomm™‹d_g‘
)

	)

51 
	#¬’a_m­b™s_dœty_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_dœty_g‘
)

	)

52 
	#¬’a_m­b™s_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_g‘
)

	)

53 
	#¬’a_m­b™s_š‹º®_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_š‹º®_£t
)

	)

54 
	#¬’a_m­b™s_Ïrge_bššd_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_Ïrge_bššd_£t
)

	)

55 
	#¬’a_m­b™s_Ïrge_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_Ïrge_g‘
)

	)

56 
	#¬’a_m­b™s_Ïrge_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_Ïrge_£t
)

	)

57 
	#¬’a_m­b™s_Ïrge_size_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_Ïrge_size_g‘
)

	)

58 
	#¬’a_m­b™s_size_decode
 
	`JEMALLOC_N
(
¬’a_m­b™s_size_decode
)

	)

59 
	#¬’a_m­b™s_size_’code
 
	`JEMALLOC_N
(
¬’a_m­b™s_size_’code
)

	)

60 
	#¬’a_m­b™s_sm®l_runšd_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_sm®l_runšd_g‘
)

	)

61 
	#¬’a_m­b™s_sm®l_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_sm®l_£t
)

	)

62 
	#¬’a_m­b™s_uÇÎoÿ‹d_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_uÇÎoÿ‹d_£t
)

	)

63 
	#¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
)

	)

64 
	#¬’a_m­b™s_uÇÎoÿ‹d_size_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_uÇÎoÿ‹d_size_£t
)

	)

65 
	#¬’a_m­b™s_unz”Ûd_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_unz”Ûd_g‘
)

	)

66 
	#¬’a_m­b™¥_g‘_cÚ¡
 
	`JEMALLOC_N
(
¬’a_m­b™¥_g‘_cÚ¡
)

	)

67 
	#¬’a_m­b™¥_g‘_mubË
 
	`JEMALLOC_N
(
¬’a_m­b™¥_g‘_mubË
)

	)

68 
	#¬’a_m­b™¥_»ad
 
	`JEMALLOC_N
(
¬’a_m­b™¥_»ad
)

	)

69 
	#¬’a_m­b™¥_wr™e
 
	`JEMALLOC_N
(
¬’a_m­b™¥_wr™e
)

	)

70 
	#¬’a_maxrun
 
	`JEMALLOC_N
(
¬’a_maxrun
)

	)

71 
	#¬’a_maybe_purge
 
	`JEMALLOC_N
(
¬’a_maybe_purge
)

	)

72 
	#¬’a_m‘ad©a_®loÿ‹d_add
 
	`JEMALLOC_N
(
¬’a_m‘ad©a_®loÿ‹d_add
)

	)

73 
	#¬’a_m‘ad©a_®loÿ‹d_g‘
 
	`JEMALLOC_N
(
¬’a_m‘ad©a_®loÿ‹d_g‘
)

	)

74 
	#¬’a_m‘ad©a_®loÿ‹d_sub
 
	`JEMALLOC_N
(
¬’a_m‘ad©a_®loÿ‹d_sub
)

	)

75 
	#¬’a_mig¿‹
 
	`JEMALLOC_N
(
¬’a_mig¿‹
)

	)

76 
	#¬’a_misûlm_g‘_cÚ¡
 
	`JEMALLOC_N
(
¬’a_misûlm_g‘_cÚ¡
)

	)

77 
	#¬’a_misûlm_g‘_mubË
 
	`JEMALLOC_N
(
¬’a_misûlm_g‘_mubË
)

	)

78 
	#¬’a_misûlm_to_·gešd
 
	`JEMALLOC_N
(
¬’a_misûlm_to_·gešd
)

	)

79 
	#¬’a_misûlm_to_½ages
 
	`JEMALLOC_N
(
¬’a_misûlm_to_½ages
)

	)

80 
	#¬’a_Ãw
 
	`JEMALLOC_N
(
¬’a_Ãw
)

	)

81 
	#¬’a_node_®loc
 
	`JEMALLOC_N
(
¬’a_node_®loc
)

	)

82 
	#¬’a_node_d®loc
 
	`JEMALLOC_N
(
¬’a_node_d®loc
)

	)

83 
	#¬’a_Áh»ads_dec
 
	`JEMALLOC_N
(
¬’a_Áh»ads_dec
)

	)

84 
	#¬’a_Áh»ads_g‘
 
	`JEMALLOC_N
(
¬’a_Áh»ads_g‘
)

	)

85 
	#¬’a_Áh»ads_šc
 
	`JEMALLOC_N
(
¬’a_Áh»ads_šc
)

	)

86 
	#¬’a_·Îoc
 
	`JEMALLOC_N
(
¬’a_·Îoc
)

	)

87 
	#¬’a_po¡fÜk_chd
 
	`JEMALLOC_N
(
¬’a_po¡fÜk_chd
)

	)

88 
	#¬’a_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
¬’a_po¡fÜk_·»Á
)

	)

89 
	#¬’a_´efÜk0
 
	`JEMALLOC_N
(
¬’a_´efÜk0
)

	)

90 
	#¬’a_´efÜk1
 
	`JEMALLOC_N
(
¬’a_´efÜk1
)

	)

91 
	#¬’a_´efÜk2
 
	`JEMALLOC_N
(
¬’a_´efÜk2
)

	)

92 
	#¬’a_´efÜk3
 
	`JEMALLOC_N
(
¬’a_´efÜk3
)

	)

93 
	#¬’a_´of_accum
 
	`JEMALLOC_N
(
¬’a_´of_accum
)

	)

94 
	#¬’a_´of_accum_im¶
 
	`JEMALLOC_N
(
¬’a_´of_accum_im¶
)

	)

95 
	#¬’a_´of_accum_locked
 
	`JEMALLOC_N
(
¬’a_´of_accum_locked
)

	)

96 
	#¬’a_´of_´omÙed
 
	`JEMALLOC_N
(
¬’a_´of_´omÙed
)

	)

97 
	#¬’a_´of_tùx_g‘
 
	`JEMALLOC_N
(
¬’a_´of_tùx_g‘
)

	)

98 
	#¬’a_´of_tùx_»£t
 
	`JEMALLOC_N
(
¬’a_´of_tùx_»£t
)

	)

99 
	#¬’a_´of_tùx_£t
 
	`JEMALLOC_N
(
¬’a_´of_tùx_£t
)

	)

100 
	#¬’a_±r_sm®l_bššd_g‘
 
	`JEMALLOC_N
(
¬’a_±r_sm®l_bššd_g‘
)

	)

101 
	#¬’a_purge
 
	`JEMALLOC_N
(
¬’a_purge
)

	)

102 
	#¬’a_qu¬ªtše_junk_sm®l
 
	`JEMALLOC_N
(
¬’a_qu¬ªtše_junk_sm®l
)

	)

103 
	#¬’a_¿Îoc
 
	`JEMALLOC_N
(
¬’a_¿Îoc
)

	)

104 
	#¬’a_¿Îoc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_¿Îoc_junk_Ïrge
)

	)

105 
	#¬’a_¿Îoc_no_move
 
	`JEMALLOC_N
(
¬’a_¿Îoc_no_move
)

	)

106 
	#¬’a_rd_to_misûlm
 
	`JEMALLOC_N
(
¬’a_rd_to_misûlm
)

	)

107 
	#¬’a_»dzÚe_cÜru±iÚ
 
	`JEMALLOC_N
(
¬’a_»dzÚe_cÜru±iÚ
)

	)

108 
	#¬’a_»£t
 
	`JEMALLOC_N
(
¬’a_»£t
)

	)

109 
	#¬’a_run_»gšd
 
	`JEMALLOC_N
(
¬’a_run_»gšd
)

	)

110 
	#¬’a_run_to_misûlm
 
	`JEMALLOC_N
(
¬’a_run_to_misûlm
)

	)

111 
	#¬’a_§Îoc
 
	`JEMALLOC_N
(
¬’a_§Îoc
)

	)

112 
	#¬’a_sd®loc
 
	`JEMALLOC_N
(
¬’a_sd®loc
)

	)

113 
	#¬’a_¡©s_m”ge
 
	`JEMALLOC_N
(
¬’a_¡©s_m”ge
)

	)

114 
	#¬’a_tÿche_fl_sm®l
 
	`JEMALLOC_N
(
¬’a_tÿche_fl_sm®l
)

	)

115 
	#¬’a_td©a_g‘
 
	`JEMALLOC_N
(
¬’a_td©a_g‘
)

	)

116 
	#¬’a_td©a_g‘_h¬d
 
	`JEMALLOC_N
(
¬’a_td©a_g‘_h¬d
)

	)

117 
	#¬’as
 
	`JEMALLOC_N
(
¬’as
)

	)

118 
	#¬’as_td©a_by·ss_ş—nup
 
	`JEMALLOC_N
(
¬’as_td©a_by·ss_ş—nup
)

	)

119 
	#¬’as_td©a_ş—nup
 
	`JEMALLOC_N
(
¬’as_td©a_ş—nup
)

	)

120 
	#©omic_add_p
 
	`JEMALLOC_N
(
©omic_add_p
)

	)

121 
	#©omic_add_u
 
	`JEMALLOC_N
(
©omic_add_u
)

	)

122 
	#©omic_add_ušt32
 
	`JEMALLOC_N
(
©omic_add_ušt32
)

	)

123 
	#©omic_add_ušt64
 
	`JEMALLOC_N
(
©omic_add_ušt64
)

	)

124 
	#©omic_add_z
 
	`JEMALLOC_N
(
©omic_add_z
)

	)

125 
	#©omic_ÿs_p
 
	`JEMALLOC_N
(
©omic_ÿs_p
)

	)

126 
	#©omic_ÿs_u
 
	`JEMALLOC_N
(
©omic_ÿs_u
)

	)

127 
	#©omic_ÿs_ušt32
 
	`JEMALLOC_N
(
©omic_ÿs_ušt32
)

	)

128 
	#©omic_ÿs_ušt64
 
	`JEMALLOC_N
(
©omic_ÿs_ušt64
)

	)

129 
	#©omic_ÿs_z
 
	`JEMALLOC_N
(
©omic_ÿs_z
)

	)

130 
	#©omic_sub_p
 
	`JEMALLOC_N
(
©omic_sub_p
)

	)

131 
	#©omic_sub_u
 
	`JEMALLOC_N
(
©omic_sub_u
)

	)

132 
	#©omic_sub_ušt32
 
	`JEMALLOC_N
(
©omic_sub_ušt32
)

	)

133 
	#©omic_sub_ušt64
 
	`JEMALLOC_N
(
©omic_sub_ušt64
)

	)

134 
	#©omic_sub_z
 
	`JEMALLOC_N
(
©omic_sub_z
)

	)

135 
	#©omic_wr™e_p
 
	`JEMALLOC_N
(
©omic_wr™e_p
)

	)

136 
	#©omic_wr™e_u
 
	`JEMALLOC_N
(
©omic_wr™e_u
)

	)

137 
	#©omic_wr™e_ušt32
 
	`JEMALLOC_N
(
©omic_wr™e_ušt32
)

	)

138 
	#©omic_wr™e_ušt64
 
	`JEMALLOC_N
(
©omic_wr™e_ušt64
)

	)

139 
	#©omic_wr™e_z
 
	`JEMALLOC_N
(
©omic_wr™e_z
)

	)

140 
	#ba£_®loc
 
	`JEMALLOC_N
(
ba£_®loc
)

	)

141 
	#ba£_boÙ
 
	`JEMALLOC_N
(
ba£_boÙ
)

	)

142 
	#ba£_po¡fÜk_chd
 
	`JEMALLOC_N
(
ba£_po¡fÜk_chd
)

	)

143 
	#ba£_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
ba£_po¡fÜk_·»Á
)

	)

144 
	#ba£_´efÜk
 
	`JEMALLOC_N
(
ba£_´efÜk
)

	)

145 
	#ba£_¡©s_g‘
 
	`JEMALLOC_N
(
ba£_¡©s_g‘
)

	)

146 
	#b™m­_fuÎ
 
	`JEMALLOC_N
(
b™m­_fuÎ
)

	)

147 
	#b™m­_g‘
 
	`JEMALLOC_N
(
b™m­_g‘
)

	)

148 
	#b™m­_šfo_š™
 
	`JEMALLOC_N
(
b™m­_šfo_š™
)

	)

149 
	#b™m­_š™
 
	`JEMALLOC_N
(
b™m­_š™
)

	)

150 
	#b™m­_£t
 
	`JEMALLOC_N
(
b™m­_£t
)

	)

151 
	#b™m­_sfu
 
	`JEMALLOC_N
(
b™m­_sfu
)

	)

152 
	#b™m­_size
 
	`JEMALLOC_N
(
b™m­_size
)

	)

153 
	#b™m­_un£t
 
	`JEMALLOC_N
(
b™m­_un£t
)

	)

154 
	#boÙ¡¿p_ÿÎoc
 
	`JEMALLOC_N
(
boÙ¡¿p_ÿÎoc
)

	)

155 
	#boÙ¡¿p_ä“
 
	`JEMALLOC_N
(
boÙ¡¿p_ä“
)

	)

156 
	#boÙ¡¿p_m®loc
 
	`JEMALLOC_N
(
boÙ¡¿p_m®loc
)

	)

157 
	#bt_š™
 
	`JEMALLOC_N
(
bt_š™
)

	)

158 
	#buã¼Ü
 
	`JEMALLOC_N
(
buã¼Ü
)

	)

159 
	#chunk_®loc_ba£
 
	`JEMALLOC_N
(
chunk_®loc_ba£
)

	)

160 
	#chunk_®loc_ÿche
 
	`JEMALLOC_N
(
chunk_®loc_ÿche
)

	)

161 
	#chunk_®loc_dss
 
	`JEMALLOC_N
(
chunk_®loc_dss
)

	)

162 
	#chunk_®loc_mm­
 
	`JEMALLOC_N
(
chunk_®loc_mm­
)

	)

163 
	#chunk_®loc_w¿µ”
 
	`JEMALLOC_N
(
chunk_®loc_w¿µ”
)

	)

164 
	#chunk_boÙ
 
	`JEMALLOC_N
(
chunk_boÙ
)

	)

165 
	#chunk_d®loc_ÿche
 
	`JEMALLOC_N
(
chunk_d®loc_ÿche
)

	)

166 
	#chunk_d®loc_mm­
 
	`JEMALLOC_N
(
chunk_d®loc_mm­
)

	)

167 
	#chunk_d®loc_w¿µ”
 
	`JEMALLOC_N
(
chunk_d®loc_w¿µ”
)

	)

168 
	#chunk_d”egi¡”
 
	`JEMALLOC_N
(
chunk_d”egi¡”
)

	)

169 
	#chunk_dss_boÙ
 
	`JEMALLOC_N
(
chunk_dss_boÙ
)

	)

170 
	#chunk_dss_po¡fÜk_chd
 
	`JEMALLOC_N
(
chunk_dss_po¡fÜk_chd
)

	)

171 
	#chunk_dss_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
chunk_dss_po¡fÜk_·»Á
)

	)

172 
	#chunk_dss_´ec_g‘
 
	`JEMALLOC_N
(
chunk_dss_´ec_g‘
)

	)

173 
	#chunk_dss_´ec_£t
 
	`JEMALLOC_N
(
chunk_dss_´ec_£t
)

	)

174 
	#chunk_dss_´efÜk
 
	`JEMALLOC_N
(
chunk_dss_´efÜk
)

	)

175 
	#chunk_hooks_deçuÉ
 
	`JEMALLOC_N
(
chunk_hooks_deçuÉ
)

	)

176 
	#chunk_hooks_g‘
 
	`JEMALLOC_N
(
chunk_hooks_g‘
)

	)

177 
	#chunk_hooks_£t
 
	`JEMALLOC_N
(
chunk_hooks_£t
)

	)

178 
	#chunk_š_dss
 
	`JEMALLOC_N
(
chunk_š_dss
)

	)

179 
	#chunk_lookup
 
	`JEMALLOC_N
(
chunk_lookup
)

	)

180 
	#chunk_Åages
 
	`JEMALLOC_N
(
chunk_Åages
)

	)

181 
	#chunk_po¡fÜk_chd
 
	`JEMALLOC_N
(
chunk_po¡fÜk_chd
)

	)

182 
	#chunk_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
chunk_po¡fÜk_·»Á
)

	)

183 
	#chunk_´efÜk
 
	`JEMALLOC_N
(
chunk_´efÜk
)

	)

184 
	#chunk_purge_w¿µ”
 
	`JEMALLOC_N
(
chunk_purge_w¿µ”
)

	)

185 
	#chunk_»gi¡”
 
	`JEMALLOC_N
(
chunk_»gi¡”
)

	)

186 
	#chunks_¹»e
 
	`JEMALLOC_N
(
chunks_¹»e
)

	)

187 
	#chunksize
 
	`JEMALLOC_N
(
chunksize
)

	)

188 
	#chunksize_mask
 
	`JEMALLOC_N
(
chunksize_mask
)

	)

189 
	#ckh_couÁ
 
	`JEMALLOC_N
(
ckh_couÁ
)

	)

190 
	#ckh_d–‘e
 
	`JEMALLOC_N
(
ckh_d–‘e
)

	)

191 
	#ckh_š£¹
 
	`JEMALLOC_N
(
ckh_š£¹
)

	)

192 
	#ckh_™”
 
	`JEMALLOC_N
(
ckh_™”
)

	)

193 
	#ckh_Ãw
 
	`JEMALLOC_N
(
ckh_Ãw
)

	)

194 
	#ckh_poš‹r_hash
 
	`JEMALLOC_N
(
ckh_poš‹r_hash
)

	)

195 
	#ckh_poš‹r_keycomp
 
	`JEMALLOC_N
(
ckh_poš‹r_keycomp
)

	)

196 
	#ckh_»move
 
	`JEMALLOC_N
(
ckh_»move
)

	)

197 
	#ckh_£¬ch
 
	`JEMALLOC_N
(
ckh_£¬ch
)

	)

198 
	#ckh_¡ršg_hash
 
	`JEMALLOC_N
(
ckh_¡ršg_hash
)

	)

199 
	#ckh_¡ršg_keycomp
 
	`JEMALLOC_N
(
ckh_¡ršg_keycomp
)

	)

200 
	#ùl_boÙ
 
	`JEMALLOC_N
(
ùl_boÙ
)

	)

201 
	#ùl_bymib
 
	`JEMALLOC_N
(
ùl_bymib
)

	)

202 
	#ùl_byÇme
 
	`JEMALLOC_N
(
ùl_byÇme
)

	)

203 
	#ùl_Çm‘omib
 
	`JEMALLOC_N
(
ùl_Çm‘omib
)

	)

204 
	#ùl_po¡fÜk_chd
 
	`JEMALLOC_N
(
ùl_po¡fÜk_chd
)

	)

205 
	#ùl_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
ùl_po¡fÜk_·»Á
)

	)

206 
	#ùl_´efÜk
 
	`JEMALLOC_N
(
ùl_´efÜk
)

	)

207 
	#deÿy_tick”_g‘
 
	`JEMALLOC_N
(
deÿy_tick”_g‘
)

	)

208 
	#dss_´ec_Çmes
 
	`JEMALLOC_N
(
dss_´ec_Çmes
)

	)

209 
	#ex‹Á_node_achunk_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_achunk_g‘
)

	)

210 
	#ex‹Á_node_achunk_£t
 
	`JEMALLOC_N
(
ex‹Á_node_achunk_£t
)

	)

211 
	#ex‹Á_node_addr_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_addr_g‘
)

	)

212 
	#ex‹Á_node_addr_£t
 
	`JEMALLOC_N
(
ex‹Á_node_addr_£t
)

	)

213 
	#ex‹Á_node_¬’a_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_¬’a_g‘
)

	)

214 
	#ex‹Á_node_¬’a_£t
 
	`JEMALLOC_N
(
ex‹Á_node_¬’a_£t
)

	)

215 
	#ex‹Á_node_comm™‹d_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_comm™‹d_g‘
)

	)

216 
	#ex‹Á_node_comm™‹d_£t
 
	`JEMALLOC_N
(
ex‹Á_node_comm™‹d_£t
)

	)

217 
	#ex‹Á_node_dœty_š£¹
 
	`JEMALLOC_N
(
ex‹Á_node_dœty_š£¹
)

	)

218 
	#ex‹Á_node_dœty_lškage_š™
 
	`JEMALLOC_N
(
ex‹Á_node_dœty_lškage_š™
)

	)

219 
	#ex‹Á_node_dœty_»move
 
	`JEMALLOC_N
(
ex‹Á_node_dœty_»move
)

	)

220 
	#ex‹Á_node_š™
 
	`JEMALLOC_N
(
ex‹Á_node_š™
)

	)

221 
	#ex‹Á_node_´of_tùx_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_´of_tùx_g‘
)

	)

222 
	#ex‹Á_node_´of_tùx_£t
 
	`JEMALLOC_N
(
ex‹Á_node_´of_tùx_£t
)

	)

223 
	#ex‹Á_node_size_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_size_g‘
)

	)

224 
	#ex‹Á_node_size_£t
 
	`JEMALLOC_N
(
ex‹Á_node_size_£t
)

	)

225 
	#ex‹Á_node_z”Ûd_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_z”Ûd_g‘
)

	)

226 
	#ex‹Á_node_z”Ûd_£t
 
	`JEMALLOC_N
(
ex‹Á_node_z”Ûd_£t
)

	)

227 
	#ex‹Á_Œ“_ad_de¡roy
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_de¡roy
)

	)

228 
	#ex‹Á_Œ“_ad_de¡roy_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_de¡roy_»cur£
)

	)

229 
	#ex‹Á_Œ“_ad_em±y
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_em±y
)

	)

230 
	#ex‹Á_Œ“_ad_fœ¡
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_fœ¡
)

	)

231 
	#ex‹Á_Œ“_ad_š£¹
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_š£¹
)

	)

232 
	#ex‹Á_Œ“_ad_™”
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_™”
)

	)

233 
	#ex‹Á_Œ“_ad_™”_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_™”_»cur£
)

	)

234 
	#ex‹Á_Œ“_ad_™”_¡¬t
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_™”_¡¬t
)

	)

235 
	#ex‹Á_Œ“_ad_Ï¡
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_Ï¡
)

	)

236 
	#ex‹Á_Œ“_ad_Ãw
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_Ãw
)

	)

237 
	#ex‹Á_Œ“_ad_Ãxt
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_Ãxt
)

	)

238 
	#ex‹Á_Œ“_ad_n£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_n£¬ch
)

	)

239 
	#ex‹Á_Œ“_ad_´ev
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_´ev
)

	)

240 
	#ex‹Á_Œ“_ad_p£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_p£¬ch
)

	)

241 
	#ex‹Á_Œ“_ad_»move
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_»move
)

	)

242 
	#ex‹Á_Œ“_ad_»v”£_™”
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_»v”£_™”
)

	)

243 
	#ex‹Á_Œ“_ad_»v”£_™”_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_»v”£_™”_»cur£
)

	)

244 
	#ex‹Á_Œ“_ad_»v”£_™”_¡¬t
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_»v”£_™”_¡¬t
)

	)

245 
	#ex‹Á_Œ“_ad_£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_£¬ch
)

	)

246 
	#ex‹Á_Œ“_szad_de¡roy
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_de¡roy
)

	)

247 
	#ex‹Á_Œ“_szad_de¡roy_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_de¡roy_»cur£
)

	)

248 
	#ex‹Á_Œ“_szad_em±y
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_em±y
)

	)

249 
	#ex‹Á_Œ“_szad_fœ¡
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_fœ¡
)

	)

250 
	#ex‹Á_Œ“_szad_š£¹
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_š£¹
)

	)

251 
	#ex‹Á_Œ“_szad_™”
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_™”
)

	)

252 
	#ex‹Á_Œ“_szad_™”_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_™”_»cur£
)

	)

253 
	#ex‹Á_Œ“_szad_™”_¡¬t
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_™”_¡¬t
)

	)

254 
	#ex‹Á_Œ“_szad_Ï¡
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_Ï¡
)

	)

255 
	#ex‹Á_Œ“_szad_Ãw
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_Ãw
)

	)

256 
	#ex‹Á_Œ“_szad_Ãxt
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_Ãxt
)

	)

257 
	#ex‹Á_Œ“_szad_n£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_n£¬ch
)

	)

258 
	#ex‹Á_Œ“_szad_´ev
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_´ev
)

	)

259 
	#ex‹Á_Œ“_szad_p£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_p£¬ch
)

	)

260 
	#ex‹Á_Œ“_szad_»move
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_»move
)

	)

261 
	#ex‹Á_Œ“_szad_»v”£_™”
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_»v”£_™”
)

	)

262 
	#ex‹Á_Œ“_szad_»v”£_™”_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_»v”£_™”_»cur£
)

	)

263 
	#ex‹Á_Œ“_szad_»v”£_™”_¡¬t
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_»v”£_™”_¡¬t
)

	)

264 
	#ex‹Á_Œ“_szad_£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_£¬ch
)

	)

265 
	#ffs_Îu
 
	`JEMALLOC_N
(
ffs_Îu
)

	)

266 
	#ffs_lu
 
	`JEMALLOC_N
(
ffs_lu
)

	)

267 
	#ffs_u
 
	`JEMALLOC_N
(
ffs_u
)

	)

268 
	#ffs_u32
 
	`JEMALLOC_N
(
ffs_u32
)

	)

269 
	#ffs_u64
 
	`JEMALLOC_N
(
ffs_u64
)

	)

270 
	#ffs_zu
 
	`JEMALLOC_N
(
ffs_zu
)

	)

271 
	#g‘_”ºo
 
	`JEMALLOC_N
(
g‘_”ºo
)

	)

272 
	#hash
 
	`JEMALLOC_N
(
hash
)

	)

273 
	#hash_fmix_32
 
	`JEMALLOC_N
(
hash_fmix_32
)

	)

274 
	#hash_fmix_64
 
	`JEMALLOC_N
(
hash_fmix_64
)

	)

275 
	#hash_g‘_block_32
 
	`JEMALLOC_N
(
hash_g‘_block_32
)

	)

276 
	#hash_g‘_block_64
 
	`JEMALLOC_N
(
hash_g‘_block_64
)

	)

277 
	#hash_rÙl_32
 
	`JEMALLOC_N
(
hash_rÙl_32
)

	)

278 
	#hash_rÙl_64
 
	`JEMALLOC_N
(
hash_rÙl_64
)

	)

279 
	#hash_x64_128
 
	`JEMALLOC_N
(
hash_x64_128
)

	)

280 
	#hash_x86_128
 
	`JEMALLOC_N
(
hash_x86_128
)

	)

281 
	#hash_x86_32
 
	`JEMALLOC_N
(
hash_x86_32
)

	)

282 
	#huge_¯Îoc
 
	`JEMALLOC_N
(
huge_¯Îoc
)

	)

283 
	#huge_d®loc
 
	`JEMALLOC_N
(
huge_d®loc
)

	)

284 
	#huge_d®loc_junk
 
	`JEMALLOC_N
(
huge_d®loc_junk
)

	)

285 
	#huge_m®loc
 
	`JEMALLOC_N
(
huge_m®loc
)

	)

286 
	#huge_·Îoc
 
	`JEMALLOC_N
(
huge_·Îoc
)

	)

287 
	#huge_´of_tùx_g‘
 
	`JEMALLOC_N
(
huge_´of_tùx_g‘
)

	)

288 
	#huge_´of_tùx_»£t
 
	`JEMALLOC_N
(
huge_´of_tùx_»£t
)

	)

289 
	#huge_´of_tùx_£t
 
	`JEMALLOC_N
(
huge_´of_tùx_£t
)

	)

290 
	#huge_¿Îoc
 
	`JEMALLOC_N
(
huge_¿Îoc
)

	)

291 
	#huge_¿Îoc_no_move
 
	`JEMALLOC_N
(
huge_¿Îoc_no_move
)

	)

292 
	#huge_§Îoc
 
	`JEMALLOC_N
(
huge_§Îoc
)

	)

293 
	#Ÿ®loc
 
	`JEMALLOC_N
(
Ÿ®loc
)

	)

294 
	#ŸÎoc
 
	`JEMALLOC_N
(
ŸÎoc
)

	)

295 
	#ŸÎocztm
 
	`JEMALLOC_N
(
ŸÎocztm
)

	)

296 
	#Ÿ»Ç_ş—nup
 
	`JEMALLOC_N
(
Ÿ»Ç_ş—nup
)

	)

297 
	#id®loc
 
	`JEMALLOC_N
(
id®loc
)

	)

298 
	#id®loùm
 
	`JEMALLOC_N
(
id®loùm
)

	)

299 
	#š_v®gršd
 
	`JEMALLOC_N
(
š_v®gršd
)

	)

300 
	#šdex2size
 
	`JEMALLOC_N
(
šdex2size
)

	)

301 
	#šdex2size_compu‹
 
	`JEMALLOC_N
(
šdex2size_compu‹
)

	)

302 
	#šdex2size_lookup
 
	`JEMALLOC_N
(
šdex2size_lookup
)

	)

303 
	#šdex2size_b
 
	`JEMALLOC_N
(
šdex2size_b
)

	)

304 
	#®loc
 
	`JEMALLOC_N
(
®loc
)

	)

305 
	#®loù
 
	`JEMALLOC_N
(
®loù
)

	)

306 
	#®locztm
 
	`JEMALLOC_N
(
®locztm
)

	)

307 
	#iq®loc
 
	`JEMALLOC_N
(
iq®loc
)

	)

308 
	#œ®loc
 
	`JEMALLOC_N
(
œ®loc
)

	)

309 
	#œ®loù
 
	`JEMALLOC_N
(
œ®loù
)

	)

310 
	#œ®loù_»®ign
 
	`JEMALLOC_N
(
œ®loù_»®ign
)

	)

311 
	#i§Îoc
 
	`JEMALLOC_N
(
i§Îoc
)

	)

312 
	#isd®loù
 
	`JEMALLOC_N
(
isd®loù
)

	)

313 
	#isq®loc
 
	`JEMALLOC_N
(
isq®loc
)

	)

314 
	#i¡h»aded
 
	`JEMALLOC_N
(
i¡h»aded
)

	)

315 
	#iv§Îoc
 
	`JEMALLOC_N
(
iv§Îoc
)

	)

316 
	#ix®loc
 
	`JEMALLOC_N
(
ix®loc
)

	)

317 
	#jem®loc_po¡fÜk_chd
 
	`JEMALLOC_N
(
jem®loc_po¡fÜk_chd
)

	)

318 
	#jem®loc_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
jem®loc_po¡fÜk_·»Á
)

	)

319 
	#jem®loc_´efÜk
 
	`JEMALLOC_N
(
jem®loc_´efÜk
)

	)

320 
	#Ïrge_maxşass
 
	`JEMALLOC_N
(
Ïrge_maxşass
)

	)

321 
	#lg_æoÜ
 
	`JEMALLOC_N
(
lg_æoÜ
)

	)

322 
	#lg_´of_§m¶e
 
	`JEMALLOC_N
(
lg_´of_§m¶e
)

	)

323 
	#m®loc_ırštf
 
	`JEMALLOC_N
(
m®loc_ırštf
)

	)

324 
	#m®loc_mu‹x_as£¹_nÙ_owÃr
 
	`JEMALLOC_N
(
m®loc_mu‹x_as£¹_nÙ_owÃr
)

	)

325 
	#m®loc_mu‹x_as£¹_owÃr
 
	`JEMALLOC_N
(
m®loc_mu‹x_as£¹_owÃr
)

	)

326 
	#m®loc_mu‹x_boÙ
 
	`JEMALLOC_N
(
m®loc_mu‹x_boÙ
)

	)

327 
	#m®loc_mu‹x_š™
 
	`JEMALLOC_N
(
m®loc_mu‹x_š™
)

	)

328 
	#m®loc_mu‹x_lock
 
	`JEMALLOC_N
(
m®loc_mu‹x_lock
)

	)

329 
	#m®loc_mu‹x_po¡fÜk_chd
 
	`JEMALLOC_N
(
m®loc_mu‹x_po¡fÜk_chd
)

	)

330 
	#m®loc_mu‹x_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
m®loc_mu‹x_po¡fÜk_·»Á
)

	)

331 
	#m®loc_mu‹x_´efÜk
 
	`JEMALLOC_N
(
m®loc_mu‹x_´efÜk
)

	)

332 
	#m®loc_mu‹x_uÆock
 
	`JEMALLOC_N
(
m®loc_mu‹x_uÆock
)

	)

333 
	#m®loc_´štf
 
	`JEMALLOC_N
(
m®loc_´štf
)

	)

334 
	#m®loc_¢´štf
 
	`JEMALLOC_N
(
m®loc_¢´štf
)

	)

335 
	#m®loc_¡¹oumax
 
	`JEMALLOC_N
(
m®loc_¡¹oumax
)

	)

336 
	#m®loc_tsd_boÙ0
 
	`JEMALLOC_N
(
m®loc_tsd_boÙ0
)

	)

337 
	#m®loc_tsd_boÙ1
 
	`JEMALLOC_N
(
m®loc_tsd_boÙ1
)

	)

338 
	#m®loc_tsd_ş—nup_»gi¡”
 
	`JEMALLOC_N
(
m®loc_tsd_ş—nup_»gi¡”
)

	)

339 
	#m®loc_tsd_d®loc
 
	`JEMALLOC_N
(
m®loc_tsd_d®loc
)

	)

340 
	#m®loc_tsd_m®loc
 
	`JEMALLOC_N
(
m®loc_tsd_m®loc
)

	)

341 
	#m®loc_tsd_no_ş—nup
 
	`JEMALLOC_N
(
m®loc_tsd_no_ş—nup
)

	)

342 
	#m®loc_vırštf
 
	`JEMALLOC_N
(
m®loc_vırštf
)

	)

343 
	#m®loc_v¢´štf
 
	`JEMALLOC_N
(
m®loc_v¢´štf
)

	)

344 
	#m®loc_wr™e
 
	`JEMALLOC_N
(
m®loc_wr™e
)

	)

345 
	#m­_bŸs
 
	`JEMALLOC_N
(
m­_bŸs
)

	)

346 
	#m­_misc_off£t
 
	`JEMALLOC_N
(
m­_misc_off£t
)

	)

347 
	#mb_wr™e
 
	`JEMALLOC_N
(
mb_wr™e
)

	)

348 
	#Ç»Çs_auto
 
	`JEMALLOC_N
(
Ç»Çs_auto
)

	)

349 
	#Ç»Çs_td©a_ş—nup
 
	`JEMALLOC_N
(
Ç»Çs_td©a_ş—nup
)

	)

350 
	#Ç»Çs_tÙ®_g‘
 
	`JEMALLOC_N
(
Ç»Çs_tÙ®_g‘
)

	)

351 
	#nıus
 
	`JEMALLOC_N
(
nıus
)

	)

352 
	#nhbšs
 
	`JEMALLOC_N
(
nhbšs
)

	)

353 
	#nhşas£s
 
	`JEMALLOC_N
(
nhşas£s
)

	)

354 
	#Æşas£s
 
	`JEMALLOC_N
(
Æşas£s
)

	)

355 
	#n¡ime_add
 
	`JEMALLOC_N
(
n¡ime_add
)

	)

356 
	#n¡ime_com·»
 
	`JEMALLOC_N
(
n¡ime_com·»
)

	)

357 
	#n¡ime_cİy
 
	`JEMALLOC_N
(
n¡ime_cİy
)

	)

358 
	#n¡ime_divide
 
	`JEMALLOC_N
(
n¡ime_divide
)

	)

359 
	#n¡ime_idivide
 
	`JEMALLOC_N
(
n¡ime_idivide
)

	)

360 
	#n¡ime_imuÉly
 
	`JEMALLOC_N
(
n¡ime_imuÉly
)

	)

361 
	#n¡ime_š™
 
	`JEMALLOC_N
(
n¡ime_š™
)

	)

362 
	#n¡ime_š™2
 
	`JEMALLOC_N
(
n¡ime_š™2
)

	)

363 
	#n¡ime_ns
 
	`JEMALLOC_N
(
n¡ime_ns
)

	)

364 
	#n¡ime_n£c
 
	`JEMALLOC_N
(
n¡ime_n£c
)

	)

365 
	#n¡ime_£c
 
	`JEMALLOC_N
(
n¡ime_£c
)

	)

366 
	#n¡ime_subŒaù
 
	`JEMALLOC_N
(
n¡ime_subŒaù
)

	)

367 
	#n¡ime_upd©e
 
	`JEMALLOC_N
(
n¡ime_upd©e
)

	)

368 
	#İt_abÜt
 
	`JEMALLOC_N
(
İt_abÜt
)

	)

369 
	#İt_deÿy_time
 
	`JEMALLOC_N
(
İt_deÿy_time
)

	)

370 
	#İt_dss
 
	`JEMALLOC_N
(
İt_dss
)

	)

371 
	#İt_junk
 
	`JEMALLOC_N
(
İt_junk
)

	)

372 
	#İt_junk_®loc
 
	`JEMALLOC_N
(
İt_junk_®loc
)

	)

373 
	#İt_junk_ä“
 
	`JEMALLOC_N
(
İt_junk_ä“
)

	)

374 
	#İt_lg_chunk
 
	`JEMALLOC_N
(
İt_lg_chunk
)

	)

375 
	#İt_lg_dœty_muÉ
 
	`JEMALLOC_N
(
İt_lg_dœty_muÉ
)

	)

376 
	#İt_lg_´of_š‹rv®
 
	`JEMALLOC_N
(
İt_lg_´of_š‹rv®
)

	)

377 
	#İt_lg_´of_§m¶e
 
	`JEMALLOC_N
(
İt_lg_´of_§m¶e
)

	)

378 
	#İt_lg_tÿche_max
 
	`JEMALLOC_N
(
İt_lg_tÿche_max
)

	)

379 
	#İt_Ç»Çs
 
	`JEMALLOC_N
(
İt_Ç»Çs
)

	)

380 
	#İt_´of
 
	`JEMALLOC_N
(
İt_´of
)

	)

381 
	#İt_´of_accum
 
	`JEMALLOC_N
(
İt_´of_accum
)

	)

382 
	#İt_´of_aùive
 
	`JEMALLOC_N
(
İt_´of_aùive
)

	)

383 
	#İt_´of_fš®
 
	`JEMALLOC_N
(
İt_´of_fš®
)

	)

384 
	#İt_´of_gdump
 
	`JEMALLOC_N
(
İt_´of_gdump
)

	)

385 
	#İt_´of_Ëak
 
	`JEMALLOC_N
(
İt_´of_Ëak
)

	)

386 
	#İt_´of_´efix
 
	`JEMALLOC_N
(
İt_´of_´efix
)

	)

387 
	#İt_´of_th»ad_aùive_š™
 
	`JEMALLOC_N
(
İt_´of_th»ad_aùive_š™
)

	)

388 
	#İt_purge
 
	`JEMALLOC_N
(
İt_purge
)

	)

389 
	#İt_qu¬ªtše
 
	`JEMALLOC_N
(
İt_qu¬ªtše
)

	)

390 
	#İt_»dzÚe
 
	`JEMALLOC_N
(
İt_»dzÚe
)

	)

391 
	#İt_¡©s_´št
 
	`JEMALLOC_N
(
İt_¡©s_´št
)

	)

392 
	#İt_tÿche
 
	`JEMALLOC_N
(
İt_tÿche
)

	)

393 
	#İt_uŒaû
 
	`JEMALLOC_N
(
İt_uŒaû
)

	)

394 
	#İt_xm®loc
 
	`JEMALLOC_N
(
İt_xm®loc
)

	)

395 
	#İt_z”o
 
	`JEMALLOC_N
(
İt_z”o
)

	)

396 
	#p2rz
 
	`JEMALLOC_N
(
p2rz
)

	)

397 
	#·ges_boÙ
 
	`JEMALLOC_N
(
·ges_boÙ
)

	)

398 
	#·ges_comm™
 
	`JEMALLOC_N
(
·ges_comm™
)

	)

399 
	#·ges_decomm™
 
	`JEMALLOC_N
(
·ges_decomm™
)

	)

400 
	#·ges_m­
 
	`JEMALLOC_N
(
·ges_m­
)

	)

401 
	#·ges_purge
 
	`JEMALLOC_N
(
·ges_purge
)

	)

402 
	#·ges_Œim
 
	`JEMALLOC_N
(
·ges_Œim
)

	)

403 
	#·ges_unm­
 
	`JEMALLOC_N
(
·ges_unm­
)

	)

404 
	#pow2_û_u32
 
	`JEMALLOC_N
(
pow2_û_u32
)

	)

405 
	#pow2_û_u64
 
	`JEMALLOC_N
(
pow2_û_u64
)

	)

406 
	#pow2_û_zu
 
	`JEMALLOC_N
(
pow2_û_zu
)

	)

407 
	#´ng_lg_¿nge
 
	`JEMALLOC_N
(
´ng_lg_¿nge
)

	)

408 
	#´ng_¿nge
 
	`JEMALLOC_N
(
´ng_¿nge
)

	)

409 
	#´of_aùive
 
	`JEMALLOC_N
(
´of_aùive
)

	)

410 
	#´of_aùive_g‘
 
	`JEMALLOC_N
(
´of_aùive_g‘
)

	)

411 
	#´of_aùive_g‘_uÆocked
 
	`JEMALLOC_N
(
´of_aùive_g‘_uÆocked
)

	)

412 
	#´of_aùive_£t
 
	`JEMALLOC_N
(
´of_aùive_£t
)

	)

413 
	#´of_®loc_´•
 
	`JEMALLOC_N
(
´of_®loc_´•
)

	)

414 
	#´of_®loc_rŞlback
 
	`JEMALLOC_N
(
´of_®loc_rŞlback
)

	)

415 
	#´of_backŒaû
 
	`JEMALLOC_N
(
´of_backŒaû
)

	)

416 
	#´of_boÙ0
 
	`JEMALLOC_N
(
´of_boÙ0
)

	)

417 
	#´of_boÙ1
 
	`JEMALLOC_N
(
´of_boÙ1
)

	)

418 
	#´of_boÙ2
 
	`JEMALLOC_N
(
´of_boÙ2
)

	)

419 
	#´of_bt_couÁ
 
	`JEMALLOC_N
(
´of_bt_couÁ
)

	)

420 
	#´of_dump_h—d”
 
	`JEMALLOC_N
(
´of_dump_h—d”
)

	)

421 
	#´of_dump_İ’
 
	`JEMALLOC_N
(
´of_dump_İ’
)

	)

422 
	#´of_ä“
 
	`JEMALLOC_N
(
´of_ä“
)

	)

423 
	#´of_ä“_§m¶ed_objeù
 
	`JEMALLOC_N
(
´of_ä“_§m¶ed_objeù
)

	)

424 
	#´of_gdump
 
	`JEMALLOC_N
(
´of_gdump
)

	)

425 
	#´of_gdump_g‘
 
	`JEMALLOC_N
(
´of_gdump_g‘
)

	)

426 
	#´of_gdump_g‘_uÆocked
 
	`JEMALLOC_N
(
´of_gdump_g‘_uÆocked
)

	)

427 
	#´of_gdump_£t
 
	`JEMALLOC_N
(
´of_gdump_£t
)

	)

428 
	#´of_gdump_v®
 
	`JEMALLOC_N
(
´of_gdump_v®
)

	)

429 
	#´of_idump
 
	`JEMALLOC_N
(
´of_idump
)

	)

430 
	#´of_š‹rv®
 
	`JEMALLOC_N
(
´of_š‹rv®
)

	)

431 
	#´of_lookup
 
	`JEMALLOC_N
(
´of_lookup
)

	)

432 
	#´of_m®loc
 
	`JEMALLOC_N
(
´of_m®loc
)

	)

433 
	#´of_m®loc_§m¶e_objeù
 
	`JEMALLOC_N
(
´of_m®loc_§m¶e_objeù
)

	)

434 
	#´of_mdump
 
	`JEMALLOC_N
(
´of_mdump
)

	)

435 
	#´of_po¡fÜk_chd
 
	`JEMALLOC_N
(
´of_po¡fÜk_chd
)

	)

436 
	#´of_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
´of_po¡fÜk_·»Á
)

	)

437 
	#´of_´efÜk0
 
	`JEMALLOC_N
(
´of_´efÜk0
)

	)

438 
	#´of_´efÜk1
 
	`JEMALLOC_N
(
´of_´efÜk1
)

	)

439 
	#´of_»®loc
 
	`JEMALLOC_N
(
´of_»®loc
)

	)

440 
	#´of_»£t
 
	`JEMALLOC_N
(
´of_»£t
)

	)

441 
	#´of_§m¶e_accum_upd©e
 
	`JEMALLOC_N
(
´of_§m¶e_accum_upd©e
)

	)

442 
	#´of_§m¶e_th»shŞd_upd©e
 
	`JEMALLOC_N
(
´of_§m¶e_th»shŞd_upd©e
)

	)

443 
	#´of_tùx_g‘
 
	`JEMALLOC_N
(
´of_tùx_g‘
)

	)

444 
	#´of_tùx_»£t
 
	`JEMALLOC_N
(
´of_tùx_»£t
)

	)

445 
	#´of_tùx_£t
 
	`JEMALLOC_N
(
´of_tùx_£t
)

	)

446 
	#´of_td©a_ş—nup
 
	`JEMALLOC_N
(
´of_td©a_ş—nup
)

	)

447 
	#´of_td©a_couÁ
 
	`JEMALLOC_N
(
´of_td©a_couÁ
)

	)

448 
	#´of_td©a_g‘
 
	`JEMALLOC_N
(
´of_td©a_g‘
)

	)

449 
	#´of_td©a_š™
 
	`JEMALLOC_N
(
´of_td©a_š™
)

	)

450 
	#´of_td©a_»š™
 
	`JEMALLOC_N
(
´of_td©a_»š™
)

	)

451 
	#´of_th»ad_aùive_g‘
 
	`JEMALLOC_N
(
´of_th»ad_aùive_g‘
)

	)

452 
	#´of_th»ad_aùive_š™_g‘
 
	`JEMALLOC_N
(
´of_th»ad_aùive_š™_g‘
)

	)

453 
	#´of_th»ad_aùive_š™_£t
 
	`JEMALLOC_N
(
´of_th»ad_aùive_š™_£t
)

	)

454 
	#´of_th»ad_aùive_£t
 
	`JEMALLOC_N
(
´of_th»ad_aùive_£t
)

	)

455 
	#´of_th»ad_Çme_g‘
 
	`JEMALLOC_N
(
´of_th»ad_Çme_g‘
)

	)

456 
	#´of_th»ad_Çme_£t
 
	`JEMALLOC_N
(
´of_th»ad_Çme_£t
)

	)

457 
	#purge_mode_Çmes
 
	`JEMALLOC_N
(
purge_mode_Çmes
)

	)

458 
	#qu¬ªtše
 
	`JEMALLOC_N
(
qu¬ªtše
)

	)

459 
	#qu¬ªtše_®loc_hook
 
	`JEMALLOC_N
(
qu¬ªtše_®loc_hook
)

	)

460 
	#qu¬ªtše_®loc_hook_wÜk
 
	`JEMALLOC_N
(
qu¬ªtše_®loc_hook_wÜk
)

	)

461 
	#qu¬ªtše_ş—nup
 
	`JEMALLOC_N
(
qu¬ªtše_ş—nup
)

	)

462 
	#»gi¡”_zÚe
 
	`JEMALLOC_N
(
»gi¡”_zÚe
)

	)

463 
	#¹»e_chd_»ad
 
	`JEMALLOC_N
(
¹»e_chd_»ad
)

	)

464 
	#¹»e_chd_»ad_h¬d
 
	`JEMALLOC_N
(
¹»e_chd_»ad_h¬d
)

	)

465 
	#¹»e_chd_Œy»ad
 
	`JEMALLOC_N
(
¹»e_chd_Œy»ad
)

	)

466 
	#¹»e_d–‘e
 
	`JEMALLOC_N
(
¹»e_d–‘e
)

	)

467 
	#¹»e_g‘
 
	`JEMALLOC_N
(
¹»e_g‘
)

	)

468 
	#¹»e_Ãw
 
	`JEMALLOC_N
(
¹»e_Ãw
)

	)

469 
	#¹»e_node_v®id
 
	`JEMALLOC_N
(
¹»e_node_v®id
)

	)

470 
	#¹»e_£t
 
	`JEMALLOC_N
(
¹»e_£t
)

	)

471 
	#¹»e_¡¬t_Ëv–
 
	`JEMALLOC_N
(
¹»e_¡¬t_Ëv–
)

	)

472 
	#¹»e_subkey
 
	`JEMALLOC_N
(
¹»e_subkey
)

	)

473 
	#¹»e_subŒ“_»ad
 
	`JEMALLOC_N
(
¹»e_subŒ“_»ad
)

	)

474 
	#¹»e_subŒ“_»ad_h¬d
 
	`JEMALLOC_N
(
¹»e_subŒ“_»ad_h¬d
)

	)

475 
	#¹»e_subŒ“_Œy»ad
 
	`JEMALLOC_N
(
¹»e_subŒ“_Œy»ad
)

	)

476 
	#¹»e_v®_»ad
 
	`JEMALLOC_N
(
¹»e_v®_»ad
)

	)

477 
	#¹»e_v®_wr™e
 
	`JEMALLOC_N
(
¹»e_v®_wr™e
)

	)

478 
	#run_quªtize_û
 
	`JEMALLOC_N
(
run_quªtize_û
)

	)

479 
	#run_quªtize_æoÜ
 
	`JEMALLOC_N
(
run_quªtize_æoÜ
)

	)

480 
	#run_quªtize_max
 
	`JEMALLOC_N
(
run_quªtize_max
)

	)

481 
	#s2u
 
	`JEMALLOC_N
(
s2u
)

	)

482 
	#s2u_compu‹
 
	`JEMALLOC_N
(
s2u_compu‹
)

	)

483 
	#s2u_lookup
 
	`JEMALLOC_N
(
s2u_lookup
)

	)

484 
	#§2u
 
	`JEMALLOC_N
(
§2u
)

	)

485 
	#£t_”ºo
 
	`JEMALLOC_N
(
£t_”ºo
)

	)

486 
	#size2šdex
 
	`JEMALLOC_N
(
size2šdex
)

	)

487 
	#size2šdex_compu‹
 
	`JEMALLOC_N
(
size2šdex_compu‹
)

	)

488 
	#size2šdex_lookup
 
	`JEMALLOC_N
(
size2šdex_lookup
)

	)

489 
	#size2šdex_b
 
	`JEMALLOC_N
(
size2šdex_b
)

	)

490 
	#¡©s_ÿùive
 
	`JEMALLOC_N
(
¡©s_ÿùive
)

	)

491 
	#¡©s_ÿùive_add
 
	`JEMALLOC_N
(
¡©s_ÿùive_add
)

	)

492 
	#¡©s_ÿùive_g‘
 
	`JEMALLOC_N
(
¡©s_ÿùive_g‘
)

	)

493 
	#¡©s_ÿùive_sub
 
	`JEMALLOC_N
(
¡©s_ÿùive_sub
)

	)

494 
	#¡©s_´št
 
	`JEMALLOC_N
(
¡©s_´št
)

	)

495 
	#tÿche_®loc_—sy
 
	`JEMALLOC_N
(
tÿche_®loc_—sy
)

	)

496 
	#tÿche_®loc_Ïrge
 
	`JEMALLOC_N
(
tÿche_®loc_Ïrge
)

	)

497 
	#tÿche_®loc_sm®l
 
	`JEMALLOC_N
(
tÿche_®loc_sm®l
)

	)

498 
	#tÿche_®loc_sm®l_h¬d
 
	`JEMALLOC_N
(
tÿche_®loc_sm®l_h¬d
)

	)

499 
	#tÿche_¬’a_»assocŸ‹
 
	`JEMALLOC_N
(
tÿche_¬’a_»assocŸ‹
)

	)

500 
	#tÿche_bš_æush_Ïrge
 
	`JEMALLOC_N
(
tÿche_bš_æush_Ïrge
)

	)

501 
	#tÿche_bš_æush_sm®l
 
	`JEMALLOC_N
(
tÿche_bš_æush_sm®l
)

	)

502 
	#tÿche_bš_šfo
 
	`JEMALLOC_N
(
tÿche_bš_šfo
)

	)

503 
	#tÿche_boÙ
 
	`JEMALLOC_N
(
tÿche_boÙ
)

	)

504 
	#tÿche_ş—nup
 
	`JEMALLOC_N
(
tÿche_ş—nup
)

	)

505 
	#tÿche_ü—‹
 
	`JEMALLOC_N
(
tÿche_ü—‹
)

	)

506 
	#tÿche_d®loc_Ïrge
 
	`JEMALLOC_N
(
tÿche_d®loc_Ïrge
)

	)

507 
	#tÿche_d®loc_sm®l
 
	`JEMALLOC_N
(
tÿche_d®loc_sm®l
)

	)

508 
	#tÿche_’abËd_ş—nup
 
	`JEMALLOC_N
(
tÿche_’abËd_ş—nup
)

	)

509 
	#tÿche_’abËd_g‘
 
	`JEMALLOC_N
(
tÿche_’abËd_g‘
)

	)

510 
	#tÿche_’abËd_£t
 
	`JEMALLOC_N
(
tÿche_’abËd_£t
)

	)

511 
	#tÿche_ev’t
 
	`JEMALLOC_N
(
tÿche_ev’t
)

	)

512 
	#tÿche_ev’t_h¬d
 
	`JEMALLOC_N
(
tÿche_ev’t_h¬d
)

	)

513 
	#tÿche_æush
 
	`JEMALLOC_N
(
tÿche_æush
)

	)

514 
	#tÿche_g‘
 
	`JEMALLOC_N
(
tÿche_g‘
)

	)

515 
	#tÿche_g‘_h¬d
 
	`JEMALLOC_N
(
tÿche_g‘_h¬d
)

	)

516 
	#tÿche_maxşass
 
	`JEMALLOC_N
(
tÿche_maxşass
)

	)

517 
	#tÿche_§Îoc
 
	`JEMALLOC_N
(
tÿche_§Îoc
)

	)

518 
	#tÿche_¡©s_m”ge
 
	`JEMALLOC_N
(
tÿche_¡©s_m”ge
)

	)

519 
	#tÿches
 
	`JEMALLOC_N
(
tÿches
)

	)

520 
	#tÿches_ü—‹
 
	`JEMALLOC_N
(
tÿches_ü—‹
)

	)

521 
	#tÿches_de¡roy
 
	`JEMALLOC_N
(
tÿches_de¡roy
)

	)

522 
	#tÿches_æush
 
	`JEMALLOC_N
(
tÿches_æush
)

	)

523 
	#tÿches_g‘
 
	`JEMALLOC_N
(
tÿches_g‘
)

	)

524 
	#th»ad_®loÿ‹d_ş—nup
 
	`JEMALLOC_N
(
th»ad_®loÿ‹d_ş—nup
)

	)

525 
	#th»ad_d—Îoÿ‹d_ş—nup
 
	`JEMALLOC_N
(
th»ad_d—Îoÿ‹d_ş—nup
)

	)

526 
	#tick”_cİy
 
	`JEMALLOC_N
(
tick”_cİy
)

	)

527 
	#tick”_š™
 
	`JEMALLOC_N
(
tick”_š™
)

	)

528 
	#tick”_»ad
 
	`JEMALLOC_N
(
tick”_»ad
)

	)

529 
	#tick”_tick
 
	`JEMALLOC_N
(
tick”_tick
)

	)

530 
	#tick”_ticks
 
	`JEMALLOC_N
(
tick”_ticks
)

	)

531 
	#tsd_¬’a_g‘
 
	`JEMALLOC_N
(
tsd_¬’a_g‘
)

	)

532 
	#tsd_¬’a_£t
 
	`JEMALLOC_N
(
tsd_¬’a_£t
)

	)

533 
	#tsd_¬’­_g‘
 
	`JEMALLOC_N
(
tsd_¬’­_g‘
)

	)

534 
	#tsd_¬’as_td©a_by·ss_g‘
 
	`JEMALLOC_N
(
tsd_¬’as_td©a_by·ss_g‘
)

	)

535 
	#tsd_¬’as_td©a_by·ss_£t
 
	`JEMALLOC_N
(
tsd_¬’as_td©a_by·ss_£t
)

	)

536 
	#tsd_¬’as_td©a_by·s¥_g‘
 
	`JEMALLOC_N
(
tsd_¬’as_td©a_by·s¥_g‘
)

	)

537 
	#tsd_¬’as_td©a_g‘
 
	`JEMALLOC_N
(
tsd_¬’as_td©a_g‘
)

	)

538 
	#tsd_¬’as_td©a_£t
 
	`JEMALLOC_N
(
tsd_¬’as_td©a_£t
)

	)

539 
	#tsd_¬’as_td©­_g‘
 
	`JEMALLOC_N
(
tsd_¬’as_td©­_g‘
)

	)

540 
	#tsd_boÙ
 
	`JEMALLOC_N
(
tsd_boÙ
)

	)

541 
	#tsd_boÙ0
 
	`JEMALLOC_N
(
tsd_boÙ0
)

	)

542 
	#tsd_boÙ1
 
	`JEMALLOC_N
(
tsd_boÙ1
)

	)

543 
	#tsd_boÙed
 
	`JEMALLOC_N
(
tsd_boÙed
)

	)

544 
	#tsd_boÙed_g‘
 
	`JEMALLOC_N
(
tsd_boÙed_g‘
)

	)

545 
	#tsd_ş—nup
 
	`JEMALLOC_N
(
tsd_ş—nup
)

	)

546 
	#tsd_ş—nup_w¿µ”
 
	`JEMALLOC_N
(
tsd_ş—nup_w¿µ”
)

	)

547 
	#tsd_ãtch
 
	`JEMALLOC_N
(
tsd_ãtch
)

	)

548 
	#tsd_g‘
 
	`JEMALLOC_N
(
tsd_g‘
)

	)

549 
	#tsd_Ÿ»Ç_g‘
 
	`JEMALLOC_N
(
tsd_Ÿ»Ç_g‘
)

	)

550 
	#tsd_Ÿ»Ç_£t
 
	`JEMALLOC_N
(
tsd_Ÿ»Ç_£t
)

	)

551 
	#tsd_Ÿ»Çp_g‘
 
	`JEMALLOC_N
(
tsd_Ÿ»Çp_g‘
)

	)

552 
	#tsd_š™Ÿlized
 
	`JEMALLOC_N
(
tsd_š™Ÿlized
)

	)

553 
	#tsd_š™_check_»cursiÚ
 
	`JEMALLOC_N
(
tsd_š™_check_»cursiÚ
)

	)

554 
	#tsd_š™_fšish
 
	`JEMALLOC_N
(
tsd_š™_fšish
)

	)

555 
	#tsd_š™_h—d
 
	`JEMALLOC_N
(
tsd_š™_h—d
)

	)

556 
	#tsd_Ç»Çs_td©a_g‘
 
	`JEMALLOC_N
(
tsd_Ç»Çs_td©a_g‘
)

	)

557 
	#tsd_Ç»Çs_td©a_£t
 
	`JEMALLOC_N
(
tsd_Ç»Çs_td©a_£t
)

	)

558 
	#tsd_Ç»Çs_td©­_g‘
 
	`JEMALLOC_N
(
tsd_Ç»Çs_td©­_g‘
)

	)

559 
	#tsd_w¿µ”_g‘
 
	`JEMALLOC_N
(
tsd_w¿µ”_g‘
)

	)

560 
	#tsd_w¿µ”_£t
 
	`JEMALLOC_N
(
tsd_w¿µ”_£t
)

	)

561 
	#tsd_nomš®
 
	`JEMALLOC_N
(
tsd_nomš®
)

	)

562 
	#tsd_´of_td©a_g‘
 
	`JEMALLOC_N
(
tsd_´of_td©a_g‘
)

	)

563 
	#tsd_´of_td©a_£t
 
	`JEMALLOC_N
(
tsd_´of_td©a_£t
)

	)

564 
	#tsd_´of_td©­_g‘
 
	`JEMALLOC_N
(
tsd_´of_td©­_g‘
)

	)

565 
	#tsd_qu¬ªtše_g‘
 
	`JEMALLOC_N
(
tsd_qu¬ªtše_g‘
)

	)

566 
	#tsd_qu¬ªtše_£t
 
	`JEMALLOC_N
(
tsd_qu¬ªtše_£t
)

	)

567 
	#tsd_qu¬ªtš•_g‘
 
	`JEMALLOC_N
(
tsd_qu¬ªtš•_g‘
)

	)

568 
	#tsd_£t
 
	`JEMALLOC_N
(
tsd_£t
)

	)

569 
	#tsd_tÿche_’abËd_g‘
 
	`JEMALLOC_N
(
tsd_tÿche_’abËd_g‘
)

	)

570 
	#tsd_tÿche_’abËd_£t
 
	`JEMALLOC_N
(
tsd_tÿche_’abËd_£t
)

	)

571 
	#tsd_tÿche_’abËdp_g‘
 
	`JEMALLOC_N
(
tsd_tÿche_’abËdp_g‘
)

	)

572 
	#tsd_tÿche_g‘
 
	`JEMALLOC_N
(
tsd_tÿche_g‘
)

	)

573 
	#tsd_tÿche_£t
 
	`JEMALLOC_N
(
tsd_tÿche_£t
)

	)

574 
	#tsd_tÿch•_g‘
 
	`JEMALLOC_N
(
tsd_tÿch•_g‘
)

	)

575 
	#tsd_th»ad_®loÿ‹d_g‘
 
	`JEMALLOC_N
(
tsd_th»ad_®loÿ‹d_g‘
)

	)

576 
	#tsd_th»ad_®loÿ‹d_£t
 
	`JEMALLOC_N
(
tsd_th»ad_®loÿ‹d_£t
)

	)

577 
	#tsd_th»ad_®loÿ‹dp_g‘
 
	`JEMALLOC_N
(
tsd_th»ad_®loÿ‹dp_g‘
)

	)

578 
	#tsd_th»ad_d—Îoÿ‹d_g‘
 
	`JEMALLOC_N
(
tsd_th»ad_d—Îoÿ‹d_g‘
)

	)

579 
	#tsd_th»ad_d—Îoÿ‹d_£t
 
	`JEMALLOC_N
(
tsd_th»ad_d—Îoÿ‹d_£t
)

	)

580 
	#tsd_th»ad_d—Îoÿ‹dp_g‘
 
	`JEMALLOC_N
(
tsd_th»ad_d—Îoÿ‹dp_g‘
)

	)

581 
	#tsd_s
 
	`JEMALLOC_N
(
tsd_s
)

	)

582 
	#tsd_tsd
 
	`JEMALLOC_N
(
tsd_tsd
)

	)

583 
	#tsd_tsdn
 
	`JEMALLOC_N
(
tsd_tsdn
)

	)

584 
	#tsd_w™Ãss_fÜk_g‘
 
	`JEMALLOC_N
(
tsd_w™Ãss_fÜk_g‘
)

	)

585 
	#tsd_w™Ãss_fÜk_£t
 
	`JEMALLOC_N
(
tsd_w™Ãss_fÜk_£t
)

	)

586 
	#tsd_w™Ãss_fÜkp_g‘
 
	`JEMALLOC_N
(
tsd_w™Ãss_fÜkp_g‘
)

	)

587 
	#tsd_w™Ãs£s_g‘
 
	`JEMALLOC_N
(
tsd_w™Ãs£s_g‘
)

	)

588 
	#tsd_w™Ãs£s_£t
 
	`JEMALLOC_N
(
tsd_w™Ãs£s_£t
)

	)

589 
	#tsd_w™Ãs£¥_g‘
 
	`JEMALLOC_N
(
tsd_w™Ãs£¥_g‘
)

	)

590 
	#tsdn_ãtch
 
	`JEMALLOC_N
(
tsdn_ãtch
)

	)

591 
	#tsdn_nuÎ
 
	`JEMALLOC_N
(
tsdn_nuÎ
)

	)

592 
	#tsdn_tsd
 
	`JEMALLOC_N
(
tsdn_tsd
)

	)

593 
	#u2rz
 
	`JEMALLOC_N
(
u2rz
)

	)

594 
	#v®gršd_ä“like_block
 
	`JEMALLOC_N
(
v®gršd_ä“like_block
)

	)

595 
	#v®gršd_make_mem_defšed
 
	`JEMALLOC_N
(
v®gršd_make_mem_defšed
)

	)

596 
	#v®gršd_make_mem_nßcûss
 
	`JEMALLOC_N
(
v®gršd_make_mem_nßcûss
)

	)

597 
	#v®gršd_make_mem_undefšed
 
	`JEMALLOC_N
(
v®gršd_make_mem_undefšed
)

	)

598 
	#w™Ãss_as£¹_lockËss
 
	`JEMALLOC_N
(
w™Ãss_as£¹_lockËss
)

	)

599 
	#w™Ãss_as£¹_nÙ_owÃr
 
	`JEMALLOC_N
(
w™Ãss_as£¹_nÙ_owÃr
)

	)

600 
	#w™Ãss_as£¹_owÃr
 
	`JEMALLOC_N
(
w™Ãss_as£¹_owÃr
)

	)

601 
	#w™Ãss_fÜk_ş—nup
 
	`JEMALLOC_N
(
w™Ãss_fÜk_ş—nup
)

	)

602 
	#w™Ãss_š™
 
	`JEMALLOC_N
(
w™Ãss_š™
)

	)

603 
	#w™Ãss_lock
 
	`JEMALLOC_N
(
w™Ãss_lock
)

	)

604 
	#w™Ãss_lock_”rÜ
 
	`JEMALLOC_N
(
w™Ãss_lock_”rÜ
)

	)

605 
	#w™Ãss_lockËss_”rÜ
 
	`JEMALLOC_N
(
w™Ãss_lockËss_”rÜ
)

	)

606 
	#w™Ãss_nÙ_owÃr_”rÜ
 
	`JEMALLOC_N
(
w™Ãss_nÙ_owÃr_”rÜ
)

	)

607 
	#w™Ãss_owÃr_”rÜ
 
	`JEMALLOC_N
(
w™Ãss_owÃr_”rÜ
)

	)

608 
	#w™Ãss_po¡fÜk_chd
 
	`JEMALLOC_N
(
w™Ãss_po¡fÜk_chd
)

	)

609 
	#w™Ãss_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
w™Ãss_po¡fÜk_·»Á
)

	)

610 
	#w™Ãss_´efÜk
 
	`JEMALLOC_N
(
w™Ãss_´efÜk
)

	)

611 
	#w™Ãss_uÆock
 
	`JEMALLOC_N
(
w™Ãss_uÆock
)

	)

612 
	#w™Ãs£s_ş—nup
 
	`JEMALLOC_N
(
w™Ãs£s_ş—nup
)

	)

	@dep/jemalloc-4.2.0/include/jemalloc/internal/private_unnamespace.h

1 #undeà
a0d®loc


2 #undeà
a0m®loc


3 #undeà
¬’a_¯Îoc


4 #undeà
¬’a_®loc_junk_sm®l


5 #undeà
¬’a_basic_¡©s_m”ge


6 #undeà
¬’a_bš_šdex


7 #undeà
¬’a_bš_šfo


8 #undeà
¬’a_b™£lm_g‘_cÚ¡


9 #undeà
¬’a_b™£lm_g‘_mubË


10 #undeà
¬’a_boÙ


11 #undeà
¬’a_choo£


12 #undeà
¬’a_choo£_h¬d


13 #undeà
¬’a_choo£_im¶


14 #undeà
¬’a_chunk_®loc_huge


15 #undeà
¬’a_chunk_ÿche_maybe_š£¹


16 #undeà
¬’a_chunk_ÿche_maybe_»move


17 #undeà
¬’a_chunk_d®loc_huge


18 #undeà
¬’a_chunk_¿Îoc_huge_ex·nd


19 #undeà
¬’a_chunk_¿Îoc_huge_shršk


20 #undeà
¬’a_chunk_¿Îoc_huge_sim¬


21 #undeà
¬’a_ş—nup


22 #undeà
¬’a_d®loc


23 #undeà
¬’a_d®loc_bš


24 #undeà
¬’a_d®loc_bš_junked_locked


25 #undeà
¬’a_d®loc_junk_Ïrge


26 #undeà
¬’a_d®loc_junk_sm®l


27 #undeà
¬’a_d®loc_Ïrge


28 #undeà
¬’a_d®loc_Ïrge_junked_locked


29 #undeà
¬’a_d®loc_sm®l


30 #undeà
¬’a_deÿy_tick


31 #undeà
¬’a_deÿy_ticks


32 #undeà
¬’a_deÿy_time_deçuÉ_g‘


33 #undeà
¬’a_deÿy_time_deçuÉ_£t


34 #undeà
¬’a_deÿy_time_g‘


35 #undeà
¬’a_deÿy_time_£t


36 #undeà
¬’a_dss_´ec_g‘


37 #undeà
¬’a_dss_´ec_£t


38 #undeà
¬’a_g‘


39 #undeà
¬’a_ichoo£


40 #undeà
¬’a_š™


41 #undeà
¬’a_lg_dœty_muÉ_deçuÉ_g‘


42 #undeà
¬’a_lg_dœty_muÉ_deçuÉ_£t


43 #undeà
¬’a_lg_dœty_muÉ_g‘


44 #undeà
¬’a_lg_dœty_muÉ_£t


45 #undeà
¬’a_m®loc


46 #undeà
¬’a_m®loc_h¬d


47 #undeà
¬’a_m®loc_Ïrge


48 #undeà
¬’a_m­b™s_®loÿ‹d_g‘


49 #undeà
¬’a_m­b™s_bššd_g‘


50 #undeà
¬’a_m­b™s_decomm™‹d_g‘


51 #undeà
¬’a_m­b™s_dœty_g‘


52 #undeà
¬’a_m­b™s_g‘


53 #undeà
¬’a_m­b™s_š‹º®_£t


54 #undeà
¬’a_m­b™s_Ïrge_bššd_£t


55 #undeà
¬’a_m­b™s_Ïrge_g‘


56 #undeà
¬’a_m­b™s_Ïrge_£t


57 #undeà
¬’a_m­b™s_Ïrge_size_g‘


58 #undeà
¬’a_m­b™s_size_decode


59 #undeà
¬’a_m­b™s_size_’code


60 #undeà
¬’a_m­b™s_sm®l_runšd_g‘


61 #undeà
¬’a_m­b™s_sm®l_£t


62 #undeà
¬’a_m­b™s_uÇÎoÿ‹d_£t


63 #undeà
¬’a_m­b™s_uÇÎoÿ‹d_size_g‘


64 #undeà
¬’a_m­b™s_uÇÎoÿ‹d_size_£t


65 #undeà
¬’a_m­b™s_unz”Ûd_g‘


66 #undeà
¬’a_m­b™¥_g‘_cÚ¡


67 #undeà
¬’a_m­b™¥_g‘_mubË


68 #undeà
¬’a_m­b™¥_»ad


69 #undeà
¬’a_m­b™¥_wr™e


70 #undeà
¬’a_maxrun


71 #undeà
¬’a_maybe_purge


72 #undeà
¬’a_m‘ad©a_®loÿ‹d_add


73 #undeà
¬’a_m‘ad©a_®loÿ‹d_g‘


74 #undeà
¬’a_m‘ad©a_®loÿ‹d_sub


75 #undeà
¬’a_mig¿‹


76 #undeà
¬’a_misûlm_g‘_cÚ¡


77 #undeà
¬’a_misûlm_g‘_mubË


78 #undeà
¬’a_misûlm_to_·gešd


79 #undeà
¬’a_misûlm_to_½ages


80 #undeà
¬’a_Ãw


81 #undeà
¬’a_node_®loc


82 #undeà
¬’a_node_d®loc


83 #undeà
¬’a_Áh»ads_dec


84 #undeà
¬’a_Áh»ads_g‘


85 #undeà
¬’a_Áh»ads_šc


86 #undeà
¬’a_·Îoc


87 #undeà
¬’a_po¡fÜk_chd


88 #undeà
¬’a_po¡fÜk_·»Á


89 #undeà
¬’a_´efÜk0


90 #undeà
¬’a_´efÜk1


91 #undeà
¬’a_´efÜk2


92 #undeà
¬’a_´efÜk3


93 #undeà
¬’a_´of_accum


94 #undeà
¬’a_´of_accum_im¶


95 #undeà
¬’a_´of_accum_locked


96 #undeà
¬’a_´of_´omÙed


97 #undeà
¬’a_´of_tùx_g‘


98 #undeà
¬’a_´of_tùx_»£t


99 #undeà
¬’a_´of_tùx_£t


100 #undeà
¬’a_±r_sm®l_bššd_g‘


101 #undeà
¬’a_purge


102 #undeà
¬’a_qu¬ªtše_junk_sm®l


103 #undeà
¬’a_¿Îoc


104 #undeà
¬’a_¿Îoc_junk_Ïrge


105 #undeà
¬’a_¿Îoc_no_move


106 #undeà
¬’a_rd_to_misûlm


107 #undeà
¬’a_»dzÚe_cÜru±iÚ


108 #undeà
¬’a_»£t


109 #undeà
¬’a_run_»gšd


110 #undeà
¬’a_run_to_misûlm


111 #undeà
¬’a_§Îoc


112 #undeà
¬’a_sd®loc


113 #undeà
¬’a_¡©s_m”ge


114 #undeà
¬’a_tÿche_fl_sm®l


115 #undeà
¬’a_td©a_g‘


116 #undeà
¬’a_td©a_g‘_h¬d


117 #undeà
¬’as


118 #undeà
¬’as_td©a_by·ss_ş—nup


119 #undeà
¬’as_td©a_ş—nup


120 #undeà
©omic_add_p


121 #undeà
©omic_add_u


122 #undeà
©omic_add_ušt32


123 #undeà
©omic_add_ušt64


124 #undeà
©omic_add_z


125 #undeà
©omic_ÿs_p


126 #undeà
©omic_ÿs_u


127 #undeà
©omic_ÿs_ušt32


128 #undeà
©omic_ÿs_ušt64


129 #undeà
©omic_ÿs_z


130 #undeà
©omic_sub_p


131 #undeà
©omic_sub_u


132 #undeà
©omic_sub_ušt32


133 #undeà
©omic_sub_ušt64


134 #undeà
©omic_sub_z


135 #undeà
©omic_wr™e_p


136 #undeà
©omic_wr™e_u


137 #undeà
©omic_wr™e_ušt32


138 #undeà
©omic_wr™e_ušt64


139 #undeà
©omic_wr™e_z


140 #undeà
ba£_®loc


141 #undeà
ba£_boÙ


142 #undeà
ba£_po¡fÜk_chd


143 #undeà
ba£_po¡fÜk_·»Á


144 #undeà
ba£_´efÜk


145 #undeà
ba£_¡©s_g‘


146 #undeà
b™m­_fuÎ


147 #undeà
b™m­_g‘


148 #undeà
b™m­_šfo_š™


149 #undeà
b™m­_š™


150 #undeà
b™m­_£t


151 #undeà
b™m­_sfu


152 #undeà
b™m­_size


153 #undeà
b™m­_un£t


154 #undeà
boÙ¡¿p_ÿÎoc


155 #undeà
boÙ¡¿p_ä“


156 #undeà
boÙ¡¿p_m®loc


157 #undeà
bt_š™


158 #undeà
buã¼Ü


159 #undeà
chunk_®loc_ba£


160 #undeà
chunk_®loc_ÿche


161 #undeà
chunk_®loc_dss


162 #undeà
chunk_®loc_mm­


163 #undeà
chunk_®loc_w¿µ”


164 #undeà
chunk_boÙ


165 #undeà
chunk_d®loc_ÿche


166 #undeà
chunk_d®loc_mm­


167 #undeà
chunk_d®loc_w¿µ”


168 #undeà
chunk_d”egi¡”


169 #undeà
chunk_dss_boÙ


170 #undeà
chunk_dss_po¡fÜk_chd


171 #undeà
chunk_dss_po¡fÜk_·»Á


172 #undeà
chunk_dss_´ec_g‘


173 #undeà
chunk_dss_´ec_£t


174 #undeà
chunk_dss_´efÜk


175 #undeà
chunk_hooks_deçuÉ


176 #undeà
chunk_hooks_g‘


177 #undeà
chunk_hooks_£t


178 #undeà
chunk_š_dss


179 #undeà
chunk_lookup


180 #undeà
chunk_Åages


181 #undeà
chunk_po¡fÜk_chd


182 #undeà
chunk_po¡fÜk_·»Á


183 #undeà
chunk_´efÜk


184 #undeà
chunk_purge_w¿µ”


185 #undeà
chunk_»gi¡”


186 #undeà
chunks_¹»e


187 #undeà
chunksize


188 #undeà
chunksize_mask


189 #undeà
ckh_couÁ


190 #undeà
ckh_d–‘e


191 #undeà
ckh_š£¹


192 #undeà
ckh_™”


193 #undeà
ckh_Ãw


194 #undeà
ckh_poš‹r_hash


195 #undeà
ckh_poš‹r_keycomp


196 #undeà
ckh_»move


197 #undeà
ckh_£¬ch


198 #undeà
ckh_¡ršg_hash


199 #undeà
ckh_¡ršg_keycomp


200 #undeà
ùl_boÙ


201 #undeà
ùl_bymib


202 #undeà
ùl_byÇme


203 #undeà
ùl_Çm‘omib


204 #undeà
ùl_po¡fÜk_chd


205 #undeà
ùl_po¡fÜk_·»Á


206 #undeà
ùl_´efÜk


207 #undeà
deÿy_tick”_g‘


208 #undeà
dss_´ec_Çmes


209 #undeà
ex‹Á_node_achunk_g‘


210 #undeà
ex‹Á_node_achunk_£t


211 #undeà
ex‹Á_node_addr_g‘


212 #undeà
ex‹Á_node_addr_£t


213 #undeà
ex‹Á_node_¬’a_g‘


214 #undeà
ex‹Á_node_¬’a_£t


215 #undeà
ex‹Á_node_comm™‹d_g‘


216 #undeà
ex‹Á_node_comm™‹d_£t


217 #undeà
ex‹Á_node_dœty_š£¹


218 #undeà
ex‹Á_node_dœty_lškage_š™


219 #undeà
ex‹Á_node_dœty_»move


220 #undeà
ex‹Á_node_š™


221 #undeà
ex‹Á_node_´of_tùx_g‘


222 #undeà
ex‹Á_node_´of_tùx_£t


223 #undeà
ex‹Á_node_size_g‘


224 #undeà
ex‹Á_node_size_£t


225 #undeà
ex‹Á_node_z”Ûd_g‘


226 #undeà
ex‹Á_node_z”Ûd_£t


227 #undeà
ex‹Á_Œ“_ad_de¡roy


228 #undeà
ex‹Á_Œ“_ad_de¡roy_»cur£


229 #undeà
ex‹Á_Œ“_ad_em±y


230 #undeà
ex‹Á_Œ“_ad_fœ¡


231 #undeà
ex‹Á_Œ“_ad_š£¹


232 #undeà
ex‹Á_Œ“_ad_™”


233 #undeà
ex‹Á_Œ“_ad_™”_»cur£


234 #undeà
ex‹Á_Œ“_ad_™”_¡¬t


235 #undeà
ex‹Á_Œ“_ad_Ï¡


236 #undeà
ex‹Á_Œ“_ad_Ãw


237 #undeà
ex‹Á_Œ“_ad_Ãxt


238 #undeà
ex‹Á_Œ“_ad_n£¬ch


239 #undeà
ex‹Á_Œ“_ad_´ev


240 #undeà
ex‹Á_Œ“_ad_p£¬ch


241 #undeà
ex‹Á_Œ“_ad_»move


242 #undeà
ex‹Á_Œ“_ad_»v”£_™”


243 #undeà
ex‹Á_Œ“_ad_»v”£_™”_»cur£


244 #undeà
ex‹Á_Œ“_ad_»v”£_™”_¡¬t


245 #undeà
ex‹Á_Œ“_ad_£¬ch


246 #undeà
ex‹Á_Œ“_szad_de¡roy


247 #undeà
ex‹Á_Œ“_szad_de¡roy_»cur£


248 #undeà
ex‹Á_Œ“_szad_em±y


249 #undeà
ex‹Á_Œ“_szad_fœ¡


250 #undeà
ex‹Á_Œ“_szad_š£¹


251 #undeà
ex‹Á_Œ“_szad_™”


252 #undeà
ex‹Á_Œ“_szad_™”_»cur£


253 #undeà
ex‹Á_Œ“_szad_™”_¡¬t


254 #undeà
ex‹Á_Œ“_szad_Ï¡


255 #undeà
ex‹Á_Œ“_szad_Ãw


256 #undeà
ex‹Á_Œ“_szad_Ãxt


257 #undeà
ex‹Á_Œ“_szad_n£¬ch


258 #undeà
ex‹Á_Œ“_szad_´ev


259 #undeà
ex‹Á_Œ“_szad_p£¬ch


260 #undeà
ex‹Á_Œ“_szad_»move


261 #undeà
ex‹Á_Œ“_szad_»v”£_™”


262 #undeà
ex‹Á_Œ“_szad_»v”£_™”_»cur£


263 #undeà
ex‹Á_Œ“_szad_»v”£_™”_¡¬t


264 #undeà
ex‹Á_Œ“_szad_£¬ch


265 #undeà
ffs_Îu


266 #undeà
ffs_lu


267 #undeà
ffs_u


268 #undeà
ffs_u32


269 #undeà
ffs_u64


270 #undeà
ffs_zu


271 #undeà
g‘_”ºo


272 #undeà
hash


273 #undeà
hash_fmix_32


274 #undeà
hash_fmix_64


275 #undeà
hash_g‘_block_32


276 #undeà
hash_g‘_block_64


277 #undeà
hash_rÙl_32


278 #undeà
hash_rÙl_64


279 #undeà
hash_x64_128


280 #undeà
hash_x86_128


281 #undeà
hash_x86_32


282 #undeà
huge_¯Îoc


283 #undeà
huge_d®loc


284 #undeà
huge_d®loc_junk


285 #undeà
huge_m®loc


286 #undeà
huge_·Îoc


287 #undeà
huge_´of_tùx_g‘


288 #undeà
huge_´of_tùx_»£t


289 #undeà
huge_´of_tùx_£t


290 #undeà
huge_¿Îoc


291 #undeà
huge_¿Îoc_no_move


292 #undeà
huge_§Îoc


293 #undeà
Ÿ®loc


294 #undeà
ŸÎoc


295 #undeà
ŸÎocztm


296 #undeà
Ÿ»Ç_ş—nup


297 #undeà
id®loc


298 #undeà
id®loùm


299 #undeà
š_v®gršd


300 #undeà
šdex2size


301 #undeà
šdex2size_compu‹


302 #undeà
šdex2size_lookup


303 #undeà
šdex2size_b


304 #undeà
®loc


305 #undeà
®loù


306 #undeà
®locztm


307 #undeà
iq®loc


308 #undeà
œ®loc


309 #undeà
œ®loù


310 #undeà
œ®loù_»®ign


311 #undeà
i§Îoc


312 #undeà
isd®loù


313 #undeà
isq®loc


314 #undeà
i¡h»aded


315 #undeà
iv§Îoc


316 #undeà
ix®loc


317 #undeà
jem®loc_po¡fÜk_chd


318 #undeà
jem®loc_po¡fÜk_·»Á


319 #undeà
jem®loc_´efÜk


320 #undeà
Ïrge_maxşass


321 #undeà
lg_æoÜ


322 #undeà
lg_´of_§m¶e


323 #undeà
m®loc_ırštf


324 #undeà
m®loc_mu‹x_as£¹_nÙ_owÃr


325 #undeà
m®loc_mu‹x_as£¹_owÃr


326 #undeà
m®loc_mu‹x_boÙ


327 #undeà
m®loc_mu‹x_š™


328 #undeà
m®loc_mu‹x_lock


329 #undeà
m®loc_mu‹x_po¡fÜk_chd


330 #undeà
m®loc_mu‹x_po¡fÜk_·»Á


331 #undeà
m®loc_mu‹x_´efÜk


332 #undeà
m®loc_mu‹x_uÆock


333 #undeà
m®loc_´štf


334 #undeà
m®loc_¢´štf


335 #undeà
m®loc_¡¹oumax


336 #undeà
m®loc_tsd_boÙ0


337 #undeà
m®loc_tsd_boÙ1


338 #undeà
m®loc_tsd_ş—nup_»gi¡”


339 #undeà
m®loc_tsd_d®loc


340 #undeà
m®loc_tsd_m®loc


341 #undeà
m®loc_tsd_no_ş—nup


342 #undeà
m®loc_vırštf


343 #undeà
m®loc_v¢´štf


344 #undeà
m®loc_wr™e


345 #undeà
m­_bŸs


346 #undeà
m­_misc_off£t


347 #undeà
mb_wr™e


348 #undeà
Ç»Çs_auto


349 #undeà
Ç»Çs_td©a_ş—nup


350 #undeà
Ç»Çs_tÙ®_g‘


351 #undeà
nıus


352 #undeà
nhbšs


353 #undeà
nhşas£s


354 #undeà
Æşas£s


355 #undeà
n¡ime_add


356 #undeà
n¡ime_com·»


357 #undeà
n¡ime_cİy


358 #undeà
n¡ime_divide


359 #undeà
n¡ime_idivide


360 #undeà
n¡ime_imuÉly


361 #undeà
n¡ime_š™


362 #undeà
n¡ime_š™2


363 #undeà
n¡ime_ns


364 #undeà
n¡ime_n£c


365 #undeà
n¡ime_£c


366 #undeà
n¡ime_subŒaù


367 #undeà
n¡ime_upd©e


368 #undeà
İt_abÜt


369 #undeà
İt_deÿy_time


370 #undeà
İt_dss


371 #undeà
İt_junk


372 #undeà
İt_junk_®loc


373 #undeà
İt_junk_ä“


374 #undeà
İt_lg_chunk


375 #undeà
İt_lg_dœty_muÉ


376 #undeà
İt_lg_´of_š‹rv®


377 #undeà
İt_lg_´of_§m¶e


378 #undeà
İt_lg_tÿche_max


379 #undeà
İt_Ç»Çs


380 #undeà
İt_´of


381 #undeà
İt_´of_accum


382 #undeà
İt_´of_aùive


383 #undeà
İt_´of_fš®


384 #undeà
İt_´of_gdump


385 #undeà
İt_´of_Ëak


386 #undeà
İt_´of_´efix


387 #undeà
İt_´of_th»ad_aùive_š™


388 #undeà
İt_purge


389 #undeà
İt_qu¬ªtše


390 #undeà
İt_»dzÚe


391 #undeà
İt_¡©s_´št


392 #undeà
İt_tÿche


393 #undeà
İt_uŒaû


394 #undeà
İt_xm®loc


395 #undeà
İt_z”o


396 #undeà
p2rz


397 #undeà
·ges_boÙ


398 #undeà
·ges_comm™


399 #undeà
·ges_decomm™


400 #undeà
·ges_m­


401 #undeà
·ges_purge


402 #undeà
·ges_Œim


403 #undeà
·ges_unm­


404 #undeà
pow2_û_u32


405 #undeà
pow2_û_u64


406 #undeà
pow2_û_zu


407 #undeà
´ng_lg_¿nge


408 #undeà
´ng_¿nge


409 #undeà
´of_aùive


410 #undeà
´of_aùive_g‘


411 #undeà
´of_aùive_g‘_uÆocked


412 #undeà
´of_aùive_£t


413 #undeà
´of_®loc_´•


414 #undeà
´of_®loc_rŞlback


415 #undeà
´of_backŒaû


416 #undeà
´of_boÙ0


417 #undeà
´of_boÙ1


418 #undeà
´of_boÙ2


419 #undeà
´of_bt_couÁ


420 #undeà
´of_dump_h—d”


421 #undeà
´of_dump_İ’


422 #undeà
´of_ä“


423 #undeà
´of_ä“_§m¶ed_objeù


424 #undeà
´of_gdump


425 #undeà
´of_gdump_g‘


426 #undeà
´of_gdump_g‘_uÆocked


427 #undeà
´of_gdump_£t


428 #undeà
´of_gdump_v®


429 #undeà
´of_idump


430 #undeà
´of_š‹rv®


431 #undeà
´of_lookup


432 #undeà
´of_m®loc


433 #undeà
´of_m®loc_§m¶e_objeù


434 #undeà
´of_mdump


435 #undeà
´of_po¡fÜk_chd


436 #undeà
´of_po¡fÜk_·»Á


437 #undeà
´of_´efÜk0


438 #undeà
´of_´efÜk1


439 #undeà
´of_»®loc


440 #undeà
´of_»£t


441 #undeà
´of_§m¶e_accum_upd©e


442 #undeà
´of_§m¶e_th»shŞd_upd©e


443 #undeà
´of_tùx_g‘


444 #undeà
´of_tùx_»£t


445 #undeà
´of_tùx_£t


446 #undeà
´of_td©a_ş—nup


447 #undeà
´of_td©a_couÁ


448 #undeà
´of_td©a_g‘


449 #undeà
´of_td©a_š™


450 #undeà
´of_td©a_»š™


451 #undeà
´of_th»ad_aùive_g‘


452 #undeà
´of_th»ad_aùive_š™_g‘


453 #undeà
´of_th»ad_aùive_š™_£t


454 #undeà
´of_th»ad_aùive_£t


455 #undeà
´of_th»ad_Çme_g‘


456 #undeà
´of_th»ad_Çme_£t


457 #undeà
purge_mode_Çmes


458 #undeà
qu¬ªtše


459 #undeà
qu¬ªtše_®loc_hook


460 #undeà
qu¬ªtše_®loc_hook_wÜk


461 #undeà
qu¬ªtše_ş—nup


462 #undeà
»gi¡”_zÚe


463 #undeà
¹»e_chd_»ad


464 #undeà
¹»e_chd_»ad_h¬d


465 #undeà
¹»e_chd_Œy»ad


466 #undeà
¹»e_d–‘e


467 #undeà
¹»e_g‘


468 #undeà
¹»e_Ãw


469 #undeà
¹»e_node_v®id


470 #undeà
¹»e_£t


471 #undeà
¹»e_¡¬t_Ëv–


472 #undeà
¹»e_subkey


473 #undeà
¹»e_subŒ“_»ad


474 #undeà
¹»e_subŒ“_»ad_h¬d


475 #undeà
¹»e_subŒ“_Œy»ad


476 #undeà
¹»e_v®_»ad


477 #undeà
¹»e_v®_wr™e


478 #undeà
run_quªtize_û


479 #undeà
run_quªtize_æoÜ


480 #undeà
run_quªtize_max


481 #undeà
s2u


482 #undeà
s2u_compu‹


483 #undeà
s2u_lookup


484 #undeà
§2u


485 #undeà
£t_”ºo


486 #undeà
size2šdex


487 #undeà
size2šdex_compu‹


488 #undeà
size2šdex_lookup


489 #undeà
size2šdex_b


490 #undeà
¡©s_ÿùive


491 #undeà
¡©s_ÿùive_add


492 #undeà
¡©s_ÿùive_g‘


493 #undeà
¡©s_ÿùive_sub


494 #undeà
¡©s_´št


495 #undeà
tÿche_®loc_—sy


496 #undeà
tÿche_®loc_Ïrge


497 #undeà
tÿche_®loc_sm®l


498 #undeà
tÿche_®loc_sm®l_h¬d


499 #undeà
tÿche_¬’a_»assocŸ‹


500 #undeà
tÿche_bš_æush_Ïrge


501 #undeà
tÿche_bš_æush_sm®l


502 #undeà
tÿche_bš_šfo


503 #undeà
tÿche_boÙ


504 #undeà
tÿche_ş—nup


505 #undeà
tÿche_ü—‹


506 #undeà
tÿche_d®loc_Ïrge


507 #undeà
tÿche_d®loc_sm®l


508 #undeà
tÿche_’abËd_ş—nup


509 #undeà
tÿche_’abËd_g‘


510 #undeà
tÿche_’abËd_£t


511 #undeà
tÿche_ev’t


512 #undeà
tÿche_ev’t_h¬d


513 #undeà
tÿche_æush


514 #undeà
tÿche_g‘


515 #undeà
tÿche_g‘_h¬d


516 #undeà
tÿche_maxşass


517 #undeà
tÿche_§Îoc


518 #undeà
tÿche_¡©s_m”ge


519 #undeà
tÿches


520 #undeà
tÿches_ü—‹


521 #undeà
tÿches_de¡roy


522 #undeà
tÿches_æush


523 #undeà
tÿches_g‘


524 #undeà
th»ad_®loÿ‹d_ş—nup


525 #undeà
th»ad_d—Îoÿ‹d_ş—nup


526 #undeà
tick”_cİy


527 #undeà
tick”_š™


528 #undeà
tick”_»ad


529 #undeà
tick”_tick


530 #undeà
tick”_ticks


531 #undeà
tsd_¬’a_g‘


532 #undeà
tsd_¬’a_£t


533 #undeà
tsd_¬’­_g‘


534 #undeà
tsd_¬’as_td©a_by·ss_g‘


535 #undeà
tsd_¬’as_td©a_by·ss_£t


536 #undeà
tsd_¬’as_td©a_by·s¥_g‘


537 #undeà
tsd_¬’as_td©a_g‘


538 #undeà
tsd_¬’as_td©a_£t


539 #undeà
tsd_¬’as_td©­_g‘


540 #undeà
tsd_boÙ


541 #undeà
tsd_boÙ0


542 #undeà
tsd_boÙ1


543 #undeà
tsd_boÙed


544 #undeà
tsd_boÙed_g‘


545 #undeà
tsd_ş—nup


546 #undeà
tsd_ş—nup_w¿µ”


547 #undeà
tsd_ãtch


548 #undeà
tsd_g‘


549 #undeà
tsd_Ÿ»Ç_g‘


550 #undeà
tsd_Ÿ»Ç_£t


551 #undeà
tsd_Ÿ»Çp_g‘


552 #undeà
tsd_š™Ÿlized


553 #undeà
tsd_š™_check_»cursiÚ


554 #undeà
tsd_š™_fšish


555 #undeà
tsd_š™_h—d


556 #undeà
tsd_Ç»Çs_td©a_g‘


557 #undeà
tsd_Ç»Çs_td©a_£t


558 #undeà
tsd_Ç»Çs_td©­_g‘


559 #undeà
tsd_w¿µ”_g‘


560 #undeà
tsd_w¿µ”_£t


561 #undeà
tsd_nomš®


562 #undeà
tsd_´of_td©a_g‘


563 #undeà
tsd_´of_td©a_£t


564 #undeà
tsd_´of_td©­_g‘


565 #undeà
tsd_qu¬ªtše_g‘


566 #undeà
tsd_qu¬ªtše_£t


567 #undeà
tsd_qu¬ªtš•_g‘


568 #undeà
tsd_£t


569 #undeà
tsd_tÿche_’abËd_g‘


570 #undeà
tsd_tÿche_’abËd_£t


571 #undeà
tsd_tÿche_’abËdp_g‘


572 #undeà
tsd_tÿche_g‘


573 #undeà
tsd_tÿche_£t


574 #undeà
tsd_tÿch•_g‘


575 #undeà
tsd_th»ad_®loÿ‹d_g‘


576 #undeà
tsd_th»ad_®loÿ‹d_£t


577 #undeà
tsd_th»ad_®loÿ‹dp_g‘


578 #undeà
tsd_th»ad_d—Îoÿ‹d_g‘


579 #undeà
tsd_th»ad_d—Îoÿ‹d_£t


580 #undeà
tsd_th»ad_d—Îoÿ‹dp_g‘


581 #undeà
tsd_s


582 #undeà
tsd_tsd


583 #undeà
tsd_tsdn


584 #undeà
tsd_w™Ãss_fÜk_g‘


585 #undeà
tsd_w™Ãss_fÜk_£t


586 #undeà
tsd_w™Ãss_fÜkp_g‘


587 #undeà
tsd_w™Ãs£s_g‘


588 #undeà
tsd_w™Ãs£s_£t


589 #undeà
tsd_w™Ãs£¥_g‘


590 #undeà
tsdn_ãtch


591 #undeà
tsdn_nuÎ


592 #undeà
tsdn_tsd


593 #undeà
u2rz


594 #undeà
v®gršd_ä“like_block


595 #undeà
v®gršd_make_mem_defšed


596 #undeà
v®gršd_make_mem_nßcûss


597 #undeà
v®gršd_make_mem_undefšed


598 #undeà
w™Ãss_as£¹_lockËss


599 #undeà
w™Ãss_as£¹_nÙ_owÃr


600 #undeà
w™Ãss_as£¹_owÃr


601 #undeà
w™Ãss_fÜk_ş—nup


602 #undeà
w™Ãss_š™


603 #undeà
w™Ãss_lock


604 #undeà
w™Ãss_lock_”rÜ


605 #undeà
w™Ãss_lockËss_”rÜ


606 #undeà
w™Ãss_nÙ_owÃr_”rÜ


607 #undeà
w™Ãss_owÃr_”rÜ


608 #undeà
w™Ãss_po¡fÜk_chd


609 #undeà
w™Ãss_po¡fÜk_·»Á


610 #undeà
w™Ãss_´efÜk


611 #undeà
w™Ãss_uÆock


612 #undeà
w™Ãs£s_ş—nup


	@dep/jemalloc-4.2.0/include/jemalloc/internal/prng.h

2 #ifdeà
JEMALLOC_H_TYPES


22 
	#PRNG_A
 
	`UINT64_C
(6364136223846793005)

	)

23 
	#PRNG_C
 
	`UINT64_C
(1442695040888963407)

	)

27 #ifdeà
JEMALLOC_H_STRUCTS


31 #ifdeà
JEMALLOC_H_EXTERNS


35 #ifdeà
JEMALLOC_H_INLINES


37 #iâdeà
JEMALLOC_ENABLE_INLINE


38 
ušt64_t
 
´ng_lg_¿nge
(ušt64_ˆ*
¡©e
, 
lg_¿nge
);

39 
ušt64_t
 
´ng_¿nge
(ušt64_ˆ*
¡©e
, ušt64_ˆ
¿nge
);

42 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_PRNG_C_
))

43 
JEMALLOC_ALWAYS_INLINE
 
ušt64_t


44 
	$´ng_lg_¿nge
(
ušt64_t
 *
¡©e
, 
lg_¿nge
)

46 
ušt64_t
 
»t
;

48 
	`as£¹
(
lg_¿nge
 > 0);

49 
	`as£¹
(
lg_¿nge
 <= 64);

51 
»t
 = (*
¡©e
 * 
PRNG_A
è+ 
PRNG_C
;

52 *
¡©e
 = 
»t
;

53 
»t
 >>ğ(64 - 
lg_¿nge
);

55  (
»t
);

56 
	}
}

58 
JEMALLOC_ALWAYS_INLINE
 
ušt64_t


59 
	$´ng_¿nge
(
ušt64_t
 *
¡©e
, ušt64_ˆ
¿nge
)

61 
ušt64_t
 
»t
;

62 
lg_¿nge
;

64 
	`as£¹
(
¿nge
 > 1);

67 
lg_¿nge
 = 
	`ffs_u64
(
	`pow2_û_u64
(
¿nge
)) - 1;

71 
»t
 = 
	`´ng_lg_¿nge
(
¡©e
, 
lg_¿nge
);

72 } 
»t
 >ğ
¿nge
);

74  (
»t
);

75 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/prof.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
´of_bt_s
 
	t´of_bt_t
;

5 
´of_út_s
 
	t´of_út_t
;

6 
´of_tùx_s
 
	t´of_tùx_t
;

7 
´of_gùx_s
 
	t´of_gùx_t
;

8 
´of_td©a_s
 
	t´of_td©a_t
;

11 #ifdeà
JEMALLOC_PROF


12 
	#PROF_PREFIX_DEFAULT
 "j•rof"

	)

14 
	#PROF_PREFIX_DEFAULT
 ""

	)

16 
	#LG_PROF_SAMPLE_DEFAULT
 19

	)

17 
	#LG_PROF_INTERVAL_DEFAULT
 -1

	)

24 
	#PROF_BT_MAX
 128

	)

27 
	#PROF_CKH_MINITEMS
 64

	)

30 
	#PROF_DUMP_BUFSIZE
 65536

	)

33 
	#PROF_PRINTF_BUFSIZE
 128

	)

39 
	#PROF_NCTX_LOCKS
 1024

	)

45 
	#PROF_NTDATA_LOCKS
 256

	)

51 
	#PROF_TDATA_STATE_REINCARNATED
 ((
´of_td©a_t
 *)(
ušŒ_t
)1)

	)

52 
	#PROF_TDATA_STATE_PURGATORY
 ((
´of_td©a_t
 *)(
ušŒ_t
)2)

	)

53 
	#PROF_TDATA_STATE_MAX
 
PROF_TDATA_STATE_PURGATORY


	)

57 #ifdeà
JEMALLOC_H_STRUCTS


59 
	s´of_bt_s
 {

61 **
	mvec
;

62 
	mËn
;

65 #ifdeà
JEMALLOC_PROF_LIBGCC


68 
´of_bt_t
 *
	mbt
;

69 
	mmax
;

70 } 
	t´of_unwšd_d©a_t
;

73 
	s´of_út_s
 {

75 
ušt64_t
 
	mcurobjs
;

76 
ušt64_t
 
	mcurby‹s
;

77 
ušt64_t
 
	maccumobjs
;

78 
ušt64_t
 
	maccumby‹s
;

82 
	m´of_tùx_¡©e_š™Ÿlizšg
,

83 
	m´of_tùx_¡©e_nomš®
,

84 
	m´of_tùx_¡©e_dumpšg
,

85 
	m´of_tùx_¡©e_purg©Üy


86 } 
	t´of_tùx_¡©e_t
;

88 
	s´of_tùx_s
 {

90 
´of_td©a_t
 *
	mtd©a
;

96 
ušt64_t
 
	mthr_uid
;

97 
ušt64_t
 
	mthr_disüim
;

100 
´of_út_t
 
	múts
;

103 
´of_gùx_t
 *
	mgùx
;

118 
ušt64_t
 
	mtùx_uid
;

121 
rb_node
(
´of_tùx_t
è
	mtùx_lšk
;

127 
boŞ
 
	m´•¬ed
;

130 
´of_tùx_¡©e_t
 
	m¡©e
;

136 
´of_út_t
 
	mdump_úts
;

138 
	$rb_Œ“
(
	t´of_tùx_t
è
	t´of_tùx_Œ“_t
;

140 
	s´of_gùx_s
 {

142 
m®loc_mu‹x_t
 *
lock
;

154 
Æimbo
;

160 
´of_tùx_Œ“_t
 
tùxs
;

163 
	`rb_node
(
´of_gùx_t
è
dump_lšk
;

166 
´of_út_t
 
út_summed
;

169 
´of_bt_t
 
bt
;

172 *
vec
[1];

174 
	$rb_Œ“
(
	t´of_gùx_t
è
	t´of_gùx_Œ“_t
;

176 
	s´of_td©a_s
 {

177 
m®loc_mu‹x_t
 *
lock
;

180 
ušt64_t
 
thr_uid
;

186 
ušt64_t
 
thr_disüim
;

189 *
th»ad_Çme
;

191 
boŞ
 
©ched
;

192 
boŞ
 
expœed
;

194 
	`rb_node
(
´of_td©a_t
è
td©a_lšk
;

201 
ušt64_t
 
tùx_uid_Ãxt
;

209 
ckh_t
 
bt2tùx
;

212 
ušt64_t
 
´ng_¡©e
;

213 
ušt64_t
 
by‹s_uÁ_§m¶e
;

216 
boŞ
 
’q
;

217 
boŞ
 
’q_idump
;

218 
boŞ
 
’q_gdump
;

226 
boŞ
 
dumpšg
;

232 
boŞ
 
aùive
;

235 
´of_út_t
 
út_summed
;

238 *
vec
[
PROF_BT_MAX
];

240 
	$rb_Œ“
(
	t´of_td©a_t
è
	t´of_td©a_Œ“_t
;

244 #ifdeà
JEMALLOC_H_EXTERNS


246 
boŞ
 
İt_´of
;

247 
boŞ
 
İt_´of_aùive
;

248 
boŞ
 
İt_´of_th»ad_aùive_š™
;

249 
size_t
 
İt_lg_´of_§m¶e
;

250 
ssize_t
 
İt_lg_´of_š‹rv®
;

251 
boŞ
 
İt_´of_gdump
;

252 
boŞ
 
İt_´of_fš®
;

253 
boŞ
 
İt_´of_Ëak
;

254 
boŞ
 
İt_´of_accum
;

255 
İt_´of_´efix
[

257 #ifdeà
JEMALLOC_PROF


258 
PATH_MAX
 +

263 
boŞ
 
´of_aùive
;

266 
boŞ
 
´of_gdump_v®
;

275 
ušt64_t
 
´of_š‹rv®
;

281 
size_t
 
lg_´of_§m¶e
;

283 
	`´of_®loc_rŞlback
(
tsd_t
 *
tsd
, 
´of_tùx_t
 *
tùx
, 
boŞ
 
upd©ed
);

284 
	`´of_m®loc_§m¶e_objeù
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
,

285 
´of_tùx_t
 *
tùx
);

286 
	`´of_ä“_§m¶ed_objeù
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
);

287 
	`bt_š™
(
´of_bt_t
 *
bt
, **
vec
);

288 
	`´of_backŒaû
(
´of_bt_t
 *
bt
);

289 
´of_tùx_t
 *
	`´of_lookup
(
tsd_t
 *
tsd
, 
´of_bt_t
 *
bt
);

290 #ifdeà
JEMALLOC_JET


291 
size_t
 
	`´of_td©a_couÁ
();

292 
size_t
 
	`´of_bt_couÁ
();

293 cÚ¡ 
´of_út_t
 *
	`´of_út_®l
();

294 (
	t´of_dump_İ’_t
)(
	tboŞ
, const *);

295 
´of_dump_İ’_t
 *
´of_dump_İ’
;

296 
	$boŞ
 (
	t´of_dump_h—d”_t
)(
	ttsdn_t
 *, 
	tboŞ
, cÚ¡ 
	t´of_út_t
 *);

297 
´of_dump_h—d”_t
 *
´of_dump_h—d”
;

299 
	`´of_idump
(
tsdn_t
 *
tsdn
);

300 
boŞ
 
	`´of_mdump
(
tsd_t
 *
tsd
, cÚ¡ *
f’ame
);

301 
	`´of_gdump
(
tsdn_t
 *
tsdn
);

302 
´of_td©a_t
 *
	`´of_td©a_š™
(
tsdn_t
 *
tsdn
);

303 
´of_td©a_t
 *
	`´of_td©a_»š™
(
tsd_t
 *
tsd
,…rof_td©a_ˆ*
td©a
);

304 
	`´of_»£t
(
tsdn_t
 *
tsdn
, 
size_t
 
lg_§m¶e
);

305 
	`´of_td©a_ş—nup
(
tsd_t
 *
tsd
);

306 
boŞ
 
	`´of_aùive_g‘
(
tsdn_t
 *
tsdn
);

307 
boŞ
 
	`´of_aùive_£t
(
tsdn_t
 *
tsdn
, boŞ 
aùive
);

308 cÚ¡ *
	`´of_th»ad_Çme_g‘
(
tsd_t
 *
tsd
);

309 
	`´of_th»ad_Çme_£t
(
tsd_t
 *
tsd
, cÚ¡ *
th»ad_Çme
);

310 
boŞ
 
	`´of_th»ad_aùive_g‘
(
tsd_t
 *
tsd
);

311 
boŞ
 
	`´of_th»ad_aùive_£t
(
tsd_t
 *
tsd
, boŞ 
aùive
);

312 
boŞ
 
	`´of_th»ad_aùive_š™_g‘
(
tsdn_t
 *
tsdn
);

313 
boŞ
 
	`´of_th»ad_aùive_š™_£t
(
tsdn_t
 *
tsdn
, boŞ 
aùive_š™
);

314 
boŞ
 
	`´of_gdump_g‘
(
tsdn_t
 *
tsdn
);

315 
boŞ
 
	`´of_gdump_£t
(
tsdn_t
 *
tsdn
, boŞ 
aùive
);

316 
	`´of_boÙ0
();

317 
	`´of_boÙ1
();

318 
boŞ
 
	`´of_boÙ2
(
tsdn_t
 *
tsdn
);

319 
	`´of_´efÜk0
(
tsdn_t
 *
tsdn
);

320 
	`´of_´efÜk1
(
tsdn_t
 *
tsdn
);

321 
	`´of_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
);

322 
	`´of_po¡fÜk_chd
(
tsdn_t
 *
tsdn
);

323 
	`´of_§m¶e_th»shŞd_upd©e
(
´of_td©a_t
 *
td©a
);

327 #ifdeà
JEMALLOC_H_INLINES


329 #iâdeà
JEMALLOC_ENABLE_INLINE


330 
boŞ
 
	`´of_aùive_g‘_uÆocked
();

331 
boŞ
 
	`´of_gdump_g‘_uÆocked
();

332 
´of_td©a_t
 *
	`´of_td©a_g‘
(
tsd_t
 *
tsd
, 
boŞ
 
ü—‹
);

333 
´of_tùx_t
 *
	`´of_tùx_g‘
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
);

334 
	`´of_tùx_£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
,

335 
´of_tùx_t
 *
tùx
);

336 
	`´of_tùx_»£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
,

337 cÚ¡ *
Şd_±r
, 
´of_tùx_t
 *
tùx
);

338 
boŞ
 
	`´of_§m¶e_accum_upd©e
(
tsd_t
 *
tsd
, 
size_t
 
usize
, boŞ 
comm™
,

339 
´of_td©a_t
 **
td©a_out
);

340 
´of_tùx_t
 *
	`´of_®loc_´•
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
boŞ
 
´of_aùive
,

341 
boŞ
 
upd©e
);

342 
	`´of_m®loc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
,

343 
´of_tùx_t
 *
tùx
);

344 
	`´of_»®loc
(
tsd_t
 *
tsd
, cÚ¡ *
±r
, 
size_t
 
usize
,

345 
´of_tùx_t
 *
tùx
, 
boŞ
 
´of_aùive
, boŞ 
upd©ed
, cÚ¡ *
Şd_±r
,

346 
size_t
 
Şd_usize
, 
´of_tùx_t
 *
Şd_tùx
);

347 
	`´of_ä“
(
tsd_t
 *
tsd
, cÚ¡ *
±r
, 
size_t
 
usize
);

350 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_PROF_C_
))

351 
JEMALLOC_ALWAYS_INLINE
 
boŞ


352 
	$´of_aùive_g‘_uÆocked
()

361  (
´of_aùive
);

362 
	}
}

364 
JEMALLOC_ALWAYS_INLINE
 
boŞ


365 
	$´of_gdump_g‘_uÆocked
()

373  (
´of_gdump_v®
);

374 
	}
}

376 
JEMALLOC_ALWAYS_INLINE
 
´of_td©a_t
 *

377 
	$´of_td©a_g‘
(
tsd_t
 *
tsd
, 
boŞ
 
ü—‹
)

379 
´of_td©a_t
 *
td©a
;

381 
	`ÿs£¹
(
cÚfig_´of
);

383 
td©a
 = 
	`tsd_´of_td©a_g‘
(
tsd
);

384 ià(
ü—‹
) {

385 ià(
	`uÆik–y
(
td©a
 =ğ
NULL
)) {

386 ià(
	`tsd_nomš®
(
tsd
)) {

387 
td©a
 = 
	`´of_td©a_š™
(
	`tsd_tsdn
(
tsd
));

388 
	`tsd_´of_td©a_£t
(
tsd
, 
td©a
);

390 } ià(
	`uÆik–y
(
td©a
->
expœed
)) {

391 
td©a
 = 
	`´of_td©a_»š™
(
tsd
,data);

392 
	`tsd_´of_td©a_£t
(
tsd
, 
td©a
);

394 
	`as£¹
(
td©a
 =ğ
NULL
 ||d©a->
©ched
);

397  (
td©a
);

398 
	}
}

400 
JEMALLOC_ALWAYS_INLINE
 
´of_tùx_t
 *

401 
	$´of_tùx_g‘
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
)

404 
	`ÿs£¹
(
cÚfig_´of
);

405 
	`as£¹
(
±r
 !ğ
NULL
);

407  (
	`¬’a_´of_tùx_g‘
(
tsdn
, 
±r
));

408 
	}
}

410 
JEMALLOC_ALWAYS_INLINE
 

411 
	$´of_tùx_£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

414 
	`ÿs£¹
(
cÚfig_´of
);

415 
	`as£¹
(
±r
 !ğ
NULL
);

417 
	`¬’a_´of_tùx_£t
(
tsdn
, 
±r
, 
usize
, 
tùx
);

418 
	}
}

420 
JEMALLOC_ALWAYS_INLINE
 

421 
	$´of_tùx_»£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
, cÚ¡ *
Şd_±r
,

422 
´of_tùx_t
 *
Şd_tùx
)

425 
	`ÿs£¹
(
cÚfig_´of
);

426 
	`as£¹
(
±r
 !ğ
NULL
);

428 
	`¬’a_´of_tùx_»£t
(
tsdn
, 
±r
, 
usize
, 
Şd_±r
, 
Şd_tùx
);

429 
	}
}

431 
JEMALLOC_ALWAYS_INLINE
 
boŞ


432 
	$´of_§m¶e_accum_upd©e
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
boŞ
 
upd©e
,

433 
´of_td©a_t
 **
td©a_out
)

435 
´of_td©a_t
 *
td©a
;

437 
	`ÿs£¹
(
cÚfig_´of
);

439 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

440 ià(
	`uÆik–y
((
ušŒ_t
)
td©a
 <ğ(ušŒ_t)
PROF_TDATA_STATE_MAX
))

441 
td©a
 = 
NULL
;

443 ià(
td©a_out
 !ğ
NULL
)

444 *
td©a_out
 = 
td©a
;

446 ià(
	`uÆik–y
(
td©a
 =ğ
NULL
))

447  (
Œue
);

449 ià(
	`lik–y
(
td©a
->
by‹s_uÁ_§m¶e
 >ğ
usize
)) {

450 ià(
upd©e
)

451 
td©a
->
by‹s_uÁ_§m¶e
 -ğ
usize
;

452  (
Œue
);

455 ià(
upd©e
)

456 
	`´of_§m¶e_th»shŞd_upd©e
(
td©a
);

457  (!
td©a
->
aùive
);

459 
	}
}

461 
JEMALLOC_ALWAYS_INLINE
 
´of_tùx_t
 *

462 
	$´of_®loc_´•
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
boŞ
 
´of_aùive
, boŞ 
upd©e
)

464 
´of_tùx_t
 *
»t
;

465 
´of_td©a_t
 *
td©a
;

466 
´of_bt_t
 
bt
;

468 
	`as£¹
(
usize
 =ğ
	`s2u
(usize));

470 ià(!
´of_aùive
 || 
	`lik–y
(
	`´of_§m¶e_accum_upd©e
(
tsd
, 
usize
, 
upd©e
,

471 &
td©a
)))

472 
»t
 = (
´of_tùx_t
 *)(
ušŒ_t
)1U;

474 
	`bt_š™
(&
bt
, 
td©a
->
vec
);

475 
	`´of_backŒaû
(&
bt
);

476 
»t
 = 
	`´of_lookup
(
tsd
, &
bt
);

479  (
»t
);

480 
	}
}

482 
JEMALLOC_ALWAYS_INLINE
 

483 
	$´of_m®loc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

486 
	`ÿs£¹
(
cÚfig_´of
);

487 
	`as£¹
(
±r
 !ğ
NULL
);

488 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
tsdn
, 
±r
, 
Œue
));

490 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 > (uintptr_t)1U))

491 
	`´of_m®loc_§m¶e_objeù
(
tsdn
, 
±r
, 
usize
, 
tùx
);

493 
	`´of_tùx_£t
(
tsdn
, 
±r
, 
usize
, (
´of_tùx_t
 *)(
ušŒ_t
)1U);

494 
	}
}

496 
JEMALLOC_ALWAYS_INLINE
 

497 
	$´of_»®loc
(
tsd_t
 *
tsd
, cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
,

498 
boŞ
 
´of_aùive
, boŞ 
upd©ed
, cÚ¡ *
Şd_±r
, 
size_t
 
Şd_usize
,

499 
´of_tùx_t
 *
Şd_tùx
)

501 
boŞ
 
§m¶ed
, 
Şd_§m¶ed
;

503 
	`ÿs£¹
(
cÚfig_´of
);

504 
	`as£¹
(
±r
 !ğ
NULL
 || (
ušŒ_t
)
tùx
 <= (uintptr_t)1U);

506 ià(
´of_aùive
 && !
upd©ed
 && 
±r
 !ğ
NULL
) {

507 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
Œue
));

508 ià(
	`´of_§m¶e_accum_upd©e
(
tsd
, 
usize
, 
Œue
, 
NULL
)) {

516 
tùx
 = (
´of_tùx_t
 *)(
ušŒ_t
)1U;

520 
§m¶ed
 = ((
ušŒ_t
)
tùx
 > (uintptr_t)1U);

521 
Şd_§m¶ed
 = ((
ušŒ_t
)
Şd_tùx
 > (uintptr_t)1U);

523 ià(
	`uÆik–y
(
§m¶ed
))

524 
	`´of_m®loc_§m¶e_objeù
(
	`tsd_tsdn
(
tsd
), 
±r
, 
usize
, 
tùx
);

526 
	`´of_tùx_»£t
(
	`tsd_tsdn
(
tsd
), 
±r
, 
usize
, 
Şd_±r
, 
Şd_tùx
);

528 ià(
	`uÆik–y
(
Şd_§m¶ed
))

529 
	`´of_ä“_§m¶ed_objeù
(
tsd
, 
Şd_usize
, 
Şd_tùx
);

530 
	}
}

532 
JEMALLOC_ALWAYS_INLINE
 

533 
	$´of_ä“
(
tsd_t
 *
tsd
, cÚ¡ *
±r
, 
size_t
 
usize
)

535 
´of_tùx_t
 *
tùx
 = 
	`´of_tùx_g‘
(
	`tsd_tsdn
(
tsd
), 
±r
);

537 
	`ÿs£¹
(
cÚfig_´of
);

538 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
Œue
));

540 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 > (uintptr_t)1U))

541 
	`´of_ä“_§m¶ed_objeù
(
tsd
, 
usize
, 
tùx
);

542 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/public_namespace.h

1 
	#je_m®loc_cÚf
 
	`JEMALLOC_N
(
m®loc_cÚf
)

	)

2 
	#je_m®loc_mes§ge
 
	`JEMALLOC_N
(
m®loc_mes§ge
)

	)

3 
	#je_m®loc
 
	`JEMALLOC_N
(
m®loc
)

	)

4 
	#je_ÿÎoc
 
	`JEMALLOC_N
(
ÿÎoc
)

	)

5 
	#je_posix_mem®ign
 
	`JEMALLOC_N
(
posix_mem®ign
)

	)

6 
	#je_®igÃd_®loc
 
	`JEMALLOC_N
(
®igÃd_®loc
)

	)

7 
	#je_»®loc
 
	`JEMALLOC_N
(
»®loc
)

	)

8 
	#je_ä“
 
	`JEMALLOC_N
(
ä“
)

	)

9 
	#je_m®locx
 
	`JEMALLOC_N
(
m®locx
)

	)

10 
	#je_¿Îocx
 
	`JEMALLOC_N
(
¿Îocx
)

	)

11 
	#je_x®locx
 
	`JEMALLOC_N
(
x®locx
)

	)

12 
	#je_§Îocx
 
	`JEMALLOC_N
(
§Îocx
)

	)

13 
	#je_d®locx
 
	`JEMALLOC_N
(
d®locx
)

	)

14 
	#je_sd®locx
 
	`JEMALLOC_N
(
sd®locx
)

	)

15 
	#je_ÇÎocx
 
	`JEMALLOC_N
(
ÇÎocx
)

	)

16 
	#je_m®lùl
 
	`JEMALLOC_N
(
m®lùl
)

	)

17 
	#je_m®lùÊam‘omib
 
	`JEMALLOC_N
(
m®lùÊam‘omib
)

	)

18 
	#je_m®lùlbymib
 
	`JEMALLOC_N
(
m®lùlbymib
)

	)

19 
	#je_m®loc_¡©s_´št
 
	`JEMALLOC_N
(
m®loc_¡©s_´št
)

	)

20 
	#je_m®loc_u§bË_size
 
	`JEMALLOC_N
(
m®loc_u§bË_size
)

	)

21 
	#je_mem®ign
 
	`JEMALLOC_N
(
mem®ign
)

	)

22 
	#je_v®loc
 
	`JEMALLOC_N
(
v®loc
)

	)

	@dep/jemalloc-4.2.0/include/jemalloc/internal/public_unnamespace.h

1 #undeà
je_m®loc_cÚf


2 #undeà
je_m®loc_mes§ge


3 #undeà
je_m®loc


4 #undeà
je_ÿÎoc


5 #undeà
je_posix_mem®ign


6 #undeà
je_®igÃd_®loc


7 #undeà
je_»®loc


8 #undeà
je_ä“


9 #undeà
je_m®locx


10 #undeà
je_¿Îocx


11 #undeà
je_x®locx


12 #undeà
je_§Îocx


13 #undeà
je_d®locx


14 #undeà
je_sd®locx


15 #undeà
je_ÇÎocx


16 #undeà
je_m®lùl


17 #undeà
je_m®lùÊam‘omib


18 #undeà
je_m®lùlbymib


19 #undeà
je_m®loc_¡©s_´št


20 #undeà
je_m®loc_u§bË_size


21 #undeà
je_mem®ign


22 #undeà
je_v®loc


	@dep/jemalloc-4.2.0/include/jemalloc/internal/ql.h

2 
	#ql_h—d
(
a_ty³
) \

4 
a_ty³
 *
qlh_fœ¡
; \

5 }

	)

7 
	#ql_h—d_š™Ÿliz”
(
a_h—d
è{
NULL
}

	)

9 
	#ql_–m
(
a_ty³
è
	`qr
×_ty³)

	)

12 
	#ql_Ãw
(
a_h—d
) do { \

13 (
a_h—d
)->
qlh_fœ¡
 = 
NULL
; \

14 } 0)

	)

16 
	#ql_–m_Ãw
(
a_–m
, 
a_f›ld
è
	`qr_Ãw
(×_–m),‡_f›ld)

	)

18 
	#ql_fœ¡
(
a_h—d
è(×_h—d)->
qlh_fœ¡
)

	)

20 
	#ql_Ï¡
(
a_h—d
, 
a_f›ld
) \

21 ((
	`ql_fœ¡
(
a_h—d
è!ğ
NULL
) \

22 ? 
	`qr_´ev
(
	`ql_fœ¡
(
a_h—d
), 
a_f›ld
è: 
NULL
)

	)

24 
	#ql_Ãxt
(
a_h—d
, 
a_–m
, 
a_f›ld
) \

25 ((
	`ql_Ï¡
(
a_h—d
, 
a_f›ld
è!ğ(
a_–m
)) \

26 ? 
	`qr_Ãxt
((
a_–m
), 
a_f›ld
è: 
NULL
)

	)

28 
	#ql_´ev
(
a_h—d
, 
a_–m
, 
a_f›ld
) \

29 ((
	`ql_fœ¡
(
a_h—d
è!ğ(
a_–m
)è? 
	`qr_´ev
(×_–m), 
a_f›ld
) \

30 : 
NULL
)

	)

32 
	#ql_befÜe_š£¹
(
a_h—d
, 
a_qËlm
, 
a_–m
, 
a_f›ld
) do { \

33 
	`qr_befÜe_š£¹
((
a_qËlm
), (
a_–m
), 
a_f›ld
); \

34 ià(
	`ql_fœ¡
(
a_h—d
è=ğ(
a_qËlm
)) { \

35 
	`ql_fœ¡
(
a_h—d
èğ(
a_–m
); \

37 } 0)

	)

39 
	#ql_aá”_š£¹
(
a_qËlm
, 
a_–m
, 
a_f›ld
) \

40 
	`qr_aá”_š£¹
((
a_qËlm
), (
a_–m
), 
a_f›ld
)

	)

42 
	#ql_h—d_š£¹
(
a_h—d
, 
a_–m
, 
a_f›ld
) do { \

43 ià(
	`ql_fœ¡
(
a_h—d
è!ğ
NULL
) { \

44 
	`qr_befÜe_š£¹
(
	`ql_fœ¡
(
a_h—d
), (
a_–m
), 
a_f›ld
); \

46 
	`ql_fœ¡
(
a_h—d
èğ(
a_–m
); \

47 } 0)

	)

49 
	#ql__š£¹
(
a_h—d
, 
a_–m
, 
a_f›ld
) do { \

50 ià(
	`ql_fœ¡
(
a_h—d
è!ğ
NULL
) { \

51 
	`qr_befÜe_š£¹
(
	`ql_fœ¡
(
a_h—d
), (
a_–m
), 
a_f›ld
); \

53 
	`ql_fœ¡
(
a_h—d
èğ
	`qr_Ãxt
((
a_–m
), 
a_f›ld
); \

54 } 0)

	)

56 
	#ql_»move
(
a_h—d
, 
a_–m
, 
a_f›ld
) do { \

57 ià(
	`ql_fœ¡
(
a_h—d
è=ğ(
a_–m
)) { \

58 
	`ql_fœ¡
(
a_h—d
èğ
	`qr_Ãxt
(ql_fœ¡×_h—d), 
a_f›ld
); \

60 ià(
	`ql_fœ¡
(
a_h—d
è!ğ(
a_–m
)) { \

61 
	`qr_»move
((
a_–m
), 
a_f›ld
); \

63 
	`ql_fœ¡
(
a_h—d
èğ
NULL
; \

65 } 0)

	)

67 
	#ql_h—d_»move
(
a_h—d
, 
a_ty³
, 
a_f›ld
) do { \

68 
a_ty³
 *
t
 = 
	`ql_fœ¡
(
a_h—d
); \

69 
	`ql_»move
((
a_h—d
), 
t
, 
a_f›ld
); \

70 } 0)

	)

72 
	#ql__»move
(
a_h—d
, 
a_ty³
, 
a_f›ld
) do { \

73 
a_ty³
 *
t
 = 
	`ql_Ï¡
(
a_h—d
, 
a_f›ld
); \

74 
	`ql_»move
((
a_h—d
), 
t
, 
a_f›ld
); \

75 } 0)

	)

77 
	#ql_fÜ—ch
(
a_v¬
, 
a_h—d
, 
a_f›ld
) \

78 
	`qr_fÜ—ch
((
a_v¬
), 
	`ql_fœ¡
(
a_h—d
), 
a_f›ld
)

	)

80 
	#ql_»v”£_fÜ—ch
(
a_v¬
, 
a_h—d
, 
a_f›ld
) \

81 
	`qr_»v”£_fÜ—ch
((
a_v¬
), 
	`ql_fœ¡
(
a_h—d
), 
a_f›ld
)

	)

	@dep/jemalloc-4.2.0/include/jemalloc/internal/qr.h

2 
	#qr
(
a_ty³
) \

4 
a_ty³
 *
q»_Ãxt
; \

5 
a_ty³
 *
q»_´ev
; \

6 }

	)

9 
	#qr_Ãw
(
a_qr
, 
a_f›ld
) do { \

10 (
a_qr
)->
a_f›ld
.
q»_Ãxt
 = (a_qr); \

11 (
a_qr
)->
a_f›ld
.
q»_´ev
 = (a_qr); \

12 } 0)

	)

14 
	#qr_Ãxt
(
a_qr
, 
a_f›ld
è(×_qr)->a_f›ld.
q»_Ãxt
)

	)

16 
	#qr_´ev
(
a_qr
, 
a_f›ld
è(×_qr)->a_f›ld.
q»_´ev
)

	)

18 
	#qr_befÜe_š£¹
(
a_q»lm
, 
a_qr
, 
a_f›ld
) do { \

19 (
a_qr
)->
a_f›ld
.
q»_´ev
 = (
a_q»lm
)->a_field.qre_prev; \

20 (
a_qr
)->
a_f›ld
.
q»_Ãxt
 = (
a_q»lm
); \

21 (
a_qr
)->
a_f›ld
.
q»_´ev
->a_f›ld.
q»_Ãxt
 = (a_qr); \

22 (
a_q»lm
)->
a_f›ld
.
q»_´ev
 = (
a_qr
); \

23 } 0)

	)

25 
	#qr_aá”_š£¹
(
a_q»lm
, 
a_qr
, 
a_f›ld
) \

28 (
a_qr
)->
a_f›ld
.
q»_Ãxt
 = (
a_q»lm
)->a_field.qre_next; \

29 (
a_qr
)->
a_f›ld
.
q»_´ev
 = (
a_q»lm
); \

30 (
a_qr
)->
a_f›ld
.
q»_Ãxt
->a_f›ld.
q»_´ev
 = (a_qr); \

31 (
a_q»lm
)->
a_f›ld
.
q»_Ãxt
 = (
a_qr
); \

32 } 0)

	)

34 
	#qr_m–d
(
a_qr_a
, 
a_qr_b
, 
a_f›ld
) do { \

35 *
t
; \

36 (
a_qr_a
)->
a_f›ld
.
q»_´ev
->a_f›ld.
q»_Ãxt
 = (
a_qr_b
); \

37 (
a_qr_b
)->
a_f›ld
.
q»_´ev
->a_f›ld.
q»_Ãxt
 = (
a_qr_a
); \

38 
t
 = (
a_qr_a
)->
a_f›ld
.
q»_´ev
; \

39 (
a_qr_a
)->
a_f›ld
.
q»_´ev
 = (
a_qr_b
)->a_field.qre_prev; \

40 (
a_qr_b
)->
a_f›ld
.
q»_´ev
 = 
t
; \

41 } 0)

	)

47 
	#qr_¥l™
(
a_qr_a
, 
a_qr_b
, 
a_f›ld
) \

48 
	`qr_m–d
((
a_qr_a
), (
a_qr_b
), 
a_f›ld
)

	)

50 
	#qr_»move
(
a_qr
, 
a_f›ld
) do { \

51 (
a_qr
)->
a_f›ld
.
q»_´ev
->a_f›ld.
q»_Ãxt
 \

52 ğ(
a_qr
)->
a_f›ld
.
q»_Ãxt
; \

53 (
a_qr
)->
a_f›ld
.
q»_Ãxt
->a_f›ld.
q»_´ev
 \

54 ğ(
a_qr
)->
a_f›ld
.
q»_´ev
; \

55 (
a_qr
)->
a_f›ld
.
q»_Ãxt
 = (a_qr); \

56 (
a_qr
)->
a_f›ld
.
q»_´ev
 = (a_qr); \

57 } 0)

	)

59 
	#qr_fÜ—ch
(
v¬
, 
a_qr
, 
a_f›ld
) \

60 (
v¬
èğ(
a_qr
); \

61 (
v¬
è!ğ
NULL
; \

62 (
v¬
èğ(((v¬)->
a_f›ld
.
q»_Ãxt
 !ğ(
a_qr
)) \

63 ? (
v¬
)->
a_f›ld
.
q»_Ãxt
 : 
NULL
))

	)

65 
	#qr_»v”£_fÜ—ch
(
v¬
, 
a_qr
, 
a_f›ld
) \

66 (
v¬
èğ((
a_qr
è!ğ
NULL
è? 
	`qr_´ev
×_qr, 
a_f›ld
) : NULL; \

67 (
v¬
è!ğ
NULL
; \

68 (
v¬
èğ(((v¬è!ğ(
a_qr
)) \

69 ? (
v¬
)->
a_f›ld
.
q»_´ev
 : 
NULL
))

	)

	@dep/jemalloc-4.2.0/include/jemalloc/internal/quarantine.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
qu¬ªtše_obj_s
 
	tqu¬ªtše_obj_t
;

5 
qu¬ªtše_s
 
	tqu¬ªtše_t
;

8 
	#JEMALLOC_VALGRIND_QUARANTINE_DEFAULT
 (
	`ZU
(1è<< 24)

	)

12 #ifdeà
JEMALLOC_H_STRUCTS


14 
	squ¬ªtše_obj_s
 {

15 *
	m±r
;

16 
size_t
 
	musize
;

19 
	squ¬ªtše_s
 {

20 
size_t
 
	mcurby‹s
;

21 
size_t
 
	mcurobjs
;

22 
size_t
 
	mfœ¡
;

23 
	#LG_MAXOBJS_INIT
 10

	)

24 
size_t
 
	mlg_maxobjs
;

25 
qu¬ªtše_obj_t
 
	mobjs
[1];

30 #ifdeà
JEMALLOC_H_EXTERNS


32 
qu¬ªtše_®loc_hook_wÜk
(
tsd_t
 *
tsd
);

33 
qu¬ªtše
(
tsd_t
 *
tsd
, *
±r
);

34 
qu¬ªtše_ş—nup
(
tsd_t
 *
tsd
);

38 #ifdeà
JEMALLOC_H_INLINES


40 #iâdeà
JEMALLOC_ENABLE_INLINE


41 
qu¬ªtše_®loc_hook
();

44 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_QUARANTINE_C_
))

45 
JEMALLOC_ALWAYS_INLINE
 

46 
	$qu¬ªtše_®loc_hook
()

48 
tsd_t
 *
tsd
;

50 
	`as£¹
(
cÚfig_fl
 && 
İt_qu¬ªtše
);

52 
tsd
 = 
	`tsd_ãtch
();

53 ià(
	`tsd_qu¬ªtše_g‘
(
tsd
è=ğ
NULL
)

54 
	`qu¬ªtše_®loc_hook_wÜk
(
tsd
);

55 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/rb.h

22 #iâdeà
RB_H_


23 
	#RB_H_


	)

25 #ifdeà
RB_COMPACT


27 
	#rb_node
(
a_ty³
) \

29 
a_ty³
 *
rbn_Ëá
; \

30 
a_ty³
 *
rbn_right_»d
; \

31 }

	)

33 
	#rb_node
(
a_ty³
) \

35 
a_ty³
 *
rbn_Ëá
; \

36 
a_ty³
 *
rbn_right
; \

37 
boŞ
 
rbn_»d
; \

38 }

	)

42 
	#rb_Œ“
(
a_ty³
) \

44 
a_ty³
 *
rbt_roÙ
; \

45 }

	)

48 
	#rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

49 ((
a_node
)->
a_f›ld
.
rbn_Ëá
)

	)

50 
	#rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_Ëá
) do { \

51 (
a_node
)->
a_f›ld
.
rbn_Ëá
 = 
a_Ëá
; \

52 } 0)

	)

54 #ifdeà
RB_COMPACT


56 
	#rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

57 ((
a_ty³
 *è(((
šŒ_t
è(
a_node
)->
a_f›ld
.
rbn_right_»d
) \

58 & ((
ssize_t
)-2)))

	)

59 
	#rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_right
) do { \

60 (
a_node
)->
a_f›ld
.
rbn_right_»d
 = (
a_ty³
 *è(((
ušŒ_t
è
a_right
) \

61 | (((
ušŒ_t
è(
a_node
)->
a_f›ld
.
rbn_right_»d
è& ((
size_t
)1))); \

62 } 0)

	)

65 
	#rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

66 ((
boŞ
è(((
ušŒ_t
è(
a_node
)->
a_f›ld
.
rbn_right_»d
) \

67 & ((
size_t
)1)))

	)

68 
	#rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_»d
) do { \

69 (
a_node
)->
a_f›ld
.
rbn_right_»d
 = (
a_ty³
 *è((((
šŒ_t
) \

70 (
a_node
)->
a_f›ld
.
rbn_right_»d
è& ((
ssize_t
)-2)) \

71 | ((
ssize_t
)
a_»d
)); \

72 } 0)

	)

73 
	#rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
a_node
) do { \

74 (
a_node
)->
a_f›ld
.
rbn_right_»d
 = (
a_ty³
 *è(((
ušŒ_t
) \

75 (
a_node
)->
a_f›ld
.
rbn_right_»d
è| ((
size_t
)1)); \

76 } 0)

	)

77 
	#rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
a_node
) do { \

78 (
a_node
)->
a_f›ld
.
rbn_right_»d
 = (
a_ty³
 *è(((
šŒ_t
) \

79 (
a_node
)->
a_f›ld
.
rbn_right_»d
è& ((
ssize_t
)-2)); \

80 } 0)

	)

83 
	#rbt_node_Ãw
(
a_ty³
, 
a_f›ld
, 
a_rbt
, 
a_node
) do { \

85 
	`as£¹
(((
ušŒ_t
)(
a_node
) & 0x1) == 0); \

86 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), 
NULL
); \

87 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), 
NULL
); \

88 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, (
a_node
)); \

89 } 0)

	)

92 
	#rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

93 ((
a_node
)->
a_f›ld
.
rbn_right
)

	)

94 
	#rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_right
) do { \

95 (
a_node
)->
a_f›ld
.
rbn_right
 = 
a_right
; \

96 } 0)

	)

99 
	#rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

100 ((
a_node
)->
a_f›ld
.
rbn_»d
)

	)

101 
	#rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_»d
) do { \

102 (
a_node
)->
a_f›ld
.
rbn_»d
 = (
a_»d
); \

103 } 0)

	)

104 
	#rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
a_node
) do { \

105 (
a_node
)->
a_f›ld
.
rbn_»d
 = 
Œue
; \

106 } 0)

	)

107 
	#rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
a_node
) do { \

108 (
a_node
)->
a_f›ld
.
rbn_»d
 = 
çl£
; \

109 } 0)

	)

112 
	#rbt_node_Ãw
(
a_ty³
, 
a_f›ld
, 
a_rbt
, 
a_node
) do { \

113 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), 
NULL
); \

114 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), 
NULL
); \

115 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, (
a_node
)); \

116 } 0)

	)

120 
	#rb_Ãw
(
a_ty³
, 
a_f›ld
, 
a_rbt
) do { \

121 (
a_rbt
)->
rbt_roÙ
 = 
NULL
; \

122 } 0)

	)

125 
	#rbŠ_fœ¡
(
a_ty³
, 
a_f›ld
, 
a_rbt
, 
a_roÙ
, 
r_node
) do { \

126 (
r_node
èğ(
a_roÙ
); \

127 ià((
r_node
è!ğ
NULL
) { \

129 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, (
r_node
)è!ğ
NULL
; \

130 (
r_node
èğ
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, (r_node))) { \

133 } 0)

	)

135 
	#rbŠ_Ï¡
(
a_ty³
, 
a_f›ld
, 
a_rbt
, 
a_roÙ
, 
r_node
) do { \

136 (
r_node
èğ(
a_roÙ
); \

137 ià((
r_node
è!ğ
NULL
) { \

138 ; 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, (
r_node
)è!ğ
NULL
; \

139 (
r_node
èğ
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, (r_node))) { \

142 } 0)

	)

144 
	#rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
a_node
, 
r_node
) do { \

145 (
r_node
èğ
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, (
a_node
)); \

146 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), \

147 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, (
r_node
))); \

148 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, (
r_node
), (
a_node
)); \

149 } 0)

	)

151 
	#rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
a_node
, 
r_node
) do { \

152 (
r_node
èğ
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, (
a_node
)); \

153 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), \

154 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, (
r_node
))); \

155 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, (
r_node
), (
a_node
)); \

156 } 0)

	)

163 
	#rb_´Ùo
(
a_©Œ
, 
a_´efix
, 
a_rbt_ty³
, 
a_ty³
) \

164 
a_©Œ
 \

165 
a_´efix
##
	`Ãw
(
a_rbt_ty³
 *
rbŒ“
); \

166 
a_©Œ
 
boŞ
 \

167 
a_´efix
##
	`em±y
(
a_rbt_ty³
 *
rbŒ“
); \

168 
a_©Œ
 
a_ty³
 * \

169 
a_´efix
##
	`fœ¡
(
a_rbt_ty³
 *
rbŒ“
); \

170 
a_©Œ
 
a_ty³
 * \

171 
a_´efix
##
	`Ï¡
(
a_rbt_ty³
 *
rbŒ“
); \

172 
a_©Œ
 
a_ty³
 * \

173 
a_´efix
##
	`Ãxt
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
); \

174 
a_©Œ
 
a_ty³
 * \

175 
a_´efix
##
	`´ev
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
); \

176 
a_©Œ
 
a_ty³
 * \

177 
a_´efix
##
	`£¬ch
(
a_rbt_ty³
 *
rbŒ“
, cÚ¡ 
a_ty³
 *
key
); \

178 
a_©Œ
 
a_ty³
 * \

179 
a_´efix
##
	`n£¬ch
(
a_rbt_ty³
 *
rbŒ“
, cÚ¡ 
a_ty³
 *
key
); \

180 
a_©Œ
 
a_ty³
 * \

181 
a_´efix
##
	`p£¬ch
(
a_rbt_ty³
 *
rbŒ“
, cÚ¡ 
a_ty³
 *
key
); \

182 
a_©Œ
 \

183 
a_´efix
##
	`š£¹
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
); \

184 
a_©Œ
 \

185 
a_´efix
##
	`»move
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
); \

186 
a_©Œ
 
a_ty³
 * \

187 
a_´efix
##
	`™”
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
,‡_ty³ *(*
cb
)( \

188 
a_rbt_ty³
 *, 
a_ty³
 *, *), *
¬g
); \

189 
a_©Œ
 
a_ty³
 * \

190 
a_´efix
##
	`»v”£_™”
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
, \

191 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
); \

192 
a_©Œ
 \

193 
a_´efix
##
	`de¡roy
(
a_rbt_ty³
 *
rbŒ“
, (*
cb
)(
a_ty³
 *, *), \

194 *
¬g
);

	)

338 
	#rb_g’
(
a_©Œ
, 
a_´efix
, 
a_rbt_ty³
, 
a_ty³
, 
a_f›ld
, 
a_cmp
) \

339 
a_©Œ
 \

340 
a_´efix
##
	`Ãw
(
a_rbt_ty³
 *
rbŒ“
) { \

341 
	`rb_Ãw
(
a_ty³
, 
a_f›ld
, 
rbŒ“
); \

343 
a_©Œ
 
boŞ
 \

344 
a_´efix
##
	`em±y
(
a_rbt_ty³
 *
rbŒ“
) { \

345  (
rbŒ“
->
rbt_roÙ
 =ğ
NULL
); \

347 
a_©Œ
 
a_ty³
 * \

348 
a_´efix
##
	`fœ¡
(
a_rbt_ty³
 *
rbŒ“
) { \

349 
a_ty³
 *
»t
; \

350 
	`rbŠ_fœ¡
(
a_ty³
, 
a_f›ld
, 
rbŒ“
,„bŒ“->
rbt_roÙ
, 
»t
); \

351  (
»t
); \

353 
a_©Œ
 
a_ty³
 * \

354 
a_´efix
##
	`Ï¡
(
a_rbt_ty³
 *
rbŒ“
) { \

355 
a_ty³
 *
»t
; \

356 
	`rbŠ_Ï¡
(
a_ty³
, 
a_f›ld
, 
rbŒ“
,„bŒ“->
rbt_roÙ
, 
»t
); \

357  (
»t
); \

359 
a_©Œ
 
a_ty³
 * \

360 
a_´efix
##
	`Ãxt
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
) { \

361 
a_ty³
 *
»t
; \

362 ià(
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
è!ğ
NULL
) { \

363 
	`rbŠ_fœ¡
(
a_ty³
, 
a_f›ld
, 
rbŒ“
, 
	`rbŠ_right_g‘
(a_type, \

364 
a_f›ld
, 
node
), 
»t
); \

366 
a_ty³
 *
Šode
 = 
rbŒ“
->
rbt_roÙ
; \

367 
	`as£¹
(
Šode
 !ğ
NULL
); \

368 
»t
 = 
NULL
; \

369 
Œue
) { \

370 
cmp
 = (
a_cmp
)(
node
, 
Šode
); \

371 ià(
cmp
 < 0) { \

372 
»t
 = 
Šode
; \

373 
Šode
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,node); \

374 } ià(
cmp
 > 0) { \

375 
Šode
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,node); \

379 
	`as£¹
(
Šode
 !ğ
NULL
); \

382  (
»t
); \

384 
a_©Œ
 
a_ty³
 * \

385 
a_´efix
##
	`´ev
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
) { \

386 
a_ty³
 *
»t
; \

387 ià(
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
è!ğ
NULL
) { \

388 
	`rbŠ_Ï¡
(
a_ty³
, 
a_f›ld
, 
rbŒ“
, 
	`rbŠ_Ëá_g‘
(a_type, \

389 
a_f›ld
, 
node
), 
»t
); \

391 
a_ty³
 *
Šode
 = 
rbŒ“
->
rbt_roÙ
; \

392 
	`as£¹
(
Šode
 !ğ
NULL
); \

393 
»t
 = 
NULL
; \

394 
Œue
) { \

395 
cmp
 = (
a_cmp
)(
node
, 
Šode
); \

396 ià(
cmp
 < 0) { \

397 
Šode
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,node); \

398 } ià(
cmp
 > 0) { \

399 
»t
 = 
Šode
; \

400 
Šode
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,node); \

404 
	`as£¹
(
Šode
 !ğ
NULL
); \

407  (
»t
); \

409 
a_©Œ
 
a_ty³
 * \

410 
a_´efix
##
	`£¬ch
(
a_rbt_ty³
 *
rbŒ“
, cÚ¡ 
a_ty³
 *
key
) { \

411 
a_ty³
 *
»t
; \

412 
cmp
; \

413 
»t
 = 
rbŒ“
->
rbt_roÙ
; \

414 
»t
 !ğ
NULL
 \

415 && (
cmp
 = (
a_cmp
)(
key
, 
»t
)) != 0) { \

416 ià(
cmp
 < 0) { \

417 
»t
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,„et); \

419 
»t
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,„et); \

422  (
»t
); \

424 
a_©Œ
 
a_ty³
 * \

425 
a_´efix
##
	`n£¬ch
(
a_rbt_ty³
 *
rbŒ“
, cÚ¡ 
a_ty³
 *
key
) { \

426 
a_ty³
 *
»t
; \

427 
a_ty³
 *
Šode
 = 
rbŒ“
->
rbt_roÙ
; \

428 
»t
 = 
NULL
; \

429 
Šode
 !ğ
NULL
) { \

430 
cmp
 = (
a_cmp
)(
key
, 
Šode
); \

431 ià(
cmp
 < 0) { \

432 
»t
 = 
Šode
; \

433 
Šode
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,node); \

434 } ià(
cmp
 > 0) { \

435 
Šode
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,node); \

437 
»t
 = 
Šode
; \

441  (
»t
); \

443 
a_©Œ
 
a_ty³
 * \

444 
a_´efix
##
	`p£¬ch
(
a_rbt_ty³
 *
rbŒ“
, cÚ¡ 
a_ty³
 *
key
) { \

445 
a_ty³
 *
»t
; \

446 
a_ty³
 *
Šode
 = 
rbŒ“
->
rbt_roÙ
; \

447 
»t
 = 
NULL
; \

448 
Šode
 !ğ
NULL
) { \

449 
cmp
 = (
a_cmp
)(
key
, 
Šode
); \

450 ià(
cmp
 < 0) { \

451 
Šode
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,node); \

452 } ià(
cmp
 > 0) { \

453 
»t
 = 
Šode
; \

454 
Šode
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,node); \

456 
»t
 = 
Šode
; \

460  (
»t
); \

462 
a_©Œ
 \

463 
a_´efix
##
	`š£¹
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
) { \

465 
a_ty³
 *
node
; \

466 
cmp
; \

467 } 
·th
[(*è<< 4], *
·thp
; \

468 
	`rbt_node_Ãw
(
a_ty³
, 
a_f›ld
, 
rbŒ“
, 
node
); \

470 
·th
->
node
 = 
rbŒ“
->
rbt_roÙ
; \

471 
·thp
 = 
·th
;…©hp->
node
 !ğ
NULL
;…athp++) { \

472 
cmp
 = 
·thp
->cm°ğ
	`a_cmp
(
node
,…athp->node); \

473 
	`as£¹
(
cmp
 != 0); \

474 ià(
cmp
 < 0) { \

475 
·thp
[1].
node
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, \

476 
·thp
->
node
); \

478 
·thp
[1].
node
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, \

479 
·thp
->
node
); \

482 
·thp
->
node
 =‚ode; \

484 
·thp
--; (
ušŒ_t
í©h°>ğ(ušŒ_t)
·th
;…athp--) { \

485 
a_ty³
 *
úode
 = 
·thp
->
node
; \

486 ià(
·thp
->
cmp
 < 0) { \

487 
a_ty³
 *
Ëá
 = 
·thp
[1].
node
; \

488 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
úode
, 
Ëá
); \

489 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
Ëá
)) { \

490 
a_ty³
 *
ËáËá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
Ëá
);\

491 ià(
ËáËá
 !ğ
NULL
 && 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, \

492 
ËáËá
)) { \

494 
a_ty³
 *
Šode
; \

495 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
ËáËá
); \

496 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
úode
, 
Šode
); \

497 
úode
 = 
Šode
; \

503 
a_ty³
 *
right
 = 
·thp
[1].
node
; \

504 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
úode
, 
right
); \

505 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
right
)) { \

506 
a_ty³
 *
Ëá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
úode
); \

507 ià(
Ëá
 !ğ
NULL
 && 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, \

508 
Ëá
)) { \

510 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

511 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
right
); \

512 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
úode
); \

515 
a_ty³
 *
Šode
; \

516 
boŞ
 
Œed
 = 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
úode
); \

517 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
úode
, 
Šode
); \

518 
	`rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
Šode
, 
Œed
); \

519 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
úode
); \

520 
úode
 = 
Šode
; \

526 
·thp
->
node
 = 
úode
; \

529 
rbŒ“
->
rbt_roÙ
 = 
·th
->
node
; \

530 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
rbŒ“
->
rbt_roÙ
); \

532 
a_©Œ
 \

533 
a_´efix
##
	`»move
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
) { \

535 
a_ty³
 *
node
; \

536 
cmp
; \

537 } *
·thp
, *
nod•
, 
·th
[(*) << 4]; \

539 
nod•
 = 
NULL
; \

540 
·th
->
node
 = 
rbŒ“
->
rbt_roÙ
; \

541 
·thp
 = 
·th
;…©hp->
node
 !ğ
NULL
;…athp++) { \

542 
cmp
 = 
·thp
->cm°ğ
	`a_cmp
(
node
,…athp->node); \

543 ià(
cmp
 < 0) { \

544 
·thp
[1].
node
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, \

545 
·thp
->
node
); \

547 
·thp
[1].
node
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, \

548 
·thp
->
node
); \

549 ià(
cmp
 == 0) { \

551 
·thp
->
cmp
 = 1; \

552 
nod•
 = 
·thp
; \

553 
·thp
++;…©hp->
node
 !ğ
NULL
; \

554 
·thp
++) { \

555 
·thp
->
cmp
 = -1; \

556 
·thp
[1].
node
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, \

557 
·thp
->
node
); \

563 
	`as£¹
(
nod•
->
node
 ==‚ode); \

564 
·thp
--; \

565 ià(
·thp
->
node
 !=‚ode) { \

567 
boŞ
 
Œed
 = 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

568 
	`rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

569 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
node
)); \

570 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

571 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
)); \

576 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

577 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
)); \

578 
	`rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
node
, 
Œed
); \

581 
nod•
->
node
 = 
·thp
->node; \

582 
·thp
->
node
 =‚ode; \

583 ià(
nod•
 =ğ
·th
) { \

584 
rbŒ“
->
rbt_roÙ
 = 
nod•
->
node
; \

586 ià(
nod•
[-1].
cmp
 < 0) { \

587 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
nod•
[-1].
node
, \

588 
nod•
->
node
); \

590 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
nod•
[-1].
node
, \

591 
nod•
->
node
); \

595 
a_ty³
 *
Ëá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
node
); \

596 ià(
Ëá
 !ğ
NULL
) { \

599 
	`as£¹
(!
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
node
)); \

600 
	`as£¹
(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
Ëá
)); \

601 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

602 ià(
·thp
 =ğ
·th
) { \

603 
rbŒ“
->
rbt_roÙ
 = 
Ëá
; \

605 ià(
·thp
[-1].
cmp
 < 0) { \

606 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

607 
Ëá
); \

609 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

610 
Ëá
); \

614 } ià(
·thp
 =ğ
·th
) { \

616 
rbŒ“
->
rbt_roÙ
 = 
NULL
; \

620 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
)) { \

622 
	`as£¹
(
·thp
[-1].
cmp
 < 0); \

623 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, 
NULL
); \

628 
·thp
->
node
 = 
NULL
; \

629 
·thp
--; (
ušŒ_t
í©h°>ğ(ušŒ_t)
·th
;…athp--) { \

630 
	`as£¹
(
·thp
->
cmp
 != 0); \

631 ià(
·thp
->
cmp
 < 0) { \

632 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

633 
·thp
[1].
node
); \

634 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
)) { \

635 
a_ty³
 *
right
 = 
	`rbŠ_right_g‘
×_ty³, 
a_f›ld
, \

636 
·thp
->
node
); \

637 
a_ty³
 *
righeá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, \

638 
right
); \

639 
a_ty³
 *
Šode
; \

640 ià(
righeá
 !ğ
NULL
 && 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, \

641 
righeá
)) { \

652 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

653 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
right
, 
Šode
); \

654 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, 
Šode
);\

655 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

656 
Šode
); \

665 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

666 
Šode
); \

670 
	`as£¹
((
ušŒ_t
)
·thp
 > (ušŒ_t)
·th
); \

671 ià(
·thp
[-1].
cmp
 < 0) { \

672 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

673 
Šode
); \

675 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

676 
Šode
); \

680 
a_ty³
 *
right
 = 
	`rbŠ_right_g‘
×_ty³, 
a_f›ld
, \

681 
·thp
->
node
); \

682 
a_ty³
 *
righeá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, \

683 
right
); \

684 ià(
righeá
 !ğ
NULL
 && 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, \

685 
righeá
)) { \

692 
a_ty³
 *
Šode
; \

693 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
righeá
); \

694 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
right
, 
Šode
); \

695 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, 
Šode
);\

696 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

697 
Šode
); \

701 ià(
·thp
 =ğ
·th
) { \

703 
rbŒ“
->
rbt_roÙ
 = 
Šode
; \

705 ià(
·thp
[-1].
cmp
 < 0) { \

706 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, \

707 
·thp
[-1].
node
, 
Šode
); \

709 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, \

710 
·thp
[-1].
node
, 
Šode
); \

721 
a_ty³
 *
Šode
; \

722 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

723 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

724 
Šode
); \

725 
·thp
->
node
 = 
Šode
; \

729 
a_ty³
 *
Ëá
; \

730 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

731 
·thp
[1].
node
); \

732 
Ëá
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

733 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
Ëá
)) { \

734 
a_ty³
 *
Šode
; \

735 
a_ty³
 *
Ëáright
 = 
	`rbŠ_right_g‘
×_ty³, 
a_f›ld
, \

736 
Ëá
); \

737 
a_ty³
 *
Ëárigheá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, \

738 
Ëáright
); \

739 ià(
Ëárigheá
 !ğ
NULL
 && 
	`rbŠ_»d_g‘
(
a_ty³
, \

740 
a_f›ld
, 
Ëárigheá
)) { \

749 
a_ty³
 *
unode
; \

750 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
Ëárigheá
); \

751 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

752 
unode
); \

753 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

754 
Šode
); \

755 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
unode
, 
Šode
); \

756 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
unode
, 
Šode
); \

766 
	`as£¹
(
Ëáright
 !ğ
NULL
); \

767 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
Ëáright
); \

768 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

769 
Šode
); \

770 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
Šode
); \

774 ià(
·thp
 =ğ
·th
) { \

776 
rbŒ“
->
rbt_roÙ
 = 
Šode
; \

778 ià(
·thp
[-1].
cmp
 < 0) { \

779 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

780 
Šode
); \

782 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

783 
Šode
); \

787 } ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
)) { \

788 
a_ty³
 *
ËáËá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
Ëá
);\

789 ià(
ËáËá
 !ğ
NULL
 && 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, \

790 
ËáËá
)) { \

797 
a_ty³
 *
Šode
; \

798 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

799 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

800 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
ËáËá
); \

801 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

802 
Šode
); \

805 
	`as£¹
((
ušŒ_t
)
·thp
 > (ušŒ_t)
·th
); \

806 ià(
·thp
[-1].
cmp
 < 0) { \

807 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

808 
Šode
); \

810 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

811 
Šode
); \

821 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

822 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

827 
a_ty³
 *
ËáËá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
Ëá
);\

828 ià(
ËáËá
 !ğ
NULL
 && 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, \

829 
ËáËá
)) { \

836 
a_ty³
 *
Šode
; \

837 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
ËáËá
); \

838 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

839 
Šode
); \

843 ià(
·thp
 =ğ
·th
) { \

845 
rbŒ“
->
rbt_roÙ
 = 
Šode
; \

847 ià(
·thp
[-1].
cmp
 < 0) { \

848 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, \

849 
·thp
[-1].
node
, 
Šode
); \

851 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, \

852 
·thp
[-1].
node
, 
Šode
); \

863 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

869 
rbŒ“
->
rbt_roÙ
 = 
·th
->
node
; \

870 
	`as£¹
(!
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
rbŒ“
->
rbt_roÙ
)); \

872 
a_©Œ
 
a_ty³
 * \

873 
a_´efix
##
	`™”_»cur£
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
, \

874 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
) { \

875 ià(
node
 =ğ
NULL
) { \

876  (
NULL
); \

878 
a_ty³
 *
»t
; \

879 ià((
»t
 = 
a_´efix
##
	`™”_»cur£
(
rbŒ“
, 
	`rbŠ_Ëá_g‘
(
a_ty³
, \

880 
a_f›ld
, 
node
), 
cb
, 
¬g
)è!ğ
NULL
 || (
»t
 = 
	`cb
(
rbŒ“
,‚ode, \

881 
¬g
)è!ğ
NULL
) { \

882  (
»t
); \

884  (
a_´efix
##
	`™”_»cur£
(
rbŒ“
, 
	`rbŠ_right_g‘
(
a_ty³
, \

885 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

888 
a_©Œ
 
a_ty³
 * \

889 
a_´efix
##
	`™”_¡¬t
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
,‡_ty³ *
node
, \

890 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
) { \

891 
cmp
 = 
	`a_cmp
(
¡¬t
, 
node
); \

892 ià(
cmp
 < 0) { \

893 
a_ty³
 *
»t
; \

894 ià((
»t
 = 
a_´efix
##
	`™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

895 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)è!ğ
NULL
 || \

896 (
»t
 = 
	`cb
(
rbŒ“
, 
node
, 
¬g
)è!ğ
NULL
) { \

897  (
»t
); \

899  (
a_´efix
##
	`™”_»cur£
(
rbŒ“
, 
	`rbŠ_right_g‘
(
a_ty³
, \

900 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

901 } ià(
cmp
 > 0) { \

902  (
a_´efix
##
	`™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

903 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

905 
a_ty³
 *
»t
; \

906 ià((
»t
 = 
	`cb
(
rbŒ“
, 
node
, 
¬g
)è!ğ
NULL
) { \

907  (
»t
); \

909  (
a_´efix
##
	`™”_»cur£
(
rbŒ“
, 
	`rbŠ_right_g‘
(
a_ty³
, \

910 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

913 
a_©Œ
 
a_ty³
 * \

914 
a_´efix
##
	`™”
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
,‡_ty³ *(*
cb
)( \

915 
a_rbt_ty³
 *, 
a_ty³
 *, *), *
¬g
) { \

916 
a_ty³
 *
»t
; \

917 ià(
¡¬t
 !ğ
NULL
) { \

918 
»t
 = 
a_´efix
##
	`™”_¡¬t
(
rbŒ“
, 
¡¬t
,„bŒ“->
rbt_roÙ
, \

919 
cb
, 
¬g
); \

921 
»t
 = 
a_´efix
##
	`™”_»cur£
(
rbŒ“
,„bŒ“->
rbt_roÙ
, 
cb
, 
¬g
);\

923  (
»t
); \

925 
a_©Œ
 
a_ty³
 * \

926 
a_´efix
##
	`»v”£_™”_»cur£
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
, \

927 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
) { \

928 ià(
node
 =ğ
NULL
) { \

929  (
NULL
); \

931 
a_ty³
 *
»t
; \

932 ià((
»t
 = 
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
, \

933 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)è!ğ
NULL
 || \

934 (
»t
 = 
	`cb
(
rbŒ“
, 
node
, 
¬g
)è!ğ
NULL
) { \

935  (
»t
); \

937  (
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
, \

938 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

941 
a_©Œ
 
a_ty³
 * \

942 
a_´efix
##
	`»v”£_™”_¡¬t
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
, \

943 
a_ty³
 *
node
,‡_ty³ *(*
cb
)(
a_rbt_ty³
 *,‡_type *, *), \

944 *
¬g
) { \

945 
cmp
 = 
	`a_cmp
(
¡¬t
, 
node
); \

946 ià(
cmp
 > 0) { \

947 
a_ty³
 *
»t
; \

948 ià((
»t
 = 
a_´efix
##
	`»v”£_™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

949 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)è!ğ
NULL
 || \

950 (
»t
 = 
	`cb
(
rbŒ“
, 
node
, 
¬g
)è!ğ
NULL
) { \

951  (
»t
); \

953  (
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
, \

954 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

955 } ià(
cmp
 < 0) { \

956  (
a_´efix
##
	`»v”£_™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

957 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

959 
a_ty³
 *
»t
; \

960 ià((
»t
 = 
	`cb
(
rbŒ“
, 
node
, 
¬g
)è!ğ
NULL
) { \

961  (
»t
); \

963  (
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
, \

964 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

967 
a_©Œ
 
a_ty³
 * \

968 
a_´efix
##
	`»v”£_™”
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
, \

969 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
) { \

970 
a_ty³
 *
»t
; \

971 ià(
¡¬t
 !ğ
NULL
) { \

972 
»t
 = 
a_´efix
##
	`»v”£_™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

973 
rbŒ“
->
rbt_roÙ
, 
cb
, 
¬g
); \

975 
»t
 = 
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
,„bŒ“->
rbt_roÙ
, \

976 
cb
, 
¬g
); \

978  (
»t
); \

980 
a_©Œ
 \

981 
a_´efix
##
	`de¡roy_»cur£
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
, (*
cb
)( \

982 
a_ty³
 *, *), *
¬g
) { \

983 ià(
node
 =ğ
NULL
) { \

986 
a_´efix
##
	`de¡roy_»cur£
(
rbŒ“
, 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, \

987 
node
), 
cb
, 
¬g
); \

988 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, (
node
), 
NULL
); \

989 
a_´efix
##
	`de¡roy_»cur£
(
rbŒ“
, 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, \

990 
node
), 
cb
, 
¬g
); \

991 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, (
node
), 
NULL
); \

992 ià(
cb
) { \

993 
	`cb
(
node
, 
¬g
); \

996 
a_©Œ
 \

997 
a_´efix
##
	`de¡roy
(
a_rbt_ty³
 *
rbŒ“
, (*
cb
)(
a_ty³
 *, *), \

998 *
¬g
) { \

999 
a_´efix
##
	`de¡roy_»cur£
(
rbŒ“
,„bŒ“->
rbt_roÙ
, 
cb
, 
¬g
); \

1000 
rbŒ“
->
rbt_roÙ
 = 
NULL
; \

1001 }

	)

	@dep/jemalloc-4.2.0/include/jemalloc/internal/rtree.h

7 #ifdeà
JEMALLOC_H_TYPES


9 
¹»e_node_–m_s
 
	t¹»e_node_–m_t
;

10 
¹»e_Ëv–_s
 
	t¹»e_Ëv–_t
;

11 
¹»e_s
 
	t¹»e_t
;

17 
	#LG_RTREE_BITS_PER_LEVEL
 4

	)

18 
	#RTREE_BITS_PER_LEVEL
 (1U << 
LG_RTREE_BITS_PER_LEVEL
)

	)

20 
	#RTREE_HEIGHT_MAX
 \

21 ((1U << (
LG_SIZEOF_PTR
+3)è/ 
RTREE_BITS_PER_LEVEL
)

	)

24 
	#RTREE_NODE_INITIALIZING
 ((
¹»e_node_–m_t
 *)0x1)

	)

31 
	g¹»e_node_–m_t
 *(
	t¹»e_node_®loc_t
)(
	tsize_t
);

32 (
	t¹»e_node_d®loc_t
)(
	t¹»e_node_–m_t
 *);

36 #ifdeà
JEMALLOC_H_STRUCTS


38 
	s¹»e_node_–m_s
 {

40 *
pun
;

41 
¹»e_node_–m_t
 *
chd
;

42 
ex‹Á_node_t
 *
v®
;

46 
	s¹»e_Ëv–_s
 {

70 *
subŒ“_pun
;

71 
¹»e_node_–m_t
 *
subŒ“
;

74 
b™s
;

79 
cumb™s
;

82 
	s¹»e_s
 {

83 
¹»e_node_®loc_t
 *
®loc
;

84 
¹»e_node_d®loc_t
 *
d®loc
;

85 
height
;

90 
¡¬t_Ëv–
[
RTREE_HEIGHT_MAX
];

91 
¹»e_Ëv–_t
 
Ëv–s
[
RTREE_HEIGHT_MAX
];

96 #ifdeà
JEMALLOC_H_EXTERNS


98 
boŞ
 
	`¹»e_Ãw
(
¹»e_t
 *
¹»e
, 
b™s
, 
¹»e_node_®loc_t
 *
®loc
,

99 
¹»e_node_d®loc_t
 *
d®loc
);

100 
	`¹»e_d–‘e
(
¹»e_t
 *
¹»e
);

101 
¹»e_node_–m_t
 *
	`¹»e_subŒ“_»ad_h¬d
(
¹»e_t
 *
¹»e
,

102 
Ëv–
);

103 
¹»e_node_–m_t
 *
	`¹»e_chd_»ad_h¬d
(
¹»e_t
 *
¹»e
,

104 
¹»e_node_–m_t
 *
–m
, 
Ëv–
);

108 #ifdeà
JEMALLOC_H_INLINES


110 #iâdeà
JEMALLOC_ENABLE_INLINE


111 
	`¹»e_¡¬t_Ëv–
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
);

112 
ušŒ_t
 
	`¹»e_subkey
(
¹»e_t
 *
¹»e
, ušŒ_ˆ
key
, 
Ëv–
);

114 
boŞ
 
	`¹»e_node_v®id
(
¹»e_node_–m_t
 *
node
);

115 
¹»e_node_–m_t
 *
	`¹»e_chd_Œy»ad
ÔŒ“_node_–m_ˆ*
–m
,

116 
boŞ
 
d•’d’t
);

117 
¹»e_node_–m_t
 *
	`¹»e_chd_»ad
(
¹»e_t
 *
¹»e
,„Œ“_node_–m_ˆ*
–m
,

118 
Ëv–
, 
boŞ
 
d•’d’t
);

119 
ex‹Á_node_t
 *
	`¹»e_v®_»ad
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
,

120 
boŞ
 
d•’d’t
);

121 
	`¹»e_v®_wr™e
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
,

122 cÚ¡ 
ex‹Á_node_t
 *
v®
);

123 
¹»e_node_–m_t
 *
	`¹»e_subŒ“_Œy»ad
(
¹»e_t
 *
¹»e
, 
Ëv–
,

124 
boŞ
 
d•’d’t
);

125 
¹»e_node_–m_t
 *
	`¹»e_subŒ“_»ad
(
¹»e_t
 *
¹»e
, 
Ëv–
,

126 
boŞ
 
d•’d’t
);

128 
ex‹Á_node_t
 *
	`¹»e_g‘
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, 
boŞ
 
d•’d’t
);

129 
boŞ
 
	`¹»e_£t
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, cÚ¡ 
ex‹Á_node_t
 *
v®
);

132 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_RTREE_C_
))

133 
JEMALLOC_ALWAYS_INLINE
 

134 
	$¹»e_¡¬t_Ëv–
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
)

136 
¡¬t_Ëv–
;

138 ià(
	`uÆik–y
(
key
 == 0))

139  (
¹»e
->
height
 - 1);

141 
¡¬t_Ëv–
 = 
¹»e
->¡¬t_Ëv–[
	`lg_æoÜ
(
key
) >>

142 
LG_RTREE_BITS_PER_LEVEL
];

143 
	`as£¹
(
¡¬t_Ëv–
 < 
¹»e
->
height
);

144  (
¡¬t_Ëv–
);

145 
	}
}

147 
JEMALLOC_ALWAYS_INLINE
 
ušŒ_t


148 
	$¹»e_subkey
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, 
Ëv–
)

151  ((
key
 >> ((
	`ZU
(1è<< (
LG_SIZEOF_PTR
+3)) -

152 
¹»e
->
Ëv–s
[
Ëv–
].
cumb™s
)è& ((
	`ZU
(1) <<

153 
¹»e
->
Ëv–s
[
Ëv–
].
b™s
) - 1));

154 
	}
}

156 
JEMALLOC_ALWAYS_INLINE
 
boŞ


157 
	$¹»e_node_v®id
(
¹»e_node_–m_t
 *
node
)

160  ((
ušŒ_t
)
node
 > (ušŒ_t)
RTREE_NODE_INITIALIZING
);

161 
	}
}

163 
JEMALLOC_ALWAYS_INLINE
 
¹»e_node_–m_t
 *

164 
	$¹»e_chd_Œy»ad
(
¹»e_node_–m_t
 *
–m
, 
boŞ
 
d•’d’t
)

166 
¹»e_node_–m_t
 *
chd
;

169 
chd
 = 
–m
->child;

170 ià(!
d•’d’t
 && !
	`¹»e_node_v®id
(
chd
))

171 
chd
 = 
	`©omic_»ad_p
(&
–m
->
pun
);

172 
	`as£¹
(!
d•’d’t
 || 
chd
 !ğ
NULL
);

173  (
chd
);

174 
	}
}

176 
JEMALLOC_ALWAYS_INLINE
 
¹»e_node_–m_t
 *

177 
	$¹»e_chd_»ad
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
, 
Ëv–
,

178 
boŞ
 
d•’d’t
)

180 
¹»e_node_–m_t
 *
chd
;

182 
chd
 = 
	`¹»e_chd_Œy»ad
(
–m
, 
d•’d’t
);

183 ià(!
d•’d’t
 && 
	`uÆik–y
(!
	`¹»e_node_v®id
(
chd
)))

184 
chd
 = 
	`¹»e_chd_»ad_h¬d
(
¹»e
, 
–m
, 
Ëv–
);

185 
	`as£¹
(!
d•’d’t
 || 
chd
 !ğ
NULL
);

186  (
chd
);

187 
	}
}

189 
JEMALLOC_ALWAYS_INLINE
 
ex‹Á_node_t
 *

190 
	$¹»e_v®_»ad
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
, 
boŞ
 
d•’d’t
)

193 ià(
d•’d’t
) {

200  (
–m
->
v®
);

207  (
	`©omic_»ad_p
(&
–m
->
pun
));

209 
	}
}

211 
JEMALLOC_INLINE
 

212 
	$¹»e_v®_wr™e
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
, cÚ¡ 
ex‹Á_node_t
 *
v®
)

215 
	`©omic_wr™e_p
(&
–m
->
pun
, 
v®
);

216 
	}
}

218 
JEMALLOC_ALWAYS_INLINE
 
¹»e_node_–m_t
 *

219 
	$¹»e_subŒ“_Œy»ad
(
¹»e_t
 *
¹»e
, 
Ëv–
, 
boŞ
 
d•’d’t
)

221 
¹»e_node_–m_t
 *
subŒ“
;

224 
subŒ“
 = 
¹»e
->
Ëv–s
[
Ëv–
].subtree;

225 ià(!
d•’d’t
 && 
	`uÆik–y
(!
	`¹»e_node_v®id
(
subŒ“
)))

226 
subŒ“
 = 
	`©omic_»ad_p
(&
¹»e
->
Ëv–s
[
Ëv–
].
subŒ“_pun
);

227 
	`as£¹
(!
d•’d’t
 || 
subŒ“
 !ğ
NULL
);

228  (
subŒ“
);

229 
	}
}

231 
JEMALLOC_ALWAYS_INLINE
 
¹»e_node_–m_t
 *

232 
	$¹»e_subŒ“_»ad
(
¹»e_t
 *
¹»e
, 
Ëv–
, 
boŞ
 
d•’d’t
)

234 
¹»e_node_–m_t
 *
subŒ“
;

236 
subŒ“
 = 
	`¹»e_subŒ“_Œy»ad
(
¹»e
, 
Ëv–
, 
d•’d’t
);

237 ià(!
d•’d’t
 && 
	`uÆik–y
(!
	`¹»e_node_v®id
(
subŒ“
)))

238 
subŒ“
 = 
	`¹»e_subŒ“_»ad_h¬d
(
¹»e
, 
Ëv–
);

239 
	`as£¹
(!
d•’d’t
 || 
subŒ“
 !ğ
NULL
);

240  (
subŒ“
);

241 
	}
}

243 
JEMALLOC_ALWAYS_INLINE
 
ex‹Á_node_t
 *

244 
	$¹»e_g‘
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, 
boŞ
 
d•’d’t
)

246 
ušŒ_t
 
subkey
;

247 
¡¬t_Ëv–
;

248 
¹»e_node_–m_t
 *
node
;

250 
¡¬t_Ëv–
 = 
	`¹»e_¡¬t_Ëv–
(
¹»e
, 
key
);

252 
node
 = 
	`¹»e_subŒ“_Œy»ad
(
¹»e
, 
¡¬t_Ëv–
, 
d•’d’t
);

253 
	#RTREE_GET_BIAS
 (
RTREE_HEIGHT_MAX
 - 
¹»e
->
height
)

	)

254 
¡¬t_Ëv–
 + 
RTREE_GET_BIAS
) {

255 
	#RTREE_GET_SUBTREE
(
Ëv–
) \

256 
Ëv–
: \

257 
	`as£¹
(
Ëv–
 < (
RTREE_HEIGHT_MAX
-1)); \

258 ià(!
d•’d’t
 && 
	`uÆik–y
(!
	`¹»e_node_v®id
(
node
))) \

259  (
NULL
); \

260 
subkey
 = 
	`¹»e_subkey
(
¹»e
, 
key
, 
Ëv–
 - \

261 
RTREE_GET_BIAS
); \

262 
node
 = 
	`¹»e_chd_Œy»ad
(&node[
subkey
], 
d•’d’t
); \

263 

	)

264 
	#RTREE_GET_LEAF
(
Ëv–
) \

265 
Ëv–
: \

266 
	`as£¹
(
Ëv–
 =ğ(
RTREE_HEIGHT_MAX
-1)); \

267 ià(!
d•’d’t
 && 
	`uÆik–y
(!
	`¹»e_node_v®id
(
node
))) \

268  (
NULL
); \

269 
subkey
 = 
	`¹»e_subkey
(
¹»e
, 
key
, 
Ëv–
 - \

270 
RTREE_GET_BIAS
); \

275  (
	`¹»e_v®_»ad
(
¹»e
, &
node
[
subkey
], \

276 
d•’d’t
));

	)

277 #ià
RTREE_HEIGHT_MAX
 > 1

278 
	`RTREE_GET_SUBTREE
(0)

280 #ià
RTREE_HEIGHT_MAX
 > 2

281 
	`RTREE_GET_SUBTREE
(1)

283 #ià
RTREE_HEIGHT_MAX
 > 3

284 
	`RTREE_GET_SUBTREE
(2)

286 #ià
RTREE_HEIGHT_MAX
 > 4

287 
	`RTREE_GET_SUBTREE
(3)

289 #ià
RTREE_HEIGHT_MAX
 > 5

290 
	`RTREE_GET_SUBTREE
(4)

292 #ià
RTREE_HEIGHT_MAX
 > 6

293 
	`RTREE_GET_SUBTREE
(5)

295 #ià
RTREE_HEIGHT_MAX
 > 7

296 
	`RTREE_GET_SUBTREE
(6)

298 #ià
RTREE_HEIGHT_MAX
 > 8

299 
	`RTREE_GET_SUBTREE
(7)

301 #ià
RTREE_HEIGHT_MAX
 > 9

302 
	`RTREE_GET_SUBTREE
(8)

304 #ià
RTREE_HEIGHT_MAX
 > 10

305 
	`RTREE_GET_SUBTREE
(9)

307 #ià
RTREE_HEIGHT_MAX
 > 11

308 
	`RTREE_GET_SUBTREE
(10)

310 #ià
RTREE_HEIGHT_MAX
 > 12

311 
	`RTREE_GET_SUBTREE
(11)

313 #ià
RTREE_HEIGHT_MAX
 > 13

314 
	`RTREE_GET_SUBTREE
(12)

316 #ià
RTREE_HEIGHT_MAX
 > 14

317 
	`RTREE_GET_SUBTREE
(13)

319 #ià
RTREE_HEIGHT_MAX
 > 15

320 
	`RTREE_GET_SUBTREE
(14)

322 #ià
RTREE_HEIGHT_MAX
 > 16

323 #”rÜ 
UnsuµÜ‹d
 
RTREE_HEIGHT_MAX


325 
	`RTREE_GET_LEAF
(
RTREE_HEIGHT_MAX
-1)

326 #undeà
RTREE_GET_SUBTREE


327 #undeà
RTREE_GET_LEAF


328 : 
	`nÙ_»ached
();

330 #undeà
RTREE_GET_BIAS


331 
	`nÙ_»ached
();

332 
	}
}

334 
JEMALLOC_INLINE
 
boŞ


335 
	$¹»e_£t
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, cÚ¡ 
ex‹Á_node_t
 *
v®
)

337 
ušŒ_t
 
subkey
;

338 
i
, 
¡¬t_Ëv–
;

339 
¹»e_node_–m_t
 *
node
, *
chd
;

341 
¡¬t_Ëv–
 = 
	`¹»e_¡¬t_Ëv–
(
¹»e
, 
key
);

343 
node
 = 
	`¹»e_subŒ“_»ad
(
¹»e
, 
¡¬t_Ëv–
, 
çl£
);

344 ià(
node
 =ğ
NULL
)

345  (
Œue
);

346 
i
 = 
¡¬t_Ëv–
; ; i++, 
node
 = 
chd
) {

347 
subkey
 = 
	`¹»e_subkey
(
¹»e
, 
key
, 
i
);

348 ià(
i
 =ğ
¹»e
->
height
 - 1) {

353 
	`¹»e_v®_wr™e
(
¹»e
, &
node
[
subkey
], 
v®
);

354  (
çl£
);

356 
	`as£¹
(
i
 + 1 < 
¹»e
->
height
);

357 
chd
 = 
	`¹»e_chd_»ad
(
¹»e
, &
node
[
subkey
], 
i
, 
çl£
);

358 ià(
chd
 =ğ
NULL
)

359  (
Œue
);

361 
	`nÙ_»ached
();

362 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/size_classes.h

3 #ifdeà
JEMALLOC_H_TYPES


31 
	#LG_SIZE_CLASS_GROUP
 2

	)

33 #ià(
LG_SIZEOF_PTR
 =ğ2 && 
LG_TINY_MIN
 =ğ3 && 
LG_QUANTUM
 =ğ3 && 
LG_PAGE
 == 12)

34 
	#SIZE_CLASSES
 \

36 
	`SC
Ğ0, 3, 3, 0, 
yes
, 3) \

37 
	`SC
Ğ1, 3, 3, 1, 
yes
, 3) \

38 
	`SC
Ğ2, 3, 3, 2, 
yes
, 3) \

39 
	`SC
Ğ3, 3, 3, 3, 
yes
, 3) \

41 
	`SC
Ğ4, 5, 3, 1, 
yes
, 3) \

42 
	`SC
Ğ5, 5, 3, 2, 
yes
, 3) \

43 
	`SC
Ğ6, 5, 3, 3, 
yes
, 3) \

44 
	`SC
Ğ7, 5, 3, 4, 
yes
, 3) \

46 
	`SC
Ğ8, 6, 4, 1, 
yes
, 4) \

47 
	`SC
Ğ9, 6, 4, 2, 
yes
, 4) \

48 
	`SC
Ğ10, 6, 4, 3, 
yes
, 4) \

49 
	`SC
Ğ11, 6, 4, 4, 
yes
, 4) \

51 
	`SC
Ğ12, 7, 5, 1, 
yes
, 5) \

52 
	`SC
Ğ13, 7, 5, 2, 
yes
, 5) \

53 
	`SC
Ğ14, 7, 5, 3, 
yes
, 5) \

54 
	`SC
Ğ15, 7, 5, 4, 
yes
, 5) \

56 
	`SC
Ğ16, 8, 6, 1, 
yes
, 6) \

57 
	`SC
Ğ17, 8, 6, 2, 
yes
, 6) \

58 
	`SC
Ğ18, 8, 6, 3, 
yes
, 6) \

59 
	`SC
Ğ19, 8, 6, 4, 
yes
, 6) \

61 
	`SC
Ğ20, 9, 7, 1, 
yes
, 7) \

62 
	`SC
Ğ21, 9, 7, 2, 
yes
, 7) \

63 
	`SC
Ğ22, 9, 7, 3, 
yes
, 7) \

64 
	`SC
Ğ23, 9, 7, 4, 
yes
, 7) \

66 
	`SC
Ğ24, 10, 8, 1, 
yes
, 8) \

67 
	`SC
Ğ25, 10, 8, 2, 
yes
, 8) \

68 
	`SC
Ğ26, 10, 8, 3, 
yes
, 8) \

69 
	`SC
Ğ27, 10, 8, 4, 
yes
, 8) \

71 
	`SC
Ğ28, 11, 9, 1, 
yes
, 9) \

72 
	`SC
Ğ29, 11, 9, 2, 
yes
, 9) \

73 
	`SC
Ğ30, 11, 9, 3, 
yes
, 9) \

74 
	`SC
Ğ31, 11, 9, 4, 
yes
, 9) \

76 
	`SC
Ğ32, 12, 10, 1, 
yes
, 
no
) \

77 
	`SC
Ğ33, 12, 10, 2, 
yes
, 
no
) \

78 
	`SC
Ğ34, 12, 10, 3, 
yes
, 
no
) \

79 
	`SC
Ğ35, 12, 10, 4, 
yes
, 
no
) \

81 
	`SC
Ğ36, 13, 11, 1, 
yes
, 
no
) \

82 
	`SC
Ğ37, 13, 11, 2, 
yes
, 
no
) \

83 
	`SC
Ğ38, 13, 11, 3, 
yes
, 
no
) \

84 
	`SC
Ğ39, 13, 11, 4, 
no
,‚o) \

86 
	`SC
Ğ40, 14, 12, 1, 
no
,‚o) \

87 
	`SC
Ğ41, 14, 12, 2, 
no
,‚o) \

88 
	`SC
Ğ42, 14, 12, 3, 
no
,‚o) \

89 
	`SC
Ğ43, 14, 12, 4, 
no
,‚o) \

91 
	`SC
Ğ44, 15, 13, 1, 
no
,‚o) \

92 
	`SC
Ğ45, 15, 13, 2, 
no
,‚o) \

93 
	`SC
Ğ46, 15, 13, 3, 
no
,‚o) \

94 
	`SC
Ğ47, 15, 13, 4, 
no
,‚o) \

96 
	`SC
Ğ48, 16, 14, 1, 
no
,‚o) \

97 
	`SC
Ğ49, 16, 14, 2, 
no
,‚o) \

98 
	`SC
Ğ50, 16, 14, 3, 
no
,‚o) \

99 
	`SC
Ğ51, 16, 14, 4, 
no
,‚o) \

101 
	`SC
Ğ52, 17, 15, 1, 
no
,‚o) \

102 
	`SC
Ğ53, 17, 15, 2, 
no
,‚o) \

103 
	`SC
Ğ54, 17, 15, 3, 
no
,‚o) \

104 
	`SC
Ğ55, 17, 15, 4, 
no
,‚o) \

106 
	`SC
Ğ56, 18, 16, 1, 
no
,‚o) \

107 
	`SC
Ğ57, 18, 16, 2, 
no
,‚o) \

108 
	`SC
Ğ58, 18, 16, 3, 
no
,‚o) \

109 
	`SC
Ğ59, 18, 16, 4, 
no
,‚o) \

111 
	`SC
Ğ60, 19, 17, 1, 
no
,‚o) \

112 
	`SC
Ğ61, 19, 17, 2, 
no
,‚o) \

113 
	`SC
Ğ62, 19, 17, 3, 
no
,‚o) \

114 
	`SC
Ğ63, 19, 17, 4, 
no
,‚o) \

116 
	`SC
Ğ64, 20, 18, 1, 
no
,‚o) \

117 
	`SC
Ğ65, 20, 18, 2, 
no
,‚o) \

118 
	`SC
Ğ66, 20, 18, 3, 
no
,‚o) \

119 
	`SC
Ğ67, 20, 18, 4, 
no
,‚o) \

121 
	`SC
Ğ68, 21, 19, 1, 
no
,‚o) \

122 
	`SC
Ğ69, 21, 19, 2, 
no
,‚o) \

123 
	`SC
Ğ70, 21, 19, 3, 
no
,‚o) \

124 
	`SC
Ğ71, 21, 19, 4, 
no
,‚o) \

126 
	`SC
Ğ72, 22, 20, 1, 
no
,‚o) \

127 
	`SC
Ğ73, 22, 20, 2, 
no
,‚o) \

128 
	`SC
Ğ74, 22, 20, 3, 
no
,‚o) \

129 
	`SC
Ğ75, 22, 20, 4, 
no
,‚o) \

131 
	`SC
Ğ76, 23, 21, 1, 
no
,‚o) \

132 
	`SC
Ğ77, 23, 21, 2, 
no
,‚o) \

133 
	`SC
Ğ78, 23, 21, 3, 
no
,‚o) \

134 
	`SC
Ğ79, 23, 21, 4, 
no
,‚o) \

136 
	`SC
Ğ80, 24, 22, 1, 
no
,‚o) \

137 
	`SC
Ğ81, 24, 22, 2, 
no
,‚o) \

138 
	`SC
Ğ82, 24, 22, 3, 
no
,‚o) \

139 
	`SC
Ğ83, 24, 22, 4, 
no
,‚o) \

141 
	`SC
Ğ84, 25, 23, 1, 
no
,‚o) \

142 
	`SC
Ğ85, 25, 23, 2, 
no
,‚o) \

143 
	`SC
Ğ86, 25, 23, 3, 
no
,‚o) \

144 
	`SC
Ğ87, 25, 23, 4, 
no
,‚o) \

146 
	`SC
Ğ88, 26, 24, 1, 
no
,‚o) \

147 
	`SC
Ğ89, 26, 24, 2, 
no
,‚o) \

148 
	`SC
Ğ90, 26, 24, 3, 
no
,‚o) \

149 
	`SC
Ğ91, 26, 24, 4, 
no
,‚o) \

151 
	`SC
Ğ92, 27, 25, 1, 
no
,‚o) \

152 
	`SC
Ğ93, 27, 25, 2, 
no
,‚o) \

153 
	`SC
Ğ94, 27, 25, 3, 
no
,‚o) \

154 
	`SC
Ğ95, 27, 25, 4, 
no
,‚o) \

156 
	`SC
Ğ96, 28, 26, 1, 
no
,‚o) \

157 
	`SC
Ğ97, 28, 26, 2, 
no
,‚o) \

158 
	`SC
Ğ98, 28, 26, 3, 
no
,‚o) \

159 
	`SC
Ğ99, 28, 26, 4, 
no
,‚o) \

161 
	`SC
(100, 29, 27, 1, 
no
,‚o) \

162 
	`SC
(101, 29, 27, 2, 
no
,‚o) \

163 
	`SC
(102, 29, 27, 3, 
no
,‚o) \

164 
	`SC
(103, 29, 27, 4, 
no
,‚o) \

166 
	`SC
(104, 30, 28, 1, 
no
,‚o) \

167 
	`SC
(105, 30, 28, 2, 
no
,‚o) \

168 
	`SC
(106, 30, 28, 3, 
no
,‚o) \

169 

	)

170 
	#SIZE_CLASSES_DEFINED


	)

171 
	#NTBINS
 0

	)

172 
	#NLBINS
 32

	)

173 
	#NBINS
 39

	)

174 
	#NSIZES
 107

	)

175 
	#LG_TINY_MAXCLASS
 "NA"

	)

176 
	#LOOKUP_MAXCLASS
 ((((
size_t
)1è<< 11è+ (((size_t)4è<< 9))

	)

177 
	#SMALL_MAXCLASS
 ((((
size_t
)1è<< 13è+ (((size_t)3è<< 11))

	)

178 
	#LG_LARGE_MINCLASS
 14

	)

179 
	#HUGE_MAXCLASS
 ((((
size_t
)1è<< 30è+ (((size_t)3è<< 28))

	)

182 #ià(
LG_SIZEOF_PTR
 =ğ2 && 
LG_TINY_MIN
 =ğ3 && 
LG_QUANTUM
 =ğ4 && 
LG_PAGE
 == 12)

183 
	#SIZE_CLASSES
 \

185 
	`SC
Ğ0, 3, 3, 0, 
yes
, 3) \

187 
	`SC
Ğ1, 3, 3, 1, 
yes
, 3) \

188 
	`SC
Ğ2, 4, 4, 1, 
yes
, 4) \

189 
	`SC
Ğ3, 4, 4, 2, 
yes
, 4) \

190 
	`SC
Ğ4, 4, 4, 3, 
yes
, 4) \

192 
	`SC
Ğ5, 6, 4, 1, 
yes
, 4) \

193 
	`SC
Ğ6, 6, 4, 2, 
yes
, 4) \

194 
	`SC
Ğ7, 6, 4, 3, 
yes
, 4) \

195 
	`SC
Ğ8, 6, 4, 4, 
yes
, 4) \

197 
	`SC
Ğ9, 7, 5, 1, 
yes
, 5) \

198 
	`SC
Ğ10, 7, 5, 2, 
yes
, 5) \

199 
	`SC
Ğ11, 7, 5, 3, 
yes
, 5) \

200 
	`SC
Ğ12, 7, 5, 4, 
yes
, 5) \

202 
	`SC
Ğ13, 8, 6, 1, 
yes
, 6) \

203 
	`SC
Ğ14, 8, 6, 2, 
yes
, 6) \

204 
	`SC
Ğ15, 8, 6, 3, 
yes
, 6) \

205 
	`SC
Ğ16, 8, 6, 4, 
yes
, 6) \

207 
	`SC
Ğ17, 9, 7, 1, 
yes
, 7) \

208 
	`SC
Ğ18, 9, 7, 2, 
yes
, 7) \

209 
	`SC
Ğ19, 9, 7, 3, 
yes
, 7) \

210 
	`SC
Ğ20, 9, 7, 4, 
yes
, 7) \

212 
	`SC
Ğ21, 10, 8, 1, 
yes
, 8) \

213 
	`SC
Ğ22, 10, 8, 2, 
yes
, 8) \

214 
	`SC
Ğ23, 10, 8, 3, 
yes
, 8) \

215 
	`SC
Ğ24, 10, 8, 4, 
yes
, 8) \

217 
	`SC
Ğ25, 11, 9, 1, 
yes
, 9) \

218 
	`SC
Ğ26, 11, 9, 2, 
yes
, 9) \

219 
	`SC
Ğ27, 11, 9, 3, 
yes
, 9) \

220 
	`SC
Ğ28, 11, 9, 4, 
yes
, 9) \

222 
	`SC
Ğ29, 12, 10, 1, 
yes
, 
no
) \

223 
	`SC
Ğ30, 12, 10, 2, 
yes
, 
no
) \

224 
	`SC
Ğ31, 12, 10, 3, 
yes
, 
no
) \

225 
	`SC
Ğ32, 12, 10, 4, 
yes
, 
no
) \

227 
	`SC
Ğ33, 13, 11, 1, 
yes
, 
no
) \

228 
	`SC
Ğ34, 13, 11, 2, 
yes
, 
no
) \

229 
	`SC
Ğ35, 13, 11, 3, 
yes
, 
no
) \

230 
	`SC
Ğ36, 13, 11, 4, 
no
,‚o) \

232 
	`SC
Ğ37, 14, 12, 1, 
no
,‚o) \

233 
	`SC
Ğ38, 14, 12, 2, 
no
,‚o) \

234 
	`SC
Ğ39, 14, 12, 3, 
no
,‚o) \

235 
	`SC
Ğ40, 14, 12, 4, 
no
,‚o) \

237 
	`SC
Ğ41, 15, 13, 1, 
no
,‚o) \

238 
	`SC
Ğ42, 15, 13, 2, 
no
,‚o) \

239 
	`SC
Ğ43, 15, 13, 3, 
no
,‚o) \

240 
	`SC
Ğ44, 15, 13, 4, 
no
,‚o) \

242 
	`SC
Ğ45, 16, 14, 1, 
no
,‚o) \

243 
	`SC
Ğ46, 16, 14, 2, 
no
,‚o) \

244 
	`SC
Ğ47, 16, 14, 3, 
no
,‚o) \

245 
	`SC
Ğ48, 16, 14, 4, 
no
,‚o) \

247 
	`SC
Ğ49, 17, 15, 1, 
no
,‚o) \

248 
	`SC
Ğ50, 17, 15, 2, 
no
,‚o) \

249 
	`SC
Ğ51, 17, 15, 3, 
no
,‚o) \

250 
	`SC
Ğ52, 17, 15, 4, 
no
,‚o) \

252 
	`SC
Ğ53, 18, 16, 1, 
no
,‚o) \

253 
	`SC
Ğ54, 18, 16, 2, 
no
,‚o) \

254 
	`SC
Ğ55, 18, 16, 3, 
no
,‚o) \

255 
	`SC
Ğ56, 18, 16, 4, 
no
,‚o) \

257 
	`SC
Ğ57, 19, 17, 1, 
no
,‚o) \

258 
	`SC
Ğ58, 19, 17, 2, 
no
,‚o) \

259 
	`SC
Ğ59, 19, 17, 3, 
no
,‚o) \

260 
	`SC
Ğ60, 19, 17, 4, 
no
,‚o) \

262 
	`SC
Ğ61, 20, 18, 1, 
no
,‚o) \

263 
	`SC
Ğ62, 20, 18, 2, 
no
,‚o) \

264 
	`SC
Ğ63, 20, 18, 3, 
no
,‚o) \

265 
	`SC
Ğ64, 20, 18, 4, 
no
,‚o) \

267 
	`SC
Ğ65, 21, 19, 1, 
no
,‚o) \

268 
	`SC
Ğ66, 21, 19, 2, 
no
,‚o) \

269 
	`SC
Ğ67, 21, 19, 3, 
no
,‚o) \

270 
	`SC
Ğ68, 21, 19, 4, 
no
,‚o) \

272 
	`SC
Ğ69, 22, 20, 1, 
no
,‚o) \

273 
	`SC
Ğ70, 22, 20, 2, 
no
,‚o) \

274 
	`SC
Ğ71, 22, 20, 3, 
no
,‚o) \

275 
	`SC
Ğ72, 22, 20, 4, 
no
,‚o) \

277 
	`SC
Ğ73, 23, 21, 1, 
no
,‚o) \

278 
	`SC
Ğ74, 23, 21, 2, 
no
,‚o) \

279 
	`SC
Ğ75, 23, 21, 3, 
no
,‚o) \

280 
	`SC
Ğ76, 23, 21, 4, 
no
,‚o) \

282 
	`SC
Ğ77, 24, 22, 1, 
no
,‚o) \

283 
	`SC
Ğ78, 24, 22, 2, 
no
,‚o) \

284 
	`SC
Ğ79, 24, 22, 3, 
no
,‚o) \

285 
	`SC
Ğ80, 24, 22, 4, 
no
,‚o) \

287 
	`SC
Ğ81, 25, 23, 1, 
no
,‚o) \

288 
	`SC
Ğ82, 25, 23, 2, 
no
,‚o) \

289 
	`SC
Ğ83, 25, 23, 3, 
no
,‚o) \

290 
	`SC
Ğ84, 25, 23, 4, 
no
,‚o) \

292 
	`SC
Ğ85, 26, 24, 1, 
no
,‚o) \

293 
	`SC
Ğ86, 26, 24, 2, 
no
,‚o) \

294 
	`SC
Ğ87, 26, 24, 3, 
no
,‚o) \

295 
	`SC
Ğ88, 26, 24, 4, 
no
,‚o) \

297 
	`SC
Ğ89, 27, 25, 1, 
no
,‚o) \

298 
	`SC
Ğ90, 27, 25, 2, 
no
,‚o) \

299 
	`SC
Ğ91, 27, 25, 3, 
no
,‚o) \

300 
	`SC
Ğ92, 27, 25, 4, 
no
,‚o) \

302 
	`SC
Ğ93, 28, 26, 1, 
no
,‚o) \

303 
	`SC
Ğ94, 28, 26, 2, 
no
,‚o) \

304 
	`SC
Ğ95, 28, 26, 3, 
no
,‚o) \

305 
	`SC
Ğ96, 28, 26, 4, 
no
,‚o) \

307 
	`SC
Ğ97, 29, 27, 1, 
no
,‚o) \

308 
	`SC
Ğ98, 29, 27, 2, 
no
,‚o) \

309 
	`SC
Ğ99, 29, 27, 3, 
no
,‚o) \

310 
	`SC
(100, 29, 27, 4, 
no
,‚o) \

312 
	`SC
(101, 30, 28, 1, 
no
,‚o) \

313 
	`SC
(102, 30, 28, 2, 
no
,‚o) \

314 
	`SC
(103, 30, 28, 3, 
no
,‚o) \

315 

	)

316 
	#SIZE_CLASSES_DEFINED


	)

317 
	#NTBINS
 1

	)

318 
	#NLBINS
 29

	)

319 
	#NBINS
 36

	)

320 
	#NSIZES
 104

	)

321 
	#LG_TINY_MAXCLASS
 3

	)

322 
	#LOOKUP_MAXCLASS
 ((((
size_t
)1è<< 11è+ (((size_t)4è<< 9))

	)

323 
	#SMALL_MAXCLASS
 ((((
size_t
)1è<< 13è+ (((size_t)3è<< 11))

	)

324 
	#LG_LARGE_MINCLASS
 14

	)

325 
	#HUGE_MAXCLASS
 ((((
size_t
)1è<< 30è+ (((size_t)3è<< 28))

	)

328 #ià(
LG_SIZEOF_PTR
 =ğ2 && 
LG_TINY_MIN
 =ğ4 && 
LG_QUANTUM
 =ğ4 && 
LG_PAGE
 == 12)

329 
	#SIZE_CLASSES
 \

331 
	`SC
Ğ0, 4, 4, 0, 
yes
, 4) \

332 
	`SC
Ğ1, 4, 4, 1, 
yes
, 4) \

333 
	`SC
Ğ2, 4, 4, 2, 
yes
, 4) \

334 
	`SC
Ğ3, 4, 4, 3, 
yes
, 4) \

336 
	`SC
Ğ4, 6, 4, 1, 
yes
, 4) \

337 
	`SC
Ğ5, 6, 4, 2, 
yes
, 4) \

338 
	`SC
Ğ6, 6, 4, 3, 
yes
, 4) \

339 
	`SC
Ğ7, 6, 4, 4, 
yes
, 4) \

341 
	`SC
Ğ8, 7, 5, 1, 
yes
, 5) \

342 
	`SC
Ğ9, 7, 5, 2, 
yes
, 5) \

343 
	`SC
Ğ10, 7, 5, 3, 
yes
, 5) \

344 
	`SC
Ğ11, 7, 5, 4, 
yes
, 5) \

346 
	`SC
Ğ12, 8, 6, 1, 
yes
, 6) \

347 
	`SC
Ğ13, 8, 6, 2, 
yes
, 6) \

348 
	`SC
Ğ14, 8, 6, 3, 
yes
, 6) \

349 
	`SC
Ğ15, 8, 6, 4, 
yes
, 6) \

351 
	`SC
Ğ16, 9, 7, 1, 
yes
, 7) \

352 
	`SC
Ğ17, 9, 7, 2, 
yes
, 7) \

353 
	`SC
Ğ18, 9, 7, 3, 
yes
, 7) \

354 
	`SC
Ğ19, 9, 7, 4, 
yes
, 7) \

356 
	`SC
Ğ20, 10, 8, 1, 
yes
, 8) \

357 
	`SC
Ğ21, 10, 8, 2, 
yes
, 8) \

358 
	`SC
Ğ22, 10, 8, 3, 
yes
, 8) \

359 
	`SC
Ğ23, 10, 8, 4, 
yes
, 8) \

361 
	`SC
Ğ24, 11, 9, 1, 
yes
, 9) \

362 
	`SC
Ğ25, 11, 9, 2, 
yes
, 9) \

363 
	`SC
Ğ26, 11, 9, 3, 
yes
, 9) \

364 
	`SC
Ğ27, 11, 9, 4, 
yes
, 9) \

366 
	`SC
Ğ28, 12, 10, 1, 
yes
, 
no
) \

367 
	`SC
Ğ29, 12, 10, 2, 
yes
, 
no
) \

368 
	`SC
Ğ30, 12, 10, 3, 
yes
, 
no
) \

369 
	`SC
Ğ31, 12, 10, 4, 
yes
, 
no
) \

371 
	`SC
Ğ32, 13, 11, 1, 
yes
, 
no
) \

372 
	`SC
Ğ33, 13, 11, 2, 
yes
, 
no
) \

373 
	`SC
Ğ34, 13, 11, 3, 
yes
, 
no
) \

374 
	`SC
Ğ35, 13, 11, 4, 
no
,‚o) \

376 
	`SC
Ğ36, 14, 12, 1, 
no
,‚o) \

377 
	`SC
Ğ37, 14, 12, 2, 
no
,‚o) \

378 
	`SC
Ğ38, 14, 12, 3, 
no
,‚o) \

379 
	`SC
Ğ39, 14, 12, 4, 
no
,‚o) \

381 
	`SC
Ğ40, 15, 13, 1, 
no
,‚o) \

382 
	`SC
Ğ41, 15, 13, 2, 
no
,‚o) \

383 
	`SC
Ğ42, 15, 13, 3, 
no
,‚o) \

384 
	`SC
Ğ43, 15, 13, 4, 
no
,‚o) \

386 
	`SC
Ğ44, 16, 14, 1, 
no
,‚o) \

387 
	`SC
Ğ45, 16, 14, 2, 
no
,‚o) \

388 
	`SC
Ğ46, 16, 14, 3, 
no
,‚o) \

389 
	`SC
Ğ47, 16, 14, 4, 
no
,‚o) \

391 
	`SC
Ğ48, 17, 15, 1, 
no
,‚o) \

392 
	`SC
Ğ49, 17, 15, 2, 
no
,‚o) \

393 
	`SC
Ğ50, 17, 15, 3, 
no
,‚o) \

394 
	`SC
Ğ51, 17, 15, 4, 
no
,‚o) \

396 
	`SC
Ğ52, 18, 16, 1, 
no
,‚o) \

397 
	`SC
Ğ53, 18, 16, 2, 
no
,‚o) \

398 
	`SC
Ğ54, 18, 16, 3, 
no
,‚o) \

399 
	`SC
Ğ55, 18, 16, 4, 
no
,‚o) \

401 
	`SC
Ğ56, 19, 17, 1, 
no
,‚o) \

402 
	`SC
Ğ57, 19, 17, 2, 
no
,‚o) \

403 
	`SC
Ğ58, 19, 17, 3, 
no
,‚o) \

404 
	`SC
Ğ59, 19, 17, 4, 
no
,‚o) \

406 
	`SC
Ğ60, 20, 18, 1, 
no
,‚o) \

407 
	`SC
Ğ61, 20, 18, 2, 
no
,‚o) \

408 
	`SC
Ğ62, 20, 18, 3, 
no
,‚o) \

409 
	`SC
Ğ63, 20, 18, 4, 
no
,‚o) \

411 
	`SC
Ğ64, 21, 19, 1, 
no
,‚o) \

412 
	`SC
Ğ65, 21, 19, 2, 
no
,‚o) \

413 
	`SC
Ğ66, 21, 19, 3, 
no
,‚o) \

414 
	`SC
Ğ67, 21, 19, 4, 
no
,‚o) \

416 
	`SC
Ğ68, 22, 20, 1, 
no
,‚o) \

417 
	`SC
Ğ69, 22, 20, 2, 
no
,‚o) \

418 
	`SC
Ğ70, 22, 20, 3, 
no
,‚o) \

419 
	`SC
Ğ71, 22, 20, 4, 
no
,‚o) \

421 
	`SC
Ğ72, 23, 21, 1, 
no
,‚o) \

422 
	`SC
Ğ73, 23, 21, 2, 
no
,‚o) \

423 
	`SC
Ğ74, 23, 21, 3, 
no
,‚o) \

424 
	`SC
Ğ75, 23, 21, 4, 
no
,‚o) \

426 
	`SC
Ğ76, 24, 22, 1, 
no
,‚o) \

427 
	`SC
Ğ77, 24, 22, 2, 
no
,‚o) \

428 
	`SC
Ğ78, 24, 22, 3, 
no
,‚o) \

429 
	`SC
Ğ79, 24, 22, 4, 
no
,‚o) \

431 
	`SC
Ğ80, 25, 23, 1, 
no
,‚o) \

432 
	`SC
Ğ81, 25, 23, 2, 
no
,‚o) \

433 
	`SC
Ğ82, 25, 23, 3, 
no
,‚o) \

434 
	`SC
Ğ83, 25, 23, 4, 
no
,‚o) \

436 
	`SC
Ğ84, 26, 24, 1, 
no
,‚o) \

437 
	`SC
Ğ85, 26, 24, 2, 
no
,‚o) \

438 
	`SC
Ğ86, 26, 24, 3, 
no
,‚o) \

439 
	`SC
Ğ87, 26, 24, 4, 
no
,‚o) \

441 
	`SC
Ğ88, 27, 25, 1, 
no
,‚o) \

442 
	`SC
Ğ89, 27, 25, 2, 
no
,‚o) \

443 
	`SC
Ğ90, 27, 25, 3, 
no
,‚o) \

444 
	`SC
Ğ91, 27, 25, 4, 
no
,‚o) \

446 
	`SC
Ğ92, 28, 26, 1, 
no
,‚o) \

447 
	`SC
Ğ93, 28, 26, 2, 
no
,‚o) \

448 
	`SC
Ğ94, 28, 26, 3, 
no
,‚o) \

449 
	`SC
Ğ95, 28, 26, 4, 
no
,‚o) \

451 
	`SC
Ğ96, 29, 27, 1, 
no
,‚o) \

452 
	`SC
Ğ97, 29, 27, 2, 
no
,‚o) \

453 
	`SC
Ğ98, 29, 27, 3, 
no
,‚o) \

454 
	`SC
Ğ99, 29, 27, 4, 
no
,‚o) \

456 
	`SC
(100, 30, 28, 1, 
no
,‚o) \

457 
	`SC
(101, 30, 28, 2, 
no
,‚o) \

458 
	`SC
(102, 30, 28, 3, 
no
,‚o) \

459 

	)

460 
	#SIZE_CLASSES_DEFINED


	)

461 
	#NTBINS
 0

	)

462 
	#NLBINS
 28

	)

463 
	#NBINS
 35

	)

464 
	#NSIZES
 103

	)

465 
	#LG_TINY_MAXCLASS
 "NA"

	)

466 
	#LOOKUP_MAXCLASS
 ((((
size_t
)1è<< 11è+ (((size_t)4è<< 9))

	)

467 
	#SMALL_MAXCLASS
 ((((
size_t
)1è<< 13è+ (((size_t)3è<< 11))

	)

468 
	#LG_LARGE_MINCLASS
 14

	)

469 
	#HUGE_MAXCLASS
 ((((
size_t
)1è<< 30è+ (((size_t)3è<< 28))

	)

472 #ià(
LG_SIZEOF_PTR
 =ğ3 && 
LG_TINY_MIN
 =ğ3 && 
LG_QUANTUM
 =ğ3 && 
LG_PAGE
 == 12)

473 
	#SIZE_CLASSES
 \

475 
	`SC
Ğ0, 3, 3, 0, 
yes
, 3) \

476 
	`SC
Ğ1, 3, 3, 1, 
yes
, 3) \

477 
	`SC
Ğ2, 3, 3, 2, 
yes
, 3) \

478 
	`SC
Ğ3, 3, 3, 3, 
yes
, 3) \

480 
	`SC
Ğ4, 5, 3, 1, 
yes
, 3) \

481 
	`SC
Ğ5, 5, 3, 2, 
yes
, 3) \

482 
	`SC
Ğ6, 5, 3, 3, 
yes
, 3) \

483 
	`SC
Ğ7, 5, 3, 4, 
yes
, 3) \

485 
	`SC
Ğ8, 6, 4, 1, 
yes
, 4) \

486 
	`SC
Ğ9, 6, 4, 2, 
yes
, 4) \

487 
	`SC
Ğ10, 6, 4, 3, 
yes
, 4) \

488 
	`SC
Ğ11, 6, 4, 4, 
yes
, 4) \

490 
	`SC
Ğ12, 7, 5, 1, 
yes
, 5) \

491 
	`SC
Ğ13, 7, 5, 2, 
yes
, 5) \

492 
	`SC
Ğ14, 7, 5, 3, 
yes
, 5) \

493 
	`SC
Ğ15, 7, 5, 4, 
yes
, 5) \

495 
	`SC
Ğ16, 8, 6, 1, 
yes
, 6) \

496 
	`SC
Ğ17, 8, 6, 2, 
yes
, 6) \

497 
	`SC
Ğ18, 8, 6, 3, 
yes
, 6) \

498 
	`SC
Ğ19, 8, 6, 4, 
yes
, 6) \

500 
	`SC
Ğ20, 9, 7, 1, 
yes
, 7) \

501 
	`SC
Ğ21, 9, 7, 2, 
yes
, 7) \

502 
	`SC
Ğ22, 9, 7, 3, 
yes
, 7) \

503 
	`SC
Ğ23, 9, 7, 4, 
yes
, 7) \

505 
	`SC
Ğ24, 10, 8, 1, 
yes
, 8) \

506 
	`SC
Ğ25, 10, 8, 2, 
yes
, 8) \

507 
	`SC
Ğ26, 10, 8, 3, 
yes
, 8) \

508 
	`SC
Ğ27, 10, 8, 4, 
yes
, 8) \

510 
	`SC
Ğ28, 11, 9, 1, 
yes
, 9) \

511 
	`SC
Ğ29, 11, 9, 2, 
yes
, 9) \

512 
	`SC
Ğ30, 11, 9, 3, 
yes
, 9) \

513 
	`SC
Ğ31, 11, 9, 4, 
yes
, 9) \

515 
	`SC
Ğ32, 12, 10, 1, 
yes
, 
no
) \

516 
	`SC
Ğ33, 12, 10, 2, 
yes
, 
no
) \

517 
	`SC
Ğ34, 12, 10, 3, 
yes
, 
no
) \

518 
	`SC
Ğ35, 12, 10, 4, 
yes
, 
no
) \

520 
	`SC
Ğ36, 13, 11, 1, 
yes
, 
no
) \

521 
	`SC
Ğ37, 13, 11, 2, 
yes
, 
no
) \

522 
	`SC
Ğ38, 13, 11, 3, 
yes
, 
no
) \

523 
	`SC
Ğ39, 13, 11, 4, 
no
,‚o) \

525 
	`SC
Ğ40, 14, 12, 1, 
no
,‚o) \

526 
	`SC
Ğ41, 14, 12, 2, 
no
,‚o) \

527 
	`SC
Ğ42, 14, 12, 3, 
no
,‚o) \

528 
	`SC
Ğ43, 14, 12, 4, 
no
,‚o) \

530 
	`SC
Ğ44, 15, 13, 1, 
no
,‚o) \

531 
	`SC
Ğ45, 15, 13, 2, 
no
,‚o) \

532 
	`SC
Ğ46, 15, 13, 3, 
no
,‚o) \

533 
	`SC
Ğ47, 15, 13, 4, 
no
,‚o) \

535 
	`SC
Ğ48, 16, 14, 1, 
no
,‚o) \

536 
	`SC
Ğ49, 16, 14, 2, 
no
,‚o) \

537 
	`SC
Ğ50, 16, 14, 3, 
no
,‚o) \

538 
	`SC
Ğ51, 16, 14, 4, 
no
,‚o) \

540 
	`SC
Ğ52, 17, 15, 1, 
no
,‚o) \

541 
	`SC
Ğ53, 17, 15, 2, 
no
,‚o) \

542 
	`SC
Ğ54, 17, 15, 3, 
no
,‚o) \

543 
	`SC
Ğ55, 17, 15, 4, 
no
,‚o) \

545 
	`SC
Ğ56, 18, 16, 1, 
no
,‚o) \

546 
	`SC
Ğ57, 18, 16, 2, 
no
,‚o) \

547 
	`SC
Ğ58, 18, 16, 3, 
no
,‚o) \

548 
	`SC
Ğ59, 18, 16, 4, 
no
,‚o) \

550 
	`SC
Ğ60, 19, 17, 1, 
no
,‚o) \

551 
	`SC
Ğ61, 19, 17, 2, 
no
,‚o) \

552 
	`SC
Ğ62, 19, 17, 3, 
no
,‚o) \

553 
	`SC
Ğ63, 19, 17, 4, 
no
,‚o) \

555 
	`SC
Ğ64, 20, 18, 1, 
no
,‚o) \

556 
	`SC
Ğ65, 20, 18, 2, 
no
,‚o) \

557 
	`SC
Ğ66, 20, 18, 3, 
no
,‚o) \

558 
	`SC
Ğ67, 20, 18, 4, 
no
,‚o) \

560 
	`SC
Ğ68, 21, 19, 1, 
no
,‚o) \

561 
	`SC
Ğ69, 21, 19, 2, 
no
,‚o) \

562 
	`SC
Ğ70, 21, 19, 3, 
no
,‚o) \

563 
	`SC
Ğ71, 21, 19, 4, 
no
,‚o) \

565 
	`SC
Ğ72, 22, 20, 1, 
no
,‚o) \

566 
	`SC
Ğ73, 22, 20, 2, 
no
,‚o) \

567 
	`SC
Ğ74, 22, 20, 3, 
no
,‚o) \

568 
	`SC
Ğ75, 22, 20, 4, 
no
,‚o) \

570 
	`SC
Ğ76, 23, 21, 1, 
no
,‚o) \

571 
	`SC
Ğ77, 23, 21, 2, 
no
,‚o) \

572 
	`SC
Ğ78, 23, 21, 3, 
no
,‚o) \

573 
	`SC
Ğ79, 23, 21, 4, 
no
,‚o) \

575 
	`SC
Ğ80, 24, 22, 1, 
no
,‚o) \

576 
	`SC
Ğ81, 24, 22, 2, 
no
,‚o) \

577 
	`SC
Ğ82, 24, 22, 3, 
no
,‚o) \

578 
	`SC
Ğ83, 24, 22, 4, 
no
,‚o) \

580 
	`SC
Ğ84, 25, 23, 1, 
no
,‚o) \

581 
	`SC
Ğ85, 25, 23, 2, 
no
,‚o) \

582 
	`SC
Ğ86, 25, 23, 3, 
no
,‚o) \

583 
	`SC
Ğ87, 25, 23, 4, 
no
,‚o) \

585 
	`SC
Ğ88, 26, 24, 1, 
no
,‚o) \

586 
	`SC
Ğ89, 26, 24, 2, 
no
,‚o) \

587 
	`SC
Ğ90, 26, 24, 3, 
no
,‚o) \

588 
	`SC
Ğ91, 26, 24, 4, 
no
,‚o) \

590 
	`SC
Ğ92, 27, 25, 1, 
no
,‚o) \

591 
	`SC
Ğ93, 27, 25, 2, 
no
,‚o) \

592 
	`SC
Ğ94, 27, 25, 3, 
no
,‚o) \

593 
	`SC
Ğ95, 27, 25, 4, 
no
,‚o) \

595 
	`SC
Ğ96, 28, 26, 1, 
no
,‚o) \

596 
	`SC
Ğ97, 28, 26, 2, 
no
,‚o) \

597 
	`SC
Ğ98, 28, 26, 3, 
no
,‚o) \

598 
	`SC
Ğ99, 28, 26, 4, 
no
,‚o) \

600 
	`SC
(100, 29, 27, 1, 
no
,‚o) \

601 
	`SC
(101, 29, 27, 2, 
no
,‚o) \

602 
	`SC
(102, 29, 27, 3, 
no
,‚o) \

603 
	`SC
(103, 29, 27, 4, 
no
,‚o) \

605 
	`SC
(104, 30, 28, 1, 
no
,‚o) \

606 
	`SC
(105, 30, 28, 2, 
no
,‚o) \

607 
	`SC
(106, 30, 28, 3, 
no
,‚o) \

608 
	`SC
(107, 30, 28, 4, 
no
,‚o) \

610 
	`SC
(108, 31, 29, 1, 
no
,‚o) \

611 
	`SC
(109, 31, 29, 2, 
no
,‚o) \

612 
	`SC
(110, 31, 29, 3, 
no
,‚o) \

613 
	`SC
(111, 31, 29, 4, 
no
,‚o) \

615 
	`SC
(112, 32, 30, 1, 
no
,‚o) \

616 
	`SC
(113, 32, 30, 2, 
no
,‚o) \

617 
	`SC
(114, 32, 30, 3, 
no
,‚o) \

618 
	`SC
(115, 32, 30, 4, 
no
,‚o) \

620 
	`SC
(116, 33, 31, 1, 
no
,‚o) \

621 
	`SC
(117, 33, 31, 2, 
no
,‚o) \

622 
	`SC
(118, 33, 31, 3, 
no
,‚o) \

623 
	`SC
(119, 33, 31, 4, 
no
,‚o) \

625 
	`SC
(120, 34, 32, 1, 
no
,‚o) \

626 
	`SC
(121, 34, 32, 2, 
no
,‚o) \

627 
	`SC
(122, 34, 32, 3, 
no
,‚o) \

628 
	`SC
(123, 34, 32, 4, 
no
,‚o) \

630 
	`SC
(124, 35, 33, 1, 
no
,‚o) \

631 
	`SC
(125, 35, 33, 2, 
no
,‚o) \

632 
	`SC
(126, 35, 33, 3, 
no
,‚o) \

633 
	`SC
(127, 35, 33, 4, 
no
,‚o) \

635 
	`SC
(128, 36, 34, 1, 
no
,‚o) \

636 
	`SC
(129, 36, 34, 2, 
no
,‚o) \

637 
	`SC
(130, 36, 34, 3, 
no
,‚o) \

638 
	`SC
(131, 36, 34, 4, 
no
,‚o) \

640 
	`SC
(132, 37, 35, 1, 
no
,‚o) \

641 
	`SC
(133, 37, 35, 2, 
no
,‚o) \

642 
	`SC
(134, 37, 35, 3, 
no
,‚o) \

643 
	`SC
(135, 37, 35, 4, 
no
,‚o) \

645 
	`SC
(136, 38, 36, 1, 
no
,‚o) \

646 
	`SC
(137, 38, 36, 2, 
no
,‚o) \

647 
	`SC
(138, 38, 36, 3, 
no
,‚o) \

648 
	`SC
(139, 38, 36, 4, 
no
,‚o) \

650 
	`SC
(140, 39, 37, 1, 
no
,‚o) \

651 
	`SC
(141, 39, 37, 2, 
no
,‚o) \

652 
	`SC
(142, 39, 37, 3, 
no
,‚o) \

653 
	`SC
(143, 39, 37, 4, 
no
,‚o) \

655 
	`SC
(144, 40, 38, 1, 
no
,‚o) \

656 
	`SC
(145, 40, 38, 2, 
no
,‚o) \

657 
	`SC
(146, 40, 38, 3, 
no
,‚o) \

658 
	`SC
(147, 40, 38, 4, 
no
,‚o) \

660 
	`SC
(148, 41, 39, 1, 
no
,‚o) \

661 
	`SC
(149, 41, 39, 2, 
no
,‚o) \

662 
	`SC
(150, 41, 39, 3, 
no
,‚o) \

663 
	`SC
(151, 41, 39, 4, 
no
,‚o) \

665 
	`SC
(152, 42, 40, 1, 
no
,‚o) \

666 
	`SC
(153, 42, 40, 2, 
no
,‚o) \

667 
	`SC
(154, 42, 40, 3, 
no
,‚o) \

668 
	`SC
(155, 42, 40, 4, 
no
,‚o) \

670 
	`SC
(156, 43, 41, 1, 
no
,‚o) \

671 
	`SC
(157, 43, 41, 2, 
no
,‚o) \

672 
	`SC
(158, 43, 41, 3, 
no
,‚o) \

673 
	`SC
(159, 43, 41, 4, 
no
,‚o) \

675 
	`SC
(160, 44, 42, 1, 
no
,‚o) \

676 
	`SC
(161, 44, 42, 2, 
no
,‚o) \

677 
	`SC
(162, 44, 42, 3, 
no
,‚o) \

678 
	`SC
(163, 44, 42, 4, 
no
,‚o) \

680 
	`SC
(164, 45, 43, 1, 
no
,‚o) \

681 
	`SC
(165, 45, 43, 2, 
no
,‚o) \

682 
	`SC
(166, 45, 43, 3, 
no
,‚o) \

683 
	`SC
(167, 45, 43, 4, 
no
,‚o) \

685 
	`SC
(168, 46, 44, 1, 
no
,‚o) \

686 
	`SC
(169, 46, 44, 2, 
no
,‚o) \

687 
	`SC
(170, 46, 44, 3, 
no
,‚o) \

688 
	`SC
(171, 46, 44, 4, 
no
,‚o) \

690 
	`SC
(172, 47, 45, 1, 
no
,‚o) \

691 
	`SC
(173, 47, 45, 2, 
no
,‚o) \

692 
	`SC
(174, 47, 45, 3, 
no
,‚o) \

693 
	`SC
(175, 47, 45, 4, 
no
,‚o) \

695 
	`SC
(176, 48, 46, 1, 
no
,‚o) \

696 
	`SC
(177, 48, 46, 2, 
no
,‚o) \

697 
	`SC
(178, 48, 46, 3, 
no
,‚o) \

698 
	`SC
(179, 48, 46, 4, 
no
,‚o) \

700 
	`SC
(180, 49, 47, 1, 
no
,‚o) \

701 
	`SC
(181, 49, 47, 2, 
no
,‚o) \

702 
	`SC
(182, 49, 47, 3, 
no
,‚o) \

703 
	`SC
(183, 49, 47, 4, 
no
,‚o) \

705 
	`SC
(184, 50, 48, 1, 
no
,‚o) \

706 
	`SC
(185, 50, 48, 2, 
no
,‚o) \

707 
	`SC
(186, 50, 48, 3, 
no
,‚o) \

708 
	`SC
(187, 50, 48, 4, 
no
,‚o) \

710 
	`SC
(188, 51, 49, 1, 
no
,‚o) \

711 
	`SC
(189, 51, 49, 2, 
no
,‚o) \

712 
	`SC
(190, 51, 49, 3, 
no
,‚o) \

713 
	`SC
(191, 51, 49, 4, 
no
,‚o) \

715 
	`SC
(192, 52, 50, 1, 
no
,‚o) \

716 
	`SC
(193, 52, 50, 2, 
no
,‚o) \

717 
	`SC
(194, 52, 50, 3, 
no
,‚o) \

718 
	`SC
(195, 52, 50, 4, 
no
,‚o) \

720 
	`SC
(196, 53, 51, 1, 
no
,‚o) \

721 
	`SC
(197, 53, 51, 2, 
no
,‚o) \

722 
	`SC
(198, 53, 51, 3, 
no
,‚o) \

723 
	`SC
(199, 53, 51, 4, 
no
,‚o) \

725 
	`SC
(200, 54, 52, 1, 
no
,‚o) \

726 
	`SC
(201, 54, 52, 2, 
no
,‚o) \

727 
	`SC
(202, 54, 52, 3, 
no
,‚o) \

728 
	`SC
(203, 54, 52, 4, 
no
,‚o) \

730 
	`SC
(204, 55, 53, 1, 
no
,‚o) \

731 
	`SC
(205, 55, 53, 2, 
no
,‚o) \

732 
	`SC
(206, 55, 53, 3, 
no
,‚o) \

733 
	`SC
(207, 55, 53, 4, 
no
,‚o) \

735 
	`SC
(208, 56, 54, 1, 
no
,‚o) \

736 
	`SC
(209, 56, 54, 2, 
no
,‚o) \

737 
	`SC
(210, 56, 54, 3, 
no
,‚o) \

738 
	`SC
(211, 56, 54, 4, 
no
,‚o) \

740 
	`SC
(212, 57, 55, 1, 
no
,‚o) \

741 
	`SC
(213, 57, 55, 2, 
no
,‚o) \

742 
	`SC
(214, 57, 55, 3, 
no
,‚o) \

743 
	`SC
(215, 57, 55, 4, 
no
,‚o) \

745 
	`SC
(216, 58, 56, 1, 
no
,‚o) \

746 
	`SC
(217, 58, 56, 2, 
no
,‚o) \

747 
	`SC
(218, 58, 56, 3, 
no
,‚o) \

748 
	`SC
(219, 58, 56, 4, 
no
,‚o) \

750 
	`SC
(220, 59, 57, 1, 
no
,‚o) \

751 
	`SC
(221, 59, 57, 2, 
no
,‚o) \

752 
	`SC
(222, 59, 57, 3, 
no
,‚o) \

753 
	`SC
(223, 59, 57, 4, 
no
,‚o) \

755 
	`SC
(224, 60, 58, 1, 
no
,‚o) \

756 
	`SC
(225, 60, 58, 2, 
no
,‚o) \

757 
	`SC
(226, 60, 58, 3, 
no
,‚o) \

758 
	`SC
(227, 60, 58, 4, 
no
,‚o) \

760 
	`SC
(228, 61, 59, 1, 
no
,‚o) \

761 
	`SC
(229, 61, 59, 2, 
no
,‚o) \

762 
	`SC
(230, 61, 59, 3, 
no
,‚o) \

763 
	`SC
(231, 61, 59, 4, 
no
,‚o) \

765 
	`SC
(232, 62, 60, 1, 
no
,‚o) \

766 
	`SC
(233, 62, 60, 2, 
no
,‚o) \

767 
	`SC
(234, 62, 60, 3, 
no
,‚o) \

768 

	)

769 
	#SIZE_CLASSES_DEFINED


	)

770 
	#NTBINS
 0

	)

771 
	#NLBINS
 32

	)

772 
	#NBINS
 39

	)

773 
	#NSIZES
 235

	)

774 
	#LG_TINY_MAXCLASS
 "NA"

	)

775 
	#LOOKUP_MAXCLASS
 ((((
size_t
)1è<< 11è+ (((size_t)4è<< 9))

	)

776 
	#SMALL_MAXCLASS
 ((((
size_t
)1è<< 13è+ (((size_t)3è<< 11))

	)

777 
	#LG_LARGE_MINCLASS
 14

	)

778 
	#HUGE_MAXCLASS
 ((((
size_t
)1è<< 62è+ (((size_t)3è<< 60))

	)

781 #ià(
LG_SIZEOF_PTR
 =ğ3 && 
LG_TINY_MIN
 =ğ3 && 
LG_QUANTUM
 =ğ4 && 
LG_PAGE
 == 12)

782 
	#SIZE_CLASSES
 \

784 
	`SC
Ğ0, 3, 3, 0, 
yes
, 3) \

786 
	`SC
Ğ1, 3, 3, 1, 
yes
, 3) \

787 
	`SC
Ğ2, 4, 4, 1, 
yes
, 4) \

788 
	`SC
Ğ3, 4, 4, 2, 
yes
, 4) \

789 
	`SC
Ğ4, 4, 4, 3, 
yes
, 4) \

791 
	`SC
Ğ5, 6, 4, 1, 
yes
, 4) \

792 
	`SC
Ğ6, 6, 4, 2, 
yes
, 4) \

793 
	`SC
Ğ7, 6, 4, 3, 
yes
, 4) \

794 
	`SC
Ğ8, 6, 4, 4, 
yes
, 4) \

796 
	`SC
Ğ9, 7, 5, 1, 
yes
, 5) \

797 
	`SC
Ğ10, 7, 5, 2, 
yes
, 5) \

798 
	`SC
Ğ11, 7, 5, 3, 
yes
, 5) \

799 
	`SC
Ğ12, 7, 5, 4, 
yes
, 5) \

801 
	`SC
Ğ13, 8, 6, 1, 
yes
, 6) \

802 
	`SC
Ğ14, 8, 6, 2, 
yes
, 6) \

803 
	`SC
Ğ15, 8, 6, 3, 
yes
, 6) \

804 
	`SC
Ğ16, 8, 6, 4, 
yes
, 6) \

806 
	`SC
Ğ17, 9, 7, 1, 
yes
, 7) \

807 
	`SC
Ğ18, 9, 7, 2, 
yes
, 7) \

808 
	`SC
Ğ19, 9, 7, 3, 
yes
, 7) \

809 
	`SC
Ğ20, 9, 7, 4, 
yes
, 7) \

811 
	`SC
Ğ21, 10, 8, 1, 
yes
, 8) \

812 
	`SC
Ğ22, 10, 8, 2, 
yes
, 8) \

813 
	`SC
Ğ23, 10, 8, 3, 
yes
, 8) \

814 
	`SC
Ğ24, 10, 8, 4, 
yes
, 8) \

816 
	`SC
Ğ25, 11, 9, 1, 
yes
, 9) \

817 
	`SC
Ğ26, 11, 9, 2, 
yes
, 9) \

818 
	`SC
Ğ27, 11, 9, 3, 
yes
, 9) \

819 
	`SC
Ğ28, 11, 9, 4, 
yes
, 9) \

821 
	`SC
Ğ29, 12, 10, 1, 
yes
, 
no
) \

822 
	`SC
Ğ30, 12, 10, 2, 
yes
, 
no
) \

823 
	`SC
Ğ31, 12, 10, 3, 
yes
, 
no
) \

824 
	`SC
Ğ32, 12, 10, 4, 
yes
, 
no
) \

826 
	`SC
Ğ33, 13, 11, 1, 
yes
, 
no
) \

827 
	`SC
Ğ34, 13, 11, 2, 
yes
, 
no
) \

828 
	`SC
Ğ35, 13, 11, 3, 
yes
, 
no
) \

829 
	`SC
Ğ36, 13, 11, 4, 
no
,‚o) \

831 
	`SC
Ğ37, 14, 12, 1, 
no
,‚o) \

832 
	`SC
Ğ38, 14, 12, 2, 
no
,‚o) \

833 
	`SC
Ğ39, 14, 12, 3, 
no
,‚o) \

834 
	`SC
Ğ40, 14, 12, 4, 
no
,‚o) \

836 
	`SC
Ğ41, 15, 13, 1, 
no
,‚o) \

837 
	`SC
Ğ42, 15, 13, 2, 
no
,‚o) \

838 
	`SC
Ğ43, 15, 13, 3, 
no
,‚o) \

839 
	`SC
Ğ44, 15, 13, 4, 
no
,‚o) \

841 
	`SC
Ğ45, 16, 14, 1, 
no
,‚o) \

842 
	`SC
Ğ46, 16, 14, 2, 
no
,‚o) \

843 
	`SC
Ğ47, 16, 14, 3, 
no
,‚o) \

844 
	`SC
Ğ48, 16, 14, 4, 
no
,‚o) \

846 
	`SC
Ğ49, 17, 15, 1, 
no
,‚o) \

847 
	`SC
Ğ50, 17, 15, 2, 
no
,‚o) \

848 
	`SC
Ğ51, 17, 15, 3, 
no
,‚o) \

849 
	`SC
Ğ52, 17, 15, 4, 
no
,‚o) \

851 
	`SC
Ğ53, 18, 16, 1, 
no
,‚o) \

852 
	`SC
Ğ54, 18, 16, 2, 
no
,‚o) \

853 
	`SC
Ğ55, 18, 16, 3, 
no
,‚o) \

854 
	`SC
Ğ56, 18, 16, 4, 
no
,‚o) \

856 
	`SC
Ğ57, 19, 17, 1, 
no
,‚o) \

857 
	`SC
Ğ58, 19, 17, 2, 
no
,‚o) \

858 
	`SC
Ğ59, 19, 17, 3, 
no
,‚o) \

859 
	`SC
Ğ60, 19, 17, 4, 
no
,‚o) \

861 
	`SC
Ğ61, 20, 18, 1, 
no
,‚o) \

862 
	`SC
Ğ62, 20, 18, 2, 
no
,‚o) \

863 
	`SC
Ğ63, 20, 18, 3, 
no
,‚o) \

864 
	`SC
Ğ64, 20, 18, 4, 
no
,‚o) \

866 
	`SC
Ğ65, 21, 19, 1, 
no
,‚o) \

867 
	`SC
Ğ66, 21, 19, 2, 
no
,‚o) \

868 
	`SC
Ğ67, 21, 19, 3, 
no
,‚o) \

869 
	`SC
Ğ68, 21, 19, 4, 
no
,‚o) \

871 
	`SC
Ğ69, 22, 20, 1, 
no
,‚o) \

872 
	`SC
Ğ70, 22, 20, 2, 
no
,‚o) \

873 
	`SC
Ğ71, 22, 20, 3, 
no
,‚o) \

874 
	`SC
Ğ72, 22, 20, 4, 
no
,‚o) \

876 
	`SC
Ğ73, 23, 21, 1, 
no
,‚o) \

877 
	`SC
Ğ74, 23, 21, 2, 
no
,‚o) \

878 
	`SC
Ğ75, 23, 21, 3, 
no
,‚o) \

879 
	`SC
Ğ76, 23, 21, 4, 
no
,‚o) \

881 
	`SC
Ğ77, 24, 22, 1, 
no
,‚o) \

882 
	`SC
Ğ78, 24, 22, 2, 
no
,‚o) \

883 
	`SC
Ğ79, 24, 22, 3, 
no
,‚o) \

884 
	`SC
Ğ80, 24, 22, 4, 
no
,‚o) \

886 
	`SC
Ğ81, 25, 23, 1, 
no
,‚o) \

887 
	`SC
Ğ82, 25, 23, 2, 
no
,‚o) \

888 
	`SC
Ğ83, 25, 23, 3, 
no
,‚o) \

889 
	`SC
Ğ84, 25, 23, 4, 
no
,‚o) \

891 
	`SC
Ğ85, 26, 24, 1, 
no
,‚o) \

892 
	`SC
Ğ86, 26, 24, 2, 
no
,‚o) \

893 
	`SC
Ğ87, 26, 24, 3, 
no
,‚o) \

894 
	`SC
Ğ88, 26, 24, 4, 
no
,‚o) \

896 
	`SC
Ğ89, 27, 25, 1, 
no
,‚o) \

897 
	`SC
Ğ90, 27, 25, 2, 
no
,‚o) \

898 
	`SC
Ğ91, 27, 25, 3, 
no
,‚o) \

899 
	`SC
Ğ92, 27, 25, 4, 
no
,‚o) \

901 
	`SC
Ğ93, 28, 26, 1, 
no
,‚o) \

902 
	`SC
Ğ94, 28, 26, 2, 
no
,‚o) \

903 
	`SC
Ğ95, 28, 26, 3, 
no
,‚o) \

904 
	`SC
Ğ96, 28, 26, 4, 
no
,‚o) \

906 
	`SC
Ğ97, 29, 27, 1, 
no
,‚o) \

907 
	`SC
Ğ98, 29, 27, 2, 
no
,‚o) \

908 
	`SC
Ğ99, 29, 27, 3, 
no
,‚o) \

909 
	`SC
(100, 29, 27, 4, 
no
,‚o) \

911 
	`SC
(101, 30, 28, 1, 
no
,‚o) \

912 
	`SC
(102, 30, 28, 2, 
no
,‚o) \

913 
	`SC
(103, 30, 28, 3, 
no
,‚o) \

914 
	`SC
(104, 30, 28, 4, 
no
,‚o) \

916 
	`SC
(105, 31, 29, 1, 
no
,‚o) \

917 
	`SC
(106, 31, 29, 2, 
no
,‚o) \

918 
	`SC
(107, 31, 29, 3, 
no
,‚o) \

919 
	`SC
(108, 31, 29, 4, 
no
,‚o) \

921 
	`SC
(109, 32, 30, 1, 
no
,‚o) \

922 
	`SC
(110, 32, 30, 2, 
no
,‚o) \

923 
	`SC
(111, 32, 30, 3, 
no
,‚o) \

924 
	`SC
(112, 32, 30, 4, 
no
,‚o) \

926 
	`SC
(113, 33, 31, 1, 
no
,‚o) \

927 
	`SC
(114, 33, 31, 2, 
no
,‚o) \

928 
	`SC
(115, 33, 31, 3, 
no
,‚o) \

929 
	`SC
(116, 33, 31, 4, 
no
,‚o) \

931 
	`SC
(117, 34, 32, 1, 
no
,‚o) \

932 
	`SC
(118, 34, 32, 2, 
no
,‚o) \

933 
	`SC
(119, 34, 32, 3, 
no
,‚o) \

934 
	`SC
(120, 34, 32, 4, 
no
,‚o) \

936 
	`SC
(121, 35, 33, 1, 
no
,‚o) \

937 
	`SC
(122, 35, 33, 2, 
no
,‚o) \

938 
	`SC
(123, 35, 33, 3, 
no
,‚o) \

939 
	`SC
(124, 35, 33, 4, 
no
,‚o) \

941 
	`SC
(125, 36, 34, 1, 
no
,‚o) \

942 
	`SC
(126, 36, 34, 2, 
no
,‚o) \

943 
	`SC
(127, 36, 34, 3, 
no
,‚o) \

944 
	`SC
(128, 36, 34, 4, 
no
,‚o) \

946 
	`SC
(129, 37, 35, 1, 
no
,‚o) \

947 
	`SC
(130, 37, 35, 2, 
no
,‚o) \

948 
	`SC
(131, 37, 35, 3, 
no
,‚o) \

949 
	`SC
(132, 37, 35, 4, 
no
,‚o) \

951 
	`SC
(133, 38, 36, 1, 
no
,‚o) \

952 
	`SC
(134, 38, 36, 2, 
no
,‚o) \

953 
	`SC
(135, 38, 36, 3, 
no
,‚o) \

954 
	`SC
(136, 38, 36, 4, 
no
,‚o) \

956 
	`SC
(137, 39, 37, 1, 
no
,‚o) \

957 
	`SC
(138, 39, 37, 2, 
no
,‚o) \

958 
	`SC
(139, 39, 37, 3, 
no
,‚o) \

959 
	`SC
(140, 39, 37, 4, 
no
,‚o) \

961 
	`SC
(141, 40, 38, 1, 
no
,‚o) \

962 
	`SC
(142, 40, 38, 2, 
no
,‚o) \

963 
	`SC
(143, 40, 38, 3, 
no
,‚o) \

964 
	`SC
(144, 40, 38, 4, 
no
,‚o) \

966 
	`SC
(145, 41, 39, 1, 
no
,‚o) \

967 
	`SC
(146, 41, 39, 2, 
no
,‚o) \

968 
	`SC
(147, 41, 39, 3, 
no
,‚o) \

969 
	`SC
(148, 41, 39, 4, 
no
,‚o) \

971 
	`SC
(149, 42, 40, 1, 
no
,‚o) \

972 
	`SC
(150, 42, 40, 2, 
no
,‚o) \

973 
	`SC
(151, 42, 40, 3, 
no
,‚o) \

974 
	`SC
(152, 42, 40, 4, 
no
,‚o) \

976 
	`SC
(153, 43, 41, 1, 
no
,‚o) \

977 
	`SC
(154, 43, 41, 2, 
no
,‚o) \

978 
	`SC
(155, 43, 41, 3, 
no
,‚o) \

979 
	`SC
(156, 43, 41, 4, 
no
,‚o) \

981 
	`SC
(157, 44, 42, 1, 
no
,‚o) \

982 
	`SC
(158, 44, 42, 2, 
no
,‚o) \

983 
	`SC
(159, 44, 42, 3, 
no
,‚o) \

984 
	`SC
(160, 44, 42, 4, 
no
,‚o) \

986 
	`SC
(161, 45, 43, 1, 
no
,‚o) \

987 
	`SC
(162, 45, 43, 2, 
no
,‚o) \

988 
	`SC
(163, 45, 43, 3, 
no
,‚o) \

989 
	`SC
(164, 45, 43, 4, 
no
,‚o) \

991 
	`SC
(165, 46, 44, 1, 
no
,‚o) \

992 
	`SC
(166, 46, 44, 2, 
no
,‚o) \

993 
	`SC
(167, 46, 44, 3, 
no
,‚o) \

994 
	`SC
(168, 46, 44, 4, 
no
,‚o) \

996 
	`SC
(169, 47, 45, 1, 
no
,‚o) \

997 
	`SC
(170, 47, 45, 2, 
no
,‚o) \

998 
	`SC
(171, 47, 45, 3, 
no
,‚o) \

999 
	`SC
(172, 47, 45, 4, 
no
,‚o) \

1001 
	`SC
(173, 48, 46, 1, 
no
,‚o) \

1002 
	`SC
(174, 48, 46, 2, 
no
,‚o) \

1003 
	`SC
(175, 48, 46, 3, 
no
,‚o) \

1004 
	`SC
(176, 48, 46, 4, 
no
,‚o) \

1006 
	`SC
(177, 49, 47, 1, 
no
,‚o) \

1007 
	`SC
(178, 49, 47, 2, 
no
,‚o) \

1008 
	`SC
(179, 49, 47, 3, 
no
,‚o) \

1009 
	`SC
(180, 49, 47, 4, 
no
,‚o) \

1011 
	`SC
(181, 50, 48, 1, 
no
,‚o) \

1012 
	`SC
(182, 50, 48, 2, 
no
,‚o) \

1013 
	`SC
(183, 50, 48, 3, 
no
,‚o) \

1014 
	`SC
(184, 50, 48, 4, 
no
,‚o) \

1016 
	`SC
(185, 51, 49, 1, 
no
,‚o) \

1017 
	`SC
(186, 51, 49, 2, 
no
,‚o) \

1018 
	`SC
(187, 51, 49, 3, 
no
,‚o) \

1019 
	`SC
(188, 51, 49, 4, 
no
,‚o) \

1021 
	`SC
(189, 52, 50, 1, 
no
,‚o) \

1022 
	`SC
(190, 52, 50, 2, 
no
,‚o) \

1023 
	`SC
(191, 52, 50, 3, 
no
,‚o) \

1024 
	`SC
(192, 52, 50, 4, 
no
,‚o) \

1026 
	`SC
(193, 53, 51, 1, 
no
,‚o) \

1027 
	`SC
(194, 53, 51, 2, 
no
,‚o) \

1028 
	`SC
(195, 53, 51, 3, 
no
,‚o) \

1029 
	`SC
(196, 53, 51, 4, 
no
,‚o) \

1031 
	`SC
(197, 54, 52, 1, 
no
,‚o) \

1032 
	`SC
(198, 54, 52, 2, 
no
,‚o) \

1033 
	`SC
(199, 54, 52, 3, 
no
,‚o) \

1034 
	`SC
(200, 54, 52, 4, 
no
,‚o) \

1036 
	`SC
(201, 55, 53, 1, 
no
,‚o) \

1037 
	`SC
(202, 55, 53, 2, 
no
,‚o) \

1038 
	`SC
(203, 55, 53, 3, 
no
,‚o) \

1039 
	`SC
(204, 55, 53, 4, 
no
,‚o) \

1041 
	`SC
(205, 56, 54, 1, 
no
,‚o) \

1042 
	`SC
(206, 56, 54, 2, 
no
,‚o) \

1043 
	`SC
(207, 56, 54, 3, 
no
,‚o) \

1044 
	`SC
(208, 56, 54, 4, 
no
,‚o) \

1046 
	`SC
(209, 57, 55, 1, 
no
,‚o) \

1047 
	`SC
(210, 57, 55, 2, 
no
,‚o) \

1048 
	`SC
(211, 57, 55, 3, 
no
,‚o) \

1049 
	`SC
(212, 57, 55, 4, 
no
,‚o) \

1051 
	`SC
(213, 58, 56, 1, 
no
,‚o) \

1052 
	`SC
(214, 58, 56, 2, 
no
,‚o) \

1053 
	`SC
(215, 58, 56, 3, 
no
,‚o) \

1054 
	`SC
(216, 58, 56, 4, 
no
,‚o) \

1056 
	`SC
(217, 59, 57, 1, 
no
,‚o) \

1057 
	`SC
(218, 59, 57, 2, 
no
,‚o) \

1058 
	`SC
(219, 59, 57, 3, 
no
,‚o) \

1059 
	`SC
(220, 59, 57, 4, 
no
,‚o) \

1061 
	`SC
(221, 60, 58, 1, 
no
,‚o) \

1062 
	`SC
(222, 60, 58, 2, 
no
,‚o) \

1063 
	`SC
(223, 60, 58, 3, 
no
,‚o) \

1064 
	`SC
(224, 60, 58, 4, 
no
,‚o) \

1066 
	`SC
(225, 61, 59, 1, 
no
,‚o) \

1067 
	`SC
(226, 61, 59, 2, 
no
,‚o) \

1068 
	`SC
(227, 61, 59, 3, 
no
,‚o) \

1069 
	`SC
(228, 61, 59, 4, 
no
,‚o) \

1071 
	`SC
(229, 62, 60, 1, 
no
,‚o) \

1072 
	`SC
(230, 62, 60, 2, 
no
,‚o) \

1073 
	`SC
(231, 62, 60, 3, 
no
,‚o) \

1074 

	)

1075 
	#SIZE_CLASSES_DEFINED


	)

1076 
	#NTBINS
 1

	)

1077 
	#NLBINS
 29

	)

1078 
	#NBINS
 36

	)

1079 
	#NSIZES
 232

	)

1080 
	#LG_TINY_MAXCLASS
 3

	)

1081 
	#LOOKUP_MAXCLASS
 ((((
size_t
)1è<< 11è+ (((size_t)4è<< 9))

	)

1082 
	#SMALL_MAXCLASS
 ((((
size_t
)1è<< 13è+ (((size_t)3è<< 11))

	)

1083 
	#LG_LARGE_MINCLASS
 14

	)

1084 
	#HUGE_MAXCLASS
 ((((
size_t
)1è<< 62è+ (((size_t)3è<< 60))

	)

1087 #ià(
LG_SIZEOF_PTR
 =ğ3 && 
LG_TINY_MIN
 =ğ4 && 
LG_QUANTUM
 =ğ4 && 
LG_PAGE
 == 12)

1088 
	#SIZE_CLASSES
 \

1090 
	`SC
Ğ0, 4, 4, 0, 
yes
, 4) \

1091 
	`SC
Ğ1, 4, 4, 1, 
yes
, 4) \

1092 
	`SC
Ğ2, 4, 4, 2, 
yes
, 4) \

1093 
	`SC
Ğ3, 4, 4, 3, 
yes
, 4) \

1095 
	`SC
Ğ4, 6, 4, 1, 
yes
, 4) \

1096 
	`SC
Ğ5, 6, 4, 2, 
yes
, 4) \

1097 
	`SC
Ğ6, 6, 4, 3, 
yes
, 4) \

1098 
	`SC
Ğ7, 6, 4, 4, 
yes
, 4) \

1100 
	`SC
Ğ8, 7, 5, 1, 
yes
, 5) \

1101 
	`SC
Ğ9, 7, 5, 2, 
yes
, 5) \

1102 
	`SC
Ğ10, 7, 5, 3, 
yes
, 5) \

1103 
	`SC
Ğ11, 7, 5, 4, 
yes
, 5) \

1105 
	`SC
Ğ12, 8, 6, 1, 
yes
, 6) \

1106 
	`SC
Ğ13, 8, 6, 2, 
yes
, 6) \

1107 
	`SC
Ğ14, 8, 6, 3, 
yes
, 6) \

1108 
	`SC
Ğ15, 8, 6, 4, 
yes
, 6) \

1110 
	`SC
Ğ16, 9, 7, 1, 
yes
, 7) \

1111 
	`SC
Ğ17, 9, 7, 2, 
yes
, 7) \

1112 
	`SC
Ğ18, 9, 7, 3, 
yes
, 7) \

1113 
	`SC
Ğ19, 9, 7, 4, 
yes
, 7) \

1115 
	`SC
Ğ20, 10, 8, 1, 
yes
, 8) \

1116 
	`SC
Ğ21, 10, 8, 2, 
yes
, 8) \

1117 
	`SC
Ğ22, 10, 8, 3, 
yes
, 8) \

1118 
	`SC
Ğ23, 10, 8, 4, 
yes
, 8) \

1120 
	`SC
Ğ24, 11, 9, 1, 
yes
, 9) \

1121 
	`SC
Ğ25, 11, 9, 2, 
yes
, 9) \

1122 
	`SC
Ğ26, 11, 9, 3, 
yes
, 9) \

1123 
	`SC
Ğ27, 11, 9, 4, 
yes
, 9) \

1125 
	`SC
Ğ28, 12, 10, 1, 
yes
, 
no
) \

1126 
	`SC
Ğ29, 12, 10, 2, 
yes
, 
no
) \

1127 
	`SC
Ğ30, 12, 10, 3, 
yes
, 
no
) \

1128 
	`SC
Ğ31, 12, 10, 4, 
yes
, 
no
) \

1130 
	`SC
Ğ32, 13, 11, 1, 
yes
, 
no
) \

1131 
	`SC
Ğ33, 13, 11, 2, 
yes
, 
no
) \

1132 
	`SC
Ğ34, 13, 11, 3, 
yes
, 
no
) \

1133 
	`SC
Ğ35, 13, 11, 4, 
no
,‚o) \

1135 
	`SC
Ğ36, 14, 12, 1, 
no
,‚o) \

1136 
	`SC
Ğ37, 14, 12, 2, 
no
,‚o) \

1137 
	`SC
Ğ38, 14, 12, 3, 
no
,‚o) \

1138 
	`SC
Ğ39, 14, 12, 4, 
no
,‚o) \

1140 
	`SC
Ğ40, 15, 13, 1, 
no
,‚o) \

1141 
	`SC
Ğ41, 15, 13, 2, 
no
,‚o) \

1142 
	`SC
Ğ42, 15, 13, 3, 
no
,‚o) \

1143 
	`SC
Ğ43, 15, 13, 4, 
no
,‚o) \

1145 
	`SC
Ğ44, 16, 14, 1, 
no
,‚o) \

1146 
	`SC
Ğ45, 16, 14, 2, 
no
,‚o) \

1147 
	`SC
Ğ46, 16, 14, 3, 
no
,‚o) \

1148 
	`SC
Ğ47, 16, 14, 4, 
no
,‚o) \

1150 
	`SC
Ğ48, 17, 15, 1, 
no
,‚o) \

1151 
	`SC
Ğ49, 17, 15, 2, 
no
,‚o) \

1152 
	`SC
Ğ50, 17, 15, 3, 
no
,‚o) \

1153 
	`SC
Ğ51, 17, 15, 4, 
no
,‚o) \

1155 
	`SC
Ğ52, 18, 16, 1, 
no
,‚o) \

1156 
	`SC
Ğ53, 18, 16, 2, 
no
,‚o) \

1157 
	`SC
Ğ54, 18, 16, 3, 
no
,‚o) \

1158 
	`SC
Ğ55, 18, 16, 4, 
no
,‚o) \

1160 
	`SC
Ğ56, 19, 17, 1, 
no
,‚o) \

1161 
	`SC
Ğ57, 19, 17, 2, 
no
,‚o) \

1162 
	`SC
Ğ58, 19, 17, 3, 
no
,‚o) \

1163 
	`SC
Ğ59, 19, 17, 4, 
no
,‚o) \

1165 
	`SC
Ğ60, 20, 18, 1, 
no
,‚o) \

1166 
	`SC
Ğ61, 20, 18, 2, 
no
,‚o) \

1167 
	`SC
Ğ62, 20, 18, 3, 
no
,‚o) \

1168 
	`SC
Ğ63, 20, 18, 4, 
no
,‚o) \

1170 
	`SC
Ğ64, 21, 19, 1, 
no
,‚o) \

1171 
	`SC
Ğ65, 21, 19, 2, 
no
,‚o) \

1172 
	`SC
Ğ66, 21, 19, 3, 
no
,‚o) \

1173 
	`SC
Ğ67, 21, 19, 4, 
no
,‚o) \

1175 
	`SC
Ğ68, 22, 20, 1, 
no
,‚o) \

1176 
	`SC
Ğ69, 22, 20, 2, 
no
,‚o) \

1177 
	`SC
Ğ70, 22, 20, 3, 
no
,‚o) \

1178 
	`SC
Ğ71, 22, 20, 4, 
no
,‚o) \

1180 
	`SC
Ğ72, 23, 21, 1, 
no
,‚o) \

1181 
	`SC
Ğ73, 23, 21, 2, 
no
,‚o) \

1182 
	`SC
Ğ74, 23, 21, 3, 
no
,‚o) \

1183 
	`SC
Ğ75, 23, 21, 4, 
no
,‚o) \

1185 
	`SC
Ğ76, 24, 22, 1, 
no
,‚o) \

1186 
	`SC
Ğ77, 24, 22, 2, 
no
,‚o) \

1187 
	`SC
Ğ78, 24, 22, 3, 
no
,‚o) \

1188 
	`SC
Ğ79, 24, 22, 4, 
no
,‚o) \

1190 
	`SC
Ğ80, 25, 23, 1, 
no
,‚o) \

1191 
	`SC
Ğ81, 25, 23, 2, 
no
,‚o) \

1192 
	`SC
Ğ82, 25, 23, 3, 
no
,‚o) \

1193 
	`SC
Ğ83, 25, 23, 4, 
no
,‚o) \

1195 
	`SC
Ğ84, 26, 24, 1, 
no
,‚o) \

1196 
	`SC
Ğ85, 26, 24, 2, 
no
,‚o) \

1197 
	`SC
Ğ86, 26, 24, 3, 
no
,‚o) \

1198 
	`SC
Ğ87, 26, 24, 4, 
no
,‚o) \

1200 
	`SC
Ğ88, 27, 25, 1, 
no
,‚o) \

1201 
	`SC
Ğ89, 27, 25, 2, 
no
,‚o) \

1202 
	`SC
Ğ90, 27, 25, 3, 
no
,‚o) \

1203 
	`SC
Ğ91, 27, 25, 4, 
no
,‚o) \

1205 
	`SC
Ğ92, 28, 26, 1, 
no
,‚o) \

1206 
	`SC
Ğ93, 28, 26, 2, 
no
,‚o) \

1207 
	`SC
Ğ94, 28, 26, 3, 
no
,‚o) \

1208 
	`SC
Ğ95, 28, 26, 4, 
no
,‚o) \

1210 
	`SC
Ğ96, 29, 27, 1, 
no
,‚o) \

1211 
	`SC
Ğ97, 29, 27, 2, 
no
,‚o) \

1212 
	`SC
Ğ98, 29, 27, 3, 
no
,‚o) \

1213 
	`SC
Ğ99, 29, 27, 4, 
no
,‚o) \

1215 
	`SC
(100, 30, 28, 1, 
no
,‚o) \

1216 
	`SC
(101, 30, 28, 2, 
no
,‚o) \

1217 
	`SC
(102, 30, 28, 3, 
no
,‚o) \

1218 
	`SC
(103, 30, 28, 4, 
no
,‚o) \

1220 
	`SC
(104, 31, 29, 1, 
no
,‚o) \

1221 
	`SC
(105, 31, 29, 2, 
no
,‚o) \

1222 
	`SC
(106, 31, 29, 3, 
no
,‚o) \

1223 
	`SC
(107, 31, 29, 4, 
no
,‚o) \

1225 
	`SC
(108, 32, 30, 1, 
no
,‚o) \

1226 
	`SC
(109, 32, 30, 2, 
no
,‚o) \

1227 
	`SC
(110, 32, 30, 3, 
no
,‚o) \

1228 
	`SC
(111, 32, 30, 4, 
no
,‚o) \

1230 
	`SC
(112, 33, 31, 1, 
no
,‚o) \

1231 
	`SC
(113, 33, 31, 2, 
no
,‚o) \

1232 
	`SC
(114, 33, 31, 3, 
no
,‚o) \

1233 
	`SC
(115, 33, 31, 4, 
no
,‚o) \

1235 
	`SC
(116, 34, 32, 1, 
no
,‚o) \

1236 
	`SC
(117, 34, 32, 2, 
no
,‚o) \

1237 
	`SC
(118, 34, 32, 3, 
no
,‚o) \

1238 
	`SC
(119, 34, 32, 4, 
no
,‚o) \

1240 
	`SC
(120, 35, 33, 1, 
no
,‚o) \

1241 
	`SC
(121, 35, 33, 2, 
no
,‚o) \

1242 
	`SC
(122, 35, 33, 3, 
no
,‚o) \

1243 
	`SC
(123, 35, 33, 4, 
no
,‚o) \

1245 
	`SC
(124, 36, 34, 1, 
no
,‚o) \

1246 
	`SC
(125, 36, 34, 2, 
no
,‚o) \

1247 
	`SC
(126, 36, 34, 3, 
no
,‚o) \

1248 
	`SC
(127, 36, 34, 4, 
no
,‚o) \

1250 
	`SC
(128, 37, 35, 1, 
no
,‚o) \

1251 
	`SC
(129, 37, 35, 2, 
no
,‚o) \

1252 
	`SC
(130, 37, 35, 3, 
no
,‚o) \

1253 
	`SC
(131, 37, 35, 4, 
no
,‚o) \

1255 
	`SC
(132, 38, 36, 1, 
no
,‚o) \

1256 
	`SC
(133, 38, 36, 2, 
no
,‚o) \

1257 
	`SC
(134, 38, 36, 3, 
no
,‚o) \

1258 
	`SC
(135, 38, 36, 4, 
no
,‚o) \

1260 
	`SC
(136, 39, 37, 1, 
no
,‚o) \

1261 
	`SC
(137, 39, 37, 2, 
no
,‚o) \

1262 
	`SC
(138, 39, 37, 3, 
no
,‚o) \

1263 
	`SC
(139, 39, 37, 4, 
no
,‚o) \

1265 
	`SC
(140, 40, 38, 1, 
no
,‚o) \

1266 
	`SC
(141, 40, 38, 2, 
no
,‚o) \

1267 
	`SC
(142, 40, 38, 3, 
no
,‚o) \

1268 
	`SC
(143, 40, 38, 4, 
no
,‚o) \

1270 
	`SC
(144, 41, 39, 1, 
no
,‚o) \

1271 
	`SC
(145, 41, 39, 2, 
no
,‚o) \

1272 
	`SC
(146, 41, 39, 3, 
no
,‚o) \

1273 
	`SC
(147, 41, 39, 4, 
no
,‚o) \

1275 
	`SC
(148, 42, 40, 1, 
no
,‚o) \

1276 
	`SC
(149, 42, 40, 2, 
no
,‚o) \

1277 
	`SC
(150, 42, 40, 3, 
no
,‚o) \

1278 
	`SC
(151, 42, 40, 4, 
no
,‚o) \

1280 
	`SC
(152, 43, 41, 1, 
no
,‚o) \

1281 
	`SC
(153, 43, 41, 2, 
no
,‚o) \

1282 
	`SC
(154, 43, 41, 3, 
no
,‚o) \

1283 
	`SC
(155, 43, 41, 4, 
no
,‚o) \

1285 
	`SC
(156, 44, 42, 1, 
no
,‚o) \

1286 
	`SC
(157, 44, 42, 2, 
no
,‚o) \

1287 
	`SC
(158, 44, 42, 3, 
no
,‚o) \

1288 
	`SC
(159, 44, 42, 4, 
no
,‚o) \

1290 
	`SC
(160, 45, 43, 1, 
no
,‚o) \

1291 
	`SC
(161, 45, 43, 2, 
no
,‚o) \

1292 
	`SC
(162, 45, 43, 3, 
no
,‚o) \

1293 
	`SC
(163, 45, 43, 4, 
no
,‚o) \

1295 
	`SC
(164, 46, 44, 1, 
no
,‚o) \

1296 
	`SC
(165, 46, 44, 2, 
no
,‚o) \

1297 
	`SC
(166, 46, 44, 3, 
no
,‚o) \

1298 
	`SC
(167, 46, 44, 4, 
no
,‚o) \

1300 
	`SC
(168, 47, 45, 1, 
no
,‚o) \

1301 
	`SC
(169, 47, 45, 2, 
no
,‚o) \

1302 
	`SC
(170, 47, 45, 3, 
no
,‚o) \

1303 
	`SC
(171, 47, 45, 4, 
no
,‚o) \

1305 
	`SC
(172, 48, 46, 1, 
no
,‚o) \

1306 
	`SC
(173, 48, 46, 2, 
no
,‚o) \

1307 
	`SC
(174, 48, 46, 3, 
no
,‚o) \

1308 
	`SC
(175, 48, 46, 4, 
no
,‚o) \

1310 
	`SC
(176, 49, 47, 1, 
no
,‚o) \

1311 
	`SC
(177, 49, 47, 2, 
no
,‚o) \

1312 
	`SC
(178, 49, 47, 3, 
no
,‚o) \

1313 
	`SC
(179, 49, 47, 4, 
no
,‚o) \

1315 
	`SC
(180, 50, 48, 1, 
no
,‚o) \

1316 
	`SC
(181, 50, 48, 2, 
no
,‚o) \

1317 
	`SC
(182, 50, 48, 3, 
no
,‚o) \

1318 
	`SC
(183, 50, 48, 4, 
no
,‚o) \

1320 
	`SC
(184, 51, 49, 1, 
no
,‚o) \

1321 
	`SC
(185, 51, 49, 2, 
no
,‚o) \

1322 
	`SC
(186, 51, 49, 3, 
no
,‚o) \

1323 
	`SC
(187, 51, 49, 4, 
no
,‚o) \

1325 
	`SC
(188, 52, 50, 1, 
no
,‚o) \

1326 
	`SC
(189, 52, 50, 2, 
no
,‚o) \

1327 
	`SC
(190, 52, 50, 3, 
no
,‚o) \

1328 
	`SC
(191, 52, 50, 4, 
no
,‚o) \

1330 
	`SC
(192, 53, 51, 1, 
no
,‚o) \

1331 
	`SC
(193, 53, 51, 2, 
no
,‚o) \

1332 
	`SC
(194, 53, 51, 3, 
no
,‚o) \

1333 
	`SC
(195, 53, 51, 4, 
no
,‚o) \

1335 
	`SC
(196, 54, 52, 1, 
no
,‚o) \

1336 
	`SC
(197, 54, 52, 2, 
no
,‚o) \

1337 
	`SC
(198, 54, 52, 3, 
no
,‚o) \

1338 
	`SC
(199, 54, 52, 4, 
no
,‚o) \

1340 
	`SC
(200, 55, 53, 1, 
no
,‚o) \

1341 
	`SC
(201, 55, 53, 2, 
no
,‚o) \

1342 
	`SC
(202, 55, 53, 3, 
no
,‚o) \

1343 
	`SC
(203, 55, 53, 4, 
no
,‚o) \

1345 
	`SC
(204, 56, 54, 1, 
no
,‚o) \

1346 
	`SC
(205, 56, 54, 2, 
no
,‚o) \

1347 
	`SC
(206, 56, 54, 3, 
no
,‚o) \

1348 
	`SC
(207, 56, 54, 4, 
no
,‚o) \

1350 
	`SC
(208, 57, 55, 1, 
no
,‚o) \

1351 
	`SC
(209, 57, 55, 2, 
no
,‚o) \

1352 
	`SC
(210, 57, 55, 3, 
no
,‚o) \

1353 
	`SC
(211, 57, 55, 4, 
no
,‚o) \

1355 
	`SC
(212, 58, 56, 1, 
no
,‚o) \

1356 
	`SC
(213, 58, 56, 2, 
no
,‚o) \

1357 
	`SC
(214, 58, 56, 3, 
no
,‚o) \

1358 
	`SC
(215, 58, 56, 4, 
no
,‚o) \

1360 
	`SC
(216, 59, 57, 1, 
no
,‚o) \

1361 
	`SC
(217, 59, 57, 2, 
no
,‚o) \

1362 
	`SC
(218, 59, 57, 3, 
no
,‚o) \

1363 
	`SC
(219, 59, 57, 4, 
no
,‚o) \

1365 
	`SC
(220, 60, 58, 1, 
no
,‚o) \

1366 
	`SC
(221, 60, 58, 2, 
no
,‚o) \

1367 
	`SC
(222, 60, 58, 3, 
no
,‚o) \

1368 
	`SC
(223, 60, 58, 4, 
no
,‚o) \

1370 
	`SC
(224, 61, 59, 1, 
no
,‚o) \

1371 
	`SC
(225, 61, 59, 2, 
no
,‚o) \

1372 
	`SC
(226, 61, 59, 3, 
no
,‚o) \

1373 
	`SC
(227, 61, 59, 4, 
no
,‚o) \

1375 
	`SC
(228, 62, 60, 1, 
no
,‚o) \

1376 
	`SC
(229, 62, 60, 2, 
no
,‚o) \

1377 
	`SC
(230, 62, 60, 3, 
no
,‚o) \

1378 

	)

1379 
	#SIZE_CLASSES_DEFINED


	)

1380 
	#NTBINS
 0

	)

1381 
	#NLBINS
 28

	)

1382 
	#NBINS
 35

	)

1383 
	#NSIZES
 231

	)

1384 
	#LG_TINY_MAXCLASS
 "NA"

	)

1385 
	#LOOKUP_MAXCLASS
 ((((
size_t
)1è<< 11è+ (((size_t)4è<< 9))

	)

1386 
	#SMALL_MAXCLASS
 ((((
size_t
)1è<< 13è+ (((size_t)3è<< 11))

	)

1387 
	#LG_LARGE_MINCLASS
 14

	)

1388 
	#HUGE_MAXCLASS
 ((((
size_t
)1è<< 62è+ (((size_t)3è<< 60))

	)

1391 #iâdeà
SIZE_CLASSES_DEFINED


1394 #undeà
SIZE_CLASSES_DEFINED


1401 #ià(
NBINS
 > 255)

1407 #ifdeà
JEMALLOC_H_STRUCTS


1412 #ifdeà
JEMALLOC_H_EXTERNS


1417 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/smoothstep.h

6 #ifdeà
JEMALLOC_H_TYPES


24 
	#SMOOTHSTEP_VARIANT
 "smoÙh”"

	)

25 
	#SMOOTHSTEP_NSTEPS
 200

	)

26 
	#SMOOTHSTEP_BFP
 24

	)

27 
	#SMOOTHSTEP
 \

29 
	`STEP
Ğ1, 
	`UINT64_C
(0x0000000000000014), 0.005, 0.000001240643750) \

30 
	`STEP
Ğ2, 
	`UINT64_C
(0x00000000000000a5), 0.010, 0.000009850600000) \

31 
	`STEP
Ğ3, 
	`UINT64_C
(0x0000000000000229), 0.015, 0.000032995181250) \

32 
	`STEP
Ğ4, 
	`UINT64_C
(0x0000000000000516), 0.020, 0.000077619200000) \

33 
	`STEP
Ğ5, 
	`UINT64_C
(0x00000000000009dc), 0.025, 0.000150449218750) \

34 
	`STEP
Ğ6, 
	`UINT64_C
(0x00000000000010e8), 0.030, 0.000257995800000) \

35 
	`STEP
Ğ7, 
	`UINT64_C
(0x0000000000001aa4), 0.035, 0.000406555756250) \

36 
	`STEP
Ğ8, 
	`UINT64_C
(0x0000000000002777), 0.040, 0.000602214400000) \

37 
	`STEP
Ğ9, 
	`UINT64_C
(0x00000000000037c2), 0.045, 0.000850847793750) \

38 
	`STEP
Ğ10, 
	`UINT64_C
(0x0000000000004be6), 0.050, 0.001158125000000) \

39 
	`STEP
Ğ11, 
	`UINT64_C
(0x000000000000643c), 0.055, 0.001529510331250) \

40 
	`STEP
Ğ12, 
	`UINT64_C
(0x000000000000811f), 0.060, 0.001970265600000) \

41 
	`STEP
Ğ13, 
	`UINT64_C
(0x000000000000a2e2), 0.065, 0.002485452368750) \

42 
	`STEP
Ğ14, 
	`UINT64_C
(0x000000000000c9d8), 0.070, 0.003079934200000) \

43 
	`STEP
Ğ15, 
	`UINT64_C
(0x000000000000f64f), 0.075, 0.003758378906250) \

44 
	`STEP
Ğ16, 
	`UINT64_C
(0x0000000000012891), 0.080, 0.004525260800000) \

45 
	`STEP
Ğ17, 
	`UINT64_C
(0x00000000000160e7), 0.085, 0.005384862943750) \

46 
	`STEP
Ğ18, 
	`UINT64_C
(0x0000000000019f95), 0.090, 0.006341279400000) \

47 
	`STEP
Ğ19, 
	`UINT64_C
(0x000000000001e4dc), 0.095, 0.007398417481250) \

48 
	`STEP
Ğ20, 
	`UINT64_C
(0x00000000000230fc), 0.100, 0.008560000000000) \

49 
	`STEP
Ğ21, 
	`UINT64_C
(0x0000000000028430), 0.105, 0.009829567518750) \

50 
	`STEP
Ğ22, 
	`UINT64_C
(0x000000000002deb0), 0.110, 0.011210480600000) \

51 
	`STEP
Ğ23, 
	`UINT64_C
(0x00000000000340b1), 0.115, 0.012705922056250) \

52 
	`STEP
Ğ24, 
	`UINT64_C
(0x000000000003aa67), 0.120, 0.014318899200000) \

53 
	`STEP
Ğ25, 
	`UINT64_C
(0x0000000000041c00), 0.125, 0.016052246093750) \

54 
	`STEP
Ğ26, 
	`UINT64_C
(0x00000000000495a8), 0.130, 0.017908625800000) \

55 
	`STEP
Ğ27, 
	`UINT64_C
(0x000000000005178b), 0.135, 0.019890532631250) \

56 
	`STEP
Ğ28, 
	`UINT64_C
(0x000000000005a1cf), 0.140, 0.022000294400000) \

57 
	`STEP
Ğ29, 
	`UINT64_C
(0x0000000000063498), 0.145, 0.024240074668750) \

58 
	`STEP
Ğ30, 
	`UINT64_C
(0x000000000006d009), 0.150, 0.026611875000000) \

59 
	`STEP
Ğ31, 
	`UINT64_C
(0x000000000007743f), 0.155, 0.029117537206250) \

60 
	`STEP
Ğ32, 
	`UINT64_C
(0x0000000000082157), 0.160, 0.031758745600000) \

61 
	`STEP
Ğ33, 
	`UINT64_C
(0x000000000008d76b), 0.165, 0.034537029243750) \

62 
	`STEP
Ğ34, 
	`UINT64_C
(0x0000000000099691), 0.170, 0.037453764200000) \

63 
	`STEP
Ğ35, 
	`UINT64_C
(0x00000000000a5edf), 0.175, 0.040510175781250) \

64 
	`STEP
Ğ36, 
	`UINT64_C
(0x00000000000b3067), 0.180, 0.043707340800000) \

65 
	`STEP
Ğ37, 
	`UINT64_C
(0x00000000000c0b38), 0.185, 0.047046189818750) \

66 
	`STEP
Ğ38, 
	`UINT64_C
(0x00000000000cef5e), 0.190, 0.050527509400000) \

67 
	`STEP
Ğ39, 
	`UINT64_C
(0x00000000000ddce6), 0.195, 0.054151944356250) \

68 
	`STEP
Ğ40, 
	`UINT64_C
(0x00000000000ed3d8), 0.200, 0.057920000000000) \

69 
	`STEP
Ğ41, 
	`UINT64_C
(0x00000000000fd439), 0.205, 0.061832044393750) \

70 
	`STEP
Ğ42, 
	`UINT64_C
(0x000000000010de0e), 0.210, 0.065888310600000) \

71 
	`STEP
Ğ43, 
	`UINT64_C
(0x000000000011f158), 0.215, 0.070088898931250) \

72 
	`STEP
Ğ44, 
	`UINT64_C
(0x0000000000130e17), 0.220, 0.074433779200000) \

73 
	`STEP
Ğ45, 
	`UINT64_C
(0x0000000000143448), 0.225, 0.078922792968750) \

74 
	`STEP
Ğ46, 
	`UINT64_C
(0x00000000001563e7), 0.230, 0.083555655800000) \

75 
	`STEP
Ğ47, 
	`UINT64_C
(0x0000000000169cec), 0.235, 0.088331959506250) \

76 
	`STEP
Ğ48, 
	`UINT64_C
(0x000000000017df4f), 0.240, 0.093251174400000) \

77 
	`STEP
Ğ49, 
	`UINT64_C
(0x0000000000192b04), 0.245, 0.098312651543750) \

78 
	`STEP
Ğ50, 
	`UINT64_C
(0x00000000001a8000), 0.250, 0.103515625000000) \

79 
	`STEP
Ğ51, 
	`UINT64_C
(0x00000000001bde32), 0.255, 0.108859214081250) \

80 
	`STEP
Ğ52, 
	`UINT64_C
(0x00000000001d458b), 0.260, 0.114342425600000) \

81 
	`STEP
Ğ53, 
	`UINT64_C
(0x00000000001eb5f8), 0.265, 0.119964156118750) \

82 
	`STEP
Ğ54, 
	`UINT64_C
(0x0000000000202f65), 0.270, 0.125723194200000) \

83 
	`STEP
Ğ55, 
	`UINT64_C
(0x000000000021b1bb), 0.275, 0.131618222656250) \

84 
	`STEP
Ğ56, 
	`UINT64_C
(0x0000000000233ce3), 0.280, 0.137647820800000) \

85 
	`STEP
Ğ57, 
	`UINT64_C
(0x000000000024d0c3), 0.285, 0.143810466693750) \

86 
	`STEP
Ğ58, 
	`UINT64_C
(0x0000000000266d40), 0.290, 0.150104539400000) \

87 
	`STEP
Ğ59, 
	`UINT64_C
(0x000000000028123d), 0.295, 0.156528321231250) \

88 
	`STEP
Ğ60, 
	`UINT64_C
(0x000000000029bf9c), 0.300, 0.163080000000000) \

89 
	`STEP
Ğ61, 
	`UINT64_C
(0x00000000002b753d), 0.305, 0.169757671268750) \

90 
	`STEP
Ğ62, 
	`UINT64_C
(0x00000000002d32fe), 0.310, 0.176559340600000) \

91 
	`STEP
Ğ63, 
	`UINT64_C
(0x00000000002ef8bc), 0.315, 0.183482925806250) \

92 
	`STEP
Ğ64, 
	`UINT64_C
(0x000000000030c654), 0.320, 0.190526259200000) \

93 
	`STEP
Ğ65, 
	`UINT64_C
(0x0000000000329b9f), 0.325, 0.197687089843750) \

94 
	`STEP
Ğ66, 
	`UINT64_C
(0x0000000000347875), 0.330, 0.204963085800000) \

95 
	`STEP
Ğ67, 
	`UINT64_C
(0x0000000000365cb0), 0.335, 0.212351836381250) \

96 
	`STEP
Ğ68, 
	`UINT64_C
(0x0000000000384825), 0.340, 0.219850854400000) \

97 
	`STEP
Ğ69, 
	`UINT64_C
(0x00000000003a3aa8), 0.345, 0.227457578418750) \

98 
	`STEP
Ğ70, 
	`UINT64_C
(0x00000000003c340f), 0.350, 0.235169375000000) \

99 
	`STEP
Ğ71, 
	`UINT64_C
(0x00000000003e342b), 0.355, 0.242983540956250) \

100 
	`STEP
Ğ72, 
	`UINT64_C
(0x0000000000403ace), 0.360, 0.250897305600000) \

101 
	`STEP
Ğ73, 
	`UINT64_C
(0x00000000004247c8), 0.365, 0.258907832993750) \

102 
	`STEP
Ğ74, 
	`UINT64_C
(0x0000000000445ae9), 0.370, 0.267012224200000) \

103 
	`STEP
Ğ75, 
	`UINT64_C
(0x0000000000467400), 0.375, 0.275207519531250) \

104 
	`STEP
Ğ76, 
	`UINT64_C
(0x00000000004892d8), 0.380, 0.283490700800000) \

105 
	`STEP
Ğ77, 
	`UINT64_C
(0x00000000004ab740), 0.385, 0.291858693568750) \

106 
	`STEP
Ğ78, 
	`UINT64_C
(0x00000000004ce102), 0.390, 0.300308369400000) \

107 
	`STEP
Ğ79, 
	`UINT64_C
(0x00000000004f0fe9), 0.395, 0.308836548106250) \

108 
	`STEP
Ğ80, 
	`UINT64_C
(0x00000000005143bf), 0.400, 0.317440000000000) \

109 
	`STEP
Ğ81, 
	`UINT64_C
(0x0000000000537c4d), 0.405, 0.326115448143750) \

110 
	`STEP
Ğ82, 
	`UINT64_C
(0x000000000055b95b), 0.410, 0.334859570600000) \

111 
	`STEP
Ğ83, 
	`UINT64_C
(0x000000000057fab1), 0.415, 0.343669002681250) \

112 
	`STEP
Ğ84, 
	`UINT64_C
(0x00000000005a4015), 0.420, 0.352540339200000) \

113 
	`STEP
Ğ85, 
	`UINT64_C
(0x00000000005c894e), 0.425, 0.361470136718750) \

114 
	`STEP
Ğ86, 
	`UINT64_C
(0x00000000005ed622), 0.430, 0.370454915800000) \

115 
	`STEP
Ğ87, 
	`UINT64_C
(0x0000000000612655), 0.435, 0.379491163256250) \

116 
	`STEP
Ğ88, 
	`UINT64_C
(0x00000000006379ac), 0.440, 0.388575334400000) \

117 
	`STEP
Ğ89, 
	`UINT64_C
(0x000000000065cfeb), 0.445, 0.397703855293750) \

118 
	`STEP
Ğ90, 
	`UINT64_C
(0x00000000006828d6), 0.450, 0.406873125000000) \

119 
	`STEP
Ğ91, 
	`UINT64_C
(0x00000000006a842f), 0.455, 0.416079517831250) \

120 
	`STEP
Ğ92, 
	`UINT64_C
(0x00000000006ce1bb), 0.460, 0.425319385600000) \

121 
	`STEP
Ğ93, 
	`UINT64_C
(0x00000000006f413a), 0.465, 0.434589059868750) \

122 
	`STEP
Ğ94, 
	`UINT64_C
(0x000000000071a270), 0.470, 0.443884854200000) \

123 
	`STEP
Ğ95, 
	`UINT64_C
(0x000000000074051d), 0.475, 0.453203066406250) \

124 
	`STEP
Ğ96, 
	`UINT64_C
(0x0000000000766905), 0.480, 0.462539980800000) \

125 
	`STEP
Ğ97, 
	`UINT64_C
(0x000000000078cde7), 0.485, 0.471891870443750) \

126 
	`STEP
Ğ98, 
	`UINT64_C
(0x00000000007b3387), 0.490, 0.481254999400000) \

127 
	`STEP
Ğ99, 
	`UINT64_C
(0x00000000007d99a4), 0.495, 0.490625624981250) \

128 
	`STEP
Ğ100, 
	`UINT64_C
(0x0000000000800000), 0.500, 0.500000000000000) \

129 
	`STEP
Ğ101, 
	`UINT64_C
(0x000000000082665b), 0.505, 0.509374375018750) \

130 
	`STEP
Ğ102, 
	`UINT64_C
(0x000000000084cc78), 0.510, 0.518745000600000) \

131 
	`STEP
Ğ103, 
	`UINT64_C
(0x0000000000873218), 0.515, 0.528108129556250) \

132 
	`STEP
Ğ104, 
	`UINT64_C
(0x00000000008996fa), 0.520, 0.537460019200000) \

133 
	`STEP
Ğ105, 
	`UINT64_C
(0x00000000008bfae2), 0.525, 0.546796933593750) \

134 
	`STEP
Ğ106, 
	`UINT64_C
(0x00000000008e5d8f), 0.530, 0.556115145800000) \

135 
	`STEP
Ğ107, 
	`UINT64_C
(0x000000000090bec5), 0.535, 0.565410940131250) \

136 
	`STEP
Ğ108, 
	`UINT64_C
(0x0000000000931e44), 0.540, 0.574680614400000) \

137 
	`STEP
Ğ109, 
	`UINT64_C
(0x0000000000957bd0), 0.545, 0.583920482168750) \

138 
	`STEP
Ğ110, 
	`UINT64_C
(0x000000000097d729), 0.550, 0.593126875000000) \

139 
	`STEP
Ğ111, 
	`UINT64_C
(0x00000000009a3014), 0.555, 0.602296144706250) \

140 
	`STEP
Ğ112, 
	`UINT64_C
(0x00000000009c8653), 0.560, 0.611424665600000) \

141 
	`STEP
Ğ113, 
	`UINT64_C
(0x00000000009ed9aa), 0.565, 0.620508836743750) \

142 
	`STEP
Ğ114, 
	`UINT64_C
(0x0000000000a129dd), 0.570, 0.629545084200000) \

143 
	`STEP
Ğ115, 
	`UINT64_C
(0x0000000000a376b1), 0.575, 0.638529863281250) \

144 
	`STEP
Ğ116, 
	`UINT64_C
(0x0000000000a5bfea), 0.580, 0.647459660800000) \

145 
	`STEP
Ğ117, 
	`UINT64_C
(0x0000000000a8054e), 0.585, 0.656330997318750) \

146 
	`STEP
Ğ118, 
	`UINT64_C
(0x0000000000aa46a4), 0.590, 0.665140429400000) \

147 
	`STEP
Ğ119, 
	`UINT64_C
(0x0000000000ac83b2), 0.595, 0.673884551856250) \

148 
	`STEP
Ğ120, 
	`UINT64_C
(0x0000000000aebc40), 0.600, 0.682560000000000) \

149 
	`STEP
Ğ121, 
	`UINT64_C
(0x0000000000b0f016), 0.605, 0.691163451893750) \

150 
	`STEP
Ğ122, 
	`UINT64_C
(0x0000000000b31efd), 0.610, 0.699691630600000) \

151 
	`STEP
Ğ123, 
	`UINT64_C
(0x0000000000b548bf), 0.615, 0.708141306431250) \

152 
	`STEP
Ğ124, 
	`UINT64_C
(0x0000000000b76d27), 0.620, 0.716509299200000) \

153 
	`STEP
Ğ125, 
	`UINT64_C
(0x0000000000b98c00), 0.625, 0.724792480468750) \

154 
	`STEP
Ğ126, 
	`UINT64_C
(0x0000000000bba516), 0.630, 0.732987775800000) \

155 
	`STEP
Ğ127, 
	`UINT64_C
(0x0000000000bdb837), 0.635, 0.741092167006250) \

156 
	`STEP
Ğ128, 
	`UINT64_C
(0x0000000000bfc531), 0.640, 0.749102694400000) \

157 
	`STEP
Ğ129, 
	`UINT64_C
(0x0000000000c1cbd4), 0.645, 0.757016459043750) \

158 
	`STEP
Ğ130, 
	`UINT64_C
(0x0000000000c3cbf0), 0.650, 0.764830625000000) \

159 
	`STEP
Ğ131, 
	`UINT64_C
(0x0000000000c5c557), 0.655, 0.772542421581250) \

160 
	`STEP
Ğ132, 
	`UINT64_C
(0x0000000000c7b7da), 0.660, 0.780149145600000) \

161 
	`STEP
Ğ133, 
	`UINT64_C
(0x0000000000c9a34f), 0.665, 0.787648163618750) \

162 
	`STEP
Ğ134, 
	`UINT64_C
(0x0000000000cb878a), 0.670, 0.795036914200000) \

163 
	`STEP
Ğ135, 
	`UINT64_C
(0x0000000000cd6460), 0.675, 0.802312910156250) \

164 
	`STEP
Ğ136, 
	`UINT64_C
(0x0000000000cf39ab), 0.680, 0.809473740800000) \

165 
	`STEP
Ğ137, 
	`UINT64_C
(0x0000000000d10743), 0.685, 0.816517074193750) \

166 
	`STEP
Ğ138, 
	`UINT64_C
(0x0000000000d2cd01), 0.690, 0.823440659400000) \

167 
	`STEP
Ğ139, 
	`UINT64_C
(0x0000000000d48ac2), 0.695, 0.830242328731250) \

168 
	`STEP
Ğ140, 
	`UINT64_C
(0x0000000000d64063), 0.700, 0.836920000000000) \

169 
	`STEP
Ğ141, 
	`UINT64_C
(0x0000000000d7edc2), 0.705, 0.843471678768750) \

170 
	`STEP
Ğ142, 
	`UINT64_C
(0x0000000000d992bf), 0.710, 0.849895460600000) \

171 
	`STEP
Ğ143, 
	`UINT64_C
(0x0000000000db2f3c), 0.715, 0.856189533306250) \

172 
	`STEP
Ğ144, 
	`UINT64_C
(0x0000000000dcc31c), 0.720, 0.862352179200000) \

173 
	`STEP
Ğ145, 
	`UINT64_C
(0x0000000000de4e44), 0.725, 0.868381777343750) \

174 
	`STEP
Ğ146, 
	`UINT64_C
(0x0000000000dfd09a), 0.730, 0.874276805800000) \

175 
	`STEP
Ğ147, 
	`UINT64_C
(0x0000000000e14a07), 0.735, 0.880035843881250) \

176 
	`STEP
Ğ148, 
	`UINT64_C
(0x0000000000e2ba74), 0.740, 0.885657574400000) \

177 
	`STEP
Ğ149, 
	`UINT64_C
(0x0000000000e421cd), 0.745, 0.891140785918750) \

178 
	`STEP
Ğ150, 
	`UINT64_C
(0x0000000000e58000), 0.750, 0.896484375000000) \

179 
	`STEP
Ğ151, 
	`UINT64_C
(0x0000000000e6d4fb), 0.755, 0.901687348456250) \

180 
	`STEP
Ğ152, 
	`UINT64_C
(0x0000000000e820b0), 0.760, 0.906748825600000) \

181 
	`STEP
Ğ153, 
	`UINT64_C
(0x0000000000e96313), 0.765, 0.911668040493750) \

182 
	`STEP
Ğ154, 
	`UINT64_C
(0x0000000000ea9c18), 0.770, 0.916444344200000) \

183 
	`STEP
Ğ155, 
	`UINT64_C
(0x0000000000ebcbb7), 0.775, 0.921077207031250) \

184 
	`STEP
Ğ156, 
	`UINT64_C
(0x0000000000ecf1e8), 0.780, 0.925566220800000) \

185 
	`STEP
Ğ157, 
	`UINT64_C
(0x0000000000ee0ea7), 0.785, 0.929911101068750) \

186 
	`STEP
Ğ158, 
	`UINT64_C
(0x0000000000ef21f1), 0.790, 0.934111689400000) \

187 
	`STEP
Ğ159, 
	`UINT64_C
(0x0000000000f02bc6), 0.795, 0.938167955606250) \

188 
	`STEP
Ğ160, 
	`UINT64_C
(0x0000000000f12c27), 0.800, 0.942080000000000) \

189 
	`STEP
Ğ161, 
	`UINT64_C
(0x0000000000f22319), 0.805, 0.945848055643750) \

190 
	`STEP
Ğ162, 
	`UINT64_C
(0x0000000000f310a1), 0.810, 0.949472490600000) \

191 
	`STEP
Ğ163, 
	`UINT64_C
(0x0000000000f3f4c7), 0.815, 0.952953810181250) \

192 
	`STEP
Ğ164, 
	`UINT64_C
(0x0000000000f4cf98), 0.820, 0.956292659200000) \

193 
	`STEP
Ğ165, 
	`UINT64_C
(0x0000000000f5a120), 0.825, 0.959489824218750) \

194 
	`STEP
Ğ166, 
	`UINT64_C
(0x0000000000f6696e), 0.830, 0.962546235800000) \

195 
	`STEP
Ğ167, 
	`UINT64_C
(0x0000000000f72894), 0.835, 0.965462970756250) \

196 
	`STEP
Ğ168, 
	`UINT64_C
(0x0000000000f7dea8), 0.840, 0.968241254400000) \

197 
	`STEP
Ğ169, 
	`UINT64_C
(0x0000000000f88bc0), 0.845, 0.970882462793750) \

198 
	`STEP
Ğ170, 
	`UINT64_C
(0x0000000000f92ff6), 0.850, 0.973388125000000) \

199 
	`STEP
Ğ171, 
	`UINT64_C
(0x0000000000f9cb67), 0.855, 0.975759925331250) \

200 
	`STEP
Ğ172, 
	`UINT64_C
(0x0000000000fa5e30), 0.860, 0.977999705600000) \

201 
	`STEP
Ğ173, 
	`UINT64_C
(0x0000000000fae874), 0.865, 0.980109467368750) \

202 
	`STEP
Ğ174, 
	`UINT64_C
(0x0000000000fb6a57), 0.870, 0.982091374200000) \

203 
	`STEP
Ğ175, 
	`UINT64_C
(0x0000000000fbe400), 0.875, 0.983947753906250) \

204 
	`STEP
Ğ176, 
	`UINT64_C
(0x0000000000fc5598), 0.880, 0.985681100800000) \

205 
	`STEP
Ğ177, 
	`UINT64_C
(0x0000000000fcbf4e), 0.885, 0.987294077943750) \

206 
	`STEP
Ğ178, 
	`UINT64_C
(0x0000000000fd214f), 0.890, 0.988789519400000) \

207 
	`STEP
Ğ179, 
	`UINT64_C
(0x0000000000fd7bcf), 0.895, 0.990170432481250) \

208 
	`STEP
Ğ180, 
	`UINT64_C
(0x0000000000fdcf03), 0.900, 0.991440000000000) \

209 
	`STEP
Ğ181, 
	`UINT64_C
(0x0000000000fe1b23), 0.905, 0.992601582518750) \

210 
	`STEP
Ğ182, 
	`UINT64_C
(0x0000000000fe606a), 0.910, 0.993658720600000) \

211 
	`STEP
Ğ183, 
	`UINT64_C
(0x0000000000fe9f18), 0.915, 0.994615137056250) \

212 
	`STEP
Ğ184, 
	`UINT64_C
(0x0000000000fed76e), 0.920, 0.995474739200000) \

213 
	`STEP
Ğ185, 
	`UINT64_C
(0x0000000000ff09b0), 0.925, 0.996241621093750) \

214 
	`STEP
Ğ186, 
	`UINT64_C
(0x0000000000ff3627), 0.930, 0.996920065800000) \

215 
	`STEP
Ğ187, 
	`UINT64_C
(0x0000000000ff5d1d), 0.935, 0.997514547631250) \

216 
	`STEP
Ğ188, 
	`UINT64_C
(0x0000000000ff7ee0), 0.940, 0.998029734400000) \

217 
	`STEP
Ğ189, 
	`UINT64_C
(0x0000000000ff9bc3), 0.945, 0.998470489668750) \

218 
	`STEP
Ğ190, 
	`UINT64_C
(0x0000000000ffb419), 0.950, 0.998841875000000) \

219 
	`STEP
Ğ191, 
	`UINT64_C
(0x0000000000ffc83d), 0.955, 0.999149152206250) \

220 
	`STEP
Ğ192, 
	`UINT64_C
(0x0000000000ffd888), 0.960, 0.999397785600000) \

221 
	`STEP
Ğ193, 
	`UINT64_C
(0x0000000000ffe55b), 0.965, 0.999593444243750) \

222 
	`STEP
Ğ194, 
	`UINT64_C
(0x0000000000ffef17), 0.970, 0.999742004200000) \

223 
	`STEP
Ğ195, 
	`UINT64_C
(0x0000000000fff623), 0.975, 0.999849550781250) \

224 
	`STEP
Ğ196, 
	`UINT64_C
(0x0000000000fffae9), 0.980, 0.999922380800000) \

225 
	`STEP
Ğ197, 
	`UINT64_C
(0x0000000000fffdd6), 0.985, 0.999967004818750) \

226 
	`STEP
Ğ198, 
	`UINT64_C
(0x0000000000ffff5a), 0.990, 0.999990149400000) \

227 
	`STEP
Ğ199, 
	`UINT64_C
(0x0000000000ffffeb), 0.995, 0.999998759356250) \

228 
	`STEP
Ğ200, 
	`UINT64_C
(0x0000000001000000), 1.000, 1.000000000000000) \

229 

	)

232 #ifdeà
JEMALLOC_H_STRUCTS


237 #ifdeà
JEMALLOC_H_EXTERNS


242 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/stats.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
tÿche_bš_¡©s_s
 
	ttÿche_bš_¡©s_t
;

5 
m®loc_bš_¡©s_s
 
	tm®loc_bš_¡©s_t
;

6 
m®loc_Ïrge_¡©s_s
 
	tm®loc_Ïrge_¡©s_t
;

7 
m®loc_huge_¡©s_s
 
	tm®loc_huge_¡©s_t
;

8 
¬’a_¡©s_s
 
	t¬’a_¡©s_t
;

9 
chunk_¡©s_s
 
	tchunk_¡©s_t
;

13 #ifdeà
JEMALLOC_H_STRUCTS


15 
	stÿche_bš_¡©s_s
 {

20 
ušt64_t
 
	mÄeque¡s
;

23 
	sm®loc_bš_¡©s_s
 {

30 
ušt64_t
 
	mnm®loc
;

31 
ušt64_t
 
	mnd®loc
;

38 
ušt64_t
 
	mÄeque¡s
;

44 
size_t
 
	mcu¼egs
;

47 
ušt64_t
 
	mnfls
;

50 
ušt64_t
 
	mnæushes
;

53 
ušt64_t
 
	mÄuns
;

59 
ušt64_t
 
	m»runs
;

62 
size_t
 
	mcu¼uns
;

65 
	sm®loc_Ïrge_¡©s_s
 {

72 
ušt64_t
 
	mnm®loc
;

73 
ušt64_t
 
	mnd®loc
;

80 
ušt64_t
 
	mÄeque¡s
;

86 
size_t
 
	mcu¼uns
;

89 
	sm®loc_huge_¡©s_s
 {

94 
ušt64_t
 
	mnm®loc
;

95 
ušt64_t
 
	mnd®loc
;

98 
size_t
 
	mcurhchunks
;

101 
	s¬’a_¡©s_s
 {

103 
size_t
 
	mm­³d
;

111 
size_t
 
	m»šed
;

118 
ušt64_t
 
	mÅurge
;

119 
ušt64_t
 
	mnmadvi£
;

120 
ušt64_t
 
	mpurged
;

126 
size_t
 
	mm‘ad©a_m­³d
;

127 
size_t
 
	mm‘ad©a_®loÿ‹d
;

130 
size_t
 
	m®loÿ‹d_Ïrge
;

131 
ušt64_t
 
	mnm®loc_Ïrge
;

132 
ušt64_t
 
	mnd®loc_Ïrge
;

133 
ušt64_t
 
	mÄeque¡s_Ïrge
;

135 
size_t
 
	m®loÿ‹d_huge
;

136 
ušt64_t
 
	mnm®loc_huge
;

137 
ušt64_t
 
	mnd®loc_huge
;

140 
m®loc_Ïrge_¡©s_t
 *
	ml¡©s
;

143 
m®loc_huge_¡©s_t
 *
	mh¡©s
;

148 #ifdeà
JEMALLOC_H_EXTERNS


150 
boŞ
 
İt_¡©s_´št
;

152 
size_t
 
¡©s_ÿùive
;

154 
¡©s_´št
((*
wr™e
)(*, cÚ¡ *), *
cbİaque
,

155 cÚ¡ *
İts
);

159 #ifdeà
JEMALLOC_H_INLINES


161 #iâdeà
JEMALLOC_ENABLE_INLINE


162 
size_t
 
	`¡©s_ÿùive_g‘
();

163 
	`¡©s_ÿùive_add
(
size_t
 
size
);

164 
	`¡©s_ÿùive_sub
(
size_t
 
size
);

167 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_STATS_C_
))

168 
JEMALLOC_INLINE
 
size_t


169 
	$¡©s_ÿùive_g‘
()

172  (
	`©omic_»ad_z
(&
¡©s_ÿùive
));

173 
	}
}

175 
JEMALLOC_INLINE
 

176 
	$¡©s_ÿùive_add
(
size_t
 
size
)

178 
UNUSED
 
size_t
 
ÿùive
;

180 
	`as£¹
(
size
 > 0);

181 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

183 
ÿùive
 = 
	`©omic_add_z
(&
¡©s_ÿùive
, 
size
);

184 
	`as£¹
(
ÿùive
 - 
size
 < cactive);

185 
	}
}

187 
JEMALLOC_INLINE
 

188 
	$¡©s_ÿùive_sub
(
size_t
 
size
)

190 
UNUSED
 
size_t
 
ÿùive
;

192 
	`as£¹
(
size
 > 0);

193 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

195 
ÿùive
 = 
	`©omic_sub_z
(&
¡©s_ÿùive
, 
size
);

196 
	`as£¹
(
ÿùive
 + 
size
 > cactive);

197 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/tcache.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
tÿche_bš_šfo_s
 
	ttÿche_bš_šfo_t
;

5 
tÿche_bš_s
 
	ttÿche_bš_t
;

6 
tÿche_s
 
	ttÿche_t
;

7 
tÿches_s
 
	ttÿches_t
;

14 
	#TCACHE_STATE_DISABLED
 ((
tÿche_t
 *)(
ušŒ_t
)1)

	)

15 
	#TCACHE_STATE_REINCARNATED
 ((
tÿche_t
 *)(
ušŒ_t
)2)

	)

16 
	#TCACHE_STATE_PURGATORY
 ((
tÿche_t
 *)(
ušŒ_t
)3)

	)

17 
	#TCACHE_STATE_MAX
 
TCACHE_STATE_PURGATORY


	)

22 
	#TCACHE_NSLOTS_SMALL_MIN
 20

	)

31 
	#TCACHE_NSLOTS_SMALL_MAX
 200

	)

34 
	#TCACHE_NSLOTS_LARGE
 20

	)

37 
	#LG_TCACHE_MAXCLASS_DEFAULT
 15

	)

44 
	#TCACHE_GC_SWEEP
 8192

	)

47 
	#TCACHE_GC_INCR
 \

48 ((
TCACHE_GC_SWEEP
 / 
NBINS
è+ ((TCACHE_GC_SWEEP / NBINS =ğ0è? 0 : 1))

	)

52 #ifdeà
JEMALLOC_H_STRUCTS


55 
	mtÿche_’abËd_çl£
 = 0,

56 
	mtÿche_’abËd_Œue
 = 1,

57 
	mtÿche_’abËd_deçuÉ
 = 2

58 } 
	ttÿche_’abËd_t
;

64 
	stÿche_bš_šfo_s
 {

65 
	mnÿched_max
;

68 
	stÿche_bš_s
 {

69 
tÿche_bš_¡©s_t
 
	mt¡©s
;

70 
	mlow_w©”
;

71 
	mlg_fl_div
;

72 
	mnÿched
;

80 **
	mava
;

83 
	stÿche_s
 {

84 
ql_–m
(
tÿche_t
è
	mlšk
;

85 
ušt64_t
 
	m´of_accumby‹s
;

86 
tick”_t
 
	mgc_tick”
;

87 
szšd_t
 
	mÃxt_gc_bš
;

88 
tÿche_bš_t
 
	mtbšs
[1];

98 
	stÿches_s
 {

100 
tÿche_t
 *
	mtÿche
;

101 
tÿches_t
 *
	mÃxt
;

107 #ifdeà
JEMALLOC_H_EXTERNS


109 
boŞ
 
İt_tÿche
;

110 
ssize_t
 
İt_lg_tÿche_max
;

112 
tÿche_bš_šfo_t
 *
tÿche_bš_šfo
;

118 
nhbšs
;

121 
size_t
 
tÿche_maxşass
;

131 
tÿches_t
 *
tÿches
;

133 
size_t
 
tÿche_§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
);

134 
tÿche_ev’t_h¬d
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
);

135 *
tÿche_®loc_sm®l_h¬d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
,

136 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
, 
boŞ
 *
tÿche_sucûss
);

137 
tÿche_bš_æush_sm®l
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, 
tÿche_bš_t
 *
tbš
,

138 
szšd_t
 
bššd
, 
»m
);

139 
tÿche_bš_æush_Ïrge
(
tsd_t
 *
tsd
, 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
,

140 
»m
, 
tÿche_t
 *
tÿche
);

141 
tÿche_¬’a_»assocŸ‹
(
tsdn_t
 *
tsdn
, 
tÿche_t
 *
tÿche
,

142 
¬’a_t
 *
Şd¬’a
,‡»Ç_ˆ*
Ãw¬’a
);

143 
tÿche_t
 *
tÿche_g‘_h¬d
(
tsd_t
 *
tsd
);

144 
tÿche_t
 *
tÿche_ü—‹
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
);

145 
tÿche_ş—nup
(
tsd_t
 *
tsd
);

146 
tÿche_’abËd_ş—nup
(
tsd_t
 *
tsd
);

147 
tÿche_¡©s_m”ge
(
tsdn_t
 *
tsdn
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

148 
boŞ
 
tÿches_ü—‹
(
tsdn_t
 *
tsdn
, *
r_šd
);

149 
tÿches_æush
(
tsd_t
 *
tsd
, 
šd
);

150 
tÿches_de¡roy
(
tsd_t
 *
tsd
, 
šd
);

151 
boŞ
 
tÿche_boÙ
(
tsdn_t
 *
tsdn
);

155 #ifdeà
JEMALLOC_H_INLINES


157 #iâdeà
JEMALLOC_ENABLE_INLINE


158 
tÿche_ev’t
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
);

159 
tÿche_æush
();

160 
boŞ
 
tÿche_’abËd_g‘
();

161 
tÿche_t
 *
tÿche_g‘
(
tsd_t
 *
tsd
, 
boŞ
 
ü—‹
);

162 
tÿche_’abËd_£t
(
boŞ
 
’abËd
);

163 *
tÿche_®loc_—sy
(
tÿche_bš_t
 *
tbš
, 
boŞ
 *
tÿche_sucûss
);

164 *
tÿche_®loc_sm®l
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
,

165 
size_t
 
size
, 
szšd_t
 
šd
, 
boŞ
 
z”o
, boŞ 
¦ow_·th
);

166 *
tÿche_®loc_Ïrge
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
,

167 
size_t
 
size
, 
szšd_t
 
šd
, 
boŞ
 
z”o
, boŞ 
¦ow_·th
);

168 
tÿche_d®loc_sm®l
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, *
±r
,

169 
szšd_t
 
bššd
, 
boŞ
 
¦ow_·th
);

170 
tÿche_d®loc_Ïrge
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, *
±r
,

171 
size_t
 
size
, 
boŞ
 
¦ow_·th
);

172 
tÿche_t
 *
tÿches_g‘
(
tsd_t
 *
tsd
, 
šd
);

175 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_TCACHE_C_
))

176 
JEMALLOC_INLINE
 

177 
	$tÿche_æush
()

179 
tsd_t
 *
tsd
;

181 
	`ÿs£¹
(
cÚfig_tÿche
);

183 
tsd
 = 
	`tsd_ãtch
();

184 
	`tÿche_ş—nup
(
tsd
);

185 
	}
}

187 
JEMALLOC_INLINE
 
boŞ


188 
	$tÿche_’abËd_g‘
()

190 
tsd_t
 *
tsd
;

191 
tÿche_’abËd_t
 
tÿche_’abËd
;

193 
	`ÿs£¹
(
cÚfig_tÿche
);

195 
tsd
 = 
	`tsd_ãtch
();

196 
tÿche_’abËd
 = 
	`tsd_tÿche_’abËd_g‘
(
tsd
);

197 ià(
tÿche_’abËd
 =ğ
tÿche_’abËd_deçuÉ
) {

198 
tÿche_’abËd
 = (
tÿche_’abËd_t
)
İt_tÿche
;

199 
	`tsd_tÿche_’abËd_£t
(
tsd
, 
tÿche_’abËd
);

202  ((
boŞ
)
tÿche_’abËd
);

203 
	}
}

205 
JEMALLOC_INLINE
 

206 
	$tÿche_’abËd_£t
(
boŞ
 
’abËd
)

208 
tsd_t
 *
tsd
;

209 
tÿche_’abËd_t
 
tÿche_’abËd
;

211 
	`ÿs£¹
(
cÚfig_tÿche
);

213 
tsd
 = 
	`tsd_ãtch
();

215 
tÿche_’abËd
 = (
tÿche_’abËd_t
)
’abËd
;

216 
	`tsd_tÿche_’abËd_£t
(
tsd
, 
tÿche_’abËd
);

218 ià(!
’abËd
)

219 
	`tÿche_ş—nup
(
tsd
);

220 
	}
}

222 
JEMALLOC_ALWAYS_INLINE
 
tÿche_t
 *

223 
	$tÿche_g‘
(
tsd_t
 *
tsd
, 
boŞ
 
ü—‹
)

225 
tÿche_t
 *
tÿche
;

227 ià(!
cÚfig_tÿche
)

228  (
NULL
);

230 
tÿche
 = 
	`tsd_tÿche_g‘
(
tsd
);

231 ià(!
ü—‹
)

232  (
tÿche
);

233 ià(
	`uÆik–y
(
tÿche
 =ğ
NULL
è&& 
	`tsd_nomš®
(
tsd
)) {

234 
tÿche
 = 
	`tÿche_g‘_h¬d
(
tsd
);

235 
	`tsd_tÿche_£t
(
tsd
, 
tÿche
);

238  (
tÿche
);

239 
	}
}

241 
JEMALLOC_ALWAYS_INLINE
 

242 
	$tÿche_ev’t
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
)

245 ià(
TCACHE_GC_INCR
 == 0)

248 ià(
	`uÆik–y
(
	`tick”_tick
(&
tÿche
->
gc_tick”
)))

249 
	`tÿche_ev’t_h¬d
(
tsd
, 
tÿche
);

250 
	}
}

252 
JEMALLOC_ALWAYS_INLINE
 *

253 
	$tÿche_®loc_—sy
(
tÿche_bš_t
 *
tbš
, 
boŞ
 *
tÿche_sucûss
)

255 *
»t
;

257 ià(
	`uÆik–y
(
tbš
->
nÿched
 == 0)) {

258 
tbš
->
low_w©”
 = -1;

259 *
tÿche_sucûss
 = 
çl£
;

260  (
NULL
);

269 *
tÿche_sucûss
 = 
Œue
;

270 
»t
 = *(
tbš
->
ava
 -bš->
nÿched
);

271 
tbš
->
nÿched
--;

273 ià(
	`uÆik–y
(()
tbš
->
nÿched
 <bš->
low_w©”
))

274 
tbš
->
low_w©”
 =bš->
nÿched
;

276  (
»t
);

277 
	}
}

279 
JEMALLOC_ALWAYS_INLINE
 *

280 
	$tÿche_®loc_sm®l
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
, 
size_t
 
size
,

281 
szšd_t
 
bššd
, 
boŞ
 
z”o
, boŞ 
¦ow_·th
)

283 *
»t
;

284 
tÿche_bš_t
 *
tbš
;

285 
boŞ
 
tÿche_sucûss
;

286 
size_t
 
usize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

288 
	`as£¹
(
bššd
 < 
NBINS
);

289 
tbš
 = &
tÿche
->
tbšs
[
bššd
];

290 
»t
 = 
	`tÿche_®loc_—sy
(
tbš
, &
tÿche_sucûss
);

291 
	`as£¹
(
tÿche_sucûss
 =ğ(
»t
 !ğ
NULL
));

292 ià(
	`uÆik–y
(!
tÿche_sucûss
)) {

293 
boŞ
 
tÿche_h¬d_sucûss
;

294 
¬’a
 = 
	`¬’a_choo£
(
tsd
,‡rena);

295 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

296  (
NULL
);

298 
»t
 = 
	`tÿche_®loc_sm®l_h¬d
(
	`tsd_tsdn
(
tsd
), 
¬’a
, 
tÿche
,

299 
tbš
, 
bššd
, &
tÿche_h¬d_sucûss
);

300 ià(
tÿche_h¬d_sucûss
 =ğ
çl£
)

301  (
NULL
);

304 
	`as£¹
(
»t
);

309 ià(
cÚfig_´of
 || (
¦ow_·th
 && 
cÚfig_fl
è|| 
	`uÆik–y
(
z”o
)) {

310 
usize
 = 
	`šdex2size
(
bššd
);

311 
	`as£¹
(
	`tÿche_§Îoc
(
	`tsd_tsdn
(
tsd
), 
»t
è=ğ
usize
);

314 ià(
	`lik–y
(!
z”o
)) {

315 ià(
¦ow_·th
 && 
cÚfig_fl
) {

316 ià(
	`uÆik–y
(
İt_junk_®loc
)) {

317 
	`¬’a_®loc_junk_sm®l
(
»t
,

318 &
¬’a_bš_šfo
[
bššd
], 
çl£
);

319 } ià(
	`uÆik–y
(
İt_z”o
))

320 
	`mem£t
(
»t
, 0, 
usize
);

323 ià(
¦ow_·th
 && 
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

324 
	`¬’a_®loc_junk_sm®l
(
»t
, &
¬’a_bš_šfo
[
bššd
],

325 
Œue
);

327 
	`mem£t
(
»t
, 0, 
usize
);

330 ià(
cÚfig_¡©s
)

331 
tbš
->
t¡©s
.
Äeque¡s
++;

332 ià(
cÚfig_´of
)

333 
tÿche
->
´of_accumby‹s
 +ğ
usize
;

334 
	`tÿche_ev’t
(
tsd
, 
tÿche
);

335  (
»t
);

336 
	}
}

338 
JEMALLOC_ALWAYS_INLINE
 *

339 
	$tÿche_®loc_Ïrge
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
, 
size_t
 
size
,

340 
szšd_t
 
bššd
, 
boŞ
 
z”o
, boŞ 
¦ow_·th
)

342 *
»t
;

343 
tÿche_bš_t
 *
tbš
;

344 
boŞ
 
tÿche_sucûss
;

346 
	`as£¹
(
bššd
 < 
nhbšs
);

347 
tbš
 = &
tÿche
->
tbšs
[
bššd
];

348 
»t
 = 
	`tÿche_®loc_—sy
(
tbš
, &
tÿche_sucûss
);

349 
	`as£¹
(
tÿche_sucûss
 =ğ(
»t
 !ğ
NULL
));

350 ià(
	`uÆik–y
(!
tÿche_sucûss
)) {

355 
¬’a
 = 
	`¬’a_choo£
(
tsd
,‡rena);

356 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

357  (
NULL
);

359 
»t
 = 
	`¬’a_m®loc_Ïrge
(
	`tsd_tsdn
(
tsd
), 
¬’a
, 
bššd
, 
z”o
);

360 ià(
»t
 =ğ
NULL
)

361  (
NULL
);

363 
size_t
 
usize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

366 ià(
cÚfig_´of
 || (
¦ow_·th
 && 
cÚfig_fl
) ||

367 
	`uÆik–y
(
z”o
)) {

368 
usize
 = 
	`šdex2size
(
bššd
);

369 
	`as£¹
(
usize
 <ğ
tÿche_maxşass
);

372 ià(
cÚfig_´of
 && 
usize
 =ğ
LARGE_MINCLASS
) {

373 
¬’a_chunk_t
 *
chunk
 =

374 (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
»t
);

375 
size_t
 
·gešd
 = (((
ušŒ_t
)
»t
 - (ušŒ_t)
chunk
) >>

376 
LG_PAGE
);

377 
	`¬’a_m­b™s_Ïrge_bššd_£t
(
chunk
, 
·gešd
,

378 
BININD_INVALID
);

380 ià(
	`lik–y
(!
z”o
)) {

381 ià(
¦ow_·th
 && 
cÚfig_fl
) {

382 ià(
	`uÆik–y
(
İt_junk_®loc
)) {

383 
	`mem£t
(
»t
, 
JEMALLOC_ALLOC_JUNK
,

384 
usize
);

385 } ià(
	`uÆik–y
(
İt_z”o
))

386 
	`mem£t
(
»t
, 0, 
usize
);

389 
	`mem£t
(
»t
, 0, 
usize
);

391 ià(
cÚfig_¡©s
)

392 
tbš
->
t¡©s
.
Äeque¡s
++;

393 ià(
cÚfig_´of
)

394 
tÿche
->
´of_accumby‹s
 +ğ
usize
;

397 
	`tÿche_ev’t
(
tsd
, 
tÿche
);

398  (
»t
);

399 
	}
}

401 
JEMALLOC_ALWAYS_INLINE
 

402 
	$tÿche_d®loc_sm®l
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, *
±r
, 
szšd_t
 
bššd
,

403 
boŞ
 
¦ow_·th
)

405 
tÿche_bš_t
 *
tbš
;

406 
tÿche_bš_šfo_t
 *
tbš_šfo
;

408 
	`as£¹
(
	`tÿche_§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
è<ğ
SMALL_MAXCLASS
);

410 ià(
¦ow_·th
 && 
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
))

411 
	`¬’a_d®loc_junk_sm®l
(
±r
, &
¬’a_bš_šfo
[
bššd
]);

413 
tbš
 = &
tÿche
->
tbšs
[
bššd
];

414 
tbš_šfo
 = &
tÿche_bš_šfo
[
bššd
];

415 ià(
	`uÆik–y
(
tbš
->
nÿched
 =ğ
tbš_šfo
->
nÿched_max
)) {

416 
	`tÿche_bš_æush_sm®l
(
tsd
, 
tÿche
, 
tbš
, 
bššd
,

417 (
tbš_šfo
->
nÿched_max
 >> 1));

419 
	`as£¹
(
tbš
->
nÿched
 < 
tbš_šfo
->
nÿched_max
);

420 
tbš
->
nÿched
++;

421 *(
tbš
->
ava
 -bš->
nÿched
èğ
±r
;

423 
	`tÿche_ev’t
(
tsd
, 
tÿche
);

424 
	}
}

426 
JEMALLOC_ALWAYS_INLINE
 

427 
	$tÿche_d®loc_Ïrge
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, *
±r
, 
size_t
 
size
,

428 
boŞ
 
¦ow_·th
)

430 
szšd_t
 
bššd
;

431 
tÿche_bš_t
 *
tbš
;

432 
tÿche_bš_šfo_t
 *
tbš_šfo
;

434 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

435 
	`as£¹
(
	`tÿche_§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
è> 
SMALL_MAXCLASS
);

436 
	`as£¹
(
	`tÿche_§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
è<ğ
tÿche_maxşass
);

438 
bššd
 = 
	`size2šdex
(
size
);

440 ià(
¦ow_·th
 && 
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
))

441 
	`¬’a_d®loc_junk_Ïrge
(
±r
, 
size
);

443 
tbš
 = &
tÿche
->
tbšs
[
bššd
];

444 
tbš_šfo
 = &
tÿche_bš_šfo
[
bššd
];

445 ià(
	`uÆik–y
(
tbš
->
nÿched
 =ğ
tbš_šfo
->
nÿched_max
)) {

446 
	`tÿche_bš_æush_Ïrge
(
tsd
, 
tbš
, 
bššd
,

447 (
tbš_šfo
->
nÿched_max
 >> 1), 
tÿche
);

449 
	`as£¹
(
tbš
->
nÿched
 < 
tbš_šfo
->
nÿched_max
);

450 
tbš
->
nÿched
++;

451 *(
tbš
->
ava
 -bš->
nÿched
èğ
±r
;

453 
	`tÿche_ev’t
(
tsd
, 
tÿche
);

454 
	}
}

456 
JEMALLOC_ALWAYS_INLINE
 
tÿche_t
 *

457 
	$tÿches_g‘
(
tsd_t
 *
tsd
, 
šd
)

459 
tÿches_t
 *
–m
 = &
tÿches
[
šd
];

460 ià(
	`uÆik–y
(
–m
->
tÿche
 =ğ
NULL
)) {

461 
–m
->
tÿche
 = 
	`tÿche_ü—‹
(
	`tsd_tsdn
(
tsd
), 
	`¬’a_choo£
(tsd,

462 
NULL
));

464  (
–m
->
tÿche
);

465 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/ticker.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
tick”_s
 
	ttick”_t
;

8 #ifdeà
JEMALLOC_H_STRUCTS


10 
	stick”_s
 {

11 
št32_t
 
	mtick
;

12 
št32_t
 
	mÁicks
;

17 #ifdeà
JEMALLOC_H_EXTERNS


21 #ifdeà
JEMALLOC_H_INLINES


23 #iâdeà
JEMALLOC_ENABLE_INLINE


24 
tick”_š™
(
tick”_t
 *
tick”
, 
št32_t
 
Áicks
);

25 
tick”_cİy
(
tick”_t
 *
tick”
, cÚ¡ick”_ˆ*
Ùh”
);

26 
št32_t
 
tick”_»ad
(cÚ¡ 
tick”_t
 *
tick”
);

27 
boŞ
 
tick”_ticks
(
tick”_t
 *
tick”
, 
št32_t
 
Áicks
);

28 
boŞ
 
tick”_tick
(
tick”_t
 *
tick”
);

31 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_TICKER_C_
))

32 
JEMALLOC_INLINE
 

33 
	$tick”_š™
(
tick”_t
 *
tick”
, 
št32_t
 
Áicks
)

36 
tick”
->
tick
 = 
Áicks
;

37 
tick”
->
Áicks
 =‚ticks;

38 
	}
}

40 
JEMALLOC_INLINE
 

41 
	$tick”_cİy
(
tick”_t
 *
tick”
, cÚ¡ick”_ˆ*
Ùh”
)

44 *
tick”
 = *
Ùh”
;

45 
	}
}

47 
JEMALLOC_INLINE
 
št32_t


48 
	$tick”_»ad
(cÚ¡ 
tick”_t
 *
tick”
)

51  (
tick”
->
tick
);

52 
	}
}

54 
JEMALLOC_INLINE
 
boŞ


55 
	$tick”_ticks
(
tick”_t
 *
tick”
, 
št32_t
 
Áicks
)

58 ià(
	`uÆik–y
(
tick”
->
tick
 < 
Áicks
)) {

59 
tick”
->
tick
 =ick”->
Áicks
;

60  (
Œue
);

62 
tick”
->
tick
 -ğ
Áicks
;

63 (
çl£
);

64 
	}
}

66 
JEMALLOC_INLINE
 
boŞ


67 
	$tick”_tick
(
tick”_t
 *
tick”
)

70  (
	`tick”_ticks
(
tick”
, 1));

71 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/tsd.h

2 #ifdeà
JEMALLOC_H_TYPES


5 
	#MALLOC_TSD_CLEANUPS_MAX
 2

	)

7 
	$boŞ
 (*
	tm®loc_tsd_ş—nup_t
)();

9 #ià(!
	`defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è&& !defšed(
JEMALLOC_TLS
) && \

10 !
	$defšed
(
_WIN32
))

11 
tsd_š™_block_s
 
	ttsd_š™_block_t
;

12 
tsd_š™_h—d_s
 
	ttsd_š™_h—d_t
;

15 
tsd_s
 
	ttsd_t
;

16 
tsdn_s
 
	ttsdn_t
;

18 
	#TSDN_NULL
 ((
tsdn_t
 *)0)

	)

21 
tsd_¡©e_unš™Ÿlized
,

22 
tsd_¡©e_nomš®
,

23 
tsd_¡©e_purg©Üy
,

24 
tsd_¡©e_»šÿº©ed


25 } 
	ttsd_¡©e_t
;

79 #ifdeà
JEMALLOC_MALLOC_THREAD_CLEANUP


80 
	#m®loc_tsd_ty³s
(
a_Çme
, 
a_ty³
)

	)

81 #–ià(
	`defšed
(
JEMALLOC_TLS
))

82 
	#m®loc_tsd_ty³s
(
a_Çme
, 
a_ty³
)

	)

83 #–ià(
	`defšed
(
_WIN32
))

84 
	#m®loc_tsd_ty³s
(
a_Çme
, 
a_ty³
) \

86 
boŞ
 
š™Ÿlized
; \

87 
a_ty³
 
v®
; \

88 } 
	ta_Çme
##
	ttsd_w¿µ”_t
;

	)

90 
	#m®loc_tsd_ty³s
(
a_Çme
, 
a_ty³
) \

92 
boŞ
 
š™Ÿlized
; \

93 
a_ty³
 
v®
; \

94 } 
	ta_Çme
##
	ttsd_w¿µ”_t
;

	)

98 
	#m®loc_tsd_´Ùos
(
a_©Œ
, 
a_Çme
, 
a_ty³
) \

99 
a_©Œ
 
boŞ
 \

100 
a_Çme
##
	`tsd_boÙ0
(); \

101 
a_©Œ
 \

102 
a_Çme
##
	`tsd_boÙ1
(); \

103 
a_©Œ
 
boŞ
 \

104 
a_Çme
##
	`tsd_boÙ
(); \

105 
a_©Œ
 
boŞ
 \

106 
a_Çme
##
	`tsd_boÙed_g‘
(); \

107 
a_©Œ
 
a_ty³
 * \

108 
a_Çme
##
	`tsd_g‘
(); \

109 
a_©Œ
 \

110 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
);

	)

113 #ifdeà
JEMALLOC_MALLOC_THREAD_CLEANUP


114 
	#m®loc_tsd_ex‹ºs
(
a_Çme
, 
a_ty³
) \

115 
__th»ad
 
a_ty³
 
a_Çme
##
tsd_s
; \

116 
__th»ad
 
boŞ
 
a_Çme
##
tsd_š™Ÿlized
; \

117 
boŞ
 
a_Çme
##
tsd_boÙed
;

	)

118 #–ià(
	`defšed
(
JEMALLOC_TLS
))

119 
	#m®loc_tsd_ex‹ºs
(
a_Çme
, 
a_ty³
) \

120 
__th»ad
 
a_ty³
 
a_Çme
##
tsd_s
; \

121 
±h»ad_key_t
 
a_Çme
##
tsd_tsd
; \

122 
boŞ
 
a_Çme
##
tsd_boÙed
;

	)

123 #–ià(
	`defšed
(
_WIN32
))

124 
	#m®loc_tsd_ex‹ºs
(
a_Çme
, 
a_ty³
) \

125 
DWORD
 
a_Çme
##
tsd_tsd
; \

126 
a_Çme
##
tsd_w¿µ”_t
‡_Çme##
tsd_boÙ_w¿µ”
; \

127 
boŞ
 
a_Çme
##
tsd_boÙed
;

	)

129 
	#m®loc_tsd_ex‹ºs
(
a_Çme
, 
a_ty³
) \

130 
±h»ad_key_t
 
a_Çme
##
tsd_tsd
; \

131 
tsd_š™_h—d_t
 
a_Çme
##
tsd_š™_h—d
; \

132 
a_Çme
##
tsd_w¿µ”_t
‡_Çme##
tsd_boÙ_w¿µ”
; \

133 
boŞ
 
a_Çme
##
tsd_boÙed
;

	)

137 #ifdeà
JEMALLOC_MALLOC_THREAD_CLEANUP


138 
	#m®loc_tsd_d©a
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
) \

139 
a_©Œ
 
__th»ad
 
a_ty³
 
JEMALLOC_TLS_MODEL
 \

140 
a_Çme
##
tsd_s
 = 
a_š™Ÿliz”
; \

141 
a_©Œ
 
__th»ad
 
boŞ
 
JEMALLOC_TLS_MODEL
 \

142 
a_Çme
##
tsd_š™Ÿlized
 = 
çl£
; \

143 
a_©Œ
 
boŞ
 
a_Çme
##
tsd_boÙed
 = 
çl£
;

	)

144 #–ià(
	`defšed
(
JEMALLOC_TLS
))

145 
	#m®loc_tsd_d©a
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
) \

146 
a_©Œ
 
__th»ad
 
a_ty³
 
JEMALLOC_TLS_MODEL
 \

147 
a_Çme
##
tsd_s
 = 
a_š™Ÿliz”
; \

148 
a_©Œ
 
±h»ad_key_t
 
a_Çme
##
tsd_tsd
; \

149 
a_©Œ
 
boŞ
 
a_Çme
##
tsd_boÙed
 = 
çl£
;

	)

150 #–ià(
	`defšed
(
_WIN32
))

151 
	#m®loc_tsd_d©a
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
) \

152 
a_©Œ
 
DWORD
 
a_Çme
##
tsd_tsd
; \

153 
a_©Œ
 
a_Çme
##
tsd_w¿µ”_t
‡_Çme##
tsd_boÙ_w¿µ”
 = { \

154 
çl£
, \

155 
a_š™Ÿliz”
 \

156 
	}
}; \

157 
a_©Œ
 
boŞ
 
a_Çme
##
tsd_boÙed
 = 
çl£
;

	)

159 
	#m®loc_tsd_d©a
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
) \

160 
a_©Œ
 
±h»ad_key_t
 
a_Çme
##
tsd_tsd
; \

161 
a_©Œ
 
tsd_š™_h—d_t
 
a_Çme
##
tsd_š™_h—d
 = { \

162 
	`ql_h—d_š™Ÿliz”
(
blocks
), \

163 
MALLOC_MUTEX_INITIALIZER
 \

165 
a_©Œ
 
a_Çme
##
tsd_w¿µ”_t
‡_Çme##
tsd_boÙ_w¿µ”
 = { \

166 
çl£
, \

167 
a_š™Ÿliz”
 \

169 
a_©Œ
 
boŞ
 
a_Çme
##
tsd_boÙed
 = 
çl£
;

	)

173 #ifdeà
JEMALLOC_MALLOC_THREAD_CLEANUP


174 
	#m®loc_tsd_funcs
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
, \

175 
a_ş—nup
) \

177 
a_©Œ
 
boŞ
 \

178 
a_Çme
##
	`tsd_ş—nup_w¿µ”
() \

181 ià(
a_Çme
##
tsd_š™Ÿlized
) { \

182 
a_Çme
##
tsd_š™Ÿlized
 = 
çl£
; \

183 
	`a_ş—nup
(&
a_Çme
##
tsd_s
); \

185  (
a_Çme
##
tsd_š™Ÿlized
); \

187 
a_©Œ
 
boŞ
 \

188 
a_Çme
##
	`tsd_boÙ0
() \

191 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) { \

192 
	`m®loc_tsd_ş—nup_»gi¡”
( \

193 &
a_Çme
##
tsd_ş—nup_w¿µ”
); \

195 
a_Çme
##
tsd_boÙed
 = 
Œue
; \

196  (
çl£
); \

198 
a_©Œ
 \

199 
a_Çme
##
	`tsd_boÙ1
() \

204 
a_©Œ
 
boŞ
 \

205 
a_Çme
##
	`tsd_boÙ
() \

208  (
a_Çme
##
	`tsd_boÙ0
()); \

210 
a_©Œ
 
boŞ
 \

211 
a_Çme
##
	`tsd_boÙed_g‘
() \

214  (
a_Çme
##
tsd_boÙed
); \

217 
a_©Œ
 
a_ty³
 * \

218 
a_Çme
##
	`tsd_g‘
() \

221 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

222  (&
a_Çme
##
tsd_s
); \

224 
a_©Œ
 \

225 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
) \

228 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

229 
a_Çme
##
tsd_s
 = (*
v®
); \

230 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) \

231 
a_Çme
##
tsd_š™Ÿlized
 = 
Œue
; \

232 }

	)

233 #–ià(
defšed
(
JEMALLOC_TLS
))

234 
	#m®loc_tsd_funcs
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
, \

235 
a_ş—nup
) \

237 
a_©Œ
 
boŞ
 \

238 
a_Çme
##
	`tsd_boÙ0
() \

241 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) { \

242 ià(
	`±h»ad_key_ü—‹
(&
a_Çme
##
tsd_tsd
, 
a_ş—nup
) != \

244  (
Œue
); \

246 
a_Çme
##
tsd_boÙed
 = 
Œue
; \

247  (
çl£
); \

249 
a_©Œ
 \

250 
a_Çme
##
	`tsd_boÙ1
() \

255 
a_©Œ
 
boŞ
 \

256 
a_Çme
##
	`tsd_boÙ
() \

259  (
a_Çme
##
	`tsd_boÙ0
()); \

261 
a_©Œ
 
boŞ
 \

262 
a_Çme
##
	`tsd_boÙed_g‘
() \

265  (
a_Çme
##
tsd_boÙed
); \

268 
a_©Œ
 
a_ty³
 * \

269 
a_Çme
##
	`tsd_g‘
() \

272 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

273  (&
a_Çme
##
tsd_s
); \

275 
a_©Œ
 \

276 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
) \

279 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

280 
a_Çme
##
tsd_s
 = (*
v®
); \

281 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) { \

282 ià(
	`±h»ad_£t¥ecific
(
a_Çme
##
tsd_tsd
, \

283 (*)(&
a_Çme
##
tsd_s
))) { \

284 
	`m®loc_wr™e
("<jemalloc>: Error" \

286 ià(
İt_abÜt
) \

287 
	`abÜt
(); \

290 }

	)

291 #–ià(
defšed
(
_WIN32
))

292 
	#m®loc_tsd_funcs
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
, \

293 
a_ş—nup
) \

295 
a_©Œ
 
boŞ
 \

296 
a_Çme
##
	`tsd_ş—nup_w¿µ”
() \

298 
DWORD
 
”rÜ
 = 
	`G‘La¡E¼Ü
(); \

299 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
 = (a_name##tsd_wrapper_t *) \

300 
	`TlsG‘V®ue
(
a_Çme
##
tsd_tsd
); \

301 
	`S‘La¡E¼Ü
(
”rÜ
); \

303 ià(
w¿µ”
 =ğ
NULL
) \

304  (
çl£
); \

305 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
 && \

306 
w¿µ”
->
š™Ÿlized
) { \

307 
w¿µ”
->
š™Ÿlized
 = 
çl£
; \

308 
	`a_ş—nup
(&
w¿µ”
->
v®
); \

309 ià(
w¿µ”
->
š™Ÿlized
) { \

311  (
Œue
); \

314 
	`m®loc_tsd_d®loc
(
w¿µ”
); \

315  (
çl£
); \

317 
a_©Œ
 \

318 
a_Çme
##
	`tsd_w¿µ”_£t
×_Çme##
tsd_w¿µ”_t
 *
w¿µ”
) \

321 ià(!
	`TlsS‘V®ue
(
a_Çme
##
tsd_tsd
, (*)
w¿µ”
)) { \

322 
	`m®loc_wr™e
("<jemalloc>: Error setting" \

324 
	`abÜt
(); \

327 
a_©Œ
 
a_Çme
##
tsd_w¿µ”_t
 * \

328 
a_Çme
##
	`tsd_w¿µ”_g‘
() \

330 
DWORD
 
”rÜ
 = 
	`G‘La¡E¼Ü
(); \

331 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
 = (a_name##tsd_wrapper_t *) \

332 
	`TlsG‘V®ue
(
a_Çme
##
tsd_tsd
); \

333 
	`S‘La¡E¼Ü
(
”rÜ
); \

335 ià(
	`uÆik–y
(
w¿µ”
 =ğ
NULL
)) { \

336 
w¿µ”
 = (
a_Çme
##
tsd_w¿µ”_t
 *) \

337 
	`m®loc_tsd_m®loc
((
a_Çme
##
tsd_w¿µ”_t
)); \

338 ià(
w¿µ”
 =ğ
NULL
) { \

339 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating" \

341 
	`abÜt
(); \

343 
w¿µ”
->
š™Ÿlized
 = 
çl£
; \

344 
w¿µ”
->
v®
 = 
a_š™Ÿliz”
; \

346 
a_Çme
##
	`tsd_w¿µ”_£t
(
w¿µ”
); \

348  (
w¿µ”
); \

350 
a_©Œ
 
boŞ
 \

351 
a_Çme
##
	`tsd_boÙ0
() \

354 
a_Çme
##
tsd_tsd
 = 
	`TlsAÎoc
(); \

355 ià(
a_Çme
##
tsd_tsd
 =ğ
TLS_OUT_OF_INDEXES
) \

356  (
Œue
); \

357 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) { \

358 
	`m®loc_tsd_ş—nup_»gi¡”
( \

359 &
a_Çme
##
tsd_ş—nup_w¿µ”
); \

361 
a_Çme
##
	`tsd_w¿µ”_£t
(&a_Çme##
tsd_boÙ_w¿µ”
); \

362 
a_Çme
##
tsd_boÙed
 = 
Œue
; \

363  (
çl£
); \

365 
a_©Œ
 \

366 
a_Çme
##
	`tsd_boÙ1
() \

368 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

369 
w¿µ”
 = (
a_Çme
##
tsd_w¿µ”_t
 *) \

370 
	`m®loc_tsd_m®loc
((
a_Çme
##
tsd_w¿µ”_t
)); \

371 ià(
w¿µ”
 =ğ
NULL
) { \

372 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating" \

374 
	`abÜt
(); \

376 
	`memıy
(
w¿µ”
, &
a_Çme
##
tsd_boÙ_w¿µ”
, \

377 (
a_Çme
##
tsd_w¿µ”_t
)); \

378 
a_Çme
##
	`tsd_w¿µ”_£t
(
w¿µ”
); \

380 
a_©Œ
 
boŞ
 \

381 
a_Çme
##
	`tsd_boÙ
() \

384 ià(
a_Çme
##
	`tsd_boÙ0
()) \

385  (
Œue
); \

386 
a_Çme
##
	`tsd_boÙ1
(); \

387  (
çl£
); \

389 
a_©Œ
 
boŞ
 \

390 
a_Çme
##
	`tsd_boÙed_g‘
() \

393  (
a_Çme
##
tsd_boÙed
); \

396 
a_©Œ
 
a_ty³
 * \

397 
a_Çme
##
	`tsd_g‘
() \

399 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

401 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

402 
w¿µ”
 = 
a_Çme
##
	`tsd_w¿µ”_g‘
(); \

403  (&
w¿µ”
->
v®
); \

405 
a_©Œ
 \

406 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
) \

408 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

410 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

411 
w¿µ”
 = 
a_Çme
##
	`tsd_w¿µ”_g‘
(); \

412 
w¿µ”
->
v®
 = *(val); \

413 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) \

414 
w¿µ”
->
š™Ÿlized
 = 
Œue
; \

415 }

	)

417 
	#m®loc_tsd_funcs
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
, \

418 
a_ş—nup
) \

420 
a_©Œ
 \

421 
a_Çme
##
	`tsd_ş—nup_w¿µ”
(*
¬g
) \

423 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
 = (a_Çme##tsd_w¿µ”_ˆ*)
¬g
; \

425 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
 && \

426 
w¿µ”
->
š™Ÿlized
) { \

427 
w¿µ”
->
š™Ÿlized
 = 
çl£
; \

428 
	`a_ş—nup
(&
w¿µ”
->
v®
); \

429 ià(
w¿µ”
->
š™Ÿlized
) { \

431 ià(
	`±h»ad_£t¥ecific
(
a_Çme
##
tsd_tsd
, \

432 (*)
w¿µ”
)) { \

433 
	`m®loc_wr™e
("<jemalloc>: Error" \

435 ià(
İt_abÜt
) \

436 
	`abÜt
(); \

441 
	`m®loc_tsd_d®loc
(
w¿µ”
); \

443 
a_©Œ
 \

444 
a_Çme
##
	`tsd_w¿µ”_£t
×_Çme##
tsd_w¿µ”_t
 *
w¿µ”
) \

447 ià(
	`±h»ad_£t¥ecific
(
a_Çme
##
tsd_tsd
, \

448 (*)
w¿µ”
)) { \

449 
	`m®loc_wr™e
("<jemalloc>: Error setting" \

451 
	`abÜt
(); \

454 
a_©Œ
 
a_Çme
##
tsd_w¿µ”_t
 * \

455 
a_Çme
##
	`tsd_w¿µ”_g‘
() \

457 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
 = (a_name##tsd_wrapper_t *) \

458 
	`±h»ad_g‘¥ecific
(
a_Çme
##
tsd_tsd
); \

460 ià(
	`uÆik–y
(
w¿µ”
 =ğ
NULL
)) { \

461 
tsd_š™_block_t
 
block
; \

462 
w¿µ”
 = 
	`tsd_š™_check_»cursiÚ
( \

463 &
a_Çme
##
tsd_š™_h—d
, &
block
); \

464 ià(
w¿µ”
) \

465  (
w¿µ”
); \

466 
w¿µ”
 = (
a_Çme
##
tsd_w¿µ”_t
 *) \

467 
	`m®loc_tsd_m®loc
((
a_Çme
##
tsd_w¿µ”_t
)); \

468 
block
.
d©a
 = 
w¿µ”
; \

469 ià(
w¿µ”
 =ğ
NULL
) { \

470 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating" \

472 
	`abÜt
(); \

474 
w¿µ”
->
š™Ÿlized
 = 
çl£
; \

475 
w¿µ”
->
v®
 = 
a_š™Ÿliz”
; \

477 
a_Çme
##
	`tsd_w¿µ”_£t
(
w¿µ”
); \

478 
	`tsd_š™_fšish
(&
a_Çme
##
tsd_š™_h—d
, &
block
); \

480  (
w¿µ”
); \

482 
a_©Œ
 
boŞ
 \

483 
a_Çme
##
	`tsd_boÙ0
() \

486 ià(
	`±h»ad_key_ü—‹
(&
a_Çme
##
tsd_tsd
, \

487 
a_Çme
##
tsd_ş—nup_w¿µ”
) != 0) \

488  (
Œue
); \

489 
a_Çme
##
	`tsd_w¿µ”_£t
(&a_Çme##
tsd_boÙ_w¿µ”
); \

490 
a_Çme
##
tsd_boÙed
 = 
Œue
; \

491  (
çl£
); \

493 
a_©Œ
 \

494 
a_Çme
##
	`tsd_boÙ1
() \

496 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

497 
w¿µ”
 = (
a_Çme
##
tsd_w¿µ”_t
 *) \

498 
	`m®loc_tsd_m®loc
((
a_Çme
##
tsd_w¿µ”_t
)); \

499 ià(
w¿µ”
 =ğ
NULL
) { \

500 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating" \

502 
	`abÜt
(); \

504 
	`memıy
(
w¿µ”
, &
a_Çme
##
tsd_boÙ_w¿µ”
, \

505 (
a_Çme
##
tsd_w¿µ”_t
)); \

506 
a_Çme
##
	`tsd_w¿µ”_£t
(
w¿µ”
); \

508 
a_©Œ
 
boŞ
 \

509 
a_Çme
##
	`tsd_boÙ
() \

512 ià(
a_Çme
##
	`tsd_boÙ0
()) \

513  (
Œue
); \

514 
a_Çme
##
	`tsd_boÙ1
(); \

515  (
çl£
); \

517 
a_©Œ
 
boŞ
 \

518 
a_Çme
##
	`tsd_boÙed_g‘
() \

521  (
a_Çme
##
tsd_boÙed
); \

524 
a_©Œ
 
a_ty³
 * \

525 
a_Çme
##
	`tsd_g‘
() \

527 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

529 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

530 
w¿µ”
 = 
a_Çme
##
	`tsd_w¿µ”_g‘
(); \

531  (&
w¿µ”
->
v®
); \

533 
a_©Œ
 \

534 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
) \

536 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

538 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

539 
w¿µ”
 = 
a_Çme
##
	`tsd_w¿µ”_g‘
(); \

540 
w¿µ”
->
v®
 = *(val); \

541 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) \

542 
w¿µ”
->
š™Ÿlized
 = 
Œue
; \

543 }

	)

548 #ifdeà
JEMALLOC_H_STRUCTS


550 #ià(!
defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è&& !defšed(
JEMALLOC_TLS
) && \

551 !
	$defšed
(
_WIN32
))

552 
	stsd_š™_block_s
 {

553 
	`ql_–m
(
tsd_š™_block_t
è
lšk
;

554 
±h»ad_t
 
th»ad
;

555 *
d©a
;

557 
	stsd_š™_h—d_s
 {

558 
	`ql_h—d
(
tsd_š™_block_t
è
blocks
;

559 
m®loc_mu‹x_t
 
lock
;

563 
	#MALLOC_TSD
 \

565 
	`O
(
tÿche
, 
tÿche_t
 *) \

566 
	`O
(
th»ad_®loÿ‹d
, 
ušt64_t
) \

567 
	`O
(
th»ad_d—Îoÿ‹d
, 
ušt64_t
) \

568 
	`O
(
´of_td©a
, 
´of_td©a_t
 *) \

569 
	`O
(
Ÿ»Ç
, 
¬’a_t
 *) \

570 
	`O
(
¬’a
, 
¬’a_t
 *) \

571 
	`O
(
¬’as_td©a
, 
¬’a_td©a_t
 *) \

572 
	`O
(
Ç»Çs_td©a
, ) \

573 
	`O
(
¬’as_td©a_by·ss
, 
boŞ
) \

574 
	`O
(
tÿche_’abËd
, 
tÿche_’abËd_t
) \

575 
	`O
(
qu¬ªtše
, 
qu¬ªtše_t
 *) \

576 
	`O
(
w™Ãs£s
, 
w™Ãss_li¡_t
) \

577 
	`O
(
w™Ãss_fÜk
, 
boŞ
) \

578 

	)

579 
	#TSD_INITIALIZER
 { \

580 
tsd_¡©e_unš™Ÿlized
, \

581 
NULL
, \

584 
NULL
, \

585 
NULL
, \

586 
NULL
, \

587 
NULL
, \

589 
çl£
, \

590 
tÿche_’abËd_deçuÉ
, \

591 
NULL
, \

592 
	`ql_h—d_š™Ÿliz”
(
w™Ãs£s
), \

593 
çl£
 \

594 
	}

	)
}

596 
	stsd_s
 {

597 
tsd_¡©e_t
 
	m¡©e
;

598 
	#O
(
n
, 
t
) \

599 
t
 
n
;

	)

600 
	mMALLOC_TSD


601 #undeà
O


609 
	stsdn_s
 {

610 
tsd_t
 
	mtsd
;

613 cÚ¡ 
tsd_t
 
	gtsd_š™Ÿliz”
 = 
TSD_INITIALIZER
;

615 
	$m®loc_tsd_ty³s
(, 
tsd_t
)

619 #ifdeà
JEMALLOC_H_EXTERNS


621 *
	`m®loc_tsd_m®loc
(
size_t
 
size
);

622 
	`m®loc_tsd_d®loc
(*
w¿µ”
);

623 
	`m®loc_tsd_no_ş—nup
(*
¬g
);

624 
	`m®loc_tsd_ş—nup_»gi¡”
(
	$boŞ
 (*
f
)());

625 
tsd_t
 *
	`m®loc_tsd_boÙ0
();

626 
	`m®loc_tsd_boÙ1
();

627 #ià(!
	`defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è&& !defšed(
JEMALLOC_TLS
) && \

628 !
	$defšed
(
_WIN32
))

629 *
	`tsd_š™_check_»cursiÚ
(
tsd_š™_h—d_t
 *
h—d
,

630 
tsd_š™_block_t
 *
block
);

631 
	`tsd_š™_fšish
(
tsd_š™_h—d_t
 *
h—d
, 
tsd_š™_block_t
 *
block
);

633 
	`tsd_ş—nup
(*
¬g
);

637 #ifdeà
JEMALLOC_H_INLINES


639 #iâdeà
JEMALLOC_ENABLE_INLINE


640 
	`m®loc_tsd_´Ùos
(
	`JEMALLOC_ATTR
(
unu£d
), , 
tsd_t
)

642 
tsd_t
 *
	`tsd_ãtch
();

643 
tsdn_t
 *
	`tsd_tsdn
(
tsd_t
 *
tsd
);

644 
boŞ
 
	`tsd_nomš®
(
tsd_t
 *
tsd
);

645 
	#O
(
n
, 
t
) \

646 
t
 *
tsd_
##
n
##
	`p_g‘
(
tsd_t
 *
tsd
); \

647 
t
 
tsd_
##
n
##
	`_g‘
(
tsd_t
 *
tsd
); \

648 
tsd_
##
n
##
	`_£t
(
tsd_t
 *
tsd
, 
t
‚);

	)

649 
MALLOC_TSD


650 #undeà
O


651 
tsdn_t
 *
	`tsdn_ãtch
();

652 
boŞ
 
	`tsdn_nuÎ
(cÚ¡ 
tsdn_t
 *
tsdn
);

653 
tsd_t
 *
	`tsdn_tsd
(
tsdn_t
 *
tsdn
);

656 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_TSD_C_
))

657 
	$m®loc_tsd_ex‹ºs
(, 
tsd_t
)

658 
	$m®loc_tsd_funcs
(
JEMALLOC_ALWAYS_INLINE
, , 
tsd_t
, 
tsd_š™Ÿliz”
, 
tsd_ş—nup
)

660 
JEMALLOC_ALWAYS_INLINE
 
tsd_t
 *

661 
	$tsd_ãtch
()

663 
tsd_t
 *
tsd
 = 
	`tsd_g‘
();

665 ià(
	`uÆik–y
(
tsd
->
¡©e
 !ğ
tsd_¡©e_nomš®
)) {

666 ià(
tsd
->
¡©e
 =ğ
tsd_¡©e_unš™Ÿlized
) {

667 
tsd
->
¡©e
 = 
tsd_¡©e_nomš®
;

669 
	`tsd_£t
(
tsd
);

670 } ià(
tsd
->
¡©e
 =ğ
tsd_¡©e_purg©Üy
) {

671 
tsd
->
¡©e
 = 
tsd_¡©e_»šÿº©ed
;

672 
	`tsd_£t
(
tsd
);

674 
	`as£¹
(
tsd
->
¡©e
 =ğ
tsd_¡©e_»šÿº©ed
);

677  (
tsd
);

678 
	}
}

680 
JEMALLOC_ALWAYS_INLINE
 
tsdn_t
 *

681 
	$tsd_tsdn
(
tsd_t
 *
tsd
)

684  ((
tsdn_t
 *)
tsd
);

685 
	}
}

687 
JEMALLOC_INLINE
 
boŞ


688 
	$tsd_nomš®
(
tsd_t
 *
tsd
)

691  (
tsd
->
¡©e
 =ğ
tsd_¡©e_nomš®
);

692 
	}
}

694 
	#O
(
n
, 
t
) \

695 
JEMALLOC_ALWAYS_INLINE
 
t
 * \

696 
tsd_
##
n
##
	`p_g‘
(
tsd_t
 *
tsd
) \

699  (&
tsd
->
n
); \

702 
JEMALLOC_ALWAYS_INLINE
 
t
 \

703 
tsd_
##
n
##
	`_g‘
(
tsd_t
 *
tsd
) \

706  (*
tsd_
##
n
##
	`p_g‘
(
tsd
)); \

709 
JEMALLOC_ALWAYS_INLINE
 \

710 
tsd_
##
n
##
	`_£t
(
tsd_t
 *
tsd
, 
t
‚) \

713 
	`as£¹
(
tsd
->
¡©e
 =ğ
tsd_¡©e_nomš®
); \

714 
tsd
->
n
 =‚; \

715 }

	)

716 
	gMALLOC_TSD


717 #undeà
O


719 
JEMALLOC_ALWAYS_INLINE
 
tsdn_t
 *

720 
	$tsdn_ãtch
()

723 ià(!
	`tsd_boÙed_g‘
())

724  (
NULL
);

726  (
	`tsd_tsdn
(
	`tsd_ãtch
()));

727 
	}
}

729 
JEMALLOC_ALWAYS_INLINE
 
boŞ


730 
	$tsdn_nuÎ
(cÚ¡ 
tsdn_t
 *
tsdn
)

733  (
tsdn
 =ğ
NULL
);

734 
	}
}

736 
JEMALLOC_ALWAYS_INLINE
 
tsd_t
 *

737 
	$tsdn_tsd
(
tsdn_t
 *
tsdn
)

740 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
));

742  (&
tsdn
->
tsd
);

743 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/util.h

2 #ifdeà
JEMALLOC_H_TYPES


4 #ifdeà
_WIN32


5 #ifdeà
_WIN64


6 
	#FMT64_PREFIX
 "Î"

	)

7 
	#FMTPTR_PREFIX
 "Î"

	)

9 
	#FMT64_PREFIX
 "Î"

	)

10 
	#FMTPTR_PREFIX
 ""

	)

12 
	#FMTd32
 "d"

	)

13 
	#FMTu32
 "u"

	)

14 
	#FMTx32
 "x"

	)

15 
	#FMTd64
 
FMT64_PREFIX
 "d"

	)

16 
	#FMTu64
 
FMT64_PREFIX
 "u"

	)

17 
	#FMTx64
 
FMT64_PREFIX
 "x"

	)

18 
	#FMTdPTR
 
FMTPTR_PREFIX
 "d"

	)

19 
	#FMTuPTR
 
FMTPTR_PREFIX
 "u"

	)

20 
	#FMTxPTR
 
FMTPTR_PREFIX
 "x"

	)

22 
	~<š‰y³s.h
>

23 
	#FMTd32
 
PRId32


	)

24 
	#FMTu32
 
PRIu32


	)

25 
	#FMTx32
 
PRIx32


	)

26 
	#FMTd64
 
PRId64


	)

27 
	#FMTu64
 
PRIu64


	)

28 
	#FMTx64
 
PRIx64


	)

29 
	#FMTdPTR
 
PRIdPTR


	)

30 
	#FMTuPTR
 
PRIuPTR


	)

31 
	#FMTxPTR
 
PRIxPTR


	)

35 
	#BUFERROR_BUF
 64

	)

41 
	#MALLOC_PRINTF_BUFSIZE
 4096

	)

44 
	#JEMALLOC_ALLOC_JUNK
 ((
ušt8_t
)0xa5)

	)

45 
	#JEMALLOC_FREE_JUNK
 ((
ušt8_t
)0x5a)

	)

51 
	#JEMALLOC_ARG_CONCAT
(...è
__VA_ARGS__


	)

58 #ifdeà
JEMALLOC_CC_SILENCE


59 
	#JEMALLOC_CC_SILENCE_INIT
(
v
èğ
	)
v

61 
	#JEMALLOC_CC_SILENCE_INIT
(
v
)

	)

64 
	#JEMALLOC_GNUC_PREREQ
(
majÜ
, 
mšÜ
) \

65 (!
	`defšed
(
__şªg__
) && \

66 (
__GNUC__
 > (
majÜ
è|| (__GNUC__ =ğ(majÜè&& 
__GNUC_MINOR__
 >ğ(
mšÜ
))))

	)

67 #iâdeà
__has_butš


68 
	#__has_butš
(
butš
è(0)

	)

70 
	#JEMALLOC_CLANG_HAS_BUILTIN
(
butš
) \

71 (
	`defšed
(
__şªg__
è&& 
	`__has_butš
(
butš
))

	)

73 #ifdeà
__GNUC__


74 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

75 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

76 #ià
JEMALLOC_GNUC_PREREQ
(4, 6) || \

77 
	$JEMALLOC_CLANG_HAS_BUILTIN
(
__butš_uÄ—chabË
)

78 
	#uÄ—chabË
(è
	`__butš_uÄ—chabË
()

	)

80 
	#uÄ—chabË
(è
	`abÜt
()

	)

83 
	#lik–y
(
x
è!!(x)

	)

84 
	#uÆik–y
(
x
è!!(x)

	)

85 
	#uÄ—chabË
(è
	`abÜt
()

	)

88 
	~"jem®loc/š‹º®/as£¹.h
"

91 
	#ÿs£¹
(
c
) do { \

92 ià(
	`uÆik–y
(!(
c
))) \

93 
	`nÙ_»ached
(); \

94 
	}
} 0)

	)

98 #ifdeà
JEMALLOC_H_STRUCTS


102 #ifdeà
JEMALLOC_H_EXTERNS


104 
buã¼Ü
(
”r
, *
buf
, 
size_t
 
buæ’
);

105 
uštmax_t
 
m®loc_¡¹oumax
(cÚ¡ *
»¡riù
 
ÅŒ
,

106 **
»¡riù
 
’d±r
, 
ba£
);

107 
m®loc_wr™e
(cÚ¡ *
s
);

113 
size_t
 
m®loc_v¢´štf
(*
¡r
, size_ˆ
size
, cÚ¡ *
fÜm©
,

114 
va_li¡
 
­
);

115 
size_t
 
	$m®loc_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, ...)

116 
	`JEMALLOC_FORMAT_PRINTF
(3, 4);

117 
	`m®loc_vırštf
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

118 cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

119 
	$m®loc_ırštf
((*
wr™e
)(*, cÚ¡ *), *
cbİaque
,

120 cÚ¡ *
fÜm©
, ...è
	`JEMALLOC_FORMAT_PRINTF
(3, 4);

121 
	$m®loc_´štf
(cÚ¡ *
fÜm©
, ...è
	`JEMALLOC_FORMAT_PRINTF
(1, 2);

125 #ifdeà
JEMALLOC_H_INLINES


127 #iâdeà
JEMALLOC_ENABLE_INLINE


128 
	`ffs_Îu
(
b™m­
);

129 
	`ffs_lu
(
b™m­
);

130 
	`ffs_u
(
b™m­
);

131 
	`ffs_zu
(
size_t
 
b™m­
);

132 
	`ffs_u64
(
ušt64_t
 
b™m­
);

133 
	`ffs_u32
(
ušt32_t
 
b™m­
);

134 
ušt64_t
 
	`pow2_û_u64
(ušt64_ˆ
x
);

135 
ušt32_t
 
	`pow2_û_u32
(ušt32_ˆ
x
);

136 
size_t
 
	`pow2_û_zu
(size_ˆ
x
);

137 
	`lg_æoÜ
(
size_t
 
x
);

138 
	`£t_”ºo
(
”ºum
);

139 
	`g‘_”ºo
();

142 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_UTIL_C_
))

145 #ià!
	`defšed
(
JEMALLOC_INTERNAL_FFSLL
è|| !defšed(
JEMALLOC_INTERNAL_FFSL
) \

146 || !
	$defšed
(
JEMALLOC_INTERNAL_FFS
)

147 #”rÜ 
JEMALLOC_INTERNAL_FFS
{,
L
,
LL
} should havb“Àdefšed by cÚfigu»

150 
JEMALLOC_ALWAYS_INLINE
 

151 
	$ffs_Îu
(
b™m­
)

154  (
	`JEMALLOC_INTERNAL_FFSLL
(
b™m­
));

155 
	}
}

157 
JEMALLOC_ALWAYS_INLINE
 

158 
	$ffs_lu
(
b™m­
)

161  (
	`JEMALLOC_INTERNAL_FFSL
(
b™m­
));

162 
	}
}

164 
JEMALLOC_ALWAYS_INLINE
 

165 
	$ffs_u
(
b™m­
)

168  (
	`JEMALLOC_INTERNAL_FFS
(
b™m­
));

169 
	}
}

171 
JEMALLOC_ALWAYS_INLINE
 

172 
	$ffs_zu
(
size_t
 
b™m­
)

175 #ià
LG_SIZEOF_PTR
 =ğ
LG_SIZEOF_INT


176  (
	`ffs_u
(
b™m­
));

177 #–ià
LG_SIZEOF_PTR
 =ğ
LG_SIZEOF_LONG


178  (
	`ffs_lu
(
b™m­
));

179 #–ià
LG_SIZEOF_PTR
 =ğ
LG_SIZEOF_LONG_LONG


180  (
	`ffs_Îu
(
b™m­
));

182 #”rÜ 
No
 
im¶em’tiÚ
 
size_t
 
	`ffs
()

184 
	}
}

186 
JEMALLOC_ALWAYS_INLINE
 

187 
	$ffs_u64
(
ušt64_t
 
b™m­
)

190 #ià
LG_SIZEOF_LONG
 == 3

191  (
	`ffs_lu
(
b™m­
));

192 #–ià
LG_SIZEOF_LONG_LONG
 == 3

193  (
	`ffs_Îu
(
b™m­
));

195 #”rÜ 
No
 
im¶em’tiÚ
 64-
b™
 
	`ffs
()

197 
	}
}

199 
JEMALLOC_ALWAYS_INLINE
 

200 
	$ffs_u32
(
ušt32_t
 
b™m­
)

203 #ià
LG_SIZEOF_INT
 == 2

204  (
	`ffs_u
(
b™m­
));

206 #”rÜ 
No
 
im¶em’tiÚ
 32-
b™
 
	`ffs
()

208  (
	`ffs_u
(
b™m­
));

209 
	}
}

211 
JEMALLOC_INLINE
 
ušt64_t


212 
	$pow2_û_u64
(
ušt64_t
 
x
)

215 
x
--;

216 
x
 |= x >> 1;

217 
x
 |= x >> 2;

218 
x
 |= x >> 4;

219 
x
 |= x >> 8;

220 
x
 |= x >> 16;

221 
x
 |= x >> 32;

222 
x
++;

223  (
x
);

224 
	}
}

226 
JEMALLOC_INLINE
 
ušt32_t


227 
	$pow2_û_u32
(
ušt32_t
 
x
)

230 
x
--;

231 
x
 |= x >> 1;

232 
x
 |= x >> 2;

233 
x
 |= x >> 4;

234 
x
 |= x >> 8;

235 
x
 |= x >> 16;

236 
x
++;

237  (
x
);

238 
	}
}

241 
JEMALLOC_INLINE
 
size_t


242 
	$pow2_û_zu
(
size_t
 
x
)

245 #ià(
LG_SIZEOF_PTR
 == 3)

246  (
	`pow2_û_u64
(
x
));

248  (
	`pow2_û_u32
(
x
));

250 
	}
}

252 #ià(
defšed
(
__i386__
è|| defšed(
__amd64__
è|| defšed(
__x86_64__
))

253 
JEMALLOC_INLINE
 

254 
	$lg_æoÜ
(
size_t
 
x
)

256 
size_t
 
»t
;

258 
	`as£¹
(
x
 != 0);

260 
	`asm
 ("bsr %1, %0"

261 : "ô"(
»t
)

262 : "r"(
x
)

264 
	`as£¹
(
»t
 < 
UINT_MAX
);

265  (()
»t
);

266 
	}
}

267 #–ià(
defšed
(
_MSC_VER
))

268 
JEMALLOC_INLINE
 

269 
	$lg_æoÜ
(
size_t
 
x
)

271 
»t
;

273 
	`as£¹
(
x
 != 0);

275 #ià(
LG_SIZEOF_PTR
 == 3)

276 
	`_B™SÿnRev”£64
(&
»t
, 
x
);

277 #–ià(
LG_SIZEOF_PTR
 == 2)

278 
	`_B™SÿnRev”£
(&
»t
, 
x
);

282 
	`as£¹
(
»t
 < 
UINT_MAX
);

283  (()
»t
);

284 
	}
}

285 #–ià(
defšed
(
JEMALLOC_HAVE_BUILTIN_CLZ
))

286 
JEMALLOC_INLINE
 

287 
	$lg_æoÜ
(
size_t
 
x
)

290 
	`as£¹
(
x
 != 0);

292 #ià(
LG_SIZEOF_PTR
 =ğ
LG_SIZEOF_INT
)

293  (((8 << 
LG_SIZEOF_PTR
è- 1è- 
	`__butš_şz
(
x
));

294 #–ià(
LG_SIZEOF_PTR
 =ğ
LG_SIZEOF_LONG
)

295  (((8 << 
LG_SIZEOF_PTR
è- 1è- 
	`__butš_şzl
(
x
));

299 
	}
}

301 
JEMALLOC_INLINE
 

302 
	$lg_æoÜ
(
size_t
 
x
)

305 
	`as£¹
(
x
 != 0);

307 
x
 |= (x >> 1);

308 
x
 |= (x >> 2);

309 
x
 |= (x >> 4);

310 
x
 |= (x >> 8);

311 
x
 |= (x >> 16);

312 #ià(
LG_SIZEOF_PTR
 == 3)

313 
x
 |= (x >> 32);

315 ià(
x
 =ğ
SIZE_T_MAX
)

316  ((8 << 
LG_SIZEOF_PTR
) - 1);

317 
x
++;

318  (
	`ffs_zu
(
x
) - 2);

319 
	}
}

323 
JEMALLOC_INLINE
 

324 
	$£t_”ºo
(
”ºum
)

327 #ifdeà
_WIN32


328 
	`S‘La¡E¼Ü
(
”ºum
);

330 
”ºo
 = 
”ºum
;

332 
	}
}

335 
JEMALLOC_INLINE
 

336 
	$g‘_”ºo
()

339 #ifdeà
_WIN32


340  (
	`G‘La¡E¼Ü
());

342  (
”ºo
);

344 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/internal/valgrind.h

2 #ifdeà
JEMALLOC_H_TYPES


4 #ifdeà
JEMALLOC_VALGRIND


5 
	~<v®gršd/v®gršd.h
>

16 
	#JEMALLOC_VALGRIND_MAKE_MEM_NOACCESS
(
±r
, 
usize
) do { \

17 ià(
	`uÆik–y
(
š_v®gršd
)) \

18 
	`v®gršd_make_mem_nßcûss
(
±r
, 
usize
); \

19 } 0)

	)

20 
	#JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
±r
, 
usize
) do { \

21 ià(
	`uÆik–y
(
š_v®gršd
)) \

22 
	`v®gršd_make_mem_undefšed
(
±r
, 
usize
); \

23 } 0)

	)

24 
	#JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
(
±r
, 
usize
) do { \

25 ià(
	`uÆik–y
(
š_v®gršd
)) \

26 
	`v®gršd_make_mem_defšed
(
±r
, 
usize
); \

27 } 0)

	)

33 
	#JEMALLOC_VALGRIND_MALLOC
(
cÚd
, 
tsdn
, 
±r
, 
usize
, 
z”o
) do { \

34 ià(
	`uÆik–y
(
š_v®gršd
 && 
cÚd
)) { \

35 
	`VALGRIND_MALLOCLIKE_BLOCK
(
±r
, 
usize
, 
	`p2rz
(
tsdn
,…tr), \

36 
z”o
); \

38 } 0)

	)

39 
	#JEMALLOC_VALGRIND_REALLOC
(
maybe_moved
, 
tsdn
, 
±r
, 
usize
, \

40 
±r_maybe_nuÎ
, 
Şd_±r
, 
Şd_usize
, 
Şd_rzsize
, 
Şd_±r_maybe_nuÎ
, \

41 
z”o
) do { \

42 ià(
	`uÆik–y
(
š_v®gršd
)) { \

43 
size_t
 
rzsize
 = 
	`p2rz
(
tsdn
, 
±r
); \

45 ià(!
maybe_moved
 || 
±r
 =ğ
Şd_±r
) { \

46 
	`VALGRIND_RESIZEINPLACE_BLOCK
(
±r
, 
Şd_usize
, \

47 
usize
, 
rzsize
); \

48 ià(
z”o
 && 
Şd_usize
 < 
usize
) { \

49 
	`v®gršd_make_mem_defšed
( \

50 (*)((
ušŒ_t
)
±r
 + \

51 
Şd_usize
), 
usize
 - old_usize); \

54 ià(!
Şd_±r_maybe_nuÎ
 || 
Şd_±r
 !ğ
NULL
) { \

55 
	`v®gršd_ä“like_block
(
Şd_±r
, \

56 
Şd_rzsize
); \

58 ià(!
±r_maybe_nuÎ
 || 
±r
 !ğ
NULL
) { \

59 
size_t
 
cİy_size
 = (
Şd_usize
 < 
usize
) \

60 ? 
Şd_usize
 : 
usize
; \

61 
size_t
 
_size
 = 
usize
 - 
cİy_size
; \

62 
	`VALGRIND_MALLOCLIKE_BLOCK
(
±r
, 
usize
, \

63 
rzsize
, 
çl£
); \

64 ià(
cİy_size
 > 0) { \

65 
	`v®gršd_make_mem_defšed
(
±r
, \

66 
cİy_size
); \

68 ià(
z”o
 && 
_size
 > 0) { \

69 
	`v®gršd_make_mem_defšed
( \

70 (*)((
ušŒ_t
)
±r
 + \

71 
cİy_size
), 
_size
); \

76 } 0)

	)

77 
	#JEMALLOC_VALGRIND_FREE
(
±r
, 
rzsize
) do { \

78 ià(
	`uÆik–y
(
š_v®gršd
)) \

79 
	`v®gršd_ä“like_block
(
±r
, 
rzsize
); \

80 } 0)

	)

82 
	#RUNNING_ON_VALGRIND
 (()0)

	)

83 
	#JEMALLOC_VALGRIND_MAKE_MEM_NOACCESS
(
±r
, 
usize
èdØ{} 0)

	)

84 
	#JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
±r
, 
usize
èdØ{} 0)

	)

85 
	#JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
(
±r
, 
usize
èdØ{} 0)

	)

86 
	#JEMALLOC_VALGRIND_MALLOC
(
cÚd
, 
tsdn
, 
±r
, 
usize
, 
z”o
èdØ{} 0)

	)

87 
	#JEMALLOC_VALGRIND_REALLOC
(
maybe_moved
, 
tsdn
, 
±r
, 
usize
, \

88 
±r_maybe_nuÎ
, 
Şd_±r
, 
Şd_usize
, 
Şd_rzsize
, 
Şd_±r_maybe_nuÎ
, \

89 
z”o
èdØ{} 0)

	)

90 
	#JEMALLOC_VALGRIND_FREE
(
±r
, 
rzsize
èdØ{} 0)

	)

95 #ifdeà
JEMALLOC_H_STRUCTS


99 #ifdeà
JEMALLOC_H_EXTERNS


101 #ifdeà
JEMALLOC_VALGRIND


102 
v®gršd_make_mem_nßcûss
(*
±r
, 
size_t
 
usize
);

103 
v®gršd_make_mem_undefšed
(*
±r
, 
size_t
 
usize
);

104 
v®gršd_make_mem_defšed
(*
±r
, 
size_t
 
usize
);

105 
v®gršd_ä“like_block
(*
±r
, 
size_t
 
usize
);

110 #ifdeà
JEMALLOC_H_INLINES


	@dep/jemalloc-4.2.0/include/jemalloc/internal/witness.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
w™Ãss_s
 
	tw™Ãss_t
;

5 
	tw™Ãss_¿nk_t
;

6 
	$ql_h—d
(
	tw™Ãss_t
è
	tw™Ãss_li¡_t
;

7 
	tw™Ãss_comp_t
 (cÚ¡ 
	tw™Ãss_t
 *, const witness_t *);

13 
	#WITNESS_RANK_OMIT
 0U

	)

15 
	#WITNESS_RANK_INIT
 1U

	)

16 
	#WITNESS_RANK_CTL
 1U

	)

17 
	#WITNESS_RANK_ARENAS
 2U

	)

19 
	#WITNESS_RANK_PROF_DUMP
 3U

	)

20 
	#WITNESS_RANK_PROF_BT2GCTX
 4U

	)

21 
	#WITNESS_RANK_PROF_TDATAS
 5U

	)

22 
	#WITNESS_RANK_PROF_TDATA
 6U

	)

23 
	#WITNESS_RANK_PROF_GCTX
 7U

	)

25 
	#WITNESS_RANK_ARENA
 8U

	)

26 
	#WITNESS_RANK_ARENA_CHUNKS
 9U

	)

27 
	#WITNESS_RANK_ARENA_NODE_CACHE
 10

	)

29 
	#WITNESS_RANK_BASE
 11U

	)

31 
	#WITNESS_RANK_LEAF
 0xffffffffU

	)

32 
	#WITNESS_RANK_ARENA_BIN
 
WITNESS_RANK_LEAF


	)

33 
	#WITNESS_RANK_ARENA_HUGE
 
WITNESS_RANK_LEAF


	)

34 
	#WITNESS_RANK_DSS
 
WITNESS_RANK_LEAF


	)

35 
	#WITNESS_RANK_PROF_ACTIVE
 
WITNESS_RANK_LEAF


	)

36 
	#WITNESS_RANK_PROF_DUMP_SEQ
 
WITNESS_RANK_LEAF


	)

37 
	#WITNESS_RANK_PROF_GDUMP
 
WITNESS_RANK_LEAF


	)

38 
	#WITNESS_RANK_PROF_NEXT_THR_UID
 
WITNESS_RANK_LEAF


	)

39 
	#WITNESS_RANK_PROF_THREAD_ACTIVE_INIT
 
WITNESS_RANK_LEAF


	)

41 
	#WITNESS_INITIALIZER
(
¿nk
è{"š™Ÿliz”",„ªk, 
NULL
, {NULL, NULL}
	}

	)
}

45 #ifdeà
JEMALLOC_H_STRUCTS


47 
	sw™Ãss_s
 {

49 cÚ¡ *
	mÇme
;

55 
w™Ãss_¿nk_t
 
	m¿nk
;

62 
w™Ãss_comp_t
 *
	mcomp
;

65 
ql_–m
(
w™Ãss_t
è
	mlšk
;

70 #ifdeà
JEMALLOC_H_EXTERNS


72 
w™Ãss_š™
(
w™Ãss_t
 *
w™Ãss
, cÚ¡ *
Çme
, 
w™Ãss_¿nk_t
 
¿nk
,

73 
w™Ãss_comp_t
 *
comp
);

74 #ifdeà
JEMALLOC_JET


75 (
	tw™Ãss_lock_”rÜ_t
)(cÚ¡ 
	tw™Ãss_li¡_t
 *, cÚ¡ 
	tw™Ãss_t
 *);

76 
w™Ãss_lock_”rÜ_t
 *
w™Ãss_lock_”rÜ
;

78 
	`w™Ãss_lock_”rÜ
(cÚ¡ 
w™Ãss_li¡_t
 *
w™Ãs£s
,

79 cÚ¡ 
w™Ãss_t
 *
w™Ãss
);

81 #ifdeà
JEMALLOC_JET


82 (
	tw™Ãss_owÃr_”rÜ_t
)(cÚ¡ 
	tw™Ãss_t
 *);

83 
w™Ãss_owÃr_”rÜ_t
 *
w™Ãss_owÃr_”rÜ
;

85 
	`w™Ãss_owÃr_”rÜ
(cÚ¡ 
w™Ãss_t
 *
w™Ãss
);

87 #ifdeà
JEMALLOC_JET


88 (
	tw™Ãss_nÙ_owÃr_”rÜ_t
)(cÚ¡ 
	tw™Ãss_t
 *);

89 
w™Ãss_nÙ_owÃr_”rÜ_t
 *
w™Ãss_nÙ_owÃr_”rÜ
;

91 
	`w™Ãss_nÙ_owÃr_”rÜ
(cÚ¡ 
w™Ãss_t
 *
w™Ãss
);

93 #ifdeà
JEMALLOC_JET


94 (
	tw™Ãss_lockËss_”rÜ_t
)(cÚ¡ 
	tw™Ãss_li¡_t
 *);

95 
w™Ãss_lockËss_”rÜ_t
 *
w™Ãss_lockËss_”rÜ
;

97 
	`w™Ãss_lockËss_”rÜ
(cÚ¡ 
w™Ãss_li¡_t
 *
w™Ãs£s
);

100 
	`w™Ãs£s_ş—nup
(
tsd_t
 *
tsd
);

101 
	`w™Ãss_fÜk_ş—nup
(
tsd_t
 *
tsd
);

102 
	`w™Ãss_´efÜk
(
tsd_t
 *
tsd
);

103 
	`w™Ãss_po¡fÜk_·»Á
(
tsd_t
 *
tsd
);

104 
	`w™Ãss_po¡fÜk_chd
(
tsd_t
 *
tsd
);

108 #ifdeà
JEMALLOC_H_INLINES


110 #iâdeà
JEMALLOC_ENABLE_INLINE


111 
	`w™Ãss_as£¹_owÃr
(
tsdn_t
 *
tsdn
, cÚ¡ 
w™Ãss_t
 *
w™Ãss
);

112 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn_t
 *
tsdn
, cÚ¡ 
w™Ãss_t
 *
w™Ãss
);

113 
	`w™Ãss_as£¹_lockËss
(
tsdn_t
 *
tsdn
);

114 
	`w™Ãss_lock
(
tsdn_t
 *
tsdn
, 
w™Ãss_t
 *
w™Ãss
);

115 
	`w™Ãss_uÆock
(
tsdn_t
 *
tsdn
, 
w™Ãss_t
 *
w™Ãss
);

118 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_MUTEX_C_
))

119 
JEMALLOC_INLINE
 

120 
	$w™Ãss_as£¹_owÃr
(
tsdn_t
 *
tsdn
, cÚ¡ 
w™Ãss_t
 *
w™Ãss
)

122 
tsd_t
 *
tsd
;

123 
w™Ãss_li¡_t
 *
w™Ãs£s
;

124 
w™Ãss_t
 *
w
;

126 ià(!
cÚfig_debug
)

129 ià(
	`tsdn_nuÎ
(
tsdn
))

131 
tsd
 = 
	`tsdn_tsd
(
tsdn
);

132 ià(
w™Ãss
->
¿nk
 =ğ
WITNESS_RANK_OMIT
)

135 
w™Ãs£s
 = 
	`tsd_w™Ãs£¥_g‘
(
tsd
);

136 
	`ql_fÜ—ch
(
w
, 
w™Ãs£s
, 
lšk
) {

137 ià(
w
 =ğ
w™Ãss
)

140 
	`w™Ãss_owÃr_”rÜ
(
w™Ãss
);

141 
	}
}

143 
JEMALLOC_INLINE
 

144 
	$w™Ãss_as£¹_nÙ_owÃr
(
tsdn_t
 *
tsdn
, cÚ¡ 
w™Ãss_t
 *
w™Ãss
)

146 
tsd_t
 *
tsd
;

147 
w™Ãss_li¡_t
 *
w™Ãs£s
;

148 
w™Ãss_t
 *
w
;

150 ià(!
cÚfig_debug
)

153 ià(
	`tsdn_nuÎ
(
tsdn
))

155 
tsd
 = 
	`tsdn_tsd
(
tsdn
);

156 ià(
w™Ãss
->
¿nk
 =ğ
WITNESS_RANK_OMIT
)

159 
w™Ãs£s
 = 
	`tsd_w™Ãs£¥_g‘
(
tsd
);

160 
	`ql_fÜ—ch
(
w
, 
w™Ãs£s
, 
lšk
) {

161 ià(
w
 =ğ
w™Ãss
)

162 
	`w™Ãss_nÙ_owÃr_”rÜ
(
w™Ãss
);

164 
	}
}

166 
JEMALLOC_INLINE
 

167 
	$w™Ãss_as£¹_lockËss
(
tsdn_t
 *
tsdn
)

169 
tsd_t
 *
tsd
;

170 
w™Ãss_li¡_t
 *
w™Ãs£s
;

171 
w™Ãss_t
 *
w
;

173 ià(!
cÚfig_debug
)

176 ià(
	`tsdn_nuÎ
(
tsdn
))

178 
tsd
 = 
	`tsdn_tsd
(
tsdn
);

180 
w™Ãs£s
 = 
	`tsd_w™Ãs£¥_g‘
(
tsd
);

181 
w
 = 
	`ql_Ï¡
(
w™Ãs£s
, 
lšk
);

182 ià(
w
 !ğ
NULL
)

183 
	`w™Ãss_lockËss_”rÜ
(
w™Ãs£s
);

184 
	}
}

186 
JEMALLOC_INLINE
 

187 
	$w™Ãss_lock
(
tsdn_t
 *
tsdn
, 
w™Ãss_t
 *
w™Ãss
)

189 
tsd_t
 *
tsd
;

190 
w™Ãss_li¡_t
 *
w™Ãs£s
;

191 
w™Ãss_t
 *
w
;

193 ià(!
cÚfig_debug
)

196 ià(
	`tsdn_nuÎ
(
tsdn
))

198 
tsd
 = 
	`tsdn_tsd
(
tsdn
);

199 ià(
w™Ãss
->
¿nk
 =ğ
WITNESS_RANK_OMIT
)

202 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn
, 
w™Ãss
);

204 
w™Ãs£s
 = 
	`tsd_w™Ãs£¥_g‘
(
tsd
);

205 
w
 = 
	`ql_Ï¡
(
w™Ãs£s
, 
lšk
);

206 ià(
w
 =ğ
NULL
) {

208 } ià(
	`tsd_w™Ãss_fÜk_g‘
(
tsd
è&& 
w
->
¿nk
 <ğ
w™Ãss
->rank) {

210 } ià(
w
->
¿nk
 > 
w™Ãss
->rank) {

212 
	`w™Ãss_lock_”rÜ
(
w™Ãs£s
, 
w™Ãss
);

213 } ià(
w
->
¿nk
 =ğ
w™Ãss
->¿nk && (w->
comp
 =ğ
NULL
 || w->comp !=

214 
w™Ãss
->
comp
 || 
w
->
	`comp
(w, witness) > 0)) {

219 
	`w™Ãss_lock_”rÜ
(
w™Ãs£s
, 
w™Ãss
);

222 
	`ql_–m_Ãw
(
w™Ãss
, 
lšk
);

223 
	`ql__š£¹
(
w™Ãs£s
, 
w™Ãss
, 
lšk
);

224 
	}
}

226 
JEMALLOC_INLINE
 

227 
	$w™Ãss_uÆock
(
tsdn_t
 *
tsdn
, 
w™Ãss_t
 *
w™Ãss
)

229 
tsd_t
 *
tsd
;

230 
w™Ãss_li¡_t
 *
w™Ãs£s
;

232 ià(!
cÚfig_debug
)

235 ià(
	`tsdn_nuÎ
(
tsdn
))

237 
tsd
 = 
	`tsdn_tsd
(
tsdn
);

238 ià(
w™Ãss
->
¿nk
 =ğ
WITNESS_RANK_OMIT
)

241 
	`w™Ãss_as£¹_owÃr
(
tsdn
, 
w™Ãss
);

243 
w™Ãs£s
 = 
	`tsd_w™Ãs£¥_g‘
(
tsd
);

244 
	`ql_»move
(
w™Ãs£s
, 
w™Ãss
, 
lšk
);

245 
	}
}

	@dep/jemalloc-4.2.0/include/jemalloc/jemalloc.h

1 #iâdeà
JEMALLOC_H_


2 
	#JEMALLOC_H_


	)

3 #ifdeà
__ılu¥lus


8 
	#JEMALLOC_HAVE_ATTR


	)

11 
	#JEMALLOC_HAVE_ATTR_ALLOC_SIZE


	)

14 
	#JEMALLOC_HAVE_ATTR_FORMAT_GNU_PRINTF


	)

17 
	#JEMALLOC_HAVE_ATTR_FORMAT_PRINTF


	)

23 
	#JEMALLOC_OVERRIDE_MEMALIGN


	)

24 
	#JEMALLOC_OVERRIDE_VALLOC


	)

33 
	#JEMALLOC_USABLE_SIZE_CONST


	)

40 
	#JEMALLOC_USE_CXX_THROW


	)

42 #ifdeà
_MSC_VER


43 #ifdeà
_WIN64


44 
	#LG_SIZEOF_PTR_WIN
 3

	)

46 
	#LG_SIZEOF_PTR_WIN
 2

	)

51 
	#LG_SIZEOF_PTR
 3

	)

58 #iâdeà
JEMALLOC_NO_RENAME


59 
	#je_m®loc_cÚf
 
je_m®loc_cÚf


	)

60 
	#je_m®loc_mes§ge
 
je_m®loc_mes§ge


	)

61 
	#je_m®loc
 
je_m®loc


	)

62 
	#je_ÿÎoc
 
je_ÿÎoc


	)

63 
	#je_posix_mem®ign
 
je_posix_mem®ign


	)

64 
	#je_®igÃd_®loc
 
je_®igÃd_®loc


	)

65 
	#je_»®loc
 
je_»®loc


	)

66 
	#je_ä“
 
je_ä“


	)

67 
	#je_m®locx
 
je_m®locx


	)

68 
	#je_¿Îocx
 
je_¿Îocx


	)

69 
	#je_x®locx
 
je_x®locx


	)

70 
	#je_§Îocx
 
je_§Îocx


	)

71 
	#je_d®locx
 
je_d®locx


	)

72 
	#je_sd®locx
 
je_sd®locx


	)

73 
	#je_ÇÎocx
 
je_ÇÎocx


	)

74 
	#je_m®lùl
 
je_m®lùl


	)

75 
	#je_m®lùÊam‘omib
 
je_m®lùÊam‘omib


	)

76 
	#je_m®lùlbymib
 
je_m®lùlbymib


	)

77 
	#je_m®loc_¡©s_´št
 
je_m®loc_¡©s_´št


	)

78 
	#je_m®loc_u§bË_size
 
je_m®loc_u§bË_size


	)

79 
	#je_mem®ign
 
je_mem®ign


	)

80 
	#je_v®loc
 
je_v®loc


	)

83 
	~<¡dlib.h
>

84 
	~<¡dboŞ.h
>

85 
	~<¡dšt.h
>

86 
	~<lim™s.h
>

87 
	~<¡ršgs.h
>

89 
	#JEMALLOC_VERSION
 "4.2.0-0-gf70a254d44c8d30af2cd5d30531fb18fdab¯e6d"

	)

90 
	#JEMALLOC_VERSION_MAJOR
 4

	)

91 
	#JEMALLOC_VERSION_MINOR
 2

	)

92 
	#JEMALLOC_VERSION_BUGFIX
 0

	)

93 
	#JEMALLOC_VERSION_NREV
 0

	)

94 
	#JEMALLOC_VERSION_GID
 "f70a254d44c8d30af2cd5d30531fb18fdab¯e6d"

	)

96 
	#MALLOCX_LG_ALIGN
(
Ï
è(()Öa))

	)

97 #ià
LG_SIZEOF_PTR
 == 2

98 
	#MALLOCX_ALIGN
(
a
è(()(
	`ffs
(()×))-1))

	)

100 
	#MALLOCX_ALIGN
(
a
) \

101 (()(((
size_t
)(
a
è< (size_t)
INT_MAX
è? 
	`ffs
(()(a))-1 : \

102 
	`ffs
(()(((
size_t
)(
a
))>>32))+31))

	)

104 
	#MALLOCX_ZERO
 (()0x40)

	)

109 
	#MALLOCX_TCACHE
(
tc
è(()((Ñc)+2è<< 8))

	)

110 
	#MALLOCX_TCACHE_NONE
 
	`MALLOCX_TCACHE
(-1)

	)

114 
	#MALLOCX_ARENA
(
a
è(((()×))+1è<< 20)

	)

116 #ià
defšed
(
__ılu¥lus
è&& defšed(
JEMALLOC_USE_CXX_THROW
)

117 
	#JEMALLOC_CXX_THROW
 
	`throw
()

	)

119 
	#JEMALLOC_CXX_THROW


	)

122 #ià
_MSC_VER


123 
	#JEMALLOC_ATTR
(
s
)

	)

124 
	#JEMALLOC_ALIGNED
(
s
è
	`__deş¥ec
(
	`®ign
(s))

	)

125 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

126 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

127 #iâdeà
JEMALLOC_EXPORT


128 #ifdeà
DLLEXPORT


129 
	#JEMALLOC_EXPORT
 
	`__deş¥ec
(
dÎexpÜt
)

	)

131 
	#JEMALLOC_EXPORT
 
	`__deş¥ec
(
dÎimpÜt
)

	)

134 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

135 
	#JEMALLOC_NOINLINE
 
	`__deş¥ec
(
nošlše
)

	)

136 #ifdeà
__ılu¥lus


137 
	#JEMALLOC_NOTHROW
 
	`__deş¥ec
(
nÙhrow
)

	)

139 
	#JEMALLOC_NOTHROW


	)

141 
	#JEMALLOC_SECTION
(
s
è
	`__deş¥ec
(
	`®loÿ‹
(s))

	)

142 
	#JEMALLOC_RESTRICT_RETURN
 
	`__deş¥ec
(
»¡riù
)

	)

143 #ià
_MSC_VER
 >ğ1900 && !
defšed
(
__EDG__
)

144 
	#JEMALLOC_ALLOCATOR
 
	`__deş¥ec
(
®loÿtÜ
)

	)

146 
	#JEMALLOC_ALLOCATOR


	)

148 #–ià
defšed
(
JEMALLOC_HAVE_ATTR
)

149 
	#JEMALLOC_ATTR
(
s
è
	`__©Œibu‹__
((s))

	)

150 
	#JEMALLOC_ALIGNED
(
s
è
	`JEMALLOC_ATTR
(
	`®igÃd
(s))

	)

151 #ifdeà
JEMALLOC_HAVE_ATTR_ALLOC_SIZE


152 
	#JEMALLOC_ALLOC_SIZE
(
s
è
	`JEMALLOC_ATTR
(
	`®loc_size
(s))

	)

153 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
è
	`JEMALLOC_ATTR
(
	`®loc_size
(s1, s2))

	)

155 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

156 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

158 #iâdeà
JEMALLOC_EXPORT


159 
	#JEMALLOC_EXPORT
 
	`JEMALLOC_ATTR
(
	`visib™y
("deçuÉ"))

	)

161 #ifdeà
JEMALLOC_HAVE_ATTR_FORMAT_GNU_PRINTF


162 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
è
	`JEMALLOC_ATTR
(
	`fÜm©
(
gnu_´štf
, s, i))

	)

163 #–ià
defšed
(
JEMALLOC_HAVE_ATTR_FORMAT_PRINTF
)

164 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
è
	`JEMALLOC_ATTR
(
	`fÜm©
(
´štf
, s, i))

	)

166 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

168 
	#JEMALLOC_NOINLINE
 
	`JEMALLOC_ATTR
(
nošlše
)

	)

169 
	#JEMALLOC_NOTHROW
 
	`JEMALLOC_ATTR
(
nÙhrow
)

	)

170 
	#JEMALLOC_SECTION
(
s
è
	`JEMALLOC_ATTR
(
	`£ùiÚ
(s))

	)

171 
	#JEMALLOC_RESTRICT_RETURN


	)

172 
	#JEMALLOC_ALLOCATOR


	)

174 
	#JEMALLOC_ATTR
(
s
)

	)

175 
	#JEMALLOC_ALIGNED
(
s
)

	)

176 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

177 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

178 
	#JEMALLOC_EXPORT


	)

179 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

180 
	#JEMALLOC_NOINLINE


	)

181 
	#JEMALLOC_NOTHROW


	)

182 
	#JEMALLOC_SECTION
(
s
)

	)

183 
	#JEMALLOC_RESTRICT_RETURN


	)

184 
	#JEMALLOC_ALLOCATOR


	)

192 
JEMALLOC_EXPORT
 cÚ¡ *
je_m®loc_cÚf
;

193 
JEMALLOC_EXPORT
 (*
je_m®loc_mes§ge
)(*
cbİaque
,

194 cÚ¡ *
s
);

196 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


197 
JEMALLOC_NOTHROW
 *
je_m®loc
(
size_t
 
size
)

198 
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
m®loc
è
JEMALLOC_ALLOC_SIZE
(1);

199 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


200 
JEMALLOC_NOTHROW
 *
je_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

201 
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
m®loc
è
JEMALLOC_ALLOC_SIZE2
(1, 2);

202 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_posix_mem®ign
(**
mem±r
,

203 
size_t
 
®ignm’t
, size_ˆ
size
è
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
nÚnuÎ
(1));

204 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


205 
JEMALLOC_NOTHROW
 *
je_®igÃd_®loc
(
size_t
 
®ignm’t
,

206 
size_t
 
size
è
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
m®loc
)

207 
JEMALLOC_ALLOC_SIZE
(2);

208 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


209 
JEMALLOC_NOTHROW
 *
je_»®loc
(*
±r
, 
size_t
 
size
)

210 
JEMALLOC_CXX_THROW
 
JEMALLOC_ALLOC_SIZE
(2);

211 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_ä“
(*
±r
)

212 
	gJEMALLOC_CXX_THROW
;

214 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


215 
JEMALLOC_NOTHROW
 *
je_m®locx
(
size_t
 
size
, 
æags
)

216 
JEMALLOC_ATTR
(
m®loc
è
JEMALLOC_ALLOC_SIZE
(1);

217 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


218 
JEMALLOC_NOTHROW
 *
je_¿Îocx
(*
±r
, 
size_t
 
size
,

219 
æags
è
JEMALLOC_ALLOC_SIZE
(2);

220 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
je_x®locx
(*
±r
, size_ˆ
size
,

221 
size_t
 
exŒa
, 
æags
);

222 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
je_§Îocx
(cÚ¡ *
±r
,

223 
æags
è
JEMALLOC_ATTR
(
pu»
);

224 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_d®locx
(*
±r
, 
æags
);

225 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_sd®locx
(*
±r
, 
size_t
 
size
,

226 
æags
);

227 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
je_ÇÎocx
(size_ˆ
size
, 
æags
)

228 
JEMALLOC_ATTR
(
pu»
);

230 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_m®lùl
(cÚ¡ *
Çme
,

231 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

232 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_m®lùÊam‘omib
(cÚ¡ *
Çme
,

233 
size_t
 *
mibp
, size_ˆ*
mibËÅ
);

234 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_m®lùlbymib
(cÚ¡ 
size_t
 *
mib
,

235 
size_t
 
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

236 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_m®loc_¡©s_´št
(

237 (*
wr™e_cb
)(*, cÚ¡ *), *
je_cbİaque
,

238 cÚ¡ *
İts
);

239 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
je_m®loc_u§bË_size
(

240 
JEMALLOC_USABLE_SIZE_CONST
 *
±r
è
	gJEMALLOC_CXX_THROW
;

242 #ifdeà
JEMALLOC_OVERRIDE_MEMALIGN


243 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


244 
JEMALLOC_NOTHROW
 *
je_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
)

245 
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
m®loc
);

248 #ifdeà
JEMALLOC_OVERRIDE_VALLOC


249 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


250 
JEMALLOC_NOTHROW
 *
je_v®loc
(
size_t
 
size
è
JEMALLOC_CXX_THROW


251 
JEMALLOC_ATTR
(
m®loc
);

259 *(
	tchunk_®loc_t
)(*, 
	tsize_t
, size_t, 
	tboŞ
 *, bool *, );

265 
boŞ
 (
	tchunk_d®loc_t
)(*, 
	tsize_t
, 
	tboŞ
, );

272 
boŞ
 (
	tchunk_comm™_t
)(*, 
	tsize_t
, size_t, size_t, );

279 
boŞ
 (
	tchunk_decomm™_t
)(*, 
	tsize_t
, size_t, size_t, );

286 
boŞ
 (
	tchunk_purge_t
)(*, 
	tsize_t
, size_t, size_t, );

293 
boŞ
 (
	tchunk_¥l™_t
)(*, 
	tsize_t
, size_t, size_t, 
	tboŞ
, );

300 
boŞ
 (
	tchunk_m”ge_t
)(*, 
	tsize_t
, *, size_t, 
	tboŞ
, );

303 
chunk_®loc_t
 *
	g®loc
;

304 
chunk_d®loc_t
 *
	gd®loc
;

305 
chunk_comm™_t
 *
	gcomm™
;

306 
chunk_decomm™_t
 *
	gdecomm™
;

307 
chunk_purge_t
 *
	gpurge
;

308 
chunk_¥l™_t
 *
	g¥l™
;

309 
chunk_m”ge_t
 *
	gm”ge
;

310 } 
	tchunk_hooks_t
;

319 #ifdeà
JEMALLOC_MANGLE


320 #iâdeà
JEMALLOC_NO_DEMANGLE


321 
	#JEMALLOC_NO_DEMANGLE


	)

323 
	#m®loc_cÚf
 
je_m®loc_cÚf


	)

324 
	#m®loc_mes§ge
 
je_m®loc_mes§ge


	)

325 
	#m®loc
 
je_m®loc


	)

326 
	#ÿÎoc
 
je_ÿÎoc


	)

327 
	#posix_mem®ign
 
je_posix_mem®ign


	)

328 
	#®igÃd_®loc
 
je_®igÃd_®loc


	)

329 
	#»®loc
 
je_»®loc


	)

330 
	#ä“
 
je_ä“


	)

331 
	#m®locx
 
je_m®locx


	)

332 
	#¿Îocx
 
je_¿Îocx


	)

333 
	#x®locx
 
je_x®locx


	)

334 
	#§Îocx
 
je_§Îocx


	)

335 
	#d®locx
 
je_d®locx


	)

336 
	#sd®locx
 
je_sd®locx


	)

337 
	#ÇÎocx
 
je_ÇÎocx


	)

338 
	#m®lùl
 
je_m®lùl


	)

339 
	#m®lùÊam‘omib
 
je_m®lùÊam‘omib


	)

340 
	#m®lùlbymib
 
je_m®lùlbymib


	)

341 
	#m®loc_¡©s_´št
 
je_m®loc_¡©s_´št


	)

342 
	#m®loc_u§bË_size
 
je_m®loc_u§bË_size


	)

343 
	#mem®ign
 
je_mem®ign


	)

344 
	#v®loc
 
je_v®loc


	)

354 #iâdeà
JEMALLOC_NO_DEMANGLE


355 #undeà
je_m®loc_cÚf


356 #undeà
je_m®loc_mes§ge


357 #undeà
je_m®loc


358 #undeà
je_ÿÎoc


359 #undeà
je_posix_mem®ign


360 #undeà
je_®igÃd_®loc


361 #undeà
je_»®loc


362 #undeà
je_ä“


363 #undeà
je_m®locx


364 #undeà
je_¿Îocx


365 #undeà
je_x®locx


366 #undeà
je_§Îocx


367 #undeà
je_d®locx


368 #undeà
je_sd®locx


369 #undeà
je_ÇÎocx


370 #undeà
je_m®lùl


371 #undeà
je_m®lùÊam‘omib


372 #undeà
je_m®lùlbymib


373 #undeà
je_m®loc_¡©s_´št


374 #undeà
je_m®loc_u§bË_size


375 #undeà
je_mem®ign


376 #undeà
je_v®loc


379 #ifdeà
__ılu¥lus


	@dep/jemalloc-4.2.0/include/jemalloc/jemalloc_defs.h

3 
	#JEMALLOC_HAVE_ATTR


	)

6 
	#JEMALLOC_HAVE_ATTR_ALLOC_SIZE


	)

9 
	#JEMALLOC_HAVE_ATTR_FORMAT_GNU_PRINTF


	)

12 
	#JEMALLOC_HAVE_ATTR_FORMAT_PRINTF


	)

18 
	#JEMALLOC_OVERRIDE_MEMALIGN


	)

19 
	#JEMALLOC_OVERRIDE_VALLOC


	)

28 
	#JEMALLOC_USABLE_SIZE_CONST


	)

35 
	#JEMALLOC_USE_CXX_THROW


	)

37 #ifdeà
_MSC_VER


38 #ifdeà
_WIN64


39 
	#LG_SIZEOF_PTR_WIN
 3

	)

41 
	#LG_SIZEOF_PTR_WIN
 2

	)

46 
	#LG_SIZEOF_PTR
 3

	)

	@dep/jemalloc-4.2.0/include/jemalloc/jemalloc_macros.h

1 
	~<¡dlib.h
>

2 
	~<¡dboŞ.h
>

3 
	~<¡dšt.h
>

4 
	~<lim™s.h
>

5 
	~<¡ršgs.h
>

7 
	#JEMALLOC_VERSION
 "4.2.0-0-gf70a254d44c8d30af2cd5d30531fb18fdab¯e6d"

	)

8 
	#JEMALLOC_VERSION_MAJOR
 4

	)

9 
	#JEMALLOC_VERSION_MINOR
 2

	)

10 
	#JEMALLOC_VERSION_BUGFIX
 0

	)

11 
	#JEMALLOC_VERSION_NREV
 0

	)

12 
	#JEMALLOC_VERSION_GID
 "f70a254d44c8d30af2cd5d30531fb18fdab¯e6d"

	)

14 
	#MALLOCX_LG_ALIGN
(
Ï
è(()Öa))

	)

15 #ià
LG_SIZEOF_PTR
 == 2

16 
	#MALLOCX_ALIGN
(
a
è(()(
	`ffs
(()×))-1))

	)

18 
	#MALLOCX_ALIGN
(
a
) \

19 (()(((
size_t
)(
a
è< (size_t)
INT_MAX
è? 
	`ffs
(()(a))-1 : \

20 
	`ffs
(()(((
size_t
)(
a
))>>32))+31))

	)

22 
	#MALLOCX_ZERO
 (()0x40)

	)

27 
	#MALLOCX_TCACHE
(
tc
è(()((Ñc)+2è<< 8))

	)

28 
	#MALLOCX_TCACHE_NONE
 
	`MALLOCX_TCACHE
(-1)

	)

32 
	#MALLOCX_ARENA
(
a
è(((()×))+1è<< 20)

	)

34 #ià
defšed
(
__ılu¥lus
è&& defšed(
JEMALLOC_USE_CXX_THROW
)

35 
	#JEMALLOC_CXX_THROW
 
	`throw
()

	)

37 
	#JEMALLOC_CXX_THROW


	)

40 #ià
_MSC_VER


41 
	#JEMALLOC_ATTR
(
s
)

	)

42 
	#JEMALLOC_ALIGNED
(
s
è
	`__deş¥ec
(
	`®ign
(s))

	)

43 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

44 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

45 #iâdeà
JEMALLOC_EXPORT


46 #ifdeà
DLLEXPORT


47 
	#JEMALLOC_EXPORT
 
	`__deş¥ec
(
dÎexpÜt
)

	)

49 
	#JEMALLOC_EXPORT
 
	`__deş¥ec
(
dÎimpÜt
)

	)

52 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

53 
	#JEMALLOC_NOINLINE
 
	`__deş¥ec
(
nošlše
)

	)

54 #ifdeà
__ılu¥lus


55 
	#JEMALLOC_NOTHROW
 
	`__deş¥ec
(
nÙhrow
)

	)

57 
	#JEMALLOC_NOTHROW


	)

59 
	#JEMALLOC_SECTION
(
s
è
	`__deş¥ec
(
	`®loÿ‹
(s))

	)

60 
	#JEMALLOC_RESTRICT_RETURN
 
	`__deş¥ec
(
»¡riù
)

	)

61 #ià
_MSC_VER
 >ğ1900 && !
defšed
(
__EDG__
)

62 
	#JEMALLOC_ALLOCATOR
 
	`__deş¥ec
(
®loÿtÜ
)

	)

64 
	#JEMALLOC_ALLOCATOR


	)

66 #–ià
defšed
(
JEMALLOC_HAVE_ATTR
)

67 
	#JEMALLOC_ATTR
(
s
è
	`__©Œibu‹__
((s))

	)

68 
	#JEMALLOC_ALIGNED
(
s
è
	`JEMALLOC_ATTR
(
	`®igÃd
(s))

	)

69 #ifdeà
JEMALLOC_HAVE_ATTR_ALLOC_SIZE


70 
	#JEMALLOC_ALLOC_SIZE
(
s
è
	`JEMALLOC_ATTR
(
	`®loc_size
(s))

	)

71 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
è
	`JEMALLOC_ATTR
(
	`®loc_size
(s1, s2))

	)

73 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

74 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

76 #iâdeà
JEMALLOC_EXPORT


77 
	#JEMALLOC_EXPORT
 
	`JEMALLOC_ATTR
(
	`visib™y
("deçuÉ"))

	)

79 #ifdeà
JEMALLOC_HAVE_ATTR_FORMAT_GNU_PRINTF


80 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
è
	`JEMALLOC_ATTR
(
	`fÜm©
(
gnu_´štf
, s, i))

	)

81 #–ià
defšed
(
JEMALLOC_HAVE_ATTR_FORMAT_PRINTF
)

82 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
è
	`JEMALLOC_ATTR
(
	`fÜm©
(
´štf
, s, i))

	)

84 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

86 
	#JEMALLOC_NOINLINE
 
	`JEMALLOC_ATTR
(
nošlše
)

	)

87 
	#JEMALLOC_NOTHROW
 
	`JEMALLOC_ATTR
(
nÙhrow
)

	)

88 
	#JEMALLOC_SECTION
(
s
è
	`JEMALLOC_ATTR
(
	`£ùiÚ
(s))

	)

89 
	#JEMALLOC_RESTRICT_RETURN


	)

90 
	#JEMALLOC_ALLOCATOR


	)

92 
	#JEMALLOC_ATTR
(
s
)

	)

93 
	#JEMALLOC_ALIGNED
(
s
)

	)

94 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

95 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

96 
	#JEMALLOC_EXPORT


	)

97 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

98 
	#JEMALLOC_NOINLINE


	)

99 
	#JEMALLOC_NOTHROW


	)

100 
	#JEMALLOC_SECTION
(
s
)

	)

101 
	#JEMALLOC_RESTRICT_RETURN


	)

102 
	#JEMALLOC_ALLOCATOR


	)

	@dep/jemalloc-4.2.0/include/jemalloc/jemalloc_mangle.h

8 #ifdeà
JEMALLOC_MANGLE


9 #iâdeà
JEMALLOC_NO_DEMANGLE


10 
	#JEMALLOC_NO_DEMANGLE


	)

12 
	#m®loc_cÚf
 
je_m®loc_cÚf


	)

13 
	#m®loc_mes§ge
 
je_m®loc_mes§ge


	)

14 
	#m®loc
 
je_m®loc


	)

15 
	#ÿÎoc
 
je_ÿÎoc


	)

16 
	#posix_mem®ign
 
je_posix_mem®ign


	)

17 
	#®igÃd_®loc
 
je_®igÃd_®loc


	)

18 
	#»®loc
 
je_»®loc


	)

19 
	#ä“
 
je_ä“


	)

20 
	#m®locx
 
je_m®locx


	)

21 
	#¿Îocx
 
je_¿Îocx


	)

22 
	#x®locx
 
je_x®locx


	)

23 
	#§Îocx
 
je_§Îocx


	)

24 
	#d®locx
 
je_d®locx


	)

25 
	#sd®locx
 
je_sd®locx


	)

26 
	#ÇÎocx
 
je_ÇÎocx


	)

27 
	#m®lùl
 
je_m®lùl


	)

28 
	#m®lùÊam‘omib
 
je_m®lùÊam‘omib


	)

29 
	#m®lùlbymib
 
je_m®lùlbymib


	)

30 
	#m®loc_¡©s_´št
 
je_m®loc_¡©s_´št


	)

31 
	#m®loc_u§bË_size
 
je_m®loc_u§bË_size


	)

32 
	#mem®ign
 
je_mem®ign


	)

33 
	#v®loc
 
je_v®loc


	)

43 #iâdeà
JEMALLOC_NO_DEMANGLE


44 #undeà
je_m®loc_cÚf


45 #undeà
je_m®loc_mes§ge


46 #undeà
je_m®loc


47 #undeà
je_ÿÎoc


48 #undeà
je_posix_mem®ign


49 #undeà
je_®igÃd_®loc


50 #undeà
je_»®loc


51 #undeà
je_ä“


52 #undeà
je_m®locx


53 #undeà
je_¿Îocx


54 #undeà
je_x®locx


55 #undeà
je_§Îocx


56 #undeà
je_d®locx


57 #undeà
je_sd®locx


58 #undeà
je_ÇÎocx


59 #undeà
je_m®lùl


60 #undeà
je_m®lùÊam‘omib


61 #undeà
je_m®lùlbymib


62 #undeà
je_m®loc_¡©s_´št


63 #undeà
je_m®loc_u§bË_size


64 #undeà
je_mem®ign


65 #undeà
je_v®loc


	@dep/jemalloc-4.2.0/include/jemalloc/jemalloc_mangle_jet.h

8 #ifdeà
JEMALLOC_MANGLE


9 #iâdeà
JEMALLOC_NO_DEMANGLE


10 
	#JEMALLOC_NO_DEMANGLE


	)

12 
	#m®loc_cÚf
 
j‘_m®loc_cÚf


	)

13 
	#m®loc_mes§ge
 
j‘_m®loc_mes§ge


	)

14 
	#m®loc
 
j‘_m®loc


	)

15 
	#ÿÎoc
 
j‘_ÿÎoc


	)

16 
	#posix_mem®ign
 
j‘_posix_mem®ign


	)

17 
	#®igÃd_®loc
 
j‘_®igÃd_®loc


	)

18 
	#»®loc
 
j‘_»®loc


	)

19 
	#ä“
 
j‘_ä“


	)

20 
	#m®locx
 
j‘_m®locx


	)

21 
	#¿Îocx
 
j‘_¿Îocx


	)

22 
	#x®locx
 
j‘_x®locx


	)

23 
	#§Îocx
 
j‘_§Îocx


	)

24 
	#d®locx
 
j‘_d®locx


	)

25 
	#sd®locx
 
j‘_sd®locx


	)

26 
	#ÇÎocx
 
j‘_ÇÎocx


	)

27 
	#m®lùl
 
j‘_m®lùl


	)

28 
	#m®lùÊam‘omib
 
j‘_m®lùÊam‘omib


	)

29 
	#m®lùlbymib
 
j‘_m®lùlbymib


	)

30 
	#m®loc_¡©s_´št
 
j‘_m®loc_¡©s_´št


	)

31 
	#m®loc_u§bË_size
 
j‘_m®loc_u§bË_size


	)

32 
	#mem®ign
 
j‘_mem®ign


	)

33 
	#v®loc
 
j‘_v®loc


	)

43 #iâdeà
JEMALLOC_NO_DEMANGLE


44 #undeà
j‘_m®loc_cÚf


45 #undeà
j‘_m®loc_mes§ge


46 #undeà
j‘_m®loc


47 #undeà
j‘_ÿÎoc


48 #undeà
j‘_posix_mem®ign


49 #undeà
j‘_®igÃd_®loc


50 #undeà
j‘_»®loc


51 #undeà
j‘_ä“


52 #undeà
j‘_m®locx


53 #undeà
j‘_¿Îocx


54 #undeà
j‘_x®locx


55 #undeà
j‘_§Îocx


56 #undeà
j‘_d®locx


57 #undeà
j‘_sd®locx


58 #undeà
j‘_ÇÎocx


59 #undeà
j‘_m®lùl


60 #undeà
j‘_m®lùÊam‘omib


61 #undeà
j‘_m®lùlbymib


62 #undeà
j‘_m®loc_¡©s_´št


63 #undeà
j‘_m®loc_u§bË_size


64 #undeà
j‘_mem®ign


65 #undeà
j‘_v®loc


	@dep/jemalloc-4.2.0/include/jemalloc/jemalloc_protos.h

6 
JEMALLOC_EXPORT
 cÚ¡ *
je_m®loc_cÚf
;

7 
JEMALLOC_EXPORT
 (*
je_m®loc_mes§ge
)(*
cbİaque
,

8 cÚ¡ *
s
);

10 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


11 
JEMALLOC_NOTHROW
 *
	$je_m®loc
(
size_t
 
size
)

12 
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE
(1);

13 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


14 
JEMALLOC_NOTHROW
 *
	$je_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

15 
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE2
(1, 2);

16 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	$je_posix_mem®ign
(**
mem±r
,

17 
size_t
 
®ignm’t
, size_ˆ
size
è
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ATTR
(
	`nÚnuÎ
(1));

18 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


19 
JEMALLOC_NOTHROW
 *
	$je_®igÃd_®loc
(
size_t
 
®ignm’t
,

20 
size_t
 
size
è
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
)

21 
	`JEMALLOC_ALLOC_SIZE
(2);

22 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


23 
JEMALLOC_NOTHROW
 *
	$je_»®loc
(*
±r
, 
size_t
 
size
)

24 
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ALLOC_SIZE
(2);

25 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	$je_ä“
(*
±r
)

26 
JEMALLOC_CXX_THROW
;

28 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


29 
JEMALLOC_NOTHROW
 *
	$je_m®locx
(
size_t
 
size
, 
æags
)

30 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE
(1);

31 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


32 
JEMALLOC_NOTHROW
 *
	$je_¿Îocx
(*
±r
, 
size_t
 
size
,

33 
æags
è
	`JEMALLOC_ALLOC_SIZE
(2);

34 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	`je_x®locx
(*
±r
, size_ˆ
size
,

35 
size_t
 
exŒa
, 
æags
);

36 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$je_§Îocx
(cÚ¡ *
±r
,

37 
æags
è
	`JEMALLOC_ATTR
(
pu»
);

38 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_d®locx
(*
±r
, 
æags
);

39 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_sd®locx
(*
±r
, 
size_t
 
size
,

40 
æags
);

41 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$je_ÇÎocx
(
size_t
 
size
, 
æags
)

42 
	`JEMALLOC_ATTR
(
pu»
);

44 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_m®lùl
(cÚ¡ *
Çme
,

45 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

46 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_m®lùÊam‘omib
(cÚ¡ *
Çme
,

47 
size_t
 *
mibp
, size_ˆ*
mibËÅ
);

48 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_m®lùlbymib
(cÚ¡ 
size_t
 *
mib
,

49 
size_t
 
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

50 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_m®loc_¡©s_´št
(

51 (*
wr™e_cb
)(*, cÚ¡ *), *
je_cbİaque
,

52 cÚ¡ *
İts
);

53 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$je_m®loc_u§bË_size
(

54 
JEMALLOC_USABLE_SIZE_CONST
 *
±r
è
JEMALLOC_CXX_THROW
;

56 #ifdeà
JEMALLOC_OVERRIDE_MEMALIGN


57 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


58 
JEMALLOC_NOTHROW
 *
	$je_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
)

59 
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ATTR
(
m®loc
);

62 #ifdeà
JEMALLOC_OVERRIDE_VALLOC


63 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


64 
JEMALLOC_NOTHROW
 *
	$je_v®loc
(
size_t
 
size
è
JEMALLOC_CXX_THROW


65 
	`JEMALLOC_ATTR
(
m®loc
);

	@dep/jemalloc-4.2.0/include/jemalloc/jemalloc_protos_jet.h

6 
JEMALLOC_EXPORT
 cÚ¡ *
j‘_m®loc_cÚf
;

7 
JEMALLOC_EXPORT
 (*
j‘_m®loc_mes§ge
)(*
cbİaque
,

8 cÚ¡ *
s
);

10 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


11 
JEMALLOC_NOTHROW
 *
	$j‘_m®loc
(
size_t
 
size
)

12 
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE
(1);

13 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


14 
JEMALLOC_NOTHROW
 *
	$j‘_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

15 
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE2
(1, 2);

16 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	$j‘_posix_mem®ign
(**
mem±r
,

17 
size_t
 
®ignm’t
, size_ˆ
size
è
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ATTR
(
	`nÚnuÎ
(1));

18 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


19 
JEMALLOC_NOTHROW
 *
	$j‘_®igÃd_®loc
(
size_t
 
®ignm’t
,

20 
size_t
 
size
è
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
)

21 
	`JEMALLOC_ALLOC_SIZE
(2);

22 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


23 
JEMALLOC_NOTHROW
 *
	$j‘_»®loc
(*
±r
, 
size_t
 
size
)

24 
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ALLOC_SIZE
(2);

25 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	$j‘_ä“
(*
±r
)

26 
JEMALLOC_CXX_THROW
;

28 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


29 
JEMALLOC_NOTHROW
 *
	$j‘_m®locx
(
size_t
 
size
, 
æags
)

30 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE
(1);

31 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


32 
JEMALLOC_NOTHROW
 *
	$j‘_¿Îocx
(*
±r
, 
size_t
 
size
,

33 
æags
è
	`JEMALLOC_ALLOC_SIZE
(2);

34 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	`j‘_x®locx
(*
±r
, size_ˆ
size
,

35 
size_t
 
exŒa
, 
æags
);

36 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$j‘_§Îocx
(cÚ¡ *
±r
,

37 
æags
è
	`JEMALLOC_ATTR
(
pu»
);

38 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_d®locx
(*
±r
, 
æags
);

39 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_sd®locx
(*
±r
, 
size_t
 
size
,

40 
æags
);

41 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$j‘_ÇÎocx
(
size_t
 
size
, 
æags
)

42 
	`JEMALLOC_ATTR
(
pu»
);

44 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_m®lùl
(cÚ¡ *
Çme
,

45 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

46 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_m®lùÊam‘omib
(cÚ¡ *
Çme
,

47 
size_t
 *
mibp
, size_ˆ*
mibËÅ
);

48 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_m®lùlbymib
(cÚ¡ 
size_t
 *
mib
,

49 
size_t
 
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

50 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_m®loc_¡©s_´št
(

51 (*
wr™e_cb
)(*, cÚ¡ *), *
j‘_cbİaque
,

52 cÚ¡ *
İts
);

53 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$j‘_m®loc_u§bË_size
(

54 
JEMALLOC_USABLE_SIZE_CONST
 *
±r
è
JEMALLOC_CXX_THROW
;

56 #ifdeà
JEMALLOC_OVERRIDE_MEMALIGN


57 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


58 
JEMALLOC_NOTHROW
 *
	$j‘_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
)

59 
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ATTR
(
m®loc
);

62 #ifdeà
JEMALLOC_OVERRIDE_VALLOC


63 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


64 
JEMALLOC_NOTHROW
 *
	$j‘_v®loc
(
size_t
 
size
è
JEMALLOC_CXX_THROW


65 
	`JEMALLOC_ATTR
(
m®loc
);

	@dep/jemalloc-4.2.0/include/jemalloc/jemalloc_rename.h

6 #iâdeà
JEMALLOC_NO_RENAME


7 
	#je_m®loc_cÚf
 
je_m®loc_cÚf


	)

8 
	#je_m®loc_mes§ge
 
je_m®loc_mes§ge


	)

9 
	#je_m®loc
 
je_m®loc


	)

10 
	#je_ÿÎoc
 
je_ÿÎoc


	)

11 
	#je_posix_mem®ign
 
je_posix_mem®ign


	)

12 
	#je_®igÃd_®loc
 
je_®igÃd_®loc


	)

13 
	#je_»®loc
 
je_»®loc


	)

14 
	#je_ä“
 
je_ä“


	)

15 
	#je_m®locx
 
je_m®locx


	)

16 
	#je_¿Îocx
 
je_¿Îocx


	)

17 
	#je_x®locx
 
je_x®locx


	)

18 
	#je_§Îocx
 
je_§Îocx


	)

19 
	#je_d®locx
 
je_d®locx


	)

20 
	#je_sd®locx
 
je_sd®locx


	)

21 
	#je_ÇÎocx
 
je_ÇÎocx


	)

22 
	#je_m®lùl
 
je_m®lùl


	)

23 
	#je_m®lùÊam‘omib
 
je_m®lùÊam‘omib


	)

24 
	#je_m®lùlbymib
 
je_m®lùlbymib


	)

25 
	#je_m®loc_¡©s_´št
 
je_m®loc_¡©s_´št


	)

26 
	#je_m®loc_u§bË_size
 
je_m®loc_u§bË_size


	)

27 
	#je_mem®ign
 
je_mem®ign


	)

28 
	#je_v®loc
 
je_v®loc


	)

	@dep/jemalloc-4.2.0/include/jemalloc/jemalloc_typedefs.h

6 *(
	tchunk_®loc_t
)(*, 
	tsize_t
, size_t, 
	tboŞ
 *, bool *, );

12 
	$boŞ
 (
	tchunk_d®loc_t
)(*, 
	tsize_t
, 
	tboŞ
, );

19 
	$boŞ
 (
	tchunk_comm™_t
)(*, 
	tsize_t
, size_t, size_t, );

26 
	$boŞ
 (
	tchunk_decomm™_t
)(*, 
	tsize_t
, size_t, size_t, );

33 
	$boŞ
 (
	tchunk_purge_t
)(*, 
	tsize_t
, size_t, size_t, );

40 
	$boŞ
 (
	tchunk_¥l™_t
)(*, 
	tsize_t
, size_t, size_t, 
	tboŞ
, );

47 
	$boŞ
 (
	tchunk_m”ge_t
)(*, 
	tsize_t
, *, size_t, 
	tboŞ
, );

50 
chunk_®loc_t
 *
®loc
;

51 
chunk_d®loc_t
 *
d®loc
;

52 
chunk_comm™_t
 *
comm™
;

53 
chunk_decomm™_t
 *
decomm™
;

54 
chunk_purge_t
 *
purge
;

55 
chunk_¥l™_t
 *
¥l™
;

56 
chunk_m”ge_t
 *
m”ge
;

57 } 
	tchunk_hooks_t
;

	@dep/jemalloc-4.2.0/include/msvc_compat/C99/stdbool.h

1 #iâdeà
¡dboŞ_h


2 
	#¡dboŞ_h


	)

4 
	~<wty³s.h
>

10 #iâdeà
__şªg__


11 
BOOL
 
	t_BoŞ
;

14 
	#boŞ
 
_BoŞ


	)

15 
	#Œue
 1

	)

16 
	#çl£
 0

	)

18 
	#__boŞ_Œue_çl£_¬e_defšed
 1

	)

	@dep/jemalloc-4.2.0/include/msvc_compat/C99/stdint.h

32 #iâdeà
_MSC_VER


36 #iâdeà
_MSC_STDINT_H_


37 
	#_MSC_STDINT_H_


	)

39 #ià
_MSC_VER
 > 1000

40 #´agm¨
Úû


43 
	~<lim™s.h
>

49 #ifdeà
__ılu¥lus


52 
	~<wch¬.h
>

53 #ifdeà
__ılu¥lus


58 #iâdeà
_W64


59 #ià!
defšed
(
__midl
è&& (defšed(
_X86_
è|| defšed(
_M_IX86
)è&& 
_MSC_VER
 >= 1300

60 
	#_W64
 
__w64


	)

62 
	#_W64


	)

74 #ià(
_MSC_VER
 < 1300)

75 sigÃd 
	tšt8_t
;

76 sigÃd 
	tšt16_t
;

77 sigÃd 
	tšt32_t
;

78 
	tušt8_t
;

79 
	tušt16_t
;

80 
	tušt32_t
;

82 sigÃd 
	t__št8
 
	tšt8_t
;

83 sigÃd 
	t__št16
 
	tšt16_t
;

84 sigÃd 
	t__št32
 
	tšt32_t
;

85 
	t__št8
 
	tušt8_t
;

86 
	t__št16
 
	tušt16_t
;

87 
	t__št32
 
	tušt32_t
;

89 sigÃd 
	t__št64
 
	tšt64_t
;

90 
	t__št64
 
	tušt64_t
;

94 
št8_t
 
	tšt_Ëa¡8_t
;

95 
št16_t
 
	tšt_Ëa¡16_t
;

96 
št32_t
 
	tšt_Ëa¡32_t
;

97 
št64_t
 
	tšt_Ëa¡64_t
;

98 
ušt8_t
 
	tušt_Ëa¡8_t
;

99 
ušt16_t
 
	tušt_Ëa¡16_t
;

100 
ušt32_t
 
	tušt_Ëa¡32_t
;

101 
ušt64_t
 
	tušt_Ëa¡64_t
;

104 
št8_t
 
	tšt_ç¡8_t
;

105 
št16_t
 
	tšt_ç¡16_t
;

106 
št32_t
 
	tšt_ç¡32_t
;

107 
št64_t
 
	tšt_ç¡64_t
;

108 
ušt8_t
 
	tušt_ç¡8_t
;

109 
ušt16_t
 
	tušt_ç¡16_t
;

110 
ušt32_t
 
	tušt_ç¡32_t
;

111 
ušt64_t
 
	tušt_ç¡64_t
;

114 #ifdeà
_WIN64


115 sigÃd 
	t__št64
 
	tšŒ_t
;

116 
	t__št64
 
	tušŒ_t
;

118 
_W64
 sigÃd 
	tšŒ_t
;

119 
_W64
 
	tušŒ_t
;

123 
št64_t
 
	tštmax_t
;

124 
ušt64_t
 
	tuštmax_t
;

129 #ià!
defšed
(
__ılu¥lus
è|| defšed(
__STDC_LIMIT_MACROS
)

132 
	#INT8_MIN
 ((
št8_t
)
_I8_MIN
)

	)

133 
	#INT8_MAX
 
_I8_MAX


	)

134 
	#INT16_MIN
 ((
št16_t
)
_I16_MIN
)

	)

135 
	#INT16_MAX
 
_I16_MAX


	)

136 
	#INT32_MIN
 ((
št32_t
)
_I32_MIN
)

	)

137 
	#INT32_MAX
 
_I32_MAX


	)

138 
	#INT64_MIN
 ((
št64_t
)
_I64_MIN
)

	)

139 
	#INT64_MAX
 
_I64_MAX


	)

140 
	#UINT8_MAX
 
_UI8_MAX


	)

141 
	#UINT16_MAX
 
_UI16_MAX


	)

142 
	#UINT32_MAX
 
_UI32_MAX


	)

143 
	#UINT64_MAX
 
_UI64_MAX


	)

146 
	#INT_LEAST8_MIN
 
INT8_MIN


	)

147 
	#INT_LEAST8_MAX
 
INT8_MAX


	)

148 
	#INT_LEAST16_MIN
 
INT16_MIN


	)

149 
	#INT_LEAST16_MAX
 
INT16_MAX


	)

150 
	#INT_LEAST32_MIN
 
INT32_MIN


	)

151 
	#INT_LEAST32_MAX
 
INT32_MAX


	)

152 
	#INT_LEAST64_MIN
 
INT64_MIN


	)

153 
	#INT_LEAST64_MAX
 
INT64_MAX


	)

154 
	#UINT_LEAST8_MAX
 
UINT8_MAX


	)

155 
	#UINT_LEAST16_MAX
 
UINT16_MAX


	)

156 
	#UINT_LEAST32_MAX
 
UINT32_MAX


	)

157 
	#UINT_LEAST64_MAX
 
UINT64_MAX


	)

160 
	#INT_FAST8_MIN
 
INT8_MIN


	)

161 
	#INT_FAST8_MAX
 
INT8_MAX


	)

162 
	#INT_FAST16_MIN
 
INT16_MIN


	)

163 
	#INT_FAST16_MAX
 
INT16_MAX


	)

164 
	#INT_FAST32_MIN
 
INT32_MIN


	)

165 
	#INT_FAST32_MAX
 
INT32_MAX


	)

166 
	#INT_FAST64_MIN
 
INT64_MIN


	)

167 
	#INT_FAST64_MAX
 
INT64_MAX


	)

168 
	#UINT_FAST8_MAX
 
UINT8_MAX


	)

169 
	#UINT_FAST16_MAX
 
UINT16_MAX


	)

170 
	#UINT_FAST32_MAX
 
UINT32_MAX


	)

171 
	#UINT_FAST64_MAX
 
UINT64_MAX


	)

174 #ifdeà
_WIN64


175 
	#INTPTR_MIN
 
INT64_MIN


	)

176 
	#INTPTR_MAX
 
INT64_MAX


	)

177 
	#UINTPTR_MAX
 
UINT64_MAX


	)

179 
	#INTPTR_MIN
 
INT32_MIN


	)

180 
	#INTPTR_MAX
 
INT32_MAX


	)

181 
	#UINTPTR_MAX
 
UINT32_MAX


	)

185 
	#INTMAX_MIN
 
INT64_MIN


	)

186 
	#INTMAX_MAX
 
INT64_MAX


	)

187 
	#UINTMAX_MAX
 
UINT64_MAX


	)

191 #ifdeà
_WIN64


192 
	#PTRDIFF_MIN
 
_I64_MIN


	)

193 
	#PTRDIFF_MAX
 
_I64_MAX


	)

195 
	#PTRDIFF_MIN
 
_I32_MIN


	)

196 
	#PTRDIFF_MAX
 
_I32_MAX


	)

199 
	#SIG_ATOMIC_MIN
 
INT_MIN


	)

200 
	#SIG_ATOMIC_MAX
 
INT_MAX


	)

202 #iâdeà
SIZE_MAX


203 #ifdeà
_WIN64


204 
	#SIZE_MAX
 
_UI64_MAX


	)

206 
	#SIZE_MAX
 
_UI32_MAX


	)

211 #iâdeà
WCHAR_MIN


212 
	#WCHAR_MIN
 0

	)

214 #iâdeà
WCHAR_MAX


215 
	#WCHAR_MAX
 
_UI16_MAX


	)

218 
	#WINT_MIN
 0

	)

219 
	#WINT_MAX
 
_UI16_MAX


	)

226 #ià!
defšed
(
__ılu¥lus
è|| defšed(
__STDC_CONSTANT_MACROS
)

230 
	#INT8_C
(
v®
èv®##
i8


	)

231 
	#INT16_C
(
v®
èv®##
i16


	)

232 
	#INT32_C
(
v®
èv®##
i32


	)

233 
	#INT64_C
(
v®
èv®##
i64


	)

235 
	#UINT8_C
(
v®
èv®##
ui8


	)

236 
	#UINT16_C
(
v®
èv®##
ui16


	)

237 
	#UINT32_C
(
v®
èv®##
ui32


	)

238 
	#UINT64_C
(
v®
èv®##
ui64


	)

241 
	#INTMAX_C
 
INT64_C


	)

242 
	#UINTMAX_C
 
UINT64_C


	)

	@dep/jemalloc-4.2.0/include/msvc_compat/strings.h

1 #iâdeà
¡ršgs_h


2 
	#¡ršgs_h


	)

6 #ifdeà
_MSC_VER


7 
	~<šŒš.h
>

8 #´agm¨
šŒšsic
(
_B™SÿnFÜw¬d
)

9 
__fÜûšlše
 
	$ff¦
(
x
)

11 
i
;

13 ià(
	`_B™SÿnFÜw¬d
(&
i
, 
x
))

14  (
i
 + 1);

16 
	}
}

18 
__fÜûšlše
 
	$ffs
(
x
)

21  (
	`ff¦
(
x
));

22 
	}
}

24 #ifdeà 
_M_X64


25 #´agm¨
šŒšsic
(
_B™SÿnFÜw¬d64
)

28 
__fÜûšlše
 
	$ff¦l
(
__št64
 
x
)

30 
i
;

31 #ifdeà 
_M_X64


32 ià(
	`_B™SÿnFÜw¬d64
(&
i
, 
x
))

33  (
i
 + 1);

39 
__št64
 
Î
;

40 
l
[2];

41 } 
s
;

43 
s
.
Î
 = 
x
;

45 ià(
	`_B™SÿnFÜw¬d
(&
i
, 
s
.
l
[0]))

46  (
i
 + 1);

47 if(
	`_B™SÿnFÜw¬d
(&
i
, 
s
.
l
[1]))

48  (
i
 + 33);

51 
	}
}

54 
	#ff¦l
(
x
è
	`__butš_ff¦l
(x)

	)

55 
	#ff¦
(
x
è
	`__butš_ff¦
(x)

	)

56 
	#ffs
(
x
è
	`__butš_ffs
(x)

	)

	@dep/jemalloc-4.2.0/include/msvc_compat/windows_extra.h

1 #iâdeà
MSVC_COMPAT_WINDOWS_EXTRA_H


2 
	#MSVC_COMPAT_WINDOWS_EXTRA_H


	)

4 
	~<”ºo.h
>

	@dep/jemalloc-4.2.0/msvc/projects/vc2015/test_threads/test_threads.cpp

5 
	~<©omic
>

6 
	~<funùiÚ®
>

7 
	~<futu»
>

8 
	~<¿ndom
>

9 
	~<th»ad
>

10 
	~<veùÜ
>

11 
	~<¡dio.h
>

12 
	~<jem®loc/jem®loc.h
>

14 
usšg
 
	g¡d
::
veùÜ
;

15 
usšg
 
	g¡d
::
th»ad
;

16 
usšg
 
	g¡d
::
unifÜm_št_di¡ributiÚ
;

17 
usšg
 
	g¡d
::
mš¡d_¿nd
;

19 
	$‹¡_th»ads
()

21 
je_m®loc_cÚf
 = "narenas:3";

22 
Ç»Çs
 = 0;

23 
size_t
 
sz
 = (
Ç»Çs
);

24 
	`je_m®lùl
("İt.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0);

25 ià(
Ç»Çs
 != 3) {

26 
	`´štf
("E¼Ü: uÃx³ùed‚umb” oà¬’as: %d\n", 
Ç»Çs
);

29 cÚ¡ 
sizes
[] = { 7, 16, 32, 60, 91, 100, 120, 144, 169, 199, 255, 400, 670, 900, 917, 1025, 3333, 5190, 13131, 49192, 99999, 123123, 255265, 2333111 };

30 cÚ¡ 
numSizes
 = ()((
sizes
) / (sizes[0]));

31 
veùÜ
<
th»ad
> 
wÜk”s
;

32 cÚ¡ 
numTh»ads
 = 
Ç»Çs
 + 1, 
numAÎocsMax
 = 25, 
numI‹r1
 = 50, 
numI‹r2
 = 50;

33 
	`je_m®loc_¡©s_´št
(
NULL
, NULL, NULL);

34 
size_t
 
®loÿ‹d1
;

35 
size_t
 
sz1
 = (
®loÿ‹d1
);

36 
	`je_m®lùl
("¡©s.aùive", &
®loÿ‹d1
, &
sz1
, 
NULL
, 0);

37 
	`´štf
("\nPress Entero starthreads...\n");

38 
	`g‘ch¬
();

39 
	`´štf
("S¹šg %dh»ad x %d x %d i‹¿tiÚs...\n", 
numTh»ads
, 
numI‹r1
, 
numI‹r2
);

40 
i
 = 0; i < 
numTh»ads
; i++) {

41 
wÜk”s
.
	`em¶aû_back
([
tid
=
i
]() {

42 
unifÜm_št_di¡ributiÚ
<> 
	`sizeDi¡
(0, 
numSizes
 - 1);

43 
mš¡d_¿nd
 
	`ºd
(
tid
 * 17);

44 
ušt8_t
* 
±rs
[
numAÎocsMax
];

45 
±rsz
[
numAÎocsMax
];

46 
i
 = 0; i < 
numI‹r1
; ++i) {

47 
th»ad
 
	`t
([&]() {

48 
i
 = 0; i < 
numI‹r2
; ++i) {

49 cÚ¡ 
numAÎocs
 = 
numAÎocsMax
 - 
	`sizeDi¡
(
ºd
);

50 
j
 = 0; j < 
numAÎocs
; j += 64) {

51 cÚ¡ 
x
 = 
	`sizeDi¡
(
ºd
);

52 cÚ¡ 
sz
 = 
sizes
[
x
];

53 
±rsz
[
j
] = 
sz
;

54 
±rs
[
j
] = (
ušt8_t
*)
	`je_m®loc
(
sz
);

55 ià(!
±rs
[
j
]) {

56 
	`´štf
("UÇbËØ®loÿ‹ %d by‹ šh»ad %d, i‹¸%d,‡Îoø%d. %d\n", 
sz
, 
tid
, 
i
, 
j
, 
x
);

57 
	`ex™
(1);

59 
k
 = 0; k < 
sz
; k++)

60 
±rs
[
j
][
k
] = 
tid
 + k;

62 
j
 = 0; j < 
numAÎocs
; j += 64) {

63 
k
 = 0, 
sz
 = 
±rsz
[
j
]; k < sz; k++)

64 ià(
±rs
[
j
][
k
] !ğ(
ušt8_t
)(
tid
 + k)) {

65 
	`´štf
("MemÜyƒ¼Ü iÀth»ad %d, i‹¸%d,‡Îoø%d @ %d : %02X!=%02X\n", 
tid
, 
i
, 
j
, 
k
, 
±rs
[j][k], (
ušt8_t
)(tid + k));

66 
	`ex™
(1);

68 
	`je_ä“
(
±rs
[
j
]);

72 
t
.
	`još
();

76 
th»ad
& 
t
 : 
wÜk”s
) {

77 
t
.
	`još
();

79 
	`je_m®loc_¡©s_´št
(
NULL
, NULL, NULL);

80 
size_t
 
®loÿ‹d2
;

81 
	`je_m®lùl
("¡©s.aùive", &
®loÿ‹d2
, &
sz1
, 
NULL
, 0);

82 
size_t
 
Ëaked
 = 
®loÿ‹d2
 - 
®loÿ‹d1
;

83 
	`´štf
("\nDÚe. L—ked: %zd by‹s\n", 
Ëaked
);

84 
boŞ
 
çed
 = 
Ëaked
 > 65536;

85 
	`´štf
("\nTe¡ %s!\n", (
çed
 ? "FAILED" : "successful"));

86 
	`´štf
("\nPress Entero continue...\n");

87 
	`g‘ch¬
();

88  
çed
 ? 1 : 0;

89 
	}
}

	@dep/jemalloc-4.2.0/msvc/projects/vc2015/test_threads/test_threads.h

1 #´agm¨
Úû


3 
‹¡_th»ads
();

	@dep/jemalloc-4.2.0/msvc/projects/vc2015/test_threads/test_threads_main.cpp

1 
	~"‹¡_th»ads.h
"

2 
	~<futu»
>

3 
	~<funùiÚ®
>

4 
	~<chrÚo
>

6 
usšg
 
Çme¥aû
 
	g¡d
::
chrÚo_l™”®s
;

8 
	$maš
(
¬gc
, ** 
¬gv
)

10 
rc
 = 
	`‹¡_th»ads
();

11  
rc
;

12 
	}
}

	@dep/jemalloc-4.2.0/src/arena.c

1 
	#JEMALLOC_ARENA_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
purge_mode_t
 
	gİt_purge
 = 
PURGE_DEFAULT
;

8 cÚ¡ *
	gpurge_mode_Çmes
[] = {

13 
ssize_t
 
	gİt_lg_dœty_muÉ
 = 
LG_DIRTY_MULT_DEFAULT
;

14 
ssize_t
 
	glg_dœty_muÉ_deçuÉ
;

15 
ssize_t
 
	gİt_deÿy_time
 = 
DECAY_TIME_DEFAULT
;

16 
ssize_t
 
	gdeÿy_time_deçuÉ
;

18 
¬’a_bš_šfo_t
 
	g¬’a_bš_šfo
[
NBINS
];

20 
size_t
 
	gm­_bŸs
;

21 
size_t
 
	gm­_misc_off£t
;

22 
size_t
 
	g¬’a_maxrun
;

23 
size_t
 
	gÏrge_maxşass
;

24 
size_t
 
	grun_quªtize_max
;

25 
size_t
 
	gsm®l_maxrun
;

26 
boŞ
 *
	gsm®l_run_b
;

27 
size_t
 *
	grun_quªtize_æoÜ_b
;

28 
size_t
 *
	grun_quªtize_û_b
;

29 
	gÆşas£s
;

30 
	gnhşas£s
;

31 
szšd_t
 
	gruns_ava_bŸs
;

32 
szšd_t
 
	gruns_ava_nşas£s
;

40 
¬’a_purge_to_lim™
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

41 
size_t
 
ndœty_lim™
);

42 
¬’a_run_d®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
,

43 
boŞ
 
dœty
, boŞ 
ş—Ãd
, boŞ 
decomm™‹d
);

44 
¬’a_d®loc_bš_run
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

45 
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
, 
¬’a_bš_t
 *
bš
);

46 
¬’a_bš_low”_run
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

47 
¬’a_run_t
 *
run
, 
¬’a_bš_t
 *
bš
);

51 
JEMALLOC_INLINE_C
 
size_t


52 
	$¬’a_misûlm_size_g‘
(cÚ¡ 
¬’a_chunk_m­_misc_t
 *
misûlm
)

54 
¬’a_chunk_t
 *
chunk
;

55 
size_t
 
·gešd
, 
m­b™s
;

57 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
misûlm
);

58 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

59 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

60  (
	`¬’a_m­b™s_size_decode
(
m­b™s
));

61 
	}
}

63 
JEMALLOC_INLINE_C
 

64 
	$¬’a_run_addr_comp
(cÚ¡ 
¬’a_chunk_m­_misc_t
 *
a
,

65 cÚ¡ 
¬’a_chunk_m­_misc_t
 *
b
)

67 
ušŒ_t
 
a_misûlm
 = (ušŒ_t)
a
;

68 
ušŒ_t
 
b_misûlm
 = (ušŒ_t)
b
;

70 
	`as£¹
(
a
 !ğ
NULL
);

71 
	`as£¹
(
b
 !ğ
NULL
);

73  ((
a_misûlm
 > 
b_misûlm
) - (a_miscelm < b_miscelm));

74 
	}
}

77 
	$ph_g’
(
UNUSED
, 
¬’a_run_h—p_
, 
¬’a_run_h—p_t
, 
¬’a_chunk_m­_misc_t
,

78 
ph_lšk
, 
¬’a_run_addr_comp
)

80 
size_t


81 
	$run_quªtize_æoÜ_compu‹
(
size_t
 
size
)

83 
size_t
 
qsize
;

85 
	`as£¹
(
size
 != 0);

86 
	`as£¹
(
size
 =ğ
	`PAGE_CEILING
(size));

89 ià(
size
 <ğ
sm®l_maxrun
 && 
sm®l_run_b
[siz>> 
LG_PAGE
])

90  (
size
);

97 
qsize
 = 
	`šdex2size
(
	`size2šdex
(
size
 - 
Ïrge_·d
 + 1) - 1) +†arge_pad;

98 ià(
qsize
 <ğ
SMALL_MAXCLASS
 + 
Ïrge_·d
)

99  (
	`run_quªtize_æoÜ_compu‹
(
size
 - 
Ïrge_·d
));

100 
	`as£¹
(
qsize
 <ğ
size
);

101  (
qsize
);

102 
	}
}

104 
size_t


105 
	$run_quªtize_û_compu‹_h¬d
(
size_t
 
size
)

107 
size_t
 
Ïrge_run_size_Ãxt
;

109 
	`as£¹
(
size
 != 0);

110 
	`as£¹
(
size
 =ğ
	`PAGE_CEILING
(size));

119 ià(
size
 > 
SMALL_MAXCLASS
) {

120 
Ïrge_run_size_Ãxt
 = 
	`PAGE_CEILING
(
	`šdex2size
(
	`size2šdex
(
size
 -

121 
Ïrge_·d
) + 1) +†arge_pad);

123 
Ïrge_run_size_Ãxt
 = 
SIZE_T_MAX
;

124 ià(
size
 >ğ
sm®l_maxrun
)

125  (
Ïrge_run_size_Ãxt
);

127 
Œue
) {

128 
size
 +ğ
PAGE
;

129 
	`as£¹
(
size
 <ğ
sm®l_maxrun
);

130 ià(
sm®l_run_b
[
size
 >> 
LG_PAGE
]) {

131 ià(
Ïrge_run_size_Ãxt
 < 
size
)

132  (
Ïrge_run_size_Ãxt
);

133  (
size
);

136 
	}
}

138 
size_t


139 
	$run_quªtize_û_compu‹
(
size_t
 
size
)

141 
size_t
 
qsize
 = 
	`run_quªtize_æoÜ_compu‹
(
size
);

143 ià(
qsize
 < 
size
) {

152 
qsize
 = 
	`run_quªtize_û_compu‹_h¬d
(qsize);

154  (
qsize
);

155 
	}
}

157 #ifdeà
JEMALLOC_JET


158 #undeà
run_quªtize_æoÜ


159 
	#run_quªtize_æoÜ
 
	`JEMALLOC_N
(
n_run_quªtize_æoÜ
)

	)

161 
size_t


162 
	$run_quªtize_æoÜ
(
size_t
 
size
)

164 
size_t
 
»t
;

166 
	`as£¹
(
size
 > 0);

167 
	`as£¹
(
size
 <ğ
run_quªtize_max
);

168 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

170 
»t
 = 
run_quªtize_æoÜ_b
[(
size
 >> 
LG_PAGE
) - 1];

171 
	`as£¹
(
»t
 =ğ
	`run_quªtize_æoÜ_compu‹
(
size
));

172  (
»t
);

173 
	}
}

174 #ifdeà
JEMALLOC_JET


175 #undeà
run_quªtize_æoÜ


176 
	#run_quªtize_æoÜ
 
	`JEMALLOC_N
(
run_quªtize_æoÜ
)

	)

177 
run_quªtize_t
 *
	grun_quªtize_æoÜ
 = 
JEMALLOC_N
(
n_run_quªtize_æoÜ
);

180 #ifdeà
JEMALLOC_JET


181 #undeà
run_quªtize_û


182 
	#run_quªtize_û
 
	`JEMALLOC_N
(
n_run_quªtize_û
)

	)

184 
size_t


185 
	$run_quªtize_û
(
size_t
 
size
)

187 
size_t
 
»t
;

189 
	`as£¹
(
size
 > 0);

190 
	`as£¹
(
size
 <ğ
run_quªtize_max
);

191 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

193 
»t
 = 
run_quªtize_û_b
[(
size
 >> 
LG_PAGE
) - 1];

194 
	`as£¹
(
»t
 =ğ
	`run_quªtize_û_compu‹
(
size
));

195  (
»t
);

196 
	}
}

197 #ifdeà
JEMALLOC_JET


198 #undeà
run_quªtize_û


199 
	#run_quªtize_û
 
	`JEMALLOC_N
(
run_quªtize_û
)

	)

200 
run_quªtize_t
 *
	grun_quªtize_û
 = 
JEMALLOC_N
(
n_run_quªtize_û
);

203 
¬’a_run_h—p_t
 *

204 
	$¬’a_runs_ava_g‘
(
¬’a_t
 *
¬’a
, 
szšd_t
 
šd
)

207 
	`as£¹
(
šd
 >ğ
runs_ava_bŸs
);

208 
	`as£¹
(
šd
 - 
runs_ava_bŸs
 < 
runs_ava_nşas£s
);

210  (&
¬’a
->
runs_ava
[
šd
 - 
runs_ava_bŸs
]);

211 
	}
}

214 
	$¬’a_ava_š£¹
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

215 
size_t
 
Åages
)

217 
szšd_t
 
šd
 = 
	`size2šdex
(
	`run_quªtize_æoÜ
(
	`¬’a_misûlm_size_g‘
(

218 
	`¬’a_misûlm_g‘_cÚ¡
(
chunk
, 
·gešd
))));

219 
	`as£¹
(
Åages
 =ğ(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
) >>

220 
LG_PAGE
));

221 
	`¬’a_run_h—p_š£¹
(
	`¬’a_runs_ava_g‘
(
¬’a
, 
šd
),

222 
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
·gešd
));

223 
	}
}

226 
	$¬’a_ava_»move
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

227 
size_t
 
Åages
)

229 
szšd_t
 
šd
 = 
	`size2šdex
(
	`run_quªtize_æoÜ
(
	`¬’a_misûlm_size_g‘
(

230 
	`¬’a_misûlm_g‘_cÚ¡
(
chunk
, 
·gešd
))));

231 
	`as£¹
(
Åages
 =ğ(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
) >>

232 
LG_PAGE
));

233 
	`¬’a_run_h—p_»move
(
	`¬’a_runs_ava_g‘
(
¬’a
, 
šd
),

234 
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
·gešd
));

235 
	}
}

238 
	$¬’a_run_dœty_š£¹
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

239 
size_t
 
Åages
)

241 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_misûlm_g‘_mubË
(
chunk
,

242 
·gešd
);

244 
	`as£¹
(
Åages
 =ğ(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
) >>

245 
LG_PAGE
));

246 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
è=ğ
CHUNK_MAP_DIRTY
);

247 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
+
Åages
-1) ==

248 
CHUNK_MAP_DIRTY
);

250 
	`qr_Ãw
(&
misûlm
->
rd
, 
rd_lšk
);

251 
	`qr_m–d
(&
¬’a
->
runs_dœty
, &
misûlm
->
rd
, 
rd_lšk
);

252 
¬’a
->
ndœty
 +ğ
Åages
;

253 
	}
}

256 
	$¬’a_run_dœty_»move
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

257 
size_t
 
Åages
)

259 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_misûlm_g‘_mubË
(
chunk
,

260 
·gešd
);

262 
	`as£¹
(
Åages
 =ğ(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
) >>

263 
LG_PAGE
));

264 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
è=ğ
CHUNK_MAP_DIRTY
);

265 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
+
Åages
-1) ==

266 
CHUNK_MAP_DIRTY
);

268 
	`qr_»move
(&
misûlm
->
rd
, 
rd_lšk
);

269 
	`as£¹
(
¬’a
->
ndœty
 >ğ
Åages
);

270 
¬’a
->
ndœty
 -ğ
Åages
;

271 
	}
}

273 
size_t


274 
	$¬’a_chunk_dœty_Åages
(cÚ¡ 
ex‹Á_node_t
 *
node
)

277  (
	`ex‹Á_node_size_g‘
(
node
è>> 
LG_PAGE
);

278 
	}
}

281 
	$¬’a_chunk_ÿche_maybe_š£¹
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
, 
boŞ
 
ÿche
)

284 ià(
ÿche
) {

285 
	`ex‹Á_node_dœty_lškage_š™
(
node
);

286 
	`ex‹Á_node_dœty_š£¹
(
node
, &
¬’a
->
runs_dœty
,

287 &
¬’a
->
chunks_ÿche
);

288 
¬’a
->
ndœty
 +ğ
	`¬’a_chunk_dœty_Åages
(
node
);

290 
	}
}

293 
	$¬’a_chunk_ÿche_maybe_»move
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
, 
boŞ
 
dœty
)

296 ià(
dœty
) {

297 
	`ex‹Á_node_dœty_»move
(
node
);

298 
	`as£¹
(
¬’a
->
ndœty
 >ğ
	`¬’a_chunk_dœty_Åages
(
node
));

299 
¬’a
->
ndœty
 -ğ
	`¬’a_chunk_dœty_Åages
(
node
);

301 
	}
}

303 
JEMALLOC_INLINE_C
 *

304 
	$¬’a_run_»g_®loc
(
¬’a_run_t
 *
run
, 
¬’a_bš_šfo_t
 *
bš_šfo
)

306 *
»t
;

307 
size_t
 
»gšd
;

308 
¬’a_chunk_m­_misc_t
 *
misûlm
;

309 *
½ages
;

311 
	`as£¹
(
run
->
nä“
 > 0);

312 
	`as£¹
(!
	`b™m­_fuÎ
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
));

314 
»gšd
 = ()
	`b™m­_sfu
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
);

315 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

316 
½ages
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

317 
»t
 = (*)((
ušŒ_t
)
½ages
 + (ušŒ_t)
bš_šfo
->
»g0_off£t
 +

318 (
ušŒ_t
)(
bš_šfo
->
»g_š‹rv®
 * 
»gšd
));

319 
run
->
nä“
--;

320  (
»t
);

321 
	}
}

323 
JEMALLOC_INLINE_C
 

324 
	$¬’a_run_»g_d®loc
(
¬’a_run_t
 *
run
, *
±r
)

326 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(
run
);

327 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

328 
size_t
 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

329 
szšd_t
 
bššd
 = 
	`¬’a_±r_sm®l_bššd_g‘
(
±r
, 
m­b™s
);

330 
¬’a_bš_šfo_t
 *
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

331 
size_t
 
»gšd
 = 
	`¬’a_run_»gšd
(
run
, 
bš_šfo
, 
±r
);

333 
	`as£¹
(
run
->
nä“
 < 
bš_šfo
->
Äegs
);

335 
	`as£¹
(((
ušŒ_t
)
±r
 -

336 ((
ušŒ_t
)
	`¬’a_misûlm_to_½ages
(
	`¬’a_run_to_misûlm
(
run
)) +

337 (
ušŒ_t
)
bš_šfo
->
»g0_off£t
)) %

338 (
ušŒ_t
)
bš_šfo
->
»g_š‹rv®
 == 0);

339 
	`as£¹
((
ušŒ_t
)
±r
 >=

340 (
ušŒ_t
)
	`¬’a_misûlm_to_½ages
(
	`¬’a_run_to_misûlm
(
run
)) +

341 (
ušŒ_t
)
bš_šfo
->
»g0_off£t
);

343 
	`as£¹
(
	`b™m­_g‘
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
, 
»gšd
));

345 
	`b™m­_un£t
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
, 
»gšd
);

346 
run
->
nä“
++;

347 
	}
}

349 
JEMALLOC_INLINE_C
 

350 
	$¬’a_run_z”o
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
run_šd
, size_ˆ
Åages
)

353 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
((*)((
ušŒ_t
)
chunk
 +

354 (
run_šd
 << 
LG_PAGE
)), (
Åages
 << LG_PAGE));

355 
	`mem£t
((*)((
ušŒ_t
)
chunk
 + (
run_šd
 << 
LG_PAGE
)), 0,

356 (
Åages
 << 
LG_PAGE
));

357 
	}
}

359 
JEMALLOC_INLINE_C
 

360 
	$¬’a_run_·ge_m¬k_z”Ûd
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
run_šd
)

363 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
((*)((
ušŒ_t
)
chunk
 + (
run_šd


364 << 
LG_PAGE
)), 
PAGE
);

365 
	}
}

367 
JEMALLOC_INLINE_C
 

368 
	$¬’a_run_·ge_v®id©e_z”Ûd
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
run_šd
)

370 
size_t
 
i
;

371 
UNUSED
 
size_t
 *
p
 = (size_ˆ*)((
ušŒ_t
)
chunk
 + (
run_šd
 << 
LG_PAGE
));

373 
	`¬’a_run_·ge_m¬k_z”Ûd
(
chunk
, 
run_šd
);

374 
i
 = 0; i < 
PAGE
 / (
size_t
); i++)

375 
	`as£¹
(
p
[
i
] == 0);

376 
	}
}

379 
	$¬’a_Çùive_add
(
¬’a_t
 *
¬’a
, 
size_t
 
add_·ges
)

382 ià(
cÚfig_¡©s
) {

383 
size_t
 
ÿùive_add
 = 
	`CHUNK_CEILING
((
¬’a
->
Çùive
 +

384 
add_·ges
è<< 
LG_PAGE
è- 
	`CHUNK_CEILING
(
¬’a
->
Çùive
 <<

385 
LG_PAGE
);

386 ià(
ÿùive_add
 != 0)

387 
	`¡©s_ÿùive_add
(
ÿùive_add
);

389 
¬’a
->
Çùive
 +ğ
add_·ges
;

390 
	}
}

393 
	$¬’a_Çùive_sub
(
¬’a_t
 *
¬’a
, 
size_t
 
sub_·ges
)

396 ià(
cÚfig_¡©s
) {

397 
size_t
 
ÿùive_sub
 = 
	`CHUNK_CEILING
(
¬’a
->
Çùive
 << 
LG_PAGE
) -

398 
	`CHUNK_CEILING
((
¬’a
->
Çùive
 - 
sub_·ges
è<< 
LG_PAGE
);

399 ià(
ÿùive_sub
 != 0)

400 
	`¡©s_ÿùive_sub
(
ÿùive_sub
);

402 
¬’a
->
Çùive
 -ğ
sub_·ges
;

403 
	}
}

406 
	$¬’a_run_¥l™_»move
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
run_šd
,

407 
size_t
 
æag_dœty
, size_ˆ
æag_decomm™‹d
, size_ˆ
Ãed_·ges
)

409 
size_t
 
tÙ®_·ges
, 
»m_·ges
;

411 
	`as£¹
(
æag_dœty
 =ğ0 || 
æag_decomm™‹d
 == 0);

413 
tÙ®_·ges
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
run_šd
) >>

414 
LG_PAGE
;

415 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
+
tÙ®_·ges
-1) ==

416 
æag_dœty
);

417 
	`as£¹
(
Ãed_·ges
 <ğ
tÙ®_·ges
);

418 
»m_·ges
 = 
tÙ®_·ges
 - 
Ãed_·ges
;

420 
	`¬’a_ava_»move
(
¬’a
, 
chunk
, 
run_šd
, 
tÙ®_·ges
);

421 ià(
æag_dœty
 != 0)

422 
	`¬’a_run_dœty_»move
(
¬’a
, 
chunk
, 
run_šd
, 
tÙ®_·ges
);

423 
	`¬’a_Çùive_add
(
¬’a
, 
Ãed_·ges
);

426 ià(
»m_·ges
 > 0) {

427 
size_t
 
æags
 = 
æag_dœty
 | 
æag_decomm™‹d
;

428 
size_t
 
æag_unz”Ûd_mask
 = (
æags
 =ğ0è? 
CHUNK_MAP_UNZEROED
 :

431 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
+
Ãed_·ges
,

432 (
»m_·ges
 << 
LG_PAGE
), 
æags
 |

433 (
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
+
Ãed_·ges
) &

434 
æag_unz”Ûd_mask
));

435 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
+
tÙ®_·ges
-1,

436 (
»m_·ges
 << 
LG_PAGE
), 
æags
 |

437 (
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
+
tÙ®_·ges
-1) &

438 
æag_unz”Ûd_mask
));

439 ià(
æag_dœty
 != 0) {

440 
	`¬’a_run_dœty_š£¹
(
¬’a
, 
chunk
, 
run_šd
+
Ãed_·ges
,

441 
»m_·ges
);

443 
	`¬’a_ava_š£¹
(
¬’a
, 
chunk
, 
run_šd
+
Ãed_·ges
, 
»m_·ges
);

445 
	}
}

447 
boŞ


448 
	$¬’a_run_¥l™_Ïrge_h–³r
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
size_t
 
size
,

449 
boŞ
 
»move
, boŞ 
z”o
)

451 
¬’a_chunk_t
 *
chunk
;

452 
¬’a_chunk_m­_misc_t
 *
misûlm
;

453 
size_t
 
æag_dœty
, 
æag_decomm™‹d
, 
run_šd
, 
Ãed_·ges
;

454 
size_t
 
æag_unz”Ûd_mask
;

456 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

457 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

458 
run_šd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

459 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
);

460 
æag_decomm™‹d
 = 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
);

461 
Ãed_·ges
 = (
size
 >> 
LG_PAGE
);

462 
	`as£¹
(
Ãed_·ges
 > 0);

464 ià(
æag_decomm™‹d
 !ğ0 && 
¬’a
->
chunk_hooks
.
	`comm™
(
chunk
, 
chunksize
,

465 
run_šd
 << 
LG_PAGE
, 
size
, 
¬’a
->
šd
))

466  (
Œue
);

468 ià(
»move
) {

469 
	`¬’a_run_¥l™_»move
(
¬’a
, 
chunk
, 
run_šd
, 
æag_dœty
,

470 
æag_decomm™‹d
, 
Ãed_·ges
);

473 ià(
z”o
) {

474 ià(
æag_decomm™‹d
 != 0) {

476 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
((

477 *)((
ušŒ_t
)
chunk
 + (
run_šd
 << 
LG_PAGE
)),

478 (
Ãed_·ges
 << 
LG_PAGE
));

479 } ià(
æag_dœty
 != 0) {

481 
	`¬’a_run_z”o
(
chunk
, 
run_šd
, 
Ãed_·ges
);

487 
size_t
 
i
;

488 
i
 = 0; i < 
Ãed_·ges
; i++) {

489 ià(
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
+
i
)

491 
	`¬’a_run_z”o
(
chunk
, 
run_šd
+
i
, 1);

492 ià(
cÚfig_debug
) {

493 
	`¬’a_run_·ge_v®id©e_z”Ûd
(
chunk
,

494 
run_šd
+
i
);

496 
	`¬’a_run_·ge_m¬k_z”Ûd
(
chunk
,

497 
run_šd
+
i
);

502 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
((*)((
ušŒ_t
)
chunk
 +

503 (
run_šd
 << 
LG_PAGE
)), (
Ãed_·ges
 << LG_PAGE));

510 
æag_unz”Ûd_mask
 = (
æag_dœty
 | 
æag_decomm™‹d
) == 0 ?

511 
CHUNK_MAP_UNZEROED
 : 0;

512 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
run_šd
+
Ãed_·ges
-1, 0, 
æag_dœty
 |

513 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

514 
run_šd
+
Ãed_·ges
-1)));

515 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
run_šd
, 
size
, 
æag_dœty
 |

516 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
)));

517  (
çl£
);

518 
	}
}

520 
boŞ


521 
	$¬’a_run_¥l™_Ïrge
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
size_t
 
size
, 
boŞ
 
z”o
)

524  (
	`¬’a_run_¥l™_Ïrge_h–³r
(
¬’a
, 
run
, 
size
, 
Œue
, 
z”o
));

525 
	}
}

527 
boŞ


528 
	$¬’a_run_š™_Ïrge
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
size_t
 
size
, 
boŞ
 
z”o
)

531  (
	`¬’a_run_¥l™_Ïrge_h–³r
(
¬’a
, 
run
, 
size
, 
çl£
, 
z”o
));

532 
	}
}

534 
boŞ


535 
	$¬’a_run_¥l™_sm®l
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
size_t
 
size
,

536 
szšd_t
 
bššd
)

538 
¬’a_chunk_t
 *
chunk
;

539 
¬’a_chunk_m­_misc_t
 *
misûlm
;

540 
size_t
 
æag_dœty
, 
æag_decomm™‹d
, 
run_šd
, 
Ãed_·ges
, 
i
;

542 
	`as£¹
(
bššd
 !ğ
BININD_INVALID
);

544 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

545 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

546 
run_šd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

547 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
);

548 
æag_decomm™‹d
 = 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
);

549 
Ãed_·ges
 = (
size
 >> 
LG_PAGE
);

550 
	`as£¹
(
Ãed_·ges
 > 0);

552 ià(
æag_decomm™‹d
 !ğ0 && 
¬’a
->
chunk_hooks
.
	`comm™
(
chunk
, 
chunksize
,

553 
run_šd
 << 
LG_PAGE
, 
size
, 
¬’a
->
šd
))

554  (
Œue
);

556 
	`¬’a_run_¥l™_»move
(
¬’a
, 
chunk
, 
run_šd
, 
æag_dœty
,

557 
æag_decomm™‹d
, 
Ãed_·ges
);

559 
i
 = 0; i < 
Ãed_·ges
; i++) {

560 
size_t
 
æag_unz”Ûd
 = 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

561 
run_šd
+
i
);

562 
	`¬’a_m­b™s_sm®l_£t
(
chunk
, 
run_šd
+
i
, i, 
bššd
,

563 
æag_unz”Ûd
);

564 ià(
cÚfig_debug
 && 
æag_dœty
 =ğ0 && 
æag_unz”Ûd
 == 0)

565 
	`¬’a_run_·ge_v®id©e_z”Ûd
(
chunk
, 
run_šd
+
i
);

567 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
((*)((
ušŒ_t
)
chunk
 +

568 (
run_šd
 << 
LG_PAGE
)), (
Ãed_·ges
 << LG_PAGE));

569  (
çl£
);

570 
	}
}

572 
¬’a_chunk_t
 *

573 
	$¬’a_chunk_š™_¥¬e
(
¬’a_t
 *
¬’a
)

575 
¬’a_chunk_t
 *
chunk
;

577 
	`as£¹
(
¬’a
->
¥¬e
 !ğ
NULL
);

579 
chunk
 = 
¬’a
->
¥¬e
;

580 
¬’a
->
¥¬e
 = 
NULL
;

582 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
m­_bŸs
) == 0);

583 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
chunk_Åages
-1) == 0);

584 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
m­_bŸs
) ==

585 
¬’a_maxrun
);

586 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
chunk_Åages
-1) ==

587 
¬’a_maxrun
);

588 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
m­_bŸs
) ==

589 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
chunk_Åages
-1));

591  (
chunk
);

592 
	}
}

594 
boŞ


595 
	$¬’a_chunk_»gi¡”
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

596 
boŞ
 
z”o
)

605 
	`ex‹Á_node_š™
(&
chunk
->
node
, 
¬’a
, chunk, 
chunksize
, 
z”o
, 
Œue
);

606 
	`ex‹Á_node_achunk_£t
(&
chunk
->
node
, 
Œue
);

607  (
	`chunk_»gi¡”
(
tsdn
, 
chunk
, &chunk->
node
));

608 
	}
}

610 
¬’a_chunk_t
 *

611 
	$¬’a_chunk_®loc_š‹º®_h¬d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

612 
chunk_hooks_t
 *
chunk_hooks
, 
boŞ
 *
z”o
, boŞ *
comm™
)

614 
¬’a_chunk_t
 *
chunk
;

616 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

618 
chunk
 = (
¬’a_chunk_t
 *)
	`chunk_®loc_w¿µ”
(
tsdn
, 
¬’a
, 
chunk_hooks
,

619 
NULL
, 
chunksize
, chunksize, 
z”o
, 
comm™
);

620 ià(
chunk
 !ğ
NULL
 && !*
comm™
) {

622 ià(
chunk_hooks
->
	`comm™
(
chunk
, 
chunksize
, 0, 
m­_bŸs
 <<

623 
LG_PAGE
, 
¬’a
->
šd
)) {

624 
	`chunk_d®loc_w¿µ”
(
tsdn
, 
¬’a
, 
chunk_hooks
,

625 (*)
chunk
, 
chunksize
, *
z”o
, *
comm™
);

626 
chunk
 = 
NULL
;

629 ià(
chunk
 !ğ
NULL
 && 
	`¬’a_chunk_»gi¡”
(
tsdn
, 
¬’a
, chunk, *
z”o
)) {

630 ià(!*
comm™
) {

632 
chunk_hooks
->
	`decomm™
(
chunk
, 
chunksize
, 0, 
m­_bŸs
 <<

633 
LG_PAGE
, 
¬’a
->
šd
);

635 
	`chunk_d®loc_w¿µ”
(
tsdn
, 
¬’a
, 
chunk_hooks
, (*)
chunk
,

636 
chunksize
, *
z”o
, *
comm™
);

637 
chunk
 = 
NULL
;

640 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

641  (
chunk
);

642 
	}
}

644 
¬’a_chunk_t
 *

645 
	$¬’a_chunk_®loc_š‹º®
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
boŞ
 *
z”o
,

646 
boŞ
 *
comm™
)

648 
¬’a_chunk_t
 *
chunk
;

649 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

651 
chunk
 = 
	`chunk_®loc_ÿche
(
tsdn
, 
¬’a
, &
chunk_hooks
, 
NULL
, 
chunksize
,

652 
chunksize
, 
z”o
, 
Œue
);

653 ià(
chunk
 !ğ
NULL
) {

654 ià(
	`¬’a_chunk_»gi¡”
(
tsdn
, 
¬’a
, 
chunk
, *
z”o
)) {

655 
	`chunk_d®loc_ÿche
(
tsdn
, 
¬’a
, &
chunk_hooks
, 
chunk
,

656 
chunksize
, 
Œue
);

657  (
NULL
);

659 *
comm™
 = 
Œue
;

661 ià(
chunk
 =ğ
NULL
) {

662 
chunk
 = 
	`¬’a_chunk_®loc_š‹º®_h¬d
(
tsdn
, 
¬’a
,

663 &
chunk_hooks
, 
z”o
, 
comm™
);

666 ià(
cÚfig_¡©s
 && 
chunk
 !ğ
NULL
) {

667 
¬’a
->
¡©s
.
m­³d
 +ğ
chunksize
;

668 
¬’a
->
¡©s
.
m‘ad©a_m­³d
 +ğ(
m­_bŸs
 << 
LG_PAGE
);

671  (
chunk
);

672 
	}
}

674 
¬’a_chunk_t
 *

675 
	$¬’a_chunk_š™_h¬d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

677 
¬’a_chunk_t
 *
chunk
;

678 
boŞ
 
z”o
, 
comm™
;

679 
size_t
 
æag_unz”Ûd
, 
æag_decomm™‹d
, 
i
;

681 
	`as£¹
(
¬’a
->
¥¬e
 =ğ
NULL
);

683 
z”o
 = 
çl£
;

684 
comm™
 = 
çl£
;

685 
chunk
 = 
	`¬’a_chunk_®loc_š‹º®
(
tsdn
, 
¬’a
, &
z”o
, &
comm™
);

686 ià(
chunk
 =ğ
NULL
)

687  (
NULL
);

694 
æag_unz”Ûd
 = (
z”o
 || !
comm™
è? 0 : 
CHUNK_MAP_UNZEROED
;

695 
æag_decomm™‹d
 = 
comm™
 ? 0 : 
CHUNK_MAP_DECOMMITTED
;

696 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
m­_bŸs
, 
¬’a_maxrun
,

697 
æag_unz”Ûd
 | 
æag_decomm™‹d
);

702 ià(!
z”o
) {

703 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(

704 (*)
	`¬’a_b™£lm_g‘_cÚ¡
(
chunk
, 
m­_bŸs
+1),

705 (
size_t
)((
ušŒ_t
)
	`¬’a_b™£lm_g‘_cÚ¡
(
chunk
,

706 
chunk_Åages
-1) -

707 (
ušŒ_t
)
	`¬’a_b™£lm_g‘_cÚ¡
(
chunk
, 
m­_bŸs
+1)));

708 
i
 = 
m­_bŸs
+1; i < 
chunk_Åages
-1; i++)

709 
	`¬’a_m­b™s_š‹º®_£t
(
chunk
, 
i
, 
æag_unz”Ûd
);

711 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
((

712 *)
	`¬’a_b™£lm_g‘_cÚ¡
(
chunk
, 
m­_bŸs
+1),

713 (
size_t
)((
ušŒ_t
)
	`¬’a_b™£lm_g‘_cÚ¡
(
chunk
,

714 
chunk_Åages
-1) -

715 (
ušŒ_t
)
	`¬’a_b™£lm_g‘_cÚ¡
(
chunk
, 
m­_bŸs
+1)));

716 ià(
cÚfig_debug
) {

717 
i
 = 
m­_bŸs
+1; i < 
chunk_Åages
-1; i++) {

718 
	`as£¹
(
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
i
) ==

719 
æag_unz”Ûd
);

723 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
chunk_Åages
-1, 
¬’a_maxrun
,

724 
æag_unz”Ûd
);

726  (
chunk
);

727 
	}
}

729 
¬’a_chunk_t
 *

730 
	$¬’a_chunk_®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

732 
¬’a_chunk_t
 *
chunk
;

734 ià(
¬’a
->
¥¬e
 !ğ
NULL
)

735 
chunk
 = 
	`¬’a_chunk_š™_¥¬e
(
¬’a
);

737 
chunk
 = 
	`¬’a_chunk_š™_h¬d
(
tsdn
, 
¬’a
);

738 ià(
chunk
 =ğ
NULL
)

739  (
NULL
);

742 
	`ql_–m_Ãw
(&
chunk
->
node
, 
ql_lšk
);

743 
	`ql__š£¹
(&
¬’a
->
achunks
, &
chunk
->
node
, 
ql_lšk
);

744 
	`¬’a_ava_š£¹
(
¬’a
, 
chunk
, 
m­_bŸs
, 
chunk_Åages
-map_bias);

746  (
chunk
);

747 
	}
}

750 
	$¬’a_chunk_disÿrd
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
)

752 
boŞ
 
comm™‹d
;

753 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

755 
	`chunk_d”egi¡”
(
chunk
, &chunk->
node
);

757 
comm™‹d
 = (
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
m­_bŸs
) == 0);

758 ià(!
comm™‹d
) {

765 
chunk_hooks
 = 
	`chunk_hooks_g‘
(
tsdn
, 
¬’a
);

766 
chunk_hooks
.
	`decomm™
(
chunk
, 
chunksize
, 0, 
m­_bŸs
 << 
LG_PAGE
,

767 
¬’a
->
šd
);

770 
	`chunk_d®loc_ÿche
(
tsdn
, 
¬’a
, &
chunk_hooks
, (*)
chunk
, 
chunksize
,

771 
comm™‹d
);

773 ià(
cÚfig_¡©s
) {

774 
¬’a
->
¡©s
.
m­³d
 -ğ
chunksize
;

775 
¬’a
->
¡©s
.
m‘ad©a_m­³d
 -ğ(
m­_bŸs
 << 
LG_PAGE
);

777 
	}
}

780 
	$¬’a_¥¬e_disÿrd
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
¥¬e
)

783 
	`as£¹
(
¬’a
->
¥¬e
 != spare);

785 ià(
	`¬’a_m­b™s_dœty_g‘
(
¥¬e
, 
m­_bŸs
) != 0) {

786 
	`¬’a_run_dœty_»move
(
¬’a
, 
¥¬e
, 
m­_bŸs
,

787 
chunk_Åages
-
m­_bŸs
);

790 
	`¬’a_chunk_disÿrd
(
tsdn
, 
¬’a
, 
¥¬e
);

791 
	}
}

794 
	$¬’a_chunk_d®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
)

796 
¬’a_chunk_t
 *
¥¬e
;

798 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
m­_bŸs
) == 0);

799 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
chunk_Åages
-1) == 0);

800 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
m­_bŸs
) ==

801 
¬’a_maxrun
);

802 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
chunk_Åages
-1) ==

803 
¬’a_maxrun
);

804 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
m­_bŸs
) ==

805 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
chunk_Åages
-1));

806 
	`as£¹
(
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
m­_bŸs
) ==

807 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
chunk_Åages
-1));

810 
	`¬’a_ava_»move
(
¬’a
, 
chunk
, 
m­_bŸs
, 
chunk_Åages
-map_bias);

812 
	`ql_»move
(&
¬’a
->
achunks
, &
chunk
->
node
, 
ql_lšk
);

813 
¥¬e
 = 
¬’a
->spare;

814 
¬’a
->
¥¬e
 = 
chunk
;

815 ià(
¥¬e
 !ğ
NULL
)

816 
	`¬’a_¥¬e_disÿrd
(
tsdn
, 
¬’a
, 
¥¬e
);

817 
	}
}

820 
	$¬’a_huge_m®loc_¡©s_upd©e
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
)

822 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
Æşas£s
 - 
NBINS
;

824 
	`ÿs£¹
(
cÚfig_¡©s
);

826 
¬’a
->
¡©s
.
nm®loc_huge
++;

827 
¬’a
->
¡©s
.
®loÿ‹d_huge
 +ğ
usize
;

828 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
nm®loc
++;

829 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
curhchunks
++;

830 
	}
}

833 
	$¬’a_huge_m®loc_¡©s_upd©e_undo
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
)

835 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
Æşas£s
 - 
NBINS
;

837 
	`ÿs£¹
(
cÚfig_¡©s
);

839 
¬’a
->
¡©s
.
nm®loc_huge
--;

840 
¬’a
->
¡©s
.
®loÿ‹d_huge
 -ğ
usize
;

841 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
nm®loc
--;

842 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
curhchunks
--;

843 
	}
}

846 
	$¬’a_huge_d®loc_¡©s_upd©e
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
)

848 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
Æşas£s
 - 
NBINS
;

850 
	`ÿs£¹
(
cÚfig_¡©s
);

852 
¬’a
->
¡©s
.
nd®loc_huge
++;

853 
¬’a
->
¡©s
.
®loÿ‹d_huge
 -ğ
usize
;

854 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
nd®loc
++;

855 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
curhchunks
--;

856 
	}
}

859 
	$¬’a_huge_»£t_¡©s_ÿnûl
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
)

861 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
Æşas£s
 - 
NBINS
;

863 
	`ÿs£¹
(
cÚfig_¡©s
);

865 
¬’a
->
¡©s
.
nd®loc_huge
++;

866 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
nd®loc
--;

867 
	}
}

870 
	$¬’a_huge_d®loc_¡©s_upd©e_undo
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
)

872 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
Æşas£s
 - 
NBINS
;

874 
	`ÿs£¹
(
cÚfig_¡©s
);

876 
¬’a
->
¡©s
.
nd®loc_huge
--;

877 
¬’a
->
¡©s
.
®loÿ‹d_huge
 +ğ
usize
;

878 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
nd®loc
--;

879 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
curhchunks
++;

880 
	}
}

883 
	$¬’a_huge_¿Îoc_¡©s_upd©e
(
¬’a_t
 *
¬’a
, 
size_t
 
Şdsize
, size_ˆ
usize
)

886 
	`¬’a_huge_d®loc_¡©s_upd©e
(
¬’a
, 
Şdsize
);

887 
	`¬’a_huge_m®loc_¡©s_upd©e
(
¬’a
, 
usize
);

888 
	}
}

891 
	$¬’a_huge_¿Îoc_¡©s_upd©e_undo
(
¬’a_t
 *
¬’a
, 
size_t
 
Şdsize
,

892 
size_t
 
usize
)

895 
	`¬’a_huge_d®loc_¡©s_upd©e_undo
(
¬’a
, 
Şdsize
);

896 
	`¬’a_huge_m®loc_¡©s_upd©e_undo
(
¬’a
, 
usize
);

897 
	}
}

899 
ex‹Á_node_t
 *

900 
	$¬’a_node_®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

902 
ex‹Á_node_t
 *
node
;

904 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
node_ÿche_mtx
);

905 
node
 = 
	`ql_Ï¡
(&
¬’a
->
node_ÿche
, 
ql_lšk
);

906 ià(
node
 =ğ
NULL
) {

907 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
node_ÿche_mtx
);

908  (
	`ba£_®loc
(
tsdn
, (
ex‹Á_node_t
)));

910 
	`ql__»move
(&
¬’a
->
node_ÿche
, 
ex‹Á_node_t
, 
ql_lšk
);

911 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
node_ÿche_mtx
);

912  (
node
);

913 
	}
}

916 
	$¬’a_node_d®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
)

919 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
node_ÿche_mtx
);

920 
	`ql_–m_Ãw
(
node
, 
ql_lšk
);

921 
	`ql__š£¹
(&
¬’a
->
node_ÿche
, 
node
, 
ql_lšk
);

922 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
node_ÿche_mtx
);

923 
	}
}

926 
	$¬’a_chunk_®loc_huge_h¬d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

927 
chunk_hooks_t
 *
chunk_hooks
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
,

928 
size_t
 
csize
)

930 *
»t
;

931 
boŞ
 
comm™
 = 
Œue
;

933 
»t
 = 
	`chunk_®loc_w¿µ”
(
tsdn
, 
¬’a
, 
chunk_hooks
, 
NULL
, 
csize
,

934 
®ignm’t
, 
z”o
, &
comm™
);

935 ià(
»t
 =ğ
NULL
) {

937 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

938 ià(
cÚfig_¡©s
) {

939 
	`¬’a_huge_m®loc_¡©s_upd©e_undo
(
¬’a
, 
usize
);

940 
¬’a
->
¡©s
.
m­³d
 -ğ
usize
;

942 
	`¬’a_Çùive_sub
(
¬’a
, 
usize
 >> 
LG_PAGE
);

943 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

946  (
»t
);

947 
	}
}

950 
	$¬’a_chunk_®loc_huge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
,

951 
size_t
 
®ignm’t
, 
boŞ
 *
z”o
)

953 *
»t
;

954 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

955 
size_t
 
csize
 = 
	`CHUNK_CEILING
(
usize
);

957 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

960 ià(
cÚfig_¡©s
) {

961 
	`¬’a_huge_m®loc_¡©s_upd©e
(
¬’a
, 
usize
);

962 
¬’a
->
¡©s
.
m­³d
 +ğ
usize
;

964 
	`¬’a_Çùive_add
(
¬’a
, 
usize
 >> 
LG_PAGE
);

966 
»t
 = 
	`chunk_®loc_ÿche
(
tsdn
, 
¬’a
, &
chunk_hooks
, 
NULL
, 
csize
,

967 
®ignm’t
, 
z”o
, 
Œue
);

968 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

969 ià(
»t
 =ğ
NULL
) {

970 
»t
 = 
	`¬’a_chunk_®loc_huge_h¬d
(
tsdn
, 
¬’a
, &
chunk_hooks
,

971 
usize
, 
®ignm’t
, 
z”o
, 
csize
);

974  (
»t
);

975 
	}
}

978 
	$¬’a_chunk_d®loc_huge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
chunk
, 
size_t
 
usize
)

980 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

981 
size_t
 
csize
;

983 
csize
 = 
	`CHUNK_CEILING
(
usize
);

984 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

985 ià(
cÚfig_¡©s
) {

986 
	`¬’a_huge_d®loc_¡©s_upd©e
(
¬’a
, 
usize
);

987 
¬’a
->
¡©s
.
m­³d
 -ğ
usize
;

989 
	`¬’a_Çùive_sub
(
¬’a
, 
usize
 >> 
LG_PAGE
);

991 
	`chunk_d®loc_ÿche
(
tsdn
, 
¬’a
, &
chunk_hooks
, 
chunk
, 
csize
, 
Œue
);

992 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

993 
	}
}

996 
	$¬’a_chunk_¿Îoc_huge_sim¬
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
chunk
,

997 
size_t
 
Şdsize
, size_ˆ
usize
)

1000 
	`as£¹
(
	`CHUNK_CEILING
(
Şdsize
è=ğCHUNK_CEILING(
usize
));

1001 
	`as£¹
(
Şdsize
 !ğ
usize
);

1003 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1004 ià(
cÚfig_¡©s
)

1005 
	`¬’a_huge_¿Îoc_¡©s_upd©e
(
¬’a
, 
Şdsize
, 
usize
);

1006 ià(
Şdsize
 < 
usize
)

1007 
	`¬’a_Çùive_add
(
¬’a
, (
usize
 - 
Şdsize
è>> 
LG_PAGE
);

1009 
	`¬’a_Çùive_sub
(
¬’a
, (
Şdsize
 - 
usize
è>> 
LG_PAGE
);

1010 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1011 
	}
}

1014 
	$¬’a_chunk_¿Îoc_huge_shršk
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
chunk
,

1015 
size_t
 
Şdsize
, size_ˆ
usize
)

1017 
size_t
 
udiff
 = 
Şdsize
 - 
usize
;

1018 
size_t
 
cdiff
 = 
	`CHUNK_CEILING
(
Şdsize
è- CHUNK_CEILING(
usize
);

1020 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1021 ià(
cÚfig_¡©s
) {

1022 
	`¬’a_huge_¿Îoc_¡©s_upd©e
(
¬’a
, 
Şdsize
, 
usize
);

1023 ià(
cdiff
 != 0)

1024 
¬’a
->
¡©s
.
m­³d
 -ğ
cdiff
;

1026 
	`¬’a_Çùive_sub
(
¬’a
, 
udiff
 >> 
LG_PAGE
);

1028 ià(
cdiff
 != 0) {

1029 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

1030 *
nchunk
 = (*)((
ušŒ_t
)
chunk
 +

1031 
	`CHUNK_CEILING
(
usize
));

1033 
	`chunk_d®loc_ÿche
(
tsdn
, 
¬’a
, &
chunk_hooks
, 
nchunk
, 
cdiff
,

1034 
Œue
);

1036 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1037 
	}
}

1039 
boŞ


1040 
	$¬’a_chunk_¿Îoc_huge_ex·nd_h¬d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

1041 
chunk_hooks_t
 *
chunk_hooks
, *
chunk
, 
size_t
 
Şdsize
, size_ˆ
usize
,

1042 
boŞ
 *
z”o
, *
nchunk
, 
size_t
 
udiff
, size_ˆ
cdiff
)

1044 
boŞ
 
”r
;

1045 
boŞ
 
comm™
 = 
Œue
;

1047 
”r
 = (
	`chunk_®loc_w¿µ”
(
tsdn
, 
¬’a
, 
chunk_hooks
, 
nchunk
, 
cdiff
,

1048 
chunksize
, 
z”o
, &
comm™
è=ğ
NULL
);

1049 ià(
”r
) {

1051 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1052 ià(
cÚfig_¡©s
) {

1053 
	`¬’a_huge_¿Îoc_¡©s_upd©e_undo
(
¬’a
, 
Şdsize
,

1054 
usize
);

1055 
¬’a
->
¡©s
.
m­³d
 -ğ
cdiff
;

1057 
	`¬’a_Çùive_sub
(
¬’a
, 
udiff
 >> 
LG_PAGE
);

1058 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1059 } ià(
chunk_hooks
->
	`m”ge
(
chunk
, 
	`CHUNK_CEILING
(
Şdsize
), 
nchunk
,

1060 
cdiff
, 
Œue
, 
¬’a
->
šd
)) {

1061 
	`chunk_d®loc_w¿µ”
(
tsdn
, 
¬’a
, 
chunk_hooks
, 
nchunk
, 
cdiff
,

1062 *
z”o
, 
Œue
);

1063 
”r
 = 
Œue
;

1065  (
”r
);

1066 
	}
}

1068 
boŞ


1069 
	$¬’a_chunk_¿Îoc_huge_ex·nd
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
chunk
,

1070 
size_t
 
Şdsize
, size_ˆ
usize
, 
boŞ
 *
z”o
)

1072 
boŞ
 
”r
;

1073 
chunk_hooks_t
 
chunk_hooks
 = 
	`chunk_hooks_g‘
(
tsdn
, 
¬’a
);

1074 *
nchunk
 = (*)((
ušŒ_t
)
chunk
 + 
	`CHUNK_CEILING
(
Şdsize
));

1075 
size_t
 
udiff
 = 
usize
 - 
Şdsize
;

1076 
size_t
 
cdiff
 = 
	`CHUNK_CEILING
(
usize
è- CHUNK_CEILING(
Şdsize
);

1078 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1081 ià(
cÚfig_¡©s
) {

1082 
	`¬’a_huge_¿Îoc_¡©s_upd©e
(
¬’a
, 
Şdsize
, 
usize
);

1083 
¬’a
->
¡©s
.
m­³d
 +ğ
cdiff
;

1085 
	`¬’a_Çùive_add
(
¬’a
, 
udiff
 >> 
LG_PAGE
);

1087 
”r
 = (
	`chunk_®loc_ÿche
(
tsdn
, 
¬’a
, &
chunk_hooks
, 
nchunk
, 
cdiff
,

1088 
chunksize
, 
z”o
, 
Œue
è=ğ
NULL
);

1089 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1090 ià(
”r
) {

1091 
”r
 = 
	`¬’a_chunk_¿Îoc_huge_ex·nd_h¬d
(
tsdn
, 
¬’a
,

1092 &
chunk_hooks
, 
chunk
, 
Şdsize
, 
usize
, 
z”o
, 
nchunk
, 
udiff
,

1093 
cdiff
);

1094 } ià(
chunk_hooks
.
	`m”ge
(
chunk
, 
	`CHUNK_CEILING
(
Şdsize
), 
nchunk
,

1095 
cdiff
, 
Œue
, 
¬’a
->
šd
)) {

1096 
	`chunk_d®loc_w¿µ”
(
tsdn
, 
¬’a
, &
chunk_hooks
, 
nchunk
, 
cdiff
,

1097 *
z”o
, 
Œue
);

1098 
”r
 = 
Œue
;

1101  (
”r
);

1102 
	}
}

1109 
¬’a_run_t
 *

1110 
	$¬’a_run_fœ¡_be¡_f™
(
¬’a_t
 *
¬’a
, 
size_t
 
size
)

1112 
szšd_t
 
šd
, 
i
;

1114 
šd
 = 
	`size2šdex
(
	`run_quªtize_û
(
size
));

1115 
i
 = 
šd
; i < 
runs_ava_nşas£s
 + 
runs_ava_bŸs
; i++) {

1116 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_h—p_fœ¡
(

1117 
	`¬’a_runs_ava_g‘
(
¬’a
, 
i
));

1118 ià(
misûlm
 !ğ
NULL
)

1119  (&
misûlm
->
run
);

1122  (
NULL
);

1123 
	}
}

1125 
¬’a_run_t
 *

1126 
	$¬’a_run_®loc_Ïrge_h–³r
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
)

1128 
¬’a_run_t
 *
run
 = 
	`¬’a_run_fœ¡_be¡_f™
(
¬’a
, 
	`s2u
(
size
));

1129 ià(
run
 !ğ
NULL
) {

1130 ià(
	`¬’a_run_¥l™_Ïrge
(
¬’a
, 
run
, 
size
, 
z”o
))

1131 
run
 = 
NULL
;

1133  (
run
);

1134 
	}
}

1136 
¬’a_run_t
 *

1137 
	$¬’a_run_®loc_Ïrge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
)

1139 
¬’a_chunk_t
 *
chunk
;

1140 
¬’a_run_t
 *
run
;

1142 
	`as£¹
(
size
 <ğ
¬’a_maxrun
);

1143 
	`as£¹
(
size
 =ğ
	`PAGE_CEILING
(size));

1146 
run
 = 
	`¬’a_run_®loc_Ïrge_h–³r
(
¬’a
, 
size
, 
z”o
);

1147 ià(
run
 !ğ
NULL
)

1148  (
run
);

1153 
chunk
 = 
	`¬’a_chunk_®loc
(
tsdn
, 
¬’a
);

1154 ià(
chunk
 !ğ
NULL
) {

1155 
run
 = &
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
m­_bŸs
)->run;

1156 ià(
	`¬’a_run_¥l™_Ïrge
(
¬’a
, 
run
, 
size
, 
z”o
))

1157 
run
 = 
NULL
;

1158  (
run
);

1166  (
	`¬’a_run_®loc_Ïrge_h–³r
(
¬’a
, 
size
, 
z”o
));

1167 
	}
}

1169 
¬’a_run_t
 *

1170 
	$¬’a_run_®loc_sm®l_h–³r
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
szšd_t
 
bššd
)

1172 
¬’a_run_t
 *
run
 = 
	`¬’a_run_fœ¡_be¡_f™
(
¬’a
, 
size
);

1173 ià(
run
 !ğ
NULL
) {

1174 ià(
	`¬’a_run_¥l™_sm®l
(
¬’a
, 
run
, 
size
, 
bššd
))

1175 
run
 = 
NULL
;

1177  (
run
);

1178 
	}
}

1180 
¬’a_run_t
 *

1181 
	$¬’a_run_®loc_sm®l
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
szšd_t
 
bššd
)

1183 
¬’a_chunk_t
 *
chunk
;

1184 
¬’a_run_t
 *
run
;

1186 
	`as£¹
(
size
 <ğ
¬’a_maxrun
);

1187 
	`as£¹
(
size
 =ğ
	`PAGE_CEILING
(size));

1188 
	`as£¹
(
bššd
 !ğ
BININD_INVALID
);

1191 
run
 = 
	`¬’a_run_®loc_sm®l_h–³r
(
¬’a
, 
size
, 
bššd
);

1192 ià(
run
 !ğ
NULL
)

1193  (
run
);

1198 
chunk
 = 
	`¬’a_chunk_®loc
(
tsdn
, 
¬’a
);

1199 ià(
chunk
 !ğ
NULL
) {

1200 
run
 = &
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
m­_bŸs
)->run;

1201 ià(
	`¬’a_run_¥l™_sm®l
(
¬’a
, 
run
, 
size
, 
bššd
))

1202 
run
 = 
NULL
;

1203  (
run
);

1211  (
	`¬’a_run_®loc_sm®l_h–³r
(
¬’a
, 
size
, 
bššd
));

1212 
	}
}

1214 
boŞ


1215 
	$¬’a_lg_dœty_muÉ_v®id
(
ssize_t
 
lg_dœty_muÉ
)

1218  (
lg_dœty_muÉ
 >ğ-1 &&†g_dœty_muÉ < (
ssize_t
)((
size_t
)

1220 
	}
}

1222 
ssize_t


1223 
	$¬’a_lg_dœty_muÉ_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

1225 
ssize_t
 
lg_dœty_muÉ
;

1227 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1228 
lg_dœty_muÉ
 = 
¬’a
->lg_dirty_mult;

1229 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1231  (
lg_dœty_muÉ
);

1232 
	}
}

1234 
boŞ


1235 
	$¬’a_lg_dœty_muÉ_£t
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
ssize_t
 
lg_dœty_muÉ
)

1238 ià(!
	`¬’a_lg_dœty_muÉ_v®id
(
lg_dœty_muÉ
))

1239  (
Œue
);

1241 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1242 
¬’a
->
lg_dœty_muÉ
 =†g_dirty_mult;

1243 
	`¬’a_maybe_purge
(
tsdn
, 
¬’a
);

1244 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1246  (
çl£
);

1247 
	}
}

1250 
	$¬’a_deÿy_d—dlše_š™
(
¬’a_t
 *
¬’a
)

1253 
	`as£¹
(
İt_purge
 =ğ
purge_mode_deÿy
);

1259 
	`n¡ime_cİy
(&
¬’a
->
deÿy_d—dlše
, &¬’a->
deÿy_•och
);

1260 
	`n¡ime_add
(&
¬’a
->
deÿy_d—dlše
, &¬’a->
deÿy_š‹rv®
);

1261 ià(
¬’a
->
deÿy_time
 > 0) {

1262 
n¡ime_t
 
j™‹r
;

1264 
	`n¡ime_š™
(&
j™‹r
, 
	`´ng_¿nge
(&
¬’a
->
deÿy_j™‹r_¡©e
,

1265 
	`n¡ime_ns
(&
¬’a
->
deÿy_š‹rv®
)));

1266 
	`n¡ime_add
(&
¬’a
->
deÿy_d—dlše
, &
j™‹r
);

1268 
	}
}

1270 
boŞ


1271 
	$¬’a_deÿy_d—dlše_»ached
(cÚ¡ 
¬’a_t
 *
¬’a
, cÚ¡ 
n¡ime_t
 *
time
)

1274 
	`as£¹
(
İt_purge
 =ğ
purge_mode_deÿy
);

1276  (
	`n¡ime_com·»
(&
¬’a
->
deÿy_d—dlše
, 
time
) <= 0);

1277 
	}
}

1279 
size_t


1280 
	$¬’a_deÿy_backlog_Åages_lim™
(cÚ¡ 
¬’a_t
 *
¬’a
)

1282 cÚ¡ 
ušt64_t
 
h_¡•s
[] = {

1283 
	#STEP
(
¡•
, 
h
, 
x
, 
y
) \

1284 
h
,

	)

1285 
SMOOTHSTEP


1286 #undeà
STEP


1288 
ušt64_t
 
sum
;

1289 
size_t
 
Åages_lim™_backlog
;

1290 
i
;

1292 
	`as£¹
(
İt_purge
 =ğ
purge_mode_deÿy
);

1299 
sum
 = 0;

1300 
i
 = 0; i < 
SMOOTHSTEP_NSTEPS
; i++)

1301 
sum
 +ğ
¬’a
->
deÿy_backlog
[
i
] * 
h_¡•s
[i];

1302 
Åages_lim™_backlog
 = (
size_t
)(
sum
 >> 
SMOOTHSTEP_BFP
);

1304  (
Åages_lim™_backlog
);

1305 
	}
}

1308 
	$¬’a_deÿy_•och_advªû
(
¬’a_t
 *
¬’a
, cÚ¡ 
n¡ime_t
 *
time
)

1310 
ušt64_t
 
Çdvªû_u64
;

1311 
n¡ime_t
 
d–
;

1312 
size_t
 
ndœty_d–
;

1314 
	`as£¹
(
İt_purge
 =ğ
purge_mode_deÿy
);

1315 
	`as£¹
(
	`¬’a_deÿy_d—dlše_»ached
(
¬’a
, 
time
));

1317 
	`n¡ime_cİy
(&
d–
, 
time
);

1318 
	`n¡ime_subŒaù
(&
d–
, &
¬’a
->
deÿy_•och
);

1319 
Çdvªû_u64
 = 
	`n¡ime_divide
(&
d–
, &
¬’a
->
deÿy_š‹rv®
);

1320 
	`as£¹
(
Çdvªû_u64
 > 0);

1323 
	`n¡ime_cİy
(&
d–
, &
¬’a
->
deÿy_š‹rv®
);

1324 
	`n¡ime_imuÉly
(&
d–
, 
Çdvªû_u64
);

1325 
	`n¡ime_add
(&
¬’a
->
deÿy_•och
, &
d–
);

1328 
	`¬’a_deÿy_d—dlše_š™
(
¬’a
);

1331 ià(
Çdvªû_u64
 >ğ
SMOOTHSTEP_NSTEPS
) {

1332 
	`mem£t
(
¬’a
->
deÿy_backlog
, 0, (
SMOOTHSTEP_NSTEPS
-1) *

1333 (
size_t
));

1335 
size_t
 
Çdvªû_z
 = (size_t)
Çdvªû_u64
;

1337 
	`as£¹
((
ušt64_t
)
Çdvªû_z
 =ğ
Çdvªû_u64
);

1339 
	`memmove
(
¬’a
->
deÿy_backlog
, &¬’a->deÿy_backlog[
Çdvªû_z
],

1340 (
SMOOTHSTEP_NSTEPS
 - 
Çdvªû_z
è* (
size_t
));

1341 ià(
Çdvªû_z
 > 1) {

1342 
	`mem£t
(&
¬’a
->
deÿy_backlog
[
SMOOTHSTEP_NSTEPS
 -

1343 
Çdvªû_z
], 0, (Çdvªû_z-1è* (
size_t
));

1346 
ndœty_d–
 = (
¬’a
->
ndœty
 >‡»Ç->
deÿy_ndœty
) ?‡rena->ndirty -

1347 
¬’a
->
deÿy_ndœty
 : 0;

1348 
¬’a
->
deÿy_ndœty
 =‡»Ç->
ndœty
;

1349 
¬’a
->
deÿy_backlog
[
SMOOTHSTEP_NSTEPS
-1] = 
ndœty_d–
;

1350 
¬’a
->
deÿy_backlog_Åages_lim™
 =

1351 
	`¬’a_deÿy_backlog_Åages_lim™
(
¬’a
);

1352 
	}
}

1354 
size_t


1355 
	$¬’a_deÿy_Åages_lim™
(
¬’a_t
 *
¬’a
)

1357 
size_t
 
Åages_lim™
;

1359 
	`as£¹
(
İt_purge
 =ğ
purge_mode_deÿy
);

1361 
Åages_lim™
 = 
¬’a
->
deÿy_backlog_Åages_lim™
;

1364 ià(
¬’a
->
ndœty
 >‡»Ç->
deÿy_ndœty
)

1365 
Åages_lim™
 +ğ
¬’a
->
ndœty
 -‡»Ç->
deÿy_ndœty
;

1367  (
Åages_lim™
);

1368 
	}
}

1371 
	$¬’a_deÿy_š™
(
¬’a_t
 *
¬’a
, 
ssize_t
 
deÿy_time
)

1374 
¬’a
->
deÿy_time
 = decay_time;

1375 ià(
deÿy_time
 > 0) {

1376 
	`n¡ime_š™2
(&
¬’a
->
deÿy_š‹rv®
, 
deÿy_time
, 0);

1377 
	`n¡ime_idivide
(&
¬’a
->
deÿy_š‹rv®
, 
SMOOTHSTEP_NSTEPS
);

1380 
	`n¡ime_š™
(&
¬’a
->
deÿy_•och
, 0);

1381 
	`n¡ime_upd©e
(&
¬’a
->
deÿy_•och
);

1382 
¬’a
->
deÿy_j™‹r_¡©e
 = (
ušt64_t
)(
ušŒ_t
)arena;

1383 
	`¬’a_deÿy_d—dlše_š™
(
¬’a
);

1384 
¬’a
->
deÿy_ndœty
 =‡»Ç->
ndœty
;

1385 
¬’a
->
deÿy_backlog_Åages_lim™
 = 0;

1386 
	`mem£t
(
¬’a
->
deÿy_backlog
, 0, 
SMOOTHSTEP_NSTEPS
 * (
size_t
));

1387 
	}
}

1389 
boŞ


1390 
	$¬’a_deÿy_time_v®id
(
ssize_t
 
deÿy_time
)

1393 ià(
deÿy_time
 < -1)

1394  (
çl£
);

1395 ià(
deÿy_time
 =ğ-1 || (
ušt64_t
)deÿy_tim<ğ
NSTIME_SEC_MAX
)

1396  (
Œue
);

1397  (
çl£
);

1398 
	}
}

1400 
ssize_t


1401 
	$¬’a_deÿy_time_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

1403 
ssize_t
 
deÿy_time
;

1405 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1406 
deÿy_time
 = 
¬’a
->decay_time;

1407 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1409  (
deÿy_time
);

1410 
	}
}

1412 
boŞ


1413 
	$¬’a_deÿy_time_£t
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
ssize_t
 
deÿy_time
)

1416 ià(!
	`¬’a_deÿy_time_v®id
(
deÿy_time
))

1417  (
Œue
);

1419 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1428 
	`¬’a_deÿy_š™
(
¬’a
, 
deÿy_time
);

1429 
	`¬’a_maybe_purge
(
tsdn
, 
¬’a
);

1430 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1432  (
çl£
);

1433 
	}
}

1436 
	$¬’a_maybe_purge_¿tio
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

1439 
	`as£¹
(
İt_purge
 =ğ
purge_mode_¿tio
);

1442 ià(
¬’a
->
lg_dœty_muÉ
 < 0)

1449 
Œue
) {

1450 
size_t
 
th»shŞd
 = (
¬’a
->
Çùive
 >>‡»Ç->
lg_dœty_muÉ
);

1451 ià(
th»shŞd
 < 
chunk_Åages
)

1452 
th»shŞd
 = 
chunk_Åages
;

1457 ià(
¬’a
->
ndœty
 <ğ
th»shŞd
)

1459 
	`¬’a_purge_to_lim™
(
tsdn
, 
¬’a
, 
th»shŞd
);

1461 
	}
}

1464 
	$¬’a_maybe_purge_deÿy
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

1466 
n¡ime_t
 
time
;

1467 
size_t
 
ndœty_lim™
;

1469 
	`as£¹
(
İt_purge
 =ğ
purge_mode_deÿy
);

1472 ià(
¬’a
->
deÿy_time
 <= 0) {

1473 ià(
¬’a
->
deÿy_time
 == 0)

1474 
	`¬’a_purge_to_lim™
(
tsdn
, 
¬’a
, 0);

1478 
	`n¡ime_cİy
(&
time
, &
¬’a
->
deÿy_•och
);

1479 ià(
	`uÆik–y
(
	`n¡ime_upd©e
(&
time
))) {

1481 
	`n¡ime_cİy
(&
time
, &
¬’a
->
deÿy_d—dlše
);

1484 ià(
	`¬’a_deÿy_d—dlše_»ached
(
¬’a
, &
time
))

1485 
	`¬’a_deÿy_•och_advªû
(
¬’a
, &
time
);

1487 
ndœty_lim™
 = 
	`¬’a_deÿy_Åages_lim™
(
¬’a
);

1493 ià(
¬’a
->
ndœty
 <ğ
ndœty_lim™
)

1495 
	`¬’a_purge_to_lim™
(
tsdn
, 
¬’a
, 
ndœty_lim™
);

1496 
	}
}

1499 
	$¬’a_maybe_purge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

1503 ià(
¬’a
->
purgšg
)

1506 ià(
İt_purge
 =ğ
purge_mode_¿tio
)

1507 
	`¬’a_maybe_purge_¿tio
(
tsdn
, 
¬’a
);

1509 
	`¬’a_maybe_purge_deÿy
(
tsdn
, 
¬’a
);

1510 
	}
}

1512 
size_t


1513 
	$¬’a_dœty_couÁ
(
¬’a_t
 *
¬’a
)

1515 
size_t
 
ndœty
 = 0;

1516 
¬’a_runs_dœty_lšk_t
 *
rd–m
;

1517 
ex‹Á_node_t
 *
chunk£lm
;

1519 
rd–m
 = 
	`qr_Ãxt
(&
¬’a
->
runs_dœty
, 
rd_lšk
),

1520 
chunk£lm
 = 
	`qr_Ãxt
(&
¬’a
->
chunks_ÿche
, 
cc_lšk
);

1521 
rd–m
 !ğ&
¬’a
->
runs_dœty
;„d–m = 
	`qr_Ãxt
Ôd–m, 
rd_lšk
)) {

1522 
size_t
 
Åages
;

1524 ià(
rd–m
 =ğ&
chunk£lm
->
rd
) {

1525 
Åages
 = 
	`ex‹Á_node_size_g‘
(
chunk£lm
è>> 
LG_PAGE
;

1526 
chunk£lm
 = 
	`qr_Ãxt
(chunk£lm, 
cc_lšk
);

1528 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(

1529 
rd–m
);

1530 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

1531 
	`¬’a_rd_to_misûlm
(
rd–m
);

1532 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1533 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) ==

1535 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) == 0);

1536 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
) != 0);

1537 
Åages
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
,

1538 
·gešd
è>> 
LG_PAGE
;

1540 
ndœty
 +ğ
Åages
;

1543  (
ndœty
);

1544 
	}
}

1546 
size_t


1547 
	$¬’a_¡ash_dœty
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

1548 
size_t
 
ndœty_lim™
, 
¬’a_runs_dœty_lšk_t
 *
purge_runs_£Áš–
,

1549 
ex‹Á_node_t
 *
purge_chunks_£Áš–
)

1551 
¬’a_runs_dœty_lšk_t
 *
rd–m
, *
rd–m_Ãxt
;

1552 
ex‹Á_node_t
 *
chunk£lm
;

1553 
size_t
 
n¡ashed
 = 0;

1556 
rd–m
 = 
	`qr_Ãxt
(&
¬’a
->
runs_dœty
, 
rd_lšk
),

1557 
chunk£lm
 = 
	`qr_Ãxt
(&
¬’a
->
chunks_ÿche
, 
cc_lšk
);

1558 
rd–m
 !ğ&
¬’a
->
runs_dœty
;„d–m = 
rd–m_Ãxt
) {

1559 
size_t
 
Åages
;

1560 
rd–m_Ãxt
 = 
	`qr_Ãxt
(
rd–m
, 
rd_lšk
);

1562 ià(
rd–m
 =ğ&
chunk£lm
->
rd
) {

1563 
ex‹Á_node_t
 *
chunk£lm_Ãxt
;

1564 
boŞ
 
z”o
;

1565 
UNUSED
 *
chunk
;

1567 
Åages
 = 
	`ex‹Á_node_size_g‘
(
chunk£lm
è>> 
LG_PAGE
;

1568 ià(
İt_purge
 =ğ
purge_mode_deÿy
 && 
¬’a
->
ndœty
 -

1569 (
n¡ashed
 + 
Åages
è< 
ndœty_lim™
)

1572 
chunk£lm_Ãxt
 = 
	`qr_Ãxt
(
chunk£lm
, 
cc_lšk
);

1577 
z”o
 = 
çl£
;

1578 
chunk
 = 
	`chunk_®loc_ÿche
(
tsdn
, 
¬’a
, 
chunk_hooks
,

1579 
	`ex‹Á_node_addr_g‘
(
chunk£lm
),

1580 
	`ex‹Á_node_size_g‘
(
chunk£lm
), 
chunksize
, &
z”o
,

1581 
çl£
);

1582 
	`as£¹
(
chunk
 =ğ
	`ex‹Á_node_addr_g‘
(
chunk£lm
));

1583 
	`as£¹
(
z”o
 =ğ
	`ex‹Á_node_z”Ûd_g‘
(
chunk£lm
));

1584 
	`ex‹Á_node_dœty_š£¹
(
chunk£lm
, 
purge_runs_£Áš–
,

1585 
purge_chunks_£Áš–
);

1586 
	`as£¹
(
Åages
 =ğ(
	`ex‹Á_node_size_g‘
(
chunk£lm
) >>

1587 
LG_PAGE
));

1588 
chunk£lm
 = 
chunk£lm_Ãxt
;

1590 
¬’a_chunk_t
 *
chunk
 =

1591 (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
rd–m
);

1592 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

1593 
	`¬’a_rd_to_misûlm
(
rd–m
);

1594 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1595 
¬’a_run_t
 *
run
 = &
misûlm
->run;

1596 
size_t
 
run_size
 =

1597 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
);

1599 
Åages
 = 
run_size
 >> 
LG_PAGE
;

1600 ià(
İt_purge
 =ğ
purge_mode_deÿy
 && 
¬’a
->
ndœty
 -

1601 (
n¡ashed
 + 
Åages
è< 
ndœty_lim™
)

1604 
	`as£¹
(
·gešd
 + 
Åages
 <ğ
chunk_Åages
);

1605 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
) ==

1606 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
+
Åages
-1));

1612 ià(
chunk
 =ğ
¬’a
->
¥¬e
)

1613 
	`¬’a_chunk_®loc
(
tsdn
, 
¬’a
);

1616 
	`¬’a_run_¥l™_Ïrge
(
¬’a
, 
run
, 
run_size
, 
çl£
);

1618 ià(
çl£
)

1619 
	`qr_Ãw
(
rd–m
, 
rd_lšk
);

1621 
	`as£¹
(
	`qr_Ãxt
(
rd–m
, 
rd_lšk
) ==„delm);

1622 
	`as£¹
(
	`qr_´ev
(
rd–m
, 
rd_lšk
) ==„delm);

1624 
	`qr_m–d
(
purge_runs_£Áš–
, 
rd–m
, 
rd_lšk
);

1627 
n¡ashed
 +ğ
Åages
;

1628 ià(
İt_purge
 =ğ
purge_mode_¿tio
 && 
¬’a
->
ndœty
 - 
n¡ashed
 <=

1629 
ndœty_lim™
)

1633  (
n¡ashed
);

1634 
	}
}

1636 
size_t


1637 
	$¬’a_purge_¡ashed
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

1638 
¬’a_runs_dœty_lšk_t
 *
purge_runs_£Áš–
,

1639 
ex‹Á_node_t
 *
purge_chunks_£Áš–
)

1641 
size_t
 
Åurged
, 
nmadvi£
;

1642 
¬’a_runs_dœty_lšk_t
 *
rd–m
;

1643 
ex‹Á_node_t
 *
chunk£lm
;

1645 ià(
cÚfig_¡©s
)

1646 
nmadvi£
 = 0;

1647 
Åurged
 = 0;

1649 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1650 
rd–m
 = 
	`qr_Ãxt
(
purge_runs_£Áš–
, 
rd_lšk
),

1651 
chunk£lm
 = 
	`qr_Ãxt
(
purge_chunks_£Áš–
, 
cc_lšk
);

1652 
rd–m
 !ğ
purge_runs_£Áš–
;„d–m = 
	`qr_Ãxt
Ôd–m, 
rd_lšk
)) {

1653 
size_t
 
Åages
;

1655 ià(
rd–m
 =ğ&
chunk£lm
->
rd
) {

1664 
size_t
 
size
 = 
	`ex‹Á_node_size_g‘
(
chunk£lm
);

1665 
Åages
 = 
size
 >> 
LG_PAGE
;

1666 
chunk£lm
 = 
	`qr_Ãxt
(chunk£lm, 
cc_lšk
);

1668 
size_t
 
·gešd
, 
run_size
, 
æag_unz”Ûd
, 
æags
, 
i
;

1669 
boŞ
 
decomm™‹d
;

1670 
¬’a_chunk_t
 *
chunk
 =

1671 (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
rd–m
);

1672 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

1673 
	`¬’a_rd_to_misûlm
(
rd–m
);

1674 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1675 
run_size
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
);

1676 
Åages
 = 
run_size
 >> 
LG_PAGE
;

1678 
	`as£¹
(
·gešd
 + 
Åages
 <ğ
chunk_Åages
);

1679 
	`as£¹
(!
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
·gešd
));

1680 
	`as£¹
(!
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
,

1681 
·gešd
+
Åages
-1));

1682 
decomm™‹d
 = !
chunk_hooks
->
	`decomm™
(
chunk
, 
chunksize
,

1683 
·gešd
 << 
LG_PAGE
, 
Åages
 << LG_PAGE, 
¬’a
->
šd
);

1684 ià(
decomm™‹d
) {

1685 
æag_unz”Ûd
 = 0;

1686 
æags
 = 
CHUNK_MAP_DECOMMITTED
;

1688 
æag_unz”Ûd
 = 
	`chunk_purge_w¿µ”
(
tsdn
, 
¬’a
,

1689 
chunk_hooks
, 
chunk
, 
chunksize
, 
·gešd
 <<

1690 
LG_PAGE
, 
run_size
è? 
CHUNK_MAP_UNZEROED
 : 0;

1691 
æags
 = 
æag_unz”Ûd
;

1693 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
Åages
-1, 0,

1694 
æags
);

1695 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
, 
run_size
,

1696 
æags
);

1709 
i
 = 1; i < 
Åages
-1; i++) {

1710 
	`¬’a_m­b™s_š‹º®_£t
(
chunk
, 
·gešd
+
i
,

1711 
æag_unz”Ûd
);

1715 
Åurged
 +ğ
Åages
;

1716 ià(
cÚfig_¡©s
)

1717 
nmadvi£
++;

1719 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1721 ià(
cÚfig_¡©s
) {

1722 
¬’a
->
¡©s
.
nmadvi£
 +=‚madvise;

1723 
¬’a
->
¡©s
.
purged
 +ğ
Åurged
;

1726  (
Åurged
);

1727 
	}
}

1730 
	$¬’a_un¡ash_purged
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

1731 
¬’a_runs_dœty_lšk_t
 *
purge_runs_£Áš–
,

1732 
ex‹Á_node_t
 *
purge_chunks_£Áš–
)

1734 
¬’a_runs_dœty_lšk_t
 *
rd–m
, *
rd–m_Ãxt
;

1735 
ex‹Á_node_t
 *
chunk£lm
;

1738 
rd–m
 = 
	`qr_Ãxt
(
purge_runs_£Áš–
, 
rd_lšk
),

1739 
chunk£lm
 = 
	`qr_Ãxt
(
purge_chunks_£Áš–
, 
cc_lšk
);

1740 
rd–m
 !ğ
purge_runs_£Áš–
;„d–m = 
rd–m_Ãxt
) {

1741 
rd–m_Ãxt
 = 
	`qr_Ãxt
(
rd–m
, 
rd_lšk
);

1742 ià(
rd–m
 =ğ&
chunk£lm
->
rd
) {

1743 
ex‹Á_node_t
 *
chunk£lm_Ãxt
 = 
	`qr_Ãxt
(
chunk£lm
,

1744 
cc_lšk
);

1745 *
addr
 = 
	`ex‹Á_node_addr_g‘
(
chunk£lm
);

1746 
size_t
 
size
 = 
	`ex‹Á_node_size_g‘
(
chunk£lm
);

1747 
boŞ
 
z”Ûd
 = 
	`ex‹Á_node_z”Ûd_g‘
(
chunk£lm
);

1748 
boŞ
 
comm™‹d
 = 
	`ex‹Á_node_comm™‹d_g‘
(
chunk£lm
);

1749 
	`ex‹Á_node_dœty_»move
(
chunk£lm
);

1750 
	`¬’a_node_d®loc
(
tsdn
, 
¬’a
, 
chunk£lm
);

1751 
chunk£lm
 = 
chunk£lm_Ãxt
;

1752 
	`chunk_d®loc_w¿µ”
(
tsdn
, 
¬’a
, 
chunk_hooks
, 
addr
,

1753 
size
, 
z”Ûd
, 
comm™‹d
);

1755 
¬’a_chunk_t
 *
chunk
 =

1756 (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
rd–m
);

1757 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

1758 
	`¬’a_rd_to_misûlm
(
rd–m
);

1759 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1760 
boŞ
 
decomm™‹d
 = (
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
,

1761 
·gešd
) != 0);

1762 
¬’a_run_t
 *
run
 = &
misûlm
->run;

1763 
	`qr_»move
(
rd–m
, 
rd_lšk
);

1764 
	`¬’a_run_d®loc
(
tsdn
, 
¬’a
, 
run
, 
çl£
, 
Œue
,

1765 
decomm™‹d
);

1768 
	}
}

1780 
	$¬’a_purge_to_lim™
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
ndœty_lim™
)

1782 
chunk_hooks_t
 
chunk_hooks
 = 
	`chunk_hooks_g‘
(
tsdn
, 
¬’a
);

1783 
size_t
 
Åurge
, 
Åurged
;

1784 
¬’a_runs_dœty_lšk_t
 
purge_runs_£Áš–
;

1785 
ex‹Á_node_t
 
purge_chunks_£Áš–
;

1787 
¬’a
->
purgšg
 = 
Œue
;

1793 ià(
çl£
 && 
cÚfig_debug
) {

1794 
size_t
 
ndœty
 = 
	`¬’a_dœty_couÁ
(
¬’a
);

1795 
	`as£¹
(
ndœty
 =ğ
¬’a
->ndirty);

1797 
	`as£¹
(
İt_purge
 !ğ
purge_mode_¿tio
 || (
¬’a
->
Çùive
 >>

1798 
¬’a
->
lg_dœty_muÉ
è<‡»Ç->
ndœty
 || 
ndœty_lim™
 == 0);

1800 
	`qr_Ãw
(&
purge_runs_£Áš–
, 
rd_lšk
);

1801 
	`ex‹Á_node_dœty_lškage_š™
(&
purge_chunks_£Áš–
);

1803 
Åurge
 = 
	`¬’a_¡ash_dœty
(
tsdn
, 
¬’a
, &
chunk_hooks
, 
ndœty_lim™
,

1804 &
purge_runs_£Áš–
, &
purge_chunks_£Áš–
);

1805 ià(
Åurge
 == 0)

1806 
Ïb–_»tuº
;

1807 
Åurged
 = 
	`¬’a_purge_¡ashed
(
tsdn
, 
¬’a
, &
chunk_hooks
,

1808 &
purge_runs_£Áš–
, &
purge_chunks_£Áš–
);

1809 
	`as£¹
(
Åurged
 =ğ
Åurge
);

1810 
	`¬’a_un¡ash_purged
(
tsdn
, 
¬’a
, &
chunk_hooks
, &
purge_runs_£Áš–
,

1811 &
purge_chunks_£Áš–
);

1813 ià(
cÚfig_¡©s
)

1814 
¬’a
->
¡©s
.
Åurge
++;

1816 
Ïb–_»tuº
:

1817 
¬’a
->
purgšg
 = 
çl£
;

1818 
	}
}

1821 
	$¬’a_purge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
boŞ
 
®l
)

1824 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

1825 ià(
®l
)

1826 
	`¬’a_purge_to_lim™
(
tsdn
, 
¬’a
, 0);

1828 
	`¬’a_maybe_purge
(
tsdn
, 
¬’a
);

1829 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

1830 
	}
}

1833 
	$¬’a_achunk_´of_»£t
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
)

1835 
size_t
 
·gešd
, 
Åages
;

1837 
	`ÿs£¹
(
cÚfig_´of
);

1838 
	`as£¹
(
İt_´of
);

1844 
·gešd
 = 
m­_bŸs
;…agešd < 
chunk_Åages
;…agešd +ğ
Åages
) {

1845 ià(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0) {

1846 ià(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0) {

1847 *
±r
 = (*)((
ušŒ_t
)
chunk
 + (
·gešd


1848 << 
LG_PAGE
));

1849 
size_t
 
usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
,

1850 
cÚfig_´of
);

1852 
	`´of_ä“
(
tsd
, 
±r
, 
usize
);

1853 
Åages
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

1854 
·gešd
è>> 
LG_PAGE
;

1857 
size_t
 
bššd
 = 
	`¬’a_m­b™s_bššd_g‘
(
chunk
,

1858 
·gešd
);

1859 
¬’a_bš_šfo_t
 *
bš_šfo
 =

1860 &
¬’a_bš_šfo
[
bššd
];

1861 
Åages
 = 
bš_šfo
->
run_size
 >> 
LG_PAGE
;

1865 
Åages
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
,

1866 
·gešd
è>> 
LG_PAGE
;

1868 
	`as£¹
(
·gešd
 + 
Åages
 <ğ
chunk_Åages
);

1870 
	}
}

1873 
	$¬’a_»£t
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
)

1875 
i
;

1876 
ex‹Á_node_t
 *
node
;

1893 ià(
cÚfig_´of
 && 
İt_´of
) {

1894 
	`ql_fÜ—ch
(
node
, &
¬’a
->
achunks
, 
ql_lšk
) {

1895 
	`¬’a_achunk_´of_»£t
(
tsd
, 
¬’a
,

1896 
	`ex‹Á_node_addr_g‘
(
node
));

1901 ià(
cÚfig_¡©s
) {

1902 
i
 = 0; i < 
Æşas£s
; i++)

1903 
¬’a
->
¡©s
.
l¡©s
[
i
].
cu¼uns
 = 0;

1907 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
huge_mtx
);

1908 
node
 = 
	`ql_Ï¡
(&
¬’a
->
huge
, 
ql_lšk
);‚od!ğ
NULL
;‚ode =

1909 
	`ql_Ï¡
(&
¬’a
->
huge
, 
ql_lšk
)) {

1910 *
±r
 = 
	`ex‹Á_node_addr_g‘
(
node
);

1911 
size_t
 
usize
;

1913 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
huge_mtx
);

1914 ià(
cÚfig_¡©s
 || (
cÚfig_´of
 && 
İt_´of
))

1915 
usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
cÚfig_´of
);

1917 ià(
cÚfig_´of
 && 
İt_´of
)

1918 
	`´of_ä“
(
tsd
, 
±r
, 
usize
);

1919 
	`huge_d®loc
(
	`tsd_tsdn
(
tsd
), 
±r
);

1920 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
huge_mtx
);

1922 ià(
cÚfig_¡©s
)

1923 
	`¬’a_huge_»£t_¡©s_ÿnûl
(
¬’a
, 
usize
);

1925 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
huge_mtx
);

1927 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
lock
);

1930 
i
 = 0; i < 
NBINS
; i++) {

1931 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
i
];

1932 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
bš
->
lock
);

1933 
bš
->
runcur
 = 
NULL
;

1934 
	`¬’a_run_h—p_Ãw
(&
bš
->
runs
);

1935 ià(
cÚfig_¡©s
) {

1936 
bš
->
¡©s
.
cu¼egs
 = 0;

1937 
bš
->
¡©s
.
cu¼uns
 = 0;

1939 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
bš
->
lock
);

1946 
	`qr_Ãw
(&
¬’a
->
runs_dœty
, 
rd_lšk
);

1947 
node
 = 
	`qr_Ãxt
(&
¬’a
->
chunks_ÿche
, 
cc_lšk
);

1948 
node
 !ğ&
¬’a
->
chunks_ÿche
;‚odğ
	`qr_Ãxt
Òode, 
cc_lšk
)) {

1949 
	`qr_Ãw
(&
node
->
rd
, 
rd_lšk
);

1950 
	`qr_m–d
(&
¬’a
->
runs_dœty
, &
node
->
rd
, 
rd_lšk
);

1954 
node
 = 
	`ql_Ï¡
(&
¬’a
->
achunks
, 
ql_lšk
);‚od!ğ
NULL
;‚ode =

1955 
	`ql_Ï¡
(&
¬’a
->
achunks
, 
ql_lšk
)) {

1956 
	`ql_»move
(&
¬’a
->
achunks
, 
node
, 
ql_lšk
);

1957 
	`¬’a_chunk_disÿrd
(
	`tsd_tsdn
(
tsd
), 
¬’a
,

1958 
	`ex‹Á_node_addr_g‘
(
node
));

1962 ià(
¬’a
->
¥¬e
 !ğ
NULL
) {

1963 
	`¬’a_chunk_disÿrd
(
	`tsd_tsdn
(
tsd
), 
¬’a
,‡»Ç->
¥¬e
);

1964 
¬’a
->
¥¬e
 = 
NULL
;

1967 
	`as£¹
(!
¬’a
->
purgšg
);

1968 
¬’a
->
Çùive
 = 0;

1970 
i
 = 0; i < 
runs_ava_nşas£s
; i++)

1971 
	`¬’a_run_h—p_Ãw
(&
¬’a
->
runs_ava
[
i
]);

1973 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
lock
);

1974 
	}
}

1977 
	$¬’a_run_cßËsû
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 *
p_size
,

1978 
size_t
 *
p_run_šd
, size_ˆ*
p_run_·ges
, size_ˆ
æag_dœty
,

1979 
size_t
 
æag_decomm™‹d
)

1981 
size_t
 
size
 = *
p_size
;

1982 
size_t
 
run_šd
 = *
p_run_šd
;

1983 
size_t
 
run_·ges
 = *
p_run_·ges
;

1986 ià(
run_šd
 + 
run_·ges
 < 
chunk_Åages
 &&

1987 
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
run_šd
+
run_·ges
) == 0 &&

1988 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
+
run_·ges
è=ğ
æag_dœty
 &&

1989 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
+
run_·ges
) ==

1990 
æag_decomm™‹d
) {

1991 
size_t
 
Äun_size
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
,

1992 
run_šd
+
run_·ges
);

1993 
size_t
 
Äun_·ges
 = 
Äun_size
 >> 
LG_PAGE
;

1999 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
,

2000 
run_šd
+
run_·ges
+
Äun_·ges
-1è=ğ
Äun_size
);

2001 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
,

2002 
run_šd
+
run_·ges
+
Äun_·ges
-1è=ğ
æag_dœty
);

2003 
	`as£¹
(
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
,

2004 
run_šd
+
run_·ges
+
Äun_·ges
-1è=ğ
æag_decomm™‹d
);

2005 
	`¬’a_ava_»move
(
¬’a
, 
chunk
, 
run_šd
+
run_·ges
, 
Äun_·ges
);

2011 ià(
æag_dœty
 != 0) {

2012 
	`¬’a_run_dœty_»move
(
¬’a
, 
chunk
, 
run_šd
+
run_·ges
,

2013 
Äun_·ges
);

2016 
size
 +ğ
Äun_size
;

2017 
run_·ges
 +ğ
Äun_·ges
;

2019 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
chunk
, 
run_šd
, 
size
);

2020 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
chunk
, 
run_šd
+
run_·ges
-1,

2021 
size
);

2025 ià(
run_šd
 > 
m­_bŸs
 && 
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
,

2026 
run_šd
-1è=ğ0 && 
	`¬’a_m­b™s_dœty_g‘
(
chunk
,„un_ind-1) ==

2027 
æag_dœty
 && 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
-1) ==

2028 
æag_decomm™‹d
) {

2029 
size_t
 
´un_size
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
,

2030 
run_šd
-1);

2031 
size_t
 
´un_·ges
 = 
´un_size
 >> 
LG_PAGE
;

2033 
run_šd
 -ğ
´un_·ges
;

2039 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
run_šd
) ==

2040 
´un_size
);

2041 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
è=ğ
æag_dœty
);

2042 
	`as£¹
(
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
) ==

2043 
æag_decomm™‹d
);

2044 
	`¬’a_ava_»move
(
¬’a
, 
chunk
, 
run_šd
, 
´un_·ges
);

2050 ià(
æag_dœty
 != 0) {

2051 
	`¬’a_run_dœty_»move
(
¬’a
, 
chunk
, 
run_šd
,

2052 
´un_·ges
);

2055 
size
 +ğ
´un_size
;

2056 
run_·ges
 +ğ
´un_·ges
;

2058 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
chunk
, 
run_šd
, 
size
);

2059 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
chunk
, 
run_šd
+
run_·ges
-1,

2060 
size
);

2063 *
p_size
 = 
size
;

2064 *
p_run_šd
 = 
run_šd
;

2065 *
p_run_·ges
 = 
run_·ges
;

2066 
	}
}

2068 
size_t


2069 
	$¬’a_run_size_g‘
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
,

2070 
size_t
 
run_šd
)

2072 
size_t
 
size
;

2074 
	`as£¹
(
run_šd
 >ğ
m­_bŸs
);

2075 
	`as£¹
(
run_šd
 < 
chunk_Åages
);

2077 ià(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
run_šd
) != 0) {

2078 
size
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
run_šd
);

2079 
	`as£¹
(
size
 =ğ
PAGE
 || 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

2080 
run_šd
+(
size
>>
LG_PAGE
)-1) == 0);

2082 
¬’a_bš_šfo_t
 *
bš_šfo
 = &
¬’a_bš_šfo
[
run
->
bššd
];

2083 
size
 = 
bš_šfo
->
run_size
;

2086  (
size
);

2087 
	}
}

2090 
	$¬’a_run_d®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
boŞ
 
dœty
,

2091 
boŞ
 
ş—Ãd
, boŞ 
decomm™‹d
)

2093 
¬’a_chunk_t
 *
chunk
;

2094 
¬’a_chunk_m­_misc_t
 *
misûlm
;

2095 
size_t
 
size
, 
run_šd
, 
run_·ges
, 
æag_dœty
, 
æag_decomm™‹d
;

2097 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

2098 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

2099 
run_šd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

2100 
	`as£¹
(
run_šd
 >ğ
m­_bŸs
);

2101 
	`as£¹
(
run_šd
 < 
chunk_Åages
);

2102 
size
 = 
	`¬’a_run_size_g‘
(
¬’a
, 
chunk
, 
run
, 
run_šd
);

2103 
run_·ges
 = (
size
 >> 
LG_PAGE
);

2104 
	`¬’a_Çùive_sub
(
¬’a
, 
run_·ges
);

2111 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
) ==

2112 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

2113 ià(!
ş—Ãd
 && !
decomm™‹d
 && 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
)

2115 
dœty
 = 
Œue
;

2116 
æag_dœty
 = 
dœty
 ? 
CHUNK_MAP_DIRTY
 : 0;

2117 
æag_decomm™‹d
 = 
decomm™‹d
 ? 
CHUNK_MAP_DECOMMITTED
 : 0;

2120 ià(
dœty
 || 
decomm™‹d
) {

2121 
size_t
 
æags
 = 
æag_dœty
 | 
æag_decomm™‹d
;

2122 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
, 
size
, 
æags
);

2123 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
+
run_·ges
-1, 
size
,

2124 
æags
);

2126 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
, 
size
,

2127 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
));

2128 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
+
run_·ges
-1, 
size
,

2129 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

2132 
	`¬’a_run_cßËsû
(
¬’a
, 
chunk
, &
size
, &
run_šd
, &
run_·ges
,

2133 
æag_dœty
, 
æag_decomm™‹d
);

2136 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
run_šd
) ==

2137 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

2138 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
) ==

2139 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

2140 
	`as£¹
(
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
) ==

2141 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

2142 
	`¬’a_ava_š£¹
(
¬’a
, 
chunk
, 
run_šd
, 
run_·ges
);

2144 ià(
dœty
)

2145 
	`¬’a_run_dœty_š£¹
(
¬’a
, 
chunk
, 
run_šd
, 
run_·ges
);

2148 ià(
size
 =ğ
¬’a_maxrun
) {

2149 
	`as£¹
(
run_šd
 =ğ
m­_bŸs
);

2150 
	`as£¹
(
run_·ges
 =ğ(
¬’a_maxrun
 >> 
LG_PAGE
));

2151 
	`¬’a_chunk_d®loc
(
tsdn
, 
¬’a
, 
chunk
);

2161 ià(
dœty
)

2162 
	`¬’a_maybe_purge
(
tsdn
, 
¬’a
);

2163 
	}
}

2166 
	$¬’a_run_Œim_h—d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

2167 
¬’a_run_t
 *
run
, 
size_t
 
Şdsize
, size_ˆ
Ãwsize
)

2169 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

2170 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

2171 
size_t
 
h—d_Åages
 = (
Şdsize
 - 
Ãwsize
è>> 
LG_PAGE
;

2172 
size_t
 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
);

2173 
size_t
 
æag_decomm™‹d
 = 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
·gešd
);

2174 
size_t
 
æag_unz”Ûd_mask
 = (
æag_dœty
 | 
æag_decomm™‹d
) == 0 ?

2175 
CHUNK_MAP_UNZEROED
 : 0;

2177 
	`as£¹
(
Şdsize
 > 
Ãwsize
);

2184 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
è=ğ
Şdsize
);

2185 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
h—d_Åages
-1, 0, 
æag_dœty
 |

2186 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

2187 
·gešd
+
h—d_Åages
-1)));

2188 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
, 
Şdsize
-
Ãwsize
, 
æag_dœty
 |

2189 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
·gešd
)));

2191 ià(
cÚfig_debug
) {

2192 
UNUSED
 
size_t
 
_Åages
 = 
Ãwsize
 >> 
LG_PAGE
;

2193 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

2194 
·gešd
+
h—d_Åages
+
_Åages
-1) == 0);

2195 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
,

2196 
·gešd
+
h—d_Åages
+
_Åages
-1è=ğ
æag_dœty
);

2198 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
h—d_Åages
, 
Ãwsize
,

2199 
æag_dœty
 | (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

2200 
·gešd
+
h—d_Åages
)));

2202 
	`¬’a_run_d®loc
(
tsdn
, 
¬’a
, 
run
, 
çl£
, f®£, (
æag_decomm™‹d
 !=

2204 
	}
}

2207 
	$¬’a_run_Œim_
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

2208 
¬’a_run_t
 *
run
, 
size_t
 
Şdsize
, size_ˆ
Ãwsize
, 
boŞ
 
dœty
)

2210 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

2211 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

2212 
size_t
 
h—d_Åages
 = 
Ãwsize
 >> 
LG_PAGE
;

2213 
size_t
 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
);

2214 
size_t
 
æag_decomm™‹d
 = 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
·gešd
);

2215 
size_t
 
æag_unz”Ûd_mask
 = (
æag_dœty
 | 
æag_decomm™‹d
) == 0 ?

2216 
CHUNK_MAP_UNZEROED
 : 0;

2217 
¬’a_chunk_m­_misc_t
 *
_misûlm
;

2218 
¬’a_run_t
 *
_run
;

2220 
	`as£¹
(
Şdsize
 > 
Ãwsize
);

2227 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
è=ğ
Şdsize
);

2228 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
h—d_Åages
-1, 0, 
æag_dœty
 |

2229 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

2230 
·gešd
+
h—d_Åages
-1)));

2231 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
, 
Ãwsize
, 
æag_dœty
 |

2232 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
·gešd
)));

2234 ià(
cÚfig_debug
) {

2235 
UNUSED
 
size_t
 
_Åages
 = (
Şdsize
 - 
Ãwsize
è>> 
LG_PAGE
;

2236 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

2237 
·gešd
+
h—d_Åages
+
_Åages
-1) == 0);

2238 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
,

2239 
·gešd
+
h—d_Åages
+
_Åages
-1è=ğ
æag_dœty
);

2241 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
h—d_Åages
, 
Şdsize
-
Ãwsize
,

2242 
æag_dœty
 | (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

2243 
·gešd
+
h—d_Åages
)));

2245 
_misûlm
 = 
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
·gešd
 + 
h—d_Åages
);

2246 
_run
 = &
_misûlm
->
run
;

2247 
	`¬’a_run_d®loc
(
tsdn
, 
¬’a
, 
_run
, 
dœty
, 
çl£
, (
æag_decomm™‹d


2249 
	}
}

2252 
	$¬’a_bš_runs_š£¹
(
¬’a_bš_t
 *
bš
, 
¬’a_run_t
 *
run
)

2254 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

2256 
	`¬’a_run_h—p_š£¹
(&
bš
->
runs
, 
misûlm
);

2257 
	}
}

2259 
¬’a_run_t
 *

2260 
	$¬’a_bš_nÚfuÎ_run_Œyg‘
(
¬’a_bš_t
 *
bš
)

2262 
¬’a_chunk_m­_misc_t
 *
misûlm
;

2264 
misûlm
 = 
	`¬’a_run_h—p_»move_fœ¡
(&
bš
->
runs
);

2265 ià(
misûlm
 =ğ
NULL
)

2266  (
NULL
);

2267 ià(
cÚfig_¡©s
)

2268 
bš
->
¡©s
.
»runs
++;

2270  (&
misûlm
->
run
);

2271 
	}
}

2273 
¬’a_run_t
 *

2274 
	$¬’a_bš_nÚfuÎ_run_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_bš_t
 *
bš
)

2276 
¬’a_run_t
 *
run
;

2277 
szšd_t
 
bššd
;

2278 
¬’a_bš_šfo_t
 *
bš_šfo
;

2281 
run
 = 
	`¬’a_bš_nÚfuÎ_run_Œyg‘
(
bš
);

2282 ià(
run
 !ğ
NULL
)

2283  (
run
);

2286 
bššd
 = 
	`¬’a_bš_šdex
(
¬’a
, 
bš
);

2287 
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

2290 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
bš
->
lock
);

2292 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

2293 
run
 = 
	`¬’a_run_®loc_sm®l
(
tsdn
, 
¬’a
, 
bš_šfo
->
run_size
, 
bššd
);

2294 ià(
run
 !ğ
NULL
) {

2296 
run
->
bššd
 = binind;

2297 
run
->
nä“
 = 
bš_šfo
->
Äegs
;

2298 
	`b™m­_š™
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
);

2300 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

2302 
	`m®loc_mu‹x_lock
(
tsdn
, &
bš
->
lock
);

2303 ià(
run
 !ğ
NULL
) {

2304 ià(
cÚfig_¡©s
) {

2305 
bš
->
¡©s
.
Äuns
++;

2306 
bš
->
¡©s
.
cu¼uns
++;

2308  (
run
);

2316 
run
 = 
	`¬’a_bš_nÚfuÎ_run_Œyg‘
(
bš
);

2317 ià(
run
 !ğ
NULL
)

2318  (
run
);

2320  (
NULL
);

2321 
	}
}

2325 
	$¬’a_bš_m®loc_h¬d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_bš_t
 *
bš
)

2327 
szšd_t
 
bššd
;

2328 
¬’a_bš_šfo_t
 *
bš_šfo
;

2329 
¬’a_run_t
 *
run
;

2331 
bššd
 = 
	`¬’a_bš_šdex
(
¬’a
, 
bš
);

2332 
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

2333 
bš
->
runcur
 = 
NULL
;

2334 
run
 = 
	`¬’a_bš_nÚfuÎ_run_g‘
(
tsdn
, 
¬’a
, 
bš
);

2335 ià(
bš
->
runcur
 !ğ
NULL
 && bš->runcur->
nä“
 > 0) {

2340 *
»t
;

2341 
	`as£¹
(
bš
->
runcur
->
nä“
 > 0);

2342 
»t
 = 
	`¬’a_run_»g_®loc
(
bš
->
runcur
, 
bš_šfo
);

2343 ià(
run
 !ğ
NULL
) {

2344 
¬’a_chunk_t
 *
chunk
;

2354 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

2355 ià(
run
->
nä“
 =ğ
bš_šfo
->
Äegs
) {

2356 
	`¬’a_d®loc_bš_run
(
tsdn
, 
¬’a
, 
chunk
, 
run
,

2357 
bš
);

2359 
	`¬’a_bš_low”_run
(
¬’a
, 
chunk
, 
run
, 
bš
);

2361  (
»t
);

2364 ià(
run
 =ğ
NULL
)

2365  (
NULL
);

2367 
bš
->
runcur
 = 
run
;

2369 
	`as£¹
(
bš
->
runcur
->
nä“
 > 0);

2371  (
	`¬’a_run_»g_®loc
(
bš
->
runcur
, 
bš_šfo
));

2372 
	}
}

2375 
	$¬’a_tÿche_fl_sm®l
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
tÿche_bš_t
 *
tbš
,

2376 
szšd_t
 
bššd
, 
ušt64_t
 
´of_accumby‹s
)

2378 
i
, 
nfl
;

2379 
¬’a_bš_t
 *
bš
;

2381 
	`as£¹
(
tbš
->
nÿched
 == 0);

2383 ià(
cÚfig_´of
 && 
	`¬’a_´of_accum
(
tsdn
, 
¬’a
, 
´of_accumby‹s
))

2384 
	`´of_idump
(
tsdn
);

2385 
bš
 = &
¬’a
->
bšs
[
bššd
];

2386 
	`m®loc_mu‹x_lock
(
tsdn
, &
bš
->
lock
);

2387 
i
 = 0, 
nfl
 = (
tÿche_bš_šfo
[
bššd
].
nÿched_max
 >>

2388 
tbš
->
lg_fl_div
); 
i
 < 
nfl
; i++) {

2389 
¬’a_run_t
 *
run
;

2390 *
±r
;

2391 ià((
run
 = 
bš
->
runcur
è!ğ
NULL
 &&„un->
nä“
 > 0)

2392 
±r
 = 
	`¬’a_run_»g_®loc
(
run
, &
¬’a_bš_šfo
[
bššd
]);

2394 
±r
 = 
	`¬’a_bš_m®loc_h¬d
(
tsdn
, 
¬’a
, 
bš
);

2395 ià(
±r
 =ğ
NULL
) {

2401 ià(
i
 > 0) {

2402 
	`memmove
(
tbš
->
ava
 - 
i
,bš->ava - 
nfl
,

2403 
i
 * (*));

2407 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

2408 
	`¬’a_®loc_junk_sm®l
(
±r
, &
¬’a_bš_šfo
[
bššd
],

2409 
Œue
);

2412 *(
tbš
->
ava
 - 
nfl
 + 
i
èğ
±r
;

2414 ià(
cÚfig_¡©s
) {

2415 
bš
->
¡©s
.
nm®loc
 +ğ
i
;

2416 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

2417 
bš
->
¡©s
.
cu¼egs
 +ğ
i
;

2418 
bš
->
¡©s
.
nfls
++;

2419 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

2421 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
bš
->
lock
);

2422 
tbš
->
nÿched
 = 
i
;

2423 
	`¬’a_deÿy_tick
(
tsdn
, 
¬’a
);

2424 
	}
}

2427 
	$¬’a_®loc_junk_sm®l
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
, 
boŞ
 
z”o
)

2430 
size_t
 
»dzÚe_size
 = 
bš_šfo
->redzone_size;

2432 ià(
z”o
) {

2433 
	`mem£t
((*)((
ušŒ_t
)
±r
 - 
»dzÚe_size
),

2434 
JEMALLOC_ALLOC_JUNK
, 
»dzÚe_size
);

2435 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
bš_šfo
->
»g_size
),

2436 
JEMALLOC_ALLOC_JUNK
, 
»dzÚe_size
);

2438 
	`mem£t
((*)((
ušŒ_t
)
±r
 - 
»dzÚe_size
),

2439 
JEMALLOC_ALLOC_JUNK
, 
bš_šfo
->
»g_š‹rv®
);

2441 
	}
}

2443 #ifdeà
JEMALLOC_JET


2444 #undeà
¬’a_»dzÚe_cÜru±iÚ


2445 
	#¬’a_»dzÚe_cÜru±iÚ
 
	`JEMALLOC_N
(
n_¬’a_»dzÚe_cÜru±iÚ
)

	)

2448 
	$¬’a_»dzÚe_cÜru±iÚ
(*
±r
, 
size_t
 
usize
, 
boŞ
 
aá”
,

2449 
size_t
 
off£t
, 
ušt8_t
 
by‹
)

2452 
	`m®loc_´štf
("<jemalloc>: Corrupt„edzone %zu byte%s %s %p "

2453 "(siz%zu), by‹=%#x\n", 
off£t
, (offset == 1) ? "" : "s",

2454 
aá”
 ? "aá”" : "befÜe", 
±r
, 
usize
, 
by‹
);

2455 
	}
}

2456 #ifdeà
JEMALLOC_JET


2457 #undeà
¬’a_»dzÚe_cÜru±iÚ


2458 
	#¬’a_»dzÚe_cÜru±iÚ
 
	`JEMALLOC_N
(
¬’a_»dzÚe_cÜru±iÚ
)

	)

2459 
¬’a_»dzÚe_cÜru±iÚ_t
 *
	g¬’a_»dzÚe_cÜru±iÚ
 =

2460 
JEMALLOC_N
(
n_¬’a_»dzÚe_cÜru±iÚ
);

2464 
	$¬’a_»dzÚes_v®id©e
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
, 
boŞ
 
»£t
)

2466 
boŞ
 
”rÜ
 = 
çl£
;

2468 ià(
İt_junk_®loc
) {

2469 
size_t
 
size
 = 
bš_šfo
->
»g_size
;

2470 
size_t
 
»dzÚe_size
 = 
bš_šfo
->redzone_size;

2471 
size_t
 
i
;

2473 
i
 = 1; i <ğ
»dzÚe_size
; i++) {

2474 
ušt8_t
 *
by‹
 = (ušt8_ˆ*)((
ušŒ_t
)
±r
 - 
i
);

2475 ià(*
by‹
 !ğ
JEMALLOC_ALLOC_JUNK
) {

2476 
”rÜ
 = 
Œue
;

2477 
	`¬’a_»dzÚe_cÜru±iÚ
(
±r
, 
size
, 
çl£
, 
i
,

2478 *
by‹
);

2479 ià(
»£t
)

2480 *
by‹
 = 
JEMALLOC_ALLOC_JUNK
;

2483 
i
 = 0; i < 
»dzÚe_size
; i++) {

2484 
ušt8_t
 *
by‹
 = (ušt8_ˆ*)((
ušŒ_t
)
±r
 + 
size
 + 
i
);

2485 ià(*
by‹
 !ğ
JEMALLOC_ALLOC_JUNK
) {

2486 
”rÜ
 = 
Œue
;

2487 
	`¬’a_»dzÚe_cÜru±iÚ
(
±r
, 
size
, 
Œue
, 
i
,

2488 *
by‹
);

2489 ià(
»£t
)

2490 *
by‹
 = 
JEMALLOC_ALLOC_JUNK
;

2495 ià(
İt_abÜt
 && 
”rÜ
)

2496 
	`abÜt
();

2497 
	}
}

2499 #ifdeà
JEMALLOC_JET


2500 #undeà
¬’a_d®loc_junk_sm®l


2501 
	#¬’a_d®loc_junk_sm®l
 
	`JEMALLOC_N
(
n_¬’a_d®loc_junk_sm®l
)

	)

2504 
	$¬’a_d®loc_junk_sm®l
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
)

2506 
size_t
 
»dzÚe_size
 = 
bš_šfo
->redzone_size;

2508 
	`¬’a_»dzÚes_v®id©e
(
±r
, 
bš_šfo
, 
çl£
);

2509 
	`mem£t
((*)((
ušŒ_t
)
±r
 - 
»dzÚe_size
), 
JEMALLOC_FREE_JUNK
,

2510 
bš_šfo
->
»g_š‹rv®
);

2511 
	}
}

2512 #ifdeà
JEMALLOC_JET


2513 #undeà
¬’a_d®loc_junk_sm®l


2514 
	#¬’a_d®loc_junk_sm®l
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_sm®l
)

	)

2515 
¬’a_d®loc_junk_sm®l_t
 *
	g¬’a_d®loc_junk_sm®l
 =

2516 
JEMALLOC_N
(
n_¬’a_d®loc_junk_sm®l
);

2520 
	$¬’a_qu¬ªtše_junk_sm®l
(*
±r
, 
size_t
 
usize
)

2522 
szšd_t
 
bššd
;

2523 
¬’a_bš_šfo_t
 *
bš_šfo
;

2524 
	`ÿs£¹
(
cÚfig_fl
);

2525 
	`as£¹
(
İt_junk_ä“
);

2526 
	`as£¹
(
İt_qu¬ªtše
);

2527 
	`as£¹
(
usize
 <ğ
SMALL_MAXCLASS
);

2529 
bššd
 = 
	`size2šdex
(
usize
);

2530 
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

2531 
	`¬’a_»dzÚes_v®id©e
(
±r
, 
bš_šfo
, 
Œue
);

2532 
	}
}

2535 
	$¬’a_m®loc_sm®l
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
szšd_t
 
bššd
, 
boŞ
 
z”o
)

2537 *
»t
;

2538 
¬’a_bš_t
 *
bš
;

2539 
size_t
 
usize
;

2540 
¬’a_run_t
 *
run
;

2542 
	`as£¹
(
bššd
 < 
NBINS
);

2543 
bš
 = &
¬’a
->
bšs
[
bššd
];

2544 
usize
 = 
	`šdex2size
(
bššd
);

2546 
	`m®loc_mu‹x_lock
(
tsdn
, &
bš
->
lock
);

2547 ià((
run
 = 
bš
->
runcur
è!ğ
NULL
 &&„un->
nä“
 > 0)

2548 
»t
 = 
	`¬’a_run_»g_®loc
(
run
, &
¬’a_bš_šfo
[
bššd
]);

2550 
»t
 = 
	`¬’a_bš_m®loc_h¬d
(
tsdn
, 
¬’a
, 
bš
);

2552 ià(
»t
 =ğ
NULL
) {

2553 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
bš
->
lock
);

2554  (
NULL
);

2557 ià(
cÚfig_¡©s
) {

2558 
bš
->
¡©s
.
nm®loc
++;

2559 
bš
->
¡©s
.
Äeque¡s
++;

2560 
bš
->
¡©s
.
cu¼egs
++;

2562 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
bš
->
lock
);

2563 ià(
cÚfig_´of
 && !
i¡h»aded
 && 
	`¬’a_´of_accum
(
tsdn
, 
¬’a
, 
usize
))

2564 
	`´of_idump
(
tsdn
);

2566 ià(!
z”o
) {

2567 ià(
cÚfig_fl
) {

2568 ià(
	`uÆik–y
(
İt_junk_®loc
)) {

2569 
	`¬’a_®loc_junk_sm®l
(
»t
,

2570 &
¬’a_bš_šfo
[
bššd
], 
çl£
);

2571 } ià(
	`uÆik–y
(
İt_z”o
))

2572 
	`mem£t
(
»t
, 0, 
usize
);

2574 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
usize
);

2576 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

2577 
	`¬’a_®loc_junk_sm®l
(
»t
, &
¬’a_bš_šfo
[
bššd
],

2578 
Œue
);

2580 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
usize
);

2581 
	`mem£t
(
»t
, 0, 
usize
);

2584 
	`¬’a_deÿy_tick
(
tsdn
, 
¬’a
);

2585  (
»t
);

2586 
	}
}

2589 
	$¬’a_m®loc_Ïrge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
szšd_t
 
bššd
, 
boŞ
 
z”o
)

2591 *
»t
;

2592 
size_t
 
usize
;

2593 
ušŒ_t
 
¿ndom_off£t
;

2594 
¬’a_run_t
 *
run
;

2595 
¬’a_chunk_m­_misc_t
 *
misûlm
;

2596 
UNUSED
 
boŞ
 
idump
 
	`JEMALLOC_CC_SILENCE_INIT
(
çl£
);

2599 
usize
 = 
	`šdex2size
(
bššd
);

2600 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

2601 ià(
cÚfig_ÿche_oblivious
) {

2602 
ušt64_t
 
r
;

2609 
r
 = 
	`´ng_lg_¿nge
(&
¬’a
->
off£t_¡©e
, 
LG_PAGE
 - 
LG_CACHELINE
);

2610 
¿ndom_off£t
 = ((
ušŒ_t
)
r
è<< 
LG_CACHELINE
;

2612 
¿ndom_off£t
 = 0;

2613 
run
 = 
	`¬’a_run_®loc_Ïrge
(
tsdn
, 
¬’a
, 
usize
 + 
Ïrge_·d
, 
z”o
);

2614 ià(
run
 =ğ
NULL
) {

2615 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

2616  (
NULL
);

2618 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

2619 
»t
 = (*)((
ušŒ_t
)
	`¬’a_misûlm_to_½ages
(
misûlm
) +

2620 
¿ndom_off£t
);

2621 ià(
cÚfig_¡©s
) {

2622 
szšd_t
 
šdex
 = 
bššd
 - 
NBINS
;

2624 
¬’a
->
¡©s
.
nm®loc_Ïrge
++;

2625 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
++;

2626 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 +ğ
usize
;

2627 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nm®loc
++;

2628 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
Äeque¡s
++;

2629 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
++;

2631 ià(
cÚfig_´of
)

2632 
idump
 = 
	`¬’a_´of_accum_locked
(
¬’a
, 
usize
);

2633 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

2634 ià(
cÚfig_´of
 && 
idump
)

2635 
	`´of_idump
(
tsdn
);

2637 ià(!
z”o
) {

2638 ià(
cÚfig_fl
) {

2639 ià(
	`uÆik–y
(
İt_junk_®loc
))

2640 
	`mem£t
(
»t
, 
JEMALLOC_ALLOC_JUNK
, 
usize
);

2641 ià(
	`uÆik–y
(
İt_z”o
))

2642 
	`mem£t
(
»t
, 0, 
usize
);

2646 
	`¬’a_deÿy_tick
(
tsdn
, 
¬’a
);

2647  (
»t
);

2648 
	}
}

2651 
	$¬’a_m®loc_h¬d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
szšd_t
 
šd
,

2652 
boŞ
 
z”o
)

2655 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
è|| 
¬’a
 !ğ
NULL
);

2657 ià(
	`lik–y
(!
	`tsdn_nuÎ
(
tsdn
)))

2658 
¬’a
 = 
	`¬’a_choo£
(
	`tsdn_tsd
(
tsdn
),‡rena);

2659 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

2660  (
NULL
);

2662 ià(
	`lik–y
(
size
 <ğ
SMALL_MAXCLASS
))

2663  (
	`¬’a_m®loc_sm®l
(
tsdn
, 
¬’a
, 
šd
, 
z”o
));

2664 ià(
	`lik–y
(
size
 <ğ
Ïrge_maxşass
))

2665  (
	`¬’a_m®loc_Ïrge
(
tsdn
, 
¬’a
, 
šd
, 
z”o
));

2666  (
	`huge_m®loc
(
tsdn
, 
¬’a
, 
	`šdex2size
(
šd
), 
z”o
));

2667 
	}
}

2671 
	$¬’a_·Îoc_Ïrge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
, size_ˆ
®ignm’t
,

2672 
boŞ
 
z”o
)

2674 *
»t
;

2675 
size_t
 
®loc_size
, 
Ëadsize
, 
Œasize
;

2676 
¬’a_run_t
 *
run
;

2677 
¬’a_chunk_t
 *
chunk
;

2678 
¬’a_chunk_m­_misc_t
 *
misûlm
;

2679 *
½ages
;

2681 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
è|| 
¬’a
 !ğ
NULL
);

2682 
	`as£¹
(
usize
 =ğ
	`PAGE_CEILING
(usize));

2684 ià(
	`lik–y
(!
	`tsdn_nuÎ
(
tsdn
)))

2685 
¬’a
 = 
	`¬’a_choo£
(
	`tsdn_tsd
(
tsdn
),‡rena);

2686 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

2687  (
NULL
);

2689 
®ignm’t
 = 
	`PAGE_CEILING
(alignment);

2690 
®loc_size
 = 
usize
 + 
Ïrge_·d
 + 
®ignm’t
;

2692 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

2693 
run
 = 
	`¬’a_run_®loc_Ïrge
(
tsdn
, 
¬’a
, 
®loc_size
, 
çl£
);

2694 ià(
run
 =ğ
NULL
) {

2695 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

2696  (
NULL
);

2698 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

2699 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

2700 
½ages
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

2702 
Ëadsize
 = 
	`ALIGNMENT_CEILING
((
ušŒ_t
)
½ages
, 
®ignm’t
) -

2703 (
ušŒ_t
)
½ages
;

2704 
	`as£¹
(
®loc_size
 >ğ
Ëadsize
 + 
usize
);

2705 
Œasize
 = 
®loc_size
 - 
Ëadsize
 - 
usize
 - 
Ïrge_·d
;

2706 ià(
Ëadsize
 != 0) {

2707 
¬’a_chunk_m­_misc_t
 *
h—d_misûlm
 = 
misûlm
;

2708 
¬’a_run_t
 *
h—d_run
 = 
run
;

2710 
misûlm
 = 
	`¬’a_misûlm_g‘_mubË
(
chunk
,

2711 
	`¬’a_misûlm_to_·gešd
(
h—d_misûlm
è+ (
Ëadsize
 >>

2712 
LG_PAGE
));

2713 
run
 = &
misûlm
->run;

2715 
	`¬’a_run_Œim_h—d
(
tsdn
, 
¬’a
, 
chunk
, 
h—d_run
, 
®loc_size
,

2716 
®loc_size
 - 
Ëadsize
);

2718 ià(
Œasize
 != 0) {

2719 
	`¬’a_run_Œim_
(
tsdn
, 
¬’a
, 
chunk
, 
run
, 
usize
 + 
Ïrge_·d
 +

2720 
Œasize
, 
usize
 + 
Ïrge_·d
, 
çl£
);

2722 ià(
	`¬’a_run_š™_Ïrge
(
¬’a
, 
run
, 
usize
 + 
Ïrge_·d
, 
z”o
)) {

2723 
size_t
 
run_šd
 =

2724 
	`¬’a_misûlm_to_·gešd
(
	`¬’a_run_to_misûlm
(
run
));

2725 
boŞ
 
dœty
 = (
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
) != 0);

2726 
boŞ
 
decomm™‹d
 = (
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
,

2727 
run_šd
) != 0);

2729 
	`as£¹
(
decomm™‹d
);

2730 
	`¬’a_run_d®loc
(
tsdn
, 
¬’a
, 
run
, 
dœty
, 
çl£
, 
decomm™‹d
);

2731 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

2732  (
NULL
);

2734 
»t
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

2736 ià(
cÚfig_¡©s
) {

2737 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
NBINS
;

2739 
¬’a
->
¡©s
.
nm®loc_Ïrge
++;

2740 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
++;

2741 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 +ğ
usize
;

2742 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nm®loc
++;

2743 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
Äeque¡s
++;

2744 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
++;

2746 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

2748 ià(
cÚfig_fl
 && !
z”o
) {

2749 ià(
	`uÆik–y
(
İt_junk_®loc
))

2750 
	`mem£t
(
»t
, 
JEMALLOC_ALLOC_JUNK
, 
usize
);

2751 ià(
	`uÆik–y
(
İt_z”o
))

2752 
	`mem£t
(
»t
, 0, 
usize
);

2754 
	`¬’a_deÿy_tick
(
tsdn
, 
¬’a
);

2755  (
»t
);

2756 
	}
}

2759 
	$¬’a_·Îoc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
, size_ˆ
®ignm’t
,

2760 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

2762 *
»t
;

2764 ià(
usize
 <ğ
SMALL_MAXCLASS
 && (
®ignm’t
 < 
PAGE
 || (alignment == PAGE

2765 && (
usize
 & 
PAGE_MASK
) == 0))) {

2767 
»t
 = 
	`¬’a_m®loc
(
tsdn
, 
¬’a
, 
usize
, 
	`size2šdex
(usize), 
z”o
,

2768 
tÿche
, 
Œue
);

2769 } ià(
usize
 <ğ
Ïrge_maxşass
 && 
®ignm’t
 <ğ
PAGE
) {

2776 
»t
 = 
	`¬’a_m®loc
(
tsdn
, 
¬’a
, 
usize
, 
	`size2šdex
(usize), 
z”o
,

2777 
tÿche
, 
Œue
);

2778 ià(
cÚfig_ÿche_oblivious
)

2779 
»t
 = (*)((
ušŒ_t
ì‘ & ~
PAGE_MASK
);

2781 ià(
	`lik–y
(
usize
 <ğ
Ïrge_maxşass
)) {

2782 
»t
 = 
	`¬’a_·Îoc_Ïrge
(
tsdn
, 
¬’a
, 
usize
, 
®ignm’t
,

2783 
z”o
);

2784 } ià(
	`lik–y
(
®ignm’t
 <ğ
chunksize
))

2785 
»t
 = 
	`huge_m®loc
(
tsdn
, 
¬’a
, 
usize
, 
z”o
);

2787 
»t
 = 
	`huge_·Îoc
(
tsdn
, 
¬’a
, 
usize
, 
®ignm’t
, 
z”o
);

2790  (
»t
);

2791 
	}
}

2794 
	$¬’a_´of_´omÙed
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
size
)

2796 
¬’a_chunk_t
 *
chunk
;

2797 
size_t
 
·gešd
;

2798 
szšd_t
 
bššd
;

2800 
	`ÿs£¹
(
cÚfig_´of
);

2801 
	`as£¹
(
±r
 !ğ
NULL
);

2802 
	`as£¹
(
	`CHUNK_ADDR2BASE
(
±r
) !=…tr);

2803 
	`as£¹
(
	`i§Îoc
(
tsdn
, 
±r
, 
çl£
è=ğ
LARGE_MINCLASS
);

2804 
	`as£¹
(
	`i§Îoc
(
tsdn
, 
±r
, 
Œue
è=ğ
LARGE_MINCLASS
);

2805 
	`as£¹
(
size
 <ğ
SMALL_MAXCLASS
);

2807 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

2808 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

2809 
bššd
 = 
	`size2šdex
(
size
);

2810 
	`as£¹
(
bššd
 < 
NBINS
);

2811 
	`¬’a_m­b™s_Ïrge_bššd_£t
(
chunk
, 
·gešd
, 
bššd
);

2813 
	`as£¹
(
	`i§Îoc
(
tsdn
, 
±r
, 
çl£
è=ğ
LARGE_MINCLASS
);

2814 
	`as£¹
(
	`i§Îoc
(
tsdn
, 
±r
, 
Œue
è=ğ
size
);

2815 
	}
}

2818 
	$¬’a_dissocŸ‹_bš_run
(
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
,

2819 
¬’a_bš_t
 *
bš
)

2823 ià(
run
 =ğ
bš
->
runcur
)

2824 
bš
->
runcur
 = 
NULL
;

2826 
szšd_t
 
bššd
 = 
	`¬’a_bš_šdex
(
	`ex‹Á_node_¬’a_g‘
(

2827 &
chunk
->
node
), 
bš
);

2828 
¬’a_bš_šfo_t
 *
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

2835 ià(
bš_šfo
->
Äegs
 != 1) {

2836 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

2837 
	`¬’a_run_to_misûlm
(
run
);

2839 
	`¬’a_run_h—p_»move
(&
bš
->
runs
, 
misûlm
);

2842 
	}
}

2845 
	$¬’a_d®loc_bš_run
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

2846 
¬’a_run_t
 *
run
, 
¬’a_bš_t
 *
bš
)

2849 
	`as£¹
(
run
 !ğ
bš
->
runcur
);

2851 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
bš
->
lock
);

2853 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

2854 
	`¬’a_run_d®loc
(
tsdn
, 
¬’a
, 
run
, 
Œue
, 
çl£
, false);

2855 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

2857 
	`m®loc_mu‹x_lock
(
tsdn
, &
bš
->
lock
);

2858 ià(
cÚfig_¡©s
)

2859 
bš
->
¡©s
.
cu¼uns
--;

2860 
	}
}

2863 
	$¬’a_bš_low”_run
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
,

2864 
¬’a_bš_t
 *
bš
)

2872 ià((
ušŒ_t
)
run
 < (ušŒ_t)
bš
->
runcur
) {

2874 ià(
bš
->
runcur
->
nä“
 > 0)

2875 
	`¬’a_bš_runs_š£¹
(
bš
, bš->
runcur
);

2876 
bš
->
runcur
 = 
run
;

2877 ià(
cÚfig_¡©s
)

2878 
bš
->
¡©s
.
»runs
++;

2880 
	`¬’a_bš_runs_š£¹
(
bš
, 
run
);

2881 
	}
}

2884 
	$¬’a_d®loc_bš_locked_im¶
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

2885 *
±r
, 
¬’a_chunk_m­_b™s_t
 *
b™£lm
, 
boŞ
 
junked
)

2887 
size_t
 
·gešd
, 
½ages_šd
;

2888 
¬’a_run_t
 *
run
;

2889 
¬’a_bš_t
 *
bš
;

2890 
¬’a_bš_šfo_t
 *
bš_šfo
;

2891 
szšd_t
 
bššd
;

2893 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

2894 
½ages_šd
 = 
·gešd
 - 
	`¬’a_m­b™s_sm®l_runšd_g‘
(
chunk
,…ageind);

2895 
run
 = &
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
½ages_šd
)->run;

2896 
bššd
 = 
run
->binind;

2897 
bš
 = &
¬’a
->
bšs
[
bššd
];

2898 
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

2900 ià(!
junked
 && 
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
))

2901 
	`¬’a_d®loc_junk_sm®l
(
±r
, 
bš_šfo
);

2903 
	`¬’a_run_»g_d®loc
(
run
, 
±r
);

2904 ià(
run
->
nä“
 =ğ
bš_šfo
->
Äegs
) {

2905 
	`¬’a_dissocŸ‹_bš_run
(
chunk
, 
run
, 
bš
);

2906 
	`¬’a_d®loc_bš_run
(
tsdn
, 
¬’a
, 
chunk
, 
run
, 
bš
);

2907 } ià(
run
->
nä“
 =ğ1 &&„uÀ!ğ
bš
->
runcur
)

2908 
	`¬’a_bš_low”_run
(
¬’a
, 
chunk
, 
run
, 
bš
);

2910 ià(
cÚfig_¡©s
) {

2911 
bš
->
¡©s
.
nd®loc
++;

2912 
bš
->
¡©s
.
cu¼egs
--;

2914 
	}
}

2917 
	$¬’a_d®loc_bš_junked_locked
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

2918 
¬’a_chunk_t
 *
chunk
, *
±r
, 
¬’a_chunk_m­_b™s_t
 *
b™£lm
)

2921 
	`¬’a_d®loc_bš_locked_im¶
(
tsdn
, 
¬’a
, 
chunk
, 
±r
, 
b™£lm
, 
Œue
);

2922 
	}
}

2925 
	$¬’a_d®loc_bš
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
,

2926 
size_t
 
·gešd
, 
¬’a_chunk_m­_b™s_t
 *
b™£lm
)

2928 
¬’a_run_t
 *
run
;

2929 
¬’a_bš_t
 *
bš
;

2930 
size_t
 
½ages_šd
;

2932 
½ages_šd
 = 
·gešd
 - 
	`¬’a_m­b™s_sm®l_runšd_g‘
(
chunk
,…ageind);

2933 
run
 = &
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
½ages_šd
)->run;

2934 
bš
 = &
¬’a
->
bšs
[
run
->
bššd
];

2935 
	`m®loc_mu‹x_lock
(
tsdn
, &
bš
->
lock
);

2936 
	`¬’a_d®loc_bš_locked_im¶
(
tsdn
, 
¬’a
, 
chunk
, 
±r
, 
b™£lm
, 
çl£
);

2937 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
bš
->
lock
);

2938 
	}
}

2941 
	$¬’a_d®loc_sm®l
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

2942 *
±r
, 
size_t
 
·gešd
)

2944 
¬’a_chunk_m­_b™s_t
 *
b™£lm
;

2946 ià(
cÚfig_debug
) {

2948 
	`as£¹
(
	`¬’a_±r_sm®l_bššd_g‘
(
±r
, 
	`¬’a_m­b™s_g‘
(
chunk
,

2949 
·gešd
)è!ğ
BININD_INVALID
);

2951 
b™£lm
 = 
	`¬’a_b™£lm_g‘_mubË
(
chunk
, 
·gešd
);

2952 
	`¬’a_d®loc_bš
(
tsdn
, 
¬’a
, 
chunk
, 
±r
, 
·gešd
, 
b™£lm
);

2953 
	`¬’a_deÿy_tick
(
tsdn
, 
¬’a
);

2954 
	}
}

2956 #ifdeà
JEMALLOC_JET


2957 #undeà
¬’a_d®loc_junk_Ïrge


2958 
	#¬’a_d®loc_junk_Ïrge
 
	`JEMALLOC_N
(
n_¬’a_d®loc_junk_Ïrge
)

	)

2961 
	$¬’a_d®loc_junk_Ïrge
(*
±r
, 
size_t
 
usize
)

2964 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
))

2965 
	`mem£t
(
±r
, 
JEMALLOC_FREE_JUNK
, 
usize
);

2966 
	}
}

2967 #ifdeà
JEMALLOC_JET


2968 #undeà
¬’a_d®loc_junk_Ïrge


2969 
	#¬’a_d®loc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_Ïrge
)

	)

2970 
¬’a_d®loc_junk_Ïrge_t
 *
	g¬’a_d®loc_junk_Ïrge
 =

2971 
JEMALLOC_N
(
n_¬’a_d®loc_junk_Ïrge
);

2975 
	$¬’a_d®loc_Ïrge_locked_im¶
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

2976 
¬’a_chunk_t
 *
chunk
, *
±r
, 
boŞ
 
junked
)

2978 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

2979 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_misûlm_g‘_mubË
(
chunk
,

2980 
·gešd
);

2981 
¬’a_run_t
 *
run
 = &
misûlm
->run;

2983 ià(
cÚfig_fl
 || 
cÚfig_¡©s
) {

2984 
size_t
 
usize
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
) -

2985 
Ïrge_·d
;

2987 ià(!
junked
)

2988 
	`¬’a_d®loc_junk_Ïrge
(
±r
, 
usize
);

2989 ià(
cÚfig_¡©s
) {

2990 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
NBINS
;

2992 
¬’a
->
¡©s
.
nd®loc_Ïrge
++;

2993 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 -ğ
usize
;

2994 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nd®loc
++;

2995 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
--;

2999 
	`¬’a_run_d®loc
(
tsdn
, 
¬’a
, 
run
, 
Œue
, 
çl£
, false);

3000 
	}
}

3003 
	$¬’a_d®loc_Ïrge_junked_locked
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

3004 
¬’a_chunk_t
 *
chunk
, *
±r
)

3007 
	`¬’a_d®loc_Ïrge_locked_im¶
(
tsdn
, 
¬’a
, 
chunk
, 
±r
, 
Œue
);

3008 
	}
}

3011 
	$¬’a_d®loc_Ïrge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

3012 *
±r
)

3015 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

3016 
	`¬’a_d®loc_Ïrge_locked_im¶
(
tsdn
, 
¬’a
, 
chunk
, 
±r
, 
çl£
);

3017 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

3018 
	`¬’a_deÿy_tick
(
tsdn
, 
¬’a
);

3019 
	}
}

3022 
	$¬’a_¿Îoc_Ïrge_shršk
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

3023 *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
)

3025 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

3026 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_misûlm_g‘_mubË
(
chunk
,

3027 
·gešd
);

3028 
¬’a_run_t
 *
run
 = &
misûlm
->run;

3030 
	`as£¹
(
size
 < 
Şdsize
);

3036 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

3037 
	`¬’a_run_Œim_
(
tsdn
, 
¬’a
, 
chunk
, 
run
, 
Şdsize
 + 
Ïrge_·d
, 
size
 +

3038 
Ïrge_·d
, 
Œue
);

3039 ià(
cÚfig_¡©s
) {

3040 
szšd_t
 
Şdšdex
 = 
	`size2šdex
(
Şdsize
è- 
NBINS
;

3041 
szšd_t
 
šdex
 = 
	`size2šdex
(
size
è- 
NBINS
;

3043 
¬’a
->
¡©s
.
nd®loc_Ïrge
++;

3044 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 -ğ
Şdsize
;

3045 
¬’a
->
¡©s
.
l¡©s
[
Şdšdex
].
nd®loc
++;

3046 
¬’a
->
¡©s
.
l¡©s
[
Şdšdex
].
cu¼uns
--;

3048 
¬’a
->
¡©s
.
nm®loc_Ïrge
++;

3049 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
++;

3050 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 +ğ
size
;

3051 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nm®loc
++;

3052 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
Äeque¡s
++;

3053 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
++;

3055 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

3056 
	}
}

3058 
boŞ


3059 
	$¬’a_¿Îoc_Ïrge_grow
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

3060 *
±r
, 
size_t
 
Şdsize
, size_ˆ
usize_mš
, size_ˆ
usize_max
, 
boŞ
 
z”o
)

3062 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

3063 
size_t
 
Åages
 = (
Şdsize
 + 
Ïrge_·d
è>> 
LG_PAGE
;

3064 
size_t
 
fŞlowsize
;

3066 
	`as£¹
(
Şdsize
 =ğ
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
) -

3067 
Ïrge_·d
);

3070 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

3071 ià(
·gešd
+
Åages
 >ğ
chunk_Åages
 || 
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
,

3072 
·gešd
+
Åages
) != 0)

3073 
Ïb–_ç
;

3074 
fŞlowsize
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
+
Åages
);

3075 ià(
Şdsize
 + 
fŞlowsize
 >ğ
usize_mš
) {

3081 
¬’a_run_t
 *
run
;

3082 
size_t
 
usize
, 
¥l™size
, 
size
, 
æag_dœty
, 
æag_unz”Ûd_mask
;

3084 
usize
 = 
usize_max
;

3085 
Şdsize
 + 
fŞlowsize
 < 
usize
)

3086 
usize
 = 
	`šdex2size
(
	`size2šdex
(usize)-1);

3087 
	`as£¹
(
usize
 >ğ
usize_mš
);

3088 
	`as£¹
(
usize
 >ğ
Şdsize
);

3089 
¥l™size
 = 
usize
 - 
Şdsize
;

3090 ià(
¥l™size
 == 0)

3091 
Ïb–_ç
;

3093 
run
 = &
	`¬’a_misûlm_g‘_mubË
(
chunk
, 
·gešd
+
Åages
)->run;

3094 ià(
	`¬’a_run_¥l™_Ïrge
(
¬’a
, 
run
, 
¥l™size
, 
z”o
))

3095 
Ïb–_ç
;

3097 ià(
cÚfig_ÿche_oblivious
 && 
z”o
) {

3105 *
zba£
 = (*)((
ušŒ_t
)
±r
 + 
Şdsize
);

3106 *
z·¡
 = 
	`PAGE_ADDR2BASE
((*)((
ušŒ_t
)
zba£
 +

3107 
PAGE
));

3108 
size_t
 
nz”o
 = (
ušŒ_t
)
z·¡
 - (ušŒ_t)
zba£
;

3109 
	`as£¹
(
nz”o
 > 0);

3110 
	`mem£t
(
zba£
, 0, 
nz”o
);

3113 
size
 = 
Şdsize
 + 
¥l™size
;

3114 
Åages
 = (
size
 + 
Ïrge_·d
è>> 
LG_PAGE
;

3124 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
) |

3125 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
+
Åages
-1);

3126 
æag_unz”Ûd_mask
 = 
æag_dœty
 =ğ0 ? 
CHUNK_MAP_UNZEROED
 : 0;

3127 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
, 
size
 + 
Ïrge_·d
,

3128 
æag_dœty
 | (
æag_unz”Ûd_mask
 &

3129 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
·gešd
)));

3130 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
Åages
-1, 0, 
æag_dœty
 |

3131 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

3132 
·gešd
+
Åages
-1)));

3134 ià(
cÚfig_¡©s
) {

3135 
szšd_t
 
Şdšdex
 = 
	`size2šdex
(
Şdsize
è- 
NBINS
;

3136 
szšd_t
 
šdex
 = 
	`size2šdex
(
size
è- 
NBINS
;

3138 
¬’a
->
¡©s
.
nd®loc_Ïrge
++;

3139 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 -ğ
Şdsize
;

3140 
¬’a
->
¡©s
.
l¡©s
[
Şdšdex
].
nd®loc
++;

3141 
¬’a
->
¡©s
.
l¡©s
[
Şdšdex
].
cu¼uns
--;

3143 
¬’a
->
¡©s
.
nm®loc_Ïrge
++;

3144 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
++;

3145 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 +ğ
size
;

3146 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nm®loc
++;

3147 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
Äeque¡s
++;

3148 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
++;

3150 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

3151  (
çl£
);

3153 
Ïb–_ç
:

3154 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

3155  (
Œue
);

3156 
	}
}

3158 #ifdeà
JEMALLOC_JET


3159 #undeà
¬’a_¿Îoc_junk_Ïrge


3160 
	#¬’a_¿Îoc_junk_Ïrge
 
	`JEMALLOC_N
(
n_¬’a_¿Îoc_junk_Ïrge
)

	)

3163 
	$¬’a_¿Îoc_junk_Ïrge
(*
±r
, 
size_t
 
Şd_usize
, size_ˆ
usize
)

3166 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

3167 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
usize
), 
JEMALLOC_FREE_JUNK
,

3168 
Şd_usize
 - 
usize
);

3170 
	}
}

3171 #ifdeà
JEMALLOC_JET


3172 #undeà
¬’a_¿Îoc_junk_Ïrge


3173 
	#¬’a_¿Îoc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_¿Îoc_junk_Ïrge
)

	)

3174 
¬’a_¿Îoc_junk_Ïrge_t
 *
	g¬’a_¿Îoc_junk_Ïrge
 =

3175 
JEMALLOC_N
(
n_¬’a_¿Îoc_junk_Ïrge
);

3182 
boŞ


3183 
	$¬’a_¿Îoc_Ïrge
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
usize_mš
,

3184 
size_t
 
usize_max
, 
boŞ
 
z”o
)

3186 
¬’a_chunk_t
 *
chunk
;

3187 
¬’a_t
 *
¬’a
;

3189 ià(
Şdsize
 =ğ
usize_max
) {

3191  (
çl£
);

3194 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

3195 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
);

3197 ià(
Şdsize
 < 
usize_max
) {

3198 
boŞ
 
»t
 = 
	`¬’a_¿Îoc_Ïrge_grow
(
tsdn
, 
¬’a
, 
chunk
, 
±r
,

3199 
Şdsize
, 
usize_mš
, 
usize_max
, 
z”o
);

3200 ià(
cÚfig_fl
 && !
»t
 && !
z”o
) {

3201 ià(
	`uÆik–y
(
İt_junk_®loc
)) {

3202 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
),

3203 
JEMALLOC_ALLOC_JUNK
,

3204 
	`i§Îoc
(
tsdn
, 
±r
, 
cÚfig_´of
è- 
Şdsize
);

3205 } ià(
	`uÆik–y
(
İt_z”o
)) {

3206 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0,

3207 
	`i§Îoc
(
tsdn
, 
±r
, 
cÚfig_´of
è- 
Şdsize
);

3210  (
»t
);

3213 
	`as£¹
(
Şdsize
 > 
usize_max
);

3215 
	`¬’a_¿Îoc_junk_Ïrge
(
±r
, 
Şdsize
, 
usize_max
);

3216 
	`¬’a_¿Îoc_Ïrge_shršk
(
tsdn
, 
¬’a
, 
chunk
, 
±r
, 
Şdsize
, 
usize_max
);

3217  (
çl£
);

3218 
	}
}

3220 
boŞ


3221 
	$¬’a_¿Îoc_no_move
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

3222 
size_t
 
exŒa
, 
boŞ
 
z”o
)

3224 
size_t
 
usize_mš
, 
usize_max
;

3227 
	`as£¹
(
exŒa
 =ğ0 || 
size
 +ƒxŒ¨<ğ
HUGE_MAXCLASS
);

3229 ià(
	`uÆik–y
(
size
 > 
HUGE_MAXCLASS
))

3230  (
Œue
);

3232 
usize_mš
 = 
	`s2u
(
size
);

3233 
usize_max
 = 
	`s2u
(
size
 + 
exŒa
);

3234 ià(
	`lik–y
(
Şdsize
 <ğ
Ïrge_maxşass
 && 
usize_mš
 <=†arge_maxclass)) {

3235 
¬’a_chunk_t
 *
chunk
;

3241 ià(
Şdsize
 <ğ
SMALL_MAXCLASS
) {

3242 
	`as£¹
(
¬’a_bš_šfo
[
	`size2šdex
(
Şdsize
)].
»g_size
 ==

3243 
Şdsize
);

3244 ià((
usize_max
 > 
SMALL_MAXCLASS
 ||

3245 
	`size2šdex
(
usize_max
è!ğsize2šdex(
Şdsize
)) &&

3246 (
size
 > 
Şdsize
 || 
usize_max
 < oldsize))

3247  (
Œue
);

3249 ià(
usize_max
 <ğ
SMALL_MAXCLASS
)

3250  (
Œue
);

3251 ià(
	`¬’a_¿Îoc_Ïrge
(
tsdn
, 
±r
, 
Şdsize
, 
usize_mš
,

3252 
usize_max
, 
z”o
))

3253  (
Œue
);

3256 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

3257 
	`¬’a_deÿy_tick
(
tsdn
, 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
));

3258  (
çl£
);

3260  (
	`huge_¿Îoc_no_move
(
tsdn
, 
±r
, 
Şdsize
, 
usize_mš
,

3261 
usize_max
, 
z”o
));

3263 
	}
}

3266 
	$¬’a_¿Îoc_move_h–³r
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
,

3267 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

3270 ià(
®ignm’t
 == 0)

3271  (
	`¬’a_m®loc
(
tsdn
, 
¬’a
, 
usize
, 
	`size2šdex
(usize),

3272 
z”o
, 
tÿche
, 
Œue
));

3273 
usize
 = 
	`§2u
(usize, 
®ignm’t
);

3274 ià(
	`uÆik–y
(
usize
 =ğ0 || usiz> 
HUGE_MAXCLASS
))

3275  (
NULL
);

3276  (
	`®loù
(
tsdn
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
));

3277 
	}
}

3280 
	$¬’a_¿Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

3281 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

3283 *
»t
;

3284 
size_t
 
usize
;

3286 
usize
 = 
	`s2u
(
size
);

3287 ià(
	`uÆik–y
(
usize
 =ğ0 || 
size
 > 
HUGE_MAXCLASS
))

3288  (
NULL
);

3290 ià(
	`lik–y
(
usize
 <ğ
Ïrge_maxşass
)) {

3291 
size_t
 
cİysize
;

3294 ià(!
	`¬’a_¿Îoc_no_move
(
	`tsd_tsdn
(
tsd
), 
±r
, 
Şdsize
, 
usize
, 0,

3295 
z”o
))

3296  (
±r
);

3303 
»t
 = 
	`¬’a_¿Îoc_move_h–³r
(
	`tsd_tsdn
(
tsd
), 
¬’a
, 
usize
,

3304 
®ignm’t
, 
z”o
, 
tÿche
);

3305 ià(
»t
 =ğ
NULL
)

3306  (
NULL
);

3313 
cİysize
 = (
usize
 < 
Şdsize
) ? usize : oldsize;

3314 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
cİysize
);

3315 
	`memıy
(
»t
, 
±r
, 
cİysize
);

3316 
	`isq®loc
(
tsd
, 
±r
, 
Şdsize
, 
tÿche
, 
Œue
);

3318 
»t
 = 
	`huge_¿Îoc
(
tsd
, 
¬’a
, 
±r
, 
Şdsize
, 
usize
, 
®ignm’t
,

3319 
z”o
, 
tÿche
);

3321  (
»t
);

3322 
	}
}

3324 
dss_´ec_t


3325 
	$¬’a_dss_´ec_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

3327 
dss_´ec_t
 
»t
;

3329 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

3330 
»t
 = 
¬’a
->
dss_´ec
;

3331 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

3332  (
»t
);

3333 
	}
}

3335 
boŞ


3336 
	$¬’a_dss_´ec_£t
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
dss_´ec_t
 
dss_´ec
)

3339 ià(!
have_dss
)

3340  (
dss_´ec
 !ğ
dss_´ec_di§bËd
);

3341 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

3342 
¬’a
->
dss_´ec
 = dss_prec;

3343 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

3344  (
çl£
);

3345 
	}
}

3347 
ssize_t


3348 
	$¬’a_lg_dœty_muÉ_deçuÉ_g‘
()

3351  ((
ssize_t
)
	`©omic_»ad_z
((
size_t
 *)&
lg_dœty_muÉ_deçuÉ
));

3352 
	}
}

3354 
boŞ


3355 
	$¬’a_lg_dœty_muÉ_deçuÉ_£t
(
ssize_t
 
lg_dœty_muÉ
)

3358 ià(
İt_purge
 !ğ
purge_mode_¿tio
)

3359  (
Œue
);

3360 ià(!
	`¬’a_lg_dœty_muÉ_v®id
(
lg_dœty_muÉ
))

3361  (
Œue
);

3362 
	`©omic_wr™e_z
((
size_t
 *)&
lg_dœty_muÉ_deçuÉ
, (size_t)
lg_dœty_muÉ
);

3363  (
çl£
);

3364 
	}
}

3366 
ssize_t


3367 
	$¬’a_deÿy_time_deçuÉ_g‘
()

3370  ((
ssize_t
)
	`©omic_»ad_z
((
size_t
 *)&
deÿy_time_deçuÉ
));

3371 
	}
}

3373 
boŞ


3374 
	$¬’a_deÿy_time_deçuÉ_£t
(
ssize_t
 
deÿy_time
)

3377 ià(
İt_purge
 !ğ
purge_mode_deÿy
)

3378  (
Œue
);

3379 ià(!
	`¬’a_deÿy_time_v®id
(
deÿy_time
))

3380  (
Œue
);

3381 
	`©omic_wr™e_z
((
size_t
 *)&
deÿy_time_deçuÉ
, (size_t)
deÿy_time
);

3382  (
çl£
);

3383 
	}
}

3386 
	$¬’a_basic_¡©s_m”ge_locked
(
¬’a_t
 *
¬’a
, *
Áh»ads
,

3387 cÚ¡ **
dss
, 
ssize_t
 *
lg_dœty_muÉ
, ssize_ˆ*
deÿy_time
,

3388 
size_t
 *
Çùive
, size_ˆ*
ndœty
)

3391 *
Áh»ads
 +ğ
	`¬’a_Áh»ads_g‘
(
¬’a
, 
çl£
);

3392 *
dss
 = 
dss_´ec_Çmes
[
¬’a
->
dss_´ec
];

3393 *
lg_dœty_muÉ
 = 
¬’a
->lg_dirty_mult;

3394 *
deÿy_time
 = 
¬’a
->decay_time;

3395 *
Çùive
 +ğ
¬’a
->nactive;

3396 *
ndœty
 +ğ
¬’a
->ndirty;

3397 
	}
}

3400 
	$¬’a_basic_¡©s_m”ge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
Áh»ads
,

3401 cÚ¡ **
dss
, 
ssize_t
 *
lg_dœty_muÉ
, ssize_ˆ*
deÿy_time
,

3402 
size_t
 *
Çùive
, size_ˆ*
ndœty
)

3405 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

3406 
	`¬’a_basic_¡©s_m”ge_locked
(
¬’a
, 
Áh»ads
, 
dss
, 
lg_dœty_muÉ
,

3407 
deÿy_time
, 
Çùive
, 
ndœty
);

3408 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

3409 
	}
}

3412 
	$¬’a_¡©s_m”ge
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
Áh»ads
,

3413 cÚ¡ **
dss
, 
ssize_t
 *
lg_dœty_muÉ
, ssize_ˆ*
deÿy_time
,

3414 
size_t
 *
Çùive
, size_ˆ*
ndœty
, 
¬’a_¡©s_t
 *
a¡©s
,

3415 
m®loc_bš_¡©s_t
 *
b¡©s
, 
m®loc_Ïrge_¡©s_t
 *
l¡©s
,

3416 
m®loc_huge_¡©s_t
 *
h¡©s
)

3418 
i
;

3420 
	`ÿs£¹
(
cÚfig_¡©s
);

3422 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

3423 
	`¬’a_basic_¡©s_m”ge_locked
(
¬’a
, 
Áh»ads
, 
dss
, 
lg_dœty_muÉ
,

3424 
deÿy_time
, 
Çùive
, 
ndœty
);

3426 
a¡©s
->
m­³d
 +ğ
¬’a
->
¡©s
.mapped;

3427 
a¡©s
->
»šed
 +ğ
¬’a
->
¡©s
.retained;

3428 
a¡©s
->
Åurge
 +ğ
¬’a
->
¡©s
.npurge;

3429 
a¡©s
->
nmadvi£
 +ğ
¬’a
->
¡©s
.nmadvise;

3430 
a¡©s
->
purged
 +ğ
¬’a
->
¡©s
.purged;

3431 
a¡©s
->
m‘ad©a_m­³d
 +ğ
¬’a
->
¡©s
.metadata_mapped;

3432 
a¡©s
->
m‘ad©a_®loÿ‹d
 +ğ
	`¬’a_m‘ad©a_®loÿ‹d_g‘
(
¬’a
);

3433 
a¡©s
->
®loÿ‹d_Ïrge
 +ğ
¬’a
->
¡©s
.allocated_large;

3434 
a¡©s
->
nm®loc_Ïrge
 +ğ
¬’a
->
¡©s
.nmalloc_large;

3435 
a¡©s
->
nd®loc_Ïrge
 +ğ
¬’a
->
¡©s
.ndalloc_large;

3436 
a¡©s
->
Äeque¡s_Ïrge
 +ğ
¬’a
->
¡©s
.nrequests_large;

3437 
a¡©s
->
®loÿ‹d_huge
 +ğ
¬’a
->
¡©s
.allocated_huge;

3438 
a¡©s
->
nm®loc_huge
 +ğ
¬’a
->
¡©s
.nmalloc_huge;

3439 
a¡©s
->
nd®loc_huge
 +ğ
¬’a
->
¡©s
.ndalloc_huge;

3441 
i
 = 0; i < 
Æşas£s
; i++) {

3442 
l¡©s
[
i
].
nm®loc
 +ğ
¬’a
->
¡©s
.lstats[i].nmalloc;

3443 
l¡©s
[
i
].
nd®loc
 +ğ
¬’a
->
¡©s
.lstats[i].ndalloc;

3444 
l¡©s
[
i
].
Äeque¡s
 +ğ
¬’a
->
¡©s
.lstats[i].nrequests;

3445 
l¡©s
[
i
].
cu¼uns
 +ğ
¬’a
->
¡©s
.lstats[i].curruns;

3448 
i
 = 0; i < 
nhşas£s
; i++) {

3449 
h¡©s
[
i
].
nm®loc
 +ğ
¬’a
->
¡©s
.hstats[i].nmalloc;

3450 
h¡©s
[
i
].
nd®loc
 +ğ
¬’a
->
¡©s
.hstats[i].ndalloc;

3451 
h¡©s
[
i
].
curhchunks
 +ğ
¬’a
->
¡©s
.hstats[i].curhchunks;

3453 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

3455 
i
 = 0; i < 
NBINS
; i++) {

3456 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
i
];

3458 
	`m®loc_mu‹x_lock
(
tsdn
, &
bš
->
lock
);

3459 
b¡©s
[
i
].
nm®loc
 +ğ
bš
->
¡©s
.nmalloc;

3460 
b¡©s
[
i
].
nd®loc
 +ğ
bš
->
¡©s
.ndalloc;

3461 
b¡©s
[
i
].
Äeque¡s
 +ğ
bš
->
¡©s
.nrequests;

3462 
b¡©s
[
i
].
cu¼egs
 +ğ
bš
->
¡©s
.curregs;

3463 ià(
cÚfig_tÿche
) {

3464 
b¡©s
[
i
].
nfls
 +ğ
bš
->
¡©s
.nfills;

3465 
b¡©s
[
i
].
næushes
 +ğ
bš
->
¡©s
.nflushes;

3467 
b¡©s
[
i
].
Äuns
 +ğ
bš
->
¡©s
.nruns;

3468 
b¡©s
[
i
].
»runs
 +ğ
bš
->
¡©s
.reruns;

3469 
b¡©s
[
i
].
cu¼uns
 +ğ
bš
->
¡©s
.curruns;

3470 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
bš
->
lock
);

3472 
	}
}

3475 
	$¬’a_Áh»ads_g‘
(
¬’a_t
 *
¬’a
, 
boŞ
 
š‹º®
)

3478  (
	`©omic_»ad_u
(&
¬’a
->
Áh»ads
[
š‹º®
]));

3479 
	}
}

3482 
	$¬’a_Áh»ads_šc
(
¬’a_t
 *
¬’a
, 
boŞ
 
š‹º®
)

3485 
	`©omic_add_u
(&
¬’a
->
Áh»ads
[
š‹º®
], 1);

3486 
	}
}

3489 
	$¬’a_Áh»ads_dec
(
¬’a_t
 *
¬’a
, 
boŞ
 
š‹º®
)

3492 
	`©omic_sub_u
(&
¬’a
->
Áh»ads
[
š‹º®
], 1);

3493 
	}
}

3495 
¬’a_t
 *

3496 
	$¬’a_Ãw
(
tsdn_t
 *
tsdn
, 
šd
)

3498 
¬’a_t
 *
¬’a
;

3499 
size_t
 
¬’a_size
;

3500 
i
;

3503 
¬’a_size
 = 
	`off£tof
(
¬’a_t
, 
runs_ava
è+ ((
¬’a_run_h—p_t
) *

3504 
runs_ava_nşas£s
);

3509 ià(
cÚfig_¡©s
) {

3510 
¬’a
 = (
¬’a_t
 *)
	`ba£_®loc
(
tsdn
,

3511 
	`CACHELINE_CEILING
(
¬’a_size
è+ 
	`QUANTUM_CEILING
(
Æşas£s
 *

3512 (
m®loc_Ïrge_¡©s_t
è+ 
nhşas£s
) *

3513 (
m®loc_huge_¡©s_t
));

3515 
¬’a
 = (
¬’a_t
 *)
	`ba£_®loc
(
tsdn
, 
¬’a_size
);

3516 ià(
¬’a
 =ğ
NULL
)

3517  (
NULL
);

3519 
¬’a
->
šd
 = ind;

3520 
¬’a
->
Áh»ads
[0] =‡rena->nthreads[1] = 0;

3521 ià(
	`m®loc_mu‹x_š™
(&
¬’a
->
lock
, "¬’a", 
WITNESS_RANK_ARENA
))

3522  (
NULL
);

3524 ià(
cÚfig_¡©s
) {

3525 
	`mem£t
(&
¬’a
->
¡©s
, 0, (
¬’a_¡©s_t
));

3526 
¬’a
->
¡©s
.
l¡©s
 = (
m®loc_Ïrge_¡©s_t
 *)((
ušŒ_t
)arena

3527 + 
	`CACHELINE_CEILING
(
¬’a_size
));

3528 
	`mem£t
(
¬’a
->
¡©s
.
l¡©s
, 0, 
Æşas£s
 *

3529 (
m®loc_Ïrge_¡©s_t
));

3530 
¬’a
->
¡©s
.
h¡©s
 = (
m®loc_huge_¡©s_t
 *)((
ušŒ_t
)arena

3531 + 
	`CACHELINE_CEILING
(
¬’a_size
) +

3532 
	`QUANTUM_CEILING
(
Æşas£s
 * (
m®loc_Ïrge_¡©s_t
)));

3533 
	`mem£t
(
¬’a
->
¡©s
.
h¡©s
, 0, 
nhşas£s
 *

3534 (
m®loc_huge_¡©s_t
));

3535 ià(
cÚfig_tÿche
)

3536 
	`ql_Ãw
(&
¬’a
->
tÿche_ql
);

3539 ià(
cÚfig_´of
)

3540 
¬’a
->
´of_accumby‹s
 = 0;

3542 ià(
cÚfig_ÿche_oblivious
) {

3550 
¬’a
->
off£t_¡©e
 = 
cÚfig_debug
 ? 
šd
 :

3551 (
ušt64_t
)(
ušŒ_t
)
¬’a
;

3554 
¬’a
->
dss_´ec
 = 
	`chunk_dss_´ec_g‘
(
tsdn
);

3556 
	`ql_Ãw
(&
¬’a
->
achunks
);

3558 
¬’a
->
¥¬e
 = 
NULL
;

3560 
¬’a
->
lg_dœty_muÉ
 = 
	`¬’a_lg_dœty_muÉ_deçuÉ_g‘
();

3561 
¬’a
->
purgšg
 = 
çl£
;

3562 
¬’a
->
Çùive
 = 0;

3563 
¬’a
->
ndœty
 = 0;

3565 
i
 = 0; i < 
runs_ava_nşas£s
; i++)

3566 
	`¬’a_run_h—p_Ãw
(&
¬’a
->
runs_ava
[
i
]);

3567 
	`qr_Ãw
(&
¬’a
->
runs_dœty
, 
rd_lšk
);

3568 
	`qr_Ãw
(&
¬’a
->
chunks_ÿche
, 
cc_lšk
);

3570 ià(
İt_purge
 =ğ
purge_mode_deÿy
)

3571 
	`¬’a_deÿy_š™
(
¬’a
, 
	`¬’a_deÿy_time_deçuÉ_g‘
());

3573 
	`ql_Ãw
(&
¬’a
->
huge
);

3574 ià(
	`m®loc_mu‹x_š™
(&
¬’a
->
huge_mtx
, "arena_huge",

3575 
WITNESS_RANK_ARENA_HUGE
))

3576  (
NULL
);

3578 
	`ex‹Á_Œ“_szad_Ãw
(&
¬’a
->
chunks_szad_ÿched
);

3579 
	`ex‹Á_Œ“_ad_Ãw
(&
¬’a
->
chunks_ad_ÿched
);

3580 
	`ex‹Á_Œ“_szad_Ãw
(&
¬’a
->
chunks_szad_»šed
);

3581 
	`ex‹Á_Œ“_ad_Ãw
(&
¬’a
->
chunks_ad_»šed
);

3582 ià(
	`m®loc_mu‹x_š™
(&
¬’a
->
chunks_mtx
, "arena_chunks",

3583 
WITNESS_RANK_ARENA_CHUNKS
))

3584  (
NULL
);

3585 
	`ql_Ãw
(&
¬’a
->
node_ÿche
);

3586 ià(
	`m®loc_mu‹x_š™
(&
¬’a
->
node_ÿche_mtx
, "arena_node_cache",

3587 
WITNESS_RANK_ARENA_NODE_CACHE
))

3588  (
NULL
);

3590 
¬’a
->
chunk_hooks
 = 
chunk_hooks_deçuÉ
;

3593 
i
 = 0; i < 
NBINS
; i++) {

3594 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
i
];

3595 ià(
	`m®loc_mu‹x_š™
(&
bš
->
lock
, "arena_bin",

3596 
WITNESS_RANK_ARENA_BIN
))

3597  (
NULL
);

3598 
bš
->
runcur
 = 
NULL
;

3599 
	`¬’a_run_h—p_Ãw
(&
bš
->
runs
);

3600 ià(
cÚfig_¡©s
)

3601 
	`mem£t
(&
bš
->
¡©s
, 0, (
m®loc_bš_¡©s_t
));

3604  (
¬’a
);

3605 
	}
}

3617 
	$bš_šfo_run_size_ÿlc
(
¬’a_bš_šfo_t
 *
bš_šfo
)

3619 
size_t
 
·d_size
;

3620 
size_t
 
Œy_run_size
, 
³rãù_run_size
, 
aùu®_run_size
;

3621 
ušt32_t
 
Œy_Äegs
, 
³rãù_Äegs
, 
aùu®_Äegs
;

3630 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_»dzÚe
)) {

3631 
size_t
 
®ign_mš
 = 
	`ZU
(1è<< (
	`ffs_zu
(
bš_šfo
->
»g_size
) - 1);

3632 ià(
®ign_mš
 <ğ
REDZONE_MINSIZE
) {

3633 
bš_šfo
->
»dzÚe_size
 = 
REDZONE_MINSIZE
;

3634 
·d_size
 = 0;

3636 
bš_šfo
->
»dzÚe_size
 = 
®ign_mš
 >> 1;

3637 
·d_size
 = 
bš_šfo
->
»dzÚe_size
;

3640 
bš_šfo
->
»dzÚe_size
 = 0;

3641 
·d_size
 = 0;

3643 
bš_šfo
->
»g_š‹rv®
 = bš_šfo->
»g_size
 +

3644 (
bš_šfo
->
»dzÚe_size
 << 1);

3650 
Œy_run_size
 = 
PAGE
;

3651 
Œy_Äegs
 = (
ušt32_t
)(
Œy_run_size
 / 
bš_šfo
->
»g_size
);

3653 
³rãù_run_size
 = 
Œy_run_size
;

3654 
³rãù_Äegs
 = 
Œy_Äegs
;

3656 
Œy_run_size
 +ğ
PAGE
;

3657 
Œy_Äegs
 = (
ušt32_t
)(
Œy_run_size
 / 
bš_šfo
->
»g_size
);

3658 } 
³rãù_run_size
 !ğ
³rãù_Äegs
 * 
bš_šfo
->
»g_size
);

3659 
	`as£¹
(
³rãù_Äegs
 <ğ
RUN_MAXREGS
);

3661 
aùu®_run_size
 = 
³rãù_run_size
;

3662 
aùu®_Äegs
 = (
ušt32_t
)((
aùu®_run_size
 - 
·d_size
) /

3663 
bš_šfo
->
»g_š‹rv®
);

3671 
aùu®_Äegs
 == 0) {

3672 
	`as£¹
(
cÚfig_fl
 && 
	`uÆik–y
(
İt_»dzÚe
));

3674 
aùu®_run_size
 +ğ
PAGE
;

3675 
aùu®_Äegs
 = (
ušt32_t
)((
aùu®_run_size
 - 
·d_size
) /

3676 
bš_šfo
->
»g_š‹rv®
);

3682 
aùu®_run_size
 > 
¬’a_maxrun
) {

3683 
aùu®_run_size
 -ğ
PAGE
;

3684 
aùu®_Äegs
 = (
ušt32_t
)((
aùu®_run_size
 - 
·d_size
) /

3685 
bš_šfo
->
»g_š‹rv®
);

3687 
	`as£¹
(
aùu®_Äegs
 > 0);

3688 
	`as£¹
(
aùu®_run_size
 =ğ
	`s2u
(actual_run_size));

3691 
bš_šfo
->
run_size
 = 
aùu®_run_size
;

3692 
bš_šfo
->
Äegs
 = 
aùu®_Äegs
;

3693 
bš_šfo
->
»g0_off£t
 = (
ušt32_t
)(
aùu®_run_size
 - (
aùu®_Äegs
 *

3694 
bš_šfo
->
»g_š‹rv®
è- 
·d_size
 + bš_šfo->
»dzÚe_size
);

3696 ià(
aùu®_run_size
 > 
sm®l_maxrun
)

3697 
sm®l_maxrun
 = 
aùu®_run_size
;

3699 
	`as£¹
(
bš_šfo
->
»g0_off£t
 - bš_šfo->
»dzÚe_size
 + (bš_šfo->
Äegs


3700 * 
bš_šfo
->
»g_š‹rv®
è+ 
·d_size
 =ğbš_šfo->
run_size
);

3701 
	}
}

3704 
	$bš_šfo_š™
()

3706 
¬’a_bš_šfo_t
 *
bš_šfo
;

3708 
	#BIN_INFO_INIT_bš_yes
(
šdex
, 
size
) \

3709 
bš_šfo
 = &
¬’a_bš_šfo
[
šdex
]; \

3710 
bš_šfo
->
»g_size
 = 
size
; \

3711 
	`bš_šfo_run_size_ÿlc
(
bš_šfo
); \

3712 
	`b™m­_šfo_š™
(&
bš_šfo
->
b™m­_šfo
, bš_šfo->
Äegs
);

	)

3713 
	#BIN_INFO_INIT_bš_no
(
šdex
, 
size
)

	)

3714 
	#SC
(
šdex
, 
lg_g½
, 
lg_d–
, 
nd–
, 
bš
, 
lg_d–_lookup
) \

3715 
BIN_INFO_INIT_bš_
##
	`bš
(
šdex
, (
	`ZU
(1)<<
lg_g½
è+ (ZU(
nd–
)<<
lg_d–
))

	)

3716 
SIZE_CLASSES


3717 #undeà
BIN_INFO_INIT_bš_yes


3718 #undeà
BIN_INFO_INIT_bš_no


3719 #undeà
SC


3720 
	}
}

3722 
boŞ


3723 
	$sm®l_run_size_š™
()

3726 
	`as£¹
(
sm®l_maxrun
 != 0);

3728 
sm®l_run_b
 = (
boŞ
 *)
	`ba£_®loc
(
NULL
, (boŞè* (
sm®l_maxrun
 >>

3729 
LG_PAGE
));

3730 ià(
sm®l_run_b
 =ğ
NULL
)

3731  (
Œue
);

3733 
	#TAB_INIT_bš_yes
(
šdex
, 
size
) { \

3734 
¬’a_bš_šfo_t
 *
bš_šfo
 = &
¬’a_bš_šfo
[
šdex
]; \

3735 
sm®l_run_b
[
bš_šfo
->
run_size
 >> 
LG_PAGE
] = 
Œue
; \

3736 }

	)

3737 
	#TAB_INIT_bš_no
(
šdex
, 
size
)

	)

3738 
	#SC
(
šdex
, 
lg_g½
, 
lg_d–
, 
nd–
, 
bš
, 
lg_d–_lookup
) \

3739 
TAB_INIT_bš_
##
	`bš
(
šdex
, (
	`ZU
(1)<<
lg_g½
è+ (ZU(
nd–
)<<
lg_d–
))

	)

3740 
SIZE_CLASSES


3741 #undeà
TAB_INIT_bš_yes


3742 #undeà
TAB_INIT_bš_no


3743 #undeà
SC


3745  (
çl£
);

3746 
	}
}

3748 
boŞ


3749 
	$run_quªtize_š™
()

3751 
i
;

3753 
run_quªtize_max
 = 
chunksize
 + 
Ïrge_·d
;

3755 
run_quªtize_æoÜ_b
 = (
size_t
 *)
	`ba£_®loc
(
NULL
, (size_t) *

3756 (
run_quªtize_max
 >> 
LG_PAGE
));

3757 ià(
run_quªtize_æoÜ_b
 =ğ
NULL
)

3758  (
Œue
);

3760 
run_quªtize_û_b
 = (
size_t
 *)
	`ba£_®loc
(
NULL
, (size_t) *

3761 (
run_quªtize_max
 >> 
LG_PAGE
));

3762 ià(
run_quªtize_û_b
 =ğ
NULL
)

3763  (
Œue
);

3765 
i
 = 1; i <ğ
run_quªtize_max
 >> 
LG_PAGE
; i++) {

3766 
size_t
 
run_size
 = 
i
 << 
LG_PAGE
;

3768 
run_quªtize_æoÜ_b
[
i
-1] =

3769 
	`run_quªtize_æoÜ_compu‹
(
run_size
);

3770 
run_quªtize_û_b
[
i
-1] =

3771 
	`run_quªtize_û_compu‹
(
run_size
);

3774  (
çl£
);

3775 
	}
}

3777 
boŞ


3778 
	$¬’a_boÙ
()

3780 
i
;

3782 
	`¬’a_lg_dœty_muÉ_deçuÉ_£t
(
İt_lg_dœty_muÉ
);

3783 
	`¬’a_deÿy_time_deçuÉ_£t
(
İt_deÿy_time
);

3797 
m­_bŸs
 = 0;

3798 
i
 = 0; i < 3; i++) {

3799 
size_t
 
h—d”_size
 = 
	`off£tof
(
¬’a_chunk_t
, 
m­_b™s
) +

3800 (((
¬’a_chunk_m­_b™s_t
) +

3801 (
¬’a_chunk_m­_misc_t
)è* (
chunk_Åages
-
m­_bŸs
));

3802 
m­_bŸs
 = (
h—d”_size
 + 
PAGE_MASK
è>> 
LG_PAGE
;

3804 
	`as£¹
(
m­_bŸs
 > 0);

3806 
m­_misc_off£t
 = 
	`off£tof
(
¬’a_chunk_t
, 
m­_b™s
) +

3807 (
¬’a_chunk_m­_b™s_t
è* (
chunk_Åages
-
m­_bŸs
);

3809 
¬’a_maxrun
 = 
chunksize
 - (
m­_bŸs
 << 
LG_PAGE
);

3810 
	`as£¹
(
¬’a_maxrun
 > 0);

3811 
Ïrge_maxşass
 = 
	`šdex2size
(
	`size2šdex
(
chunksize
)-1);

3812 ià(
Ïrge_maxşass
 > 
¬’a_maxrun
) {

3818 
Ïrge_maxşass
 = 
¬’a_maxrun
;

3820 
	`as£¹
(
Ïrge_maxşass
 > 0);

3821 
Æşas£s
 = 
	`size2šdex
(
Ïrge_maxşass
è- size2šdex(
SMALL_MAXCLASS
);

3822 
nhşas£s
 = 
NSIZES
 - 
Æşas£s
 - 
NBINS
;

3824 
	`bš_šfo_š™
();

3825 ià(
	`sm®l_run_size_š™
())

3826  (
Œue
);

3827 ià(
	`run_quªtize_š™
())

3828  (
Œue
);

3830 
runs_ava_bŸs
 = 
	`size2šdex
(
PAGE
);

3831 
runs_ava_nşas£s
 = 
	`size2šdex
(
run_quªtize_max
)+1 - 
runs_ava_bŸs
;

3833  (
çl£
);

3834 
	}
}

3837 
	$¬’a_´efÜk0
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

3840 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
¬’a
->
lock
);

3841 
	}
}

3844 
	$¬’a_´efÜk1
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

3847 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
¬’a
->
chunks_mtx
);

3848 
	}
}

3851 
	$¬’a_´efÜk2
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

3854 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
¬’a
->
node_ÿche_mtx
);

3855 
	}
}

3858 
	$¬’a_´efÜk3
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

3860 
i
;

3862 
i
 = 0; i < 
NBINS
; i++)

3863 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
¬’a
->
bšs
[
i
].
lock
);

3864 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
¬’a
->
huge_mtx
);

3865 
	}
}

3868 
	$¬’a_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

3870 
i
;

3872 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
¬’a
->
huge_mtx
);

3873 
i
 = 0; i < 
NBINS
; i++)

3874 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
¬’a
->
bšs
[
i
].
lock
);

3875 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
¬’a
->
node_ÿche_mtx
);

3876 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
¬’a
->
chunks_mtx
);

3877 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
¬’a
->
lock
);

3878 
	}
}

3881 
	$¬’a_po¡fÜk_chd
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

3883 
i
;

3885 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
¬’a
->
huge_mtx
);

3886 
i
 = 0; i < 
NBINS
; i++)

3887 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
¬’a
->
bšs
[
i
].
lock
);

3888 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
¬’a
->
node_ÿche_mtx
);

3889 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
¬’a
->
chunks_mtx
);

3890 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
¬’a
->
lock
);

3891 
	}
}

	@dep/jemalloc-4.2.0/src/atomic.c

1 
	#JEMALLOC_ATOMIC_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

	@dep/jemalloc-4.2.0/src/base.c

1 
	#JEMALLOC_BASE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
m®loc_mu‹x_t
 
	gba£_mtx
;

8 
ex‹Á_Œ“_t
 
	gba£_ava_szad
;

9 
ex‹Á_node_t
 *
	gba£_nodes
;

10 
size_t
 
	gba£_®loÿ‹d
;

11 
size_t
 
	gba£_»sid’t
;

12 
size_t
 
	gba£_m­³d
;

16 
ex‹Á_node_t
 *

17 
	$ba£_node_Œy_®loc
(
tsdn_t
 *
tsdn
)

19 
ex‹Á_node_t
 *
node
;

21 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, &
ba£_mtx
);

23 ià(
ba£_nodes
 =ğ
NULL
)

24  (
NULL
);

25 
node
 = 
ba£_nodes
;

26 
ba£_nodes
 = *(
ex‹Á_node_t
 **)
node
;

27 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
node
, (
ex‹Á_node_t
));

28  (
node
);

29 
	}
}

32 
	$ba£_node_d®loc
(
tsdn_t
 *
tsdn
, 
ex‹Á_node_t
 *
node
)

35 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, &
ba£_mtx
);

37 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
node
, (
ex‹Á_node_t
));

38 *(
ex‹Á_node_t
 **)
node
 = 
ba£_nodes
;

39 
ba£_nodes
 = 
node
;

40 
	}
}

42 
ex‹Á_node_t
 *

43 
	$ba£_chunk_®loc
(
tsdn_t
 *
tsdn
, 
size_t
 
mšsize
)

45 
ex‹Á_node_t
 *
node
;

46 
size_t
 
csize
, 
nsize
;

47 *
addr
;

49 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, &
ba£_mtx
);

50 
	`as£¹
(
mšsize
 != 0);

51 
node
 = 
	`ba£_node_Œy_®loc
(
tsdn
);

53 
nsize
 = (
node
 =ğ
NULL
è? 
	`CACHELINE_CEILING
((
ex‹Á_node_t
)) : 0;

54 
csize
 = 
	`CHUNK_CEILING
(
mšsize
 + 
nsize
);

55 
addr
 = 
	`chunk_®loc_ba£
(
csize
);

56 ià(
addr
 =ğ
NULL
) {

57 ià(
node
 !ğ
NULL
)

58 
	`ba£_node_d®loc
(
tsdn
, 
node
);

59  (
NULL
);

61 
ba£_m­³d
 +ğ
csize
;

62 ià(
node
 =ğ
NULL
) {

63 
node
 = (
ex‹Á_node_t
 *)
addr
;

64 
addr
 = (*)((
ušŒ_t
ïdd¸+ 
nsize
);

65 
csize
 -ğ
nsize
;

66 ià(
cÚfig_¡©s
) {

67 
ba£_®loÿ‹d
 +ğ
nsize
;

68 
ba£_»sid’t
 +ğ
	`PAGE_CEILING
(
nsize
);

71 
	`ex‹Á_node_š™
(
node
, 
NULL
, 
addr
, 
csize
, 
Œue
,rue);

72  (
node
);

73 
	}
}

81 
	$ba£_®loc
(
tsdn_t
 *
tsdn
, 
size_t
 
size
)

83 *
»t
;

84 
size_t
 
csize
, 
usize
;

85 
ex‹Á_node_t
 *
node
;

86 
ex‹Á_node_t
 
key
;

92 
csize
 = 
	`CACHELINE_CEILING
(
size
);

94 
usize
 = 
	`s2u
(
csize
);

95 
	`ex‹Á_node_š™
(&
key
, 
NULL
, NULL, 
usize
, 
çl£
, false);

96 
	`m®loc_mu‹x_lock
(
tsdn
, &
ba£_mtx
);

97 
node
 = 
	`ex‹Á_Œ“_szad_n£¬ch
(&
ba£_ava_szad
, &
key
);

98 ià(
node
 !ğ
NULL
) {

100 
	`ex‹Á_Œ“_szad_»move
(&
ba£_ava_szad
, 
node
);

103 
node
 = 
	`ba£_chunk_®loc
(
tsdn
, 
csize
);

105 ià(
node
 =ğ
NULL
) {

106 
»t
 = 
NULL
;

107 
Ïb–_»tuº
;

110 
»t
 = 
	`ex‹Á_node_addr_g‘
(
node
);

111 ià(
	`ex‹Á_node_size_g‘
(
node
è> 
csize
) {

112 
	`ex‹Á_node_addr_£t
(
node
, (*)((
ušŒ_t
)
»t
 + 
csize
));

113 
	`ex‹Á_node_size_£t
(
node
, 
	`ex‹Á_node_size_g‘
Òodeè- 
csize
);

114 
	`ex‹Á_Œ“_szad_š£¹
(&
ba£_ava_szad
, 
node
);

116 
	`ba£_node_d®loc
(
tsdn
, 
node
);

117 ià(
cÚfig_¡©s
) {

118 
ba£_®loÿ‹d
 +ğ
csize
;

123 
ba£_»sid’t
 +ğ
	`PAGE_CEILING
((
ušŒ_t
)
»t
 + 
csize
) -

124 
	`PAGE_CEILING
((
ušŒ_t
)
»t
);

126 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
(
»t
, 
csize
);

127 
Ïb–_»tuº
:

128 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
ba£_mtx
);

129  (
»t
);

130 
	}
}

133 
	$ba£_¡©s_g‘
(
tsdn_t
 *
tsdn
, 
size_t
 *
®loÿ‹d
, size_ˆ*
»sid’t
,

134 
size_t
 *
m­³d
)

137 
	`m®loc_mu‹x_lock
(
tsdn
, &
ba£_mtx
);

138 
	`as£¹
(
ba£_®loÿ‹d
 <ğ
ba£_»sid’t
);

139 
	`as£¹
(
ba£_»sid’t
 <ğ
ba£_m­³d
);

140 *
®loÿ‹d
 = 
ba£_®loÿ‹d
;

141 *
»sid’t
 = 
ba£_»sid’t
;

142 *
m­³d
 = 
ba£_m­³d
;

143 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
ba£_mtx
);

144 
	}
}

146 
boŞ


147 
	$ba£_boÙ
()

150 ià(
	`m®loc_mu‹x_š™
(&
ba£_mtx
, "ba£", 
WITNESS_RANK_BASE
))

151  (
Œue
);

152 
	`ex‹Á_Œ“_szad_Ãw
(&
ba£_ava_szad
);

153 
ba£_nodes
 = 
NULL
;

155  (
çl£
);

156 
	}
}

159 
	$ba£_´efÜk
(
tsdn_t
 *
tsdn
)

162 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
ba£_mtx
);

163 
	}
}

166 
	$ba£_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
)

169 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
ba£_mtx
);

170 
	}
}

173 
	$ba£_po¡fÜk_chd
(
tsdn_t
 *
tsdn
)

176 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
ba£_mtx
);

177 
	}
}

	@dep/jemalloc-4.2.0/src/bitmap.c

1 
	#JEMALLOC_BITMAP_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

6 #ifdeà
USE_TREE


9 
	$b™m­_šfo_š™
(
b™m­_šfo_t
 *
bšfo
, 
size_t
 
nb™s
)

11 
i
;

12 
size_t
 
group_couÁ
;

14 
	`as£¹
(
nb™s
 > 0);

15 
	`as£¹
(
nb™s
 <ğ(
	`ZU
(1è<< 
LG_BITMAP_MAXBITS
));

22 
bšfo
->
Ëv–s
[0].
group_off£t
 = 0;

23 
group_couÁ
 = 
	`BITMAP_BITS2GROUPS
(
nb™s
);

24 
i
 = 1; 
group_couÁ
 > 1; i++) {

25 
	`as£¹
(
i
 < 
BITMAP_MAX_LEVELS
);

26 
bšfo
->
Ëv–s
[
i
].
group_off£t
 = binfo->levels[i-1].group_offset

27 + 
group_couÁ
;

28 
group_couÁ
 = 
	`BITMAP_BITS2GROUPS
(group_count);

30 
bšfo
->
Ëv–s
[
i
].
group_off£t
 = binfo->levels[i-1].group_offset

31 + 
group_couÁ
;

32 
	`as£¹
(
bšfo
->
Ëv–s
[
i
].
group_off£t
 <ğ
BITMAP_GROUPS_MAX
);

33 
bšfo
->
Æev–s
 = 
i
;

34 
bšfo
->
nb™s
 =‚bits;

35 
	}
}

37 
size_t


38 
	$b™m­_šfo_ngroups
(cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

41  (
bšfo
->
Ëv–s
[bšfo->
Æev–s
].
group_off£t
);

42 
	}
}

45 
	$b™m­_š™
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

47 
size_t
 
exŒa
;

48 
i
;

57 
	`mem£t
(
b™m­
, 0xffU, 
	`b™m­_size
(
bšfo
));

58 
exŒa
 = (
BITMAP_GROUP_NBITS
 - (
bšfo
->
nb™s
 & 
BITMAP_GROUP_NBITS_MASK
))

59 & 
BITMAP_GROUP_NBITS_MASK
;

60 ià(
exŒa
 != 0)

61 
b™m­
[
bšfo
->
Ëv–s
[1].
group_off£t
 - 1] >>ğ
exŒa
;

62 
i
 = 1; i < 
bšfo
->
Æev–s
; i++) {

63 
size_t
 
group_couÁ
 = 
bšfo
->
Ëv–s
[
i
].
group_off£t
 -

64 
bšfo
->
Ëv–s
[
i
-1].
group_off£t
;

65 
exŒa
 = (
BITMAP_GROUP_NBITS
 - (
group_couÁ
 &

66 
BITMAP_GROUP_NBITS_MASK
)) & BITMAP_GROUP_NBITS_MASK;

67 ià(
exŒa
 != 0)

68 
b™m­
[
bšfo
->
Ëv–s
[
i
+1].
group_off£t
 - 1] >>ğ
exŒa
;

70 
	}
}

75 
	$b™m­_šfo_š™
(
b™m­_šfo_t
 *
bšfo
, 
size_t
 
nb™s
)

78 
	`as£¹
(
nb™s
 > 0);

79 
	`as£¹
(
nb™s
 <ğ(
	`ZU
(1è<< 
LG_BITMAP_MAXBITS
));

81 
bšfo
->
ngroups
 = 
	`BITMAP_BITS2GROUPS
(
nb™s
);

82 
bšfo
->
nb™s
 =‚bits;

83 
	}
}

85 
size_t


86 
	$b™m­_šfo_ngroups
(cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

89  (
bšfo
->
ngroups
);

90 
	}
}

93 
	$b™m­_š™
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

95 
size_t
 
exŒa
;

97 
	`mem£t
(
b™m­
, 0xffU, 
	`b™m­_size
(
bšfo
));

98 
exŒa
 = (
BITMAP_GROUP_NBITS
 - (
bšfo
->
nb™s
 & 
BITMAP_GROUP_NBITS_MASK
))

99 & 
BITMAP_GROUP_NBITS_MASK
;

100 ià(
exŒa
 != 0)

101 
b™m­
[
bšfo
->
ngroups
 - 1] >>ğ
exŒa
;

102 
	}
}

106 
size_t


107 
	$b™m­_size
(cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

110  (
	`b™m­_šfo_ngroups
(
bšfo
è<< 
LG_SIZEOF_BITMAP
);

111 
	}
}

	@dep/jemalloc-4.2.0/src/chunk.c

1 
	#JEMALLOC_CHUNK_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 cÚ¡ *
	gİt_dss
 = 
DSS_DEFAULT
;

8 
size_t
 
	gİt_lg_chunk
 = 0;

11 
size_t
 
	gcurchunks
;

12 
size_t
 
	ghighchunks
;

14 
¹»e_t
 
	gchunks_¹»e
;

17 
size_t
 
	gchunksize
;

18 
size_t
 
	gchunksize_mask
;

19 
size_t
 
	gchunk_Åages
;

21 *
chunk_®loc_deçuÉ
(*
Ãw_addr
, 
size_t
 
size
,

22 
size_t
 
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
, 
¬’a_šd
);

23 
boŞ
 
chunk_d®loc_deçuÉ
(*
chunk
, 
size_t
 
size
, boŞ 
comm™‹d
,

24 
¬’a_šd
);

25 
boŞ
 
chunk_comm™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
,

26 
size_t
 
Ëngth
, 
¬’a_šd
);

27 
boŞ
 
chunk_decomm™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
,

28 
size_t
 
Ëngth
, 
¬’a_šd
);

29 
boŞ
 
chunk_purge_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
,

30 
size_t
 
Ëngth
, 
¬’a_šd
);

31 
boŞ
 
chunk_¥l™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
size_a
,

32 
size_t
 
size_b
, 
boŞ
 
comm™‹d
, 
¬’a_šd
);

33 
boŞ
 
chunk_m”ge_deçuÉ
(*
chunk_a
, 
size_t
 
size_a
, *
chunk_b
,

34 
size_t
 
size_b
, 
boŞ
 
comm™‹d
, 
¬’a_šd
);

36 cÚ¡ 
chunk_hooks_t
 
	gchunk_hooks_deçuÉ
 = {

37 
chunk_®loc_deçuÉ
,

38 
chunk_d®loc_deçuÉ
,

39 
chunk_comm™_deçuÉ
,

40 
chunk_decomm™_deçuÉ
,

41 
chunk_purge_deçuÉ
,

42 
chunk_¥l™_deçuÉ
,

43 
chunk_m”ge_deçuÉ


52 
chunk_»cÜd
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

53 
chunk_hooks_t
 *
chunk_hooks
, 
ex‹Á_Œ“_t
 *
chunks_szad
,

54 
ex‹Á_Œ“_t
 *
chunks_ad
, 
boŞ
 
ÿche
, *
chunk
, 
size_t
 
size
, boŞ 
z”Ûd
,

55 
boŞ
 
comm™‹d
);

59 
chunk_hooks_t


60 
	$chunk_hooks_g‘_locked
(
¬’a_t
 *
¬’a
)

63  (
¬’a
->
chunk_hooks
);

64 
	}
}

66 
chunk_hooks_t


67 
	$chunk_hooks_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

69 
chunk_hooks_t
 
chunk_hooks
;

71 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
chunks_mtx
);

72 
chunk_hooks
 = 
	`chunk_hooks_g‘_locked
(
¬’a
);

73 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
chunks_mtx
);

75  (
chunk_hooks
);

76 
	}
}

78 
chunk_hooks_t


79 
	$chunk_hooks_£t
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, cÚ¡ 
chunk_hooks_t
 *
chunk_hooks
)

81 
chunk_hooks_t
 
Şd_chunk_hooks
;

83 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
chunks_mtx
);

84 
Şd_chunk_hooks
 = 
¬’a
->
chunk_hooks
;

92 
	#ATOMIC_COPY_HOOK
(
n
) do { \

94 
chunk_
##
n
##
_t
 **n; \

95 **
v
; \

96 } 
u
; \

97 
u
.
n
 = &
¬’a
->
chunk_hooks
.n; \

98 
	`©omic_wr™e_p
(
u
.
v
, 
chunk_hooks
->
n
); \

99 } 0)

	)

100 
	`ATOMIC_COPY_HOOK
(
®loc
);

101 
	`ATOMIC_COPY_HOOK
(
d®loc
);

102 
	`ATOMIC_COPY_HOOK
(
comm™
);

103 
	`ATOMIC_COPY_HOOK
(
decomm™
);

104 
	`ATOMIC_COPY_HOOK
(
purge
);

105 
	`ATOMIC_COPY_HOOK
(
¥l™
);

106 
	`ATOMIC_COPY_HOOK
(
m”ge
);

107 #undeà
ATOMIC_COPY_HOOK


108 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
chunks_mtx
);

110  (
Şd_chunk_hooks
);

111 
	}
}

114 
	$chunk_hooks_assu»_š™Ÿlized_im¶
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

115 
chunk_hooks_t
 *
chunk_hooks
, 
boŞ
 
locked
)

117 cÚ¡ 
chunk_hooks_t
 
unš™Ÿlized_hooks
 =

118 
CHUNK_HOOKS_INITIALIZER
;

120 ià(
	`memcmp
(
chunk_hooks
, &
unš™Ÿlized_hooks
, (
chunk_hooks_t
)) ==

122 *
chunk_hooks
 = 
locked
 ? 
	`chunk_hooks_g‘_locked
(
¬’a
) :

123 
	`chunk_hooks_g‘
(
tsdn
, 
¬’a
);

125 
	}
}

128 
	$chunk_hooks_assu»_š™Ÿlized_locked
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

129 
chunk_hooks_t
 *
chunk_hooks
)

132 
	`chunk_hooks_assu»_š™Ÿlized_im¶
(
tsdn
, 
¬’a
, 
chunk_hooks
, 
Œue
);

133 
	}
}

136 
	$chunk_hooks_assu»_š™Ÿlized
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
,

137 
chunk_hooks_t
 *
chunk_hooks
)

140 
	`chunk_hooks_assu»_š™Ÿlized_im¶
(
tsdn
, 
¬’a
, 
chunk_hooks
, 
çl£
);

141 
	}
}

143 
boŞ


144 
	$chunk_»gi¡”
(
tsdn_t
 *
tsdn
, cÚ¡ *
chunk
, cÚ¡ 
ex‹Á_node_t
 *
node
)

147 
	`as£¹
(
	`ex‹Á_node_addr_g‘
(
node
è=ğ
chunk
);

149 ià(
	`¹»e_£t
(&
chunks_¹»e
, (
ušŒ_t
)
chunk
, 
node
))

150  (
Œue
);

151 ià(
cÚfig_´of
 && 
İt_´of
) {

152 
size_t
 
size
 = 
	`ex‹Á_node_size_g‘
(
node
);

153 
size_t
 
Çdd
 = (
size
 =ğ0è? 1 : siz/ 
chunksize
;

154 
size_t
 
cur
 = 
	`©omic_add_z
(&
curchunks
, 
Çdd
);

155 
size_t
 
high
 = 
	`©omic_»ad_z
(&
highchunks
);

156 
cur
 > 
high
 && 
	`©omic_ÿs_z
(&
highchunks
, high, cur)) {

161 
high
 = 
	`©omic_»ad_z
(&
highchunks
);

163 ià(
cur
 > 
high
 && 
	`´of_gdump_g‘_uÆocked
())

164 
	`´of_gdump
(
tsdn
);

167  (
çl£
);

168 
	}
}

171 
	$chunk_d”egi¡”
(cÚ¡ *
chunk
, cÚ¡ 
ex‹Á_node_t
 *
node
)

173 
boŞ
 
”r
;

175 
”r
 = 
	`¹»e_£t
(&
chunks_¹»e
, (
ušŒ_t
)
chunk
, 
NULL
);

176 
	`as£¹
(!
”r
);

177 ià(
cÚfig_´of
 && 
İt_´of
) {

178 
size_t
 
size
 = 
	`ex‹Á_node_size_g‘
(
node
);

179 
size_t
 
nsub
 = (
size
 =ğ0è? 1 : siz/ 
chunksize
;

180 
	`as£¹
(
	`©omic_»ad_z
(&
curchunks
è>ğ
nsub
);

181 
	`©omic_sub_z
(&
curchunks
, 
nsub
);

183 
	}
}

189 
ex‹Á_node_t
 *

190 
	$chunk_fœ¡_be¡_f™
(
¬’a_t
 *
¬’a
, 
ex‹Á_Œ“_t
 *
chunks_szad
,

191 
ex‹Á_Œ“_t
 *
chunks_ad
, 
size_t
 
size
)

193 
ex‹Á_node_t
 
key
;

195 
	`as£¹
(
size
 =ğ
	`CHUNK_CEILING
(size));

197 
	`ex‹Á_node_š™
(&
key
, 
¬’a
, 
NULL
, 
size
, 
çl£
, false);

198  (
	`ex‹Á_Œ“_szad_n£¬ch
(
chunks_szad
, &
key
));

199 
	}
}

202 
	$chunk_»cyşe
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

203 
ex‹Á_Œ“_t
 *
chunks_szad
,ƒx‹Á_Œ“_ˆ*
chunks_ad
, 
boŞ
 
ÿche
,

204 *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
,

205 
boŞ
 
d®loc_node
)

207 *
»t
;

208 
ex‹Á_node_t
 *
node
;

209 
size_t
 
®loc_size
, 
Ëadsize
, 
Œasize
;

210 
boŞ
 
z”Ûd
, 
comm™‹d
;

212 
	`as£¹
(
Ãw_addr
 =ğ
NULL
 || 
®ignm’t
 =ğ
chunksize
);

218 
	`as£¹
(
d®loc_node
 || 
Ãw_addr
 !ğ
NULL
);

220 
®loc_size
 = 
	`CHUNK_CEILING
(
	`s2u
(
size
 + 
®ignm’t
 - 
chunksize
));

222 ià(
®loc_size
 < 
size
)

223  (
NULL
);

224 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
chunks_mtx
);

225 
	`chunk_hooks_assu»_š™Ÿlized_locked
(
tsdn
, 
¬’a
, 
chunk_hooks
);

226 ià(
Ãw_addr
 !ğ
NULL
) {

227 
ex‹Á_node_t
 
key
;

228 
	`ex‹Á_node_š™
(&
key
, 
¬’a
, 
Ãw_addr
, 
®loc_size
, 
çl£
,

229 
çl£
);

230 
node
 = 
	`ex‹Á_Œ“_ad_£¬ch
(
chunks_ad
, &
key
);

232 
node
 = 
	`chunk_fœ¡_be¡_f™
(
¬’a
, 
chunks_szad
, 
chunks_ad
,

233 
®loc_size
);

235 ià(
node
 =ğ
NULL
 || (
Ãw_addr
 !ğNULL && 
	`ex‹Á_node_size_g‘
(node) <

236 
size
)) {

237 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
chunks_mtx
);

238  (
NULL
);

240 
Ëadsize
 = 
	`ALIGNMENT_CEILING
((
ušŒ_t
)
	`ex‹Á_node_addr_g‘
(
node
),

241 
®ignm’t
è- (
ušŒ_t
)
	`ex‹Á_node_addr_g‘
(
node
);

242 
	`as£¹
(
Ãw_addr
 =ğ
NULL
 || 
Ëadsize
 == 0);

243 
	`as£¹
(
	`ex‹Á_node_size_g‘
(
node
è>ğ
Ëadsize
 + 
size
);

244 
Œasize
 = 
	`ex‹Á_node_size_g‘
(
node
è- 
Ëadsize
 - 
size
;

245 
»t
 = (*)((
ušŒ_t
)
	`ex‹Á_node_addr_g‘
(
node
è+ 
Ëadsize
);

246 
z”Ûd
 = 
	`ex‹Á_node_z”Ûd_g‘
(
node
);

247 ià(
z”Ûd
)

248 *
z”o
 = 
Œue
;

249 
comm™‹d
 = 
	`ex‹Á_node_comm™‹d_g‘
(
node
);

250 ià(
comm™‹d
)

251 *
comm™
 = 
Œue
;

253 ià(
Ëadsize
 != 0 &&

254 
chunk_hooks
->
	`¥l™
(
	`ex‹Á_node_addr_g‘
(
node
),

255 
	`ex‹Á_node_size_g‘
(
node
), 
Ëadsize
, 
size
, 
çl£
, 
¬’a
->
šd
)) {

256 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
chunks_mtx
);

257  (
NULL
);

260 
	`ex‹Á_Œ“_szad_»move
(
chunks_szad
, 
node
);

261 
	`ex‹Á_Œ“_ad_»move
(
chunks_ad
, 
node
);

262 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a
, 
node
, 
ÿche
);

263 ià(
Ëadsize
 != 0) {

265 
	`ex‹Á_node_size_£t
(
node
, 
Ëadsize
);

266 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

267 
	`ex‹Á_Œ“_ad_š£¹
(
chunks_ad
, 
node
);

268 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

269 
node
 = 
NULL
;

271 ià(
Œasize
 != 0) {

273 ià(
chunk_hooks
->
	`¥l™
(
»t
, 
size
 + 
Œasize
, size,

274 
Œasize
, 
çl£
, 
¬’a
->
šd
)) {

275 ià(
d®loc_node
 && 
node
 !ğ
NULL
)

276 
	`¬’a_node_d®loc
(
tsdn
, 
¬’a
, 
node
);

277 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
chunks_mtx
);

278 
	`chunk_»cÜd
(
tsdn
, 
¬’a
, 
chunk_hooks
, 
chunks_szad
,

279 
chunks_ad
, 
ÿche
, 
»t
, 
size
 + 
Œasize
, 
z”Ûd
,

280 
comm™‹d
);

281  (
NULL
);

284 ià(
node
 =ğ
NULL
) {

285 
node
 = 
	`¬’a_node_®loc
(
tsdn
, 
¬’a
);

286 ià(
node
 =ğ
NULL
) {

287 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
chunks_mtx
);

288 
	`chunk_»cÜd
(
tsdn
, 
¬’a
, 
chunk_hooks
,

289 
chunks_szad
, 
chunks_ad
, 
ÿche
, 
»t
, 
size
 +

290 
Œasize
, 
z”Ûd
, 
comm™‹d
);

291  (
NULL
);

294 
	`ex‹Á_node_š™
(
node
, 
¬’a
, (*)((
ušŒ_t
)(
»t
è+ 
size
),

295 
Œasize
, 
z”Ûd
, 
comm™‹d
);

296 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

297 
	`ex‹Á_Œ“_ad_š£¹
(
chunks_ad
, 
node
);

298 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

299 
node
 = 
NULL
;

301 ià(!
comm™‹d
 && 
chunk_hooks
->
	`comm™
(
»t
, 
size
, 0, size, 
¬’a
->
šd
)) {

302 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
chunks_mtx
);

303 
	`chunk_»cÜd
(
tsdn
, 
¬’a
, 
chunk_hooks
, 
chunks_szad
, 
chunks_ad
,

304 
ÿche
, 
»t
, 
size
, 
z”Ûd
, 
comm™‹d
);

305  (
NULL
);

307 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
chunks_mtx
);

309 
	`as£¹
(
d®loc_node
 || 
node
 !ğ
NULL
);

310 ià(
d®loc_node
 && 
node
 !ğ
NULL
)

311 
	`¬’a_node_d®loc
(
tsdn
, 
¬’a
, 
node
);

312 ià(*
z”o
) {

313 ià(!
z”Ûd
)

314 
	`mem£t
(
»t
, 0, 
size
);

315 ià(
cÚfig_debug
) {

316 
size_t
 
i
;

317 
size_t
 *
p
 = (size_ˆ*)(
ušŒ_t
)
»t
;

319 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
(
»t
, 
size
);

320 
i
 = 0; i < 
size
 / (
size_t
); i++)

321 
	`as£¹
(
p
[
i
] == 0);

324  (
»t
);

325 
	}
}

334 
	$chunk_®loc_cÜe
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
Ãw_addr
, 
size_t
 
size
,

335 
size_t
 
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
, 
dss_´ec_t
 
dss_´ec
)

337 *
»t
;

339 
	`as£¹
(
size
 != 0);

340 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

341 
	`as£¹
(
®ignm’t
 != 0);

342 
	`as£¹
((
®ignm’t
 & 
chunksize_mask
) == 0);

345 ià(
have_dss
 && 
dss_´ec
 =ğ
dss_´ec_´im¬y
 && (
»t
 =

346 
	`chunk_®loc_dss
(
tsdn
, 
¬’a
, 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
,

347 
comm™
)è!ğ
NULL
)

348  (
»t
);

350 ià((
»t
 = 
	`chunk_®loc_mm­
(
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
, 
comm™
)) !=

351 
NULL
)

352  (
»t
);

354 ià(
have_dss
 && 
dss_´ec
 =ğ
dss_´ec_£cÚd¬y
 && (
»t
 =

355 
	`chunk_®loc_dss
(
tsdn
, 
¬’a
, 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
,

356 
comm™
)è!ğ
NULL
)

357  (
»t
);

360  (
NULL
);

361 
	}
}

364 
	$chunk_®loc_ba£
(
size_t
 
size
)

366 *
»t
;

367 
boŞ
 
z”o
, 
comm™
;

374 
z”o
 = 
Œue
;

375 
comm™
 = 
Œue
;

376 
»t
 = 
	`chunk_®loc_mm­
(
NULL
, 
size
, 
chunksize
, &
z”o
, &
comm™
);

377 ià(
»t
 =ğ
NULL
)

378  (
NULL
);

379 ià(
cÚfig_v®gršd
)

380 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
size
);

382  (
»t
);

383 
	}
}

386 
	$chunk_®loc_ÿche
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

387 *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ 
d®loc_node
)

389 *
»t
;

390 
boŞ
 
comm™
;

392 
	`as£¹
(
size
 != 0);

393 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

394 
	`as£¹
(
®ignm’t
 != 0);

395 
	`as£¹
((
®ignm’t
 & 
chunksize_mask
) == 0);

397 
comm™
 = 
Œue
;

398 
»t
 = 
	`chunk_»cyşe
(
tsdn
, 
¬’a
, 
chunk_hooks
,

399 &
¬’a
->
chunks_szad_ÿched
, &¬’a->
chunks_ad_ÿched
, 
Œue
,

400 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
, &
comm™
, 
d®loc_node
);

401 ià(
»t
 =ğ
NULL
)

402  (
NULL
);

403 
	`as£¹
(
comm™
);

404 ià(
cÚfig_v®gršd
)

405 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
size
);

406  (
»t
);

407 
	}
}

409 
¬’a_t
 *

410 
	$chunk_¬’a_g‘
(
tsdn_t
 *
tsdn
, 
¬’a_šd
)

412 
¬’a_t
 *
¬’a
;

414 
¬’a
 = 
	`¬’a_g‘
(
tsdn
, 
¬’a_šd
, 
çl£
);

419 
	`as£¹
(
¬’a
 !ğ
NULL
);

420  (
¬’a
);

421 
	}
}

424 
	$chunk_®loc_deçuÉ
(*
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
,

425 
boŞ
 *
comm™
, 
¬’a_šd
)

427 *
»t
;

428 
tsdn_t
 *
tsdn
;

429 
¬’a_t
 *
¬’a
;

431 
tsdn
 = 
	`tsdn_ãtch
();

432 
¬’a
 = 
	`chunk_¬’a_g‘
(
tsdn
, 
¬’a_šd
);

433 
»t
 = 
	`chunk_®loc_cÜe
(
tsdn
, 
¬’a
, 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
,

434 
comm™
, 
¬’a
->
dss_´ec
);

435 ià(
»t
 =ğ
NULL
)

436  (
NULL
);

437 ià(
cÚfig_v®gršd
)

438 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
size
);

440  (
»t
);

441 
	}
}

444 
	$chunk_®loc_»šed
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

445 *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
)

447 *
»t
;

449 
	`as£¹
(
size
 != 0);

450 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

451 
	`as£¹
(
®ignm’t
 != 0);

452 
	`as£¹
((
®ignm’t
 & 
chunksize_mask
) == 0);

454 
»t
 = 
	`chunk_»cyşe
(
tsdn
, 
¬’a
, 
chunk_hooks
,

455 &
¬’a
->
chunks_szad_»šed
, &¬’a->
chunks_ad_»šed
, 
çl£
,

456 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
, 
comm™
, 
Œue
);

458 ià(
cÚfig_¡©s
 && 
»t
 !ğ
NULL
)

459 
¬’a
->
¡©s
.
»šed
 -ğ
size
;

461  (
»t
);

462 
	}
}

465 
	$chunk_®loc_w¿µ”
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

466 *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
)

468 *
»t
;

470 
	`chunk_hooks_assu»_š™Ÿlized
(
tsdn
, 
¬’a
, 
chunk_hooks
);

472 
»t
 = 
	`chunk_®loc_»šed
(
tsdn
, 
¬’a
, 
chunk_hooks
, 
Ãw_addr
, 
size
,

473 
®ignm’t
, 
z”o
, 
comm™
);

474 ià(
»t
 =ğ
NULL
) {

475 
»t
 = 
chunk_hooks
->
	`®loc
(
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
,

476 
comm™
, 
¬’a
->
šd
);

477 ià(
»t
 =ğ
NULL
)

478  (
NULL
);

481 ià(
cÚfig_v®gršd
 && 
chunk_hooks
->
®loc
 !ğ
chunk_®loc_deçuÉ
)

482 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
chunksize
);

483  (
»t
);

484 
	}
}

487 
	$chunk_»cÜd
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

488 
ex‹Á_Œ“_t
 *
chunks_szad
,ƒx‹Á_Œ“_ˆ*
chunks_ad
, 
boŞ
 
ÿche
,

489 *
chunk
, 
size_t
 
size
, 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
)

491 
boŞ
 
unz”Ûd
;

492 
ex‹Á_node_t
 *
node
, *
´ev
;

493 
ex‹Á_node_t
 
key
;

495 
	`as£¹
(!
ÿche
 || !
z”Ûd
);

496 
unz”Ûd
 = 
ÿche
 || !
z”Ûd
;

497 
	`JEMALLOC_VALGRIND_MAKE_MEM_NOACCESS
(
chunk
, 
size
);

499 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
chunks_mtx
);

500 
	`chunk_hooks_assu»_š™Ÿlized_locked
(
tsdn
, 
¬’a
, 
chunk_hooks
);

501 
	`ex‹Á_node_š™
(&
key
, 
¬’a
, (*)((
ušŒ_t
)
chunk
 + 
size
), 0,

502 
çl£
, false);

503 
node
 = 
	`ex‹Á_Œ“_ad_n£¬ch
(
chunks_ad
, &
key
);

505 ià(
node
 !ğ
NULL
 && 
	`ex‹Á_node_addr_g‘
(node) ==

506 
	`ex‹Á_node_addr_g‘
(&
key
è&& 
	`ex‹Á_node_comm™‹d_g‘
(
node
) ==

507 
comm™‹d
 && !
chunk_hooks
->
	`m”ge
(
chunk
, 
size
,

508 
	`ex‹Á_node_addr_g‘
(
node
), 
	`ex‹Á_node_size_g‘
Òode), 
çl£
,

509 
¬’a
->
šd
)) {

515 
	`ex‹Á_Œ“_szad_»move
(
chunks_szad
, 
node
);

516 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a
, 
node
, 
ÿche
);

517 
	`ex‹Á_node_addr_£t
(
node
, 
chunk
);

518 
	`ex‹Á_node_size_£t
(
node
, 
size
 + 
	`ex‹Á_node_size_g‘
(node));

519 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
	`ex‹Á_node_z”Ûd_g‘
(node) &&

520 !
unz”Ûd
);

521 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

522 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

525 
node
 = 
	`¬’a_node_®loc
(
tsdn
, 
¬’a
);

526 ià(
node
 =ğ
NULL
) {

533 ià(
ÿche
) {

534 
	`chunk_purge_w¿µ”
(
tsdn
, 
¬’a
, 
chunk_hooks
,

535 
chunk
, 
size
, 0, size);

537 
Ïb–_»tuº
;

539 
	`ex‹Á_node_š™
(
node
, 
¬’a
, 
chunk
, 
size
, !
unz”Ûd
,

540 
comm™‹d
);

541 
	`ex‹Á_Œ“_ad_š£¹
(
chunks_ad
, 
node
);

542 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

543 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

547 
´ev
 = 
	`ex‹Á_Œ“_ad_´ev
(
chunks_ad
, 
node
);

548 ià(
´ev
 !ğ
NULL
 && (*)((
ušŒ_t
)
	`ex‹Á_node_addr_g‘
(prev) +

549 
	`ex‹Á_node_size_g‘
(
´ev
)è=ğ
chunk
 &&

550 
	`ex‹Á_node_comm™‹d_g‘
(
´ev
è=ğ
comm™‹d
 &&

551 !
chunk_hooks
->
	`m”ge
(
	`ex‹Á_node_addr_g‘
(
´ev
),

552 
	`ex‹Á_node_size_g‘
(
´ev
), 
chunk
, 
size
, 
çl£
, 
¬’a
->
šd
)) {

558 
	`ex‹Á_Œ“_szad_»move
(
chunks_szad
, 
´ev
);

559 
	`ex‹Á_Œ“_ad_»move
(
chunks_ad
, 
´ev
);

560 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a
, 
´ev
, 
ÿche
);

561 
	`ex‹Á_Œ“_szad_»move
(
chunks_szad
, 
node
);

562 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a
, 
node
, 
ÿche
);

563 
	`ex‹Á_node_addr_£t
(
node
, 
	`ex‹Á_node_addr_g‘
(
´ev
));

564 
	`ex‹Á_node_size_£t
(
node
, 
	`ex‹Á_node_size_g‘
(
´ev
) +

565 
	`ex‹Á_node_size_g‘
(
node
));

566 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
	`ex‹Á_node_z”Ûd_g‘
(
´ev
) &&

567 
	`ex‹Á_node_z”Ûd_g‘
(
node
));

568 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

569 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

571 
	`¬’a_node_d®loc
(
tsdn
, 
¬’a
, 
´ev
);

574 
Ïb–_»tuº
:

575 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
chunks_mtx
);

576 
	}
}

579 
	$chunk_d®loc_ÿche
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

580 *
chunk
, 
size_t
 
size
, 
boŞ
 
comm™‹d
)

583 
	`as£¹
(
chunk
 !ğ
NULL
);

584 
	`as£¹
(
	`CHUNK_ADDR2BASE
(
chunk
) == chunk);

585 
	`as£¹
(
size
 != 0);

586 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

588 
	`chunk_»cÜd
(
tsdn
, 
¬’a
, 
chunk_hooks
, &¬’a->
chunks_szad_ÿched
,

589 &
¬’a
->
chunks_ad_ÿched
, 
Œue
, 
chunk
, 
size
, 
çl£
, 
comm™‹d
);

590 
	`¬’a_maybe_purge
(
tsdn
, 
¬’a
);

591 
	}
}

593 
boŞ


594 
	$chunk_d®loc_deçuÉ
(*
chunk
, 
size_t
 
size
, 
boŞ
 
comm™‹d
,

595 
¬’a_šd
)

598 ià(!
have_dss
 || !
	`chunk_š_dss
(
	`tsdn_ãtch
(), 
chunk
))

599  (
	`chunk_d®loc_mm­
(
chunk
, 
size
));

600  (
Œue
);

601 
	}
}

604 
	$chunk_d®loc_w¿µ”
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

605 *
chunk
, 
size_t
 
size
, 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
)

608 
	`as£¹
(
chunk
 !ğ
NULL
);

609 
	`as£¹
(
	`CHUNK_ADDR2BASE
(
chunk
) == chunk);

610 
	`as£¹
(
size
 != 0);

611 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

613 
	`chunk_hooks_assu»_š™Ÿlized
(
tsdn
, 
¬’a
, 
chunk_hooks
);

615 ià(!
chunk_hooks
->
	`d®loc
(
chunk
, 
size
, 
comm™‹d
, 
¬’a
->
šd
))

618 ià(
comm™‹d
) {

619 
comm™‹d
 = 
chunk_hooks
->
	`decomm™
(
chunk
, 
size
, 0, size,

620 
¬’a
->
šd
);

622 
z”Ûd
 = !
comm™‹d
 || !
chunk_hooks
->
	`purge
(
chunk
, 
size
, 0, size,

623 
¬’a
->
šd
);

624 
	`chunk_»cÜd
(
tsdn
, 
¬’a
, 
chunk_hooks
, &¬’a->
chunks_szad_»šed
,

625 &
¬’a
->
chunks_ad_»šed
, 
çl£
, 
chunk
, 
size
, 
z”Ûd
, 
comm™‹d
);

627 ià(
cÚfig_¡©s
)

628 
¬’a
->
¡©s
.
»šed
 +ğ
size
;

629 
	}
}

631 
boŞ


632 
	$chunk_comm™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

633 
¬’a_šd
)

636  (
	`·ges_comm™
((*)((
ušŒ_t
)
chunk
 + (ušŒ_t)
off£t
),

637 
Ëngth
));

638 
	}
}

640 
boŞ


641 
	$chunk_decomm™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

642 
¬’a_šd
)

645  (
	`·ges_decomm™
((*)((
ušŒ_t
)
chunk
 + (ušŒ_t)
off£t
),

646 
Ëngth
));

647 
	}
}

649 
boŞ


650 
	$chunk_purge_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

651 
¬’a_šd
)

654 
	`as£¹
(
chunk
 !ğ
NULL
);

655 
	`as£¹
(
	`CHUNK_ADDR2BASE
(
chunk
) == chunk);

656 
	`as£¹
((
off£t
 & 
PAGE_MASK
) == 0);

657 
	`as£¹
(
Ëngth
 != 0);

658 
	`as£¹
((
Ëngth
 & 
PAGE_MASK
) == 0);

660  (
	`·ges_purge
((*)((
ušŒ_t
)
chunk
 + (ušŒ_t)
off£t
),

661 
Ëngth
));

662 
	}
}

664 
boŞ


665 
	$chunk_purge_w¿µ”
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

666 *
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
)

669 
	`chunk_hooks_assu»_š™Ÿlized
(
tsdn
, 
¬’a
, 
chunk_hooks
);

670  (
chunk_hooks
->
	`purge
(
chunk
, 
size
, 
off£t
, 
Ëngth
, 
¬’a
->
šd
));

671 
	}
}

673 
boŞ


674 
	$chunk_¥l™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
size_a
, size_ˆ
size_b
,

675 
boŞ
 
comm™‹d
, 
¬’a_šd
)

678 ià(!
m­s_cßËsû
)

679  (
Œue
);

680  (
çl£
);

681 
	}
}

683 
boŞ


684 
	$chunk_m”ge_deçuÉ
(*
chunk_a
, 
size_t
 
size_a
, *
chunk_b
, size_ˆ
size_b
,

685 
boŞ
 
comm™‹d
, 
¬’a_šd
)

688 ià(!
m­s_cßËsû
)

689  (
Œue
);

690 ià(
have_dss
) {

691 
tsdn_t
 *
tsdn
 = 
	`tsdn_ãtch
();

692 ià(
	`chunk_š_dss
(
tsdn
, 
chunk_a
è!ğchunk_š_dssÑsdn, 
chunk_b
))

693  (
Œue
);

696  (
çl£
);

697 
	}
}

699 
¹»e_node_–m_t
 *

700 
	$chunks_¹»e_node_®loc
(
size_t
 
Ãlms
)

703  ((
¹»e_node_–m_t
 *)
	`ba£_®loc
(
	`tsdn_ãtch
(), 
Ãlms
 *

704 (
¹»e_node_–m_t
)));

705 
	}
}

707 
boŞ


708 
	$chunk_boÙ
()

710 #ifdeà
_WIN32


711 
SYSTEM_INFO
 
šfo
;

712 
	`G‘Sy¡emInfo
(&
šfo
);

718 ià(
šfo
.
dwPageSize
 & ((1U << 
LG_PAGE
) - 1))

719  (
Œue
);

725 ià(!
İt_lg_chunk
) {

726 
İt_lg_chunk
 = 
	`ffs_u
(()
šfo
.
dwAÎoÿtiÚG¿nuÏr™y
)

730 ià(!
İt_lg_chunk
)

731 
İt_lg_chunk
 = 
LG_CHUNK_DEFAULT
;

735 
chunksize
 = (
	`ZU
(1è<< 
İt_lg_chunk
);

736 
	`as£¹
(
chunksize
 >ğ
PAGE
);

737 
chunksize_mask
 = 
chunksize
 - 1;

738 
chunk_Åages
 = (
chunksize
 >> 
LG_PAGE
);

740 ià(
have_dss
 && 
	`chunk_dss_boÙ
())

741  (
Œue
);

742 ià(
	`¹»e_Ãw
(&
chunks_¹»e
, ()((
	`ZU
(1è<< (
LG_SIZEOF_PTR
+3)) -

743 
İt_lg_chunk
), 
chunks_¹»e_node_®loc
, 
NULL
))

744  (
Œue
);

746  (
çl£
);

747 
	}
}

750 
	$chunk_´efÜk
(
tsdn_t
 *
tsdn
)

753 
	`chunk_dss_´efÜk
(
tsdn
);

754 
	}
}

757 
	$chunk_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
)

760 
	`chunk_dss_po¡fÜk_·»Á
(
tsdn
);

761 
	}
}

764 
	$chunk_po¡fÜk_chd
(
tsdn_t
 *
tsdn
)

767 
	`chunk_dss_po¡fÜk_chd
(
tsdn
);

768 
	}
}

	@dep/jemalloc-4.2.0/src/chunk_dss.c

1 
	#JEMALLOC_CHUNK_DSS_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

6 cÚ¡ *
	gdss_´ec_Çmes
[] = {

14 
dss_´ec_t
 
	gdss_´ec_deçuÉ
 = 
DSS_PREC_DEFAULT
;

20 
m®loc_mu‹x_t
 
	gdss_mtx
;

23 *
	gdss_ba£
;

25 *
	gdss_´ev
;

27 *
	gdss_max
;

32 
	$chunk_dss_sbrk
(
šŒ_t
 
šüem’t
)

35 #ifdeà
JEMALLOC_DSS


36  (
	`sbrk
(
šüem’t
));

38 
	`nÙ_im¶em’‹d
();

39  (
NULL
);

41 
	}
}

43 
dss_´ec_t


44 
	$chunk_dss_´ec_g‘
(
tsdn_t
 *
tsdn
)

46 
dss_´ec_t
 
»t
;

48 ià(!
have_dss
)

49  (
dss_´ec_di§bËd
);

50 
	`m®loc_mu‹x_lock
(
tsdn
, &
dss_mtx
);

51 
»t
 = 
dss_´ec_deçuÉ
;

52 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
dss_mtx
);

53  (
»t
);

54 
	}
}

56 
boŞ


57 
	$chunk_dss_´ec_£t
(
tsdn_t
 *
tsdn
, 
dss_´ec_t
 
dss_´ec
)

60 ià(!
have_dss
)

61  (
dss_´ec
 !ğ
dss_´ec_di§bËd
);

62 
	`m®loc_mu‹x_lock
(
tsdn
, &
dss_mtx
);

63 
dss_´ec_deçuÉ
 = 
dss_´ec
;

64 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
dss_mtx
);

65  (
çl£
);

66 
	}
}

69 
	$chunk_®loc_dss
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, *
Ãw_addr
, 
size_t
 
size
,

70 
size_t
 
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
)

72 
	`ÿs£¹
(
have_dss
);

73 
	`as£¹
(
size
 > 0 && (siz& 
chunksize_mask
) == 0);

74 
	`as£¹
(
®ignm’t
 > 0 && (®ignm’ˆ& 
chunksize_mask
) == 0);

80 ià((
šŒ_t
)
size
 < 0)

81  (
NULL
);

83 
	`m®loc_mu‹x_lock
(
tsdn
, &
dss_mtx
);

84 ià(
dss_´ev
 != (*)-1) {

92 *
»t
, *
ıad
, *
dss_Ãxt
;

93 
size_t
 
g­_size
, 
ıad_size
;

94 
šŒ_t
 
šü
;

96 ià(
Ãw_addr
 !ğ
NULL
 && 
dss_max
 !=‚ew_addr)

100 
dss_max
 = 
	`chunk_dss_sbrk
(0);

103 ià(
Ãw_addr
 !ğ
NULL
 && 
dss_max
 !=‚ew_addr)

110 
g­_size
 = (
chunksize
 - 
	`CHUNK_ADDR2OFFSET
(
dss_max
)) &

111 
chunksize_mask
;

117 
ıad
 = (*)((
ušŒ_t
)
dss_max
 + 
g­_size
);

118 
»t
 = (*)
	`ALIGNMENT_CEILING
((
ušŒ_t
)
dss_max
,

119 
®ignm’t
);

120 
ıad_size
 = (
ušŒ_t
)
»t
 - (ušŒ_t)
ıad
;

121 
dss_Ãxt
 = (*)((
ušŒ_t
)
»t
 + 
size
);

122 ià((
ušŒ_t
)
»t
 < (ušŒ_t)
dss_max
 ||

123 (
ušŒ_t
)
dss_Ãxt
 < (ušŒ_t)
dss_max
) {

125 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
dss_mtx
);

126  (
NULL
);

128 
šü
 = 
g­_size
 + 
ıad_size
 + 
size
;

129 
dss_´ev
 = 
	`chunk_dss_sbrk
(
šü
);

130 ià(
dss_´ev
 =ğ
dss_max
) {

132 
dss_max
 = 
dss_Ãxt
;

133 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
dss_mtx
);

134 ià(
ıad_size
 != 0) {

135 
chunk_hooks_t
 
chunk_hooks
 =

136 
CHUNK_HOOKS_INITIALIZER
;

137 
	`chunk_d®loc_w¿µ”
(
tsdn
, 
¬’a
,

138 &
chunk_hooks
, 
ıad
, 
ıad_size
,

139 
çl£
, 
Œue
);

141 ià(*
z”o
) {

142 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(

143 
»t
, 
size
);

144 
	`mem£t
(
»t
, 0, 
size
);

146 ià(!*
comm™
)

147 *
comm™
 = 
	`·ges_decomm™
(
»t
, 
size
);

148  (
»t
);

150 } 
dss_´ev
 != (*)-1);

152 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
dss_mtx
);

154  (
NULL
);

155 
	}
}

157 
boŞ


158 
	$chunk_š_dss
(
tsdn_t
 *
tsdn
, *
chunk
)

160 
boŞ
 
»t
;

162 
	`ÿs£¹
(
have_dss
);

164 
	`m®loc_mu‹x_lock
(
tsdn
, &
dss_mtx
);

165 ià((
ušŒ_t
)
chunk
 >ğ(ušŒ_t)
dss_ba£


166 && (
ušŒ_t
)
chunk
 < (ušŒ_t)
dss_max
)

167 
»t
 = 
Œue
;

169 
»t
 = 
çl£
;

170 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
dss_mtx
);

172  (
»t
);

173 
	}
}

175 
boŞ


176 
	$chunk_dss_boÙ
()

179 
	`ÿs£¹
(
have_dss
);

181 ià(
	`m®loc_mu‹x_š™
(&
dss_mtx
, "dss", 
WITNESS_RANK_DSS
))

182  (
Œue
);

183 
dss_ba£
 = 
	`chunk_dss_sbrk
(0);

184 
dss_´ev
 = 
dss_ba£
;

185 
dss_max
 = 
dss_ba£
;

187  (
çl£
);

188 
	}
}

191 
	$chunk_dss_´efÜk
(
tsdn_t
 *
tsdn
)

194 ià(
have_dss
)

195 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
dss_mtx
);

196 
	}
}

199 
	$chunk_dss_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
)

202 ià(
have_dss
)

203 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
dss_mtx
);

204 
	}
}

207 
	$chunk_dss_po¡fÜk_chd
(
tsdn_t
 *
tsdn
)

210 ià(
have_dss
)

211 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
dss_mtx
);

212 
	}
}

	@dep/jemalloc-4.2.0/src/chunk_mmap.c

1 
	#JEMALLOC_CHUNK_MMAP_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
	$chunk_®loc_mm­_¦ow
(
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
)

9 *
»t
;

10 
size_t
 
®loc_size
;

12 
®loc_size
 = 
size
 + 
®ignm’t
;

14 ià(
®loc_size
 < 
size
)

15  (
NULL
);

17 *
·ges
;

18 
size_t
 
Ëadsize
;

19 
·ges
 = 
	`·ges_m­
(
NULL
, 
®loc_size
, 
comm™
);

20 ià(
·ges
 =ğ
NULL
)

21  (
NULL
);

22 
Ëadsize
 = 
	`ALIGNMENT_CEILING
((
ušŒ_t
)
·ges
, 
®ignm’t
) -

23 (
ušŒ_t
)
·ges
;

24 
»t
 = 
	`·ges_Œim
(
·ges
, 
®loc_size
, 
Ëadsize
, 
size
, 
comm™
);

25 } 
»t
 =ğ
NULL
);

27 
	`as£¹
(
»t
 !ğ
NULL
);

28 *
z”o
 = 
Œue
;

29  (
»t
);

30 
	}
}

33 
	$chunk_®loc_mm­
(*
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
,

34 
boŞ
 *
comm™
)

36 *
»t
;

37 
size_t
 
off£t
;

52 
	`as£¹
(
®ignm’t
 != 0);

53 
	`as£¹
((
®ignm’t
 & 
chunksize_mask
) == 0);

55 
»t
 = 
	`·ges_m­
(
Ãw_addr
, 
size
, 
comm™
);

56 ià(
»t
 =ğ
NULL
 ||„‘ =ğ
Ãw_addr
)

57  (
»t
);

58 
	`as£¹
(
Ãw_addr
 =ğ
NULL
);

59 
off£t
 = 
	`ALIGNMENT_ADDR2OFFSET
(
»t
, 
®ignm’t
);

60 ià(
off£t
 != 0) {

61 
	`·ges_unm­
(
»t
, 
size
);

62  (
	`chunk_®loc_mm­_¦ow
(
size
, 
®ignm’t
, 
z”o
, 
comm™
));

65 
	`as£¹
(
»t
 !ğ
NULL
);

66 *
z”o
 = 
Œue
;

67  (
»t
);

68 
	}
}

70 
boŞ


71 
	$chunk_d®loc_mm­
(*
chunk
, 
size_t
 
size
)

74 ià(
cÚfig_munm­
)

75 
	`·ges_unm­
(
chunk
, 
size
);

77  (!
cÚfig_munm­
);

78 
	}
}

	@dep/jemalloc-4.2.0/src/ckh.c

37 
	#JEMALLOC_CKH_C_


	)

38 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

43 
boŞ
 
ckh_grow
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
);

44 
ckh_shršk
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
);

52 
JEMALLOC_INLINE_C
 
size_t


53 
	$ckh_buck‘_£¬ch
(
ckh_t
 *
ckh
, 
size_t
 
buck‘
, cÚ¡ *
key
)

55 
ckhc_t
 *
ûÎ
;

56 
i
;

58 
i
 = 0; i < (
	`ZU
(1è<< 
LG_CKH_BUCKET_CELLS
); i++) {

59 
ûÎ
 = &
ckh
->
b
[(
buck‘
 << 
LG_CKH_BUCKET_CELLS
è+ 
i
];

60 ià(
ûÎ
->
key
 !ğ
NULL
 && 
ckh
->
	`keycomp
(key, cell->key))

61  ((
buck‘
 << 
LG_CKH_BUCKET_CELLS
è+ 
i
);

64  (
SIZE_T_MAX
);

65 
	}
}

70 
JEMALLOC_INLINE_C
 
size_t


71 
	$ckh_i£¬ch
(
ckh_t
 *
ckh
, cÚ¡ *
key
)

73 
size_t
 
hashes
[2], 
buck‘
, 
ûÎ
;

75 
	`as£¹
(
ckh
 !ğ
NULL
);

77 
ckh
->
	`hash
(
key
, 
hashes
);

80 
buck‘
 = 
hashes
[0] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

81 
ûÎ
 = 
	`ckh_buck‘_£¬ch
(
ckh
, 
buck‘
, 
key
);

82 ià(
ûÎ
 !ğ
SIZE_T_MAX
)

83  (
ûÎ
);

86 
buck‘
 = 
hashes
[1] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

87 
ûÎ
 = 
	`ckh_buck‘_£¬ch
(
ckh
, 
buck‘
, 
key
);

88  (
ûÎ
);

89 
	}
}

91 
JEMALLOC_INLINE_C
 
boŞ


92 
	$ckh_Œy_buck‘_š£¹
(
ckh_t
 *
ckh
, 
size_t
 
buck‘
, cÚ¡ *
key
,

93 cÚ¡ *
d©a
)

95 
ckhc_t
 *
ûÎ
;

96 
off£t
, 
i
;

102 
off£t
 = ()
	`´ng_lg_¿nge
(&
ckh
->
´ng_¡©e
, 
LG_CKH_BUCKET_CELLS
);

103 
i
 = 0; i < (
	`ZU
(1è<< 
LG_CKH_BUCKET_CELLS
); i++) {

104 
ûÎ
 = &
ckh
->
b
[(
buck‘
 << 
LG_CKH_BUCKET_CELLS
) +

105 ((
i
 + 
off£t
è& ((
	`ZU
(1è<< 
LG_CKH_BUCKET_CELLS
) - 1))];

106 ià(
ûÎ
->
key
 =ğ
NULL
) {

107 
ûÎ
->
key
 = key;

108 
ûÎ
->
d©a
 = data;

109 
ckh
->
couÁ
++;

110  (
çl£
);

114  (
Œue
);

115 
	}
}

123 
JEMALLOC_INLINE_C
 
boŞ


124 
	$ckh_eviù_»loc_š£¹
(
ckh_t
 *
ckh
, 
size_t
 
¬gbuck‘
, cÚ¡ **
¬gkey
,

125 cÚ¡ **
¬gd©a
)

127 cÚ¡ *
key
, *
d©a
, *
tkey
, *
td©a
;

128 
ckhc_t
 *
ûÎ
;

129 
size_t
 
hashes
[2], 
buck‘
, 
tbuck‘
;

130 
i
;

132 
buck‘
 = 
¬gbuck‘
;

133 
key
 = *
¬gkey
;

134 
d©a
 = *
¬gd©a
;

135 
Œue
) {

144 
i
 = ()
	`´ng_lg_¿nge
(&
ckh
->
´ng_¡©e
,

145 
LG_CKH_BUCKET_CELLS
);

146 
ûÎ
 = &
ckh
->
b
[(
buck‘
 << 
LG_CKH_BUCKET_CELLS
è+ 
i
];

147 
	`as£¹
(
ûÎ
->
key
 !ğ
NULL
);

150 
tkey
 = 
ûÎ
->
key
; 
td©a
 = c–l->
d©a
;

151 
ûÎ
->
key
 = key; c–l->
d©a
 = data;

152 
key
 = 
tkey
; 
d©a
 = 
td©a
;

154 #ifdeà
CKH_COUNT


155 
ckh
->
Ä–ocs
++;

159 
ckh
->
	`hash
(
key
, 
hashes
);

160 
tbuck‘
 = 
hashes
[1] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

161 ià(
tbuck‘
 =ğ
buck‘
) {

162 
tbuck‘
 = 
hashes
[0] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
)

182 ià(
tbuck‘
 =ğ
¬gbuck‘
) {

183 *
¬gkey
 = 
key
;

184 *
¬gd©a
 = 
d©a
;

185  (
Œue
);

188 
buck‘
 = 
tbuck‘
;

189 ià(!
	`ckh_Œy_buck‘_š£¹
(
ckh
, 
buck‘
, 
key
, 
d©a
))

190  (
çl£
);

192 
	}
}

194 
JEMALLOC_INLINE_C
 
boŞ


195 
	$ckh_Œy_š£¹
(
ckh_t
 *
ckh
, cÚ¡**
¬gkey
, cÚ¡**
¬gd©a
)

197 
size_t
 
hashes
[2], 
buck‘
;

198 cÚ¡ *
key
 = *
¬gkey
;

199 cÚ¡ *
d©a
 = *
¬gd©a
;

201 
ckh
->
	`hash
(
key
, 
hashes
);

204 
buck‘
 = 
hashes
[0] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

205 ià(!
	`ckh_Œy_buck‘_š£¹
(
ckh
, 
buck‘
, 
key
, 
d©a
))

206  (
çl£
);

209 
buck‘
 = 
hashes
[1] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

210 ià(!
	`ckh_Œy_buck‘_š£¹
(
ckh
, 
buck‘
, 
key
, 
d©a
))

211  (
çl£
);

216  (
	`ckh_eviù_»loc_š£¹
(
ckh
, 
buck‘
, 
¬gkey
, 
¬gd©a
));

217 
	}
}

223 
JEMALLOC_INLINE_C
 
boŞ


224 
	$ckh_»bud
(
ckh_t
 *
ckh
, 
ckhc_t
 *
aTab
)

226 
size_t
 
couÁ
, 
i
, 
nšs
;

227 cÚ¡ *
key
, *
d©a
;

229 
couÁ
 = 
ckh
->count;

230 
ckh
->
couÁ
 = 0;

231 
i
 = 
nšs
 = 0;‚š < 
couÁ
; i++) {

232 ià(
aTab
[
i
].
key
 !ğ
NULL
) {

233 
key
 = 
aTab
[
i
].key;

234 
d©a
 = 
aTab
[
i
].data;

235 ià(
	`ckh_Œy_š£¹
(
ckh
, &
key
, &
d©a
)) {

236 
ckh
->
couÁ
 = count;

237  (
Œue
);

239 
nšs
++;

243  (
çl£
);

244 
	}
}

246 
boŞ


247 
	$ckh_grow
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
)

249 
boŞ
 
»t
;

250 
ckhc_t
 *
b
, *
‰ab
;

251 
lg_´evbuck‘s
, 
lg_curûÎs
;

253 #ifdeà
CKH_COUNT


254 
ckh
->
ngrows
++;

262 
lg_´evbuck‘s
 = 
ckh
->
lg_curbuck‘s
;

263 
lg_curûÎs
 = 
ckh
->
lg_curbuck‘s
 + 
LG_CKH_BUCKET_CELLS
;

264 
Œue
) {

265 
size_t
 
usize
;

267 
lg_curûÎs
++;

268 
usize
 = 
	`§2u
((
ckhc_t
è<< 
lg_curûÎs
, 
CACHELINE
);

269 ià(
	`uÆik–y
(
usize
 =ğ0 || usiz> 
HUGE_MAXCLASS
)) {

270 
»t
 = 
Œue
;

271 
Ïb–_»tuº
;

273 
b
 = (
ckhc_t
 *)
	`®locztm
(
tsdn
, 
usize
, 
CACHELINE
, 
Œue
, 
NULL
,

274 
Œue
, 
	`¬’a_ichoo£
(
tsdn
, 
NULL
));

275 ià(
b
 =ğ
NULL
) {

276 
»t
 = 
Œue
;

277 
Ïb–_»tuº
;

280 
‰ab
 = 
ckh
->
b
;

281 
ckh
->
b
 =ab;

282 
b
 = 
‰ab
;

283 
ckh
->
lg_curbuck‘s
 = 
lg_curûÎs
 - 
LG_CKH_BUCKET_CELLS
;

285 ià(!
	`ckh_»bud
(
ckh
, 
b
)) {

286 
	`id®loùm
(
tsdn
, 
b
, 
NULL
, 
Œue
,rue);

291 
	`id®loùm
(
tsdn
, 
ckh
->
b
, 
NULL
, 
Œue
,rue);

292 
ckh
->
b
 =ab;

293 
ckh
->
lg_curbuck‘s
 = 
lg_´evbuck‘s
;

296 
»t
 = 
çl£
;

297 
Ïb–_»tuº
:

298  (
»t
);

299 
	}
}

302 
	$ckh_shršk
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
)

304 
ckhc_t
 *
b
, *
‰ab
;

305 
size_t
 
usize
;

306 
lg_´evbuck‘s
, 
lg_curûÎs
;

312 
lg_´evbuck‘s
 = 
ckh
->
lg_curbuck‘s
;

313 
lg_curûÎs
 = 
ckh
->
lg_curbuck‘s
 + 
LG_CKH_BUCKET_CELLS
 - 1;

314 
usize
 = 
	`§2u
((
ckhc_t
è<< 
lg_curûÎs
, 
CACHELINE
);

315 ià(
	`uÆik–y
(
usize
 =ğ0 || usiz> 
HUGE_MAXCLASS
))

317 
b
 = (
ckhc_t
 *)
	`®locztm
(
tsdn
, 
usize
, 
CACHELINE
, 
Œue
, 
NULL
,rue,

318 
	`¬’a_ichoo£
(
tsdn
, 
NULL
));

319 ià(
b
 =ğ
NULL
) {

327 
‰ab
 = 
ckh
->
b
;

328 
ckh
->
b
 =ab;

329 
b
 = 
‰ab
;

330 
ckh
->
lg_curbuck‘s
 = 
lg_curûÎs
 - 
LG_CKH_BUCKET_CELLS
;

332 ià(!
	`ckh_»bud
(
ckh
, 
b
)) {

333 
	`id®loùm
(
tsdn
, 
b
, 
NULL
, 
Œue
,rue);

334 #ifdeà
CKH_COUNT


335 
ckh
->
nshršks
++;

341 
	`id®loùm
(
tsdn
, 
ckh
->
b
, 
NULL
, 
Œue
,rue);

342 
ckh
->
b
 =ab;

343 
ckh
->
lg_curbuck‘s
 = 
lg_´evbuck‘s
;

344 #ifdeà
CKH_COUNT


345 
ckh
->
nshrškçs
++;

347 
	}
}

349 
boŞ


350 
	$ckh_Ãw
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
, 
size_t
 
mš™ems
, 
ckh_hash_t
 *
hash
,

351 
ckh_keycomp_t
 *
keycomp
)

353 
boŞ
 
»t
;

354 
size_t
 
mšûÎs
, 
usize
;

355 
lg_mšûÎs
;

357 
	`as£¹
(
mš™ems
 > 0);

358 
	`as£¹
(
hash
 !ğ
NULL
);

359 
	`as£¹
(
keycomp
 !ğ
NULL
);

361 #ifdeà
CKH_COUNT


362 
ckh
->
ngrows
 = 0;

363 
ckh
->
nshršks
 = 0;

364 
ckh
->
nshrškçs
 = 0;

365 
ckh
->
nš£¹s
 = 0;

366 
ckh
->
Ä–ocs
 = 0;

368 
ckh
->
´ng_¡©e
 = 42;

369 
ckh
->
couÁ
 = 0;

378 
	`as£¹
(
LG_CKH_BUCKET_CELLS
 > 0);

379 
mšûÎs
 = ((
mš™ems
 + (3 - (minitems % 3))) / 3) << 2;

380 
lg_mšûÎs
 = 
LG_CKH_BUCKET_CELLS
;

381 (
	`ZU
(1è<< 
lg_mšûÎs
è< 
mšûÎs
;

382 
lg_mšûÎs
++)

384 
ckh
->
lg_mšbuck‘s
 = 
lg_mšûÎs
 - 
LG_CKH_BUCKET_CELLS
;

385 
ckh
->
lg_curbuck‘s
 = 
lg_mšûÎs
 - 
LG_CKH_BUCKET_CELLS
;

386 
ckh
->
hash
 = hash;

387 
ckh
->
keycomp
 = keycomp;

389 
usize
 = 
	`§2u
((
ckhc_t
è<< 
lg_mšûÎs
, 
CACHELINE
);

390 ià(
	`uÆik–y
(
usize
 =ğ0 || usiz> 
HUGE_MAXCLASS
)) {

391 
»t
 = 
Œue
;

392 
Ïb–_»tuº
;

394 
ckh
->
b
 = (
ckhc_t
 *)
	`®locztm
(
tsdn
, 
usize
, 
CACHELINE
, 
Œue
, 
NULL
,

395 
Œue
, 
	`¬’a_ichoo£
(
tsdn
, 
NULL
));

396 ià(
ckh
->
b
 =ğ
NULL
) {

397 
»t
 = 
Œue
;

398 
Ïb–_»tuº
;

401 
»t
 = 
çl£
;

402 
Ïb–_»tuº
:

403  (
»t
);

404 
	}
}

407 
	$ckh_d–‘e
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
)

410 
	`as£¹
(
ckh
 !ğ
NULL
);

412 #ifdeà
CKH_VERBOSE


413 
	`m®loc_´štf
(

414 "%s(%p):‚grows: %"
FMTu64
",‚shrinks: %"FMTu64","

415 "‚shrškçs: %"
FMTu64
",‚inserts: %"FMTu64","

416 "‚»locs: %"
FMTu64
"\n", 
__func__
, 
ckh
,

417 ()
ckh
->
ngrows
,

418 ()
ckh
->
nshršks
,

419 ()
ckh
->
nshrškçs
,

420 ()
ckh
->
nš£¹s
,

421 ()
ckh
->
Ä–ocs
);

424 
	`id®loùm
(
tsdn
, 
ckh
->
b
, 
NULL
, 
Œue
,rue);

425 ià(
cÚfig_debug
)

426 
	`mem£t
(
ckh
, 
JEMALLOC_FREE_JUNK
, (
ckh_t
));

427 
	}
}

429 
size_t


430 
	$ckh_couÁ
(
ckh_t
 *
ckh
)

433 
	`as£¹
(
ckh
 !ğ
NULL
);

435  (
ckh
->
couÁ
);

436 
	}
}

438 
boŞ


439 
	$ckh_™”
(
ckh_t
 *
ckh
, 
size_t
 *
bšd
, **
key
, **
d©a
)

441 
size_t
 
i
, 
nûÎs
;

443 
i
 = *
bšd
, 
nûÎs
 = (
	`ZU
(1è<< (
ckh
->
lg_curbuck‘s
 +

444 
LG_CKH_BUCKET_CELLS
)); 
i
 < 
nûÎs
; i++) {

445 ià(
ckh
->
b
[
i
].
key
 !ğ
NULL
) {

446 ià(
key
 !ğ
NULL
)

447 *
key
 = (*)
ckh
->
b
[
i
].key;

448 ià(
d©a
 !ğ
NULL
)

449 *
d©a
 = (*)
ckh
->
b
[
i
].data;

450 *
bšd
 = 
i
 + 1;

451  (
çl£
);

455  (
Œue
);

456 
	}
}

458 
boŞ


459 
	$ckh_š£¹
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
, cÚ¡ *
key
, cÚ¡ *
d©a
)

461 
boŞ
 
»t
;

463 
	`as£¹
(
ckh
 !ğ
NULL
);

464 
	`as£¹
(
	`ckh_£¬ch
(
ckh
, 
key
, 
NULL
, NULL));

466 #ifdeà
CKH_COUNT


467 
ckh
->
nš£¹s
++;

470 
	`ckh_Œy_š£¹
(
ckh
, &
key
, &
d©a
)) {

471 ià(
	`ckh_grow
(
tsdn
, 
ckh
)) {

472 
»t
 = 
Œue
;

473 
Ïb–_»tuº
;

477 
»t
 = 
çl£
;

478 
Ïb–_»tuº
:

479  (
»t
);

480 
	}
}

482 
boŞ


483 
	$ckh_»move
(
tsdn_t
 *
tsdn
, 
ckh_t
 *
ckh
, cÚ¡ *
£¬chkey
, **
key
,

484 **
d©a
)

486 
size_t
 
ûÎ
;

488 
	`as£¹
(
ckh
 !ğ
NULL
);

490 
ûÎ
 = 
	`ckh_i£¬ch
(
ckh
, 
£¬chkey
);

491 ià(
ûÎ
 !ğ
SIZE_T_MAX
) {

492 ià(
key
 !ğ
NULL
)

493 *
key
 = (*)
ckh
->
b
[
ûÎ
].key;

494 ià(
d©a
 !ğ
NULL
)

495 *
d©a
 = (*)
ckh
->
b
[
ûÎ
].data;

496 
ckh
->
b
[
ûÎ
].
key
 = 
NULL
;

497 
ckh
->
b
[
ûÎ
].
d©a
 = 
NULL
;

499 
ckh
->
couÁ
--;

501 ià(
ckh
->
couÁ
 < (
	`ZU
(1è<< (ckh->
lg_curbuck‘s


502 + 
LG_CKH_BUCKET_CELLS
 - 2)è&& 
ckh
->
lg_curbuck‘s


503 > 
ckh
->
lg_mšbuck‘s
) {

505 
	`ckh_shršk
(
tsdn
, 
ckh
);

508  (
çl£
);

511  (
Œue
);

512 
	}
}

514 
boŞ


515 
	$ckh_£¬ch
(
ckh_t
 *
ckh
, cÚ¡ *
£¬chkey
, **
key
, **
d©a
)

517 
size_t
 
ûÎ
;

519 
	`as£¹
(
ckh
 !ğ
NULL
);

521 
ûÎ
 = 
	`ckh_i£¬ch
(
ckh
, 
£¬chkey
);

522 ià(
ûÎ
 !ğ
SIZE_T_MAX
) {

523 ià(
key
 !ğ
NULL
)

524 *
key
 = (*)
ckh
->
b
[
ûÎ
].key;

525 ià(
d©a
 !ğ
NULL
)

526 *
d©a
 = (*)
ckh
->
b
[
ûÎ
].data;

527  (
çl£
);

530  (
Œue
);

531 
	}
}

534 
	$ckh_¡ršg_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2])

537 
	`hash
(
key
, 
	`¡¾’
((cÚ¡ *)key), 0x94122f33U, 
r_hash
);

538 
	}
}

540 
boŞ


541 
	$ckh_¡ršg_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
)

544 
	`as£¹
(
k1
 !ğ
NULL
);

545 
	`as£¹
(
k2
 !ğ
NULL
);

547  (
	`¡rcmp
((*)
k1
, (*)
k2
è? 
çl£
 : 
Œue
);

548 
	}
}

551 
	$ckh_poš‹r_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2])

554 cÚ¡ *
v
;

555 
size_t
 
i
;

556 } 
u
;

558 
	`as£¹
((
u
.
v
è=ğ(u.
i
));

559 
u
.
v
 = 
key
;

560 
	`hash
(&
u
.
i
, (u.i), 0xd983396eU, 
r_hash
);

561 
	}
}

563 
boŞ


564 
	$ckh_poš‹r_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
)

567  ((
k1
 =ğ
k2
è? 
Œue
 : 
çl£
);

568 
	}
}

	@dep/jemalloc-4.2.0/src/ctl.c

1 
	#JEMALLOC_CTL_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

11 
m®loc_mu‹x_t
 
	gùl_mtx
;

12 
boŞ
 
	gùl_š™Ÿlized
;

13 
ušt64_t
 
	gùl_•och
;

14 
ùl_¡©s_t
 
	gùl_¡©s
;

19 
JEMALLOC_INLINE_C
 cÚ¡ 
ùl_Çmed_node_t
 *

20 
	$ùl_Çmed_node
(cÚ¡ 
ùl_node_t
 *
node
)

23  ((
node
->
Çmed
è? (cÚ¡ 
ùl_Çmed_node_t
 *êod: 
NULL
);

24 
	}
}

26 
JEMALLOC_INLINE_C
 cÚ¡ 
ùl_Çmed_node_t
 *

27 
	$ùl_Çmed_chd»n
(cÚ¡ 
ùl_Çmed_node_t
 *
node
, 
size_t
 
šdex
)

29 cÚ¡ 
ùl_Çmed_node_t
 *
chd»n
 = 
	`ùl_Çmed_node
(
node
->children);

31  (
chd»n
 ? &chd»n[
šdex
] : 
NULL
);

32 
	}
}

34 
JEMALLOC_INLINE_C
 cÚ¡ 
ùl_šdexed_node_t
 *

35 
	$ùl_šdexed_node
(cÚ¡ 
ùl_node_t
 *
node
)

38  (!
node
->
Çmed
 ? (cÚ¡ 
ùl_šdexed_node_t
 *êod: 
NULL
);

39 
	}
}

44 
	#CTL_PROTO
(
n
) \

45 
n
##
	`_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, \

46 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

	)

48 
	#INDEX_PROTO
(
n
) \

49 cÚ¡ 
ùl_Çmed_node_t
 *
n
##
	`_šdex
(
tsdn_t
 *
tsdn
, \

50 cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
);

	)

52 
boŞ
 
ùl_¬’a_š™
(
ùl_¬’a_¡©s_t
 *
a¡©s
);

53 
ùl_¬’a_ş—r
(
ùl_¬’a_¡©s_t
 *
a¡©s
);

54 
ùl_¬’a_¡©s_am”ge
(
tsdn_t
 *
tsdn
, 
ùl_¬’a_¡©s_t
 *
c¡©s
,

55 
¬’a_t
 *
¬’a
);

56 
ùl_¬’a_¡©s_sm”ge
(
ùl_¬’a_¡©s_t
 *
s¡©s
,

57 
ùl_¬’a_¡©s_t
 *
a¡©s
);

58 
ùl_¬’a_»äesh
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
i
);

59 
boŞ
 
ùl_grow
(
tsdn_t
 *
tsdn
);

60 
ùl_»äesh
(
tsdn_t
 *
tsdn
);

61 
boŞ
 
ùl_š™
(
tsdn_t
 *
tsdn
);

62 
ùl_lookup
(
tsdn_t
 *
tsdn
, cÚ¡ *
Çme
,

63 
ùl_node_t
 cÚ¡ **
node¥
, 
size_t
 *
mibp
, size_ˆ*
d•thp
);

65 
	$CTL_PROTO
(
v”siÚ
)

66 
	$CTL_PROTO
(
•och
)

67 
	$CTL_PROTO
(
th»ad_tÿche_’abËd
)

68 
	$CTL_PROTO
(
th»ad_tÿche_æush
)

69 
	$CTL_PROTO
(
th»ad_´of_Çme
)

70 
	$CTL_PROTO
(
th»ad_´of_aùive
)

71 
	$CTL_PROTO
(
th»ad_¬’a
)

72 
	$CTL_PROTO
(
th»ad_®loÿ‹d
)

73 
	$CTL_PROTO
(
th»ad_®loÿ‹dp
)

74 
	$CTL_PROTO
(
th»ad_d—Îoÿ‹d
)

75 
	$CTL_PROTO
(
th»ad_d—Îoÿ‹dp
)

76 
	$CTL_PROTO
(
cÚfig_ÿche_oblivious
)

77 
	$CTL_PROTO
(
cÚfig_debug
)

78 
	$CTL_PROTO
(
cÚfig_fl
)

79 
	$CTL_PROTO
(
cÚfig_Ïzy_lock
)

80 
	$CTL_PROTO
(
cÚfig_m®loc_cÚf
)

81 
	$CTL_PROTO
(
cÚfig_munm­
)

82 
	$CTL_PROTO
(
cÚfig_´of
)

83 
	$CTL_PROTO
(
cÚfig_´of_libgcc
)

84 
	$CTL_PROTO
(
cÚfig_´of_libunwšd
)

85 
	$CTL_PROTO
(
cÚfig_¡©s
)

86 
	$CTL_PROTO
(
cÚfig_tÿche
)

87 
	$CTL_PROTO
(
cÚfig_s
)

88 
	$CTL_PROTO
(
cÚfig_uŒaû
)

89 
	$CTL_PROTO
(
cÚfig_v®gršd
)

90 
	$CTL_PROTO
(
cÚfig_xm®loc
)

91 
	$CTL_PROTO
(
İt_abÜt
)

92 
	$CTL_PROTO
(
İt_dss
)

93 
	$CTL_PROTO
(
İt_lg_chunk
)

94 
	$CTL_PROTO
(
İt_Ç»Çs
)

95 
	$CTL_PROTO
(
İt_purge
)

96 
	$CTL_PROTO
(
İt_lg_dœty_muÉ
)

97 
	$CTL_PROTO
(
İt_deÿy_time
)

98 
	$CTL_PROTO
(
İt_¡©s_´št
)

99 
	$CTL_PROTO
(
İt_junk
)

100 
	$CTL_PROTO
(
İt_z”o
)

101 
	$CTL_PROTO
(
İt_qu¬ªtše
)

102 
	$CTL_PROTO
(
İt_»dzÚe
)

103 
	$CTL_PROTO
(
İt_uŒaû
)

104 
	$CTL_PROTO
(
İt_xm®loc
)

105 
	$CTL_PROTO
(
İt_tÿche
)

106 
	$CTL_PROTO
(
İt_lg_tÿche_max
)

107 
	$CTL_PROTO
(
İt_´of
)

108 
	$CTL_PROTO
(
İt_´of_´efix
)

109 
	$CTL_PROTO
(
İt_´of_aùive
)

110 
	$CTL_PROTO
(
İt_´of_th»ad_aùive_š™
)

111 
	$CTL_PROTO
(
İt_lg_´of_§m¶e
)

112 
	$CTL_PROTO
(
İt_lg_´of_š‹rv®
)

113 
	$CTL_PROTO
(
İt_´of_gdump
)

114 
	$CTL_PROTO
(
İt_´of_fš®
)

115 
	$CTL_PROTO
(
İt_´of_Ëak
)

116 
	$CTL_PROTO
(
İt_´of_accum
)

117 
	$CTL_PROTO
(
tÿche_ü—‹
)

118 
	$CTL_PROTO
(
tÿche_æush
)

119 
	$CTL_PROTO
(
tÿche_de¡roy
)

120 
	`¬’a_i_purge
(
tsdn_t
 *
tsdn
, 
¬’a_šd
, 
boŞ
 
®l
);

121 
	$CTL_PROTO
(
¬’a_i_purge
)

122 
	$CTL_PROTO
(
¬’a_i_deÿy
)

123 
	$CTL_PROTO
(
¬’a_i_»£t
)

124 
	$CTL_PROTO
(
¬’a_i_dss
)

125 
	$CTL_PROTO
(
¬’a_i_lg_dœty_muÉ
)

126 
	$CTL_PROTO
(
¬’a_i_deÿy_time
)

127 
	$CTL_PROTO
(
¬’a_i_chunk_hooks
)

128 
	$INDEX_PROTO
(
¬’a_i
)

129 
	$CTL_PROTO
(
¬’as_bš_i_size
)

130 
	$CTL_PROTO
(
¬’as_bš_i_Äegs
)

131 
	$CTL_PROTO
(
¬’as_bš_i_run_size
)

132 
	$INDEX_PROTO
(
¬’as_bš_i
)

133 
	$CTL_PROTO
(
¬’as_Ìun_i_size
)

134 
	$INDEX_PROTO
(
¬’as_Ìun_i
)

135 
	$CTL_PROTO
(
¬’as_hchunk_i_size
)

136 
	$INDEX_PROTO
(
¬’as_hchunk_i
)

137 
	$CTL_PROTO
(
¬’as_Ç»Çs
)

138 
	$CTL_PROTO
(
¬’as_š™Ÿlized
)

139 
	$CTL_PROTO
(
¬’as_lg_dœty_muÉ
)

140 
	$CTL_PROTO
(
¬’as_deÿy_time
)

141 
	$CTL_PROTO
(
¬’as_quªtum
)

142 
	$CTL_PROTO
(
¬’as_·ge
)

143 
	$CTL_PROTO
(
¬’as_tÿche_max
)

144 
	$CTL_PROTO
(
¬’as_nbšs
)

145 
	$CTL_PROTO
(
¬’as_nhbšs
)

146 
	$CTL_PROTO
(
¬’as_Æruns
)

147 
	$CTL_PROTO
(
¬’as_nhchunks
)

148 
	$CTL_PROTO
(
¬’as_ex‹nd
)

149 
	$CTL_PROTO
(
´of_th»ad_aùive_š™
)

150 
	$CTL_PROTO
(
´of_aùive
)

151 
	$CTL_PROTO
(
´of_dump
)

152 
	$CTL_PROTO
(
´of_gdump
)

153 
	$CTL_PROTO
(
´of_»£t
)

154 
	$CTL_PROTO
(
´of_š‹rv®
)

155 
	$CTL_PROTO
(
lg_´of_§m¶e
)

156 
	$CTL_PROTO
(
¡©s_¬’as_i_sm®l_®loÿ‹d
)

157 
	$CTL_PROTO
(
¡©s_¬’as_i_sm®l_nm®loc
)

158 
	$CTL_PROTO
(
¡©s_¬’as_i_sm®l_nd®loc
)

159 
	$CTL_PROTO
(
¡©s_¬’as_i_sm®l_Äeque¡s
)

160 
	$CTL_PROTO
(
¡©s_¬’as_i_Ïrge_®loÿ‹d
)

161 
	$CTL_PROTO
(
¡©s_¬’as_i_Ïrge_nm®loc
)

162 
	$CTL_PROTO
(
¡©s_¬’as_i_Ïrge_nd®loc
)

163 
	$CTL_PROTO
(
¡©s_¬’as_i_Ïrge_Äeque¡s
)

164 
	$CTL_PROTO
(
¡©s_¬’as_i_huge_®loÿ‹d
)

165 
	$CTL_PROTO
(
¡©s_¬’as_i_huge_nm®loc
)

166 
	$CTL_PROTO
(
¡©s_¬’as_i_huge_nd®loc
)

167 
	$CTL_PROTO
(
¡©s_¬’as_i_huge_Äeque¡s
)

168 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_nm®loc
)

169 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_nd®loc
)

170 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_Äeque¡s
)

171 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_cu¼egs
)

172 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_nfls
)

173 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_næushes
)

174 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_Äuns
)

175 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_Ä”uns
)

176 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_cu¼uns
)

177 
	$INDEX_PROTO
(
¡©s_¬’as_i_bšs_j
)

178 
	$CTL_PROTO
(
¡©s_¬’as_i_Ìuns_j_nm®loc
)

179 
	$CTL_PROTO
(
¡©s_¬’as_i_Ìuns_j_nd®loc
)

180 
	$CTL_PROTO
(
¡©s_¬’as_i_Ìuns_j_Äeque¡s
)

181 
	$CTL_PROTO
(
¡©s_¬’as_i_Ìuns_j_cu¼uns
)

182 
	$INDEX_PROTO
(
¡©s_¬’as_i_Ìuns_j
)

183 
	$CTL_PROTO
(
¡©s_¬’as_i_hchunks_j_nm®loc
)

184 
	$CTL_PROTO
(
¡©s_¬’as_i_hchunks_j_nd®loc
)

185 
	$CTL_PROTO
(
¡©s_¬’as_i_hchunks_j_Äeque¡s
)

186 
	$CTL_PROTO
(
¡©s_¬’as_i_hchunks_j_curhchunks
)

187 
	$INDEX_PROTO
(
¡©s_¬’as_i_hchunks_j
)

188 
	$CTL_PROTO
(
¡©s_¬’as_i_Áh»ads
)

189 
	$CTL_PROTO
(
¡©s_¬’as_i_dss
)

190 
	$CTL_PROTO
(
¡©s_¬’as_i_lg_dœty_muÉ
)

191 
	$CTL_PROTO
(
¡©s_¬’as_i_deÿy_time
)

192 
	$CTL_PROTO
(
¡©s_¬’as_i_·ùive
)

193 
	$CTL_PROTO
(
¡©s_¬’as_i_pdœty
)

194 
	$CTL_PROTO
(
¡©s_¬’as_i_m­³d
)

195 
	$CTL_PROTO
(
¡©s_¬’as_i_»šed
)

196 
	$CTL_PROTO
(
¡©s_¬’as_i_Åurge
)

197 
	$CTL_PROTO
(
¡©s_¬’as_i_nmadvi£
)

198 
	$CTL_PROTO
(
¡©s_¬’as_i_purged
)

199 
	$CTL_PROTO
(
¡©s_¬’as_i_m‘ad©a_m­³d
)

200 
	$CTL_PROTO
(
¡©s_¬’as_i_m‘ad©a_®loÿ‹d
)

201 
	$INDEX_PROTO
(
¡©s_¬’as_i
)

202 
	$CTL_PROTO
(
¡©s_ÿùive
)

203 
	$CTL_PROTO
(
¡©s_®loÿ‹d
)

204 
	$CTL_PROTO
(
¡©s_aùive
)

205 
	$CTL_PROTO
(
¡©s_m‘ad©a
)

206 
	$CTL_PROTO
(
¡©s_»sid’t
)

207 
	$CTL_PROTO
(
¡©s_m­³d
)

208 
	$CTL_PROTO
(
¡©s_»šed
)

214 
	#CTL_MAX_DEPTH
 6

	)

216 
	#NAME
(
n
è{
Œue
},‚

217 
	#CHILD
(
t
, 
c
) \

218 (
c
##
_node
è/ (
ùl_
##
t
##
_node_t
), \

219 (
ùl_node_t
 *)
c
##
_node
, \

220 
NULL


	)

221 
	#CTL
(
c
è0, 
NULL
, c##
_ùl


	)

227 
	#INDEX
(
i
è{
çl£
}, i##
_šdex


	)

229 cÚ¡ 
ùl_Çmed_node_t
 
	gth»ad_tÿche_node
[] = {

230 {
NAME
("’abËd"), 
CTL
(
th»ad_tÿche_’abËd
)},

231 {
NAME
("æush"), 
CTL
(
th»ad_tÿche_æush
)}

234 cÚ¡ 
ùl_Çmed_node_t
 
	gth»ad_´of_node
[] = {

235 {
NAME
("Çme"), 
CTL
(
th»ad_´of_Çme
)},

236 {
NAME
("aùive"), 
CTL
(
th»ad_´of_aùive
)}

239 cÚ¡ 
ùl_Çmed_node_t
 
	gth»ad_node
[] = {

240 {
NAME
("¬’a"), 
CTL
(
th»ad_¬’a
)},

241 {
NAME
("®loÿ‹d"), 
CTL
(
th»ad_®loÿ‹d
)},

242 {
NAME
("®loÿ‹dp"), 
CTL
(
th»ad_®loÿ‹dp
)},

243 {
NAME
("d—Îoÿ‹d"), 
CTL
(
th»ad_d—Îoÿ‹d
)},

244 {
NAME
("d—Îoÿ‹dp"), 
CTL
(
th»ad_d—Îoÿ‹dp
)},

245 {
NAME
("tÿche"), 
CHILD
(
Çmed
, 
th»ad_tÿche
)},

246 {
NAME
("´of"), 
CHILD
(
Çmed
, 
th»ad_´of
)}

249 cÚ¡ 
ùl_Çmed_node_t
 
	gcÚfig_node
[] = {

250 {
NAME
("ÿche_oblivious"), 
CTL
(
cÚfig_ÿche_oblivious
)},

251 {
NAME
("debug"), 
CTL
(
cÚfig_debug
)},

252 {
NAME
("fl"), 
CTL
(
cÚfig_fl
)},

253 {
NAME
("Ïzy_lock"), 
CTL
(
cÚfig_Ïzy_lock
)},

254 {
NAME
("m®loc_cÚf"), 
CTL
(
cÚfig_m®loc_cÚf
)},

255 {
NAME
("munm­"), 
CTL
(
cÚfig_munm­
)},

256 {
NAME
("´of"), 
CTL
(
cÚfig_´of
)},

257 {
NAME
("´of_libgcc"), 
CTL
(
cÚfig_´of_libgcc
)},

258 {
NAME
("´of_libunwšd"), 
CTL
(
cÚfig_´of_libunwšd
)},

259 {
NAME
("¡©s"), 
CTL
(
cÚfig_¡©s
)},

260 {
NAME
("tÿche"), 
CTL
(
cÚfig_tÿche
)},

261 {
NAME
("s"), 
CTL
(
cÚfig_s
)},

262 {
NAME
("uŒaû"), 
CTL
(
cÚfig_uŒaû
)},

263 {
NAME
("v®gršd"), 
CTL
(
cÚfig_v®gršd
)},

264 {
NAME
("xm®loc"), 
CTL
(
cÚfig_xm®loc
)}

267 cÚ¡ 
ùl_Çmed_node_t
 
	gİt_node
[] = {

268 {
NAME
("abÜt"), 
CTL
(
İt_abÜt
)},

269 {
NAME
("dss"), 
CTL
(
İt_dss
)},

270 {
NAME
("lg_chunk"), 
CTL
(
İt_lg_chunk
)},

271 {
NAME
("Ç»Çs"), 
CTL
(
İt_Ç»Çs
)},

272 {
NAME
("purge"), 
CTL
(
İt_purge
)},

273 {
NAME
("lg_dœty_muÉ"), 
CTL
(
İt_lg_dœty_muÉ
)},

274 {
NAME
("deÿy_time"), 
CTL
(
İt_deÿy_time
)},

275 {
NAME
("¡©s_´št"), 
CTL
(
İt_¡©s_´št
)},

276 {
NAME
("junk"), 
CTL
(
İt_junk
)},

277 {
NAME
("z”o"), 
CTL
(
İt_z”o
)},

278 {
NAME
("qu¬ªtše"), 
CTL
(
İt_qu¬ªtše
)},

279 {
NAME
("»dzÚe"), 
CTL
(
İt_»dzÚe
)},

280 {
NAME
("uŒaû"), 
CTL
(
İt_uŒaû
)},

281 {
NAME
("xm®loc"), 
CTL
(
İt_xm®loc
)},

282 {
NAME
("tÿche"), 
CTL
(
İt_tÿche
)},

283 {
NAME
("lg_tÿche_max"), 
CTL
(
İt_lg_tÿche_max
)},

284 {
NAME
("´of"), 
CTL
(
İt_´of
)},

285 {
NAME
("´of_´efix"), 
CTL
(
İt_´of_´efix
)},

286 {
NAME
("´of_aùive"), 
CTL
(
İt_´of_aùive
)},

287 {
NAME
("´of_th»ad_aùive_š™"), 
CTL
(
İt_´of_th»ad_aùive_š™
)},

288 {
NAME
("lg_´of_§m¶e"), 
CTL
(
İt_lg_´of_§m¶e
)},

289 {
NAME
("lg_´of_š‹rv®"), 
CTL
(
İt_lg_´of_š‹rv®
)},

290 {
NAME
("´of_gdump"), 
CTL
(
İt_´of_gdump
)},

291 {
NAME
("´of_fš®"), 
CTL
(
İt_´of_fš®
)},

292 {
NAME
("´of_Ëak"), 
CTL
(
İt_´of_Ëak
)},

293 {
NAME
("´of_accum"), 
CTL
(
İt_´of_accum
)}

296 cÚ¡ 
ùl_Çmed_node_t
 
	gtÿche_node
[] = {

297 {
NAME
("ü—‹"), 
CTL
(
tÿche_ü—‹
)},

298 {
NAME
("æush"), 
CTL
(
tÿche_æush
)},

299 {
NAME
("de¡roy"), 
CTL
(
tÿche_de¡roy
)}

302 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’a_i_node
[] = {

303 {
NAME
("purge"), 
CTL
(
¬’a_i_purge
)},

304 {
NAME
("deÿy"), 
CTL
(
¬’a_i_deÿy
)},

305 {
NAME
("»£t"), 
CTL
(
¬’a_i_»£t
)},

306 {
NAME
("dss"), 
CTL
(
¬’a_i_dss
)},

307 {
NAME
("lg_dœty_muÉ"), 
CTL
(
¬’a_i_lg_dœty_muÉ
)},

308 {
NAME
("deÿy_time"), 
CTL
(
¬’a_i_deÿy_time
)},

309 {
NAME
("chunk_hooks"), 
CTL
(
¬’a_i_chunk_hooks
)}

311 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¬’a_i_node
[] = {

312 {
NAME
(""), 
CHILD
(
Çmed
, 
¬’a_i
)}

315 cÚ¡ 
ùl_šdexed_node_t
 
	g¬’a_node
[] = {

316 {
INDEX
(
¬’a_i
)}

319 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’as_bš_i_node
[] = {

320 {
NAME
("size"), 
CTL
(
¬’as_bš_i_size
)},

321 {
NAME
("Äegs"), 
CTL
(
¬’as_bš_i_Äegs
)},

322 {
NAME
("run_size"), 
CTL
(
¬’as_bš_i_run_size
)}

324 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¬’as_bš_i_node
[] = {

325 {
NAME
(""), 
CHILD
(
Çmed
, 
¬’as_bš_i
)}

328 cÚ¡ 
ùl_šdexed_node_t
 
	g¬’as_bš_node
[] = {

329 {
INDEX
(
¬’as_bš_i
)}

332 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’as_Ìun_i_node
[] = {

333 {
NAME
("size"), 
CTL
(
¬’as_Ìun_i_size
)}

335 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¬’as_Ìun_i_node
[] = {

336 {
NAME
(""), 
CHILD
(
Çmed
, 
¬’as_Ìun_i
)}

339 cÚ¡ 
ùl_šdexed_node_t
 
	g¬’as_Ìun_node
[] = {

340 {
INDEX
(
¬’as_Ìun_i
)}

343 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’as_hchunk_i_node
[] = {

344 {
NAME
("size"), 
CTL
(
¬’as_hchunk_i_size
)}

346 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¬’as_hchunk_i_node
[] = {

347 {
NAME
(""), 
CHILD
(
Çmed
, 
¬’as_hchunk_i
)}

350 cÚ¡ 
ùl_šdexed_node_t
 
	g¬’as_hchunk_node
[] = {

351 {
INDEX
(
¬’as_hchunk_i
)}

354 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’as_node
[] = {

355 {
NAME
("Ç»Çs"), 
CTL
(
¬’as_Ç»Çs
)},

356 {
NAME
("š™Ÿlized"), 
CTL
(
¬’as_š™Ÿlized
)},

357 {
NAME
("lg_dœty_muÉ"), 
CTL
(
¬’as_lg_dœty_muÉ
)},

358 {
NAME
("deÿy_time"), 
CTL
(
¬’as_deÿy_time
)},

359 {
NAME
("quªtum"), 
CTL
(
¬’as_quªtum
)},

360 {
NAME
("·ge"), 
CTL
(
¬’as_·ge
)},

361 {
NAME
("tÿche_max"), 
CTL
(
¬’as_tÿche_max
)},

362 {
NAME
("nbšs"), 
CTL
(
¬’as_nbšs
)},

363 {
NAME
("nhbšs"), 
CTL
(
¬’as_nhbšs
)},

364 {
NAME
("bš"), 
CHILD
(
šdexed
, 
¬’as_bš
)},

365 {
NAME
("Æruns"), 
CTL
(
¬’as_Æruns
)},

366 {
NAME
("Ìun"), 
CHILD
(
šdexed
, 
¬’as_Ìun
)},

367 {
NAME
("nhchunks"), 
CTL
(
¬’as_nhchunks
)},

368 {
NAME
("hchunk"), 
CHILD
(
šdexed
, 
¬’as_hchunk
)},

369 {
NAME
("ex‹nd"), 
CTL
(
¬’as_ex‹nd
)}

372 cÚ¡ 
ùl_Çmed_node_t
 
	g´of_node
[] = {

373 {
NAME
("th»ad_aùive_š™"), 
CTL
(
´of_th»ad_aùive_š™
)},

374 {
NAME
("aùive"), 
CTL
(
´of_aùive
)},

375 {
NAME
("dump"), 
CTL
(
´of_dump
)},

376 {
NAME
("gdump"), 
CTL
(
´of_gdump
)},

377 {
NAME
("»£t"), 
CTL
(
´of_»£t
)},

378 {
NAME
("š‹rv®"), 
CTL
(
´of_š‹rv®
)},

379 {
NAME
("lg_§m¶e"), 
CTL
(
lg_´of_§m¶e
)}

382 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_m‘ad©a_node
[] = {

383 {
NAME
("m­³d"), 
CTL
(
¡©s_¬’as_i_m‘ad©a_m­³d
)},

384 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_¬’as_i_m‘ad©a_®loÿ‹d
)}

387 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_sm®l_node
[] = {

388 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_¬’as_i_sm®l_®loÿ‹d
)},

389 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_sm®l_nm®loc
)},

390 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_sm®l_nd®loc
)},

391 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_sm®l_Äeque¡s
)}

394 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_Ïrge_node
[] = {

395 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_¬’as_i_Ïrge_®loÿ‹d
)},

396 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_Ïrge_nm®loc
)},

397 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_Ïrge_nd®loc
)},

398 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_Ïrge_Äeque¡s
)}

401 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_huge_node
[] = {

402 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_¬’as_i_huge_®loÿ‹d
)},

403 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_huge_nm®loc
)},

404 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_huge_nd®loc
)},

405 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_huge_Äeque¡s
)}

408 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_bšs_j_node
[] = {

409 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_bšs_j_nm®loc
)},

410 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_bšs_j_nd®loc
)},

411 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_bšs_j_Äeque¡s
)},

412 {
NAME
("cu¼egs"), 
CTL
(
¡©s_¬’as_i_bšs_j_cu¼egs
)},

413 {
NAME
("nfls"), 
CTL
(
¡©s_¬’as_i_bšs_j_nfls
)},

414 {
NAME
("næushes"), 
CTL
(
¡©s_¬’as_i_bšs_j_næushes
)},

415 {
NAME
("Äuns"), 
CTL
(
¡©s_¬’as_i_bšs_j_Äuns
)},

416 {
NAME
("Ä”uns"), 
CTL
(
¡©s_¬’as_i_bšs_j_Ä”uns
)},

417 {
NAME
("cu¼uns"), 
CTL
(
¡©s_¬’as_i_bšs_j_cu¼uns
)}

419 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¡©s_¬’as_i_bšs_j_node
[] = {

420 {
NAME
(""), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_bšs_j
)}

423 cÚ¡ 
ùl_šdexed_node_t
 
	g¡©s_¬’as_i_bšs_node
[] = {

424 {
INDEX
(
¡©s_¬’as_i_bšs_j
)}

427 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_Ìuns_j_node
[] = {

428 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_Ìuns_j_nm®loc
)},

429 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_Ìuns_j_nd®loc
)},

430 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_Ìuns_j_Äeque¡s
)},

431 {
NAME
("cu¼uns"), 
CTL
(
¡©s_¬’as_i_Ìuns_j_cu¼uns
)}

433 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¡©s_¬’as_i_Ìuns_j_node
[] = {

434 {
NAME
(""), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_Ìuns_j
)}

437 cÚ¡ 
ùl_šdexed_node_t
 
	g¡©s_¬’as_i_Ìuns_node
[] = {

438 {
INDEX
(
¡©s_¬’as_i_Ìuns_j
)}

441 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_hchunks_j_node
[] = {

442 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_hchunks_j_nm®loc
)},

443 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_hchunks_j_nd®loc
)},

444 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_hchunks_j_Äeque¡s
)},

445 {
NAME
("curhchunks"), 
CTL
(
¡©s_¬’as_i_hchunks_j_curhchunks
)}

447 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¡©s_¬’as_i_hchunks_j_node
[] = {

448 {
NAME
(""), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_hchunks_j
)}

451 cÚ¡ 
ùl_šdexed_node_t
 
	g¡©s_¬’as_i_hchunks_node
[] = {

452 {
INDEX
(
¡©s_¬’as_i_hchunks_j
)}

455 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_node
[] = {

456 {
NAME
("Áh»ads"), 
CTL
(
¡©s_¬’as_i_Áh»ads
)},

457 {
NAME
("dss"), 
CTL
(
¡©s_¬’as_i_dss
)},

458 {
NAME
("lg_dœty_muÉ"), 
CTL
(
¡©s_¬’as_i_lg_dœty_muÉ
)},

459 {
NAME
("deÿy_time"), 
CTL
(
¡©s_¬’as_i_deÿy_time
)},

460 {
NAME
("·ùive"), 
CTL
(
¡©s_¬’as_i_·ùive
)},

461 {
NAME
("pdœty"), 
CTL
(
¡©s_¬’as_i_pdœty
)},

462 {
NAME
("m­³d"), 
CTL
(
¡©s_¬’as_i_m­³d
)},

463 {
NAME
("»šed"), 
CTL
(
¡©s_¬’as_i_»šed
)},

464 {
NAME
("Åurge"), 
CTL
(
¡©s_¬’as_i_Åurge
)},

465 {
NAME
("nmadvi£"), 
CTL
(
¡©s_¬’as_i_nmadvi£
)},

466 {
NAME
("purged"), 
CTL
(
¡©s_¬’as_i_purged
)},

467 {
NAME
("m‘ad©a"), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_m‘ad©a
)},

468 {
NAME
("sm®l"), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_sm®l
)},

469 {
NAME
("Ïrge"), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_Ïrge
)},

470 {
NAME
("huge"), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_huge
)},

471 {
NAME
("bšs"), 
CHILD
(
šdexed
, 
¡©s_¬’as_i_bšs
)},

472 {
NAME
("Ìuns"), 
CHILD
(
šdexed
, 
¡©s_¬’as_i_Ìuns
)},

473 {
NAME
("hchunks"), 
CHILD
(
šdexed
, 
¡©s_¬’as_i_hchunks
)}

475 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¡©s_¬’as_i_node
[] = {

476 {
NAME
(""), 
CHILD
(
Çmed
, 
¡©s_¬’as_i
)}

479 cÚ¡ 
ùl_šdexed_node_t
 
	g¡©s_¬’as_node
[] = {

480 {
INDEX
(
¡©s_¬’as_i
)}

483 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_node
[] = {

484 {
NAME
("ÿùive"), 
CTL
(
¡©s_ÿùive
)},

485 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_®loÿ‹d
)},

486 {
NAME
("aùive"), 
CTL
(
¡©s_aùive
)},

487 {
NAME
("m‘ad©a"), 
CTL
(
¡©s_m‘ad©a
)},

488 {
NAME
("»sid’t"), 
CTL
(
¡©s_»sid’t
)},

489 {
NAME
("m­³d"), 
CTL
(
¡©s_m­³d
)},

490 {
NAME
("»šed"), 
CTL
(
¡©s_»šed
)},

491 {
NAME
("¬’as"), 
CHILD
(
šdexed
, 
¡©s_¬’as
)}

494 cÚ¡ 
ùl_Çmed_node_t
 
	groÙ_node
[] = {

495 {
NAME
("v”siÚ"), 
CTL
(
v”siÚ
)},

496 {
NAME
("•och"), 
CTL
(
•och
)},

497 {
NAME
("th»ad"), 
CHILD
(
Çmed
, 
th»ad
)},

498 {
NAME
("cÚfig"), 
CHILD
(
Çmed
, 
cÚfig
)},

499 {
NAME
("İt"), 
CHILD
(
Çmed
, 
İt
)},

500 {
NAME
("tÿche"), 
CHILD
(
Çmed
, 
tÿche
)},

501 {
NAME
("¬’a"), 
CHILD
(
šdexed
, 
¬’a
)},

502 {
NAME
("¬’as"), 
CHILD
(
Çmed
, 
¬’as
)},

503 {
NAME
("´of"), 
CHILD
(
Çmed
, 
´of
)},

504 {
NAME
("¡©s"), 
CHILD
(
Çmed
, 
¡©s
)}

506 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_roÙ_node
[] = {

507 {
NAME
(""), 
CHILD
(
Çmed
, 
roÙ
)}

510 #undeà
NAME


511 #undeà
CHILD


512 #undeà
CTL


513 #undeà
INDEX


517 
boŞ


518 
	$ùl_¬’a_š™
(
ùl_¬’a_¡©s_t
 *
a¡©s
)

521 ià(
a¡©s
->
l¡©s
 =ğ
NULL
) {

522 
a¡©s
->
l¡©s
 = (
m®loc_Ïrge_¡©s_t
 *)
	`a0m®loc
(
Æşas£s
 *

523 (
m®loc_Ïrge_¡©s_t
));

524 ià(
a¡©s
->
l¡©s
 =ğ
NULL
)

525  (
Œue
);

528 ià(
a¡©s
->
h¡©s
 =ğ
NULL
) {

529 
a¡©s
->
h¡©s
 = (
m®loc_huge_¡©s_t
 *)
	`a0m®loc
(
nhşas£s
 *

530 (
m®loc_huge_¡©s_t
));

531 ià(
a¡©s
->
h¡©s
 =ğ
NULL
)

532  (
Œue
);

535  (
çl£
);

536 
	}
}

539 
	$ùl_¬’a_ş—r
(
ùl_¬’a_¡©s_t
 *
a¡©s
)

542 
a¡©s
->
Áh»ads
 = 0;

543 
a¡©s
->
dss
 = 
dss_´ec_Çmes
[
dss_´ec_lim™
];

544 
a¡©s
->
lg_dœty_muÉ
 = -1;

545 
a¡©s
->
deÿy_time
 = -1;

546 
a¡©s
->
·ùive
 = 0;

547 
a¡©s
->
pdœty
 = 0;

548 ià(
cÚfig_¡©s
) {

549 
	`mem£t
(&
a¡©s
->a¡©s, 0, (
¬’a_¡©s_t
));

550 
a¡©s
->
®loÿ‹d_sm®l
 = 0;

551 
a¡©s
->
nm®loc_sm®l
 = 0;

552 
a¡©s
->
nd®loc_sm®l
 = 0;

553 
a¡©s
->
Äeque¡s_sm®l
 = 0;

554 
	`mem£t
(
a¡©s
->
b¡©s
, 0, 
NBINS
 * (
m®loc_bš_¡©s_t
));

555 
	`mem£t
(
a¡©s
->
l¡©s
, 0, 
Æşas£s
 *

556 (
m®loc_Ïrge_¡©s_t
));

557 
	`mem£t
(
a¡©s
->
h¡©s
, 0, 
nhşas£s
 *

558 (
m®loc_huge_¡©s_t
));

560 
	}
}

563 
	$ùl_¬’a_¡©s_am”ge
(
tsdn_t
 *
tsdn
, 
ùl_¬’a_¡©s_t
 *
c¡©s
, 
¬’a_t
 *
¬’a
)

565 
i
;

567 ià(
cÚfig_¡©s
) {

568 
	`¬’a_¡©s_m”ge
(
tsdn
, 
¬’a
, &
c¡©s
->
Áh»ads
, &c¡©s->
dss
,

569 &
c¡©s
->
lg_dœty_muÉ
, &c¡©s->
deÿy_time
,

570 &
c¡©s
->
·ùive
, &c¡©s->
pdœty
, &c¡©s->
a¡©s
,

571 
c¡©s
->
b¡©s
, c¡©s->
l¡©s
, c¡©s->
h¡©s
);

573 
i
 = 0; i < 
NBINS
; i++) {

574 
c¡©s
->
®loÿ‹d_sm®l
 +ğc¡©s->
b¡©s
[
i
].
cu¼egs
 *

575 
	`šdex2size
(
i
);

576 
c¡©s
->
nm®loc_sm®l
 +ğc¡©s->
b¡©s
[
i
].
nm®loc
;

577 
c¡©s
->
nd®loc_sm®l
 +ğc¡©s->
b¡©s
[
i
].
nd®loc
;

578 
c¡©s
->
Äeque¡s_sm®l
 +ğc¡©s->
b¡©s
[
i
].
Äeque¡s
;

581 
	`¬’a_basic_¡©s_m”ge
(
tsdn
, 
¬’a
, &
c¡©s
->
Áh»ads
,

582 &
c¡©s
->
dss
, &c¡©s->
lg_dœty_muÉ
, &c¡©s->
deÿy_time
,

583 &
c¡©s
->
·ùive
, &c¡©s->
pdœty
);

585 
	}
}

588 
	$ùl_¬’a_¡©s_sm”ge
(
ùl_¬’a_¡©s_t
 *
s¡©s
, c_¬’a_¡©s_ˆ*
a¡©s
)

590 
i
;

592 
s¡©s
->
Áh»ads
 +ğ
a¡©s
->nthreads;

593 
s¡©s
->
·ùive
 +ğ
a¡©s
->pactive;

594 
s¡©s
->
pdœty
 +ğ
a¡©s
->pdirty;

596 ià(
cÚfig_¡©s
) {

597 
s¡©s
->
a¡©s
.
m­³d
 +=‡stats->astats.mapped;

598 
s¡©s
->
a¡©s
.
»šed
 +=‡stats->astats.retained;

599 
s¡©s
->
a¡©s
.
Åurge
 +=‡stats->astats.npurge;

600 
s¡©s
->
a¡©s
.
nmadvi£
 +=‡stats->astats.nmadvise;

601 
s¡©s
->
a¡©s
.
purged
 +=‡stats->astats.purged;

603 
s¡©s
->
a¡©s
.
m‘ad©a_m­³d
 +=

604 
a¡©s
->a¡©s.
m‘ad©a_m­³d
;

605 
s¡©s
->
a¡©s
.
m‘ad©a_®loÿ‹d
 +=

606 
a¡©s
->a¡©s.
m‘ad©a_®loÿ‹d
;

608 
s¡©s
->
®loÿ‹d_sm®l
 +ğ
a¡©s
->allocated_small;

609 
s¡©s
->
nm®loc_sm®l
 +ğ
a¡©s
->nmalloc_small;

610 
s¡©s
->
nd®loc_sm®l
 +ğ
a¡©s
->ndalloc_small;

611 
s¡©s
->
Äeque¡s_sm®l
 +ğ
a¡©s
->nrequests_small;

613 
s¡©s
->
a¡©s
.
®loÿ‹d_Ïrge
 +=

614 
a¡©s
->a¡©s.
®loÿ‹d_Ïrge
;

615 
s¡©s
->
a¡©s
.
nm®loc_Ïrge
 +=‡stats->astats.nmalloc_large;

616 
s¡©s
->
a¡©s
.
nd®loc_Ïrge
 +=‡stats->astats.ndalloc_large;

617 
s¡©s
->
a¡©s
.
Äeque¡s_Ïrge
 +=

618 
a¡©s
->a¡©s.
Äeque¡s_Ïrge
;

620 
s¡©s
->
a¡©s
.
®loÿ‹d_huge
 +=‡stats->astats.allocated_huge;

621 
s¡©s
->
a¡©s
.
nm®loc_huge
 +=‡stats->astats.nmalloc_huge;

622 
s¡©s
->
a¡©s
.
nd®loc_huge
 +=‡stats->astats.ndalloc_huge;

624 
i
 = 0; i < 
NBINS
; i++) {

625 
s¡©s
->
b¡©s
[
i
].
nm®loc
 +ğ
a¡©s
->bstats[i].nmalloc;

626 
s¡©s
->
b¡©s
[
i
].
nd®loc
 +ğ
a¡©s
->bstats[i].ndalloc;

627 
s¡©s
->
b¡©s
[
i
].
Äeque¡s
 +=

628 
a¡©s
->
b¡©s
[
i
].
Äeque¡s
;

629 
s¡©s
->
b¡©s
[
i
].
cu¼egs
 +ğ
a¡©s
->bstats[i].curregs;

630 ià(
cÚfig_tÿche
) {

631 
s¡©s
->
b¡©s
[
i
].
nfls
 +=

632 
a¡©s
->
b¡©s
[
i
].
nfls
;

633 
s¡©s
->
b¡©s
[
i
].
næushes
 +=

634 
a¡©s
->
b¡©s
[
i
].
næushes
;

636 
s¡©s
->
b¡©s
[
i
].
Äuns
 +ğ
a¡©s
->bstats[i].nruns;

637 
s¡©s
->
b¡©s
[
i
].
»runs
 +ğ
a¡©s
->bstats[i].reruns;

638 
s¡©s
->
b¡©s
[
i
].
cu¼uns
 +ğ
a¡©s
->bstats[i].curruns;

641 
i
 = 0; i < 
Æşas£s
; i++) {

642 
s¡©s
->
l¡©s
[
i
].
nm®loc
 +ğ
a¡©s
->lstats[i].nmalloc;

643 
s¡©s
->
l¡©s
[
i
].
nd®loc
 +ğ
a¡©s
->lstats[i].ndalloc;

644 
s¡©s
->
l¡©s
[
i
].
Äeque¡s
 +=

645 
a¡©s
->
l¡©s
[
i
].
Äeque¡s
;

646 
s¡©s
->
l¡©s
[
i
].
cu¼uns
 +ğ
a¡©s
->lstats[i].curruns;

649 
i
 = 0; i < 
nhşas£s
; i++) {

650 
s¡©s
->
h¡©s
[
i
].
nm®loc
 +ğ
a¡©s
->hstats[i].nmalloc;

651 
s¡©s
->
h¡©s
[
i
].
nd®loc
 +ğ
a¡©s
->hstats[i].ndalloc;

652 
s¡©s
->
h¡©s
[
i
].
curhchunks
 +=

653 
a¡©s
->
h¡©s
[
i
].
curhchunks
;

656 
	}
}

659 
	$ùl_¬’a_»äesh
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
i
)

661 
ùl_¬’a_¡©s_t
 *
a¡©s
 = &
ùl_¡©s
.
¬’as
[
i
];

662 
ùl_¬’a_¡©s_t
 *
s¡©s
 = &
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
];

664 
	`ùl_¬’a_ş—r
(
a¡©s
);

665 
	`ùl_¬’a_¡©s_am”ge
(
tsdn
, 
a¡©s
, 
¬’a
);

667 
	`ùl_¬’a_¡©s_sm”ge
(
s¡©s
, 
a¡©s
);

668 
	}
}

670 
boŞ


671 
	$ùl_grow
(
tsdn_t
 *
tsdn
)

673 
ùl_¬’a_¡©s_t
 *
a¡©s
;

676 ià(
	`¬’a_š™
(
tsdn
, 
ùl_¡©s
.
Ç»Çs
è=ğ
NULL
)

677  (
Œue
);

680 
a¡©s
 = (
ùl_¬’a_¡©s_t
 *)
	`a0m®loc
((
ùl_¡©s
.
Ç»Çs
 + 2) *

681 (
ùl_¬’a_¡©s_t
));

682 ià(
a¡©s
 =ğ
NULL
)

683  (
Œue
);

686 
	`memıy
(
a¡©s
, 
ùl_¡©s
.
¬’as
, (ùl_¡©s.
Ç»Çs
 + 1) *

687 (
ùl_¬’a_¡©s_t
));

688 
	`mem£t
(&
a¡©s
[
ùl_¡©s
.
Ç»Çs
 + 1], 0, (
ùl_¬’a_¡©s_t
));

689 ià(
	`ùl_¬’a_š™
(&
a¡©s
[
ùl_¡©s
.
Ç»Çs
 + 1])) {

690 
	`a0d®loc
(
a¡©s
);

691  (
Œue
);

695 
ùl_¬’a_¡©s_t
 
t¡©s
;

696 
	`memıy
(&
t¡©s
, &
a¡©s
[
ùl_¡©s
.
Ç»Çs
],

697 (
ùl_¬’a_¡©s_t
));

698 
	`memıy
(&
a¡©s
[
ùl_¡©s
.
Ç»Çs
],

699 &
a¡©s
[
ùl_¡©s
.
Ç»Çs
 + 1], (
ùl_¬’a_¡©s_t
));

700 
	`memıy
(&
a¡©s
[
ùl_¡©s
.
Ç»Çs
 + 1], &
t¡©s
,

701 (
ùl_¬’a_¡©s_t
));

703 
	`a0d®loc
(
ùl_¡©s
.
¬’as
);

704 
ùl_¡©s
.
¬’as
 = 
a¡©s
;

705 
ùl_¡©s
.
Ç»Çs
++;

707  (
çl£
);

708 
	}
}

711 
	$ùl_»äesh
(
tsdn_t
 *
tsdn
)

713 
i
;

714 
	`VARIABLE_ARRAY
(
¬’a_t
 *, 
»Çs
, 
ùl_¡©s
.
Ç»Çs
);

720 
	`ùl_¬’a_ş—r
(&
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
]);

722 
i
 = 0; i < 
ùl_¡©s
.
Ç»Çs
; i++)

723 
»Çs
[
i
] = 
	`¬’a_g‘
(
tsdn
, i, 
çl£
);

725 
i
 = 0; i < 
ùl_¡©s
.
Ç»Çs
; i++) {

726 
boŞ
 
š™Ÿlized
 = (
»Çs
[
i
] !ğ
NULL
);

728 
ùl_¡©s
.
¬’as
[
i
].
š™Ÿlized
 = initialized;

729 ià(
š™Ÿlized
)

730 
	`ùl_¬’a_»äesh
(
tsdn
, 
»Çs
[
i
], i);

733 ià(
cÚfig_¡©s
) {

734 
size_t
 
ba£_®loÿ‹d
, 
ba£_»sid’t
, 
ba£_m­³d
;

735 
	`ba£_¡©s_g‘
(
tsdn
, &
ba£_®loÿ‹d
, &
ba£_»sid’t
,

736 &
ba£_m­³d
);

737 
ùl_¡©s
.
®loÿ‹d
 =

738 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
®loÿ‹d_sm®l
 +

739 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
®loÿ‹d_Ïrge
 +

740 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
®loÿ‹d_huge
;

741 
ùl_¡©s
.
aùive
 =

742 (
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
·ùive
 << 
LG_PAGE
);

743 
ùl_¡©s
.
m‘ad©a
 = 
ba£_®loÿ‹d
 +

744 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
m‘ad©a_m­³d
 +

745 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s


746 .
m‘ad©a_®loÿ‹d
;

747 
ùl_¡©s
.
»sid’t
 = 
ba£_»sid’t
 +

748 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
m‘ad©a_m­³d
 +

749 ((
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
·ùive
 +

750 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
pdœty
è<< 
LG_PAGE
);

751 
ùl_¡©s
.
m­³d
 = 
ba£_m­³d
 +

752 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
m­³d
;

753 
ùl_¡©s
.
»šed
 =

754 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
»šed
;

757 
ùl_•och
++;

758 
	}
}

760 
boŞ


761 
	$ùl_š™
(
tsdn_t
 *
tsdn
)

763 
boŞ
 
»t
;

765 
	`m®loc_mu‹x_lock
(
tsdn
, &
ùl_mtx
);

766 ià(!
ùl_š™Ÿlized
) {

771 
ùl_¡©s
.
Ç»Çs
 = 
	`Ç»Çs_tÙ®_g‘
();

772 
ùl_¡©s
.
¬’as
 = (
ùl_¬’a_¡©s_t
 *)
	`a0m®loc
(

773 (
ùl_¡©s
.
Ç»Çs
 + 1è* (
ùl_¬’a_¡©s_t
));

774 ià(
ùl_¡©s
.
¬’as
 =ğ
NULL
) {

775 
»t
 = 
Œue
;

776 
Ïb–_»tuº
;

778 
	`mem£t
(
ùl_¡©s
.
¬’as
, 0, (ùl_¡©s.
Ç»Çs
 + 1) *

779 (
ùl_¬’a_¡©s_t
));

786 ià(
cÚfig_¡©s
) {

787 
i
;

788 
i
 = 0; i <ğ
ùl_¡©s
.
Ç»Çs
; i++) {

789 ià(
	`ùl_¬’a_š™
(&
ùl_¡©s
.
¬’as
[
i
])) {

790 
j
;

791 
j
 = 0; j < 
i
; j++) {

792 
	`a0d®loc
(

793 
ùl_¡©s
.
¬’as
[
j
].
l¡©s
);

794 
	`a0d®loc
(

795 
ùl_¡©s
.
¬’as
[
j
].
h¡©s
);

797 
	`a0d®loc
(
ùl_¡©s
.
¬’as
);

798 
ùl_¡©s
.
¬’as
 = 
NULL
;

799 
»t
 = 
Œue
;

800 
Ïb–_»tuº
;

804 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
š™Ÿlized
 = 
Œue
;

806 
ùl_•och
 = 0;

807 
	`ùl_»äesh
(
tsdn
);

808 
ùl_š™Ÿlized
 = 
Œue
;

811 
»t
 = 
çl£
;

812 
Ïb–_»tuº
:

813 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
ùl_mtx
);

814  (
»t
);

815 
	}
}

818 
	$ùl_lookup
(
tsdn_t
 *
tsdn
, cÚ¡ *
Çme
, 
ùl_node_t
 cÚ¡ **
node¥
,

819 
size_t
 *
mibp
, size_ˆ*
d•thp
)

821 
»t
;

822 cÚ¡ *
–m
, *
tdÙ
, *
dÙ
;

823 
size_t
 
–’
, 
i
, 
j
;

824 cÚ¡ 
ùl_Çmed_node_t
 *
node
;

826 
–m
 = 
Çme
;

828 
dÙ
 = ((
tdÙ
 = 
	`¡rchr
(
–m
, '.')è!ğ
NULL
) ?dot : strchr(elm, '\0');

829 
–’
 = (
size_t
)((
ušŒ_t
)
dÙ
 - (ušŒ_t)
–m
);

830 ià(
–’
 == 0) {

831 
»t
 = 
ENOENT
;

832 
Ïb–_»tuº
;

834 
node
 = 
su³r_roÙ_node
;

835 
i
 = 0; i < *
d•thp
; i++) {

836 
	`as£¹
(
node
);

837 
	`as£¹
(
node
->
nchd»n
 > 0);

838 ià(
	`ùl_Çmed_node
(
node
->
chd»n
è!ğ
NULL
) {

839 cÚ¡ 
ùl_Çmed_node_t
 *
²ode
 = 
node
;

842 
j
 = 0; j < 
node
->
nchd»n
; j++) {

843 cÚ¡ 
ùl_Çmed_node_t
 *
chd
 =

844 
	`ùl_Çmed_chd»n
(
node
, 
j
);

845 ià(
	`¡¾’
(
chd
->
Çme
è=ğ
–’
 &&

846 
	`¡ºcmp
(
–m
, 
chd
->
Çme
, 
–’
) == 0) {

847 
node
 = 
chd
;

848 ià(
node¥
 !ğ
NULL
)

849 
node¥
[
i
] =

850 (cÚ¡ 
ùl_node_t
 *)
node
;

851 
mibp
[
i
] = 
j
;

855 ià(
node
 =ğ
²ode
) {

856 
»t
 = 
ENOENT
;

857 
Ïb–_»tuº
;

860 
uštmax_t
 
šdex
;

861 cÚ¡ 
ùl_šdexed_node_t
 *
šode
;

864 
šdex
 = 
	`m®loc_¡¹oumax
(
–m
, 
NULL
, 10);

865 ià(
šdex
 =ğ
UINTMAX_MAX
 || index > 
SIZE_T_MAX
) {

866 
»t
 = 
ENOENT
;

867 
Ïb–_»tuº
;

870 
šode
 = 
	`ùl_šdexed_node
(
node
->
chd»n
);

871 
node
 = 
šode
->
	`šdex
(
tsdn
, 
mibp
, *
d•thp
, (
size_t
)
šdex
);

872 ià(
node
 =ğ
NULL
) {

873 
»t
 = 
ENOENT
;

874 
Ïb–_»tuº
;

877 ià(
node¥
 !ğ
NULL
)

878 
node¥
[
i
] = (cÚ¡ 
ùl_node_t
 *)
node
;

879 
mibp
[
i
] = (
size_t
)
šdex
;

882 ià(
node
->
ùl
 !ğ
NULL
) {

884 ià(*
dÙ
 != '\0') {

889 
»t
 = 
ENOENT
;

890 
Ïb–_»tuº
;

893 *
d•thp
 = 
i
 + 1;

898 ià(*
dÙ
 == '\0') {

900 
»t
 = 
ENOENT
;

901 
Ïb–_»tuº
;

903 
–m
 = &
dÙ
[1];

904 
dÙ
 = ((
tdÙ
 = 
	`¡rchr
(
–m
, '.')è!ğ
NULL
) ?dot :

905 
	`¡rchr
(
–m
, '\0');

906 
–’
 = (
size_t
)((
ušŒ_t
)
dÙ
 - (ušŒ_t)
–m
);

909 
»t
 = 0;

910 
Ïb–_»tuº
:

911  (
»t
);

912 
	}
}

915 
	$ùl_byÇme
(
tsd_t
 *
tsd
, cÚ¡ *
Çme
, *
Şdp
, 
size_t
 *
ŞdËÅ
,

916 *
Ãwp
, 
size_t
 
ÃwËn
)

918 
»t
;

919 
size_t
 
d•th
;

920 
ùl_node_t
 cÚ¡ *
nodes
[
CTL_MAX_DEPTH
];

921 
size_t
 
mib
[
CTL_MAX_DEPTH
];

922 cÚ¡ 
ùl_Çmed_node_t
 *
node
;

924 ià(!
ùl_š™Ÿlized
 && 
	`ùl_š™
(
	`tsd_tsdn
(
tsd
))) {

925 
»t
 = 
EAGAIN
;

926 
Ïb–_»tuº
;

929 
d•th
 = 
CTL_MAX_DEPTH
;

930 
»t
 = 
	`ùl_lookup
(
	`tsd_tsdn
(
tsd
), 
Çme
, 
nodes
, 
mib
, &
d•th
);

931 ià(
»t
 != 0)

932 
Ïb–_»tuº
;

934 
node
 = 
	`ùl_Çmed_node
(
nodes
[
d•th
-1]);

935 ià(
node
 !ğ
NULL
 &&‚ode->
ùl
)

936 
»t
 = 
node
->
	`ùl
(
tsd
, 
mib
, 
d•th
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
);

939 
»t
 = 
ENOENT
;

942 
Ïb–_»tuº
:

943 (
»t
);

944 
	}
}

947 
	$ùl_Çm‘omib
(
tsdn_t
 *
tsdn
, cÚ¡ *
Çme
, 
size_t
 *
mibp
, size_ˆ*
mibËÅ
)

949 
»t
;

951 ià(!
ùl_š™Ÿlized
 && 
	`ùl_š™
(
tsdn
)) {

952 
»t
 = 
EAGAIN
;

953 
Ïb–_»tuº
;

956 
»t
 = 
	`ùl_lookup
(
tsdn
, 
Çme
, 
NULL
, 
mibp
, 
mibËÅ
);

957 
Ïb–_»tuº
:

958 (
»t
);

959 
	}
}

962 
	$ùl_bymib
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

963 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

965 
»t
;

966 cÚ¡ 
ùl_Çmed_node_t
 *
node
;

967 
size_t
 
i
;

969 ià(!
ùl_š™Ÿlized
 && 
	`ùl_š™
(
	`tsd_tsdn
(
tsd
))) {

970 
»t
 = 
EAGAIN
;

971 
Ïb–_»tuº
;

975 
node
 = 
su³r_roÙ_node
;

976 
i
 = 0; i < 
mibËn
; i++) {

977 
	`as£¹
(
node
);

978 
	`as£¹
(
node
->
nchd»n
 > 0);

979 ià(
	`ùl_Çmed_node
(
node
->
chd»n
è!ğ
NULL
) {

981 ià(
node
->
nchd»n
 <ğ()
mib
[
i
]) {

982 
»t
 = 
ENOENT
;

983 
Ïb–_»tuº
;

985 
node
 = 
	`ùl_Çmed_chd»n
Òode, 
mib
[
i
]);

987 cÚ¡ 
ùl_šdexed_node_t
 *
šode
;

990 
šode
 = 
	`ùl_šdexed_node
(
node
->
chd»n
);

991 
node
 = 
šode
->
	`šdex
(
	`tsd_tsdn
(
tsd
), 
mib
, 
mibËn
, mib[
i
]);

992 ià(
node
 =ğ
NULL
) {

993 
»t
 = 
ENOENT
;

994 
Ïb–_»tuº
;

1000 ià(
node
 &&‚ode->
ùl
)

1001 
»t
 = 
node
->
	`ùl
(
tsd
, 
mib
, 
mibËn
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
);

1004 
»t
 = 
ENOENT
;

1007 
Ïb–_»tuº
:

1008 (
»t
);

1009 
	}
}

1011 
boŞ


1012 
	$ùl_boÙ
()

1015 ià(
	`m®loc_mu‹x_š™
(&
ùl_mtx
, "ùl", 
WITNESS_RANK_CTL
))

1016  (
Œue
);

1018 
ùl_š™Ÿlized
 = 
çl£
;

1020  (
çl£
);

1021 
	}
}

1024 
	$ùl_´efÜk
(
tsdn_t
 *
tsdn
)

1027 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
ùl_mtx
);

1028 
	}
}

1031 
	$ùl_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
)

1034 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
ùl_mtx
);

1035 
	}
}

1038 
	$ùl_po¡fÜk_chd
(
tsdn_t
 *
tsdn
)

1041 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
ùl_mtx
);

1042 
	}
}

1047 
	#READONLY
() do { \

1048 ià(
Ãwp
 !ğ
NULL
 || 
ÃwËn
 != 0) { \

1049 
»t
 = 
EPERM
; \

1050 
Ïb–_»tuº
; \

1052 } 0)

	)

1054 
	#WRITEONLY
() do { \

1055 ià(
Şdp
 !ğ
NULL
 || 
ŞdËÅ
 != NULL) { \

1056 
»t
 = 
EPERM
; \

1057 
Ïb–_»tuº
; \

1059 } 0)

	)

1061 
	#READ_XOR_WRITE
() do { \

1062 ià((
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 !ğNULLè&& (
Ãwp
 != NULL || \

1063 
ÃwËn
 != 0)) { \

1064 
»t
 = 
EPERM
; \

1065 
Ïb–_»tuº
; \

1067 } 0)

	)

1069 
	#READ
(
v
, 
t
) do { \

1070 ià(
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 != NULL) { \

1071 ià(*
ŞdËÅ
 !ğ(
t
)) { \

1072 
size_t
 
cİyËn
 = ((
t
è<ğ*
ŞdËÅ
) \

1073 ? (
t
è: *
ŞdËÅ
; \

1074 
	`memıy
(
Şdp
, (*)&(
v
), 
cİyËn
); \

1075 
»t
 = 
EINVAL
; \

1076 
Ïb–_»tuº
; \

1078 *(
t
 *)
Şdp
 = (
v
); \

1080 } 0)

	)

1082 
	#WRITE
(
v
, 
t
) do { \

1083 ià(
Ãwp
 !ğ
NULL
) { \

1084 ià(
ÃwËn
 !ğ(
t
)) { \

1085 
»t
 = 
EINVAL
; \

1086 
Ïb–_»tuº
; \

1088 (
v
èğ*(
t
 *)
Ãwp
; \

1090 } 0)

	)

1096 
	#CTL_RO_CLGEN
(
c
, 
l
, 
n
, 
v
, 
t
) \

1098 
n
##
	`_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, \

1099 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
) \

1101 
»t
; \

1102 
t
 
Şdv®
; \

1104 ià(!(
c
)) \

1105  (
ENOENT
); \

1106 ià(
l
) \

1107 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
); \

1108 
	`READONLY
(); \

1109 
Şdv®
 = (
v
); \

1110 
	`READ
(
Şdv®
, 
t
); \

1112 
»t
 = 0; \

1113 
Ïb–_»tuº
: \

1114 ià(
l
) \

1115 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
); \

1116  (
»t
); \

1117 }

	)

1119 
	#CTL_RO_CGEN
(
c
, 
n
, 
v
, 
t
) \

1121 
n
##
	`_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, \

1122 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
) \

1124 
»t
; \

1125 
t
 
Şdv®
; \

1127 ià(!(
c
)) \

1128  (
ENOENT
); \

1129 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
); \

1130 
	`READONLY
(); \

1131 
Şdv®
 = (
v
); \

1132 
	`READ
(
Şdv®
, 
t
); \

1134 
»t
 = 0; \

1135 
Ïb–_»tuº
: \

1136 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
); \

1137  (
»t
); \

1138 }

	)

1140 
	#CTL_RO_GEN
(
n
, 
v
, 
t
) \

1142 
n
##
	`_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, \

1143 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
) \

1145 
»t
; \

1146 
t
 
Şdv®
; \

1148 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
); \

1149 
	`READONLY
(); \

1150 
Şdv®
 = (
v
); \

1151 
	`READ
(
Şdv®
, 
t
); \

1153 
»t
 = 0; \

1154 
Ïb–_»tuº
: \

1155 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
); \

1156  (
»t
); \

1157 }

	)

1163 
	#CTL_RO_NL_CGEN
(
c
, 
n
, 
v
, 
t
) \

1165 
n
##
	`_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, \

1166 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
) \

1168 
»t
; \

1169 
t
 
Şdv®
; \

1171 ià(!(
c
)) \

1172  (
ENOENT
); \

1173 
	`READONLY
(); \

1174 
Şdv®
 = (
v
); \

1175 
	`READ
(
Şdv®
, 
t
); \

1177 
»t
 = 0; \

1178 
Ïb–_»tuº
: \

1179  (
»t
); \

1180 }

	)

1182 
	#CTL_RO_NL_GEN
(
n
, 
v
, 
t
) \

1184 
n
##
	`_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, \

1185 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
) \

1187 
»t
; \

1188 
t
 
Şdv®
; \

1190 
	`READONLY
(); \

1191 
Şdv®
 = (
v
); \

1192 
	`READ
(
Şdv®
, 
t
); \

1194 
»t
 = 0; \

1195 
Ïb–_»tuº
: \

1196  (
»t
); \

1197 }

	)

1199 
	#CTL_TSD_RO_NL_CGEN
(
c
, 
n
, 
m
, 
t
) \

1201 
n
##
	`_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, \

1202 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
) \

1204 
»t
; \

1205 
t
 
Şdv®
; \

1207 ià(!(
c
)) \

1208  (
ENOENT
); \

1209 
	`READONLY
(); \

1210 
Şdv®
 = (
	`m
(
tsd
)); \

1211 
	`READ
(
Şdv®
, 
t
); \

1213 
»t
 = 0; \

1214 
Ïb–_»tuº
: \

1215  (
»t
); \

1216 }

	)

1218 
	#CTL_RO_CONFIG_GEN
(
n
, 
t
) \

1220 
n
##
	`_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, \

1221 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
) \

1223 
»t
; \

1224 
t
 
Şdv®
; \

1226 
	`READONLY
(); \

1227 
Şdv®
 = 
n
; \

1228 
	`READ
(
Şdv®
, 
t
); \

1230 
»t
 = 0; \

1231 
Ïb–_»tuº
: \

1232  (
»t
); \

1233 }

	)

1237 
	$CTL_RO_NL_GEN
(
v”siÚ
, 
JEMALLOC_VERSION
, const *)

1240 
	$•och_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1241 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1243 
»t
;

1244 
UNUSED
 
ušt64_t
 
Ãwv®
;

1246 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1247 
	`WRITE
(
Ãwv®
, 
ušt64_t
);

1248 ià(
Ãwp
 !ğ
NULL
)

1249 
	`ùl_»äesh
(
	`tsd_tsdn
(
tsd
));

1250 
	`READ
(
ùl_•och
, 
ušt64_t
);

1252 
»t
 = 0;

1253 
Ïb–_»tuº
:

1254 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1255  (
»t
);

1256 
	}
}

1260 
	$CTL_RO_CONFIG_GEN
(
cÚfig_ÿche_oblivious
, 
boŞ
)

1261 
	$CTL_RO_CONFIG_GEN
(
cÚfig_debug
, 
boŞ
)

1262 
	$CTL_RO_CONFIG_GEN
(
cÚfig_fl
, 
boŞ
)

1263 
	$CTL_RO_CONFIG_GEN
(
cÚfig_Ïzy_lock
, 
boŞ
)

1264 
	$CTL_RO_CONFIG_GEN
(
cÚfig_m®loc_cÚf
, const *)

1265 
	$CTL_RO_CONFIG_GEN
(
cÚfig_munm­
, 
boŞ
)

1266 
	$CTL_RO_CONFIG_GEN
(
cÚfig_´of
, 
boŞ
)

1267 
	$CTL_RO_CONFIG_GEN
(
cÚfig_´of_libgcc
, 
boŞ
)

1268 
	$CTL_RO_CONFIG_GEN
(
cÚfig_´of_libunwšd
, 
boŞ
)

1269 
	$CTL_RO_CONFIG_GEN
(
cÚfig_¡©s
, 
boŞ
)

1270 
	$CTL_RO_CONFIG_GEN
(
cÚfig_tÿche
, 
boŞ
)

1271 
	$CTL_RO_CONFIG_GEN
(
cÚfig_s
, 
boŞ
)

1272 
	$CTL_RO_CONFIG_GEN
(
cÚfig_uŒaû
, 
boŞ
)

1273 
	$CTL_RO_CONFIG_GEN
(
cÚfig_v®gršd
, 
boŞ
)

1274 
	$CTL_RO_CONFIG_GEN
(
cÚfig_xm®loc
, 
boŞ
)

1278 
	$CTL_RO_NL_GEN
(
İt_abÜt
, o±_abÜt, 
boŞ
)

1279 
	$CTL_RO_NL_GEN
(
İt_dss
, opt_dss, const *)

1280 
	$CTL_RO_NL_GEN
(
İt_lg_chunk
, o±_lg_chunk, 
size_t
)

1281 
	$CTL_RO_NL_GEN
(
İt_Ç»Çs
, opt_narenas, )

1282 
	$CTL_RO_NL_GEN
(
İt_purge
, 
purge_mode_Çmes
[opt_purge], const *)

1283 
	$CTL_RO_NL_GEN
(
İt_lg_dœty_muÉ
, o±_lg_dœty_muÉ, 
ssize_t
)

1284 
	$CTL_RO_NL_GEN
(
İt_deÿy_time
, o±_deÿy_time, 
ssize_t
)

1285 
	$CTL_RO_NL_GEN
(
İt_¡©s_´št
, o±_¡©s_´št, 
boŞ
)

1286 
	$CTL_RO_NL_CGEN
(
cÚfig_fl
, 
İt_junk
, opt_junk, const *)

1287 
	$CTL_RO_NL_CGEN
(
cÚfig_fl
, 
İt_qu¬ªtše
, o±_qu¬ªtše, 
size_t
)

1288 
	$CTL_RO_NL_CGEN
(
cÚfig_fl
, 
İt_»dzÚe
, o±_»dzÚe, 
boŞ
)

1289 
	$CTL_RO_NL_CGEN
(
cÚfig_fl
, 
İt_z”o
, o±_z”o, 
boŞ
)

1290 
	$CTL_RO_NL_CGEN
(
cÚfig_uŒaû
, 
İt_uŒaû
, o±_uŒaû, 
boŞ
)

1291 
	$CTL_RO_NL_CGEN
(
cÚfig_xm®loc
, 
İt_xm®loc
, o±_xm®loc, 
boŞ
)

1292 
	$CTL_RO_NL_CGEN
(
cÚfig_tÿche
, 
İt_tÿche
, o±_tÿche, 
boŞ
)

1293 
	$CTL_RO_NL_CGEN
(
cÚfig_tÿche
, 
İt_lg_tÿche_max
, o±_lg_tÿche_max, 
ssize_t
)

1294 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of
, o±_´of, 
boŞ
)

1295 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_´efix
, opt_prof_prefix, const *)

1296 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_aùive
, o±_´of_aùive, 
boŞ
)

1297 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_th»ad_aùive_š™
,

1298 
İt_´of_th»ad_aùive_š™
, 
boŞ
)

1299 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_lg_´of_§m¶e
, o±_lg_´of_§m¶e, 
size_t
)

1300 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_accum
, o±_´of_accum, 
boŞ
)

1301 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_lg_´of_š‹rv®
, o±_lg_´of_š‹rv®, 
ssize_t
)

1302 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_gdump
, o±_´of_gdump, 
boŞ
)

1303 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_fš®
, o±_´of_fš®, 
boŞ
)

1304 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_Ëak
, o±_´of_Ëak, 
boŞ
)

1309 
	$th»ad_¬’a_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1310 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1312 
»t
;

1313 
¬’a_t
 *
Şd¬’a
;

1314 
Ãwšd
, 
Şdšd
;

1316 
Şd¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

1317 ià(
Şd¬’a
 =ğ
NULL
)

1318  (
EAGAIN
);

1320 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1321 
Ãwšd
 = 
Şdšd
 = 
Şd¬’a
->
šd
;

1322 
	`WRITE
(
Ãwšd
, );

1323 
	`READ
(
Şdšd
, );

1324 ià(
Ãwšd
 !ğ
Şdšd
) {

1325 
¬’a_t
 *
Ãw¬’a
;

1327 ià(
Ãwšd
 >ğ
ùl_¡©s
.
Ç»Çs
) {

1329 
»t
 = 
EFAULT
;

1330 
Ïb–_»tuº
;

1334 
Ãw¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
Ãwšd
, 
Œue
);

1335 ià(
Ãw¬’a
 =ğ
NULL
) {

1336 
»t
 = 
EAGAIN
;

1337 
Ïb–_»tuº
;

1340 
	`¬’a_mig¿‹
(
tsd
, 
Şdšd
, 
Ãwšd
);

1341 ià(
cÚfig_tÿche
) {

1342 
tÿche_t
 *
tÿche
 = 
	`tsd_tÿche_g‘
(
tsd
);

1343 ià(
tÿche
 !ğ
NULL
) {

1344 
	`tÿche_¬’a_»assocŸ‹
(
	`tsd_tsdn
(
tsd
), 
tÿche
,

1345 
Şd¬’a
, 
Ãw¬’a
);

1350 
»t
 = 0;

1351 
Ïb–_»tuº
:

1352 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1353  (
»t
);

1354 
	}
}

1356 
	$CTL_TSD_RO_NL_CGEN
(
cÚfig_¡©s
, 
th»ad_®loÿ‹d
, 
tsd_th»ad_®loÿ‹d_g‘
,

1357 
ušt64_t
)

1358 
	$CTL_TSD_RO_NL_CGEN
(
cÚfig_¡©s
, 
th»ad_®loÿ‹dp
, 
tsd_th»ad_®loÿ‹dp_g‘
,

1359 
ušt64_t
 *)

1360 
	$CTL_TSD_RO_NL_CGEN
(
cÚfig_¡©s
, 
th»ad_d—Îoÿ‹d
, 
tsd_th»ad_d—Îoÿ‹d_g‘
,

1361 
ušt64_t
)

1362 
	$CTL_TSD_RO_NL_CGEN
(
cÚfig_¡©s
, 
th»ad_d—Îoÿ‹dp
,

1363 
tsd_th»ad_d—Îoÿ‹dp_g‘
, 
ušt64_t
 *)

1366 
	$th»ad_tÿche_’abËd_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
,

1367 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1369 
»t
;

1370 
boŞ
 
Şdv®
;

1372 ià(!
cÚfig_tÿche
)

1373  (
ENOENT
);

1375 
Şdv®
 = 
	`tÿche_’abËd_g‘
();

1376 ià(
Ãwp
 !ğ
NULL
) {

1377 ià(
ÃwËn
 !ğ(
boŞ
)) {

1378 
»t
 = 
EINVAL
;

1379 
Ïb–_»tuº
;

1381 
	`tÿche_’abËd_£t
(*(
boŞ
 *)
Ãwp
);

1383 
	`READ
(
Şdv®
, 
boŞ
);

1385 
»t
 = 0;

1386 
Ïb–_»tuº
:

1387  (
»t
);

1388 
	}
}

1391 
	$th»ad_tÿche_æush_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
,

1392 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1394 
»t
;

1396 ià(!
cÚfig_tÿche
)

1397  (
ENOENT
);

1399 
	`READONLY
();

1400 
	`WRITEONLY
();

1402 
	`tÿche_æush
();

1404 
»t
 = 0;

1405 
Ïb–_»tuº
:

1406  (
»t
);

1407 
	}
}

1410 
	$th»ad_´of_Çme_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1411 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1413 
»t
;

1415 ià(!
cÚfig_´of
)

1416  (
ENOENT
);

1418 
	`READ_XOR_WRITE
();

1420 ià(
Ãwp
 !ğ
NULL
) {

1421 ià(
ÃwËn
 != (const *)) {

1422 
»t
 = 
EINVAL
;

1423 
Ïb–_»tuº
;

1426 ià((
»t
 = 
	`´of_th»ad_Çme_£t
(
tsd
, *(cÚ¡ **)
Ãwp
)) !=

1428 
Ïb–_»tuº
;

1430 cÚ¡ *
ŞdÇme
 = 
	`´of_th»ad_Çme_g‘
(
tsd
);

1431 
	`READ
(
ŞdÇme
, const *);

1434 
»t
 = 0;

1435 
Ïb–_»tuº
:

1436  (
»t
);

1437 
	}
}

1440 
	$th»ad_´of_aùive_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1441 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1443 
»t
;

1444 
boŞ
 
Şdv®
;

1446 ià(!
cÚfig_´of
)

1447  (
ENOENT
);

1449 
Şdv®
 = 
	`´of_th»ad_aùive_g‘
(
tsd
);

1450 ià(
Ãwp
 !ğ
NULL
) {

1451 ià(
ÃwËn
 !ğ(
boŞ
)) {

1452 
»t
 = 
EINVAL
;

1453 
Ïb–_»tuº
;

1455 ià(
	`´of_th»ad_aùive_£t
(
tsd
, *(
boŞ
 *)
Ãwp
)) {

1456 
»t
 = 
EAGAIN
;

1457 
Ïb–_»tuº
;

1460 
	`READ
(
Şdv®
, 
boŞ
);

1462 
»t
 = 0;

1463 
Ïb–_»tuº
:

1464  (
»t
);

1465 
	}
}

1470 
	$tÿche_ü—‹_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1471 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1473 
»t
;

1474 
tÿche_šd
;

1476 ià(!
cÚfig_tÿche
)

1477  (
ENOENT
);

1479 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1480 
	`READONLY
();

1481 ià(
	`tÿches_ü—‹
(
	`tsd_tsdn
(
tsd
), &
tÿche_šd
)) {

1482 
»t
 = 
EFAULT
;

1483 
Ïb–_»tuº
;

1485 
	`READ
(
tÿche_šd
, );

1487 
»t
 = 0;

1488 
Ïb–_»tuº
:

1489 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1490  (
»t
);

1491 
	}
}

1494 
	$tÿche_æush_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1495 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1497 
»t
;

1498 
tÿche_šd
;

1500 ià(!
cÚfig_tÿche
)

1501  (
ENOENT
);

1503 
	`WRITEONLY
();

1504 
tÿche_šd
 = 
UINT_MAX
;

1505 
	`WRITE
(
tÿche_šd
, );

1506 ià(
tÿche_šd
 =ğ
UINT_MAX
) {

1507 
»t
 = 
EFAULT
;

1508 
Ïb–_»tuº
;

1510 
	`tÿches_æush
(
tsd
, 
tÿche_šd
);

1512 
»t
 = 0;

1513 
Ïb–_»tuº
:

1514  (
»t
);

1515 
	}
}

1518 
	$tÿche_de¡roy_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1519 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1521 
»t
;

1522 
tÿche_šd
;

1524 ià(!
cÚfig_tÿche
)

1525  (
ENOENT
);

1527 
	`WRITEONLY
();

1528 
tÿche_šd
 = 
UINT_MAX
;

1529 
	`WRITE
(
tÿche_šd
, );

1530 ià(
tÿche_šd
 =ğ
UINT_MAX
) {

1531 
»t
 = 
EFAULT
;

1532 
Ïb–_»tuº
;

1534 
	`tÿches_de¡roy
(
tsd
, 
tÿche_šd
);

1536 
»t
 = 0;

1537 
Ïb–_»tuº
:

1538  (
»t
);

1539 
	}
}

1544 
	$¬’a_i_purge
(
tsdn_t
 *
tsdn
, 
¬’a_šd
, 
boŞ
 
®l
)

1547 
	`m®loc_mu‹x_lock
(
tsdn
, &
ùl_mtx
);

1549 
Ç»Çs
 = 
ùl_¡©s
.narenas;

1551 ià(
¬’a_šd
 =ğ
Ç»Çs
) {

1552 
i
;

1553 
	`VARIABLE_ARRAY
(
¬’a_t
 *, 
»Çs
, 
Ç»Çs
);

1555 
i
 = 0; i < 
Ç»Çs
; i++)

1556 
»Çs
[
i
] = 
	`¬’a_g‘
(
tsdn
, i, 
çl£
);

1562 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
ùl_mtx
);

1564 
i
 = 0; i < 
Ç»Çs
; i++) {

1565 ià(
»Çs
[
i
] !ğ
NULL
)

1566 
	`¬’a_purge
(
tsdn
, 
»Çs
[
i
], 
®l
);

1569 
¬’a_t
 *
»Ç
;

1571 
	`as£¹
(
¬’a_šd
 < 
Ç»Çs
);

1573 
»Ç
 = 
	`¬’a_g‘
(
tsdn
, 
¬’a_šd
, 
çl£
);

1576 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
ùl_mtx
);

1578 ià(
»Ç
 !ğ
NULL
)

1579 
	`¬’a_purge
(
tsdn
, 
»Ç
, 
®l
);

1582 
	}
}

1585 
	$¬’a_i_purge_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1586 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1588 
»t
;

1590 
	`READONLY
();

1591 
	`WRITEONLY
();

1592 
	`¬’a_i_purge
(
	`tsd_tsdn
(
tsd
), ()
mib
[1], 
Œue
);

1594 
»t
 = 0;

1595 
Ïb–_»tuº
:

1596  (
»t
);

1597 
	}
}

1600 
	$¬’a_i_deÿy_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1601 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1603 
»t
;

1605 
	`READONLY
();

1606 
	`WRITEONLY
();

1607 
	`¬’a_i_purge
(
	`tsd_tsdn
(
tsd
), ()
mib
[1], 
çl£
);

1609 
»t
 = 0;

1610 
Ïb–_»tuº
:

1611  (
»t
);

1612 
	}
}

1615 
	$¬’a_i_»£t_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1616 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1618 
»t
;

1619 
¬’a_šd
;

1620 
¬’a_t
 *
¬’a
;

1622 
	`READONLY
();

1623 
	`WRITEONLY
();

1625 ià((
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
)è|| (
cÚfig_fl
 &&

1626 
	`uÆik–y
(
İt_qu¬ªtše
))) {

1627 
»t
 = 
EFAULT
;

1628 
Ïb–_»tuº
;

1631 
¬’a_šd
 = ()
mib
[1];

1632 ià(
cÚfig_debug
) {

1633 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1634 
	`as£¹
(
¬’a_šd
 < 
ùl_¡©s
.
Ç»Çs
);

1635 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1637 
	`as£¹
(
¬’a_šd
 >ğ
İt_Ç»Çs
);

1639 
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a_šd
, 
çl£
);

1641 
	`¬’a_»£t
(
tsd
, 
¬’a
);

1643 
»t
 = 0;

1644 
Ïb–_»tuº
:

1645  (
»t
);

1646 
	}
}

1649 
	$¬’a_i_dss_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1650 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1652 
»t
;

1653 cÚ¡ *
dss
 = 
NULL
;

1654 
¬’a_šd
 = ()
mib
[1];

1655 
dss_´ec_t
 
dss_´ec_Şd
 = 
dss_´ec_lim™
;

1656 
dss_´ec_t
 
dss_´ec
 = 
dss_´ec_lim™
;

1658 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1659 
	`WRITE
(
dss
, const *);

1660 ià(
dss
 !ğ
NULL
) {

1661 
i
;

1662 
boŞ
 
m©ch
 = 
çl£
;

1664 
i
 = 0; i < 
dss_´ec_lim™
; i++) {

1665 ià(
	`¡rcmp
(
dss_´ec_Çmes
[
i
], 
dss
) == 0) {

1666 
dss_´ec
 = 
i
;

1667 
m©ch
 = 
Œue
;

1672 ià(!
m©ch
) {

1673 
»t
 = 
EINVAL
;

1674 
Ïb–_»tuº
;

1678 ià(
¬’a_šd
 < 
ùl_¡©s
.
Ç»Çs
) {

1679 
¬’a_t
 *
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a_šd
, 
çl£
);

1680 ià(
¬’a
 =ğ
NULL
 || (
dss_´ec
 !ğ
dss_´ec_lim™
 &&

1681 
	`¬’a_dss_´ec_£t
(
	`tsd_tsdn
(
tsd
), 
¬’a
, 
dss_´ec
))) {

1682 
»t
 = 
EFAULT
;

1683 
Ïb–_»tuº
;

1685 
dss_´ec_Şd
 = 
	`¬’a_dss_´ec_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

1687 ià(
dss_´ec
 !ğ
dss_´ec_lim™
 &&

1688 
	`chunk_dss_´ec_£t
(
	`tsd_tsdn
(
tsd
), 
dss_´ec
)) {

1689 
»t
 = 
EFAULT
;

1690 
Ïb–_»tuº
;

1692 
dss_´ec_Şd
 = 
	`chunk_dss_´ec_g‘
(
	`tsd_tsdn
(
tsd
));

1695 
dss
 = 
dss_´ec_Çmes
[
dss_´ec_Şd
];

1696 
	`READ
(
dss
, const *);

1698 
»t
 = 0;

1699 
Ïb–_»tuº
:

1700 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1701  (
»t
);

1702 
	}
}

1705 
	$¬’a_i_lg_dœty_muÉ_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
,

1706 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1708 
»t
;

1709 
¬’a_šd
 = ()
mib
[1];

1710 
¬’a_t
 *
¬’a
;

1712 
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a_šd
, 
çl£
);

1713 ià(
¬’a
 =ğ
NULL
) {

1714 
»t
 = 
EFAULT
;

1715 
Ïb–_»tuº
;

1718 ià(
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 != NULL) {

1719 
size_t
 
Şdv®
 = 
	`¬’a_lg_dœty_muÉ_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

1720 
	`READ
(
Şdv®
, 
ssize_t
);

1722 ià(
Ãwp
 !ğ
NULL
) {

1723 ià(
ÃwËn
 !ğ(
ssize_t
)) {

1724 
»t
 = 
EINVAL
;

1725 
Ïb–_»tuº
;

1727 ià(
	`¬’a_lg_dœty_muÉ_£t
(
	`tsd_tsdn
(
tsd
), 
¬’a
,

1728 *(
ssize_t
 *)
Ãwp
)) {

1729 
»t
 = 
EFAULT
;

1730 
Ïb–_»tuº
;

1734 
»t
 = 0;

1735 
Ïb–_»tuº
:

1736  (
»t
);

1737 
	}
}

1740 
	$¬’a_i_deÿy_time_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1741 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1743 
»t
;

1744 
¬’a_šd
 = ()
mib
[1];

1745 
¬’a_t
 *
¬’a
;

1747 
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a_šd
, 
çl£
);

1748 ià(
¬’a
 =ğ
NULL
) {

1749 
»t
 = 
EFAULT
;

1750 
Ïb–_»tuº
;

1753 ià(
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 != NULL) {

1754 
size_t
 
Şdv®
 = 
	`¬’a_deÿy_time_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

1755 
	`READ
(
Şdv®
, 
ssize_t
);

1757 ià(
Ãwp
 !ğ
NULL
) {

1758 ià(
ÃwËn
 !ğ(
ssize_t
)) {

1759 
»t
 = 
EINVAL
;

1760 
Ïb–_»tuº
;

1762 ià(
	`¬’a_deÿy_time_£t
(
	`tsd_tsdn
(
tsd
), 
¬’a
,

1763 *(
ssize_t
 *)
Ãwp
)) {

1764 
»t
 = 
EFAULT
;

1765 
Ïb–_»tuº
;

1769 
»t
 = 0;

1770 
Ïb–_»tuº
:

1771  (
»t
);

1772 
	}
}

1775 
	$¬’a_i_chunk_hooks_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
,

1776 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1778 
»t
;

1779 
¬’a_šd
 = ()
mib
[1];

1780 
¬’a_t
 *
¬’a
;

1782 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1783 ià(
¬’a_šd
 < 
	`Ç»Çs_tÙ®_g‘
(è&& (
¬’a
 =

1784 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a_šd
, 
çl£
)è!ğ
NULL
) {

1785 ià(
Ãwp
 !ğ
NULL
) {

1786 
chunk_hooks_t
 
Şd_chunk_hooks
, 
Ãw_chunk_hooks
;

1787 
	`WRITE
(
Ãw_chunk_hooks
, 
chunk_hooks_t
);

1788 
Şd_chunk_hooks
 = 
	`chunk_hooks_£t
(
	`tsd_tsdn
(
tsd
), 
¬’a
,

1789 &
Ãw_chunk_hooks
);

1790 
	`READ
(
Şd_chunk_hooks
, 
chunk_hooks_t
);

1792 
chunk_hooks_t
 
Şd_chunk_hooks
 =

1793 
	`chunk_hooks_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

1794 
	`READ
(
Şd_chunk_hooks
, 
chunk_hooks_t
);

1797 
»t
 = 
EFAULT
;

1798 
Ïb–_»tuº
;

1800 
»t
 = 0;

1801 
Ïb–_»tuº
:

1802 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1803  (
»t
);

1804 
	}
}

1806 cÚ¡ 
ùl_Çmed_node_t
 *

1807 
	$¬’a_i_šdex
(
tsdn_t
 *
tsdn
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

1809 cÚ¡ 
ùl_Çmed_node_t
 *
»t
;

1811 
	`m®loc_mu‹x_lock
(
tsdn
, &
ùl_mtx
);

1812 ià(
i
 > 
ùl_¡©s
.
Ç»Çs
) {

1813 
»t
 = 
NULL
;

1814 
Ïb–_»tuº
;

1817 
»t
 = 
su³r_¬’a_i_node
;

1818 
Ïb–_»tuº
:

1819 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
ùl_mtx
);

1820  (
»t
);

1821 
	}
}

1826 
	$¬’as_Ç»Çs_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1827 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1829 
»t
;

1830 
Ç»Çs
;

1832 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1833 
	`READONLY
();

1834 ià(*
ŞdËÅ
 != ()) {

1835 
»t
 = 
EINVAL
;

1836 
Ïb–_»tuº
;

1838 
Ç»Çs
 = 
ùl_¡©s
.narenas;

1839 
	`READ
(
Ç»Çs
, );

1841 
»t
 = 0;

1842 
Ïb–_»tuº
:

1843 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1844  (
»t
);

1845 
	}
}

1848 
	$¬’as_š™Ÿlized_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1849 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1851 
»t
;

1852 
Ä—d
, 
i
;

1854 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1855 
	`READONLY
();

1856 ià(*
ŞdËÅ
 !ğ
ùl_¡©s
.
Ç»Çs
 * (
boŞ
)) {

1857 
»t
 = 
EINVAL
;

1858 
Ä—d
 = (*
ŞdËÅ
 < 
ùl_¡©s
.
Ç»Çs
 * (
boŞ
))

1859 ? ()(*
ŞdËÅ
 / (
boŞ
)è: 
ùl_¡©s
.
Ç»Çs
;

1861 
»t
 = 0;

1862 
Ä—d
 = 
ùl_¡©s
.
Ç»Çs
;

1865 
i
 = 0; i < 
Ä—d
; i++)

1866 ((
boŞ
 *)
Şdp
)[
i
] = 
ùl_¡©s
.
¬’as
[i].
š™Ÿlized
;

1868 
Ïb–_»tuº
:

1869 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1870  (
»t
);

1871 
	}
}

1874 
	$¬’as_lg_dœty_muÉ_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
,

1875 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1877 
»t
;

1879 ià(
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 != NULL) {

1880 
size_t
 
Şdv®
 = 
	`¬’a_lg_dœty_muÉ_deçuÉ_g‘
();

1881 
	`READ
(
Şdv®
, 
ssize_t
);

1883 ià(
Ãwp
 !ğ
NULL
) {

1884 ià(
ÃwËn
 !ğ(
ssize_t
)) {

1885 
»t
 = 
EINVAL
;

1886 
Ïb–_»tuº
;

1888 ià(
	`¬’a_lg_dœty_muÉ_deçuÉ_£t
(*(
ssize_t
 *)
Ãwp
)) {

1889 
»t
 = 
EFAULT
;

1890 
Ïb–_»tuº
;

1894 
»t
 = 0;

1895 
Ïb–_»tuº
:

1896  (
»t
);

1897 
	}
}

1900 
	$¬’as_deÿy_time_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1901 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1903 
»t
;

1905 ià(
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 != NULL) {

1906 
size_t
 
Şdv®
 = 
	`¬’a_deÿy_time_deçuÉ_g‘
();

1907 
	`READ
(
Şdv®
, 
ssize_t
);

1909 ià(
Ãwp
 !ğ
NULL
) {

1910 ià(
ÃwËn
 !ğ(
ssize_t
)) {

1911 
»t
 = 
EINVAL
;

1912 
Ïb–_»tuº
;

1914 ià(
	`¬’a_deÿy_time_deçuÉ_£t
(*(
ssize_t
 *)
Ãwp
)) {

1915 
»t
 = 
EFAULT
;

1916 
Ïb–_»tuº
;

1920 
»t
 = 0;

1921 
Ïb–_»tuº
:

1922  (
»t
);

1923 
	}
}

1925 
	$CTL_RO_NL_GEN
(
¬’as_quªtum
, 
QUANTUM
, 
size_t
)

1926 
	$CTL_RO_NL_GEN
(
¬’as_·ge
, 
PAGE
, 
size_t
)

1927 
	$CTL_RO_NL_CGEN
(
cÚfig_tÿche
, 
¬’as_tÿche_max
, 
tÿche_maxşass
, 
size_t
)

1928 
	$CTL_RO_NL_GEN
(
¬’as_nbšs
, 
NBINS
, )

1929 
	$CTL_RO_NL_CGEN
(
cÚfig_tÿche
, 
¬’as_nhbšs
, 
nhbšs
, )

1930 
	$CTL_RO_NL_GEN
(
¬’as_bš_i_size
, 
¬’a_bš_šfo
[
mib
[2]].
»g_size
, 
size_t
)

1931 
	$CTL_RO_NL_GEN
(
¬’as_bš_i_Äegs
, 
¬’a_bš_šfo
[
mib
[2]].
Äegs
, 
ušt32_t
)

1932 
	$CTL_RO_NL_GEN
(
¬’as_bš_i_run_size
, 
¬’a_bš_šfo
[
mib
[2]].
run_size
, 
size_t
)

1933 cÚ¡ 
ùl_Çmed_node_t
 *

1934 
	$¬’as_bš_i_šdex
(
tsdn_t
 *
tsdn
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

1937 ià(
i
 > 
NBINS
)

1938  (
NULL
);

1939  (
su³r_¬’as_bš_i_node
);

1940 
	}
}

1942 
	$CTL_RO_NL_GEN
(
¬’as_Æruns
, 
Æşas£s
, )

1943 
	`CTL_RO_NL_GEN
(
¬’as_Ìun_i_size
, 
	`šdex2size
(
NBINS
+(
szšd_t
)
mib
[2]), 
size_t
)

1944 cÚ¡ 
ùl_Çmed_node_t
 *

1945 
	$¬’as_Ìun_i_šdex
(
tsdn_t
 *
tsdn
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

1948 ià(
i
 > 
Æşas£s
)

1949  (
NULL
);

1950  (
su³r_¬’as_Ìun_i_node
);

1951 
	}
}

1953 
	$CTL_RO_NL_GEN
(
¬’as_nhchunks
, 
nhşas£s
, )

1954 
	`CTL_RO_NL_GEN
(
¬’as_hchunk_i_size
, 
	`šdex2size
(
NBINS
+
Æşas£s
+(
szšd_t
)
mib
[2]),

1955 
size_t
)

1956 cÚ¡ 
ùl_Çmed_node_t
 *

1957 
	$¬’as_hchunk_i_šdex
(
tsdn_t
 *
tsdn
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

1960 ià(
i
 > 
nhşas£s
)

1961  (
NULL
);

1962  (
su³r_¬’as_hchunk_i_node
);

1963 
	}
}

1966 
	$¬’as_ex‹nd_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1967 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1969 
»t
;

1970 
Ç»Çs
;

1972 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1973 
	`READONLY
();

1974 ià(
	`ùl_grow
(
	`tsd_tsdn
(
tsd
))) {

1975 
»t
 = 
EAGAIN
;

1976 
Ïb–_»tuº
;

1978 
Ç»Çs
 = 
ùl_¡©s
.narenas - 1;

1979 
	`READ
(
Ç»Çs
, );

1981 
»t
 = 0;

1982 
Ïb–_»tuº
:

1983 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
ùl_mtx
);

1984  (
»t
);

1985 
	}
}

1990 
	$´of_th»ad_aùive_š™_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
,

1991 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1993 
»t
;

1994 
boŞ
 
Şdv®
;

1996 ià(!
cÚfig_´of
)

1997  (
ENOENT
);

1999 ià(
Ãwp
 !ğ
NULL
) {

2000 ià(
ÃwËn
 !ğ(
boŞ
)) {

2001 
»t
 = 
EINVAL
;

2002 
Ïb–_»tuº
;

2004 
Şdv®
 = 
	`´of_th»ad_aùive_š™_£t
(
	`tsd_tsdn
(
tsd
),

2005 *(
boŞ
 *)
Ãwp
);

2007 
Şdv®
 = 
	`´of_th»ad_aùive_š™_g‘
(
	`tsd_tsdn
(
tsd
));

2008 
	`READ
(
Şdv®
, 
boŞ
);

2010 
»t
 = 0;

2011 
Ïb–_»tuº
:

2012  (
»t
);

2013 
	}
}

2016 
	$´of_aùive_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

2017 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

2019 
»t
;

2020 
boŞ
 
Şdv®
;

2022 ià(!
cÚfig_´of
)

2023  (
ENOENT
);

2025 ià(
Ãwp
 !ğ
NULL
) {

2026 ià(
ÃwËn
 !ğ(
boŞ
)) {

2027 
»t
 = 
EINVAL
;

2028 
Ïb–_»tuº
;

2030 
Şdv®
 = 
	`´of_aùive_£t
(
	`tsd_tsdn
(
tsd
), *(
boŞ
 *)
Ãwp
);

2032 
Şdv®
 = 
	`´of_aùive_g‘
(
	`tsd_tsdn
(
tsd
));

2033 
	`READ
(
Şdv®
, 
boŞ
);

2035 
»t
 = 0;

2036 
Ïb–_»tuº
:

2037  (
»t
);

2038 
	}
}

2041 
	$´of_dump_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

2042 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

2044 
»t
;

2045 cÚ¡ *
f’ame
 = 
NULL
;

2047 ià(!
cÚfig_´of
)

2048  (
ENOENT
);

2050 
	`WRITEONLY
();

2051 
	`WRITE
(
f’ame
, const *);

2053 ià(
	`´of_mdump
(
tsd
, 
f’ame
)) {

2054 
»t
 = 
EFAULT
;

2055 
Ïb–_»tuº
;

2058 
»t
 = 0;

2059 
Ïb–_»tuº
:

2060  (
»t
);

2061 
	}
}

2064 
	$´of_gdump_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

2065 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

2067 
»t
;

2068 
boŞ
 
Şdv®
;

2070 ià(!
cÚfig_´of
)

2071  (
ENOENT
);

2073 ià(
Ãwp
 !ğ
NULL
) {

2074 ià(
ÃwËn
 !ğ(
boŞ
)) {

2075 
»t
 = 
EINVAL
;

2076 
Ïb–_»tuº
;

2078 
Şdv®
 = 
	`´of_gdump_£t
(
	`tsd_tsdn
(
tsd
), *(
boŞ
 *)
Ãwp
);

2080 
Şdv®
 = 
	`´of_gdump_g‘
(
	`tsd_tsdn
(
tsd
));

2081 
	`READ
(
Şdv®
, 
boŞ
);

2083 
»t
 = 0;

2084 
Ïb–_»tuº
:

2085  (
»t
);

2086 
	}
}

2089 
	$´of_»£t_ùl
(
tsd_t
 *
tsd
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

2090 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

2092 
»t
;

2093 
size_t
 
lg_§m¶e
 = 
lg_´of_§m¶e
;

2095 ià(!
cÚfig_´of
)

2096  (
ENOENT
);

2098 
	`WRITEONLY
();

2099 
	`WRITE
(
lg_§m¶e
, 
size_t
);

2100 ià(
lg_§m¶e
 >ğ((
ušt64_t
) << 3))

2101 
lg_§m¶e
 = ((
ušt64_t
) << 3) - 1;

2103 
	`´of_»£t
(
	`tsd_tsdn
(
tsd
), 
lg_§m¶e
);

2105 
»t
 = 0;

2106 
Ïb–_»tuº
:

2107  (
»t
);

2108 
	}
}

2110 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
´of_š‹rv®
,…rof_š‹rv®, 
ušt64_t
)

2111 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
lg_´of_§m¶e
,†g_´of_§m¶e, 
size_t
)

2115 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_ÿùive
, &¡©s_ÿùive, 
size_t
 *)

2116 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_®loÿ‹d
, 
ùl_¡©s
.
®loÿ‹d
, 
size_t
)

2117 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_aùive
, 
ùl_¡©s
.
aùive
, 
size_t
)

2118 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_m‘ad©a
, 
ùl_¡©s
.
m‘ad©a
, 
size_t
)

2119 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_»sid’t
, 
ùl_¡©s
.
»sid’t
, 
size_t
)

2120 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_m­³d
, 
ùl_¡©s
.
m­³d
, 
size_t
)

2121 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_»šed
, 
ùl_¡©s
.
»šed
, 
size_t
)

2123 
	$CTL_RO_GEN
(
¡©s_¬’as_i_dss
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
dss
, const *)

2124 
	$CTL_RO_GEN
(
¡©s_¬’as_i_lg_dœty_muÉ
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
lg_dœty_muÉ
,

2125 
ssize_t
)

2126 
	$CTL_RO_GEN
(
¡©s_¬’as_i_deÿy_time
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
deÿy_time
,

2127 
ssize_t
)

2128 
	$CTL_RO_GEN
(
¡©s_¬’as_i_Áh»ads
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
Áh»ads
, )

2129 
	$CTL_RO_GEN
(
¡©s_¬’as_i_·ùive
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
·ùive
, 
size_t
)

2130 
	$CTL_RO_GEN
(
¡©s_¬’as_i_pdœty
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
pdœty
, 
size_t
)

2131 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_m­³d
,

2132 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
m­³d
, 
size_t
)

2133 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_»šed
,

2134 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
»šed
, 
size_t
)

2135 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Åurge
,

2136 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
Åurge
, 
ušt64_t
)

2137 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_nmadvi£
,

2138 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nmadvi£
, 
ušt64_t
)

2139 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_purged
,

2140 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
purged
, 
ušt64_t
)

2141 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_m‘ad©a_m­³d
,

2142 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
m‘ad©a_m­³d
, 
size_t
)

2143 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_m‘ad©a_®loÿ‹d
,

2144 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
m‘ad©a_®loÿ‹d
, 
size_t
)

2146 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_sm®l_®loÿ‹d
,

2147 
ùl_¡©s
.
¬’as
[
mib
[2]].
®loÿ‹d_sm®l
, 
size_t
)

2148 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_sm®l_nm®loc
,

2149 
ùl_¡©s
.
¬’as
[
mib
[2]].
nm®loc_sm®l
, 
ušt64_t
)

2150 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_sm®l_nd®loc
,

2151 
ùl_¡©s
.
¬’as
[
mib
[2]].
nd®loc_sm®l
, 
ušt64_t
)

2152 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_sm®l_Äeque¡s
,

2153 
ùl_¡©s
.
¬’as
[
mib
[2]].
Äeque¡s_sm®l
, 
ušt64_t
)

2154 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ïrge_®loÿ‹d
,

2155 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
®loÿ‹d_Ïrge
, 
size_t
)

2156 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ïrge_nm®loc
,

2157 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nm®loc_Ïrge
, 
ušt64_t
)

2158 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ïrge_nd®loc
,

2159 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nd®loc_Ïrge
, 
ušt64_t
)

2160 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ïrge_Äeque¡s
,

2161 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
Äeque¡s_Ïrge
, 
ušt64_t
)

2162 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_huge_®loÿ‹d
,

2163 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
®loÿ‹d_huge
, 
size_t
)

2164 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_huge_nm®loc
,

2165 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nm®loc_huge
, 
ušt64_t
)

2166 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_huge_nd®loc
,

2167 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nd®loc_huge
, 
ušt64_t
)

2168 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_huge_Äeque¡s
,

2169 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nm®loc_huge
, 
ušt64_t
)

2171 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_nm®loc
,

2172 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
nm®loc
, 
ušt64_t
)

2173 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_nd®loc
,

2174 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
nd®loc
, 
ušt64_t
)

2175 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_Äeque¡s
,

2176 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
Äeque¡s
, 
ušt64_t
)

2177 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_cu¼egs
,

2178 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
cu¼egs
, 
size_t
)

2179 
	$CTL_RO_CGEN
(
cÚfig_¡©s
 && 
cÚfig_tÿche
, 
¡©s_¬’as_i_bšs_j_nfls
,

2180 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
nfls
, 
ušt64_t
)

2181 
	$CTL_RO_CGEN
(
cÚfig_¡©s
 && 
cÚfig_tÿche
, 
¡©s_¬’as_i_bšs_j_næushes
,

2182 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
næushes
, 
ušt64_t
)

2183 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_Äuns
,

2184 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
Äuns
, 
ušt64_t
)

2185 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_Ä”uns
,

2186 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
»runs
, 
ušt64_t
)

2187 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_cu¼uns
,

2188 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
cu¼uns
, 
size_t
)

2190 cÚ¡ 
ùl_Çmed_node_t
 *

2191 
	$¡©s_¬’as_i_bšs_j_šdex
(
tsdn_t
 *
tsdn
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
,

2192 
size_t
 
j
)

2195 ià(
j
 > 
NBINS
)

2196  (
NULL
);

2197  (
su³r_¡©s_¬’as_i_bšs_j_node
);

2198 
	}
}

2200 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ìuns_j_nm®loc
,

2201 
ùl_¡©s
.
¬’as
[
mib
[2]].
l¡©s
[mib[4]].
nm®loc
, 
ušt64_t
)

2202 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ìuns_j_nd®loc
,

2203 
ùl_¡©s
.
¬’as
[
mib
[2]].
l¡©s
[mib[4]].
nd®loc
, 
ušt64_t
)

2204 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ìuns_j_Äeque¡s
,

2205 
ùl_¡©s
.
¬’as
[
mib
[2]].
l¡©s
[mib[4]].
Äeque¡s
, 
ušt64_t
)

2206 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ìuns_j_cu¼uns
,

2207 
ùl_¡©s
.
¬’as
[
mib
[2]].
l¡©s
[mib[4]].
cu¼uns
, 
size_t
)

2209 cÚ¡ 
ùl_Çmed_node_t
 *

2210 
	$¡©s_¬’as_i_Ìuns_j_šdex
(
tsdn_t
 *
tsdn
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
,

2211 
size_t
 
j
)

2214 ià(
j
 > 
Æşas£s
)

2215  (
NULL
);

2216  (
su³r_¡©s_¬’as_i_Ìuns_j_node
);

2217 
	}
}

2219 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_hchunks_j_nm®loc
,

2220 
ùl_¡©s
.
¬’as
[
mib
[2]].
h¡©s
[mib[4]].
nm®loc
, 
ušt64_t
)

2221 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_hchunks_j_nd®loc
,

2222 
ùl_¡©s
.
¬’as
[
mib
[2]].
h¡©s
[mib[4]].
nd®loc
, 
ušt64_t
)

2223 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_hchunks_j_Äeque¡s
,

2224 
ùl_¡©s
.
¬’as
[
mib
[2]].
h¡©s
[mib[4]].
nm®loc
,

2225 
ušt64_t
)

2226 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_hchunks_j_curhchunks
,

2227 
ùl_¡©s
.
¬’as
[
mib
[2]].
h¡©s
[mib[4]].
curhchunks
, 
size_t
)

2229 cÚ¡ 
ùl_Çmed_node_t
 *

2230 
	$¡©s_¬’as_i_hchunks_j_šdex
(
tsdn_t
 *
tsdn
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
,

2231 
size_t
 
j
)

2234 ià(
j
 > 
nhşas£s
)

2235  (
NULL
);

2236  (
su³r_¡©s_¬’as_i_hchunks_j_node
);

2237 
	}
}

2239 cÚ¡ 
ùl_Çmed_node_t
 *

2240 
	$¡©s_¬’as_i_šdex
(
tsdn_t
 *
tsdn
, cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

2242 cÚ¡ 
ùl_Çmed_node_t
 * 
»t
;

2244 
	`m®loc_mu‹x_lock
(
tsdn
, &
ùl_mtx
);

2245 ià(
i
 > 
ùl_¡©s
.
Ç»Çs
 || !ùl_¡©s.
¬’as
[i].
š™Ÿlized
) {

2246 
»t
 = 
NULL
;

2247 
Ïb–_»tuº
;

2250 
»t
 = 
su³r_¡©s_¬’as_i_node
;

2251 
Ïb–_»tuº
:

2252 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
ùl_mtx
);

2253  (
»t
);

2254 
	}
}

	@dep/jemalloc-4.2.0/src/extent.c

1 
	#JEMALLOC_EXTENT_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

6 
JEMALLOC_INLINE_C
 
size_t


7 
	$ex‹Á_quªtize
(
size_t
 
size
)

14  (
	`šdex2size
(
	`size2šdex
(
size
 + 1) - 1));

15 
	}
}

17 
JEMALLOC_INLINE_C
 

18 
	$ex‹Á_szad_comp
(cÚ¡ 
ex‹Á_node_t
 *
a
, cÚ¡ƒx‹Á_node_ˆ*
b
)

20 
»t
;

21 
size_t
 
a_qsize
 = 
	`ex‹Á_quªtize
(
	`ex‹Á_node_size_g‘
(
a
));

22 
size_t
 
b_qsize
 = 
	`ex‹Á_quªtize
(
	`ex‹Á_node_size_g‘
(
b
));

28 
»t
 = (
a_qsize
 > 
b_qsize
) - (a_qsize < b_qsize);

29 ià(
»t
 == 0) {

30 
ušŒ_t
 
a_addr
 = (ušŒ_t)
	`ex‹Á_node_addr_g‘
(
a
);

31 
ušŒ_t
 
b_addr
 = (ušŒ_t)
	`ex‹Á_node_addr_g‘
(
b
);

33 
»t
 = (
a_addr
 > 
b_addr
) - (a_addr < b_addr);

36  (
»t
);

37 
	}
}

40 
	$rb_g’
(, 
ex‹Á_Œ“_szad_
, 
ex‹Á_Œ“_t
, 
ex‹Á_node_t
, 
szad_lšk
,

41 
ex‹Á_szad_comp
)

43 
JEMALLOC_INLINE_C
 

44 
	$ex‹Á_ad_comp
(cÚ¡ 
ex‹Á_node_t
 *
a
, cÚ¡ƒx‹Á_node_ˆ*
b
)

46 
ušŒ_t
 
a_addr
 = (ušŒ_t)
	`ex‹Á_node_addr_g‘
(
a
);

47 
ušŒ_t
 
b_addr
 = (ušŒ_t)
	`ex‹Á_node_addr_g‘
(
b
);

49  ((
a_addr
 > 
b_addr
) - (a_addr < b_addr));

50 
	}
}

53 
rb_g’
(, 
ex‹Á_Œ“_ad_
, 
ex‹Á_Œ“_t
, 
ex‹Á_node_t
, 
ad_lšk
, 
ex‹Á_ad_comp
)

	@dep/jemalloc-4.2.0/src/hash.c

1 
	#JEMALLOC_HASH_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

	@dep/jemalloc-4.2.0/src/huge.c

1 
	#JEMALLOC_HUGE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

6 
ex‹Á_node_t
 *

7 
	$huge_node_g‘
(cÚ¡ *
±r
)

9 
ex‹Á_node_t
 *
node
;

11 
node
 = 
	`chunk_lookup
(
±r
, 
Œue
);

12 
	`as£¹
(!
	`ex‹Á_node_achunk_g‘
(
node
));

14  (
node
);

15 
	}
}

17 
boŞ


18 
	$huge_node_£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
ex‹Á_node_t
 *
node
)

21 
	`as£¹
(
	`ex‹Á_node_addr_g‘
(
node
è=ğ
±r
);

22 
	`as£¹
(!
	`ex‹Á_node_achunk_g‘
(
node
));

23  (
	`chunk_»gi¡”
(
tsdn
, 
±r
, 
node
));

24 
	}
}

27 
	$huge_node_»£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
ex‹Á_node_t
 *
node
)

29 
boŞ
 
”r
;

31 
”r
 = 
	`huge_node_£t
(
tsdn
, 
±r
, 
node
);

32 
	`as£¹
(!
”r
);

33 
	}
}

36 
	$huge_node_un£t
(cÚ¡ *
±r
, cÚ¡ 
ex‹Á_node_t
 *
node
)

39 
	`chunk_d”egi¡”
(
±r
, 
node
);

40 
	}
}

43 
	$huge_m®loc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
, 
boŞ
 
z”o
)

46 
	`as£¹
(
usize
 =ğ
	`s2u
(usize));

48  (
	`huge_·Îoc
(
tsdn
, 
¬’a
, 
usize
, 
chunksize
, 
z”o
));

49 
	}
}

52 
	$huge_·Îoc
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
, size_ˆ
®ignm’t
,

53 
boŞ
 
z”o
)

55 *
»t
;

56 
size_t
 
ausize
;

57 
ex‹Á_node_t
 *
node
;

58 
boŞ
 
is_z”Ûd
;

62 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
è|| 
¬’a
 !ğ
NULL
);

64 
ausize
 = 
	`§2u
(
usize
, 
®ignm’t
);

65 ià(
	`uÆik–y
(
ausize
 =ğ0 ||‡usiz> 
HUGE_MAXCLASS
))

66  (
NULL
);

67 
	`as£¹
(
ausize
 >ğ
chunksize
);

70 
node
 = 
	`®locztm
(
tsdn
, 
	`CACHELINE_CEILING
((
ex‹Á_node_t
)),

71 
CACHELINE
, 
çl£
, 
NULL
, 
Œue
, 
	`¬’a_ichoo£
(
tsdn
, 
¬’a
));

72 ià(
node
 =ğ
NULL
)

73  (
NULL
);

79 
is_z”Ûd
 = 
z”o
;

80 ià(
	`lik–y
(!
	`tsdn_nuÎ
(
tsdn
)))

81 
¬’a
 = 
	`¬’a_choo£
(
	`tsdn_tsd
(
tsdn
),‡rena);

82 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
è|| (
»t
 = 
	`¬’a_chunk_®loc_huge
(
tsdn
,

83 
¬’a
, 
usize
, 
®ignm’t
, &
is_z”Ûd
)è=ğ
NULL
) {

84 
	`id®loùm
(
tsdn
, 
node
, 
NULL
, 
Œue
,rue);

85  (
NULL
);

88 
	`ex‹Á_node_š™
(
node
, 
¬’a
, 
»t
, 
usize
, 
is_z”Ûd
, 
Œue
);

90 ià(
	`huge_node_£t
(
tsdn
, 
»t
, 
node
)) {

91 
	`¬’a_chunk_d®loc_huge
(
tsdn
, 
¬’a
, 
»t
, 
usize
);

92 
	`id®loùm
(
tsdn
, 
node
, 
NULL
, 
Œue
,rue);

93  (
NULL
);

97 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
huge_mtx
);

98 
	`ql_–m_Ãw
(
node
, 
ql_lšk
);

99 
	`ql__š£¹
(&
¬’a
->
huge
, 
node
, 
ql_lšk
);

100 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
huge_mtx
);

102 ià(
z”o
 || (
cÚfig_fl
 && 
	`uÆik–y
(
İt_z”o
))) {

103 ià(!
is_z”Ûd
)

104 
	`mem£t
(
»t
, 0, 
usize
);

105 } ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
))

106 
	`mem£t
(
»t
, 
JEMALLOC_ALLOC_JUNK
, 
usize
);

108 
	`¬’a_deÿy_tick
(
tsdn
, 
¬’a
);

109  (
»t
);

110 
	}
}

112 #ifdeà
JEMALLOC_JET


113 #undeà
huge_d®loc_junk


114 
	#huge_d®loc_junk
 
	`JEMALLOC_N
(
huge_d®loc_junk_im¶
)

	)

117 
	$huge_d®loc_junk
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
usize
)

120 ià(
cÚfig_fl
 && 
have_dss
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

125 ià(!
cÚfig_munm­
 || (
have_dss
 && 
	`chunk_š_dss
(
tsdn
, 
±r
)))

126 
	`mem£t
(
±r
, 
JEMALLOC_FREE_JUNK
, 
usize
);

128 
	}
}

129 #ifdeà
JEMALLOC_JET


130 #undeà
huge_d®loc_junk


131 
	#huge_d®loc_junk
 
	`JEMALLOC_N
(
huge_d®loc_junk
)

	)

132 
huge_d®loc_junk_t
 *
	ghuge_d®loc_junk
 = 
JEMALLOC_N
(
huge_d®loc_junk_im¶
);

136 
	$huge_¿Îoc_no_move_sim¬
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
,

137 
size_t
 
usize_mš
, size_ˆ
usize_max
, 
boŞ
 
z”o
)

139 
size_t
 
usize
, 
usize_Ãxt
;

140 
ex‹Á_node_t
 *
node
;

141 
¬’a_t
 *
¬’a
;

142 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

143 
boŞ
 
´e_z”Ûd
, 
po¡_z”Ûd
;

146 
usize
 = 
usize_mš
; usiz< 
usize_max
 && (
usize_Ãxt
 = 
	`s2u
(usize+1))

147 <ğ
Şdsize
; 
usize
 = 
usize_Ãxt
)

150 ià(
Şdsize
 =ğ
usize
)

153 
node
 = 
	`huge_node_g‘
(
±r
);

154 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

155 
´e_z”Ûd
 = 
	`ex‹Á_node_z”Ûd_g‘
(
node
);

158 ià(
Şdsize
 > 
usize
) {

159 
size_t
 
sdiff
 = 
Şdsize
 - 
usize
;

160 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

161 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
usize
),

162 
JEMALLOC_FREE_JUNK
, 
sdiff
);

163 
po¡_z”Ûd
 = 
çl£
;

165 
po¡_z”Ûd
 = !
	`chunk_purge_w¿µ”
(
tsdn
, 
¬’a
,

166 &
chunk_hooks
, 
±r
, 
	`CHUNK_CEILING
(
Şdsize
), 
usize
,

167 
sdiff
);

170 
po¡_z”Ûd
 = 
´e_z”Ûd
;

172 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
huge_mtx
);

174 
	`huge_node_un£t
(
±r
, 
node
);

175 
	`as£¹
(
	`ex‹Á_node_size_g‘
(
node
è!ğ
usize
);

176 
	`ex‹Á_node_size_£t
(
node
, 
usize
);

177 
	`huge_node_»£t
(
tsdn
, 
±r
, 
node
);

179 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
po¡_z”Ûd
);

180 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
huge_mtx
);

182 
	`¬’a_chunk_¿Îoc_huge_sim¬
(
tsdn
, 
¬’a
, 
±r
, 
Şdsize
, 
usize
);

185 ià(
Şdsize
 < 
usize
) {

186 ià(
z”o
 || (
cÚfig_fl
 && 
	`uÆik–y
(
İt_z”o
))) {

187 ià(!
´e_z”Ûd
) {

188 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0,

189 
usize
 - 
Şdsize
);

191 } ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

192 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
),

193 
JEMALLOC_ALLOC_JUNK
, 
usize
 - 
Şdsize
);

196 
	}
}

198 
boŞ


199 
	$huge_¿Îoc_no_move_shršk
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
,

200 
size_t
 
usize
)

202 
ex‹Á_node_t
 *
node
;

203 
¬’a_t
 *
¬’a
;

204 
chunk_hooks_t
 
chunk_hooks
;

205 
size_t
 
cdiff
;

206 
boŞ
 
´e_z”Ûd
, 
po¡_z”Ûd
;

208 
node
 = 
	`huge_node_g‘
(
±r
);

209 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

210 
´e_z”Ûd
 = 
	`ex‹Á_node_z”Ûd_g‘
(
node
);

211 
chunk_hooks
 = 
	`chunk_hooks_g‘
(
tsdn
, 
¬’a
);

213 
	`as£¹
(
Şdsize
 > 
usize
);

216 
cdiff
 = 
	`CHUNK_CEILING
(
Şdsize
è- CHUNK_CEILING(
usize
);

217 ià(
cdiff
 !ğ0 && 
chunk_hooks
.
	`¥l™
(
±r
, 
	`CHUNK_CEILING
(
Şdsize
),

218 
	`CHUNK_CEILING
(
usize
), 
cdiff
, 
Œue
, 
¬’a
->
šd
))

219  (
Œue
);

221 ià(
Şdsize
 > 
usize
) {

222 
size_t
 
sdiff
 = 
Şdsize
 - 
usize
;

223 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

224 
	`huge_d®loc_junk
(
tsdn
, (*)((
ušŒ_t
)
±r
 + 
usize
),

225 
sdiff
);

226 
po¡_z”Ûd
 = 
çl£
;

228 
po¡_z”Ûd
 = !
	`chunk_purge_w¿µ”
(
tsdn
, 
¬’a
,

229 &
chunk_hooks
, 
	`CHUNK_ADDR2BASE
((
ušŒ_t
)
±r
 +

230 
usize
), 
	`CHUNK_CEILING
(
Şdsize
),

231 
	`CHUNK_ADDR2OFFSET
((
ušŒ_t
)
±r
 + 
usize
), 
sdiff
);

234 
po¡_z”Ûd
 = 
´e_z”Ûd
;

236 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
huge_mtx
);

238 
	`huge_node_un£t
(
±r
, 
node
);

239 
	`ex‹Á_node_size_£t
(
node
, 
usize
);

240 
	`huge_node_»£t
(
tsdn
, 
±r
, 
node
);

242 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
po¡_z”Ûd
);

243 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
huge_mtx
);

246 
	`¬’a_chunk_¿Îoc_huge_shršk
(
tsdn
, 
¬’a
, 
±r
, 
Şdsize
, 
usize
);

248  (
çl£
);

249 
	}
}

251 
boŞ


252 
	$huge_¿Îoc_no_move_ex·nd
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
,

253 
size_t
 
usize
, 
boŞ
 
z”o
) {

254 
ex‹Á_node_t
 *
node
;

255 
¬’a_t
 *
¬’a
;

256 
boŞ
 
is_z”Ûd_subchunk
, 
is_z”Ûd_chunk
;

258 
node
 = 
	`huge_node_g‘
(
±r
);

259 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

260 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
huge_mtx
);

261 
is_z”Ûd_subchunk
 = 
	`ex‹Á_node_z”Ûd_g‘
(
node
);

262 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
huge_mtx
);

268 
is_z”Ûd_chunk
 = 
z”o
;

270 ià(
	`¬’a_chunk_¿Îoc_huge_ex·nd
(
tsdn
, 
¬’a
, 
±r
, 
Şdsize
, 
usize
,

271 &
is_z”Ûd_chunk
))

272  (
Œue
);

274 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
huge_mtx
);

276 
	`huge_node_un£t
(
±r
, 
node
);

277 
	`ex‹Á_node_size_£t
(
node
, 
usize
);

278 
	`huge_node_»£t
(
tsdn
, 
±r
, 
node
);

279 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
huge_mtx
);

281 ià(
z”o
 || (
cÚfig_fl
 && 
	`uÆik–y
(
İt_z”o
))) {

282 ià(!
is_z”Ûd_subchunk
) {

283 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0,

284 
	`CHUNK_CEILING
(
Şdsize
) - oldsize);

286 ià(!
is_z”Ûd_chunk
) {

287 
	`mem£t
((*)((
ušŒ_t
)
±r
 +

288 
	`CHUNK_CEILING
(
Şdsize
)), 0, 
usize
 -

289 
	`CHUNK_CEILING
(
Şdsize
));

291 } ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

292 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 
JEMALLOC_ALLOC_JUNK
,

293 
usize
 - 
Şdsize
);

296  (
çl£
);

297 
	}
}

299 
boŞ


300 
	$huge_¿Îoc_no_move
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
usize_mš
,

301 
size_t
 
usize_max
, 
boŞ
 
z”o
)

304 
	`as£¹
(
	`s2u
(
Şdsize
) == oldsize);

306 
	`as£¹
(
usize_mš
 > 0 && 
usize_max
 <ğ
HUGE_MAXCLASS
);

309 ià(
Şdsize
 < 
chunksize
 || 
usize_max
 < chunksize)

310  (
Œue
);

312 ià(
	`CHUNK_CEILING
(
usize_max
è> CHUNK_CEILING(
Şdsize
)) {

314 ià(!
	`huge_¿Îoc_no_move_ex·nd
(
tsdn
, 
±r
, 
Şdsize
, 
usize_max
,

315 
z”o
)) {

316 
	`¬’a_deÿy_tick
(
tsdn
, 
	`huge_¯Îoc
(
±r
));

317  (
çl£
);

320 ià(
usize_mš
 < 
usize_max
 && 
	`CHUNK_CEILING
(usize_min) >

321 
	`CHUNK_CEILING
(
Şdsize
è&& 
	`huge_¿Îoc_no_move_ex·nd
(
tsdn
,

322 
±r
, 
Şdsize
, 
usize_mš
, 
z”o
)) {

323 
	`¬’a_deÿy_tick
(
tsdn
, 
	`huge_¯Îoc
(
±r
));

324  (
çl£
);

332 ià(
	`CHUNK_CEILING
(
Şdsize
è>ğCHUNK_CEILING(
usize_mš
)

333 && 
	`CHUNK_CEILING
(
Şdsize
è<ğCHUNK_CEILING(
usize_max
)) {

334 
	`huge_¿Îoc_no_move_sim¬
(
tsdn
, 
±r
, 
Şdsize
, 
usize_mš
,

335 
usize_max
, 
z”o
);

336 
	`¬’a_deÿy_tick
(
tsdn
, 
	`huge_¯Îoc
(
±r
));

337  (
çl£
);

341 ià(
	`CHUNK_CEILING
(
Şdsize
è> CHUNK_CEILING(
usize_max
)) {

342 ià(!
	`huge_¿Îoc_no_move_shršk
(
tsdn
, 
±r
, 
Şdsize
,

343 
usize_max
)) {

344 
	`¬’a_deÿy_tick
(
tsdn
, 
	`huge_¯Îoc
(
±r
));

345  (
çl£
);

348  (
Œue
);

349 
	}
}

352 
	$huge_¿Îoc_move_h–³r
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
,

353 
size_t
 
®ignm’t
, 
boŞ
 
z”o
)

356 ià(
®ignm’t
 <ğ
chunksize
)

357  (
	`huge_m®loc
(
tsdn
, 
¬’a
, 
usize
, 
z”o
));

358  (
	`huge_·Îoc
(
tsdn
, 
¬’a
, 
usize
, 
®ignm’t
, 
z”o
));

359 
	}
}

362 
	$huge_¿Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, *
±r
, 
size_t
 
Şdsize
,

363 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

365 *
»t
;

366 
size_t
 
cİysize
;

369 
	`as£¹
(
usize
 > 0 && usiz<ğ
HUGE_MAXCLASS
);

372 ià(!
	`huge_¿Îoc_no_move
(
	`tsd_tsdn
(
tsd
), 
±r
, 
Şdsize
, 
usize
, usize,

373 
z”o
))

374  (
±r
);

381 
»t
 = 
	`huge_¿Îoc_move_h–³r
(
	`tsd_tsdn
(
tsd
), 
¬’a
, 
usize
, 
®ignm’t
,

382 
z”o
);

383 ià(
»t
 =ğ
NULL
)

384  (
NULL
);

386 
cİysize
 = (
usize
 < 
Şdsize
) ? usize : oldsize;

387 
	`memıy
(
»t
, 
±r
, 
cİysize
);

388 
	`isq®loc
(
tsd
, 
±r
, 
Şdsize
, 
tÿche
, 
Œue
);

389  (
»t
);

390 
	}
}

393 
	$huge_d®loc
(
tsdn_t
 *
tsdn
, *
±r
)

395 
ex‹Á_node_t
 *
node
;

396 
¬’a_t
 *
¬’a
;

398 
node
 = 
	`huge_node_g‘
(
±r
);

399 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

400 
	`huge_node_un£t
(
±r
, 
node
);

401 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
huge_mtx
);

402 
	`ql_»move
(&
¬’a
->
huge
, 
node
, 
ql_lšk
);

403 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
huge_mtx
);

405 
	`huge_d®loc_junk
(
tsdn
, 
	`ex‹Á_node_addr_g‘
(
node
),

406 
	`ex‹Á_node_size_g‘
(
node
));

407 
	`¬’a_chunk_d®loc_huge
(
tsdn
, 
	`ex‹Á_node_¬’a_g‘
(
node
),

408 
	`ex‹Á_node_addr_g‘
(
node
), 
	`ex‹Á_node_size_g‘
(node));

409 
	`id®loùm
(
tsdn
, 
node
, 
NULL
, 
Œue
,rue);

411 
	`¬’a_deÿy_tick
(
tsdn
, 
¬’a
);

412 
	}
}

414 
¬’a_t
 *

415 
	$huge_¯Îoc
(cÚ¡ *
±r
)

418  (
	`ex‹Á_node_¬’a_g‘
(
	`huge_node_g‘
(
±r
)));

419 
	}
}

421 
size_t


422 
	$huge_§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
)

424 
size_t
 
size
;

425 
ex‹Á_node_t
 *
node
;

426 
¬’a_t
 *
¬’a
;

428 
node
 = 
	`huge_node_g‘
(
±r
);

429 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

430 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
huge_mtx
);

431 
size
 = 
	`ex‹Á_node_size_g‘
(
node
);

432 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
huge_mtx
);

434  (
size
);

435 
	}
}

437 
´of_tùx_t
 *

438 
	$huge_´of_tùx_g‘
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
)

440 
´of_tùx_t
 *
tùx
;

441 
ex‹Á_node_t
 *
node
;

442 
¬’a_t
 *
¬’a
;

444 
node
 = 
	`huge_node_g‘
(
±r
);

445 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

446 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
huge_mtx
);

447 
tùx
 = 
	`ex‹Á_node_´of_tùx_g‘
(
node
);

448 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
huge_mtx
);

450  (
tùx
);

451 
	}
}

454 
	$huge_´of_tùx_£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
´of_tùx_t
 *
tùx
)

456 
ex‹Á_node_t
 *
node
;

457 
¬’a_t
 *
¬’a
;

459 
node
 = 
	`huge_node_g‘
(
±r
);

460 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

461 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
huge_mtx
);

462 
	`ex‹Á_node_´of_tùx_£t
(
node
, 
tùx
);

463 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
huge_mtx
);

464 
	}
}

467 
	$huge_´of_tùx_»£t
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
)

470 
	`huge_´of_tùx_£t
(
tsdn
, 
±r
, (
´of_tùx_t
 *)(
ušŒ_t
)1U);

471 
	}
}

	@dep/jemalloc-4.2.0/src/jemalloc.c

1 
	#JEMALLOC_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

8 cÚ¡ *
je_m®loc_cÚf
 
JEMALLOC_ATTR
(
w—k
);

9 
boŞ
 
	gİt_abÜt
 =

10 #ifdeà
JEMALLOC_DEBUG


11 
Œue


13 
çl£


16 cÚ¡ *
	gİt_junk
 =

17 #ià(
defšed
(
JEMALLOC_DEBUG
è&& defšed(
JEMALLOC_FILL
))

23 
boŞ
 
	gİt_junk_®loc
 =

24 #ià(
defšed
(
JEMALLOC_DEBUG
è&& defšed(
JEMALLOC_FILL
))

25 
Œue


27 
çl£


30 
boŞ
 
	gİt_junk_ä“
 =

31 #ià(
defšed
(
JEMALLOC_DEBUG
è&& defšed(
JEMALLOC_FILL
))

32 
Œue


34 
çl£


38 
size_t
 
	gİt_qu¬ªtše
 = 
ZU
(0);

39 
boŞ
 
	gİt_»dzÚe
 = 
çl£
;

40 
boŞ
 
	gİt_uŒaû
 = 
çl£
;

41 
boŞ
 
	gİt_xm®loc
 = 
çl£
;

42 
boŞ
 
	gİt_z”o
 = 
çl£
;

43 
	gİt_Ç»Çs
 = 0;

46 
boŞ
 
	gš_v®gršd
;

48 
	gnıus
;

51 
m®loc_mu‹x_t
 
	g¬’as_lock
;

60 
¬’a_t
 **
	g¬’as
;

61 
	gÇ»Çs_tÙ®
;

62 
¬’a_t
 *
	ga0
;

63 
	gÇ»Çs_auto
;

66 
	mm®loc_š™_unš™Ÿlized
 = 3,

67 
	mm®loc_š™_a0_š™Ÿlized
 = 2,

68 
	mm®loc_š™_»cursibË
 = 1,

69 
	mm®loc_š™_š™Ÿlized
 = 0

70 } 
	tm®loc_š™_t
;

71 
m®loc_š™_t
 
	gm®loc_š™_¡©e
 = 
m®loc_š™_unš™Ÿlized
;

74 
boŞ
 
	gm®loc_¦ow
 = 
Œue
;

78 
	mæag_İt_junk_®loc
 = (1U),

79 
	mæag_İt_junk_ä“
 = (1U << 1),

80 
	mæag_İt_qu¬ªtše
 = (1U << 2),

81 
	mæag_İt_z”o
 = (1U << 3),

82 
	mæag_İt_uŒaû
 = (1U << 4),

83 
	mæag_š_v®gršd
 = (1U << 5),

84 
	mæag_İt_xm®loc
 = (1U << 6)

86 
ušt8_t
 
	gm®loc_¦ow_æags
;

89 
	$JEMALLOC_ALIGNED
(
CACHELINE
)

90 cÚ¡ 
size_t
 
šdex2size_b
[
NSIZES
+1] = {

91 
	#SC
(
šdex
, 
lg_g½
, 
lg_d–
, 
nd–
, 
bš
, 
lg_d–_lookup
) \

92 ((
	`ZU
(1)<<
lg_g½
è+ (ZU(
nd–
)<<
lg_d–
)),

	)

93 
SIZE_CLASSES


94 #undeà
SC


95 
	`ZU
(0)

96 
	}
};

98 
	$JEMALLOC_ALIGNED
(
CACHELINE
)

99 cÚ¡ 
ušt8_t
 
size2šdex_b
[] = {

100 #ià
LG_TINY_MIN
 == 0

102 
	#S2B_0
(
i
èi,

	)

103 #–ià
LG_TINY_MIN
 == 1

105 
	#S2B_1
(
i
èi,

	)

106 #–ià
LG_TINY_MIN
 == 2

108 
	#S2B_2
(
i
èi,

	)

109 #–ià
LG_TINY_MIN
 == 3

110 
	#S2B_3
(
i
èi,

	)

111 #–ià
LG_TINY_MIN
 == 4

112 
	#S2B_4
(
i
èi,

	)

113 #–ià
LG_TINY_MIN
 == 5

114 
	#S2B_5
(
i
èi,

	)

115 #–ià
LG_TINY_MIN
 == 6

116 
	#S2B_6
(
i
èi,

	)

117 #–ià
LG_TINY_MIN
 == 7

118 
	#S2B_7
(
i
èi,

	)

119 #–ià
LG_TINY_MIN
 == 8

120 
	#S2B_8
(
i
èi,

	)

121 #–ià
LG_TINY_MIN
 == 9

122 
	#S2B_9
(
i
èi,

	)

123 #–ià
LG_TINY_MIN
 == 10

124 
	#S2B_10
(
i
èi,

	)

125 #–ià
LG_TINY_MIN
 == 11

126 
	#S2B_11
(
i
èi,

	)

130 #ià
LG_TINY_MIN
 < 1

131 
	#S2B_1
(
i
è
	`S2B_0
(ièS2B_0(i)

	)

133 #ià
LG_TINY_MIN
 < 2

134 
	#S2B_2
(
i
è
	`S2B_1
(ièS2B_1(i)

	)

136 #ià
LG_TINY_MIN
 < 3

137 
	#S2B_3
(
i
è
	`S2B_2
(ièS2B_2(i)

	)

139 #ià
LG_TINY_MIN
 < 4

140 
	#S2B_4
(
i
è
	`S2B_3
(ièS2B_3(i)

	)

142 #ià
LG_TINY_MIN
 < 5

143 
	#S2B_5
(
i
è
	`S2B_4
(ièS2B_4(i)

	)

145 #ià
LG_TINY_MIN
 < 6

146 
	#S2B_6
(
i
è
	`S2B_5
(ièS2B_5(i)

	)

148 #ià
LG_TINY_MIN
 < 7

149 
	#S2B_7
(
i
è
	`S2B_6
(ièS2B_6(i)

	)

151 #ià
LG_TINY_MIN
 < 8

152 
	#S2B_8
(
i
è
	`S2B_7
(ièS2B_7(i)

	)

154 #ià
LG_TINY_MIN
 < 9

155 
	#S2B_9
(
i
è
	`S2B_8
(ièS2B_8(i)

	)

157 #ià
LG_TINY_MIN
 < 10

158 
	#S2B_10
(
i
è
	`S2B_9
(ièS2B_9(i)

	)

160 #ià
LG_TINY_MIN
 < 11

161 
	#S2B_11
(
i
è
	`S2B_10
(ièS2B_10(i)

	)

163 
	#S2B_no
(
i
)

	)

164 
	#SC
(
šdex
, 
lg_g½
, 
lg_d–
, 
nd–
, 
bš
, 
lg_d–_lookup
) \

165 
S2B_
##
	`lg_d–_lookup
(
šdex
)

	)

166 
SIZE_CLASSES


167 #undeà
S2B_3


168 #undeà
S2B_4


169 #undeà
S2B_5


170 #undeà
S2B_6


171 #undeà
S2B_7


172 #undeà
S2B_8


173 #undeà
S2B_9


174 #undeà
S2B_10


175 #undeà
S2B_11


176 #undeà
S2B_no


177 #undeà
SC


178 
	}
};

180 #ifdeà
JEMALLOC_THREADED_INIT


182 
	#NO_INITIALIZER
 (()0)

	)

183 
	#INITIALIZER
 
	`±h»ad_£lf
()

	)

184 
	#IS_INITIALIZER
 (
m®loc_š™Ÿliz”
 =ğ
	`±h»ad_£lf
())

	)

185 
±h»ad_t
 
	gm®loc_š™Ÿliz”
 = 
NO_INITIALIZER
;

187 
	#NO_INITIALIZER
 
çl£


	)

188 
	#INITIALIZER
 
Œue


	)

189 
	#IS_INITIALIZER
 
m®loc_š™Ÿliz”


	)

190 
boŞ
 
	gm®loc_š™Ÿliz”
 = 
NO_INITIALIZER
;

194 #ifdeà
_WIN32


195 #ià
_WIN32_WINNT
 >= 0x0600

196 
m®loc_mu‹x_t
 
	gš™_lock
 = 
SRWLOCK_INIT
;

198 
m®loc_mu‹x_t
 
	gš™_lock
;

199 
boŞ
 
	gš™_lock_š™Ÿlized
 = 
çl£
;

201 
	$JEMALLOC_ATTR
(
cÚ¡ruùÜ
)

202 
WINAPI


203 
	$_š™_š™_lock
()

214 ià(!
š™_lock_š™Ÿlized
)

215 
	`m®loc_mu‹x_š™
(&
š™_lock
, "š™", 
WITNESS_RANK_INIT
);

216 
š™_lock_š™Ÿlized
 = 
Œue
;

217 
	}
}

219 #ifdeà
_MSC_VER


220 #´agm¨
£ùiÚ
(".CRT$XCU", 
»ad
)

221 
JEMALLOC_SECTION
(".CRT$XCU"è
	$JEMALLOC_ATTR
(
u£d
)

222 cÚ¡ (
WINAPI
 *
š™_š™_lock
)(èğ
_š™_š™_lock
;

226 
m®loc_mu‹x_t
 
š™_lock
 = 
MALLOC_MUTEX_INITIALIZER
;

230 *
p
;

231 
size_t
 
s
;

232 *
r
;

233 } 
	tm®loc_uŒaû_t
;

235 #ifdeà
JEMALLOC_UTRACE


236 
	#UTRACE
(
a
, 
b
, 
c
) do { \

237 ià(
	`uÆik–y
(
İt_uŒaû
)) { \

238 
uŒaû_£¼no
 = 
”ºo
; \

239 
m®loc_uŒaû_t
 
ut
; \

240 
ut
.
p
 = (
a
); \

241 
ut
.
s
 = (
b
); \

242 
ut
.
r
 = (
c
); \

243 
	`uŒaû
(&
ut
, (ut)); \

244 
”ºo
 = 
uŒaû_£¼no
; \

246 
	}
} 0)

	)

248 
	#UTRACE
(
a
, 
b
, 
c
)

	)

257 
boŞ
 
m®loc_š™_h¬d_a0
();

258 
boŞ
 
m®loc_š™_h¬d
();

265 
JEMALLOC_ALWAYS_INLINE_C
 
boŞ


266 
	$m®loc_š™Ÿlized
()

269  (
m®loc_š™_¡©e
 =ğ
m®loc_š™_š™Ÿlized
);

270 
	}
}

272 
JEMALLOC_ALWAYS_INLINE_C
 

273 
	$m®loc_th»ad_š™
()

285 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_qu¬ªtše
))

286 
	`qu¬ªtše_®loc_hook
();

287 
	}
}

289 
JEMALLOC_ALWAYS_INLINE_C
 
boŞ


290 
	$m®loc_š™_a0
()

293 ià(
	`uÆik–y
(
m®loc_š™_¡©e
 =ğ
m®loc_š™_unš™Ÿlized
))

294  (
	`m®loc_š™_h¬d_a0
());

295  (
çl£
);

296 
	}
}

298 
JEMALLOC_ALWAYS_INLINE_C
 
boŞ


299 
	$m®loc_š™
()

302 ià(
	`uÆik–y
(!
	`m®loc_š™Ÿlized
()è&& 
	`m®loc_š™_h¬d
())

303  (
Œue
);

304 
	`m®loc_th»ad_š™
();

306  (
çl£
);

307 
	}
}

315 
	$a0ŸÎoc
(
size_t
 
size
, 
boŞ
 
z”o
, boŞ 
is_m‘ad©a
)

318 ià(
	`uÆik–y
(
	`m®loc_š™_a0
()))

319  (
NULL
);

321  (
	`ŸÎocztm
(
TSDN_NULL
, 
size
, 
	`size2šdex
(size), 
z”o
, 
NULL
,

322 
is_m‘ad©a
, 
	`¬’a_g‘
(
TSDN_NULL
, 0, 
Œue
),rue));

323 
	}
}

326 
	$a0id®loc
(*
±r
, 
boŞ
 
is_m‘ad©a
)

329 
	`id®loùm
(
TSDN_NULL
, 
±r
, 
çl£
, 
is_m‘ad©a
, 
Œue
);

330 
	}
}

333 
	$a0m®loc
(
size_t
 
size
)

336  (
	`a0ŸÎoc
(
size
, 
çl£
, 
Œue
));

337 
	}
}

340 
	$a0d®loc
(*
±r
)

343 
	`a0id®loc
(
±r
, 
Œue
);

344 
	}
}

353 
	$boÙ¡¿p_m®loc
(
size_t
 
size
)

356 ià(
	`uÆik–y
(
size
 == 0))

357 
size
 = 1;

359  (
	`a0ŸÎoc
(
size
, 
çl£
, false));

360 
	}
}

363 
	$boÙ¡¿p_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

365 
size_t
 
num_size
;

367 
num_size
 = 
num
 * 
size
;

368 ià(
	`uÆik–y
(
num_size
 == 0)) {

369 
	`as£¹
(
num
 =ğ0 || 
size
 == 0);

370 
num_size
 = 1;

373  (
	`a0ŸÎoc
(
num_size
, 
Œue
, 
çl£
));

374 
	}
}

377 
	$boÙ¡¿p_ä“
(*
±r
)

380 ià(
	`uÆik–y
(
±r
 =ğ
NULL
))

383 
	`a0id®loc
(
±r
, 
çl£
);

384 
	}
}

387 
	$¬’a_£t
(
šd
, 
¬’a_t
 *
¬’a
)

390 
	`©omic_wr™e_p
((**)&
¬’as
[
šd
], 
¬’a
);

391 
	}
}

394 
	$Ç»Çs_tÙ®_£t
(
Ç»Çs
)

397 
	`©omic_wr™e_u
(&
Ç»Çs_tÙ®
, 
Ç»Çs
);

398 
	}
}

401 
	$Ç»Çs_tÙ®_šc
()

404 
	`©omic_add_u
(&
Ç»Çs_tÙ®
, 1);

405 
	}
}

408 
	$Ç»Çs_tÙ®_g‘
()

411  (
	`©omic_»ad_u
(&
Ç»Çs_tÙ®
));

412 
	}
}

415 
¬’a_t
 *

416 
	$¬’a_š™_locked
(
tsdn_t
 *
tsdn
, 
šd
)

418 
¬’a_t
 *
¬’a
;

420 
	`as£¹
(
šd
 <ğ
	`Ç»Çs_tÙ®_g‘
());

421 ià(
šd
 > 
MALLOCX_ARENA_MAX
)

422  (
NULL
);

423 ià(
šd
 =ğ
	`Ç»Çs_tÙ®_g‘
())

424 
	`Ç»Çs_tÙ®_šc
();

430 
¬’a
 = 
	`¬’a_g‘
(
tsdn
, 
šd
, 
çl£
);

431 ià(
¬’a
 !ğ
NULL
) {

432 
	`as£¹
(
šd
 < 
Ç»Çs_auto
);

433  (
¬’a
);

437 
¬’a
 = 
	`¬’a_Ãw
(
tsdn
, 
šd
);

438 
	`¬’a_£t
(
šd
, 
¬’a
);

439  (
¬’a
);

440 
	}
}

442 
¬’a_t
 *

443 
	$¬’a_š™
(
tsdn_t
 *
tsdn
, 
šd
)

445 
¬’a_t
 *
¬’a
;

447 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’as_lock
);

448 
¬’a
 = 
	`¬’a_š™_locked
(
tsdn
, 
šd
);

449 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’as_lock
);

450  (
¬’a
);

451 
	}
}

454 
	$¬’a_bšd
(
tsd_t
 *
tsd
, 
šd
, 
boŞ
 
š‹º®
)

456 
¬’a_t
 *
¬’a
;

458 
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
šd
, 
çl£
);

459 
	`¬’a_Áh»ads_šc
(
¬’a
, 
š‹º®
);

461 ià(
	`tsd_nomš®
(
tsd
)) {

462 ià(
š‹º®
)

463 
	`tsd_Ÿ»Ç_£t
(
tsd
, 
¬’a
);

465 
	`tsd_¬’a_£t
(
tsd
, 
¬’a
);

467 
	}
}

470 
	$¬’a_mig¿‹
(
tsd_t
 *
tsd
, 
Şdšd
, 
Ãwšd
)

472 
¬’a_t
 *
Şd¬’a
, *
Ãw¬’a
;

474 
Şd¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
Şdšd
, 
çl£
);

475 
Ãw¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
Ãwšd
, 
çl£
);

476 
	`¬’a_Áh»ads_dec
(
Şd¬’a
, 
çl£
);

477 
	`¬’a_Áh»ads_šc
(
Ãw¬’a
, 
çl£
);

478 
	`tsd_¬’a_£t
(
tsd
, 
Ãw¬’a
);

479 
	}
}

482 
	$¬’a_unbšd
(
tsd_t
 *
tsd
, 
šd
, 
boŞ
 
š‹º®
)

484 
¬’a_t
 *
¬’a
;

486 
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
šd
, 
çl£
);

487 
	`¬’a_Áh»ads_dec
(
¬’a
, 
š‹º®
);

488 ià(
š‹º®
)

489 
	`tsd_Ÿ»Ç_£t
(
tsd
, 
NULL
);

491 
	`tsd_¬’a_£t
(
tsd
, 
NULL
);

492 
	}
}

494 
¬’a_td©a_t
 *

495 
	$¬’a_td©a_g‘_h¬d
(
tsd_t
 *
tsd
, 
šd
)

497 
¬’a_td©a_t
 *
td©a
, *
¬’as_td©a_Şd
;

498 
¬’a_td©a_t
 *
¬’as_td©a
 = 
	`tsd_¬’as_td©a_g‘
(
tsd
);

499 
Ç»Çs_td©a_Şd
, 
i
;

500 
Ç»Çs_td©a
 = 
	`tsd_Ç»Çs_td©a_g‘
(
tsd
);

501 
Ç»Çs_aùu®
 = 
	`Ç»Çs_tÙ®_g‘
();

507 ià(
¬’as_td©a
 !ğ
NULL
 && 
Ç»Çs_td©a
 < 
Ç»Çs_aùu®
) {

508 
¬’as_td©a_Şd
 = 
¬’as_td©a
;

509 
Ç»Çs_td©a_Şd
 = 
Ç»Çs_td©a
;

510 
¬’as_td©a
 = 
NULL
;

511 
Ç»Çs_td©a
 = 0;

512 
	`tsd_¬’as_td©a_£t
(
tsd
, 
¬’as_td©a
);

513 
	`tsd_Ç»Çs_td©a_£t
(
tsd
, 
Ç»Çs_td©a
);

515 
¬’as_td©a_Şd
 = 
NULL
;

516 
Ç»Çs_td©a_Şd
 = 0;

520 ià(
¬’as_td©a
 =ğ
NULL
) {

521 
boŞ
 *
¬’as_td©a_by·s¥
 = 
	`tsd_¬’as_td©a_by·s¥_g‘
(
tsd
);

522 
Ç»Çs_td©a
 = (
šd
 < 
Ç»Çs_aùu®
) ?‚arenas_actual : ind+1;

524 ià(
	`tsd_nomš®
(
tsd
è&& !*
¬’as_td©a_by·s¥
) {

525 *
¬’as_td©a_by·s¥
 = 
Œue
;

526 
¬’as_td©a
 = (
¬’a_td©a_t
 *)
	`a0m®loc
(

527 (
¬’a_td©a_t
è* 
Ç»Çs_td©a
);

528 *
¬’as_td©a_by·s¥
 = 
çl£
;

530 ià(
¬’as_td©a
 =ğ
NULL
) {

531 
td©a
 = 
NULL
;

532 
Ïb–_»tuº
;

534 
	`as£¹
(
	`tsd_nomš®
(
tsd
è&& !*
¬’as_td©a_by·s¥
);

535 
	`tsd_¬’as_td©a_£t
(
tsd
, 
¬’as_td©a
);

536 
	`tsd_Ç»Çs_td©a_£t
(
tsd
, 
Ç»Çs_td©a
);

548 
i
 = 0; i < 
Ç»Çs_aùu®
; i++) {

549 ià(
i
 < 
Ç»Çs_td©a_Şd
) {

550 
	`tick”_cİy
(&
¬’as_td©a
[
i
].
deÿy_tick”
,

551 &
¬’as_td©a_Şd
[
i
].
deÿy_tick”
);

553 
	`tick”_š™
(&
¬’as_td©a
[
i
].
deÿy_tick”
,

554 
DECAY_NTICKS_PER_UPDATE
);

557 ià(
Ç»Çs_td©a
 > 
Ç»Çs_aùu®
) {

558 
	`mem£t
(&
¬’as_td©a
[
Ç»Çs_aùu®
], 0, (
¬’a_td©a_t
)

559 * (
Ç»Çs_td©a
 - 
Ç»Çs_aùu®
));

563 
td©a
 = &
¬’as_td©a
[
šd
];

564 
Ïb–_»tuº
:

565 ià(
¬’as_td©a_Şd
 !ğ
NULL
)

566 
	`a0d®loc
(
¬’as_td©a_Şd
);

567  (
td©a
);

568 
	}
}

571 
¬’a_t
 *

572 
	$¬’a_choo£_h¬d
(
tsd_t
 *
tsd
, 
boŞ
 
š‹º®
)

574 
¬’a_t
 *
»t
 
	`JEMALLOC_CC_SILENCE_INIT
(
NULL
);

576 ià(
Ç»Çs_auto
 > 1) {

577 
i
, 
j
, 
choo£
[2], 
fœ¡_nuÎ
;

587 
j
 = 0; j < 2; j++)

588 
choo£
[
j
] = 0;

590 
fœ¡_nuÎ
 = 
Ç»Çs_auto
;

591 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
¬’as_lock
);

592 
	`as£¹
(
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 0, 
çl£
è!ğ
NULL
);

593 
i
 = 1; i < 
Ç»Çs_auto
; i++) {

594 ià(
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
i
, 
çl£
è!ğ
NULL
) {

599 
j
 = 0; j < 2; j++) {

600 ià(
	`¬’a_Áh»ads_g‘
(
	`¬’a_g‘
(

601 
	`tsd_tsdn
(
tsd
), 
i
, 
çl£
), !!
j
) <

602 
	`¬’a_Áh»ads_g‘
(
	`¬’a_g‘
(

603 
	`tsd_tsdn
(
tsd
), 
choo£
[
j
], 
çl£
),

604 !!
j
))

605 
choo£
[
j
] = 
i
;

607 } ià(
fœ¡_nuÎ
 =ğ
Ç»Çs_auto
) {

617 
fœ¡_nuÎ
 = 
i
;

621 
j
 = 0; j < 2; j++) {

622 ià(
	`¬’a_Áh»ads_g‘
(
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
),

623 
choo£
[
j
], 
çl£
), !!jè=ğ0 || 
fœ¡_nuÎ
 ==

624 
Ç»Çs_auto
) {

629 ià(!!
j
 =ğ
š‹º®
) {

630 
»t
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
),

631 
choo£
[
j
], 
çl£
);

634 
¬’a_t
 *
¬’a
;

637 
choo£
[
j
] = 
fœ¡_nuÎ
;

638 
¬’a
 = 
	`¬’a_š™_locked
(
	`tsd_tsdn
(
tsd
),

639 
choo£
[
j
]);

640 ià(
¬’a
 =ğ
NULL
) {

641 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
),

642 &
¬’as_lock
);

643  (
NULL
);

645 ià(!!
j
 =ğ
š‹º®
)

646 
»t
 = 
¬’a
;

648 
	`¬’a_bšd
(
tsd
, 
choo£
[
j
], !!j);

650 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
¬’as_lock
);

652 
»t
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 0, 
çl£
);

653 
	`¬’a_bšd
(
tsd
, 0, 
çl£
);

654 
	`¬’a_bšd
(
tsd
, 0, 
Œue
);

657  (
»t
);

658 
	}
}

661 
	$th»ad_®loÿ‹d_ş—nup
(
tsd_t
 *
tsd
)

665 
	}
}

668 
	$th»ad_d—Îoÿ‹d_ş—nup
(
tsd_t
 *
tsd
)

672 
	}
}

675 
	$Ÿ»Ç_ş—nup
(
tsd_t
 *
tsd
)

677 
¬’a_t
 *
Ÿ»Ç
;

679 
Ÿ»Ç
 = 
	`tsd_Ÿ»Ç_g‘
(
tsd
);

680 ià(
Ÿ»Ç
 !ğ
NULL
)

681 
	`¬’a_unbšd
(
tsd
, 
Ÿ»Ç
->
šd
, 
Œue
);

682 
	}
}

685 
	$¬’a_ş—nup
(
tsd_t
 *
tsd
)

687 
¬’a_t
 *
¬’a
;

689 
¬’a
 = 
	`tsd_¬’a_g‘
(
tsd
);

690 ià(
¬’a
 !ğ
NULL
)

691 
	`¬’a_unbšd
(
tsd
, 
¬’a
->
šd
, 
çl£
);

692 
	}
}

695 
	$¬’as_td©a_ş—nup
(
tsd_t
 *
tsd
)

697 
¬’a_td©a_t
 *
¬’as_td©a
;

700 *
	`tsd_¬’as_td©a_by·s¥_g‘
(
tsd
èğ
Œue
;

702 
¬’as_td©a
 = 
	`tsd_¬’as_td©a_g‘
(
tsd
);

703 ià(
¬’as_td©a
 !ğ
NULL
) {

704 
	`tsd_¬’as_td©a_£t
(
tsd
, 
NULL
);

705 
	`a0d®loc
(
¬’as_td©a
);

707 
	}
}

710 
	$Ç»Çs_td©a_ş—nup
(
tsd_t
 *
tsd
)

714 
	}
}

717 
	$¬’as_td©a_by·ss_ş—nup
(
tsd_t
 *
tsd
)

721 
	}
}

724 
	$¡©s_´št_©ex™
()

727 ià(
cÚfig_tÿche
 && 
cÚfig_¡©s
) {

728 
tsdn_t
 *
tsdn
;

729 
Ç»Çs
, 
i
;

731 
tsdn
 = 
	`tsdn_ãtch
();

740 
i
 = 0, 
Ç»Çs
 = 
	`Ç»Çs_tÙ®_g‘
(); i <‚arenas; i++) {

741 
¬’a_t
 *
¬’a
 = 
	`¬’a_g‘
(
tsdn
, 
i
, 
çl£
);

742 ià(
¬’a
 !ğ
NULL
) {

743 
tÿche_t
 *
tÿche
;

751 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

752 
	`ql_fÜ—ch
(
tÿche
, &
¬’a
->
tÿche_ql
, 
lšk
) {

753 
	`tÿche_¡©s_m”ge
(
tsdn
, 
tÿche
, 
¬’a
);

755 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

759 
	`je_m®loc_¡©s_´št
(
NULL
, NULL, NULL);

760 
	}
}

770 #iâdeà
JEMALLOC_HAVE_SECURE_GETENV


772 
	$£cu»_g‘’v
(cÚ¡ *
Çme
)

775 #ifdeà
JEMALLOC_HAVE_ISSETUGID


776 ià(
	`is£tugid
() != 0)

777  (
NULL
);

779  (
	`g‘’v
(
Çme
));

780 
	}
}

784 
	$m®loc_nıus
()

786 
»suÉ
;

788 #ifdeà
_WIN32


789 
SYSTEM_INFO
 
si
;

790 
	`G‘Sy¡emInfo
(&
si
);

791 
»suÉ
 = 
si
.
dwNumb”OfProûssÜs
;

793 
»suÉ
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

795  ((
»suÉ
 == -1) ? 1 : ()result);

796 
	}
}

798 
boŞ


799 
	$m®loc_cÚf_Ãxt
(cÚ¡ **
İts_p
, cÚ¡ **
k_p
, 
size_t
 *
kËn_p
,

800 cÚ¡ **
v_p
, 
size_t
 *
vËn_p
)

802 
boŞ
 
acû±
;

803 cÚ¡ *
İts
 = *
İts_p
;

805 *
k_p
 = 
İts
;

807 
acû±
 = 
çl£
; !accept;) {

808 *
İts
) {

822 
İts
++;

825 
İts
++;

826 *
kËn_p
 = (
ušŒ_t
)
İts
 - 1 - (ušŒ_t)*
k_p
;

827 *
v_p
 = 
İts
;

828 
acû±
 = 
Œue
;

831 ià(
İts
 !ğ*
İts_p
) {

832 
	`m®loc_wr™e
("<jemalloc>: Conf stringƒnds "

835  (
Œue
);

837 
	`m®loc_wr™e
("<jemalloc>: Malformed conf string\n");

838  (
Œue
);

842 
acû±
 = 
çl£
; !accept;) {

843 *
İts
) {

845 
İts
++;

853 ià(*
İts
 == '\0') {

854 
	`m®loc_wr™e
("<jemalloc>: Conf stringƒnds "

857 *
vËn_p
 = (
ušŒ_t
)
İts
 - 1 - (ušŒ_t)*
v_p
;

858 
acû±
 = 
Œue
;

861 *
vËn_p
 = (
ušŒ_t
)
İts
 - (ušŒ_t)*
v_p
;

862 
acû±
 = 
Œue
;

865 
İts
++;

870 *
İts_p
 = 
İts
;

871  (
çl£
);

872 
	}
}

875 
	$m®loc_cÚf_”rÜ
(cÚ¡ *
msg
, cÚ¡ *
k
, 
size_t
 
kËn
, cÚ¡ *
v
,

876 
size_t
 
vËn
)

879 
	`m®loc_´štf
("<jem®loc>: %s: %.*s:%.*s\n", 
msg
, ()
kËn
, 
k
,

880 ()
vËn
, 
v
);

881 
	}
}

884 
	$m®loc_¦ow_æag_š™
()

890 
m®loc_¦ow_æags
 |ğ(
İt_junk_®loc
 ? 
æag_İt_junk_®loc
 : 0)

891 | (
İt_junk_ä“
 ? 
æag_İt_junk_ä“
 : 0)

892 | (
İt_qu¬ªtše
 ? 
æag_İt_qu¬ªtše
 : 0)

893 | (
İt_z”o
 ? 
æag_İt_z”o
 : 0)

894 | (
İt_uŒaû
 ? 
æag_İt_uŒaû
 : 0)

895 | (
İt_xm®loc
 ? 
æag_İt_xm®loc
 : 0);

897 ià(
cÚfig_v®gršd
)

898 
m®loc_¦ow_æags
 |ğ(
š_v®gršd
 ? 
æag_š_v®gršd
 : 0);

900 
m®loc_¦ow
 = (
m®loc_¦ow_æags
 != 0);

901 
	}
}

904 
	$m®loc_cÚf_š™
()

906 
i
;

907 
buf
[
PATH_MAX
 + 1];

908 cÚ¡ *
İts
, *
k
, *
v
;

909 
size_t
 
kËn
, 
vËn
;

915 ià(
cÚfig_v®gršd
) {

916 
š_v®gršd
 = (
RUNNING_ON_VALGRIND
 !ğ0è? 
Œue
 : 
çl£
;

917 ià(
cÚfig_fl
 && 
	`uÆik–y
(
š_v®gršd
)) {

918 
İt_junk
 = "false";

919 
İt_junk_®loc
 = 
çl£
;

920 
İt_junk_ä“
 = 
çl£
;

921 
	`as£¹
(!
İt_z”o
);

922 
İt_qu¬ªtše
 = 
JEMALLOC_VALGRIND_QUARANTINE_DEFAULT
;

923 
İt_»dzÚe
 = 
Œue
;

925 ià(
cÚfig_tÿche
 && 
	`uÆik–y
(
š_v®gršd
))

926 
İt_tÿche
 = 
çl£
;

929 
i
 = 0; i < 4; i++) {

931 
i
) {

933 
İts
 = 
cÚfig_m®loc_cÚf
;

936 ià(
je_m®loc_cÚf
 !ğ
NULL
) {

941 
İts
 = 
je_m®loc_cÚf
;

944 
buf
[0] = '\0';

945 
İts
 = 
buf
;

949 
ssize_t
 
lškËn
 = 0;

950 #iâdeà
_WIN32


951 
§ved_”ºo
 = 
”ºo
;

952 cÚ¡ *
lškÇme
 =

953 #ifdeà
JEMALLOC_PREFIX


954 "/‘c/"
JEMALLOC_PREFIX
"malloc.conf"

964 
lškËn
 = 
	`»adlšk
(
lškÇme
, 
buf
, (buf) - 1);

965 ià(
lškËn
 == -1) {

967 
lškËn
 = 0;

969 
	`£t_”ºo
(
§ved_”ºo
);

972 
buf
[
lškËn
] = '\0';

973 
İts
 = 
buf
;

976 cÚ¡ *
’vÇme
 =

977 #ifdeà
JEMALLOC_PREFIX


978 
JEMALLOC_CPREFIX
"MALLOC_CONF"

984 ià((
İts
 = 
	`£cu»_g‘’v
(
’vÇme
)è!ğ
NULL
) {

992 
buf
[0] = '\0';

993 
İts
 = 
buf
;

997 
	`nÙ_»ached
();

998 
buf
[0] = '\0';

999 
İts
 = 
buf
;

1002 *
İts
 !ğ'\0' && !
	`m®loc_cÚf_Ãxt
(&İts, &
k
, &
kËn
, &
v
,

1003 &
vËn
)) {

1004 
	#CONF_MATCH
(
n
) \

1005 ((
n
)-1 =ğ
kËn
 && 
	`¡ºcmp
Ò, 
k
, kËnè=ğ0)

	)

1006 
	#CONF_MATCH_VALUE
(
n
) \

1007 ((
n
)-1 =ğ
vËn
 && 
	`¡ºcmp
Ò, 
v
, vËnè=ğ0)

	)

1008 
	#CONF_HANDLE_BOOL
(
o
, 
n
, 
cÚt
) \

1009 ià(
	`CONF_MATCH
(
n
)) { \

1010 ià(
	`CONF_MATCH_VALUE
("true")) \

1011 
o
 = 
Œue
; \

1012 ià(
	`CONF_MATCH_VALUE
("false")) \

1013 
o
 = 
çl£
; \

1015 
	`m®loc_cÚf_”rÜ
( \

1017 
k
, 
kËn
, 
v
, 
vËn
); \

1019 ià(
cÚt
) \

1021 }

	)

1022 
	#CONF_HANDLE_T_U
(
t
, 
o
, 
n
, 
mš
, 
max
, 
ş
) \

1023 ià(
	`CONF_MATCH
(
n
)) { \

1024 
uštmax_t
 
um
; \

1025 *
’d
; \

1027 
	`£t_”ºo
(0); \

1028 
um
 = 
	`m®loc_¡¹oumax
(
v
, &
’d
, 0); \

1029 ià(
	`g‘_”ºo
(è!ğ0 || (
ušŒ_t
)
’d
 -\

1030 (
ušŒ_t
)
v
 !ğ
vËn
) { \

1031 
	`m®loc_cÚf_”rÜ
( \

1033 
k
, 
kËn
, 
v
, 
vËn
); \

1034 } ià(
ş
) { \

1035 ià((
mš
è!ğ0 && 
um
 < (min)) \

1036 
o
 = (
t
)(
mš
); \

1037 ià(
um
 > (
max
)) \

1038 
o
 = (
t
)(
max
); \

1040 
o
 = (
t
)
um
; \

1042 ià(((
mš
è!ğ0 && 
um
 < (min)) \

1043 || 
um
 > (
max
)) { \

1044 
	`m®loc_cÚf_”rÜ
( \

1047 
k
, 
kËn
, 
v
, 
vËn
); \

1049 
o
 = (
t
)
um
; \

1052 }

	)

1053 
	#CONF_HANDLE_UNSIGNED
(
o
, 
n
, 
mš
, 
max
, 
ş
) \

1054 
	`CONF_HANDLE_T_U
(, 
o
, 
n
, 
mš
, 
max
, 
ş
)

	)

1055 
	#CONF_HANDLE_SIZE_T
(
o
, 
n
, 
mš
, 
max
, 
ş
) \

1056 
	`CONF_HANDLE_T_U
(
size_t
, 
o
, 
n
, 
mš
, 
max
, 
ş
)

	)

1057 
	#CONF_HANDLE_SSIZE_T
(
o
, 
n
, 
mš
, 
max
) \

1058 ià(
	`CONF_MATCH
(
n
)) { \

1059 
l
; \

1060 *
’d
; \

1062 
	`£t_”ºo
(0); \

1063 
l
 = 
	`¡¹Ş
(
v
, &
’d
, 0); \

1064 ià(
	`g‘_”ºo
(è!ğ0 || (
ušŒ_t
)
’d
 -\

1065 (
ušŒ_t
)
v
 !ğ
vËn
) { \

1066 
	`m®loc_cÚf_”rÜ
( \

1068 
k
, 
kËn
, 
v
, 
vËn
); \

1069 } ià(
l
 < (
ssize_t
)(
mš
) ||† > \

1070 (
ssize_t
)(
max
)) { \

1071 
	`m®loc_cÚf_”rÜ
( \

1073 
k
, 
kËn
, 
v
, 
vËn
); \

1075 
o
 = 
l
; \

1077 }

	)

1078 
	#CONF_HANDLE_CHAR_P
(
o
, 
n
, 
d
) \

1079 ià(
	`CONF_MATCH
(
n
)) { \

1080 
size_t
 
ıyËn
 = (
vËn
 <= \

1081 (
o
)-1è? 
vËn
 : \

1082 (
o
)-1; \

1083 
	`¡ºıy
(
o
, 
v
, 
ıyËn
); \

1084 
o
[
ıyËn
] = '\0'; \

1086 }

	)

1088 
	`CONF_HANDLE_BOOL
(
İt_abÜt
, "abÜt", 
Œue
)

1097 
	`CONF_HANDLE_SIZE_T
(
İt_lg_chunk
, "lg_chunk", 
LG_PAGE
 +

1098 
LG_SIZE_CLASS_GROUP
 + (
cÚfig_fl
 ? 2 : 1),

1099 ((
size_t
è<< 3è- 1, 
Œue
)

1100 ià(
	`¡ºcmp
("dss", 
k
, 
kËn
) == 0) {

1101 
i
;

1102 
boŞ
 
m©ch
 = 
çl£
;

1103 
i
 = 0; i < 
dss_´ec_lim™
; i++) {

1104 ià(
	`¡ºcmp
(
dss_´ec_Çmes
[
i
], 
v
, 
vËn
)

1106 ià(
	`chunk_dss_´ec_£t
(
NULL
,

1107 
i
)) {

1108 
	`m®loc_cÚf_”rÜ
(

1110 
k
, 
kËn
, 
v
, 
vËn
);

1112 
İt_dss
 =

1113 
dss_´ec_Çmes
[
i
];

1114 
m©ch
 = 
Œue
;

1119 ià(!
m©ch
) {

1120 
	`m®loc_cÚf_”rÜ
("Invalid conf value",

1121 
k
, 
kËn
, 
v
, 
vËn
);

1125 
	`CONF_HANDLE_UNSIGNED
(
İt_Ç»Çs
, "narenas", 1,

1126 
UINT_MAX
, 
çl£
)

1127 ià(
	`¡ºcmp
("purge", 
k
, 
kËn
) == 0) {

1128 
i
;

1129 
boŞ
 
m©ch
 = 
çl£
;

1130 
i
 = 0; i < 
purge_mode_lim™
; i++) {

1131 ià(
	`¡ºcmp
(
purge_mode_Çmes
[
i
], 
v
,

1132 
vËn
) == 0) {

1133 
İt_purge
 = (
purge_mode_t
)
i
;

1134 
m©ch
 = 
Œue
;

1138 ià(!
m©ch
) {

1139 
	`m®loc_cÚf_”rÜ
("Invalid conf value",

1140 
k
, 
kËn
, 
v
, 
vËn
);

1144 
	`CONF_HANDLE_SSIZE_T
(
İt_lg_dœty_muÉ
, "lg_dirty_mult",

1145 -1, ((
size_t
) << 3) - 1)

1146 
	`CONF_HANDLE_SSIZE_T
(
İt_deÿy_time
, "decay_time", -1,

1147 
NSTIME_SEC_MAX
);

1148 
	`CONF_HANDLE_BOOL
(
İt_¡©s_´št
, "¡©s_´št", 
Œue
)

1149 ià(
cÚfig_fl
) {

1150 ià(
	`CONF_MATCH
("junk")) {

1151 ià(
	`CONF_MATCH_VALUE
("true")) {

1152 
İt_junk
 = "true";

1153 
İt_junk_®loc
 = 
İt_junk_ä“
 =

1154 
Œue
;

1155 } ià(
	`CONF_MATCH_VALUE
("false")) {

1156 
İt_junk
 = "false";

1157 
İt_junk_®loc
 = 
İt_junk_ä“
 =

1158 
çl£
;

1159 } ià(
	`CONF_MATCH_VALUE
("alloc")) {

1160 
İt_junk
 = "alloc";

1161 
İt_junk_®loc
 = 
Œue
;

1162 
İt_junk_ä“
 = 
çl£
;

1163 } ià(
	`CONF_MATCH_VALUE
("free")) {

1164 
İt_junk
 = "free";

1165 
İt_junk_®loc
 = 
çl£
;

1166 
İt_junk_ä“
 = 
Œue
;

1168 
	`m®loc_cÚf_”rÜ
(

1169 "Inv®id cÚàv®ue", 
k
,

1170 
kËn
, 
v
, 
vËn
);

1174 
	`CONF_HANDLE_SIZE_T
(
İt_qu¬ªtše
, "quarantine",

1175 0, 
SIZE_T_MAX
, 
çl£
)

1176 
	`CONF_HANDLE_BOOL
(
İt_»dzÚe
, "»dzÚe", 
Œue
)

1177 
	`CONF_HANDLE_BOOL
(
İt_z”o
, "z”o", 
Œue
)

1179 ià(
cÚfig_uŒaû
) {

1180 
	`CONF_HANDLE_BOOL
(
İt_uŒaû
, "uŒaû", 
Œue
)

1182 ià(
cÚfig_xm®loc
) {

1183 
	`CONF_HANDLE_BOOL
(
İt_xm®loc
, "xm®loc", 
Œue
)

1185 ià(
cÚfig_tÿche
) {

1186 
	`CONF_HANDLE_BOOL
(
İt_tÿche
, "tcache",

1187 !
cÚfig_v®gršd
 || !
š_v®gršd
)

1188 ià(
	`CONF_MATCH
("tcache")) {

1189 
	`as£¹
(
cÚfig_v®gršd
 && 
š_v®gršd
);

1190 ià(
İt_tÿche
) {

1191 
İt_tÿche
 = 
çl£
;

1192 
	`m®loc_cÚf_”rÜ
(

1195 
k
, 
kËn
, 
v
, 
vËn
);

1199 
	`CONF_HANDLE_SSIZE_T
(
İt_lg_tÿche_max
,

1201 ((
size_t
) << 3) - 1)

1203 ià(
cÚfig_´of
) {

1204 
	`CONF_HANDLE_BOOL
(
İt_´of
, "´of", 
Œue
)

1205 
	`CONF_HANDLE_CHAR_P
(
İt_´of_´efix
,

1207 
	`CONF_HANDLE_BOOL
(
İt_´of_aùive
, "prof_active",

1208 
Œue
)

1209 
	`CONF_HANDLE_BOOL
(
İt_´of_th»ad_aùive_š™
,

1210 "´of_th»ad_aùive_š™", 
Œue
)

1211 
	`CONF_HANDLE_SIZE_T
(
İt_lg_´of_§m¶e
,

1213 ((
ušt64_t
è<< 3è- 1, 
Œue
)

1214 
	`CONF_HANDLE_BOOL
(
İt_´of_accum
, "prof_accum",

1215 
Œue
)

1216 
	`CONF_HANDLE_SSIZE_T
(
İt_lg_´of_š‹rv®
,

1218 ((
ušt64_t
) << 3) - 1)

1219 
	`CONF_HANDLE_BOOL
(
İt_´of_gdump
, "prof_gdump",

1220 
Œue
)

1221 
	`CONF_HANDLE_BOOL
(
İt_´of_fš®
, "prof_final",

1222 
Œue
)

1223 
	`CONF_HANDLE_BOOL
(
İt_´of_Ëak
, "prof_leak",

1224 
Œue
)

1226 
	`m®loc_cÚf_”rÜ
("Inv®id cÚà·œ", 
k
, 
kËn
, 
v
,

1227 
vËn
);

1228 #undeà
CONF_MATCH


1229 #undeà
CONF_HANDLE_BOOL


1230 #undeà
CONF_HANDLE_SIZE_T


1231 #undeà
CONF_HANDLE_SSIZE_T


1232 #undeà
CONF_HANDLE_CHAR_P


1235 
	}
}

1237 
boŞ


1238 
	$m®loc_š™_h¬d_Ãeded
()

1241 ià(
	`m®loc_š™Ÿlized
(è|| (
IS_INITIALIZER
 && 
m®loc_š™_¡©e
 ==

1242 
m®loc_š™_»cursibË
)) {

1248  (
çl£
);

1250 #ifdeà
JEMALLOC_THREADED_INIT


1251 ià(
m®loc_š™Ÿliz”
 !ğ
NO_INITIALIZER
 && !
IS_INITIALIZER
) {

1254 
	`m®loc_mu‹x_uÆock
(
NULL
, &
š™_lock
);

1255 
CPU_SPINWAIT
;

1256 
	`m®loc_mu‹x_lock
(
NULL
, &
š™_lock
);

1257 } !
	`m®loc_š™Ÿlized
());

1258  (
çl£
);

1261  (
Œue
);

1262 
	}
}

1264 
boŞ


1265 
	$m®loc_š™_h¬d_a0_locked
()

1268 
m®loc_š™Ÿliz”
 = 
INITIALIZER
;

1270 ià(
cÚfig_´of
)

1271 
	`´of_boÙ0
();

1272 
	`m®loc_cÚf_š™
();

1273 ià(
İt_¡©s_´št
) {

1275 ià(
	`©ex™
(
¡©s_´št_©ex™
) != 0) {

1276 
	`m®loc_wr™e
("<jemalloc>: Error in‡texit()\n");

1277 ià(
İt_abÜt
)

1278 
	`abÜt
();

1281 
	`·ges_boÙ
();

1282 ià(
	`ba£_boÙ
())

1283  (
Œue
);

1284 ià(
	`chunk_boÙ
())

1285  (
Œue
);

1286 ià(
	`ùl_boÙ
())

1287  (
Œue
);

1288 ià(
cÚfig_´of
)

1289 
	`´of_boÙ1
();

1290 ià(
	`¬’a_boÙ
())

1291  (
Œue
);

1292 ià(
cÚfig_tÿche
 && 
	`tÿche_boÙ
(
TSDN_NULL
))

1293  (
Œue
);

1294 ià(
	`m®loc_mu‹x_š™
(&
¬’as_lock
, "¬’as", 
WITNESS_RANK_ARENAS
))

1295  (
Œue
);

1300 
Ç»Çs_auto
 = 1;

1301 
	`Ç»Çs_tÙ®_£t
(
Ç»Çs_auto
);

1302 
¬’as
 = &
a0
;

1303 
	`mem£t
(
¬’as
, 0, (
¬’a_t
 *è* 
Ç»Çs_auto
);

1308 ià(
	`¬’a_š™
(
TSDN_NULL
, 0è=ğ
NULL
)

1309  (
Œue
);

1311 
m®loc_š™_¡©e
 = 
m®loc_š™_a0_š™Ÿlized
;

1313  (
çl£
);

1314 
	}
}

1316 
boŞ


1317 
	$m®loc_š™_h¬d_a0
()

1319 
boŞ
 
»t
;

1321 
	`m®loc_mu‹x_lock
(
TSDN_NULL
, &
š™_lock
);

1322 
»t
 = 
	`m®loc_š™_h¬d_a0_locked
();

1323 
	`m®loc_mu‹x_uÆock
(
TSDN_NULL
, &
š™_lock
);

1324  (
»t
);

1325 
	}
}

1328 
boŞ


1329 
	$m®loc_š™_h¬d_»cursibË
()

1332 
m®loc_š™_¡©e
 = 
m®loc_š™_»cursibË
;

1334 
nıus
 = 
	`m®loc_nıus
();

1336 #ià(!
	`defšed
(
JEMALLOC_MUTEX_INIT_CB
è&& !defšed(
JEMALLOC_ZONE
) \

1337 && !
	`defšed
(
_WIN32
è&& !defšed(
__Çtive_ş›Á__
))

1339 ià(
	`±h»ad_©fÜk
(
jem®loc_´efÜk
, 
jem®loc_po¡fÜk_·»Á
,

1340 
jem®loc_po¡fÜk_chd
) != 0) {

1341 
	`m®loc_wr™e
("<jemalloc>: Error in…thread_atfork()\n");

1342 ià(
İt_abÜt
)

1343 
	`abÜt
();

1344  (
Œue
);

1348  (
çl£
);

1349 
	}
}

1351 
boŞ


1352 
	$m®loc_š™_h¬d_fšish
(
tsdn_t
 *
tsdn
)

1355 ià(
	`m®loc_mu‹x_boÙ
())

1356  (
Œue
);

1358 ià(
İt_Ç»Çs
 == 0) {

1363 ià(
nıus
 > 1)

1364 
İt_Ç»Çs
 = 
nıus
 << 2;

1366 
İt_Ç»Çs
 = 1;

1368 
Ç»Çs_auto
 = 
İt_Ç»Çs
;

1372 ià(
Ç»Çs_auto
 > 
MALLOCX_ARENA_MAX
) {

1373 
Ç»Çs_auto
 = 
MALLOCX_ARENA_MAX
;

1374 
	`m®loc_´štf
("<jemalloc>: Reducing‚arenaso†imit (%d)\n",

1375 
Ç»Çs_auto
);

1377 
	`Ç»Çs_tÙ®_£t
(
Ç»Çs_auto
);

1380 
¬’as
 = (
¬’a_t
 **)
	`ba£_®loc
(
tsdn
, (arena_t *) *

1381 (
MALLOCX_ARENA_MAX
+1));

1382 ià(
¬’as
 =ğ
NULL
)

1383  (
Œue
);

1385 
	`¬’a_£t
(0, 
a0
);

1387 
m®loc_š™_¡©e
 = 
m®loc_š™_š™Ÿlized
;

1388 
	`m®loc_¦ow_æag_š™
();

1390  (
çl£
);

1391 
	}
}

1393 
boŞ


1394 
	$m®loc_š™_h¬d
()

1396 
tsd_t
 *
tsd
;

1398 #ià
	`defšed
(
_WIN32
è&& 
_WIN32_WINNT
 < 0x0600

1399 
	`_š™_š™_lock
();

1401 
	`m®loc_mu‹x_lock
(
TSDN_NULL
, &
š™_lock
);

1402 ià(!
	`m®loc_š™_h¬d_Ãeded
()) {

1403 
	`m®loc_mu‹x_uÆock
(
TSDN_NULL
, &
š™_lock
);

1404  (
çl£
);

1407 ià(
m®loc_š™_¡©e
 !ğ
m®loc_š™_a0_š™Ÿlized
 &&

1408 
	`m®loc_š™_h¬d_a0_locked
()) {

1409 
	`m®loc_mu‹x_uÆock
(
TSDN_NULL
, &
š™_lock
);

1410  (
Œue
);

1413 
	`m®loc_mu‹x_uÆock
(
TSDN_NULL
, &
š™_lock
);

1415 
tsd
 = 
	`m®loc_tsd_boÙ0
();

1416 ià(
tsd
 =ğ
NULL
)

1417  (
Œue
);

1418 ià(
	`m®loc_š™_h¬d_»cursibË
())

1419  (
Œue
);

1420 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
š™_lock
);

1422 ià(
cÚfig_´of
 && 
	`´of_boÙ2
(
	`tsd_tsdn
(
tsd
))) {

1423 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
š™_lock
);

1424  (
Œue
);

1427 ià(
	`m®loc_š™_h¬d_fšish
(
	`tsd_tsdn
(
tsd
))) {

1428 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
š™_lock
);

1429  (
Œue
);

1432 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
š™_lock
);

1433 
	`m®loc_tsd_boÙ1
();

1434  (
çl£
);

1435 
	}
}

1446 
	$ŸÎoc_´of_§m¶e
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
szšd_t
 
šd
, 
boŞ
 
z”o
,

1447 
´of_tùx_t
 *
tùx
, 
boŞ
 
¦ow_·th
)

1449 *
p
;

1451 ià(
tùx
 =ğ
NULL
)

1452  (
NULL
);

1453 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

1454 
szšd_t
 
šd_Ïrge
 = 
	`size2šdex
(
LARGE_MINCLASS
);

1455 
p
 = 
	`ŸÎoc
(
tsd
, 
LARGE_MINCLASS
, 
šd_Ïrge
, 
z”o
, 
¦ow_·th
);

1456 ià(
p
 =ğ
NULL
)

1457  (
NULL
);

1458 
	`¬’a_´of_´omÙed
(
	`tsd_tsdn
(
tsd
), 
p
, 
usize
);

1460 
p
 = 
	`ŸÎoc
(
tsd
, 
usize
, 
šd
, 
z”o
, 
¦ow_·th
);

1462  (
p
);

1463 
	}
}

1465 
JEMALLOC_ALWAYS_INLINE_C
 *

1466 
	$ŸÎoc_´of
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
szšd_t
 
šd
, 
boŞ
 
z”o
, boŞ 
¦ow_·th
)

1468 *
p
;

1469 
´of_tùx_t
 *
tùx
;

1471 
tùx
 = 
	`´of_®loc_´•
(
tsd
, 
usize
, 
	`´of_aùive_g‘_uÆocked
(), 
Œue
);

1472 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U))

1473 
p
 = 
	`ŸÎoc_´of_§m¶e
(
tsd
, 
usize
, 
šd
, 
z”o
, 
tùx
, 
¦ow_·th
);

1475 
p
 = 
	`ŸÎoc
(
tsd
, 
usize
, 
šd
, 
z”o
, 
¦ow_·th
);

1476 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

1477 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

1478  (
NULL
);

1480 
	`´of_m®loc
(
	`tsd_tsdn
(
tsd
), 
p
, 
usize
, 
tùx
);

1482  (
p
);

1483 
	}
}

1491 
JEMALLOC_ALWAYS_INLINE_C
 *

1492 
	$ŸÎoc_body
(
size_t
 
size
, 
boŞ
 
z”o
, 
tsdn_t
 **
tsdn
, size_ˆ*
usize
,

1493 
boŞ
 
¦ow_·th
)

1495 
tsd_t
 *
tsd
;

1496 
szšd_t
 
šd
;

1498 ià(
¦ow_·th
 && 
	`uÆik–y
(
	`m®loc_š™
())) {

1499 *
tsdn
 = 
NULL
;

1500  (
NULL
);

1503 
tsd
 = 
	`tsd_ãtch
();

1504 *
tsdn
 = 
	`tsd_tsdn
(
tsd
);

1505 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

1507 
šd
 = 
	`size2šdex
(
size
);

1508 ià(
	`uÆik–y
(
šd
 >ğ
NSIZES
))

1509  (
NULL
);

1511 ià(
cÚfig_¡©s
 || (
cÚfig_´of
 && 
İt_´of
è|| (
¦ow_·th
 &&

1512 
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))) {

1513 *
usize
 = 
	`šdex2size
(
šd
);

1514 
	`as£¹
(*
usize
 > 0 && *usiz<ğ
HUGE_MAXCLASS
);

1517 ià(
cÚfig_´of
 && 
İt_´of
)

1518  (
	`ŸÎoc_´of
(
tsd
, *
usize
, 
šd
, 
z”o
, 
¦ow_·th
));

1520  (
	`ŸÎoc
(
tsd
, 
size
, 
šd
, 
z”o
, 
¦ow_·th
));

1521 
	}
}

1523 
JEMALLOC_ALWAYS_INLINE_C
 

1524 
	$ŸÎoc_po¡_check
(*
»t
, 
tsdn_t
 *
tsdn
, 
size_t
 
usize
, cÚ¡ *
func
,

1525 
boŞ
 
upd©e_”ºo
, boŞ 
¦ow_·th
)

1528 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
è|| 
»t
 =ğ
NULL
);

1530 ià(
	`uÆik–y
(
»t
 =ğ
NULL
)) {

1531 ià(
¦ow_·th
 && 
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

1532 
	`m®loc_´štf
("<jemalloc>: Error in %s(): out of "

1533 "memÜy\n", 
func
);

1534 
	`abÜt
();

1536 ià(
upd©e_”ºo
)

1537 
	`£t_”ºo
(
ENOMEM
);

1539 ià(
cÚfig_¡©s
 && 
	`lik–y
(
»t
 !ğ
NULL
)) {

1540 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
tsdn
, 
»t
, 
cÚfig_´of
));

1541 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
	`tsdn_tsd
(
tsdn
)è+ğ
usize
;

1543 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

1544 
	}
}

1546 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1547 
JEMALLOC_NOTHROW
 *

1548 
	$JEMALLOC_ATTR
(
m®loc
è
	$JEMALLOC_ALLOC_SIZE
(1)

1549 
	$je_m®loc
(
size_t
 
size
)

1551 *
»t
;

1552 
tsdn_t
 *
tsdn
;

1553 
size_t
 
usize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1555 ià(
size
 == 0)

1556 
size
 = 1;

1558 ià(
	`lik–y
(!
m®loc_¦ow
)) {

1559 
»t
 = 
	`ŸÎoc_body
(
size
, 
çl£
, &
tsdn
, &
usize
, false);

1560 
	`ŸÎoc_po¡_check
(
»t
, 
tsdn
, 
usize
, "m®loc", 
Œue
, 
çl£
);

1562 
»t
 = 
	`ŸÎoc_body
(
size
, 
çl£
, &
tsdn
, &
usize
, 
Œue
);

1563 
	`ŸÎoc_po¡_check
(
»t
, 
tsdn
, 
usize
, "m®loc", 
Œue
,rue);

1564 
	`UTRACE
(0, 
size
, 
»t
);

1565 
	`JEMALLOC_VALGRIND_MALLOC
(
»t
 !ğ
NULL
, 
tsdn
,„‘, 
usize
, 
çl£
);

1568  (
»t
);

1569 
	}
}

1572 
	$imem®ign_´of_§m¶e
(
tsd_t
 *
tsd
, 
size_t
 
®ignm’t
, size_ˆ
usize
,

1573 
´of_tùx_t
 *
tùx
)

1575 *
p
;

1577 ià(
tùx
 =ğ
NULL
)

1578  (
NULL
);

1579 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

1580 
	`as£¹
(
	`§2u
(
LARGE_MINCLASS
, 
®ignm’t
) == LARGE_MINCLASS);

1581 
p
 = 
	`®loc
(
tsd
, 
LARGE_MINCLASS
, 
®ignm’t
, 
çl£
);

1582 ià(
p
 =ğ
NULL
)

1583  (
NULL
);

1584 
	`¬’a_´of_´omÙed
(
	`tsd_tsdn
(
tsd
), 
p
, 
usize
);

1586 
p
 = 
	`®loc
(
tsd
, 
usize
, 
®ignm’t
, 
çl£
);

1588  (
p
);

1589 
	}
}

1591 
JEMALLOC_ALWAYS_INLINE_C
 *

1592 
	$imem®ign_´of
(
tsd_t
 *
tsd
, 
size_t
 
®ignm’t
, size_ˆ
usize
)

1594 *
p
;

1595 
´of_tùx_t
 *
tùx
;

1597 
tùx
 = 
	`´of_®loc_´•
(
tsd
, 
usize
, 
	`´of_aùive_g‘_uÆocked
(), 
Œue
);

1598 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U))

1599 
p
 = 
	`imem®ign_´of_§m¶e
(
tsd
, 
®ignm’t
, 
usize
, 
tùx
);

1601 
p
 = 
	`®loc
(
tsd
, 
usize
, 
®ignm’t
, 
çl£
);

1602 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

1603 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

1604  (
NULL
);

1606 
	`´of_m®loc
(
	`tsd_tsdn
(
tsd
), 
p
, 
usize
, 
tùx
);

1608  (
p
);

1609 
	}
}

1611 
JEMALLOC_ATTR
(
	$nÚnuÎ
(1))

1613 
	$imem®ign
(**
mem±r
, 
size_t
 
®ignm’t
, size_ˆ
size
, size_ˆ
mš_®ignm’t
)

1615 
»t
;

1616 
tsd_t
 *
tsd
;

1617 
size_t
 
usize
;

1618 *
»suÉ
;

1620 
	`as£¹
(
mš_®ignm’t
 != 0);

1622 ià(
	`uÆik–y
(
	`m®loc_š™
())) {

1623 
tsd
 = 
NULL
;

1624 
»suÉ
 = 
NULL
;

1625 
Ïb–_oom
;

1627 
tsd
 = 
	`tsd_ãtch
();

1628 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

1629 ià(
size
 == 0)

1630 
size
 = 1;

1633 ià(
	`uÆik–y
(((
®ignm’t
 - 1) &‡lignment) != 0

1634 || (
®ignm’t
 < 
mš_®ignm’t
))) {

1635 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

1636 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating "

1638 
	`abÜt
();

1640 
»suÉ
 = 
NULL
;

1641 
»t
 = 
EINVAL
;

1642 
Ïb–_»tuº
;

1645 
usize
 = 
	`§2u
(
size
, 
®ignm’t
);

1646 ià(
	`uÆik–y
(
usize
 =ğ0 || usiz> 
HUGE_MAXCLASS
)) {

1647 
»suÉ
 = 
NULL
;

1648 
Ïb–_oom
;

1651 ià(
cÚfig_´of
 && 
İt_´of
)

1652 
»suÉ
 = 
	`imem®ign_´of
(
tsd
, 
®ignm’t
, 
usize
);

1654 
»suÉ
 = 
	`®loc
(
tsd
, 
usize
, 
®ignm’t
, 
çl£
);

1655 ià(
	`uÆik–y
(
»suÉ
 =ğ
NULL
))

1656 
Ïb–_oom
;

1657 
	`as£¹
(((
ušŒ_t
)
»suÉ
 & (
®ignm’t
 - 1)è=ğ
	`ZU
(0));

1659 *
mem±r
 = 
»suÉ
;

1660 
»t
 = 0;

1661 
Ïb–_»tuº
:

1662 ià(
cÚfig_¡©s
 && 
	`lik–y
(
»suÉ
 !ğ
NULL
)) {

1663 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
»suÉ
, 
cÚfig_´of
));

1664 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1666 
	`UTRACE
(0, 
size
, 
»suÉ
);

1667 
	`JEMALLOC_VALGRIND_MALLOC
(
»suÉ
 !ğ
NULL
, 
	`tsd_tsdn
(
tsd
),„esuÉ, 
usize
,

1668 
çl£
);

1669 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

1670  (
»t
);

1671 
Ïb–_oom
:

1672 
	`as£¹
(
»suÉ
 =ğ
NULL
);

1673 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

1674 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating‡ligned memory: "

1676 
	`abÜt
();

1678 
»t
 = 
ENOMEM
;

1679 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

1680 
Ïb–_»tuº
;

1681 
	}
}

1683 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


1684 
JEMALLOC_ATTR
(
	$nÚnuÎ
(1))

1685 
	$je_posix_mem®ign
(**
mem±r
, 
size_t
 
®ignm’t
, size_ˆ
size
)

1687 
»t
;

1689 
»t
 = 
	`imem®ign
(
mem±r
, 
®ignm’t
, 
size
, (*));

1691  (
»t
);

1692 
	}
}

1694 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1695 
JEMALLOC_NOTHROW
 *

1696 
	$JEMALLOC_ATTR
(
m®loc
è
	$JEMALLOC_ALLOC_SIZE
(2)

1697 
	$je_®igÃd_®loc
(
size_t
 
®ignm’t
, size_ˆ
size
)

1699 *
»t
;

1700 
”r
;

1702 ià(
	`uÆik–y
((
”r
 = 
	`imem®ign
(&
»t
, 
®ignm’t
, 
size
, 1)) != 0)) {

1703 
»t
 = 
NULL
;

1704 
	`£t_”ºo
(
”r
);

1707  (
»t
);

1708 
	}
}

1710 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1711 
JEMALLOC_NOTHROW
 *

1712 
	$JEMALLOC_ATTR
(
m®loc
è
	$JEMALLOC_ALLOC_SIZE2
(1, 2)

1713 
	$je_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

1715 *
»t
;

1716 
tsdn_t
 *
tsdn
;

1717 
size_t
 
num_size
;

1718 
size_t
 
usize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1720 
num_size
 = 
num
 * 
size
;

1721 ià(
	`uÆik–y
(
num_size
 == 0)) {

1722 ià(
num
 =ğ0 || 
size
 == 0)

1723 
num_size
 = 1;

1725 
num_size
 = 
HUGE_MAXCLASS
 + 1;

1731 } ià(
	`uÆik–y
(((
num
 | 
size
è& (
SIZE_T_MAX
 << ((
size_t
) <<

1732 2))è&& (
num_size
 / 
size
 !ğ
num
)))

1733 
num_size
 = 
HUGE_MAXCLASS
 + 1;

1735 ià(
	`lik–y
(!
m®loc_¦ow
)) {

1736 
»t
 = 
	`ŸÎoc_body
(
num_size
, 
Œue
, &
tsdn
, &
usize
, 
çl£
);

1737 
	`ŸÎoc_po¡_check
(
»t
, 
tsdn
, 
usize
, "ÿÎoc", 
Œue
, 
çl£
);

1739 
»t
 = 
	`ŸÎoc_body
(
num_size
, 
Œue
, &
tsdn
, &
usize
,rue);

1740 
	`ŸÎoc_po¡_check
(
»t
, 
tsdn
, 
usize
, "ÿÎoc", 
Œue
,rue);

1741 
	`UTRACE
(0, 
num_size
, 
»t
);

1742 
	`JEMALLOC_VALGRIND_MALLOC
(
»t
 !ğ
NULL
, 
tsdn
,„‘, 
usize
, 
çl£
);

1745  (
»t
);

1746 
	}
}

1749 
	$œ—Îoc_´of_§m¶e
(
tsd_t
 *
tsd
, *
Şd_±r
, 
size_t
 
Şd_usize
, size_ˆ
usize
,

1750 
´of_tùx_t
 *
tùx
)

1752 *
p
;

1754 ià(
tùx
 =ğ
NULL
)

1755  (
NULL
);

1756 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

1757 
p
 = 
	`œ®loc
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
LARGE_MINCLASS
, 0, 
çl£
);

1758 ià(
p
 =ğ
NULL
)

1759  (
NULL
);

1760 
	`¬’a_´of_´omÙed
(
	`tsd_tsdn
(
tsd
), 
p
, 
usize
);

1762 
p
 = 
	`œ®loc
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
usize
, 0, 
çl£
);

1764  (
p
);

1765 
	}
}

1767 
JEMALLOC_ALWAYS_INLINE_C
 *

1768 
	$œ—Îoc_´of
(
tsd_t
 *
tsd
, *
Şd_±r
, 
size_t
 
Şd_usize
, size_ˆ
usize
)

1770 *
p
;

1771 
boŞ
 
´of_aùive
;

1772 
´of_tùx_t
 *
Şd_tùx
, *
tùx
;

1774 
´of_aùive
 = 
	`´of_aùive_g‘_uÆocked
();

1775 
Şd_tùx
 = 
	`´of_tùx_g‘
(
	`tsd_tsdn
(
tsd
), 
Şd_±r
);

1776 
tùx
 = 
	`´of_®loc_´•
(
tsd
, 
usize
, 
´of_aùive
, 
Œue
);

1777 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U))

1778 
p
 = 
	`œ—Îoc_´of_§m¶e
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
usize
, 
tùx
);

1780 
p
 = 
	`œ®loc
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
usize
, 0, 
çl£
);

1781 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

1782 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

1783  (
NULL
);

1785 
	`´of_»®loc
(
tsd
, 
p
, 
usize
, 
tùx
, 
´of_aùive
, 
Œue
, 
Şd_±r
, 
Şd_usize
,

1786 
Şd_tùx
);

1788  (
p
);

1789 
	}
}

1791 
JEMALLOC_INLINE_C
 

1792 
	$iä“
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
, 
boŞ
 
¦ow_·th
)

1794 
size_t
 
usize
;

1795 
UNUSED
 
size_t
 
rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1797 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

1799 
	`as£¹
(
±r
 !ğ
NULL
);

1800 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

1802 ià(
cÚfig_´of
 && 
İt_´of
) {

1803 
usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
cÚfig_´of
);

1804 
	`´of_ä“
(
tsd
, 
±r
, 
usize
);

1805 } ià(
cÚfig_¡©s
 || 
cÚfig_v®gršd
)

1806 
usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
cÚfig_´of
);

1807 ià(
cÚfig_¡©s
)

1808 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1810 ià(
	`lik–y
(!
¦ow_·th
))

1811 
	`iq®loc
(
tsd
, 
±r
, 
tÿche
, 
çl£
);

1813 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))

1814 
rzsize
 = 
	`p2rz
(
	`tsd_tsdn
(
tsd
), 
±r
);

1815 
	`iq®loc
(
tsd
, 
±r
, 
tÿche
, 
Œue
);

1816 
	`JEMALLOC_VALGRIND_FREE
(
±r
, 
rzsize
);

1818 
	}
}

1820 
JEMALLOC_INLINE_C
 

1821 
	$isä“
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
usize
, 
tÿche_t
 *
tÿche
, 
boŞ
 
¦ow_·th
)

1823 
UNUSED
 
size_t
 
rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1825 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

1827 
	`as£¹
(
±r
 !ğ
NULL
);

1828 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

1830 ià(
cÚfig_´of
 && 
İt_´of
)

1831 
	`´of_ä“
(
tsd
, 
±r
, 
usize
);

1832 ià(
cÚfig_¡©s
)

1833 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1834 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))

1835 
rzsize
 = 
	`p2rz
(
	`tsd_tsdn
(
tsd
), 
±r
);

1836 
	`isq®loc
(
tsd
, 
±r
, 
usize
, 
tÿche
, 
¦ow_·th
);

1837 
	`JEMALLOC_VALGRIND_FREE
(
±r
, 
rzsize
);

1838 
	}
}

1840 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1841 
JEMALLOC_NOTHROW
 *

1842 
	$JEMALLOC_ALLOC_SIZE
(2)

1843 
	$je_»®loc
(*
±r
, 
size_t
 
size
)

1845 *
»t
;

1846 
tsdn_t
 *
tsdn
 
	`JEMALLOC_CC_SILENCE_INIT
(
NULL
);

1847 
size_t
 
usize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1848 
size_t
 
Şd_usize
 = 0;

1849 
UNUSED
 
size_t
 
Şd_rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1851 ià(
	`uÆik–y
(
size
 == 0)) {

1852 ià(
±r
 !ğ
NULL
) {

1853 
tsd_t
 *
tsd
;

1856 
	`UTRACE
(
±r
, 0, 0);

1857 
tsd
 = 
	`tsd_ãtch
();

1858 
	`iä“
(
tsd
, 
±r
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

1859  (
NULL
);

1861 
size
 = 1;

1864 ià(
	`lik–y
(
±r
 !ğ
NULL
)) {

1865 
tsd_t
 *
tsd
;

1867 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

1868 
	`m®loc_th»ad_š™
();

1869 
tsd
 = 
	`tsd_ãtch
();

1871 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

1873 
Şd_usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
cÚfig_´of
);

1874 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
)) {

1875 
Şd_rzsize
 = 
cÚfig_´of
 ? 
	`p2rz
(
	`tsd_tsdn
(
tsd
), 
±r
) :

1876 
	`u2rz
(
Şd_usize
);

1879 ià(
cÚfig_´of
 && 
İt_´of
) {

1880 
usize
 = 
	`s2u
(
size
);

1881 
»t
 = 
	`uÆik–y
(
usize
 =ğ0 || usiz> 
HUGE_MAXCLASS
) ?

1882 
NULL
 : 
	`œ—Îoc_´of
(
tsd
, 
±r
, 
Şd_usize
, 
usize
);

1884 ià(
cÚfig_¡©s
 || (
cÚfig_v®gršd
 &&

1885 
	`uÆik–y
(
š_v®gršd
)))

1886 
usize
 = 
	`s2u
(
size
);

1887 
»t
 = 
	`œ®loc
(
tsd
, 
±r
, 
Şd_usize
, 
size
, 0, 
çl£
);

1889 
tsdn
 = 
	`tsd_tsdn
(
tsd
);

1892 ià(
	`lik–y
(!
m®loc_¦ow
))

1893 
»t
 = 
	`ŸÎoc_body
(
size
, 
çl£
, &
tsdn
, &
usize
, false);

1895 
»t
 = 
	`ŸÎoc_body
(
size
, 
çl£
, &
tsdn
, &
usize
, 
Œue
);

1896 
	`as£¹
(!
	`tsdn_nuÎ
(
tsdn
è|| 
»t
 =ğ
NULL
);

1899 ià(
	`uÆik–y
(
»t
 =ğ
NULL
)) {

1900 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

1901 
	`m®loc_wr™e
("<jemalloc>: Error in„ealloc(): "

1903 
	`abÜt
();

1905 
	`£t_”ºo
(
ENOMEM
);

1907 ià(
cÚfig_¡©s
 && 
	`lik–y
(
»t
 !ğ
NULL
)) {

1908 
tsd_t
 *
tsd
;

1910 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
tsdn
, 
»t
, 
cÚfig_´of
));

1911 
tsd
 = 
	`tsdn_tsd
(
tsdn
);

1912 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1913 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
Şd_usize
;

1915 
	`UTRACE
(
±r
, 
size
, 
»t
);

1916 
	`JEMALLOC_VALGRIND_REALLOC
(
Œue
, 
tsdn
, 
»t
, 
usize
,rue, 
±r
, 
Şd_usize
,

1917 
Şd_rzsize
, 
Œue
, 
çl£
);

1918 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

1919  (
»t
);

1920 
	}
}

1922 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


1923 
	$je_ä“
(*
±r
)

1926 
	`UTRACE
(
±r
, 0, 0);

1927 ià(
	`lik–y
(
±r
 !ğ
NULL
)) {

1928 
tsd_t
 *
tsd
 = 
	`tsd_ãtch
();

1929 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

1930 ià(
	`lik–y
(!
m®loc_¦ow
))

1931 
	`iä“
(
tsd
, 
±r
, 
	`tÿche_g‘
Ñsd, 
çl£
), false);

1933 
	`iä“
(
tsd
, 
±r
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

1934 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

1936 
	}
}

1946 #ifdeà
JEMALLOC_OVERRIDE_MEMALIGN


1947 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1948 
JEMALLOC_NOTHROW
 *

1949 
	$JEMALLOC_ATTR
(
m®loc
)

1950 
	$je_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
)

1952 *
»t
 
	`JEMALLOC_CC_SILENCE_INIT
(
NULL
);

1953 ià(
	`uÆik–y
(
	`imem®ign
(&
»t
, 
®ignm’t
, 
size
, 1) != 0))

1954 
»t
 = 
NULL
;

1955  (
»t
);

1956 
	}
}

1959 #ifdeà
JEMALLOC_OVERRIDE_VALLOC


1960 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1961 
JEMALLOC_NOTHROW
 *

1962 
	$JEMALLOC_ATTR
(
m®loc
)

1963 
	$je_v®loc
(
size_t
 
size
)

1965 *
»t
 
	`JEMALLOC_CC_SILENCE_INIT
(
NULL
);

1966 ià(
	`uÆik–y
(
	`imem®ign
(&
»t
, 
PAGE
, 
size
, 1) != 0))

1967 
»t
 = 
NULL
;

1968  (
»t
);

1969 
	}
}

1976 
	#m®loc_is_m®loc
 1

	)

1977 
	#is_m®loc_
(
a
è
m®loc_is_
 ## 
	)
a

1978 
	#is_m®loc
(
a
è
	`is_m®loc_
×)

	)

1980 #ià((
is_m®loc
(
je_m®loc
è=ğ1è&& 
defšed
(
JEMALLOC_GLIBC_MALLOC_HOOK
))

1990 
JEMALLOC_EXPORT
 (*
__ä“_hook
)(*
±r
èğ
je_ä“
;

1991 
JEMALLOC_EXPORT
 *(*
__m®loc_hook
)(
size_t
 
size
èğ
je_m®loc
;

1992 
JEMALLOC_EXPORT
 *(*
__»®loc_hook
)(*
±r
, 
size_t
 
size
èğ
je_»®loc
;

1993 #ifdeà
JEMALLOC_GLIBC_MEMALIGN_HOOK


1994 
JEMALLOC_EXPORT
 *(*
__mem®ign_hook
)(
size_t
 
®ignm’t
, size_ˆ
size
) =

1995 
je_mem®ign
;

2007 
JEMALLOC_ALWAYS_INLINE_C
 
boŞ


2008 
	$im®locx_æags_decode
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
æags
, size_ˆ*
usize
,

2009 
size_t
 *
®ignm’t
, 
boŞ
 *
z”o
, 
tÿche_t
 **
tÿche
, 
¬’a_t
 **
¬’a
)

2012 ià((
æags
 & 
MALLOCX_LG_ALIGN_MASK
) == 0) {

2013 *
®ignm’t
 = 0;

2014 *
usize
 = 
	`s2u
(
size
);

2016 *
®ignm’t
 = 
	`MALLOCX_ALIGN_GET_SPECIFIED
(
æags
);

2017 *
usize
 = 
	`§2u
(
size
, *
®ignm’t
);

2019 ià(
	`uÆik–y
(*
usize
 =ğ0 || *usiz> 
HUGE_MAXCLASS
))

2020  (
Œue
);

2021 *
z”o
 = 
	`MALLOCX_ZERO_GET
(
æags
);

2022 ià((
æags
 & 
MALLOCX_TCACHE_MASK
) != 0) {

2023 ià((
æags
 & 
MALLOCX_TCACHE_MASK
è=ğ
MALLOCX_TCACHE_NONE
)

2024 *
tÿche
 = 
NULL
;

2026 *
tÿche
 = 
	`tÿches_g‘
(
tsd
, 
	`MALLOCX_TCACHE_GET
(
æags
));

2028 *
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
Œue
);

2029 ià((
æags
 & 
MALLOCX_ARENA_MASK
) != 0) {

2030 
¬’a_šd
 = 
	`MALLOCX_ARENA_GET
(
æags
);

2031 *
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a_šd
, 
Œue
);

2032 ià(
	`uÆik–y
(*
¬’a
 =ğ
NULL
))

2033  (
Œue
);

2035 *
¬’a
 = 
NULL
;

2036  (
çl£
);

2037 
	}
}

2039 
JEMALLOC_ALWAYS_INLINE_C
 *

2040 
	$im®locx_æags
(
tsdn_t
 *
tsdn
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

2041 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
, 
boŞ
 
¦ow_·th
)

2043 
szšd_t
 
šd
;

2045 ià(
	`uÆik–y
(
®ignm’t
 != 0))

2046  (
	`®loù
(
tsdn
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
));

2047 
šd
 = 
	`size2šdex
(
usize
);

2048 
	`as£¹
(
šd
 < 
NSIZES
);

2049  (
	`ŸÎocztm
(
tsdn
, 
usize
, 
šd
, 
z”o
, 
tÿche
, 
çl£
, 
¬’a
,

2050 
¦ow_·th
));

2051 
	}
}

2054 
	$im®locx_´of_§m¶e
(
tsdn_t
 *
tsdn
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

2055 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
, 
boŞ
 
¦ow_·th
)

2057 *
p
;

2059 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

2060 
	`as£¹
(((
®ignm’t
 =ğ0è? 
	`s2u
(
LARGE_MINCLASS
) :

2061 
	`§2u
(
LARGE_MINCLASS
, 
®ignm’t
)) == LARGE_MINCLASS);

2062 
p
 = 
	`im®locx_æags
(
tsdn
, 
LARGE_MINCLASS
, 
®ignm’t
, 
z”o
,

2063 
tÿche
, 
¬’a
, 
¦ow_·th
);

2064 ià(
p
 =ğ
NULL
)

2065  (
NULL
);

2066 
	`¬’a_´of_´omÙed
(
tsdn
, 
p
, 
usize
);

2068 
p
 = 
	`im®locx_æags
(
tsdn
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
,

2069 
¦ow_·th
);

2072  (
p
);

2073 
	}
}

2075 
JEMALLOC_ALWAYS_INLINE_C
 *

2076 
	$im®locx_´of
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
æags
, size_ˆ*
usize
, 
boŞ
 
¦ow_·th
)

2078 *
p
;

2079 
size_t
 
®ignm’t
;

2080 
boŞ
 
z”o
;

2081 
tÿche_t
 *
tÿche
;

2082 
¬’a_t
 *
¬’a
;

2083 
´of_tùx_t
 *
tùx
;

2085 ià(
	`uÆik–y
(
	`im®locx_æags_decode
(
tsd
, 
size
, 
æags
, 
usize
, &
®ignm’t
,

2086 &
z”o
, &
tÿche
, &
¬’a
)))

2087  (
NULL
);

2088 
tùx
 = 
	`´of_®loc_´•
(
tsd
, *
usize
, 
	`´of_aùive_g‘_uÆocked
(), 
Œue
);

2089 ià(
	`lik–y
((
ušŒ_t
)
tùx
 == (uintptr_t)1U)) {

2090 
p
 = 
	`im®locx_æags
(
	`tsd_tsdn
(
tsd
), *
usize
, 
®ignm’t
, 
z”o
,

2091 
tÿche
, 
¬’a
, 
¦ow_·th
);

2092 } ià((
ušŒ_t
)
tùx
 > (uintptr_t)1U) {

2093 
p
 = 
	`im®locx_´of_§m¶e
(
	`tsd_tsdn
(
tsd
), *
usize
, 
®ignm’t
, 
z”o
,

2094 
tÿche
, 
¬’a
, 
¦ow_·th
);

2096 
p
 = 
NULL
;

2097 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

2098 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

2099  (
NULL
);

2101 
	`´of_m®loc
(
	`tsd_tsdn
(
tsd
), 
p
, *
usize
, 
tùx
);

2103 
	`as£¹
(
®ignm’t
 =ğ0 || ((
ušŒ_t
)
p
 & (®ignm’ˆ- 1)è=ğ
	`ZU
(0));

2104  (
p
);

2105 
	}
}

2107 
JEMALLOC_ALWAYS_INLINE_C
 *

2108 
	$im®locx_no_´of
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
æags
, size_ˆ*
usize
,

2109 
boŞ
 
¦ow_·th
)

2111 *
p
;

2112 
size_t
 
®ignm’t
;

2113 
boŞ
 
z”o
;

2114 
tÿche_t
 *
tÿche
;

2115 
¬’a_t
 *
¬’a
;

2117 ià(
	`uÆik–y
(
	`im®locx_æags_decode
(
tsd
, 
size
, 
æags
, 
usize
, &
®ignm’t
,

2118 &
z”o
, &
tÿche
, &
¬’a
)))

2119  (
NULL
);

2120 
p
 = 
	`im®locx_æags
(
	`tsd_tsdn
(
tsd
), *
usize
, 
®ignm’t
, 
z”o
, 
tÿche
,

2121 
¬’a
, 
¦ow_·th
);

2122 
	`as£¹
(
®ignm’t
 =ğ0 || ((
ušŒ_t
)
p
 & (®ignm’ˆ- 1)è=ğ
	`ZU
(0));

2123  (
p
);

2124 
	}
}

2127 
JEMALLOC_ALWAYS_INLINE_C
 *

2128 
	$im®locx_body
(
size_t
 
size
, 
æags
, 
tsdn_t
 **
tsdn
, size_ˆ*
usize
,

2129 
boŞ
 
¦ow_·th
)

2131 
tsd_t
 *
tsd
;

2133 ià(
¦ow_·th
 && 
	`uÆik–y
(
	`m®loc_š™
())) {

2134 *
tsdn
 = 
NULL
;

2135  (
NULL
);

2138 
tsd
 = 
	`tsd_ãtch
();

2139 *
tsdn
 = 
	`tsd_tsdn
(
tsd
);

2140 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2142 ià(
	`lik–y
(
æags
 == 0)) {

2143 
szšd_t
 
šd
 = 
	`size2šdex
(
size
);

2144 ià(
	`uÆik–y
(
šd
 >ğ
NSIZES
))

2145  (
NULL
);

2146 ià(
cÚfig_¡©s
 || (
cÚfig_´of
 && 
İt_´of
è|| (
¦ow_·th
 &&

2147 
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))) {

2148 *
usize
 = 
	`šdex2size
(
šd
);

2149 
	`as£¹
(*
usize
 > 0 && *usiz<ğ
HUGE_MAXCLASS
);

2152 ià(
cÚfig_´of
 && 
İt_´of
) {

2153  (
	`ŸÎoc_´of
(
tsd
, *
usize
, 
šd
, 
çl£
,

2154 
¦ow_·th
));

2157  (
	`ŸÎoc
(
tsd
, 
size
, 
šd
, 
çl£
, 
¦ow_·th
));

2160 ià(
cÚfig_´of
 && 
İt_´of
)

2161  (
	`im®locx_´of
(
tsd
, 
size
, 
æags
, 
usize
, 
¦ow_·th
));

2163  (
	`im®locx_no_´of
(
tsd
, 
size
, 
æags
, 
usize
, 
¦ow_·th
));

2164 
	}
}

2166 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


2167 
JEMALLOC_NOTHROW
 *

2168 
	$JEMALLOC_ATTR
(
m®loc
è
	$JEMALLOC_ALLOC_SIZE
(1)

2169 
	$je_m®locx
(
size_t
 
size
, 
æags
)

2171 
tsdn_t
 *
tsdn
;

2172 *
p
;

2173 
size_t
 
usize
;

2175 
	`as£¹
(
size
 != 0);

2177 ià(
	`lik–y
(!
m®loc_¦ow
)) {

2178 
p
 = 
	`im®locx_body
(
size
, 
æags
, &
tsdn
, &
usize
, 
çl£
);

2179 
	`ŸÎoc_po¡_check
(
p
, 
tsdn
, 
usize
, "m®locx", 
çl£
, false);

2181 
p
 = 
	`im®locx_body
(
size
, 
æags
, &
tsdn
, &
usize
, 
Œue
);

2182 
	`ŸÎoc_po¡_check
(
p
, 
tsdn
, 
usize
, "m®locx", 
çl£
, 
Œue
);

2183 
	`UTRACE
(0, 
size
, 
p
);

2184 
	`JEMALLOC_VALGRIND_MALLOC
(
p
 !ğ
NULL
, 
tsdn
,…, 
usize
,

2185 
	`MALLOCX_ZERO_GET
(
æags
));

2188  (
p
);

2189 
	}
}

2192 
	$œ®locx_´of_§m¶e
(
tsd_t
 *
tsd
, *
Şd_±r
, 
size_t
 
Şd_usize
,

2193 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
,

2194 
´of_tùx_t
 *
tùx
)

2196 *
p
;

2198 ià(
tùx
 =ğ
NULL
)

2199  (
NULL
);

2200 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

2201 
p
 = 
	`œ®loù
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
LARGE_MINCLASS
, 
®ignm’t
,

2202 
z”o
, 
tÿche
, 
¬’a
);

2203 ià(
p
 =ğ
NULL
)

2204  (
NULL
);

2205 
	`¬’a_´of_´omÙed
(
	`tsd_tsdn
(
tsd
), 
p
, 
usize
);

2207 
p
 = 
	`œ®loù
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
usize
, 
®ignm’t
, 
z”o
,

2208 
tÿche
, 
¬’a
);

2211  (
p
);

2212 
	}
}

2214 
JEMALLOC_ALWAYS_INLINE_C
 *

2215 
	$œ®locx_´of
(
tsd_t
 *
tsd
, *
Şd_±r
, 
size_t
 
Şd_usize
, size_ˆ
size
,

2216 
size_t
 
®ignm’t
, size_ˆ*
usize
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
,

2217 
¬’a_t
 *
¬’a
)

2219 *
p
;

2220 
boŞ
 
´of_aùive
;

2221 
´of_tùx_t
 *
Şd_tùx
, *
tùx
;

2223 
´of_aùive
 = 
	`´of_aùive_g‘_uÆocked
();

2224 
Şd_tùx
 = 
	`´of_tùx_g‘
(
	`tsd_tsdn
(
tsd
), 
Şd_±r
);

2225 
tùx
 = 
	`´of_®loc_´•
(
tsd
, *
usize
, 
´of_aùive
, 
Œue
);

2226 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U)) {

2227 
p
 = 
	`œ®locx_´of_§m¶e
(
tsd
, 
Şd_±r
, 
Şd_usize
, *
usize
,

2228 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
, 
tùx
);

2230 
p
 = 
	`œ®loù
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
size
, 
®ignm’t
, 
z”o
,

2231 
tÿche
, 
¬’a
);

2233 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

2234 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

2235  (
NULL
);

2238 ià(
p
 =ğ
Şd_±r
 && 
®ignm’t
 != 0) {

2247 *
usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
p
, 
cÚfig_´of
);

2249 
	`´of_»®loc
(
tsd
, 
p
, *
usize
, 
tùx
, 
´of_aùive
, 
Œue
, 
Şd_±r
,

2250 
Şd_usize
, 
Şd_tùx
);

2252  (
p
);

2253 
	}
}

2255 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


2256 
JEMALLOC_NOTHROW
 *

2257 
	$JEMALLOC_ALLOC_SIZE
(2)

2258 
	$je_¿Îocx
(*
±r
, 
size_t
 
size
, 
æags
)

2260 *
p
;

2261 
tsd_t
 *
tsd
;

2262 
size_t
 
usize
;

2263 
size_t
 
Şd_usize
;

2264 
UNUSED
 
size_t
 
Şd_rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

2265 
size_t
 
®ignm’t
 = 
	`MALLOCX_ALIGN_GET
(
æags
);

2266 
boŞ
 
z”o
 = 
æags
 & 
MALLOCX_ZERO
;

2267 
¬’a_t
 *
¬’a
;

2268 
tÿche_t
 *
tÿche
;

2270 
	`as£¹
(
±r
 !ğ
NULL
);

2271 
	`as£¹
(
size
 != 0);

2272 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2273 
	`m®loc_th»ad_š™
();

2274 
tsd
 = 
	`tsd_ãtch
();

2275 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2277 ià(
	`uÆik–y
((
æags
 & 
MALLOCX_ARENA_MASK
) != 0)) {

2278 
¬’a_šd
 = 
	`MALLOCX_ARENA_GET
(
æags
);

2279 
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
¬’a_šd
, 
Œue
);

2280 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

2281 
Ïb–_oom
;

2283 
¬’a
 = 
NULL
;

2285 ià(
	`uÆik–y
((
æags
 & 
MALLOCX_TCACHE_MASK
) != 0)) {

2286 ià((
æags
 & 
MALLOCX_TCACHE_MASK
è=ğ
MALLOCX_TCACHE_NONE
)

2287 
tÿche
 = 
NULL
;

2289 
tÿche
 = 
	`tÿches_g‘
(
tsd
, 
	`MALLOCX_TCACHE_GET
(
æags
));

2291 
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
Œue
);

2293 
Şd_usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
cÚfig_´of
);

2294 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))

2295 
Şd_rzsize
 = 
	`u2rz
(
Şd_usize
);

2297 ià(
cÚfig_´of
 && 
İt_´of
) {

2298 
usize
 = (
®ignm’t
 =ğ0è? 
	`s2u
(
size
è: 
	`§2u
(size,‡lignment);

2299 ià(
	`uÆik–y
(
usize
 =ğ0 || usiz> 
HUGE_MAXCLASS
))

2300 
Ïb–_oom
;

2301 
p
 = 
	`œ®locx_´of
(
tsd
, 
±r
, 
Şd_usize
, 
size
, 
®ignm’t
, &
usize
,

2302 
z”o
, 
tÿche
, 
¬’a
);

2303 ià(
	`uÆik–y
(
p
 =ğ
NULL
))

2304 
Ïb–_oom
;

2306 
p
 = 
	`œ®loù
(
tsd
, 
±r
, 
Şd_usize
, 
size
, 
®ignm’t
, 
z”o
,

2307 
tÿche
, 
¬’a
);

2308 ià(
	`uÆik–y
(
p
 =ğ
NULL
))

2309 
Ïb–_oom
;

2310 ià(
cÚfig_¡©s
 || (
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
)))

2311 
usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
p
, 
cÚfig_´of
);

2313 
	`as£¹
(
®ignm’t
 =ğ0 || ((
ušŒ_t
)
p
 & (®ignm’ˆ- 1)è=ğ
	`ZU
(0));

2315 ià(
cÚfig_¡©s
) {

2316 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

2317 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
Şd_usize
;

2319 
	`UTRACE
(
±r
, 
size
, 
p
);

2320 
	`JEMALLOC_VALGRIND_REALLOC
(
Œue
, 
	`tsd_tsdn
(
tsd
), 
p
, 
usize
, 
çl£
, 
±r
,

2321 
Şd_usize
, 
Şd_rzsize
, 
çl£
, 
z”o
);

2322 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2323  (
p
);

2324 
Ïb–_oom
:

2325 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

2326 
	`m®loc_wr™e
("<jemalloc>: Error in„allocx(): out of memory\n");

2327 
	`abÜt
();

2329 
	`UTRACE
(
±r
, 
size
, 0);

2330 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2331  (
NULL
);

2332 
	}
}

2334 
JEMALLOC_ALWAYS_INLINE_C
 
size_t


2335 
	$ix®locx_h–³r
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şd_usize
, size_ˆ
size
,

2336 
size_t
 
exŒa
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
)

2338 
size_t
 
usize
;

2340 ià(
	`ix®loc
(
tsdn
, 
±r
, 
Şd_usize
, 
size
, 
exŒa
, 
®ignm’t
, 
z”o
))

2341  (
Şd_usize
);

2342 
usize
 = 
	`i§Îoc
(
tsdn
, 
±r
, 
cÚfig_´of
);

2344  (
usize
);

2345 
	}
}

2347 
size_t


2348 
	$ix®locx_´of_§m¶e
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
Şd_usize
, size_ˆ
size
,

2349 
size_t
 
exŒa
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
´of_tùx_t
 *
tùx
)

2351 
size_t
 
usize
;

2353 ià(
tùx
 =ğ
NULL
)

2354  (
Şd_usize
);

2355 
usize
 = 
	`ix®locx_h–³r
(
tsdn
, 
±r
, 
Şd_usize
, 
size
, 
exŒa
, 
®ignm’t
,

2356 
z”o
);

2358  (
usize
);

2359 
	}
}

2361 
JEMALLOC_ALWAYS_INLINE_C
 
size_t


2362 
	$ix®locx_´of
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şd_usize
, size_ˆ
size
,

2363 
size_t
 
exŒa
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
)

2365 
size_t
 
usize_max
, 
usize
;

2366 
boŞ
 
´of_aùive
;

2367 
´of_tùx_t
 *
Şd_tùx
, *
tùx
;

2369 
´of_aùive
 = 
	`´of_aùive_g‘_uÆocked
();

2370 
Şd_tùx
 = 
	`´of_tùx_g‘
(
	`tsd_tsdn
(
tsd
), 
±r
);

2377 ià(
®ignm’t
 == 0) {

2378 
usize_max
 = 
	`s2u
(
size
+
exŒa
);

2379 
	`as£¹
(
usize_max
 > 0 && usize_max <ğ
HUGE_MAXCLASS
);

2381 
usize_max
 = 
	`§2u
(
size
+
exŒa
, 
®ignm’t
);

2382 ià(
	`uÆik–y
(
usize_max
 =ğ0 || usize_max > 
HUGE_MAXCLASS
)) {

2389 
usize_max
 = 
HUGE_MAXCLASS
;

2392 
tùx
 = 
	`´of_®loc_´•
(
tsd
, 
usize_max
, 
´of_aùive
, 
çl£
);

2394 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U)) {

2395 
usize
 = 
	`ix®locx_´of_§m¶e
(
	`tsd_tsdn
(
tsd
), 
±r
, 
Şd_usize
,

2396 
size
, 
exŒa
, 
®ignm’t
, 
z”o
, 
tùx
);

2398 
usize
 = 
	`ix®locx_h–³r
(
	`tsd_tsdn
(
tsd
), 
±r
, 
Şd_usize
, 
size
,

2399 
exŒa
, 
®ignm’t
, 
z”o
);

2401 ià(
usize
 =ğ
Şd_usize
) {

2402 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
çl£
);

2403  (
usize
);

2405 
	`´of_»®loc
(
tsd
, 
±r
, 
usize
, 
tùx
, 
´of_aùive
, 
çl£
,…Œ, 
Şd_usize
,

2406 
Şd_tùx
);

2408  (
usize
);

2409 
	}
}

2411 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW


2412 
	$je_x®locx
(*
±r
, 
size_t
 
size
, size_ˆ
exŒa
, 
æags
)

2414 
tsd_t
 *
tsd
;

2415 
size_t
 
usize
, 
Şd_usize
;

2416 
UNUSED
 
size_t
 
Şd_rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

2417 
size_t
 
®ignm’t
 = 
	`MALLOCX_ALIGN_GET
(
æags
);

2418 
boŞ
 
z”o
 = 
æags
 & 
MALLOCX_ZERO
;

2420 
	`as£¹
(
±r
 !ğ
NULL
);

2421 
	`as£¹
(
size
 != 0);

2422 
	`as£¹
(
SIZE_T_MAX
 - 
size
 >ğ
exŒa
);

2423 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2424 
	`m®loc_th»ad_š™
();

2425 
tsd
 = 
	`tsd_ãtch
();

2426 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2428 
Şd_usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
cÚfig_´of
);

2439 ià(
	`uÆik–y
(
size
 > 
HUGE_MAXCLASS
)) {

2440 
usize
 = 
Şd_usize
;

2441 
Ïb–_nÙ_»sized
;

2443 ià(
	`uÆik–y
(
HUGE_MAXCLASS
 - 
size
 < 
exŒa
))

2444 
exŒa
 = 
HUGE_MAXCLASS
 - 
size
;

2446 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))

2447 
Şd_rzsize
 = 
	`u2rz
(
Şd_usize
);

2449 ià(
cÚfig_´of
 && 
İt_´of
) {

2450 
usize
 = 
	`ix®locx_´of
(
tsd
, 
±r
, 
Şd_usize
, 
size
, 
exŒa
,

2451 
®ignm’t
, 
z”o
);

2453 
usize
 = 
	`ix®locx_h–³r
(
	`tsd_tsdn
(
tsd
), 
±r
, 
Şd_usize
, 
size
,

2454 
exŒa
, 
®ignm’t
, 
z”o
);

2456 ià(
	`uÆik–y
(
usize
 =ğ
Şd_usize
))

2457 
Ïb–_nÙ_»sized
;

2459 ià(
cÚfig_¡©s
) {

2460 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

2461 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
Şd_usize
;

2463 
	`JEMALLOC_VALGRIND_REALLOC
(
çl£
, 
	`tsd_tsdn
(
tsd
), 
±r
, 
usize
, false,…tr,

2464 
Şd_usize
, 
Şd_rzsize
, 
çl£
, 
z”o
);

2465 
Ïb–_nÙ_»sized
:

2466 
	`UTRACE
(
±r
, 
size
,…tr);

2467 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2468  (
usize
);

2469 
	}
}

2471 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW


2472 
	$JEMALLOC_ATTR
(
pu»
)

2473 
	$je_§Îocx
(cÚ¡ *
±r
, 
æags
)

2475 
size_t
 
usize
;

2476 
tsdn_t
 *
tsdn
;

2478 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2479 
	`m®loc_th»ad_š™
();

2481 
tsdn
 = 
	`tsdn_ãtch
();

2482 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2484 ià(
cÚfig_iv§Îoc
)

2485 
usize
 = 
	`iv§Îoc
(
tsdn
, 
±r
, 
cÚfig_´of
);

2487 
usize
 = 
	`i§Îoc
(
tsdn
, 
±r
, 
cÚfig_´of
);

2489 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2490  (
usize
);

2491 
	}
}

2493 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2494 
	$je_d®locx
(*
±r
, 
æags
)

2496 
tsd_t
 *
tsd
;

2497 
tÿche_t
 *
tÿche
;

2499 
	`as£¹
(
±r
 !ğ
NULL
);

2500 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2502 
tsd
 = 
	`tsd_ãtch
();

2503 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2504 ià(
	`uÆik–y
((
æags
 & 
MALLOCX_TCACHE_MASK
) != 0)) {

2505 ià((
æags
 & 
MALLOCX_TCACHE_MASK
è=ğ
MALLOCX_TCACHE_NONE
)

2506 
tÿche
 = 
NULL
;

2508 
tÿche
 = 
	`tÿches_g‘
(
tsd
, 
	`MALLOCX_TCACHE_GET
(
æags
));

2510 
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
çl£
);

2512 
	`UTRACE
(
±r
, 0, 0);

2513 ià(
	`lik–y
(!
m®loc_¦ow
))

2514 
	`iä“
(
tsd
, 
±r
, 
tÿche
, 
çl£
);

2516 
	`iä“
(
tsd
, 
±r
, 
tÿche
, 
Œue
);

2517 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2518 
	}
}

2520 
JEMALLOC_ALWAYS_INLINE_C
 
size_t


2521 
	$š®locx
(
tsdn_t
 *
tsdn
, 
size_t
 
size
, 
æags
)

2523 
size_t
 
usize
;

2525 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2527 ià(
	`lik–y
((
æags
 & 
MALLOCX_LG_ALIGN_MASK
) == 0))

2528 
usize
 = 
	`s2u
(
size
);

2530 
usize
 = 
	`§2u
(
size
, 
	`MALLOCX_ALIGN_GET_SPECIFIED
(
æags
));

2531 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2532  (
usize
);

2533 
	}
}

2535 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2536 
	$je_sd®locx
(*
±r
, 
size_t
 
size
, 
æags
)

2538 
tsd_t
 *
tsd
;

2539 
tÿche_t
 *
tÿche
;

2540 
size_t
 
usize
;

2542 
	`as£¹
(
±r
 !ğ
NULL
);

2543 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2544 
tsd
 = 
	`tsd_ãtch
();

2545 
usize
 = 
	`š®locx
(
	`tsd_tsdn
(
tsd
), 
size
, 
æags
);

2546 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
cÚfig_´of
));

2548 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2549 ià(
	`uÆik–y
((
æags
 & 
MALLOCX_TCACHE_MASK
) != 0)) {

2550 ià((
æags
 & 
MALLOCX_TCACHE_MASK
è=ğ
MALLOCX_TCACHE_NONE
)

2551 
tÿche
 = 
NULL
;

2553 
tÿche
 = 
	`tÿches_g‘
(
tsd
, 
	`MALLOCX_TCACHE_GET
(
æags
));

2555 
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
çl£
);

2557 
	`UTRACE
(
±r
, 0, 0);

2558 ià(
	`lik–y
(!
m®loc_¦ow
))

2559 
	`isä“
(
tsd
, 
±r
, 
usize
, 
tÿche
, 
çl£
);

2561 
	`isä“
(
tsd
, 
±r
, 
usize
, 
tÿche
, 
Œue
);

2562 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2563 
	}
}

2565 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW


2566 
	$JEMALLOC_ATTR
(
pu»
)

2567 
	$je_ÇÎocx
(
size_t
 
size
, 
æags
)

2569 
size_t
 
usize
;

2570 
tsdn_t
 *
tsdn
;

2572 
	`as£¹
(
size
 != 0);

2574 ià(
	`uÆik–y
(
	`m®loc_š™
()))

2577 
tsdn
 = 
	`tsdn_ãtch
();

2578 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2580 
usize
 = 
	`š®locx
(
tsdn
, 
size
, 
æags
);

2581 ià(
	`uÆik–y
(
usize
 > 
HUGE_MAXCLASS
))

2584 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2585  (
usize
);

2586 
	}
}

2588 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2589 
	$je_m®lùl
(cÚ¡ *
Çme
, *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
,

2590 
size_t
 
ÃwËn
)

2592 
»t
;

2593 
tsd_t
 *
tsd
;

2595 ià(
	`uÆik–y
(
	`m®loc_š™
()))

2596  (
EAGAIN
);

2598 
tsd
 = 
	`tsd_ãtch
();

2599 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2600 
»t
 = 
	`ùl_byÇme
(
tsd
, 
Çme
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
);

2601 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2602  (
»t
);

2603 
	}
}

2605 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2606 
	$je_m®lùÊam‘omib
(cÚ¡ *
Çme
, 
size_t
 *
mibp
, size_ˆ*
mibËÅ
)

2608 
»t
;

2609 
tsdn_t
 *
tsdn
;

2611 ià(
	`uÆik–y
(
	`m®loc_š™
()))

2612  (
EAGAIN
);

2614 
tsdn
 = 
	`tsdn_ãtch
();

2615 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2616 
»t
 = 
	`ùl_Çm‘omib
(
tsdn
, 
Çme
, 
mibp
, 
mibËÅ
);

2617 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2618  (
»t
);

2619 
	}
}

2621 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2622 
	$je_m®lùlbymib
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

2623 *
Ãwp
, 
size_t
 
ÃwËn
)

2625 
»t
;

2626 
tsd_t
 *
tsd
;

2628 ià(
	`uÆik–y
(
	`m®loc_š™
()))

2629  (
EAGAIN
);

2631 
tsd
 = 
	`tsd_ãtch
();

2632 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2633 
»t
 = 
	`ùl_bymib
(
tsd
, 
mib
, 
mibËn
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
);

2634 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

2635  (
»t
);

2636 
	}
}

2638 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2639 
	$je_m®loc_¡©s_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

2640 cÚ¡ *
İts
)

2642 
tsdn_t
 *
tsdn
;

2644 
tsdn
 = 
	`tsdn_ãtch
();

2645 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2646 
	`¡©s_´št
(
wr™e_cb
, 
cbİaque
, 
İts
);

2647 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2648 
	}
}

2650 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW


2651 
	$je_m®loc_u§bË_size
(
JEMALLOC_USABLE_SIZE_CONST
 *
±r
)

2653 
size_t
 
»t
;

2654 
tsdn_t
 *
tsdn
;

2656 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2657 
	`m®loc_th»ad_š™
();

2659 
tsdn
 = 
	`tsdn_ãtch
();

2660 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2662 ià(
cÚfig_iv§Îoc
)

2663 
»t
 = 
	`iv§Îoc
(
tsdn
, 
±r
, 
cÚfig_´of
);

2665 
»t
 = (
±r
 =ğ
NULL
è? 0 : 
	`i§Îoc
(
tsdn
,…Œ, 
cÚfig_´of
);

2667 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

2668  (
»t
);

2669 
	}
}

2693 #iâdeà
JEMALLOC_JET


2694 
	$JEMALLOC_ATTR
(
cÚ¡ruùÜ
)

2696 
	$jem®loc_cÚ¡ruùÜ
()

2699 
	`m®loc_š™
();

2700 
	}
}

2703 #iâdeà
JEMALLOC_MUTEX_INIT_CB


2705 
	$jem®loc_´efÜk
()

2707 
JEMALLOC_EXPORT
 

2708 
	$_m®loc_´efÜk
()

2711 
tsd_t
 *
tsd
;

2712 
i
, 
j
, 
Ç»Çs
;

2713 
¬’a_t
 *
¬’a
;

2715 #ifdeà
JEMALLOC_MUTEX_INIT_CB


2716 ià(!
	`m®loc_š™Ÿlized
())

2719 
	`as£¹
(
	`m®loc_š™Ÿlized
());

2721 
tsd
 = 
	`tsd_ãtch
();

2723 
Ç»Çs
 = 
	`Ç»Çs_tÙ®_g‘
();

2725 
	`w™Ãss_´efÜk
(
tsd
);

2727 
	`ùl_´efÜk
(
	`tsd_tsdn
(
tsd
));

2728 
	`m®loc_mu‹x_´efÜk
(
	`tsd_tsdn
(
tsd
), &
¬’as_lock
);

2729 
	`´of_´efÜk0
(
	`tsd_tsdn
(
tsd
));

2730 
i
 = 0; i < 3; i++) {

2731 
j
 = 0; j < 
Ç»Çs
; j++) {

2732 ià((
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
j
, 
çl£
)) !=

2733 
NULL
) {

2734 
i
) {

2736 
	`¬’a_´efÜk0
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

2739 
	`¬’a_´efÜk1
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

2742 
	`¬’a_´efÜk2
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

2744 : 
	`nÙ_»ached
();

2749 
	`ba£_´efÜk
(
	`tsd_tsdn
(
tsd
));

2750 
	`chunk_´efÜk
(
	`tsd_tsdn
(
tsd
));

2751 
i
 = 0; i < 
Ç»Çs
; i++) {

2752 ià((
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
i
, 
çl£
)è!ğ
NULL
)

2753 
	`¬’a_´efÜk3
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

2755 
	`´of_´efÜk1
(
	`tsd_tsdn
(
tsd
));

2756 
	}
}

2758 #iâdeà
JEMALLOC_MUTEX_INIT_CB


2760 
	$jem®loc_po¡fÜk_·»Á
()

2762 
JEMALLOC_EXPORT
 

2763 
	$_m®loc_po¡fÜk
()

2766 
tsd_t
 *
tsd
;

2767 
i
, 
Ç»Çs
;

2769 #ifdeà
JEMALLOC_MUTEX_INIT_CB


2770 ià(!
	`m®loc_š™Ÿlized
())

2773 
	`as£¹
(
	`m®loc_š™Ÿlized
());

2775 
tsd
 = 
	`tsd_ãtch
();

2777 
	`w™Ãss_po¡fÜk_·»Á
(
tsd
);

2779 
	`chunk_po¡fÜk_·»Á
(
	`tsd_tsdn
(
tsd
));

2780 
	`ba£_po¡fÜk_·»Á
(
	`tsd_tsdn
(
tsd
));

2781 
i
 = 0, 
Ç»Çs
 = 
	`Ç»Çs_tÙ®_g‘
(); i <‚arenas; i++) {

2782 
¬’a_t
 *
¬’a
;

2784 ià((
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
i
, 
çl£
)è!ğ
NULL
)

2785 
	`¬’a_po¡fÜk_·»Á
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

2787 
	`´of_po¡fÜk_·»Á
(
	`tsd_tsdn
(
tsd
));

2788 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
	`tsd_tsdn
(
tsd
), &
¬’as_lock
);

2789 
	`ùl_po¡fÜk_·»Á
(
	`tsd_tsdn
(
tsd
));

2790 
	}
}

2793 
	$jem®loc_po¡fÜk_chd
()

2795 
tsd_t
 *
tsd
;

2796 
i
, 
Ç»Çs
;

2798 
	`as£¹
(
	`m®loc_š™Ÿlized
());

2800 
tsd
 = 
	`tsd_ãtch
();

2802 
	`w™Ãss_po¡fÜk_chd
(
tsd
);

2804 
	`chunk_po¡fÜk_chd
(
	`tsd_tsdn
(
tsd
));

2805 
	`ba£_po¡fÜk_chd
(
	`tsd_tsdn
(
tsd
));

2806 
i
 = 0, 
Ç»Çs
 = 
	`Ç»Çs_tÙ®_g‘
(); i <‚arenas; i++) {

2807 
¬’a_t
 *
¬’a
;

2809 ià((
¬’a
 = 
	`¬’a_g‘
(
	`tsd_tsdn
(
tsd
), 
i
, 
çl£
)è!ğ
NULL
)

2810 
	`¬’a_po¡fÜk_chd
(
	`tsd_tsdn
(
tsd
), 
¬’a
);

2812 
	`´of_po¡fÜk_chd
(
	`tsd_tsdn
(
tsd
));

2813 
	`m®loc_mu‹x_po¡fÜk_chd
(
	`tsd_tsdn
(
tsd
), &
¬’as_lock
);

2814 
	`ùl_po¡fÜk_chd
(
	`tsd_tsdn
(
tsd
));

2815 
	}
}

	@dep/jemalloc-4.2.0/src/mb.c

1 
	#JEMALLOC_MB_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

	@dep/jemalloc-4.2.0/src/mutex.c

1 
	#JEMALLOC_MUTEX_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

4 #ià
defšed
(
JEMALLOC_LAZY_LOCK
è&& !defšed(
_WIN32
)

5 
	~<dlfú.h
>

8 #iâdeà
_CRT_SPINCOUNT


9 
	#_CRT_SPINCOUNT
 4000

	)

15 #ifdeà
JEMALLOC_LAZY_LOCK


16 
boŞ
 
	gi¡h»aded
 = 
çl£
;

18 #ifdeà
JEMALLOC_MUTEX_INIT_CB


19 
boŞ
 
	gpo¡pÚe_š™
 = 
Œue
;

20 
m®loc_mu‹x_t
 *
	gpo¡pÚed_mu‹xes
 = 
NULL
;

23 #ià
defšed
(
JEMALLOC_LAZY_LOCK
è&& !defšed(
_WIN32
)

24 
±h»ad_ü—‹_Úû
();

33 #ià
defšed
(
JEMALLOC_LAZY_LOCK
è&& !defšed(
_WIN32
)

34 (*
±h»ad_ü—‹_åŒ
)(
±h»ad_t
 *
__»¡riù
, cÚ¡ 
±h»ad_©Œ_t
 *,

35 *(*)(*), *
__»¡riù
);

38 
	$±h»ad_ü—‹_Úû
()

41 
±h»ad_ü—‹_åŒ
 = 
	`dlsym
(
RTLD_NEXT
, "pthread_create");

42 ià(
±h»ad_ü—‹_åŒ
 =ğ
NULL
) {

43 
	`m®loc_wr™e
("<jemalloc>: Error in dlsym(RTLD_NEXT, "

45 
	`abÜt
();

48 
i¡h»aded
 = 
Œue
;

49 
	}
}

51 
JEMALLOC_EXPORT
 

52 
	$±h»ad_ü—‹
(
±h»ad_t
 *
__»¡riù
 
th»ad
,

53 cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
©Œ
, *(*
¡¬t_routše
)(*),

54 *
__»¡riù
 
¬g
)

56 
±h»ad_Úû_t
 
Úû_cÚŒŞ
 = 
PTHREAD_ONCE_INIT
;

58 
	`±h»ad_Úû
(&
Úû_cÚŒŞ
, 
±h»ad_ü—‹_Úû
);

60  (
	`±h»ad_ü—‹_åŒ
(
th»ad
, 
©Œ
, 
¡¬t_routše
, 
¬g
));

61 
	}
}

66 #ifdeà
JEMALLOC_MUTEX_INIT_CB


67 
JEMALLOC_EXPORT
 
_±h»ad_mu‹x_š™_ÿÎoc_cb
(
±h»ad_mu‹x_t
 *
mu‹x
,

68 *(
ÿÎoc_cb
)(
size_t
, size_t));

71 
boŞ


72 
	$m®loc_mu‹x_š™
(
m®loc_mu‹x_t
 *
mu‹x
, cÚ¡ *
Çme
, 
w™Ãss_¿nk_t
 
¿nk
)

75 #ifdeà
_WIN32


76 #ià
_WIN32_WINNT
 >= 0x0600

77 
	`In™ŸlizeSRWLock
(&
mu‹x
->
lock
);

79 ià(!
	`In™ŸlizeCr™iÿlSeùiÚAndSpšCouÁ
(&
mu‹x
->
lock
,

80 
_CRT_SPINCOUNT
))

81  (
Œue
);

83 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

84 
mu‹x
->
lock
 = 0;

85 #–ià(
	`defšed
(
JEMALLOC_MUTEX_INIT_CB
))

86 ià(
po¡pÚe_š™
) {

87 
mu‹x
->
po¡pÚed_Ãxt
 = 
po¡pÚed_mu‹xes
;

88 
po¡pÚed_mu‹xes
 = 
mu‹x
;

90 ià(
	`_±h»ad_mu‹x_š™_ÿÎoc_cb
(&
mu‹x
->
lock
,

91 
boÙ¡¿p_ÿÎoc
) != 0)

92  (
Œue
);

95 
±h»ad_mu‹x©Œ_t
 
©Œ
;

97 ià(
	`±h»ad_mu‹x©Œ_š™
(&
©Œ
) != 0)

98  (
Œue
);

99 
	`±h»ad_mu‹x©Œ_£‰y³
(&
©Œ
, 
MALLOC_MUTEX_TYPE
);

100 ià(
	`±h»ad_mu‹x_š™
(&
mu‹x
->
lock
, &
©Œ
) != 0) {

101 
	`±h»ad_mu‹x©Œ_de¡roy
(&
©Œ
);

102  (
Œue
);

104 
	`±h»ad_mu‹x©Œ_de¡roy
(&
©Œ
);

106 ià(
cÚfig_debug
)

107 
	`w™Ãss_š™
(&
mu‹x
->
w™Ãss
, 
Çme
, 
¿nk
, 
NULL
);

108  (
çl£
);

109 
	}
}

112 
	$m®loc_mu‹x_´efÜk
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
)

115 
	`m®loc_mu‹x_lock
(
tsdn
, 
mu‹x
);

116 
	}
}

119 
	$m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
)

122 
	`m®loc_mu‹x_uÆock
(
tsdn
, 
mu‹x
);

123 
	}
}

126 
	$m®loc_mu‹x_po¡fÜk_chd
(
tsdn_t
 *
tsdn
, 
m®loc_mu‹x_t
 *
mu‹x
)

129 #ifdeà
JEMALLOC_MUTEX_INIT_CB


130 
	`m®loc_mu‹x_uÆock
(
tsdn
, 
mu‹x
);

132 ià(
	`m®loc_mu‹x_š™
(
mu‹x
, mu‹x->
w™Ãss
.
Çme
,

133 
mu‹x
->
w™Ãss
.
¿nk
)) {

134 
	`m®loc_´štf
("<jemalloc>: Error„e-initializing mutex in "

136 ià(
İt_abÜt
)

137 
	`abÜt
();

140 
	}
}

142 
boŞ


143 
	$m®loc_mu‹x_boÙ
()

146 #ifdeà
JEMALLOC_MUTEX_INIT_CB


147 
po¡pÚe_š™
 = 
çl£
;

148 
po¡pÚed_mu‹xes
 !ğ
NULL
) {

149 ià(
	`_±h»ad_mu‹x_š™_ÿÎoc_cb
(&
po¡pÚed_mu‹xes
->
lock
,

150 
boÙ¡¿p_ÿÎoc
) != 0)

151  (
Œue
);

152 
po¡pÚed_mu‹xes
 =…o¡pÚed_mu‹xes->
po¡pÚed_Ãxt
;

155  (
çl£
);

156 
	}
}

	@dep/jemalloc-4.2.0/src/nstime.c

1 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

3 
	#BILLION
 
	`UINT64_C
(1000000000)

	)

6 
	$n¡ime_š™
(
n¡ime_t
 *
time
, 
ušt64_t
 
ns
)

9 
time
->
ns
 =‚s;

10 
	}
}

13 
	$n¡ime_š™2
(
n¡ime_t
 *
time
, 
ušt64_t
 
£c
, ušt64_ˆ
n£c
)

16 
time
->
ns
 = 
£c
 * 
BILLION
 + 
n£c
;

17 
	}
}

19 
ušt64_t


20 
	$n¡ime_ns
(cÚ¡ 
n¡ime_t
 *
time
)

23  (
time
->
ns
);

24 
	}
}

26 
ušt64_t


27 
	$n¡ime_£c
(cÚ¡ 
n¡ime_t
 *
time
)

30  (
time
->
ns
 / 
BILLION
);

31 
	}
}

33 
ušt64_t


34 
	$n¡ime_n£c
(cÚ¡ 
n¡ime_t
 *
time
)

37  (
time
->
ns
 % 
BILLION
);

38 
	}
}

41 
	$n¡ime_cİy
(
n¡ime_t
 *
time
, cÚ¡‚¡ime_ˆ*
sourû
)

44 *
time
 = *
sourû
;

45 
	}
}

48 
	$n¡ime_com·»
(cÚ¡ 
n¡ime_t
 *
a
, cÚ¡‚¡ime_ˆ*
b
)

51  ((
a
->
ns
 > 
b
->ns) - (a->ns < b->ns));

52 
	}
}

55 
	$n¡ime_add
(
n¡ime_t
 *
time
, cÚ¡‚¡ime_ˆ*
add’d
)

58 
	`as£¹
(
UINT64_MAX
 - 
time
->
ns
 >ğ
add’d
->ns);

60 
time
->
ns
 +ğ
add’d
->ns;

61 
	}
}

64 
	$n¡ime_subŒaù
(
n¡ime_t
 *
time
, cÚ¡‚¡ime_ˆ*
subŒah’d
)

67 
	`as£¹
(
	`n¡ime_com·»
(
time
, 
subŒah’d
) >= 0);

69 
time
->
ns
 -ğ
subŒah’d
->ns;

70 
	}
}

73 
	$n¡ime_imuÉly
(
n¡ime_t
 *
time
, 
ušt64_t
 
muÉl›r
)

76 
	`as£¹
((((
time
->
ns
 | 
muÉl›r
è& (
UINT64_MAX
 << ((
ušt64_t
) <<

77 2))è=ğ0è|| ((
time
->
ns
 * 
muÉl›r
) / multiplier ==ime->ns));

79 
time
->
ns
 *ğ
muÉl›r
;

80 
	}
}

83 
	$n¡ime_idivide
(
n¡ime_t
 *
time
, 
ušt64_t
 
divisÜ
)

86 
	`as£¹
(
divisÜ
 != 0);

88 
time
->
ns
 /ğ
divisÜ
;

89 
	}
}

91 
ušt64_t


92 
	$n¡ime_divide
(cÚ¡ 
n¡ime_t
 *
time
, cÚ¡‚¡ime_ˆ*
divisÜ
)

95 
	`as£¹
(
divisÜ
->
ns
 != 0);

97  (
time
->
ns
 / 
divisÜ
->ns);

98 
	}
}

100 #ifdeà
JEMALLOC_JET


101 #undeà
n¡ime_upd©e


102 
	#n¡ime_upd©e
 
	`JEMALLOC_N
(
n_n¡ime_upd©e
)

	)

104 
boŞ


105 
	$n¡ime_upd©e
(
n¡ime_t
 *
time
)

107 
n¡ime_t
 
Şd_time
;

109 
	`n¡ime_cİy
(&
Şd_time
, 
time
);

111 #ifdeà
_WIN32


113 
FILETIME
 
á
;

114 
ušt64_t
 
ticks
;

115 
	`G‘Sy¡emTimeAsFeTime
(&
á
);

116 
ticks
 = (((
ušt64_t
)
á
.
dwHighD©eTime
) << 32) |

117 
á
.
dwLowD©eTime
;

118 
time
->
ns
 = 
ticks
 * 100;

120 #–ià
JEMALLOC_CLOCK_GETTIME


122 
time¥ec
 
ts
;

124 ià(
	`syscÚf
(
_SC_MONOTONIC_CLOCK
) > 0)

125 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
ts
);

127 
	`şock_g‘time
(
CLOCK_REALTIME
, &
ts
);

128 
time
->
ns
 = 
ts
.
tv_£c
 * 
BILLION
 +s.
tv_n£c
;

131 
timev®
 
tv
;

132 
	`g‘timeofday
(&
tv
, 
NULL
);

133 
time
->
ns
 = 
tv
.
tv_£c
 * 
BILLION
 +v.
tv_u£c
 * 1000;

137 ià(
	`uÆik–y
(
	`n¡ime_com·»
(&
Şd_time
, 
time
) > 0)) {

138 
	`n¡ime_cİy
(
time
, &
Şd_time
);

139  (
Œue
);

142  (
çl£
);

143 
	}
}

144 #ifdeà
JEMALLOC_JET


145 #undeà
n¡ime_upd©e


146 
	#n¡ime_upd©e
 
	`JEMALLOC_N
(
n¡ime_upd©e
)

	)

147 
n¡ime_upd©e_t
 *
	gn¡ime_upd©e
 = 
JEMALLOC_N
(
n_n¡ime_upd©e
);

	@dep/jemalloc-4.2.0/src/pages.c

1 
	#JEMALLOC_PAGES_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

4 #ifdeà
JEMALLOC_SYSCTL_VM_OVERCOMMIT


5 
	~<sys/sysùl.h
>

11 #iâdeà
_WIN32


12 
	#PAGES_PROT_COMMIT
 (
PROT_READ
 | 
PROT_WRITE
)

	)

13 
	#PAGES_PROT_DECOMMIT
 (
PROT_NONE
)

	)

14 
	gmm­_æags
;

16 
boŞ
 
	gos_ov”comm™s
;

21 
	$·ges_m­
(*
addr
, 
size_t
 
size
, 
boŞ
 *
comm™
)

23 *
»t
;

25 
	`as£¹
(
size
 != 0);

27 ià(
os_ov”comm™s
)

28 *
comm™
 = 
Œue
;

30 #ifdeà
_WIN32


35 
»t
 = 
	`Vœtu®AÎoc
(
addr
, 
size
, 
MEM_RESERVE
 | (*
comm™
 ? 
MEM_COMMIT
 : 0),

36 
PAGE_READWRITE
);

43 
´Ù
 = *
comm™
 ? 
PAGES_PROT_COMMIT
 : 
PAGES_PROT_DECOMMIT
;

45 
»t
 = 
	`mm­
(
addr
, 
size
, 
´Ù
, 
mm­_æags
, -1, 0);

47 
	`as£¹
(
»t
 !ğ
NULL
);

49 ià(
»t
 =ğ
MAP_FAILED
)

50 
»t
 = 
NULL
;

51 ià(
addr
 !ğ
NULL
 && 
»t
 !=‡ddr) {

55 
	`·ges_unm­
(
»t
, 
size
);

56 
»t
 = 
NULL
;

59 
	`as£¹
(
»t
 =ğ
NULL
 || (
addr
 == NULL &&„et !=‡ddr)

60 || (
addr
 !ğ
NULL
 && 
»t
 ==‡ddr));

61  (
»t
);

62 
	}
}

65 
	$·ges_unm­
(*
addr
, 
size_t
 
size
)

68 #ifdeà
_WIN32


69 ià(
	`Vœtu®F»e
(
addr
, 0, 
MEM_RELEASE
) == 0)

71 ià(
	`munm­
(
addr
, 
size
) == -1)

74 
buf
[
BUFERROR_BUF
];

76 
	`buã¼Ü
(
	`g‘_”ºo
(), 
buf
, (buf));

77 
	`m®loc_´štf
("<jemalloc>: Error in "

78 #ifdeà
_WIN32


83 "(): %s\n", 
buf
);

84 ià(
İt_abÜt
)

85 
	`abÜt
();

87 
	}
}

90 
	$·ges_Œim
(*
addr
, 
size_t
 
®loc_size
, size_ˆ
Ëadsize
, size_ˆ
size
,

91 
boŞ
 *
comm™
)

93 *
»t
 = (*)((
ušŒ_t
)
addr
 + 
Ëadsize
);

95 
	`as£¹
(
®loc_size
 >ğ
Ëadsize
 + 
size
);

96 #ifdeà
_WIN32


98 *
Ãw_addr
;

100 
	`·ges_unm­
(
addr
, 
®loc_size
);

101 
Ãw_addr
 = 
	`·ges_m­
(
»t
, 
size
, 
comm™
);

102 ià(
Ãw_addr
 =ğ
»t
)

103  (
»t
);

104 ià(
Ãw_addr
)

105 
	`·ges_unm­
(
Ãw_addr
, 
size
);

106  (
NULL
);

110 
size_t
 
Œasize
 = 
®loc_size
 - 
Ëadsize
 - 
size
;

112 ià(
Ëadsize
 != 0)

113 
	`·ges_unm­
(
addr
, 
Ëadsize
);

114 ià(
Œasize
 != 0)

115 
	`·ges_unm­
((*)((
ušŒ_t
)
»t
 + 
size
), 
Œasize
);

116  (
»t
);

119 
	}
}

121 
boŞ


122 
	$·ges_comm™_im¶
(*
addr
, 
size_t
 
size
, 
boŞ
 
comm™
)

125 ià(
os_ov”comm™s
)

126  (
Œue
);

128 #ifdeà
_WIN32


129  (
comm™
 ? (
addr
 !ğ
	`Vœtu®AÎoc
×ddr, 
size
, 
MEM_COMMIT
,

130 
PAGE_READWRITE
)è: (!
	`Vœtu®F»e
(
addr
, 
size
, 
MEM_DECOMMIT
)));

133 
´Ù
 = 
comm™
 ? 
PAGES_PROT_COMMIT
 : 
PAGES_PROT_DECOMMIT
;

134 *
»suÉ
 = 
	`mm­
(
addr
, 
size
, 
´Ù
, 
mm­_æags
 | 
MAP_FIXED
,

136 ià(
»suÉ
 =ğ
MAP_FAILED
)

137  (
Œue
);

138 ià(
»suÉ
 !ğ
addr
) {

143 
	`·ges_unm­
(
»suÉ
, 
size
);

144  (
Œue
);

146  (
çl£
);

149 
	}
}

151 
boŞ


152 
	$·ges_comm™
(*
addr
, 
size_t
 
size
)

155  (
	`·ges_comm™_im¶
(
addr
, 
size
, 
Œue
));

156 
	}
}

158 
boŞ


159 
	$·ges_decomm™
(*
addr
, 
size_t
 
size
)

162  (
	`·ges_comm™_im¶
(
addr
, 
size
, 
çl£
));

163 
	}
}

165 
boŞ


166 
	$·ges_purge
(*
addr
, 
size_t
 
size
)

168 
boŞ
 
unz”Ûd
;

170 #ifdeà
_WIN32


171 
	`Vœtu®AÎoc
(
addr
, 
size
, 
MEM_RESET
, 
PAGE_READWRITE
);

172 
unz”Ûd
 = 
Œue
;

173 #–ià
	`defšed
(
JEMALLOC_HAVE_MADVISE
)

174 #ifdeà
JEMALLOC_PURGE_MADVISE_DONTNEED


175 
	#JEMALLOC_MADV_PURGE
 
MADV_DONTNEED


	)

176 
	#JEMALLOC_MADV_ZEROS
 
Œue


	)

177 #–ià
	`defšed
(
JEMALLOC_PURGE_MADVISE_FREE
)

178 
	#JEMALLOC_MADV_PURGE
 
MADV_FREE


	)

179 
	#JEMALLOC_MADV_ZEROS
 
çl£


	)

183 
”r
 = 
	`madvi£
(
addr
, 
size
, 
JEMALLOC_MADV_PURGE
);

184 
unz”Ûd
 = (!
JEMALLOC_MADV_ZEROS
 || 
”r
 != 0);

185 #undeà
JEMALLOC_MADV_PURGE


186 #undeà
JEMALLOC_MADV_ZEROS


189 
unz”Ûd
 = 
Œue
;

191  (
unz”Ûd
);

192 
	}
}

194 #ifdeà
JEMALLOC_SYSCTL_VM_OVERCOMMIT


195 
boŞ


196 
	$os_ov”comm™s_sysùl
()

198 
vm_ov”comm™
;

199 
size_t
 
sz
;

201 
sz
 = (
vm_ov”comm™
);

202 ià(
	`sysùlbyÇme
("vm.ov”comm™", &
vm_ov”comm™
, &
sz
, 
NULL
, 0) != 0)

203  (
çl£
);

205  ((
vm_ov”comm™
 & 0x3) == 0);

206 
	}
}

209 #ifdeà
JEMALLOC_PROC_SYS_VM_OVERCOMMIT_MEMORY


210 
boŞ


211 
	$os_ov”comm™s_´oc
()

213 
fd
;

214 
buf
[1];

215 
ssize_t
 
Ä—d
;

217 
fd
 = 
	`İ’
("/´oc/sys/vm/ov”comm™_memÜy", 
O_RDONLY
);

218 ià(
fd
 == -1)

219  (
çl£
);

221 
Ä—d
 = 
	`»ad
(
fd
, &
buf
, (buf));

222 ià(
Ä—d
 < 1)

223  (
çl£
);

230  (
buf
[0] == '0' || buf[0] == '1');

231 
	}
}

235 
	$·ges_boÙ
()

238 #iâdeà
_WIN32


239 
mm­_æags
 = 
MAP_PRIVATE
 | 
MAP_ANON
;

242 #ifdeà
JEMALLOC_SYSCTL_VM_OVERCOMMIT


243 
os_ov”comm™s
 = 
	`os_ov”comm™s_sysùl
();

244 #–ià
	`defšed
(
JEMALLOC_PROC_SYS_VM_OVERCOMMIT_MEMORY
)

245 
os_ov”comm™s
 = 
	`os_ov”comm™s_´oc
();

246 #ifdeà
MAP_NORESERVE


247 ià(
os_ov”comm™s
)

248 
mm­_æags
 |ğ
MAP_NORESERVE
;

251 
os_ov”comm™s
 = 
çl£
;

253 
	}
}

	@dep/jemalloc-4.2.0/src/prng.c

1 
	#JEMALLOC_PRNG_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

	@dep/jemalloc-4.2.0/src/prof.c

1 
	#JEMALLOC_PROF_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

5 #ifdeà
JEMALLOC_PROF_LIBUNWIND


6 
	#UNW_LOCAL_ONLY


	)

7 
	~<libunwšd.h
>

10 #ifdeà
JEMALLOC_PROF_LIBGCC


11 
	~<unwšd.h
>

17 
boŞ
 
	gİt_´of
 = 
çl£
;

18 
boŞ
 
	gİt_´of_aùive
 = 
Œue
;

19 
boŞ
 
	gİt_´of_th»ad_aùive_š™
 = 
Œue
;

20 
size_t
 
	gİt_lg_´of_§m¶e
 = 
LG_PROF_SAMPLE_DEFAULT
;

21 
ssize_t
 
	gİt_lg_´of_š‹rv®
 = 
LG_PROF_INTERVAL_DEFAULT
;

22 
boŞ
 
	gİt_´of_gdump
 = 
çl£
;

23 
boŞ
 
	gİt_´of_fš®
 = 
çl£
;

24 
boŞ
 
	gİt_´of_Ëak
 = 
çl£
;

25 
boŞ
 
	gİt_´of_accum
 = 
çl£
;

26 
	gİt_´of_´efix
[

28 #ifdeà
JEMALLOC_PROF


29 
PATH_MAX
 +

37 
boŞ
 
	g´of_aùive
;

38 
m®loc_mu‹x_t
 
	g´of_aùive_mtx
;

44 
boŞ
 
	g´of_th»ad_aùive_š™
;

45 
m®loc_mu‹x_t
 
	g´of_th»ad_aùive_š™_mtx
;

51 
boŞ
 
	g´of_gdump_v®
;

52 
m®loc_mu‹x_t
 
	g´of_gdump_mtx
;

54 
ušt64_t
 
	g´of_š‹rv®
 = 0;

56 
size_t
 
	glg_´of_§m¶e
;

65 
m®loc_mu‹x_t
 *
	ggùx_locks
;

66 
	gcum_gùxs
;

74 
m®loc_mu‹x_t
 *
	gtd©a_locks
;

80 
ckh_t
 
	gbt2gùx
;

81 
m®loc_mu‹x_t
 
	gbt2gùx_mtx
;

87 
´of_td©a_Œ“_t
 
	gtd©as
;

88 
m®loc_mu‹x_t
 
	gtd©as_mtx
;

90 
ušt64_t
 
	gÃxt_thr_uid
;

91 
m®loc_mu‹x_t
 
	gÃxt_thr_uid_mtx
;

93 
m®loc_mu‹x_t
 
	g´of_dump_£q_mtx
;

94 
ušt64_t
 
	g´of_dump_£q
;

95 
ušt64_t
 
	g´of_dump_i£q
;

96 
ušt64_t
 
	g´of_dump_m£q
;

97 
ušt64_t
 
	g´of_dump_u£q
;

103 
m®loc_mu‹x_t
 
	g´of_dump_mtx
;

104 
	g´of_dump_buf
[

106 #ifdeà
JEMALLOC_PROF


107 
PROF_DUMP_BUFSIZE


112 
size_t
 
	g´of_dump_buf_’d
;

113 
	g´of_dump_fd
;

116 
boŞ
 
	g´of_boÙed
 = 
çl£
;

124 
boŞ
 
´of_tùx_should_de¡roy
(
tsdn_t
 *
tsdn
, 
´of_tùx_t
 *
tùx
);

125 
´of_tùx_de¡roy
(
tsd_t
 *
tsd
, 
´of_tùx_t
 *
tùx
);

126 
boŞ
 
´of_td©a_should_de¡roy
(
tsdn_t
 *
tsdn
, 
´of_td©a_t
 *
td©a
,

127 
boŞ
 
ev’_if_©ched
);

128 
´of_td©a_de¡roy
(
tsdn_t
 *
tsdn
, 
´of_td©a_t
 *
td©a
,

129 
boŞ
 
ev’_if_©ched
);

130 *
´of_th»ad_Çme_®loc
(
tsdn_t
 *
tsdn
, cÚ¡ *
th»ad_Çme
);

135 
JEMALLOC_INLINE_C
 

136 
	$´of_tùx_comp
(cÚ¡ 
´of_tùx_t
 *
a
, cÚ¡…rof_tùx_ˆ*
b
)

138 
ušt64_t
 
a_thr_uid
 = 
a
->
thr_uid
;

139 
ušt64_t
 
b_thr_uid
 = 
b
->
thr_uid
;

140 
»t
 = (
a_thr_uid
 > 
b_thr_uid
) - (a_thr_uid < b_thr_uid);

141 ià(
»t
 == 0) {

142 
ušt64_t
 
a_thr_disüim
 = 
a
->
thr_disüim
;

143 
ušt64_t
 
b_thr_disüim
 = 
b
->
thr_disüim
;

144 
»t
 = (
a_thr_disüim
 > 
b_thr_disüim
) - (a_thr_discrim <

145 
b_thr_disüim
);

146 ià(
»t
 == 0) {

147 
ušt64_t
 
a_tùx_uid
 = 
a
->
tùx_uid
;

148 
ušt64_t
 
b_tùx_uid
 = 
b
->
tùx_uid
;

149 
»t
 = (
a_tùx_uid
 > 
b_tùx_uid
) - (a_tctx_uid <

150 
b_tùx_uid
);

153  (
»t
);

154 
	}
}

156 
	$rb_g’
(
UNUSED
, 
tùx_Œ“_
, 
´of_tùx_Œ“_t
, 
´of_tùx_t
,

157 
tùx_lšk
, 
´of_tùx_comp
)

159 
JEMALLOC_INLINE_C
 

160 
	$´of_gùx_comp
(cÚ¡ 
´of_gùx_t
 *
a
, cÚ¡…rof_gùx_ˆ*
b
)

162 
a_Ën
 = 
a
->
bt
.
Ën
;

163 
b_Ën
 = 
b
->
bt
.
Ën
;

164 
comp_Ën
 = (
a_Ën
 < 
b_Ën
) ?‡_len : b_len;

165 
»t
 = 
	`memcmp
(
a
->
bt
.
vec
, 
b
->bt.vec, 
comp_Ën
 * (*));

166 ià(
»t
 == 0)

167 
»t
 = (
a_Ën
 > 
b_Ën
) - (a_len < b_len);

168  (
»t
);

169 
	}
}

171 
	$rb_g’
(
UNUSED
, 
gùx_Œ“_
, 
´of_gùx_Œ“_t
, 
´of_gùx_t
, 
dump_lšk
,

172 
´of_gùx_comp
)

174 
JEMALLOC_INLINE_C
 

175 
	$´of_td©a_comp
(cÚ¡ 
´of_td©a_t
 *
a
, cÚ¡…rof_td©a_ˆ*
b
)

177 
»t
;

178 
ušt64_t
 
a_uid
 = 
a
->
thr_uid
;

179 
ušt64_t
 
b_uid
 = 
b
->
thr_uid
;

181 
»t
 = ((
a_uid
 > 
b_uid
) - (a_uid < b_uid));

182 ià(
»t
 == 0) {

183 
ušt64_t
 
a_disüim
 = 
a
->
thr_disüim
;

184 
ušt64_t
 
b_disüim
 = 
b
->
thr_disüim
;

186 
»t
 = ((
a_disüim
 > 
b_disüim
) - (a_discrim < b_discrim));

188  (
»t
);

189 
	}
}

191 
	$rb_g’
(
UNUSED
, 
td©a_Œ“_
, 
´of_td©a_Œ“_t
, 
´of_td©a_t
, 
td©a_lšk
,

192 
´of_td©a_comp
)

197 
	$´of_®loc_rŞlback
(
tsd_t
 *
tsd
, 
´of_tùx_t
 *
tùx
, 
boŞ
 
upd©ed
)

199 
´of_td©a_t
 *
td©a
;

201 
	`ÿs£¹
(
cÚfig_´of
);

203 ià(
upd©ed
) {

210 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

211 ià(
td©a
 !ğ
NULL
)

212 
	`´of_§m¶e_th»shŞd_upd©e
(
td©a
);

215 ià((
ušŒ_t
)
tùx
 > (uintptr_t)1U) {

216 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
tùx
->
td©a
->
lock
);

217 
tùx
->
´•¬ed
 = 
çl£
;

218 ià(
	`´of_tùx_should_de¡roy
(
	`tsd_tsdn
(
tsd
), 
tùx
))

219 
	`´of_tùx_de¡roy
(
tsd
, 
tùx
);

221 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
tùx
->
td©a
->
lock
);

223 
	}
}

226 
	$´of_m®loc_§m¶e_objeù
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
, 
size_t
 
usize
,

227 
´of_tùx_t
 *
tùx
)

230 
	`´of_tùx_£t
(
tsdn
, 
±r
, 
usize
, 
tùx
);

232 
	`m®loc_mu‹x_lock
(
tsdn
, 
tùx
->
td©a
->
lock
);

233 
tùx
->
úts
.
curobjs
++;

234 
tùx
->
úts
.
curby‹s
 +ğ
usize
;

235 ià(
İt_´of_accum
) {

236 
tùx
->
úts
.
accumobjs
++;

237 
tùx
->
úts
.
accumby‹s
 +ğ
usize
;

239 
tùx
->
´•¬ed
 = 
çl£
;

240 
	`m®loc_mu‹x_uÆock
(
tsdn
, 
tùx
->
td©a
->
lock
);

241 
	}
}

244 
	$´of_ä“_§m¶ed_objeù
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

247 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
tùx
->
td©a
->
lock
);

248 
	`as£¹
(
tùx
->
úts
.
curobjs
 > 0);

249 
	`as£¹
(
tùx
->
úts
.
curby‹s
 >ğ
usize
);

250 
tùx
->
úts
.
curobjs
--;

251 
tùx
->
úts
.
curby‹s
 -ğ
usize
;

253 ià(
	`´of_tùx_should_de¡roy
(
	`tsd_tsdn
(
tsd
), 
tùx
))

254 
	`´of_tùx_de¡roy
(
tsd
, 
tùx
);

256 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
tùx
->
td©a
->
lock
);

257 
	}
}

260 
	$bt_š™
(
´of_bt_t
 *
bt
, **
vec
)

263 
	`ÿs£¹
(
cÚfig_´of
);

265 
bt
->
vec
 = vec;

266 
bt
->
Ën
 = 0;

267 
	}
}

269 
JEMALLOC_INLINE_C
 

270 
	$´of_’‹r
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
)

273 
	`ÿs£¹
(
cÚfig_´of
);

274 
	`as£¹
(
td©a
 =ğ
	`´of_td©a_g‘
(
tsd
, 
çl£
));

276 ià(
td©a
 !ğ
NULL
) {

277 
	`as£¹
(!
td©a
->
’q
);

278 
td©a
->
’q
 = 
Œue
;

281 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
bt2gùx_mtx
);

282 
	}
}

284 
JEMALLOC_INLINE_C
 

285 
	$´of_Ëave
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
)

288 
	`ÿs£¹
(
cÚfig_´of
);

289 
	`as£¹
(
td©a
 =ğ
	`´of_td©a_g‘
(
tsd
, 
çl£
));

291 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
bt2gùx_mtx
);

293 ià(
td©a
 !ğ
NULL
) {

294 
boŞ
 
idump
, 
gdump
;

296 
	`as£¹
(
td©a
->
’q
);

297 
td©a
->
’q
 = 
çl£
;

298 
idump
 = 
td©a
->
’q_idump
;

299 
td©a
->
’q_idump
 = 
çl£
;

300 
gdump
 = 
td©a
->
’q_gdump
;

301 
td©a
->
’q_gdump
 = 
çl£
;

303 ià(
idump
)

304 
	`´of_idump
(
	`tsd_tsdn
(
tsd
));

305 ià(
gdump
)

306 
	`´of_gdump
(
	`tsd_tsdn
(
tsd
));

308 
	}
}

310 #ifdeà
JEMALLOC_PROF_LIBUNWIND


312 
	$´of_backŒaû
(
´of_bt_t
 *
bt
)

314 
näames
;

316 
	`ÿs£¹
(
cÚfig_´of
);

317 
	`as£¹
(
bt
->
Ën
 == 0);

318 
	`as£¹
(
bt
->
vec
 !ğ
NULL
);

320 
näames
 = 
	`unw_backŒaû
(
bt
->
vec
, 
PROF_BT_MAX
);

321 ià(
näames
 <= 0)

323 
bt
->
Ën
 = 
näames
;

324 
	}
}

325 #–ià(
defšed
(
JEMALLOC_PROF_LIBGCC
))

326 
_Unwšd_R—sÚ_Code


327 
	$´of_unwšd_š™_ÿÎback
(
_Unwšd_CÚ‹xt
 *
cÚ‹xt
, *
¬g
)

330 
	`ÿs£¹
(
cÚfig_´of
);

332  (
_URC_NO_REASON
);

333 
	}
}

335 
_Unwšd_R—sÚ_Code


336 
	$´of_unwšd_ÿÎback
(
_Unwšd_CÚ‹xt
 *
cÚ‹xt
, *
¬g
)

338 
´of_unwšd_d©a_t
 *
d©a
 = (´of_unwšd_d©a_ˆ*)
¬g
;

339 *

;

341 
	`ÿs£¹
(
cÚfig_´of
);

343 

 = (*)
	`_Unwšd_G‘IP
(
cÚ‹xt
);

344 ià(

 =ğ
NULL
)

345  (
_URC_END_OF_STACK
);

346 
d©a
->
bt
->
vec
[d©a->bt->
Ën
] = 

;

347 
d©a
->
bt
->
Ën
++;

348 ià(
d©a
->
bt
->
Ën
 =ğd©a->
max
)

349  (
_URC_END_OF_STACK
);

351  (
_URC_NO_REASON
);

352 
	}
}

355 
	$´of_backŒaû
(
´of_bt_t
 *
bt
)

357 
´of_unwšd_d©a_t
 
d©a
 = {
bt
, 
PROF_BT_MAX
};

359 
	`ÿs£¹
(
cÚfig_´of
);

361 
	`_Unwšd_BackŒaû
(
´of_unwšd_ÿÎback
, &
d©a
);

362 
	}
}

363 #–ià(
defšed
(
JEMALLOC_PROF_GCC
))

365 
	$´of_backŒaû
(
´of_bt_t
 *
bt
)

367 
	#BT_FRAME
(
i
) \

368 ià((
i
è< 
PROF_BT_MAX
) { \

369 *
p
; \

370 ià(
	`__butš_äame_add»ss
(
i
) == 0) \

372 
p
 = 
	`__butš_»tuº_add»ss
(
i
); \

373 ià(
p
 =ğ
NULL
) \

375 
bt
->
vec
[(
i
)] = 
p
; \

376 
bt
->
Ën
 = (
i
) + 1; \

378 ;

	)

380 
	`ÿs£¹
(
cÚfig_´of
);

382 
	`BT_FRAME
(0)

383 
	`BT_FRAME
(1)

384 
	`BT_FRAME
(2)

385 
	`BT_FRAME
(3)

386 
	`BT_FRAME
(4)

387 
	`BT_FRAME
(5)

388 
	`BT_FRAME
(6)

389 
	`BT_FRAME
(7)

390 
	`BT_FRAME
(8)

391 
	`BT_FRAME
(9)

393 
	`BT_FRAME
(10)

394 
	`BT_FRAME
(11)

395 
	`BT_FRAME
(12)

396 
	`BT_FRAME
(13)

397 
	`BT_FRAME
(14)

398 
	`BT_FRAME
(15)

399 
	`BT_FRAME
(16)

400 
	`BT_FRAME
(17)

401 
	`BT_FRAME
(18)

402 
	`BT_FRAME
(19)

404 
	`BT_FRAME
(20)

405 
	`BT_FRAME
(21)

406 
	`BT_FRAME
(22)

407 
	`BT_FRAME
(23)

408 
	`BT_FRAME
(24)

409 
	`BT_FRAME
(25)

410 
	`BT_FRAME
(26)

411 
	`BT_FRAME
(27)

412 
	`BT_FRAME
(28)

413 
	`BT_FRAME
(29)

415 
	`BT_FRAME
(30)

416 
	`BT_FRAME
(31)

417 
	`BT_FRAME
(32)

418 
	`BT_FRAME
(33)

419 
	`BT_FRAME
(34)

420 
	`BT_FRAME
(35)

421 
	`BT_FRAME
(36)

422 
	`BT_FRAME
(37)

423 
	`BT_FRAME
(38)

424 
	`BT_FRAME
(39)

426 
	`BT_FRAME
(40)

427 
	`BT_FRAME
(41)

428 
	`BT_FRAME
(42)

429 
	`BT_FRAME
(43)

430 
	`BT_FRAME
(44)

431 
	`BT_FRAME
(45)

432 
	`BT_FRAME
(46)

433 
	`BT_FRAME
(47)

434 
	`BT_FRAME
(48)

435 
	`BT_FRAME
(49)

437 
	`BT_FRAME
(50)

438 
	`BT_FRAME
(51)

439 
	`BT_FRAME
(52)

440 
	`BT_FRAME
(53)

441 
	`BT_FRAME
(54)

442 
	`BT_FRAME
(55)

443 
	`BT_FRAME
(56)

444 
	`BT_FRAME
(57)

445 
	`BT_FRAME
(58)

446 
	`BT_FRAME
(59)

448 
	`BT_FRAME
(60)

449 
	`BT_FRAME
(61)

450 
	`BT_FRAME
(62)

451 
	`BT_FRAME
(63)

452 
	`BT_FRAME
(64)

453 
	`BT_FRAME
(65)

454 
	`BT_FRAME
(66)

455 
	`BT_FRAME
(67)

456 
	`BT_FRAME
(68)

457 
	`BT_FRAME
(69)

459 
	`BT_FRAME
(70)

460 
	`BT_FRAME
(71)

461 
	`BT_FRAME
(72)

462 
	`BT_FRAME
(73)

463 
	`BT_FRAME
(74)

464 
	`BT_FRAME
(75)

465 
	`BT_FRAME
(76)

466 
	`BT_FRAME
(77)

467 
	`BT_FRAME
(78)

468 
	`BT_FRAME
(79)

470 
	`BT_FRAME
(80)

471 
	`BT_FRAME
(81)

472 
	`BT_FRAME
(82)

473 
	`BT_FRAME
(83)

474 
	`BT_FRAME
(84)

475 
	`BT_FRAME
(85)

476 
	`BT_FRAME
(86)

477 
	`BT_FRAME
(87)

478 
	`BT_FRAME
(88)

479 
	`BT_FRAME
(89)

481 
	`BT_FRAME
(90)

482 
	`BT_FRAME
(91)

483 
	`BT_FRAME
(92)

484 
	`BT_FRAME
(93)

485 
	`BT_FRAME
(94)

486 
	`BT_FRAME
(95)

487 
	`BT_FRAME
(96)

488 
	`BT_FRAME
(97)

489 
	`BT_FRAME
(98)

490 
	`BT_FRAME
(99)

492 
	`BT_FRAME
(100)

493 
	`BT_FRAME
(101)

494 
	`BT_FRAME
(102)

495 
	`BT_FRAME
(103)

496 
	`BT_FRAME
(104)

497 
	`BT_FRAME
(105)

498 
	`BT_FRAME
(106)

499 
	`BT_FRAME
(107)

500 
	`BT_FRAME
(108)

501 
	`BT_FRAME
(109)

503 
	`BT_FRAME
(110)

504 
	`BT_FRAME
(111)

505 
	`BT_FRAME
(112)

506 
	`BT_FRAME
(113)

507 
	`BT_FRAME
(114)

508 
	`BT_FRAME
(115)

509 
	`BT_FRAME
(116)

510 
	`BT_FRAME
(117)

511 
	`BT_FRAME
(118)

512 
	`BT_FRAME
(119)

514 
	`BT_FRAME
(120)

515 
	`BT_FRAME
(121)

516 
	`BT_FRAME
(122)

517 
	`BT_FRAME
(123)

518 
	`BT_FRAME
(124)

519 
	`BT_FRAME
(125)

520 
	`BT_FRAME
(126)

521 
	`BT_FRAME
(127)

522 #undeà
BT_FRAME


523 
	}
}

526 
	$´of_backŒaû
(
´of_bt_t
 *
bt
)

529 
	`ÿs£¹
(
cÚfig_´of
);

530 
	`nÙ_»ached
();

531 
	}
}

534 
m®loc_mu‹x_t
 *

535 
	$´of_gùx_mu‹x_choo£
()

537 
ngùxs
 = 
	`©omic_add_u
(&
cum_gùxs
, 1);

539  (&
gùx_locks
[(
ngùxs
 - 1è% 
PROF_NCTX_LOCKS
]);

540 
	}
}

542 
m®loc_mu‹x_t
 *

543 
	$´of_td©a_mu‹x_choo£
(
ušt64_t
 
thr_uid
)

546  (&
td©a_locks
[
thr_uid
 % 
PROF_NTDATA_LOCKS
]);

547 
	}
}

549 
´of_gùx_t
 *

550 
	$´of_gùx_ü—‹
(
tsdn_t
 *
tsdn
, 
´of_bt_t
 *
bt
)

555 
size_t
 
size
 = 
	`off£tof
(
´of_gùx_t
, 
vec
è+ (
bt
->
Ën
 * (*));

556 
´of_gùx_t
 *
gùx
 = (´of_gùx_ˆ*)
	`ŸÎocztm
(
tsdn
, 
size
,

557 
	`size2šdex
(
size
), 
çl£
, 
NULL
, 
Œue
, 
	`¬’a_g‘
(
TSDN_NULL
, 0,rue),

558 
Œue
);

559 ià(
gùx
 =ğ
NULL
)

560  (
NULL
);

561 
gùx
->
lock
 = 
	`´of_gùx_mu‹x_choo£
();

566 
gùx
->
Æimbo
 = 1;

567 
	`tùx_Œ“_Ãw
(&
gùx
->
tùxs
);

569 
	`memıy
(
gùx
->
vec
, 
bt
->vec, bt->
Ën
 * (*));

570 
gùx
->
bt
.
vec
 = gctx->vec;

571 
gùx
->
bt
.
Ën
 = bt->len;

572  (
gùx
);

573 
	}
}

576 
	$´of_gùx_Œy_de¡roy
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a_£lf
, 
´of_gùx_t
 *
gùx
,

577 
´of_td©a_t
 *
td©a
)

580 
	`ÿs£¹
(
cÚfig_´of
);

589 
	`´of_’‹r
(
tsd
, 
td©a_£lf
);

590 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

591 
	`as£¹
(
gùx
->
Æimbo
 != 0);

592 ià(
	`tùx_Œ“_em±y
(&
gùx
->
tùxs
è&& gùx->
Æimbo
 == 1) {

594 ià(
	`ckh_»move
(
	`tsd_tsdn
(
tsd
), &
bt2gùx
, &
gùx
->
bt
, 
NULL
, NULL))

595 
	`nÙ_»ached
();

596 
	`´of_Ëave
(
tsd
, 
td©a_£lf
);

598 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

599 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
gùx
, 
NULL
, 
Œue
,rue);

605 
gùx
->
Æimbo
--;

606 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

607 
	`´of_Ëave
(
tsd
, 
td©a_£lf
);

609 
	}
}

611 
boŞ


612 
	$´of_tùx_should_de¡roy
(
tsdn_t
 *
tsdn
, 
´of_tùx_t
 *
tùx
)

615 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, 
tùx
->
td©a
->
lock
);

617 ià(
İt_´of_accum
)

618  (
çl£
);

619 ià(
tùx
->
úts
.
curobjs
 != 0)

620  (
çl£
);

621 ià(
tùx
->
´•¬ed
)

622  (
çl£
);

623  (
Œue
);

624 
	}
}

626 
boŞ


627 
	$´of_gùx_should_de¡roy
(
´of_gùx_t
 *
gùx
)

630 ià(
İt_´of_accum
)

631  (
çl£
);

632 ià(!
	`tùx_Œ“_em±y
(&
gùx
->
tùxs
))

633  (
çl£
);

634 ià(
gùx
->
Æimbo
 != 0)

635  (
çl£
);

636  (
Œue
);

637 
	}
}

640 
	$´of_tùx_de¡roy
(
tsd_t
 *
tsd
, 
´of_tùx_t
 *
tùx
)

642 
´of_td©a_t
 *
td©a
 = 
tùx
->tdata;

643 
´of_gùx_t
 *
gùx
 = 
tùx
->gctx;

644 
boŞ
 
de¡roy_td©a
, 
de¡roy_tùx
, 
de¡roy_gùx
;

646 
	`m®loc_mu‹x_as£¹_owÃr
(
	`tsd_tsdn
(
tsd
), 
tùx
->
td©a
->
lock
);

648 
	`as£¹
(
tùx
->
úts
.
curobjs
 == 0);

649 
	`as£¹
(
tùx
->
úts
.
curby‹s
 == 0);

650 
	`as£¹
(!
İt_´of_accum
);

651 
	`as£¹
(
tùx
->
úts
.
accumobjs
 == 0);

652 
	`as£¹
(
tùx
->
úts
.
accumby‹s
 == 0);

654 
	`ckh_»move
(
	`tsd_tsdn
(
tsd
), &
td©a
->
bt2tùx
, &
gùx
->
bt
, 
NULL
, NULL);

655 
de¡roy_td©a
 = 
	`´of_td©a_should_de¡roy
(
	`tsd_tsdn
(
tsd
), 
td©a
, 
çl£
);

656 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
td©a
->
lock
);

658 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

659 
tùx
->
¡©e
) {

660 
´of_tùx_¡©e_nomš®
:

661 
	`tùx_Œ“_»move
(&
gùx
->
tùxs
, 
tùx
);

662 
de¡roy_tùx
 = 
Œue
;

663 ià(
	`´of_gùx_should_de¡roy
(
gùx
)) {

678 
gùx
->
Æimbo
++;

679 
de¡roy_gùx
 = 
Œue
;

681 
de¡roy_gùx
 = 
çl£
;

683 
´of_tùx_¡©e_dumpšg
:

689 
tùx
->
¡©e
 = 
´of_tùx_¡©e_purg©Üy
;

690 
de¡roy_tùx
 = 
çl£
;

691 
de¡roy_gùx
 = 
çl£
;

694 
	`nÙ_»ached
();

695 
de¡roy_tùx
 = 
çl£
;

696 
de¡roy_gùx
 = 
çl£
;

698 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

699 ià(
de¡roy_gùx
) {

700 
	`´of_gùx_Œy_de¡roy
(
tsd
, 
	`´of_td©a_g‘
Ñsd, 
çl£
), 
gùx
,

701 
td©a
);

704 
	`m®loc_mu‹x_as£¹_nÙ_owÃr
(
	`tsd_tsdn
(
tsd
), 
tùx
->
td©a
->
lock
);

706 ià(
de¡roy_td©a
)

707 
	`´of_td©a_de¡roy
(
	`tsd_tsdn
(
tsd
), 
td©a
, 
çl£
);

709 ià(
de¡roy_tùx
)

710 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
tùx
, 
NULL
, 
Œue
,rue);

711 
	}
}

713 
boŞ


714 
	$´of_lookup_glob®
(
tsd_t
 *
tsd
, 
´of_bt_t
 *
bt
, 
´of_td©a_t
 *
td©a
,

715 **
p_btkey
, 
´of_gùx_t
 **
p_gùx
, 
boŞ
 *
p_Ãw_gùx
)

718 
´of_gùx_t
 *
p
;

719 *
v
;

720 } 
gùx
;

722 
´of_bt_t
 *
p
;

723 *
v
;

724 } 
btkey
;

725 
boŞ
 
Ãw_gùx
;

727 
	`´of_’‹r
(
tsd
, 
td©a
);

728 ià(
	`ckh_£¬ch
(&
bt2gùx
, 
bt
, &
btkey
.
v
, &
gùx
.v)) {

730 
gùx
.
p
 = 
	`´of_gùx_ü—‹
(
	`tsd_tsdn
(
tsd
), 
bt
);

731 ià(
gùx
.
v
 =ğ
NULL
) {

732 
	`´of_Ëave
(
tsd
, 
td©a
);

733  (
Œue
);

735 
btkey
.
p
 = &
gùx
.p->
bt
;

736 ià(
	`ckh_š£¹
(
	`tsd_tsdn
(
tsd
), &
bt2gùx
, 
btkey
.
v
, 
gùx
.v)) {

738 
	`´of_Ëave
(
tsd
, 
td©a
);

739 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
gùx
.
v
, 
NULL
, 
Œue
,rue);

740  (
Œue
);

742 
Ãw_gùx
 = 
Œue
;

748 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
gùx
.
p
->
lock
);

749 
gùx
.
p
->
Æimbo
++;

750 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
gùx
.
p
->
lock
);

751 
Ãw_gùx
 = 
çl£
;

753 
	`´of_Ëave
(
tsd
, 
td©a
);

755 *
p_btkey
 = 
btkey
.
v
;

756 *
p_gùx
 = 
gùx
.
p
;

757 *
p_Ãw_gùx
 = 
Ãw_gùx
;

758  (
çl£
);

759 
	}
}

761 
´of_tùx_t
 *

762 
	$´of_lookup
(
tsd_t
 *
tsd
, 
´of_bt_t
 *
bt
)

765 
´of_tùx_t
 *
p
;

766 *
v
;

767 } 
»t
;

768 
´of_td©a_t
 *
td©a
;

769 
boŞ
 
nÙ_found
;

771 
	`ÿs£¹
(
cÚfig_´of
);

773 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

774 ià(
td©a
 =ğ
NULL
)

775  (
NULL
);

777 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
td©a
->
lock
);

778 
nÙ_found
 = 
	`ckh_£¬ch
(&
td©a
->
bt2tùx
, 
bt
, 
NULL
, &
»t
.
v
);

779 ià(!
nÙ_found
)

780 
»t
.
p
->
´•¬ed
 = 
Œue
;

781 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
td©a
->
lock
);

782 ià(
nÙ_found
) {

783 *
btkey
;

784 
´of_gùx_t
 *
gùx
;

785 
boŞ
 
Ãw_gùx
, 
”rÜ
;

791 ià(
	`´of_lookup_glob®
(
tsd
, 
bt
, 
td©a
, &
btkey
, &
gùx
,

792 &
Ãw_gùx
))

793  (
NULL
);

796 
»t
.
v
 = 
	`ŸÎocztm
(
	`tsd_tsdn
(
tsd
), (
´of_tùx_t
),

797 
	`size2šdex
((
´of_tùx_t
)), 
çl£
, 
NULL
, 
Œue
,

798 
	`¬’a_ichoo£
(
	`tsd_tsdn
(
tsd
), 
NULL
), 
Œue
);

799 ià(
»t
.
p
 =ğ
NULL
) {

800 ià(
Ãw_gùx
)

801 
	`´of_gùx_Œy_de¡roy
(
tsd
, 
td©a
, 
gùx
,data);

802  (
NULL
);

804 
»t
.
p
->
td©a
 =data;

805 
»t
.
p
->
thr_uid
 = 
td©a
->thr_uid;

806 
»t
.
p
->
thr_disüim
 = 
td©a
->thr_discrim;

807 
	`mem£t
(&
»t
.
p
->
úts
, 0, (
´of_út_t
));

808 
»t
.
p
->
gùx
 = gctx;

809 
»t
.
p
->
tùx_uid
 = 
td©a
->
tùx_uid_Ãxt
++;

810 
»t
.
p
->
´•¬ed
 = 
Œue
;

811 
»t
.
p
->
¡©e
 = 
´of_tùx_¡©e_š™Ÿlizšg
;

812 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
td©a
->
lock
);

813 
”rÜ
 = 
	`ckh_š£¹
(
	`tsd_tsdn
(
tsd
), &
td©a
->
bt2tùx
, 
btkey
,

814 
»t
.
v
);

815 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
td©a
->
lock
);

816 ià(
”rÜ
) {

817 ià(
Ãw_gùx
)

818 
	`´of_gùx_Œy_de¡roy
(
tsd
, 
td©a
, 
gùx
,data);

819 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
»t
.
v
, 
NULL
, 
Œue
,rue);

820  (
NULL
);

822 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

823 
»t
.
p
->
¡©e
 = 
´of_tùx_¡©e_nomš®
;

824 
	`tùx_Œ“_š£¹
(&
gùx
->
tùxs
, 
»t
.
p
);

825 
gùx
->
Æimbo
--;

826 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

829  (
»t
.
p
);

830 
	}
}

846 
	$´of_§m¶e_th»shŞd_upd©e
(
´of_td©a_t
 *
td©a
)

848 #ifdeà
JEMALLOC_PROF


849 
ušt64_t
 
r
;

850 
u
;

852 ià(!
cÚfig_´of
)

855 ià(
lg_´of_§m¶e
 == 0) {

856 
td©a
->
by‹s_uÁ_§m¶e
 = 0;

878 
r
 = 
	`´ng_lg_¿nge
(&
td©a
->
´ng_¡©e
, 53);

879 
u
 = ()
r
 * (1.0/9007199254740992.0L);

880 
td©a
->
by‹s_uÁ_§m¶e
 = (
ušt64_t
)(
	`log
(
u
) /

881 
	`log
(1.0 - (1.0 / ()((
ušt64_t
)1U << 
lg_´of_§m¶e
))))

882 + (
ušt64_t
)1U;

884 
	}
}

886 #ifdeà
JEMALLOC_JET


887 
´of_td©a_t
 *

888 
	$´of_td©a_couÁ_™”
(
´of_td©a_Œ“_t
 *
td©as
, 
´of_td©a_t
 *
td©a
, *
¬g
)

890 
size_t
 *
td©a_couÁ
 = (size_ˆ*)
¬g
;

892 (*
td©a_couÁ
)++;

894  (
NULL
);

895 
	}
}

897 
size_t


898 
	$´of_td©a_couÁ
()

900 
size_t
 
td©a_couÁ
 = 0;

901 
tsdn_t
 *
tsdn
;

903 
tsdn
 = 
	`tsdn_ãtch
();

904 
	`m®loc_mu‹x_lock
(
tsdn
, &
td©as_mtx
);

905 
	`td©a_Œ“_™”
(&
td©as
, 
NULL
, 
´of_td©a_couÁ_™”
,

906 (*)&
td©a_couÁ
);

907 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
td©as_mtx
);

909  (
td©a_couÁ
);

910 
	}
}

913 #ifdeà
JEMALLOC_JET


914 
size_t


915 
	$´of_bt_couÁ
()

917 
size_t
 
bt_couÁ
;

918 
tsd_t
 *
tsd
;

919 
´of_td©a_t
 *
td©a
;

921 
tsd
 = 
	`tsd_ãtch
();

922 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

923 ià(
td©a
 =ğ
NULL
)

926 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
bt2gùx_mtx
);

927 
bt_couÁ
 = 
	`ckh_couÁ
(&
bt2gùx
);

928 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
bt2gùx_mtx
);

930  (
bt_couÁ
);

931 
	}
}

934 #ifdeà
JEMALLOC_JET


935 #undeà
´of_dump_İ’


936 
	#´of_dump_İ’
 
	`JEMALLOC_N
(
´of_dump_İ’_im¶
)

	)

939 
	$´of_dump_İ’
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

941 
fd
;

943 
fd
 = 
	`ü—t
(
f’ame
, 0644);

944 ià(
fd
 =ğ-1 && !
´İag©e_”r
) {

945 
	`m®loc_´štf
("<jemalloc>: creat(\"%s\"), 0644) failed\n",

946 
f’ame
);

947 ià(
İt_abÜt
)

948 
	`abÜt
();

951  (
fd
);

952 
	}
}

953 #ifdeà
JEMALLOC_JET


954 #undeà
´of_dump_İ’


955 
	#´of_dump_İ’
 
	`JEMALLOC_N
(
´of_dump_İ’
)

	)

956 
´of_dump_İ’_t
 *
	g´of_dump_İ’
 = 
JEMALLOC_N
(
´of_dump_İ’_im¶
);

959 
boŞ


960 
	$´of_dump_æush
(
boŞ
 
´İag©e_”r
)

962 
boŞ
 
»t
 = 
çl£
;

963 
ssize_t
 
”r
;

965 
	`ÿs£¹
(
cÚfig_´of
);

967 
”r
 = 
	`wr™e
(
´of_dump_fd
, 
´of_dump_buf
, 
´of_dump_buf_’d
);

968 ià(
”r
 == -1) {

969 ià(!
´İag©e_”r
) {

970 
	`m®loc_wr™e
("<jemalloc>: write() failed during heap "

972 ià(
İt_abÜt
)

973 
	`abÜt
();

975 
»t
 = 
Œue
;

977 
´of_dump_buf_’d
 = 0;

979  (
»t
);

980 
	}
}

982 
boŞ


983 
	$´of_dump_şo£
(
boŞ
 
´İag©e_”r
)

985 
boŞ
 
»t
;

987 
	`as£¹
(
´of_dump_fd
 != -1);

988 
»t
 = 
	`´of_dump_æush
(
´İag©e_”r
);

989 
	`şo£
(
´of_dump_fd
);

990 
´of_dump_fd
 = -1;

992  (
»t
);

993 
	}
}

995 
boŞ


996 
	$´of_dump_wr™e
(
boŞ
 
´İag©e_”r
, cÚ¡ *
s
)

998 
size_t
 
i
, 
¦’
, 
n
;

1000 
	`ÿs£¹
(
cÚfig_´of
);

1002 
i
 = 0;

1003 
¦’
 = 
	`¡¾’
(
s
);

1004 
i
 < 
¦’
) {

1006 ià(
´of_dump_buf_’d
 =ğ
PROF_DUMP_BUFSIZE
)

1007 ià(
	`´of_dump_æush
(
´İag©e_”r
) &&…ropagate_err)

1008  (
Œue
);

1010 ià(
´of_dump_buf_’d
 + 
¦’
 <ğ
PROF_DUMP_BUFSIZE
) {

1012 
n
 = 
¦’
 - 
i
;

1015 
n
 = 
PROF_DUMP_BUFSIZE
 - 
´of_dump_buf_’d
;

1017 
	`memıy
(&
´of_dump_buf
[
´of_dump_buf_’d
], &
s
[
i
], 
n
);

1018 
´of_dump_buf_’d
 +ğ
n
;

1019 
i
 +ğ
n
;

1022  (
çl£
);

1023 
	}
}

1025 
	$JEMALLOC_FORMAT_PRINTF
(2, 3)

1026 
boŞ


1027 
	$´of_dump_´štf
(
boŞ
 
´İag©e_”r
, cÚ¡ *
fÜm©
, ...)

1029 
boŞ
 
»t
;

1030 
va_li¡
 
­
;

1031 
buf
[
PROF_PRINTF_BUFSIZE
];

1033 
	`va_¡¬t
(
­
, 
fÜm©
);

1034 
	`m®loc_v¢´štf
(
buf
, (buf), 
fÜm©
, 
­
);

1035 
	`va_’d
(
­
);

1036 
»t
 = 
	`´of_dump_wr™e
(
´İag©e_”r
, 
buf
);

1038  (
»t
);

1039 
	}
}

1042 
	$´of_tùx_m”ge_td©a
(
tsdn_t
 *
tsdn
, 
´of_tùx_t
 *
tùx
, 
´of_td©a_t
 *
td©a
)

1045 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, 
tùx
->
td©a
->
lock
);

1047 
	`m®loc_mu‹x_lock
(
tsdn
, 
tùx
->
gùx
->
lock
);

1049 
tùx
->
¡©e
) {

1050 
´of_tùx_¡©e_š™Ÿlizšg
:

1051 
	`m®loc_mu‹x_uÆock
(
tsdn
, 
tùx
->
gùx
->
lock
);

1053 
´of_tùx_¡©e_nomš®
:

1054 
tùx
->
¡©e
 = 
´of_tùx_¡©e_dumpšg
;

1055 
	`m®loc_mu‹x_uÆock
(
tsdn
, 
tùx
->
gùx
->
lock
);

1057 
	`memıy
(&
tùx
->
dump_úts
, &tùx->
úts
, (
´of_út_t
));

1059 
td©a
->
út_summed
.
curobjs
 +ğ
tùx
->
dump_úts
.curobjs;

1060 
td©a
->
út_summed
.
curby‹s
 +ğ
tùx
->
dump_úts
.curbytes;

1061 ià(
İt_´of_accum
) {

1062 
td©a
->
út_summed
.
accumobjs
 +=

1063 
tùx
->
dump_úts
.
accumobjs
;

1064 
td©a
->
út_summed
.
accumby‹s
 +=

1065 
tùx
->
dump_úts
.
accumby‹s
;

1068 
´of_tùx_¡©e_dumpšg
:

1069 
´of_tùx_¡©e_purg©Üy
:

1070 
	`nÙ_»ached
();

1072 
	}
}

1075 
	$´of_tùx_m”ge_gùx
(
tsdn_t
 *
tsdn
, 
´of_tùx_t
 *
tùx
, 
´of_gùx_t
 *
gùx
)

1078 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, 
gùx
->
lock
);

1080 
gùx
->
út_summed
.
curobjs
 +ğ
tùx
->
dump_úts
.curobjs;

1081 
gùx
->
út_summed
.
curby‹s
 +ğ
tùx
->
dump_úts
.curbytes;

1082 ià(
İt_´of_accum
) {

1083 
gùx
->
út_summed
.
accumobjs
 +ğ
tùx
->
dump_úts
.accumobjs;

1084 
gùx
->
út_summed
.
accumby‹s
 +ğ
tùx
->
dump_úts
.accumbytes;

1086 
	}
}

1088 
´of_tùx_t
 *

1089 
	$´of_tùx_m”ge_™”
(
´of_tùx_Œ“_t
 *
tùxs
, 
´of_tùx_t
 *
tùx
, *
¬g
)

1091 
tsdn_t
 *
tsdn
 = (tsdn_ˆ*)
¬g
;

1093 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, 
tùx
->
gùx
->
lock
);

1095 
tùx
->
¡©e
) {

1096 
´of_tùx_¡©e_nomš®
:

1099 
´of_tùx_¡©e_dumpšg
:

1100 
´of_tùx_¡©e_purg©Üy
:

1101 
	`´of_tùx_m”ge_gùx
(
tsdn
, 
tùx
,ùx->
gùx
);

1104 
	`nÙ_»ached
();

1107  (
NULL
);

1108 
	}
}

1110 
	s´of_tùx_dump_™”_¬g_s
 {

1111 
tsdn_t
 *
	mtsdn
;

1112 
boŞ
 
	m´İag©e_”r
;

1115 
´of_tùx_t
 *

1116 
	$´of_tùx_dump_™”
(
´of_tùx_Œ“_t
 *
tùxs
, 
´of_tùx_t
 *
tùx
, *
İaque
)

1118 
´of_tùx_dump_™”_¬g_s
 *
¬g
 =

1119 (
´of_tùx_dump_™”_¬g_s
 *)
İaque
;

1121 
	`m®loc_mu‹x_as£¹_owÃr
(
¬g
->
tsdn
, 
tùx
->
gùx
->
lock
);

1123 
tùx
->
¡©e
) {

1124 
´of_tùx_¡©e_š™Ÿlizšg
:

1125 
´of_tùx_¡©e_nomš®
:

1128 
´of_tùx_¡©e_dumpšg
:

1129 
´of_tùx_¡©e_purg©Üy
:

1130 ià(
	`´of_dump_´štf
(
¬g
->
´İag©e_”r
,

1131 "%"
FMTu64
": %"FMTu64": %"FMTu64" [%"FMTu64": "

1132 "%"
FMTu64
"]\n", 
tùx
->
thr_uid
,ùx->
dump_úts
.
curobjs
,

1133 
tùx
->
dump_úts
.
curby‹s
,ùx->dump_úts.
accumobjs
,

1134 
tùx
->
dump_úts
.
accumby‹s
))

1135  (
tùx
);

1138 
	`nÙ_»ached
();

1140  (
NULL
);

1141 
	}
}

1143 
´of_tùx_t
 *

1144 
	$´of_tùx_fšish_™”
(
´of_tùx_Œ“_t
 *
tùxs
, 
´of_tùx_t
 *
tùx
, *
¬g
)

1146 
tsdn_t
 *
tsdn
 = (tsdn_ˆ*)
¬g
;

1147 
´of_tùx_t
 *
»t
;

1149 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, 
tùx
->
gùx
->
lock
);

1151 
tùx
->
¡©e
) {

1152 
´of_tùx_¡©e_nomš®
:

1155 
´of_tùx_¡©e_dumpšg
:

1156 
tùx
->
¡©e
 = 
´of_tùx_¡©e_nomš®
;

1158 
´of_tùx_¡©e_purg©Üy
:

1159 
»t
 = 
tùx
;

1160 
Ïb–_»tuº
;

1162 
	`nÙ_»ached
();

1165 
»t
 = 
NULL
;

1166 
Ïb–_»tuº
:

1167  (
»t
);

1168 
	}
}

1171 
	$´of_dump_gùx_´•
(
tsdn_t
 *
tsdn
, 
´of_gùx_t
 *
gùx
, 
´of_gùx_Œ“_t
 *
gùxs
)

1174 
	`ÿs£¹
(
cÚfig_´of
);

1176 
	`m®loc_mu‹x_lock
(
tsdn
, 
gùx
->
lock
);

1183 
gùx
->
Æimbo
++;

1184 
	`gùx_Œ“_š£¹
(
gùxs
, 
gùx
);

1186 
	`mem£t
(&
gùx
->
út_summed
, 0, (
´of_út_t
));

1188 
	`m®loc_mu‹x_uÆock
(
tsdn
, 
gùx
->
lock
);

1189 
	}
}

1191 
	s´of_gùx_m”ge_™”_¬g_s
 {

1192 
tsdn_t
 *
	mtsdn
;

1193 
size_t
 
	mËak_ngùx
;

1196 
´of_gùx_t
 *

1197 
	$´of_gùx_m”ge_™”
(
´of_gùx_Œ“_t
 *
gùxs
, 
´of_gùx_t
 *
gùx
, *
İaque
)

1199 
´of_gùx_m”ge_™”_¬g_s
 *
¬g
 =

1200 (
´of_gùx_m”ge_™”_¬g_s
 *)
İaque
;

1202 
	`m®loc_mu‹x_lock
(
¬g
->
tsdn
, 
gùx
->
lock
);

1203 
	`tùx_Œ“_™”
(&
gùx
->
tùxs
, 
NULL
, 
´of_tùx_m”ge_™”
,

1204 (*)
¬g
->
tsdn
);

1205 ià(
gùx
->
út_summed
.
curobjs
 != 0)

1206 
¬g
->
Ëak_ngùx
++;

1207 
	`m®loc_mu‹x_uÆock
(
¬g
->
tsdn
, 
gùx
->
lock
);

1209  (
NULL
);

1210 
	}
}

1213 
	$´of_gùx_fšish
(
tsd_t
 *
tsd
, 
´of_gùx_Œ“_t
 *
gùxs
)

1215 
´of_td©a_t
 *
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

1216 
´of_gùx_t
 *
gùx
;

1224 (
gùx
 = 
	`gùx_Œ“_fœ¡
(
gùxs
)è!ğ
NULL
) {

1225 
	`gùx_Œ“_»move
(
gùxs
, 
gùx
);

1226 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

1228 
´of_tùx_t
 *
Ãxt
;

1230 
Ãxt
 = 
NULL
;

1232 
´of_tùx_t
 *
to_de¡roy
 =

1233 
	`tùx_Œ“_™”
(&
gùx
->
tùxs
, 
Ãxt
,

1234 
´of_tùx_fšish_™”
,

1235 (*)
	`tsd_tsdn
(
tsd
));

1236 ià(
to_de¡roy
 !ğ
NULL
) {

1237 
Ãxt
 = 
	`tùx_Œ“_Ãxt
(&
gùx
->
tùxs
,

1238 
to_de¡roy
);

1239 
	`tùx_Œ“_»move
(&
gùx
->
tùxs
,

1240 
to_de¡roy
);

1241 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
to_de¡roy
,

1242 
NULL
, 
Œue
,rue);

1244 
Ãxt
 = 
NULL
;

1245 } 
Ãxt
 !ğ
NULL
);

1247 
gùx
->
Æimbo
--;

1248 ià(
	`´of_gùx_should_de¡roy
(
gùx
)) {

1249 
gùx
->
Æimbo
++;

1250 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

1251 
	`´of_gùx_Œy_de¡roy
(
tsd
, 
td©a
, 
gùx
,data);

1253 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
gùx
->
lock
);

1255 
	}
}

1257 
	s´of_td©a_m”ge_™”_¬g_s
 {

1258 
tsdn_t
 *
	mtsdn
;

1259 
´of_út_t
 
	mút_®l
;

1262 
´of_td©a_t
 *

1263 
	$´of_td©a_m”ge_™”
(
´of_td©a_Œ“_t
 *
td©as
, 
´of_td©a_t
 *
td©a
,

1264 *
İaque
)

1266 
´of_td©a_m”ge_™”_¬g_s
 *
¬g
 =

1267 (
´of_td©a_m”ge_™”_¬g_s
 *)
İaque
;

1269 
	`m®loc_mu‹x_lock
(
¬g
->
tsdn
, 
td©a
->
lock
);

1270 ià(!
td©a
->
expœed
) {

1271 
size_t
 
bšd
;

1273 
´of_tùx_t
 *
p
;

1274 *
v
;

1275 } 
tùx
;

1277 
td©a
->
dumpšg
 = 
Œue
;

1278 
	`mem£t
(&
td©a
->
út_summed
, 0, (
´of_út_t
));

1279 
bšd
 = 0; !
	`ckh_™”
(&
td©a
->
bt2tùx
, &bšd, 
NULL
,

1280 &
tùx
.
v
);)

1281 
	`´of_tùx_m”ge_td©a
(
¬g
->
tsdn
, 
tùx
.
p
, 
td©a
);

1283 
¬g
->
út_®l
.
curobjs
 +ğ
td©a
->
út_summed
.curobjs;

1284 
¬g
->
út_®l
.
curby‹s
 +ğ
td©a
->
út_summed
.curbytes;

1285 ià(
İt_´of_accum
) {

1286 
¬g
->
út_®l
.
accumobjs
 +ğ
td©a
->
út_summed
.accumobjs;

1287 
¬g
->
út_®l
.
accumby‹s
 +ğ
td©a
->
út_summed
.accumbytes;

1290 
td©a
->
dumpšg
 = 
çl£
;

1291 
	`m®loc_mu‹x_uÆock
(
¬g
->
tsdn
, 
td©a
->
lock
);

1293  (
NULL
);

1294 
	}
}

1296 
´of_td©a_t
 *

1297 
	$´of_td©a_dump_™”
(
´of_td©a_Œ“_t
 *
td©as
, 
´of_td©a_t
 *
td©a
, *
¬g
)

1299 
boŞ
 
´İag©e_”r
 = *(boŞ *)
¬g
;

1301 ià(!
td©a
->
dumpšg
)

1302  (
NULL
);

1304 ià(
	`´of_dump_´štf
(
´İag©e_”r
,

1305 "%"
FMTu64
": %"FMTu64": %"FMTu64" [%"FMTu64": %"FMTu64"]%s%s\n",

1306 
td©a
->
thr_uid
,d©a->
út_summed
.
curobjs
,

1307 
td©a
->
út_summed
.
curby‹s
,d©a->út_summed.
accumobjs
,

1308 
td©a
->
út_summed
.
accumby‹s
,

1309 (
td©a
->
th»ad_Çme
 !ğ
NULL
) ? " " : "",

1310 (
td©a
->
th»ad_Çme
 !ğ
NULL
) ?data->thread_name : ""))

1311  (
td©a
);

1312  (
NULL
);

1313 
	}
}

1315 #ifdeà
JEMALLOC_JET


1316 #undeà
´of_dump_h—d”


1317 
	#´of_dump_h—d”
 
	`JEMALLOC_N
(
´of_dump_h—d”_im¶
)

	)

1319 
boŞ


1320 
	$´of_dump_h—d”
(
tsdn_t
 *
tsdn
, 
boŞ
 
´İag©e_”r
, cÚ¡ 
´of_út_t
 *
út_®l
)

1322 
boŞ
 
»t
;

1324 ià(
	`´of_dump_´štf
(
´İag©e_”r
,

1325 "h—p_v2/%"
FMTu64
"\n"

1326 "*: %"
FMTu64
": %"FMTu64" [%"FMTu64": %"FMTu64"]\n",

1327 ((
ušt64_t
)1U << 
lg_´of_§m¶e
), 
út_®l
->
curobjs
,

1328 
út_®l
->
curby‹s
, cÁ_®l->
accumobjs
, cÁ_®l->
accumby‹s
))

1329  (
Œue
);

1331 
	`m®loc_mu‹x_lock
(
tsdn
, &
td©as_mtx
);

1332 
»t
 = (
	`td©a_Œ“_™”
(&
td©as
, 
NULL
, 
´of_td©a_dump_™”
,

1333 (*)&
´İag©e_”r
è!ğ
NULL
);

1334 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
td©as_mtx
);

1335  (
»t
);

1336 
	}
}

1337 #ifdeà
JEMALLOC_JET


1338 #undeà
´of_dump_h—d”


1339 
	#´of_dump_h—d”
 
	`JEMALLOC_N
(
´of_dump_h—d”
)

	)

1340 
´of_dump_h—d”_t
 *
	g´of_dump_h—d”
 = 
JEMALLOC_N
(
´of_dump_h—d”_im¶
);

1343 
boŞ


1344 
	$´of_dump_gùx
(
tsdn_t
 *
tsdn
, 
boŞ
 
´İag©e_”r
, 
´of_gùx_t
 *
gùx
,

1345 cÚ¡ 
´of_bt_t
 *
bt
, 
´of_gùx_Œ“_t
 *
gùxs
)

1347 
boŞ
 
»t
;

1348 
i
;

1349 
´of_tùx_dump_™”_¬g_s
 
´of_tùx_dump_™”_¬g
;

1351 
	`ÿs£¹
(
cÚfig_´of
);

1352 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, 
gùx
->
lock
);

1355 ià((!
İt_´of_accum
 && 
gùx
->
út_summed
.
curobjs
 == 0) ||

1356 (
İt_´of_accum
 && 
gùx
->
út_summed
.
accumobjs
 == 0)) {

1357 
	`as£¹
(
gùx
->
út_summed
.
curobjs
 == 0);

1358 
	`as£¹
(
gùx
->
út_summed
.
curby‹s
 == 0);

1359 
	`as£¹
(
gùx
->
út_summed
.
accumobjs
 == 0);

1360 
	`as£¹
(
gùx
->
út_summed
.
accumby‹s
 == 0);

1361 
»t
 = 
çl£
;

1362 
Ïb–_»tuº
;

1365 ià(
	`´of_dump_´štf
(
´İag©e_”r
, "@")) {

1366 
»t
 = 
Œue
;

1367 
Ïb–_»tuº
;

1369 
i
 = 0; i < 
bt
->
Ën
; i++) {

1370 ià(
	`´of_dump_´štf
(
´İag©e_”r
, " %#"
FMTxPTR
,

1371 (
ušŒ_t
)
bt
->
vec
[
i
])) {

1372 
»t
 = 
Œue
;

1373 
Ïb–_»tuº
;

1377 ià(
	`´of_dump_´štf
(
´İag©e_”r
,

1379 "*: %"
FMTu64
": %"FMTu64" [%"FMTu64": %"FMTu64"]\n",

1380 
gùx
->
út_summed
.
curobjs
, gùx->út_summed.
curby‹s
,

1381 
gùx
->
út_summed
.
accumobjs
, gùx->út_summed.
accumby‹s
)) {

1382 
»t
 = 
Œue
;

1383 
Ïb–_»tuº
;

1386 
´of_tùx_dump_™”_¬g
.
tsdn
 =sdn;

1387 
´of_tùx_dump_™”_¬g
.
´İag©e_”r
 =…ropagate_err;

1388 ià(
	`tùx_Œ“_™”
(&
gùx
->
tùxs
, 
NULL
, 
´of_tùx_dump_™”
,

1389 (*)&
´of_tùx_dump_™”_¬g
è!ğ
NULL
) {

1390 
»t
 = 
Œue
;

1391 
Ïb–_»tuº
;

1394 
»t
 = 
çl£
;

1395 
Ïb–_»tuº
:

1396  (
»t
);

1397 
	}
}

1399 #iâdeà
_WIN32


1400 
	$JEMALLOC_FORMAT_PRINTF
(1, 2)

1402 
	$´of_İ’_m­s
(cÚ¡ *
fÜm©
, ...)

1404 
mfd
;

1405 
va_li¡
 
­
;

1406 
f’ame
[
PATH_MAX
 + 1];

1408 
	`va_¡¬t
(
­
, 
fÜm©
);

1409 
	`m®loc_v¢´štf
(
f’ame
, (f’ame), 
fÜm©
, 
­
);

1410 
	`va_’d
(
­
);

1411 
mfd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

1413  (
mfd
);

1414 
	}
}

1418 
	$´of_g‘pid
()

1421 #ifdeà
_WIN32


1422  (
	`G‘Cu¼’tProûssId
());

1424  (
	`g‘pid
());

1426 
	}
}

1428 
boŞ


1429 
	$´of_dump_m­s
(
boŞ
 
´İag©e_”r
)

1431 
boŞ
 
»t
;

1432 
mfd
;

1434 
	`ÿs£¹
(
cÚfig_´of
);

1435 #ifdeà
__F»eBSD__


1436 
mfd
 = 
	`´of_İ’_m­s
("/proc/curproc/map");

1437 #–ià
	`defšed
(
_WIN32
)

1438 
mfd
 = -1;

1441 
pid
 = 
	`´of_g‘pid
();

1443 
mfd
 = 
	`´of_İ’_m­s
("/´oc/%d/sk/%d/m­s", 
pid
,…id);

1444 ià(
mfd
 == -1)

1445 
mfd
 = 
	`´of_İ’_m­s
("/´oc/%d/m­s", 
pid
);

1448 ià(
mfd
 != -1) {

1449 
ssize_t
 
Ä—d
;

1451 ià(
	`´of_dump_wr™e
(
´İag©e_”r
, "\nMAPPED_LIBRARIES:\n") &&

1452 
´İag©e_”r
) {

1453 
»t
 = 
Œue
;

1454 
Ïb–_»tuº
;

1456 
Ä—d
 = 0;

1458 
´of_dump_buf_’d
 +ğ
Ä—d
;

1459 ià(
´of_dump_buf_’d
 =ğ
PROF_DUMP_BUFSIZE
) {

1461 ià(
	`´of_dump_æush
(
´İag©e_”r
) &&

1462 
´İag©e_”r
) {

1463 
»t
 = 
Œue
;

1464 
Ïb–_»tuº
;

1467 
Ä—d
 = 
	`»ad
(
mfd
, &
´of_dump_buf
[
´of_dump_buf_’d
],

1468 
PROF_DUMP_BUFSIZE
 - 
´of_dump_buf_’d
);

1469 } 
Ä—d
 > 0);

1471 
»t
 = 
Œue
;

1472 
Ïb–_»tuº
;

1475 
»t
 = 
çl£
;

1476 
Ïb–_»tuº
:

1477 ià(
mfd
 != -1)

1478 
	`şo£
(
mfd
);

1479  (
»t
);

1480 
	}
}

1487 
	$´of_Ëakcheck
(cÚ¡ 
´of_út_t
 *
út_®l
, 
size_t
 
Ëak_ngùx
,

1488 cÚ¡ *
f’ame
)

1491 #ifdeà
JEMALLOC_PROF


1498 ià(
út_®l
->
curby‹s
 != 0) {

1499 
§m¶e_³riod
 = ()((
ušt64_t
)1 << 
lg_´of_§m¶e
);

1500 
¿tio
 = ((()
út_®l
->
curby‹s
) /

1501 ()
út_®l
->
curobjs
è/ 
§m¶e_³riod
;

1502 
sÿË_çùÜ
 = 1.0 / (1.0 - 
	`exp
(-
¿tio
));

1503 
ušt64_t
 
curby‹s
 = (ušt64_t)
	`round
((()
út_®l
->curbytes)

1504 * 
sÿË_çùÜ
);

1505 
ušt64_t
 
curobjs
 = (ušt64_t)
	`round
((()
út_®l
->curobjs) *

1506 
sÿË_çùÜ
);

1508 
	`m®loc_´štf
("<jem®loc>: L—k‡µroxim©iÚ summ¬y: ~%"
FMTu64


1509 " by‹%s, ~%"
FMTu64
" object%s, >= %zu context%s\n",

1510 
curby‹s
, (curby‹ !ğ1è? "s" : "", 
curobjs
, (curobjs !=

1511 1è? "s" : "", 
Ëak_ngùx
, (leak_ngctx != 1) ? "s" : "");

1512 
	`m®loc_´štf
(

1514 
f’ame
);

1517 
	}
}

1519 
	s´of_gùx_dump_™”_¬g_s
 {

1520 
tsdn_t
 *
	mtsdn
;

1521 
boŞ
 
	m´İag©e_”r
;

1524 
´of_gùx_t
 *

1525 
	$´of_gùx_dump_™”
(
´of_gùx_Œ“_t
 *
gùxs
, 
´of_gùx_t
 *
gùx
, *
İaque
)

1527 
´of_gùx_t
 *
»t
;

1528 
´of_gùx_dump_™”_¬g_s
 *
¬g
 =

1529 (
´of_gùx_dump_™”_¬g_s
 *)
İaque
;

1531 
	`m®loc_mu‹x_lock
(
¬g
->
tsdn
, 
gùx
->
lock
);

1533 ià(
	`´of_dump_gùx
(
¬g
->
tsdn
,‡rg->
´İag©e_”r
, 
gùx
, &gùx->
bt
,

1534 
gùxs
)) {

1535 
»t
 = 
gùx
;

1536 
Ïb–_»tuº
;

1539 
»t
 = 
NULL
;

1540 
Ïb–_»tuº
:

1541 
	`m®loc_mu‹x_uÆock
(
¬g
->
tsdn
, 
gùx
->
lock
);

1542  (
»t
);

1543 
	}
}

1545 
boŞ


1546 
	$´of_dump
(
tsd_t
 *
tsd
, 
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
, boŞ 
Ëakcheck
)

1548 
´of_td©a_t
 *
td©a
;

1549 
´of_td©a_m”ge_™”_¬g_s
 
´of_td©a_m”ge_™”_¬g
;

1550 
size_t
 
bšd
;

1552 
´of_gùx_t
 *
p
;

1553 *
v
;

1554 } 
gùx
;

1555 
´of_gùx_m”ge_™”_¬g_s
 
´of_gùx_m”ge_™”_¬g
;

1556 
´of_gùx_dump_™”_¬g_s
 
´of_gùx_dump_™”_¬g
;

1557 
´of_gùx_Œ“_t
 
gùxs
;

1559 
	`ÿs£¹
(
cÚfig_´of
);

1561 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

1562 ià(
td©a
 =ğ
NULL
)

1563  (
Œue
);

1565 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
´of_dump_mtx
);

1566 
	`´of_’‹r
(
tsd
, 
td©a
);

1572 
	`gùx_Œ“_Ãw
(&
gùxs
);

1573 
bšd
 = 0; !
	`ckh_™”
(&
bt2gùx
, &bšd, 
NULL
, &
gùx
.
v
);)

1574 
	`´of_dump_gùx_´•
(
	`tsd_tsdn
(
tsd
), 
gùx
.
p
, &
gùxs
);

1580 
´of_td©a_m”ge_™”_¬g
.
tsdn
 = 
	`tsd_tsdn
(
tsd
);

1581 
	`mem£t
(&
´of_td©a_m”ge_™”_¬g
.
út_®l
, 0, (
´of_út_t
));

1582 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
td©as_mtx
);

1583 
	`td©a_Œ“_™”
(&
td©as
, 
NULL
, 
´of_td©a_m”ge_™”
,

1584 (*)&
´of_td©a_m”ge_™”_¬g
);

1585 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
td©as_mtx
);

1588 
´of_gùx_m”ge_™”_¬g
.
tsdn
 = 
	`tsd_tsdn
(
tsd
);

1589 
´of_gùx_m”ge_™”_¬g
.
Ëak_ngùx
 = 0;

1590 
	`gùx_Œ“_™”
(&
gùxs
, 
NULL
, 
´of_gùx_m”ge_™”
,

1591 (*)&
´of_gùx_m”ge_™”_¬g
);

1593 
	`´of_Ëave
(
tsd
, 
td©a
);

1596 ià((
´of_dump_fd
 = 
	`´of_dump_İ’
(
´İag©e_”r
, 
f’ame
)) == -1)

1597 
Ïb–_İ’_şo£_”rÜ
;

1600 ià(
	`´of_dump_h—d”
(
	`tsd_tsdn
(
tsd
), 
´İag©e_”r
,

1601 &
´of_td©a_m”ge_™”_¬g
.
út_®l
))

1602 
Ïb–_wr™e_”rÜ
;

1605 
´of_gùx_dump_™”_¬g
.
tsdn
 = 
	`tsd_tsdn
(
tsd
);

1606 
´of_gùx_dump_™”_¬g
.
´İag©e_”r
 =…ropagate_err;

1607 ià(
	`gùx_Œ“_™”
(&
gùxs
, 
NULL
, 
´of_gùx_dump_™”
,

1608 (*)&
´of_gùx_dump_™”_¬g
è!ğ
NULL
)

1609 
Ïb–_wr™e_”rÜ
;

1612 ià(
	`´of_dump_m­s
(
´İag©e_”r
))

1613 
Ïb–_wr™e_”rÜ
;

1615 ià(
	`´of_dump_şo£
(
´İag©e_”r
))

1616 
Ïb–_İ’_şo£_”rÜ
;

1618 
	`´of_gùx_fšish
(
tsd
, &
gùxs
);

1619 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
´of_dump_mtx
);

1621 ià(
Ëakcheck
) {

1622 
	`´of_Ëakcheck
(&
´of_td©a_m”ge_™”_¬g
.
út_®l
,

1623 
´of_gùx_m”ge_™”_¬g
.
Ëak_ngùx
, 
f’ame
);

1625  (
çl£
);

1626 
Ïb–_wr™e_”rÜ
:

1627 
	`´of_dump_şo£
(
´İag©e_”r
);

1628 
Ïb–_İ’_şo£_”rÜ
:

1629 
	`´of_gùx_fšish
(
tsd
, &
gùxs
);

1630 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
´of_dump_mtx
);

1631  (
Œue
);

1632 
	}
}

1634 
	#DUMP_FILENAME_BUFSIZE
 (
PATH_MAX
 + 1)

	)

1635 
	#VSEQ_INVALID
 
	`UINT64_C
(0xffffffffffffffff)

	)

1637 
	$´of_dump_f’ame
(*
f’ame
, 
v
, 
ušt64_t
 
v£q
)

1640 
	`ÿs£¹
(
cÚfig_´of
);

1642 ià(
v£q
 !ğ
VSEQ_INVALID
) {

1644 
	`m®loc_¢´štf
(
f’ame
, 
DUMP_FILENAME_BUFSIZE
,

1645 "%s.%d.%"
FMTu64
".%c%"FMTu64".heap",

1646 
İt_´of_´efix
, 
	`´of_g‘pid
(), 
´of_dump_£q
, 
v
, 
v£q
);

1649 
	`m®loc_¢´štf
(
f’ame
, 
DUMP_FILENAME_BUFSIZE
,

1650 "%s.%d.%"
FMTu64
".%c.heap",

1651 
İt_´of_´efix
, 
	`´of_g‘pid
(), 
´of_dump_£q
, 
v
);

1653 
´of_dump_£q
++;

1654 
	}
}

1657 
	$´of_fdump
()

1659 
tsd_t
 *
tsd
;

1660 
f’ame
[
DUMP_FILENAME_BUFSIZE
];

1662 
	`ÿs£¹
(
cÚfig_´of
);

1663 
	`as£¹
(
İt_´of_fš®
);

1664 
	`as£¹
(
İt_´of_´efix
[0] != '\0');

1666 ià(!
´of_boÙed
)

1668 
tsd
 = 
	`tsd_ãtch
();

1670 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
´of_dump_£q_mtx
);

1671 
	`´of_dump_f’ame
(
f’ame
, 'f', 
VSEQ_INVALID
);

1672 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
´of_dump_£q_mtx
);

1673 
	`´of_dump
(
tsd
, 
çl£
, 
f’ame
, 
İt_´of_Ëak
);

1674 
	}
}

1677 
	$´of_idump
(
tsdn_t
 *
tsdn
)

1679 
tsd_t
 *
tsd
;

1680 
´of_td©a_t
 *
td©a
;

1682 
	`ÿs£¹
(
cÚfig_´of
);

1684 ià(!
´of_boÙed
 || 
	`tsdn_nuÎ
(
tsdn
))

1686 
tsd
 = 
	`tsdn_tsd
(
tsdn
);

1687 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

1688 ià(
td©a
 =ğ
NULL
)

1690 ià(
td©a
->
’q
) {

1691 
td©a
->
’q_idump
 = 
Œue
;

1695 ià(
İt_´of_´efix
[0] != '\0') {

1696 
f’ame
[
PATH_MAX
 + 1];

1697 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
´of_dump_£q_mtx
);

1698 
	`´of_dump_f’ame
(
f’ame
, 'i', 
´of_dump_i£q
);

1699 
´of_dump_i£q
++;

1700 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
´of_dump_£q_mtx
);

1701 
	`´of_dump
(
tsd
, 
çl£
, 
f’ame
, false);

1703 
	}
}

1705 
boŞ


1706 
	$´of_mdump
(
tsd_t
 *
tsd
, cÚ¡ *
f’ame
)

1708 
f’ame_buf
[
DUMP_FILENAME_BUFSIZE
];

1710 
	`ÿs£¹
(
cÚfig_´of
);

1712 ià(!
İt_´of
 || !
´of_boÙed
)

1713  (
Œue
);

1715 ià(
f’ame
 =ğ
NULL
) {

1717 ià(
İt_´of_´efix
[0] == '\0')

1718  (
Œue
);

1719 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
´of_dump_£q_mtx
);

1720 
	`´of_dump_f’ame
(
f’ame_buf
, 'm', 
´of_dump_m£q
);

1721 
´of_dump_m£q
++;

1722 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
´of_dump_£q_mtx
);

1723 
f’ame
 = 
f’ame_buf
;

1725  (
	`´of_dump
(
tsd
, 
Œue
, 
f’ame
, 
çl£
));

1726 
	}
}

1729 
	$´of_gdump
(
tsdn_t
 *
tsdn
)

1731 
tsd_t
 *
tsd
;

1732 
´of_td©a_t
 *
td©a
;

1734 
	`ÿs£¹
(
cÚfig_´of
);

1736 ià(!
´of_boÙed
 || 
	`tsdn_nuÎ
(
tsdn
))

1738 
tsd
 = 
	`tsdn_tsd
(
tsdn
);

1739 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

1740 ià(
td©a
 =ğ
NULL
)

1742 ià(
td©a
->
’q
) {

1743 
td©a
->
’q_gdump
 = 
Œue
;

1747 ià(
İt_´of_´efix
[0] != '\0') {

1748 
f’ame
[
DUMP_FILENAME_BUFSIZE
];

1749 
	`m®loc_mu‹x_lock
(
tsdn
, &
´of_dump_£q_mtx
);

1750 
	`´of_dump_f’ame
(
f’ame
, 'u', 
´of_dump_u£q
);

1751 
´of_dump_u£q
++;

1752 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
´of_dump_£q_mtx
);

1753 
	`´of_dump
(
tsd
, 
çl£
, 
f’ame
, false);

1755 
	}
}

1758 
	$´of_bt_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2])

1760 
´of_bt_t
 *
bt
 = (´of_bt_ˆ*)
key
;

1762 
	`ÿs£¹
(
cÚfig_´of
);

1764 
	`hash
(
bt
->
vec
, bt->
Ën
 * (*), 0x94122f33U, 
r_hash
);

1765 
	}
}

1767 
boŞ


1768 
	$´of_bt_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
)

1770 cÚ¡ 
´of_bt_t
 *
bt1
 = (´of_bt_ˆ*)
k1
;

1771 cÚ¡ 
´of_bt_t
 *
bt2
 = (´of_bt_ˆ*)
k2
;

1773 
	`ÿs£¹
(
cÚfig_´of
);

1775 ià(
bt1
->
Ën
 !ğ
bt2
->len)

1776  (
çl£
);

1777  (
	`memcmp
(
bt1
->
vec
, 
bt2
->vec, bt1->
Ën
 * (*)) == 0);

1778 
	}
}

1780 
JEMALLOC_INLINE_C
 
ušt64_t


1781 
	$´of_thr_uid_®loc
(
tsdn_t
 *
tsdn
)

1783 
ušt64_t
 
thr_uid
;

1785 
	`m®loc_mu‹x_lock
(
tsdn
, &
Ãxt_thr_uid_mtx
);

1786 
thr_uid
 = 
Ãxt_thr_uid
;

1787 
Ãxt_thr_uid
++;

1788 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
Ãxt_thr_uid_mtx
);

1790  (
thr_uid
);

1791 
	}
}

1793 
´of_td©a_t
 *

1794 
	$´of_td©a_š™_im¶
(
tsdn_t
 *
tsdn
, 
ušt64_t
 
thr_uid
, ušt64_ˆ
thr_disüim
,

1795 *
th»ad_Çme
, 
boŞ
 
aùive
)

1797 
´of_td©a_t
 *
td©a
;

1799 
	`ÿs£¹
(
cÚfig_´of
);

1802 
td©a
 = (
´of_td©a_t
 *)
	`ŸÎocztm
(
tsdn
, (prof_tdata_t),

1803 
	`size2šdex
((
´of_td©a_t
)), 
çl£
, 
NULL
, 
Œue
,

1804 
	`¬’a_g‘
(
TSDN_NULL
, 0, 
Œue
),rue);

1805 ià(
td©a
 =ğ
NULL
)

1806  (
NULL
);

1808 
td©a
->
lock
 = 
	`´of_td©a_mu‹x_choo£
(
thr_uid
);

1809 
td©a
->
thr_uid
 =hr_uid;

1810 
td©a
->
thr_disüim
 =hr_discrim;

1811 
td©a
->
th»ad_Çme
 =hread_name;

1812 
td©a
->
©ched
 = 
Œue
;

1813 
td©a
->
expœed
 = 
çl£
;

1814 
td©a
->
tùx_uid_Ãxt
 = 0;

1816 ià(
	`ckh_Ãw
(
tsdn
, &
td©a
->
bt2tùx
, 
PROF_CKH_MINITEMS
,

1817 
´of_bt_hash
, 
´of_bt_keycomp
)) {

1818 
	`id®loùm
(
tsdn
, 
td©a
, 
NULL
, 
Œue
,rue);

1819  (
NULL
);

1822 
td©a
->
´ng_¡©e
 = (
ušt64_t
)(
ušŒ_t
)tdata;

1823 
	`´of_§m¶e_th»shŞd_upd©e
(
td©a
);

1825 
td©a
->
’q
 = 
çl£
;

1826 
td©a
->
’q_idump
 = 
çl£
;

1827 
td©a
->
’q_gdump
 = 
çl£
;

1829 
td©a
->
dumpšg
 = 
çl£
;

1830 
td©a
->
aùive
 =‡ctive;

1832 
	`m®loc_mu‹x_lock
(
tsdn
, &
td©as_mtx
);

1833 
	`td©a_Œ“_š£¹
(&
td©as
, 
td©a
);

1834 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
td©as_mtx
);

1836  (
td©a
);

1837 
	}
}

1839 
´of_td©a_t
 *

1840 
	$´of_td©a_š™
(
tsdn_t
 *
tsdn
)

1843  (
	`´of_td©a_š™_im¶
(
tsdn
, 
	`´of_thr_uid_®loc
Ñsdn), 0, 
NULL
,

1844 
	`´of_th»ad_aùive_š™_g‘
(
tsdn
)));

1845 
	}
}

1847 
boŞ


1848 
	$´of_td©a_should_de¡roy_uÆocked
(
´of_td©a_t
 *
td©a
, 
boŞ
 
ev’_if_©ched
)

1851 ià(
td©a
->
©ched
 && !
ev’_if_©ched
)

1852  (
çl£
);

1853 ià(
	`ckh_couÁ
(&
td©a
->
bt2tùx
) != 0)

1854  (
çl£
);

1855  (
Œue
);

1856 
	}
}

1858 
boŞ


1859 
	$´of_td©a_should_de¡roy
(
tsdn_t
 *
tsdn
, 
´of_td©a_t
 *
td©a
,

1860 
boŞ
 
ev’_if_©ched
)

1863 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, 
td©a
->
lock
);

1865  (
	`´of_td©a_should_de¡roy_uÆocked
(
td©a
, 
ev’_if_©ched
));

1866 
	}
}

1869 
	$´of_td©a_de¡roy_locked
(
tsdn_t
 *
tsdn
, 
´of_td©a_t
 *
td©a
,

1870 
boŞ
 
ev’_if_©ched
)

1873 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, &
td©as_mtx
);

1875 
	`as£¹
(
	`tsdn_nuÎ
(
tsdn
è|| 
	`tsd_´of_td©a_g‘
(
	`tsdn_tsd
Ñsdn)è!ğ
td©a
);

1877 
	`td©a_Œ“_»move
(&
td©as
, 
td©a
);

1879 
	`as£¹
(
	`´of_td©a_should_de¡roy_uÆocked
(
td©a
, 
ev’_if_©ched
));

1881 ià(
td©a
->
th»ad_Çme
 !ğ
NULL
)

1882 
	`id®loùm
(
tsdn
, 
td©a
->
th»ad_Çme
, 
NULL
, 
Œue
,rue);

1883 
	`ckh_d–‘e
(
tsdn
, &
td©a
->
bt2tùx
);

1884 
	`id®loùm
(
tsdn
, 
td©a
, 
NULL
, 
Œue
,rue);

1885 
	}
}

1888 
	$´of_td©a_de¡roy
(
tsdn_t
 *
tsdn
, 
´of_td©a_t
 *
td©a
, 
boŞ
 
ev’_if_©ched
)

1891 
	`m®loc_mu‹x_lock
(
tsdn
, &
td©as_mtx
);

1892 
	`´of_td©a_de¡roy_locked
(
tsdn
, 
td©a
, 
ev’_if_©ched
);

1893 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
td©as_mtx
);

1894 
	}
}

1897 
	$´of_td©a_d‘ach
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
)

1899 
boŞ
 
de¡roy_td©a
;

1901 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), 
td©a
->
lock
);

1902 ià(
td©a
->
©ched
) {

1903 
de¡roy_td©a
 = 
	`´of_td©a_should_de¡roy
(
	`tsd_tsdn
(
tsd
), 
td©a
,

1904 
Œue
);

1909 ià(!
de¡roy_td©a
)

1910 
td©a
->
©ched
 = 
çl£
;

1911 
	`tsd_´of_td©a_£t
(
tsd
, 
NULL
);

1913 
de¡roy_td©a
 = 
çl£
;

1914 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), 
td©a
->
lock
);

1915 ià(
de¡roy_td©a
)

1916 
	`´of_td©a_de¡roy
(
	`tsd_tsdn
(
tsd
), 
td©a
, 
Œue
);

1917 
	}
}

1919 
´of_td©a_t
 *

1920 
	$´of_td©a_»š™
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
)

1922 
ušt64_t
 
thr_uid
 = 
td©a
->thr_uid;

1923 
ušt64_t
 
thr_disüim
 = 
td©a
->thr_discrim + 1;

1924 *
th»ad_Çme
 = (
td©a
->th»ad_Çm!ğ
NULL
) ?

1925 
	`´of_th»ad_Çme_®loc
(
	`tsd_tsdn
(
tsd
), 
td©a
->
th»ad_Çme
è: 
NULL
;

1926 
boŞ
 
aùive
 = 
td©a
->active;

1928 
	`´of_td©a_d‘ach
(
tsd
, 
td©a
);

1929  (
	`´of_td©a_š™_im¶
(
	`tsd_tsdn
(
tsd
), 
thr_uid
, 
thr_disüim
,

1930 
th»ad_Çme
, 
aùive
));

1931 
	}
}

1933 
boŞ


1934 
	$´of_td©a_expœe
(
tsdn_t
 *
tsdn
, 
´of_td©a_t
 *
td©a
)

1936 
boŞ
 
de¡roy_td©a
;

1938 
	`m®loc_mu‹x_lock
(
tsdn
, 
td©a
->
lock
);

1939 ià(!
td©a
->
expœed
) {

1940 
td©a
->
expœed
 = 
Œue
;

1941 
de¡roy_td©a
 = 
td©a
->
©ched
 ? 
çl£
 :

1942 
	`´of_td©a_should_de¡roy
(
tsdn
, 
td©a
, 
çl£
);

1944 
de¡roy_td©a
 = 
çl£
;

1945 
	`m®loc_mu‹x_uÆock
(
tsdn
, 
td©a
->
lock
);

1947  (
de¡roy_td©a
);

1948 
	}
}

1950 
´of_td©a_t
 *

1951 
	$´of_td©a_»£t_™”
(
´of_td©a_Œ“_t
 *
td©as
, 
´of_td©a_t
 *
td©a
, *
¬g
)

1953 
tsdn_t
 *
tsdn
 = (tsdn_ˆ*)
¬g
;

1955  (
	`´of_td©a_expœe
(
tsdn
, 
td©a
è?d©¨: 
NULL
);

1956 
	}
}

1959 
	$´of_»£t
(
tsdn_t
 *
tsdn
, 
size_t
 
lg_§m¶e
)

1961 
´of_td©a_t
 *
Ãxt
;

1963 
	`as£¹
(
lg_§m¶e
 < ((
ušt64_t
) << 3));

1965 
	`m®loc_mu‹x_lock
(
tsdn
, &
´of_dump_mtx
);

1966 
	`m®loc_mu‹x_lock
(
tsdn
, &
td©as_mtx
);

1968 
lg_´of_§m¶e
 = 
lg_§m¶e
;

1970 
Ãxt
 = 
NULL
;

1972 
´of_td©a_t
 *
to_de¡roy
 = 
	`td©a_Œ“_™”
(&
td©as
, 
Ãxt
,

1973 
´of_td©a_»£t_™”
, (*)
tsdn
);

1974 ià(
to_de¡roy
 !ğ
NULL
) {

1975 
Ãxt
 = 
	`td©a_Œ“_Ãxt
(&
td©as
, 
to_de¡roy
);

1976 
	`´of_td©a_de¡roy_locked
(
tsdn
, 
to_de¡roy
, 
çl£
);

1978 
Ãxt
 = 
NULL
;

1979 } 
Ãxt
 !ğ
NULL
);

1981 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
td©as_mtx
);

1982 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
´of_dump_mtx
);

1983 
	}
}

1986 
	$´of_td©a_ş—nup
(
tsd_t
 *
tsd
)

1988 
´of_td©a_t
 *
td©a
;

1990 ià(!
cÚfig_´of
)

1993 
td©a
 = 
	`tsd_´of_td©a_g‘
(
tsd
);

1994 ià(
td©a
 !ğ
NULL
)

1995 
	`´of_td©a_d‘ach
(
tsd
, 
td©a
);

1996 
	}
}

1998 
boŞ


1999 
	$´of_aùive_g‘
(
tsdn_t
 *
tsdn
)

2001 
boŞ
 
´of_aùive_cu¼’t
;

2003 
	`m®loc_mu‹x_lock
(
tsdn
, &
´of_aùive_mtx
);

2004 
´of_aùive_cu¼’t
 = 
´of_aùive
;

2005 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
´of_aùive_mtx
);

2006  (
´of_aùive_cu¼’t
);

2007 
	}
}

2009 
boŞ


2010 
	$´of_aùive_£t
(
tsdn_t
 *
tsdn
, 
boŞ
 
aùive
)

2012 
boŞ
 
´of_aùive_Şd
;

2014 
	`m®loc_mu‹x_lock
(
tsdn
, &
´of_aùive_mtx
);

2015 
´of_aùive_Şd
 = 
´of_aùive
;

2016 
´of_aùive
 = 
aùive
;

2017 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
´of_aùive_mtx
);

2018  (
´of_aùive_Şd
);

2019 
	}
}

2022 
	$´of_th»ad_Çme_g‘
(
tsd_t
 *
tsd
)

2024 
´of_td©a_t
 *
td©a
;

2026 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

2027 ià(
td©a
 =ğ
NULL
)

2029  (
td©a
->
th»ad_Çme
 !ğ
NULL
 ?data->thread_name : "");

2030 
	}
}

2033 
	$´of_th»ad_Çme_®loc
(
tsdn_t
 *
tsdn
, cÚ¡ *
th»ad_Çme
)

2035 *
»t
;

2036 
size_t
 
size
;

2038 ià(
th»ad_Çme
 =ğ
NULL
)

2039  (
NULL
);

2041 
size
 = 
	`¡¾’
(
th»ad_Çme
) + 1;

2042 ià(
size
 == 1)

2045 
»t
 = 
	`ŸÎocztm
(
tsdn
, 
size
, 
	`size2šdex
(size), 
çl£
, 
NULL
, 
Œue
,

2046 
	`¬’a_g‘
(
TSDN_NULL
, 0, 
Œue
),rue);

2047 ià(
»t
 =ğ
NULL
)

2048  (
NULL
);

2049 
	`memıy
(
»t
, 
th»ad_Çme
, 
size
);

2050  (
»t
);

2051 
	}
}

2054 
	$´of_th»ad_Çme_£t
(
tsd_t
 *
tsd
, cÚ¡ *
th»ad_Çme
)

2056 
´of_td©a_t
 *
td©a
;

2057 
i
;

2058 *
s
;

2060 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

2061 ià(
td©a
 =ğ
NULL
)

2062  (
EAGAIN
);

2065 ià(
th»ad_Çme
 =ğ
NULL
)

2066  (
EFAULT
);

2067 
i
 = 0; 
th»ad_Çme
[i] != '\0'; i++) {

2068 
c
 = 
th»ad_Çme
[
i
];

2069 ià(!
	`isg¿ph
(
c
è&& !
	`isbÏnk
(c))

2070  (
EFAULT
);

2073 
s
 = 
	`´of_th»ad_Çme_®loc
(
	`tsd_tsdn
(
tsd
), 
th»ad_Çme
);

2074 ià(
s
 =ğ
NULL
)

2075  (
EAGAIN
);

2077 ià(
td©a
->
th»ad_Çme
 !ğ
NULL
) {

2078 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
td©a
->
th»ad_Çme
, 
NULL
, 
Œue
,rue);

2079 
td©a
->
th»ad_Çme
 = 
NULL
;

2081 ià(
	`¡¾’
(
s
) > 0)

2082 
td©a
->
th»ad_Çme
 = 
s
;

2084 
	}
}

2086 
boŞ


2087 
	$´of_th»ad_aùive_g‘
(
tsd_t
 *
tsd
)

2089 
´of_td©a_t
 *
td©a
;

2091 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

2092 ià(
td©a
 =ğ
NULL
)

2093  (
çl£
);

2094  (
td©a
->
aùive
);

2095 
	}
}

2097 
boŞ


2098 
	$´of_th»ad_aùive_£t
(
tsd_t
 *
tsd
, 
boŞ
 
aùive
)

2100 
´of_td©a_t
 *
td©a
;

2102 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

2103 ià(
td©a
 =ğ
NULL
)

2104  (
Œue
);

2105 
td©a
->
aùive
 =‡ctive;

2106  (
çl£
);

2107 
	}
}

2109 
boŞ


2110 
	$´of_th»ad_aùive_š™_g‘
(
tsdn_t
 *
tsdn
)

2112 
boŞ
 
aùive_š™
;

2114 
	`m®loc_mu‹x_lock
(
tsdn
, &
´of_th»ad_aùive_š™_mtx
);

2115 
aùive_š™
 = 
´of_th»ad_aùive_š™
;

2116 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
´of_th»ad_aùive_š™_mtx
);

2117  (
aùive_š™
);

2118 
	}
}

2120 
boŞ


2121 
	$´of_th»ad_aùive_š™_£t
(
tsdn_t
 *
tsdn
, 
boŞ
 
aùive_š™
)

2123 
boŞ
 
aùive_š™_Şd
;

2125 
	`m®loc_mu‹x_lock
(
tsdn
, &
´of_th»ad_aùive_š™_mtx
);

2126 
aùive_š™_Şd
 = 
´of_th»ad_aùive_š™
;

2127 
´of_th»ad_aùive_š™
 = 
aùive_š™
;

2128 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
´of_th»ad_aùive_š™_mtx
);

2129  (
aùive_š™_Şd
);

2130 
	}
}

2132 
boŞ


2133 
	$´of_gdump_g‘
(
tsdn_t
 *
tsdn
)

2135 
boŞ
 
´of_gdump_cu¼’t
;

2137 
	`m®loc_mu‹x_lock
(
tsdn
, &
´of_gdump_mtx
);

2138 
´of_gdump_cu¼’t
 = 
´of_gdump_v®
;

2139 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
´of_gdump_mtx
);

2140  (
´of_gdump_cu¼’t
);

2141 
	}
}

2143 
boŞ


2144 
	$´of_gdump_£t
(
tsdn_t
 *
tsdn
, 
boŞ
 
gdump
)

2146 
boŞ
 
´of_gdump_Şd
;

2148 
	`m®loc_mu‹x_lock
(
tsdn
, &
´of_gdump_mtx
);

2149 
´of_gdump_Şd
 = 
´of_gdump_v®
;

2150 
´of_gdump_v®
 = 
gdump
;

2151 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
´of_gdump_mtx
);

2152  (
´of_gdump_Şd
);

2153 
	}
}

2156 
	$´of_boÙ0
()

2159 
	`ÿs£¹
(
cÚfig_´of
);

2161 
	`memıy
(
İt_´of_´efix
, 
PROF_PREFIX_DEFAULT
,

2162 (
PROF_PREFIX_DEFAULT
));

2163 
	}
}

2166 
	$´of_boÙ1
()

2169 
	`ÿs£¹
(
cÚfig_´of
);

2176 ià(
İt_´of_Ëak
 && !
İt_´of
) {

2181 
İt_´of
 = 
Œue
;

2182 
İt_´of_gdump
 = 
çl£
;

2183 } ià(
İt_´of
) {

2184 ià(
İt_lg_´of_š‹rv®
 >= 0) {

2185 
´of_š‹rv®
 = (((
ušt64_t
)1U) <<

2186 
İt_lg_´of_š‹rv®
);

2189 
	}
}

2191 
boŞ


2192 
	$´of_boÙ2
(
tsdn_t
 *
tsdn
)

2195 
	`ÿs£¹
(
cÚfig_´of
);

2197 ià(
İt_´of
) {

2198 
i
;

2200 
lg_´of_§m¶e
 = 
İt_lg_´of_§m¶e
;

2202 
´of_aùive
 = 
İt_´of_aùive
;

2203 ià(
	`m®loc_mu‹x_š™
(&
´of_aùive_mtx
, "prof_active",

2204 
WITNESS_RANK_PROF_ACTIVE
))

2205  (
Œue
);

2207 
´of_gdump_v®
 = 
İt_´of_gdump
;

2208 ià(
	`m®loc_mu‹x_š™
(&
´of_gdump_mtx
, "prof_gdump",

2209 
WITNESS_RANK_PROF_GDUMP
))

2210  (
Œue
);

2212 
´of_th»ad_aùive_š™
 = 
İt_´of_th»ad_aùive_š™
;

2213 ià(
	`m®loc_mu‹x_š™
(&
´of_th»ad_aùive_š™_mtx
,

2215 
WITNESS_RANK_PROF_THREAD_ACTIVE_INIT
))

2216  (
Œue
);

2218 ià(
	`ckh_Ãw
(
tsdn
, &
bt2gùx
, 
PROF_CKH_MINITEMS
, 
´of_bt_hash
,

2219 
´of_bt_keycomp
))

2220  (
Œue
);

2221 ià(
	`m®loc_mu‹x_š™
(&
bt2gùx_mtx
, "prof_bt2gctx",

2222 
WITNESS_RANK_PROF_BT2GCTX
))

2223  (
Œue
);

2225 
	`td©a_Œ“_Ãw
(&
td©as
);

2226 ià(
	`m®loc_mu‹x_š™
(&
td©as_mtx
, "prof_tdatas",

2227 
WITNESS_RANK_PROF_TDATAS
))

2228  (
Œue
);

2230 
Ãxt_thr_uid
 = 0;

2231 ià(
	`m®loc_mu‹x_š™
(&
Ãxt_thr_uid_mtx
, "prof_next_thr_uid",

2232 
WITNESS_RANK_PROF_NEXT_THR_UID
))

2233  (
Œue
);

2235 ià(
	`m®loc_mu‹x_š™
(&
´of_dump_£q_mtx
, "prof_dump_seq",

2236 
WITNESS_RANK_PROF_DUMP_SEQ
))

2237  (
Œue
);

2238 ià(
	`m®loc_mu‹x_š™
(&
´of_dump_mtx
, "prof_dump",

2239 
WITNESS_RANK_PROF_DUMP
))

2240  (
Œue
);

2242 ià(
İt_´of_fš®
 && 
İt_´of_´efix
[0] != '\0' &&

2243 
	`©ex™
(
´of_fdump
) != 0) {

2244 
	`m®loc_wr™e
("<jemalloc>: Error in‡texit()\n");

2245 ià(
İt_abÜt
)

2246 
	`abÜt
();

2249 
gùx_locks
 = (
m®loc_mu‹x_t
 *)
	`ba£_®loc
(
tsdn
, 
PROF_NCTX_LOCKS


2250 * (
m®loc_mu‹x_t
));

2251 ià(
gùx_locks
 =ğ
NULL
)

2252  (
Œue
);

2253 
i
 = 0; i < 
PROF_NCTX_LOCKS
; i++) {

2254 ià(
	`m®loc_mu‹x_š™
(&
gùx_locks
[
i
], "prof_gctx",

2255 
WITNESS_RANK_PROF_GCTX
))

2256  (
Œue
);

2259 
td©a_locks
 = (
m®loc_mu‹x_t
 *)
	`ba£_®loc
(
tsdn
,

2260 
PROF_NTDATA_LOCKS
 * (
m®loc_mu‹x_t
));

2261 ià(
td©a_locks
 =ğ
NULL
)

2262  (
Œue
);

2263 
i
 = 0; i < 
PROF_NTDATA_LOCKS
; i++) {

2264 ià(
	`m®loc_mu‹x_š™
(&
td©a_locks
[
i
], "prof_tdata",

2265 
WITNESS_RANK_PROF_TDATA
))

2266  (
Œue
);

2270 #ifdeà
JEMALLOC_PROF_LIBGCC


2275 
	`_Unwšd_BackŒaû
(
´of_unwšd_š™_ÿÎback
, 
NULL
);

2278 
´of_boÙed
 = 
Œue
;

2280  (
çl£
);

2281 
	}
}

2284 
	$´of_´efÜk0
(
tsdn_t
 *
tsdn
)

2287 ià(
İt_´of
) {

2288 
i
;

2290 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
´of_dump_mtx
);

2291 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
bt2gùx_mtx
);

2292 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
td©as_mtx
);

2293 
i
 = 0; i < 
PROF_NTDATA_LOCKS
; i++)

2294 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
td©a_locks
[
i
]);

2295 
i
 = 0; i < 
PROF_NCTX_LOCKS
; i++)

2296 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
gùx_locks
[
i
]);

2298 
	}
}

2301 
	$´of_´efÜk1
(
tsdn_t
 *
tsdn
)

2304 ià(
İt_´of
) {

2305 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
´of_aùive_mtx
);

2306 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
´of_dump_£q_mtx
);

2307 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
´of_gdump_mtx
);

2308 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
Ãxt_thr_uid_mtx
);

2309 
	`m®loc_mu‹x_´efÜk
(
tsdn
, &
´of_th»ad_aùive_š™_mtx
);

2311 
	}
}

2314 
	$´of_po¡fÜk_·»Á
(
tsdn_t
 *
tsdn
)

2317 ià(
İt_´of
) {

2318 
i
;

2320 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
,

2321 &
´of_th»ad_aùive_š™_mtx
);

2322 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
Ãxt_thr_uid_mtx
);

2323 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
´of_gdump_mtx
);

2324 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
´of_dump_£q_mtx
);

2325 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
´of_aùive_mtx
);

2326 
i
 = 0; i < 
PROF_NCTX_LOCKS
; i++)

2327 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
gùx_locks
[
i
]);

2328 
i
 = 0; i < 
PROF_NTDATA_LOCKS
; i++)

2329 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
td©a_locks
[
i
]);

2330 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
td©as_mtx
);

2331 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
bt2gùx_mtx
);

2332 
	`m®loc_mu‹x_po¡fÜk_·»Á
(
tsdn
, &
´of_dump_mtx
);

2334 
	}
}

2337 
	$´of_po¡fÜk_chd
(
tsdn_t
 *
tsdn
)

2340 ià(
İt_´of
) {

2341 
i
;

2343 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
´of_th»ad_aùive_š™_mtx
);

2344 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
Ãxt_thr_uid_mtx
);

2345 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
´of_gdump_mtx
);

2346 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
´of_dump_£q_mtx
);

2347 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
´of_aùive_mtx
);

2348 
i
 = 0; i < 
PROF_NCTX_LOCKS
; i++)

2349 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
gùx_locks
[
i
]);

2350 
i
 = 0; i < 
PROF_NTDATA_LOCKS
; i++)

2351 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
td©a_locks
[
i
]);

2352 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
td©as_mtx
);

2353 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
bt2gùx_mtx
);

2354 
	`m®loc_mu‹x_po¡fÜk_chd
(
tsdn
, &
´of_dump_mtx
);

2356 
	}
}

	@dep/jemalloc-4.2.0/src/quarantine.c

1 
	#JEMALLOC_QUARANTINE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

8 
	#QUARANTINE_STATE_REINCARNATED
 ((
qu¬ªtše_t
 *)(
ušŒ_t
)1)

	)

9 
	#QUARANTINE_STATE_PURGATORY
 ((
qu¬ªtše_t
 *)(
ušŒ_t
)2)

	)

10 
	#QUARANTINE_STATE_MAX
 
QUARANTINE_STATE_PURGATORY


	)

15 
qu¬ªtše_t
 *
qu¬ªtše_grow
(
tsd_t
 *
tsd
, qu¬ªtše_ˆ*
qu¬ªtše
);

16 
qu¬ªtše_d¿š_Úe
(
tsdn_t
 *
tsdn
, 
qu¬ªtše_t
 *
qu¬ªtše
);

17 
qu¬ªtše_d¿š
(
tsdn_t
 *
tsdn
, 
qu¬ªtše_t
 *
qu¬ªtše
,

18 
size_t
 
uµ”_bound
);

22 
qu¬ªtše_t
 *

23 
	$qu¬ªtše_š™
(
tsdn_t
 *
tsdn
, 
size_t
 
lg_maxobjs
)

25 
qu¬ªtše_t
 *
qu¬ªtše
;

26 
size_t
 
size
;

28 
size
 = 
	`off£tof
(
qu¬ªtše_t
, 
objs
è+ ((
	`ZU
(1è<< 
lg_maxobjs
) *

29 (
qu¬ªtše_obj_t
));

30 
qu¬ªtše
 = (
qu¬ªtše_t
 *)
	`ŸÎocztm
(
tsdn
, 
size
, 
	`size2šdex
(size),

31 
çl£
, 
NULL
, 
Œue
, 
	`¬’a_g‘
(
TSDN_NULL
, 0,rue),rue);

32 ià(
qu¬ªtše
 =ğ
NULL
)

33  (
NULL
);

34 
qu¬ªtše
->
curby‹s
 = 0;

35 
qu¬ªtše
->
curobjs
 = 0;

36 
qu¬ªtše
->
fœ¡
 = 0;

37 
qu¬ªtše
->
lg_maxobjs
 =†g_maxobjs;

39  (
qu¬ªtše
);

40 
	}
}

43 
	$qu¬ªtše_®loc_hook_wÜk
(
tsd_t
 *
tsd
)

45 
qu¬ªtše_t
 *
qu¬ªtše
;

47 ià(!
	`tsd_nomš®
(
tsd
))

50 
qu¬ªtše
 = 
	`qu¬ªtše_š™
(
	`tsd_tsdn
(
tsd
), 
LG_MAXOBJS_INIT
);

55 ià(
	`tsd_qu¬ªtše_g‘
(
tsd
è=ğ
NULL
)

56 
	`tsd_qu¬ªtše_£t
(
tsd
, 
qu¬ªtše
);

58 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
qu¬ªtše
, 
NULL
, 
Œue
,rue);

59 
	}
}

61 
qu¬ªtše_t
 *

62 
	$qu¬ªtše_grow
(
tsd_t
 *
tsd
, 
qu¬ªtše_t
 *
qu¬ªtše
)

64 
qu¬ªtše_t
 *
»t
;

66 
»t
 = 
	`qu¬ªtše_š™
(
	`tsd_tsdn
(
tsd
), 
qu¬ªtše
->
lg_maxobjs
 + 1);

67 ià(
»t
 =ğ
NULL
) {

68 
	`qu¬ªtše_d¿š_Úe
(
	`tsd_tsdn
(
tsd
), 
qu¬ªtše
);

69  (
qu¬ªtše
);

72 
»t
->
curby‹s
 = 
qu¬ªtše
->curbytes;

73 
»t
->
curobjs
 = 
qu¬ªtše
->curobjs;

74 ià(
qu¬ªtše
->
fœ¡
 + qu¬ªtše->
curobjs
 <ğ(
	`ZU
(1) <<

75 
qu¬ªtše
->
lg_maxobjs
)) {

77 
	`memıy
(
»t
->
objs
, &
qu¬ªtše
->objs[qu¬ªtše->
fœ¡
],

78 
qu¬ªtše
->
curobjs
 * (
qu¬ªtše_obj_t
));

81 
size_t
 
ncİy_a
 = (
	`ZU
(1è<< 
qu¬ªtše
->
lg_maxobjs
) -

82 
qu¬ªtše
->
fœ¡
;

83 
size_t
 
ncİy_b
 = 
qu¬ªtše
->
curobjs
 - 
ncİy_a
;

85 
	`memıy
(
»t
->
objs
, &
qu¬ªtše
->objs[qu¬ªtše->
fœ¡
], 
ncİy_a


86 * (
qu¬ªtše_obj_t
));

87 
	`memıy
(&
»t
->
objs
[
ncİy_a
], 
qu¬ªtše
->objs, 
ncİy_b
 *

88 (
qu¬ªtše_obj_t
));

90 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
qu¬ªtše
, 
NULL
, 
Œue
,rue);

92 
	`tsd_qu¬ªtše_£t
(
tsd
, 
»t
);

93  (
»t
);

94 
	}
}

97 
	$qu¬ªtše_d¿š_Úe
(
tsdn_t
 *
tsdn
, 
qu¬ªtše_t
 *
qu¬ªtše
)

99 
qu¬ªtše_obj_t
 *
obj
 = &
qu¬ªtše
->
objs
[qu¬ªtše->
fœ¡
];

100 
	`as£¹
(
obj
->
usize
 =ğ
	`i§Îoc
(
tsdn
, obj->
±r
, 
cÚfig_´of
));

101 
	`id®loùm
(
tsdn
, 
obj
->
±r
, 
NULL
, 
çl£
, 
Œue
);

102 
qu¬ªtše
->
curby‹s
 -ğ
obj
->
usize
;

103 
qu¬ªtše
->
curobjs
--;

104 
qu¬ªtše
->
fœ¡
 = (qu¬ªtše->fœ¡ + 1è& ((
	`ZU
(1) <<

105 
qu¬ªtše
->
lg_maxobjs
) - 1);

106 
	}
}

109 
	$qu¬ªtše_d¿š
(
tsdn_t
 *
tsdn
, 
qu¬ªtše_t
 *
qu¬ªtše
, 
size_t
 
uµ”_bound
)

112 
qu¬ªtše
->
curby‹s
 > 
uµ”_bound
 && qu¬ªtše->
curobjs
 > 0)

113 
	`qu¬ªtše_d¿š_Úe
(
tsdn
, 
qu¬ªtše
);

114 
	}
}

117 
	$qu¬ªtše
(
tsd_t
 *
tsd
, *
±r
)

119 
qu¬ªtše_t
 *
qu¬ªtše
;

120 
size_t
 
usize
 = 
	`i§Îoc
(
	`tsd_tsdn
(
tsd
), 
±r
, 
cÚfig_´of
);

122 
	`ÿs£¹
(
cÚfig_fl
);

123 
	`as£¹
(
İt_qu¬ªtše
);

125 ià((
qu¬ªtše
 = 
	`tsd_qu¬ªtše_g‘
(
tsd
)è=ğ
NULL
) {

126 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
±r
, 
NULL
, 
çl£
, 
Œue
);

133 ià(
qu¬ªtše
->
curby‹s
 + 
usize
 > 
İt_qu¬ªtše
) {

134 
size_t
 
uµ”_bound
 = (
İt_qu¬ªtše
 >ğ
usize
) ? opt_quarantine

135 - 
usize
 : 0;

136 
	`qu¬ªtše_d¿š
(
	`tsd_tsdn
(
tsd
), 
qu¬ªtše
, 
uµ”_bound
);

139 ià(
qu¬ªtše
->
curobjs
 =ğ(
	`ZU
(1è<< qu¬ªtše->
lg_maxobjs
))

140 
qu¬ªtše
 = 
	`qu¬ªtše_grow
(
tsd
, quarantine);

142 
	`as£¹
(
qu¬ªtše
->
curobjs
 < (
	`ZU
(1è<< qu¬ªtše->
lg_maxobjs
));

144 ià(
qu¬ªtše
->
curby‹s
 + 
usize
 <ğ
İt_qu¬ªtše
) {

145 
size_t
 
off£t
 = (
qu¬ªtše
->
fœ¡
 + qu¬ªtše->
curobjs
) &

146 ((
	`ZU
(1è<< 
qu¬ªtše
->
lg_maxobjs
) - 1);

147 
qu¬ªtše_obj_t
 *
obj
 = &
qu¬ªtše
->
objs
[
off£t
];

148 
obj
->
±r
 =…tr;

149 
obj
->
usize
 = usize;

150 
qu¬ªtše
->
curby‹s
 +ğ
usize
;

151 
qu¬ªtše
->
curobjs
++;

152 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

157 ià((!
cÚfig_v®gršd
 || 
	`lik–y
(!
š_v®gršd
))

158 && 
usize
 <ğ
SMALL_MAXCLASS
)

159 
	`¬’a_qu¬ªtše_junk_sm®l
(
±r
, 
usize
);

161 
	`mem£t
(
±r
, 
JEMALLOC_FREE_JUNK
, 
usize
);

164 
	`as£¹
(
qu¬ªtše
->
curby‹s
 == 0);

165 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
±r
, 
NULL
, 
çl£
, 
Œue
);

167 
	}
}

170 
	$qu¬ªtše_ş—nup
(
tsd_t
 *
tsd
)

172 
qu¬ªtše_t
 *
qu¬ªtše
;

174 ià(!
cÚfig_fl
)

177 
qu¬ªtše
 = 
	`tsd_qu¬ªtše_g‘
(
tsd
);

178 ià(
qu¬ªtše
 !ğ
NULL
) {

179 
	`qu¬ªtše_d¿š
(
	`tsd_tsdn
(
tsd
), 
qu¬ªtše
, 0);

180 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
qu¬ªtše
, 
NULL
, 
Œue
,rue);

181 
	`tsd_qu¬ªtše_£t
(
tsd
, 
NULL
);

183 
	}
}

	@dep/jemalloc-4.2.0/src/rtree.c

1 
	#JEMALLOC_RTREE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

5 
	$hmš
(
ha
, 
hb
)

8  (
ha
 < 
hb
 ? ha : hb);

9 
	}
}

12 
boŞ


13 
	$¹»e_Ãw
(
¹»e_t
 *
¹»e
, 
b™s
, 
¹»e_node_®loc_t
 *
®loc
,

14 
¹»e_node_d®loc_t
 *
d®loc
)

16 
b™s_š_Ëaf
, 
height
, 
i
;

18 
	`as£¹
(
RTREE_HEIGHT_MAX
 =ğ((
	`ZU
(1è<< (
LG_SIZEOF_PTR
+3)) /

19 
RTREE_BITS_PER_LEVEL
));

20 
	`as£¹
(
b™s
 > 0 && b™ <ğ((
ušŒ_t
) << 3));

22 
b™s_š_Ëaf
 = (
b™s
 % 
RTREE_BITS_PER_LEVEL
) == 0 ? RTREE_BITS_PER_LEVEL

23 : (
b™s
 % 
RTREE_BITS_PER_LEVEL
);

24 ià(
b™s
 > 
b™s_š_Ëaf
) {

25 
height
 = 1 + (
b™s
 - 
b™s_š_Ëaf
è/ 
RTREE_BITS_PER_LEVEL
;

26 ià((
height
-1è* 
RTREE_BITS_PER_LEVEL
 + 
b™s_š_Ëaf
 !ğ
b™s
)

27 
height
++;

29 
height
 = 1;

30 
	`as£¹
((
height
-1è* 
RTREE_BITS_PER_LEVEL
 + 
b™s_š_Ëaf
 =ğ
b™s
);

32 
¹»e
->
®loc
 =‡lloc;

33 
¹»e
->
d®loc
 = dalloc;

34 
¹»e
->
height
 = height;

37 
¹»e
->
Ëv–s
[0].
subŒ“
 = 
NULL
;

38 
¹»e
->
Ëv–s
[0].
b™s
 = (
height
 > 1è? 
RTREE_BITS_PER_LEVEL
 :

39 
b™s_š_Ëaf
;

40 
¹»e
->
Ëv–s
[0].
cumb™s
 =„Œ“->Ëv–s[0].
b™s
;

42 
i
 = 1; i < 
height
-1; i++) {

43 
¹»e
->
Ëv–s
[
i
].
subŒ“
 = 
NULL
;

44 
¹»e
->
Ëv–s
[
i
].
b™s
 = 
RTREE_BITS_PER_LEVEL
;

45 
¹»e
->
Ëv–s
[
i
].
cumb™s
 =„tree->levels[i-1].cumbits +

46 
RTREE_BITS_PER_LEVEL
;

49 ià(
height
 > 1) {

50 
¹»e
->
Ëv–s
[
height
-1].
subŒ“
 = 
NULL
;

51 
¹»e
->
Ëv–s
[
height
-1].
b™s
 = 
b™s_š_Ëaf
;

52 
¹»e
->
Ëv–s
[
height
-1].
cumb™s
 = 
b™s
;

56 
i
 = 0; i < 
RTREE_HEIGHT_MAX
; i++) {

57 
¹»e
->
¡¬t_Ëv–
[
i
] = 
	`hmš
(
RTREE_HEIGHT_MAX
 - 1 - i, 
height
 -

61  (
çl£
);

62 
	}
}

65 
	$¹»e_d–‘e_subŒ“
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
node
, 
Ëv–
)

68 ià(
Ëv–
 + 1 < 
¹»e
->
height
) {

69 
size_t
 
nchd»n
, 
i
;

71 
nchd»n
 = 
	`ZU
(1è<< 
¹»e
->
Ëv–s
[
Ëv–
].
b™s
;

72 
i
 = 0; i < 
nchd»n
; i++) {

73 
¹»e_node_–m_t
 *
chd
 = 
node
[
i
].child;

74 ià(
chd
 !ğ
NULL
)

75 
	`¹»e_d–‘e_subŒ“
(
¹»e
, 
chd
, 
Ëv–
 + 1);

78 
¹»e
->
	`d®loc
(
node
);

79 
	}
}

82 
	$¹»e_d–‘e
(
¹»e_t
 *
¹»e
)

84 
i
;

86 
i
 = 0; i < 
¹»e
->
height
; i++) {

87 
¹»e_node_–m_t
 *
subŒ“
 = 
¹»e
->
Ëv–s
[
i
].subtree;

88 ià(
subŒ“
 !ğ
NULL
)

89 
	`¹»e_d–‘e_subŒ“
(
¹»e
, 
subŒ“
, 
i
);

91 
	}
}

93 
¹»e_node_–m_t
 *

94 
	$¹»e_node_š™
(
¹»e_t
 *
¹»e
, 
Ëv–
, 
¹»e_node_–m_t
 **
–mp
)

96 
¹»e_node_–m_t
 *
node
;

98 ià(
	`©omic_ÿs_p
((**)
–mp
, 
NULL
, 
RTREE_NODE_INITIALIZING
)) {

104 
CPU_SPINWAIT
;

105 
node
 = 
	`©omic_»ad_p
((**)
–mp
);

106 } 
node
 =ğ
RTREE_NODE_INITIALIZING
);

108 
node
 = 
¹»e
->
	`®loc
(
	`ZU
(1è<<„Œ“->
Ëv–s
[
Ëv–
].
b™s
);

109 ià(
node
 =ğ
NULL
)

110  (
NULL
);

111 
	`©omic_wr™e_p
((**)
–mp
, 
node
);

114  (
node
);

115 
	}
}

117 
¹»e_node_–m_t
 *

118 
	$¹»e_subŒ“_»ad_h¬d
(
¹»e_t
 *
¹»e
, 
Ëv–
)

121  (
	`¹»e_node_š™
(
¹»e
, 
Ëv–
, &¹»e->
Ëv–s
[Ëv–].
subŒ“
));

122 
	}
}

124 
¹»e_node_–m_t
 *

125 
	$¹»e_chd_»ad_h¬d
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
, 
Ëv–
)

128  (
	`¹»e_node_š™
(
¹»e
, 
Ëv–
, &
–m
->
chd
));

129 
	}
}

	@dep/jemalloc-4.2.0/src/stats.c

1 
	#JEMALLOC_STATS_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

4 
	#CTL_GET
(
n
, 
v
, 
t
) do { \

5 
size_t
 
sz
 = (
t
); \

6 
	`xm®lùl
(
n
, 
v
, &
sz
, 
NULL
, 0); \

7 } 0)

	)

9 
	#CTL_M2_GET
(
n
, 
i
, 
v
, 
t
) do { \

10 
size_t
 
mib
[6]; \

11 
size_t
 
mibËn
 = (
mib
) / (size_t); \

12 
size_t
 
sz
 = (
t
); \

13 
	`xm®lùÊam‘omib
(
n
, 
mib
, &
mibËn
); \

14 
mib
[2] = (
i
); \

15 
	`xm®lùlbymib
(
mib
, 
mibËn
, 
v
, &
sz
, 
NULL
, 0); \

16 } 0)

	)

18 
	#CTL_M2_M4_GET
(
n
, 
i
, 
j
, 
v
, 
t
) do { \

19 
size_t
 
mib
[6]; \

20 
size_t
 
mibËn
 = (
mib
) / (size_t); \

21 
size_t
 
sz
 = (
t
); \

22 
	`xm®lùÊam‘omib
(
n
, 
mib
, &
mibËn
); \

23 
mib
[2] = (
i
); \

24 
mib
[4] = (
j
); \

25 
	`xm®lùlbymib
(
mib
, 
mibËn
, 
v
, &
sz
, 
NULL
, 0); \

26 } 0)

	)

31 
boŞ
 
	gİt_¡©s_´št
 = 
çl£
;

33 
size_t
 
	g¡©s_ÿùive
 = 0;

38 
¡©s_¬’a_bšs_´št
((*
wr™e_cb
)(*, const *),

39 *
cbİaque
, 
i
);

40 
	`¡©s_¬’a_Ìuns_´št
((*
wr™e_cb
)(*, const *),

41 *
cbİaque
, 
i
);

42 
	`¡©s_¬’a_hchunks_´št
(

43 (*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
, 
i
);

44 
	`¡©s_¬’a_´št
((*
wr™e_cb
)(*, const *),

45 *
cbİaque
, 
i
, 
boŞ
 
bšs
, boŞ 
Ïrge
, boŞ 
huge
);

50 
	$¡©s_¬’a_bšs_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

51 
i
)

53 
size_t
 
·ge
;

54 
boŞ
 
cÚfig_tÿche
, 
š_g­
;

55 
nbšs
, 
j
;

57 
	`CTL_GET
("¬’as.·ge", &
·ge
, 
size_t
);

59 
	`CTL_GET
("cÚfig.tÿche", &
cÚfig_tÿche
, 
boŞ
);

60 ià(
cÚfig_tÿche
) {

61 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

67 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

72 
	`CTL_GET
("¬’as.nbšs", &
nbšs
, );

73 
j
 = 0, 
š_g­
 = 
çl£
; j < 
nbšs
; j++) {

74 
ušt64_t
 
Äuns
;

76 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.Äuns", 
i
, 
j
, &
Äuns
,

77 
ušt64_t
);

78 ià(
Äuns
 == 0)

79 
š_g­
 = 
Œue
;

81 
size_t
 
»g_size
, 
run_size
, 
cu¼egs
, 
ava»gs
, 
mli
;

82 
size_t
 
cu¼uns
;

83 
ušt32_t
 
Äegs
;

84 
ušt64_t
 
nm®loc
, 
nd®loc
, 
Äeque¡s
, 
nfls
, 
næushes
;

85 
ušt64_t
 
»runs
;

86 
ut
[6];

88 ià(
š_g­
) {

89 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

91 
š_g­
 = 
çl£
;

93 
	`CTL_M2_GET
("¬’as.bš.0.size", 
j
, &
»g_size
, 
size_t
);

94 
	`CTL_M2_GET
("¬’as.bš.0.Äegs", 
j
, &
Äegs
, 
ušt32_t
);

95 
	`CTL_M2_GET
("¬’as.bš.0.run_size", 
j
, &
run_size
,

96 
size_t
);

97 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.nm®loc", 
i
, 
j
,

98 &
nm®loc
, 
ušt64_t
);

99 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.nd®loc", 
i
, 
j
,

100 &
nd®loc
, 
ušt64_t
);

101 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.cu¼egs", 
i
, 
j
,

102 &
cu¼egs
, 
size_t
);

103 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.Äeque¡s", 
i
, 
j
,

104 &
Äeque¡s
, 
ušt64_t
);

105 ià(
cÚfig_tÿche
) {

106 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.nfls", 
i
,

107 
j
, &
nfls
, 
ušt64_t
);

108 
	`CTL_M2_M4_GET
("stats.arenas.0.bins.0.nflushes",

109 
i
, 
j
, &
næushes
, 
ušt64_t
);

111 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.Ä”uns", 
i
, 
j
,

112 &
»runs
, 
ušt64_t
);

113 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.cu¼uns", 
i
, 
j
,

114 &
cu¼uns
, 
size_t
);

116 
ava»gs
 = 
Äegs
 * 
cu¼uns
;

117 
mli
 = (
ava»gs
 !ğ0è? (1000 * 
cu¼egs
) /‡vailregs

119 
	`as£¹
(
mli
 <= 1000);

120 ià(
mli
 < 10) {

121 
	`m®loc_¢´štf
(
ut
, (util),

122 "0.00%zu", 
mli
);

123 } ià(
mli
 < 100) {

124 
	`m®loc_¢´štf
(
ut
, (util), "0.0%zu",

125 
mli
);

126 } ià(
mli
 < 1000) {

127 
	`m®loc_¢´štf
(
ut
, (util), "0.%zu",

128 
mli
);

130 
	`m®loc_¢´štf
(
ut
, (util), "1");

132 ià(
cÚfig_tÿche
) {

133 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

134 "%20zu %3u %12zu %12"
FMTu64


135 " %12"
FMTu64
" %12"FMTu64" %12zu"

136 " %12zu %4u %3zu %-5 %12"
FMTu64


137 " %12"
FMTu64
" %12"FMTu64" %12"FMTu64"\n",

138 
»g_size
, 
j
, 
cu¼egs
 *„eg_size, 
nm®loc
,

139 
nd®loc
, 
Äeque¡s
, 
cu¼egs
, 
cu¼uns
, 
Äegs
,

140 
run_size
 / 
·ge
, 
ut
, 
nfls
, 
næushes
,

141 
Äuns
, 
»runs
);

143 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

144 "%20zu %3u %12zu %12"
FMTu64


145 " %12"
FMTu64
" %12"FMTu64" %12zu"

146 " %12zu %4u %3zu %-5 %12"
FMTu64


147 " %12"
FMTu64
"\n",

148 
»g_size
, 
j
, 
cu¼egs
 *„eg_size, 
nm®loc
,

149 
nd®loc
, 
Äeque¡s
, 
cu¼egs
, 
cu¼uns
, 
Äegs
,

150 
run_size
 / 
·ge
, 
ut
, 
Äuns
, 
»runs
);

154 ià(
š_g­
) {

155 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

158 
	}
}

161 
	$¡©s_¬’a_Ìuns_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

162 
i
)

164 
nbšs
, 
Æruns
, 
j
;

165 
boŞ
 
š_g­
;

167 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

170 
	`CTL_GET
("¬’as.nbšs", &
nbšs
, );

171 
	`CTL_GET
("¬’as.Æruns", &
Æruns
, );

172 
j
 = 0, 
š_g­
 = 
çl£
; j < 
Æruns
; j++) {

173 
ušt64_t
 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

174 
size_t
 
run_size
, 
cu¼uns
;

176 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.Ìuns.0.nm®loc", 
i
, 
j
, &
nm®loc
,

177 
ušt64_t
);

178 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.Ìuns.0.nd®loc", 
i
, 
j
, &
nd®loc
,

179 
ušt64_t
);

180 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.Ìuns.0.Äeque¡s", 
i
, 
j
,

181 &
Äeque¡s
, 
ušt64_t
);

182 ià(
Äeque¡s
 == 0)

183 
š_g­
 = 
Œue
;

185 
	`CTL_M2_GET
("¬’as.Ìun.0.size", 
j
, &
run_size
, 
size_t
);

186 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.Ìuns.0.cu¼uns", 
i
, 
j
,

187 &
cu¼uns
, 
size_t
);

188 ià(
š_g­
) {

189 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

191 
š_g­
 = 
çl£
;

193 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

194 "%20zu %3u %12zu %12"
FMTu64
" %12"FMTu64

195 " %12"
FMTu64
" %12zu\n",

196 
run_size
, 
nbšs
 + 
j
, 
cu¼uns
 *„un_size, 
nm®loc
,

197 
nd®loc
, 
Äeque¡s
, 
cu¼uns
);

200 ià(
š_g­
) {

201 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

204 
	}
}

207 
	$¡©s_¬’a_hchunks_´št
((*
wr™e_cb
)(*, const *),

208 *
cbİaque
, 
i
)

210 
nbšs
, 
Æruns
, 
nhchunks
, 
j
;

211 
boŞ
 
š_g­
;

213 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

216 
	`CTL_GET
("¬’as.nbšs", &
nbšs
, );

217 
	`CTL_GET
("¬’as.Æruns", &
Æruns
, );

218 
	`CTL_GET
("¬’as.nhchunks", &
nhchunks
, );

219 
j
 = 0, 
š_g­
 = 
çl£
; j < 
nhchunks
; j++) {

220 
ušt64_t
 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

221 
size_t
 
hchunk_size
, 
curhchunks
;

223 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.hchunks.0.nm®loc", 
i
, 
j
,

224 &
nm®loc
, 
ušt64_t
);

225 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.hchunks.0.nd®loc", 
i
, 
j
,

226 &
nd®loc
, 
ušt64_t
);

227 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.hchunks.0.Äeque¡s", 
i
, 
j
,

228 &
Äeque¡s
, 
ušt64_t
);

229 ià(
Äeque¡s
 == 0)

230 
š_g­
 = 
Œue
;

232 
	`CTL_M2_GET
("¬’as.hchunk.0.size", 
j
, &
hchunk_size
,

233 
size_t
);

234 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.hchunks.0.curhchunks", 
i
,

235 
j
, &
curhchunks
, 
size_t
);

236 ià(
š_g­
) {

237 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

239 
š_g­
 = 
çl£
;

241 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

242 "%20zu %3u %12zu %12"
FMTu64
" %12"FMTu64

243 " %12"
FMTu64
" %12zu\n",

244 
hchunk_size
, 
nbšs
 + 
Æruns
 + 
j
,

245 
curhchunks
 * 
hchunk_size
, 
nm®loc
, 
nd®loc
,

246 
Äeque¡s
, 
curhchunks
);

249 ià(
š_g­
) {

250 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

253 
	}
}

256 
	$¡©s_¬’a_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

257 
i
, 
boŞ
 
bšs
, boŞ 
Ïrge
, boŞ 
huge
)

259 
Áh»ads
;

260 cÚ¡ *
dss
;

261 
ssize_t
 
lg_dœty_muÉ
, 
deÿy_time
;

262 
size_t
 
·ge
, 
·ùive
, 
pdœty
, 
m­³d
, 
»šed
;

263 
size_t
 
m‘ad©a_m­³d
, 
m‘ad©a_®loÿ‹d
;

264 
ušt64_t
 
Åurge
, 
nmadvi£
, 
purged
;

265 
size_t
 
sm®l_®loÿ‹d
;

266 
ušt64_t
 
sm®l_nm®loc
, 
sm®l_nd®loc
, 
sm®l_Äeque¡s
;

267 
size_t
 
Ïrge_®loÿ‹d
;

268 
ušt64_t
 
Ïrge_nm®loc
, 
Ïrge_nd®loc
, 
Ïrge_Äeque¡s
;

269 
size_t
 
huge_®loÿ‹d
;

270 
ušt64_t
 
huge_nm®loc
, 
huge_nd®loc
, 
huge_Äeque¡s
;

272 
	`CTL_GET
("¬’as.·ge", &
·ge
, 
size_t
);

274 
	`CTL_M2_GET
("¡©s.¬’as.0.Áh»ads", 
i
, &
Áh»ads
, );

275 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

276 "assigÃdh»ads: %u\n", 
Áh»ads
);

277 
	`CTL_M2_GET
("¡©s.¬’as.0.dss", 
i
, &
dss
, const *);

278 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "dss‡llocation…recedence: %s\n",

279 
dss
);

280 
	`CTL_M2_GET
("¡©s.¬’as.0.lg_dœty_muÉ", 
i
, &
lg_dœty_muÉ
, 
ssize_t
);

281 ià(
İt_purge
 =ğ
purge_mode_¿tio
) {

282 ià(
lg_dœty_muÉ
 >= 0) {

283 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

285 (1U << 
lg_dœty_muÉ
));

287 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

291 
	`CTL_M2_GET
("¡©s.¬’as.0.deÿy_time", 
i
, &
deÿy_time
, 
ssize_t
);

292 ià(
İt_purge
 =ğ
purge_mode_deÿy
) {

293 ià(
deÿy_time
 >= 0) {

294 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "decayime: %zd\n",

295 
deÿy_time
);

297 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "decayime: N/A\n");

299 
	`CTL_M2_GET
("¡©s.¬’as.0.·ùive", 
i
, &
·ùive
, 
size_t
);

300 
	`CTL_M2_GET
("¡©s.¬’as.0.pdœty", 
i
, &
pdœty
, 
size_t
);

301 
	`CTL_M2_GET
("¡©s.¬’as.0.Åurge", 
i
, &
Åurge
, 
ušt64_t
);

302 
	`CTL_M2_GET
("¡©s.¬’as.0.nmadvi£", 
i
, &
nmadvi£
, 
ušt64_t
);

303 
	`CTL_M2_GET
("¡©s.¬’as.0.purged", 
i
, &
purged
, 
ušt64_t
);

304 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

305 "purgšg: dœty: %zu, sw“ps: %"
FMTu64
", madvises: %"FMTu64", "

306 "purged: %"
FMTu64
"\n", 
pdœty
, 
Åurge
, 
nmadvi£
, 
purged
);

308 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

311 
	`CTL_M2_GET
("¡©s.¬’as.0.sm®l.®loÿ‹d", 
i
, &
sm®l_®loÿ‹d
,

312 
size_t
);

313 
	`CTL_M2_GET
("¡©s.¬’as.0.sm®l.nm®loc", 
i
, &
sm®l_nm®loc
, 
ušt64_t
);

314 
	`CTL_M2_GET
("¡©s.¬’as.0.sm®l.nd®loc", 
i
, &
sm®l_nd®loc
, 
ušt64_t
);

315 
	`CTL_M2_GET
("¡©s.¬’as.0.sm®l.Äeque¡s", 
i
, &
sm®l_Äeque¡s
,

316 
ušt64_t
);

317 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

318 "sm®l: %12zu %12"
FMTu64
" %12"FMTu64

319 " %12"
FMTu64
"\n",

320 
sm®l_®loÿ‹d
, 
sm®l_nm®loc
, 
sm®l_nd®loc
, 
sm®l_Äeque¡s
);

321 
	`CTL_M2_GET
("¡©s.¬’as.0.Ïrge.®loÿ‹d", 
i
, &
Ïrge_®loÿ‹d
,

322 
size_t
);

323 
	`CTL_M2_GET
("¡©s.¬’as.0.Ïrge.nm®loc", 
i
, &
Ïrge_nm®loc
, 
ušt64_t
);

324 
	`CTL_M2_GET
("¡©s.¬’as.0.Ïrge.nd®loc", 
i
, &
Ïrge_nd®loc
, 
ušt64_t
);

325 
	`CTL_M2_GET
("¡©s.¬’as.0.Ïrge.Äeque¡s", 
i
, &
Ïrge_Äeque¡s
,

326 
ušt64_t
);

327 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

328 "Ïrge: %12zu %12"
FMTu64
" %12"FMTu64

329 " %12"
FMTu64
"\n",

330 
Ïrge_®loÿ‹d
, 
Ïrge_nm®loc
, 
Ïrge_nd®loc
, 
Ïrge_Äeque¡s
);

331 
	`CTL_M2_GET
("¡©s.¬’as.0.huge.®loÿ‹d", 
i
, &
huge_®loÿ‹d
, 
size_t
);

332 
	`CTL_M2_GET
("¡©s.¬’as.0.huge.nm®loc", 
i
, &
huge_nm®loc
, 
ušt64_t
);

333 
	`CTL_M2_GET
("¡©s.¬’as.0.huge.nd®loc", 
i
, &
huge_nd®loc
, 
ušt64_t
);

334 
	`CTL_M2_GET
("¡©s.¬’as.0.huge.Äeque¡s", 
i
, &
huge_Äeque¡s
,

335 
ušt64_t
);

336 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

337 "huge: %12zu %12"
FMTu64
" %12"FMTu64

338 " %12"
FMTu64
"\n",

339 
huge_®loÿ‹d
, 
huge_nm®loc
, 
huge_nd®loc
, 
huge_Äeque¡s
);

340 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

341 "tÙ®: %12zu %12"
FMTu64
" %12"FMTu64

342 " %12"
FMTu64
"\n",

343 
sm®l_®loÿ‹d
 + 
Ïrge_®loÿ‹d
 + 
huge_®loÿ‹d
,

344 
sm®l_nm®loc
 + 
Ïrge_nm®loc
 + 
huge_nm®loc
,

345 
sm®l_nd®loc
 + 
Ïrge_nd®loc
 + 
huge_nd®loc
,

346 
sm®l_Äeque¡s
 + 
Ïrge_Äeque¡s
 + 
huge_Äeque¡s
);

347 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

348 "aùive: %12zu\n", 
·ùive
 * 
·ge
);

349 
	`CTL_M2_GET
("¡©s.¬’as.0.m­³d", 
i
, &
m­³d
, 
size_t
);

350 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

351 "m­³d: %12zu\n", 
m­³d
);

352 
	`CTL_M2_GET
("¡©s.¬’as.0.»šed", 
i
, &
»šed
, 
size_t
);

353 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

354 "»šed: %12zu\n", 
»šed
);

355 
	`CTL_M2_GET
("¡©s.¬’as.0.m‘ad©a.m­³d", 
i
, &
m‘ad©a_m­³d
,

356 
size_t
);

357 
	`CTL_M2_GET
("¡©s.¬’as.0.m‘ad©a.®loÿ‹d", 
i
, &
m‘ad©a_®loÿ‹d
,

358 
size_t
);

359 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

361 
m‘ad©a_m­³d
, 
m‘ad©a_®loÿ‹d
);

363 ià(
bšs
)

364 
	`¡©s_¬’a_bšs_´št
(
wr™e_cb
, 
cbİaque
, 
i
);

365 ià(
Ïrge
)

366 
	`¡©s_¬’a_Ìuns_´št
(
wr™e_cb
, 
cbİaque
, 
i
);

367 ià(
huge
)

368 
	`¡©s_¬’a_hchunks_´št
(
wr™e_cb
, 
cbİaque
, 
i
);

369 
	}
}

372 
	$¡©s_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

373 cÚ¡ *
İts
)

375 
”r
;

376 
ušt64_t
 
•och
;

377 
size_t
 
u64sz
;

378 
boŞ
 
g’”®
 = 
Œue
;

379 
boŞ
 
m”ged
 = 
Œue
;

380 
boŞ
 
unm”ged
 = 
Œue
;

381 
boŞ
 
bšs
 = 
Œue
;

382 
boŞ
 
Ïrge
 = 
Œue
;

383 
boŞ
 
huge
 = 
Œue
;

392 
•och
 = 1;

393 
u64sz
 = (
ušt64_t
);

394 
”r
 = 
	`je_m®lùl
("•och", &
•och
, &
u64sz
, &•och, (
ušt64_t
));

395 ià(
”r
 != 0) {

396 ià(
”r
 =ğ
EAGAIN
) {

397 
	`m®loc_wr™e
("<jemalloc>: Memory‡llocation failure in "

401 
	`m®loc_wr™e
("<jemalloc>: Failure in mallctl(\"epoch\", "

403 
	`abÜt
();

406 ià(
İts
 !ğ
NULL
) {

407 
i
;

409 
i
 = 0; 
İts
[i] != '\0'; i++) {

410 
İts
[
i
]) {

412 
g’”®
 = 
çl£
;

415 
m”ged
 = 
çl£
;

418 
unm”ged
 = 
çl£
;

421 
bšs
 = 
çl£
;

424 
Ïrge
 = 
çl£
;

427 
huge
 = 
çl£
;

434 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

436 ià(
g’”®
) {

437 cÚ¡ *
ıv
;

438 
boŞ
 
bv
;

439 
uv
;

440 
ssize_t
 
ssv
;

441 
size_t
 
sv
, 
bsz
, 
usz
, 
ssz
, 
sssz
, 
ısz
;

443 
bsz
 = (
boŞ
);

444 
usz
 = ();

445 
ssz
 = (
size_t
);

446 
sssz
 = (
ssize_t
);

447 
ısz
 = (const *);

449 
	`CTL_GET
("v”siÚ", &
ıv
, const *);

450 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "V”siÚ: %s\n", 
ıv
);

451 
	`CTL_GET
("cÚfig.debug", &
bv
, 
boŞ
);

452 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "Assertions %s\n",

453 
bv
 ? "enabled" : "disabled");

454 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

455 "cÚfig.m®loc_cÚf: \"%s\"\n", 
cÚfig_m®loc_cÚf
);

457 
	#OPT_WRITE_BOOL
(
n
) \

458 ià(
	`je_m®lùl
("İt."#n, &
bv
, &
bsz
, 
NULL
, 0) == 0) { \

459 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

460 " o±."#n": %s\n", 
bv
 ? "true" : "false"); \

461 }

	)

462 
	#OPT_WRITE_BOOL_MUTABLE
(
n
, 
m
) { \

463 
boŞ
 
bv2
; \

464 ià(
	`je_m®lùl
("İt."#n, &
bv
, &
bsz
, 
NULL
, 0) == 0 && \

465 
	`je_m®lùl
(#m, &
bv2
, &
bsz
, 
NULL
, 0) == 0) { \

466 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

467 " o±."#n": % ("#m": %s)\n", 
bv
 ? "true" \

468 : "çl£", 
bv2
 ? "true" : "false"); \

470 }

	)

471 
	#OPT_WRITE_UNSIGNED
(
n
) \

472 ià(
	`je_m®lùl
("İt."#n, &
uv
, &
usz
, 
NULL
, 0) == 0) { \

473 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

474 " o±."#n": %u\n", 
uv
); \

475 }

	)

476 
	#OPT_WRITE_SIZE_T
(
n
) \

477 ià(
	`je_m®lùl
("İt."#n, &
sv
, &
ssz
, 
NULL
, 0) == 0) { \

478 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

479 " o±."#n": %zu\n", 
sv
); \

480 }

	)

481 
	#OPT_WRITE_SSIZE_T
(
n
) \

482 ià(
	`je_m®lùl
("İt."#n, &
ssv
, &
sssz
, 
NULL
, 0) == 0) { \

483 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

484 " o±."#n": %zd\n", 
ssv
); \

485 }

	)

486 
	#OPT_WRITE_SSIZE_T_MUTABLE
(
n
, 
m
) { \

487 
ssize_t
 
ssv2
; \

488 ià(
	`je_m®lùl
("İt."#n, &
ssv
, &
sssz
, 
NULL
, 0) == 0 && \

489 
	`je_m®lùl
(#m, &
ssv2
, &
sssz
, 
NULL
, 0) == 0) { \

490 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

492 
ssv
, 
ssv2
); \

494 }

	)

495 
	#OPT_WRITE_CHAR_P
(
n
) \

496 ià(
	`je_m®lùl
("İt."#n, &
ıv
, &
ısz
, 
NULL
, 0) == 0) { \

497 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

498 " o±."#n": \"%s\"\n", 
ıv
); \

499 }

	)

501 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

503 
	`OPT_WRITE_BOOL
(
abÜt
)

504 
	`OPT_WRITE_SIZE_T
(
lg_chunk
)

505 
	`OPT_WRITE_CHAR_P
(
dss
)

506 
	`OPT_WRITE_UNSIGNED
(
Ç»Çs
)

507 
	`OPT_WRITE_CHAR_P
(
purge
)

508 ià(
İt_purge
 =ğ
purge_mode_¿tio
) {

509 
	`OPT_WRITE_SSIZE_T_MUTABLE
(
lg_dœty_muÉ
,

510 
¬’as
.
lg_dœty_muÉ
)

512 ià(
İt_purge
 =ğ
purge_mode_deÿy
)

513 
	`OPT_WRITE_SSIZE_T_MUTABLE
(
deÿy_time
, 
¬’as
.decay_time)

514 
	`OPT_WRITE_BOOL
(
¡©s_´št
)

515 
	`OPT_WRITE_CHAR_P
(
junk
)

516 
	`OPT_WRITE_SIZE_T
(
qu¬ªtše
)

517 
	`OPT_WRITE_BOOL
(
»dzÚe
)

518 
	`OPT_WRITE_BOOL
(
z”o
)

519 
	`OPT_WRITE_BOOL
(
uŒaû
)

520 
	`OPT_WRITE_BOOL
(
v®gršd
)

521 
	`OPT_WRITE_BOOL
(
xm®loc
)

522 
	`OPT_WRITE_BOOL
(
tÿche
)

523 
	`OPT_WRITE_SSIZE_T
(
lg_tÿche_max
)

524 
	`OPT_WRITE_BOOL
(
´of
)

525 
	`OPT_WRITE_CHAR_P
(
´of_´efix
)

526 
	`OPT_WRITE_BOOL_MUTABLE
(
´of_aùive
, 
´of
.
aùive
)

527 
	`OPT_WRITE_BOOL_MUTABLE
(
´of_th»ad_aùive_š™
,

528 
´of
.
th»ad_aùive_š™
)

529 
	`OPT_WRITE_SSIZE_T
(
lg_´of_§m¶e
)

530 
	`OPT_WRITE_BOOL
(
´of_accum
)

531 
	`OPT_WRITE_SSIZE_T
(
lg_´of_š‹rv®
)

532 
	`OPT_WRITE_BOOL
(
´of_gdump
)

533 
	`OPT_WRITE_BOOL
(
´of_fš®
)

534 
	`OPT_WRITE_BOOL
(
´of_Ëak
)

536 #undeà
OPT_WRITE_BOOL


537 #undeà
OPT_WRITE_BOOL_MUTABLE


538 #undeà
OPT_WRITE_SIZE_T


539 #undeà
OPT_WRITE_SSIZE_T


540 #undeà
OPT_WRITE_CHAR_P


542 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "CPUs: %u\n", 
nıus
);

544 
	`CTL_GET
("¬’as.Ç»Çs", &
uv
, );

545 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "A»Çs: %u\n", 
uv
);

547 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "Pointer size: %zu\n",

550 
	`CTL_GET
("¬’as.quªtum", &
sv
, 
size_t
);

551 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "Quantum size: %zu\n",

552 
sv
);

554 
	`CTL_GET
("¬’as.·ge", &
sv
, 
size_t
);

555 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "Pagsize: %zu\n", 
sv
);

557 
	`CTL_GET
("¬’as.lg_dœty_muÉ", &
ssv
, 
ssize_t
);

558 ià(
İt_purge
 =ğ
purge_mode_¿tio
) {

559 ià(
ssv
 >= 0) {

560 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

562 "%u:1\n", (1U << 
ssv
));

564 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

569 
	`CTL_GET
("¬’as.deÿy_time", &
ssv
, 
ssize_t
);

570 ià(
İt_purge
 =ğ
purge_mode_deÿy
) {

571 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

573 
ssv
, (ssv < 0) ? " (no decay)" : "");

575 ià(
	`je_m®lùl
("¬’as.tÿche_max", &
sv
, &
ssz
, 
NULL
, 0) == 0) {

576 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

577 "Maximumh»ad-ÿched sizşass: %zu\n", 
sv
);

579 ià(
	`je_m®lùl
("İt.´of", &
bv
, &
bsz
, 
NULL
, 0) == 0 && bv) {

580 
	`CTL_GET
("´of.lg_§m¶e", &
sv
, 
size_t
);

581 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

582 "Av”ag´of§m¶š‹rv®: %"
FMTu64


583 " (2^%zu)\n", (((
ušt64_t
)1Uè<< 
sv
), sv);

585 
	`CTL_GET
("İt.lg_´of_š‹rv®", &
ssv
, 
ssize_t
);

586 ià(
ssv
 >= 0) {

587 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

588 "Av”ag´ofdum°š‹rv®: %"
FMTu64


590 (((
ušt64_t
)1Uè<< 
ssv
), ssv);

592 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

596 
	`CTL_GET
("İt.lg_chunk", &
sv
, 
size_t
);

597 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

598 "Chunk size: %zu (2^%zu)\n", (
	`ZU
(1è<< 
sv
), sv);

601 ià(
cÚfig_¡©s
) {

602 
size_t
 *
ÿùive
;

603 
size_t
 
®loÿ‹d
, 
aùive
, 
m‘ad©a
, 
»sid’t
, 
m­³d
, 
»šed
;

605 
	`CTL_GET
("¡©s.ÿùive", &
ÿùive
, 
size_t
 *);

606 
	`CTL_GET
("¡©s.®loÿ‹d", &
®loÿ‹d
, 
size_t
);

607 
	`CTL_GET
("¡©s.aùive", &
aùive
, 
size_t
);

608 
	`CTL_GET
("¡©s.m‘ad©a", &
m‘ad©a
, 
size_t
);

609 
	`CTL_GET
("¡©s.»sid’t", &
»sid’t
, 
size_t
);

610 
	`CTL_GET
("¡©s.m­³d", &
m­³d
, 
size_t
);

611 
	`CTL_GET
("¡©s.»šed", &
»šed
, 
size_t
);

612 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

615 
®loÿ‹d
, 
aùive
, 
m‘ad©a
, 
»sid’t
, 
m­³d
, 
»šed
);

616 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

618 
	`©omic_»ad_z
(
ÿùive
));

620 ià(
m”ged
) {

621 
Ç»Çs
;

623 
	`CTL_GET
("¬’as.Ç»Çs", &
Ç»Çs
, );

625 
	`VARIABLE_ARRAY
(
boŞ
, 
š™Ÿlized
, 
Ç»Çs
);

626 
size_t
 
isz
;

627 
i
, 
nš™Ÿlized
;

629 
isz
 = (
boŞ
è* 
Ç»Çs
;

630 
	`xm®lùl
("¬’as.š™Ÿlized", 
š™Ÿlized
,

631 &
isz
, 
NULL
, 0);

632 
i
 = 
nš™Ÿlized
 = 0; i < 
Ç»Çs
; i++) {

633 ià(
š™Ÿlized
[
i
])

634 
nš™Ÿlized
++;

637 ià(
nš™Ÿlized
 > 1 || !
unm”ged
) {

639 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

641 
	`¡©s_¬’a_´št
(
wr™e_cb
, 
cbİaque
,

642 
Ç»Çs
, 
bšs
, 
Ïrge
, 
huge
);

647 ià(
unm”ged
) {

648 
Ç»Çs
;

652 
	`CTL_GET
("¬’as.Ç»Çs", &
Ç»Çs
, );

654 
	`VARIABLE_ARRAY
(
boŞ
, 
š™Ÿlized
, 
Ç»Çs
);

655 
size_t
 
isz
;

656 
i
;

658 
isz
 = (
boŞ
è* 
Ç»Çs
;

659 
	`xm®lùl
("¬’as.š™Ÿlized", 
š™Ÿlized
,

660 &
isz
, 
NULL
, 0);

662 
i
 = 0; i < 
Ç»Çs
; i++) {

663 ià(
š™Ÿlized
[
i
]) {

664 
	`m®loc_ırštf
(
wr™e_cb
,

665 
cbİaque
,

666 "\Ç»Çs[%u]:\n", 
i
);

667 
	`¡©s_¬’a_´št
(
wr™e_cb
,

668 
cbİaque
, 
i
, 
bšs
, 
Ïrge
,

669 
huge
);

675 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "--- End jemalloc statistics ---\n");

676 
	}
}

	@dep/jemalloc-4.2.0/src/tcache.c

1 
	#JEMALLOC_TCACHE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
boŞ
 
	gİt_tÿche
 = 
Œue
;

8 
ssize_t
 
	gİt_lg_tÿche_max
 = 
LG_TCACHE_MAXCLASS_DEFAULT
;

10 
tÿche_bš_šfo_t
 *
	gtÿche_bš_šfo
;

11 
	g¡ack_Ãlms
;

13 
	gnhbšs
;

14 
size_t
 
	gtÿche_maxşass
;

16 
tÿches_t
 *
	gtÿches
;

19 
	gtÿches_·¡
;

22 
tÿches_t
 *
	gtÿches_ava
;

26 
size_t


27 
	$tÿche_§Îoc
(
tsdn_t
 *
tsdn
, cÚ¡ *
±r
)

30  (
	`¬’a_§Îoc
(
tsdn
, 
±r
, 
çl£
));

31 
	}
}

34 
	$tÿche_ev’t_h¬d
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
)

36 
szšd_t
 
bššd
 = 
tÿche
->
Ãxt_gc_bš
;

37 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
bššd
];

38 
tÿche_bš_šfo_t
 *
tbš_šfo
 = &
tÿche_bš_šfo
[
bššd
];

40 ià(
tbš
->
low_w©”
 > 0) {

44 ià(
bššd
 < 
NBINS
) {

45 
	`tÿche_bš_æush_sm®l
(
tsd
, 
tÿche
, 
tbš
, 
bššd
,

46 
tbš
->
nÿched
 -bš->
low_w©”
 + (tbin->low_water

49 
	`tÿche_bš_æush_Ïrge
(
tsd
, 
tbš
, 
bššd
,bš->
nÿched


50 - 
tbš
->
low_w©”
 + (tbš->low_w©” >> 2), 
tÿche
);

56 ià((
tbš_šfo
->
nÿched_max
 >> (
tbš
->
lg_fl_div
+1)) >= 1)

57 
tbš
->
lg_fl_div
++;

58 } ià(
tbš
->
low_w©”
 < 0) {

63 ià(
tbš
->
lg_fl_div
 > 1)

64 
tbš
->
lg_fl_div
--;

66 
tbš
->
low_w©”
 =bš->
nÿched
;

68 
tÿche
->
Ãxt_gc_bš
++;

69 ià(
tÿche
->
Ãxt_gc_bš
 =ğ
nhbšs
)

70 
tÿche
->
Ãxt_gc_bš
 = 0;

71 
	}
}

74 
	$tÿche_®loc_sm®l_h¬d
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
,

75 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
, 
boŞ
 *
tÿche_sucûss
)

77 *
»t
;

79 
	`¬’a_tÿche_fl_sm®l
(
tsdn
, 
¬’a
, 
tbš
, 
bššd
, 
cÚfig_´of
 ?

80 
tÿche
->
´of_accumby‹s
 : 0);

81 ià(
cÚfig_´of
)

82 
tÿche
->
´of_accumby‹s
 = 0;

83 
»t
 = 
	`tÿche_®loc_—sy
(
tbš
, 
tÿche_sucûss
);

85  (
»t
);

86 
	}
}

89 
	$tÿche_bš_æush_sm®l
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, 
tÿche_bš_t
 *
tbš
,

90 
szšd_t
 
bššd
, 
»m
)

92 
¬’a_t
 *
¬’a
;

93 *
±r
;

94 
i
, 
næush
, 
ndeã¼ed
;

95 
boŞ
 
m”ged_¡©s
 = 
çl£
;

97 
	`as£¹
(
bššd
 < 
NBINS
);

98 
	`as£¹
(
»m
 <ğ
tbš
->
nÿched
);

100 
¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

101 
	`as£¹
(
¬’a
 !ğ
NULL
);

102 
næush
 = 
tbš
->
nÿched
 - 
»m
;‚æush > 0;‚æush = 
ndeã¼ed
) {

104 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(

105 *(
tbš
->
ava
 - 1));

106 
¬’a_t
 *
bš_¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
);

107 
¬’a_bš_t
 *
bš
 = &
bš_¬’a
->
bšs
[
bššd
];

109 ià(
cÚfig_´of
 && 
bš_¬’a
 =ğ
¬’a
) {

110 ià(
	`¬’a_´of_accum
(
	`tsd_tsdn
(
tsd
), 
¬’a
,

111 
tÿche
->
´of_accumby‹s
))

112 
	`´of_idump
(
	`tsd_tsdn
(
tsd
));

113 
tÿche
->
´of_accumby‹s
 = 0;

116 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
bš
->
lock
);

117 ià(
cÚfig_¡©s
 && 
bš_¬’a
 =ğ
¬’a
) {

118 
	`as£¹
(!
m”ged_¡©s
);

119 
m”ged_¡©s
 = 
Œue
;

120 
bš
->
¡©s
.
næushes
++;

121 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

122 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

124 
ndeã¼ed
 = 0;

125 
i
 = 0; i < 
næush
; i++) {

126 
±r
 = *(
tbš
->
ava
 - 1 - 
i
);

127 
	`as£¹
(
±r
 !ğ
NULL
);

128 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

129 ià(
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
è=ğ
bš_¬’a
) {

130 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 -

131 (
ušŒ_t
)
chunk
è>> 
LG_PAGE
;

132 
¬’a_chunk_m­_b™s_t
 *
b™£lm
 =

133 
	`¬’a_b™£lm_g‘_mubË
(
chunk
, 
·gešd
);

134 
	`¬’a_d®loc_bš_junked_locked
(
	`tsd_tsdn
(
tsd
),

135 
bš_¬’a
, 
chunk
, 
±r
, 
b™£lm
);

143 *(
tbš
->
ava
 - 1 - 
ndeã¼ed
èğ
±r
;

144 
ndeã¼ed
++;

147 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
bš
->
lock
);

148 
	`¬’a_deÿy_ticks
(
	`tsd_tsdn
(
tsd
), 
bš_¬’a
, 
næush
 - 
ndeã¼ed
);

150 ià(
cÚfig_¡©s
 && !
m”ged_¡©s
) {

155 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
bššd
];

156 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
bš
->
lock
);

157 
bš
->
¡©s
.
næushes
++;

158 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

159 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

160 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
bš
->
lock
);

163 
	`memmove
(
tbš
->
ava
 - 
»m
,bš->ava -bš->
nÿched
,„em *

165 
tbš
->
nÿched
 = 
»m
;

166 ià(()
tbš
->
nÿched
 <bš->
low_w©”
)

167 
tbš
->
low_w©”
 =bš->
nÿched
;

168 
	}
}

171 
	$tÿche_bš_æush_Ïrge
(
tsd_t
 *
tsd
, 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
,

172 
»m
, 
tÿche_t
 *
tÿche
)

174 
¬’a_t
 *
¬’a
;

175 *
±r
;

176 
i
, 
næush
, 
ndeã¼ed
;

177 
boŞ
 
m”ged_¡©s
 = 
çl£
;

179 
	`as£¹
(
bššd
 < 
nhbšs
);

180 
	`as£¹
(
»m
 <ğ
tbš
->
nÿched
);

182 
¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

183 
	`as£¹
(
¬’a
 !ğ
NULL
);

184 
næush
 = 
tbš
->
nÿched
 - 
»m
;‚æush > 0;‚æush = 
ndeã¼ed
) {

186 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(

187 *(
tbš
->
ava
 - 1));

188 
¬’a_t
 *
locked_¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
);

189 
UNUSED
 
boŞ
 
idump
;

191 ià(
cÚfig_´of
)

192 
idump
 = 
çl£
;

193 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
locked_¬’a
->
lock
);

194 ià((
cÚfig_´of
 || 
cÚfig_¡©s
è&& 
locked_¬’a
 =ğ
¬’a
) {

195 ià(
cÚfig_´of
) {

196 
idump
 = 
	`¬’a_´of_accum_locked
(
¬’a
,

197 
tÿche
->
´of_accumby‹s
);

198 
tÿche
->
´of_accumby‹s
 = 0;

200 ià(
cÚfig_¡©s
) {

201 
m”ged_¡©s
 = 
Œue
;

202 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
 +=

203 
tbš
->
t¡©s
.
Äeque¡s
;

204 
¬’a
->
¡©s
.
l¡©s
[
bššd
 - 
NBINS
].
Äeque¡s
 +=

205 
tbš
->
t¡©s
.
Äeque¡s
;

206 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

209 
ndeã¼ed
 = 0;

210 
i
 = 0; i < 
næush
; i++) {

211 
±r
 = *(
tbš
->
ava
 - 1 - 
i
);

212 
	`as£¹
(
±r
 !ğ
NULL
);

213 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

214 ià(
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
) ==

215 
locked_¬’a
) {

216 
	`¬’a_d®loc_Ïrge_junked_locked
(
	`tsd_tsdn
(
tsd
),

217 
locked_¬’a
, 
chunk
, 
±r
);

225 *(
tbš
->
ava
 - 1 - 
ndeã¼ed
èğ
±r
;

226 
ndeã¼ed
++;

229 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
locked_¬’a
->
lock
);

230 ià(
cÚfig_´of
 && 
idump
)

231 
	`´of_idump
(
	`tsd_tsdn
(
tsd
));

232 
	`¬’a_deÿy_ticks
(
	`tsd_tsdn
(
tsd
), 
locked_¬’a
, 
næush
 -

233 
ndeã¼ed
);

235 ià(
cÚfig_¡©s
 && !
m”ged_¡©s
) {

240 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
lock
);

241 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
 +ğ
tbš
->
t¡©s
.
Äeque¡s
;

242 
¬’a
->
¡©s
.
l¡©s
[
bššd
 - 
NBINS
].
Äeque¡s
 +=

243 
tbš
->
t¡©s
.
Äeque¡s
;

244 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

245 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
lock
);

248 
	`memmove
(
tbš
->
ava
 - 
»m
,bš->ava -bš->
nÿched
,„em *

250 
tbš
->
nÿched
 = 
»m
;

251 ià(()
tbš
->
nÿched
 <bš->
low_w©”
)

252 
tbš
->
low_w©”
 =bš->
nÿched
;

253 
	}
}

256 
	$tÿche_¬’a_assocŸ‹
(
tsdn_t
 *
tsdn
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

259 ià(
cÚfig_¡©s
) {

261 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

262 
	`ql_–m_Ãw
(
tÿche
, 
lšk
);

263 
	`ql__š£¹
(&
¬’a
->
tÿche_ql
, 
tÿche
, 
lšk
);

264 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

266 
	}
}

269 
	$tÿche_¬’a_dissocŸ‹
(
tsdn_t
 *
tsdn
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

272 ià(
cÚfig_¡©s
) {

274 
	`m®loc_mu‹x_lock
(
tsdn
, &
¬’a
->
lock
);

275 ià(
cÚfig_debug
) {

276 
boŞ
 
š_ql
 = 
çl£
;

277 
tÿche_t
 *
™”
;

278 
	`ql_fÜ—ch
(
™”
, &
¬’a
->
tÿche_ql
, 
lšk
) {

279 ià(
™”
 =ğ
tÿche
) {

280 
š_ql
 = 
Œue
;

284 
	`as£¹
(
š_ql
);

286 
	`ql_»move
(&
¬’a
->
tÿche_ql
, 
tÿche
, 
lšk
);

287 
	`tÿche_¡©s_m”ge
(
tsdn
, 
tÿche
, 
¬’a
);

288 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
¬’a
->
lock
);

290 
	}
}

293 
	$tÿche_¬’a_»assocŸ‹
(
tsdn_t
 *
tsdn
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
Şd¬’a
,

294 
¬’a_t
 *
Ãw¬’a
)

297 
	`tÿche_¬’a_dissocŸ‹
(
tsdn
, 
tÿche
, 
Şd¬’a
);

298 
	`tÿche_¬’a_assocŸ‹
(
tsdn
, 
tÿche
, 
Ãw¬’a
);

299 
	}
}

301 
tÿche_t
 *

302 
	$tÿche_g‘_h¬d
(
tsd_t
 *
tsd
)

304 
¬’a_t
 *
¬’a
;

306 ià(!
	`tÿche_’abËd_g‘
()) {

307 ià(
	`tsd_nomš®
(
tsd
))

308 
	`tÿche_’abËd_£t
(
çl£
);

309  (
NULL
);

311 
¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

312 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

313  (
NULL
);

314  (
	`tÿche_ü—‹
(
	`tsd_tsdn
(
tsd
), 
¬’a
));

315 
	}
}

317 
tÿche_t
 *

318 
	$tÿche_ü—‹
(
tsdn_t
 *
tsdn
, 
¬’a_t
 *
¬’a
)

320 
tÿche_t
 *
tÿche
;

321 
size_t
 
size
, 
¡ack_off£t
;

322 
i
;

324 
size
 = 
	`off£tof
(
tÿche_t
, 
tbšs
è+ ((
tÿche_bš_t
è* 
nhbšs
);

326 
size
 = 
	`PTR_CEILING
(size);

327 
¡ack_off£t
 = 
size
;

328 
size
 +ğ
¡ack_Ãlms
 * (*);

330 
size
 = 
	`§2u
(size, 
CACHELINE
);

332 
tÿche
 = 
	`®locztm
(
tsdn
, 
size
, 
CACHELINE
, 
Œue
, 
NULL
,rue,

333 
	`¬’a_g‘
(
TSDN_NULL
, 0, 
Œue
));

334 ià(
tÿche
 =ğ
NULL
)

335  (
NULL
);

337 
	`tÿche_¬’a_assocŸ‹
(
tsdn
, 
tÿche
, 
¬’a
);

339 
	`tick”_š™
(&
tÿche
->
gc_tick”
, 
TCACHE_GC_INCR
);

341 
	`as£¹
((
TCACHE_NSLOTS_SMALL_MAX
 & 1U) == 0);

342 
i
 = 0; i < 
nhbšs
; i++) {

343 
tÿche
->
tbšs
[
i
].
lg_fl_div
 = 1;

344 
¡ack_off£t
 +ğ
tÿche_bš_šfo
[
i
].
nÿched_max
 * (*);

350 
tÿche
->
tbšs
[
i
].
ava
 = (**)((
ušŒ_t
)tcache +

351 (
ušŒ_t
)
¡ack_off£t
);

354  (
tÿche
);

355 
	}
}

358 
	$tÿche_de¡roy
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
)

360 
¬’a_t
 *
¬’a
;

361 
i
;

363 
¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

364 
	`tÿche_¬’a_dissocŸ‹
(
	`tsd_tsdn
(
tsd
), 
tÿche
, 
¬’a
);

366 
i
 = 0; i < 
NBINS
; i++) {

367 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
i
];

368 
	`tÿche_bš_æush_sm®l
(
tsd
, 
tÿche
, 
tbš
, 
i
, 0);

370 ià(
cÚfig_¡©s
 && 
tbš
->
t¡©s
.
Äeque¡s
 != 0) {

371 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
i
];

372 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
bš
->
lock
);

373 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

374 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
bš
->
lock
);

378 ; 
i
 < 
nhbšs
; i++) {

379 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
i
];

380 
	`tÿche_bš_æush_Ïrge
(
tsd
, 
tbš
, 
i
, 0, 
tÿche
);

382 ià(
cÚfig_¡©s
 && 
tbš
->
t¡©s
.
Äeque¡s
 != 0) {

383 
	`m®loc_mu‹x_lock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
lock
);

384 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
 +ğ
tbš
->
t¡©s
.
Äeque¡s
;

385 
¬’a
->
¡©s
.
l¡©s
[
i
 - 
NBINS
].
Äeque¡s
 +=

386 
tbš
->
t¡©s
.
Äeque¡s
;

387 
	`m®loc_mu‹x_uÆock
(
	`tsd_tsdn
(
tsd
), &
¬’a
->
lock
);

391 ià(
cÚfig_´of
 && 
tÿche
->
´of_accumby‹s
 > 0 &&

392 
	`¬’a_´of_accum
(
	`tsd_tsdn
(
tsd
), 
¬’a
, 
tÿche
->
´of_accumby‹s
))

393 
	`´of_idump
(
	`tsd_tsdn
(
tsd
));

395 
	`id®loùm
(
	`tsd_tsdn
(
tsd
), 
tÿche
, 
NULL
, 
Œue
,rue);

396 
	}
}

399 
	$tÿche_ş—nup
(
tsd_t
 *
tsd
)

401 
tÿche_t
 *
tÿche
;

403 ià(!
cÚfig_tÿche
)

406 ià((
tÿche
 = 
	`tsd_tÿche_g‘
(
tsd
)è!ğ
NULL
) {

407 
	`tÿche_de¡roy
(
tsd
, 
tÿche
);

408 
	`tsd_tÿche_£t
(
tsd
, 
NULL
);

410 
	}
}

413 
	$tÿche_’abËd_ş—nup
(
tsd_t
 *
tsd
)

417 
	}
}

420 
	$tÿche_¡©s_m”ge
(
tsdn_t
 *
tsdn
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

422 
i
;

424 
	`ÿs£¹
(
cÚfig_¡©s
);

426 
	`m®loc_mu‹x_as£¹_owÃr
(
tsdn
, &
¬’a
->
lock
);

429 
i
 = 0; i < 
NBINS
; i++) {

430 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
i
];

431 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
i
];

432 
	`m®loc_mu‹x_lock
(
tsdn
, &
bš
->
lock
);

433 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

434 
	`m®loc_mu‹x_uÆock
(
tsdn
, &
bš
->
lock
);

435 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

438 ; 
i
 < 
nhbšs
; i++) {

439 
m®loc_Ïrge_¡©s_t
 *
l¡©s
 = &
¬’a
->
¡©s
.l¡©s[
i
 - 
NBINS
];

440 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
i
];

441 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
 +ğ
tbš
->
t¡©s
.
Äeque¡s
;

442 
l¡©s
->
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

443 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

445 
	}
}

447 
boŞ


448 
	$tÿches_ü—‹
(
tsdn_t
 *
tsdn
, *
r_šd
)

450 
¬’a_t
 *
¬’a
;

451 
tÿche_t
 *
tÿche
;

452 
tÿches_t
 *
–m
;

454 ià(
tÿches
 =ğ
NULL
) {

455 
tÿches
 = 
	`ba£_®loc
(
tsdn
, (
tÿche_t
 *) *

456 (
MALLOCX_TCACHE_MAX
+1));

457 ià(
tÿches
 =ğ
NULL
)

458  (
Œue
);

461 ià(
tÿches_ava
 =ğ
NULL
 && 
tÿches_·¡
 > 
MALLOCX_TCACHE_MAX
)

462  (
Œue
);

463 
¬’a
 = 
	`¬’a_ichoo£
(
tsdn
, 
NULL
);

464 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

465  (
Œue
);

466 
tÿche
 = 
	`tÿche_ü—‹
(
tsdn
, 
¬’a
);

467 ià(
tÿche
 =ğ
NULL
)

468  (
Œue
);

470 ià(
tÿches_ava
 !ğ
NULL
) {

471 
–m
 = 
tÿches_ava
;

472 
tÿches_ava
 =ÿches_ava->
Ãxt
;

473 
–m
->
tÿche
 =cache;

474 *
r_šd
 = ()(
–m
 - 
tÿches
);

476 
–m
 = &
tÿches
[
tÿches_·¡
];

477 
–m
->
tÿche
 =cache;

478 *
r_šd
 = 
tÿches_·¡
;

479 
tÿches_·¡
++;

482  (
çl£
);

483 
	}
}

486 
	$tÿches_–m_æush
(
tsd_t
 *
tsd
, 
tÿches_t
 *
–m
)

489 ià(
–m
->
tÿche
 =ğ
NULL
)

491 
	`tÿche_de¡roy
(
tsd
, 
–m
->
tÿche
);

492 
–m
->
tÿche
 = 
NULL
;

493 
	}
}

496 
	$tÿches_æush
(
tsd_t
 *
tsd
, 
šd
)

499 
	`tÿches_–m_æush
(
tsd
, &
tÿches
[
šd
]);

500 
	}
}

503 
	$tÿches_de¡roy
(
tsd_t
 *
tsd
, 
šd
)

505 
tÿches_t
 *
–m
 = &
tÿches
[
šd
];

506 
	`tÿches_–m_æush
(
tsd
, 
–m
);

507 
–m
->
Ãxt
 = 
tÿches_ava
;

508 
tÿches_ava
 = 
–m
;

509 
	}
}

511 
boŞ


512 
	$tÿche_boÙ
(
tsdn_t
 *
tsdn
)

514 
i
;

520 ià(
İt_lg_tÿche_max
 < 0 || (1U << o±_lg_tÿche_maxè< 
SMALL_MAXCLASS
)

521 
tÿche_maxşass
 = 
SMALL_MAXCLASS
;

522 ià((1U << 
İt_lg_tÿche_max
è> 
Ïrge_maxşass
)

523 
tÿche_maxşass
 = 
Ïrge_maxşass
;

525 
tÿche_maxşass
 = (1U << 
İt_lg_tÿche_max
);

527 
nhbšs
 = 
	`size2šdex
(
tÿche_maxşass
) + 1;

530 
tÿche_bš_šfo
 = (
tÿche_bš_šfo_t
 *)
	`ba£_®loc
(
tsdn
, 
nhbšs
 *

531 (
tÿche_bš_šfo_t
));

532 ià(
tÿche_bš_šfo
 =ğ
NULL
)

533  (
Œue
);

534 
¡ack_Ãlms
 = 0;

535 
i
 = 0; i < 
NBINS
; i++) {

536 ià((
¬’a_bš_šfo
[
i
].
Äegs
 << 1è<ğ
TCACHE_NSLOTS_SMALL_MIN
) {

537 
tÿche_bš_šfo
[
i
].
nÿched_max
 =

538 
TCACHE_NSLOTS_SMALL_MIN
;

539 } ià((
¬’a_bš_šfo
[
i
].
Äegs
 << 1) <=

540 
TCACHE_NSLOTS_SMALL_MAX
) {

541 
tÿche_bš_šfo
[
i
].
nÿched_max
 =

542 (
¬’a_bš_šfo
[
i
].
Äegs
 << 1);

544 
tÿche_bš_šfo
[
i
].
nÿched_max
 =

545 
TCACHE_NSLOTS_SMALL_MAX
;

547 
¡ack_Ãlms
 +ğ
tÿche_bš_šfo
[
i
].
nÿched_max
;

549 ; 
i
 < 
nhbšs
; i++) {

550 
tÿche_bš_šfo
[
i
].
nÿched_max
 = 
TCACHE_NSLOTS_LARGE
;

551 
¡ack_Ãlms
 +ğ
tÿche_bš_šfo
[
i
].
nÿched_max
;

554  (
çl£
);

555 
	}
}

	@dep/jemalloc-4.2.0/src/ticker.c

1 
	#JEMALLOC_TICKER_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

	@dep/jemalloc-4.2.0/src/tsd.c

1 
	#JEMALLOC_TSD_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
	gnş—nups
;

8 
m®loc_tsd_ş—nup_t
 
	gş—nups
[
MALLOC_TSD_CLEANUPS_MAX
];

10 
	$m®loc_tsd_d©a
(, , 
tsd_t
, 
TSD_INITIALIZER
)

15 
	$m®loc_tsd_m®loc
(
size_t
 
size
)

18  (
	`a0m®loc
(
	`CACHELINE_CEILING
(
size
)));

19 
	}
}

22 
	$m®loc_tsd_d®loc
(*
w¿µ”
)

25 
	`a0d®loc
(
w¿µ”
);

26 
	}
}

29 
	$m®loc_tsd_no_ş—nup
(*
¬g
)

32 
	`nÙ_»ached
();

33 
	}
}

35 #ià
defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è|| defšed(
_WIN32
)

36 #iâdeà
_WIN32


37 
	gJEMALLOC_EXPORT


40 
	$_m®loc_th»ad_ş—nup
()

42 
boŞ
 
³ndšg
[
MALLOC_TSD_CLEANUPS_MAX
], 
agaš
;

43 
i
;

45 
i
 = 0; i < 
nş—nups
; i++)

46 
³ndšg
[
i
] = 
Œue
;

49 
agaš
 = 
çl£
;

50 
i
 = 0; i < 
nş—nups
; i++) {

51 ià(
³ndšg
[
i
]) {

52 
³ndšg
[
i
] = 
ş—nups
[i]();

53 ià(
³ndšg
[
i
])

54 
agaš
 = 
Œue
;

57 } 
agaš
);

58 
	}
}

62 
	$m®loc_tsd_ş—nup_»gi¡”
(
	$boŞ
 (*
f
)())

65 
	`as£¹
(
nş—nups
 < 
MALLOC_TSD_CLEANUPS_MAX
);

66 
ş—nups
[
nş—nups
] = 
f
;

67 
nş—nups
++;

68 
	}
}

71 
	$tsd_ş—nup
(*
¬g
)

73 
tsd_t
 *
tsd
 = (tsd_ˆ*)
¬g
;

75 
tsd
->
¡©e
) {

76 
tsd_¡©e_unš™Ÿlized
:

79 
tsd_¡©e_nomš®
:

80 
	#O
(
n
, 
t
) \

81 
n
##
	`_ş—nup
(
tsd
);

	)

82 
MALLOC_TSD


83 #undeà
O


84 
tsd
->
¡©e
 = 
tsd_¡©e_purg©Üy
;

85 
	`tsd_£t
(
tsd
);

87 
tsd_¡©e_purg©Üy
:

95 
tsd_¡©e_»šÿº©ed
:

101 
tsd
->
¡©e
 = 
tsd_¡©e_purg©Üy
;

102 
	`tsd_£t
(
tsd
);

105 
	`nÙ_»ached
();

107 
	}
}

109 
tsd_t
 *

110 
	$m®loc_tsd_boÙ0
()

112 
tsd_t
 *
tsd
;

114 
nş—nups
 = 0;

115 ià(
	`tsd_boÙ0
())

116  (
NULL
);

117 
tsd
 = 
	`tsd_ãtch
();

118 *
	`tsd_¬’as_td©a_by·s¥_g‘
(
tsd
èğ
Œue
;

119  (
tsd
);

120 
	}
}

123 
	$m®loc_tsd_boÙ1
()

126 
	`tsd_boÙ1
();

127 *
	`tsd_¬’as_td©a_by·s¥_g‘
(
	`tsd_ãtch
()èğ
çl£
;

128 
	}
}

130 #ifdeà
_WIN32


131 
BOOL
 
WINAPI


132 
	$_s_ÿÎback
(
HINSTANCE
 
hš¡DLL
, 
DWORD
 
fdwR—sÚ
, 
LPVOID
 
ÍvRe£rved
)

135 
fdwR—sÚ
) {

136 #ifdeà
JEMALLOC_LAZY_LOCK


137 
DLL_THREAD_ATTACH
:

138 
i¡h»aded
 = 
Œue
;

141 
DLL_THREAD_DETACH
:

142 
	`_m®loc_th»ad_ş—nup
();

147  (
Œue
);

148 
	}
}

150 #ifdeà
_MSC_VER


151 #ifdeà
_M_IX86


152 #´agm¨
comm’t
(
lšk”
, "/INCLUDE:__tls_used")

153 #´agm¨
comm’t
(
lšk”
, "/INCLUDE:_tls_callback")

155 #´agm¨
comm’t
(
lšk”
, "/INCLUDE:_tls_used")

156 #´agm¨
comm’t
(
lšk”
, "/INCLUDE:tls_callback")

158 #´agm¨
£ùiÚ
(".CRT$XLY",,
»ad
)

160 
JEMALLOC_SECTION
(".CRT$XLY"è
	$JEMALLOC_ATTR
(
u£d
)

161 
	$BOOL
 (
WINAPI
 *cÚ¡ 
s_ÿÎback
)(
HINSTANCE
 
hš¡DLL
,

162 
DWORD
 
fdwR—sÚ
, 
LPVOID
 
ÍvRe£rved
èğ
_s_ÿÎback
;

165 #ià(!
	`defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è&& !defšed(
JEMALLOC_TLS
) && \

166 !
	$defšed
(
_WIN32
))

168 
	$tsd_š™_check_»cursiÚ
(
tsd_š™_h—d_t
 *
h—d
, 
tsd_š™_block_t
 *
block
)

170 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

171 
tsd_š™_block_t
 *
™”
;

174 
	`m®loc_mu‹x_lock
(
NULL
, &
h—d
->
lock
);

175 
	`ql_fÜ—ch
(
™”
, &
h—d
->
blocks
, 
lšk
) {

176 ià(
™”
->
th»ad
 =ğ
£lf
) {

177 
	`m®loc_mu‹x_uÆock
(
NULL
, &
h—d
->
lock
);

178  (
™”
->
d©a
);

182 
	`ql_–m_Ãw
(
block
, 
lšk
);

183 
block
->
th»ad
 = 
£lf
;

184 
	`ql__š£¹
(&
h—d
->
blocks
, 
block
, 
lšk
);

185 
	`m®loc_mu‹x_uÆock
(
NULL
, &
h—d
->
lock
);

186  (
NULL
);

187 
	}
}

190 
	$tsd_š™_fšish
(
tsd_š™_h—d_t
 *
h—d
, 
tsd_š™_block_t
 *
block
)

193 
	`m®loc_mu‹x_lock
(
NULL
, &
h—d
->
lock
);

194 
	`ql_»move
(&
h—d
->
blocks
, 
block
, 
lšk
);

195 
	`m®loc_mu‹x_uÆock
(
NULL
, &
h—d
->
lock
);

196 
	}
}

	@dep/jemalloc-4.2.0/src/util.c

5 
	#as£¹
(
e
) do { \

6 ià(
cÚfig_debug
 && !(
e
)) { \

7 
	`m®loc_wr™e
("<jemalloc>: Failed‡ssertion\n"); \

8 
	`abÜt
(); \

10 } 0)

	)

12 
	#nÙ_»ached
() do { \

13 ià(
cÚfig_debug
) { \

14 
	`m®loc_wr™e
("<jemalloc>: Unreachable code„eached\n"); \

15 
	`abÜt
(); \

17 
	`uÄ—chabË
(); \

18 } 0)

	)

20 
	#nÙ_im¶em’‹d
() do { \

21 ià(
cÚfig_debug
) { \

22 
	`m®loc_wr™e
("<jemalloc>: Not implemented\n"); \

23 
	`abÜt
(); \

25 } 0)

	)

27 
	#JEMALLOC_UTIL_C_


	)

28 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

33 
w¹mes§ge
(*
cbİaque
, cÚ¡ *
s
);

34 
	#U2S_BUFSIZE
 ((1U << (
LG_SIZEOF_INTMAX_T
 + 3)è+ 1)

	)

35 *
u2s
(
uštmax_t
 
x
, 
ba£
, 
boŞ
 
uµ”ÿ£
, *
s
,

36 
size_t
 *
¦’_p
);

37 
	#D2S_BUFSIZE
 (1 + 
U2S_BUFSIZE
)

	)

38 *
d2s
(
štmax_t
 
x
, 
sign
, *
s
, 
size_t
 *
¦’_p
);

39 
	#O2S_BUFSIZE
 (1 + 
U2S_BUFSIZE
)

	)

40 *
o2s
(
uštmax_t
 
x
, 
boŞ
 
®t_fÜm
, *
s
, 
size_t
 *
¦’_p
);

41 
	#X2S_BUFSIZE
 (2 + 
U2S_BUFSIZE
)

	)

42 *
x2s
(
uštmax_t
 
x
, 
boŞ
 
®t_fÜm
, boŞ 
uµ”ÿ£
, *
s
,

43 
size_t
 *
¦’_p
);

49 
	$w¹mes§ge
(*
cbİaque
, cÚ¡ *
s
)

52 #ifdeà
SYS_wr™e


62 
UNUSED
 
»suÉ
 = 
	`sysÿÎ
(
SYS_wr™e
, 
STDERR_FILENO
, 
s
, 
	`¡¾’
(s));

64 
UNUSED
 
ssize_t
 
»suÉ
 = 
	`wr™e
(
STDERR_FILENO
, 
s
, 
	`¡¾’
(s));

66 
	}
}

68 
JEMALLOC_EXPORT
 (*
je_m®loc_mes§ge
)(*, cÚ¡ *
s
);

75 
	$m®loc_wr™e
(cÚ¡ *
s
)

78 ià(
je_m®loc_mes§ge
 !ğ
NULL
)

79 
	`je_m®loc_mes§ge
(
NULL
, 
s
);

81 
	`w¹mes§ge
(
NULL
, 
s
);

82 
	}
}

89 
	$buã¼Ü
(
”r
, *
buf
, 
size_t
 
buæ’
)

92 #ifdeà
_WIN32


93 
	`FÜm©Mes§geA
(
FORMAT_MESSAGE_FROM_SYSTEM
, 
NULL
, 
”r
, 0,

94 (
LPSTR
)
buf
, (
DWORD
)
buæ’
, 
NULL
);

96 #–ià
	`defšed
(
__GLIBC__
è&& defšed(
_GNU_SOURCE
)

97 *
b
 = 
	`¡»¼Ü_r
(
”r
, 
buf
, 
buæ’
);

98 ià(
b
 !ğ
buf
) {

99 
	`¡ºıy
(
buf
, 
b
, 
buæ’
);

100 
buf
[
buæ’
-1] = '\0';

104  (
	`¡»¼Ü_r
(
”r
, 
buf
, 
buæ’
));

106 
	}
}

108 
uštmax_t


109 
	$m®loc_¡¹oumax
(cÚ¡ *
»¡riù
 
ÅŒ
, **»¡riù 
’d±r
, 
ba£
)

111 
uštmax_t
 
»t
, 
dig™
;

112 
b
;

113 
boŞ
 
Ãg
;

114 cÚ¡ *
p
, *
ns
;

116 
p
 = 
ÅŒ
;

117 ià(
ba£
 < 0 || base == 1 || base > 36) {

118 
ns
 = 
p
;

119 
	`£t_”ºo
(
EINVAL
);

120 
»t
 = 
UINTMAX_MAX
;

121 
Ïb–_»tuº
;

123 
b
 = 
ba£
;

126 
Ãg
 = 
çl£
;

127 
Œue
) {

128 *
p
) {

130 
p
++;

133 
Ãg
 = 
Œue
;

136 
p
++;

139 
Ïb–_´efix
;

144 
Ïb–_´efix
:

150 
ns
 = 
p
;

151 ià(*
p
 == '0') {

152 
p
[1]) {

155 ià(
b
 == 0)

156 
b
 = 8;

157 ià(
b
 == 8)

158 
p
++;

161 
p
[2]) {

168 ià(
b
 == 0)

169 
b
 = 16;

170 ià(
b
 == 16)

171 
p
 += 2;

178 
p
++;

179 
»t
 = 0;

180 
Ïb–_»tuº
;

183 ià(
b
 == 0)

184 
b
 = 10;

187 
»t
 = 0;

188 (*
p
 >ğ'0' && *°<ğ'9' && (
dig™
 = *°- '0'è< 
b
)

189 || (*
p
 >ğ'A' && *°<ğ'Z' && (
dig™
 = 10 + *°- 'A'è< 
b
)

190 || (*
p
 >ğ'a' && *°<ğ'z' && (
dig™
 = 10 + *°- 'a'è< 
b
)) {

191 
uštmax_t
 
´‘
 = 
»t
;

192 
»t
 *ğ
b
;

193 
»t
 +ğ
dig™
;

194 ià(
»t
 < 
´‘
) {

196 
	`£t_”ºo
(
ERANGE
);

197 
»t
 = 
UINTMAX_MAX
;

198 
Ïb–_»tuº
;

200 
p
++;

202 ià(
Ãg
)

203 
»t
 = -ret;

205 ià(
p
 =ğ
ns
) {

207 
	`£t_”ºo
(
EINVAL
);

208 
»t
 = 
UINTMAX_MAX
;

209 
Ïb–_»tuº
;

212 
Ïb–_»tuº
:

213 ià(
’d±r
 !ğ
NULL
) {

214 ià(
p
 =ğ
ns
) {

216 *
’d±r
 = (*)
ÅŒ
;

218 *
’d±r
 = (*)
p
;

220  (
»t
);

221 
	}
}

224 
	$u2s
(
uštmax_t
 
x
, 
ba£
, 
boŞ
 
uµ”ÿ£
, *
s
, 
size_t
 *
¦’_p
)

226 
i
;

228 
i
 = 
U2S_BUFSIZE
 - 1;

229 
s
[
i
] = '\0';

230 
ba£
) {

233 
i
--;

234 
s
[
i
] = "0123456789"[
x
 % (
ušt64_t
)10];

235 
x
 /ğ(
ušt64_t
)10;

236 } 
x
 > 0);

239 cÚ¡ *
dig™s
 = (
uµ”ÿ£
)

244 
i
--;

245 
s
[
i
] = 
dig™s
[
x
 & 0xf];

246 
x
 >>= 4;

247 } 
x
 > 0);

250 cÚ¡ *
dig™s
 = (
uµ”ÿ£
)

254 
	`as£¹
(
ba£
 >= 2 && base <= 36);

256 
i
--;

257 
s
[
i
] = 
dig™s
[
x
 % (
ušt64_t
)
ba£
];

258 
x
 /ğ(
ušt64_t
)
ba£
;

259 } 
x
 > 0);

262 *
¦’_p
 = 
U2S_BUFSIZE
 - 1 - 
i
;

263  (&
s
[
i
]);

264 
	}
}

267 
	$d2s
(
štmax_t
 
x
, 
sign
, *
s
, 
size_t
 *
¦’_p
)

269 
boŞ
 
Ãg
;

271 ià((
Ãg
 = (
x
 < 0)))

272 
x
 = -x;

273 
s
 = 
	`u2s
(
x
, 10, 
çl£
, s, 
¦’_p
);

274 ià(
Ãg
)

275 
sign
 = '-';

276 
sign
) {

278 ià(!
Ãg
)

283 
s
--;

284 (*
¦’_p
)++;

285 *
s
 = 
sign
;

287 : 
	`nÙ_»ached
();

289  (
s
);

290 
	}
}

293 
	$o2s
(
uštmax_t
 
x
, 
boŞ
 
®t_fÜm
, *
s
, 
size_t
 *
¦’_p
)

296 
s
 = 
	`u2s
(
x
, 8, 
çl£
, s, 
¦’_p
);

297 ià(
®t_fÜm
 && *
s
 != '0') {

298 
s
--;

299 (*
¦’_p
)++;

300 *
s
 = '0';

302  (
s
);

303 
	}
}

306 
	$x2s
(
uštmax_t
 
x
, 
boŞ
 
®t_fÜm
, boŞ 
uµ”ÿ£
, *
s
, 
size_t
 *
¦’_p
)

309 
s
 = 
	`u2s
(
x
, 16, 
uµ”ÿ£
, s, 
¦’_p
);

310 ià(
®t_fÜm
) {

311 
s
 -= 2;

312 (*
¦’_p
) += 2;

313 
	`memıy
(
s
, 
uµ”ÿ£
 ? "0X" : "0x", 2);

315  (
s
);

316 
	}
}

318 
size_t


319 
	$m®loc_v¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

321 
size_t
 
i
;

322 cÚ¡ *
f
;

324 
	#APPEND_C
(
c
) do { \

325 ià(
i
 < 
size
) \

326 
¡r
[
i
] = (
c
); \

327 
i
++; \

328 } 0)

	)

329 
	#APPEND_S
(
s
, 
¦’
) do { \

330 ià(
i
 < 
size
) { \

331 
size_t
 
ıyËn
 = (
¦’
 <ğ
size
 - 
i
) ? slen : size - i; \

332 
	`memıy
(&
¡r
[
i
], 
s
, 
ıyËn
); \

334 
i
 +ğ
¦’
; \

335 } 0)

	)

336 
	#APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
) do { \

338 
size_t
 
·d_Ën
 = (
width
 =ğ-1è? 0 : ((
¦’
 < (size_t)width) ? \

339 (
size_t
)
width
 - 
¦’
 : 0); \

340 ià(!
Ëá_ju¡ify
 && 
·d_Ën
 != 0) { \

341 
size_t
 
j
; \

342 
j
 = 0; j < 
·d_Ën
; j++) \

343 
	`APPEND_C
(' '); \

346 
	`APPEND_S
(
s
, 
¦’
); \

348 ià(
Ëá_ju¡ify
 && 
·d_Ën
 != 0) { \

349 
size_t
 
j
; \

350 
j
 = 0; j < 
·d_Ën
; j++) \

351 
	`APPEND_C
(' '); \

353 } 0)

	)

354 
	#GET_ARG_NUMERIC
(
v®
, 
Ën
) do { \

355 
Ën
) { \

357 
v®
 = 
	`va_¬g
(
­
, ); \

360 
v®
 = 
	`va_¬g
(
­
, ); \

363 
v®
 = 
	`va_¬g
(
­
, ); \

366 
v®
 = 
	`va_¬g
(
­
, ); \

369 
v®
 = 
	`va_¬g
(
­
, ); \

372 
v®
 = 
	`va_¬g
(
­
, ); \

375 
v®
 = 
	`va_¬g
(
­
, 
štmax_t
); \

378 
v®
 = 
	`va_¬g
(
­
, 
uštmax_t
); \

381 
v®
 = 
	`va_¬g
(
­
, 
±rdiff_t
); \

384 
v®
 = 
	`va_¬g
(
­
, 
ssize_t
); \

387 
v®
 = 
	`va_¬g
(
­
, 
size_t
); \

390 
v®
 = 
	`va_¬g
(
­
, 
ušŒ_t
); \

393 
	`nÙ_»ached
(); \

394 
v®
 = 0; \

396 } 0)

	)

398 
i
 = 0;

399 
f
 = 
fÜm©
;

400 
Œue
) {

401 *
f
) {

402 '\0': 
Ïb–_out
;

404 
boŞ
 
®t_fÜm
 = 
çl£
;

405 
boŞ
 
Ëá_ju¡ify
 = 
çl£
;

406 
boŞ
 
¶us_¥aû
 = 
çl£
;

407 
boŞ
 
¶us_¶us
 = 
çl£
;

408 
´ec
 = -1;

409 
width
 = -1;

410 
Ën
 = '?';

411 *
s
;

412 
size_t
 
¦’
;

414 
f
++;

416 
Œue
) {

417 *
f
) {

419 
	`as£¹
(!
®t_fÜm
);

420 
®t_fÜm
 = 
Œue
;

423 
	`as£¹
(!
Ëá_ju¡ify
);

424 
Ëá_ju¡ify
 = 
Œue
;

427 
	`as£¹
(!
¶us_¥aû
);

428 
¶us_¥aû
 = 
Œue
;

431 
	`as£¹
(!
¶us_¶us
);

432 
¶us_¶us
 = 
Œue
;

434 : 
Ïb–_width
;

436 
f
++;

439 
Ïb–_width
:

440 *
f
) {

442 
width
 = 
	`va_¬g
(
­
, );

443 
f
++;

444 ià(
width
 < 0) {

445 
Ëá_ju¡ify
 = 
Œue
;

446 
width
 = -width;

451 
uštmax_t
 
uwidth
;

452 
	`£t_”ºo
(0);

453 
uwidth
 = 
	`m®loc_¡¹oumax
(
f
, (**)&f, 10);

454 
	`as£¹
(
uwidth
 !ğ
UINTMAX_MAX
 || 
	`g‘_”ºo
() !=

455 
ERANGE
);

456 
width
 = ()
uwidth
;

462 ià(*
f
 == '.')

463 
f
++;

465 
Ïb–_Ëngth
;

467 *
f
) {

469 
´ec
 = 
	`va_¬g
(
­
, );

470 
f
++;

474 
uštmax_t
 
u´ec
;

475 
	`£t_”ºo
(0);

476 
u´ec
 = 
	`m®loc_¡¹oumax
(
f
, (**)&f, 10);

477 
	`as£¹
(
u´ec
 !ğ
UINTMAX_MAX
 || 
	`g‘_”ºo
() !=

478 
ERANGE
);

479 
´ec
 = ()
u´ec
;

485 
Ïb–_Ëngth
:

486 *
f
) {

488 
f
++;

489 ià(*
f
 == 'l') {

490 
Ën
 = 'q';

491 
f
++;

493 
Ën
 = 'l';

496 
Ën
 = *
f
;

497 
f
++;

502 *
f
) {

505 
	`APPEND_C
(*
f
);

506 
f
++;

509 
štmax_t
 
v®
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

510 
buf
[
D2S_BUFSIZE
];

512 
	`GET_ARG_NUMERIC
(
v®
, 
Ën
);

513 
s
 = 
	`d2s
(
v®
, (
¶us_¶us
 ? '+' : (
¶us_¥aû
 ?

514 ' ' : '-')), 
buf
, &
¦’
);

515 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

516 
f
++;

519 
uštmax_t
 
v®
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

520 
buf
[
O2S_BUFSIZE
];

522 
	`GET_ARG_NUMERIC
(
v®
, 
Ën
 | 0x80);

523 
s
 = 
	`o2s
(
v®
, 
®t_fÜm
, 
buf
, &
¦’
);

524 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

525 
f
++;

528 
uštmax_t
 
v®
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

529 
buf
[
U2S_BUFSIZE
];

531 
	`GET_ARG_NUMERIC
(
v®
, 
Ën
 | 0x80);

532 
s
 = 
	`u2s
(
v®
, 10, 
çl£
, 
buf
, &
¦’
);

533 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

534 
f
++;

537 
uštmax_t
 
v®
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

538 
buf
[
X2S_BUFSIZE
];

540 
	`GET_ARG_NUMERIC
(
v®
, 
Ën
 | 0x80);

541 
s
 = 
	`x2s
(
v®
, 
®t_fÜm
, *
f
 =ğ'X', 
buf
, &
¦’
);

542 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

543 
f
++;

546 
v®
;

547 
buf
[2];

549 
	`as£¹
(
Ën
 == '?' ||†en == 'l');

550 
	`as£¹_nÙ_im¶em’‹d
(
Ën
 != 'l');

551 
v®
 = 
	`va_¬g
(
­
, );

552 
buf
[0] = 
v®
;

553 
buf
[1] = '\0';

554 
	`APPEND_PADDED_S
(
buf
, 1, 
width
, 
Ëá_ju¡ify
);

555 
f
++;

558 
	`as£¹
(
Ën
 == '?' ||†en == 'l');

559 
	`as£¹_nÙ_im¶em’‹d
(
Ën
 != 'l');

560 
s
 = 
	`va_¬g
(
­
, *);

561 
¦’
 = (
´ec
 < 0è? 
	`¡¾’
(
s
è: (
size_t
)prec;

562 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

563 
f
++;

566 
uštmax_t
 
v®
;

567 
buf
[
X2S_BUFSIZE
];

569 
	`GET_ARG_NUMERIC
(
v®
, 'p');

570 
s
 = 
	`x2s
(
v®
, 
Œue
, 
çl£
, 
buf
, &
¦’
);

571 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

572 
f
++;

574 } : 
	`nÙ_»ached
();

578 
	`APPEND_C
(*
f
);

579 
f
++;

583 
Ïb–_out
:

584 ià(
i
 < 
size
)

585 
¡r
[
i
] = '\0';

587 
¡r
[
size
 - 1] = '\0';

589 #undeà
APPEND_C


590 #undeà
APPEND_S


591 #undeà
APPEND_PADDED_S


592 #undeà
GET_ARG_NUMERIC


593  (
i
);

594 
	}
}

596 
	$JEMALLOC_FORMAT_PRINTF
(3, 4)

597 
size_t


598 
	$m®loc_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, ...)

600 
size_t
 
»t
;

601 
va_li¡
 
­
;

603 
	`va_¡¬t
(
­
, 
fÜm©
);

604 
»t
 = 
	`m®loc_v¢´štf
(
¡r
, 
size
, 
fÜm©
, 
­
);

605 
	`va_’d
(
­
);

607  (
»t
);

608 
	}
}

611 
	$m®loc_vırštf
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

612 cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

614 
buf
[
MALLOC_PRINTF_BUFSIZE
];

616 ià(
wr™e_cb
 =ğ
NULL
) {

622 
wr™e_cb
 = (
je_m®loc_mes§ge
 !ğ
NULL
) ? je_malloc_message :

623 
w¹mes§ge
;

624 
cbİaque
 = 
NULL
;

627 
	`m®loc_v¢´štf
(
buf
, (buf), 
fÜm©
, 
­
);

628 
	`wr™e_cb
(
cbİaque
, 
buf
);

629 
	}
}

635 
	$JEMALLOC_FORMAT_PRINTF
(3, 4)

637 
	$m®loc_ırštf
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

638 cÚ¡ *
fÜm©
, ...)

640 
va_li¡
 
­
;

642 
	`va_¡¬t
(
­
, 
fÜm©
);

643 
	`m®loc_vırštf
(
wr™e_cb
, 
cbİaque
, 
fÜm©
, 
­
);

644 
	`va_’d
(
­
);

645 
	}
}

648 
	$JEMALLOC_FORMAT_PRINTF
(1, 2)

650 
	$m®loc_´štf
(cÚ¡ *
fÜm©
, ...)

652 
va_li¡
 
­
;

654 
	`va_¡¬t
(
­
, 
fÜm©
);

655 
	`m®loc_vırštf
(
NULL
, NULL, 
fÜm©
, 
­
);

656 
	`va_’d
(
­
);

657 
	}
}

663 #undeà
as£¹


664 #undeà
nÙ_»ached


665 #undeà
nÙ_im¶em’‹d


666 
	~"jem®loc/š‹º®/as£¹.h
"

	@dep/jemalloc-4.2.0/src/valgrind.c

1 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

2 #iâdeà
JEMALLOC_VALGRIND


6 
	~<v®gršd/memcheck.h
>

9 
	$v®gršd_make_mem_nßcûss
(*
±r
, 
size_t
 
usize
)

12 
	`VALGRIND_MAKE_MEM_NOACCESS
(
±r
, 
usize
);

13 
	}
}

16 
	$v®gršd_make_mem_undefšed
(*
±r
, 
size_t
 
usize
)

19 
	`VALGRIND_MAKE_MEM_UNDEFINED
(
±r
, 
usize
);

20 
	}
}

23 
	$v®gršd_make_mem_defšed
(*
±r
, 
size_t
 
usize
)

26 
	`VALGRIND_MAKE_MEM_DEFINED
(
±r
, 
usize
);

27 
	}
}

30 
	$v®gršd_ä“like_block
(*
±r
, 
size_t
 
usize
)

33 
	`VALGRIND_FREELIKE_BLOCK
(
±r
, 
usize
);

34 
	}
}

	@dep/jemalloc-4.2.0/src/witness.c

1 
	#JEMALLOC_WITNESS_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

5 
	$w™Ãss_š™
(
w™Ãss_t
 *
w™Ãss
, cÚ¡ *
Çme
, 
w™Ãss_¿nk_t
 
¿nk
,

6 
w™Ãss_comp_t
 *
comp
)

9 
w™Ãss
->
Çme
 =‚ame;

10 
w™Ãss
->
¿nk
 =„ank;

11 
w™Ãss
->
comp
 = comp;

12 
	}
}

14 #ifdeà
JEMALLOC_JET


15 #undeà
w™Ãss_lock_”rÜ


16 
	#w™Ãss_lock_”rÜ
 
	`JEMALLOC_N
(
n_w™Ãss_lock_”rÜ
)

	)

19 
	$w™Ãss_lock_”rÜ
(cÚ¡ 
w™Ãss_li¡_t
 *
w™Ãs£s
, cÚ¡ 
w™Ãss_t
 *
w™Ãss
)

21 
w™Ãss_t
 *
w
;

23 
	`m®loc_´štf
("<jemalloc>: Lock„ank order„eversal:");

24 
	`ql_fÜ—ch
(
w
, 
w™Ãs£s
, 
lšk
) {

25 
	`m®loc_´štf
(" %s(%u)", 
w
->
Çme
, w->
¿nk
);

27 
	`m®loc_´štf
(" %s(%u)\n", 
w™Ãss
->
Çme
, w™Ãss->
¿nk
);

28 
	`abÜt
();

29 
	}
}

30 #ifdeà
JEMALLOC_JET


31 #undeà
w™Ãss_lock_”rÜ


32 
	#w™Ãss_lock_”rÜ
 
	`JEMALLOC_N
(
w™Ãss_lock_”rÜ
)

	)

33 
w™Ãss_lock_”rÜ_t
 *
	gw™Ãss_lock_”rÜ
 = 
JEMALLOC_N
(
n_w™Ãss_lock_”rÜ
);

36 #ifdeà
JEMALLOC_JET


37 #undeà
w™Ãss_owÃr_”rÜ


38 
	#w™Ãss_owÃr_”rÜ
 
	`JEMALLOC_N
(
n_w™Ãss_owÃr_”rÜ
)

	)

41 
	$w™Ãss_owÃr_”rÜ
(cÚ¡ 
w™Ãss_t
 *
w™Ãss
)

44 
	`m®loc_´štf
("<jem®loc>: Should owÀ%s(%u)\n", 
w™Ãss
->
Çme
,

45 
w™Ãss
->
¿nk
);

46 
	`abÜt
();

47 
	}
}

48 #ifdeà
JEMALLOC_JET


49 #undeà
w™Ãss_owÃr_”rÜ


50 
	#w™Ãss_owÃr_”rÜ
 
	`JEMALLOC_N
(
w™Ãss_owÃr_”rÜ
)

	)

51 
w™Ãss_owÃr_”rÜ_t
 *
	gw™Ãss_owÃr_”rÜ
 = 
JEMALLOC_N
(
n_w™Ãss_owÃr_”rÜ
);

54 #ifdeà
JEMALLOC_JET


55 #undeà
w™Ãss_nÙ_owÃr_”rÜ


56 
	#w™Ãss_nÙ_owÃr_”rÜ
 
	`JEMALLOC_N
(
n_w™Ãss_nÙ_owÃr_”rÜ
)

	)

59 
	$w™Ãss_nÙ_owÃr_”rÜ
(cÚ¡ 
w™Ãss_t
 *
w™Ãss
)

62 
	`m®loc_´štf
("<jem®loc>: Should‚Ù owÀ%s(%u)\n", 
w™Ãss
->
Çme
,

63 
w™Ãss
->
¿nk
);

64 
	`abÜt
();

65 
	}
}

66 #ifdeà
JEMALLOC_JET


67 #undeà
w™Ãss_nÙ_owÃr_”rÜ


68 
	#w™Ãss_nÙ_owÃr_”rÜ
 
	`JEMALLOC_N
(
w™Ãss_nÙ_owÃr_”rÜ
)

	)

69 
w™Ãss_nÙ_owÃr_”rÜ_t
 *
	gw™Ãss_nÙ_owÃr_”rÜ
 =

70 
JEMALLOC_N
(
n_w™Ãss_nÙ_owÃr_”rÜ
);

73 #ifdeà
JEMALLOC_JET


74 #undeà
w™Ãss_lockËss_”rÜ


75 
	#w™Ãss_lockËss_”rÜ
 
	`JEMALLOC_N
(
n_w™Ãss_lockËss_”rÜ
)

	)

78 
	$w™Ãss_lockËss_”rÜ
(cÚ¡ 
w™Ãss_li¡_t
 *
w™Ãs£s
)

80 
w™Ãss_t
 *
w
;

82 
	`m®loc_´štf
("<jemalloc>: Should‚ot own‡ny†ocks:");

83 
	`ql_fÜ—ch
(
w
, 
w™Ãs£s
, 
lšk
) {

84 
	`m®loc_´štf
(" %s(%u)", 
w
->
Çme
, w->
¿nk
);

86 
	`m®loc_´štf
("\n");

87 
	`abÜt
();

88 
	}
}

89 #ifdeà
JEMALLOC_JET


90 #undeà
w™Ãss_lockËss_”rÜ


91 
	#w™Ãss_lockËss_”rÜ
 
	`JEMALLOC_N
(
w™Ãss_lockËss_”rÜ
)

	)

92 
w™Ãss_lockËss_”rÜ_t
 *
	gw™Ãss_lockËss_”rÜ
 =

93 
JEMALLOC_N
(
n_w™Ãss_lockËss_”rÜ
);

97 
	$w™Ãs£s_ş—nup
(
tsd_t
 *
tsd
)

100 
	`w™Ãss_as£¹_lockËss
(
	`tsd_tsdn
(
tsd
));

103 
	}
}

106 
	$w™Ãss_fÜk_ş—nup
(
tsd_t
 *
tsd
)

110 
	}
}

113 
	$w™Ãss_´efÜk
(
tsd_t
 *
tsd
)

116 
	`tsd_w™Ãss_fÜk_£t
(
tsd
, 
Œue
);

117 
	}
}

120 
	$w™Ãss_po¡fÜk_·»Á
(
tsd_t
 *
tsd
)

123 
	`tsd_w™Ãss_fÜk_£t
(
tsd
, 
çl£
);

124 
	}
}

127 
	$w™Ãss_po¡fÜk_chd
(
tsd_t
 *
tsd
)

129 #iâdeà
JEMALLOC_MUTEX_INIT_CB


130 
w™Ãss_li¡_t
 *
w™Ãs£s
;

132 
w™Ãs£s
 = 
	`tsd_w™Ãs£¥_g‘
(
tsd
);

133 
	`ql_Ãw
(
w™Ãs£s
);

135 
	`tsd_w™Ãss_fÜk_£t
(
tsd
, 
çl£
);

136 
	}
}

	@dep/jemalloc-4.2.0/src/zone.c

1 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

2 #iâdeà
JEMALLOC_ZONE


10 
m®loc_zÚe_t
 *
	$m®loc_deçuÉ_purg—bË_zÚe
()

11 
	`JEMALLOC_ATTR
(
w—k_impÜt
);

16 
m®loc_zÚe_t
 
zÚe
;

17 
m®loc_šŒo¥eùiÚ_t
 
zÚe_šŒo¥eù
;

22 
size_t
 
	`zÚe_size
(
m®loc_zÚe_t
 *
zÚe
, *
±r
);

23 *
	`zÚe_m®loc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
);

24 *
	`zÚe_ÿÎoc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
num
, size_ˆ
size
);

25 *
	`zÚe_v®loc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
);

26 
	`zÚe_ä“
(
m®loc_zÚe_t
 *
zÚe
, *
±r
);

27 *
	`zÚe_»®loc
(
m®loc_zÚe_t
 *
zÚe
, *
±r
, 
size_t
 
size
);

28 #ià(
JEMALLOC_ZONE_VERSION
 >= 5)

29 *
	`zÚe_mem®ign
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
®ignm’t
,

31 #ià(
JEMALLOC_ZONE_VERSION
 >= 6)

32 
size_t
 
size
);

33 
	`zÚe_ä“_defš™e_size
(
m®loc_zÚe_t
 *
zÚe
, *
±r
,

34 
size_t
 
size
);

36 *
	`zÚe_de¡roy
(
m®loc_zÚe_t
 *
zÚe
);

37 
size_t
 
	`zÚe_good_size
(
m®loc_zÚe_t
 *
zÚe
, size_ˆ
size
);

38 
	`zÚe_fÜû_lock
(
m®loc_zÚe_t
 *
zÚe
);

39 
	`zÚe_fÜû_uÆock
(
m®loc_zÚe_t
 *
zÚe
);

46 
size_t


47 
	$zÚe_size
(
m®loc_zÚe_t
 *
zÚe
, *
±r
)

59  (
	`iv§Îoc
(
	`tsdn_ãtch
(), 
±r
, 
cÚfig_´of
));

60 
	}
}

63 
	$zÚe_m®loc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
)

66  (
	`je_m®loc
(
size
));

67 
	}
}

70 
	$zÚe_ÿÎoc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
num
, size_ˆ
size
)

73  (
	`je_ÿÎoc
(
num
, 
size
));

74 
	}
}

77 
	$zÚe_v®loc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
)

79 *
»t
 = 
NULL
;

81 
	`je_posix_mem®ign
(&
»t
, 
PAGE
, 
size
);

83  (
»t
);

84 
	}
}

87 
	$zÚe_ä“
(
m®loc_zÚe_t
 *
zÚe
, *
±r
)

90 ià(
	`iv§Îoc
(
	`tsdn_ãtch
(), 
±r
, 
cÚfig_´of
) != 0) {

91 
	`je_ä“
(
±r
);

95 
	`ä“
(
±r
);

96 
	}
}

99 
	$zÚe_»®loc
(
m®loc_zÚe_t
 *
zÚe
, *
±r
, 
size_t
 
size
)

102 ià(
	`iv§Îoc
(
	`tsdn_ãtch
(), 
±r
, 
cÚfig_´of
) != 0)

103  (
	`je_»®loc
(
±r
, 
size
));

105  (
	`»®loc
(
±r
, 
size
));

106 
	}
}

108 #ià(
JEMALLOC_ZONE_VERSION
 >= 5)

110 
	$zÚe_mem®ign
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
®ignm’t
, size_ˆ
size
)

112 *
»t
 = 
NULL
;

114 
	`je_posix_mem®ign
(&
»t
, 
®ignm’t
, 
size
);

116  (
»t
);

117 
	}
}

120 #ià(
JEMALLOC_ZONE_VERSION
 >= 6)

122 
	$zÚe_ä“_defš™e_size
(
m®loc_zÚe_t
 *
zÚe
, *
±r
, 
size_t
 
size
)

124 
size_t
 
®loc_size
;

126 
®loc_size
 = 
	`iv§Îoc
(
	`tsdn_ãtch
(), 
±r
, 
cÚfig_´of
);

127 ià(
®loc_size
 != 0) {

128 
	`as£¹
(
®loc_size
 =ğ
size
);

129 
	`je_ä“
(
±r
);

133 
	`ä“
(
±r
);

134 
	}
}

138 
	$zÚe_de¡roy
(
m®loc_zÚe_t
 *
zÚe
)

142 
	`nÙ_»ached
();

143  (
NULL
);

144 
	}
}

146 
size_t


147 
	$zÚe_good_size
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
)

150 ià(
size
 == 0)

151 
size
 = 1;

152  (
	`s2u
(
size
));

153 
	}
}

156 
	$zÚe_fÜû_lock
(
m®loc_zÚe_t
 *
zÚe
)

159 ià(
i¡h»aded
)

160 
	`jem®loc_´efÜk
();

161 
	}
}

164 
	$zÚe_fÜû_uÆock
(
m®loc_zÚe_t
 *
zÚe
)

167 ià(
i¡h»aded
)

168 
	`jem®loc_po¡fÜk_·»Á
();

169 
	}
}

171 
	$JEMALLOC_ATTR
(
cÚ¡ruùÜ
)

173 
	$»gi¡”_zÚe
()

180 
m®loc_zÚe_t
 *
deçuÉ_zÚe
 = 
	`m®loc_deçuÉ_zÚe
();

181 
m®loc_zÚe_t
 *
purg—bË_zÚe
 = 
NULL
;

182 ià(!
deçuÉ_zÚe
->
zÚe_Çme
 ||

183 
	`¡rcmp
(
deçuÉ_zÚe
->
zÚe_Çme
, "DefaultMallocZone") != 0) {

187 
zÚe
.
size
 = (*)
zÚe_size
;

188 
zÚe
.
m®loc
 = (*)
zÚe_m®loc
;

189 
zÚe
.
ÿÎoc
 = (*)
zÚe_ÿÎoc
;

190 
zÚe
.
v®loc
 = (*)
zÚe_v®loc
;

191 
zÚe
.
ä“
 = (*)
zÚe_ä“
;

192 
zÚe
.
»®loc
 = (*)
zÚe_»®loc
;

193 
zÚe
.
de¡roy
 = (*)
zÚe_de¡roy
;

194 
zÚe
.
zÚe_Çme
 = "jemalloc_zone";

195 
zÚe
.
b©ch_m®loc
 = 
NULL
;

196 
zÚe
.
b©ch_ä“
 = 
NULL
;

197 
zÚe
.
šŒo¥eù
 = &
zÚe_šŒo¥eù
;

198 
zÚe
.
v”siÚ
 = 
JEMALLOC_ZONE_VERSION
;

199 #ià(
JEMALLOC_ZONE_VERSION
 >= 5)

200 
zÚe
.
mem®ign
 = 
zÚe_mem®ign
;

202 #ià(
JEMALLOC_ZONE_VERSION
 >= 6)

203 
zÚe
.
ä“_defš™e_size
 = 
zÚe_ä“_defš™e_size
;

205 #ià(
JEMALLOC_ZONE_VERSION
 >= 8)

206 
zÚe
.
´essu»_»l›f
 = 
NULL
;

209 
zÚe_šŒo¥eù
.
’um”©Ü
 = 
NULL
;

210 
zÚe_šŒo¥eù
.
good_size
 = (*)
zÚe_good_size
;

211 
zÚe_šŒo¥eù
.
check
 = 
NULL
;

212 
zÚe_šŒo¥eù
.
´št
 = 
NULL
;

213 
zÚe_šŒo¥eù
.
log
 = 
NULL
;

214 
zÚe_šŒo¥eù
.
fÜû_lock
 = (*)
zÚe_fÜû_lock
;

215 
zÚe_šŒo¥eù
.
fÜû_uÆock
 = (*)
zÚe_fÜû_uÆock
;

216 
zÚe_šŒo¥eù
.
¡©i¡ics
 = 
NULL
;

217 #ià(
JEMALLOC_ZONE_VERSION
 >= 6)

218 
zÚe_šŒo¥eù
.
zÚe_locked
 = 
NULL
;

220 #ià(
JEMALLOC_ZONE_VERSION
 >= 7)

221 
zÚe_šŒo¥eù
.
’abË_disch¬ge_checkšg
 = 
NULL
;

222 
zÚe_šŒo¥eù
.
di§bË_disch¬ge_checkšg
 = 
NULL
;

223 
zÚe_šŒo¥eù
.
disch¬ge
 = 
NULL
;

224 #ifdeà
__BLOCKS__


225 
zÚe_šŒo¥eù
.
’um”©e_disch¬ged_poš‹rs
 = 
NULL
;

227 
zÚe_šŒo¥eù
.
’um”©e_uÇvaabË_w™hout_blocks
 = 
NULL
;

242 ià(
m®loc_deçuÉ_purg—bË_zÚe
 !ğ
NULL
)

243 
purg—bË_zÚe
 = 
	`m®loc_deçuÉ_purg—bË_zÚe
();

246 
	`m®loc_zÚe_»gi¡”
(&
zÚe
);

249 
deçuÉ_zÚe
 = 
	`m®loc_deçuÉ_zÚe
();

258 
	`m®loc_zÚe_uÄegi¡”
(
deçuÉ_zÚe
);

259 
	`m®loc_zÚe_»gi¡”
(
deçuÉ_zÚe
);

271 ià(
purg—bË_zÚe
) {

272 
	`m®loc_zÚe_uÄegi¡”
(
purg—bË_zÚe
);

273 
	`m®loc_zÚe_»gi¡”
(
purg—bË_zÚe
);

275 } 
	`m®loc_deçuÉ_zÚe
(è!ğ&
zÚe
);

276 
	}
}

	@dep/jemalloc-4.2.0/test/include/test/SFMT-alti.h

52 #iâdeà
SFMT_ALTI_H


53 
	#SFMT_ALTI_H


	)

63 
JEMALLOC_ALWAYS_INLINE


64 
veùÜ
 
	$vec_»cursiÚ
(
veùÜ
 
a
,

65 
veùÜ
 
b
,

66 
veùÜ
 
c
,

67 
veùÜ
 
d
) {

69 cÚ¡ 
veùÜ
 
¦1
 = 
ALTI_SL1
;

70 cÚ¡ 
veùÜ
 
¤1
 = 
ALTI_SR1
;

71 #ifdeà
ONLY64


72 cÚ¡ 
veùÜ
 
mask
 = 
ALTI_MSK64
;

73 cÚ¡ 
veùÜ
 
³rm_¦
 = 
ALTI_SL2_PERM64
;

74 cÚ¡ 
veùÜ
 
³rm_¤
 = 
ALTI_SR2_PERM64
;

76 cÚ¡ 
veùÜ
 
mask
 = 
ALTI_MSK
;

77 cÚ¡ 
veùÜ
 
³rm_¦
 = 
ALTI_SL2_PERM
;

78 cÚ¡ 
veùÜ
 
³rm_¤
 = 
ALTI_SR2_PERM
;

80 
veùÜ
 
v
, 
w
, 
x
, 
y
, 
z
;

81 
x
 = 
	`vec_³rm
(
a
, (
veùÜ
 )
³rm_¦
,…erm_sl);

82 
v
 = 
a
;

83 
y
 = 
	`vec_¤
(
b
, 
¤1
);

84 
z
 = 
	`vec_³rm
(
c
, (
veùÜ
 )
³rm_¤
,…erm_sr);

85 
w
 = 
	`vec_¦
(
d
, 
¦1
);

86 
z
 = 
	`vec_xÜ
(z, 
w
);

87 
y
 = 
	`vec_ªd
(y, 
mask
);

88 
v
 = 
	`vec_xÜ
(v, 
x
);

89 
z
 = 
	`vec_xÜ
(z, 
y
);

90 
z
 = 
	`vec_xÜ
(z, 
v
);

91  
z
;

92 
	}
}

98 
JEMALLOC_INLINE
 
	$g’_¿nd_®l
(
sfmt_t
 *
ùx
) {

99 
i
;

100 
veùÜ
 
r
, 
r1
, 
r2
;

102 
r1
 = 
ùx
->
sfmt
[
N
 - 2].
s
;

103 
r2
 = 
ùx
->
sfmt
[
N
 - 1].
s
;

104 
i
 = 0; i < 
N
 - 
POS1
; i++) {

105 
r
 = 
	`vec_»cursiÚ
(
ùx
->
sfmt
[
i
].
s
, ctx->sfmt[˜+ 
POS1
].s, 
r1
, 
r2
);

106 
ùx
->
sfmt
[
i
].
s
 = 
r
;

107 
r1
 = 
r2
;

108 
r2
 = 
r
;

110 ; 
i
 < 
N
; i++) {

111 
r
 = 
	`vec_»cursiÚ
(
ùx
->
sfmt
[
i
].
s
, ctx->sfmt[˜+ 
POS1
 - 
N
].s, 
r1
, 
r2
);

112 
ùx
->
sfmt
[
i
].
s
 = 
r
;

113 
r1
 = 
r2
;

114 
r2
 = 
r
;

116 
	}
}

125 
JEMALLOC_INLINE
 
	$g’_¿nd_¬¿y
(
sfmt_t
 *
ùx
, 
w128_t
 *
¬¿y
, 
size
) {

126 
i
, 
j
;

127 
veùÜ
 
r
, 
r1
, 
r2
;

129 
r1
 = 
ùx
->
sfmt
[
N
 - 2].
s
;

130 
r2
 = 
ùx
->
sfmt
[
N
 - 1].
s
;

131 
i
 = 0; i < 
N
 - 
POS1
; i++) {

132 
r
 = 
	`vec_»cursiÚ
(
ùx
->
sfmt
[
i
].
s
, ctx->sfmt[˜+ 
POS1
].s, 
r1
, 
r2
);

133 
¬¿y
[
i
].
s
 = 
r
;

134 
r1
 = 
r2
;

135 
r2
 = 
r
;

137 ; 
i
 < 
N
; i++) {

138 
r
 = 
	`vec_»cursiÚ
(
ùx
->
sfmt
[
i
].
s
, 
¬¿y
[˜+ 
POS1
 - 
N
].s, 
r1
, 
r2
);

139 
¬¿y
[
i
].
s
 = 
r
;

140 
r1
 = 
r2
;

141 
r2
 = 
r
;

144 ; 
i
 < 
size
 - 
N
; i++) {

145 
r
 = 
	`vec_»cursiÚ
(
¬¿y
[
i
 - 
N
].
s
,‡¼ay[˜+ 
POS1
 - N].s, 
r1
, 
r2
);

146 
¬¿y
[
i
].
s
 = 
r
;

147 
r1
 = 
r2
;

148 
r2
 = 
r
;

150 
j
 = 0; j < 2 * 
N
 - 
size
; j++) {

151 
ùx
->
sfmt
[
j
].
s
 = 
¬¿y
[j + 
size
 - 
N
].s;

153 ; 
i
 < 
size
; i++) {

154 
r
 = 
	`vec_»cursiÚ
(
¬¿y
[
i
 - 
N
].
s
,‡¼ay[˜+ 
POS1
 - N].s, 
r1
, 
r2
);

155 
¬¿y
[
i
].
s
 = 
r
;

156 
ùx
->
sfmt
[
j
++].
s
 = 
r
;

157 
r1
 = 
r2
;

158 
r2
 = 
r
;

160 
	}
}

162 #iâdeà
ONLY64


163 #ià
defšed
(
__APPLE__
)

164 
	#ALTI_SWAP
 (
veùÜ
 ) \

165 (4, 5, 6, 7, 0, 1, 2, 3, 12, 13, 14, 15, 8, 9, 10, 11)

	)

167 
	#ALTI_SWAP
 {4, 5, 6, 7, 0, 1, 2, 3, 12, 13, 14, 15, 8, 9, 10, 11}

	)

176 
JEMALLOC_INLINE
 
	$sw­
(
w128_t
 *
¬¿y
, 
size
) {

177 
i
;

178 cÚ¡ 
veùÜ
 
³rm
 = 
ALTI_SWAP
;

180 
i
 = 0; i < 
size
; i++) {

181 
¬¿y
[
i
].
s
 = 
	`vec_³rm
×¼ay[i].s, (
veùÜ
 )
³rm
,…erm);

183 
	}
}

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params.h

36 #iâdeà
SFMT_PARAMS_H


37 
	#SFMT_PARAMS_H


	)

39 #ià!
defšed
(
MEXP
)

40 #ifdeà
__GNUC__


43 
	#MEXP
 19937

	)

53 
	#N
 (
MEXP
 / 128 + 1)

	)

56 
	#N32
 (
N
 * 4)

	)

59 
	#N64
 (
N
 * 2)

	)

102 #ià
MEXP
 == 607

103 
	~"‹¡/SFMT-·¿ms607.h
"

104 #–ià
MEXP
 == 1279

105 
	~"‹¡/SFMT-·¿ms1279.h
"

106 #–ià
MEXP
 == 2281

107 
	~"‹¡/SFMT-·¿ms2281.h
"

108 #–ià
MEXP
 == 4253

109 
	~"‹¡/SFMT-·¿ms4253.h
"

110 #–ià
MEXP
 == 11213

111 
	~"‹¡/SFMT-·¿ms11213.h
"

112 #–ià
MEXP
 == 19937

113 
	~"‹¡/SFMT-·¿ms19937.h
"

114 #–ià
MEXP
 == 44497

115 
	~"‹¡/SFMT-·¿ms44497.h
"

116 #–ià
MEXP
 == 86243

117 
	~"‹¡/SFMT-·¿ms86243.h
"

118 #–ià
MEXP
 == 132049

119 
	~"‹¡/SFMT-·¿ms132049.h
"

120 #–ià
MEXP
 == 216091

121 
	~"‹¡/SFMT-·¿ms216091.h
"

123 #ifdeà
__GNUC__


125 #undeà
MEXP


127 #undeà
MEXP


	@dep/jemalloc-4.2.0/test/include/test/SFMT-params11213.h

36 #iâdeà
SFMT_PARAMS11213_H


37 
	#SFMT_PARAMS11213_H


	)

39 
	#POS1
 68

	)

40 
	#SL1
 14

	)

41 
	#SL2
 3

	)

42 
	#SR1
 7

	)

43 
	#SR2
 3

	)

44 
	#MSK1
 0xeffff7fbU

	)

45 
	#MSK2
 0xfffffãfU

	)

46 
	#MSK3
 0xdfdfbfffU

	)

47 
	#MSK4
 0x7fffdbfdU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0xe8148000U

	)

51 
	#PARITY4
 0xd0c7aç3U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12}

	)

77 
	#ALTI_SR2_PERM64
 {13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12}

	)

79 
	#IDSTR
 "SFMT-11213:68-14-3-7-3:effff7fb-fffffãf-dfdfbfff-7fffdbfd"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params1279.h

36 #iâdeà
SFMT_PARAMS1279_H


37 
	#SFMT_PARAMS1279_H


	)

39 
	#POS1
 7

	)

40 
	#SL1
 14

	)

41 
	#SL2
 3

	)

42 
	#SR1
 5

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xf7ãfffdU

	)

45 
	#MSK2
 0x7ãfcfffU

	)

46 
	#MSK3
 0xaff3ef3fU

	)

47 
	#MSK4
 0xb5ffff7fU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0x20000000U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-1279:7-14-3-5-1:f7ãfffd-7ãfcfff-aff3ef3f-b5ffff7f"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params132049.h

36 #iâdeà
SFMT_PARAMS132049_H


37 
	#SFMT_PARAMS132049_H


	)

39 
	#POS1
 110

	)

40 
	#SL1
 19

	)

41 
	#SL2
 1

	)

42 
	#SR1
 21

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xffffbb5fU

	)

45 
	#MSK2
 0xfb6ebf95U

	)

46 
	#MSK3
 0xffãffçU

	)

47 
	#MSK4
 0xcff77fffU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0xcb520000U

	)

51 
	#PARITY4
 0xc7e91c7dU

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8}

	)

75 
	#ALTI_SL2_PERM64
 {1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-132049:110-19-1-21-1:ffffbb5f-fb6ebf95-ffãffç-cff77fff"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params19937.h

36 #iâdeà
SFMT_PARAMS19937_H


37 
	#SFMT_PARAMS19937_H


	)

39 
	#POS1
 122

	)

40 
	#SL1
 18

	)

41 
	#SL2
 1

	)

42 
	#SR1
 11

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xdffffãfU

	)

45 
	#MSK2
 0xddãcb7fU

	)

46 
	#MSK3
 0xbfçffffU

	)

47 
	#MSK4
 0xbffffff6U

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0x13c9e684U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8}

	)

75 
	#ALTI_SL2_PERM64
 {1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-19937:122-18-1-11-1:dffffãf-ddãcb7f-bfçffff-bffffff6"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params216091.h

36 #iâdeà
SFMT_PARAMS216091_H


37 
	#SFMT_PARAMS216091_H


	)

39 
	#POS1
 627

	)

40 
	#SL1
 11

	)

41 
	#SL2
 3

	)

42 
	#SR1
 10

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xbff7bff7U

	)

45 
	#MSK2
 0xbfffffffU

	)

46 
	#MSK3
 0xbfffç7fU

	)

47 
	#MSK4
 0xffddfbfbU

	)

48 
	#PARITY1
 0xf8000001U

	)

49 
	#PARITY2
 0x89e80709U

	)

50 
	#PARITY3
 0x3bd2b64bU

	)

51 
	#PARITY4
 0x0c64b1e4U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-216091:627-11-3-10-1:bff7bff7-bfffffff-bfffç7f-ffddfbfb"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params2281.h

36 #iâdeà
SFMT_PARAMS2281_H


37 
	#SFMT_PARAMS2281_H


	)

39 
	#POS1
 12

	)

40 
	#SL1
 19

	)

41 
	#SL2
 1

	)

42 
	#SR1
 5

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xbff7ffbfU

	)

45 
	#MSK2
 0xfdffffãU

	)

46 
	#MSK3
 0xf7fãf7fU

	)

47 
	#MSK4
 0xf2f7cbbfU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0x41dç600U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8}

	)

75 
	#ALTI_SL2_PERM64
 {1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-2281:12-19-1-5-1:bff7ffbf-fdffffã-f7fãf7f-f2f7cbbf"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params4253.h

36 #iâdeà
SFMT_PARAMS4253_H


37 
	#SFMT_PARAMS4253_H


	)

39 
	#POS1
 17

	)

40 
	#SL1
 20

	)

41 
	#SL2
 1

	)

42 
	#SR1
 7

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0x9f7bffffU

	)

45 
	#MSK2
 0x9fffff5fU

	)

46 
	#MSK3
 0x3efffffbU

	)

47 
	#MSK4
 0xfffff7bbU

	)

48 
	#PARITY1
 0xa8000001U

	)

49 
	#PARITY2
 0xaf5390a3U

	)

50 
	#PARITY3
 0xb740b3f8U

	)

51 
	#PARITY4
 0x6c11486dU

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8}

	)

75 
	#ALTI_SL2_PERM64
 {1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-4253:17-20-1-7-1:9f7bffff-9fffff5f-3efffffb-fffff7bb"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params44497.h

36 #iâdeà
SFMT_PARAMS44497_H


37 
	#SFMT_PARAMS44497_H


	)

39 
	#POS1
 330

	)

40 
	#SL1
 5

	)

41 
	#SL2
 3

	)

42 
	#SR1
 9

	)

43 
	#SR2
 3

	)

44 
	#MSK1
 0xeffffffbU

	)

45 
	#MSK2
 0xdfbebfffU

	)

46 
	#MSK3
 0xbfbf7befU

	)

47 
	#MSK4
 0x9ffd7bffU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0xa3ac4000U

	)

51 
	#PARITY4
 0xecc1327aU

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12}

	)

77 
	#ALTI_SR2_PERM64
 {13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12}

	)

79 
	#IDSTR
 "SFMT-44497:330-5-3-9-3:effffffb-dfbebfff-bfbf7bef-9ffd7bff"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params607.h

36 #iâdeà
SFMT_PARAMS607_H


37 
	#SFMT_PARAMS607_H


	)

39 
	#POS1
 2

	)

40 
	#SL1
 15

	)

41 
	#SL2
 3

	)

42 
	#SR1
 13

	)

43 
	#SR2
 3

	)

44 
	#MSK1
 0xfdff37ffU

	)

45 
	#MSK2
 0xef7f3f7dU

	)

46 
	#MSK3
 0xff777b7dU

	)

47 
	#MSK4
 0x7ff7fb2fU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0x5986f054U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12}

	)

77 
	#ALTI_SR2_PERM64
 {13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12}

	)

79 
	#IDSTR
 "SFMT-607:2-15-3-13-3:fdff37ff-ef7f3f7d-ff777b7d-7ff7fb2f"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-params86243.h

36 #iâdeà
SFMT_PARAMS86243_H


37 
	#SFMT_PARAMS86243_H


	)

39 
	#POS1
 366

	)

40 
	#SL1
 6

	)

41 
	#SL2
 7

	)

42 
	#SR1
 19

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xfdbffbffU

	)

45 
	#MSK2
 0xbff7ff3fU

	)

46 
	#MSK3
 0xfd77efffU

	)

47 
	#MSK4
 0xbf9ff3ffU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0xe9528d85U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(25,25,25,25,3,25,25,25,7,0,1,2,11,4,5,6)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(7,25,25,25,25,25,25,25,15,0,1,2,3,4,5,6)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {25,25,25,25,3,25,25,25,7,0,1,2,11,4,5,6}

	)

75 
	#ALTI_SL2_PERM64
 {7,25,25,25,25,25,25,25,15,0,1,2,3,4,5,6}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-86243:366-6-7-19-1:fdbffbff-bff7ff3f-fd77efff-bf9ff3ff"

	)

	@dep/jemalloc-4.2.0/test/include/test/SFMT-sse2.h

51 #iâdeà
SFMT_SSE2_H


52 
	#SFMT_SSE2_H


	)

63 
JEMALLOC_ALWAYS_INLINE
 
__m128i
 
	$mm_»cursiÚ
(
__m128i
 *
a
, __m128˜*
b
,

64 
__m128i
 
c
, __m128˜
d
, __m128˜
mask
) {

65 
__m128i
 
v
, 
x
, 
y
, 
z
;

67 
x
 = 
	`_mm_lßd_si128
(
a
);

68 
y
 = 
	`_mm_¤li_•i32
(*
b
, 
SR1
);

69 
z
 = 
	`_mm_¤li_si128
(
c
, 
SR2
);

70 
v
 = 
	`_mm_¦li_•i32
(
d
, 
SL1
);

71 
z
 = 
	`_mm_xÜ_si128
(z, 
x
);

72 
z
 = 
	`_mm_xÜ_si128
(z, 
v
);

73 
x
 = 
	`_mm_¦li_si128
(x, 
SL2
);

74 
y
 = 
	`_mm_ªd_si128
(y, 
mask
);

75 
z
 = 
	`_mm_xÜ_si128
(z, 
x
);

76 
z
 = 
	`_mm_xÜ_si128
(z, 
y
);

77  
z
;

78 
	}
}

84 
JEMALLOC_INLINE
 
	$g’_¿nd_®l
(
sfmt_t
 *
ùx
) {

85 
i
;

86 
__m128i
 
r
, 
r1
, 
r2
, 
mask
;

87 
mask
 = 
	`_mm_£t_•i32
(
MSK4
, 
MSK3
, 
MSK2
, 
MSK1
);

89 
r1
 = 
	`_mm_lßd_si128
(&
ùx
->
sfmt
[
N
 - 2].
si
);

90 
r2
 = 
	`_mm_lßd_si128
(&
ùx
->
sfmt
[
N
 - 1].
si
);

91 
i
 = 0; i < 
N
 - 
POS1
; i++) {

92 
r
 = 
	`mm_»cursiÚ
(&
ùx
->
sfmt
[
i
].
si
, &ùx->sfmt[˜+ 
POS1
].si, 
r1
, 
r2
,

93 
mask
);

94 
	`_mm_¡Üe_si128
(&
ùx
->
sfmt
[
i
].
si
, 
r
);

95 
r1
 = 
r2
;

96 
r2
 = 
r
;

98 ; 
i
 < 
N
; i++) {

99 
r
 = 
	`mm_»cursiÚ
(&
ùx
->
sfmt
[
i
].
si
, &ùx->sfmt[˜+ 
POS1
 - 
N
].si, 
r1
, 
r2
,

100 
mask
);

101 
	`_mm_¡Üe_si128
(&
ùx
->
sfmt
[
i
].
si
, 
r
);

102 
r1
 = 
r2
;

103 
r2
 = 
r
;

105 
	}
}

114 
JEMALLOC_INLINE
 
	$g’_¿nd_¬¿y
(
sfmt_t
 *
ùx
, 
w128_t
 *
¬¿y
, 
size
) {

115 
i
, 
j
;

116 
__m128i
 
r
, 
r1
, 
r2
, 
mask
;

117 
mask
 = 
	`_mm_£t_•i32
(
MSK4
, 
MSK3
, 
MSK2
, 
MSK1
);

119 
r1
 = 
	`_mm_lßd_si128
(&
ùx
->
sfmt
[
N
 - 2].
si
);

120 
r2
 = 
	`_mm_lßd_si128
(&
ùx
->
sfmt
[
N
 - 1].
si
);

121 
i
 = 0; i < 
N
 - 
POS1
; i++) {

122 
r
 = 
	`mm_»cursiÚ
(&
ùx
->
sfmt
[
i
].
si
, &ùx->sfmt[˜+ 
POS1
].si, 
r1
, 
r2
,

123 
mask
);

124 
	`_mm_¡Üe_si128
(&
¬¿y
[
i
].
si
, 
r
);

125 
r1
 = 
r2
;

126 
r2
 = 
r
;

128 ; 
i
 < 
N
; i++) {

129 
r
 = 
	`mm_»cursiÚ
(&
ùx
->
sfmt
[
i
].
si
, &
¬¿y
[˜+ 
POS1
 - 
N
].si, 
r1
, 
r2
,

130 
mask
);

131 
	`_mm_¡Üe_si128
(&
¬¿y
[
i
].
si
, 
r
);

132 
r1
 = 
r2
;

133 
r2
 = 
r
;

136 ; 
i
 < 
size
 - 
N
; i++) {

137 
r
 = 
	`mm_»cursiÚ
(&
¬¿y
[
i
 - 
N
].
si
, &¬¿y[˜+ 
POS1
 - N].si, 
r1
, 
r2
,

138 
mask
);

139 
	`_mm_¡Üe_si128
(&
¬¿y
[
i
].
si
, 
r
);

140 
r1
 = 
r2
;

141 
r2
 = 
r
;

143 
j
 = 0; j < 2 * 
N
 - 
size
; j++) {

144 
r
 = 
	`_mm_lßd_si128
(&
¬¿y
[
j
 + 
size
 - 
N
].
si
);

145 
	`_mm_¡Üe_si128
(&
ùx
->
sfmt
[
j
].
si
, 
r
);

147 ; 
i
 < 
size
; i++) {

148 
r
 = 
	`mm_»cursiÚ
(&
¬¿y
[
i
 - 
N
].
si
, &¬¿y[˜+ 
POS1
 - N].si, 
r1
, 
r2
,

149 
mask
);

150 
	`_mm_¡Üe_si128
(&
¬¿y
[
i
].
si
, 
r
);

151 
	`_mm_¡Üe_si128
(&
ùx
->
sfmt
[
j
++].
si
, 
r
);

152 
r1
 = 
r2
;

153 
r2
 = 
r
;

155 
	}
}

	@dep/jemalloc-4.2.0/test/include/test/SFMT.h

66 #iâdeà
SFMT_H


67 
	#SFMT_H


	)

69 
sfmt_s
 
	tsfmt_t
;

71 
ušt32_t
 
g’_¿nd32
(
sfmt_t
 *
ùx
);

72 
ušt32_t
 
g’_¿nd32_¿nge
(
sfmt_t
 *
ùx
, ušt32_ˆ
lim™
);

73 
ušt64_t
 
g’_¿nd64
(
sfmt_t
 *
ùx
);

74 
ušt64_t
 
g’_¿nd64_¿nge
(
sfmt_t
 *
ùx
, ušt64_ˆ
lim™
);

75 
fl_¬¿y32
(
sfmt_t
 *
ùx
, 
ušt32_t
 *
¬¿y
, 
size
);

76 
fl_¬¿y64
(
sfmt_t
 *
ùx
, 
ušt64_t
 *
¬¿y
, 
size
);

77 
sfmt_t
 *
š™_g’_¿nd
(
ušt32_t
 
£ed
);

78 
sfmt_t
 *
š™_by_¬¿y
(
ušt32_t
 *
š™_key
, 
key_Ëngth
);

79 
fši_g’_¿nd
(
sfmt_t
 *
ùx
);

80 cÚ¡ *
g‘_id¡ršg
();

81 
g‘_mš_¬¿y_size32
();

82 
g‘_mš_¬¿y_size64
();

84 #iâdeà
JEMALLOC_ENABLE_INLINE


85 
to_»®1
(
ušt32_t
 
v
);

86 
g’¿nd_»®1
(
sfmt_t
 *
ùx
);

87 
to_»®2
(
ušt32_t
 
v
);

88 
g’¿nd_»®2
(
sfmt_t
 *
ùx
);

89 
to_»®3
(
ušt32_t
 
v
);

90 
g’¿nd_»®3
(
sfmt_t
 *
ùx
);

91 
to_»s53
(
ušt64_t
 
v
);

92 
to_»s53_mix
(
ušt32_t
 
x
, ušt32_ˆ
y
);

93 
g’¿nd_»s53
(
sfmt_t
 *
ùx
);

94 
g’¿nd_»s53_mix
(
sfmt_t
 *
ùx
);

97 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
SFMT_C_
))

100 
JEMALLOC_INLINE
 
	$to_»®1
(
ušt32_t
 
v
)

102  
v
 * (1.0/4294967295.0);

104 
	}
}

107 
JEMALLOC_INLINE
 
	$g’¿nd_»®1
(
sfmt_t
 *
ùx
)

109  
	`to_»®1
(
	`g’_¿nd32
(
ùx
));

110 
	}
}

113 
JEMALLOC_INLINE
 
	$to_»®2
(
ušt32_t
 
v
)

115  
v
 * (1.0/4294967296.0);

117 
	}
}

120 
JEMALLOC_INLINE
 
	$g’¿nd_»®2
(
sfmt_t
 *
ùx
)

122  
	`to_»®2
(
	`g’_¿nd32
(
ùx
));

123 
	}
}

126 
JEMALLOC_INLINE
 
	$to_»®3
(
ušt32_t
 
v
)

128  ((()
v
) + 0.5)*(1.0/4294967296.0);

130 
	}
}

133 
JEMALLOC_INLINE
 
	$g’¿nd_»®3
(
sfmt_t
 *
ùx
)

135  
	`to_»®3
(
	`g’_¿nd32
(
ùx
));

136 
	}
}

140 
JEMALLOC_INLINE
 
	$to_»s53
(
ušt64_t
 
v
)

142  
v
 * (1.0/18446744073709551616.0L);

143 
	}
}

147 
JEMALLOC_INLINE
 
	$to_»s53_mix
(
ušt32_t
 
x
, ušt32_ˆ
y
)

149  
	`to_»s53
(
x
 | ((
ušt64_t
)
y
 << 32));

150 
	}
}

154 
JEMALLOC_INLINE
 
	$g’¿nd_»s53
(
sfmt_t
 *
ùx
)

156  
	`to_»s53
(
	`g’_¿nd64
(
ùx
));

157 
	}
}

162 
JEMALLOC_INLINE
 
	$g’¿nd_»s53_mix
(
sfmt_t
 *
ùx
)

164 
ušt32_t
 
x
, 
y
;

166 
x
 = 
	`g’_¿nd32
(
ùx
);

167 
y
 = 
	`g’_¿nd32
(
ùx
);

168  
	`to_»s53_mix
(
x
, 
y
);

169 
	}
}

	@dep/jemalloc-4.2.0/test/include/test/btalloc.h

2 *
bÎoc
(
size_t
 
size
, 
b™s
);

4 
	#bÎoc_n_´Ùo
(
n
) \

5 *
bÎoc_
##
	`n
(
size_t
 
size
, 
b™s
);

	)

6 
	$bÎoc_n_´Ùo
(0)

7 
	$bÎoc_n_´Ùo
(1)

9 
	#bÎoc_n_g’
(
n
) \

11 
bÎoc_
##
	`n
(
size_t
 
size
, 
b™s
) \

13 *
p
; \

15 ià(
b™s
 == 0) \

16 
p
 = 
	`m®locx
(
size
, 0); \

18 
b™s
 & 0x1U) { \

20 
p
 = (
	`bÎoc_0
(
size
, 
b™s
 >> 1)); \

23 
p
 = (
	`bÎoc_1
(
size
, 
b™s
 >> 1)); \

25 : 
	`nÙ_»ached
(); \

29 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure"); \

30  (
p
); \

31 
	}

	)
}

	@dep/jemalloc-4.2.0/test/include/test/jemalloc_test.h

1 
	~<lim™s.h
>

2 #iâdeà
SIZE_T_MAX


3 
	#SIZE_T_MAX
 
SIZE_MAX


	)

5 
	~<¡dlib.h
>

6 
	~<¡d¬g.h
>

7 
	~<¡dboŞ.h
>

8 
	~<”ºo.h
>

9 
	~<m©h.h
>

10 
	~<¡ršg.h
>

11 #ifdeà
_WIN32


12 
	~"msvc_com·t/¡ršgs.h
"

15 #ifdeà
_WIN32


16 
	~<wšdows.h
>

17 
	~"msvc_com·t/wšdows_exŒa.h
"

19 
	~<±h»ad.h
>

22 
	~"‹¡/jem®loc_‹¡_defs.h
"

24 #ifdeà
JEMALLOC_OSSPIN


25 
	~<libk”n/OSAtomic.h
>

28 #ià
defšed
(
HAVE_ALTIVEC
è&& !defšed(
__APPLE__
)

29 
	~<®tivec.h
>

31 #ifdeà
HAVE_SSE2


32 
	~<emmšŒš.h
>

39 #ifdeà
JEMALLOC_UNIT_TEST


40 
	#JEMALLOC_JET


	)

41 
	#JEMALLOC_MANGLE


	)

42 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

50 #–ià
defšed
(
JEMALLOC_INTEGRATION_TEST
)

51 
	#JEMALLOC_MANGLE


	)

52 
	~"jem®loc/jem®loc.h
"

53 
	~"jem®loc/š‹º®/jem®loc_š‹º®_defs.h
"

54 
	~"jem®loc/š‹º®/jem®loc_š‹º®_maüos.h
"

56 cÚ¡ 
boŞ
 
	gcÚfig_debug
 =

57 #ifdeà
JEMALLOC_DEBUG


58 
Œue


60 
çl£


64 
	#JEMALLOC_N
(
n
è
je_
##
	)
n

65 
	~"jem®loc/š‹º®/´iv©e_Çme¥aû.h
"

67 
	#JEMALLOC_H_TYPES


	)

68 
	#JEMALLOC_H_STRUCTS


	)

69 
	#JEMALLOC_H_EXTERNS


	)

70 
	#JEMALLOC_H_INLINES


	)

71 
	~"jem®loc/š‹º®/n¡ime.h
"

72 
	~"jem®loc/š‹º®/ut.h
"

73 
	~"jem®loc/š‹º®/qr.h
"

74 
	~"jem®loc/š‹º®/ql.h
"

75 #undeà
JEMALLOC_H_TYPES


76 #undeà
JEMALLOC_H_STRUCTS


77 #undeà
JEMALLOC_H_EXTERNS


78 #undeà
JEMALLOC_H_INLINES


87 #–ià
defšed
(
JEMALLOC_STRESS_TEST
)

88 
	~"jem®loc/jem®loc.h
"

90 
	~"jem®loc/jem®loc_´Ùos_j‘.h
"

92 
	#JEMALLOC_JET


	)

93 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

94 
	~"jem®loc/š‹º®/public_uÂame¥aû.h
"

95 #undeà
JEMALLOC_JET


97 
	~"jem®loc/jem®loc_»Çme.h
"

98 
	#JEMALLOC_MANGLE


	)

99 #ifdeà
JEMALLOC_STRESS_TESTLIB


100 
	~"jem®loc/jem®loc_mªgË_j‘.h
"

102 
	~"jem®loc/jem®loc_mªgË.h
"

118 
	~"‹¡/bÎoc.h
"

119 
	~"‹¡/m©h.h
"

120 
	~"‹¡/mtx.h
"

121 
	~"‹¡/mq.h
"

122 
	~"‹¡/‹¡.h
"

123 
	~"‹¡/tim”.h
"

124 
	~"‹¡/thd.h
"

125 
	#MEXP
 19937

	)

126 
	~"‹¡/SFMT.h
"

133 #undeà
as£¹


134 #undeà
nÙ_»ached


135 #undeà
nÙ_im¶em’‹d


136 #undeà
as£¹_nÙ_im¶em’‹d


138 
	#as£¹
(
e
) do { \

139 ià(!(
e
)) { \

140 
	`m®loc_´štf
( \

142 
__FILE__
, 
__LINE__
, #e); \

143 
	`abÜt
(); \

145 } 0)

	)

147 
	#nÙ_»ached
() do { \

148 
	`m®loc_´štf
( \

150 
__FILE__
, 
__LINE__
); \

151 
	`abÜt
(); \

152 } 0)

	)

154 
	#nÙ_im¶em’‹d
() do { \

155 
	`m®loc_´štf
("<jemalloc>: %s:%d: Not implemented\n", \

156 
__FILE__
, 
__LINE__
); \

157 
	`abÜt
(); \

158 } 0)

	)

160 
	#as£¹_nÙ_im¶em’‹d
(
e
) do { \

161 ià(!(
e
)) \

162 
	`nÙ_im¶em’‹d
(); \

163 } 0)

	)

	@dep/jemalloc-4.2.0/test/include/test/jemalloc_test_defs.h

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®_defs.h
"

3 
	~"jem®loc/š‹º®/jem®loc_š‹º®_deşs.h
"

	@dep/jemalloc-4.2.0/test/include/test/math.h

1 #iâdeà
JEMALLOC_ENABLE_INLINE


2 
Ê_gamma
(
x
);

3 
i_gamma
(
x
, 
p
, 
Ê_gamma_p
);

4 
±_nÜm
(
p
);

5 
±_chi2
(
p
, 
df
, 
Ê_gamma_df_2
);

6 
±_gamma
(
p
, 
sh­e
, 
sÿË
, 
Ê_gamma_sh­e
);

9 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
MATH_C_
))

18 
JEMALLOC_INLINE
 

19 
	$Ê_gamma
(
x
)

21 
f
, 
z
;

23 
	`as£¹
(
x
 > 0.0);

25 ià(
x
 < 7.0) {

26 
f
 = 1.0;

27 
z
 = 
x
;

28 
z
 < 7.0) {

29 
f
 *ğ
z
;

30 
z
 += 1.0;

32 
x
 = 
z
;

33 
f
 = -
	`log
(f);

35 
f
 = 0.0;

37 
z
 = 1.0 / (
x
 * x);

39  (
f
 + (
x
-0.5è* 
	`log
(x) - x + 0.918938533204673 +

40 (((-0.000595238095238 * 
z
 + 0.000793650793651) * z -

41 0.002777777777778è* 
z
 + 0.083333333333333è/ 
x
);

42 
	}
}

53 
JEMALLOC_INLINE
 

54 
	$i_gamma
(
x
, 
p
, 
Ê_gamma_p
)

56 
acu
, 
çùÜ
, 
oæo
, 
gš
, 
‹rm
, 
º
, 
a
, 
b
, 
ª
, 
dif
;

57 
²
[6];

58 
i
;

60 
	`as£¹
(
p
 > 0.0);

61 
	`as£¹
(
x
 >= 0.0);

63 ià(
x
 == 0.0)

66 
acu
 = 1.0e-10;

67 
oæo
 = 1.0e30;

68 
gš
 = 0.0;

69 
çùÜ
 = 
	`exp
(
p
 * 
	`log
(
x
è- x - 
Ê_gamma_p
);

71 ià(
x
 <ğ1.0 || x < 
p
) {

73 
gš
 = 1.0;

74 
‹rm
 = 1.0;

75 
º
 = 
p
;

77 
Œue
) {

78 
º
 += 1.0;

79 
‹rm
 *ğ
x
 / 
º
;

80 
gš
 +ğ
‹rm
;

81 ià(
‹rm
 <ğ
acu
) {

82 
gš
 *ğ
çùÜ
 / 
p
;

83  (
gš
);

88 
a
 = 1.0 - 
p
;

89 
b
 = 
a
 + 
x
 + 1.0;

90 
‹rm
 = 0.0;

91 
²
[0] = 1.0;

92 
²
[1] = 
x
;

93 
²
[2] = 
x
 + 1.0;

94 
²
[3] = 
x
 * 
b
;

95 
gš
 = 
²
[2] /…n[3];

97 
Œue
) {

98 
a
 += 1.0;

99 
b
 += 2.0;

100 
‹rm
 += 1.0;

101 
ª
 = 
a
 * 
‹rm
;

102 
i
 = 0; i < 2; i++)

103 
²
[
i
+4] = 
b
 *…n[i+2] - 
ª
 *…n[i];

104 ià(
²
[5] != 0.0) {

105 
º
 = 
²
[4] /…n[5];

106 
dif
 = 
	`çbs
(
gš
 - 
º
);

107 ià(
dif
 <ğ
acu
 && dià<ğacu * 
º
) {

108 
gš
 = 1.0 - 
çùÜ
 * gin;

109  (
gš
);

111 
gš
 = 
º
;

113 
i
 = 0; i < 4; i++)

114 
²
[
i
] =…n[i+2];

116 ià(
	`çbs
(
²
[4]è>ğ
oæo
) {

117 
i
 = 0; i < 4; i++)

118 
²
[
i
] /ğ
oæo
;

122 
	}
}

134 
JEMALLOC_INLINE
 

135 
	$±_nÜm
(
p
)

137 
q
, 
r
, 
»t
;

139 
	`as£¹
(
p
 > 0.0 &&… < 1.0);

141 
q
 = 
p
 - 0.5;

142 ià(
	`çbs
(
q
) <= 0.425) {

144 
r
 = 0.180625 - 
q
 * q;

145  (
q
 * (((((((2.5090809287301226727e3 * 
r
 +

146 3.3430575583588128105e4è* 
r
 + 6.7265770927008700853e4) *„

147 + 4.5921953931549871457e4è* 
r
 + 1.3731693765509461125e4) *

148 
r
 + 1.9715909503065514427e3) *„ + 1.3314166789178437745e2)

149 * 
r
 + 3.3871328727963666080e0) /

150 (((((((5.2264952788528545610e3 * 
r
 +

151 2.8729085735721942674e4è* 
r
 + 3.9307895800092710610e4) *„

152 + 2.1213794301586595867e4è* 
r
 + 5.3941960214247511077e3) *

153 
r
 + 6.8718700749205790830e2) *„ + 4.2313330701600911252e1)

154 * 
r
 + 1.0));

156 ià(
q
 < 0.0)

157 
r
 = 
p
;

159 
r
 = 1.0 - 
p
;

160 
	`as£¹
(
r
 > 0.0);

162 
r
 = 
	`sq¹
(-
	`log
(r));

163 ià(
r
 <= 5.0) {

165 
r
 -= 1.6;

166 
»t
 = ((((((((7.74545014278341407640e-4 * 
r
 +

167 2.27238449892691845833e-2è* 
r
 +

168 2.41780725177450611770e-1è* 
r
 +

169 1.27045825245236838258e0è* 
r
 +

170 3.64784832476320460504e0è* 
r
 +

171 5.76949722146069140550e0è* 
r
 +

172 4.63033784615654529590e0è* 
r
 +

174 (((((((1.05075007164441684324e-9 * 
r
 +

175 5.47593808499534494600e-4è* 
r
 +

177 * 
r
 + 1.48103976427480074590e-1) *„ +

178 6.89767334985100004550e-1è* 
r
 +

179 1.67638483018380384940e0è* 
r
 +

180 2.05319162663775882187e0è* 
r
 + 1.0));

183 
r
 -= 5.0;

184 
»t
 = ((((((((2.01033439929228813265e-7 * 
r
 +

185 2.71155556874348757815e-5è* 
r
 +

186 1.24266094738807843860e-3è* 
r
 +

187 2.65321895265761230930e-2è* 
r
 +

188 2.96560571828504891230e-1è* 
r
 +

189 1.78482653991729133580e0è* 
r
 +

190 5.46378491116411436990e0è* 
r
 +

192 (((((((2.04426310338993978564e-15 * 
r
 +

193 1.42151175831644588870e-7è* 
r
 +

194 1.84631831751005468180e-5è* 
r
 +

195 7.86869131145613259100e-4è* 
r
 +

196 1.48753612908506148525e-2è* 
r
 +

197 1.36929880922735805310e-1è* 
r
 +

199 * 
r
 + 1.0));

201 ià(
q
 < 0.0)

202 
»t
 = -ret;

203  (
»t
);

205 
	}
}

221 
JEMALLOC_INLINE
 

222 
	$±_chi2
(
p
, 
df
, 
Ê_gamma_df_2
)

224 
e
, 
¯
, 
xx
, 
c
, 
ch
, 
a
, 
q
, 
p1
, 
p2
, 
t
, 
x
, 
b
, 
s1
, 
s2
, 
s3
, 
s4
, 
s5
, 
s6
;

225 
i
;

227 
	`as£¹
(
p
 >= 0.0 &&… < 1.0);

228 
	`as£¹
(
df
 > 0.0);

230 
e
 = 5.0e-7;

231 
¯
 = 0.6931471805;

233 
xx
 = 0.5 * 
df
;

234 
c
 = 
xx
 - 1.0;

236 ià(
df
 < -1.24 * 
	`log
(
p
)) {

238 
ch
 = 
	`pow
(
p
 * 
xx
 * 
	`exp
(
Ê_gamma_df_2
 + xx * 
¯
), 1.0 / xx);

239 ià(
ch
 - 
e
 < 0.0)

240  (
ch
);

242 ià(
df
 > 0.32) {

243 
x
 = 
	`±_nÜm
(
p
);

248 
p1
 = 0.222222 / 
df
;

249 
ch
 = 
df
 * 
	`pow
(
x
 * 
	`sq¹
(
p1
) + 1.0 -…1, 3.0);

251 ià(
ch
 > 2.2 * 
df
 + 6.0) {

252 
ch
 = -2.0 * (
	`log
(1.0 - 
p
è- 
c
 *†og(0.5 * ch) +

253 
Ê_gamma_df_2
);

256 
ch
 = 0.4;

257 
a
 = 
	`log
(1.0 - 
p
);

258 
Œue
) {

259 
q
 = 
ch
;

260 
p1
 = 1.0 + 
ch
 * (4.67 + ch);

261 
p2
 = 
ch
 * (6.73 + ch * (6.66 + ch));

262 
t
 = -0.5 + (4.67 + 2.0 * 
ch
è/ 
p1
 - (6.73 + ch

263 * (13.32 + 3.0 * 
ch
)è/ 
p2
;

264 
ch
 -ğ(1.0 - 
	`exp
(
a
 + 
Ê_gamma_df_2
 + 0.5 * ch +

265 
c
 * 
¯
è* 
p2
 / 
p1
è/ 
t
;

266 ià(
	`çbs
(
q
 / 
ch
 - 1.0) - 0.01 <= 0.0)

272 
i
 = 0; i < 20; i++) {

274 
q
 = 
ch
;

275 
p1
 = 0.5 * 
ch
;

276 ià(
p1
 < 0.0)

278 
p2
 = 
p
 - 
	`i_gamma
(
p1
, 
xx
, 
Ê_gamma_df_2
);

279 
t
 = 
p2
 * 
	`exp
(
xx
 * 
¯
 + 
Ê_gamma_df_2
 + 
p1
 - 
c
 * 
	`log
(
ch
));

280 
b
 = 
t
 / 
ch
;

281 
a
 = 0.5 * 
t
 - 
b
 * 
c
;

282 
s1
 = (210.0 + 
a
 * (140.0 +‡ * (105.0 +‡ * (84.0 +‡ * (70.0 +

283 60.0 * 
a
))))) / 420.0;

284 
s2
 = (420.0 + 
a
 * (735.0 +‡ * (966.0 +‡ * (1141.0 + 1278.0 *

285 
a
)))) / 2520.0;

286 
s3
 = (210.0 + 
a
 * (462.0 +‡ * (707.0 + 932.0 *‡))) / 2520.0;

287 
s4
 = (252.0 + 
a
 * (672.0 + 1182.0 *‡è+ 
c
 * (294.0 +‡ *

288 (889.0 + 1740.0 * 
a
))) / 5040.0;

289 
s5
 = (84.0 + 264.0 * 
a
 + 
c
 * (175.0 + 606.0 *‡)) / 2520.0;

290 
s6
 = (120.0 + 
c
 * (346.0 + 127.0 * c)) / 5040.0;

291 
ch
 +ğ
t
 * (1.0 + 0.5 * * 
s1
 - 
b
 * 
c
 * (s1 - b * (
s2
 - b * (
s3


292 - 
b
 * (
s4
 - b * (
s5
 - b * 
s6
))))));

293 ià(
	`çbs
(
q
 / 
ch
 - 1.0è<ğ
e
)

297  (
ch
);

298 
	}
}

305 
JEMALLOC_INLINE
 

306 
	$±_gamma
(
p
, 
sh­e
, 
sÿË
, 
Ê_gamma_sh­e
)

309  (
	`±_chi2
(
p
, 
sh­e
 * 2.0, 
Ê_gamma_sh­e
è* 0.5 * 
sÿË
);

310 
	}
}

	@dep/jemalloc-4.2.0/test/include/test/mq.h

1 
mq_Çno¦“p
(
ns
);

29 
	#mq_msg
(
a_mq_msg_ty³
è
	`ql_–m
×_mq_msg_ty³)

	)

31 
	#mq_g’
(
a_©Œ
, 
a_´efix
, 
a_mq_ty³
, 
a_mq_msg_ty³
, 
a_f›ld
) \

33 
mtx_t
 
lock
; \

34 
	`ql_h—d
(
a_mq_msg_ty³
è
msgs
; \

35 
couÁ
; \

36 } 
	ta_mq_ty³
; \

37 
a_©Œ
 
boŞ
 \

38 
a_´efix
##
	`š™
(
a_mq_ty³
 *
mq
) { \

40 ià(
	`mtx_š™
(&
mq
->
lock
)) \

41  (
Œue
); \

42 
	`ql_Ãw
(&
mq
->
msgs
); \

43 
mq
->
couÁ
 = 0; \

44  (
çl£
); \

46 
a_©Œ
 \

47 
a_´efix
##
	`fši
(
a_mq_ty³
 *
mq
) \

50 
	`mtx_fši
(&
mq
->
lock
); \

52 
a_©Œ
 \

53 
a_´efix
##
	`couÁ
(
a_mq_ty³
 *
mq
) \

55 
couÁ
; \

57 
	`mtx_lock
(&
mq
->
lock
); \

58 
couÁ
 = 
mq
->count; \

59 
	`mtx_uÆock
(&
mq
->
lock
); \

60  (
couÁ
); \

62 
a_©Œ
 
a_mq_msg_ty³
 * \

63 
a_´efix
##
	`Œyg‘
(
a_mq_ty³
 *
mq
) \

65 
a_mq_msg_ty³
 *
msg
; \

67 
	`mtx_lock
(&
mq
->
lock
); \

68 
msg
 = 
	`ql_fœ¡
(&
mq
->
msgs
); \

69 ià(
msg
 !ğ
NULL
) { \

70 
	`ql_h—d_»move
(&
mq
->
msgs
, 
a_mq_msg_ty³
, 
a_f›ld
); \

71 
mq
->
couÁ
--; \

73 
	`mtx_uÆock
(&
mq
->
lock
); \

74  (
msg
); \

76 
a_©Œ
 
a_mq_msg_ty³
 * \

77 
a_´efix
##
	`g‘
(
a_mq_ty³
 *
mq
) \

79 
a_mq_msg_ty³
 *
msg
; \

80 
ns
; \

82 
msg
 = 
a_´efix
##
	`Œyg‘
(
mq
); \

83 ià(
msg
 !ğ
NULL
) \

84  (
msg
); \

86 
ns
 = 1; \

87 
Œue
) { \

88 
	`mq_Çno¦“p
(
ns
); \

89 
msg
 = 
a_´efix
##
	`Œyg‘
(
mq
); \

90 ià(
msg
 !ğ
NULL
) \

91  (
msg
); \

92 ià(
ns
 < 1000*1000*1000) { \

94 
ns
 <<= 1; \

95 ià(
ns
 > 1000*1000*1000) \

96 
ns
 = 1000*1000*1000; \

100 
a_©Œ
 \

101 
a_´efix
##
	`put
(
a_mq_ty³
 *
mq
, 
a_mq_msg_ty³
 *
msg
) \

104 
	`mtx_lock
(&
mq
->
lock
); \

105 
	`ql_–m_Ãw
(
msg
, 
a_f›ld
); \

106 
	`ql__š£¹
(&
mq
->
msgs
, 
msg
, 
a_f›ld
); \

107 
mq
->
couÁ
++; \

108 
	`mtx_uÆock
(&
mq
->
lock
); \

109 }

	)

	@dep/jemalloc-4.2.0/test/include/test/mtx.h

9 #ifdeà
_WIN32


10 
CRITICAL_SECTION
 
	mlock
;

11 #–ià(
defšed
(
JEMALLOC_OSSPIN
))

12 
OSSpšLock
 
	mlock
;

14 
±h»ad_mu‹x_t
 
	mlock
;

16 } 
	tmtx_t
;

18 
boŞ
 
mtx_š™
(
mtx_t
 *
mtx
);

19 
mtx_fši
(
mtx_t
 *
mtx
);

20 
mtx_lock
(
mtx_t
 *
mtx
);

21 
mtx_uÆock
(
mtx_t
 *
mtx
);

	@dep/jemalloc-4.2.0/test/include/test/test.h

1 
	#ASSERT_BUFSIZE
 256

	)

3 
	#as£¹_cmp
(
t
, 
a
, 
b
, 
cmp
, 
Ãg_cmp
, 
´i
, ...) do { \

4 
t
 
a_
 = (
a
); \

5 
t
 
b_
 = (
b
); \

6 ià(!(
a_
 
cmp
 
b_
)) { \

7 
´efix
[
ASSERT_BUFSIZE
]; \

8 
mes§ge
[
ASSERT_BUFSIZE
]; \

9 
	`m®loc_¢´štf
(
´efix
, (prefix), \

12 "%"
´i
" "#neg_cmp" %"pri": ", \

13 
__func__
, 
__FILE__
, 
__LINE__
, \

14 #a, #b, 
a_
, 
b_
); \

15 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

16 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

18 } 0)

	)

20 
	#as£¹_±r_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(*,‡, b, ==, \

21 !=, "p", 
__VA_ARGS__
)

	)

22 
	#as£¹_±r_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(*,‡, b, !=, \

23 ==, "p", 
__VA_ARGS__
)

	)

24 
	#as£¹_±r_nuÎ
(
a
, ...è
	`as£¹_cmp
(*,‡, 
NULL
, ==, \

25 !=, "p", 
__VA_ARGS__
)

	)

26 
	#as£¹_±r_nÙ_nuÎ
(
a
, ...è
	`as£¹_cmp
(*,‡, 
NULL
, !=, \

27 ==, "p", 
__VA_ARGS__
)

	)

29 
	#as£¹_c_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, !=, "c", 
__VA_ARGS__
)

	)

30 
	#as£¹_c_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, ==, "c", 
__VA_ARGS__
)

	)

31 
	#as£¹_c_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, >=, "c", 
__VA_ARGS__
)

	)

32 
	#as£¹_c_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, >, "c", 
__VA_ARGS__
)

	)

33 
	#as£¹_c_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, <, "c", 
__VA_ARGS__
)

	)

34 
	#as£¹_c_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, <=, "c", 
__VA_ARGS__
)

	)

36 
	#as£¹_x_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, !=, "#x", 
__VA_ARGS__
)

	)

37 
	#as£¹_x_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, ==, "#x", 
__VA_ARGS__
)

	)

38 
	#as£¹_x_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, >=, "#x", 
__VA_ARGS__
)

	)

39 
	#as£¹_x_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, >, "#x", 
__VA_ARGS__
)

	)

40 
	#as£¹_x_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, <, "#x", 
__VA_ARGS__
)

	)

41 
	#as£¹_x_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, <=, "#x", 
__VA_ARGS__
)

	)

43 
	#as£¹_d_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, !=, "d", 
__VA_ARGS__
)

	)

44 
	#as£¹_d_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, ==, "d", 
__VA_ARGS__
)

	)

45 
	#as£¹_d_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, >=, "d", 
__VA_ARGS__
)

	)

46 
	#as£¹_d_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, >, "d", 
__VA_ARGS__
)

	)

47 
	#as£¹_d_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, <, "d", 
__VA_ARGS__
)

	)

48 
	#as£¹_d_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, <=, "d", 
__VA_ARGS__
)

	)

50 
	#as£¹_u_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, !=, "u", 
__VA_ARGS__
)

	)

51 
	#as£¹_u_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, ==, "u", 
__VA_ARGS__
)

	)

52 
	#as£¹_u_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, >=, "u", 
__VA_ARGS__
)

	)

53 
	#as£¹_u_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, >, "u", 
__VA_ARGS__
)

	)

54 
	#as£¹_u_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, <, "u", 
__VA_ARGS__
)

	)

55 
	#as£¹_u_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, <=, "u", 
__VA_ARGS__
)

	)

57 
	#as£¹_ld_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, \

58 !=, "ld", 
__VA_ARGS__
)

	)

59 
	#as£¹_ld_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, \

60 ==, "ld", 
__VA_ARGS__
)

	)

61 
	#as£¹_ld_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, \

62 >=, "ld", 
__VA_ARGS__
)

	)

63 
	#as£¹_ld_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, \

64 >, "ld", 
__VA_ARGS__
)

	)

65 
	#as£¹_ld_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, \

66 <, "ld", 
__VA_ARGS__
)

	)

67 
	#as£¹_ld_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, \

68 <=, "ld", 
__VA_ARGS__
)

	)

70 
	#as£¹_lu_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

71 
a
, 
b
, ==, !=, "lu", 
__VA_ARGS__
)

	)

72 
	#as£¹_lu_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

73 
a
, 
b
, !=, ==, "lu", 
__VA_ARGS__
)

	)

74 
	#as£¹_lu_É
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

75 
a
, 
b
, <, >=, "lu", 
__VA_ARGS__
)

	)

76 
	#as£¹_lu_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

77 
a
, 
b
, <=, >, "lu", 
__VA_ARGS__
)

	)

78 
	#as£¹_lu_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

79 
a
, 
b
, >=, <, "lu", 
__VA_ARGS__
)

	)

80 
	#as£¹_lu_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

81 
a
, 
b
, >, <=, "lu", 
__VA_ARGS__
)

	)

83 
	#as£¹_qd_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, \

84 !=, "qd", 
__VA_ARGS__
)

	)

85 
	#as£¹_qd_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, \

86 ==, "qd", 
__VA_ARGS__
)

	)

87 
	#as£¹_qd_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, \

88 >=, "qd", 
__VA_ARGS__
)

	)

89 
	#as£¹_qd_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, \

90 >, "qd", 
__VA_ARGS__
)

	)

91 
	#as£¹_qd_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, \

92 <, "qd", 
__VA_ARGS__
)

	)

93 
	#as£¹_qd_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, \

94 <=, "qd", 
__VA_ARGS__
)

	)

96 
	#as£¹_qu_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

97 
a
, 
b
, ==, !=, "qu", 
__VA_ARGS__
)

	)

98 
	#as£¹_qu_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

99 
a
, 
b
, !=, ==, "qu", 
__VA_ARGS__
)

	)

100 
	#as£¹_qu_É
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

101 
a
, 
b
, <, >=, "qu", 
__VA_ARGS__
)

	)

102 
	#as£¹_qu_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

103 
a
, 
b
, <=, >, "qu", 
__VA_ARGS__
)

	)

104 
	#as£¹_qu_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

105 
a
, 
b
, >=, <, "qu", 
__VA_ARGS__
)

	)

106 
	#as£¹_qu_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

107 
a
, 
b
, >, <=, "qu", 
__VA_ARGS__
)

	)

109 
	#as£¹_jd_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, ==, \

110 !=, "jd", 
__VA_ARGS__
)

	)

111 
	#as£¹_jd_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, !=, \

112 ==, "jd", 
__VA_ARGS__
)

	)

113 
	#as£¹_jd_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, <, \

114 >=, "jd", 
__VA_ARGS__
)

	)

115 
	#as£¹_jd_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, <=, \

116 >, "jd", 
__VA_ARGS__
)

	)

117 
	#as£¹_jd_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, >=, \

118 <, "jd", 
__VA_ARGS__
)

	)

119 
	#as£¹_jd_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, >, \

120 <=, "jd", 
__VA_ARGS__
)

	)

122 
	#as£¹_ju_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, ==, \

123 !=, "ju", 
__VA_ARGS__
)

	)

124 
	#as£¹_ju_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, !=, \

125 ==, "ju", 
__VA_ARGS__
)

	)

126 
	#as£¹_ju_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, <, \

127 >=, "ju", 
__VA_ARGS__
)

	)

128 
	#as£¹_ju_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, <=, \

129 >, "ju", 
__VA_ARGS__
)

	)

130 
	#as£¹_ju_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, >=, \

131 <, "ju", 
__VA_ARGS__
)

	)

132 
	#as£¹_ju_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, >, \

133 <=, "ju", 
__VA_ARGS__
)

	)

135 
	#as£¹_zd_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, ==, \

136 !=, "zd", 
__VA_ARGS__
)

	)

137 
	#as£¹_zd_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, !=, \

138 ==, "zd", 
__VA_ARGS__
)

	)

139 
	#as£¹_zd_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, <, \

140 >=, "zd", 
__VA_ARGS__
)

	)

141 
	#as£¹_zd_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, <=, \

142 >, "zd", 
__VA_ARGS__
)

	)

143 
	#as£¹_zd_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, >=, \

144 <, "zd", 
__VA_ARGS__
)

	)

145 
	#as£¹_zd_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, >, \

146 <=, "zd", 
__VA_ARGS__
)

	)

148 
	#as£¹_zu_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, ==, \

149 !=, "zu", 
__VA_ARGS__
)

	)

150 
	#as£¹_zu_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, !=, \

151 ==, "zu", 
__VA_ARGS__
)

	)

152 
	#as£¹_zu_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, <, \

153 >=, "zu", 
__VA_ARGS__
)

	)

154 
	#as£¹_zu_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, <=, \

155 >, "zu", 
__VA_ARGS__
)

	)

156 
	#as£¹_zu_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, >=, \

157 <, "zu", 
__VA_ARGS__
)

	)

158 
	#as£¹_zu_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, >, \

159 <=, "zu", 
__VA_ARGS__
)

	)

161 
	#as£¹_d32_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, ==, \

162 !=, 
FMTd32
, 
__VA_ARGS__
)

	)

163 
	#as£¹_d32_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, !=, \

164 ==, 
FMTd32
, 
__VA_ARGS__
)

	)

165 
	#as£¹_d32_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, <, \

166 >=, 
FMTd32
, 
__VA_ARGS__
)

	)

167 
	#as£¹_d32_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, <=, \

168 >, 
FMTd32
, 
__VA_ARGS__
)

	)

169 
	#as£¹_d32_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, >=, \

170 <, 
FMTd32
, 
__VA_ARGS__
)

	)

171 
	#as£¹_d32_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, >, \

172 <=, 
FMTd32
, 
__VA_ARGS__
)

	)

174 
	#as£¹_u32_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, ==, \

175 !=, 
FMTu32
, 
__VA_ARGS__
)

	)

176 
	#as£¹_u32_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, !=, \

177 ==, 
FMTu32
, 
__VA_ARGS__
)

	)

178 
	#as£¹_u32_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, <, \

179 >=, 
FMTu32
, 
__VA_ARGS__
)

	)

180 
	#as£¹_u32_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, <=, \

181 >, 
FMTu32
, 
__VA_ARGS__
)

	)

182 
	#as£¹_u32_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, >=, \

183 <, 
FMTu32
, 
__VA_ARGS__
)

	)

184 
	#as£¹_u32_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, >, \

185 <=, 
FMTu32
, 
__VA_ARGS__
)

	)

187 
	#as£¹_d64_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, ==, \

188 !=, 
FMTd64
, 
__VA_ARGS__
)

	)

189 
	#as£¹_d64_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, !=, \

190 ==, 
FMTd64
, 
__VA_ARGS__
)

	)

191 
	#as£¹_d64_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, <, \

192 >=, 
FMTd64
, 
__VA_ARGS__
)

	)

193 
	#as£¹_d64_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, <=, \

194 >, 
FMTd64
, 
__VA_ARGS__
)

	)

195 
	#as£¹_d64_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, >=, \

196 <, 
FMTd64
, 
__VA_ARGS__
)

	)

197 
	#as£¹_d64_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, >, \

198 <=, 
FMTd64
, 
__VA_ARGS__
)

	)

200 
	#as£¹_u64_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, ==, \

201 !=, 
FMTu64
, 
__VA_ARGS__
)

	)

202 
	#as£¹_u64_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, !=, \

203 ==, 
FMTu64
, 
__VA_ARGS__
)

	)

204 
	#as£¹_u64_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, <, \

205 >=, 
FMTu64
, 
__VA_ARGS__
)

	)

206 
	#as£¹_u64_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, <=, \

207 >, 
FMTu64
, 
__VA_ARGS__
)

	)

208 
	#as£¹_u64_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, >=, \

209 <, 
FMTu64
, 
__VA_ARGS__
)

	)

210 
	#as£¹_u64_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, >, \

211 <=, 
FMTu64
, 
__VA_ARGS__
)

	)

213 
	#as£¹_b_eq
(
a
, 
b
, ...) do { \

214 
boŞ
 
a_
 = (
a
); \

215 
boŞ
 
b_
 = (
b
); \

216 ià(!(
a_
 =ğ
b_
)) { \

217 
´efix
[
ASSERT_BUFSIZE
]; \

218 
mes§ge
[
ASSERT_BUFSIZE
]; \

219 
	`m®loc_¢´štf
(
´efix
, (prefix), \

222 
__func__
, 
__FILE__
, 
__LINE__
, \

223 #a, #b, 
a_
 ? "true" : "false", \

224 
b_
 ? "true" : "false"); \

225 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

226 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

228 } 0)

	)

229 
	#as£¹_b_Ã
(
a
, 
b
, ...) do { \

230 
boŞ
 
a_
 = (
a
); \

231 
boŞ
 
b_
 = (
b
); \

232 ià(!(
a_
 !ğ
b_
)) { \

233 
´efix
[
ASSERT_BUFSIZE
]; \

234 
mes§ge
[
ASSERT_BUFSIZE
]; \

235 
	`m®loc_¢´štf
(
´efix
, (prefix), \

238 
__func__
, 
__FILE__
, 
__LINE__
, \

239 #a, #b, 
a_
 ? "true" : "false", \

240 
b_
 ? "true" : "false"); \

241 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

242 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

244 } 0)

	)

245 
	#as£¹_Œue
(
a
, ...è
	`as£¹_b_eq
×, 
Œue
, 
__VA_ARGS__
)

	)

246 
	#as£¹_çl£
(
a
, ...è
	`as£¹_b_eq
×, 
çl£
, 
__VA_ARGS__
)

	)

248 
	#as£¹_¡r_eq
(
a
, 
b
, ...) do { \

249 ià(
	`¡rcmp
((
a
), (
b
))) { \

250 
´efix
[
ASSERT_BUFSIZE
]; \

251 
mes§ge
[
ASSERT_BUFSIZE
]; \

252 
	`m®loc_¢´štf
(
´efix
, (prefix), \

256 
__func__
, 
__FILE__
, 
__LINE__
, #a, #b, 
a
, 
b
); \

257 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

258 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

260 } 0)

	)

261 
	#as£¹_¡r_Ã
(
a
, 
b
, ...) do { \

262 ià(!
	`¡rcmp
((
a
), (
b
))) { \

263 
´efix
[
ASSERT_BUFSIZE
]; \

264 
mes§ge
[
ASSERT_BUFSIZE
]; \

265 
	`m®loc_¢´štf
(
´efix
, (prefix), \

269 
__func__
, 
__FILE__
, 
__LINE__
, #a, #b, 
a
, 
b
); \

270 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

271 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

273 } 0)

	)

275 
	#as£¹_nÙ_»ached
(...) do { \

276 
´efix
[
ASSERT_BUFSIZE
]; \

277 
mes§ge
[
ASSERT_BUFSIZE
]; \

278 
	`m®loc_¢´štf
(
´efix
, (prefix), \

280 
__func__
, 
__FILE__
, 
__LINE__
); \

281 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

282 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

283 } 0)

	)

290 
	m‹¡_¡©us_·ss
 = 0,

291 
	m‹¡_¡©us_sk
 = 1,

292 
	m‹¡_¡©us_ç
 = 2,

294 
	m‹¡_¡©us_couÁ
 = 3

295 } 
	t‹¡_¡©us_t
;

297 (
	t‹¡_t
)();

299 
	#TEST_BEGIN
(
f
) \

301 
	`f
() \

303 
	`p_‹¡_š™
(#f);

	)

305 
	#TEST_END
 \

306 
Ïb–_‹¡_’d
; \

307 
Ïb–_‹¡_’d
: \

308 
	`p_‹¡_fši
(); \

309 
	}

	)
}

311 
	#‹¡
(...) \

312 
	`p_‹¡
(
__VA_ARGS__
, 
NULL
)

	)

314 
	#‹¡_no_m®loc_š™
(...) \

315 
	`p_‹¡_no_m®loc_š™
(
__VA_ARGS__
, 
NULL
)

	)

317 
	#‹¡_sk_if
(
e
) do { \

318 ià(
e
) { \

319 
	`‹¡_sk
("%s:%s:%d: Test skipped: (%s)", \

320 
__func__
, 
__FILE__
, 
__LINE__
, #e); \

321 
Ïb–_‹¡_’d
; \

323 } 0)

	)

325 
	$‹¡_sk
(cÚ¡ *
fÜm©
, ...è
	`JEMALLOC_FORMAT_PRINTF
(1, 2);

326 
	$‹¡_ç
(cÚ¡ *
fÜm©
, ...è
	`JEMALLOC_FORMAT_PRINTF
(1, 2);

329 
‹¡_¡©us_t
 
	`p_‹¡
(
‹¡_t
 *
t
, ...);

330 
‹¡_¡©us_t
 
	`p_‹¡_no_m®loc_š™
(
‹¡_t
 *
t
, ...);

331 
	`p_‹¡_š™
(cÚ¡ *
Çme
);

332 
	`p_‹¡_fši
();

333 
	`p_‹¡_ç
(cÚ¡ *
´efix
, cÚ¡ *
mes§ge
);

	@dep/jemalloc-4.2.0/test/include/test/thd.h

2 #ifdeà
_WIN32


3 
HANDLE
 
	tthd_t
;

5 
±h»ad_t
 
	tthd_t
;

8 
thd_ü—‹
(
thd_t
 *
thd
, *(*
´oc
)(*), *
¬g
);

9 
thd_još
(
thd_t
 
thd
, **
»t
);

	@dep/jemalloc-4.2.0/test/include/test/timer.h

4 
n¡ime_t
 
	mt0
;

5 
n¡ime_t
 
	mt1
;

6 } 
	ttimed–_t
;

8 
tim”_¡¬t
(
timed–_t
 *
tim”
);

9 
tim”_¡İ
(
timed–_t
 *
tim”
);

10 
ušt64_t
 
tim”_u£c
(cÚ¡ 
timed–_t
 *
tim”
);

11 
tim”_¿tio
(
timed–_t
 *
a
,imed–_ˆ*
b
, *
buf
, 
size_t
 
buæ’
);

	@dep/jemalloc-4.2.0/test/integration/MALLOCX_ARENA.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NTHREADS
 10

	)

5 
boŞ
 
	ghave_dss
 =

6 #ifdeà
JEMALLOC_DSS


7 
Œue


9 
çl£


14 
	$thd_¡¬t
(*
¬g
)

16 
th»ad_šd
 = ()(
ušŒ_t
)
¬g
;

17 
¬’a_šd
;

18 *
p
;

19 
size_t
 
sz
;

21 
sz
 = (
¬’a_šd
);

22 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.ex‹nd", &
¬’a_šd
, &
sz
, 
NULL
, 0), 0,

25 ià(
th»ad_šd
 % 4 != 3) {

26 
size_t
 
mib
[3];

27 
size_t
 
mibËn
 = (
mib
) / (size_t);

28 cÚ¡ *
dss_´ecs
[] = {"disabled", "primary", "secondary"};

29 
´ec_šd
 = 
th»ad_šd
 %

30 ((
dss_´ecs
)/(*));

31 cÚ¡ *
dss
 = 
dss_´ecs
[
´ec_šd
];

32 
ex³ùed_”r
 = (
have_dss
 || 
´ec_šd
 =ğ0è? 0 : 
EFAULT
;

33 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.dss", 
mib
, &
mibËn
), 0,

35 
mib
[1] = 
¬’a_šd
;

36 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, (*)&
dss
,

37 (cÚ¡ *)), 
ex³ùed_”r
,

41 
p
 = 
	`m®locx
(1, 
	`MALLOCX_ARENA
(
¬’a_šd
));

42 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

43 
	`d®locx
(
p
, 0);

45  (
NULL
);

46 
	}
}

48 
	$TEST_BEGIN
(
‹¡_MALLOCX_ARENA
)

50 
thd_t
 
thds
[
NTHREADS
];

51 
i
;

53 
i
 = 0; i < 
NTHREADS
; i++) {

54 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
,

55 (*)(
ušŒ_t
)
i
);

58 
i
 = 0; i < 
NTHREADS
; i++)

59 
	`thd_još
(
thds
[
i
], 
NULL
);

60 
	}
}

61 
TEST_END


64 
	$maš
()

67  (
	`‹¡
(

68 
‹¡_MALLOCX_ARENA
));

69 
	}
}

	@dep/jemalloc-4.2.0/test/integration/aligned_alloc.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#CHUNK
 0x400000

	)

5 
	#MAXALIGN
 ((
size_t
)0x2000000LU)

	)

6 
	#NITER
 4

	)

8 
	$TEST_BEGIN
(
‹¡_®ignm’t_”rÜs
)

10 
size_t
 
®ignm’t
;

11 *
p
;

13 
®ignm’t
 = 0;

14 
	`£t_”ºo
(0);

15 
p
 = 
	`®igÃd_®loc
(
®ignm’t
, 1);

16 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
EINVAL
,

17 "Ex³ùedƒ¼Ü fÜ inv®id‡lignm’ˆ%zu", 
®ignm’t
);

19 
®ignm’t
 = (
size_t
);‡lignm’ˆ< 
MAXALIGN
;

20 
®ignm’t
 <<= 1) {

21 
	`£t_”ºo
(0);

22 
p
 = 
	`®igÃd_®loc
(
®ignm’t
 + 1, 1);

23 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
EINVAL
,

25 
®ignm’t
 + 1);

27 
	}
}

28 
TEST_END


30 
	$TEST_BEGIN
(
‹¡_oom_”rÜs
)

32 
size_t
 
®ignm’t
, 
size
;

33 *
p
;

35 #ià
LG_SIZEOF_PTR
 == 3

36 
®ignm’t
 = 
	`UINT64_C
(0x8000000000000000);

37 
size
 = 
	`UINT64_C
(0x8000000000000000);

39 
®ignm’t
 = 0x80000000LU;

40 
size
 = 0x80000000LU;

42 
	`£t_”ºo
(0);

43 
p
 = 
	`®igÃd_®loc
(
®ignm’t
, 
size
);

44 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
ENOMEM
,

46 
®ignm’t
, 
size
);

48 #ià
LG_SIZEOF_PTR
 == 3

49 
®ignm’t
 = 
	`UINT64_C
(0x4000000000000000);

50 
size
 = 
	`UINT64_C
(0xc000000000000001);

52 
®ignm’t
 = 0x40000000LU;

53 
size
 = 0xc0000001LU;

55 
	`£t_”ºo
(0);

56 
p
 = 
	`®igÃd_®loc
(
®ignm’t
, 
size
);

57 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
ENOMEM
,

59 
®ignm’t
, 
size
);

61 
®ignm’t
 = 0x10LU;

62 #ià
LG_SIZEOF_PTR
 == 3

63 
size
 = 
	`UINT64_C
(0xfffffffffffffff0);

65 
size
 = 0xfffffff0LU;

67 
	`£t_”ºo
(0);

68 
p
 = 
	`®igÃd_®loc
(
®ignm’t
, 
size
);

69 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
ENOMEM
,

71 
®ignm’t
, 
size
);

72 
	}
}

73 
TEST_END


75 
	$TEST_BEGIN
(
‹¡_®ignm’t_ªd_size
)

77 
size_t
 
®ignm’t
, 
size
, 
tÙ®
;

78 
i
;

79 *
ps
[
NITER
];

81 
i
 = 0; i < 
NITER
; i++)

82 
ps
[
i
] = 
NULL
;

84 
®ignm’t
 = 8;

85 
®ignm’t
 <ğ
MAXALIGN
;

86 
®ignm’t
 <<= 1) {

87 
tÙ®
 = 0;

88 
size
 = 1;

89 
size
 < 3 * 
®ignm’t
 && size < (1U << 31);

90 
size
 +ğ(
®ignm’t
 >> (
LG_SIZEOF_PTR
-1)) - 1) {

91 
i
 = 0; i < 
NITER
; i++) {

92 
ps
[
i
] = 
	`®igÃd_®loc
(
®ignm’t
, 
size
);

93 ià(
ps
[
i
] =ğ
NULL
) {

94 
buf
[
BUFERROR_BUF
];

96 
	`buã¼Ü
(
	`g‘_”ºo
(), 
buf
, (buf));

97 
	`‹¡_ç
(

100 
®ignm’t
, 
size
, size, 
buf
);

102 
tÙ®
 +ğ
	`m®loc_u§bË_size
(
ps
[
i
]);

103 ià(
tÙ®
 >ğ(
MAXALIGN
 << 1))

106 
i
 = 0; i < 
NITER
; i++) {

107 ià(
ps
[
i
] !ğ
NULL
) {

108 
	`ä“
(
ps
[
i
]);

109 
ps
[
i
] = 
NULL
;

114 
	}
}

115 
TEST_END


118 
	$maš
()

121  (
	`‹¡
(

122 
‹¡_®ignm’t_”rÜs
,

123 
‹¡_oom_”rÜs
,

124 
‹¡_®ignm’t_ªd_size
));

125 
	}
}

	@dep/jemalloc-4.2.0/test/integration/allocated.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 cÚ¡ 
boŞ
 
	gcÚfig_¡©s
 =

4 #ifdeà
JEMALLOC_STATS


5 
Œue


7 
çl£


12 
	$thd_¡¬t
(*
¬g
)

14 
”r
;

15 *
p
;

16 
ušt64_t
 
a0
, 
a1
, 
d0
, 
d1
;

17 
ušt64_t
 *
­0
, *
­1
, *
dp0
, *
dp1
;

18 
size_t
 
sz
, 
usize
;

20 
sz
 = (
a0
);

21 ià((
”r
 = 
	`m®lùl
("th»ad.®loÿ‹d", &
a0
, &
sz
, 
NULL
, 0))) {

22 ià(
”r
 =ğ
ENOENT
)

23 
Ïb–_ENOENT
;

24 
	`‹¡_ç
("%s(): E¼Ü iÀm®lùl(): %s", 
__func__
,

25 
	`¡»¼Ü
(
”r
));

27 
sz
 = (
­0
);

28 ià((
”r
 = 
	`m®lùl
("th»ad.®loÿ‹dp", &
­0
, &
sz
, 
NULL
, 0))) {

29 ià(
”r
 =ğ
ENOENT
)

30 
Ïb–_ENOENT
;

31 
	`‹¡_ç
("%s(): E¼Ü iÀm®lùl(): %s", 
__func__
,

32 
	`¡»¼Ü
(
”r
));

34 
	`as£¹_u64_eq
(*
­0
, 
a0
,

38 
sz
 = (
d0
);

39 ià((
”r
 = 
	`m®lùl
("th»ad.d—Îoÿ‹d", &
d0
, &
sz
, 
NULL
, 0))) {

40 ià(
”r
 =ğ
ENOENT
)

41 
Ïb–_ENOENT
;

42 
	`‹¡_ç
("%s(): E¼Ü iÀm®lùl(): %s", 
__func__
,

43 
	`¡»¼Ü
(
”r
));

45 
sz
 = (
dp0
);

46 ià((
”r
 = 
	`m®lùl
("th»ad.d—Îoÿ‹dp", &
dp0
, &
sz
, 
NULL
, 0))) {

47 ià(
”r
 =ğ
ENOENT
)

48 
Ïb–_ENOENT
;

49 
	`‹¡_ç
("%s(): E¼Ü iÀm®lùl(): %s", 
__func__
,

50 
	`¡»¼Ü
(
”r
));

52 
	`as£¹_u64_eq
(*
dp0
, 
d0
,

56 
p
 = 
	`m®loc
(1);

57 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected malloc()ƒrror");

59 
sz
 = (
a1
);

60 
	`m®lùl
("th»ad.®loÿ‹d", &
a1
, &
sz
, 
NULL
, 0);

61 
sz
 = (
­1
);

62 
	`m®lùl
("th»ad.®loÿ‹dp", &
­1
, &
sz
, 
NULL
, 0);

63 
	`as£¹_u64_eq
(*
­1
, 
a1
,

66 
	`as£¹_±r_eq
(
­0
, 
­1
,

69 
usize
 = 
	`m®loc_u§bË_size
(
p
);

70 
	`as£¹_u64_Ë
(
a0
 + 
usize
, 
a1
,

74 
	`ä“
(
p
);

76 
sz
 = (
d1
);

77 
	`m®lùl
("th»ad.d—Îoÿ‹d", &
d1
, &
sz
, 
NULL
, 0);

78 
sz
 = (
dp1
);

79 
	`m®lùl
("th»ad.d—Îoÿ‹dp", &
dp1
, &
sz
, 
NULL
, 0);

80 
	`as£¹_u64_eq
(*
dp1
, 
d1
,

83 
	`as£¹_±r_eq
(
dp0
, 
dp1
,

86 
	`as£¹_u64_Ë
(
d0
 + 
usize
, 
d1
,

90  (
NULL
);

91 
Ïb–_ENOENT
:

92 
	`as£¹_çl£
(
cÚfig_¡©s
,

94 
	`‹¡_sk
("\"thread.allocated\" mallctl‚ot‡vailable");

95  (
NULL
);

96 
	}
}

98 
	$TEST_BEGIN
(
‹¡_maš_th»ad
)

101 
	`thd_¡¬t
(
NULL
);

102 
	}
}

103 
TEST_END


105 
	$TEST_BEGIN
(
‹¡_subth»ad
)

107 
thd_t
 
thd
;

109 
	`thd_ü—‹
(&
thd
, 
thd_¡¬t
, 
NULL
);

110 
	`thd_još
(
thd
, 
NULL
);

111 
	}
}

112 
TEST_END


115 
	$maš
()

119  (
	`‹¡
(

120 
‹¡_maš_th»ad
,

121 
‹¡_subth»ad
,

122 
‹¡_maš_th»ad
,

123 
‹¡_subth»ad
,

124 
‹¡_maš_th»ad
));

125 
	}
}

	@dep/jemalloc-4.2.0/test/integration/chunk.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_FILL


4 cÚ¡ *
	gm®loc_cÚf
 = "junk:false";

7 
chunk_hooks_t
 
	gÜig_hooks
;

8 
chunk_hooks_t
 
	gŞd_hooks
;

10 
boŞ
 
	gdo_d®loc
 = 
Œue
;

11 
boŞ
 
	gdo_decomm™
;

13 
boŞ
 
	gdid_®loc
;

14 
boŞ
 
	gdid_d®loc
;

15 
boŞ
 
	gdid_comm™
;

16 
boŞ
 
	gdid_decomm™
;

17 
boŞ
 
	gdid_purge
;

18 
boŞ
 
	gdid_¥l™
;

19 
boŞ
 
	gdid_m”ge
;

22 
	#TRACE_HOOK
(
fmt
, ...è
	`m®loc_´štf
(fmt, 
__VA_ARGS__
)

	)

24 
	#TRACE_HOOK
(
fmt
, ...)

	)

28 
	$chunk_®loc
(*
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
,

29 
boŞ
 *
comm™
, 
¬’a_šd
)

32 
	`TRACE_HOOK
("%s(new_addr=%p, size=%zu,‡lignment=%zu, *zero=%s, "

33 "*comm™=%s,‡»Ç_šd=%u)\n", 
__func__
, 
Ãw_addr
, 
size
, 
®ignm’t
,

34 *
z”o
 ? "Œue" : "çl£", *
comm™
 ? "Œue" : "çl£", 
¬’a_šd
);

35 
did_®loc
 = 
Œue
;

36  (
Şd_hooks
.
	`®loc
(
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
, 
comm™
,

37 
¬’a_šd
));

38 
	}
}

40 
boŞ


41 
	$chunk_d®loc
(*
chunk
, 
size_t
 
size
, 
boŞ
 
comm™‹d
, 
¬’a_šd
)

44 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, committed=%s,‡rena_ind=%u)\n",

45 
__func__
, 
chunk
, 
size
, 
comm™‹d
 ? "Œue" : "çl£", 
¬’a_šd
);

46 
did_d®loc
 = 
Œue
;

47 ià(!
do_d®loc
)

48  (
Œue
);

49  (
Şd_hooks
.
	`d®loc
(
chunk
, 
size
, 
comm™‹d
, 
¬’a_šd
));

50 
	}
}

52 
boŞ


53 
	$chunk_comm™
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

54 
¬’a_šd
)

56 
boŞ
 
”r
;

58 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, offset=%zu,†ength=%zu, "

59 "¬’a_šd=%u)\n", 
__func__
, 
chunk
, 
size
, 
off£t
, 
Ëngth
,

60 
¬’a_šd
);

61 
”r
 = 
Şd_hooks
.
	`comm™
(
chunk
, 
size
, 
off£t
, 
Ëngth
, 
¬’a_šd
);

62 
did_comm™
 = !
”r
;

63  (
”r
);

64 
	}
}

66 
boŞ


67 
	$chunk_decomm™
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

68 
¬’a_šd
)

70 
boŞ
 
”r
;

72 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, offset=%zu,†ength=%zu, "

73 "¬’a_šd=%u)\n", 
__func__
, 
chunk
, 
size
, 
off£t
, 
Ëngth
,

74 
¬’a_šd
);

75 ià(!
do_decomm™
)

76  (
Œue
);

77 
”r
 = 
Şd_hooks
.
	`decomm™
(
chunk
, 
size
, 
off£t
, 
Ëngth
, 
¬’a_šd
);

78 
did_decomm™
 = !
”r
;

79  (
”r
);

80 
	}
}

82 
boŞ


83 
	$chunk_purge
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

84 
¬’a_šd
)

87 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, offset=%zu,†ength=%zu "

88 "¬’a_šd=%u)\n", 
__func__
, 
chunk
, 
size
, 
off£t
, 
Ëngth
,

89 
¬’a_šd
);

90 
did_purge
 = 
Œue
;

91  (
Şd_hooks
.
	`purge
(
chunk
, 
size
, 
off£t
, 
Ëngth
, 
¬’a_šd
));

92 
	}
}

94 
boŞ


95 
	$chunk_¥l™
(*
chunk
, 
size_t
 
size
, size_ˆ
size_a
, size_ˆ
size_b
,

96 
boŞ
 
comm™‹d
, 
¬’a_šd
)

99 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, size_a=%zu, size_b=%zu, "

100 "comm™‹d=%s,‡»Ç_šd=%u)\n", 
__func__
, 
chunk
, 
size
, 
size_a
,

101 
size_b
, 
comm™‹d
 ? "Œue" : "çl£", 
¬’a_šd
);

102 
did_¥l™
 = 
Œue
;

103  (
Şd_hooks
.
	`¥l™
(
chunk
, 
size
, 
size_a
, 
size_b
, 
comm™‹d
,

104 
¬’a_šd
));

105 
	}
}

107 
boŞ


108 
	$chunk_m”ge
(*
chunk_a
, 
size_t
 
size_a
, *
chunk_b
, size_ˆ
size_b
,

109 
boŞ
 
comm™‹d
, 
¬’a_šd
)

112 
	`TRACE_HOOK
("%s(chunk_a=%p, size_a=%zu, chunk_b=%p size_b=%zu, "

113 "comm™‹d=%s,‡»Ç_šd=%u)\n", 
__func__
, 
chunk_a
, 
size_a
, 
chunk_b
,

114 
size_b
, 
comm™‹d
 ? "Œue" : "çl£", 
¬’a_šd
);

115 
did_m”ge
 = 
Œue
;

116  (
Şd_hooks
.
	`m”ge
(
chunk_a
, 
size_a
, 
chunk_b
, 
size_b
,

117 
comm™‹d
, 
¬’a_šd
));

118 
	}
}

120 
	$TEST_BEGIN
(
‹¡_chunk
)

122 *
p
;

123 
size_t
 
Şd_size
, 
Ãw_size
, 
Ïrge0
, 
Ïrge1
, 
huge0
, 
huge1
, 
huge2
, 
sz
;

124 
¬’a_šd
;

125 
æags
;

126 
size_t
 
hooks_mib
[3], 
purge_mib
[3];

127 
size_t
 
hooks_mibËn
, 
purge_mibËn
;

128 
chunk_hooks_t
 
Ãw_hooks
 = {

129 
chunk_®loc
,

130 
chunk_d®loc
,

131 
chunk_comm™
,

132 
chunk_decomm™
,

133 
chunk_purge
,

134 
chunk_¥l™
,

135 
chunk_m”ge


137 
boŞ
 
x®locx_sucûss_a
, 
x®locx_sucûss_b
, 
x®locx_sucûss_c
;

139 
sz
 = ();

140 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.ex‹nd", &
¬’a_šd
, &
sz
, 
NULL
, 0), 0,

142 
æags
 = 
	`MALLOCX_ARENA
(
¬’a_šd
è| 
MALLOCX_TCACHE_NONE
;

145 
hooks_mibËn
 = (
hooks_mib
)/(
size_t
);

146 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.chunk_hooks", 
hooks_mib
,

147 &
hooks_mibËn
), 0, "Unexpected mallctlnametomib() failure");

148 
hooks_mib
[1] = (
size_t
)
¬’a_šd
;

149 
Şd_size
 = (
chunk_hooks_t
);

150 
Ãw_size
 = (
chunk_hooks_t
);

151 
	`as£¹_d_eq
(
	`m®lùlbymib
(
hooks_mib
, 
hooks_mibËn
, &
Şd_hooks
, &
Şd_size
,

152 &
Ãw_hooks
, 
Ãw_size
), 0, "Unexpected chunk_hooksƒrror");

153 
Üig_hooks
 = 
Şd_hooks
;

154 
	`as£¹_±r_Ã
(
Şd_hooks
.
®loc
, 
chunk_®loc
, "Unexpected‡llocƒrror");

155 
	`as£¹_±r_Ã
(
Şd_hooks
.
d®loc
, 
chunk_d®loc
,

157 
	`as£¹_±r_Ã
(
Şd_hooks
.
comm™
, 
chunk_comm™
,

159 
	`as£¹_±r_Ã
(
Şd_hooks
.
decomm™
, 
chunk_decomm™
,

161 
	`as£¹_±r_Ã
(
Şd_hooks
.
purge
, 
chunk_purge
, "Unexpected…urgeƒrror");

162 
	`as£¹_±r_Ã
(
Şd_hooks
.
¥l™
, 
chunk_¥l™
, "Unexpected splitƒrror");

163 
	`as£¹_±r_Ã
(
Şd_hooks
.
m”ge
, 
chunk_m”ge
, "Unexpected mergeƒrror");

166 
sz
 = (
size_t
);

167 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ìun.0.size", &
Ïrge0
, &
sz
, 
NULL
, 0), 0,

169 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ìun.1.size", &
Ïrge1
, &
sz
, 
NULL
, 0), 0,

173 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.hchunk.0.size", &
huge0
, &
sz
, 
NULL
, 0), 0,

175 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.hchunk.1.size", &
huge1
, &
sz
, 
NULL
, 0), 0,

177 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.hchunk.2.size", &
huge2
, &
sz
, 
NULL
, 0), 0,

181 
purge_mibËn
 = (
purge_mib
)/(
size_t
);

182 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.purge", 
purge_mib
, &
purge_mibËn
),

184 
purge_mib
[1] = (
size_t
)
¬’a_šd
;

185 
do_d®loc
 = 
çl£
;

186 
do_decomm™
 = 
çl£
;

187 
p
 = 
	`m®locx
(
huge0
 * 2, 
æags
);

188 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

189 
did_d®loc
 = 
çl£
;

190 
did_decomm™
 = 
çl£
;

191 
did_purge
 = 
çl£
;

192 
did_¥l™
 = 
çl£
;

193 
x®locx_sucûss_a
 = (
	`x®locx
(
p
, 
huge0
, 0, 
æags
) == huge0);

194 
	`as£¹_d_eq
(
	`m®lùlbymib
(
purge_mib
, 
purge_mibËn
, 
NULL
, NULL, NULL, 0),

195 0, "UÃx³ùed‡»Ç.%u.purg”rÜ", 
¬’a_šd
);

196 ià(
x®locx_sucûss_a
) {

197 
	`as£¹_Œue
(
did_d®loc
, "Expected dalloc");

198 
	`as£¹_çl£
(
did_decomm™
, "Unexpected decommit");

199 
	`as£¹_Œue
(
did_purge
, "Expected…urge");

201 
	`as£¹_Œue
(
did_¥l™
, "Expected split");

202 
	`d®locx
(
p
, 
æags
);

203 
do_d®loc
 = 
Œue
;

206 
do_d®loc
 = 
çl£
;

207 
do_decomm™
 = 
Œue
;

208 
p
 = 
	`m®locx
(
huge0
 * 2, 
æags
);

209 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

210 
did_decomm™
 = 
çl£
;

211 
did_comm™
 = 
çl£
;

212 
did_¥l™
 = 
çl£
;

213 
did_m”ge
 = 
çl£
;

214 
x®locx_sucûss_b
 = (
	`x®locx
(
p
, 
huge0
, 0, 
æags
) == huge0);

215 
	`as£¹_d_eq
(
	`m®lùlbymib
(
purge_mib
, 
purge_mibËn
, 
NULL
, NULL, NULL, 0),

216 0, "UÃx³ùed‡»Ç.%u.purg”rÜ", 
¬’a_šd
);

217 ià(
x®locx_sucûss_b
)

218 
	`as£¹_Œue
(
did_¥l™
, "Expected split");

219 
x®locx_sucûss_c
 = (
	`x®locx
(
p
, 
huge0
 * 2, 0, 
æags
) == huge0 * 2);

220 
	`as£¹_b_eq
(
did_decomm™
, 
did_comm™
, "Expected decommit/commit match");

221 ià(
x®locx_sucûss_b
 && 
x®locx_sucûss_c
)

222 
	`as£¹_Œue
(
did_m”ge
, "Expected merge");

223 
	`d®locx
(
p
, 
æags
);

224 
do_d®loc
 = 
Œue
;

225 
do_decomm™
 = 
çl£
;

228 ià(
huge0
 * 2 > 
huge2
) {

234 
p
 = 
	`m®locx
(
huge2
, 
æags
);

235 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

236 
did_purge
 = 
çl£
;

237 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge1
, 0, 
æags
), huge1,

239 
	`as£¹_Œue
(
did_purge
, "Expected…urge");

240 
	`d®locx
(
p
, 
æags
);

244 
do_decomm™
 = 
Œue
;

245 
p
 = 
	`m®locx
(
Ïrge1
, 
æags
);

246 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

247 
	`as£¹_d_eq
(
	`m®lùlbymib
(
purge_mib
, 
purge_mibËn
, 
NULL
, NULL, NULL, 0),

248 0, "UÃx³ùed‡»Ç.%u.purg”rÜ", 
¬’a_šd
);

249 
did_decomm™
 = 
çl£
;

250 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 
æags
),†arge0,

252 
	`as£¹_d_eq
(
	`m®lùlbymib
(
purge_mib
, 
purge_mibËn
, 
NULL
, NULL, NULL, 0),

253 0, "UÃx³ùed‡»Ç.%u.purg”rÜ", 
¬’a_šd
);

254 
did_comm™
 = 
çl£
;

255 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge1
, 0, 
æags
),†arge1,

257 
	`as£¹_b_eq
(
did_decomm™
, 
did_comm™
, "Expected decommit/commit match");

258 
	`d®locx
(
p
, 
æags
);

259 
do_decomm™
 = 
çl£
;

262 
p
 = 
	`m®locx
(42, 
æags
);

263 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

264 
	`d®locx
(
p
, 
æags
);

267 
	`as£¹_d_eq
(
	`m®lùlbymib
(
hooks_mib
, 
hooks_mibËn
, 
NULL
, NULL,

268 &
Şd_hooks
, 
Ãw_size
), 0, "Unexpected chunk_hooksƒrror");

269 
	`as£¹_d_eq
(
	`m®lùlbymib
(
hooks_mib
, 
hooks_mibËn
, &
Şd_hooks
, &
Şd_size
,

270 
NULL
, 0), 0, "Unexpected chunk_hooksƒrror");

271 
	`as£¹_±r_eq
(
Şd_hooks
.
®loc
, 
Üig_hooks
.alloc,

273 
	`as£¹_±r_eq
(
Şd_hooks
.
d®loc
, 
Üig_hooks
.dalloc,

275 
	`as£¹_±r_eq
(
Şd_hooks
.
comm™
, 
Üig_hooks
.commit,

277 
	`as£¹_±r_eq
(
Şd_hooks
.
decomm™
, 
Üig_hooks
.decommit,

279 
	`as£¹_±r_eq
(
Şd_hooks
.
purge
, 
Üig_hooks
.purge,

281 
	`as£¹_±r_eq
(
Şd_hooks
.
¥l™
, 
Üig_hooks
.split,

283 
	`as£¹_±r_eq
(
Şd_hooks
.
m”ge
, 
Üig_hooks
.merge,

285 
	}
}

286 
TEST_END


289 
	$maš
()

292  (
	`‹¡
(
‹¡_chunk
));

293 
	}
}

	@dep/jemalloc-4.2.0/test/integration/mallocx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_FILL


4 cÚ¡ *
	gm®loc_cÚf
 = "junk:false";

8 
	$g‘_nsizes_im¶
(cÚ¡ *
cmd
)

10 
»t
;

11 
size_t
 
z
;

13 
z
 = ();

14 
	`as£¹_d_eq
(
	`m®lùl
(
cmd
, &
»t
, &
z
, 
NULL
, 0), 0,

15 "UÃx³ùed m®lùl(\"%s\", ...èçu»", 
cmd
);

17  (
»t
);

18 
	}
}

21 
	$g‘_nhuge
()

24  (
	`g‘_nsizes_im¶
("arenas.nhchunks"));

25 
	}
}

27 
size_t


28 
	$g‘_size_im¶
(cÚ¡ *
cmd
, 
size_t
 
šd
)

30 
size_t
 
»t
;

31 
size_t
 
z
;

32 
size_t
 
mib
[4];

33 
size_t
 
mibËn
 = 4;

35 
z
 = (
size_t
);

36 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
(
cmd
, 
mib
, &
mibËn
),

37 0, "UÃx³ùed m®lùÊam‘omib(\"%s\", ...èçu»", 
cmd
);

38 
mib
[2] = 
šd
;

39 
z
 = (
size_t
);

40 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
»t
, &
z
, 
NULL
, 0),

41 0, "UÃx³ùed m®lùlbymib([\"%s\", %zu], ...èçu»", 
cmd
, 
šd
);

43  (
»t
);

44 
	}
}

46 
size_t


47 
	$g‘_huge_size
(
size_t
 
šd
)

50  (
	`g‘_size_im¶
("¬’as.hchunk.0.size", 
šd
));

51 
	}
}

53 
	$TEST_BEGIN
(
‹¡_ov”æow
)

55 
size_t
 
hugemax
;

57 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

59 
	`as£¹_±r_nuÎ
(
	`m®locx
(
hugemax
+1, 0),

60 "Ex³ùed OOM fÜ m®locx(size=%#zx, 0)", 
hugemax
+1);

62 
	`as£¹_±r_nuÎ
(
	`m®locx
(
	`ZU
(
PTRDIFF_MAX
)+1, 0),

63 "Ex³ùed OOM fÜ m®locx(size=%#zx, 0)", 
	`ZU
(
PTRDIFF_MAX
)+1);

65 
	`as£¹_±r_nuÎ
(
	`m®locx
(
SIZE_T_MAX
, 0),

66 "Ex³ùed OOM fÜ m®locx(size=%#zx, 0)", 
SIZE_T_MAX
);

68 
	`as£¹_±r_nuÎ
(
	`m®locx
(1, 
	`MALLOCX_ALIGN
(
	`ZU
(
PTRDIFF_MAX
)+1)),

70 
	`ZU
(
PTRDIFF_MAX
)+1);

71 
	}
}

72 
TEST_END


74 
	$TEST_BEGIN
(
‹¡_oom
)

76 
size_t
 
hugemax
;

77 
boŞ
 
oom
;

78 *
±rs
[3];

79 
i
;

85 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

86 
oom
 = 
çl£
;

87 
i
 = 0; i < (
±rs
) / (*); i++) {

88 
±rs
[
i
] = 
	`m®locx
(
hugemax
, 0);

89 ià(
±rs
[
i
] =ğ
NULL
)

90 
oom
 = 
Œue
;

92 
	`as£¹_Œue
(
oom
,

94 
hugemax
);

95 
i
 = 0; i < (
±rs
) / (*); i++) {

96 ià(
±rs
[
i
] !ğ
NULL
)

97 
	`d®locx
(
±rs
[
i
], 0);

100 #ià
LG_SIZEOF_PTR
 == 3

101 
	`as£¹_±r_nuÎ
(
	`m®locx
(0x8000000000000000ULL,

102 
	`MALLOCX_ALIGN
(0x8000000000000000ULL)),

104 
	`as£¹_±r_nuÎ
(
	`m®locx
(0x8000000000000000ULL,

105 
	`MALLOCX_ALIGN
(0x80000000)),

108 
	`as£¹_±r_nuÎ
(
	`m®locx
(0x80000000UL, 
	`MALLOCX_ALIGN
(0x80000000UL)),

111 
	}
}

112 
TEST_END


114 
	$TEST_BEGIN
(
‹¡_basic
)

116 
	#MAXSZ
 (((
size_t
)1è<< 26)

	)

117 
size_t
 
sz
;

119 
sz
 = 1; sz < 
MAXSZ
; sz = 
	`ÇÎocx
(sz, 0) + 1) {

120 
size_t
 
nsz
, 
rsz
;

121 *
p
;

122 
nsz
 = 
	`ÇÎocx
(
sz
, 0);

123 
	`as£¹_zu_Ã
(
nsz
, 0, "Unexpected‚allocx()ƒrror");

124 
p
 = 
	`m®locx
(
sz
, 0);

125 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

126 
rsz
 = 
	`§Îocx
(
p
, 0);

127 
	`as£¹_zu_ge
(
rsz
, 
sz
, "Real size smallerhanƒxpected");

128 
	`as£¹_zu_eq
(
nsz
, 
rsz
, "nallocx()/sallocx() size mismatch");

129 
	`d®locx
(
p
, 0);

131 
p
 = 
	`m®locx
(
sz
, 0);

132 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

133 
	`d®locx
(
p
, 0);

135 
nsz
 = 
	`ÇÎocx
(
sz
, 
MALLOCX_ZERO
);

136 
	`as£¹_zu_Ã
(
nsz
, 0, "Unexpected‚allocx()ƒrror");

137 
p
 = 
	`m®locx
(
sz
, 
MALLOCX_ZERO
);

138 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

139 
rsz
 = 
	`§Îocx
(
p
, 0);

140 
	`as£¹_zu_eq
(
nsz
, 
rsz
, "nallocx()/sallocx()„size mismatch");

141 
	`d®locx
(
p
, 0);

143 #undeà
MAXSZ


144 
	}
}

145 
TEST_END


147 
	$TEST_BEGIN
(
‹¡_®ignm’t_ªd_size
)

149 
	#MAXALIGN
 (((
size_t
)1è<< 25)

	)

150 
	#NITER
 4

	)

151 
size_t
 
nsz
, 
rsz
, 
sz
, 
®ignm’t
, 
tÙ®
;

152 
i
;

153 *
ps
[
NITER
];

155 
i
 = 0; i < 
NITER
; i++)

156 
ps
[
i
] = 
NULL
;

158 
®ignm’t
 = 8;

159 
®ignm’t
 <ğ
MAXALIGN
;

160 
®ignm’t
 <<= 1) {

161 
tÙ®
 = 0;

162 
sz
 = 1;

163 
sz
 < 3 * 
®ignm’t
 && sz < (1U << 31);

164 
sz
 +ğ(
®ignm’t
 >> (
LG_SIZEOF_PTR
-1)) - 1) {

165 
i
 = 0; i < 
NITER
; i++) {

166 
nsz
 = 
	`ÇÎocx
(
sz
, 
	`MALLOCX_ALIGN
(
®ignm’t
) |

167 
MALLOCX_ZERO
);

168 
	`as£¹_zu_Ã
(
nsz
, 0,

170 "size=%zu (%#zx)", 
®ignm’t
, 
sz
, sz);

171 
ps
[
i
] = 
	`m®locx
(
sz
, 
	`MALLOCX_ALIGN
(
®ignm’t
) |

172 
MALLOCX_ZERO
);

173 
	`as£¹_±r_nÙ_nuÎ
(
ps
[
i
],

175 "size=%zu (%#zx)", 
®ignm’t
, 
sz
, sz);

176 
rsz
 = 
	`§Îocx
(
ps
[
i
], 0);

177 
	`as£¹_zu_ge
(
rsz
, 
sz
,

179 "®ignm’t=%zu, size=%zu", 
®ignm’t
, 
sz
);

180 
	`as£¹_zu_eq
(
nsz
, 
rsz
,

182 "®ignm’t=%zu, size=%zu", 
®ignm’t
, 
sz
);

183 
	`as£¹_±r_nuÎ
(

184 (*)((
ušŒ_t
)
ps
[
i
] & (
®ignm’t
-1)),

186 "‡lignm’t=%zu, size=%zu", 
ps
[
i
],

187 
®ignm’t
, 
sz
);

188 
tÙ®
 +ğ
rsz
;

189 ià(
tÙ®
 >ğ(
MAXALIGN
 << 1))

192 
i
 = 0; i < 
NITER
; i++) {

193 ià(
ps
[
i
] !ğ
NULL
) {

194 
	`d®locx
(
ps
[
i
], 0);

195 
ps
[
i
] = 
NULL
;

200 #undeà
MAXALIGN


201 #undeà
NITER


202 
	}
}

203 
TEST_END


206 
	$maš
()

209  (
	`‹¡
(

210 
‹¡_ov”æow
,

211 
‹¡_oom
,

212 
‹¡_basic
,

213 
‹¡_®ignm’t_ªd_size
));

214 
	}
}

	@dep/jemalloc-4.2.0/test/integration/overflow.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_ov”æow
)

5 
nhchunks
;

6 
size_t
 
mib
[4];

7 
size_t
 
sz
, 
mibËn
, 
max_size_şass
;

8 *
p
;

10 
sz
 = ();

11 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.nhchunks", &
nhchunks
, &
sz
, 
NULL
, 0), 0,

14 
mibËn
 = (
mib
è/ (
size_t
);

15 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.hchunk.0.size", 
mib
, &
mibËn
), 0,

17 
mib
[2] = 
nhchunks
 - 1;

19 
sz
 = (
size_t
);

20 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
max_size_şass
, &
sz
, 
NULL
, 0), 0,

23 
	`as£¹_±r_nuÎ
(
	`m®loc
(
max_size_şass
 + 1),

25 
	`as£¹_±r_nuÎ
(
	`m®loc
(
SIZE_T_MAX
),

28 
	`as£¹_±r_nuÎ
(
	`ÿÎoc
(1, 
max_size_şass
 + 1),

30 
	`as£¹_±r_nuÎ
(
	`ÿÎoc
(1, 
SIZE_T_MAX
),

33 
p
 = 
	`m®loc
(1);

34 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected malloc() OOM");

35 
	`as£¹_±r_nuÎ
(
	`»®loc
(
p
, 
max_size_şass
 + 1),

37 
	`as£¹_±r_nuÎ
(
	`»®loc
(
p
, 
SIZE_T_MAX
),

39 
	`ä“
(
p
);

40 
	}
}

41 
TEST_END


44 
	$maš
()

47  (
	`‹¡
(

48 
‹¡_ov”æow
));

49 
	}
}

	@dep/jemalloc-4.2.0/test/integration/posix_memalign.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#CHUNK
 0x400000

	)

5 
	#MAXALIGN
 ((
size_t
)0x2000000LU)

	)

6 
	#NITER
 4

	)

8 
	$TEST_BEGIN
(
‹¡_®ignm’t_”rÜs
)

10 
size_t
 
®ignm’t
;

11 *
p
;

13 
®ignm’t
 = 0;‡lignment < (*);‡lignment++) {

14 
	`as£¹_d_eq
(
	`posix_mem®ign
(&
p
, 
®ignm’t
, 1), 
EINVAL
,

16 
®ignm’t
);

19 
®ignm’t
 = (
size_t
);‡lignm’ˆ< 
MAXALIGN
;

20 
®ignm’t
 <<= 1) {

21 
	`as£¹_d_Ã
(
	`posix_mem®ign
(&
p
, 
®ignm’t
 + 1, 1), 0,

23 
®ignm’t
 + 1);

25 
	}
}

26 
TEST_END


28 
	$TEST_BEGIN
(
‹¡_oom_”rÜs
)

30 
size_t
 
®ignm’t
, 
size
;

31 *
p
;

33 #ià
LG_SIZEOF_PTR
 == 3

34 
®ignm’t
 = 
	`UINT64_C
(0x8000000000000000);

35 
size
 = 
	`UINT64_C
(0x8000000000000000);

37 
®ignm’t
 = 0x80000000LU;

38 
size
 = 0x80000000LU;

40 
	`as£¹_d_Ã
(
	`posix_mem®ign
(&
p
, 
®ignm’t
, 
size
), 0,

42 
®ignm’t
, 
size
);

44 #ià
LG_SIZEOF_PTR
 == 3

45 
®ignm’t
 = 
	`UINT64_C
(0x4000000000000000);

46 
size
 = 
	`UINT64_C
(0xc000000000000001);

48 
®ignm’t
 = 0x40000000LU;

49 
size
 = 0xc0000001LU;

51 
	`as£¹_d_Ã
(
	`posix_mem®ign
(&
p
, 
®ignm’t
, 
size
), 0,

53 
®ignm’t
, 
size
);

55 
®ignm’t
 = 0x10LU;

56 #ià
LG_SIZEOF_PTR
 == 3

57 
size
 = 
	`UINT64_C
(0xfffffffffffffff0);

59 
size
 = 0xfffffff0LU;

61 
	`as£¹_d_Ã
(
	`posix_mem®ign
(&
p
, 
®ignm’t
, 
size
), 0,

63 
®ignm’t
, 
size
);

64 
	}
}

65 
TEST_END


67 
	$TEST_BEGIN
(
‹¡_®ignm’t_ªd_size
)

69 
size_t
 
®ignm’t
, 
size
, 
tÙ®
;

70 
i
;

71 
”r
;

72 *
ps
[
NITER
];

74 
i
 = 0; i < 
NITER
; i++)

75 
ps
[
i
] = 
NULL
;

77 
®ignm’t
 = 8;

78 
®ignm’t
 <ğ
MAXALIGN
;

79 
®ignm’t
 <<= 1) {

80 
tÙ®
 = 0;

81 
size
 = 1;

82 
size
 < 3 * 
®ignm’t
 && size < (1U << 31);

83 
size
 +ğ(
®ignm’t
 >> (
LG_SIZEOF_PTR
-1)) - 1) {

84 
i
 = 0; i < 
NITER
; i++) {

85 
”r
 = 
	`posix_mem®ign
(&
ps
[
i
],

86 
®ignm’t
, 
size
);

87 ià(
”r
) {

88 
buf
[
BUFERROR_BUF
];

90 
	`buã¼Ü
(
	`g‘_”ºo
(), 
buf
, (buf));

91 
	`‹¡_ç
(

94 
®ignm’t
, 
size
, size, 
buf
);

96 
tÙ®
 +ğ
	`m®loc_u§bË_size
(
ps
[
i
]);

97 ià(
tÙ®
 >ğ(
MAXALIGN
 << 1))

100 
i
 = 0; i < 
NITER
; i++) {

101 ià(
ps
[
i
] !ğ
NULL
) {

102 
	`ä“
(
ps
[
i
]);

103 
ps
[
i
] = 
NULL
;

108 
	}
}

109 
TEST_END


112 
	$maš
()

115  (
	`‹¡
(

116 
‹¡_®ignm’t_”rÜs
,

117 
‹¡_oom_”rÜs
,

118 
‹¡_®ignm’t_ªd_size
));

119 
	}
}

	@dep/jemalloc-4.2.0/test/integration/rallocx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	$g‘_nsizes_im¶
(cÚ¡ *
cmd
)

6 
»t
;

7 
size_t
 
z
;

9 
z
 = ();

10 
	`as£¹_d_eq
(
	`m®lùl
(
cmd
, &
»t
, &
z
, 
NULL
, 0), 0,

11 "UÃx³ùed m®lùl(\"%s\", ...èçu»", 
cmd
);

13  (
»t
);

14 
	}
}

17 
	$g‘_nhuge
()

20  (
	`g‘_nsizes_im¶
("arenas.nhchunks"));

21 
	}
}

23 
size_t


24 
	$g‘_size_im¶
(cÚ¡ *
cmd
, 
size_t
 
šd
)

26 
size_t
 
»t
;

27 
size_t
 
z
;

28 
size_t
 
mib
[4];

29 
size_t
 
mibËn
 = 4;

31 
z
 = (
size_t
);

32 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
(
cmd
, 
mib
, &
mibËn
),

33 0, "UÃx³ùed m®lùÊam‘omib(\"%s\", ...èçu»", 
cmd
);

34 
mib
[2] = 
šd
;

35 
z
 = (
size_t
);

36 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
»t
, &
z
, 
NULL
, 0),

37 0, "UÃx³ùed m®lùlbymib([\"%s\", %zu], ...èçu»", 
cmd
, 
šd
);

39  (
»t
);

40 
	}
}

42 
size_t


43 
	$g‘_huge_size
(
size_t
 
šd
)

46  (
	`g‘_size_im¶
("¬’as.hchunk.0.size", 
šd
));

47 
	}
}

49 
	$TEST_BEGIN
(
‹¡_grow_ªd_shršk
)

51 *
p
, *
q
;

52 
size_t
 
tsz
;

53 
	#NCYCLES
 3

	)

54 
i
, 
j
;

55 
	#NSZS
 2500

	)

56 
size_t
 
szs
[
NSZS
];

57 
	#MAXSZ
 
	`ZU
(12 * 1024 * 1024)

	)

59 
p
 = 
	`m®locx
(1, 0);

60 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

61 
szs
[0] = 
	`§Îocx
(
p
, 0);

63 
i
 = 0; i < 
NCYCLES
; i++) {

64 
j
 = 1; j < 
NSZS
 && 
szs
[j-1] < 
MAXSZ
; j++) {

65 
q
 = 
	`¿Îocx
(
p
, 
szs
[
j
-1]+1, 0);

66 
	`as£¹_±r_nÙ_nuÎ
(
q
,

68 
szs
[
j
-1], szs[j-1]+1);

69 
szs
[
j
] = 
	`§Îocx
(
q
, 0);

70 
	`as£¹_zu_Ã
(
szs
[
j
], szs[j-1]+1,

71 "Ex³ùed siztØb©†—¡: %zu", 
szs
[
j
-1]+1);

72 
p
 = 
q
;

75 
j
--; j > 0; j--) {

76 
q
 = 
	`¿Îocx
(
p
, 
szs
[
j
-1], 0);

77 
	`as£¹_±r_nÙ_nuÎ
(
q
,

79 
szs
[
j
], szs[j-1]);

80 
tsz
 = 
	`§Îocx
(
q
, 0);

81 
	`as£¹_zu_eq
(
tsz
, 
szs
[
j
-1],

82 "Ex³ùed size=%zu, gÙ size=%zu", 
szs
[
j
-1], 
tsz
);

83 
p
 = 
q
;

87 
	`d®locx
(
p
, 0);

88 #undeà
MAXSZ


89 #undeà
NSZS


90 #undeà
NCYCLES


91 
	}
}

92 
TEST_END


94 
boŞ


95 
	$v®id©e_fl
(cÚ¡ *
p
, 
ušt8_t
 
c
, 
size_t
 
off£t
, size_ˆ
Ën
)

97 
boŞ
 
»t
 = 
çl£
;

98 cÚ¡ 
ušt8_t
 *
buf
 = (cÚ¡ ušt8_ˆ*)
p
;

99 
size_t
 
i
;

101 
i
 = 0; i < 
Ën
; i++) {

102 
ušt8_t
 
b
 = 
buf
[
off£t
+
i
];

103 ià(
b
 !ğ
c
) {

104 
	`‹¡_ç
("Allocation‡t %p (len=%zu) contains %#x "

105 "¿th”hª %#x‡ˆoff£ˆ%zu", 
p
, 
Ën
, 
b
, 
c
,

106 
off£t
+
i
);

107 
»t
 = 
Œue
;

111  (
»t
);

112 
	}
}

114 
	$TEST_BEGIN
(
‹¡_z”o
)

116 *
p
, *
q
;

117 
size_t
 
psz
, 
qsz
, 
i
, 
j
;

118 
size_t
 
¡¬t_sizes
[] = {1, 3*1024, 63*1024, 4095*1024};

119 
	#FILL_BYTE
 0x¯U

	)

120 
	#RANGE
 2048

	)

122 
i
 = 0; i < (
¡¬t_sizes
)/(
size_t
); i++) {

123 
size_t
 
¡¬t_size
 = 
¡¬t_sizes
[
i
];

124 
p
 = 
	`m®locx
(
¡¬t_size
, 
MALLOCX_ZERO
);

125 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

126 
psz
 = 
	`§Îocx
(
p
, 0);

128 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 0, 0, 
psz
),

130 
	`mem£t
(
p
, 
FILL_BYTE
, 
psz
);

131 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
psz
),

134 
j
 = 1; j < 
RANGE
; j++) {

135 
q
 = 
	`¿Îocx
(
p
, 
¡¬t_size
+
j
, 
MALLOCX_ZERO
);

136 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected„allocx()ƒrror");

137 
qsz
 = 
	`§Îocx
(
q
, 0);

138 ià(
q
 !ğ
p
 || 
qsz
 !ğ
psz
) {

139 
	`as£¹_çl£
(
	`v®id©e_fl
(
q
, 
FILL_BYTE
, 0,

140 
psz
), "Expected filled memory");

141 
	`as£¹_çl£
(
	`v®id©e_fl
(
q
, 0, 
psz
, 
qsz
-psz),

144 ià(
psz
 !ğ
qsz
) {

145 
	`mem£t
((*)((
ušŒ_t
)
q
+
psz
), 
FILL_BYTE
,

146 
qsz
-
psz
);

147 
psz
 = 
qsz
;

149 
p
 = 
q
;

151 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
psz
),

153 
	`d®locx
(
p
, 0);

155 #undeà
FILL_BYTE


156 
	}
}

157 
TEST_END


159 
	$TEST_BEGIN
(
‹¡_®ign
)

161 *
p
, *
q
;

162 
size_t
 
®ign
;

163 
	#MAX_ALIGN
 (
	`ZU
(1è<< 25)

	)

165 
®ign
 = 
	`ZU
(1);

166 
p
 = 
	`m®locx
(1, 
	`MALLOCX_ALIGN
(
®ign
));

167 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

169 
®ign
 <<ğ1;‡ligÀ<ğ
MAX_ALIGN
;‡lign <<= 1) {

170 
q
 = 
	`¿Îocx
(
p
, 1, 
	`MALLOCX_ALIGN
(
®ign
));

171 
	`as£¹_±r_nÙ_nuÎ
(
q
,

172 "UÃx³ùed„®locx(è”rÜ fÜ‡lign=%zu", 
®ign
);

173 
	`as£¹_±r_nuÎ
(

174 (*)((
ušŒ_t
)
q
 & (
®ign
-1)),

176 
q
, 
®ign
);

177 
p
 = 
q
;

179 
	`d®locx
(
p
, 0);

180 #undeà
MAX_ALIGN


181 
	}
}

182 
TEST_END


184 
	$TEST_BEGIN
(
‹¡_lg_®ign_ªd_z”o
)

186 *
p
, *
q
;

187 
lg_®ign
;

188 
size_t
 
sz
;

189 
	#MAX_LG_ALIGN
 25

	)

190 
	#MAX_VALIDATE
 (
	`ZU
(1è<< 22)

	)

192 
lg_®ign
 = 0;

193 
p
 = 
	`m®locx
(1, 
	`MALLOCX_LG_ALIGN
(
lg_®ign
)|
MALLOCX_ZERO
);

194 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

196 
lg_®ign
++;†g_®igÀ<ğ
MAX_LG_ALIGN
;†g_align++) {

197 
q
 = 
	`¿Îocx
(
p
, 1, 
	`MALLOCX_LG_ALIGN
(
lg_®ign
)|
MALLOCX_ZERO
);

198 
	`as£¹_±r_nÙ_nuÎ
(
q
,

199 "UÃx³ùed„®locx(è”rÜ fÜ†g_®ign=%u", 
lg_®ign
);

200 
	`as£¹_±r_nuÎ
(

201 (*)((
ušŒ_t
)
q
 & ((
	`ZU
(1è<< 
lg_®ign
)-1)),

202 "%°šadequ©–y‡ligÃd fÜ†g_®ign=%u", 
q
, 
lg_®ign
);

203 
sz
 = 
	`§Îocx
(
q
, 0);

204 ià((
sz
 << 1è<ğ
MAX_VALIDATE
) {

205 
	`as£¹_çl£
(
	`v®id©e_fl
(
q
, 0, 0, 
sz
),

208 
	`as£¹_çl£
(
	`v®id©e_fl
(
q
, 0, 0, 
MAX_VALIDATE
),

210 
	`as£¹_çl£
(
	`v®id©e_fl
(

211 (*)((
ušŒ_t
)
q
+
sz
-
MAX_VALIDATE
),

212 0, 0, 
MAX_VALIDATE
), "Expected zeroed memory");

214 
p
 = 
q
;

216 
	`d®locx
(
p
, 0);

217 #undeà
MAX_VALIDATE


218 #undeà
MAX_LG_ALIGN


219 
	}
}

220 
TEST_END


222 
	$TEST_BEGIN
(
‹¡_ov”æow
)

224 
size_t
 
hugemax
;

225 *
p
;

227 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

229 
p
 = 
	`m®locx
(1, 0);

230 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

232 
	`as£¹_±r_nuÎ
(
	`¿Îocx
(
p
, 
hugemax
+1, 0),

233 "Ex³ùed OOM fÜ„®locxÕ, size=%#zx, 0)", 
hugemax
+1);

235 
	`as£¹_±r_nuÎ
(
	`¿Îocx
(
p
, 
	`ZU
(
PTRDIFF_MAX
)+1, 0),

236 "Ex³ùed OOM fÜ„®locxÕ, size=%#zx, 0)", 
	`ZU
(
PTRDIFF_MAX
)+1);

238 
	`as£¹_±r_nuÎ
(
	`¿Îocx
(
p
, 
SIZE_T_MAX
, 0),

239 "Ex³ùed OOM fÜ„®locxÕ, size=%#zx, 0)", 
SIZE_T_MAX
);

241 
	`as£¹_±r_nuÎ
(
	`¿Îocx
(
p
, 1, 
	`MALLOCX_ALIGN
(
	`ZU
(
PTRDIFF_MAX
)+1)),

243 
	`ZU
(
PTRDIFF_MAX
)+1);

245 
	`d®locx
(
p
, 0);

246 
	}
}

247 
TEST_END


250 
	$maš
()

253  (
	`‹¡
(

254 
‹¡_grow_ªd_shršk
,

255 
‹¡_z”o
,

256 
‹¡_®ign
,

257 
‹¡_lg_®ign_ªd_z”o
,

258 
‹¡_ov”æow
));

259 
	}
}

	@dep/jemalloc-4.2.0/test/integration/sdallocx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#MAXALIGN
 (((
size_t
)1è<< 25)

	)

4 
	#NITER
 4

	)

6 
	$TEST_BEGIN
(
‹¡_basic
)

8 *
±r
 = 
	`m®locx
(64, 0);

9 
	`sd®locx
(
±r
, 64, 0);

10 
	}
}

11 
TEST_END


13 
	$TEST_BEGIN
(
‹¡_®ignm’t_ªd_size
)

15 
size_t
 
nsz
, 
sz
, 
®ignm’t
, 
tÙ®
;

16 
i
;

17 *
ps
[
NITER
];

19 
i
 = 0; i < 
NITER
; i++)

20 
ps
[
i
] = 
NULL
;

22 
®ignm’t
 = 8;

23 
®ignm’t
 <ğ
MAXALIGN
;

24 
®ignm’t
 <<= 1) {

25 
tÙ®
 = 0;

26 
sz
 = 1;

27 
sz
 < 3 * 
®ignm’t
 && sz < (1U << 31);

28 
sz
 +ğ(
®ignm’t
 >> (
LG_SIZEOF_PTR
-1)) - 1) {

29 
i
 = 0; i < 
NITER
; i++) {

30 
nsz
 = 
	`ÇÎocx
(
sz
, 
	`MALLOCX_ALIGN
(
®ignm’t
) |

31 
MALLOCX_ZERO
);

32 
ps
[
i
] = 
	`m®locx
(
sz
, 
	`MALLOCX_ALIGN
(
®ignm’t
) |

33 
MALLOCX_ZERO
);

34 
tÙ®
 +ğ
nsz
;

35 ià(
tÙ®
 >ğ(
MAXALIGN
 << 1))

38 
i
 = 0; i < 
NITER
; i++) {

39 ià(
ps
[
i
] !ğ
NULL
) {

40 
	`sd®locx
(
ps
[
i
], 
sz
,

41 
	`MALLOCX_ALIGN
(
®ignm’t
));

42 
ps
[
i
] = 
NULL
;

47 
	}
}

48 
TEST_END


51 
	$maš
()

54  (
	`‹¡
(

55 
‹¡_basic
,

56 
‹¡_®ignm’t_ªd_size
));

57 
	}
}

	@dep/jemalloc-4.2.0/test/integration/thread_arena.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NTHREADS
 10

	)

6 
	$thd_¡¬t
(*
¬g
)

8 
maš_¬’a_šd
 = *(*)
¬g
;

9 *
p
;

10 
¬’a_šd
;

11 
size_t
 
size
;

12 
”r
;

14 
p
 = 
	`m®loc
(1);

15 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Error in malloc()");

16 
	`ä“
(
p
);

18 
size
 = (
¬’a_šd
);

19 ià((
”r
 = 
	`m®lùl
("th»ad.¬’a", &
¬’a_šd
, &
size
, &
maš_¬’a_šd
,

20 (
maš_¬’a_šd
)))) {

21 
buf
[
BUFERROR_BUF
];

23 
	`buã¼Ü
(
”r
, 
buf
, (buf));

24 
	`‹¡_ç
("E¼Ü iÀm®lùl(): %s", 
buf
);

27 
size
 = (
¬’a_šd
);

28 ià((
”r
 = 
	`m®lùl
("th»ad.¬’a", &
¬’a_šd
, &
size
, 
NULL
, 0))) {

29 
buf
[
BUFERROR_BUF
];

31 
	`buã¼Ü
(
”r
, 
buf
, (buf));

32 
	`‹¡_ç
("E¼Ü iÀm®lùl(): %s", 
buf
);

34 
	`as£¹_u_eq
(
¬’a_šd
, 
maš_¬’a_šd
,

37  (
NULL
);

38 
	}
}

40 
	$TEST_BEGIN
(
‹¡_th»ad_¬’a
)

42 *
p
;

43 
¬’a_šd
;

44 
size_t
 
size
;

45 
”r
;

46 
thd_t
 
thds
[
NTHREADS
];

47 
i
;

49 
p
 = 
	`m®loc
(1);

50 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Error in malloc()");

52 
size
 = (
¬’a_šd
);

53 ià((
”r
 = 
	`m®lùl
("th»ad.¬’a", &
¬’a_šd
, &
size
, 
NULL
, 0))) {

54 
buf
[
BUFERROR_BUF
];

56 
	`buã¼Ü
(
”r
, 
buf
, (buf));

57 
	`‹¡_ç
("E¼Ü iÀm®lùl(): %s", 
buf
);

60 
i
 = 0; i < 
NTHREADS
; i++) {

61 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
,

62 (*)&
¬’a_šd
);

65 
i
 = 0; i < 
NTHREADS
; i++) {

66 
šŒ_t
 
još_»t
;

67 
	`thd_još
(
thds
[
i
], (*)&
još_»t
);

68 
	`as£¹_zd_eq
(
još_»t
, 0, "Unexpectedhread joinƒrror");

70 
	}
}

71 
TEST_END


74 
	$maš
()

77  (
	`‹¡
(

78 
‹¡_th»ad_¬’a
));

79 
	}
}

	@dep/jemalloc-4.2.0/test/integration/thread_tcache_enabled.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 cÚ¡ 
boŞ
 
	gcÚfig_tÿche
 =

4 #ifdeà
JEMALLOC_TCACHE


5 
Œue


7 
çl£


12 
	$thd_¡¬t
(*
¬g
)

14 
”r
;

15 
size_t
 
sz
;

16 
boŞ
 
e0
, 
e1
;

18 
sz
 = (
boŞ
);

19 ià((
”r
 = 
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, 
NULL
, 0))) {

20 ià(
”r
 =ğ
ENOENT
) {

21 
	`as£¹_çl£
(
cÚfig_tÿche
,

25 
Ïb–_ENOENT
;

28 ià(
e0
) {

29 
e1
 = 
çl£
;

30 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz),

32 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

35 
e1
 = 
Œue
;

36 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

38 
	`as£¹_çl£
(
e0
, "tcache should be disabled");

40 
e1
 = 
Œue
;

41 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

43 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

45 
e1
 = 
çl£
;

46 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

48 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

50 
e1
 = 
çl£
;

51 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

53 
	`as£¹_çl£
(
e0
, "tcache should be disabled");

55 
	`ä“
(
	`m®loc
(1));

56 
e1
 = 
Œue
;

57 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

59 
	`as£¹_çl£
(
e0
, "tcache should be disabled");

61 
	`ä“
(
	`m®loc
(1));

62 
e1
 = 
Œue
;

63 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

65 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

67 
	`ä“
(
	`m®loc
(1));

68 
e1
 = 
çl£
;

69 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

71 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

73 
	`ä“
(
	`m®loc
(1));

74 
e1
 = 
çl£
;

75 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

77 
	`as£¹_çl£
(
e0
, "tcache should be disabled");

79 
	`ä“
(
	`m®loc
(1));

80  (
NULL
);

81 
Ïb–_ENOENT
:

82 
	`‹¡_sk
("\"thread.tcache.enabled\" mallctl‚ot‡vailable");

83  (
NULL
);

84 
	}
}

86 
	$TEST_BEGIN
(
‹¡_maš_th»ad
)

89 
	`thd_¡¬t
(
NULL
);

90 
	}
}

91 
TEST_END


93 
	$TEST_BEGIN
(
‹¡_subth»ad
)

95 
thd_t
 
thd
;

97 
	`thd_ü—‹
(&
thd
, 
thd_¡¬t
, 
NULL
);

98 
	`thd_još
(
thd
, 
NULL
);

99 
	}
}

100 
TEST_END


103 
	$maš
()

107  (
	`‹¡
(

108 
‹¡_maš_th»ad
,

109 
‹¡_subth»ad
,

110 
‹¡_maš_th»ad
,

111 
‹¡_subth»ad
,

112 
‹¡_maš_th»ad
));

113 
	}
}

	@dep/jemalloc-4.2.0/test/integration/xallocx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_FILL


4 cÚ¡ *
	gm®loc_cÚf
 = "junk:false";

13 
	$¬’a_šd
()

15 
šd
 = 0;

17 ià(
šd
 == 0) {

18 
size_t
 
sz
 = (
šd
);

19 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.ex‹nd", &
šd
, &
sz
, 
NULL
, 0), 0,

23  (
šd
);

24 
	}
}

26 
	$TEST_BEGIN
(
‹¡_§me_size
)

28 *
p
;

29 
size_t
 
sz
, 
tsz
;

31 
p
 = 
	`m®locx
(42, 0);

32 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

33 
sz
 = 
	`§Îocx
(
p
, 0);

35 
tsz
 = 
	`x®locx
(
p
, 
sz
, 0, 0);

36 
	`as£¹_zu_eq
(
tsz
, 
sz
, "Unexpected size change: %zu --> %zu", sz,sz);

38 
	`d®locx
(
p
, 0);

39 
	}
}

40 
TEST_END


42 
	$TEST_BEGIN
(
‹¡_exŒa_no_move
)

44 *
p
;

45 
size_t
 
sz
, 
tsz
;

47 
p
 = 
	`m®locx
(42, 0);

48 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

49 
sz
 = 
	`§Îocx
(
p
, 0);

51 
tsz
 = 
	`x®locx
(
p
, 
sz
, sz-42, 0);

52 
	`as£¹_zu_eq
(
tsz
, 
sz
, "Unexpected size change: %zu --> %zu", sz,sz);

54 
	`d®locx
(
p
, 0);

55 
	}
}

56 
TEST_END


58 
	$TEST_BEGIN
(
‹¡_no_move_ç
)

60 *
p
;

61 
size_t
 
sz
, 
tsz
;

63 
p
 = 
	`m®locx
(42, 0);

64 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

65 
sz
 = 
	`§Îocx
(
p
, 0);

67 
tsz
 = 
	`x®locx
(
p
, 
sz
 + 5, 0, 0);

68 
	`as£¹_zu_eq
(
tsz
, 
sz
, "Unexpected size change: %zu --> %zu", sz,sz);

70 
	`d®locx
(
p
, 0);

71 
	}
}

72 
TEST_END


75 
	$g‘_nsizes_im¶
(cÚ¡ *
cmd
)

77 
»t
;

78 
size_t
 
z
;

80 
z
 = ();

81 
	`as£¹_d_eq
(
	`m®lùl
(
cmd
, &
»t
, &
z
, 
NULL
, 0), 0,

82 "UÃx³ùed m®lùl(\"%s\", ...èçu»", 
cmd
);

84  (
»t
);

85 
	}
}

88 
	$g‘_nsm®l
()

91  (
	`g‘_nsizes_im¶
("arenas.nbins"));

92 
	}
}

95 
	$g‘_Æ¬ge
()

98  (
	`g‘_nsizes_im¶
("arenas.nlruns"));

99 
	}
}

102 
	$g‘_nhuge
()

105  (
	`g‘_nsizes_im¶
("arenas.nhchunks"));

106 
	}
}

108 
size_t


109 
	$g‘_size_im¶
(cÚ¡ *
cmd
, 
size_t
 
šd
)

111 
size_t
 
»t
;

112 
size_t
 
z
;

113 
size_t
 
mib
[4];

114 
size_t
 
mibËn
 = 4;

116 
z
 = (
size_t
);

117 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
(
cmd
, 
mib
, &
mibËn
),

118 0, "UÃx³ùed m®lùÊam‘omib(\"%s\", ...èçu»", 
cmd
);

119 
mib
[2] = 
šd
;

120 
z
 = (
size_t
);

121 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
»t
, &
z
, 
NULL
, 0),

122 0, "UÃx³ùed m®lùlbymib([\"%s\", %zu], ...èçu»", 
cmd
, 
šd
);

124  (
»t
);

125 
	}
}

127 
size_t


128 
	$g‘_sm®l_size
(
size_t
 
šd
)

131  (
	`g‘_size_im¶
("¬’as.bš.0.size", 
šd
));

132 
	}
}

134 
size_t


135 
	$g‘_Ïrge_size
(
size_t
 
šd
)

138  (
	`g‘_size_im¶
("¬’as.Ìun.0.size", 
šd
));

139 
	}
}

141 
size_t


142 
	$g‘_huge_size
(
size_t
 
šd
)

145  (
	`g‘_size_im¶
("¬’as.hchunk.0.size", 
šd
));

146 
	}
}

148 
	$TEST_BEGIN
(
‹¡_size
)

150 
size_t
 
sm®l0
, 
hugemax
;

151 *
p
;

154 
sm®l0
 = 
	`g‘_sm®l_size
(0);

155 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

157 
p
 = 
	`m®locx
(
sm®l0
, 0);

158 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

161 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 1, 0, 0), 
sm®l0
,

165 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
, 0, 0), hugemax,

169 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
+1, 0, 0), hugemax,

171 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
SIZE_T_MAX
, 0, 0), 
hugemax
,

174 
	`d®locx
(
p
, 0);

175 
	}
}

176 
TEST_END


178 
	$TEST_BEGIN
(
‹¡_size_exŒa_ov”æow
)

180 
size_t
 
sm®l0
, 
hugemax
;

181 *
p
;

184 
sm®l0
 = 
	`g‘_sm®l_size
(0);

185 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

187 
p
 = 
	`m®locx
(
sm®l0
, 0);

188 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

191 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
-1, 2, 0), hugemax,

193 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
, 1, 0), hugemax,

197 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
+1, 2, 0), hugemax,

199 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
+2, 3, 0), hugemax,

201 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
SIZE_T_MAX
-2, 2, 0), 
hugemax
,

203 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
SIZE_T_MAX
-1, 1, 0), 
hugemax
,

206 
	`d®locx
(
p
, 0);

207 
	}
}

208 
TEST_END


210 
	$TEST_BEGIN
(
‹¡_exŒa_sm®l
)

212 
size_t
 
sm®l0
, 
sm®l1
, 
hugemax
;

213 *
p
;

216 
sm®l0
 = 
	`g‘_sm®l_size
(0);

217 
sm®l1
 = 
	`g‘_sm®l_size
(1);

218 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

220 
p
 = 
	`m®locx
(
sm®l0
, 0);

221 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

223 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l1
, 0, 0), 
sm®l0
,

226 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l1
, 0, 0), 
sm®l0
,

229 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l0
, 
sm®l1
 - small0, 0), small0,

233 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l0
, 
hugemax
 - small0 + 1, 0), small0,

235 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l0
, 
SIZE_T_MAX
 - small0, 0), small0,

238 
	`d®locx
(
p
, 0);

239 
	}
}

240 
TEST_END


242 
	$TEST_BEGIN
(
‹¡_exŒa_Ïrge
)

244 
æags
 = 
	`MALLOCX_ARENA
(
	`¬’a_šd
());

245 
size_t
 
sm®lmax
, 
Ïrge0
, 
Ïrge1
, 
Ïrge2
, 
huge0
, 
hugemax
;

246 *
p
;

249 
sm®lmax
 = 
	`g‘_sm®l_size
(
	`g‘_nsm®l
()-1);

250 
Ïrge0
 = 
	`g‘_Ïrge_size
(0);

251 
Ïrge1
 = 
	`g‘_Ïrge_size
(1);

252 
Ïrge2
 = 
	`g‘_Ïrge_size
(2);

253 
huge0
 = 
	`g‘_huge_size
(0);

254 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

256 
p
 = 
	`m®locx
(
Ïrge2
, 
æags
);

257 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

259 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge2
, 0, 
æags
),†arge2,

262 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 
æags
),†arge0,

264 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®lmax
, 0, 
æags
), 
Ïrge0
,

267 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge2
, 0, 
æags
),†arge2,

270 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 
Ïrge2
 -†¬ge0, 
æags
),†arge2,

272 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge1
, 
Ïrge2
 -†¬ge1, 
æags
),†arge2,

274 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 
Ïrge1
 -†¬ge0, 
æags
),†arge1,

276 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®lmax
, 
Ïrge0
 - sm®lmax, 
æags
),†arge0,

279 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 
æags
),†arge0,

282 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge2
, 0, 
æags
),†arge2,

284 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge0
, 0, 
æags
), 
Ïrge2
,

287 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 
æags
),†arge0,

290 
	`as£¹_zu_É
(
	`x®locx
(
p
, 
Ïrge0
, 
huge0
 -†¬ge0, 
æags
), huge0,

293 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 
æags
),†arge0,

296 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 
Ïrge2
 -†¬ge0, 
æags
),†arge2,

299 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge2
, 0, 
æags
),†arge2,

302 
	`as£¹_zu_É
(
	`x®locx
(
p
, 
Ïrge2
, 
hugemax
 -†¬ge2 + 1, 
æags
), 
huge0
,

305 
	`d®locx
(
p
, 
æags
);

306 
	}
}

307 
TEST_END


309 
	$TEST_BEGIN
(
‹¡_exŒa_huge
)

311 
æags
 = 
	`MALLOCX_ARENA
(
	`¬’a_šd
());

312 
size_t
 
Ïrgemax
, 
huge1
, 
huge2
, 
huge3
, 
hugemax
;

313 *
p
;

316 
Ïrgemax
 = 
	`g‘_Ïrge_size
(
	`g‘_Æ¬ge
()-1);

317 
huge1
 = 
	`g‘_huge_size
(1);

318 
huge2
 = 
	`g‘_huge_size
(2);

319 
huge3
 = 
	`g‘_huge_size
(3);

320 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

322 
p
 = 
	`m®locx
(
huge3
, 
æags
);

323 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

325 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge3
, 0, 
æags
), huge3,

328 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
huge1
, 0, 
æags
), huge1,

330 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
Ïrgemax
, 0, 
æags
), 
huge1
,

333 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge3
, 0, 
æags
), huge3,

336 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge1
, 
huge3
 - huge1, 
æags
), huge3,

338 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge2
, 
huge3
 - huge2, 
æags
), huge3,

340 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge1
, 
huge2
 - huge1, 
æags
), huge2,

342 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
Ïrgemax
, 
huge1
 -†¬gemax, 
æags
), huge1,

345 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
huge1
, 0, 
æags
), huge1,

348 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
huge3
, 0, 
æags
), huge3,

350 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
+1, 0, 
æags
), 
huge3
,

353 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
huge1
, 0, 
æags
), huge1,

356 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
huge1
, 
SIZE_T_MAX
 - huge1, 
æags
), 
hugemax
,

359 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
huge1
, 0, 
æags
), huge1,

362 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
huge1
, 
huge3
 - huge1, 
æags
), huge3,

365 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge3
, 0, 
æags
), huge3,

368 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
huge3
, 
hugemax
 - huge3 + 1, 
æags
), hugemax,

371 
	`d®locx
(
p
, 
æags
);

372 
	}
}

373 
TEST_END


376 
	$´št_fËd_ex‹Ás
(cÚ¡ *
p
, 
ušt8_t
 
c
, 
size_t
 
Ën
)

378 cÚ¡ 
ušt8_t
 *
pc
 = (cÚ¡ ušt8_ˆ*)
p
;

379 
size_t
 
i
, 
¿nge0
;

380 
ušt8_t
 
c0
;

382 
	`m®loc_´štf
("…=%p, c=%#x,†’=%zu:", 
p
, 
c
, 
Ën
);

383 
¿nge0
 = 0;

384 
c0
 = 
pc
[0];

385 
i
 = 0; i < 
Ën
; i++) {

386 ià(
pc
[
i
] !ğ
c0
) {

387 
	`m®loc_´štf
(" %#x[%zu..%zu)", 
c0
, 
¿nge0
, 
i
);

388 
¿nge0
 = 
i
;

389 
c0
 = 
pc
[
i
];

392 
	`m®loc_´štf
(" %#x[%zu..%zu)\n", 
c0
, 
¿nge0
, 
i
);

393 
	}
}

395 
boŞ


396 
	$v®id©e_fl
(cÚ¡ *
p
, 
ušt8_t
 
c
, 
size_t
 
off£t
, size_ˆ
Ën
)

398 cÚ¡ 
ušt8_t
 *
pc
 = (cÚ¡ ušt8_ˆ*)
p
;

399 
boŞ
 
”r
;

400 
size_t
 
i
;

402 
i
 = 
off£t
, 
”r
 = 
çl£
; i < off£t+
Ën
; i++) {

403 ià(
pc
[
i
] !ğ
c
)

404 
”r
 = 
Œue
;

407 ià(
”r
)

408 
	`´št_fËd_ex‹Ás
(
p
, 
c
, 
off£t
 + 
Ën
);

410  (
”r
);

411 
	}
}

414 
	$‹¡_z”o
(
size_t
 
szmš
, size_ˆ
szmax
)

416 
æags
 = 
	`MALLOCX_ARENA
(
	`¬’a_šd
()è| 
MALLOCX_ZERO
;

417 
size_t
 
sz
, 
nsz
;

418 *
p
;

419 
	#FILL_BYTE
 0x7aU

	)

421 
sz
 = 
szmax
;

422 
p
 = 
	`m®locx
(
sz
, 
æags
);

423 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

424 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 0x00, 0, 
sz
), "Memory‚ot filled: sz=%zu",

425 
sz
);

431 
	`mem£t
(
p
, 
FILL_BYTE
, 
sz
);

432 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
sz
),

433 "MemÜy‚Ù fËd: sz=%zu", 
sz
);

436 
sz
 = 
szmš
;

437 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sz
, 0, 
æags
), sz,

439 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
sz
),

440 "MemÜy‚Ù fËd: sz=%zu", 
sz
);

442 
sz
 = 
szmš
; sz < 
szmax
; sz = 
nsz
) {

443 
nsz
 = 
	`ÇÎocx
(
sz
+1, 
æags
);

444 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sz
+1, 0, 
æags
), 
nsz
,

446 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
sz
),

447 "MemÜy‚Ù fËd: sz=%zu", 
sz
);

448 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 0x00, 
sz
, 
nsz
-sz),

449 "MemÜy‚Ù fËd: sz=%zu,‚sz-sz=%zu", 
sz
, 
nsz
-sz);

450 
	`mem£t
((*)((
ušŒ_t
)
p
 + 
sz
), 
FILL_BYTE
, 
nsz
-sz);

451 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
nsz
),

452 "MemÜy‚Ù fËd:‚sz=%zu", 
nsz
);

455 
	`d®locx
(
p
, 
æags
);

456 
	}
}

458 
	$TEST_BEGIN
(
‹¡_z”o_Ïrge
)

460 
size_t
 
Ïrge0
, 
Ïrgemax
;

463 
Ïrge0
 = 
	`g‘_Ïrge_size
(0);

464 
Ïrgemax
 = 
	`g‘_Ïrge_size
(
	`g‘_Æ¬ge
()-1);

466 
	`‹¡_z”o
(
Ïrge0
, 
Ïrgemax
);

467 
	}
}

468 
TEST_END


470 
	$TEST_BEGIN
(
‹¡_z”o_huge
)

472 
size_t
 
huge0
, 
huge1
;

475 
huge0
 = 
	`g‘_huge_size
(0);

476 
huge1
 = 
	`g‘_huge_size
(1);

478 
	`‹¡_z”o
(
huge1
, 
huge0
 * 2);

479 
	}
}

480 
TEST_END


483 
	$maš
()

486  (
	`‹¡
(

487 
‹¡_§me_size
,

488 
‹¡_exŒa_no_move
,

489 
‹¡_no_move_ç
,

490 
‹¡_size
,

491 
‹¡_size_exŒa_ov”æow
,

492 
‹¡_exŒa_sm®l
,

493 
‹¡_exŒa_Ïrge
,

494 
‹¡_exŒa_huge
,

495 
‹¡_z”o_Ïrge
,

496 
‹¡_z”o_huge
));

497 
	}
}

	@dep/jemalloc-4.2.0/test/src/SFMT.c

48 
	#SFMT_C_


	)

49 
	~"‹¡/jem®loc_‹¡.h
"

50 
	~"‹¡/SFMT-·¿ms.h
"

52 #ià
defšed
(
JEMALLOC_BIG_ENDIAN
è&& !defšed(
BIG_ENDIAN64
)

53 
	#BIG_ENDIAN64
 1

	)

55 #ià
defšed
(
__BIG_ENDIAN__
è&& !defšed(
__amd64
è&& !defšed(
BIG_ENDIAN64
)

56 
	#BIG_ENDIAN64
 1

	)

58 #ià
defšed
(
HAVE_ALTIVEC
è&& !defšed(
BIG_ENDIAN64
)

59 
	#BIG_ENDIAN64
 1

	)

61 #ià
defšed
(
ONLY64
è&& !defšed(
BIG_ENDIAN64
)

62 #ià
defšed
(
__GNUC__
)

65 #undeà
ONLY64


70 #ià
defšed
(
HAVE_ALTIVEC
)

72 
	uW128_T
 {

73 
veùÜ
 
	ms
;

74 
ušt32_t
 
	mu
[4];

77 
W128_T
 
	tw128_t
;

79 #–ià
defšed
(
HAVE_SSE2
)

81 
	uW128_T
 {

82 
__m128i
 
	msi
;

83 
ušt32_t
 
	mu
[4];

86 
W128_T
 
	tw128_t
;

91 
	sW128_T
 {

92 
ušt32_t
 
	mu
[4];

95 
W128_T
 
	tw128_t
;

99 
	ssfmt_s
 {

101 
w128_t
 
	msfmt
[
N
];

103 
	midx
;

106 
	mš™Ÿlized
;

115 
ušt32_t
 
	g·r™y
[4] = {
PARITY1
, 
PARITY2
, 
PARITY3
, 
PARITY4
};

120 
JEMALLOC_INLINE_C
 
idxof
(
i
);

121 #ià(!
defšed
(
HAVE_ALTIVEC
)è&& (!defšed(
HAVE_SSE2
))

122 
JEMALLOC_INLINE_C
 
rshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
);

123 
JEMALLOC_INLINE_C
 
lshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
);

125 
JEMALLOC_INLINE_C
 
g’_¿nd_®l
(
sfmt_t
 *
ùx
);

126 
JEMALLOC_INLINE_C
 
g’_¿nd_¬¿y
(
sfmt_t
 *
ùx
, 
w128_t
 *
¬¿y
, 
size
);

127 
JEMALLOC_INLINE_C
 
ušt32_t
 
func1
(ušt32_ˆ
x
);

128 
JEMALLOC_INLINE_C
 
ušt32_t
 
func2
(ušt32_ˆ
x
);

129 
³riod_û¹ifiÿtiÚ
(
sfmt_t
 *
ùx
);

130 #ià
defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
)

131 
JEMALLOC_INLINE_C
 
sw­
(
w128_t
 *
¬¿y
, 
size
);

134 #ià
defšed
(
HAVE_ALTIVEC
)

135 
	~"‹¡/SFMT-®ti.h
"

136 #–ià
defšed
(
HAVE_SSE2
)

137 
	~"‹¡/SFMT-s£2.h
"

144 #ifdeà
ONLY64


145 
JEMALLOC_INLINE_C
 
	$idxof
(
i
) {

146  
i
 ^ 1;

147 
	}
}

149 
JEMALLOC_INLINE_C
 
	$idxof
(
i
) {

150  
i
;

151 
	}
}

161 #ià(!
defšed
(
HAVE_ALTIVEC
)è&& (!defšed(
HAVE_SSE2
))

162 #ifdeà
ONLY64


163 
JEMALLOC_INLINE_C
 
	$rshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
) {

164 
ušt64_t
 
th
, 

, 
oh
, 
Ş
;

166 
th
 = ((
ušt64_t
)
š
->
u
[2] << 32) | ((uint64_t)in->u[3]);

167 

 = ((
ušt64_t
)
š
->
u
[0] << 32) | ((uint64_t)in->u[1]);

169 
oh
 = 
th
 >> (
shiá
 * 8);

170 
Ş
 = 

 >> (
shiá
 * 8);

171 
Ş
 |ğ
th
 << (64 - 
shiá
 * 8);

172 
out
->
u
[0] = (
ušt32_t
)(
Ş
 >> 32);

173 
out
->
u
[1] = (
ušt32_t
)
Ş
;

174 
out
->
u
[2] = (
ušt32_t
)(
oh
 >> 32);

175 
out
->
u
[3] = (
ušt32_t
)
oh
;

176 
	}
}

178 
JEMALLOC_INLINE_C
 
	$rshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
) {

179 
ušt64_t
 
th
, 

, 
oh
, 
Ş
;

181 
th
 = ((
ušt64_t
)
š
->
u
[3] << 32) | ((uint64_t)in->u[2]);

182 

 = ((
ušt64_t
)
š
->
u
[1] << 32) | ((uint64_t)in->u[0]);

184 
oh
 = 
th
 >> (
shiá
 * 8);

185 
Ş
 = 

 >> (
shiá
 * 8);

186 
Ş
 |ğ
th
 << (64 - 
shiá
 * 8);

187 
out
->
u
[1] = (
ušt32_t
)(
Ş
 >> 32);

188 
out
->
u
[0] = (
ušt32_t
)
Ş
;

189 
out
->
u
[3] = (
ušt32_t
)(
oh
 >> 32);

190 
out
->
u
[2] = (
ušt32_t
)
oh
;

191 
	}
}

201 #ifdeà
ONLY64


202 
JEMALLOC_INLINE_C
 
	$lshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
) {

203 
ušt64_t
 
th
, 

, 
oh
, 
Ş
;

205 
th
 = ((
ušt64_t
)
š
->
u
[2] << 32) | ((uint64_t)in->u[3]);

206 

 = ((
ušt64_t
)
š
->
u
[0] << 32) | ((uint64_t)in->u[1]);

208 
oh
 = 
th
 << (
shiá
 * 8);

209 
Ş
 = 

 << (
shiá
 * 8);

210 
oh
 |ğ

 >> (64 - 
shiá
 * 8);

211 
out
->
u
[0] = (
ušt32_t
)(
Ş
 >> 32);

212 
out
->
u
[1] = (
ušt32_t
)
Ş
;

213 
out
->
u
[2] = (
ušt32_t
)(
oh
 >> 32);

214 
out
->
u
[3] = (
ušt32_t
)
oh
;

215 
	}
}

217 
JEMALLOC_INLINE_C
 
	$lshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
) {

218 
ušt64_t
 
th
, 

, 
oh
, 
Ş
;

220 
th
 = ((
ušt64_t
)
š
->
u
[3] << 32) | ((uint64_t)in->u[2]);

221 

 = ((
ušt64_t
)
š
->
u
[1] << 32) | ((uint64_t)in->u[0]);

223 
oh
 = 
th
 << (
shiá
 * 8);

224 
Ş
 = 

 << (
shiá
 * 8);

225 
oh
 |ğ

 >> (64 - 
shiá
 * 8);

226 
out
->
u
[1] = (
ušt32_t
)(
Ş
 >> 32);

227 
out
->
u
[0] = (
ušt32_t
)
Ş
;

228 
out
->
u
[3] = (
ušt32_t
)(
oh
 >> 32);

229 
out
->
u
[2] = (
ušt32_t
)
oh
;

230 
	}
}

242 #ià(!
defšed
(
HAVE_ALTIVEC
)è&& (!defšed(
HAVE_SSE2
))

243 #ifdeà
ONLY64


244 
JEMALLOC_INLINE_C
 
	$do_»cursiÚ
(
w128_t
 *
r
, w128_ˆ*
a
, w128_ˆ*
b
, w128_ˆ*
c
,

245 
w128_t
 *
d
) {

246 
w128_t
 
x
;

247 
w128_t
 
y
;

249 
	`lshiá128
(&
x
, 
a
, 
SL2
);

250 
	`rshiá128
(&
y
, 
c
, 
SR2
);

251 
r
->
u
[0] = 
a
->u[0] ^ 
x
.u[0] ^ ((
b
->u[0] >> 
SR1
è& 
MSK2
è^ 
y
.u[0]

252 ^ (
d
->
u
[0] << 
SL1
);

253 
r
->
u
[1] = 
a
->u[1] ^ 
x
.u[1] ^ ((
b
->u[1] >> 
SR1
è& 
MSK1
è^ 
y
.u[1]

254 ^ (
d
->
u
[1] << 
SL1
);

255 
r
->
u
[2] = 
a
->u[2] ^ 
x
.u[2] ^ ((
b
->u[2] >> 
SR1
è& 
MSK4
è^ 
y
.u[2]

256 ^ (
d
->
u
[2] << 
SL1
);

257 
r
->
u
[3] = 
a
->u[3] ^ 
x
.u[3] ^ ((
b
->u[3] >> 
SR1
è& 
MSK3
è^ 
y
.u[3]

258 ^ (
d
->
u
[3] << 
SL1
);

259 
	}
}

261 
JEMALLOC_INLINE_C
 
	$do_»cursiÚ
(
w128_t
 *
r
, w128_ˆ*
a
, w128_ˆ*
b
, w128_ˆ*
c
,

262 
w128_t
 *
d
) {

263 
w128_t
 
x
;

264 
w128_t
 
y
;

266 
	`lshiá128
(&
x
, 
a
, 
SL2
);

267 
	`rshiá128
(&
y
, 
c
, 
SR2
);

268 
r
->
u
[0] = 
a
->u[0] ^ 
x
.u[0] ^ ((
b
->u[0] >> 
SR1
è& 
MSK1
è^ 
y
.u[0]

269 ^ (
d
->
u
[0] << 
SL1
);

270 
r
->
u
[1] = 
a
->u[1] ^ 
x
.u[1] ^ ((
b
->u[1] >> 
SR1
è& 
MSK2
è^ 
y
.u[1]

271 ^ (
d
->
u
[1] << 
SL1
);

272 
r
->
u
[2] = 
a
->u[2] ^ 
x
.u[2] ^ ((
b
->u[2] >> 
SR1
è& 
MSK3
è^ 
y
.u[2]

273 ^ (
d
->
u
[2] << 
SL1
);

274 
r
->
u
[3] = 
a
->u[3] ^ 
x
.u[3] ^ ((
b
->u[3] >> 
SR1
è& 
MSK4
è^ 
y
.u[3]

275 ^ (
d
->
u
[3] << 
SL1
);

276 
	}
}

280 #ià(!
defšed
(
HAVE_ALTIVEC
)è&& (!defšed(
HAVE_SSE2
))

285 
JEMALLOC_INLINE_C
 
	$g’_¿nd_®l
(
sfmt_t
 *
ùx
) {

286 
i
;

287 
w128_t
 *
r1
, *
r2
;

289 
r1
 = &
ùx
->
sfmt
[
N
 - 2];

290 
r2
 = &
ùx
->
sfmt
[
N
 - 1];

291 
i
 = 0; i < 
N
 - 
POS1
; i++) {

292 
	`do_»cursiÚ
(&
ùx
->
sfmt
[
i
], &ùx->sfmt[i], &ùx->sfmt[˜+ 
POS1
], 
r1
,

293 
r2
);

294 
r1
 = 
r2
;

295 
r2
 = &
ùx
->
sfmt
[
i
];

297 ; 
i
 < 
N
; i++) {

298 
	`do_»cursiÚ
(&
ùx
->
sfmt
[
i
], &ùx->sfmt[i], &ùx->sfmt[˜+ 
POS1
 - 
N
], 
r1
,

299 
r2
);

300 
r1
 = 
r2
;

301 
r2
 = &
ùx
->
sfmt
[
i
];

303 
	}
}

312 
JEMALLOC_INLINE_C
 
	$g’_¿nd_¬¿y
(
sfmt_t
 *
ùx
, 
w128_t
 *
¬¿y
, 
size
) {

313 
i
, 
j
;

314 
w128_t
 *
r1
, *
r2
;

316 
r1
 = &
ùx
->
sfmt
[
N
 - 2];

317 
r2
 = &
ùx
->
sfmt
[
N
 - 1];

318 
i
 = 0; i < 
N
 - 
POS1
; i++) {

319 
	`do_»cursiÚ
(&
¬¿y
[
i
], &
ùx
->
sfmt
[i], &ùx->sfmt[˜+ 
POS1
], 
r1
, 
r2
);

320 
r1
 = 
r2
;

321 
r2
 = &
¬¿y
[
i
];

323 ; 
i
 < 
N
; i++) {

324 
	`do_»cursiÚ
(&
¬¿y
[
i
], &
ùx
->
sfmt
[i], &¬¿y[˜+ 
POS1
 - 
N
], 
r1
, 
r2
);

325 
r1
 = 
r2
;

326 
r2
 = &
¬¿y
[
i
];

328 ; 
i
 < 
size
 - 
N
; i++) {

329 
	`do_»cursiÚ
(&
¬¿y
[
i
], &¬¿y[˜- 
N
], &¬¿y[˜+ 
POS1
 - N], 
r1
, 
r2
);

330 
r1
 = 
r2
;

331 
r2
 = &
¬¿y
[
i
];

333 
j
 = 0; j < 2 * 
N
 - 
size
; j++) {

334 
ùx
->
sfmt
[
j
] = 
¬¿y
[j + 
size
 - 
N
];

336 ; 
i
 < 
size
; i++, 
j
++) {

337 
	`do_»cursiÚ
(&
¬¿y
[
i
], &¬¿y[˜- 
N
], &¬¿y[˜+ 
POS1
 - N], 
r1
, 
r2
);

338 
r1
 = 
r2
;

339 
r2
 = &
¬¿y
[
i
];

340 
ùx
->
sfmt
[
j
] = 
¬¿y
[
i
];

342 
	}
}

345 #ià
defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
è&& !defšed(
HAVE_ALTIVEC
)

346 
JEMALLOC_INLINE_C
 
	$sw­
(
w128_t
 *
¬¿y
, 
size
) {

347 
i
;

348 
ušt32_t
 
x
, 
y
;

350 
i
 = 0; i < 
size
; i++) {

351 
x
 = 
¬¿y
[
i
].
u
[0];

352 
y
 = 
¬¿y
[
i
].
u
[2];

353 
¬¿y
[
i
].
u
[0] =‡rray[i].u[1];

354 
¬¿y
[
i
].
u
[2] =‡rray[i].u[3];

355 
¬¿y
[
i
].
u
[1] = 
x
;

356 
¬¿y
[
i
].
u
[3] = 
y
;

358 
	}
}

366 
ušt32_t
 
	$func1
(
ušt32_t
 
x
) {

367  (
x
 ^ (x >> 27)è* (
ušt32_t
)1664525UL;

368 
	}
}

376 
ušt32_t
 
	$func2
(
ušt32_t
 
x
) {

377  (
x
 ^ (x >> 27)è* (
ušt32_t
)1566083941UL;

378 
	}
}

383 
	$³riod_û¹ifiÿtiÚ
(
sfmt_t
 *
ùx
) {

384 
šÃr
 = 0;

385 
i
, 
j
;

386 
ušt32_t
 
wÜk
;

387 
ušt32_t
 *
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

389 
i
 = 0; i < 4; i++)

390 
šÃr
 ^ğ
psfmt32
[
	`idxof
(
i
)] & 
·r™y
[i];

391 
i
 = 16; i > 0; i >>= 1)

392 
šÃr
 ^ğšÃ¸>> 
i
;

393 
šÃr
 &= 1;

395 ià(
šÃr
 == 1) {

399 
i
 = 0; i < 4; i++) {

400 
wÜk
 = 1;

401 
j
 = 0; j < 32; j++) {

402 ià((
wÜk
 & 
·r™y
[
i
]) != 0) {

403 
psfmt32
[
	`idxof
(
i
)] ^ğ
wÜk
;

406 
wÜk
 = work << 1;

409 
	}
}

419 cÚ¡ *
	$g‘_id¡ršg
() {

420  
IDSTR
;

421 
	}
}

428 
	$g‘_mš_¬¿y_size32
() {

429  
N32
;

430 
	}
}

437 
	$g‘_mš_¬¿y_size64
() {

438  
N64
;

439 
	}
}

441 #iâdeà
ONLY64


447 
ušt32_t
 
	$g’_¿nd32
(
sfmt_t
 *
ùx
) {

448 
ušt32_t
 
r
;

449 
ušt32_t
 *
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

451 
	`as£¹
(
ùx
->
š™Ÿlized
);

452 ià(
ùx
->
idx
 >ğ
N32
) {

453 
	`g’_¿nd_®l
(
ùx
);

454 
ùx
->
idx
 = 0;

456 
r
 = 
psfmt32
[
ùx
->
idx
++];

457  
r
;

458 
	}
}

461 
ušt32_t
 
	$g’_¿nd32_¿nge
(
sfmt_t
 *
ùx
, 
ušt32_t
 
lim™
) {

462 
ušt32_t
 
»t
, 
above
;

464 
above
 = 0xffffffffU - (0xffffffffU % 
lim™
);

466 
»t
 = 
	`g’_¿nd32
(
ùx
);

467 ià(
»t
 < 
above
) {

468 
»t
 %ğ
lim™
;

472  
»t
;

473 
	}
}

482 
ušt64_t
 
	$g’_¿nd64
(
sfmt_t
 *
ùx
) {

483 #ià
	`defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
)

484 
ušt32_t
 
r1
, 
r2
;

485 
ušt32_t
 *
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

487 
ušt64_t
 
r
;

488 
ušt64_t
 *
psfmt64
 = (ušt64_ˆ*)&
ùx
->
sfmt
[0].
u
[0];

491 
	`as£¹
(
ùx
->
š™Ÿlized
);

492 
	`as£¹
(
ùx
->
idx
 % 2 == 0);

494 ià(
ùx
->
idx
 >ğ
N32
) {

495 
	`g’_¿nd_®l
(
ùx
);

496 
ùx
->
idx
 = 0;

498 #ià
	`defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
)

499 
r1
 = 
psfmt32
[
ùx
->
idx
];

500 
r2
 = 
psfmt32
[
ùx
->
idx
 + 1];

501 
ùx
->
idx
 += 2;

502  ((
ušt64_t
)
r2
 << 32è| 
r1
;

504 
r
 = 
psfmt64
[
ùx
->
idx
 / 2];

505 
ùx
->
idx
 += 2;

506  
r
;

508 
	}
}

511 
ušt64_t
 
	$g’_¿nd64_¿nge
(
sfmt_t
 *
ùx
, 
ušt64_t
 
lim™
) {

512 
ušt64_t
 
»t
, 
above
;

514 
above
 = 
	`KQU
(0xffffffffffffffffè- (KQU(0xffffffffffffffffè% 
lim™
);

516 
»t
 = 
	`g’_¿nd64
(
ùx
);

517 ià(
»t
 < 
above
) {

518 
»t
 %ğ
lim™
;

522  
»t
;

523 
	}
}

525 #iâdeà
ONLY64


551 
	$fl_¬¿y32
(
sfmt_t
 *
ùx
, 
ušt32_t
 *
¬¿y
, 
size
) {

552 
	`as£¹
(
ùx
->
š™Ÿlized
);

553 
	`as£¹
(
ùx
->
idx
 =ğ
N32
);

554 
	`as£¹
(
size
 % 4 == 0);

555 
	`as£¹
(
size
 >ğ
N32
);

557 
	`g’_¿nd_¬¿y
(
ùx
, (
w128_t
 *)
¬¿y
, 
size
 / 4);

558 
ùx
->
idx
 = 
N32
;

559 
	}
}

587 
	$fl_¬¿y64
(
sfmt_t
 *
ùx
, 
ušt64_t
 *
¬¿y
, 
size
) {

588 
	`as£¹
(
ùx
->
š™Ÿlized
);

589 
	`as£¹
(
ùx
->
idx
 =ğ
N32
);

590 
	`as£¹
(
size
 % 2 == 0);

591 
	`as£¹
(
size
 >ğ
N64
);

593 
	`g’_¿nd_¬¿y
(
ùx
, (
w128_t
 *)
¬¿y
, 
size
 / 2);

594 
ùx
->
idx
 = 
N32
;

596 #ià
	`defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
)

597 
	`sw­
((
w128_t
 *)
¬¿y
, 
size
 /2);

599 
	}
}

607 
sfmt_t
 *
	$š™_g’_¿nd
(
ušt32_t
 
£ed
) {

608 *
p
;

609 
sfmt_t
 *
ùx
;

610 
i
;

611 
ušt32_t
 *
psfmt32
;

613 ià(
	`posix_mem®ign
(&
p
, (
w128_t
), (
sfmt_t
)) != 0) {

614  
NULL
;

616 
ùx
 = (
sfmt_t
 *)
p
;

617 
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

619 
psfmt32
[
	`idxof
(0)] = 
£ed
;

620 
i
 = 1; i < 
N32
; i++) {

621 
psfmt32
[
	`idxof
(
i
)] = 1812433253UL * (psfmt32[idxof(i - 1)]

622 ^ (
psfmt32
[
	`idxof
(
i
 - 1)] >> 30))

623 + 
i
;

625 
ùx
->
idx
 = 
N32
;

626 
	`³riod_û¹ifiÿtiÚ
(
ùx
);

627 
ùx
->
š™Ÿlized
 = 1;

629  
ùx
;

630 
	}
}

638 
sfmt_t
 *
	$š™_by_¬¿y
(
ušt32_t
 *
š™_key
, 
key_Ëngth
) {

639 *
p
;

640 
sfmt_t
 *
ùx
;

641 
i
, 
j
, 
couÁ
;

642 
ušt32_t
 
r
;

643 
Ïg
;

644 
mid
;

645 
size
 = 
N
 * 4;

646 
ušt32_t
 *
psfmt32
;

648 ià(
	`posix_mem®ign
(&
p
, (
w128_t
), (
sfmt_t
)) != 0) {

649  
NULL
;

651 
ùx
 = (
sfmt_t
 *)
p
;

652 
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

654 ià(
size
 >= 623) {

655 
Ïg
 = 11;

656 } ià(
size
 >= 68) {

657 
Ïg
 = 7;

658 } ià(
size
 >= 39) {

659 
Ïg
 = 5;

661 
Ïg
 = 3;

663 
mid
 = (
size
 - 
Ïg
) / 2;

665 
	`mem£t
(
ùx
->
sfmt
, 0x8b, (ctx->sfmt));

666 ià(
key_Ëngth
 + 1 > 
N32
) {

667 
couÁ
 = 
key_Ëngth
 + 1;

669 
couÁ
 = 
N32
;

671 
r
 = 
	`func1
(
psfmt32
[
	`idxof
(0)] ^…sfmt32[idxof(
mid
)]

672 ^ 
psfmt32
[
	`idxof
(
N32
 - 1)]);

673 
psfmt32
[
	`idxof
(
mid
)] +ğ
r
;

674 
r
 +ğ
key_Ëngth
;

675 
psfmt32
[
	`idxof
(
mid
 + 
Ïg
)] +ğ
r
;

676 
psfmt32
[
	`idxof
(0)] = 
r
;

678 
couÁ
--;

679 
i
 = 1, 
j
 = 0; (j < 
couÁ
è&& (j < 
key_Ëngth
); j++) {

680 
r
 = 
	`func1
(
psfmt32
[
	`idxof
(
i
)] ^…sfmt32[idxof((˜+ 
mid
è% 
N32
)]

681 ^ 
psfmt32
[
	`idxof
((
i
 + 
N32
 - 1) % N32)]);

682 
psfmt32
[
	`idxof
((
i
 + 
mid
è% 
N32
)] +ğ
r
;

683 
r
 +ğ
š™_key
[
j
] + 
i
;

684 
psfmt32
[
	`idxof
((
i
 + 
mid
 + 
Ïg
è% 
N32
)] +ğ
r
;

685 
psfmt32
[
	`idxof
(
i
)] = 
r
;

686 
i
 = (˜+ 1è% 
N32
;

688 ; 
j
 < 
couÁ
; j++) {

689 
r
 = 
	`func1
(
psfmt32
[
	`idxof
(
i
)] ^…sfmt32[idxof((˜+ 
mid
è% 
N32
)]

690 ^ 
psfmt32
[
	`idxof
((
i
 + 
N32
 - 1) % N32)]);

691 
psfmt32
[
	`idxof
((
i
 + 
mid
è% 
N32
)] +ğ
r
;

692 
r
 +ğ
i
;

693 
psfmt32
[
	`idxof
((
i
 + 
mid
 + 
Ïg
è% 
N32
)] +ğ
r
;

694 
psfmt32
[
	`idxof
(
i
)] = 
r
;

695 
i
 = (˜+ 1è% 
N32
;

697 
j
 = 0; j < 
N32
; j++) {

698 
r
 = 
	`func2
(
psfmt32
[
	`idxof
(
i
)] +…sfmt32[idxof((˜+ 
mid
è% 
N32
)]

699 + 
psfmt32
[
	`idxof
((
i
 + 
N32
 - 1) % N32)]);

700 
psfmt32
[
	`idxof
((
i
 + 
mid
è% 
N32
)] ^ğ
r
;

701 
r
 -ğ
i
;

702 
psfmt32
[
	`idxof
((
i
 + 
mid
 + 
Ïg
è% 
N32
)] ^ğ
r
;

703 
psfmt32
[
	`idxof
(
i
)] = 
r
;

704 
i
 = (˜+ 1è% 
N32
;

707 
ùx
->
idx
 = 
N32
;

708 
	`³riod_û¹ifiÿtiÚ
(
ùx
);

709 
ùx
->
š™Ÿlized
 = 1;

711  
ùx
;

712 
	}
}

714 
	$fši_g’_¿nd
(
sfmt_t
 *
ùx
) {

715 
	`as£¹
(
ùx
 !ğ
NULL
);

717 
ùx
->
š™Ÿlized
 = 0;

718 
	`ä“
(
ùx
);

719 
	}
}

	@dep/jemalloc-4.2.0/test/src/btalloc.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	$bÎoc
(
size_t
 
size
, 
b™s
)

7  (
	`bÎoc_0
(
size
, 
b™s
));

8 
	}
}

	@dep/jemalloc-4.2.0/test/src/btalloc_0.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
bÎoc_n_g’
(0)

	@dep/jemalloc-4.2.0/test/src/btalloc_1.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
bÎoc_n_g’
(1)

	@dep/jemalloc-4.2.0/test/src/math.c

1 
	#MATH_C_


	)

2 
	~"‹¡/jem®loc_‹¡.h
"

	@dep/jemalloc-4.2.0/test/src/mq.c

1 
	~"‹¡/jem®loc_‹¡.h
"

8 
	$mq_Çno¦“p
(
ns
)

11 
	`as£¹
(
ns
 <= 1000*1000*1000);

13 #ifdeà
_WIN32


14 
	`SË•
(
ns
 / 1000);

17 
time¥ec
 
timeout
;

19 ià(
ns
 < 1000*1000*1000) {

20 
timeout
.
tv_£c
 = 0;

21 
timeout
.
tv_n£c
 = 
ns
;

23 
timeout
.
tv_£c
 = 1;

24 
timeout
.
tv_n£c
 = 0;

26 
	`Çno¦“p
(&
timeout
, 
NULL
);

29 
	}
}

	@dep/jemalloc-4.2.0/test/src/mtx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #iâdeà
_CRT_SPINCOUNT


4 
	#_CRT_SPINCOUNT
 4000

	)

7 
boŞ


8 
	$mtx_š™
(
mtx_t
 *
mtx
)

11 #ifdeà
_WIN32


12 ià(!
	`In™ŸlizeCr™iÿlSeùiÚAndSpšCouÁ
(&
mtx
->
lock
, 
_CRT_SPINCOUNT
))

13  (
Œue
);

14 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

15 
mtx
->
lock
 = 0;

17 
±h»ad_mu‹x©Œ_t
 
©Œ
;

19 ià(
	`±h»ad_mu‹x©Œ_š™
(&
©Œ
) != 0)

20  (
Œue
);

21 
	`±h»ad_mu‹x©Œ_£‰y³
(&
©Œ
, 
PTHREAD_MUTEX_DEFAULT
);

22 ià(
	`±h»ad_mu‹x_š™
(&
mtx
->
lock
, &
©Œ
) != 0) {

23 
	`±h»ad_mu‹x©Œ_de¡roy
(&
©Œ
);

24  (
Œue
);

26 
	`±h»ad_mu‹x©Œ_de¡roy
(&
©Œ
);

28  (
çl£
);

29 
	}
}

32 
	$mtx_fši
(
mtx_t
 *
mtx
)

35 #ifdeà
_WIN32


36 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

38 
	`±h»ad_mu‹x_de¡roy
(&
mtx
->
lock
);

40 
	}
}

43 
	$mtx_lock
(
mtx_t
 *
mtx
)

46 #ifdeà
_WIN32


47 
	`EÁ”Cr™iÿlSeùiÚ
(&
mtx
->
lock
);

48 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

49 
	`OSSpšLockLock
(&
mtx
->
lock
);

51 
	`±h»ad_mu‹x_lock
(&
mtx
->
lock
);

53 
	}
}

56 
	$mtx_uÆock
(
mtx_t
 *
mtx
)

59 #ifdeà
_WIN32


60 
	`L—veCr™iÿlSeùiÚ
(&
mtx
->
lock
);

61 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

62 
	`OSSpšLockUÆock
(&
mtx
->
lock
);

64 
	`±h»ad_mu‹x_uÆock
(&
mtx
->
lock
);

66 
	}
}

	@dep/jemalloc-4.2.0/test/src/test.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	g‹¡_couÁ
 = 0;

4 
‹¡_¡©us_t
 
	g‹¡_couÁs
[
‹¡_¡©us_couÁ
] = {0, 0, 0};

5 
‹¡_¡©us_t
 
	g‹¡_¡©us
 = 
‹¡_¡©us_·ss
;

6 cÚ¡ * 
	g‹¡_Çme
 = "";

8 
	$JEMALLOC_FORMAT_PRINTF
(1, 2)

10 
	$‹¡_sk
(cÚ¡ *
fÜm©
, ...)

12 
va_li¡
 
­
;

14 
	`va_¡¬t
(
­
, 
fÜm©
);

15 
	`m®loc_vırštf
(
NULL
, NULL, 
fÜm©
, 
­
);

16 
	`va_’d
(
­
);

17 
	`m®loc_´štf
("\n");

18 
‹¡_¡©us
 = 
‹¡_¡©us_sk
;

19 
	}
}

21 
	$JEMALLOC_FORMAT_PRINTF
(1, 2)

23 
	$‹¡_ç
(cÚ¡ *
fÜm©
, ...)

25 
va_li¡
 
­
;

27 
	`va_¡¬t
(
­
, 
fÜm©
);

28 
	`m®loc_vırštf
(
NULL
, NULL, 
fÜm©
, 
­
);

29 
	`va_’d
(
­
);

30 
	`m®loc_´štf
("\n");

31 
‹¡_¡©us
 = 
‹¡_¡©us_ç
;

32 
	}
}

35 
	$‹¡_¡©us_¡ršg
(
‹¡_¡©us_t
 
‹¡_¡©us
)

38 
‹¡_¡©us
) {

39 
‹¡_¡©us_·ss
:  "pass";

40 
‹¡_¡©us_sk
:  "skip";

41 
‹¡_¡©us_ç
:  "fail";

42 : 
	`nÙ_»ached
();

44 
	}
}

47 
	$p_‹¡_š™
(cÚ¡ *
Çme
)

50 
‹¡_couÁ
++;

51 
‹¡_¡©us
 = 
‹¡_¡©us_·ss
;

52 
‹¡_Çme
 = 
Çme
;

53 
	}
}

56 
	$p_‹¡_fši
()

59 
‹¡_couÁs
[
‹¡_¡©us
]++;

60 
	`m®loc_´štf
("%s: %s\n", 
‹¡_Çme
, 
	`‹¡_¡©us_¡ršg
(
‹¡_¡©us
));

61 
	}
}

63 
‹¡_¡©us_t


64 
	$p_‹¡_im¶
(
boŞ
 
do_m®loc_š™
, 
‹¡_t
 *
t
, 
va_li¡
 
­
)

66 
‹¡_¡©us_t
 
»t
;

68 ià(
do_m®loc_š™
) {

75 ià(
	`ÇÎocx
(1, 0) == 0) {

76 
	`m®loc_´štf
("Initializationƒrror");

77  (
‹¡_¡©us_ç
);

81 
»t
 = 
‹¡_¡©us_·ss
;

82 ; 
t
 !ğ
NULL
; = 
	`va_¬g
(
­
, 
‹¡_t
 *)) {

83 
	`t
();

84 ià(
‹¡_¡©us
 > 
»t
)

85 
»t
 = 
‹¡_¡©us
;

88 
	`m®loc_´štf
("--- %s: %u/%u, %s: %u/%u, %s: %u/%u ---\n",

89 
	`‹¡_¡©us_¡ršg
(
‹¡_¡©us_·ss
),

90 
‹¡_couÁs
[
‹¡_¡©us_·ss
], 
‹¡_couÁ
,

91 
	`‹¡_¡©us_¡ršg
(
‹¡_¡©us_sk
),

92 
‹¡_couÁs
[
‹¡_¡©us_sk
], 
‹¡_couÁ
,

93 
	`‹¡_¡©us_¡ršg
(
‹¡_¡©us_ç
),

94 
‹¡_couÁs
[
‹¡_¡©us_ç
], 
‹¡_couÁ
);

96  (
»t
);

97 
	}
}

99 
‹¡_¡©us_t


100 
	$p_‹¡
(
‹¡_t
 *
t
, ...)

102 
‹¡_¡©us_t
 
»t
;

103 
va_li¡
 
­
;

105 
»t
 = 
‹¡_¡©us_·ss
;

106 
	`va_¡¬t
(
­
, 
t
);

107 
»t
 = 
	`p_‹¡_im¶
(
Œue
, 
t
, 
­
);

108 
	`va_’d
(
­
);

110  (
»t
);

111 
	}
}

113 
‹¡_¡©us_t


114 
	$p_‹¡_no_m®loc_š™
(
‹¡_t
 *
t
, ...)

116 
‹¡_¡©us_t
 
»t
;

117 
va_li¡
 
­
;

119 
»t
 = 
‹¡_¡©us_·ss
;

120 
	`va_¡¬t
(
­
, 
t
);

121 
»t
 = 
	`p_‹¡_im¶
(
çl£
, 
t
, 
­
);

122 
	`va_’d
(
­
);

124  (
»t
);

125 
	}
}

128 
	$p_‹¡_ç
(cÚ¡ *
´efix
, cÚ¡ *
mes§ge
)

131 
	`m®loc_ırštf
(
NULL
, NULL, "%s%s\n", 
´efix
, 
mes§ge
);

132 
‹¡_¡©us
 = 
‹¡_¡©us_ç
;

133 
	}
}

	@dep/jemalloc-4.2.0/test/src/thd.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
_WIN32


5 
	$thd_ü—‹
(
thd_t
 *
thd
, *(*
´oc
)(*), *
¬g
)

7 
LPTHREAD_START_ROUTINE
 
routše
 = (LPTHREAD_START_ROUTINE)
´oc
;

8 *
thd
 = 
	`C»©eTh»ad
(
NULL
, 0, 
routše
, 
¬g
, 0, NULL);

9 ià(*
thd
 =ğ
NULL
)

10 
	`‹¡_ç
("Error in CreateThread()\n");

11 
	}
}

14 
	$thd_još
(
thd_t
 
thd
, **
»t
)

17 ià(
	`Wa™FÜSšgËObjeù
(
thd
, 
INFINITE
è=ğ
WAIT_OBJECT_0
 && 
»t
) {

18 
DWORD
 
ex™_code
;

19 
	`G‘Ex™CodeTh»ad
(
thd
, (
LPDWORD
è&
ex™_code
);

20 *
»t
 = (*)(
ušŒ_t
)
ex™_code
;

22 
	}
}

26 
	$thd_ü—‹
(
thd_t
 *
thd
, *(*
´oc
)(*), *
¬g
)

29 ià(
	`±h»ad_ü—‹
(
thd
, 
NULL
, 
´oc
, 
¬g
) != 0)

30 
	`‹¡_ç
("Error in…thread_create()\n");

31 
	}
}

34 
	$thd_još
(
thd_t
 
thd
, **
»t
)

37 
	`±h»ad_još
(
thd
, 
»t
);

38 
	}
}

	@dep/jemalloc-4.2.0/test/src/timer.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	$tim”_¡¬t
(
timed–_t
 *
tim”
)

7 
	`n¡ime_š™
(&
tim”
->
t0
, 0);

8 
	`n¡ime_upd©e
(&
tim”
->
t0
);

9 
	}
}

12 
	$tim”_¡İ
(
timed–_t
 *
tim”
)

15 
	`n¡ime_cİy
(&
tim”
->
t1
, &tim”->
t0
);

16 
	`n¡ime_upd©e
(&
tim”
->
t1
);

17 
	}
}

19 
ušt64_t


20 
	$tim”_u£c
(cÚ¡ 
timed–_t
 *
tim”
)

22 
n¡ime_t
 
d–
;

24 
	`n¡ime_cİy
(&
d–
, &
tim”
->
t1
);

25 
	`n¡ime_subŒaù
(&
d–
, &
tim”
->
t0
);

26  (
	`n¡ime_ns
(&
d–
) / 1000);

27 
	}
}

30 
	$tim”_¿tio
(
timed–_t
 *
a
,imed–_ˆ*
b
, *
buf
, 
size_t
 
buæ’
)

32 
ušt64_t
 
t0
 = 
	`tim”_u£c
(
a
);

33 
ušt64_t
 
t1
 = 
	`tim”_u£c
(
b
);

34 
ušt64_t
 
muÉ
;

35 
size_t
 
i
 = 0;

36 
size_t
 
j
, 
n
;

39 
n
 = 
	`m®loc_¢´štf
(&
buf
[
i
], 
buæ’
-i, "%"
FMTu64
, 
t0
 / 
t1
);

40 
i
 +ğ
n
;

41 ià(
i
 >ğ
buæ’
)

43 
muÉ
 = 1;

44 
j
 = 0; j < 
n
; j++)

45 
muÉ
 *= 10;

48 
n
 = 
	`m®loc_¢´štf
(&
buf
[
i
], 
buæ’
-i, ".");

49 
i
 +ğ
n
;

52 
i
 < 
buæ’
-1) {

53 
ušt64_t
 
round
 = (
i
+1 =ğ
buæ’
-1 && ((
t0
 * 
muÉ
 * 10 / 
t1
) % 10

55 
n
 = 
	`m®loc_¢´štf
(&
buf
[
i
], 
buæ’
-i,

56 "%"
FMTu64
, (
t0
 * 
muÉ
 / 
t1
è% 10 + 
round
);

57 
i
 +ğ
n
;

58 
muÉ
 *= 10;

60 
	}
}

	@dep/jemalloc-4.2.0/test/stress/microbench.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
JEMALLOC_INLINE_C
 

4 
	$time_func
(
timed–_t
 *
tim”
, 
ušt64_t
 
nw¬mup
, ušt64_ˆ
n™”
,

5 (*
func
)())

7 
ušt64_t
 
i
;

9 
i
 = 0; i < 
nw¬mup
; i++)

10 
	`func
();

11 
	`tim”_¡¬t
(
tim”
);

12 
i
 = 0; i < 
n™”
; i++)

13 
	`func
();

14 
	`tim”_¡İ
(
tim”
);

15 
	}
}

18 
com·»_funcs
(
ušt64_t
 
nw¬mup
, ušt64_ˆ
n™”
, cÚ¡ *
Çme_a
,

19 (*
func_a
), cÚ¡ *
Çme_b
, (*
func_b
))

21 
timed–_t
 
tim”_a
, 
tim”_b
;

22 
¿tio_buf
[6];

23 *
p
;

25 
p
 = 
	`m®locx
(1, 0);

26 ià(
p
 =ğ
NULL
) {

27 
	`‹¡_ç
("Unexpected mallocx() failure");

31 
	`time_func
(&
tim”_a
, 
nw¬mup
, 
n™”
, 
func_a
);

32 
	`time_func
(&
tim”_b
, 
nw¬mup
, 
n™”
, 
func_b
);

34 
	`tim”_¿tio
(&
tim”_a
, &
tim”_b
, 
¿tio_buf
, (ratio_buf));

35 
	`m®loc_´štf
("%"
FMTu64
" iterations, %s=%"FMTu64"us, "

36 "%s=%"
FMTu64
"us,„atio=1:%s\n",

37 
n™”
, 
Çme_a
, 
	`tim”_u£c
(&
tim”_a
), 
Çme_b
,im”_u£c(&
tim”_b
),

38 
¿tio_buf
);

40 
	`d®locx
(
p
, 0);

41 
	}
}

44 
	$m®loc_ä“
()

47 *
p
 = 
	`m®loc
(1);

48 ià(
p
 =ğ
NULL
) {

49 
	`‹¡_ç
("Unexpected malloc() failure");

52 
	`ä“
(
p
);

53 
	}
}

56 
	$m®locx_ä“
()

58 *
p
 = 
	`m®locx
(1, 0);

59 ià(
p
 =ğ
NULL
) {

60 
	`‹¡_ç
("Unexpected mallocx() failure");

63 
	`ä“
(
p
);

64 
	}
}

66 
	$TEST_BEGIN
(
‹¡_m®loc_vs_m®locx
)

69 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "malloc",

70 
m®loc_ä“
, "m®locx", 
m®locx_ä“
);

71 
	}
}

72 
TEST_END


75 
	$m®loc_d®locx
()

77 *
p
 = 
	`m®loc
(1);

78 ià(
p
 =ğ
NULL
) {

79 
	`‹¡_ç
("Unexpected malloc() failure");

82 
	`d®locx
(
p
, 0);

83 
	}
}

86 
	$m®loc_sd®locx
()

88 *
p
 = 
	`m®loc
(1);

89 ià(
p
 =ğ
NULL
) {

90 
	`‹¡_ç
("Unexpected malloc() failure");

93 
	`sd®locx
(
p
, 1, 0);

94 
	}
}

96 
	$TEST_BEGIN
(
‹¡_ä“_vs_d®locx
)

99 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "ä“", 
m®loc_ä“
,

100 "d®locx", 
m®loc_d®locx
);

101 
	}
}

102 
TEST_END


104 
	$TEST_BEGIN
(
‹¡_d®locx_vs_sd®locx
)

107 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "d®locx", 
m®loc_d®locx
,

108 "sd®locx", 
m®loc_sd®locx
);

109 
	}
}

110 
TEST_END


113 
	$m®loc_mus_ä“
()

115 *
p
;

117 
p
 = 
	`m®loc
(1);

118 ià(
p
 =ğ
NULL
) {

119 
	`‹¡_ç
("Unexpected malloc() failure");

122 
	`m®loc_u§bË_size
(
p
);

123 
	`ä“
(
p
);

124 
	}
}

127 
	$m®loc_§Îocx_ä“
()

129 *
p
;

131 
p
 = 
	`m®loc
(1);

132 ià(
p
 =ğ
NULL
) {

133 
	`‹¡_ç
("Unexpected malloc() failure");

136 ià(
	`§Îocx
(
p
, 0) < 1)

137 
	`‹¡_ç
("Unexpected sallocx() failure");

138 
	`ä“
(
p
);

139 
	}
}

141 
	$TEST_BEGIN
(
‹¡_mus_vs_§Îocx
)

144 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "malloc_usable_size",

145 
m®loc_mus_ä“
, "§Îocx", 
m®loc_§Îocx_ä“
);

146 
	}
}

147 
TEST_END


150 
	$m®loc_ÇÎocx_ä“
()

152 *
p
;

154 
p
 = 
	`m®loc
(1);

155 ià(
p
 =ğ
NULL
) {

156 
	`‹¡_ç
("Unexpected malloc() failure");

159 ià(
	`ÇÎocx
(1, 0) < 1)

160 
	`‹¡_ç
("Unexpected‚allocx() failure");

161 
	`ä“
(
p
);

162 
	}
}

164 
	$TEST_BEGIN
(
‹¡_§Îocx_vs_ÇÎocx
)

167 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "sallocx",

168 
m®loc_§Îocx_ä“
, "ÇÎocx", 
m®loc_ÇÎocx_ä“
);

169 
	}
}

170 
TEST_END


173 
	$maš
()

176  (
	`‹¡
(

177 
‹¡_m®loc_vs_m®locx
,

178 
‹¡_ä“_vs_d®locx
,

179 
‹¡_d®locx_vs_sd®locx
,

180 
‹¡_mus_vs_§Îocx
,

181 
‹¡_§Îocx_vs_ÇÎocx
));

182 
	}
}

	@dep/jemalloc-4.2.0/test/unit/SFMT.c

36 
	~"‹¡/jem®loc_‹¡.h
"

38 
	#BLOCK_SIZE
 10000

	)

39 
	#BLOCK_SIZE64
 (
BLOCK_SIZE
 / 2)

	)

40 
	#COUNT_1
 1000

	)

41 
	#COUNT_2
 700

	)

43 cÚ¡ 
ušt32_t
 
	gš™_g’_¿nd_32_ex³ùed
[] = {

245 cÚ¡ 
ušt32_t
 
	gš™_by_¬¿y_32_ex³ùed
[] = {

447 cÚ¡ 
ušt64_t
 
	gš™_g’_¿nd_64_ex³ùed
[] = {

448 
KQU
(16924766246869039260), KQU( 8201438687333352714),

449 
KQU
( 2265290287015001750), KQU(18397264611805473832),

450 
KQU
( 3375255223302384358), KQU( 6345559975416828796),

451 
KQU
(18229739242790328073), KQU( 7596792742098800905),

452 
KQU
( 255338647169685981), KQU( 2052747240048610300),

453 
KQU
(18328151576097299343), KQU(12472905421133796567),

454 
KQU
(11315245349717600863), KQU(16594110197775871209),

455 
KQU
(15708751964632456450), KQU(10452031272054632535),

456 
KQU
(11097646720811454386), KQU( 4556090668445745441),

457 
KQU
(17116187693090663106), KQU(14931526836144510645),

458 
KQU
( 9190752218020552591), KQU( 9625800285771901401),

459 
KQU
(13995141077659972832), KQU( 5194209094927829625),

460 
KQU
( 4156788379151063303), KQU( 8523452593770139494),

461 
KQU
(14082382103049296727), KQU( 2462601863986088483),

462 
KQU
( 3030583461592840678), KQU( 5221622077872827681),

463 
KQU
( 3084210671228981236), KQU(13956758381389953823),

464 
KQU
(13503889856213423831), KQU(15696904024189836170),

465 
KQU
( 4612584152877036206), KQU( 6231135538447867881),

466 
KQU
(10172457294158869468), KQU( 6452258628466708150),

467 
KQU
(14044432824917330221), KQU( 370168364480044279),

468 
KQU
(10102144686427193359), KQU( 667870489994776076),

469 
KQU
( 2732271956925885858), KQU(18027788905977284151),

470 
KQU
(15009842788582923859), KQU( 7136357960180199542),

471 
KQU
(15901736243475578127), KQU(16951293785352615701),

472 
KQU
(10551492125243691632), KQU(17668869969146434804),

473 
KQU
(13646002971174390445), KQU( 9804471050759613248),

474 
KQU
( 5511670439655935493), KQU(18103342091070400926),

475 
KQU
(17224512747665137533), KQU(15534627482992618168),

476 
KQU
( 1423813266186582647), KQU(15821176807932930024),

477 
KQU
( 30323369733607156), KQU(11599382494723479403),

478 
KQU
( 653856076586810062), KQU( 3176437395144899659),

479 
KQU
(14028076268147963917), KQU(16156398271809666195),

480 
KQU
( 3166955484848201676), KQU( 5746805620136919390),

481 
KQU
(17297845208891256593), KQU(11691653183226428483),

482 
KQU
(17900026146506981577), KQU(15387382115755971042),

483 
KQU
(16923567681040845943), KQU( 8039057517199388606),

484 
KQU
(11748409241468629263), KQU( 794358245539076095),

485 
KQU
(13438501964693401242), KQU(14036803236515618962),

486 
KQU
( 5252311215205424721), KQU(17806589612915509081),

487 
KQU
( 6802767092397596006), KQU(14212120431184557140),

488 
KQU
( 1072951366761385712), KQU(13098491780722836296),

489 
KQU
( 9466676828710797353), KQU(12673056849042830081),

490 
KQU
(12763726623645357580), KQU(16468961652999309493),

491 
KQU
(15305979875636438926), KQU(17444713151223449734),

492 
KQU
( 5692214267627883674), KQU(13049589139196151505),

493 
KQU
( 880115207831670745), KQU( 1776529075789695498),

494 
KQU
(16695225897801466485), KQU(10666901778795346845),

495 
KQU
( 6164389346722833869), KQU( 2863817793264300475),

496 
KQU
( 9464049921886304754), KQU( 3993566636740015468),

497 
KQU
( 9983749692528514136), KQU(16375286075057755211),

498 
KQU
(16042643417005440820), KQU(11445419662923489877),

499 
KQU
( 7999038846885158836), KQU( 6721913661721511535),

500 
KQU
( 5363052654139357320), KQU( 1817788761173584205),

501 
KQU
(13290974386445856444), KQU( 4650350818937984680),

502 
KQU
( 8219183528102484836), KQU( 1569862923500819899),

503 
KQU
( 4189359732136641860), KQU(14202822961683148583),

504 
KQU
( 4457498315309429058), KQU(13089067387019074834),

505 
KQU
(11075517153328927293), KQU(10277016248336668389),

506 
KQU
( 7070509725324401122), KQU(17808892017780289380),

507 
KQU
(13143367339909287349), KQU( 1377743745360085151),

508 
KQU
( 5749341807421286485), KQU(14832814616770931325),

509 
KQU
( 7688820635324359492), KQU(10960474011539770045),

510 
KQU
( 81970066653179790), KQU(12619476072607878022),

511 
KQU
( 4419566616271201744), KQU(15147917311750568503),

512 
KQU
( 5549739182852706345), KQU( 7308198397975204770),

513 
KQU
(13580425496671289278), KQU(17070764785210130301),

514 
KQU
( 8202832846285604405), KQU( 6873046287640887249),

515 
KQU
( 6927424434308206114), KQU( 6139014645937224874),

516 
KQU
(10290373645978487639), KQU(15904261291701523804),

517 
KQU
( 9628743442057826883), KQU(18383429096255546714),

518 
KQU
( 4977413265753686967), KQU( 7714317492425012869),

519 
KQU
( 9025232586309926193), KQU(14627338359776709107),

520 
KQU
(14759849896467790763), KQU(10931129435864423252),

521 
KQU
( 4588456988775014359), KQU(10699388531797056724),

522 
KQU
( 468652268869238792), KQU( 5755943035328078086),

523 
KQU
( 2102437379988580216), KQU( 9986312786506674028),

524 
KQU
( 2654207180040945604), KQU( 8726634790559960062),

525 
KQU
( 100497234871808137), KQU( 2800137176951425819),

526 
KQU
( 6076627612918553487), KQU( 5780186919186152796),

527 
KQU
( 8179183595769929098), KQU( 6009426283716221169),

528 
KQU
( 2796662551397449358), KQU( 1756961367041986764),

529 
KQU
( 6972897917355606205), KQU(14524774345368968243),

530 
KQU
( 2773529684745706940), KQU( 4853632376213075959),

531 
KQU
( 4198177923731358102), KQU( 8271224913084139776),

532 
KQU
( 2741753121611092226), KQU(16782366145996731181),

533 
KQU
(15426125238972640790), KQU(13595497100671260342),

534 
KQU
( 3173531022836259898), KQU( 6573264560319511662),

535 
KQU
(18041111951511157441), KQU( 2351433581833135952),

536 
KQU
( 3113255578908173487), KQU( 1739371330877858784),

537 
KQU
(16046126562789165480), KQU( 8072101652214192925),

538 
KQU
(15267091584090664910), KQU( 9309579200403648940),

539 
KQU
( 5218892439752408722), KQU(14492477246004337115),

540 
KQU
(17431037586679770619), KQU( 7385248135963250480),

541 
KQU
( 9580144956565560660), KQU( 4919546228040008720),

542 
KQU
(15261542469145035584), KQU(18233297270822253102),

543 
KQU
( 5453248417992302857), KQU( 9309519155931460285),

544 
KQU
(10342813012345291756), KQU(15676085186784762381),

545 
KQU
(15912092950691300645), KQU( 9371053121499003195),

546 
KQU
( 9897186478226866746), KQU(14061858287188196327),

547 
KQU
( 122575971620788119), KQU(12146750969116317754),

548 
KQU
( 4438317272813245201), KQU( 8332576791009527119),

549 
KQU
(13907785691786542057), KQU(10374194887283287467),

550 
KQU
( 2098798755649059566), KQU( 3416235197748288894),

551 
KQU
( 8688269957320773484), KQU( 7503964602397371571),

552 
KQU
(16724977015147478236), KQU( 9461512855439858184),

553 
KQU
(13259049744534534727), KQU( 3583094952542899294),

554 
KQU
( 8764245731305528292), KQU(13240823595462088985),

555 
KQU
(13716141617617910448), KQU(18114969519935960955),

556 
KQU
( 2297553615798302206), KQU( 4585521442944663362),

557 
KQU
(17776858680630198686), KQU( 4685873229192163363),

558 
KQU
( 152558080671135627), KQU(15424900540842670088),

559 
KQU
(13229630297130024108), KQU(17530268788245718717),

560 
KQU
(16675633913065714144), KQU( 3158912717897568068),

561 
KQU
(15399132185380087288), KQU( 7401418744515677872),

562 
KQU
(13135412922344398535), KQU( 6385314346100509511),

563 
KQU
(13962867001134161139), KQU(10272780155442671999),

564 
KQU
(12894856086597769142), KQU(13340877795287554994),

565 
KQU
(12913630602094607396), KQU(12543167911119793857),

566 
KQU
(17343570372251873096), KQU(10959487764494150545),

567 
KQU
( 6966737953093821128), KQU(13780699135496988601),

568 
KQU
( 4405070719380142046), KQU(14923788365607284982),

569 
KQU
( 2869487678905148380), KQU( 6416272754197188403),

570 
KQU
(15017380475943612591), KQU( 1995636220918429487),

571 
KQU
( 3402016804620122716), KQU(15800188663407057080),

572 
KQU
(11362369990390932882), KQU(15262183501637986147),

573 
KQU
(10239175385387371494), KQU( 9352042420365748334),

574 
KQU
( 1682457034285119875), KQU( 1724710651376289644),

575 
KQU
( 2038157098893817966), KQU( 9897825558324608773),

576 
KQU
( 1477666236519164736), KQU(16835397314511233640),

577 
KQU
(10370866327005346508), KQU(10157504370660621982),

578 
KQU
(12113904045335882069), KQU(13326444439742783008),

579 
KQU
(11302769043000765804), KQU(13594979923955228484),

580 
KQU
(11779351762613475968), KQU( 3786101619539298383),

581 
KQU
( 8021122969180846063), KQU(15745904401162500495),

582 
KQU
(10762168465993897267), KQU(13552058957896319026),

583 
KQU
(11200228655252462013), KQU( 5035370357337441226),

584 
KQU
( 7593918984545500013), KQU( 5418554918361528700),

585 
KQU
( 4858270799405446371), KQU( 9974659566876282544),

586 
KQU
(18227595922273957859), KQU( 2772778443635656220),

587 
KQU
(14285143053182085385), KQU( 9939700992429600469),

588 
KQU
(12756185904545598068), KQU( 2020783375367345262),

589 
KQU
( 57026775058331227), KQU( 950827867930065454),

590 
KQU
( 6602279670145371217), KQU( 2291171535443566929),

591 
KQU
( 5832380724425010313), KQU( 1220343904715982285),

592 
KQU
(17045542598598037633), KQU(15460481779702820971),

593 
KQU
(13948388779949365130), KQU(13975040175430829518),

594 
KQU
(17477538238425541763), KQU(11104663041851745725),

595 
KQU
(15860992957141157587), KQU(14529434633012950138),

596 
KQU
( 2504838019075394203), KQU( 7512113882611121886),

597 
KQU
( 4859973559980886617), KQU( 1258601555703250219),

598 
KQU
(15594548157514316394), KQU( 4516730171963773048),

599 
KQU
(11380103193905031983), KQU( 6809282239982353344),

600 
KQU
(18045256930420065002), KQU( 2453702683108791859),

601 
KQU
( 977214582986981460), KQU( 2006410402232713466),

602 
KQU
( 6192236267216378358), KQU( 3429468402195675253),

603 
KQU
(18146933153017348921), KQU(17369978576367231139),

604 
KQU
( 1246940717230386603), KQU(11335758870083327110),

605 
KQU
(14166488801730353682), KQU( 9008573127269635732),

606 
KQU
(10776025389820643815), KQU(15087605441903942962),

607 
KQU
( 1359542462712147922), KQU(13898874411226454206),

608 
KQU
(17911176066536804411), KQU( 9435590428600085274),

609 
KQU
( 294488509967864007), KQU( 8890111397567922046),

610 
KQU
( 7987823476034328778), KQU(13263827582440967651),

611 
KQU
( 7503774813106751573), KQU(14974747296185646837),

612 
KQU
( 8504765037032103375), KQU(17340303357444536213),

613 
KQU
( 7704610912964485743), KQU( 8107533670327205061),

614 
KQU
( 9062969835083315985), KQU(16968963142126734184),

615 
KQU
(12958041214190810180), KQU( 2720170147759570200),

616 
KQU
( 2986358963942189566), KQU(14884226322219356580),

617 
KQU
( 286224325144368520), KQU(11313800433154279797),

618 
KQU
(18366849528439673248), KQU(17899725929482368789),

619 
KQU
( 3730004284609106799), KQU( 1654474302052767205),

620 
KQU
( 5006698007047077032), KQU( 8196893913601182838),

621 
KQU
(15214541774425211640), KQU(17391346045606626073),

622 
KQU
( 8369003584076969089), KQU( 3939046733368550293),

623 
KQU
(10178639720308707785), KQU( 2180248669304388697),

624 
KQU
( 62894391300126322), KQU( 9205708961736223191),

625 
KQU
( 6837431058165360438), KQU( 3150743890848308214),

626 
KQU
(17849330658111464583), KQU(12214815643135450865),

627 
KQU
(13410713840519603402), KQU( 3200778126692046802),

628 
KQU
(13354780043041779313), KQU( 800850022756886036),

629 
KQU
(15660052933953067433), KQU( 6572823544154375676),

630 
KQU
(11030281857015819266), KQU(12682241941471433835),

631 
KQU
(11654136407300274693), KQU( 4517795492388641109),

632 
KQU
( 9757017371504524244), KQU(17833043400781889277),

633 
KQU
(12685085201747792227), KQU(10408057728835019573),

634 
KQU
( 98370418513455221), KQU( 6732663555696848598),

635 
KQU
(13248530959948529780), KQU( 3530441401230622826),

636 
KQU
(18188251992895660615), KQU( 1847918354186383756),

637 
KQU
( 1127392190402660921), KQU(11293734643143819463),

638 
KQU
( 3015506344578682982), KQU(13852645444071153329),

639 
KQU
( 2121359659091349142), KQU( 1294604376116677694),

640 
KQU
( 5616576231286352318), KQU( 7112502442954235625),

641 
KQU
(11676228199551561689), KQU(12925182803007305359),

642 
KQU
( 7852375518160493082), KQU( 1136513130539296154),

643 
KQU
( 5636923900916593195), KQU( 3221077517612607747),

644 
KQU
(17784790465798152513), KQU( 3554210049056995938),

645 
KQU
(17476839685878225874), KQU( 3206836372585575732),

646 
KQU
( 2765333945644823430), KQU(10080070903718799528),

647 
KQU
( 5412370818878286353), KQU( 9689685887726257728),

648 
KQU
( 8236117509123533998), KQU( 1951139137165040214),

649 
KQU
( 4492205209227980349), KQU(16541291230861602967),

650 
KQU
( 1424371548301437940), KQU( 9117562079669206794),

651 
KQU
(14374681563251691625), KQU(13873164030199921303),

652 
KQU
( 6680317946770936731), KQU(15586334026918276214),

653 
KQU
(10896213950976109802), KQU( 9506261949596413689),

654 
KQU
( 9903949574308040616), KQU( 6038397344557204470),

655 
KQU
( 174601465422373648), KQU(15946141191338238030),

656 
KQU
(17142225620992044937), KQU( 7552030283784477064),

657 
KQU
( 2947372384532947997), KQU( 510797021688197711),

658 
KQU
( 4962499439249363461), KQU( 23770320158385357),

659 
KQU
( 959774499105138124), KQU( 1468396011518788276),

660 
KQU
( 2015698006852312308), KQU( 4149400718489980136),

661 
KQU
( 5992916099522371188), KQU(10819182935265531076),

662 
KQU
(16189787999192351131), KQU( 342833961790261950),

663 
KQU
(12470830319550495336), KQU(18128495041912812501),

664 
KQU
( 1193600899723524337), KQU( 9056793666590079770),

665 
KQU
( 2154021227041669041), KQU( 4963570213951235735),

666 
KQU
( 4865075960209211409), KQU( 2097724599039942963),

667 
KQU
( 2024080278583179845), KQU(11527054549196576736),

668 
KQU
(10650256084182390252), KQU( 4808408648695766755),

669 
KQU
( 1642839215013788844), KQU(10607187948250398390),

670 
KQU
( 7076868166085913508), KQU( 730522571106887032),

671 
KQU
(12500579240208524895), KQU( 4484390097311355324),

672 
KQU
(15145801330700623870), KQU( 8055827661392944028),

673 
KQU
( 5865092976832712268), KQU(15159212508053625143),

674 
KQU
( 3560964582876483341), KQU( 4070052741344438280),

675 
KQU
( 6032585709886855634), KQU(15643262320904604873),

676 
KQU
( 2565119772293371111), KQU( 318314293065348260),

677 
KQU
(15047458749141511872), KQU( 7772788389811528730),

678 
KQU
( 7081187494343801976), KQU( 6465136009467253947),

679 
KQU
(10425940692543362069), KQU( 554608190318339115),

680 
KQU
(14796699860302125214), KQU( 1638153134431111443),

681 
KQU
(10336967447052276248), KQU( 8412308070396592958),

682 
KQU
( 4004557277152051226), KQU( 8143598997278774834),

683 
KQU
(16413323996508783221), KQU(13139418758033994949),

684 
KQU
( 9772709138335006667), KQU( 2818167159287157659),

685 
KQU
(17091740573832523669), KQU(14629199013130751608),

686 
KQU
(18268322711500338185), KQU( 8290963415675493063),

687 
KQU
( 8830864907452542588), KQU( 1614839084637494849),

688 
KQU
(14855358500870422231), KQU( 3472996748392519937),

689 
KQU
(15317151166268877716), KQU( 5825895018698400362),

690 
KQU
(16730208429367544129), KQU(10481156578141202800),

691 
KQU
( 4746166512382823750), KQU(12720876014472464998),

692 
KQU
( 8825177124486735972), KQU(13733447296837467838),

693 
KQU
( 6412293741681359625), KQU( 8313213138756135033),

694 
KQU
(11421481194803712517), KQU( 7997007691544174032),

695 
KQU
( 6812963847917605930), KQU( 9683091901227558641),

696 
KQU
(14703594165860324713), KQU( 1775476144519618309),

697 
KQU
( 2724283288516469519), KQU( 717642555185856868),

698 
KQU
( 8736402192215092346), KQU(11878800336431381021),

699 
KQU
( 4348816066017061293), KQU( 6115112756583631307),

700 
KQU
( 9176597239667142976), KQU(12615622714894259204),

701 
KQU
(10283406711301385987), KQU( 5111762509485379420),

702 
KQU
( 3118290051198688449), KQU( 7345123071632232145),

703 
KQU
( 9176423451688682359), KQU( 4843865456157868971),

704 
KQU
(12008036363752566088), KQU(12058837181919397720),

705 
KQU
( 2145073958457347366), KQU( 1526504881672818067),

706 
KQU
( 3488830105567134848), KQU(13208362960674805143),

707 
KQU
( 4077549672899572192), KQU( 7770995684693818365),

708 
KQU
( 1398532341546313593), KQU(12711859908703927840),

709 
KQU
( 1417561172594446813), KQU(17045191024194170604),

710 
KQU
( 4101933177604931713), KQU(14708428834203480320),

711 
KQU
(17447509264469407724), KQU(14314821973983434255),

712 
KQU
(17990472271061617265), KQU( 5087756685841673942),

713 
KQU
(12797820586893859939), KQU( 1778128952671092879),

714 
KQU
( 3535918530508665898), KQU( 9035729701042481301),

715 
KQU
(14808661568277079962), KQU(14587345077537747914),

716 
KQU
(11920080002323122708), KQU( 6426515805197278753),

717 
KQU
( 3295612216725984831), KQU(11040722532100876120),

718 
KQU
(12305952936387598754), KQU(16097391899742004253),

719 
KQU
( 4908537335606182208), KQU(12446674552196795504),

720 
KQU
(16010497855816895177), KQU( 9194378874788615551),

721 
KQU
( 3382957529567613384), KQU( 5154647600754974077),

722 
KQU
( 9801822865328396141), KQU( 9023662173919288143),

723 
KQU
(17623115353825147868), KQU( 8238115767443015816),

724 
KQU
(15811444159859002560), KQU( 9085612528904059661),

725 
KQU
( 6888601089398614254), KQU( 258252992894160189),

726 
KQU
( 6704363880792428622), KQU( 6114966032147235763),

727 
KQU
(11075393882690261875), KQU( 8797664238933620407),

728 
KQU
( 5901892006476726920), KQU( 5309780159285518958),

729 
KQU
(14940808387240817367), KQU(14642032021449656698),

730 
KQU
( 9808256672068504139), KQU( 3670135111380607658),

731 
KQU
(11211211097845960152), KQU( 1474304506716695808),

732 
KQU
(15843166204506876239), KQU( 7661051252471780561),

733 
KQU
(10170905502249418476), KQU( 7801416045582028589),

734 
KQU
( 2763981484737053050), KQU( 9491377905499253054),

735 
KQU
(16201395896336915095), KQU( 9256513756442782198),

736 
KQU
( 5411283157972456034), KQU( 5059433122288321676),

737 
KQU
( 4327408006721123357), KQU( 9278544078834433377),

738 
KQU
( 7601527110882281612), KQU(11848295896975505251),

739 
KQU
(12096998801094735560), KQU(14773480339823506413),

740 
KQU
(15586227433895802149), KQU(12786541257830242872),

741 
KQU
( 6904692985140503067), KQU( 5309011515263103959),

742 
KQU
(12105257191179371066), KQU(14654380212442225037),

743 
KQU
( 2556774974190695009), KQU( 4461297399927600261),

744 
KQU
(14888225660915118646), KQU(14915459341148291824),

745 
KQU
( 2738802166252327631), KQU( 6047155789239131512),

746 
KQU
(12920545353217010338), KQU(10697617257007840205),

747 
KQU
( 2751585253158203504), KQU(13252729159780047496),

748 
KQU
(14700326134672815469), KQU(14082527904374600529),

749 
KQU
(16852962273496542070), KQU(17446675504235853907),

750 
KQU
(15019600398527572311), KQU(12312781346344081551),

751 
KQU
(14524667935039810450), KQU( 5634005663377195738),

752 
KQU
(11375574739525000569), KQU( 2423665396433260040),

753 
KQU
( 5222836914796015410), KQU( 4397666386492647387),

754 
KQU
( 4619294441691707638), KQU( 665088602354770716),

755 
KQU
(13246495665281593610), KQU( 6564144270549729409),

756 
KQU
(10223216188145661688), KQU( 3961556907299230585),

757 
KQU
(11543262515492439914), KQU(16118031437285993790),

758 
KQU
( 7143417964520166465), KQU(13295053515909486772),

759 
KQU
( 40434666004899675), KQU(17127804194038347164),

760 
KQU
( 8599165966560586269), KQU( 8214016749011284903),

761 
KQU
(13725130352140465239), KQU( 5467254474431726291),

762 
KQU
( 7748584297438219877), KQU(16933551114829772472),

763 
KQU
( 2169618439506799400), KQU( 2169787627665113463),

764 
KQU
(17314493571267943764), KQU(18053575102911354912),

765 
KQU
(11928303275378476973), KQU(11593850925061715550),

766 
KQU
(17782269923473589362), KQU( 3280235307704747039),

767 
KQU
( 6145343578598685149), KQU(17080117031114086090),

768 
KQU
(18066839902983594755), KQU( 6517508430331020706),

769 
KQU
( 8092908893950411541), KQU(12558378233386153732),

770 
KQU
( 4476532167973132976), KQU(16081642430367025016),

771 
KQU
( 4233154094369139361), KQU( 8693630486693161027),

772 
KQU
(11244959343027742285), KQU(12273503967768513508),

773 
KQU
(14108978636385284876), KQU( 7242414665378826984),

774 
KQU
( 6561316938846562432), KQU( 8601038474994665795),

775 
KQU
(17532942353612365904), KQU(17940076637020912186),

776 
KQU
( 7340260368823171304), KQU( 7061807613916067905),

777 
KQU
(10561734935039519326), KQU(17990796503724650862),

778 
KQU
( 6208732943911827159), KQU( 359077562804090617),

779 
KQU
(14177751537784403113), KQU(10659599444915362902),

780 
KQU
(15081727220615085833), KQU(13417573895659757486),

781 
KQU
(15513842342017811524), KQU(11814141516204288231),

782 
KQU
( 1827312513875101814), KQU( 2804611699894603103),

783 
KQU
(17116500469975602763), KQU(12270191815211952087),

784 
KQU
(12256358467786024988), KQU(18435021722453971267),

785 
KQU
( 671330264390865618), KQU( 476504300460286050),

786 
KQU
(16465470901027093441), KQU( 4047724406247136402),

787 
KQU
( 1322305451411883346), KQU( 1388308688834322280),

788 
KQU
( 7303989085269758176), KQU( 9323792664765233642),

789 
KQU
( 4542762575316368936), KQU(17342696132794337618),

790 
KQU
( 4588025054768498379), KQU(13415475057390330804),

791 
KQU
(17880279491733405570), KQU(10610553400618620353),

792 
KQU
( 3180842072658960139), KQU(13002966655454270120),

793 
KQU
( 1665301181064982826), KQU( 7083673946791258979),

794 
KQU
( 190522247122496820), KQU(17388280237250677740),

795 
KQU
( 8430770379923642945), KQU(12987180971921668584),

796 
KQU
( 2311086108365390642), KQU( 2870984383579822345),

797 
KQU
(14014682609164653318), KQU(14467187293062251484),

798 
KQU
( 192186361147413298), KQU(15171951713531796524),

799 
KQU
( 9900305495015948728), KQU(17958004775615466344),

800 
KQU
(14346380954498606514), KQU(18040047357617407096),

801 
KQU
( 5035237584833424532), KQU(15089555460613972287),

802 
KQU
( 4131411873749729831), KQU( 1329013581168250330),

803 
KQU
(10095353333051193949), KQU(10749518561022462716),

804 
KQU
( 9050611429810755847), KQU(15022028840236655649),

805 
KQU
( 8775554279239748298), KQU(13105754025489230502),

806 
KQU
(15471300118574167585), KQU( 89864764002355628),

807 
KQU
( 8776416323420466637), KQU( 5280258630612040891),

808 
KQU
( 2719174488591862912), KQU( 7599309137399661994),

809 
KQU
(15012887256778039979), KQU(14062981725630928925),

810 
KQU
(12038536286991689603), KQU( 7089756544681775245),

811 
KQU
(10376661532744718039), KQU( 1265198725901533130),

812 
KQU
(13807996727081142408), KQU( 2935019626765036403),

813 
KQU
( 7651672460680700141), KQU( 3644093016200370795),

814 
KQU
( 2840982578090080674), KQU(17956262740157449201),

815 
KQU
(18267979450492880548), KQU(11799503659796848070),

816 
KQU
( 9942537025669672388), KQU(11886606816406990297),

817 
KQU
( 5488594946437447576), KQU( 7226714353282744302),

818 
KQU
( 3784851653123877043), KQU( 878018453244803041),

819 
KQU
(12110022586268616085), KQU( 734072179404675123),

820 
KQU
(11869573627998248542), KQU( 469150421297783998),

821 
KQU
( 260151124912803804), KQU(11639179410120968649),

822 
KQU
( 9318165193840846253), KQU(12795671722734758075),

823 
KQU
(15318410297267253933), KQU( 691524703570062620),

824 
KQU
( 5837129010576994601), KQU(15045963859726941052),

825 
KQU
( 5850056944932238169), KQU(12017434144750943807),

826 
KQU
( 7447139064928956574), KQU( 3101711812658245019),

827 
KQU
(16052940704474982954), KQU(18195745945986994042),

828 
KQU
( 8932252132785575659), KQU(13390817488106794834),

829 
KQU
(11582771836502517453), KQU( 4964411326683611686),

830 
KQU
( 2195093981702694011), KQU(14145229538389675669),

831 
KQU
(16459605532062271798), KQU( 866316924816482864),

832 
KQU
( 4593041209937286377), KQU( 8415491391910972138),

833 
KQU
( 4171236715600528969), KQU(16637569303336782889),

834 
KQU
( 2002011073439212680), KQU(17695124661097601411),

835 
KQU
( 4627687053598611702), KQU( 7895831936020190403),

836 
KQU
( 8455951300917267802), KQU( 2923861649108534854),

837 
KQU
( 8344557563927786255), KQU( 6408671940373352556),

838 
KQU
(12210227354536675772), KQU(14294804157294222295),

839 
KQU
(10103022425071085127), KQU(10092959489504123771),

840 
KQU
( 6554774405376736268), KQU(12629917718410641774),

841 
KQU
( 6260933257596067126), KQU( 2460827021439369673),

842 
KQU
( 2541962996717103668), KQU( 597377203127351475),

843 
KQU
( 5316984203117315309), KQU( 4811211393563241961),

844 
KQU
(13119698597255811641), KQU( 8048691512862388981),

845 
KQU
(10216818971194073842), KQU( 4612229970165291764),

846 
KQU
(10000980798419974770), KQU( 6877640812402540687),

847 
KQU
( 1488727563290436992), KQU( 2227774069895697318),

848 
KQU
(11237754507523316593), KQU(13478948605382290972),

849 
KQU
( 1963583846976858124), KQU( 5512309205269276457),

850 
KQU
( 3972770164717652347), KQU( 3841751276198975037),

851 
KQU
(10283343042181903117), KQU( 8564001259792872199),

852 
KQU
(16472187244722489221), KQU( 8953493499268945921),

853 
KQU
( 3518747340357279580), KQU( 4003157546223963073),

854 
KQU
( 3270305958289814590), KQU( 3966704458129482496),

855 
KQU
( 8122141865926661939), KQU(14627734748099506653),

856 
KQU
(13064426990862560568), KQU( 2414079187889870829),

857 
KQU
( 5378461209354225306), KQU(10841985740128255566),

858 
KQU
( 538582442885401738), KQU( 7535089183482905946),

859 
KQU
(16117559957598879095), KQU( 8477890721414539741),

860 
KQU
( 1459127491209533386), KQU(17035126360733620462),

861 
KQU
( 8517668552872379126), KQU(10292151468337355014),

862 
KQU
(17081267732745344157), KQU(13751455337946087178),

863 
KQU
(14026945459523832966), KQU( 6653278775061723516),

864 
KQU
(10619085543856390441), KQU( 2196343631481122885),

865 
KQU
(10045966074702826136), KQU(10082317330452718282),

866 
KQU
( 5920859259504831242), KQU( 9951879073426540617),

867 
KQU
( 7074696649151414158), KQU(15808193543879464318),

868 
KQU
( 7385247772746953374), KQU( 3192003544283864292),

869 
KQU
(18153684490917593847), KQU(12423498260668568905),

870 
KQU
(10957758099756378169), KQU(11488762179911016040),

871 
KQU
( 2099931186465333782), KQU(11180979581250294432),

872 
KQU
( 8098916250668367933), KQU( 3529200436790763465),

873 
KQU
(12988418908674681745), KQU( 6147567275954808580),

874 
KQU
( 3207503344604030989), KQU(10761592604898615360),

875 
KQU
( 229854861031893504), KQU( 8809853962667144291),

876 
KQU
(13957364469005693860), KQU( 7634287665224495886),

877 
KQU
(12353487366976556874), KQU( 1134423796317152034),

878 
KQU
( 2088992471334107068), KQU( 7393372127190799698),

879 
KQU
( 1845367839871058391), KQU( 207922563987322884),

880 
KQU
(11960870813159944976), KQU(12182120053317317363),

881 
KQU
(17307358132571709283), KQU(13871081155552824936),

882 
KQU
(18304446751741566262), KQU( 7178705220184302849),

883 
KQU
(10929605677758824425), KQU(16446976977835806844),

884 
KQU
(13723874412159769044), KQU( 6942854352100915216),

885 
KQU
( 1726308474365729390), KQU( 2150078766445323155),

886 
KQU
(15345558947919656626), KQU(12145453828874527201),

887 
KQU
( 2054448620739726849), KQU( 2740102003352628137),

888 
KQU
(11294462163577610655), KQU( 756164283387413743),

889 
KQU
(17841144758438810880), KQU(10802406021185415861),

890 
KQU
( 8716455530476737846), KQU( 6321788834517649606),

891 
KQU
(14681322910577468426), KQU(17330043563884336387),

892 
KQU
(12701802180050071614), KQU(14695105111079727151),

893 
KQU
( 5112098511654172830), KQU( 4957505496794139973),

894 
KQU
( 8270979451952045982), KQU(12307685939199120969),

895 
KQU
(12425799408953443032), KQU( 8376410143634796588),

896 
KQU
(16621778679680060464), KQU( 3580497854566660073),

897 
KQU
( 1122515747803382416), KQU( 857664980960597599),

898 
KQU
( 6343640119895925918), KQU(12878473260854462891),

899 
KQU
(10036813920765722626), KQU(14451335468363173812),

900 
KQU
( 5476809692401102807), KQU(16442255173514366342),

901 
KQU
(13060203194757167104), KQU(14354124071243177715),

902 
KQU
(15961249405696125227), KQU(13703893649690872584),

903 
KQU
( 363907326340340064), KQU( 6247455540491754842),

904 
KQU
(12242249332757832361), KQU( 156065475679796717),

905 
KQU
( 9351116235749732355), KQU( 4590350628677701405),

906 
KQU
( 1671195940982350389), KQU(13501398458898451905),

907 
KQU
( 6526341991225002255), KQU( 1689782913778157592),

908 
KQU
( 7439222350869010334), KQU(13975150263226478308),

909 
KQU
(11411961169932682710), KQU(17204271834833847277),

910 
KQU
( 541534742544435367), KQU( 6591191931218949684),

911 
KQU
( 2645454775478232486), KQU( 4322857481256485321),

912 
KQU
( 8477416487553065110), KQU(12902505428548435048),

913 
KQU
( 971445777981341415), KQU(14995104682744976712),

914 
KQU
( 4243341648807158063), KQU( 8695061252721927661),

915 
KQU
( 5028202003270177222), KQU( 2289257340915567840),

916 
KQU
(13870416345121866007), KQU(13994481698072092233),

917 
KQU
( 6912785400753196481), KQU( 2278309315841980139),

918 
KQU
( 4329765449648304839), KQU( 5963108095785485298),

919 
KQU
( 4880024847478722478), KQU(16015608779890240947),

920 
KQU
( 1866679034261393544), KQU( 914821179919731519),

921 
KQU
( 9643404035648760131), KQU( 2418114953615593915),

922 
KQU
( 944756836073702374), KQU(15186388048737296834),

923 
KQU
( 7723355336128442206), KQU( 7500747479679599691),

924 
KQU
(18013961306453293634), KQU( 2315274808095756456),

925 
KQU
(13655308255424029566), KQU(17203800273561677098),

926 
KQU
( 1382158694422087756), KQU( 5090390250309588976),

927 
KQU
( 517170818384213989), KQU( 1612709252627729621),

928 
KQU
( 1330118955572449606), KQU( 300922478056709885),

929 
KQU
(18115693291289091987), KQU(13491407109725238321),

930 
KQU
(15293714633593827320), KQU( 5151539373053314504),

931 
KQU
( 5951523243743139207), KQU(14459112015249527975),

932 
KQU
( 5456113959000700739), KQU( 3877918438464873016),

933 
KQU
(12534071654260163555), KQU(15871678376893555041),

934 
KQU
(11005484805712025549), KQU(16353066973143374252),

935 
KQU
( 4358331472063256685), KQU( 8268349332210859288),

936 
KQU
(12485161590939658075), KQU(13955993592854471343),

937 
KQU
( 5911446886848367039), KQU(14925834086813706974),

938 
KQU
( 6590362597857994805), KQU( 1280544923533661875),

939 
KQU
( 1637756018947988164), KQU( 4734090064512686329),

940 
KQU
(16693705263131485912), KQU( 6834882340494360958),

941 
KQU
( 8120732176159658505), KQU( 2244371958905329346),

942 
KQU
(10447499707729734021), KQU( 7318742361446942194),

943 
KQU
( 8032857516355555296), KQU(14023605983059313116),

944 
KQU
( 1032336061815461376), KQU( 9840995337876562612),

945 
KQU
( 9869256223029203587), KQU(12227975697177267636),

946 
KQU
(12728115115844186033), KQU( 7752058479783205470),

947 
KQU
( 729733219713393087), KQU(12954017801239007622)

949 cÚ¡ 
ušt64_t
 
	gš™_by_¬¿y_64_ex³ùed
[] = {

950 
KQU
( 2100341266307895239), KQU( 8344256300489757943),

951 
KQU
(15687933285484243894), KQU( 8268620370277076319),

952 
KQU
(12371852309826545459), KQU( 8800491541730110238),

953 
KQU
(18113268950100835773), KQU( 2886823658884438119),

954 
KQU
( 3293667307248180724), KQU( 9307928143300172731),

955 
KQU
( 7688082017574293629), KQU( 900986224735166665),

956 
KQU
( 9977972710722265039), KQU( 6008205004994830552),

957 
KQU
( 546909104521689292), KQU( 7428471521869107594),

958 
KQU
(14777563419314721179), KQU(16116143076567350053),

959 
KQU
( 5322685342003142329), KQU( 4200427048445863473),

960 
KQU
( 4693092150132559146), KQU(13671425863759338582),

961 
KQU
( 6747117460737639916), KQU( 4732666080236551150),

962 
KQU
( 5912839950611941263), KQU( 3903717554504704909),

963 
KQU
( 2615667650256786818), KQU(10844129913887006352),

964 
KQU
(13786467861810997820), KQU(14267853002994021570),

965 
KQU
(13767807302847237439), KQU(16407963253707224617),

966 
KQU
( 4802498363698583497), KQU( 2523802839317209764),

967 
KQU
( 3822579397797475589), KQU( 8950320572212130610),

968 
KQU
( 3745623504978342534), KQU(16092609066068482806),

969 
KQU
( 9817016950274642398), KQU(10591660660323829098),

970 
KQU
(11751606650792815920), KQU( 5122873818577122211),

971 
KQU
(17209553764913936624), KQU( 6249057709284380343),

972 
KQU
(15088791264695071830), KQU(15344673071709851930),

973 
KQU
( 4345751415293646084), KQU( 2542865750703067928),

974 
KQU
(13520525127852368784), KQU(18294188662880997241),

975 
KQU
( 3871781938044881523), KQU( 2873487268122812184),

976 
KQU
(15099676759482679005), KQU(15442599127239350490),

977 
KQU
( 6311893274367710888), KQU( 3286118760484672933),

978 
KQU
( 4146067961333542189), KQU(13303942567897208770),

979 
KQU
( 8196013722255630418), KQU( 4437815439340979989),

980 
KQU
(15433791533450605135), KQU( 4254828956815687049),

981 
KQU
( 1310903207708286015), KQU(10529182764462398549),

982 
KQU
(14900231311660638810), KQU( 9727017277104609793),

983 
KQU
( 1821308310948199033), KQU(11628861435066772084),

984 
KQU
( 9469019138491546924), KQU( 3145812670532604988),

985 
KQU
( 9938468915045491919), KQU( 1562447430672662142),

986 
KQU
(13963995266697989134), KQU( 3356884357625028695),

987 
KQU
( 4499850304584309747), KQU( 8456825817023658122),

988 
KQU
(10859039922814285279), KQU( 8099512337972526555),

989 
KQU
( 348006375109672149), KQU(11919893998241688603),

990 
KQU
( 1104199577402948826), KQU(16689191854356060289),

991 
KQU
(10992552041730168078), KQU( 7243733172705465836),

992 
KQU
( 5668075606180319560), KQU(18182847037333286970),

993 
KQU
( 4290215357664631322), KQU( 4061414220791828613),

994 
KQU
(13006291061652989604), KQU( 7140491178917128798),

995 
KQU
(12703446217663283481), KQU( 5500220597564558267),

996 
KQU
(10330551509971296358), KQU(15958554768648714492),

997 
KQU
( 5174555954515360045), KQU( 1731318837687577735),

998 
KQU
( 3557700801048354857), KQU(13764012341928616198),

999 
KQU
(13115166194379119043), KQU( 7989321021560255519),

1000 
KQU
( 2103584280905877040), KQU( 9230788662155228488),

1001 
KQU
(16396629323325547654), KQU( 657926409811318051),

1002 
KQU
(15046700264391400727), KQU( 5120132858771880830),

1003 
KQU
( 7934160097989028561), KQU( 6963121488531976245),

1004 
KQU
(17412329602621742089), KQU(15144843053931774092),

1005 
KQU
(17204176651763054532), KQU(13166595387554065870),

1006 
KQU
( 8590377810513960213), KQU( 5834365135373991938),

1007 
KQU
( 7640913007182226243), KQU( 3479394703859418425),

1008 
KQU
(16402784452644521040), KQU( 4993979809687083980),

1009 
KQU
(13254522168097688865), KQU(15643659095244365219),

1010 
KQU
( 5881437660538424982), KQU(11174892200618987379),

1011 
KQU
( 254409966159711077), KQU(17158413043140549909),

1012 
KQU
( 3638048789290376272), KQU( 1376816930299489190),

1013 
KQU
( 4622462095217761923), KQU(15086407973010263515),

1014 
KQU
(13253971772784692238), KQU( 5270549043541649236),

1015 
KQU
(11182714186805411604), KQU(12283846437495577140),

1016 
KQU
( 5297647149908953219), KQU(10047451738316836654),

1017 
KQU
( 4938228100367874746), KQU(12328523025304077923),

1018 
KQU
( 3601049438595312361), KQU( 9313624118352733770),

1019 
KQU
(13322966086117661798), KQU(16660005705644029394),

1020 
KQU
(11337677526988872373), KQU(13869299102574417795),

1021 
KQU
(15642043183045645437), KQU( 3021755569085880019),

1022 
KQU
( 4979741767761188161), KQU(13679979092079279587),

1023 
KQU
( 3344685842861071743), KQU(13947960059899588104),

1024 
KQU
( 305806934293368007), KQU( 5749173929201650029),

1025 
KQU
(11123724852118844098), KQU(15128987688788879802),

1026 
KQU
(15251651211024665009), KQU( 7689925933816577776),

1027 
KQU
(16732804392695859449), KQU(17087345401014078468),

1028 
KQU
(14315108589159048871), KQU( 4820700266619778917),

1029 
KQU
(16709637539357958441), KQU( 4936227875177351374),

1030 
KQU
( 2137907697912987247), KQU(11628565601408395420),

1031 
KQU
( 2333250549241556786), KQU( 5711200379577778637),

1032 
KQU
( 5170680131529031729), KQU(12620392043061335164),

1033 
KQU
( 95363390101096078), KQU( 5487981914081709462),

1034 
KQU
( 1763109823981838620), KQU( 3395861271473224396),

1035 
KQU
( 1300496844282213595), KQU( 6894316212820232902),

1036 
KQU
(10673859651135576674), KQU( 5911839658857903252),

1037 
KQU
(17407110743387299102), KQU( 8257427154623140385),

1038 
KQU
(11389003026741800267), KQU( 4070043211095013717),

1039 
KQU
(11663806997145259025), KQU(15265598950648798210),

1040 
KQU
( 630585789434030934), KQU( 3524446529213587334),

1041 
KQU
( 7186424168495184211), KQU(10806585451386379021),

1042 
KQU
(11120017753500499273), KQU( 1586837651387701301),

1043 
KQU
(17530454400954415544), KQU( 9991670045077880430),

1044 
KQU
( 7550997268990730180), KQU( 8640249196597379304),

1045 
KQU
( 3522203892786893823), KQU(10401116549878854788),

1046 
KQU
(13690285544733124852), KQU( 8295785675455774586),

1047 
KQU
(15535716172155117603), KQU( 3112108583723722511),

1048 
KQU
(17633179955339271113), KQU(18154208056063759375),

1049 
KQU
( 1866409236285815666), KQU(13326075895396412882),

1050 
KQU
( 8756261842948020025), KQU( 6281852999868439131),

1051 
KQU
(15087653361275292858), KQU(10333923911152949397),

1052 
KQU
( 5265567645757408500), KQU(12728041843210352184),

1053 
KQU
( 6347959327507828759), KQU( 154112802625564758),

1054 
KQU
(18235228308679780218), KQU( 3253805274673352418),

1055 
KQU
( 4849171610689031197), KQU(17948529398340432518),

1056 
KQU
(13803510475637409167), KQU(13506570190409883095),

1057 
KQU
(15870801273282960805), KQU( 8451286481299170773),

1058 
KQU
( 9562190620034457541), KQU( 8518905387449138364),

1059 
KQU
(12681306401363385655), KQU( 3788073690559762558),

1060 
KQU
( 5256820289573487769), KQU( 2752021372314875467),

1061 
KQU
( 6354035166862520716), KQU( 4328956378309739069),

1062 
KQU
( 449087441228269600), KQU( 5533508742653090868),

1063 
KQU
( 1260389420404746988), KQU(18175394473289055097),

1064 
KQU
( 1535467109660399420), KQU( 8818894282874061442),

1065 
KQU
(12140873243824811213), KQU(15031386653823014946),

1066 
KQU
( 1286028221456149232), KQU( 6329608889367858784),

1067 
KQU
( 9419654354945132725), KQU( 6094576547061672379),

1068 
KQU
(17706217251847450255), KQU( 1733495073065878126),

1069 
KQU
(16918923754607552663), KQU( 8881949849954945044),

1070 
KQU
(12938977706896313891), KQU(14043628638299793407),

1071 
KQU
(18393874581723718233), KQU( 6886318534846892044),

1072 
KQU
(14577870878038334081), KQU(13541558383439414119),

1073 
KQU
(13570472158807588273), KQU(18300760537910283361),

1074 
KQU
( 818368572800609205), KQU( 1417000585112573219),

1075 
KQU
(12337533143867683655), KQU(12433180994702314480),

1076 
KQU
( 778190005829189083), KQU(13667356216206524711),

1077 
KQU
( 9866149895295225230), KQU(11043240490417111999),

1078 
KQU
( 1123933826541378598), KQU( 6469631933605123610),

1079 
KQU
(14508554074431980040), KQU(13918931242962026714),

1080 
KQU
( 2870785929342348285), KQU(14786362626740736974),

1081 
KQU
(13176680060902695786), KQU( 9591778613541679456),

1082 
KQU
( 9097662885117436706), KQU( 749262234240924947),

1083 
KQU
( 1944844067793307093), KQU( 4339214904577487742),

1084 
KQU
( 8009584152961946551), KQU(16073159501225501777),

1085 
KQU
( 3335870590499306217), KQU(17088312653151202847),

1086 
KQU
( 3108893142681931848), KQU(16636841767202792021),

1087 
KQU
(10423316431118400637), KQU( 8008357368674443506),

1088 
KQU
(11340015231914677875), KQU(17687896501594936090),

1089 
KQU
(15173627921763199958), KQU( 542569482243721959),

1090 
KQU
(15071714982769812975), KQU( 4466624872151386956),

1091 
KQU
( 1901780715602332461), KQU( 9822227742154351098),

1092 
KQU
( 1479332892928648780), KQU( 6981611948382474400),

1093 
KQU
( 7620824924456077376), KQU(14095973329429406782),

1094 
KQU
( 7902744005696185404), KQU(15830577219375036920),

1095 
KQU
(10287076667317764416), KQU(12334872764071724025),

1096 
KQU
( 4419302088133544331), KQU(14455842851266090520),

1097 
KQU
(12488077416504654222), KQU( 7953892017701886766),

1098 
KQU
( 6331484925529519007), KQU( 4902145853785030022),

1099 
KQU
(17010159216096443073), KQU(11945354668653886087),

1100 
KQU
(15112022728645230829), KQU(17363484484522986742),

1101 
KQU
( 4423497825896692887), KQU( 8155489510809067471),

1102 
KQU
( 258966605622576285), KQU( 5462958075742020534),

1103 
KQU
( 6763710214913276228), KQU( 2368935183451109054),

1104 
KQU
(14209506165246453811), KQU( 2646257040978514881),

1105 
KQU
( 3776001911922207672), KQU( 1419304601390147631),

1106 
KQU
(14987366598022458284), KQU( 3977770701065815721),

1107 
KQU
( 730820417451838898), KQU( 3982991703612885327),

1108 
KQU
( 2803544519671388477), KQU(17067667221114424649),

1109 
KQU
( 2922555119737867166), KQU( 1989477584121460932),

1110 
KQU
(15020387605892337354), KQU( 9293277796427533547),

1111 
KQU
(10722181424063557247), KQU(16704542332047511651),

1112 
KQU
( 5008286236142089514), KQU(16174732308747382540),

1113 
KQU
(17597019485798338402), KQU(13081745199110622093),

1114 
KQU
( 8850305883842258115), KQU(12723629125624589005),

1115 
KQU
( 8140566453402805978), KQU(15356684607680935061),

1116 
KQU
(14222190387342648650), KQU(11134610460665975178),

1117 
KQU
( 1259799058620984266), KQU(13281656268025610041),

1118 
KQU
( 298262561068153992), KQU(12277871700239212922),

1119 
KQU
(13911297774719779438), KQU(16556727962761474934),

1120 
KQU
(17903010316654728010), KQU( 9682617699648434744),

1121 
KQU
(14757681836838592850), KQU( 1327242446558524473),

1122 
KQU
(11126645098780572792), KQU( 1883602329313221774),

1123 
KQU
( 2543897783922776873), KQU(15029168513767772842),

1124 
KQU
(12710270651039129878), KQU(16118202956069604504),

1125 
KQU
(15010759372168680524), KQU( 2296827082251923948),

1126 
KQU
(10793729742623518101), KQU(13829764151845413046),

1127 
KQU
(17769301223184451213), KQU( 3118268169210783372),

1128 
KQU
(17626204544105123127), KQU( 7416718488974352644),

1129 
KQU
(10450751996212925994), KQU( 9352529519128770586),

1130 
KQU
( 259347569641110140), KQU( 8048588892269692697),

1131 
KQU
( 1774414152306494058), KQU(10669548347214355622),

1132 
KQU
(13061992253816795081), KQU(18432677803063861659),

1133 
KQU
( 8879191055593984333), KQU(12433753195199268041),

1134 
KQU
(14919392415439730602), KQU( 6612848378595332963),

1135 
KQU
( 6320986812036143628), KQU(10465592420226092859),

1136 
KQU
( 4196009278962570808), KQU( 3747816564473572224),

1137 
KQU
(17941203486133732898), KQU( 2350310037040505198),

1138 
KQU
( 5811779859134370113), KQU(10492109599506195126),

1139 
KQU
( 7699650690179541274), KQU( 1954338494306022961),

1140 
KQU
(14095816969027231152), KQU( 5841346919964852061),

1141 
KQU
(14945969510148214735), KQU( 3680200305887550992),

1142 
KQU
( 6218047466131695792), KQU( 8242165745175775096),

1143 
KQU
(11021371934053307357), KQU( 1265099502753169797),

1144 
KQU
( 4644347436111321718), KQU( 3609296916782832859),

1145 
KQU
( 8109807992218521571), KQU(18387884215648662020),

1146 
KQU
(14656324896296392902), KQU(17386819091238216751),

1147 
KQU
(17788300878582317152), KQU( 7919446259742399591),

1148 
KQU
( 4466613134576358004), KQU(12928181023667938509),

1149 
KQU
(13147446154454932030), KQU(16552129038252734620),

1150 
KQU
( 8395299403738822450), KQU(11313817655275361164),

1151 
KQU
( 434258809499511718), KQU( 2074882104954788676),

1152 
KQU
( 7929892178759395518), KQU( 9006461629105745388),

1153 
KQU
( 5176475650000323086), KQU(11128357033468341069),

1154 
KQU
(12026158851559118955), KQU(14699716249471156500),

1155 
KQU
( 448982497120206757), KQU( 4156475356685519900),

1156 
KQU
( 6063816103417215727), KQU(10073289387954971479),

1157 
KQU
( 8174466846138590962), KQU( 2675777452363449006),

1158 
KQU
( 9090685420572474281), KQU( 6659652652765562060),

1159 
KQU
(12923120304018106621), KQU(11117480560334526775),

1160 
KQU
( 937910473424587511), KQU( 1838692113502346645),

1161 
KQU
(11133914074648726180), KQU( 7922600945143884053),

1162 
KQU
(13435287702700959550), KQU( 5287964921251123332),

1163 
KQU
(11354875374575318947), KQU(17955724760748238133),

1164 
KQU
(13728617396297106512), KQU( 4107449660118101255),

1165 
KQU
( 1210269794886589623), KQU(11408687205733456282),

1166 
KQU
( 4538354710392677887), KQU(13566803319341319267),

1167 
KQU
(17870798107734050771), KQU( 3354318982568089135),

1168 
KQU
( 9034450839405133651), KQU(13087431795753424314),

1169 
KQU
( 950333102820688239), KQU( 1968360654535604116),

1170 
KQU
(16840551645563314995), KQU( 8867501803892924995),

1171 
KQU
(11395388644490626845), KQU( 1529815836300732204),

1172 
KQU
(13330848522996608842), KQU( 1813432878817504265),

1173 
KQU
( 2336867432693429560), KQU(15192805445973385902),

1174 
KQU
( 2528593071076407877), KQU( 128459777936689248),

1175 
KQU
( 9976345382867214866), KQU( 6208885766767996043),

1176 
KQU
(14982349522273141706), KQU( 3099654362410737822),

1177 
KQU
(13776700761947297661), KQU( 8806185470684925550),

1178 
KQU
( 8151717890410585321), KQU( 640860591588072925),

1179 
KQU
(14592096303937307465), KQU( 9056472419613564846),

1180 
KQU
(14861544647742266352), KQU(12703771500398470216),

1181 
KQU
( 3142372800384138465), KQU( 6201105606917248196),

1182 
KQU
(18337516409359270184), KQU(15042268695665115339),

1183 
KQU
(15188246541383283846), KQU(12800028693090114519),

1184 
KQU
( 5992859621101493472), KQU(18278043971816803521),

1185 
KQU
( 9002773075219424560), KQU( 7325707116943598353),

1186 
KQU
( 7930571931248040822), KQU( 5645275869617023448),

1187 
KQU
( 7266107455295958487), KQU( 4363664528273524411),

1188 
KQU
(14313875763787479809), KQU(17059695613553486802),

1189 
KQU
( 9247761425889940932), KQU(13704726459237593128),

1190 
KQU
( 2701312427328909832), KQU(17235532008287243115),

1191 
KQU
(14093147761491729538), KQU( 6247352273768386516),

1192 
KQU
( 8268710048153268415), KQU( 7985295214477182083),

1193 
KQU
(15624495190888896807), KQU( 3772753430045262788),

1194 
KQU
( 9133991620474991698), KQU( 5665791943316256028),

1195 
KQU
( 7551996832462193473), KQU(13163729206798953877),

1196 
KQU
( 9263532074153846374), KQU( 1015460703698618353),

1197 
KQU
(17929874696989519390), KQU(18257884721466153847),

1198 
KQU
(16271867543011222991), KQU( 3905971519021791941),

1199 
KQU
(16814488397137052085), KQU( 1321197685504621613),

1200 
KQU
( 2870359191894002181), KQU(14317282970323395450),

1201 
KQU
(13663920845511074366), KQU( 2052463995796539594),

1202 
KQU
(14126345686431444337), KQU( 1727572121947022534),

1203 
KQU
(17793552254485594241), KQU( 6738857418849205750),

1204 
KQU
( 1282987123157442952), KQU(16655480021581159251),

1205 
KQU
( 6784587032080183866), KQU(14726758805359965162),

1206 
KQU
( 7577995933961987349), KQU(12539609320311114036),

1207 
KQU
(10789773033385439494), KQU( 8517001497411158227),

1208 
KQU
(10075543932136339710), KQU(14838152340938811081),

1209 
KQU
( 9560840631794044194), KQU(17445736541454117475),

1210 
KQU
(10633026464336393186), KQU(15705729708242246293),

1211 
KQU
( 1117517596891411098), KQU( 4305657943415886942),

1212 
KQU
( 4948856840533979263), KQU(16071681989041789593),

1213 
KQU
(13723031429272486527), KQU( 7639567622306509462),

1214 
KQU
(12670424537483090390), KQU( 9715223453097197134),

1215 
KQU
( 5457173389992686394), KQU( 289857129276135145),

1216 
KQU
(17048610270521972512), KQU( 692768013309835485),

1217 
KQU
(14823232360546632057), KQU(18218002361317895936),

1218 
KQU
( 3281724260212650204), KQU(16453957266549513795),

1219 
KQU
( 8592711109774511881), KQU( 929825123473369579),

1220 
KQU
(15966784769764367791), KQU( 9627344291450607588),

1221 
KQU
(10849555504977813287), KQU( 9234566913936339275),

1222 
KQU
( 6413807690366911210), KQU(10862389016184219267),

1223 
KQU
(13842504799335374048), KQU( 1531994113376881174),

1224 
KQU
( 2081314867544364459), KQU(16430628791616959932),

1225 
KQU
( 8314714038654394368), KQU( 9155473892098431813),

1226 
KQU
(12577843786670475704), KQU( 4399161106452401017),

1227 
KQU
( 1668083091682623186), KQU( 1741383777203714216),

1228 
KQU
( 2162597285417794374), KQU(15841980159165218736),

1229 
KQU
( 1971354603551467079), KQU( 1206714764913205968),

1230 
KQU
( 4790860439591272330), KQU(14699375615594055799),

1231 
KQU
( 8374423871657449988), KQU(10950685736472937738),

1232 
KQU
( 697344331343267176), KQU(10084998763118059810),

1233 
KQU
(12897369539795983124), KQU(12351260292144383605),

1234 
KQU
( 1268810970176811234), KQU( 7406287800414582768),

1235 
KQU
( 516169557043807831), KQU( 5077568278710520380),

1236 
KQU
( 3828791738309039304), KQU( 7721974069946943610),

1237 
KQU
( 3534670260981096460), KQU( 4865792189600584891),

1238 
KQU
(16892578493734337298), KQU( 9161499464278042590),

1239 
KQU
(11976149624067055931), KQU(13219479887277343990),

1240 
KQU
(14161556738111500680), KQU(14670715255011223056),

1241 
KQU
( 4671205678403576558), KQU(12633022931454259781),

1242 
KQU
(14821376219869187646), KQU( 751181776484317028),

1243 
KQU
( 2192211308839047070), KQU(11787306362361245189),

1244 
KQU
(10672375120744095707), KQU( 4601972328345244467),

1245 
KQU
(15457217788831125879), KQU( 8464345256775460809),

1246 
KQU
(10191938789487159478), KQU( 6184348739615197613),

1247 
KQU
(11425436778806882100), KQU( 2739227089124319793),

1248 
KQU
( 461464518456000551), KQU( 4689850170029177442),

1249 
KQU
( 6120307814374078625), KQU(11153579230681708671),

1250 
KQU
( 7891721473905347926), KQU(10281646937824872400),

1251 
KQU
( 3026099648191332248), KQU( 8666750296953273818),

1252 
KQU
(14978499698844363232), KQU(13303395102890132065),

1253 
KQU
( 8182358205292864080), KQU(10560547713972971291),

1254 
KQU
(11981635489418959093), KQU( 3134621354935288409),

1255 
KQU
(11580681977404383968), KQU(14205530317404088650),

1256 
KQU
( 5997789011854923157), KQU(13659151593432238041),

1257 
KQU
(11664332114338865086), KQU( 7490351383220929386),

1258 
KQU
( 7189290499881530378), KQU(15039262734271020220),

1259 
KQU
( 2057217285976980055), KQU( 555570804905355739),

1260 
KQU
(11235311968348555110), KQU(13824557146269603217),

1261 
KQU
(16906788840653099693), KQU( 7222878245455661677),

1262 
KQU
( 5245139444332423756), KQU( 4723748462805674292),

1263 
KQU
(12216509815698568612), KQU(17402362976648951187),

1264 
KQU
(17389614836810366768), KQU( 4880936484146667711),

1265 
KQU
( 9085007839292639880), KQU(13837353458498535449),

1266 
KQU
(11914419854360366677), KQU(16595890135313864103),

1267 
KQU
( 6313969847197627222), KQU(18296909792163910431),

1268 
KQU
(10041780113382084042), KQU( 2499478551172884794),

1269 
KQU
(11057894246241189489), KQU( 9742243032389068555),

1270 
KQU
(12838934582673196228), KQU(13437023235248490367),

1271 
KQU
(13372420669446163240), KQU( 6752564244716909224),

1272 
KQU
( 7157333073400313737), KQU(12230281516370654308),

1273 
KQU
( 1182884552219419117), KQU( 2955125381312499218),

1274 
KQU
(10308827097079443249), KQU( 1337648572986534958),

1275 
KQU
(16378788590020343939), KQU( 108619126514420935),

1276 
KQU
( 3990981009621629188), KQU( 5460953070230946410),

1277 
KQU
( 9703328329366531883), KQU(13166631489188077236),

1278 
KQU
( 1104768831213675170), KQU( 3447930458553877908),

1279 
KQU
( 8067172487769945676), KQU( 5445802098190775347),

1280 
KQU
( 3244840981648973873), KQU(17314668322981950060),

1281 
KQU
( 5006812527827763807), KQU(18158695070225526260),

1282 
KQU
( 2824536478852417853), KQU(13974775809127519886),

1283 
KQU
( 9814362769074067392), KQU(17276205156374862128),

1284 
KQU
(11361680725379306967), KQU( 3422581970382012542),

1285 
KQU
(11003189603753241266), KQU(11194292945277862261),

1286 
KQU
( 6839623313908521348), KQU(11935326462707324634),

1287 
KQU
( 1611456788685878444), KQU(13112620989475558907),

1288 
KQU
( 517659108904450427), KQU(13558114318574407624),

1289 
KQU
(15699089742731633077), KQU( 4988979278862685458),

1290 
KQU
( 8111373583056521297), KQU( 3891258746615399627),

1291 
KQU
( 8137298251469718086), KQU(12748663295624701649),

1292 
KQU
( 4389835683495292062), KQU( 5775217872128831729),

1293 
KQU
( 9462091896405534927), KQU( 8498124108820263989),

1294 
KQU
( 8059131278842839525), KQU(10503167994254090892),

1295 
KQU
(11613153541070396656), KQU(18069248738504647790),

1296 
KQU
( 570657419109768508), KQU( 3950574167771159665),

1297 
KQU
( 5514655599604313077), KQU( 2908460854428484165),

1298 
KQU
(10777722615935663114), KQU(12007363304839279486),

1299 
KQU
( 9800646187569484767), KQU( 8795423564889864287),

1300 
KQU
(14257396680131028419), KQU( 6405465117315096498),

1301 
KQU
( 7939411072208774878), KQU(17577572378528990006),

1302 
KQU
(14785873806715994850), KQU(16770572680854747390),

1303 
KQU
(18127549474419396481), KQU(11637013449455757750),

1304 
KQU
(14371851933996761086), KQU( 3601181063650110280),

1305 
KQU
( 4126442845019316144), KQU(10198287239244320669),

1306 
KQU
(18000169628555379659), KQU(18392482400739978269),

1307 
KQU
( 6219919037686919957), KQU( 3610085377719446052),

1308 
KQU
( 2513925039981776336), KQU(16679413537926716955),

1309 
KQU
(12903302131714909434), KQU( 5581145789762985009),

1310 
KQU
(12325955044293303233), KQU(17216111180742141204),

1311 
KQU
( 6321919595276545740), KQU( 3507521147216174501),

1312 
KQU
( 9659194593319481840), KQU(11473976005975358326),

1313 
KQU
(14742730101435987026), KQU( 492845897709954780),

1314 
KQU
(16976371186162599676), KQU(17712703422837648655),

1315 
KQU
( 9881254778587061697), KQU( 8413223156302299551),

1316 
KQU
( 1563841828254089168), KQU( 9996032758786671975),

1317 
KQU
( 138877700583772667), KQU(13003043368574995989),

1318 
KQU
( 4390573668650456587), KQU( 8610287390568126755),

1319 
KQU
(15126904974266642199), KQU( 6703637238986057662),

1320 
KQU
( 2873075592956810157), KQU( 6035080933946049418),

1321 
KQU
(13382846581202353014), KQU( 7303971031814642463),

1322 
KQU
(18418024405307444267), KQU( 5847096731675404647),

1323 
KQU
( 4035880699639842500), KQU(11525348625112218478),

1324 
KQU
( 3041162365459574102), KQU( 2604734487727986558),

1325 
KQU
(15526341771636983145), KQU(14556052310697370254),

1326 
KQU
(12997787077930808155), KQU( 9601806501755554499),

1327 
KQU
(11349677952521423389), KQU(14956777807644899350),

1328 
KQU
(16559736957742852721), KQU(12360828274778140726),

1329 
KQU
( 6685373272009662513), KQU(16932258748055324130),

1330 
KQU
(15918051131954158508), KQU( 1692312913140790144),

1331 
KQU
( 546653826801637367), KQU( 5341587076045986652),

1332 
KQU
(14975057236342585662), KQU(12374976357340622412),

1333 
KQU
(10328833995181940552), KQU(12831807101710443149),

1334 
KQU
(10548514914382545716), KQU( 2217806727199715993),

1335 
KQU
(12627067369242845138), KQU( 4598965364035438158),

1336 
KQU
( 150923352751318171), KQU(14274109544442257283),

1337 
KQU
( 4696661475093863031), KQU( 1505764114384654516),

1338 
KQU
(10699185831891495147), KQU( 2392353847713620519),

1339 
KQU
( 3652870166711788383), KQU( 8640653276221911108),

1340 
KQU
( 3894077592275889704), KQU( 4918592872135964845),

1341 
KQU
(16379121273281400789), KQU(12058465483591683656),

1342 
KQU
(11250106829302924945), KQU( 1147537556296983005),

1343 
KQU
( 6376342756004613268), KQU(14967128191709280506),

1344 
KQU
(18007449949790627628), KQU( 9497178279316537841),

1345 
KQU
( 7920174844809394893), KQU(10037752595255719907),

1346 
KQU
(15875342784985217697), KQU(15311615921712850696),

1347 
KQU
( 9552902652110992950), KQU(14054979450099721140),

1348 
KQU
( 5998709773566417349), KQU(18027910339276320187),

1349 
KQU
( 8223099053868585554), KQU( 7842270354824999767),

1350 
KQU
( 4896315688770080292), KQU(12969320296569787895),

1351 
KQU
( 2674321489185759961), KQU( 4053615936864718439),

1352 
KQU
(11349775270588617578), KQU( 4743019256284553975),

1353 
KQU
( 5602100217469723769), KQU(14398995691411527813),

1354 
KQU
( 7412170493796825470), KQU( 836262406131744846),

1355 
KQU
( 8231086633845153022), KQU( 5161377920438552287),

1356 
KQU
( 8828731196169924949), KQU(16211142246465502680),

1357 
KQU
( 3307990879253687818), KQU( 5193405406899782022),

1358 
KQU
( 8510842117467566693), KQU( 6070955181022405365),

1359 
KQU
(14482950231361409799), KQU(12585159371331138077),

1360 
KQU
( 3511537678933588148), KQU( 2041849474531116417),

1361 
KQU
(10944936685095345792), KQU(18303116923079107729),

1362 
KQU
( 2720566371239725320), KQU( 4958672473562397622),

1363 
KQU
( 3032326668253243412), KQU(13689418691726908338),

1364 
KQU
( 1895205511728843996), KQU( 8146303515271990527),

1365 
KQU
(16507343500056113480), KQU( 473996939105902919),

1366 
KQU
( 9897686885246881481), KQU(14606433762712790575),

1367 
KQU
( 6732796251605566368), KQU( 1399778120855368916),

1368 
KQU
( 935023885182833777), KQU(16066282816186753477),

1369 
KQU
( 7291270991820612055), KQU(17530230393129853844),

1370 
KQU
(10223493623477451366), KQU(15841725630495676683),

1371 
KQU
(17379567246435515824), KQU( 8588251429375561971),

1372 
KQU
(18339511210887206423), KQU(17349587430725976100),

1373 
KQU
(12244876521394838088), KQU( 6382187714147161259),

1374 
KQU
(12335807181848950831), KQU(16948885622305460665),

1375 
KQU
(13755097796371520506), KQU(14806740373324947801),

1376 
KQU
( 4828699633859287703), KQU( 8209879281452301604),

1377 
KQU
(12435716669553736437), KQU(13970976859588452131),

1378 
KQU
( 6233960842566773148), KQU(12507096267900505759),

1379 
KQU
( 1198713114381279421), KQU(14989862731124149015),

1380 
KQU
(15932189508707978949), KQU( 2526406641432708722),

1381 
KQU
( 29187427817271982), KQU( 1499802773054556353),

1382 
KQU
(10816638187021897173), KQU( 5436139270839738132),

1383 
KQU
( 6659882287036010082), KQU( 2154048955317173697),

1384 
KQU
(10887317019333757642), KQU(16281091802634424955),

1385 
KQU
(10754549879915384901), KQU(10760611745769249815),

1386 
KQU
( 2161505946972504002), KQU( 5243132808986265107),

1387 
KQU
(10129852179873415416), KQU( 710339480008649081),

1388 
KQU
( 7802129453068808528), KQU(17967213567178907213),

1389 
KQU
(15730859124668605599), KQU(13058356168962376502),

1390 
KQU
( 3701224985413645909), KQU(14464065869149109264),

1391 
KQU
( 9959272418844311646), KQU(10157426099515958752),

1392 
KQU
(14013736814538268528), KQU(17797456992065653951),

1393 
KQU
(17418878140257344806), KQU(15457429073540561521),

1394 
KQU
( 2184426881360949378), KQU( 2062193041154712416),

1395 
KQU
( 8553463347406931661), KQU( 4913057625202871854),

1396 
KQU
( 2668943682126618425), KQU(17064444737891172288),

1397 
KQU
( 4997115903913298637), KQU(12019402608892327416),

1398 
KQU
(17603584559765897352), KQU(11367529582073647975),

1399 
KQU
( 8211476043518436050), KQU( 8676849804070323674),

1400 
KQU
(18431829230394475730), KQU(10490177861361247904),

1401 
KQU
( 9508720602025651349), KQU( 7409627448555722700),

1402 
KQU
( 5804047018862729008), KQU(11943858176893142594),

1403 
KQU
(11908095418933847092), KQU( 5415449345715887652),

1404 
KQU
( 1554022699166156407), KQU( 9073322106406017161),

1405 
KQU
( 7080630967969047082), KQU(18049736940860732943),

1406 
KQU
(12748714242594196794), KQU( 1226992415735156741),

1407 
KQU
(17900981019609531193), KQU(11720739744008710999),

1408 
KQU
( 3006400683394775434), KQU(11347974011751996028),

1409 
KQU
( 3316999628257954608), KQU( 8384484563557639101),

1410 
KQU
(18117794685961729767), KQU( 1900145025596618194),

1411 
KQU
(17459527840632892676), KQU( 5634784101865710994),

1412 
KQU
( 7918619300292897158), KQU( 3146577625026301350),

1413 
KQU
( 9955212856499068767), KQU( 1873995843681746975),

1414 
KQU
( 1561487759967972194), KQU( 8322718804375878474),

1415 
KQU
(11300284215327028366), KQU( 4667391032508998982),

1416 
KQU
( 9820104494306625580), KQU(17922397968599970610),

1417 
KQU
( 1784690461886786712), KQU(14940365084341346821),

1418 
KQU
( 5348719575594186181), KQU(10720419084507855261),

1419 
KQU
(14210394354145143274), KQU( 2426468692164000131),

1420 
KQU
(16271062114607059202), KQU(14851904092357070247),

1421 
KQU
( 6524493015693121897), KQU( 9825473835127138531),

1422 
KQU
(14222500616268569578), KQU(15521484052007487468),

1423 
KQU
(14462579404124614699), KQU(11012375590820665520),

1424 
KQU
(11625327350536084927), KQU(14452017765243785417),

1425 
KQU
( 9989342263518766305), KQU( 3640105471101803790),

1426 
KQU
( 4749866455897513242), KQU(13963064946736312044),

1427 
KQU
(10007416591973223791), KQU(18314132234717431115),

1428 
KQU
( 3286596588617483450), KQU( 7726163455370818765),

1429 
KQU
( 7575454721115379328), KQU( 5308331576437663422),

1430 
KQU
(18288821894903530934), KQU( 8028405805410554106),

1431 
KQU
(15744019832103296628), KQU( 149765559630932100),

1432 
KQU
( 6137705557200071977), KQU(14513416315434803615),

1433 
KQU
(11665702820128984473), KQU( 218926670505601386),

1434 
KQU
( 6868675028717769519), KQU(15282016569441512302),

1435 
KQU
( 5707000497782960236), KQU( 6671120586555079567),

1436 
KQU
( 2194098052618985448), KQU(16849577895477330978),

1437 
KQU
(12957148471017466283), KQU( 1997805535404859393),

1438 
KQU
( 1180721060263860490), KQU(13206391310193756958),

1439 
KQU
(12980208674461861797), KQU( 3825967775058875366),

1440 
KQU
(17543433670782042631), KQU( 1518339070120322730),

1441 
KQU
(16344584340890991669), KQU( 2611327165318529819),

1442 
KQU
(11265022723283422529), KQU( 4001552800373196817),

1443 
KQU
(14509595890079346161), KQU( 3528717165416234562),

1444 
KQU
(18153222571501914072), KQU( 9387182977209744425),

1445 
KQU
(10064342315985580021), KQU(11373678413215253977),

1446 
KQU
( 2308457853228798099), KQU( 9729042942839545302),

1447 
KQU
( 7833785471140127746), KQU( 6351049900319844436),

1448 
KQU
(14454610627133496067), KQU(12533175683634819111),

1449 
KQU
(15570163926716513029), KQU(13356980519185762498)

1452 
	$TEST_BEGIN
(
‹¡_g’_¿nd_32
)

1454 
ušt32_t
 
¬¿y32
[
BLOCK_SIZE
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1455 
ušt32_t
 
¬¿y32_2
[
BLOCK_SIZE
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1456 
i
;

1457 
ušt32_t
 
r32
;

1458 
sfmt_t
 *
ùx
;

1460 
	`as£¹_d_Ë
(
	`g‘_mš_¬¿y_size32
(), 
BLOCK_SIZE
,

1462 
ùx
 = 
	`š™_g’_¿nd
(1234);

1463 
	`fl_¬¿y32
(
ùx
, 
¬¿y32
, 
BLOCK_SIZE
);

1464 
	`fl_¬¿y32
(
ùx
, 
¬¿y32_2
, 
BLOCK_SIZE
);

1465 
	`fši_g’_¿nd
(
ùx
);

1467 
ùx
 = 
	`š™_g’_¿nd
(1234);

1468 
i
 = 0; i < 
BLOCK_SIZE
; i++) {

1469 ià(
i
 < 
COUNT_1
) {

1470 
	`as£¹_u32_eq
(
¬¿y32
[
i
], 
š™_g’_¿nd_32_ex³ùed
[i],

1471 "Ouuˆmism©ch fÜ i=%d", 
i
);

1473 
r32
 = 
	`g’_¿nd32
(
ùx
);

1474 
	`as£¹_u32_eq
(
r32
, 
¬¿y32
[
i
],

1475 "Mism©ch‡ˆ¬¿y32[%d]=%x, g’=%x", 
i
, 
¬¿y32
[i], 
r32
);

1477 
i
 = 0; i < 
COUNT_2
; i++) {

1478 
r32
 = 
	`g’_¿nd32
(
ùx
);

1479 
	`as£¹_u32_eq
(
r32
, 
¬¿y32_2
[
i
],

1480 "Mism©ch‡ˆ¬¿y32_2[%d]=%x, g’=%x", 
i
, 
¬¿y32_2
[i],

1481 
r32
);

1483 
	`fši_g’_¿nd
(
ùx
);

1484 
	}
}

1485 
TEST_END


1487 
	$TEST_BEGIN
(
‹¡_by_¬¿y_32
)

1489 
ušt32_t
 
¬¿y32
[
BLOCK_SIZE
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1490 
ušt32_t
 
¬¿y32_2
[
BLOCK_SIZE
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1491 
i
;

1492 
ušt32_t
 
ši
[4] = {0x1234, 0x5678, 0x9abc, 0xdef0};

1493 
ušt32_t
 
r32
;

1494 
sfmt_t
 *
ùx
;

1496 
	`as£¹_d_Ë
(
	`g‘_mš_¬¿y_size32
(), 
BLOCK_SIZE
,

1498 
ùx
 = 
	`š™_by_¬¿y
(
ši
, 4);

1499 
	`fl_¬¿y32
(
ùx
, 
¬¿y32
, 
BLOCK_SIZE
);

1500 
	`fl_¬¿y32
(
ùx
, 
¬¿y32_2
, 
BLOCK_SIZE
);

1501 
	`fši_g’_¿nd
(
ùx
);

1503 
ùx
 = 
	`š™_by_¬¿y
(
ši
, 4);

1504 
i
 = 0; i < 
BLOCK_SIZE
; i++) {

1505 ià(
i
 < 
COUNT_1
) {

1506 
	`as£¹_u32_eq
(
¬¿y32
[
i
], 
š™_by_¬¿y_32_ex³ùed
[i],

1507 "Ouuˆmism©ch fÜ i=%d", 
i
);

1509 
r32
 = 
	`g’_¿nd32
(
ùx
);

1510 
	`as£¹_u32_eq
(
r32
, 
¬¿y32
[
i
],

1511 "Mism©ch‡ˆ¬¿y32[%d]=%x, g’=%x", 
i
, 
¬¿y32
[i], 
r32
);

1513 
i
 = 0; i < 
COUNT_2
; i++) {

1514 
r32
 = 
	`g’_¿nd32
(
ùx
);

1515 
	`as£¹_u32_eq
(
r32
, 
¬¿y32_2
[
i
],

1516 "Mism©ch‡ˆ¬¿y32_2[%d]=%x, g’=%x", 
i
, 
¬¿y32_2
[i],

1517 
r32
);

1519 
	`fši_g’_¿nd
(
ùx
);

1520 
	}
}

1521 
TEST_END


1523 
	$TEST_BEGIN
(
‹¡_g’_¿nd_64
)

1525 
ušt64_t
 
¬¿y64
[
BLOCK_SIZE64
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1526 
ušt64_t
 
¬¿y64_2
[
BLOCK_SIZE64
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1527 
i
;

1528 
ušt64_t
 
r
;

1529 
sfmt_t
 *
ùx
;

1531 
	`as£¹_d_Ë
(
	`g‘_mš_¬¿y_size64
(), 
BLOCK_SIZE64
,

1533 
ùx
 = 
	`š™_g’_¿nd
(4321);

1534 
	`fl_¬¿y64
(
ùx
, 
¬¿y64
, 
BLOCK_SIZE64
);

1535 
	`fl_¬¿y64
(
ùx
, 
¬¿y64_2
, 
BLOCK_SIZE64
);

1536 
	`fši_g’_¿nd
(
ùx
);

1538 
ùx
 = 
	`š™_g’_¿nd
(4321);

1539 
i
 = 0; i < 
BLOCK_SIZE64
; i++) {

1540 ià(
i
 < 
COUNT_1
) {

1541 
	`as£¹_u64_eq
(
¬¿y64
[
i
], 
š™_g’_¿nd_64_ex³ùed
[i],

1542 "Ouuˆmism©ch fÜ i=%d", 
i
);

1544 
r
 = 
	`g’_¿nd64
(
ùx
);

1545 
	`as£¹_u64_eq
(
r
, 
¬¿y64
[
i
],

1546 "Mism©ch‡ˆ¬¿y64[%d]=%"
FMTx64
", g’=%"FMTx64, 
i
,

1547 
¬¿y64
[
i
], 
r
);

1549 
i
 = 0; i < 
COUNT_2
; i++) {

1550 
r
 = 
	`g’_¿nd64
(
ùx
);

1551 
	`as£¹_u64_eq
(
r
, 
¬¿y64_2
[
i
],

1552 "Mism©ch‡ˆ¬¿y64_2[%d]=%"
FMTx64
" g’=%"FMTx64"", 
i
,

1553 
¬¿y64_2
[
i
], 
r
);

1555 
	`fši_g’_¿nd
(
ùx
);

1556 
	}
}

1557 
TEST_END


1559 
	$TEST_BEGIN
(
‹¡_by_¬¿y_64
)

1561 
ušt64_t
 
¬¿y64
[
BLOCK_SIZE64
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1562 
ušt64_t
 
¬¿y64_2
[
BLOCK_SIZE64
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1563 
i
;

1564 
ušt64_t
 
r
;

1565 
ušt32_t
 
ši
[] = {5, 4, 3, 2, 1};

1566 
sfmt_t
 *
ùx
;

1568 
	`as£¹_d_Ë
(
	`g‘_mš_¬¿y_size64
(), 
BLOCK_SIZE64
,

1570 
ùx
 = 
	`š™_by_¬¿y
(
ši
, 5);

1571 
	`fl_¬¿y64
(
ùx
, 
¬¿y64
, 
BLOCK_SIZE64
);

1572 
	`fl_¬¿y64
(
ùx
, 
¬¿y64_2
, 
BLOCK_SIZE64
);

1573 
	`fši_g’_¿nd
(
ùx
);

1575 
ùx
 = 
	`š™_by_¬¿y
(
ši
, 5);

1576 
i
 = 0; i < 
BLOCK_SIZE64
; i++) {

1577 ià(
i
 < 
COUNT_1
) {

1578 
	`as£¹_u64_eq
(
¬¿y64
[
i
], 
š™_by_¬¿y_64_ex³ùed
[i],

1579 "Ouuˆmism©ch fÜ i=%d", 
i
);

1581 
r
 = 
	`g’_¿nd64
(
ùx
);

1582 
	`as£¹_u64_eq
(
r
, 
¬¿y64
[
i
],

1583 "Mism©ch‡ˆ¬¿y64[%d]=%"
FMTx64
" g’=%"FMTx64, 
i
,

1584 
¬¿y64
[
i
], 
r
);

1586 
i
 = 0; i < 
COUNT_2
; i++) {

1587 
r
 = 
	`g’_¿nd64
(
ùx
);

1588 
	`as£¹_u64_eq
(
r
, 
¬¿y64_2
[
i
],

1589 "Mism©ch‡ˆ¬¿y64_2[%d]=%"
FMTx64
" g’=%"FMTx64, 
i
,

1590 
¬¿y64_2
[
i
], 
r
);

1592 
	`fši_g’_¿nd
(
ùx
);

1593 
	}
}

1594 
TEST_END


1597 
	$maš
()

1600  (
	`‹¡
(

1601 
‹¡_g’_¿nd_32
,

1602 
‹¡_by_¬¿y_32
,

1603 
‹¡_g’_¿nd_64
,

1604 
‹¡_by_¬¿y_64
));

1605 
	}
}

	@dep/jemalloc-4.2.0/test/unit/a0.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_a0
)

5 *
p
;

7 
p
 = 
	`a0m®loc
(1);

8 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected‡0malloc()ƒrror");

9 
	`a0d®loc
(
p
);

10 
	}
}

11 
TEST_END


14 
	$maš
()

17  (
	`‹¡_no_m®loc_š™
(

18 
‹¡_a0
));

19 
	}
}

	@dep/jemalloc-4.2.0/test/unit/arena_reset.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 = "prof:true,lg_prof_sample:0";

8 
	$g‘_nsizes_im¶
(cÚ¡ *
cmd
)

10 
»t
;

11 
size_t
 
z
;

13 
z
 = ();

14 
	`as£¹_d_eq
(
	`m®lùl
(
cmd
, &
»t
, &
z
, 
NULL
, 0), 0,

15 "UÃx³ùed m®lùl(\"%s\", ...èçu»", 
cmd
);

17  (
»t
);

18 
	}
}

21 
	$g‘_nsm®l
()

24  (
	`g‘_nsizes_im¶
("arenas.nbins"));

25 
	}
}

28 
	$g‘_Æ¬ge
()

31  (
	`g‘_nsizes_im¶
("arenas.nlruns"));

32 
	}
}

35 
	$g‘_nhuge
()

38  (
	`g‘_nsizes_im¶
("arenas.nhchunks"));

39 
	}
}

41 
size_t


42 
	$g‘_size_im¶
(cÚ¡ *
cmd
, 
size_t
 
šd
)

44 
size_t
 
»t
;

45 
size_t
 
z
;

46 
size_t
 
mib
[4];

47 
size_t
 
mibËn
 = 4;

49 
z
 = (
size_t
);

50 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
(
cmd
, 
mib
, &
mibËn
),

51 0, "UÃx³ùed m®lùÊam‘omib(\"%s\", ...èçu»", 
cmd
);

52 
mib
[2] = 
šd
;

53 
z
 = (
size_t
);

54 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
»t
, &
z
, 
NULL
, 0),

55 0, "UÃx³ùed m®lùlbymib([\"%s\", %zu], ...èçu»", 
cmd
, 
šd
);

57  (
»t
);

58 
	}
}

60 
size_t


61 
	$g‘_sm®l_size
(
size_t
 
šd
)

64  (
	`g‘_size_im¶
("¬’as.bš.0.size", 
šd
));

65 
	}
}

67 
size_t


68 
	$g‘_Ïrge_size
(
size_t
 
šd
)

71  (
	`g‘_size_im¶
("¬’as.Ìun.0.size", 
šd
));

72 
	}
}

74 
size_t


75 
	$g‘_huge_size
(
size_t
 
šd
)

78  (
	`g‘_size_im¶
("¬’as.hchunk.0.size", 
šd
));

79 
	}
}

81 
	$TEST_BEGIN
(
‹¡_¬’a_»£t
)

83 
	#NHUGE
 4

	)

84 
¬’a_šd
, 
nsm®l
, 
Æ¬ge
, 
nhuge
, 
ÅŒs
, 
i
;

85 
size_t
 
sz
, 
mibËn
;

86 **
±rs
;

87 
æags
;

88 
size_t
 
mib
[3];

89 
tsdn_t
 *
tsdn
;

91 
	`‹¡_sk_if
((
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
)è|| (
cÚfig_fl


92 && 
	`uÆik–y
(
İt_qu¬ªtše
)));

94 
sz
 = ();

95 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.ex‹nd", &
¬’a_šd
, &
sz
, 
NULL
, 0), 0,

98 
æags
 = 
	`MALLOCX_ARENA
(
¬’a_šd
è| 
MALLOCX_TCACHE_NONE
;

100 
nsm®l
 = 
	`g‘_nsm®l
();

101 
Æ¬ge
 = 
	`g‘_Æ¬ge
();

102 
nhuge
 = 
	`g‘_nhuge
(è> 
NHUGE
 ? NHUGE : get_nhuge();

103 
ÅŒs
 = 
nsm®l
 + 
Æ¬ge
 + 
nhuge
;

104 
±rs
 = (**)
	`m®loc
(
ÅŒs
 * (*));

105 
	`as£¹_±r_nÙ_nuÎ
(
±rs
, "Unexpected malloc() failure");

108 
i
 = 0; i < 
nsm®l
; i++) {

109 
sz
 = 
	`g‘_sm®l_size
(
i
);

110 
±rs
[
i
] = 
	`m®locx
(
sz
, 
æags
);

111 
	`as£¹_±r_nÙ_nuÎ
(
±rs
[
i
],

112 "UÃx³ùed m®locx(%zu, %#xèçu»", 
sz
, 
æags
);

114 
i
 = 0; i < 
Æ¬ge
; i++) {

115 
sz
 = 
	`g‘_Ïrge_size
(
i
);

116 
±rs
[
nsm®l
 + 
i
] = 
	`m®locx
(
sz
, 
æags
);

117 
	`as£¹_±r_nÙ_nuÎ
(
±rs
[
i
],

118 "UÃx³ùed m®locx(%zu, %#xèçu»", 
sz
, 
æags
);

120 
i
 = 0; i < 
nhuge
; i++) {

121 
sz
 = 
	`g‘_huge_size
(
i
);

122 
±rs
[
nsm®l
 + 
Æ¬ge
 + 
i
] = 
	`m®locx
(
sz
, 
æags
);

123 
	`as£¹_±r_nÙ_nuÎ
(
±rs
[
i
],

124 "UÃx³ùed m®locx(%zu, %#xèçu»", 
sz
, 
æags
);

127 
tsdn
 = 
	`tsdn_ãtch
();

130 
i
 = 0; i < 
ÅŒs
; i++) {

131 
	`as£¹_zu_gt
(
	`iv§Îoc
(
tsdn
, 
±rs
[
i
], 
çl£
), 0,

136 
mibËn
 = (
mib
)/(
size_t
);

137 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.»£t", 
mib
, &
mibËn
), 0,

139 
mib
[1] = (
size_t
)
¬’a_šd
;

140 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, NULL, 0), 0,

144 
i
 = 0; i < 
ÅŒs
; i++) {

145 
	`as£¹_zu_eq
(
	`iv§Îoc
(
tsdn
, 
±rs
[
i
], 
çl£
), 0,

149 
	`ä“
(
±rs
);

150 
	}
}

151 
TEST_END


154 
	$maš
()

157  (
	`‹¡
(

158 
‹¡_¬’a_»£t
));

159 
	}
}

	@dep/jemalloc-4.2.0/test/unit/atomic.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#TEST_STRUCT
(
p
, 
t
) \

4 
p
##
_‹¡_s
 { \

5 
t
 
accum0
; \

6 
t
 
x
; \

7 
t
 
s
; \

9 
p
##
	t_‹¡_s
 
	tp
##
	t_‹¡_t
;

	)

11 
	#TEST_BODY
(
p
, 
t
, 
tc
, 

, 
FMT
) do { \

12 cÚ¡ 
p
##
_‹¡_t
 
‹¡s
[] = { \

13 {(
t
)-1, (t)-1, (t)-2}, \

14 {(
t
)-1, (t) 0, (t)-2}, \

15 {(
t
)-1, (t) 1, (t)-2}, \

17 {(
t
) 0, (t)-1, (t)-2}, \

18 {(
t
) 0, (t) 0, (t)-2}, \

19 {(
t
) 0, (t) 1, (t)-2}, \

21 {(
t
) 1, (t)-1, (t)-2}, \

22 {(
t
) 1, (t) 0, (t)-2}, \

23 {(
t
) 1, (t) 1, (t)-2}, \

25 {(
t
)0, (t)-(1 << 22), (t)-2}, \

26 {(
t
)0, (t)(1 << 22), (t)-2}, \

27 {(
t
)(1 << 22), (t)-(1 << 22), (t)-2}, \

28 {(
t
)(1 << 22), (t)(1 << 22), (t)-2} \

30 
i
; \

32 
i
 = 0; i < (
‹¡s
)/(
p
##
_‹¡_t
); i++) { \

33 
boŞ
 
”r
; \

34 
t
 
accum
 = 
‹¡s
[
i
].
accum0
; \

35 
as£¹_
##

##
	`_eq
(
©omic_»ad_
##
	`p
(&
accum
), \

36 
‹¡s
[
i
].
accum0
, \

37 "E¼Úeou »ad, i=%u", 
i
); \

39 
as£¹_
##

##
	`_eq
(
©omic_add_
##
	`p
(&
accum
, 
‹¡s
[
i
].
x
), \

40 (
t
)((
tc
)
‹¡s
[
i
].
accum0
 + (tcée¡s[i].
x
), \

41 "i=%u,‡ccum=%"
FMT
", x=%"FMT, \

42 
i
, 
‹¡s
[i].
accum0
,e¡s[i].
x
); \

43 
as£¹_
##

##
	`_eq
(
©omic_»ad_
##
	`p
(&
accum
),‡ccum, \

44 "E¼Úeou add, i=%u", 
i
); \

46 
accum
 = 
‹¡s
[
i
].
accum0
; \

47 
as£¹_
##

##
	`_eq
(
©omic_sub_
##
	`p
(&
accum
, 
‹¡s
[
i
].
x
), \

48 (
t
)((
tc
)
‹¡s
[
i
].
accum0
 - (tcée¡s[i].
x
), \

49 "i=%u,‡ccum=%"
FMT
", x=%"FMT, \

50 
i
, 
‹¡s
[i].
accum0
,e¡s[i].
x
); \

51 
as£¹_
##

##
	`_eq
(
©omic_»ad_
##
	`p
(&
accum
),‡ccum, \

52 "E¼Úeou sub, i=%u", 
i
); \

54 
accum
 = 
‹¡s
[
i
].
accum0
; \

55 
”r
 = 
©omic_ÿs_
##
	`p
(&
accum
, 
‹¡s
[
i
].
x
,e¡s[i].
s
); \

56 
	`as£¹_b_eq
(
”r
, 
‹¡s
[
i
].
accum0
 !ğ‹¡s[i].
x
, \

58 
as£¹_
##

##
	`_eq
(
accum
, 
”r
 ? 
‹¡s
[
i
].
accum0
 : \

59 
‹¡s
[
i
].
s
, "Erroneous casƒffect, i=%u", i); \

61 
accum
 = 
‹¡s
[
i
].
accum0
; \

62 
©omic_wr™e_
##
	`p
(&
accum
, 
‹¡s
[
i
].
s
); \

63 
as£¹_
##

##
	`_eq
(
accum
, 
‹¡s
[
i
].
s
, \

64 "E¼Úeou wr™e, i=%u", 
i
); \

66 } 0)

	)

68 
	$TEST_STRUCT
(
ušt64
, 
ušt64_t
)

69 
	$TEST_BEGIN
(
‹¡_©omic_ušt64
)

72 #ià!(
LG_SIZEOF_PTR
 =ğ3 || 
LG_SIZEOF_INT
 == 3)

73 
	`‹¡_sk
("64-bit‡tomic operations‚ot supported");

75 
	`TEST_BODY
(
ušt64
, 
ušt64_t
, ušt64_t, 
u64
, 
FMTx64
);

77 
	}
}

78 
TEST_END


80 
	$TEST_STRUCT
(
ušt32
, 
ušt32_t
)

81 
	$TEST_BEGIN
(
‹¡_©omic_ušt32
)

84 
	`TEST_BODY
(
ušt32
, 
ušt32_t
, ušt32_t, 
u32
, "#"
FMTx32
);

85 
	}
}

86 
TEST_END


88 
	$TEST_STRUCT
(
p
, *)

89 
	$TEST_BEGIN
(
‹¡_©omic_p
)

92 
	`TEST_BODY
(
p
, *, 
ušŒ_t
, 
±r
, "p");

93 
	}
}

94 
TEST_END


96 
	$TEST_STRUCT
(
z
, 
size_t
)

97 
	$TEST_BEGIN
(
‹¡_©omic_z
)

100 
	`TEST_BODY
(
z
, 
size_t
, size_t, 
zu
, "#zx");

101 
	}
}

102 
TEST_END


104 
	$TEST_STRUCT
(
u
, )

105 
	$TEST_BEGIN
(
‹¡_©omic_u
)

108 
	`TEST_BODY
(
u
, , , u, "#x");

109 
	}
}

110 
TEST_END


113 
	$maš
()

116  (
	`‹¡
(

117 
‹¡_©omic_ušt64
,

118 
‹¡_©omic_ušt32
,

119 
‹¡_©omic_p
,

120 
‹¡_©omic_z
,

121 
‹¡_©omic_u
));

122 
	}
}

	@dep/jemalloc-4.2.0/test/unit/bitmap.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_b™m­_size
)

5 
size_t
 
i
, 
´ev_size
;

7 
´ev_size
 = 0;

8 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

9 
b™m­_šfo_t
 
bšfo
;

10 
size_t
 
size
;

12 
	`b™m­_šfo_š™
(&
bšfo
, 
i
);

13 
size
 = 
	`b™m­_size
(&
bšfo
);

14 
	`as£¹_Œue
(
size
 >ğ
´ev_size
,

16 
´ev_size
 = 
size
;

18 
	}
}

19 
TEST_END


21 
	$TEST_BEGIN
(
‹¡_b™m­_š™
)

23 
size_t
 
i
;

25 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

26 
b™m­_šfo_t
 
bšfo
;

27 
	`b™m­_šfo_š™
(&
bšfo
, 
i
);

29 
size_t
 
j
;

30 
b™m­_t
 *
b™m­
 = (b™m­_ˆ*)
	`m®loc
(

31 
	`b™m­_size
(&
bšfo
));

32 
	`b™m­_š™
(
b™m­
, &
bšfo
);

34 
j
 = 0; j < 
i
; j++) {

35 
	`as£¹_çl£
(
	`b™m­_g‘
(
b™m­
, &
bšfo
, 
j
),

38 
	`ä“
(
b™m­
);

41 
	}
}

42 
TEST_END


44 
	$TEST_BEGIN
(
‹¡_b™m­_£t
)

46 
size_t
 
i
;

48 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

49 
b™m­_šfo_t
 
bšfo
;

50 
	`b™m­_šfo_š™
(&
bšfo
, 
i
);

52 
size_t
 
j
;

53 
b™m­_t
 *
b™m­
 = (b™m­_ˆ*)
	`m®loc
(

54 
	`b™m­_size
(&
bšfo
));

55 
	`b™m­_š™
(
b™m­
, &
bšfo
);

57 
j
 = 0; j < 
i
; j++)

58 
	`b™m­_£t
(
b™m­
, &
bšfo
, 
j
);

59 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

61 
	`ä“
(
b™m­
);

64 
	}
}

65 
TEST_END


67 
	$TEST_BEGIN
(
‹¡_b™m­_un£t
)

69 
size_t
 
i
;

71 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

72 
b™m­_šfo_t
 
bšfo
;

73 
	`b™m­_šfo_š™
(&
bšfo
, 
i
);

75 
size_t
 
j
;

76 
b™m­_t
 *
b™m­
 = (b™m­_ˆ*)
	`m®loc
(

77 
	`b™m­_size
(&
bšfo
));

78 
	`b™m­_š™
(
b™m­
, &
bšfo
);

80 
j
 = 0; j < 
i
; j++)

81 
	`b™m­_£t
(
b™m­
, &
bšfo
, 
j
);

82 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

84 
j
 = 0; j < 
i
; j++)

85 
	`b™m­_un£t
(
b™m­
, &
bšfo
, 
j
);

86 
j
 = 0; j < 
i
; j++)

87 
	`b™m­_£t
(
b™m­
, &
bšfo
, 
j
);

88 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

90 
	`ä“
(
b™m­
);

93 
	}
}

94 
TEST_END


96 
	$TEST_BEGIN
(
‹¡_b™m­_sfu
)

98 
size_t
 
i
;

100 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

101 
b™m­_šfo_t
 
bšfo
;

102 
	`b™m­_šfo_š™
(&
bšfo
, 
i
);

104 
size_t
 
j
;

105 
b™m­_t
 *
b™m­
 = (b™m­_ˆ*)
	`m®loc
(

106 
	`b™m­_size
(&
bšfo
));

107 
	`b™m­_š™
(
b™m­
, &
bšfo
);

110 
j
 = 0; j < 
i
; j++) {

111 
	`as£¹_zd_eq
(
	`b™m­_sfu
(
b™m­
, &
bšfo
), 
j
,

115 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

122 
j
 = 
i
 - 1; j < i; j--) {

123 
	`b™m­_un£t
(
b™m­
, &
bšfo
, 
j
);

124 
	`as£¹_zd_eq
(
	`b™m­_sfu
(
b™m­
, &
bšfo
), 
j
,

127 
	`b™m­_un£t
(
b™m­
, &
bšfo
, 
j
);

129 
	`as£¹_çl£
(
	`b™m­_g‘
(
b™m­
, &
bšfo
, 0),

136 
j
 = 1; j < 
i
; j++) {

137 
	`b™m­_£t
(
b™m­
, &
bšfo
, 
j
 - 1);

138 
	`as£¹_zd_eq
(
	`b™m­_sfu
(
b™m­
, &
bšfo
), 
j
,

141 
	`b™m­_un£t
(
b™m­
, &
bšfo
, 
j
);

143 
	`as£¹_zd_eq
(
	`b™m­_sfu
(
b™m­
, &
bšfo
), 
i
 - 1,

145 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

147 
	`ä“
(
b™m­
);

150 
	}
}

151 
TEST_END


154 
	$maš
()

157  (
	`‹¡
(

158 
‹¡_b™m­_size
,

159 
‹¡_b™m­_š™
,

160 
‹¡_b™m­_£t
,

161 
‹¡_b™m­_un£t
,

162 
‹¡_b™m­_sfu
));

163 
	}
}

	@dep/jemalloc-4.2.0/test/unit/ckh.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_Ãw_d–‘e
)

5 
tsdn_t
 *
tsdn
;

6 
ckh_t
 
ckh
;

8 
tsdn
 = 
	`tsdn_ãtch
();

10 
	`as£¹_çl£
(
	`ckh_Ãw
(
tsdn
, &
ckh
, 2, 
ckh_¡ršg_hash
,

11 
ckh_¡ršg_keycomp
), "Unexpected ckh_new()ƒrror");

12 
	`ckh_d–‘e
(
tsdn
, &
ckh
);

14 
	`as£¹_çl£
(
	`ckh_Ãw
(
tsdn
, &
ckh
, 3, 
ckh_poš‹r_hash
,

15 
ckh_poš‹r_keycomp
), "Unexpected ckh_new()ƒrror");

16 
	`ckh_d–‘e
(
tsdn
, &
ckh
);

17 
	}
}

18 
TEST_END


20 
	$TEST_BEGIN
(
‹¡_couÁ_š£¹_£¬ch_»move
)

22 
tsdn_t
 *
tsdn
;

23 
ckh_t
 
ckh
;

24 cÚ¡ *
¡rs
[] = {

30 cÚ¡ *
missšg
 = "A string‚ot inhe hashable.";

31 
size_t
 
i
;

33 
tsdn
 = 
	`tsdn_ãtch
();

35 
	`as£¹_çl£
(
	`ckh_Ãw
(
tsdn
, &
ckh
, 2, 
ckh_¡ršg_hash
,

36 
ckh_¡ršg_keycomp
), "Unexpected ckh_new()ƒrror");

37 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
), 0,

38 "ckh_couÁ(èshould„‘uº %zu, buˆ™„‘uºed %zu", 
	`ZU
(0),

39 
	`ckh_couÁ
(&
ckh
));

42 
i
 = 0; i < (
¡rs
)/(const *); i++) {

43 
	`ckh_š£¹
(
tsdn
, &
ckh
, 
¡rs
[
i
], strs[i]);

44 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
), 
i
+1,

45 "ckh_couÁ(èshould„‘uº %zu, buˆ™„‘uºed %zu", 
i
+1,

46 
	`ckh_couÁ
(&
ckh
));

50 
i
 = 0; i < (
¡rs
)/(const *); i++) {

52 *
p
;

53 cÚ¡ *
s
;

54 } 
k
, 
v
;

55 **
kp
, **
vp
;

56 cÚ¡ *
ks
, *
vs
;

58 
kp
 = (
i
 & 1è? &
k
.
p
 : 
NULL
;

59 
vp
 = (
i
 & 2è? &
v
.
p
 : 
NULL
;

60 
k
.
p
 = 
NULL
;

61 
v
.
p
 = 
NULL
;

62 
	`as£¹_çl£
(
	`ckh_£¬ch
(&
ckh
, 
¡rs
[
i
], 
kp
, 
vp
),

65 
ks
 = (
i
 & 1è? 
¡rs
[i] : (cÚ¡ *)
NULL
;

66 
vs
 = (
i
 & 2è? 
¡rs
[i] : (cÚ¡ *)
NULL
;

67 
	`as£¹_±r_eq
((*)
ks
, (*)
k
.
s
, "Key mismatch, i=%zu",

68 
i
);

69 
	`as£¹_±r_eq
((*)
vs
, (*)
v
.
s
, "Value mismatch, i=%zu",

70 
i
);

72 
	`as£¹_Œue
(
	`ckh_£¬ch
(&
ckh
, 
missšg
, 
NULL
, NULL),

76 
i
 = 0; i < (
¡rs
)/(const *); i++) {

78 *
p
;

79 cÚ¡ *
s
;

80 } 
k
, 
v
;

81 **
kp
, **
vp
;

82 cÚ¡ *
ks
, *
vs
;

84 
kp
 = (
i
 & 1è? &
k
.
p
 : 
NULL
;

85 
vp
 = (
i
 & 2è? &
v
.
p
 : 
NULL
;

86 
k
.
p
 = 
NULL
;

87 
v
.
p
 = 
NULL
;

88 
	`as£¹_çl£
(
	`ckh_»move
(
tsdn
, &
ckh
, 
¡rs
[
i
], 
kp
, 
vp
),

91 
ks
 = (
i
 & 1è? 
¡rs
[i] : (cÚ¡ *)
NULL
;

92 
vs
 = (
i
 & 2è? 
¡rs
[i] : (cÚ¡ *)
NULL
;

93 
	`as£¹_±r_eq
((*)
ks
, (*)
k
.
s
, "Key mismatch, i=%zu",

94 
i
);

95 
	`as£¹_±r_eq
((*)
vs
, (*)
v
.
s
, "Value mismatch, i=%zu",

96 
i
);

97 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
),

98 (
¡rs
)/(cÚ¡ *è- 
i
 - 1,

100 (
¡rs
)/(cÚ¡ *è- 
i
 - 1,

101 
	`ckh_couÁ
(&
ckh
));

104 
	`ckh_d–‘e
(
tsdn
, &
ckh
);

105 
	}
}

106 
TEST_END


108 
	$TEST_BEGIN
(
‹¡_š£¹_™”_»move
)

110 
	#NITEMS
 
	`ZU
(1000)

	)

111 
tsdn_t
 *
tsdn
;

112 
ckh_t
 
ckh
;

113 **
p
[
NITEMS
];

114 *
q
, *
r
;

115 
size_t
 
i
;

117 
tsdn
 = 
	`tsdn_ãtch
();

119 
	`as£¹_çl£
(
	`ckh_Ãw
(
tsdn
, &
ckh
, 2, 
ckh_poš‹r_hash
,

120 
ckh_poš‹r_keycomp
), "Unexpected ckh_new()ƒrror");

122 
i
 = 0; i < 
NITEMS
; i++) {

123 
p
[
i
] = 
	`m®locx
(i+1, 0);

124 
	`as£¹_±r_nÙ_nuÎ
(
p
[
i
], "Unexpected mallocx() failure");

127 
i
 = 0; i < 
NITEMS
; i++) {

128 
size_t
 
j
;

130 
j
 = 
i
; j < 
NITEMS
; j++) {

131 
	`as£¹_çl£
(
	`ckh_š£¹
(
tsdn
, &
ckh
, 
p
[
j
],…[j]),

133 
	`as£¹_çl£
(
	`ckh_£¬ch
(&
ckh
, 
p
[
j
], &
q
, &
r
),

135 
	`as£¹_±r_eq
(
p
[
j
], 
q
, "Key…ointer mismatch");

136 
	`as£¹_±r_eq
(
p
[
j
], 
r
, "Value…ointer mismatch");

139 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
), 
NITEMS
,

141 
NITEMS
, 
	`ckh_couÁ
(&
ckh
));

143 
j
 = 
i
 + 1; j < 
NITEMS
; j++) {

144 
	`as£¹_çl£
(
	`ckh_£¬ch
(&
ckh
, 
p
[
j
], 
NULL
, NULL),

146 
	`as£¹_çl£
(
	`ckh_»move
(
tsdn
, &
ckh
, 
p
[
j
], &
q
, &
r
),

148 
	`as£¹_±r_eq
(
p
[
j
], 
q
, "Key…ointer mismatch");

149 
	`as£¹_±r_eq
(
p
[
j
], 
r
, "Value…ointer mismatch");

150 
	`as£¹_Œue
(
	`ckh_£¬ch
(&
ckh
, 
p
[
j
], 
NULL
, NULL),

152 
	`as£¹_Œue
(
	`ckh_»move
(
tsdn
, &
ckh
, 
p
[
j
], &
q
, &
r
),

157 
boŞ
 
£’
[
NITEMS
];

158 
size_t
 
bšd
;

160 
	`mem£t
(
£’
, 0, (seen));

162 
bšd
 = 0; !
	`ckh_™”
(&
ckh
, &bšd, &
q
, &
r
);) {

163 
size_t
 
k
;

165 
	`as£¹_±r_eq
(
q
, 
r
, "Key‡nd val‚otƒqual");

167 
k
 = 0; k < 
NITEMS
; k++) {

168 ià(
p
[
k
] =ğ
q
) {

169 
	`as£¹_çl£
(
£’
[
k
],

170 "I‹m %zu‡Ì—dy s“n", 
k
);

171 
£’
[
k
] = 
Œue
;

177 
j
 = 0; j < 
i
 + 1; j++)

178 
	`as£¹_Œue
(
£’
[
j
], "Item %zu‚ot seen", j);

179 ; 
j
 < 
NITEMS
; j++)

180 
	`as£¹_çl£
(
£’
[
j
], "Item %zu seen", j);

184 
i
 = 0; i < 
NITEMS
; i++) {

185 
	`as£¹_çl£
(
	`ckh_£¬ch
(&
ckh
, 
p
[
i
], 
NULL
, NULL),

187 
	`as£¹_çl£
(
	`ckh_»move
(
tsdn
, &
ckh
, 
p
[
i
], &
q
, &
r
),

189 
	`as£¹_±r_eq
(
p
[
i
], 
q
, "Key…ointer mismatch");

190 
	`as£¹_±r_eq
(
p
[
i
], 
r
, "Value…ointer mismatch");

191 
	`as£¹_Œue
(
	`ckh_£¬ch
(&
ckh
, 
p
[
i
], 
NULL
, NULL),

193 
	`as£¹_Œue
(
	`ckh_»move
(
tsdn
, &
ckh
, 
p
[
i
], &
q
, &
r
),

195 
	`d®locx
(
p
[
i
], 0);

198 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
), 0,

200 
	`ZU
(0), 
	`ckh_couÁ
(&
ckh
));

201 
	`ckh_d–‘e
(
tsdn
, &
ckh
);

202 #undeà
NITEMS


203 
	}
}

204 
TEST_END


207 
	$maš
()

210  (
	`‹¡
(

211 
‹¡_Ãw_d–‘e
,

212 
‹¡_couÁ_š£¹_£¬ch_»move
,

213 
‹¡_š£¹_™”_»move
));

214 
	}
}

	@dep/jemalloc-4.2.0/test/unit/decay.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 cÚ¡ *
	gm®loc_cÚf
 = "purge:decay,decay_time:1";

5 
n¡ime_upd©e_t
 *
	gn¡ime_upd©e_Üig
;

7 
	gnupd©es_mock
;

8 
n¡ime_t
 
	gtime_mock
;

9 
boŞ
 
	gnÚmÚÙÚic_mock
;

11 
boŞ


12 
	$n¡ime_upd©e_mock
(
n¡ime_t
 *
time
)

15 
nupd©es_mock
++;

16 ià(!
nÚmÚÙÚic_mock
)

17 
	`n¡ime_cİy
(
time
, &
time_mock
);

18  (
nÚmÚÙÚic_mock
);

19 
	}
}

21 
	$TEST_BEGIN
(
‹¡_deÿy_ticks
)

23 
tick”_t
 *
deÿy_tick”
;

24 
tick0
, 
tick1
;

25 
size_t
 
sz
, 
huge0
, 
Ïrge0
;

26 *
p
;

28 
	`‹¡_sk_if
(
İt_purge
 !ğ
purge_mode_deÿy
);

30 
deÿy_tick”
 = 
	`deÿy_tick”_g‘
(
	`tsd_ãtch
(), 0);

31 
	`as£¹_±r_nÙ_nuÎ
(
deÿy_tick”
,

34 
sz
 = (
size_t
);

35 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.hchunk.0.size", &
huge0
, &
sz
, 
NULL
, 0), 0,

37 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ìun.0.size", &
Ïrge0
, &
sz
, 
NULL
, 0), 0,

47 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

48 
p
 = 
	`m®loc
(
huge0
);

49 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected malloc() failure");

50 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

51 
	`as£¹_u32_Ã
(
tick1
, 
tick0
, "Expectedickeroick during malloc()");

53 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

54 
	`ä“
(
p
);

55 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

56 
	`as£¹_u32_Ã
(
tick1
, 
tick0
, "Expectedickeroick during free()");

59 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

60 
p
 = 
	`ÿÎoc
(1, 
huge0
);

61 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected calloc() failure");

62 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

63 
	`as£¹_u32_Ã
(
tick1
, 
tick0
, "Expectedickeroick during calloc()");

64 
	`ä“
(
p
);

67 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

68 
	`as£¹_d_eq
(
	`posix_mem®ign
(&
p
, (
size_t
), 
huge0
), 0,

70 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

71 
	`as£¹_u32_Ã
(
tick1
, 
tick0
,

73 
	`ä“
(
p
);

76 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

77 
p
 = 
	`®igÃd_®loc
((
size_t
), 
huge0
);

78 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected‡ligned_alloc() failure");

79 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

80 
	`as£¹_u32_Ã
(
tick1
, 
tick0
,

82 
	`ä“
(
p
);

86 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

87 
p
 = 
	`»®loc
(
NULL
, 
huge0
);

88 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected„ealloc() failure");

89 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

90 
	`as£¹_u32_Ã
(
tick1
, 
tick0
, "Expectedickeroick during„ealloc()");

92 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

93 
p
 = 
	`»®loc
Õ, 
huge0
);

94 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected„ealloc() failure");

95 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

96 
	`as£¹_u32_Ã
(
tick1
, 
tick0
, "Expectedickeroick during„ealloc()");

98 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

99 
	`»®loc
(
p
, 0);

100 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

101 
	`as£¹_u32_Ã
(
tick1
, 
tick0
, "Expectedickeroick during„ealloc()");

108 
i
;

109 
size_t
 
®locx_sizes
[3];

110 
®locx_sizes
[0] = 
huge0
;

111 
®locx_sizes
[1] = 
Ïrge0
;

112 
®locx_sizes
[2] = 1;

114 
i
 = 0; i < (
®locx_sizes
è/ (
size_t
); i++) {

115 
sz
 = 
®locx_sizes
[
i
];

118 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

119 
p
 = 
	`m®locx
(
sz
, 
MALLOCX_TCACHE_NONE
);

120 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

121 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

122 
	`as£¹_u32_Ã
(
tick1
, 
tick0
,

124 
sz
);

126 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

127 
p
 = 
	`¿Îocx
Õ, 
sz
, 
MALLOCX_TCACHE_NONE
);

128 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected„allocx() failure");

129 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

130 
	`as£¹_u32_Ã
(
tick1
, 
tick0
,

132 
sz
);

134 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

135 
	`x®locx
(
p
, 
sz
, 0, 
MALLOCX_TCACHE_NONE
);

136 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

137 
	`as£¹_u32_Ã
(
tick1
, 
tick0
,

139 
sz
);

141 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

142 
	`d®locx
(
p
, 
MALLOCX_TCACHE_NONE
);

143 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

144 
	`as£¹_u32_Ã
(
tick1
, 
tick0
,

146 
sz
);

148 
p
 = 
	`m®locx
(
sz
, 
MALLOCX_TCACHE_NONE
);

149 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

150 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

151 
	`sd®locx
(
p
, 
sz
, 
MALLOCX_TCACHE_NONE
);

152 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

153 
	`as£¹_u32_Ã
(
tick1
, 
tick0
,

155 "(sz=%zu)", 
sz
);

163 ià(
cÚfig_tÿche
) {

164 
tÿche_šd
, 
i
;

165 
size_t
 
tÿche_sizes
[2];

166 
tÿche_sizes
[0] = 
Ïrge0
;

167 
tÿche_sizes
[1] = 1;

169 
sz
 = ();

170 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.ü—‹", &
tÿche_šd
, &
sz
, 
NULL
, 0),

173 
i
 = 0; i < (
tÿche_sizes
è/ (
size_t
); i++) {

174 
sz
 = 
tÿche_sizes
[
i
];

177 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

178 
p
 = 
	`m®locx
(
sz
, 
	`MALLOCX_TCACHE
(
tÿche_šd
));

179 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

180 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

181 
	`as£¹_u32_Ã
(
tick1
, 
tick0
,

183 "(sz=%zu)", 
sz
);

185 
	`d®locx
(
p
, 
	`MALLOCX_TCACHE
(
tÿche_šd
));

186 
tick0
 = 
	`tick”_»ad
(
deÿy_tick”
);

187 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.æush", 
NULL
, NULL,

188 &
tÿche_šd
, ()), 0,

190 
tick1
 = 
	`tick”_»ad
(
deÿy_tick”
);

191 
	`as£¹_u32_Ã
(
tick1
, 
tick0
,

193 "(sz=%zu)", 
sz
);

196 
	}
}

197 
TEST_END


199 
	$TEST_BEGIN
(
‹¡_deÿy_tick”
)

201 
	#NPS
 1024

	)

202 
æags
 = (
	`MALLOCX_ARENA
(0è| 
MALLOCX_TCACHE_NONE
);

203 *
ps
[
NPS
];

204 
ušt64_t
 
•och
;

205 
ušt64_t
 
Åurge0
 = 0;

206 
ušt64_t
 
Åurge1
 = 0;

207 
size_t
 
sz
, 
Ïrge
;

208 
i
, 
nupd©es0
;

209 
n¡ime_t
 
time
, 
deÿy_time
, 
d—dlše
;

211 
	`‹¡_sk_if
(
İt_purge
 !ğ
purge_mode_deÿy
);

219 ià(
cÚfig_tÿche
) {

220 
size_t
 
tÿche_max
;

222 
sz
 = (
size_t
);

223 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.tÿche_max", &
tÿche_max
, &
sz
, 
NULL
,

225 
Ïrge
 = 
	`ÇÎocx
(
tÿche_max
 + 1, 
æags
);

227 
sz
 = (
size_t
);

228 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ìun.0.size", &
Ïrge
, &
sz
, 
NULL
, 0),

232 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

234 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (
ušt64_t
)), 0,

236 
sz
 = (
ušt64_t
);

237 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Åurge", &
Åurge0
, &
sz
, 
NULL
, 0),

238 
cÚfig_¡©s
 ? 0 : 
ENOENT
, "Unexpected mallctl„esult");

240 
i
 = 0; i < 
NPS
; i++) {

241 
ps
[
i
] = 
	`m®locx
(
Ïrge
, 
æags
);

242 
	`as£¹_±r_nÙ_nuÎ
(
ps
[
i
], "Unexpected mallocx() failure");

245 
nupd©es_mock
 = 0;

246 
	`n¡ime_š™
(&
time_mock
, 0);

247 
	`n¡ime_upd©e
(&
time_mock
);

248 
nÚmÚÙÚic_mock
 = 
çl£
;

250 
n¡ime_upd©e_Üig
 = 
n¡ime_upd©e
;

251 
n¡ime_upd©e
 = 
n¡ime_upd©e_mock
;

253 
i
 = 0; i < 
NPS
; i++) {

254 
	`d®locx
(
ps
[
i
], 
æags
);

255 
nupd©es0
 = 
nupd©es_mock
;

256 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.deÿy", 
NULL
, NULL, NULL, 0), 0,

258 
	`as£¹_u_gt
(
nupd©es_mock
, 
nupd©es0
,

262 
n¡ime_upd©e
 = 
n¡ime_upd©e_Üig
;

264 
	`n¡ime_š™
(&
time
, 0);

265 
	`n¡ime_upd©e
(&
time
);

266 
	`n¡ime_š™2
(&
deÿy_time
, 
İt_deÿy_time
, 0);

267 
	`n¡ime_cİy
(&
d—dlše
, &
time
);

268 
	`n¡ime_add
(&
d—dlše
, &
deÿy_time
);

270 
i
 = 0; i < 
DECAY_NTICKS_PER_UPDATE
 / 2; i++) {

271 *
p
 = 
	`m®locx
(1, 
æags
);

272 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

273 
	`d®locx
(
p
, 
æags
);

275 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
,

276 (
ušt64_t
)), 0, "Unexpected mallctl failure");

277 
sz
 = (
ušt64_t
);

278 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Åurge", &
Åurge1
, &
sz
,

279 
NULL
, 0), 
cÚfig_¡©s
 ? 0 : 
ENOENT
,

282 
	`n¡ime_upd©e
(&
time
);

283 } 
	`n¡ime_com·»
(&
time
, &
d—dlše
è<ğ0 && 
Åurge1
 =ğ
Åurge0
);

285 ià(
cÚfig_¡©s
)

286 
	`as£¹_u64_gt
(
Åurge1
, 
Åurge0
, "Expected…urgingo occur");

287 #undeà
NPS


288 
	}
}

289 
TEST_END


291 
	$TEST_BEGIN
(
‹¡_deÿy_nÚmÚÙÚic
)

293 
	#NPS
 (
SMOOTHSTEP_NSTEPS
 + 1)

	)

294 
æags
 = (
	`MALLOCX_ARENA
(0è| 
MALLOCX_TCACHE_NONE
);

295 *
ps
[
NPS
];

296 
ušt64_t
 
•och
;

297 
ušt64_t
 
Åurge0
 = 0;

298 
ušt64_t
 
Åurge1
 = 0;

299 
size_t
 
sz
, 
Ïrge0
;

300 
i
, 
nupd©es0
;

302 
	`‹¡_sk_if
(
İt_purge
 !ğ
purge_mode_deÿy
);

304 
sz
 = (
size_t
);

305 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ìun.0.size", &
Ïrge0
, &
sz
, 
NULL
, 0), 0,

308 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

310 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (
ušt64_t
)), 0,

312 
sz
 = (
ušt64_t
);

313 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Åurge", &
Åurge0
, &
sz
, 
NULL
, 0),

314 
cÚfig_¡©s
 ? 0 : 
ENOENT
, "Unexpected mallctl„esult");

316 
nupd©es_mock
 = 0;

317 
	`n¡ime_š™
(&
time_mock
, 0);

318 
	`n¡ime_upd©e
(&
time_mock
);

319 
nÚmÚÙÚic_mock
 = 
Œue
;

321 
n¡ime_upd©e_Üig
 = 
n¡ime_upd©e
;

322 
n¡ime_upd©e
 = 
n¡ime_upd©e_mock
;

324 
i
 = 0; i < 
NPS
; i++) {

325 
ps
[
i
] = 
	`m®locx
(
Ïrge0
, 
æags
);

326 
	`as£¹_±r_nÙ_nuÎ
(
ps
[
i
], "Unexpected mallocx() failure");

329 
i
 = 0; i < 
NPS
; i++) {

330 
	`d®locx
(
ps
[
i
], 
æags
);

331 
nupd©es0
 = 
nupd©es_mock
;

332 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.deÿy", 
NULL
, NULL, NULL, 0), 0,

334 
	`as£¹_u_gt
(
nupd©es_mock
, 
nupd©es0
,

338 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (
ušt64_t
)), 0,

340 
sz
 = (
ušt64_t
);

341 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Åurge", &
Åurge1
, &
sz
, 
NULL
, 0),

342 
cÚfig_¡©s
 ? 0 : 
ENOENT
, "Unexpected mallctl„esult");

344 ià(
cÚfig_¡©s
)

345 
	`as£¹_u64_gt
(
Åurge1
, 
Åurge0
, "Expected…urgingo occur");

347 
n¡ime_upd©e
 = 
n¡ime_upd©e_Üig
;

348 #undeà
NPS


349 
	}
}

350 
TEST_END


353 
	$maš
()

356  (
	`‹¡
(

357 
‹¡_deÿy_ticks
,

358 
‹¡_deÿy_tick”
,

359 
‹¡_deÿy_nÚmÚÙÚic
));

360 
	}
}

	@dep/jemalloc-4.2.0/test/unit/fork.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #iâdeà
_WIN32


4 
	~<sys/wa™.h
>

7 
	$TEST_BEGIN
(
‹¡_fÜk
)

9 #iâdeà
_WIN32


10 *
p
;

11 
pid_t
 
pid
;

13 
p
 = 
	`m®loc
(1);

14 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected malloc() failure");

16 
pid
 = 
	`fÜk
();

18 
	`ä“
(
p
);

20 
p
 = 
	`m®loc
(64);

21 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected malloc() failure");

22 
	`ä“
(
p
);

24 ià(
pid
 == -1) {

26 
	`‹¡_ç
("Unexpected fork() failure");

27 } ià(
pid
 == 0) {

29 
	`ex™
(0);

31 
¡©us
;

34 
Œue
) {

35 ià(
	`wa™pid
(
pid
, &
¡©us
, 0) == -1)

36 
	`‹¡_ç
("Unexpected waitpid() failure");

37 ià(
	`WIFSIGNALED
(
¡©us
)) {

38 
	`‹¡_ç
("Unexpected childermination dueo "

39 "sigÇÈ%d", 
	`WTERMSIG
(
¡©us
));

42 ià(
	`WIFEXITED
(
¡©us
)) {

43 ià(
	`WEXITSTATUS
(
¡©us
) != 0) {

44 
	`‹¡_ç
(

46 
	`WEXITSTATUS
(
¡©us
));

53 
	`‹¡_sk
("fork(2) is irrelevanto Windows");

55 
	}
}

56 
TEST_END


59 
	$maš
()

62  (
	`‹¡
(

63 
‹¡_fÜk
));

64 
	}
}

	@dep/jemalloc-4.2.0/test/unit/hash.c

30 
	~"‹¡/jem®loc_‹¡.h
"

33 
	mhash_v¬ŸÁ_x86_32
,

34 
	mhash_v¬ŸÁ_x86_128
,

35 
	mhash_v¬ŸÁ_x64_128


36 } 
	thash_v¬ŸÁ_t
;

39 
	$hash_v¬ŸÁ_b™s
(
hash_v¬ŸÁ_t
 
v¬ŸÁ
)

42 
v¬ŸÁ
) {

43 
hash_v¬ŸÁ_x86_32
:  (32);

44 
hash_v¬ŸÁ_x86_128
:  (128);

45 
hash_v¬ŸÁ_x64_128
:  (128);

46 : 
	`nÙ_»ached
();

48 
	}
}

51 
	$hash_v¬ŸÁ_¡ršg
(
hash_v¬ŸÁ_t
 
v¬ŸÁ
)

54 
v¬ŸÁ
) {

55 
hash_v¬ŸÁ_x86_32
:  ("hash_x86_32");

56 
hash_v¬ŸÁ_x86_128
:  ("hash_x86_128");

57 
hash_v¬ŸÁ_x64_128
:  ("hash_x64_128");

58 : 
	`nÙ_»ached
();

60 
	}
}

62 
	#KEY_SIZE
 256

	)

64 
	$hash_v¬ŸÁ_v”ify_key
(
hash_v¬ŸÁ_t
 
v¬ŸÁ
, 
ušt8_t
 *
key
)

66 cÚ¡ 
hashby‹s
 = 
	`hash_v¬ŸÁ_b™s
(
v¬ŸÁ
) / 8;

67 cÚ¡ 
hashes_size
 = 
hashby‹s
 * 256;

68 
	`VARIABLE_ARRAY
(
ušt8_t
, 
hashes
, 
hashes_size
);

69 
	`VARIABLE_ARRAY
(
ušt8_t
, 
fš®
, 
hashby‹s
);

70 
i
;

71 
ušt32_t
 
compu‹d
, 
ex³ùed
;

73 
	`mem£t
(
key
, 0, 
KEY_SIZE
);

74 
	`mem£t
(
hashes
, 0, 
hashes_size
);

75 
	`mem£t
(
fš®
, 0, 
hashby‹s
);

81 
i
 = 0; i < 256; i++) {

82 
key
[
i
] = (
ušt8_t
)i;

83 
v¬ŸÁ
) {

84 
hash_v¬ŸÁ_x86_32
: {

85 
ušt32_t
 
out
;

86 
out
 = 
	`hash_x86_32
(
key
, 
i
, 256-i);

87 
	`memıy
(&
hashes
[
i
*
hashby‹s
], &
out
, hashbytes);

89 } 
hash_v¬ŸÁ_x86_128
: {

90 
ušt64_t
 
out
[2];

91 
	`hash_x86_128
(
key
, 
i
, 256-i, 
out
);

92 
	`memıy
(&
hashes
[
i
*
hashby‹s
], 
out
, hashbytes);

94 } 
hash_v¬ŸÁ_x64_128
: {

95 
ušt64_t
 
out
[2];

96 
	`hash_x64_128
(
key
, 
i
, 256-i, 
out
);

97 
	`memıy
(&
hashes
[
i
*
hashby‹s
], 
out
, hashbytes);

99 } : 
	`nÙ_»ached
();

104 
v¬ŸÁ
) {

105 
hash_v¬ŸÁ_x86_32
: {

106 
ušt32_t
 
out
 = 
	`hash_x86_32
(
hashes
, 
hashes_size
, 0);

107 
	`memıy
(
fš®
, &
out
, (out));

109 } 
hash_v¬ŸÁ_x86_128
: {

110 
ušt64_t
 
out
[2];

111 
	`hash_x86_128
(
hashes
, 
hashes_size
, 0, 
out
);

112 
	`memıy
(
fš®
, 
out
, (out));

114 } 
hash_v¬ŸÁ_x64_128
: {

115 
ušt64_t
 
out
[2];

116 
	`hash_x64_128
(
hashes
, 
hashes_size
, 0, 
out
);

117 
	`memıy
(
fš®
, 
out
, (out));

119 } : 
	`nÙ_»ached
();

122 
compu‹d
 = (
fš®
[0] << 0) | (final[1] << 8) | (final[2] << 16) |

123 (
fš®
[3] << 24);

125 
v¬ŸÁ
) {

126 #ifdeà
JEMALLOC_BIG_ENDIAN


127 
hash_v¬ŸÁ_x86_32
: 
ex³ùed
 = 0x6213303eU; ;

128 
hash_v¬ŸÁ_x86_128
: 
ex³ùed
 = 0x266820caU; ;

129 
hash_v¬ŸÁ_x64_128
: 
ex³ùed
 = 0xcc622b6fU; ;

131 
hash_v¬ŸÁ_x86_32
: 
ex³ùed
 = 0xb0f57ee3U; ;

132 
hash_v¬ŸÁ_x86_128
: 
ex³ùed
 = 0xb3ece62aU; ;

133 
hash_v¬ŸÁ_x64_128
: 
ex³ùed
 = 0x6384ba69U; ;

135 : 
	`nÙ_»ached
();

138 
	`as£¹_u32_eq
(
compu‹d
, 
ex³ùed
,

140 
	`hash_v¬ŸÁ_¡ršg
(
v¬ŸÁ
), 
ex³ùed
, 
compu‹d
);

141 
	}
}

144 
	$hash_v¬ŸÁ_v”ify
(
hash_v¬ŸÁ_t
 
v¬ŸÁ
)

146 
	#MAX_ALIGN
 16

	)

147 
ušt8_t
 
key
[
KEY_SIZE
 + (
MAX_ALIGN
 - 1)];

148 
i
;

150 
i
 = 0; i < 
MAX_ALIGN
; i++)

151 
	`hash_v¬ŸÁ_v”ify_key
(
v¬ŸÁ
, &
key
[
i
]);

152 #undeà
MAX_ALIGN


153 
	}
}

154 #undeà
KEY_SIZE


156 
	$TEST_BEGIN
(
‹¡_hash_x86_32
)

159 
	`hash_v¬ŸÁ_v”ify
(
hash_v¬ŸÁ_x86_32
);

160 
	}
}

161 
TEST_END


163 
	$TEST_BEGIN
(
‹¡_hash_x86_128
)

166 
	`hash_v¬ŸÁ_v”ify
(
hash_v¬ŸÁ_x86_128
);

167 
	}
}

168 
TEST_END


170 
	$TEST_BEGIN
(
‹¡_hash_x64_128
)

173 
	`hash_v¬ŸÁ_v”ify
(
hash_v¬ŸÁ_x64_128
);

174 
	}
}

175 
TEST_END


178 
	$maš
()

181  (
	`‹¡
(

182 
‹¡_hash_x86_32
,

183 
‹¡_hash_x86_128
,

184 
‹¡_hash_x64_128
));

185 
	}
}

	@dep/jemalloc-4.2.0/test/unit/junk.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_FILL


4 #iâdeà
JEMALLOC_TEST_JUNK_OPT


5 
	#JEMALLOC_TEST_JUNK_OPT
 "junk:Œue"

	)

7 cÚ¡ *
	gm®loc_cÚf
 =

8 "abÜt:çl£,z”o:çl£,»dzÚe:Œue,qu¬ªtše:0," 
JEMALLOC_TEST_JUNK_OPT
;

11 
¬’a_d®loc_junk_sm®l_t
 *
	g¬’a_d®loc_junk_sm®l_Üig
;

12 
¬’a_d®loc_junk_Ïrge_t
 *
	g¬’a_d®loc_junk_Ïrge_Üig
;

13 
huge_d®loc_junk_t
 *
	ghuge_d®loc_junk_Üig
;

14 *
	gw©ch_fÜ_junkšg
;

15 
boŞ
 
	g§w_junkšg
;

18 
	$w©ch_junkšg
(*
p
)

21 
w©ch_fÜ_junkšg
 = 
p
;

22 
§w_junkšg
 = 
çl£
;

23 
	}
}

26 
	$¬’a_d®loc_junk_sm®l_š‹rû±
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
)

28 
size_t
 
i
;

30 
	`¬’a_d®loc_junk_sm®l_Üig
(
±r
, 
bš_šfo
);

31 
i
 = 0; i < 
bš_šfo
->
»g_size
; i++) {

32 
	`as£¹_u_eq
(((
ušt8_t
 *)
±r
)[
i
], 
JEMALLOC_FREE_JUNK
,

34 
i
, 
bš_šfo
->
»g_size
);

36 ià(
±r
 =ğ
w©ch_fÜ_junkšg
)

37 
§w_junkšg
 = 
Œue
;

38 
	}
}

41 
	$¬’a_d®loc_junk_Ïrge_š‹rû±
(*
±r
, 
size_t
 
usize
)

43 
size_t
 
i
;

45 
	`¬’a_d®loc_junk_Ïrge_Üig
(
±r
, 
usize
);

46 
i
 = 0; i < 
usize
; i++) {

47 
	`as£¹_u_eq
(((
ušt8_t
 *)
±r
)[
i
], 
JEMALLOC_FREE_JUNK
,

49 
i
, 
usize
);

51 ià(
±r
 =ğ
w©ch_fÜ_junkšg
)

52 
§w_junkšg
 = 
Œue
;

53 
	}
}

56 
	$huge_d®loc_junk_š‹rû±
(
tsdn_t
 *
tsdn
, *
±r
, 
size_t
 
usize
)

59 
	`huge_d®loc_junk_Üig
(
tsdn
, 
±r
, 
usize
);

65 ià(
±r
 =ğ
w©ch_fÜ_junkšg
)

66 
§w_junkšg
 = 
Œue
;

67 
	}
}

70 
	$‹¡_junk
(
size_t
 
sz_mš
, size_ˆ
sz_max
)

72 
ušt8_t
 *
s
;

73 
size_t
 
sz_´ev
, 
sz
, 
i
;

75 ià(
İt_junk_ä“
) {

76 
¬’a_d®loc_junk_sm®l_Üig
 = 
¬’a_d®loc_junk_sm®l
;

77 
¬’a_d®loc_junk_sm®l
 = 
¬’a_d®loc_junk_sm®l_š‹rû±
;

78 
¬’a_d®loc_junk_Ïrge_Üig
 = 
¬’a_d®loc_junk_Ïrge
;

79 
¬’a_d®loc_junk_Ïrge
 = 
¬’a_d®loc_junk_Ïrge_š‹rû±
;

80 
huge_d®loc_junk_Üig
 = 
huge_d®loc_junk
;

81 
huge_d®loc_junk
 = 
huge_d®loc_junk_š‹rû±
;

84 
sz_´ev
 = 0;

85 
s
 = (
ušt8_t
 *)
	`m®locx
(
sz_mš
, 0);

86 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

88 
sz
 = 
	`§Îocx
(
s
, 0); sz <ğ
sz_max
;

89 
sz_´ev
 = 
sz
, sz = 
	`§Îocx
(
s
, 0)) {

90 ià(
sz_´ev
 > 0) {

91 
	`as£¹_u_eq
(
s
[0], 'a',

93 
	`ZU
(0), 
sz_´ev
);

94 
	`as£¹_u_eq
(
s
[
sz_´ev
-1], 'a',

96 
sz_´ev
-1, sz_prev);

99 
i
 = 
sz_´ev
; i < 
sz
; i++) {

100 ià(
İt_junk_®loc
) {

101 
	`as£¹_u_eq
(
s
[
i
], 
JEMALLOC_ALLOC_JUNK
,

103 "junk-fËd", 
i
, 
sz
);

105 
s
[
i
] = 'a';

108 ià(
	`x®locx
(
s
, 
sz
+1, 0, 0) == sz) {

109 
	`w©ch_junkšg
(
s
);

110 
s
 = (
ušt8_t
 *)
	`¿Îocx
(s, 
sz
+1, 0);

111 
	`as£¹_±r_nÙ_nuÎ
((*)
s
,

113 
	`as£¹_Œue
(!
İt_junk_ä“
 || 
§w_junkšg
,

115 
sz
);

119 
	`w©ch_junkšg
(
s
);

120 
	`d®locx
(
s
, 0);

121 
	`as£¹_Œue
(!
İt_junk_ä“
 || 
§w_junkšg
,

122 "Ex³ùed„egiÚ oàsiz%zuØbjunk-fËd", 
sz
);

124 ià(
İt_junk_ä“
) {

125 
¬’a_d®loc_junk_sm®l
 = 
¬’a_d®loc_junk_sm®l_Üig
;

126 
¬’a_d®loc_junk_Ïrge
 = 
¬’a_d®loc_junk_Ïrge_Üig
;

127 
huge_d®loc_junk
 = 
huge_d®loc_junk_Üig
;

129 
	}
}

131 
	$TEST_BEGIN
(
‹¡_junk_sm®l
)

134 
	`‹¡_sk_if
(!
cÚfig_fl
);

135 
	`‹¡_junk
(1, 
SMALL_MAXCLASS
-1);

136 
	}
}

137 
TEST_END


139 
	$TEST_BEGIN
(
‹¡_junk_Ïrge
)

142 
	`‹¡_sk_if
(!
cÚfig_fl
);

143 
	`‹¡_junk
(
SMALL_MAXCLASS
+1, 
Ïrge_maxşass
);

144 
	}
}

145 
TEST_END


147 
	$TEST_BEGIN
(
‹¡_junk_huge
)

150 
	`‹¡_sk_if
(!
cÚfig_fl
);

151 
	`‹¡_junk
(
Ïrge_maxşass
+1, 
chunksize
*2);

152 
	}
}

153 
TEST_END


155 
¬’a_¿Îoc_junk_Ïrge_t
 *
	g¬’a_¿Îoc_junk_Ïrge_Üig
;

156 *
	gmo¡_»ûÁly_Œimmed
;

158 
size_t


159 
	$shršk_size
(
size_t
 
size
)

161 
size_t
 
shršk_size
;

163 
shršk_size
 = 
size
 - 1; 
	`ÇÎocx
(shrink_size, 0) == size;

164 
shršk_size
--)

167  (
shršk_size
);

168 
	}
}

171 
	$¬’a_¿Îoc_junk_Ïrge_š‹rû±
(*
±r
, 
size_t
 
Şd_usize
, size_ˆ
usize
)

174 
	`¬’a_¿Îoc_junk_Ïrge_Üig
(
±r
, 
Şd_usize
, 
usize
);

175 
	`as£¹_zu_eq
(
Şd_usize
, 
Ïrge_maxşass
, "Unexpected old_usize");

176 
	`as£¹_zu_eq
(
usize
, 
	`shršk_size
(
Ïrge_maxşass
), "Unexpected usize");

177 
mo¡_»ûÁly_Œimmed
 = 
±r
;

178 
	}
}

180 
	$TEST_BEGIN
(
‹¡_junk_Ïrge_¿Îoc_shršk
)

182 *
p1
, *
p2
;

184 
p1
 = 
	`m®locx
(
Ïrge_maxşass
, 0);

185 
	`as£¹_±r_nÙ_nuÎ
(
p1
, "Unexpected mallocx() failure");

187 
¬’a_¿Îoc_junk_Ïrge_Üig
 = 
¬’a_¿Îoc_junk_Ïrge
;

188 
¬’a_¿Îoc_junk_Ïrge
 = 
¬’a_¿Îoc_junk_Ïrge_š‹rû±
;

190 
p2
 = 
	`¿Îocx
(
p1
, 
	`shršk_size
(
Ïrge_maxşass
), 0);

191 
	`as£¹_±r_eq
(
p1
, 
p2
, "Unexpected move during shrink");

193 
¬’a_¿Îoc_junk_Ïrge
 = 
¬’a_¿Îoc_junk_Ïrge_Üig
;

195 
	`as£¹_±r_eq
(
mo¡_»ûÁly_Œimmed
, 
p1
,

197 
	}
}

198 
TEST_END


200 
boŞ
 
	gd‘eùed_»dzÚe_cÜru±iÚ
;

203 
	$¬’a_»dzÚe_cÜru±iÚ_»¶aûm’t
(*
±r
, 
size_t
 
usize
, 
boŞ
 
aá”
,

204 
size_t
 
off£t
, 
ušt8_t
 
by‹
)

207 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
Œue
;

208 
	}
}

210 
	$TEST_BEGIN
(
‹¡_junk_»dzÚe
)

212 *
s
;

213 
¬’a_»dzÚe_cÜru±iÚ_t
 *
¬’a_»dzÚe_cÜru±iÚ_Üig
;

215 
	`‹¡_sk_if
(!
cÚfig_fl
);

216 
	`‹¡_sk_if
(!
İt_junk_®loc
 || !
İt_junk_ä“
);

218 
¬’a_»dzÚe_cÜru±iÚ_Üig
 = 
¬’a_»dzÚe_cÜru±iÚ
;

219 
¬’a_»dzÚe_cÜru±iÚ
 = 
¬’a_»dzÚe_cÜru±iÚ_»¶aûm’t
;

222 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
çl£
;

223 
s
 = (*)
	`m®locx
(1, 0);

224 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

225 
s
[-1] = 0xbb;

226 
	`d®locx
(
s
, 0);

227 
	`as£¹_Œue
(
d‘eùed_»dzÚe_cÜru±iÚ
,

231 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
çl£
;

232 
s
 = (*)
	`m®locx
(1, 0);

233 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

234 
s
[
	`§Îocx
(s, 0)] = 0xbb;

235 
	`d®locx
(
s
, 0);

236 
	`as£¹_Œue
(
d‘eùed_»dzÚe_cÜru±iÚ
,

239 
¬’a_»dzÚe_cÜru±iÚ
 = 
¬’a_»dzÚe_cÜru±iÚ_Üig
;

240 
	}
}

241 
TEST_END


244 
	$maš
()

247  (
	`‹¡
(

248 
‹¡_junk_sm®l
,

249 
‹¡_junk_Ïrge
,

250 
‹¡_junk_huge
,

251 
‹¡_junk_Ïrge_¿Îoc_shršk
,

252 
‹¡_junk_»dzÚe
));

253 
	}
}

	@dep/jemalloc-4.2.0/test/unit/junk_alloc.c

1 
	#JEMALLOC_TEST_JUNK_OPT
 "junk:®loc"

	)

2 
	~"junk.c
"

3 #undeà
JEMALLOC_TEST_JUNK_OPT


	@dep/jemalloc-4.2.0/test/unit/junk_free.c

1 
	#JEMALLOC_TEST_JUNK_OPT
 "junk:ä“"

	)

2 
	~"junk.c
"

3 #undeà
JEMALLOC_TEST_JUNK_OPT


	@dep/jemalloc-4.2.0/test/unit/lg_chunk.c

1 
	~"‹¡/jem®loc_‹¡.h
"

8 cÚ¡ *
	gm®loc_cÚf
 = "lg_chunk:0";

10 
	$TEST_BEGIN
(
‹¡_lg_chunk_şamp
)

12 *
p
;

14 
p
 = 
	`m®locx
(1, 0);

15 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

16 
	`d®locx
(
p
, 0);

17 
	}
}

18 
TEST_END


21 
	$maš
()

24  (
	`‹¡
(

25 
‹¡_lg_chunk_şamp
));

26 
	}
}

	@dep/jemalloc-4.2.0/test/unit/mallctl.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_m®lùl_”rÜs
)

5 
ušt64_t
 
•och
;

6 
size_t
 
sz
;

8 
	`as£¹_d_eq
(
	`m®lùl
("no_such_Çme", 
NULL
, NULL, NULL, 0), 
ENOENT
,

11 
	`as£¹_d_eq
(
	`m®lùl
("v”siÚ", 
NULL
, NULL, "0.0.0", 
	`¡¾’
("0.0.0")),

12 
EPERM
, "mallctl() should„eturn EPERM on‡ttempto write "

15 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)-1),

16 
EINVAL
, "mallctl() should„eturn EINVAL for input size mismatch");

17 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)+1),

18 
EINVAL
, "mallctl() should„eturn EINVAL for input size mismatch");

20 
sz
 = (
•och
)-1;

21 
	`as£¹_d_eq
(
	`m®lùl
("•och", &
•och
, &
sz
, 
NULL
, 0), 
EINVAL
,

23 
sz
 = (
•och
)+1;

24 
	`as£¹_d_eq
(
	`m®lùl
("•och", &
•och
, &
sz
, 
NULL
, 0), 
EINVAL
,

26 
	}
}

27 
TEST_END


29 
	$TEST_BEGIN
(
‹¡_m®lùÊam‘omib_”rÜs
)

31 
size_t
 
mib
[1];

32 
size_t
 
mibËn
;

34 
mibËn
 = (
mib
)/(
size_t
);

35 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("no_such_Çme", 
mib
, &
mibËn
), 
ENOENT
,

37 
	}
}

38 
TEST_END


40 
	$TEST_BEGIN
(
‹¡_m®lùlbymib_”rÜs
)

42 
ušt64_t
 
•och
;

43 
size_t
 
sz
;

44 
size_t
 
mib
[1];

45 
size_t
 
mibËn
;

47 
mibËn
 = (
mib
)/(
size_t
);

48 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("v”siÚ", 
mib
, &
mibËn
), 0,

51 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, "0.0.0",

52 
	`¡¾’
("0.0.0")), 
EPERM
, "mallctl() should„eturn EPERM on "

55 
mibËn
 = (
mib
)/(
size_t
);

56 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("•och", 
mib
, &
mibËn
), 0,

59 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, &
•och
,

60 (
•och
)-1), 
EINVAL
,

62 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, &
•och
,

63 (
•och
)+1), 
EINVAL
,

66 
sz
 = (
•och
)-1;

67 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
•och
, &
sz
, 
NULL
, 0), 
EINVAL
,

69 
sz
 = (
•och
)+1;

70 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
•och
, &
sz
, 
NULL
, 0), 
EINVAL
,

72 
	}
}

73 
TEST_END


75 
	$TEST_BEGIN
(
‹¡_m®lùl_»ad_wr™e
)

77 
ušt64_t
 
Şd_•och
, 
Ãw_•och
;

78 
size_t
 
sz
 = (
Şd_•och
);

81 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, NULL, 0), 0,

83 
	`as£¹_zu_eq
(
sz
, (
Şd_•och
), "Unexpected output size");

86 
	`as£¹_d_eq
(
	`m®lùl
("•och", &
Şd_•och
, &
sz
, 
NULL
, 0), 0,

88 
	`as£¹_zu_eq
(
sz
, (
Şd_•och
), "Unexpected output size");

91 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
Ãw_•och
, (new_epoch)),

93 
	`as£¹_zu_eq
(
sz
, (
Şd_•och
), "Unexpected output size");

96 
	`as£¹_d_eq
(
	`m®lùl
("•och", &
Şd_•och
, &
sz
, &
Ãw_•och
,

97 (
Ãw_•och
)), 0, "Unexpected mallctl() failure");

98 
	`as£¹_zu_eq
(
sz
, (
Şd_•och
), "Unexpected output size");

99 
	}
}

100 
TEST_END


102 
	$TEST_BEGIN
(
‹¡_m®lùÊam‘omib_shÜt_mib
)

104 
size_t
 
mib
[4];

105 
size_t
 
mibËn
;

107 
mibËn
 = 3;

108 
mib
[3] = 42;

109 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.bš.0.Äegs", 
mib
, &
mibËn
), 0,

111 
	`as£¹_zu_eq
(
mibËn
, 3, "Unexpected mib output†ength");

112 
	`as£¹_zu_eq
(
mib
[3], 42,

114 
	}
}

115 
TEST_END


117 
	$TEST_BEGIN
(
‹¡_m®lùl_cÚfig
)

120 
	#TEST_MALLCTL_CONFIG
(
cÚfig
, 
t
) do { \

121 
t
 
Şdv®
; \

122 
size_t
 
sz
 = (
Şdv®
); \

123 
	`as£¹_d_eq
(
	`m®lùl
("cÚfig."#cÚfig, &
Şdv®
, &
sz
, 
NULL
, 0), \

125 
	`as£¹_b_eq
(
Şdv®
, 
cÚfig_
##
cÚfig
, "Incorrect config value"); \

126 
	`as£¹_zu_eq
(
sz
, (
Şdv®
), "Unexpected output size"); \

127 } 0)

	)

129 
	`TEST_MALLCTL_CONFIG
(
ÿche_oblivious
, 
boŞ
);

130 
	`TEST_MALLCTL_CONFIG
(
debug
, 
boŞ
);

131 
	`TEST_MALLCTL_CONFIG
(
fl
, 
boŞ
);

132 
	`TEST_MALLCTL_CONFIG
(
Ïzy_lock
, 
boŞ
);

133 
	`TEST_MALLCTL_CONFIG
(
m®loc_cÚf
, const *);

134 
	`TEST_MALLCTL_CONFIG
(
munm­
, 
boŞ
);

135 
	`TEST_MALLCTL_CONFIG
(
´of
, 
boŞ
);

136 
	`TEST_MALLCTL_CONFIG
(
´of_libgcc
, 
boŞ
);

137 
	`TEST_MALLCTL_CONFIG
(
´of_libunwšd
, 
boŞ
);

138 
	`TEST_MALLCTL_CONFIG
(
¡©s
, 
boŞ
);

139 
	`TEST_MALLCTL_CONFIG
(
tÿche
, 
boŞ
);

140 
	`TEST_MALLCTL_CONFIG
(
s
, 
boŞ
);

141 
	`TEST_MALLCTL_CONFIG
(
uŒaû
, 
boŞ
);

142 
	`TEST_MALLCTL_CONFIG
(
v®gršd
, 
boŞ
);

143 
	`TEST_MALLCTL_CONFIG
(
xm®loc
, 
boŞ
);

145 #undeà
TEST_MALLCTL_CONFIG


146 
	}
}

147 
TEST_END


149 
	$TEST_BEGIN
(
‹¡_m®lùl_İt
)

151 
boŞ
 
cÚfig_®ways
 = 
Œue
;

153 
	#TEST_MALLCTL_OPT
(
t
, 
İt
, 
cÚfig
) do { \

154 
t
 
Şdv®
; \

155 
size_t
 
sz
 = (
Şdv®
); \

156 
ex³ùed
 = 
cÚfig_
##
cÚfig
 ? 0 : 
ENOENT
; \

157 
»suÉ
 = 
	`m®lùl
("İt."#İt, &
Şdv®
, &
sz
, 
NULL
, 0); \

158 
	`as£¹_d_eq
(
»suÉ
, 
ex³ùed
, \

160 
	`as£¹_zu_eq
(
sz
, (
Şdv®
), "Unexpected output size"); \

161 } 0)

	)

163 
	`TEST_MALLCTL_OPT
(
boŞ
, 
abÜt
, 
®ways
);

164 
	`TEST_MALLCTL_OPT
(
size_t
, 
lg_chunk
, 
®ways
);

165 
	`TEST_MALLCTL_OPT
(cÚ¡ *, 
dss
, 
®ways
);

166 
	`TEST_MALLCTL_OPT
(, 
Ç»Çs
, 
®ways
);

167 
	`TEST_MALLCTL_OPT
(cÚ¡ *, 
purge
, 
®ways
);

168 
	`TEST_MALLCTL_OPT
(
ssize_t
, 
lg_dœty_muÉ
, 
®ways
);

169 
	`TEST_MALLCTL_OPT
(
ssize_t
, 
deÿy_time
, 
®ways
);

170 
	`TEST_MALLCTL_OPT
(
boŞ
, 
¡©s_´št
, 
®ways
);

171 
	`TEST_MALLCTL_OPT
(cÚ¡ *, 
junk
, 
fl
);

172 
	`TEST_MALLCTL_OPT
(
size_t
, 
qu¬ªtše
, 
fl
);

173 
	`TEST_MALLCTL_OPT
(
boŞ
, 
»dzÚe
, 
fl
);

174 
	`TEST_MALLCTL_OPT
(
boŞ
, 
z”o
, 
fl
);

175 
	`TEST_MALLCTL_OPT
(
boŞ
, 
uŒaû
, utrace);

176 
	`TEST_MALLCTL_OPT
(
boŞ
, 
xm®loc
, xmalloc);

177 
	`TEST_MALLCTL_OPT
(
boŞ
, 
tÿche
,cache);

178 
	`TEST_MALLCTL_OPT
(
size_t
, 
lg_tÿche_max
, 
tÿche
);

179 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of
,…rof);

180 
	`TEST_MALLCTL_OPT
(cÚ¡ *, 
´of_´efix
, 
´of
);

181 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_aùive
, 
´of
);

182 
	`TEST_MALLCTL_OPT
(
ssize_t
, 
lg_´of_§m¶e
, 
´of
);

183 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_accum
, 
´of
);

184 
	`TEST_MALLCTL_OPT
(
ssize_t
, 
lg_´of_š‹rv®
, 
´of
);

185 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_gdump
, 
´of
);

186 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_fš®
, 
´of
);

187 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_Ëak
, 
´of
);

189 #undeà
TEST_MALLCTL_OPT


190 
	}
}

191 
TEST_END


193 
	$TEST_BEGIN
(
‹¡_mª·ge_exam¶e
)

195 
nbšs
, 
i
;

196 
size_t
 
mib
[4];

197 
size_t
 
Ën
, 
mibËn
;

199 
Ën
 = (
nbšs
);

200 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.nbšs", &
nbšs
, &
Ën
, 
NULL
, 0), 0,

203 
mibËn
 = 4;

204 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.bš.0.size", 
mib
, &
mibËn
), 0,

206 
i
 = 0; i < 
nbšs
; i++) {

207 
size_t
 
bš_size
;

209 
mib
[2] = 
i
;

210 
Ën
 = (
bš_size
);

211 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
bš_size
, &
Ën
, 
NULL
, 0),

215 
	}
}

216 
TEST_END


218 
	$TEST_BEGIN
(
‹¡_tÿche_nÚe
)

220 *
p0
, *
q
, *
p1
;

222 
	`‹¡_sk_if
(!
cÚfig_tÿche
);

225 
p0
 = 
	`m®locx
(42, 0);

226 
	`as£¹_±r_nÙ_nuÎ
(
p0
, "Unexpected mallocx() failure");

227 
q
 = 
	`m®locx
(42, 0);

228 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected mallocx() failure");

231 
	`d®locx
(
p0
, 0);

232 
	`d®locx
(
q
, 
MALLOCX_TCACHE_NONE
);

235 
p1
 = 
	`m®locx
(42, 0);

236 
	`as£¹_±r_nÙ_nuÎ
(
p1
, "Unexpected mallocx() failure");

237 
	`as£¹_±r_eq
(
p0
, 
p1
, "Expectedcacheo‡llocate cached„egion");

240 
	`d®locx
(
p1
, 
MALLOCX_TCACHE_NONE
);

241 
	}
}

242 
TEST_END


244 
	$TEST_BEGIN
(
‹¡_tÿche
)

246 
	#NTCACHES
 10

	)

247 
tis
[
NTCACHES
];

248 *
ps
[
NTCACHES
];

249 *
qs
[
NTCACHES
];

250 
i
;

251 
size_t
 
sz
, 
psz
, 
qsz
;

253 
	`‹¡_sk_if
(!
cÚfig_tÿche
);

255 
psz
 = 42;

256 
qsz
 = 
	`ÇÎocx
(
psz
, 0) + 1;

259 
i
 = 0; i < 
NTCACHES
; i++) {

260 
sz
 = ();

261 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.ü—‹", &
tis
[
i
], &
sz
, 
NULL
, 0), 0,

262 "UÃx³ùed m®lùl(èçu», i=%u", 
i
);

266 
i
 = 0; i < 
NTCACHES
; i++) {

267 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.de¡roy", 
NULL
, NULL, &
tis
[
i
],

269 
i
);

271 
i
 = 0; i < 
NTCACHES
; i++) {

272 
sz
 = ();

273 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.ü—‹", &
tis
[
i
], &
sz
, 
NULL
, 0), 0,

274 "UÃx³ùed m®lùl(èçu», i=%u", 
i
);

278 
i
 = 0; i < 
NTCACHES
; i++) {

279 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.æush", 
NULL
, NULL, &
tis
[
i
],

281 
i
);

285 
i
 = 0; i < 
NTCACHES
; i++) {

286 
ps
[
i
] = 
	`m®locx
(
psz
, 
	`MALLOCX_TCACHE
(
tis
[i]));

287 
	`as£¹_±r_nÙ_nuÎ
(
ps
[
i
], "Unexpected mallocx() failure, i=%u",

288 
i
);

289 
	`d®locx
(
ps
[
i
], 
	`MALLOCX_TCACHE
(
tis
[i]));

291 
qs
[
i
] = 
	`m®locx
(
qsz
, 
	`MALLOCX_TCACHE
(
tis
[i]));

292 
	`as£¹_±r_nÙ_nuÎ
(
qs
[
i
], "Unexpected mallocx() failure, i=%u",

293 
i
);

294 
	`d®locx
(
qs
[
i
], 
	`MALLOCX_TCACHE
(
tis
[i]));

298 
i
 = 0; i < 
NTCACHES
; i++) {

299 *
p0
 = 
ps
[
i
];

300 
ps
[
i
] = 
	`m®locx
(
psz
, 
	`MALLOCX_TCACHE
(
tis
[i]));

301 
	`as£¹_±r_nÙ_nuÎ
(
ps
[
i
], "Unexpected mallocx() failure, i=%u",

302 
i
);

303 
	`as£¹_±r_eq
(
ps
[
i
], 
p0
,

304 "Ex³ùed m®locx(ètØ®loÿ‹ cached„egiÚ, i=%u", 
i
);

308 
i
 = 0; i < 
NTCACHES
; i++) {

309 *
q0
 = 
qs
[
i
];

310 
qs
[
i
] = 
	`¿Îocx
(
ps
[i], 
qsz
, 
	`MALLOCX_TCACHE
(
tis
[i]));

311 
	`as£¹_±r_nÙ_nuÎ
(
qs
[
i
], "Unexpected„allocx() failure, i=%u",

312 
i
);

313 
	`as£¹_±r_eq
(
qs
[
i
], 
q0
,

314 "Ex³ùed„®locx(ètØ®loÿ‹ cached„egiÚ, i=%u", 
i
);

316 ià(
qs
[
i
] =ğ
NULL
)

317 
qs
[
i
] = 
ps
[i];

319 
i
 = 0; i < 
NTCACHES
; i++)

320 
	`d®locx
(
qs
[
i
], 
	`MALLOCX_TCACHE
(
tis
[i]));

323 
i
 = 0; i < 
NTCACHES
/2; i++) {

324 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.æush", 
NULL
, NULL, &
tis
[
i
],

326 
i
);

330 
i
 = 0; i < 
NTCACHES
; i++) {

331 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.de¡roy", 
NULL
, NULL, &
tis
[
i
],

333 
i
);

335 
	}
}

336 
TEST_END


338 
	$TEST_BEGIN
(
‹¡_th»ad_¬’a
)

340 
¬’a_Şd
, 
¬’a_Ãw
, 
Ç»Çs
;

341 
size_t
 
sz
 = ();

343 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0), 0,

345 
	`as£¹_u_eq
(
Ç»Çs
, 
İt_Ç»Çs
, "Number of‡renas incorrect");

346 
¬’a_Ãw
 = 
Ç»Çs
 - 1;

347 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", &
¬’a_Şd
, &
sz
, &
¬’a_Ãw
,

349 
¬’a_Ãw
 = 0;

350 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", &
¬’a_Şd
, &
sz
, &
¬’a_Ãw
,

352 
	}
}

353 
TEST_END


355 
	$TEST_BEGIN
(
‹¡_¬’a_i_lg_dœty_muÉ
)

357 
ssize_t
 
lg_dœty_muÉ
, 
Üig_lg_dœty_muÉ
, 
´ev_lg_dœty_muÉ
;

358 
size_t
 
sz
 = (
ssize_t
);

360 
	`‹¡_sk_if
(
İt_purge
 !ğ
purge_mode_¿tio
);

362 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.lg_dœty_muÉ", &
Üig_lg_dœty_muÉ
, &
sz
,

363 
NULL
, 0), 0, "Unexpected mallctl() failure");

365 
lg_dœty_muÉ
 = -2;

366 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.lg_dœty_muÉ", 
NULL
, NULL,

367 &
lg_dœty_muÉ
, (
ssize_t
)), 
EFAULT
,

370 
lg_dœty_muÉ
 = ((
size_t
) << 3);

371 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.lg_dœty_muÉ", 
NULL
, NULL,

372 &
lg_dœty_muÉ
, (
ssize_t
)), 
EFAULT
,

375 
´ev_lg_dœty_muÉ
 = 
Üig_lg_dœty_muÉ
, 
lg_dœty_muÉ
 = -1;

376 
lg_dœty_muÉ
 < (
ssize_t
)((
size_t
è<< 3); 
´ev_lg_dœty_muÉ


377 ğ
lg_dœty_muÉ
,†g_dirty_mult++) {

378 
ssize_t
 
Şd_lg_dœty_muÉ
;

380 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.lg_dœty_muÉ", &
Şd_lg_dœty_muÉ
,

381 &
sz
, &
lg_dœty_muÉ
, (
ssize_t
)), 0,

383 
	`as£¹_zd_eq
(
Şd_lg_dœty_muÉ
, 
´ev_lg_dœty_muÉ
,

386 
	}
}

387 
TEST_END


389 
	$TEST_BEGIN
(
‹¡_¬’a_i_deÿy_time
)

391 
ssize_t
 
deÿy_time
, 
Üig_deÿy_time
, 
´ev_deÿy_time
;

392 
size_t
 
sz
 = (
ssize_t
);

394 
	`‹¡_sk_if
(
İt_purge
 !ğ
purge_mode_deÿy
);

396 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.deÿy_time", &
Üig_deÿy_time
, &
sz
,

397 
NULL
, 0), 0, "Unexpected mallctl() failure");

399 
deÿy_time
 = -2;

400 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.deÿy_time", 
NULL
, NULL,

401 &
deÿy_time
, (
ssize_t
)), 
EFAULT
,

404 
deÿy_time
 = 0x7fffffff;

405 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.deÿy_time", 
NULL
, NULL,

406 &
deÿy_time
, (
ssize_t
)), 0,

409 
´ev_deÿy_time
 = 
deÿy_time
, decay_time = -1;

410 
deÿy_time
 < 20; 
´ev_deÿy_time
 = decay_time, decay_time++) {

411 
ssize_t
 
Şd_deÿy_time
;

413 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.deÿy_time", &
Şd_deÿy_time
,

414 &
sz
, &
deÿy_time
, (
ssize_t
)), 0,

416 
	`as£¹_zd_eq
(
Şd_deÿy_time
, 
´ev_deÿy_time
,

419 
	}
}

420 
TEST_END


422 
	$TEST_BEGIN
(
‹¡_¬’a_i_purge
)

424 
Ç»Çs
;

425 
size_t
 
sz
 = ();

426 
size_t
 
mib
[3];

427 
size_t
 
mibËn
 = 3;

429 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

432 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0), 0,

434 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.purge", 
mib
, &
mibËn
), 0,

436 
mib
[1] = 
Ç»Çs
;

437 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, NULL, 0), 0,

439 
	}
}

440 
TEST_END


442 
	$TEST_BEGIN
(
‹¡_¬’a_i_deÿy
)

444 
Ç»Çs
;

445 
size_t
 
sz
 = ();

446 
size_t
 
mib
[3];

447 
size_t
 
mibËn
 = 3;

449 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.deÿy", 
NULL
, NULL, NULL, 0), 0,

452 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0), 0,

454 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.deÿy", 
mib
, &
mibËn
), 0,

456 
mib
[1] = 
Ç»Çs
;

457 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, NULL, 0), 0,

459 
	}
}

460 
TEST_END


462 
	$TEST_BEGIN
(
‹¡_¬’a_i_dss
)

464 cÚ¡ *
dss_´ec_Şd
, *
dss_´ec_Ãw
;

465 
size_t
 
sz
 = (
dss_´ec_Şd
);

466 
size_t
 
mib
[3];

467 
size_t
 
mibËn
;

469 
mibËn
 = (
mib
)/(
size_t
);

470 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.dss", 
mib
, &
mibËn
), 0,

473 
dss_´ec_Ãw
 = "disabled";

474 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Şd
, &
sz
, &
dss_´ec_Ãw
,

475 (
dss_´ec_Ãw
)), 0, "Unexpected mallctl() failure");

476 
	`as£¹_¡r_Ã
(
dss_´ec_Şd
, "primary",

479 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Ãw
, &
sz
, &
dss_´ec_Şd
,

480 (
dss_´ec_Şd
)), 0, "Unexpected mallctl() failure");

482 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Şd
, &
sz
, 
NULL
, 0), 0,

484 
	`as£¹_¡r_Ã
(
dss_´ec_Şd
, "primary",

487 
mib
[1] = 
	`Ç»Çs_tÙ®_g‘
();

488 
dss_´ec_Ãw
 = "disabled";

489 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Şd
, &
sz
, &
dss_´ec_Ãw
,

490 (
dss_´ec_Ãw
)), 0, "Unexpected mallctl() failure");

491 
	`as£¹_¡r_Ã
(
dss_´ec_Şd
, "primary",

494 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Ãw
, &
sz
, &
dss_´ec_Şd
,

495 (
dss_´ec_Ãw
)), 0, "Unexpected mallctl() failure");

497 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Şd
, &
sz
, 
NULL
, 0), 0,

499 
	`as£¹_¡r_Ã
(
dss_´ec_Şd
, "primary",

501 
	}
}

502 
TEST_END


504 
	$TEST_BEGIN
(
‹¡_¬’as_š™Ÿlized
)

506 
Ç»Çs
;

507 
size_t
 
sz
 = (
Ç»Çs
);

509 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0), 0,

512 
	`VARIABLE_ARRAY
(
boŞ
, 
š™Ÿlized
, 
Ç»Çs
);

514 
sz
 = 
Ç»Çs
 * (
boŞ
);

515 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.š™Ÿlized", 
š™Ÿlized
, &
sz
,

516 
NULL
, 0), 0, "Unexpected mallctl() failure");

518 
	}
}

519 
TEST_END


521 
	$TEST_BEGIN
(
‹¡_¬’as_lg_dœty_muÉ
)

523 
ssize_t
 
lg_dœty_muÉ
, 
Üig_lg_dœty_muÉ
, 
´ev_lg_dœty_muÉ
;

524 
size_t
 
sz
 = (
ssize_t
);

526 
	`‹¡_sk_if
(
İt_purge
 !ğ
purge_mode_¿tio
);

528 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.lg_dœty_muÉ", &
Üig_lg_dœty_muÉ
, &
sz
,

529 
NULL
, 0), 0, "Unexpected mallctl() failure");

531 
lg_dœty_muÉ
 = -2;

532 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.lg_dœty_muÉ", 
NULL
, NULL,

533 &
lg_dœty_muÉ
, (
ssize_t
)), 
EFAULT
,

536 
lg_dœty_muÉ
 = ((
size_t
) << 3);

537 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.lg_dœty_muÉ", 
NULL
, NULL,

538 &
lg_dœty_muÉ
, (
ssize_t
)), 
EFAULT
,

541 
´ev_lg_dœty_muÉ
 = 
Üig_lg_dœty_muÉ
, 
lg_dœty_muÉ
 = -1;

542 
lg_dœty_muÉ
 < (
ssize_t
)((
size_t
è<< 3); 
´ev_lg_dœty_muÉ
 =

543 
lg_dœty_muÉ
,†g_dirty_mult++) {

544 
ssize_t
 
Şd_lg_dœty_muÉ
;

546 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.lg_dœty_muÉ", &
Şd_lg_dœty_muÉ
,

547 &
sz
, &
lg_dœty_muÉ
, (
ssize_t
)), 0,

549 
	`as£¹_zd_eq
(
Şd_lg_dœty_muÉ
, 
´ev_lg_dœty_muÉ
,

552 
	}
}

553 
TEST_END


555 
	$TEST_BEGIN
(
‹¡_¬’as_deÿy_time
)

557 
ssize_t
 
deÿy_time
, 
Üig_deÿy_time
, 
´ev_deÿy_time
;

558 
size_t
 
sz
 = (
ssize_t
);

560 
	`‹¡_sk_if
(
İt_purge
 !ğ
purge_mode_deÿy
);

562 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.deÿy_time", &
Üig_deÿy_time
, &
sz
,

563 
NULL
, 0), 0, "Unexpected mallctl() failure");

565 
deÿy_time
 = -2;

566 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.deÿy_time", 
NULL
, NULL,

567 &
deÿy_time
, (
ssize_t
)), 
EFAULT
,

570 
deÿy_time
 = 0x7fffffff;

571 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.deÿy_time", 
NULL
, NULL,

572 &
deÿy_time
, (
ssize_t
)), 0,

575 
´ev_deÿy_time
 = 
deÿy_time
, decay_time = -1;

576 
deÿy_time
 < 20; 
´ev_deÿy_time
 = decay_time, decay_time++) {

577 
ssize_t
 
Şd_deÿy_time
;

579 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.deÿy_time", &
Şd_deÿy_time
,

580 &
sz
, &
deÿy_time
, (
ssize_t
)), 0,

582 
	`as£¹_zd_eq
(
Şd_deÿy_time
, 
´ev_deÿy_time
,

585 
	}
}

586 
TEST_END


588 
	$TEST_BEGIN
(
‹¡_¬’as_cÚ¡ªts
)

591 
	#TEST_ARENAS_CONSTANT
(
t
, 
Çme
, 
ex³ùed
) do { \

592 
t
 
Çme
; \

593 
size_t
 
sz
 = (
t
); \

594 
	`as£¹_d_eq
(
	`m®lùl
("¬’as."#Çme, &
Çme
, &
sz
, 
NULL
, 0), 0, \

596 
	`as£¹_zu_eq
(
Çme
, 
ex³ùed
, "Incorrect "#name" size"); \

597 } 0)

	)

599 
	`TEST_ARENAS_CONSTANT
(
size_t
, 
quªtum
, 
QUANTUM
);

600 
	`TEST_ARENAS_CONSTANT
(
size_t
, 
·ge
, 
PAGE
);

601 
	`TEST_ARENAS_CONSTANT
(, 
nbšs
, 
NBINS
);

602 
	`TEST_ARENAS_CONSTANT
(, 
Æruns
, 
Æşas£s
);

603 
	`TEST_ARENAS_CONSTANT
(, 
nhchunks
, 
nhşas£s
);

605 #undeà
TEST_ARENAS_CONSTANT


606 
	}
}

607 
TEST_END


609 
	$TEST_BEGIN
(
‹¡_¬’as_bš_cÚ¡ªts
)

612 
	#TEST_ARENAS_BIN_CONSTANT
(
t
, 
Çme
, 
ex³ùed
) do { \

613 
t
 
Çme
; \

614 
size_t
 
sz
 = (
t
); \

615 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.bš.0."#Çme, &
Çme
, &
sz
, 
NULL
, 0), \

617 
	`as£¹_zu_eq
(
Çme
, 
ex³ùed
, "Incorrect "#name" size"); \

618 } 0)

	)

620 
	`TEST_ARENAS_BIN_CONSTANT
(
size_t
, 
size
, 
¬’a_bš_šfo
[0].
»g_size
);

621 
	`TEST_ARENAS_BIN_CONSTANT
(
ušt32_t
, 
Äegs
, 
¬’a_bš_šfo
[0].nregs);

622 
	`TEST_ARENAS_BIN_CONSTANT
(
size_t
, 
run_size
, 
¬’a_bš_šfo
[0].run_size);

624 #undeà
TEST_ARENAS_BIN_CONSTANT


625 
	}
}

626 
TEST_END


628 
	$TEST_BEGIN
(
‹¡_¬’as_Ìun_cÚ¡ªts
)

631 
	#TEST_ARENAS_LRUN_CONSTANT
(
t
, 
Çme
, 
ex³ùed
) do { \

632 
t
 
Çme
; \

633 
size_t
 
sz
 = (
t
); \

634 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ìun.0."#Çme, &
Çme
, &
sz
, 
NULL
, \

636 
	`as£¹_zu_eq
(
Çme
, 
ex³ùed
, "Incorrect "#name" size"); \

637 } 0)

	)

639 
	`TEST_ARENAS_LRUN_CONSTANT
(
size_t
, 
size
, 
LARGE_MINCLASS
);

641 #undeà
TEST_ARENAS_LRUN_CONSTANT


642 
	}
}

643 
TEST_END


645 
	$TEST_BEGIN
(
‹¡_¬’as_hchunk_cÚ¡ªts
)

648 
	#TEST_ARENAS_HCHUNK_CONSTANT
(
t
, 
Çme
, 
ex³ùed
) do { \

649 
t
 
Çme
; \

650 
size_t
 
sz
 = (
t
); \

651 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.hchunk.0."#Çme, &
Çme
, &
sz
, 
NULL
, \

653 
	`as£¹_zu_eq
(
Çme
, 
ex³ùed
, "Incorrect "#name" size"); \

654 } 0)

	)

656 
	`TEST_ARENAS_HCHUNK_CONSTANT
(
size_t
, 
size
, 
chunksize
);

658 #undeà
TEST_ARENAS_HCHUNK_CONSTANT


659 
	}
}

660 
TEST_END


662 
	$TEST_BEGIN
(
‹¡_¬’as_ex‹nd
)

664 
Ç»Çs_befÜe
, 
¬’a
, 
Ç»Çs_aá”
;

665 
size_t
 
sz
 = ();

667 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs_befÜe
, &
sz
, 
NULL
, 0), 0,

669 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.ex‹nd", &
¬’a
, &
sz
, 
NULL
, 0), 0,

671 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs_aá”
, &
sz
, 
NULL
, 0), 0,

674 
	`as£¹_u_eq
(
Ç»Çs_befÜe
+1, 
Ç»Çs_aá”
,

676 
	`as£¹_u_eq
(
¬’a
, 
Ç»Çs_aá”
-1, "Unexpected‡rena index");

677 
	}
}

678 
TEST_END


680 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as
)

683 
	#TEST_STATS_ARENAS
(
t
, 
Çme
) do { \

684 
t
 
Çme
; \

685 
size_t
 
sz
 = (
t
); \

686 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0."#Çme, &
Çme
, &
sz
, 
NULL
, \

688 } 0)

	)

690 
	`TEST_STATS_ARENAS
(, 
Áh»ads
);

691 
	`TEST_STATS_ARENAS
(cÚ¡ *, 
dss
);

692 
	`TEST_STATS_ARENAS
(
ssize_t
, 
lg_dœty_muÉ
);

693 
	`TEST_STATS_ARENAS
(
ssize_t
, 
deÿy_time
);

694 
	`TEST_STATS_ARENAS
(
size_t
, 
·ùive
);

695 
	`TEST_STATS_ARENAS
(
size_t
, 
pdœty
);

697 #undeà
TEST_STATS_ARENAS


698 
	}
}

699 
TEST_END


702 
	$maš
()

705  (
	`‹¡
(

706 
‹¡_m®lùl_”rÜs
,

707 
‹¡_m®lùÊam‘omib_”rÜs
,

708 
‹¡_m®lùlbymib_”rÜs
,

709 
‹¡_m®lùl_»ad_wr™e
,

710 
‹¡_m®lùÊam‘omib_shÜt_mib
,

711 
‹¡_m®lùl_cÚfig
,

712 
‹¡_m®lùl_İt
,

713 
‹¡_mª·ge_exam¶e
,

714 
‹¡_tÿche_nÚe
,

715 
‹¡_tÿche
,

716 
‹¡_th»ad_¬’a
,

717 
‹¡_¬’a_i_lg_dœty_muÉ
,

718 
‹¡_¬’a_i_deÿy_time
,

719 
‹¡_¬’a_i_purge
,

720 
‹¡_¬’a_i_deÿy
,

721 
‹¡_¬’a_i_dss
,

722 
‹¡_¬’as_š™Ÿlized
,

723 
‹¡_¬’as_lg_dœty_muÉ
,

724 
‹¡_¬’as_deÿy_time
,

725 
‹¡_¬’as_cÚ¡ªts
,

726 
‹¡_¬’as_bš_cÚ¡ªts
,

727 
‹¡_¬’as_Ìun_cÚ¡ªts
,

728 
‹¡_¬’as_hchunk_cÚ¡ªts
,

729 
‹¡_¬’as_ex‹nd
,

730 
‹¡_¡©s_¬’as
));

731 
	}
}

	@dep/jemalloc-4.2.0/test/unit/math.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#MAX_REL_ERR
 1.0e-9

	)

4 
	#MAX_ABS_ERR
 1.0e-9

	)

6 
	~<æßt.h
>

8 #iâdeà
INFINITY


9 
	#INFINITY
 (
DBL_MAX
 + DBL_MAX)

	)

12 
boŞ


13 
	$doubË_eq_»l
(
a
, 
b
, 
max_»l_”r
, 
max_abs_”r
)

15 
»l_”r
;

17 ià(
	`çbs
(
a
 - 
b
è< 
max_abs_”r
)

18  (
Œue
);

19 
»l_”r
 = (
	`çbs
(
b
è> fabs(
a
)) ? fabs((a-b)/b) : fabs((a-b)/a);

20  (
»l_”r
 < 
max_»l_”r
);

21 
	}
}

23 
ušt64_t


24 
	$çùÜŸl
(
x
)

26 
ušt64_t
 
»t
 = 1;

27 
i
;

29 
i
 = 2; i <ğ
x
; i++)

30 
»t
 *ğ(
ušt64_t
)
i
;

32  (
»t
);

33 
	}
}

35 
	$TEST_BEGIN
(
‹¡_Ê_gamma_çùÜŸl
)

37 
x
;

40 
x
 = 1; x <= 21; x++) {

41 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`exp
(
	`Ê_gamma
(
x
)),

42 ()
	`çùÜŸl
(
x
-1), 
MAX_REL_ERR
, 
MAX_ABS_ERR
),

43 "IncÜ»ù faùÜŸÈ»suÉ fÜ x=%u", 
x
);

45 
	}
}

46 
TEST_END


49 cÚ¡ 
	gÊ_gamma_misc_ex³ùed
[] = {

50 
INFINITY
,

187 
	$TEST_BEGIN
(
‹¡_Ê_gamma_misc
)

189 
i
;

191 
i
 = 1; i < (
Ê_gamma_misc_ex³ùed
)/(); i++) {

192 
x
 = ()
i
 * 0.25;

193 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`Ê_gamma
(
x
),

194 
Ê_gamma_misc_ex³ùed
[
i
], 
MAX_REL_ERR
, 
MAX_ABS_ERR
),

195 "IncÜ»ù†n_gamm¨»suÉ fÜ i=%u", 
i
);

197 
	}
}

198 
TEST_END


201 cÚ¡ 
	g±_nÜm_ex³ùed
[] = {

202 -
INFINITY
,

238 
	$TEST_BEGIN
(
‹¡_±_nÜm
)

240 
i
;

242 
i
 = 1; i < (
±_nÜm_ex³ùed
)/(); i++) {

243 
p
 = ()
i
 * 0.01;

244 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`±_nÜm
(
p
), 
±_nÜm_ex³ùed
[
i
],

245 
MAX_REL_ERR
, 
MAX_ABS_ERR
),

246 "IncÜ»ù…t_nÜm„esuÉ fÜ i=%u", 
i
);

248 
	}
}

249 
TEST_END


255 cÚ¡ 
	g±_chi2_df
[] = {0.1, 1.1, 10.1, 100.1, 1000.1};

256 cÚ¡ 
	g±_chi2_ex³ùed
[] = {

288 
	$TEST_BEGIN
(
‹¡_±_chi2
)

290 
i
, 
j
;

291 
e
 = 0;

293 
i
 = 0; i < (
±_chi2_df
)/(); i++) {

294 
df
 = 
±_chi2_df
[
i
];

295 
Ê_gamma_df
 = 
	`Ê_gamma
(
df
 * 0.5);

296 
j
 = 1; j < 100; j += 7) {

297 
p
 = ()
j
 * 0.01;

298 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`±_chi2
(
p
, 
df
, 
Ê_gamma_df
),

299 
±_chi2_ex³ùed
[
e
], 
MAX_REL_ERR
, 
MAX_ABS_ERR
),

300 "IncÜ»ù…t_chi2„esuÉ fÜ i=%u, j=%u", 
i
, 
j
);

301 
e
++;

304 
	}
}

305 
TEST_END


311 cÚ¡ 
	g±_gamma_sh­e
[] = {0.5, 1.0, 1.5, 2.0, 2.5, 3.0};

312 cÚ¡ 
	g±_gamma_ex³ùed
[] = {

350 
	$TEST_BEGIN
(
‹¡_±_gamma_sh­e
)

352 
i
, 
j
;

353 
e
 = 0;

355 
i
 = 0; i < (
±_gamma_sh­e
)/(); i++) {

356 
sh­e
 = 
±_gamma_sh­e
[
i
];

357 
Ê_gamma_sh­e
 = 
	`Ê_gamma
(
sh­e
);

358 
j
 = 1; j < 100; j += 7) {

359 
p
 = ()
j
 * 0.01;

360 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`±_gamma
(
p
, 
sh­e
, 1.0,

361 
Ê_gamma_sh­e
), 
±_gamma_ex³ùed
[
e
], 
MAX_REL_ERR
,

362 
MAX_ABS_ERR
),

363 "IncÜ»ù…t_gamm¨»suÉ fÜ i=%u, j=%u", 
i
, 
j
);

364 
e
++;

367 
	}
}

368 
TEST_END


370 
	$TEST_BEGIN
(
‹¡_±_gamma_sÿË
)

372 
sh­e
 = 1.0;

373 
Ê_gamma_sh­e
 = 
	`Ê_gamma
(
sh­e
);

375 
	`as£¹_Œue
(
	`doubË_eq_»l
(

376 
	`±_gamma
(0.5, 
sh­e
, 1.0, 
Ê_gamma_sh­e
) * 10.0,

377 
	`±_gamma
(0.5, 
sh­e
, 10.0, 
Ê_gamma_sh­e
), 
MAX_REL_ERR
,

378 
MAX_ABS_ERR
),

380 
	}
}

381 
TEST_END


384 
	$maš
()

387  (
	`‹¡
(

388 
‹¡_Ê_gamma_çùÜŸl
,

389 
‹¡_Ê_gamma_misc
,

390 
‹¡_±_nÜm
,

391 
‹¡_±_chi2
,

392 
‹¡_±_gamma_sh­e
,

393 
‹¡_±_gamma_sÿË
));

394 
	}
}

	@dep/jemalloc-4.2.0/test/unit/mq.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NSENDERS
 3

	)

4 
	#NMSGS
 100000

	)

6 
mq_msg_s
 
	tmq_msg_t
;

7 
	smq_msg_s
 {

8 
mq_msg
(
mq_msg_t
è
	mlšk
;

10 
	$mq_g’
(, 
mq_
, 
mq_t
, 
mq_msg_t
, 
lšk
)

12 
	$TEST_BEGIN
(
‹¡_mq_basic
)

14 
mq_t
 
mq
;

15 
mq_msg_t
 
msg
;

17 
	`as£¹_çl£
(
	`mq_š™
(&
mq
), "Unexpected mq_init() failure");

18 
	`as£¹_u_eq
(
	`mq_couÁ
(&
mq
), 0, "mq should beƒmpty");

19 
	`as£¹_±r_nuÎ
(
	`mq_Œyg‘
(&
mq
),

22 
	`mq_put
(&
mq
, &
msg
);

23 
	`as£¹_u_eq
(
	`mq_couÁ
(&
mq
), 1, "mq should contain one message");

24 
	`as£¹_±r_eq
(
	`mq_Œyg‘
(&
mq
), &
msg
, "mq_tryget() should„eturn msg");

26 
	`mq_put
(&
mq
, &
msg
);

27 
	`as£¹_±r_eq
(
	`mq_g‘
(&
mq
), &
msg
, "mq_get() should„eturn msg");

29 
	`mq_fši
(&
mq
);

30 
	}
}

31 
TEST_END


34 
	$thd_»ûiv”_¡¬t
(*
¬g
)

36 
mq_t
 *
mq
 = (mq_ˆ*)
¬g
;

37 
i
;

39 
i
 = 0; i < (
NSENDERS
 * 
NMSGS
); i++) {

40 
mq_msg_t
 *
msg
 = 
	`mq_g‘
(
mq
);

41 
	`as£¹_±r_nÙ_nuÎ
(
msg
, "mq_get() should‚ever„eturn NULL");

42 
	`d®locx
(
msg
, 0);

44  (
NULL
);

45 
	}
}

48 
	$thd_£nd”_¡¬t
(*
¬g
)

50 
mq_t
 *
mq
 = (mq_ˆ*)
¬g
;

51 
i
;

53 
i
 = 0; i < 
NMSGS
; i++) {

54 
mq_msg_t
 *
msg
;

55 *
p
;

56 
p
 = 
	`m®locx
((
mq_msg_t
), 0);

57 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

58 
msg
 = (
mq_msg_t
 *)
p
;

59 
	`mq_put
(
mq
, 
msg
);

61  (
NULL
);

62 
	}
}

64 
	$TEST_BEGIN
(
‹¡_mq_th»aded
)

66 
mq_t
 
mq
;

67 
thd_t
 
»ûiv”
;

68 
thd_t
 
£nd”s
[
NSENDERS
];

69 
i
;

71 
	`as£¹_çl£
(
	`mq_š™
(&
mq
), "Unexpected mq_init() failure");

73 
	`thd_ü—‹
(&
»ûiv”
, 
thd_»ûiv”_¡¬t
, (*)&
mq
);

74 
i
 = 0; i < 
NSENDERS
; i++)

75 
	`thd_ü—‹
(&
£nd”s
[
i
], 
thd_£nd”_¡¬t
, (*)&
mq
);

77 
	`thd_još
(
»ûiv”
, 
NULL
);

78 
i
 = 0; i < 
NSENDERS
; i++)

79 
	`thd_još
(
£nd”s
[
i
], 
NULL
);

81 
	`mq_fši
(&
mq
);

82 
	}
}

83 
TEST_END


86 
	$maš
()

89  (
	`‹¡
(

90 
‹¡_mq_basic
,

91 
‹¡_mq_th»aded
));

92 
	}
}

	@dep/jemalloc-4.2.0/test/unit/mtx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NTHREADS
 2

	)

4 
	#NINCRS
 2000000

	)

6 
	$TEST_BEGIN
(
‹¡_mtx_basic
)

8 
mtx_t
 
mtx
;

10 
	`as£¹_çl£
(
	`mtx_š™
(&
mtx
), "Unexpected mtx_init() failure");

11 
	`mtx_lock
(&
mtx
);

12 
	`mtx_uÆock
(&
mtx
);

13 
	`mtx_fši
(&
mtx
);

14 
	}
}

15 
TEST_END


18 
mtx_t
 
	mmtx
;

19 
	mx
;

20 } 
	tthd_¡¬t_¬g_t
;

23 
	$thd_¡¬t
(*
v¬g
)

25 
thd_¡¬t_¬g_t
 *
¬g
 = (thd_¡¬t_¬g_ˆ*)
v¬g
;

26 
i
;

28 
i
 = 0; i < 
NINCRS
; i++) {

29 
	`mtx_lock
(&
¬g
->
mtx
);

30 
¬g
->
x
++;

31 
	`mtx_uÆock
(&
¬g
->
mtx
);

33  (
NULL
);

34 
	}
}

36 
	$TEST_BEGIN
(
‹¡_mtx_¿û
)

38 
thd_¡¬t_¬g_t
 
¬g
;

39 
thd_t
 
thds
[
NTHREADS
];

40 
i
;

42 
	`as£¹_çl£
(
	`mtx_š™
(&
¬g
.
mtx
), "Unexpected mtx_init() failure");

43 
¬g
.
x
 = 0;

44 
i
 = 0; i < 
NTHREADS
; i++)

45 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
, (*)&
¬g
);

46 
i
 = 0; i < 
NTHREADS
; i++)

47 
	`thd_još
(
thds
[
i
], 
NULL
);

48 
	`as£¹_u_eq
(
¬g
.
x
, 
NTHREADS
 * 
NINCRS
,

50 
	}
}

51 
TEST_END


54 
	$maš
()

57  (
	`‹¡
(

58 
‹¡_mtx_basic
,

59 
‹¡_mtx_¿û
));

60 
	}
}

	@dep/jemalloc-4.2.0/test/unit/nstime.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#BILLION
 
	`UINT64_C
(1000000000)

	)

5 
	$TEST_BEGIN
(
‹¡_n¡ime_š™
)

7 
n¡ime_t
 
n¡
;

9 
	`n¡ime_š™
(&
n¡
, 42000000043);

10 
	`as£¹_u64_eq
(
	`n¡ime_ns
(&
n¡
), 42000000043, "ns incorrectly„ead");

11 
	`as£¹_u64_eq
(
	`n¡ime_£c
(&
n¡
), 42, "sec incorrectly„ead");

12 
	`as£¹_u64_eq
(
	`n¡ime_n£c
(&
n¡
), 43, "nsec incorrectly„ead");

13 
	}
}

14 
TEST_END


16 
	$TEST_BEGIN
(
‹¡_n¡ime_š™2
)

18 
n¡ime_t
 
n¡
;

20 
	`n¡ime_š™2
(&
n¡
, 42, 43);

21 
	`as£¹_u64_eq
(
	`n¡ime_£c
(&
n¡
), 42, "sec incorrectly„ead");

22 
	`as£¹_u64_eq
(
	`n¡ime_n£c
(&
n¡
), 43, "nsec incorrectly„ead");

23 
	}
}

24 
TEST_END


26 
	$TEST_BEGIN
(
‹¡_n¡ime_cİy
)

28 
n¡ime_t
 
n¡a
, 
n¡b
;

30 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

31 
	`n¡ime_š™
(&
n¡b
, 0);

32 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

33 
	`as£¹_u64_eq
(
	`n¡ime_£c
(&
n¡b
), 42, "sec incorrectly copied");

34 
	`as£¹_u64_eq
(
	`n¡ime_n£c
(&
n¡b
), 43, "nsec incorrectly copied");

35 
	}
}

36 
TEST_END


38 
	$TEST_BEGIN
(
‹¡_n¡ime_com·»
)

40 
n¡ime_t
 
n¡a
, 
n¡b
;

42 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

43 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

44 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 0, "Times should beƒqual");

45 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡b
, &
n¡a
), 0, "Times should beƒqual");

47 
	`n¡ime_š™2
(&
n¡b
, 42, 42);

48 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 1,

50 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡b
, &
n¡a
), -1,

53 
	`n¡ime_š™2
(&
n¡b
, 42, 44);

54 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), -1,

56 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡b
, &
n¡a
), 1,

59 
	`n¡ime_š™2
(&
n¡b
, 41, 
BILLION
 - 1);

60 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 1,

62 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡b
, &
n¡a
), -1,

65 
	`n¡ime_š™2
(&
n¡b
, 43, 0);

66 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), -1,

68 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡b
, &
n¡a
), 1,

70 
	}
}

71 
TEST_END


73 
	$TEST_BEGIN
(
‹¡_n¡ime_add
)

75 
n¡ime_t
 
n¡a
, 
n¡b
;

77 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

78 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

79 
	`n¡ime_add
(&
n¡a
, &
n¡b
);

80 
	`n¡ime_š™2
(&
n¡b
, 84, 86);

81 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 0,

84 
	`n¡ime_š™2
(&
n¡a
, 42, 
BILLION
 - 1);

85 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

86 
	`n¡ime_add
(&
n¡a
, &
n¡b
);

87 
	`n¡ime_š™2
(&
n¡b
, 85, 
BILLION
 - 2);

88 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 0,

90 
	}
}

91 
TEST_END


93 
	$TEST_BEGIN
(
‹¡_n¡ime_subŒaù
)

95 
n¡ime_t
 
n¡a
, 
n¡b
;

97 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

98 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

99 
	`n¡ime_subŒaù
(&
n¡a
, &
n¡b
);

100 
	`n¡ime_š™
(&
n¡b
, 0);

101 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 0,

104 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

105 
	`n¡ime_š™2
(&
n¡b
, 41, 44);

106 
	`n¡ime_subŒaù
(&
n¡a
, &
n¡b
);

107 
	`n¡ime_š™2
(&
n¡b
, 0, 
BILLION
 - 1);

108 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 0,

110 
	}
}

111 
TEST_END


113 
	$TEST_BEGIN
(
‹¡_n¡ime_imuÉly
)

115 
n¡ime_t
 
n¡a
, 
n¡b
;

117 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

118 
	`n¡ime_imuÉly
(&
n¡a
, 10);

119 
	`n¡ime_š™2
(&
n¡b
, 420, 430);

120 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 0,

123 
	`n¡ime_š™2
(&
n¡a
, 42, 666666666);

124 
	`n¡ime_imuÉly
(&
n¡a
, 3);

125 
	`n¡ime_š™2
(&
n¡b
, 127, 999999998);

126 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 0,

128 
	}
}

129 
TEST_END


131 
	$TEST_BEGIN
(
‹¡_n¡ime_idivide
)

133 
n¡ime_t
 
n¡a
, 
n¡b
;

135 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

136 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

137 
	`n¡ime_imuÉly
(&
n¡a
, 10);

138 
	`n¡ime_idivide
(&
n¡a
, 10);

139 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 0,

142 
	`n¡ime_š™2
(&
n¡a
, 42, 666666666);

143 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

144 
	`n¡ime_imuÉly
(&
n¡a
, 3);

145 
	`n¡ime_idivide
(&
n¡a
, 3);

146 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡a
, &
n¡b
), 0,

148 
	}
}

149 
TEST_END


151 
	$TEST_BEGIN
(
‹¡_n¡ime_divide
)

153 
n¡ime_t
 
n¡a
, 
n¡b
, 
n¡c
;

155 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

156 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

157 
	`n¡ime_imuÉly
(&
n¡a
, 10);

158 
	`as£¹_u64_eq
(
	`n¡ime_divide
(&
n¡a
, &
n¡b
), 10,

161 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

162 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

163 
	`n¡ime_imuÉly
(&
n¡a
, 10);

164 
	`n¡ime_š™
(&
n¡c
, 1);

165 
	`n¡ime_add
(&
n¡a
, &
n¡c
);

166 
	`as£¹_u64_eq
(
	`n¡ime_divide
(&
n¡a
, &
n¡b
), 10,

169 
	`n¡ime_š™2
(&
n¡a
, 42, 43);

170 
	`n¡ime_cİy
(&
n¡b
, &
n¡a
);

171 
	`n¡ime_imuÉly
(&
n¡a
, 10);

172 
	`n¡ime_š™
(&
n¡c
, 1);

173 
	`n¡ime_subŒaù
(&
n¡a
, &
n¡c
);

174 
	`as£¹_u64_eq
(
	`n¡ime_divide
(&
n¡a
, &
n¡b
), 9,

176 
	}
}

177 
TEST_END


179 
	$TEST_BEGIN
(
‹¡_n¡ime_upd©e
)

181 
n¡ime_t
 
n¡
;

183 
	`n¡ime_š™
(&
n¡
, 0);

185 
	`as£¹_çl£
(
	`n¡ime_upd©e
(&
n¡
), "Basicime update failed.");

189 
n¡ime_t
 
add’d
;

190 
	`n¡ime_š™2
(&
add’d
, 631152000, 0);

191 
	`n¡ime_add
(&
n¡
, &
add’d
);

194 
n¡ime_t
 
n¡0
;

195 
	`n¡ime_cİy
(&
n¡0
, &
n¡
);

196 
	`as£¹_Œue
(
	`n¡ime_upd©e
(&
n¡
),

198 
	`as£¹_d_eq
(
	`n¡ime_com·»
(&
n¡
, &
n¡0
), 0,

202 
	}
}

203 
TEST_END


206 
	$maš
()

209  (
	`‹¡
(

210 
‹¡_n¡ime_š™
,

211 
‹¡_n¡ime_š™2
,

212 
‹¡_n¡ime_cİy
,

213 
‹¡_n¡ime_com·»
,

214 
‹¡_n¡ime_add
,

215 
‹¡_n¡ime_subŒaù
,

216 
‹¡_n¡ime_imuÉly
,

217 
‹¡_n¡ime_idivide
,

218 
‹¡_n¡ime_divide
,

219 
‹¡_n¡ime_upd©e
));

220 
	}
}

	@dep/jemalloc-4.2.0/test/unit/ph.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
node_s
 
	tnode_t
;

5 
	snode_s
 {

6 
	#NODE_MAGIC
 0x9823af7e

	)

7 
ušt32_t
 
	mmagic
;

8 
phn
(
node_t
è
	mlšk
;

9 
ušt64_t
 
	mkey
;

13 
	$node_cmp
(cÚ¡ 
node_t
 *
a
, cÚ¡‚ode_ˆ*
b
)

15 
»t
;

17 
»t
 = (
a
->
key
 > 
b
->key) - (a->key < b->key);

18 ià(
»t
 == 0) {

23 
»t
 = (((
ušŒ_t
)
a
è> ((ušŒ_t)
b
))

24 - (((
ušŒ_t
)
a
è< ((ušŒ_t)
b
));

26  (
»t
);

27 
	}
}

30 
	$node_cmp_magic
(cÚ¡ 
node_t
 *
a
, cÚ¡‚ode_ˆ*
b
) {

32 
	`as£¹_u32_eq
(
a
->
magic
, 
NODE_MAGIC
, "Bad magic");

33 
	`as£¹_u32_eq
(
b
->
magic
, 
NODE_MAGIC
, "Bad magic");

35  (
	`node_cmp
(
a
, 
b
));

36 
	}
}

38 
	$ph
(
	tnode_t
è
	th—p_t
;

39 
	`ph_g’
(, 
h—p_
, 
h—p_t
, 
node_t
, 
lšk
, 
node_cmp_magic
);

42 
	$node_´št
(cÚ¡ 
node_t
 *
node
, 
d•th
)

44 
i
;

45 
node_t
 *
Ëámo¡_chd
, *
siblšg
;

47 
i
 = 0; i < 
d•th
; i++)

48 
	`m®loc_´štf
("\t");

49 
	`m®loc_´štf
("%2"
FMTu64
"\n", 
node
->
key
);

51 
Ëámo¡_chd
 = 
	`phn_lchd_g‘
(
node_t
, 
lšk
, 
node
);

52 ià(
Ëámo¡_chd
 =ğ
NULL
)

54 
	`node_´št
(
Ëámo¡_chd
, 
d•th
 + 1);

56 
siblšg
 = 
	`phn_Ãxt_g‘
(
node_t
, 
lšk
, 
Ëámo¡_chd
); sibling !=

57 
NULL
; 
siblšg
 = 
	`phn_Ãxt_g‘
(
node_t
, 
lšk
, sibling)) {

58 
	`node_´št
(
siblšg
, 
d•th
 + 1);

60 
	}
}

63 
	$h—p_´št
(cÚ¡ 
h—p_t
 *
h—p
)

65 
node_t
 *
aux–m
;

67 
	`m®loc_´štf
("vvv h—°%°vvv\n", 
h—p
);

68 ià(
h—p
->
ph_roÙ
 =ğ
NULL
)

69 
Ïb–_»tuº
;

71 
	`node_´št
(
h—p
->
ph_roÙ
, 0);

73 
aux–m
 = 
	`phn_Ãxt_g‘
(
node_t
, 
lšk
, 
h—p
->
ph_roÙ
);‡ux–m !ğ
NULL
;

74 
aux–m
 = 
	`phn_Ãxt_g‘
(
node_t
, 
lšk
,‡uxelm)) {

75 
	`as£¹_±r_eq
(
	`phn_Ãxt_g‘
(
node_t
, 
lšk
, 
	`phn_´ev_g‘
(node_t,

76 
lšk
, 
aux–m
)),‡uxelm,

78 
	`node_´št
(
aux–m
, 0);

81 
Ïb–_»tuº
:

82 
	`m®loc_´štf
("^^^ h—°%°^^^\n", 
h—p
);

83 
	}
}

86 
	$node_v®id©e
(cÚ¡ 
node_t
 *
node
, cÚ¡‚ode_ˆ*
·»Á
)

88 
Âodes
 = 1;

89 
node_t
 *
Ëámo¡_chd
, *
siblšg
;

91 ià(
·»Á
 !ğ
NULL
) {

92 
	`as£¹_d_ge
(
	`node_cmp_magic
(
node
, 
·»Á
), 0,

96 
Ëámo¡_chd
 = 
	`phn_lchd_g‘
(
node_t
, 
lšk
, 
node
);

97 ià(
Ëámo¡_chd
 =ğ
NULL
)

98  (
Âodes
);

99 
	`as£¹_±r_eq
((*)
	`phn_´ev_g‘
(
node_t
, 
lšk
, 
Ëámo¡_chd
),

100 (*)
node
, "Leftmost child does‚ot†inko‚ode");

101 
Âodes
 +ğ
	`node_v®id©e
(
Ëámo¡_chd
, 
node
);

103 
siblšg
 = 
	`phn_Ãxt_g‘
(
node_t
, 
lšk
, 
Ëámo¡_chd
); sibling !=

104 
NULL
; 
siblšg
 = 
	`phn_Ãxt_g‘
(
node_t
, 
lšk
, sibling)) {

105 
	`as£¹_±r_eq
(
	`phn_Ãxt_g‘
(
node_t
, 
lšk
, 
	`phn_´ev_g‘
(node_t,

106 
lšk
, 
siblšg
)), sibling,

108 
Âodes
 +ğ
	`node_v®id©e
(
siblšg
, 
node
);

110  (
Âodes
);

111 
	}
}

114 
	$h—p_v®id©e
(cÚ¡ 
h—p_t
 *
h—p
)

116 
Âodes
 = 0;

117 
node_t
 *
aux–m
;

119 ià(
h—p
->
ph_roÙ
 =ğ
NULL
)

120 
Ïb–_»tuº
;

122 
Âodes
 +ğ
	`node_v®id©e
(
h—p
->
ph_roÙ
, 
NULL
);

124 
aux–m
 = 
	`phn_Ãxt_g‘
(
node_t
, 
lšk
, 
h—p
->
ph_roÙ
);‡ux–m !ğ
NULL
;

125 
aux–m
 = 
	`phn_Ãxt_g‘
(
node_t
, 
lšk
,‡uxelm)) {

126 
	`as£¹_±r_eq
(
	`phn_Ãxt_g‘
(
node_t
, 
lšk
, 
	`phn_´ev_g‘
(node_t,

127 
lšk
, 
aux–m
)),‡uxelm,

129 
Âodes
 +ğ
	`node_v®id©e
(
aux–m
, 
NULL
);

132 
Ïb–_»tuº
:

133 ià(
çl£
)

134 
	`h—p_´št
(
h—p
);

135  (
Âodes
);

136 
	}
}

138 
	$TEST_BEGIN
(
‹¡_ph_em±y
)

140 
h—p_t
 
h—p
;

142 
	`h—p_Ãw
(&
h—p
);

143 
	`as£¹_Œue
(
	`h—p_em±y
(&
h—p
), "Heap should beƒmpty");

144 
	`as£¹_±r_nuÎ
(
	`h—p_fœ¡
(&
h—p
), "Unexpected‚ode");

145 
	}
}

146 
TEST_END


149 
	$node_»move
(
h—p_t
 *
h—p
, 
node_t
 *
node
)

152 
	`h—p_»move
(
h—p
, 
node
);

154 
node
->
magic
 = 0;

155 
	}
}

157 
node_t
 *

158 
	$node_»move_fœ¡
(
h—p_t
 *
h—p
)

160 
node_t
 *
node
 = 
	`h—p_»move_fœ¡
(
h—p
);

161 
node
->
magic
 = 0;

162  (
node
);

163 
	}
}

165 
	$TEST_BEGIN
(
‹¡_ph_¿ndom
)

167 
	#NNODES
 25

	)

168 
	#NBAGS
 250

	)

169 
	#SEED
 42

	)

170 
sfmt_t
 *
sfmt
;

171 
ušt64_t
 
bag
[
NNODES
];

172 
h—p_t
 
h—p
;

173 
node_t
 
nodes
[
NNODES
];

174 
i
, 
j
, 
k
;

176 
sfmt
 = 
	`š™_g’_¿nd
(
SEED
);

177 
i
 = 0; i < 
NBAGS
; i++) {

178 
i
) {

181 
j
 = 0; j < 
NNODES
; j++)

182 
bag
[
j
] = j;

186 
j
 = 0; j < 
NNODES
; j++)

187 
bag
[
j
] = 
NNODES
 - j - 1;

190 
j
 = 0; j < 
NNODES
; j++)

191 
bag
[
j
] = 
	`g’_¿nd64_¿nge
(
sfmt
, 
NNODES
);

194 
j
 = 1; j <ğ
NNODES
; j++) {

196 
	`h—p_Ãw
(&
h—p
);

197 
	`as£¹_u_eq
(
	`h—p_v®id©e
(&
h—p
), 0,

199 
k
 = 0; k < 
j
; k++) {

200 
nodes
[
k
].
magic
 = 
NODE_MAGIC
;

201 
nodes
[
k
].
key
 = 
bag
[k];

205 
k
 = 0; k < 
j
; k++) {

206 
	`h—p_š£¹
(&
h—p
, &
nodes
[
k
]);

207 ià(
i
 % 13 == 12) {

209 
	`as£¹_±r_nÙ_nuÎ
(
	`h—p_fœ¡
(&
h—p
),

212 
	`as£¹_u_eq
(
	`h—p_v®id©e
(&
h—p
), 
k
 + 1,

216 
	`as£¹_çl£
(
	`h—p_em±y
(&
h—p
),

220 
i
 % 4) {

222 
k
 = 0; k < 
j
; k++) {

223 
	`as£¹_u_eq
(
	`h—p_v®id©e
(&
h—p
), 
j
 - 
k
,

225 
	`node_»move
(&
h—p
, &
nodes
[
k
]);

226 
	`as£¹_u_eq
(
	`h—p_v®id©e
(&
h—p
), 
j
 - 
k


231 
k
 = 
j
; k > 0; k--) {

232 
	`node_»move
(&
h—p
, &
nodes
[
k
-1]);

233 
	`as£¹_u_eq
(
	`h—p_v®id©e
(&
h—p
), 
k
 - 1,

238 
node_t
 *
´ev
 = 
NULL
;

239 
k
 = 0; k < 
j
; k++) {

240 
node_t
 *
node
 = 
	`node_»move_fœ¡
(&
h—p
);

241 
	`as£¹_u_eq
(
	`h—p_v®id©e
(&
h—p
), 
j
 - 
k


243 ià(
´ev
 !ğ
NULL
) {

244 
	`as£¹_d_ge
(
	`node_cmp
(
node
,

245 
´ev
), 0,

248 
´ev
 = 
node
;

252 
node_t
 *
´ev
 = 
NULL
;

253 
k
 = 0; k < 
j
; k++) {

254 
node_t
 *
node
 = 
	`h—p_fœ¡
(&
h—p
);

255 
	`as£¹_u_eq
(
	`h—p_v®id©e
(&
h—p
), 
j
 - 
k
,

257 ià(
´ev
 !ğ
NULL
) {

258 
	`as£¹_d_ge
(
	`node_cmp
(
node
,

259 
´ev
), 0,

262 
	`node_»move
(&
h—p
, 
node
);

263 
	`as£¹_u_eq
(
	`h—p_v®id©e
(&
h—p
), 
j
 - 
k


265 
´ev
 = 
node
;

269 
	`nÙ_»ached
();

272 
	`as£¹_±r_nuÎ
(
	`h—p_fœ¡
(&
h—p
),

274 
	`as£¹_Œue
(
	`h—p_em±y
(&
h—p
), "Heap should beƒmpty");

277 
	`fši_g’_¿nd
(
sfmt
);

278 #undeà
NNODES


279 #undeà
SEED


280 
	}
}

281 
TEST_END


284 
	$maš
()

287  (
	`‹¡
(

288 
‹¡_ph_em±y
,

289 
‹¡_ph_¿ndom
));

290 
	}
}

	@dep/jemalloc-4.2.0/test/unit/prng.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_´ng_lg_¿nge
)

5 
ušt64_t
 
§
, 
sb
, 
¿
, 
rb
;

6 
lg_¿nge
;

8 
§
 = 42;

9 
¿
 = 
	`´ng_lg_¿nge
(&
§
, 64);

10 
§
 = 42;

11 
rb
 = 
	`´ng_lg_¿nge
(&
§
, 64);

12 
	`as£¹_u64_eq
(
¿
, 
rb
,

15 
sb
 = 42;

16 
rb
 = 
	`´ng_lg_¿nge
(&
sb
, 64);

17 
	`as£¹_u64_eq
(
¿
, 
rb
,

20 
§
 = 42;

21 
¿
 = 
	`´ng_lg_¿nge
(&
§
, 64);

22 
rb
 = 
	`´ng_lg_¿nge
(&
§
, 64);

23 
	`as£¹_u64_Ã
(
¿
, 
rb
,

26 
§
 = 42;

27 
¿
 = 
	`´ng_lg_¿nge
(&
§
, 64);

28 
lg_¿nge
 = 63;†g_range > 0;†g_range--) {

29 
sb
 = 42;

30 
rb
 = 
	`´ng_lg_¿nge
(&
sb
, 
lg_¿nge
);

31 
	`as£¹_u64_eq
((
rb
 & (
	`UINT64_C
(0xffffffffffffffffè<< 
lg_¿nge
)),

32 0, "High ord” b™ should b0,†g_¿nge=%u", 
lg_¿nge
);

33 
	`as£¹_u64_eq
(
rb
, (
¿
 >> (64 - 
lg_¿nge
)),

35 "lg_¿nge=%u", 
lg_¿nge
);

37 
	}
}

38 
TEST_END


40 
	$TEST_BEGIN
(
‹¡_´ng_¿nge
)

42 
ušt64_t
 
¿nge
;

43 
	#MAX_RANGE
 10000000

	)

44 
	#RANGE_STEP
 97

	)

45 
	#NREPS
 10

	)

47 
¿nge
 = 2;„ªg< 
MAX_RANGE
;„ªg+ğ
RANGE_STEP
) {

48 
ušt64_t
 
s
;

49 
»p
;

51 
s
 = 
¿nge
;

52 
»p
 = 0;„• < 
NREPS
;„ep++) {

53 
ušt64_t
 
r
 = 
	`´ng_¿nge
(&
s
, 
¿nge
);

55 
	`as£¹_u64_É
(
r
, 
¿nge
, "Out of„ange");

58 
	}
}

59 
TEST_END


62 
	$maš
()

65  (
	`‹¡
(

66 
‹¡_´ng_lg_¿nge
,

67 
‹¡_´ng_¿nge
));

68 
	}
}

	@dep/jemalloc-4.2.0/test/unit/prof_accum.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NTHREADS
 4

	)

4 
	#NALLOCS_PER_THREAD
 50

	)

5 
	#DUMP_INTERVAL
 1

	)

6 
	#BT_COUNT_CHECK_INTERVAL
 5

	)

8 #ifdeà
JEMALLOC_PROF


9 cÚ¡ *
	gm®loc_cÚf
 =

14 
	$´of_dump_İ’_š‹rû±
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

16 
fd
;

18 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

19 
	`as£¹_d_Ã
(
fd
, -1, "Unexpected open() failure");

21  (
fd
);

22 
	}
}

25 
	$®loc_äom_³rmu‹d_backŒaû
(
thd_šd
, 
™”©iÚ
)

28  (
	`bÎoc
(1, 
thd_šd
*
NALLOCS_PER_THREAD
 + 
™”©iÚ
));

29 
	}
}

32 
	$thd_¡¬t
(*
v¬g
)

34 
thd_šd
 = *(*)
v¬g
;

35 
size_t
 
bt_couÁ_´ev
, 
bt_couÁ
;

36 
i_´ev
, 
i
;

38 
i_´ev
 = 0;

39 
bt_couÁ_´ev
 = 0;

40 
i
 = 0; i < 
NALLOCS_PER_THREAD
; i++) {

41 *
p
 = 
	`®loc_äom_³rmu‹d_backŒaû
(
thd_šd
, 
i
);

42 
	`d®locx
(
p
, 0);

43 ià(
i
 % 
DUMP_INTERVAL
 == 0) {

44 
	`as£¹_d_eq
(
	`m®lùl
("´of.dump", 
NULL
, NULL, NULL, 0),

48 ià(
i
 % 
BT_COUNT_CHECK_INTERVAL
 == 0 ||

49 
i
+1 =ğ
NALLOCS_PER_THREAD
) {

50 
bt_couÁ
 = 
	`´of_bt_couÁ
();

51 
	`as£¹_zu_Ë
(
bt_couÁ_´ev
+(
i
-
i_´ev
), 
bt_couÁ
,

53 
i_´ev
 = 
i
;

54 
bt_couÁ_´ev
 = 
bt_couÁ
;

58  (
NULL
);

59 
	}
}

61 
	$TEST_BEGIN
(
‹¡_idump
)

63 
boŞ
 
aùive
;

64 
thd_t
 
thds
[
NTHREADS
];

65 
thd_¬gs
[
NTHREADS
];

66 
i
;

68 
	`‹¡_sk_if
(!
cÚfig_´of
);

70 
aùive
 = 
Œue
;

71 
	`as£¹_d_eq
(
	`m®lùl
("´of.aùive", 
NULL
, NULL, &
aùive
, (active)),

74 
´of_dump_İ’
 = 
´of_dump_İ’_š‹rû±
;

76 
i
 = 0; i < 
NTHREADS
; i++) {

77 
thd_¬gs
[
i
] = i;

78 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
, (*)&
thd_¬gs
[i]);

80 
i
 = 0; i < 
NTHREADS
; i++)

81 
	`thd_još
(
thds
[
i
], 
NULL
);

82 
	}
}

83 
TEST_END


86 
	$maš
()

89  (
	`‹¡
(

90 
‹¡_idump
));

91 
	}
}

	@dep/jemalloc-4.2.0/test/unit/prof_active.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 =

9 
	$m®lùl_boŞ_g‘
(cÚ¡ *
Çme
, 
boŞ
 
ex³ùed
, cÚ¡ *
func
, 
lše
)

11 
boŞ
 
Şd
;

12 
size_t
 
sz
;

14 
sz
 = (
Şd
);

15 
	`as£¹_d_eq
(
	`m®lùl
(
Çme
, &
Şd
, &
sz
, 
NULL
, 0), 0,

16 "%s():%d: UÃx³ùed m®lùÈçu»„—dšg %s", 
func
, 
lše
, 
Çme
);

17 
	`as£¹_b_eq
(
Şd
, 
ex³ùed
, "%s():%d: UÃx³ùed % v®ue", 
func
, 
lše
,

18 
Çme
);

19 
	}
}

22 
	$m®lùl_boŞ_£t
(cÚ¡ *
Çme
, 
boŞ
 
Şd_ex³ùed
, boŞ 
v®_Ãw
,

23 cÚ¡ *
func
, 
lše
)

25 
boŞ
 
Şd
;

26 
size_t
 
sz
;

28 
sz
 = (
Şd
);

29 
	`as£¹_d_eq
(
	`m®lùl
(
Çme
, &
Şd
, &
sz
, &
v®_Ãw
, (val_new)), 0,

30 "%s():%d: UÃx³ùed m®lùÈçu»„—dšg/wr™šg %s", 
func
,

31 
lše
, 
Çme
);

32 
	`as£¹_b_eq
(
Şd
, 
Şd_ex³ùed
, "%s():%d: UÃx³ùed % v®ue", 
func
,

33 
lše
, 
Çme
);

34 
	}
}

37 
	$m®lùl_´of_aùive_g‘_im¶
(
boŞ
 
´of_aùive_Şd_ex³ùed
, cÚ¡ *
func
,

38 
lše
)

41 
	`m®lùl_boŞ_g‘
("´of.aùive", 
´of_aùive_Şd_ex³ùed
, 
func
, 
lše
);

42 
	}
}

43 
	#m®lùl_´of_aùive_g‘
(
a
) \

44 
	`m®lùl_´of_aùive_g‘_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

47 
	$m®lùl_´of_aùive_£t_im¶
(
boŞ
 
´of_aùive_Şd_ex³ùed
,

48 
boŞ
 
´of_aùive_Ãw
, cÚ¡ *
func
, 
lše
)

51 
	`m®lùl_boŞ_£t
("´of.aùive", 
´of_aùive_Şd_ex³ùed
,

52 
´of_aùive_Ãw
, 
func
, 
lše
);

53 
	}
}

54 
	#m®lùl_´of_aùive_£t
(
a
, 
b
) \

55 
	`m®lùl_´of_aùive_£t_im¶
(
a
, 
b
, 
__func__
, 
__LINE__
)

	)

58 
	$m®lùl_th»ad_´of_aùive_g‘_im¶
(
boŞ
 
th»ad_´of_aùive_Şd_ex³ùed
,

59 cÚ¡ *
func
, 
lše
)

62 
	`m®lùl_boŞ_g‘
("th»ad.´of.aùive", 
th»ad_´of_aùive_Şd_ex³ùed
,

63 
func
, 
lše
);

64 
	}
}

65 
	#m®lùl_th»ad_´of_aùive_g‘
(
a
) \

66 
	`m®lùl_th»ad_´of_aùive_g‘_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

69 
	$m®lùl_th»ad_´of_aùive_£t_im¶
(
boŞ
 
th»ad_´of_aùive_Şd_ex³ùed
,

70 
boŞ
 
th»ad_´of_aùive_Ãw
, cÚ¡ *
func
, 
lše
)

73 
	`m®lùl_boŞ_£t
("th»ad.´of.aùive", 
th»ad_´of_aùive_Şd_ex³ùed
,

74 
th»ad_´of_aùive_Ãw
, 
func
, 
lše
);

75 
	}
}

76 
	#m®lùl_th»ad_´of_aùive_£t
(
a
, 
b
) \

77 
	`m®lùl_th»ad_´of_aùive_£t_im¶
(
a
, 
b
, 
__func__
, 
__LINE__
)

	)

80 
	$´of_§m¶šg_´obe_im¶
(
boŞ
 
ex³ù_§m¶e
, cÚ¡ *
func
, 
lše
)

82 *
p
;

83 
size_t
 
ex³ùed_backŒaûs
 = 
ex³ù_§m¶e
 ? 1 : 0;

85 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 0, "%s():%d: Ex³ùed 0 backŒaûs", 
func
,

86 
lše
);

87 
p
 = 
	`m®locx
(1, 0);

88 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

89 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 
ex³ùed_backŒaûs
,

90 "%s():%d: UÃx³ùed backŒaû couÁ", 
func
, 
lše
);

91 
	`d®locx
(
p
, 0);

92 
	}
}

93 
	#´of_§m¶šg_´obe
(
a
) \

94 
	`´of_§m¶šg_´obe_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

96 
	$TEST_BEGIN
(
‹¡_´of_aùive
)

99 
	`‹¡_sk_if
(!
cÚfig_´of
);

101 
	`m®lùl_´of_aùive_g‘
(
Œue
);

102 
	`m®lùl_th»ad_´of_aùive_g‘
(
çl£
);

104 
	`m®lùl_´of_aùive_£t
(
Œue
,rue);

105 
	`m®lùl_th»ad_´of_aùive_£t
(
çl£
, false);

107 
	`´of_§m¶šg_´obe
(
çl£
);

109 
	`m®lùl_´of_aùive_£t
(
Œue
, 
çl£
);

110 
	`m®lùl_th»ad_´of_aùive_£t
(
çl£
, false);

112 
	`´of_§m¶šg_´obe
(
çl£
);

114 
	`m®lùl_´of_aùive_£t
(
çl£
, false);

115 
	`m®lùl_th»ad_´of_aùive_£t
(
çl£
, 
Œue
);

117 
	`´of_§m¶šg_´obe
(
çl£
);

119 
	`m®lùl_´of_aùive_£t
(
çl£
, 
Œue
);

120 
	`m®lùl_th»ad_´of_aùive_£t
(
Œue
,rue);

122 
	`´of_§m¶šg_´obe
(
Œue
);

125 
	`m®lùl_´of_aùive_£t
(
Œue
,rue);

126 
	`m®lùl_th»ad_´of_aùive_£t
(
Œue
, 
çl£
);

127 
	}
}

128 
TEST_END


131 
	$maš
()

134  (
	`‹¡
(

135 
‹¡_´of_aùive
));

136 
	}
}

	@dep/jemalloc-4.2.0/test/unit/prof_gdump.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 = "prof:true,prof_active:false,prof_gdump:true";

7 
boŞ
 
	gdid_´of_dump_İ’
;

10 
	$´of_dump_İ’_š‹rû±
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

12 
fd
;

14 
did_´of_dump_İ’
 = 
Œue
;

16 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

17 
	`as£¹_d_Ã
(
fd
, -1, "Unexpected open() failure");

19  (
fd
);

20 
	}
}

22 
	$TEST_BEGIN
(
‹¡_gdump
)

24 
boŞ
 
aùive
, 
gdump
, 
gdump_Şd
;

25 *
p
, *
q
, *
r
, *
s
;

26 
size_t
 
sz
;

28 
	`‹¡_sk_if
(!
cÚfig_´of
);

30 
aùive
 = 
Œue
;

31 
	`as£¹_d_eq
(
	`m®lùl
("´of.aùive", 
NULL
, NULL, &
aùive
, (active)),

34 
´of_dump_İ’
 = 
´of_dump_İ’_š‹rû±
;

36 
did_´of_dump_İ’
 = 
çl£
;

37 
p
 = 
	`m®locx
(
chunksize
, 0);

38 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

39 
	`as£¹_Œue
(
did_´of_dump_İ’
, "Expected‡…rofile dump");

41 
did_´of_dump_İ’
 = 
çl£
;

42 
q
 = 
	`m®locx
(
chunksize
, 0);

43 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected mallocx() failure");

44 
	`as£¹_Œue
(
did_´of_dump_İ’
, "Expected‡…rofile dump");

46 
gdump
 = 
çl£
;

47 
sz
 = (
gdump_Şd
);

48 
	`as£¹_d_eq
(
	`m®lùl
("´of.gdump", &
gdump_Şd
, &
sz
, &
gdump
,

49 (
gdump
)), 0,

51 
	`as£¹
(
gdump_Şd
);

52 
did_´of_dump_İ’
 = 
çl£
;

53 
r
 = 
	`m®locx
(
chunksize
, 0);

54 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected mallocx() failure");

55 
	`as£¹_çl£
(
did_´of_dump_İ’
, "Unexpected…rofile dump");

57 
gdump
 = 
Œue
;

58 
sz
 = (
gdump_Şd
);

59 
	`as£¹_d_eq
(
	`m®lùl
("´of.gdump", &
gdump_Şd
, &
sz
, &
gdump
,

60 (
gdump
)), 0,

62 
	`as£¹
(!
gdump_Şd
);

63 
did_´of_dump_İ’
 = 
çl£
;

64 
s
 = 
	`m®locx
(
chunksize
, 0);

65 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected mallocx() failure");

66 
	`as£¹_Œue
(
did_´of_dump_İ’
, "Expected‡…rofile dump");

68 
	`d®locx
(
p
, 0);

69 
	`d®locx
(
q
, 0);

70 
	`d®locx
(
r
, 0);

71 
	`d®locx
(
s
, 0);

72 
	}
}

73 
TEST_END


76 
	$maš
()

79  (
	`‹¡
(

80 
‹¡_gdump
));

81 
	}
}

	@dep/jemalloc-4.2.0/test/unit/prof_idump.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 =

9 
boŞ
 
	gdid_´of_dump_İ’
;

12 
	$´of_dump_İ’_š‹rû±
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

14 
fd
;

16 
did_´of_dump_İ’
 = 
Œue
;

18 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

19 
	`as£¹_d_Ã
(
fd
, -1, "Unexpected open() failure");

21  (
fd
);

22 
	}
}

24 
	$TEST_BEGIN
(
‹¡_idump
)

26 
boŞ
 
aùive
;

27 *
p
;

29 
	`‹¡_sk_if
(!
cÚfig_´of
);

31 
aùive
 = 
Œue
;

32 
	`as£¹_d_eq
(
	`m®lùl
("´of.aùive", 
NULL
, NULL, &
aùive
, (active)),

35 
´of_dump_İ’
 = 
´of_dump_İ’_š‹rû±
;

37 
did_´of_dump_İ’
 = 
çl£
;

38 
p
 = 
	`m®locx
(1, 0);

39 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

40 
	`d®locx
(
p
, 0);

41 
	`as£¹_Œue
(
did_´of_dump_İ’
, "Expected‡…rofile dump");

42 
	}
}

43 
TEST_END


46 
	$maš
()

49  (
	`‹¡
(

50 
‹¡_idump
));

51 
	}
}

	@dep/jemalloc-4.2.0/test/unit/prof_reset.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 =

9 
	$´of_dump_İ’_š‹rû±
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

11 
fd
;

13 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

14 
	`as£¹_d_Ã
(
fd
, -1, "Unexpected open() failure");

16  (
fd
);

17 
	}
}

20 
	$£t_´of_aùive
(
boŞ
 
aùive
)

23 
	`as£¹_d_eq
(
	`m®lùl
("´of.aùive", 
NULL
, NULL, &
aùive
, (active)),

25 
	}
}

27 
size_t


28 
	$g‘_lg_´of_§m¶e
()

30 
size_t
 
lg_´of_§m¶e
;

31 
size_t
 
sz
 = (size_t);

33 
	`as£¹_d_eq
(
	`m®lùl
("´of.lg_§m¶e", &
lg_´of_§m¶e
, &
sz
, 
NULL
, 0), 0,

35  (
lg_´of_§m¶e
);

36 
	}
}

39 
	$do_´of_»£t
(
size_t
 
lg_´of_§m¶e
)

41 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL,

42 &
lg_´of_§m¶e
, (
size_t
)), 0,

44 
	`as£¹_zu_eq
(
lg_´of_§m¶e
, 
	`g‘_lg_´of_§m¶e
(),

46 
	}
}

48 
	$TEST_BEGIN
(
‹¡_´of_»£t_basic
)

50 
size_t
 
lg_´of_§m¶e_Üig
, 
lg_´of_§m¶e
, 
lg_´of_§m¶e_Ãxt
;

51 
size_t
 
sz
;

52 
i
;

54 
	`‹¡_sk_if
(!
cÚfig_´of
);

56 
sz
 = (
size_t
);

57 
	`as£¹_d_eq
(
	`m®lùl
("İt.lg_´of_§m¶e", &
lg_´of_§m¶e_Üig
, &
sz
,

58 
NULL
, 0), 0,

60 
	`as£¹_zu_eq
(
lg_´of_§m¶e_Üig
, 0,

62 
lg_´of_§m¶e
 = 
	`g‘_lg_´of_§m¶e
();

63 
	`as£¹_zu_eq
(
lg_´of_§m¶e_Üig
, 
lg_´of_§m¶e
,

68 
i
 = 0; i < 2; i++) {

69 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL, NULL, 0), 0,

71 
lg_´of_§m¶e
 = 
	`g‘_lg_´of_§m¶e
();

72 
	`as£¹_zu_eq
(
lg_´of_§m¶e_Üig
, 
lg_´of_§m¶e
,

77 
lg_´of_§m¶e_Ãxt
 = 1;

78 
i
 = 0; i < 2; i++) {

79 
	`do_´of_»£t
(
lg_´of_§m¶e_Ãxt
);

80 
lg_´of_§m¶e
 = 
	`g‘_lg_´of_§m¶e
();

81 
	`as£¹_zu_eq
(
lg_´of_§m¶e
, 
lg_´of_§m¶e_Ãxt
,

83 
lg_´of_§m¶e_Ãxt
 = 
lg_´of_§m¶e_Üig
;

87 
lg_´of_§m¶e
 = 
	`g‘_lg_´of_§m¶e
();

88 
	`as£¹_zu_eq
(
lg_´of_§m¶e_Üig
, 
lg_´of_§m¶e
,

91 
	}
}

92 
TEST_END


94 
boŞ
 
	g´of_dump_h—d”_š‹rû±ed
 = 
çl£
;

95 
´of_út_t
 
	gút_®l_cİy
 = {0, 0, 0, 0};

96 
boŞ


97 
	$´of_dump_h—d”_š‹rû±
(
tsdn_t
 *
tsdn
, 
boŞ
 
´İag©e_”r
,

98 cÚ¡ 
´of_út_t
 *
út_®l
)

101 
´of_dump_h—d”_š‹rû±ed
 = 
Œue
;

102 
	`memıy
(&
út_®l_cİy
, 
út_®l
, (
´of_út_t
));

104  (
çl£
);

105 
	}
}

107 
	$TEST_BEGIN
(
‹¡_´of_»£t_ş—nup
)

109 *
p
;

110 
´of_dump_h—d”_t
 *
´of_dump_h—d”_Üig
;

112 
	`‹¡_sk_if
(!
cÚfig_´of
);

114 
	`£t_´of_aùive
(
Œue
);

116 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 0, "Expected 0 backtraces");

117 
p
 = 
	`m®locx
(1, 0);

118 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

119 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 1, "Expected 1 backtrace");

121 
´of_dump_h—d”_Üig
 = 
´of_dump_h—d”
;

122 
´of_dump_h—d”
 = 
´of_dump_h—d”_š‹rû±
;

123 
	`as£¹_çl£
(
´of_dump_h—d”_š‹rû±ed
, "Unexpected intercept");

125 
	`as£¹_d_eq
(
	`m®lùl
("´of.dump", 
NULL
, NULL, NULL, 0),

127 
	`as£¹_Œue
(
´of_dump_h—d”_š‹rû±ed
, "Expected intercept");

128 
	`as£¹_u64_eq
(
út_®l_cİy
.
curobjs
, 1, "Expected 1‡llocation");

130 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL, NULL, 0), 0,

132 
	`as£¹_d_eq
(
	`m®lùl
("´of.dump", 
NULL
, NULL, NULL, 0),

134 
	`as£¹_u64_eq
(
út_®l_cİy
.
curobjs
, 0, "Expected 0‡llocations");

135 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 1, "Expected 1 backtrace");

137 
´of_dump_h—d”
 = 
´of_dump_h—d”_Üig
;

139 
	`d®locx
(
p
, 0);

140 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 0, "Expected 0 backtraces");

142 
	`£t_´of_aùive
(
çl£
);

143 
	}
}

144 
	gTEST_END


146 
	#NTHREADS
 4

	)

147 
	#NALLOCS_PER_THREAD
 (1U << 13)

	)

148 
	#OBJ_RING_BUF_COUNT
 1531

	)

149 
	#RESET_INTERVAL
 (1U << 10)

	)

150 
	#DUMP_INTERVAL
 3677

	)

152 
	$thd_¡¬t
(*
v¬g
)

154 
thd_šd
 = *(*)
v¬g
;

155 
i
;

156 *
objs
[
OBJ_RING_BUF_COUNT
];

158 
	`mem£t
(
objs
, 0, (objs));

160 
i
 = 0; i < 
NALLOCS_PER_THREAD
; i++) {

161 ià(
i
 % 
RESET_INTERVAL
 == 0) {

162 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL, NULL, 0),

167 ià(
i
 % 
DUMP_INTERVAL
 == 0) {

168 
	`as£¹_d_eq
(
	`m®lùl
("´of.dump", 
NULL
, NULL, NULL, 0),

173 **
µ
 = &
objs
[
i
 % 
OBJ_RING_BUF_COUNT
];

174 ià(*
µ
 !ğ
NULL
) {

175 
	`d®locx
(*
µ
, 0);

176 *
µ
 = 
NULL
;

178 *
µ
 = 
	`bÎoc
(1, 
thd_šd
*
NALLOCS_PER_THREAD
 + 
i
);

179 
	`as£¹_±r_nÙ_nuÎ
(*
µ
,

185 
i
 = 0; i < 
OBJ_RING_BUF_COUNT
; i++) {

186 **
µ
 = &
objs
[
i
 % 
OBJ_RING_BUF_COUNT
];

187 ià(*
µ
 !ğ
NULL
) {

188 
	`d®locx
(*
µ
, 0);

189 *
µ
 = 
NULL
;

193  (
NULL
);

194 
	}
}

196 
	$TEST_BEGIN
(
‹¡_´of_»£t
)

198 
size_t
 
lg_´of_§m¶e_Üig
;

199 
thd_t
 
thds
[
NTHREADS
];

200 
thd_¬gs
[
NTHREADS
];

201 
i
;

202 
size_t
 
bt_couÁ
, 
td©a_couÁ
;

204 
	`‹¡_sk_if
(!
cÚfig_´of
);

206 
bt_couÁ
 = 
	`´of_bt_couÁ
();

207 
	`as£¹_zu_eq
(
bt_couÁ
, 0,

209 
td©a_couÁ
 = 
	`´of_td©a_couÁ
();

211 
lg_´of_§m¶e_Üig
 = 
	`g‘_lg_´of_§m¶e
();

212 
	`do_´of_»£t
(5);

214 
	`£t_´of_aùive
(
Œue
);

216 
i
 = 0; i < 
NTHREADS
; i++) {

217 
thd_¬gs
[
i
] = i;

218 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
, (*)&
thd_¬gs
[i]);

220 
i
 = 0; i < 
NTHREADS
; i++)

221 
	`thd_još
(
thds
[
i
], 
NULL
);

223 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 
bt_couÁ
,

225 
	`as£¹_zu_eq
(
	`´of_td©a_couÁ
(), 
td©a_couÁ
,

228 
	`£t_´of_aùive
(
çl£
);

230 
	`do_´of_»£t
(
lg_´of_§m¶e_Üig
);

231 
	}
}

232 
	gTEST_END


233 #undeà
NTHREADS


234 #undeà
NALLOCS_PER_THREAD


235 #undeà
OBJ_RING_BUF_COUNT


236 #undeà
RESET_INTERVAL


237 #undeà
DUMP_INTERVAL


240 
	#NITER
 10

	)

241 
	$TEST_BEGIN
(
‹¡_x®locx
)

243 
size_t
 
lg_´of_§m¶e_Üig
;

244 
i
;

245 *
±rs
[
NITER
];

247 
	`‹¡_sk_if
(!
cÚfig_´of
);

249 
lg_´of_§m¶e_Üig
 = 
	`g‘_lg_´of_§m¶e
();

250 
	`£t_´of_aùive
(
Œue
);

253 
	`do_´of_»£t
(0);

255 
i
 = 0; i < 
NITER
; i++) {

256 *
p
;

257 
size_t
 
sz
, 
nsz
;

260 
	`do_´of_»£t
(0);

263 
p
 = 
±rs
[
i
] = 
	`m®locx
(1, 0);

264 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

267 
	`do_´of_»£t
(0);

270 
sz
 = 
	`§Îocx
(
p
, 0);

271 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sz
, 0, 0), sz,

275 
nsz
 = 
	`ÇÎocx
(
sz
+1, 0);

276 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
nsz
, 0, 0), 
sz
,

280 
i
 = 0; i < 
NITER
; i++) {

282 
	`d®locx
(
±rs
[
i
], 0);

285 
	`£t_´of_aùive
(
çl£
);

286 
	`do_´of_»£t
(
lg_´of_§m¶e_Üig
);

287 
	}
}

288 
	gTEST_END


289 #undeà
NITER


292 
	$maš
()

296 
´of_dump_İ’
 = 
´of_dump_İ’_š‹rû±
;

298  (
	`‹¡
(

299 
‹¡_´of_»£t_basic
,

300 
‹¡_´of_»£t_ş—nup
,

301 
‹¡_´of_»£t
,

302 
‹¡_x®locx
));

303 
	}
}

	@dep/jemalloc-4.2.0/test/unit/prof_thread_name.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 = "prof:true,prof_active:false";

8 
	$m®lùl_th»ad_Çme_g‘_im¶
(cÚ¡ *
th»ad_Çme_ex³ùed
, cÚ¡ *
func
,

9 
lše
)

11 cÚ¡ *
th»ad_Çme_Şd
;

12 
size_t
 
sz
;

14 
sz
 = (
th»ad_Çme_Şd
);

15 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", &
th»ad_Çme_Şd
, &
sz
, 
NULL
, 0),

17 
func
, 
lše
);

18 
	`as£¹_¡r_eq
(
th»ad_Çme_Şd
, 
th»ad_Çme_ex³ùed
,

19 "%s():%d: UÃx³ùedh»ad.´of.Çmv®ue", 
func
, 
lše
);

20 
	}
}

21 
	#m®lùl_th»ad_Çme_g‘
(
a
) \

22 
	`m®lùl_th»ad_Çme_g‘_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

25 
	$m®lùl_th»ad_Çme_£t_im¶
(cÚ¡ *
th»ad_Çme
, cÚ¡ *
func
,

26 
lše
)

29 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", 
NULL
, NULL, &
th»ad_Çme
,

30 (
th»ad_Çme
)), 0,

32 
func
, 
lše
);

33 
	`m®lùl_th»ad_Çme_g‘_im¶
(
th»ad_Çme
, 
func
, 
lše
);

34 
	}
}

35 
	#m®lùl_th»ad_Çme_£t
(
a
) \

36 
	`m®lùl_th»ad_Çme_£t_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

38 
	$TEST_BEGIN
(
‹¡_´of_th»ad_Çme_v®id©iÚ
)

40 cÚ¡ *
th»ad_Çme
;

42 
	`‹¡_sk_if
(!
cÚfig_´of
);

44 
	`m®lùl_th»ad_Çme_g‘
("");

45 
	`m®lùl_th»ad_Çme_£t
("hihere");

48 
th»ad_Çme
 = 
NULL
;

49 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", 
NULL
, NULL, &
th»ad_Çme
,

50 (
th»ad_Çme
)), 
EFAULT
,

52 
th»ad_Çme
);

55 
th»ad_Çme
 = "hi\nthere";

56 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", 
NULL
, NULL, &
th»ad_Çme
,

57 (
th»ad_Çme
)), 
EFAULT
,

59 
th»ad_Çme
);

63 cÚ¡ *
th»ad_Çme_Şd
;

64 
size_t
 
sz
;

66 
sz
 = (
th»ad_Çme_Şd
);

67 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", &
th»ad_Çme_Şd
, &
sz
,

68 &
th»ad_Çme
, Ñh»ad_Çme)), 
EPERM
,

70 "th»ad.´of.Çme", 
th»ad_Çme
);

73 
	`m®lùl_th»ad_Çme_£t
("");

74 
	}
}

75 
	gTEST_END


77 
	#NTHREADS
 4

	)

78 
	#NRESET
 25

	)

80 
	$thd_¡¬t
(*
v¬g
)

82 
thd_šd
 = *(*)
v¬g
;

83 
th»ad_Çme
[16] = "";

84 
i
;

86 
	`m®loc_¢´štf
(
th»ad_Çme
, Ñh»ad_Çme), "th»ad %u", 
thd_šd
);

88 
	`m®lùl_th»ad_Çme_g‘
("");

89 
	`m®lùl_th»ad_Çme_£t
(
th»ad_Çme
);

91 
i
 = 0; i < 
NRESET
; i++) {

92 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL, NULL, 0), 0,

94 
	`m®lùl_th»ad_Çme_g‘
(
th»ad_Çme
);

97 
	`m®lùl_th»ad_Çme_£t
(
th»ad_Çme
);

98 
	`m®lùl_th»ad_Çme_£t
("");

100  (
NULL
);

101 
	}
}

103 
	$TEST_BEGIN
(
‹¡_´of_th»ad_Çme_th»aded
)

105 
thd_t
 
thds
[
NTHREADS
];

106 
thd_¬gs
[
NTHREADS
];

107 
i
;

109 
	`‹¡_sk_if
(!
cÚfig_´of
);

111 
i
 = 0; i < 
NTHREADS
; i++) {

112 
thd_¬gs
[
i
] = i;

113 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
, (*)&
thd_¬gs
[i]);

115 
i
 = 0; i < 
NTHREADS
; i++)

116 
	`thd_još
(
thds
[
i
], 
NULL
);

117 
	}
}

118 
	gTEST_END


119 #undeà
NTHREADS


120 #undeà
NRESET


123 
	$maš
()

126  (
	`‹¡
(

127 
‹¡_´of_th»ad_Çme_v®id©iÚ
,

128 
‹¡_´of_th»ad_Çme_th»aded
));

129 
	}
}

	@dep/jemalloc-4.2.0/test/unit/ql.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	#NENTRIES
 9

	)

6 
li¡_s
 
	tli¡_t
;

7 
	$ql_h—d
(
	tli¡_t
è
	tli¡_h—d_t
;

9 
	sli¡_s
 {

10 
	`ql_–m
(
li¡_t
è
lšk
;

11 
id
;

15 
	$‹¡_em±y_li¡
(
li¡_h—d_t
 *
h—d
)

17 
li¡_t
 *
t
;

18 
i
;

20 
	`as£¹_±r_nuÎ
(
	`ql_fœ¡
(
h—d
), "Unexpectedƒlement forƒmpty†ist");

21 
	`as£¹_±r_nuÎ
(
	`ql_Ï¡
(
h—d
, 
lšk
),

24 
i
 = 0;

25 
	`ql_fÜ—ch
(
t
, 
h—d
, 
lšk
) {

26 
i
++;

28 
	`as£¹_u_eq
(
i
, 0, "Unexpectedƒlement forƒmpty†ist");

30 
i
 = 0;

31 
	`ql_»v”£_fÜ—ch
(
t
, 
h—d
, 
lšk
) {

32 
i
++;

34 
	`as£¹_u_eq
(
i
, 0, "Unexpectedƒlement forƒmpty†ist");

35 
	}
}

37 
	$TEST_BEGIN
(
‹¡_ql_em±y
)

39 
li¡_h—d_t
 
h—d
;

41 
	`ql_Ãw
(&
h—d
);

42 
	`‹¡_em±y_li¡
(&
h—d
);

43 
	}
}

44 
TEST_END


47 
	$š™_’Œ›s
(
li¡_t
 *
’Œ›s
, 
ÃÁr›s
)

49 
i
;

51 
i
 = 0; i < 
ÃÁr›s
; i++) {

52 
’Œ›s
[
i
].
id
 = 'a' + i;

53 
	`ql_–m_Ãw
(&
’Œ›s
[
i
], 
lšk
);

55 
	}
}

58 
	$‹¡_’Œ›s_li¡
(
li¡_h—d_t
 *
h—d
, 
li¡_t
 *
’Œ›s
, 
ÃÁr›s
)

60 
li¡_t
 *
t
;

61 
i
;

63 
	`as£¹_c_eq
(
	`ql_fœ¡
(
h—d
)->
id
, 
’Œ›s
[0].id, "Element id mismatch");

64 
	`as£¹_c_eq
(
	`ql_Ï¡
(
h—d
, 
lšk
)->
id
, 
’Œ›s
[
ÃÁr›s
-1].id,

67 
i
 = 0;

68 
	`ql_fÜ—ch
(
t
, 
h—d
, 
lšk
) {

69 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
i
].id, "Element id mismatch");

70 
i
++;

73 
i
 = 0;

74 
	`ql_»v”£_fÜ—ch
(
t
, 
h—d
, 
lšk
) {

75 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
ÃÁr›s
-
i
-1].id,

77 
i
++;

80 
i
 = 0; i < 
ÃÁr›s
-1; i++) {

81 
t
 = 
	`ql_Ãxt
(
h—d
, &
’Œ›s
[
i
], 
lšk
);

82 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
i
+1].id, "Element id mismatch");

84 
	`as£¹_±r_nuÎ
(
	`ql_Ãxt
(
h—d
, &
’Œ›s
[
ÃÁr›s
-1], 
lšk
),

87 
	`as£¹_±r_nuÎ
(
	`ql_´ev
(
h—d
, &
’Œ›s
[0], 
lšk
), "Unexpectedƒlement");

88 
i
 = 1; i < 
ÃÁr›s
; i++) {

89 
t
 = 
	`ql_´ev
(
h—d
, &
’Œ›s
[
i
], 
lšk
);

90 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
i
-1].id, "Element id mismatch");

92 
	}
}

94 
	$TEST_BEGIN
(
‹¡_ql__š£¹
)

96 
li¡_h—d_t
 
h—d
;

97 
li¡_t
 
’Œ›s
[
NENTRIES
];

98 
i
;

100 
	`ql_Ãw
(&
h—d
);

101 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

102 
i
 = 0; i < 
NENTRIES
; i++)

103 
	`ql__š£¹
(&
h—d
, &
’Œ›s
[
i
], 
lšk
);

105 
	`‹¡_’Œ›s_li¡
(&
h—d
, 
’Œ›s
, 
NENTRIES
);

106 
	}
}

107 
TEST_END


109 
	$TEST_BEGIN
(
‹¡_ql__»move
)

111 
li¡_h—d_t
 
h—d
;

112 
li¡_t
 
’Œ›s
[
NENTRIES
];

113 
i
;

115 
	`ql_Ãw
(&
h—d
);

116 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

117 
i
 = 0; i < 
NENTRIES
; i++)

118 
	`ql__š£¹
(&
h—d
, &
’Œ›s
[
i
], 
lšk
);

120 
i
 = 0; i < 
NENTRIES
; i++) {

121 
	`‹¡_’Œ›s_li¡
(&
h—d
, 
’Œ›s
, 
NENTRIES
-
i
);

122 
	`ql__»move
(&
h—d
, 
li¡_t
, 
lšk
);

124 
	`‹¡_em±y_li¡
(&
h—d
);

125 
	}
}

126 
TEST_END


128 
	$TEST_BEGIN
(
‹¡_ql_h—d_š£¹
)

130 
li¡_h—d_t
 
h—d
;

131 
li¡_t
 
’Œ›s
[
NENTRIES
];

132 
i
;

134 
	`ql_Ãw
(&
h—d
);

135 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

136 
i
 = 0; i < 
NENTRIES
; i++)

137 
	`ql_h—d_š£¹
(&
h—d
, &
’Œ›s
[
NENTRIES
-
i
-1], 
lšk
);

139 
	`‹¡_’Œ›s_li¡
(&
h—d
, 
’Œ›s
, 
NENTRIES
);

140 
	}
}

141 
TEST_END


143 
	$TEST_BEGIN
(
‹¡_ql_h—d_»move
)

145 
li¡_h—d_t
 
h—d
;

146 
li¡_t
 
’Œ›s
[
NENTRIES
];

147 
i
;

149 
	`ql_Ãw
(&
h—d
);

150 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

151 
i
 = 0; i < 
NENTRIES
; i++)

152 
	`ql_h—d_š£¹
(&
h—d
, &
’Œ›s
[
NENTRIES
-
i
-1], 
lšk
);

154 
i
 = 0; i < 
NENTRIES
; i++) {

155 
	`‹¡_’Œ›s_li¡
(&
h—d
, &
’Œ›s
[
i
], 
NENTRIES
-i);

156 
	`ql_h—d_»move
(&
h—d
, 
li¡_t
, 
lšk
);

158 
	`‹¡_em±y_li¡
(&
h—d
);

159 
	}
}

160 
TEST_END


162 
	$TEST_BEGIN
(
‹¡_ql_š£¹
)

164 
li¡_h—d_t
 
h—d
;

165 
li¡_t
 
’Œ›s
[8];

166 
li¡_t
 *
a
, *
b
, *
c
, *
d
, *
e
, *
f
, *
g
, *
h
;

168 
	`ql_Ãw
(&
h—d
);

169 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

170 
a
 = &
’Œ›s
[0];

171 
b
 = &
’Œ›s
[1];

172 
c
 = &
’Œ›s
[2];

173 
d
 = &
’Œ›s
[3];

174 
e
 = &
’Œ›s
[4];

175 
f
 = &
’Œ›s
[5];

176 
g
 = &
’Œ›s
[6];

177 
h
 = &
’Œ›s
[7];

185 
	`ql__š£¹
(&
h—d
, 
f
, 
lšk
);

186 
	`ql_befÜe_š£¹
(&
h—d
, 
f
, 
b
, 
lšk
);

187 
	`ql_befÜe_š£¹
(&
h—d
, 
f
, 
c
, 
lšk
);

188 
	`ql_aá”_š£¹
(
f
, 
h
, 
lšk
);

189 
	`ql_aá”_š£¹
(
f
, 
g
, 
lšk
);

190 
	`ql_befÜe_š£¹
(&
h—d
, 
b
, 
a
, 
lšk
);

191 
	`ql_aá”_š£¹
(
c
, 
d
, 
lšk
);

192 
	`ql_befÜe_š£¹
(&
h—d
, 
f
, 
e
, 
lšk
);

194 
	`‹¡_’Œ›s_li¡
(&
h—d
, 
’Œ›s
, ÓÁr›s)/(
li¡_t
));

195 
	}
}

196 
TEST_END


199 
	$maš
()

202  (
	`‹¡
(

203 
‹¡_ql_em±y
,

204 
‹¡_ql__š£¹
,

205 
‹¡_ql__»move
,

206 
‹¡_ql_h—d_š£¹
,

207 
‹¡_ql_h—d_»move
,

208 
‹¡_ql_š£¹
));

209 
	}
}

	@dep/jemalloc-4.2.0/test/unit/qr.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	#NENTRIES
 9

	)

6 
	#SPLIT_INDEX
 5

	)

8 
ršg_s
 
	tršg_t
;

10 
	sršg_s
 {

11 
qr
(
ršg_t
è
	mlšk
;

12 
	mid
;

16 
	$š™_’Œ›s
(
ršg_t
 *
’Œ›s
)

18 
i
;

20 
i
 = 0; i < 
NENTRIES
; i++) {

21 
	`qr_Ãw
(&
’Œ›s
[
i
], 
lšk
);

22 
’Œ›s
[
i
].
id
 = 'a' + i;

24 
	}
}

27 
	$‹¡_šd•’d’t_’Œ›s
(
ršg_t
 *
’Œ›s
)

29 
ršg_t
 *
t
;

30 
i
, 
j
;

32 
i
 = 0; i < 
NENTRIES
; i++) {

33 
j
 = 0;

34 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

35 
j
++;

37 
	`as£¹_u_eq
(
j
, 1,

41 
i
 = 0; i < 
NENTRIES
; i++) {

42 
j
 = 0;

43 
	`qr_»v”£_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

44 
j
++;

46 
	`as£¹_u_eq
(
j
, 1,

50 
i
 = 0; i < 
NENTRIES
; i++) {

51 
t
 = 
	`qr_Ãxt
(&
’Œ›s
[
i
], 
lšk
);

52 
	`as£¹_±r_eq
(
t
, &
’Œ›s
[
i
],

56 
i
 = 0; i < 
NENTRIES
; i++) {

57 
t
 = 
	`qr_´ev
(&
’Œ›s
[
i
], 
lšk
);

58 
	`as£¹_±r_eq
(
t
, &
’Œ›s
[
i
],

62 
	}
}

64 
	$TEST_BEGIN
(
‹¡_qr_Úe
)

66 
ršg_t
 
’Œ›s
[
NENTRIES
];

68 
	`š™_’Œ›s
(
’Œ›s
);

69 
	`‹¡_šd•’d’t_’Œ›s
(
’Œ›s
);

70 
	}
}

71 
TEST_END


74 
	$‹¡_’Œ›s_ršg
(
ršg_t
 *
’Œ›s
)

76 
ršg_t
 *
t
;

77 
i
, 
j
;

79 
i
 = 0; i < 
NENTRIES
; i++) {

80 
j
 = 0;

81 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

82 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+
j
è% 
NENTRIES
].id,

84 
j
++;

87 
i
 = 0; i < 
NENTRIES
; i++) {

88 
j
 = 0;

89 
	`qr_»v”£_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

90 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
NENTRIES
+
i
-
j
-1) %

91 
NENTRIES
].
id
, "Element id mismatch");

92 
j
++;

95 
i
 = 0; i < 
NENTRIES
; i++) {

96 
t
 = 
	`qr_Ãxt
(&
’Œ›s
[
i
], 
lšk
);

97 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+1è% 
NENTRIES
].id,

100 
i
 = 0; i < 
NENTRIES
; i++) {

101 
t
 = 
	`qr_´ev
(&
’Œ›s
[
i
], 
lšk
);

102 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
NENTRIES
+
i
-1) % NENTRIES].id,

105 
	}
}

107 
	$TEST_BEGIN
(
‹¡_qr_aá”_š£¹
)

109 
ršg_t
 
’Œ›s
[
NENTRIES
];

110 
i
;

112 
	`š™_’Œ›s
(
’Œ›s
);

113 
i
 = 1; i < 
NENTRIES
; i++)

114 
	`qr_aá”_š£¹
(&
’Œ›s
[
i
 - 1], &’Œ›s[i], 
lšk
);

115 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

116 
	}
}

117 
TEST_END


119 
	$TEST_BEGIN
(
‹¡_qr_»move
)

121 
ršg_t
 
’Œ›s
[
NENTRIES
];

122 
ršg_t
 *
t
;

123 
i
, 
j
;

125 
	`š™_’Œ›s
(
’Œ›s
);

126 
i
 = 1; i < 
NENTRIES
; i++)

127 
	`qr_aá”_š£¹
(&
’Œ›s
[
i
 - 1], &’Œ›s[i], 
lšk
);

129 
i
 = 0; i < 
NENTRIES
; i++) {

130 
j
 = 0;

131 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

132 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
i
+
j
].id,

134 
j
++;

136 
j
 = 0;

137 
	`qr_»v”£_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

138 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
NENTRIES
 - 1 - 
j
].id,

140 
j
++;

142 
	`qr_»move
(&
’Œ›s
[
i
], 
lšk
);

144 
	`‹¡_šd•’d’t_’Œ›s
(
’Œ›s
);

145 
	}
}

146 
TEST_END


148 
	$TEST_BEGIN
(
‹¡_qr_befÜe_š£¹
)

150 
ršg_t
 
’Œ›s
[
NENTRIES
];

151 
ršg_t
 *
t
;

152 
i
, 
j
;

154 
	`š™_’Œ›s
(
’Œ›s
);

155 
i
 = 1; i < 
NENTRIES
; i++)

156 
	`qr_befÜe_š£¹
(&
’Œ›s
[
i
 - 1], &’Œ›s[i], 
lšk
);

157 
i
 = 0; i < 
NENTRIES
; i++) {

158 
j
 = 0;

159 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

160 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
NENTRIES
+
i
-
j
) %

161 
NENTRIES
].
id
, "Element id mismatch");

162 
j
++;

165 
i
 = 0; i < 
NENTRIES
; i++) {

166 
j
 = 0;

167 
	`qr_»v”£_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

168 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+
j
+1è% 
NENTRIES
].id,

170 
j
++;

173 
i
 = 0; i < 
NENTRIES
; i++) {

174 
t
 = 
	`qr_Ãxt
(&
’Œ›s
[
i
], 
lšk
);

175 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
NENTRIES
+
i
-1) % NENTRIES].id,

178 
i
 = 0; i < 
NENTRIES
; i++) {

179 
t
 = 
	`qr_´ev
(&
’Œ›s
[
i
], 
lšk
);

180 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+1è% 
NENTRIES
].id,

183 
	}
}

184 
TEST_END


187 
	$‹¡_¥l™_’Œ›s
(
ršg_t
 *
’Œ›s
)

189 
ršg_t
 *
t
;

190 
i
, 
j
;

192 
i
 = 0; i < 
NENTRIES
; i++) {

193 
j
 = 0;

194 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

195 ià(
i
 < 
SPLIT_INDEX
) {

196 
	`as£¹_c_eq
(
t
->
id
,

197 
’Œ›s
[(
i
+
j
è% 
SPLIT_INDEX
].
id
,

200 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+
j
-
SPLIT_INDEX
) %

201 (
NENTRIES
-
SPLIT_INDEX
è+ SPLIT_INDEX].
id
,

204 
j
++;

207 
	}
}

209 
	$TEST_BEGIN
(
‹¡_qr_m–d_¥l™
)

211 
ršg_t
 
’Œ›s
[
NENTRIES
];

212 
i
;

214 
	`š™_’Œ›s
(
’Œ›s
);

215 
i
 = 1; i < 
NENTRIES
; i++)

216 
	`qr_aá”_š£¹
(&
’Œ›s
[
i
 - 1], &’Œ›s[i], 
lšk
);

218 
	`qr_¥l™
(&
’Œ›s
[0], &’Œ›s[
SPLIT_INDEX
], 
lšk
);

219 
	`‹¡_¥l™_’Œ›s
(
’Œ›s
);

221 
	`qr_m–d
(&
’Œ›s
[0], &’Œ›s[
SPLIT_INDEX
], 
lšk
);

222 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

224 
	`qr_m–d
(&
’Œ›s
[0], &’Œ›s[
SPLIT_INDEX
], 
lšk
);

225 
	`‹¡_¥l™_’Œ›s
(
’Œ›s
);

227 
	`qr_¥l™
(&
’Œ›s
[0], &’Œ›s[
SPLIT_INDEX
], 
lšk
);

228 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

230 
	`qr_¥l™
(&
’Œ›s
[0], &’Œ›s[0], 
lšk
);

231 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

233 
	`qr_m–d
(&
’Œ›s
[0], &’Œ›s[0], 
lšk
);

234 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

235 
	}
}

236 
TEST_END


239 
	$maš
()

242  (
	`‹¡
(

243 
‹¡_qr_Úe
,

244 
‹¡_qr_aá”_š£¹
,

245 
‹¡_qr_»move
,

246 
‹¡_qr_befÜe_š£¹
,

247 
‹¡_qr_m–d_¥l™
));

248 
	}
}

	@dep/jemalloc-4.2.0/test/unit/quarantine.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#QUARANTINE_SIZE
 8192

	)

4 
	#STRINGIFY_HELPER
(
x
è#x

	)

5 
	#STRINGIFY
(
x
è
	`STRINGIFY_HELPER
(x)

	)

7 #ifdeà
JEMALLOC_FILL


8 cÚ¡ *
	gm®loc_cÚf
 = "abort:false,junk:true,redzone:true,quarantine:"

9 
STRINGIFY
(
QUARANTINE_SIZE
);

13 
	$qu¬ªtše_ş—r
()

15 *
p
;

17 
p
 = 
	`m®locx
(
QUARANTINE_SIZE
*2, 0);

18 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

19 
	`d®locx
(
p
, 0);

20 
	}
}

22 
	$TEST_BEGIN
(
‹¡_qu¬ªtše
)

24 
	#SZ
 
	`ZU
(256)

	)

25 
	#NQUARANTINED
 (
QUARANTINE_SIZE
/
SZ
)

	)

26 *
qu¬ªtšed
[
NQUARANTINED
+1];

27 
size_t
 
i
, 
j
;

29 
	`‹¡_sk_if
(!
cÚfig_fl
);

31 
	`as£¹_zu_eq
(
	`ÇÎocx
(
SZ
, 0), SZ,

32 "SZ=%zu dÛ nÙ…»ci£lyƒqu®‡ sizşass", 
SZ
);

34 
	`qu¬ªtše_ş—r
();

43 
i
 = 0; i < 
NQUARANTINED
+1; i++) {

44 *
p
 = 
	`m®locx
(
SZ
, 0);

45 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

46 
qu¬ªtšed
[
i
] = 
p
;

47 
	`d®locx
(
p
, 0);

48 
j
 = 0; j < 
i
; j++) {

49 
	`as£¹_±r_Ã
(
p
, 
qu¬ªtšed
[
j
],

51 "i=%zu, j=%zu", 
i
, 
j
);

54 #undeà
NQUARANTINED


55 #undeà
SZ


56 
	}
}

57 
TEST_END


59 
boŞ
 
	gd‘eùed_»dzÚe_cÜru±iÚ
;

62 
	$¬’a_»dzÚe_cÜru±iÚ_»¶aûm’t
(*
±r
, 
size_t
 
usize
, 
boŞ
 
aá”
,

63 
size_t
 
off£t
, 
ušt8_t
 
by‹
)

66 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
Œue
;

67 
	}
}

69 
	$TEST_BEGIN
(
‹¡_qu¬ªtše_»dzÚe
)

71 *
s
;

72 
¬’a_»dzÚe_cÜru±iÚ_t
 *
¬’a_»dzÚe_cÜru±iÚ_Üig
;

74 
	`‹¡_sk_if
(!
cÚfig_fl
);

76 
¬’a_»dzÚe_cÜru±iÚ_Üig
 = 
¬’a_»dzÚe_cÜru±iÚ
;

77 
¬’a_»dzÚe_cÜru±iÚ
 = 
¬’a_»dzÚe_cÜru±iÚ_»¶aûm’t
;

80 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
çl£
;

81 
s
 = (*)
	`m®locx
(1, 0);

82 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

83 
s
[-1] = 0xbb;

84 
	`d®locx
(
s
, 0);

85 
	`as£¹_Œue
(
d‘eùed_»dzÚe_cÜru±iÚ
,

89 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
çl£
;

90 
s
 = (*)
	`m®locx
(1, 0);

91 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

92 
s
[
	`§Îocx
(s, 0)] = 0xbb;

93 
	`d®locx
(
s
, 0);

94 
	`as£¹_Œue
(
d‘eùed_»dzÚe_cÜru±iÚ
,

97 
¬’a_»dzÚe_cÜru±iÚ
 = 
¬’a_»dzÚe_cÜru±iÚ_Üig
;

98 
	}
}

99 
TEST_END


102 
	$maš
()

105  (
	`‹¡
(

106 
‹¡_qu¬ªtše
,

107 
‹¡_qu¬ªtše_»dzÚe
));

108 
	}
}

	@dep/jemalloc-4.2.0/test/unit/rb.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#rbŠ_bÏck_height
(
a_ty³
, 
a_f›ld
, 
a_rbt
, 
r_height
) do { \

4 
a_ty³
 *
rbp_bh_t
; \

5 
rbp_bh_t
 = (
a_rbt
)->
rbt_roÙ
, (
r_height
) = 0; \

6 
rbp_bh_t
 !ğ
NULL
; \

7 
rbp_bh_t
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,„bp_bh_t)) { \

8 ià(!
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
rbp_bh_t
)) { \

9 (
r_height
)++; \

12 } 0)

	)

14 
node_s
 
	tnode_t
;

16 
	snode_s
 {

17 
	#NODE_MAGIC
 0x9823af7e

	)

18 
ušt32_t
 
	mmagic
;

19 
rb_node
(
node_t
è
	mlšk
;

20 
ušt64_t
 
	mkey
;

24 
	$node_cmp
(cÚ¡ 
node_t
 *
a
, cÚ¡‚ode_ˆ*
b
) {

25 
»t
;

27 
	`as£¹_u32_eq
(
a
->
magic
, 
NODE_MAGIC
, "Bad magic");

28 
	`as£¹_u32_eq
(
b
->
magic
, 
NODE_MAGIC
, "Bad magic");

30 
»t
 = (
a
->
key
 > 
b
->key) - (a->key < b->key);

31 ià(
»t
 == 0) {

36 
»t
 = (((
ušŒ_t
)
a
è> ((ušŒ_t)
b
))

37 - (((
ušŒ_t
)
a
è< ((ušŒ_t)
b
));

39  (
»t
);

40 
	}
}

42 
	$rb_Œ“
(
	tnode_t
è
	tŒ“_t
;

43 
	`rb_g’
(, 
Œ“_
, 
Œ“_t
, 
node_t
, 
lšk
, 
node_cmp
);

45 
	$TEST_BEGIN
(
‹¡_rb_em±y
)

47 
Œ“_t
 
Œ“
;

48 
node_t
 
key
;

50 
	`Œ“_Ãw
(&
Œ“
);

52 
	`as£¹_Œue
(
	`Œ“_em±y
(&
Œ“
), "Tree should beƒmpty");

53 
	`as£¹_±r_nuÎ
(
	`Œ“_fœ¡
(&
Œ“
), "Unexpected‚ode");

54 
	`as£¹_±r_nuÎ
(
	`Œ“_Ï¡
(&
Œ“
), "Unexpected‚ode");

56 
key
.key = 0;

57 
key
.
magic
 = 
NODE_MAGIC
;

58 
	`as£¹_±r_nuÎ
(
	`Œ“_£¬ch
(&
Œ“
, &
key
), "Unexpected‚ode");

60 
key
.key = 0;

61 
key
.
magic
 = 
NODE_MAGIC
;

62 
	`as£¹_±r_nuÎ
(
	`Œ“_n£¬ch
(&
Œ“
, &
key
), "Unexpected‚ode");

64 
key
.key = 0;

65 
key
.
magic
 = 
NODE_MAGIC
;

66 
	`as£¹_±r_nuÎ
(
	`Œ“_p£¬ch
(&
Œ“
, &
key
), "Unexpected‚ode");

67 
	}
}

68 
TEST_END


71 
	$Œ“_»cur£
(
node_t
 *
node
, 
bÏck_height
, 
bÏck_d•th
)

73 
»t
 = 0;

74 
node_t
 *
Ëá_node
;

75 
node_t
 *
right_node
;

77 ià(
node
 =ğ
NULL
)

78  (
»t
);

80 
Ëá_node
 = 
	`rbŠ_Ëá_g‘
(
node_t
, 
lšk
, 
node
);

81 
right_node
 = 
	`rbŠ_right_g‘
(
node_t
, 
lšk
, 
node
);

83 ià(!
	`rbŠ_»d_g‘
(
node_t
, 
lšk
, 
node
))

84 
bÏck_d•th
++;

87 ià(
	`rbŠ_»d_g‘
(
node_t
, 
lšk
, 
node
)) {

88 ià(
Ëá_node
 !ğ
NULL
)

89 
	`as£¹_çl£
(
	`rbŠ_»d_g‘
(
node_t
, 
lšk
, 
Ëá_node
),

91 ià(
right_node
 !ğ
NULL
)

92 
	`as£¹_çl£
(
	`rbŠ_»d_g‘
(
node_t
, 
lšk
, 
right_node
),

97 
	`as£¹_u32_eq
(
node
->
magic
, 
NODE_MAGIC
, "Bad magic");

100 ià(
Ëá_node
 !ğ
NULL
)

101 
»t
 +ğ
	`Œ“_»cur£
(
Ëá_node
, 
bÏck_height
, 
bÏck_d•th
);

103 
»t
 +ğ(
bÏck_d•th
 !ğ
bÏck_height
);

106 ià(
right_node
 !ğ
NULL
)

107 
»t
 +ğ
	`Œ“_»cur£
(
right_node
, 
bÏck_height
, 
bÏck_d•th
);

109 
»t
 +ğ(
bÏck_d•th
 !ğ
bÏck_height
);

111  (
»t
);

112 
	}
}

114 
node_t
 *

115 
	$Œ“_™”©e_cb
(
Œ“_t
 *
Œ“
, 
node_t
 *
node
, *
d©a
)

117 *
i
 = (*)
d©a
;

118 
node_t
 *
£¬ch_node
;

120 
	`as£¹_u32_eq
(
node
->
magic
, 
NODE_MAGIC
, "Bad magic");

123 
£¬ch_node
 = 
	`Œ“_£¬ch
(
Œ“
, 
node
);

124 
	`as£¹_±r_eq
(
£¬ch_node
, 
node
,

128 
£¬ch_node
 = 
	`Œ“_n£¬ch
(
Œ“
, 
node
);

129 
	`as£¹_±r_eq
(
£¬ch_node
, 
node
,

133 
£¬ch_node
 = 
	`Œ“_p£¬ch
(
Œ“
, 
node
);

134 
	`as£¹_±r_eq
(
£¬ch_node
, 
node
,

137 (*
i
)++;

139  (
NULL
);

140 
	}
}

143 
	$Œ“_™”©e
(
Œ“_t
 *
Œ“
)

145 
i
;

147 
i
 = 0;

148 
	`Œ“_™”
(
Œ“
, 
NULL
, 
Œ“_™”©e_cb
, (*)&
i
);

150  (
i
);

151 
	}
}

154 
	$Œ“_™”©e_»v”£
(
Œ“_t
 *
Œ“
)

156 
i
;

158 
i
 = 0;

159 
	`Œ“_»v”£_™”
(
Œ“
, 
NULL
, 
Œ“_™”©e_cb
, (*)&
i
);

161  (
i
);

162 
	}
}

165 
	$node_»move
(
Œ“_t
 *
Œ“
, 
node_t
 *
node
, 
Âodes
)

167 
node_t
 *
£¬ch_node
;

168 
bÏck_height
, 
imb®ªûs
;

170 
	`Œ“_»move
(
Œ“
, 
node
);

173 
£¬ch_node
 = 
	`Œ“_n£¬ch
(
Œ“
, 
node
);

174 ià(
£¬ch_node
 !ğ
NULL
) {

175 
	`as£¹_u64_ge
(
£¬ch_node
->
key
, 
node
->key,

180 
£¬ch_node
 = 
	`Œ“_p£¬ch
(
Œ“
, 
node
);

181 ià(
£¬ch_node
 !ğ
NULL
) {

182 
	`as£¹_u64_Ë
(
£¬ch_node
->
key
, 
node
->key,

186 
node
->
magic
 = 0;

188 
	`rbŠ_bÏck_height
(
node_t
, 
lšk
, 
Œ“
, 
bÏck_height
);

189 
imb®ªûs
 = 
	`Œ“_»cur£
(
Œ“
->
rbt_roÙ
, 
bÏck_height
, 0);

190 
	`as£¹_u_eq
(
imb®ªûs
, 0, "Tree is unbalanced");

191 
	`as£¹_u_eq
(
	`Œ“_™”©e
(
Œ“
), 
Âodes
-1,

193 
	`as£¹_u_eq
(
	`Œ“_™”©e_»v”£
(
Œ“
), 
Âodes
-1,

195 
	}
}

197 
node_t
 *

198 
	$»move_™”©e_cb
(
Œ“_t
 *
Œ“
, 
node_t
 *
node
, *
d©a
)

200 *
Âodes
 = (*)
d©a
;

201 
node_t
 *
»t
 = 
	`Œ“_Ãxt
(
Œ“
, 
node
);

203 
	`node_»move
(
Œ“
, 
node
, *
Âodes
);

205  (
»t
);

206 
	}
}

208 
node_t
 *

209 
	$»move_»v”£_™”©e_cb
(
Œ“_t
 *
Œ“
, 
node_t
 *
node
, *
d©a
)

211 *
Âodes
 = (*)
d©a
;

212 
node_t
 *
»t
 = 
	`Œ“_´ev
(
Œ“
, 
node
);

214 
	`node_»move
(
Œ“
, 
node
, *
Âodes
);

216  (
»t
);

217 
	}
}

220 
	$de¡roy_cb
(
node_t
 *
node
, *
d©a
)

222 *
Âodes
 = (*)
d©a
;

224 
	`as£¹_u_gt
(*
Âodes
, 0, "Destruction„emovedoo many‚odes");

225 (*
Âodes
)--;

226 
	}
}

228 
	$TEST_BEGIN
(
‹¡_rb_¿ndom
)

230 
	#NNODES
 25

	)

231 
	#NBAGS
 250

	)

232 
	#SEED
 42

	)

233 
sfmt_t
 *
sfmt
;

234 
ušt64_t
 
bag
[
NNODES
];

235 
Œ“_t
 
Œ“
;

236 
node_t
 
nodes
[
NNODES
];

237 
i
, 
j
, 
k
, 
bÏck_height
, 
imb®ªûs
;

239 
sfmt
 = 
	`š™_g’_¿nd
(
SEED
);

240 
i
 = 0; i < 
NBAGS
; i++) {

241 
i
) {

244 
j
 = 0; j < 
NNODES
; j++)

245 
bag
[
j
] = j;

249 
j
 = 0; j < 
NNODES
; j++)

250 
bag
[
j
] = 
NNODES
 - j - 1;

253 
j
 = 0; j < 
NNODES
; j++)

254 
bag
[
j
] = 
	`g’_¿nd64_¿nge
(
sfmt
, 
NNODES
);

257 
j
 = 1; j <ğ
NNODES
; j++) {

259 
	`Œ“_Ãw
(&
Œ“
);

260 
k
 = 0; k < 
j
; k++) {

261 
nodes
[
k
].
magic
 = 
NODE_MAGIC
;

262 
nodes
[
k
].
key
 = 
bag
[k];

266 
k
 = 0; k < 
j
; k++) {

267 
	`Œ“_š£¹
(&
Œ“
, &
nodes
[
k
]);

269 
	`rbŠ_bÏck_height
(
node_t
, 
lšk
, &
Œ“
,

270 
bÏck_height
);

271 
imb®ªûs
 = 
	`Œ“_»cur£
(
Œ“
.
rbt_roÙ
,

272 
bÏck_height
, 0);

273 
	`as£¹_u_eq
(
imb®ªûs
, 0,

276 
	`as£¹_u_eq
(
	`Œ“_™”©e
(&
Œ“
), 
k
+1,

278 
	`as£¹_u_eq
(
	`Œ“_™”©e_»v”£
(&
Œ“
), 
k
+1,

281 
	`as£¹_çl£
(
	`Œ“_em±y
(&
Œ“
),

283 
	`as£¹_±r_nÙ_nuÎ
(
	`Œ“_fœ¡
(&
Œ“
),

285 
	`as£¹_±r_nÙ_nuÎ
(
	`Œ“_Ï¡
(&
Œ“
),

288 
	`Œ“_Ãxt
(&
Œ“
, &
nodes
[
k
]);

289 
	`Œ“_´ev
(&
Œ“
, &
nodes
[
k
]);

293 
i
 % 5) {

295 
k
 = 0; k < 
j
; k++)

296 
	`node_»move
(&
Œ“
, &
nodes
[
k
], 
j
 - k);

299 
k
 = 
j
; k > 0; k--)

300 
	`node_»move
(&
Œ“
, &
nodes
[
k
-1], k);

303 
node_t
 *
¡¬t
;

304 
Âodes
 = 
j
;

306 
¡¬t
 = 
NULL
;

308 
¡¬t
 = 
	`Œ“_™”
(&
Œ“
, start,

309 
»move_™”©e_cb
, (*)&
Âodes
);

310 
Âodes
--;

311 } 
¡¬t
 !ğ
NULL
);

312 
	`as£¹_u_eq
(
Âodes
, 0,

316 
node_t
 *
¡¬t
;

317 
Âodes
 = 
j
;

319 
¡¬t
 = 
NULL
;

321 
¡¬t
 = 
	`Œ“_»v”£_™”
(&
Œ“
, start,

322 
»move_»v”£_™”©e_cb
,

323 (*)&
Âodes
);

324 
Âodes
--;

325 } 
¡¬t
 !ğ
NULL
);

326 
	`as£¹_u_eq
(
Âodes
, 0,

330 
Âodes
 = 
j
;

331 
	`Œ“_de¡roy
(&
Œ“
, 
de¡roy_cb
, &
Âodes
);

332 
	`as£¹_u_eq
(
Âodes
, 0,

336 
	`nÙ_»ached
();

340 
	`fši_g’_¿nd
(
sfmt
);

341 #undeà
NNODES


342 #undeà
NBAGS


343 #undeà
SEED


344 
	}
}

345 
TEST_END


348 
	$maš
()

351  (
	`‹¡
(

352 
‹¡_rb_em±y
,

353 
‹¡_rb_¿ndom
));

354 
	}
}

	@dep/jemalloc-4.2.0/test/unit/rtree.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
¹»e_node_–m_t
 *

4 
	$node_®loc
(
size_t
 
Ãlms
)

7  ((
¹»e_node_–m_t
 *)
	`ÿÎoc
(
Ãlms
, (rtree_node_elm_t)));

8 
	}
}

11 
	$node_d®loc
(
¹»e_node_–m_t
 *
node
)

14 
	`ä“
(
node
);

15 
	}
}

17 
	$TEST_BEGIN
(
‹¡_¹»e_g‘_em±y
)

19 
i
;

21 
i
 = 1; i <ğ((
ušŒ_t
) << 3); i++) {

22 
¹»e_t
 
¹»e
;

23 
	`as£¹_çl£
(
	`¹»e_Ãw
(&
¹»e
, 
i
, 
node_®loc
, 
node_d®loc
),

25 
	`as£¹_±r_nuÎ
(
	`¹»e_g‘
(&
¹»e
, 0, 
çl£
),

27 
	`¹»e_d–‘e
(&
¹»e
);

29 
	}
}

30 
TEST_END


32 
	$TEST_BEGIN
(
‹¡_¹»e_exŒema
)

34 
i
;

35 
ex‹Á_node_t
 
node_a
, 
node_b
;

37 
i
 = 1; i <ğ((
ušŒ_t
) << 3); i++) {

38 
¹»e_t
 
¹»e
;

39 
	`as£¹_çl£
(
	`¹»e_Ãw
(&
¹»e
, 
i
, 
node_®loc
, 
node_d®loc
),

42 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 0, &
node_a
),

44 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, 0, 
Œue
), &
node_a
,

47 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, ~((
ušŒ_t
)0), &
node_b
),

49 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, ~((
ušŒ_t
)0), 
Œue
), &
node_b
,

52 
	`¹»e_d–‘e
(&
¹»e
);

54 
	}
}

55 
TEST_END


57 
	$TEST_BEGIN
(
‹¡_¹»e_b™s
)

59 
i
, 
j
, 
k
;

61 
i
 = 1; i < ((
ušŒ_t
) << 3); i++) {

62 
ušŒ_t
 
keys
[] = {0, 1,

63 (((
ušŒ_t
)1è<< ((ušŒ_t)*8-
i
)) - 1};

64 
ex‹Á_node_t
 
node
;

65 
¹»e_t
 
¹»e
;

67 
	`as£¹_çl£
(
	`¹»e_Ãw
(&
¹»e
, 
i
, 
node_®loc
, 
node_d®loc
),

70 
j
 = 0; j < (
keys
)/(
ušŒ_t
); j++) {

71 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 
keys
[
j
], &
node
),

73 
k
 = 0; k < (
keys
)/(
ušŒ_t
); k++) {

74 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
k
], 
Œue
),

75 &
node
, "rtree_get() should„eturn "

78 "£ˆkey=%#"
FMTxPTR
", g‘ key=%#"FMTxPTR, 
i
,

79 
j
, 
k
, 
keys
[j], keys[k]);

81 
	`as£¹_±r_nuÎ
(
	`¹»e_g‘
(&
¹»e
,

82 (((
ušŒ_t
)1è<< ((ušŒ_t)*8-
i
)), 
çl£
),

84 "i=%u, j=%u", 
i
, 
j
);

85 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 
keys
[
j
], 
NULL
),

89 
	`¹»e_d–‘e
(&
¹»e
);

91 
	}
}

92 
TEST_END


94 
	$TEST_BEGIN
(
‹¡_¹»e_¿ndom
)

96 
i
;

97 
sfmt_t
 *
sfmt
;

98 
	#NSET
 16

	)

99 
	#SEED
 42

	)

101 
sfmt
 = 
	`š™_g’_¿nd
(
SEED
);

102 
i
 = 1; i <ğ((
ušŒ_t
) << 3); i++) {

103 
ušŒ_t
 
keys
[
NSET
];

104 
ex‹Á_node_t
 
node
;

105 
j
;

106 
¹»e_t
 
¹»e
;

108 
	`as£¹_çl£
(
	`¹»e_Ãw
(&
¹»e
, 
i
, 
node_®loc
, 
node_d®loc
),

111 
j
 = 0; j < 
NSET
; j++) {

112 
keys
[
j
] = (
ušŒ_t
)
	`g’_¿nd64
(
sfmt
);

113 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 
keys
[
j
], &
node
),

115 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
j
], 
Œue
), &
node
,

118 
j
 = 0; j < 
NSET
; j++) {

119 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
j
], 
Œue
), &
node
,

123 
j
 = 0; j < 
NSET
; j++) {

124 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 
keys
[
j
], 
NULL
),

126 
	`as£¹_±r_nuÎ
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
j
], 
Œue
),

129 
j
 = 0; j < 
NSET
; j++) {

130 
	`as£¹_±r_nuÎ
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
j
], 
Œue
),

134 
	`¹»e_d–‘e
(&
¹»e
);

136 
	`fši_g’_¿nd
(
sfmt
);

137 #undeà
NSET


138 #undeà
SEED


139 
	}
}

140 
TEST_END


143 
	$maš
()

146  (
	`‹¡
(

147 
‹¡_¹»e_g‘_em±y
,

148 
‹¡_¹»e_exŒema
,

149 
‹¡_¹»e_b™s
,

150 
‹¡_¹»e_¿ndom
));

151 
	}
}

	@dep/jemalloc-4.2.0/test/unit/run_quantize.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_sm®l_run_size
)

5 
nbšs
, 
i
;

6 
size_t
 
sz
, 
run_size
;

7 
size_t
 
mib
[4];

8 
size_t
 
mibËn
 = (
mib
) / (size_t);

15 
sz
 = ();

16 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.nbšs", &
nbšs
, &
sz
, 
NULL
, 0), 0,

19 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.bš.0.run_size", 
mib
, &
mibËn
), 0,

21 
i
 = 0; i < 
nbšs
; i++) {

22 
mib
[2] = 
i
;

23 
sz
 = (
size_t
);

24 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
run_size
, &
sz
, 
NULL
, 0),

26 
	`as£¹_zu_eq
(
run_size
, 
	`run_quªtize_æoÜ
(run_size),

28 
run_size
);

29 
	`as£¹_zu_eq
(
run_size
, 
	`run_quªtize_û
(run_size),

31 
run_size
);

33 
	}
}

34 
TEST_END


36 
	$TEST_BEGIN
(
‹¡_Ïrge_run_size
)

38 
boŞ
 
ÿche_oblivious
;

39 
Æruns
, 
i
;

40 
size_t
 
sz
, 
run_size_´ev
, 
û_´ev
;

41 
size_t
 
mib
[4];

42 
size_t
 
mibËn
 = (
mib
) / (size_t);

49 
sz
 = (
boŞ
);

50 
	`as£¹_d_eq
(
	`m®lùl
("cÚfig.ÿche_oblivious", &
ÿche_oblivious
, &
sz
,

51 
NULL
, 0), 0, "Unexpected mallctl failure");

53 
sz
 = ();

54 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Æruns", &
Æruns
, &
sz
, 
NULL
, 0), 0,

57 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.Ìun.0.size", 
mib
, &
mibËn
), 0,

59 
i
 = 0; i < 
Æruns
; i++) {

60 
size_t
 
Ìun_size
, 
run_size
, 
æoÜ
, 
û
;

62 
mib
[2] = 
i
;

63 
sz
 = (
size_t
);

64 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
Ìun_size
, &
sz
, 
NULL
, 0),

66 
run_size
 = 
ÿche_oblivious
 ? 
Ìun_size
 + 
PAGE
 :†run_size;

67 
æoÜ
 = 
	`run_quªtize_æoÜ
(
run_size
);

68 
û
 = 
	`run_quªtize_û
(
run_size
);

70 
	`as£¹_zu_eq
(
run_size
, 
æoÜ
,

72 "sizÖrun_size=%zu,„un_size=%zu)", 
Ìun_size
, 
run_size
);

73 
	`as£¹_zu_eq
(
run_size
, 
û
,

75 "sizÖrun_size=%zu,„un_size=%zu)", 
Ìun_size
, 
run_size
);

77 ià(
i
 > 0) {

78 
	`as£¹_zu_eq
(
run_size_´ev
, 
	`run_quªtize_æoÜ
(
run_size


79 - 
PAGE
), "Floor should be‡…recise size");

80 ià(
run_size_´ev
 < 
û_´ev
) {

81 
	`as£¹_zu_eq
(
û_´ev
, 
run_size
,

84 "run_size=%zu)", 
run_size_´ev
, 
û_´ev
,

85 
run_size
);

88 
run_size_´ev
 = 
æoÜ
;

89 
û_´ev
 = 
	`run_quªtize_û
(
run_size
 + 
PAGE
);

91 
	}
}

92 
TEST_END


94 
	$TEST_BEGIN
(
‹¡_mÚÙÚic
)

96 
nbšs
, 
Æruns
, 
i
;

97 
size_t
 
sz
, 
æoÜ_´ev
, 
û_´ev
;

104 
sz
 = ();

105 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.nbšs", &
nbšs
, &
sz
, 
NULL
, 0), 0,

108 
sz
 = ();

109 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Æruns", &
Æruns
, &
sz
, 
NULL
, 0), 0,

112 
æoÜ_´ev
 = 0;

113 
û_´ev
 = 0;

114 
i
 = 1; i < 
run_quªtize_max
 >> 
LG_PAGE
; i++) {

115 
size_t
 
run_size
, 
æoÜ
, 
û
;

117 
run_size
 = 
i
 << 
LG_PAGE
;

118 
æoÜ
 = 
	`run_quªtize_æoÜ
(
run_size
);

119 
û
 = 
	`run_quªtize_û
(
run_size
);

121 
	`as£¹_zu_Ë
(
æoÜ
, 
run_size
,

123 
æoÜ
, 
run_size
, 
û
);

124 
	`as£¹_zu_ge
(
û
, 
run_size
,

126 
æoÜ
, 
run_size
, 
û
);

128 
	`as£¹_zu_Ë
(
æoÜ_´ev
, 
æoÜ
, "Floor should be monotonic "

130 
æoÜ_´ev
, 
æoÜ
, 
run_size
, 
û
);

131 
	`as£¹_zu_Ë
(
û_´ev
, 
û
, "Ceiling should be monotonic "

133 
æoÜ
, 
run_size
, 
û_´ev
, 
û
);

135 
æoÜ_´ev
 = 
æoÜ
;

136 
û_´ev
 = 
û
;

138 
	}
}

139 
TEST_END


142 
	$maš
()

145  (
	`‹¡
(

146 
‹¡_sm®l_run_size
,

147 
‹¡_Ïrge_run_size
,

148 
‹¡_mÚÙÚic
));

149 
	}
}

	@dep/jemalloc-4.2.0/test/unit/size_classes.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
size_t


4 
	$g‘_max_size_şass
()

6 
nhchunks
;

7 
size_t
 
mib
[4];

8 
size_t
 
sz
, 
mibËn
, 
max_size_şass
;

10 
sz
 = ();

11 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.nhchunks", &
nhchunks
, &
sz
, 
NULL
, 0), 0,

14 
mibËn
 = (
mib
è/ (
size_t
);

15 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.hchunk.0.size", 
mib
, &
mibËn
), 0,

17 
mib
[2] = 
nhchunks
 - 1;

19 
sz
 = (
size_t
);

20 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
max_size_şass
, &
sz
, 
NULL
, 0), 0,

23  (
max_size_şass
);

24 
	}
}

26 
	$TEST_BEGIN
(
‹¡_size_şas£s
)

28 
size_t
 
size_şass
, 
max_size_şass
;

29 
szšd_t
 
šdex
, 
max_šdex
;

31 
max_size_şass
 = 
	`g‘_max_size_şass
();

32 
max_šdex
 = 
	`size2šdex
(
max_size_şass
);

34 
šdex
 = 0, 
size_şass
 = 
	`šdex2size
(šdex); index < 
max_šdex
 ||

35 
size_şass
 < 
max_size_şass
; 
šdex
++, size_class =

36 
	`šdex2size
(
šdex
)) {

37 
	`as£¹_Œue
(
šdex
 < 
max_šdex
,

39 "size_şass=%zu (%#zx)", 
šdex
, 
size_şass
, size_class);

40 
	`as£¹_Œue
(
size_şass
 < 
max_size_şass
,

42 "size_şass=%zu (%#zx)", 
šdex
, 
size_şass
, size_class);

44 
	`as£¹_u_eq
(
šdex
, 
	`size2šdex
(
size_şass
),

46 " size_şass=%zu --> index=%u --> size_şass=%zu", 
šdex
,

47 
size_şass
, 
	`size2šdex
(size_class),

48 
	`šdex2size
(
	`size2šdex
(
size_şass
)));

49 
	`as£¹_zu_eq
(
size_şass
, 
	`šdex2size
(
	`size2šdex
(size_class)),

51 " size_şass=%zu --> index=%u --> size_şass=%zu", 
šdex
,

52 
size_şass
, 
	`size2šdex
(size_class),

53 
	`šdex2size
(
	`size2šdex
(
size_şass
)));

55 
	`as£¹_u_eq
(
šdex
+1, 
	`size2šdex
(
size_şass
+1),

58 
	`as£¹_zu_eq
(
size_şass
, (
šdex
 > 0) ?

59 
	`s2u
(
	`šdex2size
(
šdex
-1)+1) : s2u(1),

61 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(size_class-1),

63 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(size_class),

65 
	`as£¹_zu_eq
(
	`s2u
(
size_şass
+1), 
	`šdex2size
(
šdex
+1),

69 
	`as£¹_u_eq
(
šdex
, 
	`size2šdex
(
	`šdex2size
(index)),

71 
	`as£¹_zu_eq
(
max_size_şass
, 
	`šdex2size
(
	`size2šdex
(max_size_class)),

74 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(
	`šdex2size
(
šdex
-1)+1),

76 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(size_class-1),

78 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(size_class),

80 
	}
}

81 
TEST_END


83 
	$TEST_BEGIN
(
‹¡_ov”æow
)

85 
size_t
 
max_size_şass
;

87 
max_size_şass
 = 
	`g‘_max_size_şass
();

89 
	`as£¹_u_ge
(
	`size2šdex
(
max_size_şass
+1), 
NSIZES
,

91 
	`as£¹_u_ge
(
	`size2šdex
(
	`ZU
(
PTRDIFF_MAX
)+1), 
NSIZES
,

93 
	`as£¹_u_ge
(
	`size2šdex
(
SIZE_T_MAX
), 
NSIZES
,

96 
	`as£¹_zu_gt
(
	`s2u
(
max_size_şass
+1), 
HUGE_MAXCLASS
,

98 
	`as£¹_zu_gt
(
	`s2u
(
	`ZU
(
PTRDIFF_MAX
)+1), 
HUGE_MAXCLASS
,

100 
	`as£¹_zu_eq
(
	`s2u
(
SIZE_T_MAX
), 0,

102 
	}
}

103 
TEST_END


106 
	$maš
()

109  (
	`‹¡
(

110 
‹¡_size_şas£s
,

111 
‹¡_ov”æow
));

112 
	}
}

	@dep/jemalloc-4.2.0/test/unit/smoothstep.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 cÚ¡ 
ušt64_t
 
	gsmoÙh¡•_b
[] = {

4 
	#STEP
(
¡•
, 
h
, 
x
, 
y
) \

5 
h
,

	)

6 
SMOOTHSTEP


7 #undeà
STEP


10 
	$TEST_BEGIN
(
‹¡_smoÙh¡•_š‹g¿l
)

12 
ušt64_t
 
sum
, 
mš
, 
max
;

13 
i
;

22 
sum
 = 0;

23 
i
 = 0; i < 
SMOOTHSTEP_NSTEPS
; i++)

24 
sum
 +ğ
smoÙh¡•_b
[
i
];

26 
max
 = (
	`KQU
(1è<< (
SMOOTHSTEP_BFP
-1)è* (
SMOOTHSTEP_NSTEPS
+1);

27 
mš
 = 
max
 - 
SMOOTHSTEP_NSTEPS
;

29 
	`as£¹_u64_ge
(
sum
, 
mš
,

31 
	`as£¹_u64_Ë
(
sum
, 
max
, "Integralƒxceeds 1/2");

32 ià(
çl£
) {

33 
	`m®loc_´štf
("%"
FMTu64
" ulps under 1/2 (limit %d)\n",

34 
max
 - 
sum
, 
SMOOTHSTEP_NSTEPS
);

36 
	}
}

37 
TEST_END


39 
	$TEST_BEGIN
(
‹¡_smoÙh¡•_mÚÙÚic
)

41 
ušt64_t
 
´ev_h
;

42 
i
;

50 
´ev_h
 = 0;

51 
i
 = 0; i < 
SMOOTHSTEP_NSTEPS
; i++) {

52 
ušt64_t
 
h
 = 
smoÙh¡•_b
[
i
];

53 
	`as£¹_u64_ge
(
h
, 
´ev_h
, "P›ûwi£‚Ú-mÚÙÚic, i=%u", 
i
);

54 
´ev_h
 = 
h
;

56 
	`as£¹_u64_eq
(
smoÙh¡•_b
[
SMOOTHSTEP_NSTEPS
-1],

57 (
	`KQU
(1è<< 
SMOOTHSTEP_BFP
), "Last step mustƒqual 1");

58 
	}
}

59 
TEST_END


61 
	$TEST_BEGIN
(
‹¡_smoÙh¡•_¦İe
)

63 
ušt64_t
 
´ev_h
, 
´ev_d–
;

64 
i
;

72 
´ev_h
 = 0;

73 
´ev_d–
 = 0;

74 
i
 = 0; i < 
SMOOTHSTEP_NSTEPS
 / 2 + SMOOTHSTEP_NSTEPS % 2; i++) {

75 
ušt64_t
 
h
 = 
smoÙh¡•_b
[
i
];

76 
ušt64_t
 
d–
 = 
h
 - 
´ev_h
;

77 
	`as£¹_u64_ge
(
d–
, 
´ev_d–
,

79 "i=%u", 
i
);

80 
´ev_h
 = 
h
;

81 
´ev_d–
 = 
d–
;

84 
´ev_h
 = 
	`KQU
(1è<< 
SMOOTHSTEP_BFP
;

85 
´ev_d–
 = 0;

86 
i
 = 
SMOOTHSTEP_NSTEPS
-1; i >= SMOOTHSTEP_NSTEPS / 2; i--) {

87 
ušt64_t
 
h
 = 
smoÙh¡•_b
[
i
];

88 
ušt64_t
 
d–
 = 
´ev_h
 - 
h
;

89 
	`as£¹_u64_ge
(
d–
, 
´ev_d–
,

91 "i=%u", 
i
);

92 
´ev_h
 = 
h
;

93 
´ev_d–
 = 
d–
;

95 
	}
}

96 
TEST_END


99 
	$maš
()

102  (
	`‹¡
(

103 
‹¡_smoÙh¡•_š‹g¿l
,

104 
‹¡_smoÙh¡•_mÚÙÚic
,

105 
‹¡_smoÙh¡•_¦İe
));

106 
	}
}

	@dep/jemalloc-4.2.0/test/unit/stats.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_¡©s_summ¬y
)

5 
size_t
 *
ÿùive
;

6 
size_t
 
sz
, 
®loÿ‹d
, 
aùive
, 
»sid’t
, 
m­³d
;

7 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

9 
sz
 = (
ÿùive
);

10 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.ÿùive", &
ÿùive
, &
sz
, 
NULL
, 0), 
ex³ùed
,

13 
sz
 = (
size_t
);

14 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.®loÿ‹d", &
®loÿ‹d
, &
sz
, 
NULL
, 0),

15 
ex³ùed
, "Unexpected mallctl()„esult");

16 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.aùive", &
aùive
, &
sz
, 
NULL
, 0), 
ex³ùed
,

18 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.»sid’t", &
»sid’t
, &
sz
, 
NULL
, 0),

19 
ex³ùed
, "Unexpected mallctl()„esult");

20 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.m­³d", &
m­³d
, &
sz
, 
NULL
, 0), 
ex³ùed
,

23 ià(
cÚfig_¡©s
) {

24 
	`as£¹_zu_Ë
(
aùive
, *
ÿùive
,

26 
	`as£¹_zu_Ë
(
®loÿ‹d
, 
aùive
,

28 
	`as£¹_zu_É
(
aùive
, 
»sid’t
,

30 
	`as£¹_zu_É
(
aùive
, 
m­³d
,

33 
	}
}

34 
TEST_END


36 
	$TEST_BEGIN
(
‹¡_¡©s_huge
)

38 *
p
;

39 
ušt64_t
 
•och
;

40 
size_t
 
®loÿ‹d
;

41 
ušt64_t
 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

42 
size_t
 
sz
;

43 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

45 
p
 = 
	`m®locx
(
Ïrge_maxşass
+1, 0);

46 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

48 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

51 
sz
 = (
size_t
);

52 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.®loÿ‹d", &
®loÿ‹d
, &
sz
,

53 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

54 
sz
 = (
ušt64_t
);

55 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.nm®loc", &
nm®loc
, &
sz
, 
NULL
,

56 0), 
ex³ùed
, "Unexpected mallctl()„esult");

57 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.nd®loc", &
nd®loc
, &
sz
, 
NULL
,

58 0), 
ex³ùed
, "Unexpected mallctl()„esult");

59 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.Äeque¡s", &
Äeque¡s
, &
sz
,

60 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

62 ià(
cÚfig_¡©s
) {

63 
	`as£¹_zu_gt
(
®loÿ‹d
, 0,

65 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

67 
	`as£¹_u64_Ë
(
nm®loc
, 
Äeque¡s
,

71 
	`d®locx
(
p
, 0);

72 
	}
}

73 
TEST_END


75 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_summ¬y
)

77 
¬’a
;

78 *
l™e
, *
Ïrge
, *
huge
;

79 
ušt64_t
 
•och
;

80 
size_t
 
sz
;

81 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

82 
size_t
 
m­³d
;

83 
ušt64_t
 
Åurge
, 
nmadvi£
, 
purged
;

85 
¬’a
 = 0;

86 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

89 
l™e
 = 
	`m®locx
(
SMALL_MAXCLASS
, 0);

90 
	`as£¹_±r_nÙ_nuÎ
(
l™e
, "Unexpected mallocx() failure");

91 
Ïrge
 = 
	`m®locx
(
Ïrge_maxşass
, 0);

92 
	`as£¹_±r_nÙ_nuÎ
(
Ïrge
, "Unexpected mallocx() failure");

93 
huge
 = 
	`m®locx
(
chunksize
, 0);

94 
	`as£¹_±r_nÙ_nuÎ
(
huge
, "Unexpected mallocx() failure");

96 
	`d®locx
(
l™e
, 0);

97 
	`d®locx
(
Ïrge
, 0);

98 
	`d®locx
(
huge
, 0);

100 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

103 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

106 
sz
 = (
size_t
);

107 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.m­³d", &
m­³d
, &
sz
, 
NULL
, 0),

108 
ex³ùed
, "Unexepected mallctl()„esult");

109 
sz
 = (
ušt64_t
);

110 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Åurge", &
Åurge
, &
sz
, 
NULL
, 0),

111 
ex³ùed
, "Unexepected mallctl()„esult");

112 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.nmadvi£", &
nmadvi£
, &
sz
, 
NULL
, 0),

113 
ex³ùed
, "Unexepected mallctl()„esult");

114 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.purged", &
purged
, &
sz
, 
NULL
, 0),

115 
ex³ùed
, "Unexepected mallctl()„esult");

117 ià(
cÚfig_¡©s
) {

118 
	`as£¹_u64_gt
(
Åurge
, 0,

120 
	`as£¹_u64_Ë
(
nmadvi£
, 
purged
,

123 
	}
}

124 
TEST_END


127 
	$thd_¡¬t
(*
¬g
)

130  (
NULL
);

131 
	}
}

134 
	$no_Ïzy_lock
()

136 
thd_t
 
thd
;

138 
	`thd_ü—‹
(&
thd
, 
thd_¡¬t
, 
NULL
);

139 
	`thd_još
(
thd
, 
NULL
);

140 
	}
}

142 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_sm®l
)

144 
¬’a
;

145 *
p
;

146 
size_t
 
sz
, 
®loÿ‹d
;

147 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

148 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

150 
	`no_Ïzy_lock
();

152 
¬’a
 = 0;

153 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

156 
p
 = 
	`m®locx
(
SMALL_MAXCLASS
, 0);

157 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

159 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.æush", 
NULL
, NULL, NULL, 0),

160 
cÚfig_tÿche
 ? 0 : 
ENOENT
, "Unexpected mallctl()„esult");

162 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

165 
sz
 = (
size_t
);

166 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.sm®l.®loÿ‹d", &
®loÿ‹d
, &
sz
,

167 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

168 
sz
 = (
ušt64_t
);

169 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.sm®l.nm®loc", &
nm®loc
, &
sz
,

170 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

171 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.sm®l.nd®loc", &
nd®loc
, &
sz
,

172 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

173 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.sm®l.Äeque¡s", &
Äeque¡s
, &
sz
,

174 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

176 ià(
cÚfig_¡©s
) {

177 
	`as£¹_zu_gt
(
®loÿ‹d
, 0,

179 
	`as£¹_u64_gt
(
nm®loc
, 0,

181 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

183 
	`as£¹_u64_gt
(
Äeque¡s
, 0,

187 
	`d®locx
(
p
, 0);

188 
	}
}

189 
TEST_END


191 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_Ïrge
)

193 
¬’a
;

194 *
p
;

195 
size_t
 
sz
, 
®loÿ‹d
;

196 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

197 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

199 
¬’a
 = 0;

200 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

203 
p
 = 
	`m®locx
(
Ïrge_maxşass
, 0);

204 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

206 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

209 
sz
 = (
size_t
);

210 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ïrge.®loÿ‹d", &
®loÿ‹d
, &
sz
,

211 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

212 
sz
 = (
ušt64_t
);

213 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ïrge.nm®loc", &
nm®loc
, &
sz
,

214 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

215 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ïrge.nd®loc", &
nd®loc
, &
sz
,

216 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

217 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ïrge.Äeque¡s", &
Äeque¡s
, &
sz
,

218 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

220 ià(
cÚfig_¡©s
) {

221 
	`as£¹_zu_gt
(
®loÿ‹d
, 0,

223 
	`as£¹_u64_gt
(
nm®loc
, 0,

225 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

227 
	`as£¹_u64_gt
(
Äeque¡s
, 0,

231 
	`d®locx
(
p
, 0);

232 
	}
}

233 
TEST_END


235 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_huge
)

237 
¬’a
;

238 *
p
;

239 
size_t
 
sz
, 
®loÿ‹d
;

240 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
;

241 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

243 
¬’a
 = 0;

244 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

247 
p
 = 
	`m®locx
(
chunksize
, 0);

248 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

250 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

253 
sz
 = (
size_t
);

254 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.®loÿ‹d", &
®loÿ‹d
, &
sz
,

255 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

256 
sz
 = (
ušt64_t
);

257 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.nm®loc", &
nm®loc
, &
sz
,

258 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

259 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.nd®loc", &
nd®loc
, &
sz
,

260 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

262 ià(
cÚfig_¡©s
) {

263 
	`as£¹_zu_gt
(
®loÿ‹d
, 0,

265 
	`as£¹_u64_gt
(
nm®loc
, 0,

267 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

271 
	`d®locx
(
p
, 0);

272 
	}
}

273 
TEST_END


275 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_bšs
)

277 
¬’a
;

278 *
p
;

279 
size_t
 
sz
, 
cu¼uns
, 
cu¼egs
;

280 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
, 
Äeque¡s
, 
nfls
, 
næushes
;

281 
ušt64_t
 
Äuns
, 
Ä”uns
;

282 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

284 
¬’a
 = 0;

285 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

288 
p
 = 
	`m®locx
(
¬’a_bš_šfo
[0].
»g_size
, 0);

289 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

291 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.æush", 
NULL
, NULL, NULL, 0),

292 
cÚfig_tÿche
 ? 0 : 
ENOENT
, "Unexpected mallctl()„esult");

294 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

297 
sz
 = (
ušt64_t
);

298 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.nm®loc", &
nm®loc
, &
sz
,

299 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

300 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.nd®loc", &
nd®loc
, &
sz
,

301 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

302 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.Äeque¡s", &
Äeque¡s
, &
sz
,

303 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

304 
sz
 = (
size_t
);

305 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.cu¼egs", &
cu¼egs
, &
sz
,

306 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

308 
sz
 = (
ušt64_t
);

309 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.nfls", &
nfls
, &
sz
,

310 
NULL
, 0), 
cÚfig_tÿche
 ? 
ex³ùed
 : 
ENOENT
,

312 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.næushes", &
næushes
, &
sz
,

313 
NULL
, 0), 
cÚfig_tÿche
 ? 
ex³ùed
 : 
ENOENT
,

316 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.Äuns", &
Äuns
, &
sz
,

317 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

318 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.Ä”uns", &
Ä”uns
, &
sz
,

319 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

320 
sz
 = (
size_t
);

321 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.cu¼uns", &
cu¼uns
, &
sz
,

322 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

324 ià(
cÚfig_¡©s
) {

325 
	`as£¹_u64_gt
(
nm®loc
, 0,

327 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

329 
	`as£¹_u64_gt
(
Äeque¡s
, 0,

331 
	`as£¹_zu_gt
(
cu¼egs
, 0,

333 ià(
cÚfig_tÿche
) {

334 
	`as£¹_u64_gt
(
nfls
, 0,

336 
	`as£¹_u64_gt
(
næushes
, 0,

339 
	`as£¹_u64_gt
(
Äuns
, 0,

341 
	`as£¹_zu_gt
(
cu¼uns
, 0,

345 
	`d®locx
(
p
, 0);

346 
	}
}

347 
TEST_END


349 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_Ìuns
)

351 
¬’a
;

352 *
p
;

353 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

354 
size_t
 
cu¼uns
, 
sz
;

355 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

357 
¬’a
 = 0;

358 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

361 
p
 = 
	`m®locx
(
LARGE_MINCLASS
, 0);

362 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

364 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

367 
sz
 = (
ušt64_t
);

368 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ìuns.0.nm®loc", &
nm®loc
, &
sz
,

369 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

370 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ìuns.0.nd®loc", &
nd®loc
, &
sz
,

371 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

372 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ìuns.0.Äeque¡s", &
Äeque¡s
, &
sz
,

373 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

374 
sz
 = (
size_t
);

375 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ìuns.0.cu¼uns", &
cu¼uns
, &
sz
,

376 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

378 ià(
cÚfig_¡©s
) {

379 
	`as£¹_u64_gt
(
nm®loc
, 0,

381 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

383 
	`as£¹_u64_gt
(
Äeque¡s
, 0,

385 
	`as£¹_u64_gt
(
cu¼uns
, 0,

389 
	`d®locx
(
p
, 0);

390 
	}
}

391 
TEST_END


393 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_hchunks
)

395 
¬’a
;

396 *
p
;

397 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
;

398 
size_t
 
curhchunks
, 
sz
;

399 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

401 
¬’a
 = 0;

402 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

405 
p
 = 
	`m®locx
(
chunksize
, 0);

406 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

408 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

411 
sz
 = (
ušt64_t
);

412 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.hchunks.0.nm®loc", &
nm®loc
, &
sz
,

413 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

414 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.hchunks.0.nd®loc", &
nd®loc
, &
sz
,

415 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

416 
sz
 = (
size_t
);

417 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.hchunks.0.curhchunks", &
curhchunks
,

418 &
sz
, 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

420 ià(
cÚfig_¡©s
) {

421 
	`as£¹_u64_gt
(
nm®loc
, 0,

423 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

425 
	`as£¹_u64_gt
(
curhchunks
, 0,

429 
	`d®locx
(
p
, 0);

430 
	}
}

431 
TEST_END


434 
	$maš
()

437  (
	`‹¡
(

438 
‹¡_¡©s_summ¬y
,

439 
‹¡_¡©s_huge
,

440 
‹¡_¡©s_¬’as_summ¬y
,

441 
‹¡_¡©s_¬’as_sm®l
,

442 
‹¡_¡©s_¬’as_Ïrge
,

443 
‹¡_¡©s_¬’as_huge
,

444 
‹¡_¡©s_¬’as_bšs
,

445 
‹¡_¡©s_¬’as_Ìuns
,

446 
‹¡_¡©s_¬’as_hchunks
));

447 
	}
}

	@dep/jemalloc-4.2.0/test/unit/ticker.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_tick”_tick
)

5 
	#NREPS
 2

	)

6 
	#NTICKS
 3

	)

7 
tick”_t
 
tick”
;

8 
št32_t
 
i
, 
j
;

10 
	`tick”_š™
(&
tick”
, 
NTICKS
);

11 
i
 = 0; i < 
NREPS
; i++) {

12 
j
 = 0; j < 
NTICKS
; j++) {

13 
	`as£¹_u_eq
(
	`tick”_»ad
(&
tick”
), 
NTICKS
 - 
j
,

14 "UÃx³ùedick” v®u(i=%d, j=%d)", 
i
, 
j
);

15 
	`as£¹_çl£
(
	`tick”_tick
(&
tick”
),

16 "UÃx³ùedick” fœ(i=%d, j=%d)", 
i
, 
j
);

18 
	`as£¹_u32_eq
(
	`tick”_»ad
(&
tick”
), 0,

20 
	`as£¹_Œue
(
	`tick”_tick
(&
tick”
),

21 "Ex³ùedick” fœ(i=%d)", 
i
);

22 
	`as£¹_u32_eq
(
	`tick”_»ad
(&
tick”
), 
NTICKS
,

25 #undeà
NTICKS


26 
	}
}

27 
TEST_END


29 
	$TEST_BEGIN
(
‹¡_tick”_ticks
)

31 
	#NTICKS
 3

	)

32 
tick”_t
 
tick”
;

34 
	`tick”_š™
(&
tick”
, 
NTICKS
);

36 
	`as£¹_u_eq
(
	`tick”_»ad
(&
tick”
), 
NTICKS
, "Unexpectedicker value");

37 
	`as£¹_çl£
(
	`tick”_ticks
(&
tick”
, 
NTICKS
), "Unexpectedicker fire");

38 
	`as£¹_u_eq
(
	`tick”_»ad
(&
tick”
), 0, "Unexpectedicker value");

39 
	`as£¹_Œue
(
	`tick”_ticks
(&
tick”
, 
NTICKS
), "Expectedicker fire");

40 
	`as£¹_u_eq
(
	`tick”_»ad
(&
tick”
), 
NTICKS
, "Unexpectedicker value");

42 
	`as£¹_Œue
(
	`tick”_ticks
(&
tick”
, 
NTICKS
 + 1), "Expectedicker fire");

43 
	`as£¹_u_eq
(
	`tick”_»ad
(&
tick”
), 
NTICKS
, "Unexpectedicker value");

44 #undeà
NTICKS


45 
	}
}

46 
TEST_END


48 
	$TEST_BEGIN
(
‹¡_tick”_cİy
)

50 
	#NTICKS
 3

	)

51 
tick”_t
 

, 
tb
;

53 
	`tick”_š™
(&

, 
NTICKS
);

54 
	`tick”_cİy
(&
tb
, &

);

55 
	`as£¹_u_eq
(
	`tick”_»ad
(&
tb
), 
NTICKS
, "Unexpectedicker value");

56 
	`as£¹_Œue
(
	`tick”_ticks
(&
tb
, 
NTICKS
 + 1), "Expectedicker fire");

57 
	`as£¹_u_eq
(
	`tick”_»ad
(&
tb
), 
NTICKS
, "Unexpectedicker value");

59 
	`tick”_tick
(&

);

60 
	`tick”_cİy
(&
tb
, &

);

61 
	`as£¹_u_eq
(
	`tick”_»ad
(&
tb
), 
NTICKS
 - 1, "Unexpectedicker value");

62 
	`as£¹_Œue
(
	`tick”_ticks
(&
tb
, 
NTICKS
), "Expectedicker fire");

63 
	`as£¹_u_eq
(
	`tick”_»ad
(&
tb
), 
NTICKS
, "Unexpectedicker value");

64 #undeà
NTICKS


65 
	}
}

66 
TEST_END


69 
	$maš
()

72  (
	`‹¡
(

73 
‹¡_tick”_tick
,

74 
‹¡_tick”_ticks
,

75 
‹¡_tick”_cİy
));

76 
	}
}

	@dep/jemalloc-4.2.0/test/unit/tsd.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#THREAD_DATA
 0x72b65c10

	)

5 
	td©a_t
;

7 
boŞ
 
	gd©a_ş—nup_execu‹d
;

9 
	$m®loc_tsd_ty³s
(
d©a_
, 
d©a_t
)

10 
	$m®loc_tsd_´Ùos
(, 
d©a_
, 
d©a_t
)

13 
	$d©a_ş—nup
(*
¬g
)

15 
d©a_t
 *
d©a
 = (d©a_ˆ*)
¬g
;

17 ià(!
d©a_ş—nup_execu‹d
) {

18 
	`as£¹_x_eq
(*
d©a
, 
THREAD_DATA
,

22 
d©a_ş—nup_execu‹d
 = 
Œue
;

28 *
d©a
) {

29 
THREAD_DATA
:

30 *
d©a
 = 1;

31 
	`d©a_tsd_£t
(
d©a
);

34 *
d©a
 = 2;

35 
	`d©a_tsd_£t
(
d©a
);

40 
	`nÙ_»ached
();

44 *
p
 = 
	`m®locx
(1, 0);

45 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpeced mallocx() failure");

46 
	`d®locx
(
p
, 0);

48 
	}
}

50 
	$m®loc_tsd_ex‹ºs
(
d©a_
, 
d©a_t
)

51 
	#DATA_INIT
 0x12345678

	)

52 
	$m®loc_tsd_d©a
(, 
d©a_
, 
d©a_t
, 
DATA_INIT
)

53 
	$m®loc_tsd_funcs
(, 
d©a_
, 
d©a_t
, 
DATA_INIT
, 
d©a_ş—nup
)

56 
	$thd_¡¬t
(*
¬g
)

58 
d©a_t
 
d
 = (d©a_t)(
ušŒ_t
)
¬g
;

59 *
p
;

61 
	`as£¹_x_eq
(*
	`d©a_tsd_g‘
(), 
DATA_INIT
,

64 
p
 = 
	`m®loc
(1);

65 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected malloc() failure");

67 
	`d©a_tsd_£t
(&
d
);

68 
	`as£¹_x_eq
(*
	`d©a_tsd_g‘
(), 
d
,

71 
d
 = 0;

72 
	`as£¹_x_eq
(*
	`d©a_tsd_g‘
(), (
d©a_t
)(
ušŒ_t
)
¬g
,

75 
	`ä“
(
p
);

76  (
NULL
);

77 
	}
}

79 
	$TEST_BEGIN
(
‹¡_tsd_maš_th»ad
)

82 
	`thd_¡¬t
((*) 0xa5f3e329);

83 
	}
}

84 
TEST_END


86 
	$TEST_BEGIN
(
‹¡_tsd_sub_th»ad
)

88 
thd_t
 
thd
;

90 
d©a_ş—nup_execu‹d
 = 
çl£
;

91 
	`thd_ü—‹
(&
thd
, 
thd_¡¬t
, (*)
THREAD_DATA
);

92 
	`thd_još
(
thd
, 
NULL
);

93 
	`as£¹_Œue
(
d©a_ş—nup_execu‹d
,

95 
	}
}

96 
TEST_END


99 
	$maš
()

103 ià(
	`ÇÎocx
(1, 0) == 0) {

104 
	`m®loc_´štf
("Initializationƒrror");

105  (
‹¡_¡©us_ç
);

107 
	`d©a_tsd_boÙ
();

109  (
	`‹¡
(

110 
‹¡_tsd_maš_th»ad
,

111 
‹¡_tsd_sub_th»ad
));

112 
	}
}

	@dep/jemalloc-4.2.0/test/unit/util.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#TEST_POW2_CEIL
(
t
, 
suf
, 
´i
) do { \

4 
i
, 
pow2
; \

5 
t
 
x
; \

7 
as£¹_
##
suf
##
	`_eq
(
pow2_û_
##
	`suf
(0), 0, "Unexpected„esult"); \

9 
i
 = 0; i < (
t
) * 8; i++) { \

10 
as£¹_
##
suf
##
	`_eq
(
pow2_û_
##
	`suf
(((
t
)1è<< 
i
), ((t)1) \

11 << 
i
, "Unexpected„esult"); \

14 
i
 = 2; i < (
t
) * 8; i++) { \

15 
as£¹_
##
suf
##
	`_eq
(
pow2_û_
##
	`suf
((((
t
)1è<< 
i
) - 1), \

16 ((
t
)1è<< 
i
, "Unexpected„esult"); \

19 
i
 = 0; i < (
t
) * 8 - 1; i++) { \

20 
as£¹_
##
suf
##
	`_eq
(
pow2_û_
##
	`suf
((((
t
)1è<< 
i
) + 1), \

21 ((
t
)1è<< (
i
+1), "Unexpected„esult"); \

24 
pow2
 = 1;…ow2 < 25;…ow2++) { \

25 
x
 = (((
t
)1è<< (
pow2
-1)) + 1; x <= ((t)1) <<…ow2; \

26 
x
++) { \

27 
as£¹_
##
suf
##
	`_eq
(
pow2_û_
##
	`suf
(
x
), \

28 ((
t
)1è<< 
pow2
, \

29 "UÃx³ùed„esuÉ, x=%"
´i
, 
x
); \

32 } 0)

	)

34 
	$TEST_BEGIN
(
‹¡_pow2_û_u64
)

37 
	`TEST_POW2_CEIL
(
ušt64_t
, 
u64
, 
FMTu64
);

38 
	}
}

39 
TEST_END


41 
	$TEST_BEGIN
(
‹¡_pow2_û_u32
)

44 
	`TEST_POW2_CEIL
(
ušt32_t
, 
u32
, 
FMTu32
);

45 
	}
}

46 
TEST_END


48 
	$TEST_BEGIN
(
‹¡_pow2_û_zu
)

51 
	`TEST_POW2_CEIL
(
size_t
, 
zu
, "zu");

52 
	}
}

53 
TEST_END


55 
	$TEST_BEGIN
(
‹¡_m®loc_¡¹oumax_no_’d±r
)

57 
”r
;

59 
	`£t_”ºo
(0);

60 
	`as£¹_ju_eq
(
	`m®loc_¡¹oumax
("0", 
NULL
, 0), 0, "Unexpected„esult");

61 
”r
 = 
	`g‘_”ºo
();

62 
	`as£¹_d_eq
(
”r
, 0, "Unexpected failure");

63 
	}
}

64 
TEST_END


66 
	$TEST_BEGIN
(
‹¡_m®loc_¡¹oumax
)

68 
	s‹¡_s
 {

69 cÚ¡ *
šput
;

70 cÚ¡ *
ex³ùed_»mašd”
;

71 
ba£
;

72 
ex³ùed_”ºo
;

73 cÚ¡ *
ex³ùed_”ºo_Çme
;

74 
uštmax_t
 
ex³ùed_x
;

76 
	#ERR
(
e
èe, #e

	)

77 
	#KUMAX
(
x
è((
uštmax_t
)x##
ULL
)

	)

78 
‹¡_s
 
‹¡s
[] = {

79 {"0", "0", -1, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

80 {"0", "0", 1, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

81 {"0", "0", 37, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

83 {"", "", 0, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

84 {"+", "+", 0, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

85 {"++3", "++3", 0, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

86 {"-", "-", 0, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

88 {"42", "", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

89 {"+42", "", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

90 {"-42", "", 0, 
	`ERR
(0), 
	`KUMAX
(-42)},

91 {"042", "", 0, 
	`ERR
(0), 
	`KUMAX
(042)},

92 {"+042", "", 0, 
	`ERR
(0), 
	`KUMAX
(042)},

93 {"-042", "", 0, 
	`ERR
(0), 
	`KUMAX
(-042)},

94 {"0x42", "", 0, 
	`ERR
(0), 
	`KUMAX
(0x42)},

95 {"+0x42", "", 0, 
	`ERR
(0), 
	`KUMAX
(0x42)},

96 {"-0x42", "", 0, 
	`ERR
(0), 
	`KUMAX
(-0x42)},

98 {"0", "", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

99 {"1", "", 0, 
	`ERR
(0), 
	`KUMAX
(1)},

101 {"42", "", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

102 {" 42", "", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

103 {"42 ", " ", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

104 {"0x", "x", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

105 {"42x", "x", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

107 {"07", "", 0, 
	`ERR
(0), 
	`KUMAX
(7)},

108 {"010", "", 0, 
	`ERR
(0), 
	`KUMAX
(8)},

109 {"08", "8", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

110 {"0_", "_", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

112 {"0x", "x", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

113 {"0X", "X", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

114 {"0xg", "xg", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

115 {"0XA", "", 0, 
	`ERR
(0), 
	`KUMAX
(10)},

117 {"010", "", 10, 
	`ERR
(0), 
	`KUMAX
(10)},

118 {"0x3", "x3", 10, 
	`ERR
(0), 
	`KUMAX
(0)},

120 {"12", "2", 2, 
	`ERR
(0), 
	`KUMAX
(1)},

121 {"78", "8", 8, 
	`ERR
(0), 
	`KUMAX
(7)},

122 {"9a", "a", 10, 
	`ERR
(0), 
	`KUMAX
(9)},

123 {"9A", "A", 10, 
	`ERR
(0), 
	`KUMAX
(9)},

124 {"fg", "g", 16, 
	`ERR
(0), 
	`KUMAX
(15)},

125 {"FG", "G", 16, 
	`ERR
(0), 
	`KUMAX
(15)},

126 {"0xfg", "g", 16, 
	`ERR
(0), 
	`KUMAX
(15)},

127 {"0XFG", "G", 16, 
	`ERR
(0), 
	`KUMAX
(15)},

128 {"z_", "_", 36, 
	`ERR
(0), 
	`KUMAX
(35)},

129 {"Z_", "_", 36, 
	`ERR
(0), 
	`KUMAX
(35)}

131 #undeà
ERR


132 #undeà
KUMAX


133 
i
;

135 
i
 = 0; i < (
‹¡s
)/(
‹¡_s
); i++) {

136 
‹¡_s
 *
‹¡
 = &
‹¡s
[
i
];

137 
”r
;

138 
uštmax_t
 
»suÉ
;

139 *
»mašd”
;

141 
	`£t_”ºo
(0);

142 
»suÉ
 = 
	`m®loc_¡¹oumax
(
‹¡
->
šput
, &
»mašd”
,e¡->
ba£
);

143 
”r
 = 
	`g‘_”ºo
();

144 
	`as£¹_d_eq
(
”r
, 
‹¡
->
ex³ùed_”ºo
,

146 
‹¡
->
ex³ùed_”ºo_Çme
,e¡->
šput
,e¡->
ba£
);

147 
	`as£¹_¡r_eq
(
»mašd”
, 
‹¡
->
ex³ùed_»mašd”
,

149 
‹¡
->
šput
,e¡->
ba£
);

150 ià(
”r
 == 0) {

151 
	`as£¹_ju_eq
(
»suÉ
, 
‹¡
->
ex³ùed_x
,

153 
‹¡
->
šput
,e¡->
ba£
);

156 
	}
}

157 
TEST_END


159 
	$TEST_BEGIN
(
‹¡_m®loc_¢´štf_Œunÿ‹d
)

161 
	#BUFLEN
 15

	)

162 
buf
[
BUFLEN
];

163 
size_t
 
»suÉ
;

164 
size_t
 
Ën
;

165 
	#TEST
(
ex³ùed_¡r_uÁrunÿ‹d
, ...) do { \

166 
»suÉ
 = 
	`m®loc_¢´štf
(
buf
, 
Ën
, 
__VA_ARGS__
); \

167 
	`as£¹_d_eq
(
	`¡ºcmp
(
buf
, 
ex³ùed_¡r_uÁrunÿ‹d
, 
Ën
-1), 0, \

169 
buf
, 
ex³ùed_¡r_uÁrunÿ‹d
); \

170 
	`as£¹_zu_eq
(
»suÉ
, 
	`¡¾’
(
ex³ùed_¡r_uÁrunÿ‹d
), \

172 } 0)

	)

174 
Ën
 = 1;†’ < 
BUFLEN
;†en++) {

175 
	`TEST
("012346789", "012346789");

176 
	`TEST
("a0123b", "a%sb", "0123");

177 
	`TEST
("a01234567", "a%s%s", "0123", "4567");

178 
	`TEST
("a0123 ", "a%-6s", "0123");

179 
	`TEST
("a 0123", "a%6s", "0123");

180 
	`TEST
("a 012", "a%6.3s", "0123");

181 
	`TEST
("a 012", "a%*.*s", 6, 3, "0123");

182 
	`TEST
("a 123b", "a% db", 123);

183 
	`TEST
("a123b", "a%-db", 123);

184 
	`TEST
("a-123b", "a%-db", -123);

185 
	`TEST
("a+123b", "a%+db", 123);

187 #undeà
BUFLEN


188 #undeà
TEST


189 
	}
}

190 
TEST_END


192 
	$TEST_BEGIN
(
‹¡_m®loc_¢´štf
)

194 
	#BUFLEN
 128

	)

195 
buf
[
BUFLEN
];

196 
size_t
 
»suÉ
;

197 
	#TEST
(
ex³ùed_¡r
, ...) do { \

198 
»suÉ
 = 
	`m®loc_¢´štf
(
buf
, (buf), 
__VA_ARGS__
); \

199 
	`as£¹_¡r_eq
(
buf
, 
ex³ùed_¡r
, "Unexpected output"); \

200 
	`as£¹_zu_eq
(
»suÉ
, 
	`¡¾’
(
ex³ùed_¡r
), "Unexpected„esult");\

201 } 0)

	)

203 
	`TEST
("hello", "hello");

205 
	`TEST
("50%, 100%", "50%%, %d%%", 100);

207 
	`TEST
("a0123b", "a%sb", "0123");

209 
	`TEST
("a 0123b", "a%5sb", "0123");

210 
	`TEST
("a 0123b", "a%*sb", 5, "0123");

212 
	`TEST
("a0123 b", "a%-5sb", "0123");

213 
	`TEST
("a0123b", "a%*sb", -1, "0123");

214 
	`TEST
("a0123 b", "a%*sb", -5, "0123");

215 
	`TEST
("a0123 b", "a%-*sb", -5, "0123");

217 
	`TEST
("a012b", "a%.3sb", "0123");

218 
	`TEST
("a012b", "a%.*sb", 3, "0123");

219 
	`TEST
("a0123b", "a%.*sb", -3, "0123");

221 
	`TEST
("a 012b", "a%5.3sb", "0123");

222 
	`TEST
("a 012b", "a%5.*sb", 3, "0123");

223 
	`TEST
("a 012b", "a%*.3sb", 5, "0123");

224 
	`TEST
("a 012b", "a%*.*sb", 5, 3, "0123");

225 
	`TEST
("a 0123b", "a%*.*sb", 5, -3, "0123");

227 
	`TEST
("_abcd_", "_%x_", 0xabcd);

228 
	`TEST
("_0xabcd_", "_%#x_", 0xabcd);

229 
	`TEST
("_1234_", "_%o_", 01234);

230 
	`TEST
("_01234_", "_%#o_", 01234);

231 
	`TEST
("_1234_", "_%u_", 1234);

233 
	`TEST
("_1234_", "_%d_", 1234);

234 
	`TEST
("_ 1234_", "_% d_", 1234);

235 
	`TEST
("_+1234_", "_%+d_", 1234);

236 
	`TEST
("_-1234_", "_%d_", -1234);

237 
	`TEST
("_-1234_", "_% d_", -1234);

238 
	`TEST
("_-1234_", "_%+d_", -1234);

240 
	`TEST
("_-1234_", "_%d_", -1234);

241 
	`TEST
("_1234_", "_%d_", 1234);

242 
	`TEST
("_-1234_", "_%i_", -1234);

243 
	`TEST
("_1234_", "_%i_", 1234);

244 
	`TEST
("_01234_", "_%#o_", 01234);

245 
	`TEST
("_1234_", "_%u_", 1234);

246 
	`TEST
("_0x1234abc_", "_%#x_", 0x1234abc);

247 
	`TEST
("_0X1234ABC_", "_%#X_", 0x1234abc);

248 
	`TEST
("_c_", "_%c_", 'c');

249 
	`TEST
("_string_", "_%s_", "string");

250 
	`TEST
("_0x42_", "_%p_", ((*)0x42));

252 
	`TEST
("_-1234_", "_%ld_", (()-1234));

253 
	`TEST
("_1234_", "_%ld_", (()1234));

254 
	`TEST
("_-1234_", "_%li_", (()-1234));

255 
	`TEST
("_1234_", "_%li_", (()1234));

256 
	`TEST
("_01234_", "_%#lo_", (()01234));

257 
	`TEST
("_1234_", "_%lu_", (()1234));

258 
	`TEST
("_0x1234abc_", "_%#lx_", (()0x1234abc));

259 
	`TEST
("_0X1234ABC_", "_%#lX_", (()0x1234ABC));

261 
	`TEST
("_-1234_", "_%lld_", (()-1234));

262 
	`TEST
("_1234_", "_%lld_", (()1234));

263 
	`TEST
("_-1234_", "_%lli_", (()-1234));

264 
	`TEST
("_1234_", "_%lli_", (()1234));

265 
	`TEST
("_01234_", "_%#llo_", (()01234));

266 
	`TEST
("_1234_", "_%llu_", (()1234));

267 
	`TEST
("_0x1234abc_", "_%#llx_", (()0x1234abc));

268 
	`TEST
("_0X1234ABC_", "_%#llX_", (()0x1234ABC));

270 
	`TEST
("_-1234_", "_%qd_", (()-1234));

271 
	`TEST
("_1234_", "_%qd_", (()1234));

272 
	`TEST
("_-1234_", "_%qi_", (()-1234));

273 
	`TEST
("_1234_", "_%qi_", (()1234));

274 
	`TEST
("_01234_", "_%#qo_", (()01234));

275 
	`TEST
("_1234_", "_%qu_", (()1234));

276 
	`TEST
("_0x1234abc_", "_%#qx_", (()0x1234abc));

277 
	`TEST
("_0X1234ABC_", "_%#qX_", (()0x1234ABC));

279 
	`TEST
("_-1234_", "_%jd_", ((
štmax_t
)-1234));

280 
	`TEST
("_1234_", "_%jd_", ((
štmax_t
)1234));

281 
	`TEST
("_-1234_", "_%ji_", ((
štmax_t
)-1234));

282 
	`TEST
("_1234_", "_%ji_", ((
štmax_t
)1234));

283 
	`TEST
("_01234_", "_%#jo_", ((
štmax_t
)01234));

284 
	`TEST
("_1234_", "_%ju_", ((
štmax_t
)1234));

285 
	`TEST
("_0x1234abc_", "_%#jx_", ((
štmax_t
)0x1234abc));

286 
	`TEST
("_0X1234ABC_", "_%#jX_", ((
štmax_t
)0x1234ABC));

288 
	`TEST
("_1234_", "_%td_", ((
±rdiff_t
)1234));

289 
	`TEST
("_-1234_", "_%td_", ((
±rdiff_t
)-1234));

290 
	`TEST
("_1234_", "_%ti_", ((
±rdiff_t
)1234));

291 
	`TEST
("_-1234_", "_%ti_", ((
±rdiff_t
)-1234));

293 
	`TEST
("_-1234_", "_%zd_", ((
ssize_t
)-1234));

294 
	`TEST
("_1234_", "_%zd_", ((
ssize_t
)1234));

295 
	`TEST
("_-1234_", "_%zi_", ((
ssize_t
)-1234));

296 
	`TEST
("_1234_", "_%zi_", ((
ssize_t
)1234));

297 
	`TEST
("_01234_", "_%#zo_", ((
ssize_t
)01234));

298 
	`TEST
("_1234_", "_%zu_", ((
ssize_t
)1234));

299 
	`TEST
("_0x1234abc_", "_%#zx_", ((
ssize_t
)0x1234abc));

300 
	`TEST
("_0X1234ABC_", "_%#zX_", ((
ssize_t
)0x1234ABC));

301 #undeà
BUFLEN


302 
	}
}

303 
TEST_END


306 
	$maš
()

309  (
	`‹¡
(

310 
‹¡_pow2_û_u64
,

311 
‹¡_pow2_û_u32
,

312 
‹¡_pow2_û_zu
,

313 
‹¡_m®loc_¡¹oumax_no_’d±r
,

314 
‹¡_m®loc_¡¹oumax
,

315 
‹¡_m®loc_¢´štf_Œunÿ‹d
,

316 
‹¡_m®loc_¢´štf
));

317 
	}
}

	@dep/jemalloc-4.2.0/test/unit/witness.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
w™Ãss_lock_”rÜ_t
 *
	gw™Ãss_lock_”rÜ_Üig
;

4 
w™Ãss_owÃr_”rÜ_t
 *
	gw™Ãss_owÃr_”rÜ_Üig
;

5 
w™Ãss_nÙ_owÃr_”rÜ_t
 *
	gw™Ãss_nÙ_owÃr_”rÜ_Üig
;

6 
w™Ãss_lockËss_”rÜ_t
 *
	gw™Ãss_lockËss_”rÜ_Üig
;

8 
boŞ
 
	g§w_lock_”rÜ
;

9 
boŞ
 
	g§w_owÃr_”rÜ
;

10 
boŞ
 
	g§w_nÙ_owÃr_”rÜ
;

11 
boŞ
 
	g§w_lockËss_”rÜ
;

14 
	$w™Ãss_lock_”rÜ_š‹rû±
(cÚ¡ 
w™Ãss_li¡_t
 *
w™Ãs£s
,

15 cÚ¡ 
w™Ãss_t
 *
w™Ãss
)

18 
§w_lock_”rÜ
 = 
Œue
;

19 
	}
}

22 
	$w™Ãss_owÃr_”rÜ_š‹rû±
(cÚ¡ 
w™Ãss_t
 *
w™Ãss
)

25 
§w_owÃr_”rÜ
 = 
Œue
;

26 
	}
}

29 
	$w™Ãss_nÙ_owÃr_”rÜ_š‹rû±
(cÚ¡ 
w™Ãss_t
 *
w™Ãss
)

32 
§w_nÙ_owÃr_”rÜ
 = 
Œue
;

33 
	}
}

36 
	$w™Ãss_lockËss_”rÜ_š‹rû±
(cÚ¡ 
w™Ãss_li¡_t
 *
w™Ãs£s
)

39 
§w_lockËss_”rÜ
 = 
Œue
;

40 
	}
}

43 
	$w™Ãss_comp
(cÚ¡ 
w™Ãss_t
 *
a
, cÚ¡ w™Ãss_ˆ*
b
)

46 
	`as£¹_u_eq
(
a
->
¿nk
, 
b
->rank, "Witnesses should haveƒqual„ank");

48  (
	`¡rcmp
(
a
->
Çme
, 
b
->name));

49 
	}
}

52 
	$w™Ãss_comp_»v”£
(cÚ¡ 
w™Ãss_t
 *
a
, cÚ¡ w™Ãss_ˆ*
b
)

55 
	`as£¹_u_eq
(
a
->
¿nk
, 
b
->rank, "Witnesses should haveƒqual„ank");

57  (-
	`¡rcmp
(
a
->
Çme
, 
b
->name));

58 
	}
}

60 
	$TEST_BEGIN
(
‹¡_w™Ãss
)

62 
w™Ãss_t
 
a
, 
b
;

63 
tsdn_t
 *
tsdn
;

65 
	`‹¡_sk_if
(!
cÚfig_debug
);

67 
tsdn
 = 
	`tsdn_ãtch
();

69 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

71 
	`w™Ãss_š™
(&
a
, "a", 1, 
NULL
);

72 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn
, &
a
);

73 
	`w™Ãss_lock
(
tsdn
, &
a
);

74 
	`w™Ãss_as£¹_owÃr
(
tsdn
, &
a
);

76 
	`w™Ãss_š™
(&
b
, "b", 2, 
NULL
);

77 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn
, &
b
);

78 
	`w™Ãss_lock
(
tsdn
, &
b
);

79 
	`w™Ãss_as£¹_owÃr
(
tsdn
, &
b
);

81 
	`w™Ãss_uÆock
(
tsdn
, &
a
);

82 
	`w™Ãss_uÆock
(
tsdn
, &
b
);

84 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

85 
	}
}

86 
TEST_END


88 
	$TEST_BEGIN
(
‹¡_w™Ãss_comp
)

90 
w™Ãss_t
 
a
, 
b
, 
c
, 
d
;

91 
tsdn_t
 *
tsdn
;

93 
	`‹¡_sk_if
(!
cÚfig_debug
);

95 
tsdn
 = 
	`tsdn_ãtch
();

97 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

99 
	`w™Ãss_š™
(&
a
, "a", 1, 
w™Ãss_comp
);

100 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn
, &
a
);

101 
	`w™Ãss_lock
(
tsdn
, &
a
);

102 
	`w™Ãss_as£¹_owÃr
(
tsdn
, &
a
);

104 
	`w™Ãss_š™
(&
b
, "b", 1, 
w™Ãss_comp
);

105 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn
, &
b
);

106 
	`w™Ãss_lock
(
tsdn
, &
b
);

107 
	`w™Ãss_as£¹_owÃr
(
tsdn
, &
b
);

108 
	`w™Ãss_uÆock
(
tsdn
, &
b
);

110 
w™Ãss_lock_”rÜ_Üig
 = 
w™Ãss_lock_”rÜ
;

111 
w™Ãss_lock_”rÜ
 = 
w™Ãss_lock_”rÜ_š‹rû±
;

112 
§w_lock_”rÜ
 = 
çl£
;

114 
	`w™Ãss_š™
(&
c
, "c", 1, 
w™Ãss_comp_»v”£
);

115 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn
, &
c
);

116 
	`as£¹_çl£
(
§w_lock_”rÜ
, "Unexpected witness†ockƒrror");

117 
	`w™Ãss_lock
(
tsdn
, &
c
);

118 
	`as£¹_Œue
(
§w_lock_”rÜ
, "Expected witness†ockƒrror");

119 
	`w™Ãss_uÆock
(
tsdn
, &
c
);

121 
§w_lock_”rÜ
 = 
çl£
;

123 
	`w™Ãss_š™
(&
d
, "d", 1, 
NULL
);

124 
	`w™Ãss_as£¹_nÙ_owÃr
(
tsdn
, &
d
);

125 
	`as£¹_çl£
(
§w_lock_”rÜ
, "Unexpected witness†ockƒrror");

126 
	`w™Ãss_lock
(
tsdn
, &
d
);

127 
	`as£¹_Œue
(
§w_lock_”rÜ
, "Expected witness†ockƒrror");

128 
	`w™Ãss_uÆock
(
tsdn
, &
d
);

130 
	`w™Ãss_uÆock
(
tsdn
, &
a
);

132 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

134 
w™Ãss_lock_”rÜ
 = 
w™Ãss_lock_”rÜ_Üig
;

135 
	}
}

136 
TEST_END


138 
	$TEST_BEGIN
(
‹¡_w™Ãss_»v”§l
)

140 
w™Ãss_t
 
a
, 
b
;

141 
tsdn_t
 *
tsdn
;

143 
	`‹¡_sk_if
(!
cÚfig_debug
);

145 
w™Ãss_lock_”rÜ_Üig
 = 
w™Ãss_lock_”rÜ
;

146 
w™Ãss_lock_”rÜ
 = 
w™Ãss_lock_”rÜ_š‹rû±
;

147 
§w_lock_”rÜ
 = 
çl£
;

149 
tsdn
 = 
	`tsdn_ãtch
();

151 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

153 
	`w™Ãss_š™
(&
a
, "a", 1, 
NULL
);

154 
	`w™Ãss_š™
(&
b
, "b", 2, 
NULL
);

156 
	`w™Ãss_lock
(
tsdn
, &
b
);

157 
	`as£¹_çl£
(
§w_lock_”rÜ
, "Unexpected witness†ockƒrror");

158 
	`w™Ãss_lock
(
tsdn
, &
a
);

159 
	`as£¹_Œue
(
§w_lock_”rÜ
, "Expected witness†ockƒrror");

161 
	`w™Ãss_uÆock
(
tsdn
, &
a
);

162 
	`w™Ãss_uÆock
(
tsdn
, &
b
);

164 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

166 
w™Ãss_lock_”rÜ
 = 
w™Ãss_lock_”rÜ_Üig
;

167 
	}
}

168 
TEST_END


170 
	$TEST_BEGIN
(
‹¡_w™Ãss_»cursive
)

172 
w™Ãss_t
 
a
;

173 
tsdn_t
 *
tsdn
;

175 
	`‹¡_sk_if
(!
cÚfig_debug
);

177 
w™Ãss_nÙ_owÃr_”rÜ_Üig
 = 
w™Ãss_nÙ_owÃr_”rÜ
;

178 
w™Ãss_nÙ_owÃr_”rÜ
 = 
w™Ãss_nÙ_owÃr_”rÜ_š‹rû±
;

179 
§w_nÙ_owÃr_”rÜ
 = 
çl£
;

181 
w™Ãss_lock_”rÜ_Üig
 = 
w™Ãss_lock_”rÜ
;

182 
w™Ãss_lock_”rÜ
 = 
w™Ãss_lock_”rÜ_š‹rû±
;

183 
§w_lock_”rÜ
 = 
çl£
;

185 
tsdn
 = 
	`tsdn_ãtch
();

187 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

189 
	`w™Ãss_š™
(&
a
, "a", 1, 
NULL
);

191 
	`w™Ãss_lock
(
tsdn
, &
a
);

192 
	`as£¹_çl£
(
§w_lock_”rÜ
, "Unexpected witness†ockƒrror");

193 
	`as£¹_çl£
(
§w_nÙ_owÃr_”rÜ
, "Unexpected witness‚ot ownerƒrror");

194 
	`w™Ãss_lock
(
tsdn
, &
a
);

195 
	`as£¹_Œue
(
§w_lock_”rÜ
, "Expected witness†ockƒrror");

196 
	`as£¹_Œue
(
§w_nÙ_owÃr_”rÜ
, "Expected witness‚ot ownerƒrror");

198 
	`w™Ãss_uÆock
(
tsdn
, &
a
);

200 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

202 
w™Ãss_owÃr_”rÜ
 = 
w™Ãss_owÃr_”rÜ_Üig
;

203 
w™Ãss_lock_”rÜ
 = 
w™Ãss_lock_”rÜ_Üig
;

205 
	}
}

206 
TEST_END


208 
	$TEST_BEGIN
(
‹¡_w™Ãss_uÆock_nÙ_owÃd
)

210 
w™Ãss_t
 
a
;

211 
tsdn_t
 *
tsdn
;

213 
	`‹¡_sk_if
(!
cÚfig_debug
);

215 
w™Ãss_owÃr_”rÜ_Üig
 = 
w™Ãss_owÃr_”rÜ
;

216 
w™Ãss_owÃr_”rÜ
 = 
w™Ãss_owÃr_”rÜ_š‹rû±
;

217 
§w_owÃr_”rÜ
 = 
çl£
;

219 
tsdn
 = 
	`tsdn_ãtch
();

221 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

223 
	`w™Ãss_š™
(&
a
, "a", 1, 
NULL
);

225 
	`as£¹_çl£
(
§w_owÃr_”rÜ
, "Unexpected ownerƒrror");

226 
	`w™Ãss_uÆock
(
tsdn
, &
a
);

227 
	`as£¹_Œue
(
§w_owÃr_”rÜ
, "Expected ownerƒrror");

229 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

231 
w™Ãss_owÃr_”rÜ
 = 
w™Ãss_owÃr_”rÜ_Üig
;

232 
	}
}

233 
TEST_END


235 
	$TEST_BEGIN
(
‹¡_w™Ãss_lockful
)

237 
w™Ãss_t
 
a
;

238 
tsdn_t
 *
tsdn
;

240 
	`‹¡_sk_if
(!
cÚfig_debug
);

242 
w™Ãss_lockËss_”rÜ_Üig
 = 
w™Ãss_lockËss_”rÜ
;

243 
w™Ãss_lockËss_”rÜ
 = 
w™Ãss_lockËss_”rÜ_š‹rû±
;

244 
§w_lockËss_”rÜ
 = 
çl£
;

246 
tsdn
 = 
	`tsdn_ãtch
();

248 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

250 
	`w™Ãss_š™
(&
a
, "a", 1, 
NULL
);

252 
	`as£¹_çl£
(
§w_lockËss_”rÜ
, "Unexpected†ocklessƒrror");

253 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

255 
	`w™Ãss_lock
(
tsdn
, &
a
);

256 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

257 
	`as£¹_Œue
(
§w_lockËss_”rÜ
, "Expected†ocklessƒrror");

259 
	`w™Ãss_uÆock
(
tsdn
, &
a
);

261 
	`w™Ãss_as£¹_lockËss
(
tsdn
);

263 
w™Ãss_lockËss_”rÜ
 = 
w™Ãss_lockËss_”rÜ_Üig
;

264 
	}
}

265 
TEST_END


268 
	$maš
()

271  (
	`‹¡
(

272 
‹¡_w™Ãss
,

273 
‹¡_w™Ãss_comp
,

274 
‹¡_w™Ãss_»v”§l
,

275 
‹¡_w™Ãss_»cursive
,

276 
‹¡_w™Ãss_uÆock_nÙ_owÃd
,

277 
‹¡_w™Ãss_lockful
));

278 
	}
}

	@dep/jemalloc-4.2.0/test/unit/zero.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_FILL


4 cÚ¡ *
	gm®loc_cÚf
 =

9 
	$‹¡_z”o
(
size_t
 
sz_mš
, size_ˆ
sz_max
)

11 
ušt8_t
 *
s
;

12 
size_t
 
sz_´ev
, 
sz
, 
i
;

13 
	#MAGIC
 ((
ušt8_t
)0x61)

	)

15 
sz_´ev
 = 0;

16 
s
 = (
ušt8_t
 *)
	`m®locx
(
sz_mš
, 0);

17 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

19 
sz
 = 
	`§Îocx
(
s
, 0); sz <ğ
sz_max
;

20 
sz_´ev
 = 
sz
, sz = 
	`§Îocx
(
s
, 0)) {

21 ià(
sz_´ev
 > 0) {

22 
	`as£¹_u_eq
(
s
[0], 
MAGIC
,

24 
	`ZU
(0), 
sz_´ev
);

25 
	`as£¹_u_eq
(
s
[
sz_´ev
-1], 
MAGIC
,

27 
sz_´ev
-1, sz_prev);

30 
i
 = 
sz_´ev
; i < 
sz
; i++) {

31 
	`as£¹_u_eq
(
s
[
i
], 0x0,

33 
i
, 
sz
);

34 
s
[
i
] = 
MAGIC
;

37 ià(
	`x®locx
(
s
, 
sz
+1, 0, 0) == sz) {

38 
s
 = (
ušt8_t
 *)
	`¿Îocx
(s, 
sz
+1, 0);

39 
	`as£¹_±r_nÙ_nuÎ
((*)
s
,

44 
	`d®locx
(
s
, 0);

45 #undeà
MAGIC


46 
	}
}

48 
	$TEST_BEGIN
(
‹¡_z”o_sm®l
)

51 
	`‹¡_sk_if
(!
cÚfig_fl
);

52 
	`‹¡_z”o
(1, 
SMALL_MAXCLASS
-1);

53 
	}
}

54 
TEST_END


56 
	$TEST_BEGIN
(
‹¡_z”o_Ïrge
)

59 
	`‹¡_sk_if
(!
cÚfig_fl
);

60 
	`‹¡_z”o
(
SMALL_MAXCLASS
+1, 
Ïrge_maxşass
);

61 
	}
}

62 
TEST_END


64 
	$TEST_BEGIN
(
‹¡_z”o_huge
)

67 
	`‹¡_sk_if
(!
cÚfig_fl
);

68 
	`‹¡_z”o
(
Ïrge_maxşass
+1, 
chunksize
*2);

69 
	}
}

70 
TEST_END


73 
	$maš
()

76  (
	`‹¡
(

77 
‹¡_z”o_sm®l
,

78 
‹¡_z”o_Ïrge
,

79 
‹¡_z”o_huge
));

80 
	}
}

	@dep/sds/sds.c

33 
	~<¡dio.h
>

34 
	~<¡dlib.h
>

35 
	~<¡ršg.h
>

36 
	~<ùy³.h
>

37 
	~<as£¹.h
>

39 
	~<sds.h
>

40 
	~<sd§Îoc.h
>

43 
šlše
 
	$sdsHdrSize
(
ty³
) {

44 
ty³
&
SDS_TYPE_MASK
) {

45 
SDS_TYPE_5
:

46  (
sdshdr5
);

47 
SDS_TYPE_8
:

48  (
sdshdr8
);

49 
SDS_TYPE_16
:

50  (
sdshdr16
);

51 
SDS_TYPE_32
:

52  (
sdshdr32
);

53 
SDS_TYPE_64
:

54  (
sdshdr64
);

57 
	}
}

60 
šlše
 
	$sdsReqTy³
(
size_t
 
¡ršg_size
) {

61 ià(
¡ršg_size
 < 32)

62  
SDS_TYPE_5
;

63 ià(
¡ršg_size
 < 0xff)

64  
SDS_TYPE_8
;

65 ià(
¡ršg_size
 < 0xffff)

66  
SDS_TYPE_16
;

67 ià(
¡ršg_size
 < 0xffffffff)

68  
SDS_TYPE_32
;

69  
SDS_TYPE_64
;

70 
	}
}

85 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

86 *
sh
;

87 
sds
 
s
;

89 
ty³
 = 
	`sdsReqTy³
(
š™Ën
);

93 ià(
ty³
 =ğ
SDS_TYPE_5
 && 
š™Ën
 =ğ0èty³ = 
SDS_TYPE_8
;

95 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

96 *
å
;

98 
sh
 = 
	`s_m®loc
(
hd¾’
+
š™Ën
+1);

99 ià(!
š™
)

100 
	`mem£t
(
sh
, 0, 
hd¾’
+
š™Ën
+1);

101 ià(
sh
 =ğ
NULL
)  NULL;

103 
s
 = (*)
sh
+
hd¾’
;

105 
å
 = ((*)
s
)-1;

107 
ty³
) {

108 
SDS_TYPE_5
: {

109 *
å
 = 
ty³
 | (
š™Ën
 << 
SDS_TYPE_BITS
);

112 
SDS_TYPE_8
: {

113 
	`SDS_HDR_VAR
(8,
s
);

114 
sh
->
Ën
 = 
š™Ën
;

115 
sh
->
®loc
 = 
š™Ën
;

116 *
å
 = 
ty³
;

119 
SDS_TYPE_16
: {

120 
	`SDS_HDR_VAR
(16,
s
);

121 
sh
->
Ën
 = 
š™Ën
;

122 
sh
->
®loc
 = 
š™Ën
;

123 *
å
 = 
ty³
;

126 
SDS_TYPE_32
: {

127 
	`SDS_HDR_VAR
(32,
s
);

128 
sh
->
Ën
 = 
š™Ën
;

129 
sh
->
®loc
 = 
š™Ën
;

130 *
å
 = 
ty³
;

133 
SDS_TYPE_64
: {

134 
	`SDS_HDR_VAR
(64,
s
);

135 
sh
->
Ën
 = 
š™Ën
;

136 
sh
->
®loc
 = 
š™Ën
;

137 *
å
 = 
ty³
;

142 ià(
š™Ën
 && 
š™
)

143 
	`memıy
(
s
, 
š™
, 
š™Ën
);

144 
s
[
š™Ën
] = '\0';

145  
s
;

146 
	}
}

151 
sds
 
	$sd£m±y
() {

152  
	`sd¢ewËn
("",0);

153 
	}
}

157 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

158 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

159  
	`sd¢ewËn
(
š™
, 
š™Ën
);

160 
	}
}

164 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

165  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

166 
	}
}

170 
	$sdsä“
(
sds
 
s
) {

171 ià(
s
 =ğ
NULL
) ;

172 
	`s_ä“
((*)
s
-
	`sdsHdrSize
(s[-1]));

173 
	}
}

190 
	$sdsupd©–’
(
sds
 
s
) {

191 
»®Ën
 = 
	`¡¾’
(
s
);

192 
	`sds£’
(
s
, 
»®Ën
);

193 
	}
}

200 
	$sdsş—r
(
sds
 
s
) {

201 
	`sds£’
(
s
, 0);

202 
s
[0] = '\0';

203 
	}
}

212 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

213 *
sh
, *
Ãwsh
;

215 
size_t
 
ava
 = 
	`sd§va
(
s
);

216 
size_t
 
Ën
, 
ÃwËn
;

217 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

218 
hd¾’
;

222 ià(
ava
 >ğ
addËn
è 
s
;

225 
Ën
 = 
	`sd¦’
(
s
);

227 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

229 
ÃwËn
 = (
Ën
+
addËn
);

231 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

232 
ÃwËn
 *= 2;

234 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

237 
ty³
 = 
	`sdsReqTy³
(
ÃwËn
);

243 ià(
ty³
 =ğ
SDS_TYPE_5
èty³ = 
SDS_TYPE_8
;

246 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

248 ià(
Şdty³
==
ty³
) {

249 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
ÃwËn
+1);

250 ià(
Ãwsh
 =ğ
NULL
)  NULL;

251 
s
 = (*)
Ãwsh
+
hd¾’
;

255 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
ÃwËn
+1);

256 ià(
Ãwsh
 =ğ
NULL
)  NULL;

258 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

260 
	`s_ä“
(
sh
);

262 
s
 = (*)
Ãwsh
+
hd¾’
;

263 
s
[-1] = 
ty³
;

264 
	`sds£’
(
s
, 
Ën
);

267 
	`sds£Îoc
(
s
, 
ÃwËn
);

268  
s
;

269 
	}
}

278 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

280 *
sh
, *
Ãwsh
;

281 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

282 
hd¾’
;

283 
size_t
 
Ën
 = 
	`sd¦’
(
s
);

285 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

287 
ty³
 = 
	`sdsReqTy³
(
Ën
);

289 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

291 ià(
Şdty³
==
ty³
) {

292 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
Ën
+1);

293 ià(
Ãwsh
 =ğ
NULL
)  NULL;

294 
s
 = (*)
Ãwsh
+
hd¾’
;

296 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
Ën
+1);

297 ià(
Ãwsh
 =ğ
NULL
)  NULL;

298 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

299 
	`s_ä“
(
sh
);

300 
s
 = (*)
Ãwsh
+
hd¾’
;

301 
s
[-1] = 
ty³
;

302 
	`sds£’
(
s
, 
Ën
);

304 
	`sds£Îoc
(
s
, 
Ën
);

305  
s
;

306 
	}
}

316 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

317 
size_t
 
®loc
 = 
	`sd§Îoc
(
s
);

318  
	`sdsHdrSize
(
s
[-1])+
®loc
+1;

319 
	}
}

324 *
	$sdsAÎocPŒ
(
sds
 
s
) {

325  (*è(
s
-
	`sdsHdrSize
(s[-1]));

326 
	}
}

352 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

353 
æags
 = 
s
[-1];

354 
size_t
 
Ën
;

356 
æags
&
SDS_TYPE_MASK
) {

357 
SDS_TYPE_5
: {

358 *
å
 = ((*)
s
)-1;

359 
ŞdËn
 = 
	`SDS_TYPE_5_LEN
(
æags
);

360 
	`as£¹
((
šü
 > 0 && 
ŞdËn
+incr < 32) || (incr < 0 && oldlen >= ()(-incr)));

361 *
å
 = 
SDS_TYPE_5
 | ((
ŞdËn
+
šü
è<< 
SDS_TYPE_BITS
);

362 
Ën
 = 
ŞdËn
+
šü
;

365 
SDS_TYPE_8
: {

366 
	`SDS_HDR_VAR
(8,
s
);

367 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

368 
Ën
 = (
sh
->ËÀ+ğ
šü
);

371 
SDS_TYPE_16
: {

372 
	`SDS_HDR_VAR
(16,
s
);

373 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

374 
Ën
 = (
sh
->ËÀ+ğ
šü
);

377 
SDS_TYPE_32
: {

378 
	`SDS_HDR_VAR
(32,
s
);

379 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= ()incr) || (incr < 0 && sh->len >= ()(-incr)));

380 
Ën
 = (
sh
->ËÀ+ğ
šü
);

383 
SDS_TYPE_64
: {

384 
	`SDS_HDR_VAR
(64,
s
);

385 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >ğ(
ušt64_t
)incr) || (incr < 0 && sh->len >= (uint64_t)(-incr)));

386 
Ën
 = (
sh
->ËÀ+ğ
šü
);

389 : 
Ën
 = 0;

391 
s
[
Ën
] = '\0';

392 
	}
}

400 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

401 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

403 ià(
Ën
 <ğ
cu¾’
è 
s
;

404 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

405 ià(
s
 =ğ
NULL
)  NULL;

408 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

409 
	`sds£’
(
s
, 
Ën
);

410  
s
;

411 
	}
}

419 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

420 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

422 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

423 ià(
s
 =ğ
NULL
)  NULL;

424 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

425 
	`sds£’
(
s
, 
cu¾’
+
Ën
);

426 
s
[
cu¾’
+
Ën
] = '\0';

427  
s
;

428 
	}
}

435 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

436  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

437 
	}
}

444 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

445  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

446 
	}
}

451 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

452 ià(
	`sd§Îoc
(
s
è< 
Ën
) {

453 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
	`sd¦’
(s));

454 ià(
s
 =ğ
NULL
)  NULL;

456 
	`memıy
(
s
, 
t
, 
Ën
);

457 
s
[
Ën
] = '\0';

458 
	`sds£’
(
s
, 
Ën
);

459  
s
;

460 
	}
}

465 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

466  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

467 
	}
}

475 
	#SDS_LLSTR_SIZE
 21

	)

477 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

478 *
p
, 
aux
;

479 
v
;

480 
size_t
 
l
;

485 
v
 = (
v®ue
 < 0) ? -value : value;

487 
p
 = 
s
;

489 *
p
++ = '0'+(
v
%10);

490 
v
 /= 10;

491 } 
v
);

492 ià(
v®ue
 < 0è*
p
++ = '-';

496 
l
 = 
p
-
s
;

497 *
p
 = '\0';

500 
p
--;

501 
s
 < 
p
) {

502 
aux
 = *
s
;

503 *
s
 = *
p
;

504 *
p
 = 
aux
;

505 
s
++;

506 
p
--;

508  
l
;

509 
	}
}

513 
	$sdsuÎ2¡r
(*
s
, 
v
) {

514 *
p
, 
aux
;

515 
size_t
 
l
;

519 
p
 = 
s
;

521 *
p
++ = '0'+(
v
%10);

522 
v
 /= 10;

523 } 
v
);

526 
l
 = 
p
-
s
;

527 *
p
 = '\0';

530 
p
--;

531 
s
 < 
p
) {

532 
aux
 = *
s
;

533 *
s
 = *
p
;

534 *
p
 = 
aux
;

535 
s
++;

536 
p
--;

538  
l
;

539 
	}
}

546 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

547 
buf
[
SDS_LLSTR_SIZE
];

548 
Ën
 = 
	`sd¦l2¡r
(
buf
,
v®ue
);

550  
	`sd¢ewËn
(
buf
,
Ën
);

551 
	}
}

555 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

556 
va_li¡
 
ıy
;

557 
¡©icbuf
[1024], *
buf
 = sticbuf, *
t
;

558 
size_t
 
buæ’
 = 
	`¡¾’
(
fmt
)*2;

562 ià(
buæ’
 > (
¡©icbuf
)) {

563 
buf
 = 
	`s_m®loc
(
buæ’
);

564 ià(
buf
 =ğ
NULL
)  NULL;

566 
buæ’
 = (
¡©icbuf
);

572 
buf
[
buæ’
-2] = '\0';

573 
	`va_cİy
(
ıy
,
­
);

574 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

575 
	`va_’d
(
ıy
);

576 ià(
buf
[
buæ’
-2] != '\0') {

577 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

578 
buæ’
 *= 2;

579 
buf
 = 
	`s_m®loc
(
buæ’
);

580 ià(
buf
 =ğ
NULL
)  NULL;

587 
t
 = 
	`sdsÿt
(
s
, 
buf
);

588 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

589  
t
;

590 
	}
}

609 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

610 
va_li¡
 
­
;

611 *
t
;

612 
	`va_¡¬t
(
­
, 
fmt
);

613 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

614 
	`va_’d
(
­
);

615  
t
;

616 
	}
}

635 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

636 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

637 cÚ¡ *
f
 = 
fmt
;

638 
i
;

639 
va_li¡
 
­
;

641 
	`va_¡¬t
(
­
,
fmt
);

642 
f
 = 
fmt
;

643 
i
 = 
š™Ën
;

644 *
f
) {

645 
Ãxt
, *
¡r
;

646 
size_t
 
l
;

647 
num
;

648 
unum
;

651 ià(
	`sd§va
(
s
)==0) {

652 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

655 *
f
) {

657 
Ãxt
 = *(
f
+1);

658 
f
++;

659 
Ãxt
) {

662 
¡r
 = 
	`va_¬g
(
­
,*);

663 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

664 ià(
	`sd§va
(
s
è< 
l
) {

665 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

667 
	`memıy
(
s
+
i
,
¡r
,
l
);

668 
	`sdsšş’
(
s
,
l
);

669 
i
 +ğ
l
;

673 ià(
Ãxt
 == 'i')

674 
num
 = 
	`va_¬g
(
­
,);

676 
num
 = 
	`va_¬g
(
­
,);

678 
buf
[
SDS_LLSTR_SIZE
];

679 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

680 ià(
	`sd§va
(
s
è< 
l
) {

681 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

683 
	`memıy
(
s
+
i
,
buf
,
l
);

684 
	`sdsšş’
(
s
,
l
);

685 
i
 +ğ
l
;

690 ià(
Ãxt
 == 'u')

691 
unum
 = 
	`va_¬g
(
­
,);

693 
unum
 = 
	`va_¬g
(
­
,);

695 
buf
[
SDS_LLSTR_SIZE
];

696 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

697 ià(
	`sd§va
(
s
è< 
l
) {

698 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

700 
	`memıy
(
s
+
i
,
buf
,
l
);

701 
	`sdsšş’
(
s
,
l
);

702 
i
 +ğ
l
;

706 
s
[
i
++] = 
Ãxt
;

707 
	`sdsšş’
(
s
,1);

712 
s
[
i
++] = *
f
;

713 
	`sdsšş’
(
s
,1);

716 
f
++;

718 
	`va_’d
(
­
);

721 
s
[
i
] = '\0';

722  
s
;

723 
	}
}

740 
sds
 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

741 *
¡¬t
, *
’d
, *
¥
, *
•
;

742 
size_t
 
Ën
;

744 
¥
 = 
¡¬t
 = 
s
;

745 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

746 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

747 
•
 > 
¥
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

748 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

749 ià(
s
 !ğ
¥
è
	`memmove
(s, sp, 
Ën
);

750 
s
[
Ën
] = '\0';

751 
	`sds£’
(
s
,
Ën
);

752  
s
;

753 
	}
}

772 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

773 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

775 ià(
Ën
 == 0) ;

776 ià(
¡¬t
 < 0) {

777 
¡¬t
 = 
Ën
+start;

778 ià(
¡¬t
 < 0) start = 0;

780 ià(
’d
 < 0) {

781 
’d
 = 
Ën
+end;

782 ià(
’d
 < 0)ƒnd = 0;

784 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

785 ià(
ÃwËn
 != 0) {

786 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

787 
ÃwËn
 = 0;

788 } ià(
’d
 >ğ(sigÃd)
Ën
) {

789 
’d
 = 
Ën
-1;

790 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

793 
¡¬t
 = 0;

795 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
s
, s+start,‚ewlen);

796 
s
[
ÃwËn
] = 0;

797 
	`sds£’
(
s
,
ÃwËn
);

798 
	}
}

802 
	$sd¡Şow”
(
sds
 
s
) {

803 
Ën
 = 
	`sd¦’
(
s
), 
j
;

805 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

806 
	}
}

810 
	$sd¡ouµ”
(
sds
 
s
) {

811 
Ën
 = 
	`sd¦’
(
s
), 
j
;

813 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

814 
	}
}

828 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

829 
size_t
 
l1
, 
l2
, 
mšËn
;

830 
cmp
;

832 
l1
 = 
	`sd¦’
(
s1
);

833 
l2
 = 
	`sd¦’
(
s2
);

834 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

835 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

836 ià(
cmp
 =ğ0è 
l1
-
l2
;

837  
cmp
;

838 
	}
}

857 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

858 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

859 
sds
 *
tok’s
;

861 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

864 
tok’s
 = 
	`s_m®loc
((
sds
)*
¦Ùs
);

865 ià(
tok’s
 =ğ
NULL
)  NULL;

867 ià(
Ën
 == 0) {

868 *
couÁ
 = 0;

869  
tok’s
;

871 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

874 ià(
¦Ùs
 < 
–em’ts
+2) {

875 
sds
 *
Ãwtok’s
;

877 
¦Ùs
 *= 2;

878 
Ãwtok’s
 = 
	`s_»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

879 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

880 
tok’s
 = 
Ãwtok’s
;

884 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

885 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

886 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

887 
–em’ts
++;

888 
¡¬t
 = 
j
+
£¶’
;

889 
j
 = j+
£¶’
-1;

893 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

894 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

895 
–em’ts
++;

896 *
couÁ
 = 
–em’ts
;

897  
tok’s
;

899 
ş—nup
:

901 
i
;

902 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

903 
	`s_ä“
(
tok’s
);

904 *
couÁ
 = 0;

905  
NULL
;

907 
	}
}

911 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

912 ià(!
tok’s
) ;

913 
couÁ
--)

914 
	`sdsä“
(
tok’s
[
couÁ
]);

915 
	`s_ä“
(
tok’s
);

916 
	}
}

926 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

929 
s
 = 
	`sdsÿ’
(s,"\"",1);

931 
Ën
--) {

932 *
p
) {

935 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

937 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

938 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

939 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

940 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

941 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

943 ià(
	`i¥ršt
(*
p
))

944 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

946 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

949 
p
++;

951  
	`sdsÿ’
(
s
,"\"",1);

952 
	}
}

957 
	$is_hex_dig™
(
c
) {

958  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

959 (
c
 >= 'A' && c <= 'F');

960 
	}
}

965 
	$hex_dig™_to_št
(
c
) {

966 
c
) {

985 
	}
}

1007 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

1008 cÚ¡ *
p
 = 
lše
;

1009 *
cu¼’t
 = 
NULL
;

1010 **
veùÜ
 = 
NULL
;

1012 *
¬gc
 = 0;

1016 *
p
 && 
	`is¥aû
(*p))…++;

1017 ià(*
p
) {

1019 
šq
=0;

1020 
šsq
=0;

1021 
dÚe
=0;

1023 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

1024 !
dÚe
) {

1025 ià(
šq
) {

1026 ià(*
p
 == '\\' && *(p+1) == 'x' &&

1027 
	`is_hex_dig™
(*(
p
+2)) &&

1028 
	`is_hex_dig™
(*(
p
+3)))

1030 
by‹
;

1032 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

1033 
	`hex_dig™_to_št
(*(
p
+3));

1034 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

1035 
p
 += 3;

1036 } ià(*
p
 == '\\' && *(p+1)) {

1037 
c
;

1039 
p
++;

1040 *
p
) {

1041 'n': 
c
 = '\n'; ;

1042 'r': 
c
 = '\r'; ;

1043 't': 
c
 = '\t'; ;

1044 'b': 
c
 = '\b'; ;

1045 'a': 
c
 = '\a'; ;

1046 : 
c
 = *
p
; ;

1048 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

1049 } ià(*
p
 == '"') {

1052 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

1053 
dÚe
=1;

1054 } ià(!*
p
) {

1056 
”r
;

1058 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1060 } ià(
šsq
) {

1061 ià(*
p
 == '\\' && *(p+1) == '\'') {

1062 
p
++;

1063 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

1064 } ià(*
p
 == '\'') {

1067 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

1068 
dÚe
=1;

1069 } ià(!*
p
) {

1071 
”r
;

1073 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1076 *
p
) {

1082 
dÚe
=1;

1085 
šq
=1;

1088 
šsq
=1;

1091 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1095 ià(*
p
)…++;

1098 
veùÜ
 = 
	`s_»®loc
(veùÜ,((*
¬gc
)+1)*(*));

1099 
veùÜ
[*
¬gc
] = 
cu¼’t
;

1100 (*
¬gc
)++;

1101 
cu¼’t
 = 
NULL
;

1104 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`s_m®loc
((*));

1105  
veùÜ
;

1109 
”r
:

1110 (*
¬gc
)--)

1111 
	`sdsä“
(
veùÜ
[*
¬gc
]);

1112 
	`s_ä“
(
veùÜ
);

1113 ià(
cu¼’t
è
	`sdsä“
(current);

1114 *
¬gc
 = 0;

1115  
NULL
;

1116 
	}
}

1128 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

1129 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

1131 
j
 = 0; j < 
l
; j++) {

1132 
i
 = 0; i < 
£’
; i++) {

1133 ià(
s
[
j
] =ğ
äom
[
i
]) {

1134 
s
[
j
] = 
to
[
i
];

1139  
s
;

1140 
	}
}

1145 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
) {

1146 
sds
 
još
 = 
	`sd£m±y
();

1147 
j
;

1149 
j
 = 0; j < 
¬gc
; j++) {

1150 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

1151 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿt
(još,
£p
);

1153  
još
;

1154 
	}
}

1158 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

1159 
sds
 
još
 = 
	`sd£m±y
();

1160 
j
;

1162 
j
 = 0; j < 
¬gc
; j++) {

1163 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

1164 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

1166  
još
;

1167 
	}
}

1170 
	$sdsIsNum
(
sds
 
s
) {

1171 
size_t
 
i
;

1173 ià(
s
 =ğ
NULL
 || 
	`sd¦’
(s) == 0) {

1177 
i
 = 0; i < 
	`sd¦’
(
s
); i ++) {

1178 if(*(
s
+
i
) < '0' || *(s+i) > '9'){

1184 
	}
}

1191 *
	$sds_m®loc
(
size_t
 
size
è{  
	`s_m®loc
(size); 
	}
}

1192 *
	$sds_»®loc
(*
±r
, 
size_t
 
size
è{  
	`s_»®loc
ÕŒ,size); 
	}
}

1193 
	$sds_ä“
(*
±r
è{ 
	`s_ä“
ÕŒ); 
	}
}

1195 #ià
defšed
(
SDS_TEST_MAIN
)

1196 
	~<¡dio.h
>

1197 
	~"‹¡h–p.h
"

1198 
	~"lim™s.h
"

1200 
	#UNUSED
(
x
è()(x)

	)

1202 
	$sdsTe¡
() {

1204 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

1206 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

1207 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

1209 
	`sdsä“
(
x
);

1210 
x
 = 
	`sd¢ewËn
("foo",2);

1211 
	`‹¡_cÚd
("Create‡ string with specified†ength",

1212 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

1214 
x
 = 
	`sdsÿt
(x,"bar");

1215 
	`‹¡_cÚd
("Strings concatenation",

1216 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

1218 
x
 = 
	`sdsıy
(x,"a");

1219 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

1220 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

1222 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

1223 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1224 
	`sd¦’
(
x
) == 33 &&

1225 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1227 
	`sdsä“
(
x
);

1228 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1229 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1230 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) == 0)

1232 
	`sdsä“
(
x
);

1233 
x
 = 
	`sd¢ew
("--");

1234 
x
 = 
	`sdsÿtfmt
(x, "H–lØ% WÜld %I,%I--", "Hi!", 
LLONG_MIN
,
LLONG_MAX
);

1235 
	`‹¡_cÚd
("sdscatfmt() seems working inhe base case",

1236 
	`sd¦’
(
x
) == 60 &&

1237 
	`memcmp
(
x
,"--Hello Hi! World -9223372036854775808,"

1239 
	`´štf
("[%s]\n",
x
);

1241 
	`sdsä“
(
x
);

1242 
x
 = 
	`sd¢ew
("--");

1243 
x
 = 
	`sdsÿtfmt
(x, "%u,%U--", 
UINT_MAX
, 
ULLONG_MAX
);

1244 
	`‹¡_cÚd
("sdscatfmt() seems working with unsigned‚umbers",

1245 
	`sd¦’
(
x
) == 35 &&

1246 
	`memcmp
(
x
,"--4294967295,18446744073709551615--",35) == 0)

1248 
	`sdsä“
(
x
);

1249 
x
 = 
	`sd¢ew
(" x ");

1250 
	`sd¡rim
(
x
," x");

1251 
	`‹¡_cÚd
("sdstrim() works when‡ll chars match",

1252 
	`sd¦’
(
x
) == 0)

1254 
	`sdsä“
(
x
);

1255 
x
 = 
	`sd¢ew
(" x ");

1256 
	`sd¡rim
(
x
," ");

1257 
	`‹¡_cÚd
("sdstrim() works when‡ single char„emains",

1258 
	`sd¦’
(
x
) == 1 && x[0] == 'x')

1260 
	`sdsä“
(
x
);

1261 
x
 = 
	`sd¢ew
("xxciaoyyy");

1262 
	`sd¡rim
(
x
,"xy");

1263 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1264 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1266 
y
 = 
	`sdsdup
(
x
);

1267 
	`sd¤ªge
(
y
,1,1);

1268 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1269 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1271 
	`sdsä“
(
y
);

1272 
y
 = 
	`sdsdup
(
x
);

1273 
	`sd¤ªge
(
y
,1,-1);

1274 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1275 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1277 
	`sdsä“
(
y
);

1278 
y
 = 
	`sdsdup
(
x
);

1279 
	`sd¤ªge
(
y
,-2,-1);

1280 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1281 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1283 
	`sdsä“
(
y
);

1284 
y
 = 
	`sdsdup
(
x
);

1285 
	`sd¤ªge
(
y
,2,1);

1286 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1287 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1289 
	`sdsä“
(
y
);

1290 
y
 = 
	`sdsdup
(
x
);

1291 
	`sd¤ªge
(
y
,1,100);

1292 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1293 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1295 
	`sdsä“
(
y
);

1296 
y
 = 
	`sdsdup
(
x
);

1297 
	`sd¤ªge
(
y
,100,100);

1298 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1299 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1301 
	`sdsä“
(
y
);

1302 
	`sdsä“
(
x
);

1303 
x
 = 
	`sd¢ew
("foo");

1304 
y
 = 
	`sd¢ew
("foa");

1305 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1307 
	`sdsä“
(
y
);

1308 
	`sdsä“
(
x
);

1309 
x
 = 
	`sd¢ew
("bar");

1310 
y
 = 
	`sd¢ew
("bar");

1311 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1313 
	`sdsä“
(
y
);

1314 
	`sdsä“
(
x
);

1315 
x
 = 
	`sd¢ew
("aar");

1316 
y
 = 
	`sd¢ew
("bar");

1317 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1319 
	`sdsä“
(
y
);

1320 
	`sdsä“
(
x
);

1321 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1322 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1323 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1324 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1327 
Şdä“
;

1328 *
p
;

1329 
¡•
 = 10, 
j
, 
i
;

1331 
	`sdsä“
(
x
);

1332 
	`sdsä“
(
y
);

1333 
x
 = 
	`sd¢ew
("0");

1334 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
	`sd¦’
(
x
è=ğ1 && 
	`sd§va
(x) == 0);

1338 
i
 = 0; i < 10; i++) {

1339 
ŞdËn
 = 
	`sd¦’
(
x
);

1340 
x
 = 
	`sdsMakeRoomFÜ
(x,
¡•
);

1341 
ty³
 = 
x
[-1]&
SDS_TYPE_MASK
;

1343 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èËn", 
	`sd¦’
(
x
è=ğ
ŞdËn
);

1344 ià(
ty³
 !ğ
SDS_TYPE_5
) {

1345 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èä“", 
	`sd§va
(
x
è>ğ
¡•
);

1346 
Şdä“
 = 
	`sd§va
(
x
);

1348 
p
 = 
x
+
ŞdËn
;

1349 
j
 = 0; j < 
¡•
; j++) {

1350 
p
[
j
] = 'A'+j;

1352 
	`sdsInüL’
(
x
,
¡•
);

1354 
	`‹¡_cÚd
("sdsMakeRoomFor() content",

1355 
	`memcmp
("0ABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJ",
x
,101) == 0);

1356 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èfš®†’gth",
	`sd¦’
(
x
)==101);

1358 
	`sdsä“
(
x
);

1361 
	`‹¡_»pÜt
()

1363 
	}
}

1366 #ifdeà
SDS_TEST_MAIN


1367 
	$maš
() {

1368  
	`sdsTe¡
();

1369 
	}
}

	@dep/sds/sds.c

33 
	~<¡dio.h
>

34 
	~<¡dlib.h
>

35 
	~<¡ršg.h
>

36 
	~<ùy³.h
>

37 
	~<as£¹.h
>

39 
	~<sds.h
>

40 
	~<sd§Îoc.h
>

43 
šlše
 
	$sdsHdrSize
(
ty³
) {

44 
ty³
&
SDS_TYPE_MASK
) {

45 
SDS_TYPE_5
:

46  (
sdshdr5
);

47 
SDS_TYPE_8
:

48  (
sdshdr8
);

49 
SDS_TYPE_16
:

50  (
sdshdr16
);

51 
SDS_TYPE_32
:

52  (
sdshdr32
);

53 
SDS_TYPE_64
:

54  (
sdshdr64
);

57 
	}
}

60 
šlše
 
	$sdsReqTy³
(
size_t
 
¡ršg_size
) {

61 ià(
¡ršg_size
 < 32)

62  
SDS_TYPE_5
;

63 ià(
¡ršg_size
 < 0xff)

64  
SDS_TYPE_8
;

65 ià(
¡ršg_size
 < 0xffff)

66  
SDS_TYPE_16
;

67 ià(
¡ršg_size
 < 0xffffffff)

68  
SDS_TYPE_32
;

69  
SDS_TYPE_64
;

70 
	}
}

85 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

86 *
sh
;

87 
sds
 
s
;

89 
ty³
 = 
	`sdsReqTy³
(
š™Ën
);

93 ià(
ty³
 =ğ
SDS_TYPE_5
 && 
š™Ën
 =ğ0èty³ = 
SDS_TYPE_8
;

95 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

96 *
å
;

98 
sh
 = 
	`s_m®loc
(
hd¾’
+
š™Ën
+1);

99 ià(!
š™
)

100 
	`mem£t
(
sh
, 0, 
hd¾’
+
š™Ën
+1);

101 ià(
sh
 =ğ
NULL
)  NULL;

103 
s
 = (*)
sh
+
hd¾’
;

105 
å
 = ((*)
s
)-1;

107 
ty³
) {

108 
SDS_TYPE_5
: {

109 *
å
 = 
ty³
 | (
š™Ën
 << 
SDS_TYPE_BITS
);

112 
SDS_TYPE_8
: {

113 
	`SDS_HDR_VAR
(8,
s
);

114 
sh
->
Ën
 = 
š™Ën
;

115 
sh
->
®loc
 = 
š™Ën
;

116 *
å
 = 
ty³
;

119 
SDS_TYPE_16
: {

120 
	`SDS_HDR_VAR
(16,
s
);

121 
sh
->
Ën
 = 
š™Ën
;

122 
sh
->
®loc
 = 
š™Ën
;

123 *
å
 = 
ty³
;

126 
SDS_TYPE_32
: {

127 
	`SDS_HDR_VAR
(32,
s
);

128 
sh
->
Ën
 = 
š™Ën
;

129 
sh
->
®loc
 = 
š™Ën
;

130 *
å
 = 
ty³
;

133 
SDS_TYPE_64
: {

134 
	`SDS_HDR_VAR
(64,
s
);

135 
sh
->
Ën
 = 
š™Ën
;

136 
sh
->
®loc
 = 
š™Ën
;

137 *
å
 = 
ty³
;

142 ià(
š™Ën
 && 
š™
)

143 
	`memıy
(
s
, 
š™
, 
š™Ën
);

144 
s
[
š™Ën
] = '\0';

145  
s
;

146 
	}
}

151 
sds
 
	$sd£m±y
() {

152  
	`sd¢ewËn
("",0);

153 
	}
}

157 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

158 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

159  
	`sd¢ewËn
(
š™
, 
š™Ën
);

160 
	}
}

164 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

165  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

166 
	}
}

170 
	$sdsä“
(
sds
 
s
) {

171 ià(
s
 =ğ
NULL
) ;

172 
	`s_ä“
((*)
s
-
	`sdsHdrSize
(s[-1]));

173 
	}
}

190 
	$sdsupd©–’
(
sds
 
s
) {

191 
»®Ën
 = 
	`¡¾’
(
s
);

192 
	`sds£’
(
s
, 
»®Ën
);

193 
	}
}

200 
	$sdsş—r
(
sds
 
s
) {

201 
	`sds£’
(
s
, 0);

202 
s
[0] = '\0';

203 
	}
}

212 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

213 *
sh
, *
Ãwsh
;

215 
size_t
 
ava
 = 
	`sd§va
(
s
);

216 
size_t
 
Ën
, 
ÃwËn
;

217 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

218 
hd¾’
;

222 ià(
ava
 >ğ
addËn
è 
s
;

225 
Ën
 = 
	`sd¦’
(
s
);

227 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

229 
ÃwËn
 = (
Ën
+
addËn
);

231 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

232 
ÃwËn
 *= 2;

234 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

237 
ty³
 = 
	`sdsReqTy³
(
ÃwËn
);

243 ià(
ty³
 =ğ
SDS_TYPE_5
èty³ = 
SDS_TYPE_8
;

246 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

248 ià(
Şdty³
==
ty³
) {

249 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
ÃwËn
+1);

250 ià(
Ãwsh
 =ğ
NULL
)  NULL;

251 
s
 = (*)
Ãwsh
+
hd¾’
;

255 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
ÃwËn
+1);

256 ià(
Ãwsh
 =ğ
NULL
)  NULL;

258 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

260 
	`s_ä“
(
sh
);

262 
s
 = (*)
Ãwsh
+
hd¾’
;

263 
s
[-1] = 
ty³
;

264 
	`sds£’
(
s
, 
Ën
);

267 
	`sds£Îoc
(
s
, 
ÃwËn
);

268  
s
;

269 
	}
}

278 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

280 *
sh
, *
Ãwsh
;

281 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

282 
hd¾’
;

283 
size_t
 
Ën
 = 
	`sd¦’
(
s
);

285 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

287 
ty³
 = 
	`sdsReqTy³
(
Ën
);

289 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

291 ià(
Şdty³
==
ty³
) {

292 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
Ën
+1);

293 ià(
Ãwsh
 =ğ
NULL
)  NULL;

294 
s
 = (*)
Ãwsh
+
hd¾’
;

296 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
Ën
+1);

297 ià(
Ãwsh
 =ğ
NULL
)  NULL;

298 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

299 
	`s_ä“
(
sh
);

300 
s
 = (*)
Ãwsh
+
hd¾’
;

301 
s
[-1] = 
ty³
;

302 
	`sds£’
(
s
, 
Ën
);

304 
	`sds£Îoc
(
s
, 
Ën
);

305  
s
;

306 
	}
}

316 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

317 
size_t
 
®loc
 = 
	`sd§Îoc
(
s
);

318  
	`sdsHdrSize
(
s
[-1])+
®loc
+1;

319 
	}
}

324 *
	$sdsAÎocPŒ
(
sds
 
s
) {

325  (*è(
s
-
	`sdsHdrSize
(s[-1]));

326 
	}
}

352 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

353 
æags
 = 
s
[-1];

354 
size_t
 
Ën
;

356 
æags
&
SDS_TYPE_MASK
) {

357 
SDS_TYPE_5
: {

358 *
å
 = ((*)
s
)-1;

359 
ŞdËn
 = 
	`SDS_TYPE_5_LEN
(
æags
);

360 
	`as£¹
((
šü
 > 0 && 
ŞdËn
+incr < 32) || (incr < 0 && oldlen >= ()(-incr)));

361 *
å
 = 
SDS_TYPE_5
 | ((
ŞdËn
+
šü
è<< 
SDS_TYPE_BITS
);

362 
Ën
 = 
ŞdËn
+
šü
;

365 
SDS_TYPE_8
: {

366 
	`SDS_HDR_VAR
(8,
s
);

367 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

368 
Ën
 = (
sh
->ËÀ+ğ
šü
);

371 
SDS_TYPE_16
: {

372 
	`SDS_HDR_VAR
(16,
s
);

373 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

374 
Ën
 = (
sh
->ËÀ+ğ
šü
);

377 
SDS_TYPE_32
: {

378 
	`SDS_HDR_VAR
(32,
s
);

379 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= ()incr) || (incr < 0 && sh->len >= ()(-incr)));

380 
Ën
 = (
sh
->ËÀ+ğ
šü
);

383 
SDS_TYPE_64
: {

384 
	`SDS_HDR_VAR
(64,
s
);

385 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >ğ(
ušt64_t
)incr) || (incr < 0 && sh->len >= (uint64_t)(-incr)));

386 
Ën
 = (
sh
->ËÀ+ğ
šü
);

389 : 
Ën
 = 0;

391 
s
[
Ën
] = '\0';

392 
	}
}

400 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

401 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

403 ià(
Ën
 <ğ
cu¾’
è 
s
;

404 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

405 ià(
s
 =ğ
NULL
)  NULL;

408 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

409 
	`sds£’
(
s
, 
Ën
);

410  
s
;

411 
	}
}

419 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

420 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

422 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

423 ià(
s
 =ğ
NULL
)  NULL;

424 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

425 
	`sds£’
(
s
, 
cu¾’
+
Ën
);

426 
s
[
cu¾’
+
Ën
] = '\0';

427  
s
;

428 
	}
}

435 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

436  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

437 
	}
}

444 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

445  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

446 
	}
}

451 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

452 ià(
	`sd§Îoc
(
s
è< 
Ën
) {

453 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
	`sd¦’
(s));

454 ià(
s
 =ğ
NULL
)  NULL;

456 
	`memıy
(
s
, 
t
, 
Ën
);

457 
s
[
Ën
] = '\0';

458 
	`sds£’
(
s
, 
Ën
);

459  
s
;

460 
	}
}

465 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

466  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

467 
	}
}

475 
	#SDS_LLSTR_SIZE
 21

	)

477 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

478 *
p
, 
aux
;

479 
v
;

480 
size_t
 
l
;

485 
v
 = (
v®ue
 < 0) ? -value : value;

487 
p
 = 
s
;

489 *
p
++ = '0'+(
v
%10);

490 
v
 /= 10;

491 } 
v
);

492 ià(
v®ue
 < 0è*
p
++ = '-';

496 
l
 = 
p
-
s
;

497 *
p
 = '\0';

500 
p
--;

501 
s
 < 
p
) {

502 
aux
 = *
s
;

503 *
s
 = *
p
;

504 *
p
 = 
aux
;

505 
s
++;

506 
p
--;

508  
l
;

509 
	}
}

513 
	$sdsuÎ2¡r
(*
s
, 
v
) {

514 *
p
, 
aux
;

515 
size_t
 
l
;

519 
p
 = 
s
;

521 *
p
++ = '0'+(
v
%10);

522 
v
 /= 10;

523 } 
v
);

526 
l
 = 
p
-
s
;

527 *
p
 = '\0';

530 
p
--;

531 
s
 < 
p
) {

532 
aux
 = *
s
;

533 *
s
 = *
p
;

534 *
p
 = 
aux
;

535 
s
++;

536 
p
--;

538  
l
;

539 
	}
}

546 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

547 
buf
[
SDS_LLSTR_SIZE
];

548 
Ën
 = 
	`sd¦l2¡r
(
buf
,
v®ue
);

550  
	`sd¢ewËn
(
buf
,
Ën
);

551 
	}
}

555 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

556 
va_li¡
 
ıy
;

557 
¡©icbuf
[1024], *
buf
 = sticbuf, *
t
;

558 
size_t
 
buæ’
 = 
	`¡¾’
(
fmt
)*2;

562 ià(
buæ’
 > (
¡©icbuf
)) {

563 
buf
 = 
	`s_m®loc
(
buæ’
);

564 ià(
buf
 =ğ
NULL
)  NULL;

566 
buæ’
 = (
¡©icbuf
);

572 
buf
[
buæ’
-2] = '\0';

573 
	`va_cİy
(
ıy
,
­
);

574 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

575 
	`va_’d
(
ıy
);

576 ià(
buf
[
buæ’
-2] != '\0') {

577 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

578 
buæ’
 *= 2;

579 
buf
 = 
	`s_m®loc
(
buæ’
);

580 ià(
buf
 =ğ
NULL
)  NULL;

587 
t
 = 
	`sdsÿt
(
s
, 
buf
);

588 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

589  
t
;

590 
	}
}

609 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

610 
va_li¡
 
­
;

611 *
t
;

612 
	`va_¡¬t
(
­
, 
fmt
);

613 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

614 
	`va_’d
(
­
);

615  
t
;

616 
	}
}

635 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

636 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

637 cÚ¡ *
f
 = 
fmt
;

638 
i
;

639 
va_li¡
 
­
;

641 
	`va_¡¬t
(
­
,
fmt
);

642 
f
 = 
fmt
;

643 
i
 = 
š™Ën
;

644 *
f
) {

645 
Ãxt
, *
¡r
;

646 
size_t
 
l
;

647 
num
;

648 
unum
;

651 ià(
	`sd§va
(
s
)==0) {

652 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

655 *
f
) {

657 
Ãxt
 = *(
f
+1);

658 
f
++;

659 
Ãxt
) {

662 
¡r
 = 
	`va_¬g
(
­
,*);

663 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

664 ià(
	`sd§va
(
s
è< 
l
) {

665 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

667 
	`memıy
(
s
+
i
,
¡r
,
l
);

668 
	`sdsšş’
(
s
,
l
);

669 
i
 +ğ
l
;

673 ià(
Ãxt
 == 'i')

674 
num
 = 
	`va_¬g
(
­
,);

676 
num
 = 
	`va_¬g
(
­
,);

678 
buf
[
SDS_LLSTR_SIZE
];

679 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

680 ià(
	`sd§va
(
s
è< 
l
) {

681 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

683 
	`memıy
(
s
+
i
,
buf
,
l
);

684 
	`sdsšş’
(
s
,
l
);

685 
i
 +ğ
l
;

690 ià(
Ãxt
 == 'u')

691 
unum
 = 
	`va_¬g
(
­
,);

693 
unum
 = 
	`va_¬g
(
­
,);

695 
buf
[
SDS_LLSTR_SIZE
];

696 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

697 ià(
	`sd§va
(
s
è< 
l
) {

698 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

700 
	`memıy
(
s
+
i
,
buf
,
l
);

701 
	`sdsšş’
(
s
,
l
);

702 
i
 +ğ
l
;

706 
s
[
i
++] = 
Ãxt
;

707 
	`sdsšş’
(
s
,1);

712 
s
[
i
++] = *
f
;

713 
	`sdsšş’
(
s
,1);

716 
f
++;

718 
	`va_’d
(
­
);

721 
s
[
i
] = '\0';

722  
s
;

723 
	}
}

740 
sds
 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

741 *
¡¬t
, *
’d
, *
¥
, *
•
;

742 
size_t
 
Ën
;

744 
¥
 = 
¡¬t
 = 
s
;

745 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

746 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

747 
•
 > 
¥
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

748 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

749 ià(
s
 !ğ
¥
è
	`memmove
(s, sp, 
Ën
);

750 
s
[
Ën
] = '\0';

751 
	`sds£’
(
s
,
Ën
);

752  
s
;

753 
	}
}

772 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

773 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

775 ià(
Ën
 == 0) ;

776 ià(
¡¬t
 < 0) {

777 
¡¬t
 = 
Ën
+start;

778 ià(
¡¬t
 < 0) start = 0;

780 ià(
’d
 < 0) {

781 
’d
 = 
Ën
+end;

782 ià(
’d
 < 0)ƒnd = 0;

784 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

785 ià(
ÃwËn
 != 0) {

786 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

787 
ÃwËn
 = 0;

788 } ià(
’d
 >ğ(sigÃd)
Ën
) {

789 
’d
 = 
Ën
-1;

790 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

793 
¡¬t
 = 0;

795 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
s
, s+start,‚ewlen);

796 
s
[
ÃwËn
] = 0;

797 
	`sds£’
(
s
,
ÃwËn
);

798 
	}
}

802 
	$sd¡Şow”
(
sds
 
s
) {

803 
Ën
 = 
	`sd¦’
(
s
), 
j
;

805 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

806 
	}
}

810 
	$sd¡ouµ”
(
sds
 
s
) {

811 
Ën
 = 
	`sd¦’
(
s
), 
j
;

813 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

814 
	}
}

828 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

829 
size_t
 
l1
, 
l2
, 
mšËn
;

830 
cmp
;

832 
l1
 = 
	`sd¦’
(
s1
);

833 
l2
 = 
	`sd¦’
(
s2
);

834 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

835 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

836 ià(
cmp
 =ğ0è 
l1
-
l2
;

837  
cmp
;

838 
	}
}

857 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

858 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

859 
sds
 *
tok’s
;

861 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

864 
tok’s
 = 
	`s_m®loc
((
sds
)*
¦Ùs
);

865 ià(
tok’s
 =ğ
NULL
)  NULL;

867 ià(
Ën
 == 0) {

868 *
couÁ
 = 0;

869  
tok’s
;

871 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

874 ià(
¦Ùs
 < 
–em’ts
+2) {

875 
sds
 *
Ãwtok’s
;

877 
¦Ùs
 *= 2;

878 
Ãwtok’s
 = 
	`s_»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

879 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

880 
tok’s
 = 
Ãwtok’s
;

884 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

885 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

886 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

887 
–em’ts
++;

888 
¡¬t
 = 
j
+
£¶’
;

889 
j
 = j+
£¶’
-1;

893 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

894 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

895 
–em’ts
++;

896 *
couÁ
 = 
–em’ts
;

897  
tok’s
;

899 
ş—nup
:

901 
i
;

902 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

903 
	`s_ä“
(
tok’s
);

904 *
couÁ
 = 0;

905  
NULL
;

907 
	}
}

911 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

912 ià(!
tok’s
) ;

913 
couÁ
--)

914 
	`sdsä“
(
tok’s
[
couÁ
]);

915 
	`s_ä“
(
tok’s
);

916 
	}
}

926 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

929 
s
 = 
	`sdsÿ’
(s,"\"",1);

931 
Ën
--) {

932 *
p
) {

935 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

937 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

938 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

939 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

940 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

941 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

943 ià(
	`i¥ršt
(*
p
))

944 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

946 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

949 
p
++;

951  
	`sdsÿ’
(
s
,"\"",1);

952 
	}
}

957 
	$is_hex_dig™
(
c
) {

958  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

959 (
c
 >= 'A' && c <= 'F');

960 
	}
}

965 
	$hex_dig™_to_št
(
c
) {

966 
c
) {

985 
	}
}

1007 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

1008 cÚ¡ *
p
 = 
lše
;

1009 *
cu¼’t
 = 
NULL
;

1010 **
veùÜ
 = 
NULL
;

1012 *
¬gc
 = 0;

1016 *
p
 && 
	`is¥aû
(*p))…++;

1017 ià(*
p
) {

1019 
šq
=0;

1020 
šsq
=0;

1021 
dÚe
=0;

1023 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

1024 !
dÚe
) {

1025 ià(
šq
) {

1026 ià(*
p
 == '\\' && *(p+1) == 'x' &&

1027 
	`is_hex_dig™
(*(
p
+2)) &&

1028 
	`is_hex_dig™
(*(
p
+3)))

1030 
by‹
;

1032 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

1033 
	`hex_dig™_to_št
(*(
p
+3));

1034 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

1035 
p
 += 3;

1036 } ià(*
p
 == '\\' && *(p+1)) {

1037 
c
;

1039 
p
++;

1040 *
p
) {

1041 'n': 
c
 = '\n'; ;

1042 'r': 
c
 = '\r'; ;

1043 't': 
c
 = '\t'; ;

1044 'b': 
c
 = '\b'; ;

1045 'a': 
c
 = '\a'; ;

1046 : 
c
 = *
p
; ;

1048 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

1049 } ià(*
p
 == '"') {

1052 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

1053 
dÚe
=1;

1054 } ià(!*
p
) {

1056 
”r
;

1058 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1060 } ià(
šsq
) {

1061 ià(*
p
 == '\\' && *(p+1) == '\'') {

1062 
p
++;

1063 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

1064 } ià(*
p
 == '\'') {

1067 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

1068 
dÚe
=1;

1069 } ià(!*
p
) {

1071 
”r
;

1073 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1076 *
p
) {

1082 
dÚe
=1;

1085 
šq
=1;

1088 
šsq
=1;

1091 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1095 ià(*
p
)…++;

1098 
veùÜ
 = 
	`s_»®loc
(veùÜ,((*
¬gc
)+1)*(*));

1099 
veùÜ
[*
¬gc
] = 
cu¼’t
;

1100 (*
¬gc
)++;

1101 
cu¼’t
 = 
NULL
;

1104 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`s_m®loc
((*));

1105  
veùÜ
;

1109 
”r
:

1110 (*
¬gc
)--)

1111 
	`sdsä“
(
veùÜ
[*
¬gc
]);

1112 
	`s_ä“
(
veùÜ
);

1113 ià(
cu¼’t
è
	`sdsä“
(current);

1114 *
¬gc
 = 0;

1115  
NULL
;

1116 
	}
}

1128 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

1129 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

1131 
j
 = 0; j < 
l
; j++) {

1132 
i
 = 0; i < 
£’
; i++) {

1133 ià(
s
[
j
] =ğ
äom
[
i
]) {

1134 
s
[
j
] = 
to
[
i
];

1139  
s
;

1140 
	}
}

1145 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
) {

1146 
sds
 
još
 = 
	`sd£m±y
();

1147 
j
;

1149 
j
 = 0; j < 
¬gc
; j++) {

1150 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

1151 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿt
(još,
£p
);

1153  
još
;

1154 
	}
}

1158 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

1159 
sds
 
još
 = 
	`sd£m±y
();

1160 
j
;

1162 
j
 = 0; j < 
¬gc
; j++) {

1163 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

1164 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

1166  
još
;

1167 
	}
}

1170 
	$sdsIsNum
(
sds
 
s
) {

1171 
size_t
 
i
;

1173 ià(
s
 =ğ
NULL
 || 
	`sd¦’
(s) == 0) {

1177 
i
 = 0; i < 
	`sd¦’
(
s
); i ++) {

1178 if(*(
s
+
i
) < '0' || *(s+i) > '9'){

1184 
	}
}

1191 *
	$sds_m®loc
(
size_t
 
size
è{  
	`s_m®loc
(size); 
	}
}

1192 *
	$sds_»®loc
(*
±r
, 
size_t
 
size
è{  
	`s_»®loc
ÕŒ,size); 
	}
}

1193 
	$sds_ä“
(*
±r
è{ 
	`s_ä“
ÕŒ); 
	}
}

1195 #ià
defšed
(
SDS_TEST_MAIN
)

1196 
	~<¡dio.h
>

1197 
	~"‹¡h–p.h
"

1198 
	~"lim™s.h
"

1200 
	#UNUSED
(
x
è()(x)

	)

1202 
	$sdsTe¡
() {

1204 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

1206 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

1207 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

1209 
	`sdsä“
(
x
);

1210 
x
 = 
	`sd¢ewËn
("foo",2);

1211 
	`‹¡_cÚd
("Create‡ string with specified†ength",

1212 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

1214 
x
 = 
	`sdsÿt
(x,"bar");

1215 
	`‹¡_cÚd
("Strings concatenation",

1216 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

1218 
x
 = 
	`sdsıy
(x,"a");

1219 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

1220 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

1222 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

1223 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1224 
	`sd¦’
(
x
) == 33 &&

1225 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1227 
	`sdsä“
(
x
);

1228 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1229 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1230 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) == 0)

1232 
	`sdsä“
(
x
);

1233 
x
 = 
	`sd¢ew
("--");

1234 
x
 = 
	`sdsÿtfmt
(x, "H–lØ% WÜld %I,%I--", "Hi!", 
LLONG_MIN
,
LLONG_MAX
);

1235 
	`‹¡_cÚd
("sdscatfmt() seems working inhe base case",

1236 
	`sd¦’
(
x
) == 60 &&

1237 
	`memcmp
(
x
,"--Hello Hi! World -9223372036854775808,"

1239 
	`´štf
("[%s]\n",
x
);

1241 
	`sdsä“
(
x
);

1242 
x
 = 
	`sd¢ew
("--");

1243 
x
 = 
	`sdsÿtfmt
(x, "%u,%U--", 
UINT_MAX
, 
ULLONG_MAX
);

1244 
	`‹¡_cÚd
("sdscatfmt() seems working with unsigned‚umbers",

1245 
	`sd¦’
(
x
) == 35 &&

1246 
	`memcmp
(
x
,"--4294967295,18446744073709551615--",35) == 0)

1248 
	`sdsä“
(
x
);

1249 
x
 = 
	`sd¢ew
(" x ");

1250 
	`sd¡rim
(
x
," x");

1251 
	`‹¡_cÚd
("sdstrim() works when‡ll chars match",

1252 
	`sd¦’
(
x
) == 0)

1254 
	`sdsä“
(
x
);

1255 
x
 = 
	`sd¢ew
(" x ");

1256 
	`sd¡rim
(
x
," ");

1257 
	`‹¡_cÚd
("sdstrim() works when‡ single char„emains",

1258 
	`sd¦’
(
x
) == 1 && x[0] == 'x')

1260 
	`sdsä“
(
x
);

1261 
x
 = 
	`sd¢ew
("xxciaoyyy");

1262 
	`sd¡rim
(
x
,"xy");

1263 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1264 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1266 
y
 = 
	`sdsdup
(
x
);

1267 
	`sd¤ªge
(
y
,1,1);

1268 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1269 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1271 
	`sdsä“
(
y
);

1272 
y
 = 
	`sdsdup
(
x
);

1273 
	`sd¤ªge
(
y
,1,-1);

1274 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1275 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1277 
	`sdsä“
(
y
);

1278 
y
 = 
	`sdsdup
(
x
);

1279 
	`sd¤ªge
(
y
,-2,-1);

1280 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1281 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1283 
	`sdsä“
(
y
);

1284 
y
 = 
	`sdsdup
(
x
);

1285 
	`sd¤ªge
(
y
,2,1);

1286 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1287 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1289 
	`sdsä“
(
y
);

1290 
y
 = 
	`sdsdup
(
x
);

1291 
	`sd¤ªge
(
y
,1,100);

1292 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1293 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1295 
	`sdsä“
(
y
);

1296 
y
 = 
	`sdsdup
(
x
);

1297 
	`sd¤ªge
(
y
,100,100);

1298 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1299 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1301 
	`sdsä“
(
y
);

1302 
	`sdsä“
(
x
);

1303 
x
 = 
	`sd¢ew
("foo");

1304 
y
 = 
	`sd¢ew
("foa");

1305 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1307 
	`sdsä“
(
y
);

1308 
	`sdsä“
(
x
);

1309 
x
 = 
	`sd¢ew
("bar");

1310 
y
 = 
	`sd¢ew
("bar");

1311 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1313 
	`sdsä“
(
y
);

1314 
	`sdsä“
(
x
);

1315 
x
 = 
	`sd¢ew
("aar");

1316 
y
 = 
	`sd¢ew
("bar");

1317 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1319 
	`sdsä“
(
y
);

1320 
	`sdsä“
(
x
);

1321 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1322 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1323 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1324 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1327 
Şdä“
;

1328 *
p
;

1329 
¡•
 = 10, 
j
, 
i
;

1331 
	`sdsä“
(
x
);

1332 
	`sdsä“
(
y
);

1333 
x
 = 
	`sd¢ew
("0");

1334 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
	`sd¦’
(
x
è=ğ1 && 
	`sd§va
(x) == 0);

1338 
i
 = 0; i < 10; i++) {

1339 
ŞdËn
 = 
	`sd¦’
(
x
);

1340 
x
 = 
	`sdsMakeRoomFÜ
(x,
¡•
);

1341 
ty³
 = 
x
[-1]&
SDS_TYPE_MASK
;

1343 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èËn", 
	`sd¦’
(
x
è=ğ
ŞdËn
);

1344 ià(
ty³
 !ğ
SDS_TYPE_5
) {

1345 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èä“", 
	`sd§va
(
x
è>ğ
¡•
);

1346 
Şdä“
 = 
	`sd§va
(
x
);

1348 
p
 = 
x
+
ŞdËn
;

1349 
j
 = 0; j < 
¡•
; j++) {

1350 
p
[
j
] = 'A'+j;

1352 
	`sdsInüL’
(
x
,
¡•
);

1354 
	`‹¡_cÚd
("sdsMakeRoomFor() content",

1355 
	`memcmp
("0ABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJ",
x
,101) == 0);

1356 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èfš®†’gth",
	`sd¦’
(
x
)==101);

1358 
	`sdsä“
(
x
);

1361 
	`‹¡_»pÜt
()

1363 
	}
}

1366 #ifdeà
SDS_TEST_MAIN


1367 
	$maš
() {

1368  
	`sdsTe¡
();

1369 
	}
}

	@dep/sds/sds.h

33 #iâdeà
__SDS_H


34 
	#__SDS_H


	)

36 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

38 
	~<sys/ty³s.h
>

39 
	~<¡d¬g.h
>

40 
	~<¡dšt.h
>

42 *
	tsds
;

47 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr5
 {

49 
	gæags
;

50 
	gbuf
[];

52 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr8
 {

54 
ušt8_t
 
	gËn
;

56 
ušt8_t
 
	g®loc
;

58 
	gæags
;

59 
	gbuf
[];

62 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr16
 {

63 
ušt16_t
 
	gËn
;

64 
ušt16_t
 
	g®loc
;

65 
	gæags
;

66 
	gbuf
[];

68 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr32
 {

69 
ušt32_t
 
	gËn
;

70 
ušt32_t
 
	g®loc
;

71 
	gæags
;

72 
	gbuf
[];

74 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr64
 {

75 
ušt64_t
 
	gËn
;

76 
ušt64_t
 
	g®loc
;

77 
	gæags
;

78 
	gbuf
[];

82 
	#SDS_TYPE_5
 0

	)

83 
	#SDS_TYPE_8
 1

	)

84 
	#SDS_TYPE_16
 2

	)

85 
	#SDS_TYPE_32
 3

	)

86 
	#SDS_TYPE_64
 4

	)

88 
	#SDS_TYPE_MASK
 7

	)

89 
	#SDS_TYPE_BITS
 3

	)

92 
	#SDS_HDR_VAR
(
T
,
s
è
sdshdr
##T *
sh
 = (*)((s)-((sdshdr##T)));

	)

94 
	#SDS_HDR
(
T
,
s
è((
sdshdr
##T *)((s)-((sdshdr##T))))

	)

96 
	#SDS_TYPE_5_LEN
(
f
è((f)>>
SDS_TYPE_BITS
)

	)

99 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

100 
æags
 = 
s
[-1];

101 
æags
&
SDS_TYPE_MASK
) {

102 
SDS_TYPE_5
:

103  
	`SDS_TYPE_5_LEN
(
æags
);

104 
SDS_TYPE_8
:

105  
	`SDS_HDR
(8,
s
)->
Ën
;

106 
SDS_TYPE_16
:

107  
	`SDS_HDR
(16,
s
)->
Ën
;

108 
SDS_TYPE_32
:

109  
	`SDS_HDR
(32,
s
)->
Ën
;

110 
SDS_TYPE_64
:

111  
	`SDS_HDR
(64,
s
)->
Ën
;

114 
	}
}

118 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

120 
æags
 = 
s
[-1];

121 
æags
&
SDS_TYPE_MASK
) {

122 
SDS_TYPE_5
: {

125 
SDS_TYPE_8
: {

126 
	`SDS_HDR_VAR
(8,
s
);

127  
sh
->
®loc
 - sh->
Ën
;

129 
SDS_TYPE_16
: {

130 
	`SDS_HDR_VAR
(16,
s
);

131  
sh
->
®loc
 - sh->
Ën
;

133 
SDS_TYPE_32
: {

134 
	`SDS_HDR_VAR
(32,
s
);

135  
sh
->
®loc
 - sh->
Ën
;

137 
SDS_TYPE_64
: {

138 
	`SDS_HDR_VAR
(64,
s
);

139  
sh
->
®loc
 - sh->
Ën
;

143 
	}
}

146 
šlše
 
	$sds£’
(
sds
 
s
, 
size_t
 
ÃwËn
) {

148 
æags
 = 
s
[-1];

149 
æags
&
SDS_TYPE_MASK
) {

150 
SDS_TYPE_5
:

152 *
å
 = ((*)
s
)-1;

153 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

156 
SDS_TYPE_8
:

157 
	`SDS_HDR
(8,
s
)->
Ën
 = 
ÃwËn
;

159 
SDS_TYPE_16
:

160 
	`SDS_HDR
(16,
s
)->
Ën
 = 
ÃwËn
;

162 
SDS_TYPE_32
:

163 
	`SDS_HDR
(32,
s
)->
Ën
 = 
ÃwËn
;

165 
SDS_TYPE_64
:

166 
	`SDS_HDR
(64,
s
)->
Ën
 = 
ÃwËn
;

169 
	}
}

172 
šlše
 
	$sdsšş’
(
sds
 
s
, 
size_t
 
šc
) {

173 
æags
 = 
s
[-1];

174 
æags
&
SDS_TYPE_MASK
) {

175 
SDS_TYPE_5
:

177 *
å
 = ((*)
s
)-1;

179 
ÃwËn
 = 
	`SDS_TYPE_5_LEN
(
æags
)+
šc
;

181 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

184 
SDS_TYPE_8
:

185 
	`SDS_HDR
(8,
s
)->
Ën
 +ğ
šc
;

187 
SDS_TYPE_16
:

188 
	`SDS_HDR
(16,
s
)->
Ën
 +ğ
šc
;

190 
SDS_TYPE_32
:

191 
	`SDS_HDR
(32,
s
)->
Ën
 +ğ
šc
;

193 
SDS_TYPE_64
:

194 
	`SDS_HDR
(64,
s
)->
Ën
 +ğ
šc
;

197 
	}
}

201 
šlše
 
size_t
 
	$sd§Îoc
(cÚ¡ 
sds
 
s
) {

202 
æags
 = 
s
[-1];

203 
æags
&
SDS_TYPE_MASK
) {

204 
SDS_TYPE_5
:

205  
	`SDS_TYPE_5_LEN
(
æags
);

206 
SDS_TYPE_8
:

207  
	`SDS_HDR
(8,
s
)->
®loc
;

208 
SDS_TYPE_16
:

209  
	`SDS_HDR
(16,
s
)->
®loc
;

210 
SDS_TYPE_32
:

211  
	`SDS_HDR
(32,
s
)->
®loc
;

212 
SDS_TYPE_64
:

213  
	`SDS_HDR
(64,
s
)->
®loc
;

216 
	}
}

218 
šlše
 
	$sds£Îoc
(
sds
 
s
, 
size_t
 
ÃwËn
) {

219 
æags
 = 
s
[-1];

220 
æags
&
SDS_TYPE_MASK
) {

221 
SDS_TYPE_5
:

224 
SDS_TYPE_8
:

225 
	`SDS_HDR
(8,
s
)->
®loc
 = 
ÃwËn
;

227 
SDS_TYPE_16
:

228 
	`SDS_HDR
(16,
s
)->
®loc
 = 
ÃwËn
;

230 
SDS_TYPE_32
:

231 
	`SDS_HDR
(32,
s
)->
®loc
 = 
ÃwËn
;

233 
SDS_TYPE_64
:

234 
	`SDS_HDR
(64,
s
)->
®loc
 = 
ÃwËn
;

237 
	}
}

240 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

241 
sds
 
sd¢ew
(cÚ¡ *
š™
);

242 
sds
 
sd£m±y
();

243 
sds
 
sdsdup
(cÚ¡ sd 
s
);

244 
sdsä“
(
sds
 
s
);

245 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

246 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

247 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

248 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

249 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

250 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

252 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

253 #ifdeà
__GNUC__


254 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

255 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

257 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

260 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

261 
sds
 
	`sd¡rim
(sd 
s
, cÚ¡ *
c£t
);

262 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

263 
	`sdsupd©–’
(
sds
 
s
);

264 
	`sdsş—r
(
sds
 
s
);

265 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

266 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

267 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

268 
	`sd¡Şow”
(
sds
 
s
);

269 
	`sd¡ouµ”
(
sds
 
s
);

270 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

271 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

272 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

273 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

274 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
);

275 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

277 
	`sdsIsNum
(
sds
 
s
);

280 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

281 
	`sdsInüL’
(
sds
 
s
, 
šü
);

282 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

283 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

284 *
	`sdsAÎocPŒ
(
sds
 
s
);

290 *
	`sds_m®loc
(
size_t
 
size
);

291 *
	`sds_»®loc
(*
±r
, 
size_t
 
size
);

292 
	`sds_ä“
(*
±r
);

294 #ifdeà
REDIS_TEST


296 
	`sdsTe¡
(
¬gc
, *
¬gv
[]);

	@dep/sds/sds.h

33 #iâdeà
__SDS_H


34 
	#__SDS_H


	)

36 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

38 
	~<sys/ty³s.h
>

39 
	~<¡d¬g.h
>

40 
	~<¡dšt.h
>

42 *
	tsds
;

47 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr5
 {

49 
	gæags
;

50 
	gbuf
[];

52 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr8
 {

54 
ušt8_t
 
	gËn
;

56 
ušt8_t
 
	g®loc
;

58 
	gæags
;

59 
	gbuf
[];

62 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr16
 {

63 
ušt16_t
 
	gËn
;

64 
ušt16_t
 
	g®loc
;

65 
	gæags
;

66 
	gbuf
[];

68 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr32
 {

69 
ušt32_t
 
	gËn
;

70 
ušt32_t
 
	g®loc
;

71 
	gæags
;

72 
	gbuf
[];

74 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr64
 {

75 
ušt64_t
 
	gËn
;

76 
ušt64_t
 
	g®loc
;

77 
	gæags
;

78 
	gbuf
[];

82 
	#SDS_TYPE_5
 0

	)

83 
	#SDS_TYPE_8
 1

	)

84 
	#SDS_TYPE_16
 2

	)

85 
	#SDS_TYPE_32
 3

	)

86 
	#SDS_TYPE_64
 4

	)

88 
	#SDS_TYPE_MASK
 7

	)

89 
	#SDS_TYPE_BITS
 3

	)

92 
	#SDS_HDR_VAR
(
T
,
s
è
sdshdr
##T *
sh
 = (*)((s)-((sdshdr##T)));

	)

94 
	#SDS_HDR
(
T
,
s
è((
sdshdr
##T *)((s)-((sdshdr##T))))

	)

96 
	#SDS_TYPE_5_LEN
(
f
è((f)>>
SDS_TYPE_BITS
)

	)

99 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

100 
æags
 = 
s
[-1];

101 
æags
&
SDS_TYPE_MASK
) {

102 
SDS_TYPE_5
:

103  
	`SDS_TYPE_5_LEN
(
æags
);

104 
SDS_TYPE_8
:

105  
	`SDS_HDR
(8,
s
)->
Ën
;

106 
SDS_TYPE_16
:

107  
	`SDS_HDR
(16,
s
)->
Ën
;

108 
SDS_TYPE_32
:

109  
	`SDS_HDR
(32,
s
)->
Ën
;

110 
SDS_TYPE_64
:

111  
	`SDS_HDR
(64,
s
)->
Ën
;

114 
	}
}

118 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

120 
æags
 = 
s
[-1];

121 
æags
&
SDS_TYPE_MASK
) {

122 
SDS_TYPE_5
: {

125 
SDS_TYPE_8
: {

126 
	`SDS_HDR_VAR
(8,
s
);

127  
sh
->
®loc
 - sh->
Ën
;

129 
SDS_TYPE_16
: {

130 
	`SDS_HDR_VAR
(16,
s
);

131  
sh
->
®loc
 - sh->
Ën
;

133 
SDS_TYPE_32
: {

134 
	`SDS_HDR_VAR
(32,
s
);

135  
sh
->
®loc
 - sh->
Ën
;

137 
SDS_TYPE_64
: {

138 
	`SDS_HDR_VAR
(64,
s
);

139  
sh
->
®loc
 - sh->
Ën
;

143 
	}
}

146 
šlše
 
	$sds£’
(
sds
 
s
, 
size_t
 
ÃwËn
) {

148 
æags
 = 
s
[-1];

149 
æags
&
SDS_TYPE_MASK
) {

150 
SDS_TYPE_5
:

152 *
å
 = ((*)
s
)-1;

153 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

156 
SDS_TYPE_8
:

157 
	`SDS_HDR
(8,
s
)->
Ën
 = 
ÃwËn
;

159 
SDS_TYPE_16
:

160 
	`SDS_HDR
(16,
s
)->
Ën
 = 
ÃwËn
;

162 
SDS_TYPE_32
:

163 
	`SDS_HDR
(32,
s
)->
Ën
 = 
ÃwËn
;

165 
SDS_TYPE_64
:

166 
	`SDS_HDR
(64,
s
)->
Ën
 = 
ÃwËn
;

169 
	}
}

172 
šlše
 
	$sdsšş’
(
sds
 
s
, 
size_t
 
šc
) {

173 
æags
 = 
s
[-1];

174 
æags
&
SDS_TYPE_MASK
) {

175 
SDS_TYPE_5
:

177 *
å
 = ((*)
s
)-1;

179 
ÃwËn
 = 
	`SDS_TYPE_5_LEN
(
æags
)+
šc
;

181 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

184 
SDS_TYPE_8
:

185 
	`SDS_HDR
(8,
s
)->
Ën
 +ğ
šc
;

187 
SDS_TYPE_16
:

188 
	`SDS_HDR
(16,
s
)->
Ën
 +ğ
šc
;

190 
SDS_TYPE_32
:

191 
	`SDS_HDR
(32,
s
)->
Ën
 +ğ
šc
;

193 
SDS_TYPE_64
:

194 
	`SDS_HDR
(64,
s
)->
Ën
 +ğ
šc
;

197 
	}
}

201 
šlše
 
size_t
 
	$sd§Îoc
(cÚ¡ 
sds
 
s
) {

202 
æags
 = 
s
[-1];

203 
æags
&
SDS_TYPE_MASK
) {

204 
SDS_TYPE_5
:

205  
	`SDS_TYPE_5_LEN
(
æags
);

206 
SDS_TYPE_8
:

207  
	`SDS_HDR
(8,
s
)->
®loc
;

208 
SDS_TYPE_16
:

209  
	`SDS_HDR
(16,
s
)->
®loc
;

210 
SDS_TYPE_32
:

211  
	`SDS_HDR
(32,
s
)->
®loc
;

212 
SDS_TYPE_64
:

213  
	`SDS_HDR
(64,
s
)->
®loc
;

216 
	}
}

218 
šlše
 
	$sds£Îoc
(
sds
 
s
, 
size_t
 
ÃwËn
) {

219 
æags
 = 
s
[-1];

220 
æags
&
SDS_TYPE_MASK
) {

221 
SDS_TYPE_5
:

224 
SDS_TYPE_8
:

225 
	`SDS_HDR
(8,
s
)->
®loc
 = 
ÃwËn
;

227 
SDS_TYPE_16
:

228 
	`SDS_HDR
(16,
s
)->
®loc
 = 
ÃwËn
;

230 
SDS_TYPE_32
:

231 
	`SDS_HDR
(32,
s
)->
®loc
 = 
ÃwËn
;

233 
SDS_TYPE_64
:

234 
	`SDS_HDR
(64,
s
)->
®loc
 = 
ÃwËn
;

237 
	}
}

240 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

241 
sds
 
sd¢ew
(cÚ¡ *
š™
);

242 
sds
 
sd£m±y
();

243 
sds
 
sdsdup
(cÚ¡ sd 
s
);

244 
sdsä“
(
sds
 
s
);

245 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

246 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

247 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

248 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

249 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

250 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

252 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

253 #ifdeà
__GNUC__


254 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

255 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

257 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

260 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

261 
sds
 
	`sd¡rim
(sd 
s
, cÚ¡ *
c£t
);

262 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

263 
	`sdsupd©–’
(
sds
 
s
);

264 
	`sdsş—r
(
sds
 
s
);

265 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

266 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

267 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

268 
	`sd¡Şow”
(
sds
 
s
);

269 
	`sd¡ouµ”
(
sds
 
s
);

270 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

271 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

272 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

273 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

274 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
);

275 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

277 
	`sdsIsNum
(
sds
 
s
);

280 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

281 
	`sdsInüL’
(
sds
 
s
, 
šü
);

282 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

283 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

284 *
	`sdsAÎocPŒ
(
sds
 
s
);

290 *
	`sds_m®loc
(
size_t
 
size
);

291 *
	`sds_»®loc
(*
±r
, 
size_t
 
size
);

292 
	`sds_ä“
(*
±r
);

294 #ifdeà
REDIS_TEST


296 
	`sdsTe¡
(
¬gc
, *
¬gv
[]);

	@dep/sds/sdsalloc.h

39 
	~<dm®loc.h
>

41 
	#s_m®loc
 
d®loc


	)

42 
	#s_»®loc
 
d»®loc


	)

43 
	#s_ä“
 
dä“


	)

	@dep/sds/sdsalloc.h

39 
	~<dm®loc.h
>

41 
	#s_m®loc
 
d®loc


	)

42 
	#s_»®loc
 
d»®loc


	)

43 
	#s_ä“
 
dä“


	)

	@dep/util/dlog.c

1 
	~<¡dlib.h
>

2 
	~<¡d¬g.h
>

3 
	~<uni¡d.h
>

4 
	~<ùy³.h
>

5 
	~<time.h
>

6 
	~<sys/¡©.h
>

7 
	~<fú.h
>

8 
	~<”ºo.h
>

10 
	~<dut.h
>

11 
	~<dlog.h
>

13 
logg”
 
	glogg”
;

17 
	$log_š™
(
Ëv–
, *
Çme
)

19 
logg”
 *
l
 = &logger;

21 
l
->
Ëv–
 = 
	`MAX
(
LOG_EMERG
, 
	`MIN
Öev–, 
LOG_PVERB
));

22 
l
->
Çme
 =‚ame;

23 ià(
Çme
 =ğ
NULL
 || !
	`¡¾’
(name)) {

24 
l
->
fd
 = 
STDERR_FILENO
;

26 
l
->
fd
 = 
	`İ’
(
Çme
, 
O_WRONLY
 | 
O_APPEND
 | 
O_CREAT
, 0644);

27 ià(
l
->
fd
 < 0) {

28 
	`log_¡d”r
("İ’šg†og f'%s' faed: %s", 
Çme
,

29 
	`¡»¼Ü
(
”ºo
));

35 
	}
}

38 
	$log_deš™
()

40 
logg”
 *
l
 = &logger;

42 ià(
l
->
fd
 < 0 ||†->fd =ğ
STDERR_FILENO
) {

46 
	`şo£
(
l
->
fd
);

47 
	}
}

50 
	$log_»İ’
()

52 
logg”
 *
l
 = &logger;

54 ià(
l
->
fd
 !ğ
STDERR_FILENO
) {

55 
	`şo£
(
l
->
fd
);

56 
l
->
fd
 = 
	`İ’
Ö->
Çme
, 
O_WRONLY
 | 
O_APPEND
 | 
O_CREAT
, 0644);

57 ià(
l
->
fd
 < 0) {

58 
	`log_¡d”r_§ã
("»İ’šg†og f'%s' faed, ignÜed: %s", 
l
->
Çme
,

59 
	`¡»¼Ü
(
”ºo
));

62 
	}
}

65 
	$log_Ëv–_up
()

67 
logg”
 *
l
 = &logger;

69 ià(
l
->
Ëv–
 < 
LOG_PVERB
) {

70 
l
->
Ëv–
++;

71 
	`log_§ã
("u°log†ev–Ø%d", 
l
->
Ëv–
);

73 
	}
}

76 
	$log_Ëv–_down
()

78 
logg”
 *
l
 = &logger;

80 ià(
l
->
Ëv–
 > 
LOG_EMERG
) {

81 
l
->
Ëv–
--;

82 
	`log_§ã
("dowÀlog†ev–Ø%d", 
l
->
Ëv–
);

84 
	}
}

87 
	$log_Ëv–_£t
(
Ëv–
)

89 
logg”
 *
l
 = &logger;

91 
l
->
Ëv–
 = 
	`MAX
(
LOG_EMERG
, 
	`MIN
Öev–, 
LOG_PVERB
));

92 
	`loga
("£ˆlog†ev–Ø%d", 
l
->
Ëv–
);

93 
	}
}

96 
	$log_¡ackŒaû
()

98 
logg”
 *
l
 = &logger;

100 ià(
l
->
fd
 < 0) {

103 
	`d¡ackŒaû_fd
(
l
->
fd
);

104 
	}
}

107 
	$log_loggabË
(
Ëv–
)

109 
logg”
 *
l
 = &logger;

111 ià(
Ëv–
 > 
l
->level) {

116 
	}
}

119 
	$_log
(cÚ¡ *
fe
, 
lše
, 
Ëv–
, 
·nic
, cÚ¡ *
fmt
, ...)

121 
logg”
 *
l
 = &logger;

122 
Ën
, 
size
, 
”ºo_§ve
;

123 
buf
[
LOG_MAX_LEN
];

124 
va_li¡
 
¬gs
;

125 
ssize_t
 
n
;

126 
timev®
 
tv
;

128 ià(
l
->
fd
 < 0) {

132 
”ºo_§ve
 = 
”ºo
;

133 
Ën
 = 0;

134 
size
 = 
LOG_MAX_LEN
;

136 
	`g‘timeofday
(&
tv
, 
NULL
);

137 
buf
[
Ën
++] = '[';

138 
Ën
 +ğ
	`d¡ráime
(
buf
 +†’, 
size
 -†’, "%Y-%m-%d %H:%M:%S.", 
	`loÿÉime
(&
tv
.
tv_£c
));

139 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%03ld", 
tv
.
tv_u£c
/1000);

140 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "] %s:%d ", 
fe
, 
lše
);

142 
	`va_¡¬t
(
¬gs
, 
fmt
);

143 
Ën
 +ğ
	`dvsú´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

144 
	`va_’d
(
¬gs
);

146 
buf
[
Ën
++] = '\n';

148 
n
 = 
	`wr™e
(
l
->
fd
, 
buf
, 
Ën
);

149 ià(
n
 < 0) {

150 
l
->
Ã¼Ü
++;

153 
”ºo
 = 
”ºo_§ve
;

155 ià(
·nic
) {

156 
	`abÜt
();

158 
	}
}

161 
	$_log_¡d”r
(cÚ¡ *
fmt
, ...)

163 
logg”
 *
l
 = &logger;

164 
Ën
, 
size
, 
”ºo_§ve
;

165 
buf
[4 * 
LOG_MAX_LEN
];

166 
va_li¡
 
¬gs
;

167 
ssize_t
 
n
;

169 
”ºo_§ve
 = 
”ºo
;

170 
Ën
 = 0;

171 
size
 = 4 * 
LOG_MAX_LEN
;

173 
	`va_¡¬t
(
¬gs
, 
fmt
);

174 
Ën
 +ğ
	`dvsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

175 
	`va_’d
(
¬gs
);

177 
buf
[
Ën
++] = '\n';

179 
n
 = 
	`wr™e
(
STDERR_FILENO
, 
buf
, 
Ën
);

180 ià(
n
 < 0) {

181 
l
->
Ã¼Ü
++;

184 
”ºo
 = 
”ºo_§ve
;

185 
	}
}

188 
	$_log_¡dout
(cÚ¡ *
fmt
, ...)

190 
logg”
 *
l
 = &logger;

191 
Ën
, 
size
, 
”ºo_§ve
;

192 
buf
[4 * 
LOG_MAX_LEN
];

193 
va_li¡
 
¬gs
;

194 
ssize_t
 
n
;

196 
”ºo_§ve
 = 
”ºo
;

197 
Ën
 = 0;

198 
size
 = 4 * 
LOG_MAX_LEN
;

200 
	`va_¡¬t
(
¬gs
, 
fmt
);

201 
Ën
 +ğ
	`dvsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

202 
	`va_’d
(
¬gs
);

204 
buf
[
Ën
++] = '\n';

206 
n
 = 
	`wr™e
(
STDOUT_FILENO
, 
buf
, 
Ën
);

207 ià(
n
 < 0) {

208 
l
->
Ã¼Ü
++;

211 
”ºo
 = 
”ºo_§ve
;

212 
	}
}

219 
	$_log_hexdump
(cÚ¡ *
fe
, 
lše
, *
d©a
, 
d©®’
,

220 cÚ¡ *
fmt
, ...)

222 
logg”
 *
l
 = &logger;

223 
buf
[8 * 
LOG_MAX_LEN
];

224 
i
, 
off
, 
Ën
, 
size
, 
”ºo_§ve
;

225 
ssize_t
 
n
;

227 ià(
l
->
fd
 < 0) {

232 
”ºo_§ve
 = 
”ºo
;

233 
off
 = 0;

234 
Ën
 = 0;

235 
size
 = 8 * 
LOG_MAX_LEN
;

237 
d©®’
 !ğ0 && (
Ën
 < 
size
 - 1)) {

238 *
§ve
, *
¡r
;

239 
c
;

240 
§v–’
;

242 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%08x ", 
off
);

244 
§ve
 = 
d©a
;

245 
§v–’
 = 
d©®’
;

247 
i
 = 0; 
d©®’
 !ğ0 && i < 16; 
d©a
++, datalen--, i++) {

248 
c
 = ()(*
d©a
);

249 
¡r
 = (
i
 == 7) ? " " : " ";

250 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%02x%s", 
c
, 
¡r
);

252  ; 
i
 < 16; i++) {

253 
¡r
 = (
i
 == 7) ? " " : " ";

254 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, " %s", 
¡r
);

257 
d©a
 = 
§ve
;

258 
d©®’
 = 
§v–’
;

260 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†en, " |");

262 
i
 = 0; 
d©®’
 !ğ0 && i < 16; 
d©a
++, datalen--, i++) {

263 
c
 = ()(
	`i¥ršt
(*
d©a
) ? *data : '.');

264 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%c", 
c
);

266 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†en, "|\n");

268 
off
 += 16;

271 
n
 = 
	`wr™e
(
l
->
fd
, 
buf
, 
Ën
);

272 ià(
n
 < 0) {

273 
l
->
Ã¼Ü
++;

276 ià(
Ën
 >ğ
size
 - 1) {

277 
n
 = 
	`wr™e
(
l
->
fd
, "\n", 1);

278 ià(
n
 < 0) {

279 
l
->
Ã¼Ü
++;

283 
”ºo
 = 
”ºo_§ve
;

284 
	}
}

287 
	$_log_§ã
(cÚ¡ *
fmt
, ...)

289 
logg”
 *
l
 = &logger;

290 
Ën
, 
size
, 
”ºo_§ve
;

291 
buf
[
LOG_MAX_LEN
];

292 
va_li¡
 
¬gs
;

293 
ssize_t
 
n
;

295 ià(
l
->
fd
 < 0) {

299 
”ºo_§ve
 = 
”ºo
;

300 
Ën
 = 0;

301 
size
 = 
LOG_MAX_LEN
;

303 
Ën
 +ğ
	`d§ã_¢´štf
(
buf
 +†’, 
size
 -†en, "[.......................] ");

305 
	`va_¡¬t
(
¬gs
, 
fmt
);

306 
Ën
 +ğ
	`d§ã_v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

307 
	`va_’d
(
¬gs
);

309 
buf
[
Ën
++] = '\n';

311 
n
 = 
	`wr™e
(
l
->
fd
, 
buf
, 
Ën
);

312 ià(
n
 < 0) {

313 
l
->
Ã¼Ü
++;

316 
”ºo
 = 
”ºo_§ve
;

317 
	}
}

320 
	$_log_¡d”r_§ã
(cÚ¡ *
fmt
, ...)

322 
logg”
 *
l
 = &logger;

323 
Ën
, 
size
, 
”ºo_§ve
;

324 
buf
[
LOG_MAX_LEN
];

325 
va_li¡
 
¬gs
;

326 
ssize_t
 
n
;

328 
”ºo_§ve
 = 
”ºo
;

329 
Ën
 = 0;

330 
size
 = 
LOG_MAX_LEN
;

332 
Ën
 +ğ
	`d§ã_¢´štf
(
buf
 +†’, 
size
 -†en, "[.......................] ");

334 
	`va_¡¬t
(
¬gs
, 
fmt
);

335 
Ën
 +ğ
	`d§ã_v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

336 
	`va_’d
(
¬gs
);

338 
buf
[
Ën
++] = '\n';

340 
n
 = 
	`wr™e
(
STDERR_FILENO
, 
buf
, 
Ën
);

341 ià(
n
 < 0) {

342 
l
->
Ã¼Ü
++;

345 
”ºo
 = 
”ºo_§ve
;

346 
	}
}

348 
	$log_wr™e_Ën
(*
¡r
, 
size_t
 
Ën
)

350 
logg”
 *
l
 = &logger;

351 
”ºo_§ve
;

352 
ssize_t
 
n
;

354 ià(
l
->
fd
 < 0) {

358 
”ºo_§ve
 = 
”ºo
;

359 
n
 = 
	`wr™e
(
l
->
fd
, 
¡r
, 
Ën
);

360 ià(
n
 < 0) {

361 
l
->
Ã¼Ü
++;

364 
”ºo
 = 
”ºo_§ve
;

365 
	}
}

	@dep/util/dlog.c

1 
	~<¡dlib.h
>

2 
	~<¡d¬g.h
>

3 
	~<uni¡d.h
>

4 
	~<ùy³.h
>

5 
	~<time.h
>

6 
	~<sys/¡©.h
>

7 
	~<fú.h
>

8 
	~<”ºo.h
>

10 
	~<dut.h
>

11 
	~<dlog.h
>

13 
logg”
 
	glogg”
;

17 
	$log_š™
(
Ëv–
, *
Çme
)

19 
logg”
 *
l
 = &logger;

21 
l
->
Ëv–
 = 
	`MAX
(
LOG_EMERG
, 
	`MIN
Öev–, 
LOG_PVERB
));

22 
l
->
Çme
 =‚ame;

23 ià(
Çme
 =ğ
NULL
 || !
	`¡¾’
(name)) {

24 
l
->
fd
 = 
STDERR_FILENO
;

26 
l
->
fd
 = 
	`İ’
(
Çme
, 
O_WRONLY
 | 
O_APPEND
 | 
O_CREAT
, 0644);

27 ià(
l
->
fd
 < 0) {

28 
	`log_¡d”r
("İ’šg†og f'%s' faed: %s", 
Çme
,

29 
	`¡»¼Ü
(
”ºo
));

35 
	}
}

38 
	$log_deš™
()

40 
logg”
 *
l
 = &logger;

42 ià(
l
->
fd
 < 0 ||†->fd =ğ
STDERR_FILENO
) {

46 
	`şo£
(
l
->
fd
);

47 
	}
}

50 
	$log_»İ’
()

52 
logg”
 *
l
 = &logger;

54 ià(
l
->
fd
 !ğ
STDERR_FILENO
) {

55 
	`şo£
(
l
->
fd
);

56 
l
->
fd
 = 
	`İ’
Ö->
Çme
, 
O_WRONLY
 | 
O_APPEND
 | 
O_CREAT
, 0644);

57 ià(
l
->
fd
 < 0) {

58 
	`log_¡d”r_§ã
("»İ’šg†og f'%s' faed, ignÜed: %s", 
l
->
Çme
,

59 
	`¡»¼Ü
(
”ºo
));

62 
	}
}

65 
	$log_Ëv–_up
()

67 
logg”
 *
l
 = &logger;

69 ià(
l
->
Ëv–
 < 
LOG_PVERB
) {

70 
l
->
Ëv–
++;

71 
	`log_§ã
("u°log†ev–Ø%d", 
l
->
Ëv–
);

73 
	}
}

76 
	$log_Ëv–_down
()

78 
logg”
 *
l
 = &logger;

80 ià(
l
->
Ëv–
 > 
LOG_EMERG
) {

81 
l
->
Ëv–
--;

82 
	`log_§ã
("dowÀlog†ev–Ø%d", 
l
->
Ëv–
);

84 
	}
}

87 
	$log_Ëv–_£t
(
Ëv–
)

89 
logg”
 *
l
 = &logger;

91 
l
->
Ëv–
 = 
	`MAX
(
LOG_EMERG
, 
	`MIN
Öev–, 
LOG_PVERB
));

92 
	`loga
("£ˆlog†ev–Ø%d", 
l
->
Ëv–
);

93 
	}
}

96 
	$log_¡ackŒaû
()

98 
logg”
 *
l
 = &logger;

100 ià(
l
->
fd
 < 0) {

103 
	`d¡ackŒaû_fd
(
l
->
fd
);

104 
	}
}

107 
	$log_loggabË
(
Ëv–
)

109 
logg”
 *
l
 = &logger;

111 ià(
Ëv–
 > 
l
->level) {

116 
	}
}

119 
	$_log
(cÚ¡ *
fe
, 
lše
, 
Ëv–
, 
·nic
, cÚ¡ *
fmt
, ...)

121 
logg”
 *
l
 = &logger;

122 
Ën
, 
size
, 
”ºo_§ve
;

123 
buf
[
LOG_MAX_LEN
];

124 
va_li¡
 
¬gs
;

125 
ssize_t
 
n
;

126 
timev®
 
tv
;

128 ià(
l
->
fd
 < 0) {

132 
”ºo_§ve
 = 
”ºo
;

133 
Ën
 = 0;

134 
size
 = 
LOG_MAX_LEN
;

136 
	`g‘timeofday
(&
tv
, 
NULL
);

137 
buf
[
Ën
++] = '[';

138 
Ën
 +ğ
	`d¡ráime
(
buf
 +†’, 
size
 -†’, "%Y-%m-%d %H:%M:%S.", 
	`loÿÉime
(&
tv
.
tv_£c
));

139 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%03ld", 
tv
.
tv_u£c
/1000);

140 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "] %s:%d ", 
fe
, 
lše
);

142 
	`va_¡¬t
(
¬gs
, 
fmt
);

143 
Ën
 +ğ
	`dvsú´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

144 
	`va_’d
(
¬gs
);

146 
buf
[
Ën
++] = '\n';

148 
n
 = 
	`wr™e
(
l
->
fd
, 
buf
, 
Ën
);

149 ià(
n
 < 0) {

150 
l
->
Ã¼Ü
++;

153 
”ºo
 = 
”ºo_§ve
;

155 ià(
·nic
) {

156 
	`abÜt
();

158 
	}
}

161 
	$_log_¡d”r
(cÚ¡ *
fmt
, ...)

163 
logg”
 *
l
 = &logger;

164 
Ën
, 
size
, 
”ºo_§ve
;

165 
buf
[4 * 
LOG_MAX_LEN
];

166 
va_li¡
 
¬gs
;

167 
ssize_t
 
n
;

169 
”ºo_§ve
 = 
”ºo
;

170 
Ën
 = 0;

171 
size
 = 4 * 
LOG_MAX_LEN
;

173 
	`va_¡¬t
(
¬gs
, 
fmt
);

174 
Ën
 +ğ
	`dvsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

175 
	`va_’d
(
¬gs
);

177 
buf
[
Ën
++] = '\n';

179 
n
 = 
	`wr™e
(
STDERR_FILENO
, 
buf
, 
Ën
);

180 ià(
n
 < 0) {

181 
l
->
Ã¼Ü
++;

184 
”ºo
 = 
”ºo_§ve
;

185 
	}
}

188 
	$_log_¡dout
(cÚ¡ *
fmt
, ...)

190 
logg”
 *
l
 = &logger;

191 
Ën
, 
size
, 
”ºo_§ve
;

192 
buf
[4 * 
LOG_MAX_LEN
];

193 
va_li¡
 
¬gs
;

194 
ssize_t
 
n
;

196 
”ºo_§ve
 = 
”ºo
;

197 
Ën
 = 0;

198 
size
 = 4 * 
LOG_MAX_LEN
;

200 
	`va_¡¬t
(
¬gs
, 
fmt
);

201 
Ën
 +ğ
	`dvsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

202 
	`va_’d
(
¬gs
);

204 
buf
[
Ën
++] = '\n';

206 
n
 = 
	`wr™e
(
STDOUT_FILENO
, 
buf
, 
Ën
);

207 ià(
n
 < 0) {

208 
l
->
Ã¼Ü
++;

211 
”ºo
 = 
”ºo_§ve
;

212 
	}
}

219 
	$_log_hexdump
(cÚ¡ *
fe
, 
lše
, *
d©a
, 
d©®’
,

220 cÚ¡ *
fmt
, ...)

222 
logg”
 *
l
 = &logger;

223 
buf
[8 * 
LOG_MAX_LEN
];

224 
i
, 
off
, 
Ën
, 
size
, 
”ºo_§ve
;

225 
ssize_t
 
n
;

227 ià(
l
->
fd
 < 0) {

232 
”ºo_§ve
 = 
”ºo
;

233 
off
 = 0;

234 
Ën
 = 0;

235 
size
 = 8 * 
LOG_MAX_LEN
;

237 
d©®’
 !ğ0 && (
Ën
 < 
size
 - 1)) {

238 *
§ve
, *
¡r
;

239 
c
;

240 
§v–’
;

242 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%08x ", 
off
);

244 
§ve
 = 
d©a
;

245 
§v–’
 = 
d©®’
;

247 
i
 = 0; 
d©®’
 !ğ0 && i < 16; 
d©a
++, datalen--, i++) {

248 
c
 = ()(*
d©a
);

249 
¡r
 = (
i
 == 7) ? " " : " ";

250 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%02x%s", 
c
, 
¡r
);

252  ; 
i
 < 16; i++) {

253 
¡r
 = (
i
 == 7) ? " " : " ";

254 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, " %s", 
¡r
);

257 
d©a
 = 
§ve
;

258 
d©®’
 = 
§v–’
;

260 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†en, " |");

262 
i
 = 0; 
d©®’
 !ğ0 && i < 16; 
d©a
++, datalen--, i++) {

263 
c
 = ()(
	`i¥ršt
(*
d©a
) ? *data : '.');

264 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†’, "%c", 
c
);

266 
Ën
 +ğ
	`dsú´štf
(
buf
 +†’, 
size
 -†en, "|\n");

268 
off
 += 16;

271 
n
 = 
	`wr™e
(
l
->
fd
, 
buf
, 
Ën
);

272 ià(
n
 < 0) {

273 
l
->
Ã¼Ü
++;

276 ià(
Ën
 >ğ
size
 - 1) {

277 
n
 = 
	`wr™e
(
l
->
fd
, "\n", 1);

278 ià(
n
 < 0) {

279 
l
->
Ã¼Ü
++;

283 
”ºo
 = 
”ºo_§ve
;

284 
	}
}

287 
	$_log_§ã
(cÚ¡ *
fmt
, ...)

289 
logg”
 *
l
 = &logger;

290 
Ën
, 
size
, 
”ºo_§ve
;

291 
buf
[
LOG_MAX_LEN
];

292 
va_li¡
 
¬gs
;

293 
ssize_t
 
n
;

295 ià(
l
->
fd
 < 0) {

299 
”ºo_§ve
 = 
”ºo
;

300 
Ën
 = 0;

301 
size
 = 
LOG_MAX_LEN
;

303 
Ën
 +ğ
	`d§ã_¢´štf
(
buf
 +†’, 
size
 -†en, "[.......................] ");

305 
	`va_¡¬t
(
¬gs
, 
fmt
);

306 
Ën
 +ğ
	`d§ã_v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

307 
	`va_’d
(
¬gs
);

309 
buf
[
Ën
++] = '\n';

311 
n
 = 
	`wr™e
(
l
->
fd
, 
buf
, 
Ën
);

312 ià(
n
 < 0) {

313 
l
->
Ã¼Ü
++;

316 
”ºo
 = 
”ºo_§ve
;

317 
	}
}

320 
	$_log_¡d”r_§ã
(cÚ¡ *
fmt
, ...)

322 
logg”
 *
l
 = &logger;

323 
Ën
, 
size
, 
”ºo_§ve
;

324 
buf
[
LOG_MAX_LEN
];

325 
va_li¡
 
¬gs
;

326 
ssize_t
 
n
;

328 
”ºo_§ve
 = 
”ºo
;

329 
Ën
 = 0;

330 
size
 = 
LOG_MAX_LEN
;

332 
Ën
 +ğ
	`d§ã_¢´štf
(
buf
 +†’, 
size
 -†en, "[.......................] ");

334 
	`va_¡¬t
(
¬gs
, 
fmt
);

335 
Ën
 +ğ
	`d§ã_v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

336 
	`va_’d
(
¬gs
);

338 
buf
[
Ën
++] = '\n';

340 
n
 = 
	`wr™e
(
STDERR_FILENO
, 
buf
, 
Ën
);

341 ià(
n
 < 0) {

342 
l
->
Ã¼Ü
++;

345 
”ºo
 = 
”ºo_§ve
;

346 
	}
}

348 
	$log_wr™e_Ën
(*
¡r
, 
size_t
 
Ën
)

350 
logg”
 *
l
 = &logger;

351 
”ºo_§ve
;

352 
ssize_t
 
n
;

354 ià(
l
->
fd
 < 0) {

358 
”ºo_§ve
 = 
”ºo
;

359 
n
 = 
	`wr™e
(
l
->
fd
, 
¡r
, 
Ën
);

360 ià(
n
 < 0) {

361 
l
->
Ã¼Ü
++;

364 
”ºo
 = 
”ºo_§ve
;

365 
	}
}

	@dep/util/dlog.h

1 #iâdeà
_DLOG_H_


2 
	#_DLOG_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	slogg”
 {

10 *
	mÇme
;

12 
	mËv–
;

14 
	mfd
;

16 
	mÃ¼Ü
;

20 
	#LOG_EMERG
 0

	)

21 
	#LOG_ALERT
 1

	)

22 
	#LOG_CRIT
 2

	)

23 
	#LOG_ERR
 3

	)

24 
	#LOG_WARN
 4

	)

25 
	#LOG_NOTICE
 5

	)

26 
	#LOG_INFO
 6

	)

27 
	#LOG_DEBUG
 7

	)

28 
	#LOG_VERB
 8

	)

29 
	#LOG_VVERB
 9

	)

30 
	#LOG_VVVERB
 10

	)

31 
	#LOG_PVERB
 11

	)

33 
	#LOG_ZC
 12

	)

34 
	#LOG_MAX_LEN
 256

	)

47 #ifdeà
HAVE_DEBUG_LOG


49 
	#log_debug
(
_Ëv–
, ...) do { \

50 ià(
	`log_loggabË
(
_Ëv–
) != 0) { \

51 
	`_log
(
__FILE__
, 
__LINE__
, 
_Ëv–
, 0, 
__VA_ARGS__
); \

53 } 0)

	)

57 
	#log_debug
(
_Ëv–
, ...)

	)

61 
	#log_hexdump
(
_Ëv–
, 
_d©a
, 
_d©®’
, ...) do { \

62 ià(
	`log_loggabË
(
_Ëv–
) != 0) { \

63 
	`_log
(
__FILE__
, 
__LINE__
, 
_Ëv–
, 0, 
__VA_ARGS__
); \

64 
	`_log_hexdump
(
__FILE__
, 
__LINE__
, (*)(
_d©a
), ()(
_d©®’
), \

65 
__VA_ARGS__
); \

67 } 0)

	)

69 
	#log_¡d”r
(...) do { \

70 
	`_log_¡d”r
(
__VA_ARGS__
); \

71 } 0)

	)

73 
	#log_¡dout
(...) do { \

74 
	`_log_¡dout
(
__VA_ARGS__
); \

75 } 0)

	)

77 
	#log_§ã
(...) do { \

78 
	`_log_§ã
(
__VA_ARGS__
); \

79 } 0)

	)

81 
	#log_¡d”r_§ã
(...) do { \

82 
	`_log_¡d”r_§ã
(
__VA_ARGS__
); \

83 } 0)

	)

85 
	#loga
(...) do { \

86 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 0, 
__VA_ARGS__
); \

87 } 0)

	)

89 
	#loga_hexdump
(
_d©a
, 
_d©®’
, ...) do { \

90 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 0, 
__VA_ARGS__
); \

91 
	`_log_hexdump
(
__FILE__
, 
__LINE__
, (*)(
_d©a
), ()(
_d©®’
), \

92 
__VA_ARGS__
); \

94 

	)

95 
	#log_”rÜ
(...) do { \

96 ià(
	`log_loggabË
(
LOG_ERR
) != 0) { \

97 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_ERR
, 0, 
__VA_ARGS__
); \

99 } 0)

	)

101 
	#log_w¬n
(...) do { \

102 ià(
	`log_loggabË
(
LOG_WARN
) != 0) { \

103 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_WARN
, 0, 
__VA_ARGS__
); \

105 } 0)

	)

107 
	#log_nÙiû
(...) do { \

108 ià(
	`log_loggabË
(
LOG_NOTICE
) != 0) { \

109 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_NOTICE
, 0, 
__VA_ARGS__
); \

111 } 0)

	)

113 
	#log_·nic
(...) do { \

114 ià(
	`log_loggabË
(
LOG_EMERG
) != 0) { \

115 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 1, 
__VA_ARGS__
); \

117 } 0)

	)

123 
	#log_zc
(...) do { \

124 ià(
	`log_loggabË
(
LOG_ERR
) != 0) { \

125 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_ZC
, 0, 
__VA_ARGS__
); \

127 } 0)

	)

131 
log_š™
(
Ëv–
, *
f’ame
);

132 
log_deš™
();

133 
log_Ëv–_up
();

134 
log_Ëv–_down
();

135 
log_Ëv–_£t
(
Ëv–
);

136 
log_¡ackŒaû
();

137 
log_»İ’
();

138 
log_loggabË
(
Ëv–
);

140 
_log
(cÚ¡ *
fe
, 
lše
, 
Ëv–
, 
·nic
, cÚ¡ *
fmt
, ...);

141 
_log_¡d”r
(cÚ¡ *
fmt
, ...);

142 
_log_¡dout
(cÚ¡ *
fmt
, ...);

143 
_log_§ã
(cÚ¡ *
fmt
, ...);

144 
_log_¡d”r_§ã
(cÚ¡ *
fmt
, ...);

145 
_log_hexdump
(cÚ¡ *
fe
, 
lše
, *
d©a
, 
d©®’
, cÚ¡ *
fmt
, ...);

147 
log_wr™e_Ën
(* 
¡r
, 
size_t
 
Ën
);

	@dep/util/dlog.h

1 #iâdeà
_DLOG_H_


2 
	#_DLOG_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	slogg”
 {

10 *
	mÇme
;

12 
	mËv–
;

14 
	mfd
;

16 
	mÃ¼Ü
;

20 
	#LOG_EMERG
 0

	)

21 
	#LOG_ALERT
 1

	)

22 
	#LOG_CRIT
 2

	)

23 
	#LOG_ERR
 3

	)

24 
	#LOG_WARN
 4

	)

25 
	#LOG_NOTICE
 5

	)

26 
	#LOG_INFO
 6

	)

27 
	#LOG_DEBUG
 7

	)

28 
	#LOG_VERB
 8

	)

29 
	#LOG_VVERB
 9

	)

30 
	#LOG_VVVERB
 10

	)

31 
	#LOG_PVERB
 11

	)

33 
	#LOG_ZC
 12

	)

34 
	#LOG_MAX_LEN
 256

	)

47 #ifdeà
HAVE_DEBUG_LOG


49 
	#log_debug
(
_Ëv–
, ...) do { \

50 ià(
	`log_loggabË
(
_Ëv–
) != 0) { \

51 
	`_log
(
__FILE__
, 
__LINE__
, 
_Ëv–
, 0, 
__VA_ARGS__
); \

53 } 0)

	)

57 
	#log_debug
(
_Ëv–
, ...)

	)

61 
	#log_hexdump
(
_Ëv–
, 
_d©a
, 
_d©®’
, ...) do { \

62 ià(
	`log_loggabË
(
_Ëv–
) != 0) { \

63 
	`_log
(
__FILE__
, 
__LINE__
, 
_Ëv–
, 0, 
__VA_ARGS__
); \

64 
	`_log_hexdump
(
__FILE__
, 
__LINE__
, (*)(
_d©a
), ()(
_d©®’
), \

65 
__VA_ARGS__
); \

67 } 0)

	)

69 
	#log_¡d”r
(...) do { \

70 
	`_log_¡d”r
(
__VA_ARGS__
); \

71 } 0)

	)

73 
	#log_¡dout
(...) do { \

74 
	`_log_¡dout
(
__VA_ARGS__
); \

75 } 0)

	)

77 
	#log_§ã
(...) do { \

78 
	`_log_§ã
(
__VA_ARGS__
); \

79 } 0)

	)

81 
	#log_¡d”r_§ã
(...) do { \

82 
	`_log_¡d”r_§ã
(
__VA_ARGS__
); \

83 } 0)

	)

85 
	#loga
(...) do { \

86 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 0, 
__VA_ARGS__
); \

87 } 0)

	)

89 
	#loga_hexdump
(
_d©a
, 
_d©®’
, ...) do { \

90 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 0, 
__VA_ARGS__
); \

91 
	`_log_hexdump
(
__FILE__
, 
__LINE__
, (*)(
_d©a
), ()(
_d©®’
), \

92 
__VA_ARGS__
); \

94 

	)

95 
	#log_”rÜ
(...) do { \

96 ià(
	`log_loggabË
(
LOG_ERR
) != 0) { \

97 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_ERR
, 0, 
__VA_ARGS__
); \

99 } 0)

	)

101 
	#log_w¬n
(...) do { \

102 ià(
	`log_loggabË
(
LOG_WARN
) != 0) { \

103 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_WARN
, 0, 
__VA_ARGS__
); \

105 } 0)

	)

107 
	#log_nÙiû
(...) do { \

108 ià(
	`log_loggabË
(
LOG_NOTICE
) != 0) { \

109 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_NOTICE
, 0, 
__VA_ARGS__
); \

111 } 0)

	)

113 
	#log_·nic
(...) do { \

114 ià(
	`log_loggabË
(
LOG_EMERG
) != 0) { \

115 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 1, 
__VA_ARGS__
); \

117 } 0)

	)

123 
	#log_zc
(...) do { \

124 ià(
	`log_loggabË
(
LOG_ERR
) != 0) { \

125 
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_ZC
, 0, 
__VA_ARGS__
); \

127 } 0)

	)

131 
log_š™
(
Ëv–
, *
f’ame
);

132 
log_deš™
();

133 
log_Ëv–_up
();

134 
log_Ëv–_down
();

135 
log_Ëv–_£t
(
Ëv–
);

136 
log_¡ackŒaû
();

137 
log_»İ’
();

138 
log_loggabË
(
Ëv–
);

140 
_log
(cÚ¡ *
fe
, 
lše
, 
Ëv–
, 
·nic
, cÚ¡ *
fmt
, ...);

141 
_log_¡d”r
(cÚ¡ *
fmt
, ...);

142 
_log_¡dout
(cÚ¡ *
fmt
, ...);

143 
_log_§ã
(cÚ¡ *
fmt
, ...);

144 
_log_¡d”r_§ã
(cÚ¡ *
fmt
, ...);

145 
_log_hexdump
(cÚ¡ *
fe
, 
lše
, *
d©a
, 
d©®’
, cÚ¡ *
fmt
, ...);

147 
log_wr™e_Ën
(* 
¡r
, 
size_t
 
Ën
);

	@dep/util/dspecialconfig.h

1 #iâdeà
_DSPECIALCONFIG_H_


2 
	#_DSPECIALCONFIG_H_


	)

4 #ifdeà
__APPLE__


5 
	~<Avaab™yMaüos.h
>

8 #ifdeà
__lšux__


9 
	~<lšux/v”siÚ.h
>

10 
	~<ã©u»s.h
>

13 #ià(
__i386
 || 
__amd64
 || 
__pow”pc__
è&& 
__GNUC__


14 
	#GNUC_VERSION
 (
__GNUC__
 * 10000 + 
__GNUC_MINOR__
 * 100 + 
__GNUC_PATCHLEVEL__
)

	)

15 #ià
defšed
(
__şªg__
)

16 
	#HAVE_ATOMIC


	)

18 #ià(
defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
))

19 #ià(
GNUC_VERSION
 >ğ40100 && 
__GLIBC_PREREQ
(2, 6))

20 
	#HAVE_ATOMIC


	)

26 #ià
defšed
(
__sun
)

27 #ià
defšed
(
__GNUC__
)

28 
	~<m©h.h
>

29 #undeà
i¢ª


30 
	#i¢ª
(
x
) \

31 
	`__ex‹nsiÚ__
({ 
	`__ty³of
 (
x
è
__x_a
 = (x); \

32 
	`__butš_ex³ù
(
__x_a
 !ğ__x_a, 0); })

	)

34 #undeà
isfš™e


35 
	#isfš™e
(
x
) \

36 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_f
 = (x); \

37 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_f
 - __x_f), 1); })

	)

39 #undeà
isšf


40 
	#isšf
(
x
) \

41 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_i
 = (x); \

42 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_i
è&& !
	`isfš™e
(__x_i), 0); })

	)

44 
	#u_št
 
ušt


	)

45 
	#u_št32_t
 
ušt32_t


	)

51 #ifdeà
__lšux__


52 
	#HAVE_PROC_STAT
 1

	)

53 
	#HAVE_PROC_MAPS
 1

	)

54 
	#HAVE_PROC_SMAPS
 1

	)

55 
	#HAVE_PROC_SOMAXCONN
 1

	)

59 #ià
defšed
(
__APPLE__
)

60 
	#HAVE_TASKINFO
 1

	)

	@dep/util/dspecialconfig.h

1 #iâdeà
_DSPECIALCONFIG_H_


2 
	#_DSPECIALCONFIG_H_


	)

4 #ifdeà
__APPLE__


5 
	~<Avaab™yMaüos.h
>

8 #ifdeà
__lšux__


9 
	~<lšux/v”siÚ.h
>

10 
	~<ã©u»s.h
>

13 #ià(
__i386
 || 
__amd64
 || 
__pow”pc__
è&& 
__GNUC__


14 
	#GNUC_VERSION
 (
__GNUC__
 * 10000 + 
__GNUC_MINOR__
 * 100 + 
__GNUC_PATCHLEVEL__
)

	)

15 #ià
defšed
(
__şªg__
)

16 
	#HAVE_ATOMIC


	)

18 #ià(
defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
))

19 #ià(
GNUC_VERSION
 >ğ40100 && 
__GLIBC_PREREQ
(2, 6))

20 
	#HAVE_ATOMIC


	)

26 #ià
defšed
(
__sun
)

27 #ià
defšed
(
__GNUC__
)

28 
	~<m©h.h
>

29 #undeà
i¢ª


30 
	#i¢ª
(
x
) \

31 
	`__ex‹nsiÚ__
({ 
	`__ty³of
 (
x
è
__x_a
 = (x); \

32 
	`__butš_ex³ù
(
__x_a
 !ğ__x_a, 0); })

	)

34 #undeà
isfš™e


35 
	#isfš™e
(
x
) \

36 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_f
 = (x); \

37 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_f
 - __x_f), 1); })

	)

39 #undeà
isšf


40 
	#isšf
(
x
) \

41 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_i
 = (x); \

42 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_i
è&& !
	`isfš™e
(__x_i), 0); })

	)

44 
	#u_št
 
ušt


	)

45 
	#u_št32_t
 
ušt32_t


	)

51 #ifdeà
__lšux__


52 
	#HAVE_PROC_STAT
 1

	)

53 
	#HAVE_PROC_MAPS
 1

	)

54 
	#HAVE_PROC_SMAPS
 1

	)

55 
	#HAVE_PROC_SOMAXCONN
 1

	)

59 #ià
defšed
(
__APPLE__
)

60 
	#HAVE_TASKINFO
 1

	)

	@dep/util/dutil.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡d¬g.h
>

4 
	~<¡ršg.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<Ãtdb.h
>

8 
	~<”ºo.h
>

10 
	~<sys/time.h
>

11 
	~<sys/ty³s.h
>

12 
	~<sys/sock‘.h
>

13 
	~<sys/ioùl.h
>

15 
	~<Ãtš‘/š.h
>

16 
	~<Ãtš‘/tı.h
>

18 #ifdeà
HAVE_CONFIG_H


19 
	~<cÚfig.h
>

22 #ifdeà
HAVE_BACKTRACE


23 
	~<execšfo.h
>

26 
	~<dlog.h
>

27 
	~<dut.h
>

30 #ià
defšed
(
__ATOMIC_RELAXED
)

32 #–ià
defšed
(
HAVE_ATOMIC
)

34 
±h»ad_mu‹x_t
 
	g©omic_lock”
 = 
PTHREAD_MUTEX_INITIALIZER
;

38 
	$das£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
)

40 
	`log_”rÜ
("as£¹ '%s' faed @ (%s, %d)", 
cÚd
, 
fe
, 
lše
);

42 ià(
·nic
) {

43 
	`d¡ackŒaû
(1);

44 
	`abÜt
();

46 
	}
}

49 
	$d¡ackŒaû
(
sk_couÁ
)

51 #ifdeà
HAVE_BACKTRACE


52 *
¡ack
[64];

53 **
symbŞs
;

54 
size
, 
i
, 
j
;

56 
size
 = 
	`backŒaû
(
¡ack
, 64);

57 
symbŞs
 = 
	`backŒaû_symbŞs
(
¡ack
, 
size
);

58 ià(
symbŞs
 =ğ
NULL
) {

62 
sk_couÁ
++;

64 
i
 = 
sk_couÁ
, 
j
 = 0; i < 
size
; i++, j++) {

65 
	`loga
("[%d] %s", 
j
, 
symbŞs
[
i
]);

68 
	`ä“
(
symbŞs
);

70 
	}
}

73 
	$d¡ackŒaû_fd
(
fd
)

75 #ifdeà
HAVE_BACKTRACE


76 *
¡ack
[64];

77 
size
;

79 
size
 = 
	`backŒaû
(
¡ack
, 64);

80 
	`backŒaû_symbŞs_fd
(
¡ack
, 
size
, 
fd
);

82 
	}
}

85 
	$_dvsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
)

87 
n
;

89 
n
 = 
	`v¢´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

101 ià(
n
 <= 0) {

105 ià(
n
 < (è
size
) {

106  
n
;

109  ()(
size
 - 1);

110 
	}
}

113 
	$_dsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...)

115 
va_li¡
 
¬gs
;

116 
n
;

118 
	`va_¡¬t
(
¬gs
, 
fmt
);

119 
n
 = 
	`_dvsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

120 
	`va_’d
(
¬gs
);

122  
n
;

123 
	}
}

126 
	$_§ã_utß
(
_ba£
, 
ušt64_t
 
v®
, *
buf
)

128 
hex
[] = "0123456789abcdef";

129 
ušt32_t
 
ba£
 = (ušt32_tè
_ba£
;

130 *
buf
-- = 0;

132 *
buf
-- = 
hex
[
v®
 % 
ba£
];

133 } (
v®
 /ğ
ba£
) != 0);

134  
buf
 + 1;

135 
	}
}

138 
	$_§ã_™ß
(
ba£
, 
št64_t
 
v®
, *
buf
)

140 
hex
[] = "0123456789abcdef";

141 *
Üig_buf
 = 
buf
;

142 cÚ¡ 
št32_t
 
is_Ãg
 = (
v®
 < 0);

143 *
buf
-- = 0;

145 ià(
is_Ãg
) {

146 
v®
 = -val;

148 ià(
is_Ãg
 && 
ba£
 == 16) {

149 
ix
;

150 
v®
 -= 1;

151 
ix
 = 0; ix < 16; ++ix)

152 
buf
[-
ix
] = '0';

156 *
buf
-- = 
hex
[
v®
 % 
ba£
];

157 } (
v®
 /ğ
ba£
) != 0);

159 ià(
is_Ãg
 && 
ba£
 == 10) {

160 *
buf
-- = '-';

163 ià(
is_Ãg
 && 
ba£
 == 16) {

164 
ix
;

165 
buf
 = 
Üig_buf
 - 1;

166 
ix
 = 0; ix < 16; ++ix, --
buf
) {

168 *
buf
) {

169 '0': *
buf
 = 'f'; ;

170 '1': *
buf
 = 'e'; ;

171 '2': *
buf
 = 'd'; ;

172 '3': *
buf
 = 'c'; ;

173 '4': *
buf
 = 'b'; ;

174 '5': *
buf
 = 'a'; ;

175 '6': *
buf
 = '9'; ;

176 '7': *
buf
 = '8'; ;

177 '8': *
buf
 = '7'; ;

178 '9': *
buf
 = '6'; ;

179 'a': *
buf
 = '5'; ;

180 'b': *
buf
 = '4'; ;

181 'c': *
buf
 = '3'; ;

182 'd': *
buf
 = '2'; ;

183 'e': *
buf
 = '1'; ;

184 'f': *
buf
 = '0'; ;

189  
buf
 + 1;

190 
	}
}

193 
	$_§ã_check_lÚglÚg
(cÚ¡ *
fmt
, *
have_lÚglÚg
)

195 *
have_lÚglÚg
 = 0;

196 ià(*
fmt
 == 'l') {

197 
fmt
++;

198 ià(*
fmt
 != 'l') {

199 *
have_lÚglÚg
 = (() == ());

201 
fmt
++;

202 *
have_lÚglÚg
 = 1;

205  
fmt
;

206 
	}
}

209 
	$_§ã_v¢´štf
(*
to
, 
size_t
 
size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

211 *
¡¬t
 = 
to
;

212 *
’d
 = 
¡¬t
 + 
size
 - 1;

213 ; *
fÜm©
; ++format) {

214 
have_lÚglÚg
 = 0;

215 ià(*
fÜm©
 != '%') {

216 ià(
to
 =ğ
’d
) {

219 *
to
++ = *
fÜm©
;

222 ++
fÜm©
;

224 
fÜm©
 = 
	`_§ã_check_lÚglÚg
(fÜm©, &
have_lÚglÚg
);

226 *
fÜm©
) {

233 
št64_t
 
iv®
 = 0;

234 
ušt64_t
 
uv®
 = 0;

235 ià(*
fÜm©
 == 'p')

236 
have_lÚglÚg
 = ((*è=ğ(
ušt64_t
));

237 ià(
have_lÚglÚg
) {

238 ià(*
fÜm©
 == 'u') {

239 
uv®
 = 
	`va_¬g
(
­
, 
ušt64_t
);

241 
iv®
 = 
	`va_¬g
(
­
, 
št64_t
);

244 ià(*
fÜm©
 == 'u') {

245 
uv®
 = 
	`va_¬g
(
­
, 
ušt32_t
);

247 
iv®
 = 
	`va_¬g
(
­
, 
št32_t
);

252 
buff
[22];

253 cÚ¡ 
ba£
 = (*
fÜm©
 == 'x' || *format == 'p') ? 16 : 10;

256 *
v®_as_¡r
 = (*
fÜm©
 == 'u') ?

257 
	`_§ã_utß
(
ba£
, 
uv®
, &
buff
[(buff) - 1]) :

258 
	`_§ã_™ß
(
ba£
, 
iv®
, &
buff
[(buff) - 1]);

262 ià(*
fÜm©
 =ğ'x' && !
have_lÚglÚg
 && 
iv®
 < 0) {

263 
v®_as_¡r
 += 8;

266 *
v®_as_¡r
 && 
to
 < 
’d
) {

267 *
to
++ = *
v®_as_¡r
++;

274 cÚ¡ *
v®
 = 
	`va_¬g
(
­
, *);

275 ià(!
v®
) {

276 
v®
 = "(null)";

278 *
v®
 && 
to
 < 
’d
) {

279 *
to
++ = *
v®
++;

285 *
to
 = 0;

286  ()(
to
 - 
¡¬t
);

287 
	}
}

290 
	$_§ã_¢´štf
(*
to
, 
size_t
 
n
, cÚ¡ *
fmt
, ...)

292 
»suÉ
;

293 
va_li¡
 
¬gs
;

294 
	`va_¡¬t
(
¬gs
, 
fmt
);

295 
»suÉ
 = 
	`_§ã_v¢´štf
(
to
, 
n
, 
fmt
, 
¬gs
);

296 
	`va_’d
(
¬gs
);

297  
»suÉ
;

298 
	}
}

304 
	$du£c_now
()

306 
timev®
 
now
;

307 
št64_t
 
u£c
;

308 
¡©us
;

310 
¡©us
 = 
	`g‘timeofday
(&
now
, 
NULL
);

311 ià(
¡©us
 < 0) {

312 
	`log_”rÜ
("g‘timeofday faed: %s", 
	`¡»¼Ü
(
”ºo
));

316 
u£c
 = (
št64_t
)
now
.
tv_£c
 * 1000000LL + (št64_têow.
tv_u£c
;

318  
u£c
;

319 
	}
}

325 
	$dm£c_now
()

327  
	`du£c_now
() / 1000LL;

328 
	}
}

334 
	$d£c_now
()

336  
	`du£c_now
() / 1000000LL;

337 
	}
}

340 
	$¡ršg_m©ch_Ën
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

341 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

343 
·‰”nL’
) {

344 
·‰”n
[0]) {

346 
·‰”n
[1] == '*') {

347 
·‰”n
++;

348 
·‰”nL’
--;

350 ià(
·‰”nL’
 == 1)

352 
¡ršgL’
) {

353 ià(
	`¡ršg_m©ch_Ën
(
·‰”n
+1, 
·‰”nL’
-1,

354 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

356 
¡ršg
++;

357 
¡ršgL’
--;

362 ià(
¡ršgL’
 == 0)

364 
¡ršg
++;

365 
¡ršgL’
--;

369 
nÙ
, 
m©ch
;

371 
·‰”n
++;

372 
·‰”nL’
--;

373 
nÙ
 = 
·‰”n
[0] == '^';

374 ià(
nÙ
) {

375 
·‰”n
++;

376 
·‰”nL’
--;

378 
m©ch
 = 0;

380 ià(
·‰”n
[0] == '\\') {

381 
·‰”n
++;

382 
·‰”nL’
--;

383 ià(
·‰”n
[0] =ğ
¡ršg
[0])

384 
m©ch
 = 1;

385 } ià(
·‰”n
[0] == ']') {

387 } ià(
·‰”nL’
 == 0) {

388 
·‰”n
--;

389 
·‰”nL’
++;

391 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

392 
¡¬t
 = 
·‰”n
[0];

393 
’d
 = 
·‰”n
[2];

394 
c
 = 
¡ršg
[0];

395 ià(
¡¬t
 > 
’d
) {

396 
t
 = 
¡¬t
;

397 
¡¬t
 = 
’d
;

398 
’d
 = 
t
;

400 ià(
noÿ£
) {

401 
¡¬t
 = 
	`tŞow”
(start);

402 
’d
 = 
	`tŞow”
(end);

403 
c
 = 
	`tŞow”
(c);

405 
·‰”n
 += 2;

406 
·‰”nL’
 -= 2;

407 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

408 
m©ch
 = 1;

410 ià(!
noÿ£
) {

411 ià(
·‰”n
[0] =ğ
¡ršg
[0])

412 
m©ch
 = 1;

414 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

415 
m©ch
 = 1;

418 
·‰”n
++;

419 
·‰”nL’
--;

421 ià(
nÙ
)

422 
m©ch
 = !match;

423 ià(!
m©ch
)

425 
¡ršg
++;

426 
¡ršgL’
--;

430 ià(
·‰”nL’
 >= 2) {

431 
·‰”n
++;

432 
·‰”nL’
--;

436 ià(!
noÿ£
) {

437 ià(
·‰”n
[0] !ğ
¡ršg
[0])

440 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

443 
¡ršg
++;

444 
¡ršgL’
--;

447 
·‰”n
++;

448 
·‰”nL’
--;

449 ià(
¡ršgL’
 == 0) {

450 *
·‰”n
 == '*') {

451 
·‰”n
++;

452 
·‰”nL’
--;

457 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

460 
	}
}

462 
	$¡ršg_m©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

463  
	`¡ršg_m©ch_Ën
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

464 
	}
}

	@dep/util/dutil.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡d¬g.h
>

4 
	~<¡ršg.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<Ãtdb.h
>

8 
	~<”ºo.h
>

10 
	~<sys/time.h
>

11 
	~<sys/ty³s.h
>

12 
	~<sys/sock‘.h
>

13 
	~<sys/ioùl.h
>

15 
	~<Ãtš‘/š.h
>

16 
	~<Ãtš‘/tı.h
>

18 #ifdeà
HAVE_CONFIG_H


19 
	~<cÚfig.h
>

22 #ifdeà
HAVE_BACKTRACE


23 
	~<execšfo.h
>

26 
	~<dlog.h
>

27 
	~<dut.h
>

30 #ià
defšed
(
__ATOMIC_RELAXED
)

32 #–ià
defšed
(
HAVE_ATOMIC
)

34 
±h»ad_mu‹x_t
 
	g©omic_lock”
 = 
PTHREAD_MUTEX_INITIALIZER
;

38 
	$das£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
)

40 
	`log_”rÜ
("as£¹ '%s' faed @ (%s, %d)", 
cÚd
, 
fe
, 
lše
);

42 ià(
·nic
) {

43 
	`d¡ackŒaû
(1);

44 
	`abÜt
();

46 
	}
}

49 
	$d¡ackŒaû
(
sk_couÁ
)

51 #ifdeà
HAVE_BACKTRACE


52 *
¡ack
[64];

53 **
symbŞs
;

54 
size
, 
i
, 
j
;

56 
size
 = 
	`backŒaû
(
¡ack
, 64);

57 
symbŞs
 = 
	`backŒaû_symbŞs
(
¡ack
, 
size
);

58 ià(
symbŞs
 =ğ
NULL
) {

62 
sk_couÁ
++;

64 
i
 = 
sk_couÁ
, 
j
 = 0; i < 
size
; i++, j++) {

65 
	`loga
("[%d] %s", 
j
, 
symbŞs
[
i
]);

68 
	`ä“
(
symbŞs
);

70 
	}
}

73 
	$d¡ackŒaû_fd
(
fd
)

75 #ifdeà
HAVE_BACKTRACE


76 *
¡ack
[64];

77 
size
;

79 
size
 = 
	`backŒaû
(
¡ack
, 64);

80 
	`backŒaû_symbŞs_fd
(
¡ack
, 
size
, 
fd
);

82 
	}
}

85 
	$_dvsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
)

87 
n
;

89 
n
 = 
	`v¢´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

101 ià(
n
 <= 0) {

105 ià(
n
 < (è
size
) {

106  
n
;

109  ()(
size
 - 1);

110 
	}
}

113 
	$_dsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...)

115 
va_li¡
 
¬gs
;

116 
n
;

118 
	`va_¡¬t
(
¬gs
, 
fmt
);

119 
n
 = 
	`_dvsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

120 
	`va_’d
(
¬gs
);

122  
n
;

123 
	}
}

126 
	$_§ã_utß
(
_ba£
, 
ušt64_t
 
v®
, *
buf
)

128 
hex
[] = "0123456789abcdef";

129 
ušt32_t
 
ba£
 = (ušt32_tè
_ba£
;

130 *
buf
-- = 0;

132 *
buf
-- = 
hex
[
v®
 % 
ba£
];

133 } (
v®
 /ğ
ba£
) != 0);

134  
buf
 + 1;

135 
	}
}

138 
	$_§ã_™ß
(
ba£
, 
št64_t
 
v®
, *
buf
)

140 
hex
[] = "0123456789abcdef";

141 *
Üig_buf
 = 
buf
;

142 cÚ¡ 
št32_t
 
is_Ãg
 = (
v®
 < 0);

143 *
buf
-- = 0;

145 ià(
is_Ãg
) {

146 
v®
 = -val;

148 ià(
is_Ãg
 && 
ba£
 == 16) {

149 
ix
;

150 
v®
 -= 1;

151 
ix
 = 0; ix < 16; ++ix)

152 
buf
[-
ix
] = '0';

156 *
buf
-- = 
hex
[
v®
 % 
ba£
];

157 } (
v®
 /ğ
ba£
) != 0);

159 ià(
is_Ãg
 && 
ba£
 == 10) {

160 *
buf
-- = '-';

163 ià(
is_Ãg
 && 
ba£
 == 16) {

164 
ix
;

165 
buf
 = 
Üig_buf
 - 1;

166 
ix
 = 0; ix < 16; ++ix, --
buf
) {

168 *
buf
) {

169 '0': *
buf
 = 'f'; ;

170 '1': *
buf
 = 'e'; ;

171 '2': *
buf
 = 'd'; ;

172 '3': *
buf
 = 'c'; ;

173 '4': *
buf
 = 'b'; ;

174 '5': *
buf
 = 'a'; ;

175 '6': *
buf
 = '9'; ;

176 '7': *
buf
 = '8'; ;

177 '8': *
buf
 = '7'; ;

178 '9': *
buf
 = '6'; ;

179 'a': *
buf
 = '5'; ;

180 'b': *
buf
 = '4'; ;

181 'c': *
buf
 = '3'; ;

182 'd': *
buf
 = '2'; ;

183 'e': *
buf
 = '1'; ;

184 'f': *
buf
 = '0'; ;

189  
buf
 + 1;

190 
	}
}

193 
	$_§ã_check_lÚglÚg
(cÚ¡ *
fmt
, *
have_lÚglÚg
)

195 *
have_lÚglÚg
 = 0;

196 ià(*
fmt
 == 'l') {

197 
fmt
++;

198 ià(*
fmt
 != 'l') {

199 *
have_lÚglÚg
 = (() == ());

201 
fmt
++;

202 *
have_lÚglÚg
 = 1;

205  
fmt
;

206 
	}
}

209 
	$_§ã_v¢´štf
(*
to
, 
size_t
 
size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

211 *
¡¬t
 = 
to
;

212 *
’d
 = 
¡¬t
 + 
size
 - 1;

213 ; *
fÜm©
; ++format) {

214 
have_lÚglÚg
 = 0;

215 ià(*
fÜm©
 != '%') {

216 ià(
to
 =ğ
’d
) {

219 *
to
++ = *
fÜm©
;

222 ++
fÜm©
;

224 
fÜm©
 = 
	`_§ã_check_lÚglÚg
(fÜm©, &
have_lÚglÚg
);

226 *
fÜm©
) {

233 
št64_t
 
iv®
 = 0;

234 
ušt64_t
 
uv®
 = 0;

235 ià(*
fÜm©
 == 'p')

236 
have_lÚglÚg
 = ((*è=ğ(
ušt64_t
));

237 ià(
have_lÚglÚg
) {

238 ià(*
fÜm©
 == 'u') {

239 
uv®
 = 
	`va_¬g
(
­
, 
ušt64_t
);

241 
iv®
 = 
	`va_¬g
(
­
, 
št64_t
);

244 ià(*
fÜm©
 == 'u') {

245 
uv®
 = 
	`va_¬g
(
­
, 
ušt32_t
);

247 
iv®
 = 
	`va_¬g
(
­
, 
št32_t
);

252 
buff
[22];

253 cÚ¡ 
ba£
 = (*
fÜm©
 == 'x' || *format == 'p') ? 16 : 10;

256 *
v®_as_¡r
 = (*
fÜm©
 == 'u') ?

257 
	`_§ã_utß
(
ba£
, 
uv®
, &
buff
[(buff) - 1]) :

258 
	`_§ã_™ß
(
ba£
, 
iv®
, &
buff
[(buff) - 1]);

262 ià(*
fÜm©
 =ğ'x' && !
have_lÚglÚg
 && 
iv®
 < 0) {

263 
v®_as_¡r
 += 8;

266 *
v®_as_¡r
 && 
to
 < 
’d
) {

267 *
to
++ = *
v®_as_¡r
++;

274 cÚ¡ *
v®
 = 
	`va_¬g
(
­
, *);

275 ià(!
v®
) {

276 
v®
 = "(null)";

278 *
v®
 && 
to
 < 
’d
) {

279 *
to
++ = *
v®
++;

285 *
to
 = 0;

286  ()(
to
 - 
¡¬t
);

287 
	}
}

290 
	$_§ã_¢´štf
(*
to
, 
size_t
 
n
, cÚ¡ *
fmt
, ...)

292 
»suÉ
;

293 
va_li¡
 
¬gs
;

294 
	`va_¡¬t
(
¬gs
, 
fmt
);

295 
»suÉ
 = 
	`_§ã_v¢´štf
(
to
, 
n
, 
fmt
, 
¬gs
);

296 
	`va_’d
(
¬gs
);

297  
»suÉ
;

298 
	}
}

304 
	$du£c_now
()

306 
timev®
 
now
;

307 
št64_t
 
u£c
;

308 
¡©us
;

310 
¡©us
 = 
	`g‘timeofday
(&
now
, 
NULL
);

311 ià(
¡©us
 < 0) {

312 
	`log_”rÜ
("g‘timeofday faed: %s", 
	`¡»¼Ü
(
”ºo
));

316 
u£c
 = (
št64_t
)
now
.
tv_£c
 * 1000000LL + (št64_têow.
tv_u£c
;

318  
u£c
;

319 
	}
}

325 
	$dm£c_now
()

327  
	`du£c_now
() / 1000LL;

328 
	}
}

334 
	$d£c_now
()

336  
	`du£c_now
() / 1000000LL;

337 
	}
}

340 
	$¡ršg_m©ch_Ën
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

341 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

343 
·‰”nL’
) {

344 
·‰”n
[0]) {

346 
·‰”n
[1] == '*') {

347 
·‰”n
++;

348 
·‰”nL’
--;

350 ià(
·‰”nL’
 == 1)

352 
¡ršgL’
) {

353 ià(
	`¡ršg_m©ch_Ën
(
·‰”n
+1, 
·‰”nL’
-1,

354 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

356 
¡ršg
++;

357 
¡ršgL’
--;

362 ià(
¡ršgL’
 == 0)

364 
¡ršg
++;

365 
¡ršgL’
--;

369 
nÙ
, 
m©ch
;

371 
·‰”n
++;

372 
·‰”nL’
--;

373 
nÙ
 = 
·‰”n
[0] == '^';

374 ià(
nÙ
) {

375 
·‰”n
++;

376 
·‰”nL’
--;

378 
m©ch
 = 0;

380 ià(
·‰”n
[0] == '\\') {

381 
·‰”n
++;

382 
·‰”nL’
--;

383 ià(
·‰”n
[0] =ğ
¡ršg
[0])

384 
m©ch
 = 1;

385 } ià(
·‰”n
[0] == ']') {

387 } ià(
·‰”nL’
 == 0) {

388 
·‰”n
--;

389 
·‰”nL’
++;

391 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

392 
¡¬t
 = 
·‰”n
[0];

393 
’d
 = 
·‰”n
[2];

394 
c
 = 
¡ršg
[0];

395 ià(
¡¬t
 > 
’d
) {

396 
t
 = 
¡¬t
;

397 
¡¬t
 = 
’d
;

398 
’d
 = 
t
;

400 ià(
noÿ£
) {

401 
¡¬t
 = 
	`tŞow”
(start);

402 
’d
 = 
	`tŞow”
(end);

403 
c
 = 
	`tŞow”
(c);

405 
·‰”n
 += 2;

406 
·‰”nL’
 -= 2;

407 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

408 
m©ch
 = 1;

410 ià(!
noÿ£
) {

411 ià(
·‰”n
[0] =ğ
¡ršg
[0])

412 
m©ch
 = 1;

414 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

415 
m©ch
 = 1;

418 
·‰”n
++;

419 
·‰”nL’
--;

421 ià(
nÙ
)

422 
m©ch
 = !match;

423 ià(!
m©ch
)

425 
¡ršg
++;

426 
¡ršgL’
--;

430 ià(
·‰”nL’
 >= 2) {

431 
·‰”n
++;

432 
·‰”nL’
--;

436 ià(!
noÿ£
) {

437 ià(
·‰”n
[0] !ğ
¡ršg
[0])

440 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

443 
¡ršg
++;

444 
¡ršgL’
--;

447 
·‰”n
++;

448 
·‰”nL’
--;

449 ià(
¡ršgL’
 == 0) {

450 *
·‰”n
 == '*') {

451 
·‰”n
++;

452 
·‰”nL’
--;

457 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

460 
	}
}

462 
	$¡ršg_m©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

463  
	`¡ršg_m©ch_Ën
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

464 
	}
}

	@dep/util/dutil.h

1 #iâdeà
_DUTIL_H_


2 
	#_DUTIL_H_


	)

4 
	~<¡d¬g.h
>

6 
	~<d¥ecŸlcÚfig.h
>

8 
	#UNUSED
(
x
è()(x)

	)

10 
	#LF
 (
ušt8_t
è10

	)

11 
	#CR
 (
ušt8_t
è13

	)

12 
	#CRLF
 "\x0d\x0a"

	)

13 
	#CRLF_LEN
 (("\x0d\x0a"è- 1)

	)

15 
	#NELEMS
(
a
è((×)è/ (×)[0]))

	)

17 
	#MIN
(
a
, 
b
è(×è< (bè? (aè: (b))

	)

18 
	#MAX
(
a
, 
b
è(×è> (bè? (aè: (b))

	)

20 
	#SQUARE
(
d
è((dè* (d))

	)

21 
	#VAR
(
s
, 
s2
, 
n
è((Òè< 2è? 0.0 : ((s2è- 
	`SQUARE
(s)/Ò)è/ (Òè- 1))

	)

22 
	#STDDEV
(
s
, 
s2
, 
n
è((Òè< 2è? 0.0 : 
	`sq¹
(
	`VAR
((s), (s2), (n))))

	)

29 #ifdeà
HAVE_ASSERT_PANIC


31 
	#ASSERT
(
_x
) do { \

32 ià(!(
_x
)) { \

33 
	`das£¹
(#_x, 
__FILE__
, 
__LINE__
, 1); \

35 } 0)

	)

37 
	#NOT_REACHED
(è
	`ASSERT
(0)

	)

39 #–ià
HAVE_ASSERT_LOG


41 
	#ASSERT
(
_x
) do { \

42 ià(!(
_x
)) { \

43 
	`das£¹
(#_x, 
__FILE__
, 
__LINE__
, 0); \

45 } 0)

	)

47 
	#NOT_REACHED
(è
	`ASSERT
(0)

	)

51 
	#ASSERT
(
_x
)

	)

53 
	#NOT_REACHED
()

	)

57 
das£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
);

58 
d¡ackŒaû
(
sk_couÁ
);

59 
d¡ackŒaû_fd
(
fd
);

61 
_dsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...);

62 
_dvsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
);

63 
du£c_now
();

64 
dm£c_now
();

65 
d£c_now
();

78 
_§ã_v¢´štf
(*
to
, 
size_t
 
size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

79 
_§ã_¢´štf
(*
to
, 
size_t
 
n
, cÚ¡ *
fmt
, ...);

81 
	#d§ã_¢´štf
(
_s
, 
_n
, ...) \

82 
	`_§ã_¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
__VA_ARGS__
)

	)

84 
	#d§ã_v¢´štf
(
_s
, 
_n
, 
_f
, 
_a
) \

85 
	`_§ã_v¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
_f
, 
_a
)

	)

101 
	#d¢´štf
(
_s
, 
_n
, ...) \

102 
	`¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
__VA_ARGS__
)

	)

104 
	#dsú´štf
(
_s
, 
_n
, ...) \

105 
	`_dsú´štf
((*)(
_s
), (
size_t
)(
_n
), 
__VA_ARGS__
)

	)

107 
	#dv¢´štf
(
_s
, 
_n
, 
_f
, 
_a
) \

108 
	`v¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
_f
, 
_a
)

	)

110 
	#dvsú´štf
(
_s
, 
_n
, 
_f
, 
_a
) \

111 
	`_dvsú´štf
((*)(
_s
), (
size_t
)(
_n
), 
_f
, 
_a
)

	)

113 
	#d¡ráime
(
_s
, 
_n
, 
fmt
, 
tm
) \

114 ()
	`¡ráime
((*)(
_s
), (
size_t
)(
_n
), 
fmt
, 
tm
)

	)

116 
¡ršg_m©ch_Ën
(cÚ¡ *
·‰”n
, 
·‰”nL’
, cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
);

117 
¡ršg_m©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
);

122 #ià
defšed
(
__ATOMIC_RELAXED
)

123 
	#©omic_add
(
_v®ue
, 
_n
è
	`__©omic_add_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

124 
	#©omic_sub
(
_v®ue
, 
_n
è
	`__©omic_sub_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

125 
	#©omic_£t
(
_v®ue
, 
_n
è
	`__©omic_¡Üe_n
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

126 
	#©omic_g‘
(
_v®ue
, 
_v
) do { \

127 
	`__©omic_lßd
(&
_v®ue
, 
_v
, 
__ATOMIC_RELAXED
); \

128 } 0)

	)

130 
	#ATOMIC_LOCK_TYPE
 "__ATOMIC_RELAXED"

	)

132 #–ià
defšed
(
HAVE_ATOMIC
)

133 
	#©omic_add
(
_v®ue
, 
_n
è
	`__sync_add_ªd_ãtch
(&_v®ue, (_n))

	)

134 
	#©omic_sub
(
_v®ue
, 
_n
è
	`__sync_sub_ªd_ãtch
(&_v®ue, (_n))

	)

135 
	#©omic_£t
(
_v®ue
, 
_n
è
	`__sync_lock_‹¡_ªd_£t
(&_v®ue, (_n))

	)

136 
	#©omic_g‘
(
_v®ue
, 
_v
) do { \

137 (*
_v
èğ
	`__sync_add_ªd_ãtch
(&
_v®ue
, 0); \

138 } 0)

	)

140 
	#ATOMIC_LOCK_TYPE
 "HAVE_ATOMIC"

	)

142 
±h»ad_mu‹x_t
 
©omic_lock”
;

144 
	#©omic_add
(
_v®ue
, 
_n
) do { \

145 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

146 
_v®ue
 +ğ(
_n
); \

147 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

148 } 0)

	)

150 
	#©omic_sub
(
_v®ue
, 
_n
) do { \

151 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

152 
_v®ue
 -ğ(
_n
); \

153 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

154 } 0)

	)

156 
	#©omic_£t
(
_v®ue
, 
_n
) do { \

157 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

158 
_v®ue
 = (
_n
); \

159 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

160 } 0)

	)

162 
	#©omic_g‘
(
_v®ue
, 
_v
) do { \

163 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

164 (*
_v
èğ
_v®ue
; \

165 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

166 } 0)

	)

168 
	#ATOMIC_LOCK_TYPE
 "±h»ad_mu‹x_lock"

	)

	@dep/util/dutil.h

1 #iâdeà
_DUTIL_H_


2 
	#_DUTIL_H_


	)

4 
	~<¡d¬g.h
>

6 
	~<d¥ecŸlcÚfig.h
>

8 
	#UNUSED
(
x
è()(x)

	)

10 
	#LF
 (
ušt8_t
è10

	)

11 
	#CR
 (
ušt8_t
è13

	)

12 
	#CRLF
 "\x0d\x0a"

	)

13 
	#CRLF_LEN
 (("\x0d\x0a"è- 1)

	)

15 
	#NELEMS
(
a
è((×)è/ (×)[0]))

	)

17 
	#MIN
(
a
, 
b
è(×è< (bè? (aè: (b))

	)

18 
	#MAX
(
a
, 
b
è(×è> (bè? (aè: (b))

	)

20 
	#SQUARE
(
d
è((dè* (d))

	)

21 
	#VAR
(
s
, 
s2
, 
n
è((Òè< 2è? 0.0 : ((s2è- 
	`SQUARE
(s)/Ò)è/ (Òè- 1))

	)

22 
	#STDDEV
(
s
, 
s2
, 
n
è((Òè< 2è? 0.0 : 
	`sq¹
(
	`VAR
((s), (s2), (n))))

	)

29 #ifdeà
HAVE_ASSERT_PANIC


31 
	#ASSERT
(
_x
) do { \

32 ià(!(
_x
)) { \

33 
	`das£¹
(#_x, 
__FILE__
, 
__LINE__
, 1); \

35 } 0)

	)

37 
	#NOT_REACHED
(è
	`ASSERT
(0)

	)

39 #–ià
HAVE_ASSERT_LOG


41 
	#ASSERT
(
_x
) do { \

42 ià(!(
_x
)) { \

43 
	`das£¹
(#_x, 
__FILE__
, 
__LINE__
, 0); \

45 } 0)

	)

47 
	#NOT_REACHED
(è
	`ASSERT
(0)

	)

51 
	#ASSERT
(
_x
)

	)

53 
	#NOT_REACHED
()

	)

57 
das£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
);

58 
d¡ackŒaû
(
sk_couÁ
);

59 
d¡ackŒaû_fd
(
fd
);

61 
_dsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...);

62 
_dvsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
);

63 
du£c_now
();

64 
dm£c_now
();

65 
d£c_now
();

78 
_§ã_v¢´štf
(*
to
, 
size_t
 
size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

79 
_§ã_¢´štf
(*
to
, 
size_t
 
n
, cÚ¡ *
fmt
, ...);

81 
	#d§ã_¢´štf
(
_s
, 
_n
, ...) \

82 
	`_§ã_¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
__VA_ARGS__
)

	)

84 
	#d§ã_v¢´štf
(
_s
, 
_n
, 
_f
, 
_a
) \

85 
	`_§ã_v¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
_f
, 
_a
)

	)

101 
	#d¢´štf
(
_s
, 
_n
, ...) \

102 
	`¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
__VA_ARGS__
)

	)

104 
	#dsú´štf
(
_s
, 
_n
, ...) \

105 
	`_dsú´štf
((*)(
_s
), (
size_t
)(
_n
), 
__VA_ARGS__
)

	)

107 
	#dv¢´štf
(
_s
, 
_n
, 
_f
, 
_a
) \

108 
	`v¢´štf
((*)(
_s
), (
size_t
)(
_n
), 
_f
, 
_a
)

	)

110 
	#dvsú´štf
(
_s
, 
_n
, 
_f
, 
_a
) \

111 
	`_dvsú´štf
((*)(
_s
), (
size_t
)(
_n
), 
_f
, 
_a
)

	)

113 
	#d¡ráime
(
_s
, 
_n
, 
fmt
, 
tm
) \

114 ()
	`¡ráime
((*)(
_s
), (
size_t
)(
_n
), 
fmt
, 
tm
)

	)

116 
¡ršg_m©ch_Ën
(cÚ¡ *
·‰”n
, 
·‰”nL’
, cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
);

117 
¡ršg_m©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
);

122 #ià
defšed
(
__ATOMIC_RELAXED
)

123 
	#©omic_add
(
_v®ue
, 
_n
è
	`__©omic_add_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

124 
	#©omic_sub
(
_v®ue
, 
_n
è
	`__©omic_sub_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

125 
	#©omic_£t
(
_v®ue
, 
_n
è
	`__©omic_¡Üe_n
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

126 
	#©omic_g‘
(
_v®ue
, 
_v
) do { \

127 
	`__©omic_lßd
(&
_v®ue
, 
_v
, 
__ATOMIC_RELAXED
); \

128 } 0)

	)

130 
	#ATOMIC_LOCK_TYPE
 "__ATOMIC_RELAXED"

	)

132 #–ià
defšed
(
HAVE_ATOMIC
)

133 
	#©omic_add
(
_v®ue
, 
_n
è
	`__sync_add_ªd_ãtch
(&_v®ue, (_n))

	)

134 
	#©omic_sub
(
_v®ue
, 
_n
è
	`__sync_sub_ªd_ãtch
(&_v®ue, (_n))

	)

135 
	#©omic_£t
(
_v®ue
, 
_n
è
	`__sync_lock_‹¡_ªd_£t
(&_v®ue, (_n))

	)

136 
	#©omic_g‘
(
_v®ue
, 
_v
) do { \

137 (*
_v
èğ
	`__sync_add_ªd_ãtch
(&
_v®ue
, 0); \

138 } 0)

	)

140 
	#ATOMIC_LOCK_TYPE
 "HAVE_ATOMIC"

	)

142 
±h»ad_mu‹x_t
 
©omic_lock”
;

144 
	#©omic_add
(
_v®ue
, 
_n
) do { \

145 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

146 
_v®ue
 +ğ(
_n
); \

147 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

148 } 0)

	)

150 
	#©omic_sub
(
_v®ue
, 
_n
) do { \

151 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

152 
_v®ue
 -ğ(
_n
); \

153 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

154 } 0)

	)

156 
	#©omic_£t
(
_v®ue
, 
_n
) do { \

157 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

158 
_v®ue
 = (
_n
); \

159 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

160 } 0)

	)

162 
	#©omic_g‘
(
_v®ue
, 
_v
) do { \

163 
	`±h»ad_mu‹x_lock
(&
©omic_lock”
); \

164 (*
_v
èğ
_v®ue
; \

165 
	`±h»ad_mu‹x_uÆock
(&
©omic_lock”
); \

166 } 0)

	)

168 
	#ATOMIC_LOCK_TYPE
 "±h»ad_mu‹x_lock"

	)

	@src/vr.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<sigÇl.h
>

5 
	~<g‘İt.h
>

6 
	~<fú.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/ut¢ame.h
>

10 
	~<vr_cÜe.h
>

11 
	~<vr_cÚf.h
>

12 
	~<vr_sigÇl.h
>

15 
	#VR_CONF_PATH
 "cÚf/vœe.cÚf"

	)

18 
	#VR_LOG_DEFAULT
 
LOG_ZC


	)

19 
	#VR_LOG_MIN
 
LOG_EMERG


	)

20 
	#VR_LOG_MAX
 
LOG_PVERB


	)

21 
	#VR_LOG_PATH
 
NULL


	)

24 
	#VR_PORT
 8889

	)

26 
	#VR_ADDR
 "0.0.0.0"

	)

28 
	#VR_INTERVAL
 (30 * 1000è

	)

30 
	#VR_PID_FILE
 
NULL


	)

32 
	#VR_THREAD_NUM_DEFAULT
 (
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>6?6:syscÚf(_SC_NPROCESSORS_ONLN))

	)

34 #iâdeà
PRINT_STACK


35 
	#PRINT_STACK
 12345

	)

38 
	$Pršt_Func
(*
¡r
){

39 ià(
PRINT_STACK
 != 12345)

43 
	`´štf
("\Âow in:%s\n",
¡r
);

44 
	}
}

47 cÚ¡ 
	gSHOWIMG
 = 1;

50 
	gshow_h–p
;

52 
	gshow_v”siÚ
;

54 
	g‹¡_cÚf
;

56 
	gd«mÚize
;

58 
İtiÚ
 
	glÚg_İtiÚs
[] = {

59 { "h–p", 
no_¬gum’t
, 
NULL
, 'h' },

60 { "v”siÚ", 
no_¬gum’t
, 
NULL
, 'V' },

61 { "‹¡-cÚf", 
no_¬gum’t
, 
NULL
, 't' },

62 { "d«mÚize", 
no_¬gum’t
, 
NULL
, 'd' },

63 { "v”bo£", 
»quœed_¬gum’t
, 
NULL
, 'v' },

64 { "ouut", 
»quœed_¬gum’t
, 
NULL
, 'o' },

65 { "cÚf-fe", 
»quœed_¬gum’t
, 
NULL
, 'c' },

66 { "pid-fe", 
»quœed_¬gum’t
, 
NULL
, 'p' },

67 { "th»ad-num", 
»quœed_¬gum’t
, 
NULL
, 'T' },

68 { 
NULL
, 0, NULL, 0 }

72 
	gshÜt_İtiÚs
[] = "hVtdv:o:c:p:T:";

75 
r¡©us_t


76 
	$vr_d«mÚize
(
dump_cÜe
)

78 
r¡©us_t
 
¡©us
;

79 
pid_t
 
pid
, 
sid
;

80 
fd
;

82 
pid
 = 
	`fÜk
();

83 
pid
) {

85 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

86  
VR_ERROR
;

93 
	`_ex™
(0);

98 
sid
 = 
	`£tsid
();

99 ià(
sid
 < 0) {

100 
	`log_”rÜ
("£tsid(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

101  
VR_ERROR
;

104 ià(
	`sigÇl
(
SIGHUP
, 
SIG_IGN
è=ğ
SIG_ERR
) {

105 
	`log_”rÜ
("sigÇl(SIGHUP, SIG_IGNèçed: %s", 
	`¡»¼Ü
(
”ºo
));

106  
VR_ERROR
;

109 
pid
 = 
	`fÜk
();

110 
pid
) {

112 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

113  
VR_ERROR
;

120 
	`_ex™
(0);

126 ià(
dump_cÜe
 == 0) {

127 
¡©us
 = 
	`chdœ
("/");

128 ià(
¡©us
 < 0) {

129 
	`log_”rÜ
("chdœ(\"/\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

130  
VR_ERROR
;

135 
	`umask
(0);

139 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

140 ià(
fd
 < 0) {

141 
	`log_”rÜ
("İ’(\"/dev/nuÎ\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

142  
VR_ERROR
;

145 
¡©us
 = 
	`dup2
(
fd
, 
STDIN_FILENO
);

146 ià(
¡©us
 < 0) {

147 
	`log_”rÜ
("dup2(%d, STDINèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

148 
	`şo£
(
fd
);

149  
VR_ERROR
;

152 
¡©us
 = 
	`dup2
(
fd
, 
STDOUT_FILENO
);

153 ià(
¡©us
 < 0) {

154 
	`log_”rÜ
("dup2(%d, STDOUTèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

155 
	`şo£
(
fd
);

156  
VR_ERROR
;

159 
¡©us
 = 
	`dup2
(
fd
, 
STDERR_FILENO
);

160 ià(
¡©us
 < 0) {

161 
	`log_”rÜ
("dup2(%d, STDERRèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

162 
	`şo£
(
fd
);

163  
VR_ERROR
;

166 ià(
fd
 > 
STDERR_FILENO
) {

167 
¡©us
 = 
	`şo£
(
fd
);

168 ià(
¡©us
 < 0) {

169 
	`log_”rÜ
("şo£(%dèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

170  
VR_ERROR
;

174  
VR_OK
;

175 
	}
}

178 
	$vr_´št_run
(
š¡ªû
 *
nci
)

180 
¡©us
;

181 
ut¢ame
 
Çme
;

183 
¡©us
 = 
	`uÇme
(&
Çme
);

190 *
ascii_logo1
 =

196 )/`.,'\\Ğ \À\
|. ,| \À\
:6è (6; \À\
\\`\\ _(\\ \À\
\\._'; `.
___
...---..
________
...------.
_
 \
n
 \

201 \\ | ,' . . . . .`:. \À\
\\`.' . . . . . . . \\ \
n
 \

203 `. . . \\ . . ..::: . :: \
n
 \

204 \\ . . . ..::::::::'' ': . || \À\
\\ `. :. .:' \\ '. . ;; \À\
`._ \\ ::: ; _,\ :. |/Ğ \À\
`.`::: /--....---''' \\ `. :. :`\\` \
n
 \

208 | |:': \\ `. :.\\ \À\
| |' ; \\ (\\ .\\ \
n
 \

210 | |.: \\ \\`. : \
n
 \

211 |.| | ) / :.| \
n
 \

212 | |.| /./ | | \
n
 \

213 |.| | / / | | \
n
 \

214 | | | /./ |.| \
n
 \

215 ;
_
;_; ,'_/ ;_| \À\
'-/
	`_
( '--' /,' \n \
" ;

218 
	`´štf
("%s",
ascii_logo1
);

224 ià(
nci
->
log_f’ame
) {

225 *
ascii_logo
 = 
ascii_logo1
;

244 *
buf
 = 
	`d®loc
(1024*16);

245 
	`¢´štf
(
buf
,1024*16,
ascii_logo
,

246 
VR_VERSION_STRING
,

248 "¡ªd®Úe", 
£rv”
.
pÜt
,

249 (è
nci
->
pid
,

250 
¡©us
 < 0 ? " ":
Çme
.
sy¢ame
,

251 
¡©us
 < 0 ? " ":
Çme
.
»Ëa£
,

252 
¡©us
 < 0 ? " ":
Çme
.
machše
);

253 
	`log_wr™e_Ën
(
buf
, 
	`¡¾’
(buf));

254 
	`dä“
(
buf
);

256 
buf
[256];

257 
	`¢´štf
(
buf
,256,"Vire %s, %s bit, %s mode,…ort %d,…id %ld, built for %s %s %s„eadyo„un.\n",

258 
VR_VERSION_STRING
, (() == 8) ? "64" : "32",

259 "¡ªd®Úe", 
£rv”
.
pÜt
, (è
nci
->
pid
,

260 
¡©us
 < 0 ? " ":
Çme
.
sy¢ame
,

261 
¡©us
 < 0 ? " ":
Çme
.
»Ëa£
,

262 
¡©us
 < 0 ? " ":
Çme
.
machše
);

263 
	`log_wr™e_Ën
(
buf
, 
	`¡¾’
(buf));

265 
	}
}

268 
	$vr_´št_dÚe
()

270 
	`loga
("done,„abbit done");

271 
	}
}

274 
	$vr_show_u§ge
()

276 
	`log_¡d”r
(

277 "U§ge: vœ[-?hVdt] [-v v”bos™y†ev–] [-Øouuˆfe]" 
CRLF


278 " [-øcÚàfe] [-°pid fe]" 
CRLF


279 " [-T wÜk”h»ad numb”]" 
CRLF


281 
	`log_¡d”r
(

282 "O±iÚs:" 
CRLF


283 " -h, --h–° :hi h–p" 
CRLF


284 " -V, --v”siÚ : show v”siÚ‡ndƒx™" 
CRLF


285 " -t, --‹¡-cÚà :e¡ cÚfigu¿tiÚ fÜ syÁaxƒ¼Ü ªdƒx™" 
CRLF


287 
	`log_¡d”r
(

288 " -v, --v”bo£=N : s‘†oggšg†ev– (deçuÉ: %d, mš: %d, max: %d)" 
CRLF


289 " -o, --ouut=S : s‘†oggšg f(deçuÉ: %s)" 
CRLF


290 " -c, --cÚf-fe=S : s‘ cÚfigu¿tiÚ f(deçuÉ: %s)" 
CRLF


291 " -p, --pid-fe=S : s‘…id f(deçuÉ: %s)" 
CRLF


292 " -T, --th»ad_num=N : s‘hwÜk”h»ad numb” (deçuÉ: %d)" 
CRLF


294 
VR_LOG_DEFAULT
, 
VR_LOG_MIN
, 
VR_LOG_MAX
,

295 
VR_LOG_PATH
 !ğ
NULL
 ? VR_LOG_PATH : "stderr",

296 
VR_CONF_PATH
,

297 
VR_PID_FILE
 !ğ
NULL
 ? VR_PID_FILE : "off",

298 
VR_THREAD_NUM_DEFAULT
);

299 
	}
}

301 
r¡©us_t


302 
	$vr_ü—‹_pidfe
(
š¡ªû
 *
nci
)

304 
pid
[
VR_UINTMAX_MAXLEN
];

305 
fd
, 
pid_Ën
;

306 
ssize_t
 
n
;

308 
fd
 = 
	`İ’
(
nci
->
pid_f’ame
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

309 ià(
fd
 < 0) {

310 
	`log_”rÜ
("İ’šg…id f'%s' faed: %s", 
nci
->
pid_f’ame
,

311 
	`¡»¼Ü
(
”ºo
));

312  
VR_ERROR
;

314 
nci
->
pidfe
 = 1;

316 
pid_Ën
 = 
	`d¢´štf
(
pid
, 
VR_UINTMAX_MAXLEN
, "%d", 
nci
->pid);

318 
n
 = 
	`vr_wr™e
(
fd
, 
pid
, 
pid_Ën
);

319 ià(
n
 < 0) {

320 
	`log_”rÜ
("wr™tØpid f'%s' faed: %s", 
nci
->
pid_f’ame
,

321 
	`¡»¼Ü
(
”ºo
));

322  
VR_ERROR
;

325 
	`şo£
(
fd
);

327  
VR_OK
;

328 
	}
}

332 
	$vr_»move_pidfe
(
š¡ªû
 *
nci
)

334 
¡©us
;

336 
¡©us
 = 
	`uÆšk
(
nci
->
pid_f’ame
);

337 ià(
¡©us
 < 0) {

338 
	`log_”rÜ
("unlink of…id file '%s' failed, ignored: %s",

339 
nci
->
pid_f’ame
, 
	`¡»¼Ü
(
”ºo
));

341 
	}
}

344 
	$vr_£t_deçuÉ_İtiÚs
(
š¡ªû
 *
nci
)

347 
¡©us
;

349 
nci
->
log_Ëv–
 = 
VR_LOG_DEFAULT
;

350 
nci
->
log_f’ame
 = 
VR_LOG_PATH
;

352 
nci
->
cÚf_f’ame
 = 
VR_CONF_PATH
;

355 
¡©us
 = 
	`vr_g‘ho¡Çme
(
nci
->
ho¡Çme
, 
VR_MAXHOSTNAMELEN
);

356 ià(
¡©us
 < 0) {

357 
	`log_w¬n
("g‘ho¡Çmçed, ignÜed: %s", 
	`¡»¼Ü
(
”ºo
));

358 
	`d¢´štf
(
nci
->
ho¡Çme
, 
VR_MAXHOSTNAMELEN
, "unknown");

360 
nci
->
ho¡Çme
[
VR_MAXHOSTNAMELEN
 - 1] = '\0';

362 
nci
->
pid
 = (
pid_t
)-1;

363 
nci
->
pid_f’ame
 = 
NULL
;

364 
nci
->
pidfe
 = 0;

366 
nci
->
th»ad_num
 = ()
VR_THREAD_NUM_DEFAULT
;

367 
	}
}

369 
r¡©us_t


370 
	$vr_g‘_İtiÚs
(
¬gc
, **
¬gv
, 
š¡ªû
 *
nci
)

372 
c
, 
v®ue
;

374 
İ‹¼
 = 0;

378 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İtiÚs
, 
lÚg_İtiÚs
, 
NULL
);

379 ià(
c
 == -1) {

384 
c
) {

386 
show_v”siÚ
 = 1;

387 
show_h–p
 = 1;

391 
show_v”siÚ
 = 1;

395 
‹¡_cÚf
 = 1;

399 
d«mÚize
 = 1;

403 
v®ue
 = 
	`vr_©oi
(
İrg
, 
	`¡¾’
(optarg));

404 ià(
v®ue
 < 0) {

405 
	`log_¡d”r
("vire: option -v„equires‡‚umber");

406  
VR_ERROR
;

408 
nci
->
log_Ëv–
 = 
v®ue
;

412 
nci
->
log_f’ame
 = 
İrg
;

416 
nci
->
cÚf_f’ame
 = 
İrg
;

420 
nci
->
pid_f’ame
 = 
İrg
;

424 
v®ue
 = 
	`vr_©oi
(
İrg
, 
	`¡¾’
(optarg));

425 ià(
v®ue
 < 0) {

426 
	`log_¡d”r
("vire: option -T„equires‡‚umber");

427  
VR_ERROR
;

430 
nci
->
th»ad_num
 = 
v®ue
;

434 
İtİt
) {

438 
	`log_¡d”r
("vire: option -%c„equires‡ file‚ame",

439 
İtİt
);

444 
	`log_¡d”r
("vœe: o±iÚ -%ø»quœe ¨numb”", 
İtİt
);

448 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

451  
VR_ERROR
;

454 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

455  
VR_ERROR
;

460  
VR_OK
;

461 
	}
}

468 
boŞ


469 
	$vr_‹¡_cÚf
(
š¡ªû
 *
nci
, 
‹¡
)

471 
vr_cÚf
 *
cf
;

473 
cf
 = 
	`cÚf_ü—‹
(
nci
->
cÚf_f’ame
);

475 ià(
cf
 =ğ
NULL
) {

476 ià(
‹¡
)

477 
	`log_¡d”r
("vire: configuration file '%s' syntax is invalid",

478 
nci
->
cÚf_f’ame
);

479  
çl£
;

482 
	`cÚf_de¡roy
(
cf
);

484 ià(
‹¡
)

485 
	`log_¡d”r
("vire: configuration file '%s' syntax is ok",

486 
nci
->
cÚf_f’ame
);

487  
Œue
;

488 
	}
}

492 
	$vr_´e_run
(
š¡ªû
 *
nci
)

494 
»t
;

496 
»t
 = 
	`log_š™
(
nci
->
log_Ëv–
,‚ci->
log_f’ame
);

497 ià(
»t
 !ğ
VR_OK
) {

498  
»t
;

501 
	`log_debug
(
LOG_VERB
, "Vœu£d†ogfe: %s", 
nci
->
cÚf_f’ame
);

503 ià(!
	`vr_‹¡_cÚf
(
nci
, 
çl£
)) {

504 
	`log_”rÜ
("cÚàf% i ”rÜ", 
nci
->
cÚf_f’ame
);

505  
VR_ERROR
;

508 ià(
d«mÚize
) {

509 
»t
 = 
	`vr_d«mÚize
(1);

510 ià(
»t
 !ğ
VR_OK
) {

511  
»t
;

515 
nci
->
pid
 = 
	`g‘pid
();

517 
»t
 = 
	`sigÇl_š™
();

518 ià(
»t
 !ğ
VR_OK
) {

519  
»t
;

522 ià(
nci
->
pid_f’ame
) {

523 
»t
 = 
	`vr_ü—‹_pidfe
(
nci
);

524 ià(
»t
 !ğ
VR_OK
) {

525  
VR_ERROR
;

529 
»t
 = 
	`š™_£rv”
(
nci
);

530 ià(
»t
 !ğ
VR_OK
) {

531  
VR_ERROR
;

534 
	`vr_´št_run
(
nci
);

536  
VR_OK
;

537 
	}
}

540 
	$vr_po¡_run
(
š¡ªû
 *
nci
)

544 
	`wÜk”s_deš™
();

546 
	`back’ds_deš™
();

548 
	`ma¡”_deš™
();

550 ià(
nci
->
pidfe
) {

551 
	`vr_»move_pidfe
(
nci
);

554 
	`sigÇl_deš™
();

556 
	`vr_´št_dÚe
();

558 
	`log_deš™
();

559 
	}
}

563 
	$vr_run
(
š¡ªû
 *
nci
)

566 ià(
nci
->
th»ad_num
 <= 0) {

567 
	`log_”rÜ
("number of workhreads must be greaterhan 0");

569 } ià(
nci
->
th»ad_num
 > 64) {

570 
	`log_w¬n
("WARNING: Setting‡ high‚umber of workerhreads is‚ot„ecommended."

576 
	`ma¡”_run
();

578 
	`wÜk”s_run
();

580 
	`back’ds_run
();

584 
	`wÜk”s_wa™
();

586 
	`back’ds_wa™
();

587 
	}
}

591 
	$maš
(
¬gc
, **
¬gv
)

593 
r¡©us_t
 
¡©us
;

594 
š¡ªû
 
nci
;

596 
	`vr_£t_deçuÉ_İtiÚs
(&
nci
);

598 
¡©us
 = 
	`vr_g‘_İtiÚs
(
¬gc
, 
¬gv
, &
nci
);

599 ià(
¡©us
 !ğ
VR_OK
) {

601 
	`vr_show_u§ge
();

602 
	`ex™
(1);

605 ià(
show_v”siÚ
) {

606 
	`log_¡d”r
("Thi i vœe-%s" 
CRLF
, 
VR_VERSION_STRING
);

607 ià(
show_h–p
) {

608 
	`vr_show_u§ge
();

610 
	`ex™
(0);

613 ià(
‹¡_cÚf
) {

614 ià(!
	`vr_‹¡_cÚf
(&
nci
, 
Œue
)) {

615 
	`ex™
(1);

617 
	`ex™
(0);

620 
¡©us
 = 
	`vr_´e_run
(&
nci
);

621 ià(
¡©us
 !ğ
VR_OK
) {

622 
	`vr_po¡_run
(&
nci
);

623 
	`ex™
(1);

627 
£rv”
.
execubË
 = 
	`g‘AbsŞu‹P©h
(
¬gv
[0]);

629 
	`vr_run
(&
nci
);

631 
	`vr_po¡_run
(&
nci
);

633  
VR_OK
;

634 
	}
}

	@src/vr.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<sigÇl.h
>

5 
	~<g‘İt.h
>

6 
	~<fú.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/ut¢ame.h
>

10 
	~<vr_cÜe.h
>

11 
	~<vr_cÚf.h
>

12 
	~<vr_sigÇl.h
>

15 
	#VR_CONF_PATH
 "cÚf/vœe.cÚf"

	)

18 
	#VR_LOG_DEFAULT
 
LOG_ZC


	)

19 
	#VR_LOG_MIN
 
LOG_EMERG


	)

20 
	#VR_LOG_MAX
 
LOG_PVERB


	)

21 
	#VR_LOG_PATH
 
NULL


	)

24 
	#VR_PORT
 8889

	)

26 
	#VR_ADDR
 "0.0.0.0"

	)

28 
	#VR_INTERVAL
 (30 * 1000è

	)

30 
	#VR_PID_FILE
 
NULL


	)

32 
	#VR_THREAD_NUM_DEFAULT
 (
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>6?6:syscÚf(_SC_NPROCESSORS_ONLN))

	)

34 #iâdeà
PRINT_STACK


35 
	#PRINT_STACK
 12345

	)

38 
	$Pršt_Func
(*
¡r
){

39 ià(
PRINT_STACK
 != 12345)

43 
	`´štf
("\Âow in:%s\n",
¡r
);

44 
	}
}

47 cÚ¡ 
	gSHOWIMG
 = 1;

50 
	gshow_h–p
;

52 
	gshow_v”siÚ
;

54 
	g‹¡_cÚf
;

56 
	gd«mÚize
;

58 
İtiÚ
 
	glÚg_İtiÚs
[] = {

59 { "h–p", 
no_¬gum’t
, 
NULL
, 'h' },

60 { "v”siÚ", 
no_¬gum’t
, 
NULL
, 'V' },

61 { "‹¡-cÚf", 
no_¬gum’t
, 
NULL
, 't' },

62 { "d«mÚize", 
no_¬gum’t
, 
NULL
, 'd' },

63 { "v”bo£", 
»quœed_¬gum’t
, 
NULL
, 'v' },

64 { "ouut", 
»quœed_¬gum’t
, 
NULL
, 'o' },

65 { "cÚf-fe", 
»quœed_¬gum’t
, 
NULL
, 'c' },

66 { "pid-fe", 
»quœed_¬gum’t
, 
NULL
, 'p' },

67 { "th»ad-num", 
»quœed_¬gum’t
, 
NULL
, 'T' },

68 { 
NULL
, 0, NULL, 0 }

72 
	gshÜt_İtiÚs
[] = "hVtdv:o:c:p:T:";

75 
r¡©us_t


76 
	$vr_d«mÚize
(
dump_cÜe
)

78 
r¡©us_t
 
¡©us
;

79 
pid_t
 
pid
, 
sid
;

80 
fd
;

82 
pid
 = 
	`fÜk
();

83 
pid
) {

85 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

86  
VR_ERROR
;

93 
	`_ex™
(0);

98 
sid
 = 
	`£tsid
();

99 ià(
sid
 < 0) {

100 
	`log_”rÜ
("£tsid(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

101  
VR_ERROR
;

104 ià(
	`sigÇl
(
SIGHUP
, 
SIG_IGN
è=ğ
SIG_ERR
) {

105 
	`log_”rÜ
("sigÇl(SIGHUP, SIG_IGNèçed: %s", 
	`¡»¼Ü
(
”ºo
));

106  
VR_ERROR
;

109 
pid
 = 
	`fÜk
();

110 
pid
) {

112 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

113  
VR_ERROR
;

120 
	`_ex™
(0);

126 ià(
dump_cÜe
 == 0) {

127 
¡©us
 = 
	`chdœ
("/");

128 ià(
¡©us
 < 0) {

129 
	`log_”rÜ
("chdœ(\"/\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

130  
VR_ERROR
;

135 
	`umask
(0);

139 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

140 ià(
fd
 < 0) {

141 
	`log_”rÜ
("İ’(\"/dev/nuÎ\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

142  
VR_ERROR
;

145 
¡©us
 = 
	`dup2
(
fd
, 
STDIN_FILENO
);

146 ià(
¡©us
 < 0) {

147 
	`log_”rÜ
("dup2(%d, STDINèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

148 
	`şo£
(
fd
);

149  
VR_ERROR
;

152 
¡©us
 = 
	`dup2
(
fd
, 
STDOUT_FILENO
);

153 ià(
¡©us
 < 0) {

154 
	`log_”rÜ
("dup2(%d, STDOUTèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

155 
	`şo£
(
fd
);

156  
VR_ERROR
;

159 
¡©us
 = 
	`dup2
(
fd
, 
STDERR_FILENO
);

160 ià(
¡©us
 < 0) {

161 
	`log_”rÜ
("dup2(%d, STDERRèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

162 
	`şo£
(
fd
);

163  
VR_ERROR
;

166 ià(
fd
 > 
STDERR_FILENO
) {

167 
¡©us
 = 
	`şo£
(
fd
);

168 ià(
¡©us
 < 0) {

169 
	`log_”rÜ
("şo£(%dèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

170  
VR_ERROR
;

174  
VR_OK
;

175 
	}
}

178 
	$vr_´št_run
(
š¡ªû
 *
nci
)

180 
¡©us
;

181 
ut¢ame
 
Çme
;

183 
¡©us
 = 
	`uÇme
(&
Çme
);

190 *
ascii_logo1
 =

196 )/`.,'\\Ğ \À\
|. ,| \À\
:6è (6; \À\
\\`\\ _(\\ \À\
\\._'; `.
___
...---..
________
...------.
_
 \
n
 \

201 \\ | ,' . . . . .`:. \À\
\\`.' . . . . . . . \\ \
n
 \

203 `. . . \\ . . ..::: . :: \
n
 \

204 \\ . . . ..::::::::'' ': . || \À\
\\ `. :. .:' \\ '. . ;; \À\
`._ \\ ::: ; _,\ :. |/Ğ \À\
`.`::: /--....---''' \\ `. :. :`\\` \
n
 \

208 | |:': \\ `. :.\\ \À\
| |' ; \\ (\\ .\\ \
n
 \

210 | |.: \\ \\`. : \
n
 \

211 |.| | ) / :.| \
n
 \

212 | |.| /./ | | \
n
 \

213 |.| | / / | | \
n
 \

214 | | | /./ |.| \
n
 \

215 ;
_
;_; ,'_/ ;_| \À\
'-/
	`_
( '--' /,' \n \
" ;

218 
	`´štf
("%s",
ascii_logo1
);

224 ià(
nci
->
log_f’ame
) {

225 *
ascii_logo
 = 
ascii_logo1
;

244 *
buf
 = 
	`d®loc
(1024*16);

245 
	`¢´štf
(
buf
,1024*16,
ascii_logo
,

246 
VR_VERSION_STRING
,

248 "¡ªd®Úe", 
£rv”
.
pÜt
,

249 (è
nci
->
pid
,

250 
¡©us
 < 0 ? " ":
Çme
.
sy¢ame
,

251 
¡©us
 < 0 ? " ":
Çme
.
»Ëa£
,

252 
¡©us
 < 0 ? " ":
Çme
.
machše
);

253 
	`log_wr™e_Ën
(
buf
, 
	`¡¾’
(buf));

254 
	`dä“
(
buf
);

256 
buf
[256];

257 
	`¢´štf
(
buf
,256,"Vire %s, %s bit, %s mode,…ort %d,…id %ld, built for %s %s %s„eadyo„un.\n",

258 
VR_VERSION_STRING
, (() == 8) ? "64" : "32",

259 "¡ªd®Úe", 
£rv”
.
pÜt
, (è
nci
->
pid
,

260 
¡©us
 < 0 ? " ":
Çme
.
sy¢ame
,

261 
¡©us
 < 0 ? " ":
Çme
.
»Ëa£
,

262 
¡©us
 < 0 ? " ":
Çme
.
machše
);

263 
	`log_wr™e_Ën
(
buf
, 
	`¡¾’
(buf));

265 
	}
}

268 
	$vr_´št_dÚe
()

270 
	`loga
("done,„abbit done");

271 
	}
}

274 
	$vr_show_u§ge
()

276 
	`log_¡d”r
(

277 "U§ge: vœ[-?hVdt] [-v v”bos™y†ev–] [-Øouuˆfe]" 
CRLF


278 " [-øcÚàfe] [-°pid fe]" 
CRLF


279 " [-T wÜk”h»ad numb”]" 
CRLF


281 
	`log_¡d”r
(

282 "O±iÚs:" 
CRLF


283 " -h, --h–° :hi h–p" 
CRLF


284 " -V, --v”siÚ : show v”siÚ‡ndƒx™" 
CRLF


285 " -t, --‹¡-cÚà :e¡ cÚfigu¿tiÚ fÜ syÁaxƒ¼Ü ªdƒx™" 
CRLF


287 
	`log_¡d”r
(

288 " -v, --v”bo£=N : s‘†oggšg†ev– (deçuÉ: %d, mš: %d, max: %d)" 
CRLF


289 " -o, --ouut=S : s‘†oggšg f(deçuÉ: %s)" 
CRLF


290 " -c, --cÚf-fe=S : s‘ cÚfigu¿tiÚ f(deçuÉ: %s)" 
CRLF


291 " -p, --pid-fe=S : s‘…id f(deçuÉ: %s)" 
CRLF


292 " -T, --th»ad_num=N : s‘hwÜk”h»ad numb” (deçuÉ: %d)" 
CRLF


294 
VR_LOG_DEFAULT
, 
VR_LOG_MIN
, 
VR_LOG_MAX
,

295 
VR_LOG_PATH
 !ğ
NULL
 ? VR_LOG_PATH : "stderr",

296 
VR_CONF_PATH
,

297 
VR_PID_FILE
 !ğ
NULL
 ? VR_PID_FILE : "off",

298 
VR_THREAD_NUM_DEFAULT
);

299 
	}
}

301 
r¡©us_t


302 
	$vr_ü—‹_pidfe
(
š¡ªû
 *
nci
)

304 
pid
[
VR_UINTMAX_MAXLEN
];

305 
fd
, 
pid_Ën
;

306 
ssize_t
 
n
;

308 
fd
 = 
	`İ’
(
nci
->
pid_f’ame
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

309 ià(
fd
 < 0) {

310 
	`log_”rÜ
("İ’šg…id f'%s' faed: %s", 
nci
->
pid_f’ame
,

311 
	`¡»¼Ü
(
”ºo
));

312  
VR_ERROR
;

314 
nci
->
pidfe
 = 1;

316 
pid_Ën
 = 
	`d¢´štf
(
pid
, 
VR_UINTMAX_MAXLEN
, "%d", 
nci
->pid);

318 
n
 = 
	`vr_wr™e
(
fd
, 
pid
, 
pid_Ën
);

319 ià(
n
 < 0) {

320 
	`log_”rÜ
("wr™tØpid f'%s' faed: %s", 
nci
->
pid_f’ame
,

321 
	`¡»¼Ü
(
”ºo
));

322  
VR_ERROR
;

325 
	`şo£
(
fd
);

327  
VR_OK
;

328 
	}
}

332 
	$vr_»move_pidfe
(
š¡ªû
 *
nci
)

334 
¡©us
;

336 
¡©us
 = 
	`uÆšk
(
nci
->
pid_f’ame
);

337 ià(
¡©us
 < 0) {

338 
	`log_”rÜ
("unlink of…id file '%s' failed, ignored: %s",

339 
nci
->
pid_f’ame
, 
	`¡»¼Ü
(
”ºo
));

341 
	}
}

344 
	$vr_£t_deçuÉ_İtiÚs
(
š¡ªû
 *
nci
)

347 
¡©us
;

349 
nci
->
log_Ëv–
 = 
VR_LOG_DEFAULT
;

350 
nci
->
log_f’ame
 = 
VR_LOG_PATH
;

352 
nci
->
cÚf_f’ame
 = 
VR_CONF_PATH
;

355 
¡©us
 = 
	`vr_g‘ho¡Çme
(
nci
->
ho¡Çme
, 
VR_MAXHOSTNAMELEN
);

356 ià(
¡©us
 < 0) {

357 
	`log_w¬n
("g‘ho¡Çmçed, ignÜed: %s", 
	`¡»¼Ü
(
”ºo
));

358 
	`d¢´štf
(
nci
->
ho¡Çme
, 
VR_MAXHOSTNAMELEN
, "unknown");

360 
nci
->
ho¡Çme
[
VR_MAXHOSTNAMELEN
 - 1] = '\0';

362 
nci
->
pid
 = (
pid_t
)-1;

363 
nci
->
pid_f’ame
 = 
NULL
;

364 
nci
->
pidfe
 = 0;

366 
nci
->
th»ad_num
 = ()
VR_THREAD_NUM_DEFAULT
;

367 
	}
}

369 
r¡©us_t


370 
	$vr_g‘_İtiÚs
(
¬gc
, **
¬gv
, 
š¡ªû
 *
nci
)

372 
c
, 
v®ue
;

374 
İ‹¼
 = 0;

378 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İtiÚs
, 
lÚg_İtiÚs
, 
NULL
);

379 ià(
c
 == -1) {

384 
c
) {

386 
show_v”siÚ
 = 1;

387 
show_h–p
 = 1;

391 
show_v”siÚ
 = 1;

395 
‹¡_cÚf
 = 1;

399 
d«mÚize
 = 1;

403 
v®ue
 = 
	`vr_©oi
(
İrg
, 
	`¡¾’
(optarg));

404 ià(
v®ue
 < 0) {

405 
	`log_¡d”r
("vire: option -v„equires‡‚umber");

406  
VR_ERROR
;

408 
nci
->
log_Ëv–
 = 
v®ue
;

412 
nci
->
log_f’ame
 = 
İrg
;

416 
nci
->
cÚf_f’ame
 = 
İrg
;

420 
nci
->
pid_f’ame
 = 
İrg
;

424 
v®ue
 = 
	`vr_©oi
(
İrg
, 
	`¡¾’
(optarg));

425 ià(
v®ue
 < 0) {

426 
	`log_¡d”r
("vire: option -T„equires‡‚umber");

427  
VR_ERROR
;

430 
nci
->
th»ad_num
 = 
v®ue
;

434 
İtİt
) {

438 
	`log_¡d”r
("vire: option -%c„equires‡ file‚ame",

439 
İtİt
);

444 
	`log_¡d”r
("vœe: o±iÚ -%ø»quœe ¨numb”", 
İtİt
);

448 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

451  
VR_ERROR
;

454 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

455  
VR_ERROR
;

460  
VR_OK
;

461 
	}
}

468 
boŞ


469 
	$vr_‹¡_cÚf
(
š¡ªû
 *
nci
, 
‹¡
)

471 
vr_cÚf
 *
cf
;

473 
cf
 = 
	`cÚf_ü—‹
(
nci
->
cÚf_f’ame
);

475 ià(
cf
 =ğ
NULL
) {

476 ià(
‹¡
)

477 
	`log_¡d”r
("vire: configuration file '%s' syntax is invalid",

478 
nci
->
cÚf_f’ame
);

479  
çl£
;

482 
	`cÚf_de¡roy
(
cf
);

484 ià(
‹¡
)

485 
	`log_¡d”r
("vire: configuration file '%s' syntax is ok",

486 
nci
->
cÚf_f’ame
);

487  
Œue
;

488 
	}
}

492 
	$vr_´e_run
(
š¡ªû
 *
nci
)

494 
»t
;

496 
»t
 = 
	`log_š™
(
nci
->
log_Ëv–
,‚ci->
log_f’ame
);

497 ià(
»t
 !ğ
VR_OK
) {

498  
»t
;

501 
	`log_debug
(
LOG_VERB
, "Vœu£d†ogfe: %s", 
nci
->
cÚf_f’ame
);

503 ià(!
	`vr_‹¡_cÚf
(
nci
, 
çl£
)) {

504 
	`log_”rÜ
("cÚàf% i ”rÜ", 
nci
->
cÚf_f’ame
);

505  
VR_ERROR
;

508 ià(
d«mÚize
) {

509 
»t
 = 
	`vr_d«mÚize
(1);

510 ià(
»t
 !ğ
VR_OK
) {

511  
»t
;

515 
nci
->
pid
 = 
	`g‘pid
();

517 
»t
 = 
	`sigÇl_š™
();

518 ià(
»t
 !ğ
VR_OK
) {

519  
»t
;

522 ià(
nci
->
pid_f’ame
) {

523 
»t
 = 
	`vr_ü—‹_pidfe
(
nci
);

524 ià(
»t
 !ğ
VR_OK
) {

525  
VR_ERROR
;

529 
»t
 = 
	`š™_£rv”
(
nci
);

530 ià(
»t
 !ğ
VR_OK
) {

531  
VR_ERROR
;

534 
	`vr_´št_run
(
nci
);

536  
VR_OK
;

537 
	}
}

540 
	$vr_po¡_run
(
š¡ªû
 *
nci
)

544 
	`wÜk”s_deš™
();

546 
	`back’ds_deš™
();

548 
	`ma¡”_deš™
();

550 ià(
nci
->
pidfe
) {

551 
	`vr_»move_pidfe
(
nci
);

554 
	`sigÇl_deš™
();

556 
	`vr_´št_dÚe
();

558 
	`log_deš™
();

559 
	}
}

563 
	$vr_run
(
š¡ªû
 *
nci
)

566 ià(
nci
->
th»ad_num
 <= 0) {

567 
	`log_”rÜ
("number of workhreads must be greaterhan 0");

569 } ià(
nci
->
th»ad_num
 > 64) {

570 
	`log_w¬n
("WARNING: Setting‡ high‚umber of workerhreads is‚ot„ecommended."

576 
	`ma¡”_run
();

578 
	`wÜk”s_run
();

580 
	`back’ds_run
();

584 
	`wÜk”s_wa™
();

586 
	`back’ds_wa™
();

587 
	}
}

591 
	$maš
(
¬gc
, **
¬gv
)

593 
r¡©us_t
 
¡©us
;

594 
š¡ªû
 
nci
;

596 
	`vr_£t_deçuÉ_İtiÚs
(&
nci
);

598 
¡©us
 = 
	`vr_g‘_İtiÚs
(
¬gc
, 
¬gv
, &
nci
);

599 ià(
¡©us
 !ğ
VR_OK
) {

601 
	`vr_show_u§ge
();

602 
	`ex™
(1);

605 ià(
show_v”siÚ
) {

606 
	`log_¡d”r
("Thi i vœe-%s" 
CRLF
, 
VR_VERSION_STRING
);

607 ià(
show_h–p
) {

608 
	`vr_show_u§ge
();

610 
	`ex™
(0);

613 ià(
‹¡_cÚf
) {

614 ià(!
	`vr_‹¡_cÚf
(&
nci
, 
Œue
)) {

615 
	`ex™
(1);

617 
	`ex™
(0);

620 
¡©us
 = 
	`vr_´e_run
(&
nci
);

621 ià(
¡©us
 !ğ
VR_OK
) {

622 
	`vr_po¡_run
(&
nci
);

623 
	`ex™
(1);

627 
£rv”
.
execubË
 = 
	`g‘AbsŞu‹P©h
(
¬gv
[0]);

629 
	`vr_run
(&
nci
);

631 
	`vr_po¡_run
(&
nci
);

633  
VR_OK
;

634 
	}
}

	@src/vr_aof.c

1 
	~<vr_cÜe.h
>

4 
	$aofRewr™eBufãrSize
() {

5 
dli¡Node
 *
Ê
;

6 
dli¡I‹r
 
li
;

7 
size
 = 0;

9 
	`dli¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

10 (
Ê
 = 
	`dli¡Next
(&
li
))) {

11 
aoäwblock
 *
block
 = 
	`dli¡NodeV®ue
(
Ê
);

12 
size
 +ğ
block
->
u£d
;

14  
size
;

15 
	}
}

24 
sds
 
	$ÿtAµ’dOÆyExpœeAtCommªd
(
sds
 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
) {

25 
wh’
;

26 
robj
 *
¬gv
[3];

29 
£cÚds
 = 
	`g‘DecodedObjeù
(seconds);

30 
wh’
 = 
	`¡¹Şl
(
£cÚds
->
±r
,
NULL
,10);

32 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
£‹xCommªd
 ||

33 
cmd
->
´oc
 =ğ
expœ—tCommªd
)

35 
wh’
 *= 1000;

38 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

39 
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
)

41 
wh’
 +ğ
	`vr_m£c_now
();

43 
	`deüRefCouÁ
(
£cÚds
);

45 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PEXPIREAT",9);

46 
¬gv
[1] = 
key
;

47 
¬gv
[2] = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
wh’
);

48 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf, 3, 
¬gv
);

49 
	`deüRefCouÁ
(
¬gv
[0]);

50 
	`deüRefCouÁ
(
¬gv
[2]);

51  
buf
;

52 
	}
}

54 
sds
 
	$ÿtAµ’dOÆyG’”icCommªd
(
sds
 
d¡
, 
¬gc
, 
robj
 **
¬gv
) {

55 
buf
[32];

56 
Ën
, 
j
;

57 
robj
 *
o
;

59 
buf
[0] = '*';

60 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
¬gc
);

61 
buf
[
Ën
++] = '\r';

62 
buf
[
Ën
++] = '\n';

63 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

65 
j
 = 0; j < 
¬gc
; j++) {

66 
o
 = 
	`g‘DecodedObjeù
(
¬gv
[
j
]);

67 
buf
[0] = '$';

68 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
	`sd¦’
(
o
->
±r
));

69 
buf
[
Ën
++] = '\r';

70 
buf
[
Ën
++] = '\n';

71 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

72 
d¡
 = 
	`sdsÿ’
(d¡,
o
->
±r
,
	`sd¦’
(o->ptr));

73 
d¡
 = 
	`sdsÿ’
(dst,"\r\n",2);

74 
	`deüRefCouÁ
(
o
);

76  
d¡
;

77 
	}
}

82 
	$aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

83 
dli¡Node
 *
Ê
;

84 
aoäwblock
 *
block
;

85 
ssize_t
 
nwr™‹n
;

86 
	`UNUSED
(
–
);

87 
	`UNUSED
(
fd
);

88 
	`UNUSED
(
´ivd©a
);

89 
	`UNUSED
(
mask
);

92 
Ê
 = 
	`dli¡Fœ¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

93 
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

94 ià(
£rv”
.
aof_¡İ_£ndšg_diff
 || !
block
) {

95 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,

96 
AE_WRITABLE
);

99 ià(
block
->
u£d
 > 0) {

100 
nwr™‹n
 = 
	`vr_wr™e
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
,

101 
block
->
buf
,block->
u£d
);

102 ià(
nwr™‹n
 <= 0) ;

103 
	`memmove
(
block
->
buf
,block->buf+
nwr™‹n
,block->
u£d
-nwritten);

104 
block
->
u£d
 -ğ
nwr™‹n
;

106 ià(
block
->
u£d
 =ğ0è
	`dli¡D–Node
(
£rv”
.
aof_»wr™e_buf_blocks
,
Ê
);

108 
	}
}

111 
	$aofRewr™eBufãrAµ’d
(*
s
, 
Ën
) {

112 
dli¡Node
 *
Ê
 = 
	`dli¡La¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

113 
aoäwblock
 *
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

115 
Ën
) {

118 ià(
block
) {

119 
thi¦’
 = (
block
->
ä“
 < 
Ën
) ? block->free :†en;

120 ià(
thi¦’
) {

121 
	`memıy
(
block
->
buf
+block->
u£d
, 
s
, 
thi¦’
);

122 
block
->
u£d
 +ğ
thi¦’
;

123 
block
->
ä“
 -ğ
thi¦’
;

124 
s
 +ğ
thi¦’
;

125 
Ën
 -ğ
thi¦’
;

129 ià(
Ën
) {

130 
numblocks
;

132 
block
 = 
	`d®loc
((*block));

133 
block
->
ä“
 = 
AOF_RW_BUF_BLOCK_SIZE
;

134 
block
->
u£d
 = 0;

135 
	`dli¡AddNodeTa
(
£rv”
.
aof_»wr™e_buf_blocks
,
block
);

139 
numblocks
 = 
	`dli¡L’gth
(
£rv”
.
aof_»wr™e_buf_blocks
);

140 ià(((
numblocks
+1) % 10) == 0) {

141 
Ëv–
 = ((
numblocks
+1è% 100è=ğ0 ? 
LOG_WARN
 :

142 
LOG_NOTICE
;

143 
	`log_debug
(
Ëv–
, "Background AOF buffer size: %lu MB",

144 
	`aofRewr™eBufãrSize
()/(1024*1024));

151 ià(
	`«G‘FeEv’ts
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
) == 0) {

152 
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
aof_pe_wr™e_d©a_to_chd
,

153 
AE_WRITABLE
, 
aofChdWr™eDiffD©a
, 
NULL
);

155 
	}
}

157 
	$ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

158 
sds
 
buf
 = 
	`sd£m±y
();

159 
robj
 *
tm·rgv
[3];

163 ià(
diùid
 !ğ
£rv”
.
aof_£Ëùed_db
) {

164 
£ldb
[64];

166 
	`¢´štf
(
£ldb
,(£ldb),"%d",
diùid
);

167 
buf
 = 
	`sdsÿrštf
(buf,"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n",

168 ()
	`¡¾’
(
£ldb
),seldb);

169 
£rv”
.
aof_£Ëùed_db
 = 
diùid
;

172 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

173 
cmd
->
´oc
 =ğ
expœ—tCommªd
) {

175 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

176 } ià(
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
) {

178 
tm·rgv
[0] = 
	`ü—‹SŒšgObjeù
("SET",3);

179 
tm·rgv
[1] = 
¬gv
[1];

180 
tm·rgv
[2] = 
¬gv
[3];

181 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,3,
tm·rgv
);

182 
	`deüRefCouÁ
(
tm·rgv
[0]);

183 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

188 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,
¬gc
,
¬gv
);

194 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
)

195 
£rv”
.
aof_buf
 = 
	`sdsÿ’
(£rv”.aof_buf,
buf
,
	`sd¦’
(buf));

201 ià(
£rv”
.
aof_chd_pid
 != -1)

202 
	`aofRewr™eBufãrAµ’d
((*)
buf
,
	`sd¦’
(buf));

204 
	`sdsä“
(
buf
);

205 
	}
}

	@src/vr_aof.c

1 
	~<vr_cÜe.h
>

4 
	$aofRewr™eBufãrSize
() {

5 
dli¡Node
 *
Ê
;

6 
dli¡I‹r
 
li
;

7 
size
 = 0;

9 
	`dli¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

10 (
Ê
 = 
	`dli¡Next
(&
li
))) {

11 
aoäwblock
 *
block
 = 
	`dli¡NodeV®ue
(
Ê
);

12 
size
 +ğ
block
->
u£d
;

14  
size
;

15 
	}
}

24 
sds
 
	$ÿtAµ’dOÆyExpœeAtCommªd
(
sds
 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
) {

25 
wh’
;

26 
robj
 *
¬gv
[3];

29 
£cÚds
 = 
	`g‘DecodedObjeù
(seconds);

30 
wh’
 = 
	`¡¹Şl
(
£cÚds
->
±r
,
NULL
,10);

32 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
£‹xCommªd
 ||

33 
cmd
->
´oc
 =ğ
expœ—tCommªd
)

35 
wh’
 *= 1000;

38 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

39 
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
)

41 
wh’
 +ğ
	`vr_m£c_now
();

43 
	`deüRefCouÁ
(
£cÚds
);

45 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PEXPIREAT",9);

46 
¬gv
[1] = 
key
;

47 
¬gv
[2] = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
wh’
);

48 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf, 3, 
¬gv
);

49 
	`deüRefCouÁ
(
¬gv
[0]);

50 
	`deüRefCouÁ
(
¬gv
[2]);

51  
buf
;

52 
	}
}

54 
sds
 
	$ÿtAµ’dOÆyG’”icCommªd
(
sds
 
d¡
, 
¬gc
, 
robj
 **
¬gv
) {

55 
buf
[32];

56 
Ën
, 
j
;

57 
robj
 *
o
;

59 
buf
[0] = '*';

60 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
¬gc
);

61 
buf
[
Ën
++] = '\r';

62 
buf
[
Ën
++] = '\n';

63 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

65 
j
 = 0; j < 
¬gc
; j++) {

66 
o
 = 
	`g‘DecodedObjeù
(
¬gv
[
j
]);

67 
buf
[0] = '$';

68 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
	`sd¦’
(
o
->
±r
));

69 
buf
[
Ën
++] = '\r';

70 
buf
[
Ën
++] = '\n';

71 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

72 
d¡
 = 
	`sdsÿ’
(d¡,
o
->
±r
,
	`sd¦’
(o->ptr));

73 
d¡
 = 
	`sdsÿ’
(dst,"\r\n",2);

74 
	`deüRefCouÁ
(
o
);

76  
d¡
;

77 
	}
}

82 
	$aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

83 
dli¡Node
 *
Ê
;

84 
aoäwblock
 *
block
;

85 
ssize_t
 
nwr™‹n
;

86 
	`UNUSED
(
–
);

87 
	`UNUSED
(
fd
);

88 
	`UNUSED
(
´ivd©a
);

89 
	`UNUSED
(
mask
);

92 
Ê
 = 
	`dli¡Fœ¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

93 
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

94 ià(
£rv”
.
aof_¡İ_£ndšg_diff
 || !
block
) {

95 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,

96 
AE_WRITABLE
);

99 ià(
block
->
u£d
 > 0) {

100 
nwr™‹n
 = 
	`vr_wr™e
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
,

101 
block
->
buf
,block->
u£d
);

102 ià(
nwr™‹n
 <= 0) ;

103 
	`memmove
(
block
->
buf
,block->buf+
nwr™‹n
,block->
u£d
-nwritten);

104 
block
->
u£d
 -ğ
nwr™‹n
;

106 ià(
block
->
u£d
 =ğ0è
	`dli¡D–Node
(
£rv”
.
aof_»wr™e_buf_blocks
,
Ê
);

108 
	}
}

111 
	$aofRewr™eBufãrAµ’d
(*
s
, 
Ën
) {

112 
dli¡Node
 *
Ê
 = 
	`dli¡La¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

113 
aoäwblock
 *
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

115 
Ën
) {

118 ià(
block
) {

119 
thi¦’
 = (
block
->
ä“
 < 
Ën
) ? block->free :†en;

120 ià(
thi¦’
) {

121 
	`memıy
(
block
->
buf
+block->
u£d
, 
s
, 
thi¦’
);

122 
block
->
u£d
 +ğ
thi¦’
;

123 
block
->
ä“
 -ğ
thi¦’
;

124 
s
 +ğ
thi¦’
;

125 
Ën
 -ğ
thi¦’
;

129 ià(
Ën
) {

130 
numblocks
;

132 
block
 = 
	`d®loc
((*block));

133 
block
->
ä“
 = 
AOF_RW_BUF_BLOCK_SIZE
;

134 
block
->
u£d
 = 0;

135 
	`dli¡AddNodeTa
(
£rv”
.
aof_»wr™e_buf_blocks
,
block
);

139 
numblocks
 = 
	`dli¡L’gth
(
£rv”
.
aof_»wr™e_buf_blocks
);

140 ià(((
numblocks
+1) % 10) == 0) {

141 
Ëv–
 = ((
numblocks
+1è% 100è=ğ0 ? 
LOG_WARN
 :

142 
LOG_NOTICE
;

143 
	`log_debug
(
Ëv–
, "Background AOF buffer size: %lu MB",

144 
	`aofRewr™eBufãrSize
()/(1024*1024));

151 ià(
	`«G‘FeEv’ts
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
) == 0) {

152 
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
aof_pe_wr™e_d©a_to_chd
,

153 
AE_WRITABLE
, 
aofChdWr™eDiffD©a
, 
NULL
);

155 
	}
}

157 
	$ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

158 
sds
 
buf
 = 
	`sd£m±y
();

159 
robj
 *
tm·rgv
[3];

163 ià(
diùid
 !ğ
£rv”
.
aof_£Ëùed_db
) {

164 
£ldb
[64];

166 
	`¢´štf
(
£ldb
,(£ldb),"%d",
diùid
);

167 
buf
 = 
	`sdsÿrštf
(buf,"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n",

168 ()
	`¡¾’
(
£ldb
),seldb);

169 
£rv”
.
aof_£Ëùed_db
 = 
diùid
;

172 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

173 
cmd
->
´oc
 =ğ
expœ—tCommªd
) {

175 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

176 } ià(
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
) {

178 
tm·rgv
[0] = 
	`ü—‹SŒšgObjeù
("SET",3);

179 
tm·rgv
[1] = 
¬gv
[1];

180 
tm·rgv
[2] = 
¬gv
[3];

181 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,3,
tm·rgv
);

182 
	`deüRefCouÁ
(
tm·rgv
[0]);

183 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

188 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,
¬gc
,
¬gv
);

194 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
)

195 
£rv”
.
aof_buf
 = 
	`sdsÿ’
(£rv”.aof_buf,
buf
,
	`sd¦’
(buf));

201 ià(
£rv”
.
aof_chd_pid
 != -1)

202 
	`aofRewr™eBufãrAµ’d
((*)
buf
,
	`sd¦’
(buf));

204 
	`sdsä“
(
buf
);

205 
	}
}

	@src/vr_aof.h

1 #iâdeà
_VR_AOF_H_


2 
	#_VR_AOF_H_


	)

5 
	#AOF_OFF
 0

	)

6 
	#AOF_ON
 1

	)

7 
	#AOF_WAIT_REWRITE
 2

	)

9 
	#AOF_AUTOSYNC_BYTES
 (1024*1024*32è

	)

25 
	#AOF_RW_BUF_BLOCK_SIZE
 (1024*1024*10è

	)

27 
	saoäwblock
 {

28 
	mu£d
, 
	mä“
;

29 
	mbuf
[
AOF_RW_BUF_BLOCK_SIZE
];

30 } 
	taoäwblock
;

32 
aofRewr™eBufãrSize
();

33 
aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

34 
sds
 
ÿtAµ’dOÆyExpœeAtCommªd
(sd 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
);

35 
sds
 
ÿtAµ’dOÆyG’”icCommªd
(sd 
d¡
, 
¬gc
, 
robj
 **
¬gv
);

36 
aofRewr™eBufãrAµ’d
(*
s
, 
Ën
);

37 
ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

	@src/vr_aof.h

1 #iâdeà
_VR_AOF_H_


2 
	#_VR_AOF_H_


	)

5 
	#AOF_OFF
 0

	)

6 
	#AOF_ON
 1

	)

7 
	#AOF_WAIT_REWRITE
 2

	)

9 
	#AOF_AUTOSYNC_BYTES
 (1024*1024*32è

	)

25 
	#AOF_RW_BUF_BLOCK_SIZE
 (1024*1024*10è

	)

27 
	saoäwblock
 {

28 
	mu£d
, 
	mä“
;

29 
	mbuf
[
AOF_RW_BUF_BLOCK_SIZE
];

30 } 
	taoäwblock
;

32 
aofRewr™eBufãrSize
();

33 
aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

34 
sds
 
ÿtAµ’dOÆyExpœeAtCommªd
(sd 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
);

35 
sds
 
ÿtAµ’dOÆyG’”icCommªd
(sd 
d¡
, 
¬gc
, 
robj
 **
¬gv
);

36 
aofRewr™eBufãrAµ’d
(*
s
, 
Ën
);

37 
ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

	@src/vr_backend.c

1 
	~<vr_cÜe.h
>

4 
	gnum_back’d_th»ads
;

6 
d¬¿y
 
	gback’ds
;

8 *
back’d_th»ad_run
(*
¬gs
);

11 
	$vr_back’d_š™
(
vr_back’d
 *
back’d
)

13 
r¡©us_t
 
¡©us
;

14 
th»ads_num
;

16 ià(
back’d
 =ğ
NULL
) {

17  
VR_ERROR
;

20 
back’d
->
id
 = 0;

21 
back’d
->
cu¼’t_db
 = 0;

22 
back’d
->
tim–im™_ex™
 = 0;

23 
back’d
->
Ï¡_ç¡_cyşe
 = 0;

24 
back’d
->
»size_db
 = 0;

25 
back’d
->
»hash_db
 = 0;

28 
	`vr_ev’oİ_š™
(&
back’d
->
v–
, 10);

29 
back’d
->
v–
.
th»ad
.
fun_run
 = 
back’d_th»ad_run
;

30 
back’d
->
v–
.
th»ad
.
d©a
 = backend;

32  
VR_OK
;

33 
	}
}

36 
	$vr_back’d_deš™
(
vr_back’d
 *
back’d
)

38 ià(
back’d
 =ğ
NULL
) {

42 
	`vr_ev’oİ_deš™
(&
back’d
->
v–
);

43 
	}
}

46 
	$back’d_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

48 
vr_wÜk”
 *
back’d
 = 
ş›ÁD©a
;

50 
vr_ev’oİ
 *
v–
 = &
back’d
->vel;

51 
size_t
 
¡©_u£d_memÜy
, 
¡©s_³ak_memÜy
;

53 
	`UNUSED
(
ev’tLoİ
);

54 
	`UNUSED
(
id
);

55 
	`UNUSED
(
ş›ÁD©a
);

57 
	`ASSERT
(
ev’tLoİ
 =ğ
v–
->
–
);

59 
v–
->
unixtime
 = 
	`time
(
NULL
);

60 
v–
->
m¡ime
 = 
	`vr_m£c_now
();

63 
¡©_u£d_memÜy
 = 
	`d®loc_u£d_memÜy
();

64 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
, 
³ak_memÜy
, &
¡©s_³ak_memÜy
);

65 ià(
¡©_u£d_memÜy
 > 
¡©s_³ak_memÜy
) {

66 
	`upd©e_¡©s_£t
(
v–
->
¡©s
, 
³ak_memÜy
, 
¡©_u£d_memÜy
);

69 
	`d©aba£sCrÚ
(
back’d
);

72 
	`run_w™h_³riod
(1000, 
v–
->
üÚloİs
) {

73 
	`cÚf_ÿche_upd©e
(&
v–
->
cc
);

76 
v–
->
üÚloİs
 ++;

77  1000/
v–
->
hz
;

78 
	}
}

81 
	$£tup_back’d
(
vr_back’d
 *
back’d
)

85 if(
	`«C»©eTimeEv’t
(
back’d
->
v–
.
–
, 1, 
back’d_üÚ
, back’d, 
NULL
è=ğ
AE_ERR
) {

86 
	`£rv”Pªic
("Can't createhe serverCronimeƒvent.");

87  
VR_ERROR
;

90  
VR_OK
;

91 
	}
}

94 
	$back’d_th»ad_run
(*
¬gs
)

96 
vr_wÜk”
 *
back’d
 = 
¬gs
;

99 
	`«Maš
(
back’d
->
v–
.
–
);

101  
NULL
;

102 
	}
}

105 
	$back’ds_š™
(
ušt32_t
 
back’d_couÁ
)

107 
r¡©us_t
 
¡©us
;

108 
ušt32_t
 
idx
;

109 
vr_back’d
 *
back’d
;

111 
	`d¬¿y_š™
(&
back’ds
, 
back’d_couÁ
, (
vr_back’d
));

113 
idx
 = 0; idx < 
back’d_couÁ
; idx ++) {

114 
back’d
 = 
	`d¬¿y_push
(&
back’ds
);

115 
	`vr_back’d_š™
(
back’d
);

116 
back’d
->
id
 = 
idx
;

117 
¡©us
 = 
	`£tup_back’d
(
back’d
);

118 ià(
¡©us
 !ğ
VR_OK
) {

119 
	`ex™
(1);

123 
num_back’d_th»ads
 = ()
	`d¬¿y_n
(&
back’ds
);

125  
VR_OK
;

126 
	}
}

129 
	$back’ds_run
()

131 
ušt32_t
 
i
, 
th»ad_couÁ
;

132 
vr_back’d
 *
back’d
;

134 
th»ad_couÁ
 = (
ušt32_t
)
num_back’d_th»ads
;

136 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

137 
back’d
 = 
	`d¬¿y_g‘
(&
back’ds
, 
i
);

138 
	`vr_th»ad_¡¬t
(&
back’d
->
v–
.
th»ad
);

141  
VR_OK
;

142 
	}
}

145 
	$back’ds_wa™
()

147 
ušt32_t
 
i
, 
th»ad_couÁ
;

148 
vr_back’d
 *
back’d
;

150 
th»ad_couÁ
 = (
ušt32_t
)
num_back’d_th»ads
;

152 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

153 
back’d
 = 
	`d¬¿y_g‘
(&
back’ds
, 
i
);

154 
	`±h»ad_još
(
back’d
->
v–
.
th»ad
.
th»ad_id
, 
NULL
);

157  
VR_OK
;

158 
	}
}

161 
	$back’ds_deš™
()

163 
vr_back’d
 *
back’d
;

165 
	`d¬¿y_n
(&
back’ds
)) {

166 
back’d
 = 
	`d¬¿y_pİ
(&
back’ds
);

167 
	`vr_back’d_deš™
(
back’d
);

169 
	}
}

	@src/vr_backend.c

1 
	~<vr_cÜe.h
>

4 
	gnum_back’d_th»ads
;

6 
d¬¿y
 
	gback’ds
;

8 *
back’d_th»ad_run
(*
¬gs
);

11 
	$vr_back’d_š™
(
vr_back’d
 *
back’d
)

13 
r¡©us_t
 
¡©us
;

14 
th»ads_num
;

16 ià(
back’d
 =ğ
NULL
) {

17  
VR_ERROR
;

20 
back’d
->
id
 = 0;

21 
back’d
->
cu¼’t_db
 = 0;

22 
back’d
->
tim–im™_ex™
 = 0;

23 
back’d
->
Ï¡_ç¡_cyşe
 = 0;

24 
back’d
->
»size_db
 = 0;

25 
back’d
->
»hash_db
 = 0;

28 
	`vr_ev’oİ_š™
(&
back’d
->
v–
, 10);

29 
back’d
->
v–
.
th»ad
.
fun_run
 = 
back’d_th»ad_run
;

30 
back’d
->
v–
.
th»ad
.
d©a
 = backend;

32  
VR_OK
;

33 
	}
}

36 
	$vr_back’d_deš™
(
vr_back’d
 *
back’d
)

38 ià(
back’d
 =ğ
NULL
) {

42 
	`vr_ev’oİ_deš™
(&
back’d
->
v–
);

43 
	}
}

46 
	$back’d_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

48 
vr_wÜk”
 *
back’d
 = 
ş›ÁD©a
;

50 
vr_ev’oİ
 *
v–
 = &
back’d
->vel;

51 
size_t
 
¡©_u£d_memÜy
, 
¡©s_³ak_memÜy
;

53 
	`UNUSED
(
ev’tLoİ
);

54 
	`UNUSED
(
id
);

55 
	`UNUSED
(
ş›ÁD©a
);

57 
	`ASSERT
(
ev’tLoİ
 =ğ
v–
->
–
);

59 
v–
->
unixtime
 = 
	`time
(
NULL
);

60 
v–
->
m¡ime
 = 
	`vr_m£c_now
();

63 
¡©_u£d_memÜy
 = 
	`d®loc_u£d_memÜy
();

64 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
, 
³ak_memÜy
, &
¡©s_³ak_memÜy
);

65 ià(
¡©_u£d_memÜy
 > 
¡©s_³ak_memÜy
) {

66 
	`upd©e_¡©s_£t
(
v–
->
¡©s
, 
³ak_memÜy
, 
¡©_u£d_memÜy
);

69 
	`d©aba£sCrÚ
(
back’d
);

72 
	`run_w™h_³riod
(1000, 
v–
->
üÚloİs
) {

73 
	`cÚf_ÿche_upd©e
(&
v–
->
cc
);

76 
v–
->
üÚloİs
 ++;

77  1000/
v–
->
hz
;

78 
	}
}

81 
	$£tup_back’d
(
vr_back’d
 *
back’d
)

85 if(
	`«C»©eTimeEv’t
(
back’d
->
v–
.
–
, 1, 
back’d_üÚ
, back’d, 
NULL
è=ğ
AE_ERR
) {

86 
	`£rv”Pªic
("Can't createhe serverCronimeƒvent.");

87  
VR_ERROR
;

90  
VR_OK
;

91 
	}
}

94 
	$back’d_th»ad_run
(*
¬gs
)

96 
vr_wÜk”
 *
back’d
 = 
¬gs
;

99 
	`«Maš
(
back’d
->
v–
.
–
);

101  
NULL
;

102 
	}
}

105 
	$back’ds_š™
(
ušt32_t
 
back’d_couÁ
)

107 
r¡©us_t
 
¡©us
;

108 
ušt32_t
 
idx
;

109 
vr_back’d
 *
back’d
;

111 
	`d¬¿y_š™
(&
back’ds
, 
back’d_couÁ
, (
vr_back’d
));

113 
idx
 = 0; idx < 
back’d_couÁ
; idx ++) {

114 
back’d
 = 
	`d¬¿y_push
(&
back’ds
);

115 
	`vr_back’d_š™
(
back’d
);

116 
back’d
->
id
 = 
idx
;

117 
¡©us
 = 
	`£tup_back’d
(
back’d
);

118 ià(
¡©us
 !ğ
VR_OK
) {

119 
	`ex™
(1);

123 
num_back’d_th»ads
 = ()
	`d¬¿y_n
(&
back’ds
);

125  
VR_OK
;

126 
	}
}

129 
	$back’ds_run
()

131 
ušt32_t
 
i
, 
th»ad_couÁ
;

132 
vr_back’d
 *
back’d
;

134 
th»ad_couÁ
 = (
ušt32_t
)
num_back’d_th»ads
;

136 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

137 
back’d
 = 
	`d¬¿y_g‘
(&
back’ds
, 
i
);

138 
	`vr_th»ad_¡¬t
(&
back’d
->
v–
.
th»ad
);

141  
VR_OK
;

142 
	}
}

145 
	$back’ds_wa™
()

147 
ušt32_t
 
i
, 
th»ad_couÁ
;

148 
vr_back’d
 *
back’d
;

150 
th»ad_couÁ
 = (
ušt32_t
)
num_back’d_th»ads
;

152 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

153 
back’d
 = 
	`d¬¿y_g‘
(&
back’ds
, 
i
);

154 
	`±h»ad_još
(
back’d
->
v–
.
th»ad
.
th»ad_id
, 
NULL
);

157  
VR_OK
;

158 
	}
}

161 
	$back’ds_deš™
()

163 
vr_back’d
 *
back’d
;

165 
	`d¬¿y_n
(&
back’ds
)) {

166 
back’d
 = 
	`d¬¿y_pİ
(&
back’ds
);

167 
	`vr_back’d_deš™
(
back’d
);

169 
	}
}

	@src/vr_backend.h

1 #iâdeà
_VR_BACKEND_H_


2 
	#_VR_BACKEND_H_


	)

4 
	svr_back’d
 {

6 
	mid
;

8 
vr_ev’oİ
 
	mv–
;

13 
	mcu¼’t_db
;

15 
	mtim–im™_ex™
;

16 
	mÏ¡_ç¡_cyşe
;

21 
	m»size_db
;

22 
	m»hash_db
;

23 }
	tvr_back’d
;

25 
d¬¿y
 
back’ds
;

27 
back’ds_š™
(
ušt32_t
 
back’d_couÁ
);

28 
back’ds_run
();

29 
back’ds_wa™
();

30 
back’ds_deš™
();

	@src/vr_backend.h

1 #iâdeà
_VR_BACKEND_H_


2 
	#_VR_BACKEND_H_


	)

4 
	svr_back’d
 {

6 
	mid
;

8 
vr_ev’oİ
 
	mv–
;

13 
	mcu¼’t_db
;

15 
	mtim–im™_ex™
;

16 
	mÏ¡_ç¡_cyşe
;

21 
	m»size_db
;

22 
	m»hash_db
;

23 }
	tvr_back’d
;

25 
d¬¿y
 
back’ds
;

27 
back’ds_š™
(
ušt32_t
 
back’d_couÁ
);

28 
back’ds_run
();

29 
back’ds_wa™
();

30 
back’ds_deš™
();

	@src/vr_bitops.c

1 
	~<vr_cÜe.h
>

10 
size_t
 
	$»disPİcouÁ
(*
s
, 
couÁ
) {

11 
size_t
 
b™s
 = 0;

12 *
p
 = 
s
;

13 
ušt32_t
 *
p4
;

14 cÚ¡ 
b™sšby‹
[256] = {0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8};

17 ()
p
 & 3 && 
couÁ
) {

18 
b™s
 +ğ
b™sšby‹
[*
p
++];

19 
couÁ
--;

23 
p4
 = (
ušt32_t
*)
p
;

24 
couÁ
>=28) {

25 
ušt32_t
 
aux1
, 
aux2
, 
aux3
, 
aux4
, 
aux5
, 
aux6
, 
aux7
;

27 
aux1
 = *
p4
++;

28 
aux2
 = *
p4
++;

29 
aux3
 = *
p4
++;

30 
aux4
 = *
p4
++;

31 
aux5
 = *
p4
++;

32 
aux6
 = *
p4
++;

33 
aux7
 = *
p4
++;

34 
couÁ
 -= 28;

36 
aux1
 =‡ux1 - ((aux1 >> 1) & 0x55555555);

37 
aux1
 = (aux1 & 0x33333333) + ((aux1 >> 2) & 0x33333333);

38 
aux2
 =‡ux2 - ((aux2 >> 1) & 0x55555555);

39 
aux2
 = (aux2 & 0x33333333) + ((aux2 >> 2) & 0x33333333);

40 
aux3
 =‡ux3 - ((aux3 >> 1) & 0x55555555);

41 
aux3
 = (aux3 & 0x33333333) + ((aux3 >> 2) & 0x33333333);

42 
aux4
 =‡ux4 - ((aux4 >> 1) & 0x55555555);

43 
aux4
 = (aux4 & 0x33333333) + ((aux4 >> 2) & 0x33333333);

44 
aux5
 =‡ux5 - ((aux5 >> 1) & 0x55555555);

45 
aux5
 = (aux5 & 0x33333333) + ((aux5 >> 2) & 0x33333333);

46 
aux6
 =‡ux6 - ((aux6 >> 1) & 0x55555555);

47 
aux6
 = (aux6 & 0x33333333) + ((aux6 >> 2) & 0x33333333);

48 
aux7
 =‡ux7 - ((aux7 >> 1) & 0x55555555);

49 
aux7
 = (aux7 & 0x33333333) + ((aux7 >> 2) & 0x33333333);

50 
b™s
 +ğ((((
aux1
 + (aux1 >> 4)) & 0x0F0F0F0F) +

51 ((
aux2
 + (aux2 >> 4)) & 0x0F0F0F0F) +

52 ((
aux3
 + (aux3 >> 4)) & 0x0F0F0F0F) +

53 ((
aux4
 + (aux4 >> 4)) & 0x0F0F0F0F) +

54 ((
aux5
 + (aux5 >> 4)) & 0x0F0F0F0F) +

55 ((
aux6
 + (aux6 >> 4)) & 0x0F0F0F0F) +

56 ((
aux7
 + (aux7 >> 4)) & 0x0F0F0F0F))* 0x01010101) >> 24;

59 
p
 = (*)
p4
;

60 
couÁ
--è
b™s
 +ğ
b™sšby‹
[*
p
++];

61  
b™s
;

62 
	}
}

71 
	$»disB™pos
(*
s
, 
couÁ
, 
b™
) {

72 *
l
;

73 *
c
;

74 
skv®
, 
wÜd
 = 0, 
Úe
;

75 
pos
 = 0;

76 
j
;

88 
skv®
 = 
b™
 ? 0 : 
UCHAR_MAX
;

89 
c
 = (*è
s
;

90 ()
c
 & ((*
l
)-1è&& 
couÁ
) {

91 ià(*
c
 !ğ
skv®
) ;

92 
c
++;

93 
couÁ
--;

94 
pos
 += 8;

98 
skv®
 = 
b™
 ? 0 : 
ULONG_MAX
;

99 
l
 = (*è
c
;

100 
couÁ
 >ğ(*
l
)) {

101 ià(*
l
 !ğ
skv®
) ;

102 
l
++;

103 
couÁ
 -ğ(*
l
);

104 
pos
 +ğ(*
l
)*8;

114 
c
 = (*)
l
;

115 
j
 = 0; j < (*
l
); j++) {

116 
wÜd
 <<= 8;

117 ià(
couÁ
) {

118 
wÜd
 |ğ*
c
;

119 
c
++;

120 
couÁ
--;

129 ià(
b™
 =ğ1 && 
wÜd
 == 0)  -1;

135 
Úe
 = 
ULONG_MAX
;

136 
Úe
 >>= 1;

137 
Úe
 = ~one;

139 
Úe
) {

140 ià(((
Úe
 & 
wÜd
è!ğ0è=ğ
b™
è 
pos
;

141 
pos
++;

142 
Úe
 >>= 1;

147 
	`£rv”Pªic
("End of„edisBitpos()„eached.");

149 
	}
}

172 
	$£tUnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, ušt64_ˆ
v®ue
) {

173 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
;

175 
j
 = 0; j < 
b™s
; j++) {

176 
b™v®
 = (
v®ue
 & ((
ušt64_t
)1<<(
b™s
-1-
j
))) != 0;

177 
by‹
 = 
off£t
 >> 3;

178 
b™
 = 7 - (
off£t
 & 0x7);

179 
by‹v®
 = 
p
[
by‹
];

180 
by‹v®
 &ğ~(1 << 
b™
);

181 
by‹v®
 |ğ
b™v®
 << 
b™
;

182 
p
[
by‹
] = 
by‹v®
 & 0xff;

183 
off£t
++;

185 
	}
}

187 
	$£tSigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, 
št64_t
 
v®ue
) {

188 
ušt64_t
 
uv
;

190 ià(
v®ue
 >= 0)

191 
uv
 = 
v®ue
;

193 
uv
 = 
UINT64_MAX
 + 
v®ue
 + 1;

194 
	`£tUnsigÃdB™f›ld
(
p
,
off£t
,
b™s
,
uv
);

195 
	}
}

197 
ušt64_t
 
	$g‘UnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

198 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
, 
v®ue
 = 0;

200 
j
 = 0; j < 
b™s
; j++) {

201 
by‹
 = 
off£t
 >> 3;

202 
b™
 = 7 - (
off£t
 & 0x7);

203 
by‹v®
 = 
p
[
by‹
];

204 
b™v®
 = (
by‹v®
 >> 
b™
) & 1;

205 
v®ue
 = (v®ue<<1è| 
b™v®
;

206 
off£t
++;

208  
v®ue
;

209 
	}
}

211 
št64_t
 
	$g‘SigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

212 
št64_t
 
v®ue
 = 
	`g‘UnsigÃdB™f›ld
(
p
,
off£t
,
b™s
);

216 ià(
v®ue
 & ((
ušt64_t
)1 << (
b™s
-1)))

217 
v®ue
 |ğ((
ušt64_t
)-1è<< 
b™s
;

218  
v®ue
;

219 
	}
}

240 
	#BFOVERFLOW_WRAP
 0

	)

241 
	#BFOVERFLOW_SAT
 1

	)

242 
	#BFOVERFLOW_FAIL
 2

	)

244 
	$checkUnsigÃdB™f›ldOv”æow
(
ušt64_t
 
v®ue
, 
št64_t
 
šü
, ušt64_ˆ
b™s
, 
owty³
, ušt64_ˆ*
lim™
) {

245 
ušt64_t
 
max
 = (
b™s
 =ğ64è? 
UINT64_MAX
 : (((uint64_t)1<<bits)-1);

246 
št64_t
 
maxšü
 = 
max
-
v®ue
;

247 
št64_t
 
mššü
 = -
v®ue
;

249 ià(
v®ue
 > 
max
 || (
šü
 > 0 && inü > 
maxšü
)) {

250 ià(
lim™
) {

251 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

252 
hªdË_w¿p
;

253 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

254 *
lim™
 = 
max
;

258 } ià(
šü
 < 0 && inü < 
mššü
) {

259 ià(
lim™
) {

260 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

261 
hªdË_w¿p
;

262 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

263 *
lim™
 = 0;

270 
hªdË_w¿p
:

272 
ušt64_t
 
mask
 = ((
št64_t
)-1è<< 
b™s
;

273 
ušt64_t
 
»s
 = 
v®ue
+
šü
;

275 
»s
 &ğ~
mask
;

276 *
lim™
 = 
»s
;

279 
	}
}

281 
	$checkSigÃdB™f›ldOv”æow
(
št64_t
 
v®ue
, iÁ64_ˆ
šü
, 
ušt64_t
 
b™s
, 
owty³
, iÁ64_ˆ*
lim™
) {

282 
št64_t
 
max
 = (
b™s
 =ğ64è? 
INT64_MAX
 : (((int64_t)1<<(bits-1))-1);

283 
št64_t
 
mš
 = (-
max
)-1;

288 
št64_t
 
maxšü
 = 
max
-
v®ue
;

289 
št64_t
 
mššü
 = 
mš
-
v®ue
;

291 ià(
v®ue
 > 
max
 || (
b™s
 !ğ64 && 
šü
 > 
maxšü
) || (value >= 0 && incr > 0 && incr > maxincr))

293 ià(
lim™
) {

294 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

295 
hªdË_w¿p
;

296 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

297 *
lim™
 = 
max
;

301 } ià(
v®ue
 < 
mš
 || (
b™s
 !ğ64 && 
šü
 < 
mššü
) || (value < 0 && incr < 0 && incr < minincr)) {

302 ià(
lim™
) {

303 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

304 
hªdË_w¿p
;

305 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

306 *
lim™
 = 
mš
;

313 
hªdË_w¿p
:

315 
ušt64_t
 
mask
 = ((
št64_t
)-1è<< 
b™s
;

316 
ušt64_t
 
msb
 = (ušt64_t)1 << (
b™s
-1);

317 
ušt64_t
 
a
 = 
v®ue
, 
b
 = 
šü
, 
c
;

318 
c
 = 
a
+
b
;

323 ià(
c
 & 
msb
) {

324 
c
 |ğ
mask
;

326 
c
 &ğ~
mask
;

328 *
lim™
 = 
c
;

331 
	}
}

335 
	$´štB™s
(*
p
, 
couÁ
) {

336 
j
, 
i
, 
by‹
;

338 
j
 = 0; j < 
couÁ
; j++) {

339 
by‹
 = 
p
[
j
];

340 
i
 = 0x80; i > 0; i /= 2)

341 
	`´štf
("%c", (
by‹
 & 
i
) ? '1' : '0');

342 
	`´štf
("|");

344 
	`´štf
("\n");

345 
	}
}

351 
	#BITOP_AND
 0

	)

352 
	#BITOP_OR
 1

	)

353 
	#BITOP_XOR
 2

	)

354 
	#BITOP_NOT
 3

	)

356 
	#BITFIELDOP_GET
 0

	)

357 
	#BITFIELDOP_SET
 1

	)

358 
	#BITFIELDOP_INCRBY
 2

	)

367 
	$g‘B™Off£tFromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
, 
hash
, 
b™s
) {

368 
loff£t
;

369 *
”r
 = "bit offset is‚ot‡n integer or out of„ange";

370 *
p
 = 
o
->
±r
;

371 
size_t
 
¶’
 = 
	`sd¦’
(
p
);

372 
u£hash
 = 0;

375 ià(
p
[0] =ğ'#' && 
hash
 && 
b™s
 > 0è
u£hash
 = 1;

377 ià(
	`¡ršg2Î
(
p
+
u£hash
,
¶’
-u£hash,&
loff£t
) == 0) {

378 
	`addR•lyE¼Ü
(
c
,
”r
);

379  
VR_ERROR
;

383 ià(
u£hash
è
loff£t
 *ğ
b™s
;

386 ià((
loff£t
 < 0) || (()loffset >> 3) >= (512*1024*1024))

388 
	`addR•lyE¼Ü
(
c
,
”r
);

389  
VR_ERROR
;

392 *
off£t
 = (
size_t
)
loff£t
;

393  
VR_OK
;

394 
	}
}

403 
	$g‘B™f›ldTy³FromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, *
sign
, *
b™s
) {

404 *
p
 = 
o
->
±r
;

405 *
”r
 = "Invalid bitfieldype. Use something†ike i16 u8. Notehat u64 is‚ot supported but i64 is.";

406 
Îb™s
;

408 ià(
p
[0] == 'i') {

409 *
sign
 = 1;

410 } ià(
p
[0] == 'u') {

411 *
sign
 = 0;

413 
	`addR•lyE¼Ü
(
c
,
”r
);

414  
VR_ERROR
;

417 ià((
	`¡ršg2Î
(
p
+1,
	`¡¾’
Õ+1),&
Îb™s
)) == 0 ||

418 
Îb™s
 < 1 ||

419 (*
sign
 =ğ1 && 
Îb™s
 > 64) ||

420 (*
sign
 =ğ0 && 
Îb™s
 > 63))

422 
	`addR•lyE¼Ü
(
c
,
”r
);

423  
VR_ERROR
;

425 *
b™s
 = 
Îb™s
;

426  
VR_OK
;

427 
	}
}

434 
robj
 *
	$lookupSŒšgFÜB™Commªd
(
ş›Á
 *
c
, 
size_t
 
maxb™
, *
expœed
) {

435 
size_t
 
by‹
 = 
maxb™
 >> 3;

436 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
expœed
);

438 ià(
o
 =ğ
NULL
) {

439 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
by‹
+1));

440 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

442 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)è 
NULL
;

443 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

444 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
by‹
+1);

446  
o
;

447 
	}
}

450 
	$£tb™Commªd
(
ş›Á
 *
c
) {

451 
robj
 *
o
;

452 *
”r
 = "bit is‚ot‡n integer or out of„ange";

453 
size_t
 
b™off£t
;

454 
ssize_t
 
by‹
, 
b™
;

455 
by‹v®
, 
b™v®
;

456 
Ú
;

457 
expœed
 = 0;

459 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
VR_OK
)

462 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
Ú
,
”r
è!ğ
VR_OK
)

466 ià(
Ú
 & ~1) {

467 
	`addR•lyE¼Ü
(
c
,
”r
);

471 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

472 
	`lockDbWr™e
(
c
->
db
);

473 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,
b™off£t
,&
expœed
)è=ğ
NULL
) {

474 
	`uÆockDb
(
c
->
db
);

475 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

480 
by‹
 = 
b™off£t
 >> 3;

481 
by‹v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
];

482 
b™
 = 7 - (
b™off£t
 & 0x7);

483 
b™v®
 = 
by‹v®
 & (1 << 
b™
);

486 
by‹v®
 &ğ~(1 << 
b™
);

487 
by‹v®
 |ğ((
Ú
 & 0x1è<< 
b™
);

488 ((
ušt8_t
*)
o
->
±r
)[
by‹
] = 
by‹v®
;

489 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

490 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

491 
c
->
v–
->
dœty
++;

492 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

493 
	`uÆockDb
(
c
->
db
);

494 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

495 
	}
}

498 
	$g‘b™Commªd
(
ş›Á
 *
c
) {

499 
robj
 *
o
;

500 
Îbuf
[32];

501 
size_t
 
b™off£t
;

502 
size_t
 
by‹
, 
b™
;

503 
size_t
 
b™v®
 = 0;

505 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
VR_OK
)

508 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

509 
	`lockDbR—d
(
c
->
db
);

510 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

511 
	`uÆockDb
(
c
->
db
);

512 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

514 } ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

515 
	`uÆockDb
(
c
->
db
);

516 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

519 
by‹
 = 
b™off£t
 >> 3;

520 
b™
 = 7 - (
b™off£t
 & 0x7);

521 ià(
	`sdsEncodedObjeù
(
o
)) {

522 ià(
by‹
 < 
	`sd¦’
(
o
->
±r
))

523 
b™v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
] & (1 << 
b™
);

525 ià(
by‹
 < (
size_t
)
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
))

526 
b™v®
 = 
Îbuf
[
by‹
] & (1 << 
b™
);

529 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

530 
	`uÆockDb
(
c
->
db
);

531 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

532 
	}
}

535 
	$b™İCommªd
(
ş›Á
 *
c
) {

536 *
İÇme
 = 
c
->
¬gv
[1]->
±r
;

537 
robj
 *
o
, *
rg‘key
 = 
c
->
¬gv
[2];

538 
İ
, 
j
, 
numkeys
;

539 
robj
 **
objeùs
;

540 **
¤c
;

541 *
Ën
, 
maxËn
 = 0;

543 
mšËn
 = 0;

544 *
»s
 = 
NULL
;

547 ià((
İÇme
[0] =ğ'a' || o²ame[0] =ğ'A'è&& !
	`¡rÿ£cmp
(opname,"and"))

548 
İ
 = 
BITOP_AND
;

549 if((
İÇme
[0] =ğ'o' || o²ame[0] =ğ'O'è&& !
	`¡rÿ£cmp
(opname,"or"))

550 
İ
 = 
BITOP_OR
;

551 if((
İÇme
[0] =ğ'x' || o²ame[0] =ğ'X'è&& !
	`¡rÿ£cmp
(opname,"xor"))

552 
İ
 = 
BITOP_XOR
;

553 if((
İÇme
[0] =ğ'n' || o²ame[0] =ğ'N'è&& !
	`¡rÿ£cmp
(opname,"not"))

554 
İ
 = 
BITOP_NOT
;

556 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

561 ià(
İ
 =ğ
BITOP_NOT
 && 
c
->
¬gc
 != 4) {

562 
	`addR•lyE¼Ü
(
c
,"BITOP NOT must be called with‡ single source key.");

567 
numkeys
 = 
c
->
¬gc
 - 3;

568 
¤c
 = 
	`d®loc
((*è* 
numkeys
);

569 
Ën
 = 
	`d®loc
((è* 
numkeys
);

570 
objeùs
 = 
	`d®loc
((
robj
*è* 
numkeys
);

571 
j
 = 0; j < 
numkeys
; j++) {

572 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
+3]);

574 ià(
o
 =ğ
NULL
) {

575 
objeùs
[
j
] = 
NULL
;

576 
¤c
[
j
] = 
NULL
;

577 
Ën
[
j
] = 0;

578 
mšËn
 = 0;

582 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

583 
i
;

584 
i
 = 0; i < 
j
; i++) {

585 ià(
objeùs
[
i
])

586 
	`deüRefCouÁ
(
objeùs
[
i
]);

588 
	`dä“
(
¤c
);

589 
	`dä“
(
Ën
);

590 
	`dä“
(
objeùs
);

593 
objeùs
[
j
] = 
	`g‘DecodedObjeù
(
o
);

594 
¤c
[
j
] = 
objeùs
[j]->
±r
;

595 
Ën
[
j
] = 
	`sd¦’
(
objeùs
[j]->
±r
);

596 ià(
Ën
[
j
] > 
maxËn
) maxlen =†en[j];

597 ià(
j
 =ğ0 || 
Ën
[j] < 
mšËn
) minlen =†en[j];

601 ià(
maxËn
) {

602 
»s
 = (*è
	`sd¢ewËn
(
NULL
,
maxËn
);

603 
ouut
, 
by‹
;

604 
i
;

609 
j
 = 0;

610 ià(
mšËn
 >ğ()*4 && 
numkeys
 <= 16) {

611 *
Í
[16];

612 *
Ìes
 = (*è
»s
;

615 
	`memıy
(
Í
,
¤c
,(*)*
numkeys
);

616 
	`memıy
(
»s
,
¤c
[0],
mšËn
);

619 ià(
İ
 =ğ
BITOP_AND
) {

620 
mšËn
 >= ()*4) {

621 
i
 = 1; i < 
numkeys
; i++) {

622 
Ìes
[0] &ğ
Í
[
i
][0];

623 
Ìes
[1] &ğ
Í
[
i
][1];

624 
Ìes
[2] &ğ
Í
[
i
][2];

625 
Ìes
[3] &ğ
Í
[
i
][3];

626 
Í
[
i
]+=4;

628 
Ìes
+=4;

629 
j
 += ()*4;

630 
mšËn
 -= ()*4;

632 } ià(
İ
 =ğ
BITOP_OR
) {

633 
mšËn
 >= ()*4) {

634 
i
 = 1; i < 
numkeys
; i++) {

635 
Ìes
[0] |ğ
Í
[
i
][0];

636 
Ìes
[1] |ğ
Í
[
i
][1];

637 
Ìes
[2] |ğ
Í
[
i
][2];

638 
Ìes
[3] |ğ
Í
[
i
][3];

639 
Í
[
i
]+=4;

641 
Ìes
+=4;

642 
j
 += ()*4;

643 
mšËn
 -= ()*4;

645 } ià(
İ
 =ğ
BITOP_XOR
) {

646 
mšËn
 >= ()*4) {

647 
i
 = 1; i < 
numkeys
; i++) {

648 
Ìes
[0] ^ğ
Í
[
i
][0];

649 
Ìes
[1] ^ğ
Í
[
i
][1];

650 
Ìes
[2] ^ğ
Í
[
i
][2];

651 
Ìes
[3] ^ğ
Í
[
i
][3];

652 
Í
[
i
]+=4;

654 
Ìes
+=4;

655 
j
 += ()*4;

656 
mšËn
 -= ()*4;

658 } ià(
İ
 =ğ
BITOP_NOT
) {

659 
mšËn
 >= ()*4) {

660 
Ìes
[0] = ~lres[0];

661 
Ìes
[1] = ~lres[1];

662 
Ìes
[2] = ~lres[2];

663 
Ìes
[3] = ~lres[3];

664 
Ìes
+=4;

665 
j
 += ()*4;

666 
mšËn
 -= ()*4;

672 ; 
j
 < 
maxËn
; j++) {

673 
ouut
 = (
Ën
[0] <ğ
j
è? 0 : 
¤c
[0][j];

674 ià(
İ
 =ğ
BITOP_NOT
è
ouut
 = ~output;

675 
i
 = 1; i < 
numkeys
; i++) {

676 
by‹
 = (
Ën
[
i
] <ğ
j
è? 0 : 
¤c
[i][j];

677 
İ
) {

678 
BITOP_AND
: 
ouut
 &ğ
by‹
; ;

679 
BITOP_OR
: 
ouut
 |ğ
by‹
; ;

680 
BITOP_XOR
: 
ouut
 ^ğ
by‹
; ;

683 
»s
[
j
] = 
ouut
;

686 
j
 = 0; j < 
numkeys
; j++) {

687 ià(
objeùs
[
j
])

688 
	`deüRefCouÁ
(
objeùs
[
j
]);

690 
	`dä“
(
¤c
);

691 
	`dä“
(
Ën
);

692 
	`dä“
(
objeùs
);

695 ià(
maxËn
) {

696 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
»s
);

697 
	`£tKey
(
c
->
db
,
rg‘key
,
o
,
NULL
);

698 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
rg‘key
,
c
->
db
->
id
);

699 
	`deüRefCouÁ
(
o
);

700 } ià(
	`dbD–‘e
(
c
->
db
,
rg‘key
)) {

701 
	`sigÇlModif›dKey
(
c
->
db
,
rg‘key
);

702 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
rg‘key
,
c
->
db
->
id
);

704 
£rv”
.
dœty
++;

705 
	`addR•lyLÚgLÚg
(
c
,
maxËn
);

706 
	}
}

709 
	$b™couÁCommªd
(
ş›Á
 *
c
) {

710 
robj
 *
o
;

711 
¡¬t
, 
’d
, 
¡¾’
;

712 *
p
;

713 
Îbuf
[32];

715 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

716 
	`lockDbR—d
(
c
->
db
);

718 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

719 
	`uÆockDb
(
c
->
db
);

720 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

722 } ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

723 
	`uÆockDb
(
c
->
db
);

724 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

730 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

731 
p
 = (*è
Îbuf
;

732 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

734 
p
 = (*è
o
->
±r
;

735 
¡¾’
 = 
	`sd¦’
(
o
->
±r
);

739 ià(
c
->
¬gc
 == 4) {

740 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
VR_OK
) {

741 
	`uÆockDb
(
c
->
db
);

742 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

745 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
VR_OK
) {

746 
	`uÆockDb
(
c
->
db
);

747 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

751 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

752 ià(
’d
 < 0è’d = 
¡¾’
+end;

753 ià(
¡¬t
 < 0) start = 0;

754 ià(
’d
 < 0)ƒnd = 0;

755 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

756 } ià(
c
->
¬gc
 == 2) {

758 
¡¬t
 = 0;

759 
’d
 = 
¡¾’
-1;

761 
	`uÆockDb
(
c
->
db
);

762 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

764 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

770 ià(
¡¬t
 > 
’d
) {

771 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

773 
by‹s
 = 
’d
-
¡¬t
+1;

775 
	`addR•lyLÚgLÚg
(
c
,
	`»disPİcouÁ
(
p
+
¡¬t
,
by‹s
));

777 
	`uÆockDb
(
c
->
db
);

778 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

779 
	}
}

782 
	$b™posCommªd
(
ş›Á
 *
c
) {

783 
robj
 *
o
;

784 
b™
, 
¡¬t
, 
’d
, 
¡¾’
;

785 *
p
;

786 
Îbuf
[32];

787 
’d_giv’
 = 0;

791 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
b™
,
NULL
è!ğ
VR_OK
)

793 ià(
b™
 != 0 && bit != 1) {

794 
	`addR•lyE¼Ü
(
c
, "The bit‡rgument must be 1 or 0.");

798 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

799 
	`lockDbR—d
(
c
->
db
);

803 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

804 
	`uÆockDb
(
c
->
db
);

805 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

806 
	`addR•lyLÚgLÚg
(
c
, 
b™
 ? -1 : 0);

809 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

810 
	`uÆockDb
(
c
->
db
);

811 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

817 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

818 
p
 = (*è
Îbuf
;

819 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

821 
p
 = (*è
o
->
±r
;

822 
¡¾’
 = 
	`sd¦’
(
o
->
±r
);

826 ià(
c
->
¬gc
 == 4 || c->argc == 5) {

827 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
¡¬t
,
NULL
è!ğ
VR_OK
) {

828 
	`uÆockDb
(
c
->
db
);

829 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

832 ià(
c
->
¬gc
 == 5) {

833 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
’d
,
NULL
è!ğ
VR_OK
) {

834 
	`uÆockDb
(
c
->
db
);

835 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

838 
’d_giv’
 = 1;

840 
’d
 = 
¡¾’
-1;

843 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

844 ià(
’d
 < 0è’d = 
¡¾’
+end;

845 ià(
¡¬t
 < 0) start = 0;

846 ià(
’d
 < 0)ƒnd = 0;

847 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

848 } ià(
c
->
¬gc
 == 3) {

850 
¡¬t
 = 0;

851 
’d
 = 
¡¾’
-1;

853 
	`uÆockDb
(
c
->
db
);

854 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

856 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

862 ià(
¡¬t
 > 
’d
) {

863 
	`addR•lyLÚgLÚg
(
c
, -1);

865 
by‹s
 = 
’d
-
¡¬t
+1;

866 
pos
 = 
	`»disB™pos
(
p
+
¡¬t
,
by‹s
,
b™
);

875 ià(
’d_giv’
 && 
b™
 =ğ0 && 
pos
 =ğ
by‹s
*8) {

876 
	`uÆockDb
(
c
->
db
);

877 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

878 
	`addR•lyLÚgLÚg
(
c
,-1);

881 ià(
pos
 !ğ-1èpo +ğ
¡¬t
*8;

882 
	`addR•lyLÚgLÚg
(
c
,
pos
);

884 
	`uÆockDb
(
c
->
db
);

885 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

886 
	}
}

898 
	sb™f›ldOp
 {

899 
ušt64_t
 
	moff£t
;

900 
št64_t
 
	mi64
;

901 
	mİcode
;

902 
	mowty³
;

903 
	mb™s
;

904 
	msign
;

907 
	$b™f›ldCommªd
(
ş›Á
 *
c
) {

908 
robj
 *
o
;

909 
size_t
 
b™off£t
;

910 
j
, 
numİs
 = 0, 
chªges
 = 0;

911 
b™f›ldOp
 *
İs
 = 
NULL
;

912 
owty³
 = 
BFOVERFLOW_WRAP
;

914 
j
 = 2; j < 
c
->
¬gc
; j++) {

915 
»m¬gs
 = 
c
->
¬gc
-
j
-1;

916 *
subcmd
 = 
c
->
¬gv
[
j
]->
±r
;

917 
İcode
;

918 
i64
 = 0;

919 
sign
 = 0;

920 
b™s
 = 0;

922 ià(!
	`¡rÿ£cmp
(
subcmd
,"g‘"è&& 
»m¬gs
 >= 2)

923 
İcode
 = 
BITFIELDOP_GET
;

924 ià(!
	`¡rÿ£cmp
(
subcmd
,"£t"è&& 
»m¬gs
 >= 3)

925 
İcode
 = 
BITFIELDOP_SET
;

926 ià(!
	`¡rÿ£cmp
(
subcmd
,"šüby"è&& 
»m¬gs
 >= 3)

927 
İcode
 = 
BITFIELDOP_INCRBY
;

928 ià(!
	`¡rÿ£cmp
(
subcmd
,"ov”æow"è&& 
»m¬gs
 >= 1) {

929 *
owty³Çme
 = 
c
->
¬gv
[
j
+1]->
±r
;

930 
j
++;

931 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"wrap"))

932 
owty³
 = 
BFOVERFLOW_WRAP
;

933 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"sat"))

934 
owty³
 = 
BFOVERFLOW_SAT
;

935 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"fail"))

936 
owty³
 = 
BFOVERFLOW_FAIL
;

938 
	`addR•lyE¼Ü
(
c
,"Invalid OVERFLOWype specified");

939 
	`dä“
(
İs
);

944 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

945 
	`dä“
(
İs
);

950 ià(
	`g‘B™f›ldTy³FromArgum’t
(
c
,c->
¬gv
[
j
+1],&
sign
,&
b™s
è!ğ
VR_OK
) {

951 
	`dä“
(
İs
);

955 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[
j
+2],&
b™off£t
,1,
b™s
è!ğ
VR_OK
){

956 
	`dä“
(
İs
);

961 ià(
İcode
 !ğ
BITFIELDOP_GET
) {

962 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+3],&
i64
,
NULL
è!ğ
VR_OK
){

963 
	`dä“
(
İs
);

969 
İs
 = 
	`d»®loc
(İs,(*İs)*(
numİs
+1));

970 
İs
[
numİs
].
off£t
 = 
b™off£t
;

971 
İs
[
numİs
].
i64
 = i64;

972 
İs
[
numİs
].
İcode
 = opcode;

973 
İs
[
numİs
].
owty³
 = owtype;

974 
İs
[
numİs
].
b™s
 = bits;

975 
İs
[
numİs
].
sign
 = sign;

976 
numİs
++;

978 
j
 +ğ3 - (
İcode
 =ğ
BITFIELDOP_GET
);

981 
	`addR•lyMuÉiBulkL’
(
c
,
numİs
);

984 
j
 = 0; j < 
numİs
; j++) {

985 
b™f›ldOp
 *
thisİ
 = 
İs
+
j
;

988 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_SET
 ||

989 
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
)

997 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,

998 
thisİ
->
off£t
 + (thisİ->
b™s
-1), 
NULL
)) == NULL) ;

1003 ià(
thisİ
->
sign
) {

1004 
št64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1005 
ov”æow
;

1007 
Şdv®
 = 
	`g‘SigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1008 
thisİ
->
b™s
);

1010 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1011 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1012 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Şdv®
,

1013 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1014 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1015 
»tv®
 = 
Ãwv®
;

1017 
Ãwv®
 = 
thisİ
->
i64
;

1018 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Ãwv®
,

1019 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1020 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1021 
»tv®
 = 
Şdv®
;

1026 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1027 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1028 
	`£tSigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1029 
thisİ
->
b™s
,
Ãwv®
);

1031 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1034 
ušt64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1035 
ov”æow
;

1037 
Şdv®
 = 
	`g‘UnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1038 
thisİ
->
b™s
);

1040 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1041 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1042 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Şdv®
,

1043 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1044 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1045 
»tv®
 = 
Ãwv®
;

1047 
Ãwv®
 = 
thisİ
->
i64
;

1048 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Ãwv®
,

1049 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1050 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1051 
»tv®
 = 
Şdv®
;

1055 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1056 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1057 
	`£tUnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1058 
thisİ
->
b™s
,
Ãwv®
);

1060 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1063 
chªges
++;

1066 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

1067 
size_t
 
Ş’
 = (
o
 =ğ
NULL
è? 0 : 
	`sd¦’
(o->
±r
);

1068 
buf
[9];

1074 
	`mem£t
(
buf
,0,9);

1075 *
¤c
 = 
o
 ? o->
±r
 : 
NULL
;

1076 
i
;

1077 
size_t
 
by‹
 = 
thisİ
->
off£t
 >> 3;

1078 
i
 = 0; i < 9; i++) {

1079 ià(
¤c
 =ğ
NULL
 || 
i
+
by‹
 >ğ
Ş’
) ;

1080 
buf
[
i
] = 
¤c
[i+
by‹
];

1085 ià(
thisİ
->
sign
) {

1086 
št64_t
 
v®
 = 
	`g‘SigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1087 
thisİ
->
b™s
);

1088 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1090 
ušt64_t
 
v®
 = 
	`g‘UnsigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1091 
thisİ
->
b™s
);

1092 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1097 ià(
chªges
) {

1098 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1099 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

1100 
£rv”
.
dœty
 +ğ
chªges
;

1102 
	`dä“
(
İs
);

1103 
	}
}

	@src/vr_bitops.c

1 
	~<vr_cÜe.h
>

10 
size_t
 
	$»disPİcouÁ
(*
s
, 
couÁ
) {

11 
size_t
 
b™s
 = 0;

12 *
p
 = 
s
;

13 
ušt32_t
 *
p4
;

14 cÚ¡ 
b™sšby‹
[256] = {0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8};

17 ()
p
 & 3 && 
couÁ
) {

18 
b™s
 +ğ
b™sšby‹
[*
p
++];

19 
couÁ
--;

23 
p4
 = (
ušt32_t
*)
p
;

24 
couÁ
>=28) {

25 
ušt32_t
 
aux1
, 
aux2
, 
aux3
, 
aux4
, 
aux5
, 
aux6
, 
aux7
;

27 
aux1
 = *
p4
++;

28 
aux2
 = *
p4
++;

29 
aux3
 = *
p4
++;

30 
aux4
 = *
p4
++;

31 
aux5
 = *
p4
++;

32 
aux6
 = *
p4
++;

33 
aux7
 = *
p4
++;

34 
couÁ
 -= 28;

36 
aux1
 =‡ux1 - ((aux1 >> 1) & 0x55555555);

37 
aux1
 = (aux1 & 0x33333333) + ((aux1 >> 2) & 0x33333333);

38 
aux2
 =‡ux2 - ((aux2 >> 1) & 0x55555555);

39 
aux2
 = (aux2 & 0x33333333) + ((aux2 >> 2) & 0x33333333);

40 
aux3
 =‡ux3 - ((aux3 >> 1) & 0x55555555);

41 
aux3
 = (aux3 & 0x33333333) + ((aux3 >> 2) & 0x33333333);

42 
aux4
 =‡ux4 - ((aux4 >> 1) & 0x55555555);

43 
aux4
 = (aux4 & 0x33333333) + ((aux4 >> 2) & 0x33333333);

44 
aux5
 =‡ux5 - ((aux5 >> 1) & 0x55555555);

45 
aux5
 = (aux5 & 0x33333333) + ((aux5 >> 2) & 0x33333333);

46 
aux6
 =‡ux6 - ((aux6 >> 1) & 0x55555555);

47 
aux6
 = (aux6 & 0x33333333) + ((aux6 >> 2) & 0x33333333);

48 
aux7
 =‡ux7 - ((aux7 >> 1) & 0x55555555);

49 
aux7
 = (aux7 & 0x33333333) + ((aux7 >> 2) & 0x33333333);

50 
b™s
 +ğ((((
aux1
 + (aux1 >> 4)) & 0x0F0F0F0F) +

51 ((
aux2
 + (aux2 >> 4)) & 0x0F0F0F0F) +

52 ((
aux3
 + (aux3 >> 4)) & 0x0F0F0F0F) +

53 ((
aux4
 + (aux4 >> 4)) & 0x0F0F0F0F) +

54 ((
aux5
 + (aux5 >> 4)) & 0x0F0F0F0F) +

55 ((
aux6
 + (aux6 >> 4)) & 0x0F0F0F0F) +

56 ((
aux7
 + (aux7 >> 4)) & 0x0F0F0F0F))* 0x01010101) >> 24;

59 
p
 = (*)
p4
;

60 
couÁ
--è
b™s
 +ğ
b™sšby‹
[*
p
++];

61  
b™s
;

62 
	}
}

71 
	$»disB™pos
(*
s
, 
couÁ
, 
b™
) {

72 *
l
;

73 *
c
;

74 
skv®
, 
wÜd
 = 0, 
Úe
;

75 
pos
 = 0;

76 
j
;

88 
skv®
 = 
b™
 ? 0 : 
UCHAR_MAX
;

89 
c
 = (*è
s
;

90 ()
c
 & ((*
l
)-1è&& 
couÁ
) {

91 ià(*
c
 !ğ
skv®
) ;

92 
c
++;

93 
couÁ
--;

94 
pos
 += 8;

98 
skv®
 = 
b™
 ? 0 : 
ULONG_MAX
;

99 
l
 = (*è
c
;

100 
couÁ
 >ğ(*
l
)) {

101 ià(*
l
 !ğ
skv®
) ;

102 
l
++;

103 
couÁ
 -ğ(*
l
);

104 
pos
 +ğ(*
l
)*8;

114 
c
 = (*)
l
;

115 
j
 = 0; j < (*
l
); j++) {

116 
wÜd
 <<= 8;

117 ià(
couÁ
) {

118 
wÜd
 |ğ*
c
;

119 
c
++;

120 
couÁ
--;

129 ià(
b™
 =ğ1 && 
wÜd
 == 0)  -1;

135 
Úe
 = 
ULONG_MAX
;

136 
Úe
 >>= 1;

137 
Úe
 = ~one;

139 
Úe
) {

140 ià(((
Úe
 & 
wÜd
è!ğ0è=ğ
b™
è 
pos
;

141 
pos
++;

142 
Úe
 >>= 1;

147 
	`£rv”Pªic
("End of„edisBitpos()„eached.");

149 
	}
}

172 
	$£tUnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, ušt64_ˆ
v®ue
) {

173 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
;

175 
j
 = 0; j < 
b™s
; j++) {

176 
b™v®
 = (
v®ue
 & ((
ušt64_t
)1<<(
b™s
-1-
j
))) != 0;

177 
by‹
 = 
off£t
 >> 3;

178 
b™
 = 7 - (
off£t
 & 0x7);

179 
by‹v®
 = 
p
[
by‹
];

180 
by‹v®
 &ğ~(1 << 
b™
);

181 
by‹v®
 |ğ
b™v®
 << 
b™
;

182 
p
[
by‹
] = 
by‹v®
 & 0xff;

183 
off£t
++;

185 
	}
}

187 
	$£tSigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, 
št64_t
 
v®ue
) {

188 
ušt64_t
 
uv
;

190 ià(
v®ue
 >= 0)

191 
uv
 = 
v®ue
;

193 
uv
 = 
UINT64_MAX
 + 
v®ue
 + 1;

194 
	`£tUnsigÃdB™f›ld
(
p
,
off£t
,
b™s
,
uv
);

195 
	}
}

197 
ušt64_t
 
	$g‘UnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

198 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
, 
v®ue
 = 0;

200 
j
 = 0; j < 
b™s
; j++) {

201 
by‹
 = 
off£t
 >> 3;

202 
b™
 = 7 - (
off£t
 & 0x7);

203 
by‹v®
 = 
p
[
by‹
];

204 
b™v®
 = (
by‹v®
 >> 
b™
) & 1;

205 
v®ue
 = (v®ue<<1è| 
b™v®
;

206 
off£t
++;

208  
v®ue
;

209 
	}
}

211 
št64_t
 
	$g‘SigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

212 
št64_t
 
v®ue
 = 
	`g‘UnsigÃdB™f›ld
(
p
,
off£t
,
b™s
);

216 ià(
v®ue
 & ((
ušt64_t
)1 << (
b™s
-1)))

217 
v®ue
 |ğ((
ušt64_t
)-1è<< 
b™s
;

218  
v®ue
;

219 
	}
}

240 
	#BFOVERFLOW_WRAP
 0

	)

241 
	#BFOVERFLOW_SAT
 1

	)

242 
	#BFOVERFLOW_FAIL
 2

	)

244 
	$checkUnsigÃdB™f›ldOv”æow
(
ušt64_t
 
v®ue
, 
št64_t
 
šü
, ušt64_ˆ
b™s
, 
owty³
, ušt64_ˆ*
lim™
) {

245 
ušt64_t
 
max
 = (
b™s
 =ğ64è? 
UINT64_MAX
 : (((uint64_t)1<<bits)-1);

246 
št64_t
 
maxšü
 = 
max
-
v®ue
;

247 
št64_t
 
mššü
 = -
v®ue
;

249 ià(
v®ue
 > 
max
 || (
šü
 > 0 && inü > 
maxšü
)) {

250 ià(
lim™
) {

251 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

252 
hªdË_w¿p
;

253 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

254 *
lim™
 = 
max
;

258 } ià(
šü
 < 0 && inü < 
mššü
) {

259 ià(
lim™
) {

260 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

261 
hªdË_w¿p
;

262 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

263 *
lim™
 = 0;

270 
hªdË_w¿p
:

272 
ušt64_t
 
mask
 = ((
št64_t
)-1è<< 
b™s
;

273 
ušt64_t
 
»s
 = 
v®ue
+
šü
;

275 
»s
 &ğ~
mask
;

276 *
lim™
 = 
»s
;

279 
	}
}

281 
	$checkSigÃdB™f›ldOv”æow
(
št64_t
 
v®ue
, iÁ64_ˆ
šü
, 
ušt64_t
 
b™s
, 
owty³
, iÁ64_ˆ*
lim™
) {

282 
št64_t
 
max
 = (
b™s
 =ğ64è? 
INT64_MAX
 : (((int64_t)1<<(bits-1))-1);

283 
št64_t
 
mš
 = (-
max
)-1;

288 
št64_t
 
maxšü
 = 
max
-
v®ue
;

289 
št64_t
 
mššü
 = 
mš
-
v®ue
;

291 ià(
v®ue
 > 
max
 || (
b™s
 !ğ64 && 
šü
 > 
maxšü
) || (value >= 0 && incr > 0 && incr > maxincr))

293 ià(
lim™
) {

294 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

295 
hªdË_w¿p
;

296 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

297 *
lim™
 = 
max
;

301 } ià(
v®ue
 < 
mš
 || (
b™s
 !ğ64 && 
šü
 < 
mššü
) || (value < 0 && incr < 0 && incr < minincr)) {

302 ià(
lim™
) {

303 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

304 
hªdË_w¿p
;

305 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

306 *
lim™
 = 
mš
;

313 
hªdË_w¿p
:

315 
ušt64_t
 
mask
 = ((
št64_t
)-1è<< 
b™s
;

316 
ušt64_t
 
msb
 = (ušt64_t)1 << (
b™s
-1);

317 
ušt64_t
 
a
 = 
v®ue
, 
b
 = 
šü
, 
c
;

318 
c
 = 
a
+
b
;

323 ià(
c
 & 
msb
) {

324 
c
 |ğ
mask
;

326 
c
 &ğ~
mask
;

328 *
lim™
 = 
c
;

331 
	}
}

335 
	$´štB™s
(*
p
, 
couÁ
) {

336 
j
, 
i
, 
by‹
;

338 
j
 = 0; j < 
couÁ
; j++) {

339 
by‹
 = 
p
[
j
];

340 
i
 = 0x80; i > 0; i /= 2)

341 
	`´štf
("%c", (
by‹
 & 
i
) ? '1' : '0');

342 
	`´štf
("|");

344 
	`´štf
("\n");

345 
	}
}

351 
	#BITOP_AND
 0

	)

352 
	#BITOP_OR
 1

	)

353 
	#BITOP_XOR
 2

	)

354 
	#BITOP_NOT
 3

	)

356 
	#BITFIELDOP_GET
 0

	)

357 
	#BITFIELDOP_SET
 1

	)

358 
	#BITFIELDOP_INCRBY
 2

	)

367 
	$g‘B™Off£tFromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
, 
hash
, 
b™s
) {

368 
loff£t
;

369 *
”r
 = "bit offset is‚ot‡n integer or out of„ange";

370 *
p
 = 
o
->
±r
;

371 
size_t
 
¶’
 = 
	`sd¦’
(
p
);

372 
u£hash
 = 0;

375 ià(
p
[0] =ğ'#' && 
hash
 && 
b™s
 > 0è
u£hash
 = 1;

377 ià(
	`¡ršg2Î
(
p
+
u£hash
,
¶’
-u£hash,&
loff£t
) == 0) {

378 
	`addR•lyE¼Ü
(
c
,
”r
);

379  
VR_ERROR
;

383 ià(
u£hash
è
loff£t
 *ğ
b™s
;

386 ià((
loff£t
 < 0) || (()loffset >> 3) >= (512*1024*1024))

388 
	`addR•lyE¼Ü
(
c
,
”r
);

389  
VR_ERROR
;

392 *
off£t
 = (
size_t
)
loff£t
;

393  
VR_OK
;

394 
	}
}

403 
	$g‘B™f›ldTy³FromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, *
sign
, *
b™s
) {

404 *
p
 = 
o
->
±r
;

405 *
”r
 = "Invalid bitfieldype. Use something†ike i16 u8. Notehat u64 is‚ot supported but i64 is.";

406 
Îb™s
;

408 ià(
p
[0] == 'i') {

409 *
sign
 = 1;

410 } ià(
p
[0] == 'u') {

411 *
sign
 = 0;

413 
	`addR•lyE¼Ü
(
c
,
”r
);

414  
VR_ERROR
;

417 ià((
	`¡ršg2Î
(
p
+1,
	`¡¾’
Õ+1),&
Îb™s
)) == 0 ||

418 
Îb™s
 < 1 ||

419 (*
sign
 =ğ1 && 
Îb™s
 > 64) ||

420 (*
sign
 =ğ0 && 
Îb™s
 > 63))

422 
	`addR•lyE¼Ü
(
c
,
”r
);

423  
VR_ERROR
;

425 *
b™s
 = 
Îb™s
;

426  
VR_OK
;

427 
	}
}

434 
robj
 *
	$lookupSŒšgFÜB™Commªd
(
ş›Á
 *
c
, 
size_t
 
maxb™
, *
expœed
) {

435 
size_t
 
by‹
 = 
maxb™
 >> 3;

436 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
expœed
);

438 ià(
o
 =ğ
NULL
) {

439 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
by‹
+1));

440 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

442 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)è 
NULL
;

443 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

444 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
by‹
+1);

446  
o
;

447 
	}
}

450 
	$£tb™Commªd
(
ş›Á
 *
c
) {

451 
robj
 *
o
;

452 *
”r
 = "bit is‚ot‡n integer or out of„ange";

453 
size_t
 
b™off£t
;

454 
ssize_t
 
by‹
, 
b™
;

455 
by‹v®
, 
b™v®
;

456 
Ú
;

457 
expœed
 = 0;

459 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
VR_OK
)

462 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
Ú
,
”r
è!ğ
VR_OK
)

466 ià(
Ú
 & ~1) {

467 
	`addR•lyE¼Ü
(
c
,
”r
);

471 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

472 
	`lockDbWr™e
(
c
->
db
);

473 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,
b™off£t
,&
expœed
)è=ğ
NULL
) {

474 
	`uÆockDb
(
c
->
db
);

475 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

480 
by‹
 = 
b™off£t
 >> 3;

481 
by‹v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
];

482 
b™
 = 7 - (
b™off£t
 & 0x7);

483 
b™v®
 = 
by‹v®
 & (1 << 
b™
);

486 
by‹v®
 &ğ~(1 << 
b™
);

487 
by‹v®
 |ğ((
Ú
 & 0x1è<< 
b™
);

488 ((
ušt8_t
*)
o
->
±r
)[
by‹
] = 
by‹v®
;

489 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

490 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

491 
c
->
v–
->
dœty
++;

492 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

493 
	`uÆockDb
(
c
->
db
);

494 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

495 
	}
}

498 
	$g‘b™Commªd
(
ş›Á
 *
c
) {

499 
robj
 *
o
;

500 
Îbuf
[32];

501 
size_t
 
b™off£t
;

502 
size_t
 
by‹
, 
b™
;

503 
size_t
 
b™v®
 = 0;

505 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
VR_OK
)

508 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

509 
	`lockDbR—d
(
c
->
db
);

510 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

511 
	`uÆockDb
(
c
->
db
);

512 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

514 } ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

515 
	`uÆockDb
(
c
->
db
);

516 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

519 
by‹
 = 
b™off£t
 >> 3;

520 
b™
 = 7 - (
b™off£t
 & 0x7);

521 ià(
	`sdsEncodedObjeù
(
o
)) {

522 ià(
by‹
 < 
	`sd¦’
(
o
->
±r
))

523 
b™v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
] & (1 << 
b™
);

525 ià(
by‹
 < (
size_t
)
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
))

526 
b™v®
 = 
Îbuf
[
by‹
] & (1 << 
b™
);

529 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

530 
	`uÆockDb
(
c
->
db
);

531 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

532 
	}
}

535 
	$b™İCommªd
(
ş›Á
 *
c
) {

536 *
İÇme
 = 
c
->
¬gv
[1]->
±r
;

537 
robj
 *
o
, *
rg‘key
 = 
c
->
¬gv
[2];

538 
İ
, 
j
, 
numkeys
;

539 
robj
 **
objeùs
;

540 **
¤c
;

541 *
Ën
, 
maxËn
 = 0;

543 
mšËn
 = 0;

544 *
»s
 = 
NULL
;

547 ià((
İÇme
[0] =ğ'a' || o²ame[0] =ğ'A'è&& !
	`¡rÿ£cmp
(opname,"and"))

548 
İ
 = 
BITOP_AND
;

549 if((
İÇme
[0] =ğ'o' || o²ame[0] =ğ'O'è&& !
	`¡rÿ£cmp
(opname,"or"))

550 
İ
 = 
BITOP_OR
;

551 if((
İÇme
[0] =ğ'x' || o²ame[0] =ğ'X'è&& !
	`¡rÿ£cmp
(opname,"xor"))

552 
İ
 = 
BITOP_XOR
;

553 if((
İÇme
[0] =ğ'n' || o²ame[0] =ğ'N'è&& !
	`¡rÿ£cmp
(opname,"not"))

554 
İ
 = 
BITOP_NOT
;

556 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

561 ià(
İ
 =ğ
BITOP_NOT
 && 
c
->
¬gc
 != 4) {

562 
	`addR•lyE¼Ü
(
c
,"BITOP NOT must be called with‡ single source key.");

567 
numkeys
 = 
c
->
¬gc
 - 3;

568 
¤c
 = 
	`d®loc
((*è* 
numkeys
);

569 
Ën
 = 
	`d®loc
((è* 
numkeys
);

570 
objeùs
 = 
	`d®loc
((
robj
*è* 
numkeys
);

571 
j
 = 0; j < 
numkeys
; j++) {

572 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
+3]);

574 ià(
o
 =ğ
NULL
) {

575 
objeùs
[
j
] = 
NULL
;

576 
¤c
[
j
] = 
NULL
;

577 
Ën
[
j
] = 0;

578 
mšËn
 = 0;

582 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

583 
i
;

584 
i
 = 0; i < 
j
; i++) {

585 ià(
objeùs
[
i
])

586 
	`deüRefCouÁ
(
objeùs
[
i
]);

588 
	`dä“
(
¤c
);

589 
	`dä“
(
Ën
);

590 
	`dä“
(
objeùs
);

593 
objeùs
[
j
] = 
	`g‘DecodedObjeù
(
o
);

594 
¤c
[
j
] = 
objeùs
[j]->
±r
;

595 
Ën
[
j
] = 
	`sd¦’
(
objeùs
[j]->
±r
);

596 ià(
Ën
[
j
] > 
maxËn
) maxlen =†en[j];

597 ià(
j
 =ğ0 || 
Ën
[j] < 
mšËn
) minlen =†en[j];

601 ià(
maxËn
) {

602 
»s
 = (*è
	`sd¢ewËn
(
NULL
,
maxËn
);

603 
ouut
, 
by‹
;

604 
i
;

609 
j
 = 0;

610 ià(
mšËn
 >ğ()*4 && 
numkeys
 <= 16) {

611 *
Í
[16];

612 *
Ìes
 = (*è
»s
;

615 
	`memıy
(
Í
,
¤c
,(*)*
numkeys
);

616 
	`memıy
(
»s
,
¤c
[0],
mšËn
);

619 ià(
İ
 =ğ
BITOP_AND
) {

620 
mšËn
 >= ()*4) {

621 
i
 = 1; i < 
numkeys
; i++) {

622 
Ìes
[0] &ğ
Í
[
i
][0];

623 
Ìes
[1] &ğ
Í
[
i
][1];

624 
Ìes
[2] &ğ
Í
[
i
][2];

625 
Ìes
[3] &ğ
Í
[
i
][3];

626 
Í
[
i
]+=4;

628 
Ìes
+=4;

629 
j
 += ()*4;

630 
mšËn
 -= ()*4;

632 } ià(
İ
 =ğ
BITOP_OR
) {

633 
mšËn
 >= ()*4) {

634 
i
 = 1; i < 
numkeys
; i++) {

635 
Ìes
[0] |ğ
Í
[
i
][0];

636 
Ìes
[1] |ğ
Í
[
i
][1];

637 
Ìes
[2] |ğ
Í
[
i
][2];

638 
Ìes
[3] |ğ
Í
[
i
][3];

639 
Í
[
i
]+=4;

641 
Ìes
+=4;

642 
j
 += ()*4;

643 
mšËn
 -= ()*4;

645 } ià(
İ
 =ğ
BITOP_XOR
) {

646 
mšËn
 >= ()*4) {

647 
i
 = 1; i < 
numkeys
; i++) {

648 
Ìes
[0] ^ğ
Í
[
i
][0];

649 
Ìes
[1] ^ğ
Í
[
i
][1];

650 
Ìes
[2] ^ğ
Í
[
i
][2];

651 
Ìes
[3] ^ğ
Í
[
i
][3];

652 
Í
[
i
]+=4;

654 
Ìes
+=4;

655 
j
 += ()*4;

656 
mšËn
 -= ()*4;

658 } ià(
İ
 =ğ
BITOP_NOT
) {

659 
mšËn
 >= ()*4) {

660 
Ìes
[0] = ~lres[0];

661 
Ìes
[1] = ~lres[1];

662 
Ìes
[2] = ~lres[2];

663 
Ìes
[3] = ~lres[3];

664 
Ìes
+=4;

665 
j
 += ()*4;

666 
mšËn
 -= ()*4;

672 ; 
j
 < 
maxËn
; j++) {

673 
ouut
 = (
Ën
[0] <ğ
j
è? 0 : 
¤c
[0][j];

674 ià(
İ
 =ğ
BITOP_NOT
è
ouut
 = ~output;

675 
i
 = 1; i < 
numkeys
; i++) {

676 
by‹
 = (
Ën
[
i
] <ğ
j
è? 0 : 
¤c
[i][j];

677 
İ
) {

678 
BITOP_AND
: 
ouut
 &ğ
by‹
; ;

679 
BITOP_OR
: 
ouut
 |ğ
by‹
; ;

680 
BITOP_XOR
: 
ouut
 ^ğ
by‹
; ;

683 
»s
[
j
] = 
ouut
;

686 
j
 = 0; j < 
numkeys
; j++) {

687 ià(
objeùs
[
j
])

688 
	`deüRefCouÁ
(
objeùs
[
j
]);

690 
	`dä“
(
¤c
);

691 
	`dä“
(
Ën
);

692 
	`dä“
(
objeùs
);

695 ià(
maxËn
) {

696 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
»s
);

697 
	`£tKey
(
c
->
db
,
rg‘key
,
o
,
NULL
);

698 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
rg‘key
,
c
->
db
->
id
);

699 
	`deüRefCouÁ
(
o
);

700 } ià(
	`dbD–‘e
(
c
->
db
,
rg‘key
)) {

701 
	`sigÇlModif›dKey
(
c
->
db
,
rg‘key
);

702 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
rg‘key
,
c
->
db
->
id
);

704 
£rv”
.
dœty
++;

705 
	`addR•lyLÚgLÚg
(
c
,
maxËn
);

706 
	}
}

709 
	$b™couÁCommªd
(
ş›Á
 *
c
) {

710 
robj
 *
o
;

711 
¡¬t
, 
’d
, 
¡¾’
;

712 *
p
;

713 
Îbuf
[32];

715 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

716 
	`lockDbR—d
(
c
->
db
);

718 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

719 
	`uÆockDb
(
c
->
db
);

720 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

722 } ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

723 
	`uÆockDb
(
c
->
db
);

724 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

730 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

731 
p
 = (*è
Îbuf
;

732 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

734 
p
 = (*è
o
->
±r
;

735 
¡¾’
 = 
	`sd¦’
(
o
->
±r
);

739 ià(
c
->
¬gc
 == 4) {

740 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
VR_OK
) {

741 
	`uÆockDb
(
c
->
db
);

742 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

745 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
VR_OK
) {

746 
	`uÆockDb
(
c
->
db
);

747 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

751 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

752 ià(
’d
 < 0è’d = 
¡¾’
+end;

753 ià(
¡¬t
 < 0) start = 0;

754 ià(
’d
 < 0)ƒnd = 0;

755 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

756 } ià(
c
->
¬gc
 == 2) {

758 
¡¬t
 = 0;

759 
’d
 = 
¡¾’
-1;

761 
	`uÆockDb
(
c
->
db
);

762 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

764 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

770 ià(
¡¬t
 > 
’d
) {

771 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

773 
by‹s
 = 
’d
-
¡¬t
+1;

775 
	`addR•lyLÚgLÚg
(
c
,
	`»disPİcouÁ
(
p
+
¡¬t
,
by‹s
));

777 
	`uÆockDb
(
c
->
db
);

778 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

779 
	}
}

782 
	$b™posCommªd
(
ş›Á
 *
c
) {

783 
robj
 *
o
;

784 
b™
, 
¡¬t
, 
’d
, 
¡¾’
;

785 *
p
;

786 
Îbuf
[32];

787 
’d_giv’
 = 0;

791 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
b™
,
NULL
è!ğ
VR_OK
)

793 ià(
b™
 != 0 && bit != 1) {

794 
	`addR•lyE¼Ü
(
c
, "The bit‡rgument must be 1 or 0.");

798 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

799 
	`lockDbR—d
(
c
->
db
);

803 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

804 
	`uÆockDb
(
c
->
db
);

805 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

806 
	`addR•lyLÚgLÚg
(
c
, 
b™
 ? -1 : 0);

809 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

810 
	`uÆockDb
(
c
->
db
);

811 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

817 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

818 
p
 = (*è
Îbuf
;

819 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

821 
p
 = (*è
o
->
±r
;

822 
¡¾’
 = 
	`sd¦’
(
o
->
±r
);

826 ià(
c
->
¬gc
 == 4 || c->argc == 5) {

827 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
¡¬t
,
NULL
è!ğ
VR_OK
) {

828 
	`uÆockDb
(
c
->
db
);

829 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

832 ià(
c
->
¬gc
 == 5) {

833 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
’d
,
NULL
è!ğ
VR_OK
) {

834 
	`uÆockDb
(
c
->
db
);

835 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

838 
’d_giv’
 = 1;

840 
’d
 = 
¡¾’
-1;

843 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

844 ià(
’d
 < 0è’d = 
¡¾’
+end;

845 ià(
¡¬t
 < 0) start = 0;

846 ià(
’d
 < 0)ƒnd = 0;

847 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

848 } ià(
c
->
¬gc
 == 3) {

850 
¡¬t
 = 0;

851 
’d
 = 
¡¾’
-1;

853 
	`uÆockDb
(
c
->
db
);

854 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

856 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

862 ià(
¡¬t
 > 
’d
) {

863 
	`addR•lyLÚgLÚg
(
c
, -1);

865 
by‹s
 = 
’d
-
¡¬t
+1;

866 
pos
 = 
	`»disB™pos
(
p
+
¡¬t
,
by‹s
,
b™
);

875 ià(
’d_giv’
 && 
b™
 =ğ0 && 
pos
 =ğ
by‹s
*8) {

876 
	`uÆockDb
(
c
->
db
);

877 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

878 
	`addR•lyLÚgLÚg
(
c
,-1);

881 ià(
pos
 !ğ-1èpo +ğ
¡¬t
*8;

882 
	`addR•lyLÚgLÚg
(
c
,
pos
);

884 
	`uÆockDb
(
c
->
db
);

885 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

886 
	}
}

898 
	sb™f›ldOp
 {

899 
ušt64_t
 
	moff£t
;

900 
št64_t
 
	mi64
;

901 
	mİcode
;

902 
	mowty³
;

903 
	mb™s
;

904 
	msign
;

907 
	$b™f›ldCommªd
(
ş›Á
 *
c
) {

908 
robj
 *
o
;

909 
size_t
 
b™off£t
;

910 
j
, 
numİs
 = 0, 
chªges
 = 0;

911 
b™f›ldOp
 *
İs
 = 
NULL
;

912 
owty³
 = 
BFOVERFLOW_WRAP
;

914 
j
 = 2; j < 
c
->
¬gc
; j++) {

915 
»m¬gs
 = 
c
->
¬gc
-
j
-1;

916 *
subcmd
 = 
c
->
¬gv
[
j
]->
±r
;

917 
İcode
;

918 
i64
 = 0;

919 
sign
 = 0;

920 
b™s
 = 0;

922 ià(!
	`¡rÿ£cmp
(
subcmd
,"g‘"è&& 
»m¬gs
 >= 2)

923 
İcode
 = 
BITFIELDOP_GET
;

924 ià(!
	`¡rÿ£cmp
(
subcmd
,"£t"è&& 
»m¬gs
 >= 3)

925 
İcode
 = 
BITFIELDOP_SET
;

926 ià(!
	`¡rÿ£cmp
(
subcmd
,"šüby"è&& 
»m¬gs
 >= 3)

927 
İcode
 = 
BITFIELDOP_INCRBY
;

928 ià(!
	`¡rÿ£cmp
(
subcmd
,"ov”æow"è&& 
»m¬gs
 >= 1) {

929 *
owty³Çme
 = 
c
->
¬gv
[
j
+1]->
±r
;

930 
j
++;

931 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"wrap"))

932 
owty³
 = 
BFOVERFLOW_WRAP
;

933 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"sat"))

934 
owty³
 = 
BFOVERFLOW_SAT
;

935 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"fail"))

936 
owty³
 = 
BFOVERFLOW_FAIL
;

938 
	`addR•lyE¼Ü
(
c
,"Invalid OVERFLOWype specified");

939 
	`dä“
(
İs
);

944 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

945 
	`dä“
(
İs
);

950 ià(
	`g‘B™f›ldTy³FromArgum’t
(
c
,c->
¬gv
[
j
+1],&
sign
,&
b™s
è!ğ
VR_OK
) {

951 
	`dä“
(
İs
);

955 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[
j
+2],&
b™off£t
,1,
b™s
è!ğ
VR_OK
){

956 
	`dä“
(
İs
);

961 ià(
İcode
 !ğ
BITFIELDOP_GET
) {

962 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+3],&
i64
,
NULL
è!ğ
VR_OK
){

963 
	`dä“
(
İs
);

969 
İs
 = 
	`d»®loc
(İs,(*İs)*(
numİs
+1));

970 
İs
[
numİs
].
off£t
 = 
b™off£t
;

971 
İs
[
numİs
].
i64
 = i64;

972 
İs
[
numİs
].
İcode
 = opcode;

973 
İs
[
numİs
].
owty³
 = owtype;

974 
İs
[
numİs
].
b™s
 = bits;

975 
İs
[
numİs
].
sign
 = sign;

976 
numİs
++;

978 
j
 +ğ3 - (
İcode
 =ğ
BITFIELDOP_GET
);

981 
	`addR•lyMuÉiBulkL’
(
c
,
numİs
);

984 
j
 = 0; j < 
numİs
; j++) {

985 
b™f›ldOp
 *
thisİ
 = 
İs
+
j
;

988 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_SET
 ||

989 
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
)

997 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,

998 
thisİ
->
off£t
 + (thisİ->
b™s
-1), 
NULL
)) == NULL) ;

1003 ià(
thisİ
->
sign
) {

1004 
št64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1005 
ov”æow
;

1007 
Şdv®
 = 
	`g‘SigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1008 
thisİ
->
b™s
);

1010 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1011 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1012 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Şdv®
,

1013 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1014 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1015 
»tv®
 = 
Ãwv®
;

1017 
Ãwv®
 = 
thisİ
->
i64
;

1018 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Ãwv®
,

1019 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1020 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1021 
»tv®
 = 
Şdv®
;

1026 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1027 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1028 
	`£tSigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1029 
thisİ
->
b™s
,
Ãwv®
);

1031 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1034 
ušt64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1035 
ov”æow
;

1037 
Şdv®
 = 
	`g‘UnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1038 
thisİ
->
b™s
);

1040 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1041 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1042 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Şdv®
,

1043 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1044 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1045 
»tv®
 = 
Ãwv®
;

1047 
Ãwv®
 = 
thisİ
->
i64
;

1048 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Ãwv®
,

1049 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1050 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1051 
»tv®
 = 
Şdv®
;

1055 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1056 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1057 
	`£tUnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1058 
thisİ
->
b™s
,
Ãwv®
);

1060 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1063 
chªges
++;

1066 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

1067 
size_t
 
Ş’
 = (
o
 =ğ
NULL
è? 0 : 
	`sd¦’
(o->
±r
);

1068 
buf
[9];

1074 
	`mem£t
(
buf
,0,9);

1075 *
¤c
 = 
o
 ? o->
±r
 : 
NULL
;

1076 
i
;

1077 
size_t
 
by‹
 = 
thisİ
->
off£t
 >> 3;

1078 
i
 = 0; i < 9; i++) {

1079 ià(
¤c
 =ğ
NULL
 || 
i
+
by‹
 >ğ
Ş’
) ;

1080 
buf
[
i
] = 
¤c
[i+
by‹
];

1085 ià(
thisİ
->
sign
) {

1086 
št64_t
 
v®
 = 
	`g‘SigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1087 
thisİ
->
b™s
);

1088 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1090 
ušt64_t
 
v®
 = 
	`g‘UnsigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1091 
thisİ
->
b™s
);

1092 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1097 ià(
chªges
) {

1098 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1099 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

1100 
£rv”
.
dœty
 +ğ
chªges
;

1102 
	`dä“
(
İs
);

1103 
	}
}

	@src/vr_bitops.h

1 #iâdeà
_VR_BITOPS_H_


2 
	#_VR_BITOPS_H_


	)

4 
size_t
 
»disPİcouÁ
(*
s
, 
couÁ
);

5 
»disB™pos
(*
s
, 
couÁ
, 
b™
);

6 
£tUnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, ušt64_ˆ
v®ue
);

7 
£tSigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, 
št64_t
 
v®ue
);

8 
ušt64_t
 
g‘UnsigÃdB™f›ld
(*
p
, ušt64_ˆ
off£t
, ušt64_ˆ
b™s
);

9 
št64_t
 
g‘SigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
);

10 
checkUnsigÃdB™f›ldOv”æow
(
ušt64_t
 
v®ue
, 
št64_t
 
šü
, ušt64_ˆ
b™s
, 
owty³
, ušt64_ˆ*
lim™
);

11 
checkSigÃdB™f›ldOv”æow
(
št64_t
 
v®ue
, iÁ64_ˆ
šü
, 
ušt64_t
 
b™s
, 
owty³
, iÁ64_ˆ*
lim™
);

12 
´štB™s
(*
p
, 
couÁ
);

13 
g‘B™Off£tFromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
, 
hash
, 
b™s
);

14 
g‘B™f›ldTy³FromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, *
sign
, *
b™s
);

15 
robj
 *
lookupSŒšgFÜB™Commªd
(
ş›Á
 *
c
, 
size_t
 
maxb™
, *
expœed
);

16 
£tb™Commªd
(
ş›Á
 *
c
);

17 
g‘b™Commªd
(
ş›Á
 *
c
);

18 
b™İCommªd
(
ş›Á
 *
c
);

19 
b™couÁCommªd
(
ş›Á
 *
c
);

20 
b™posCommªd
(
ş›Á
 *
c
);

21 
b™f›ldCommªd
(
ş›Á
 *
c
);

	@src/vr_bitops.h

1 #iâdeà
_VR_BITOPS_H_


2 
	#_VR_BITOPS_H_


	)

4 
size_t
 
»disPİcouÁ
(*
s
, 
couÁ
);

5 
»disB™pos
(*
s
, 
couÁ
, 
b™
);

6 
£tUnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, ušt64_ˆ
v®ue
);

7 
£tSigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, 
št64_t
 
v®ue
);

8 
ušt64_t
 
g‘UnsigÃdB™f›ld
(*
p
, ušt64_ˆ
off£t
, ušt64_ˆ
b™s
);

9 
št64_t
 
g‘SigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
);

10 
checkUnsigÃdB™f›ldOv”æow
(
ušt64_t
 
v®ue
, 
št64_t
 
šü
, ušt64_ˆ
b™s
, 
owty³
, ušt64_ˆ*
lim™
);

11 
checkSigÃdB™f›ldOv”æow
(
št64_t
 
v®ue
, iÁ64_ˆ
šü
, 
ušt64_t
 
b™s
, 
owty³
, iÁ64_ˆ*
lim™
);

12 
´štB™s
(*
p
, 
couÁ
);

13 
g‘B™Off£tFromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
, 
hash
, 
b™s
);

14 
g‘B™f›ldTy³FromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, *
sign
, *
b™s
);

15 
robj
 *
lookupSŒšgFÜB™Commªd
(
ş›Á
 *
c
, 
size_t
 
maxb™
, *
expœed
);

16 
£tb™Commªd
(
ş›Á
 *
c
);

17 
g‘b™Commªd
(
ş›Á
 *
c
);

18 
b™İCommªd
(
ş›Á
 *
c
);

19 
b™couÁCommªd
(
ş›Á
 *
c
);

20 
b™posCommªd
(
ş›Á
 *
c
);

21 
b™f›ldCommªd
(
ş›Á
 *
c
);

	@src/vr_block.c

1 
	~<vr_cÜe.h
>

7 
	$unblockCl›Á
(
ş›Á
 *
c
) {

8 ià(
c
->
bty³
 =ğ
BLOCKED_LIST
) {

9 
	`unblockCl›ÁWa™šgD©a
(
c
);

10 } ià(
c
->
bty³
 =ğ
BLOCKED_WAIT
) {

11 
	`unblockCl›ÁWa™šgR•liÿs
(
c
);

13 
	`£rv”Pªic
("Unknown btype in unblockClient().");

17 
c
->
æags
 &ğ~
CLIENT_BLOCKED
;

18 
c
->
bty³
 = 
BLOCKED_NONE
;

19 
c
->
v–
->
bpİ_blocked_ş›Ás
--;

22 ià(!(
c
->
æags
 & 
CLIENT_UNBLOCKED
)) {

23 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

24 
	`dli¡AddNodeTa
(
c
->
v–
->
unblocked_ş›Ás
,c);

26 
	}
}

37 
	$g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, *
timeout
, 
un™
) {

38 
tv®
;

40 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
objeù
,&
tv®
,

41 "timeouˆi nÙ‡Àš‹g” o¸ouˆoà¿nge"è!ğ
VR_OK
)

42  
VR_ERROR
;

44 ià(
tv®
 < 0) {

45 
	`addR•lyE¼Ü
(
c
,"timeout is‚egative");

46  
VR_ERROR
;

49 ià(
tv®
 > 0) {

50 ià(
un™
 =ğ
UNIT_SECONDS
è
tv®
 *= 1000;

51 
tv®
 +ğ
	`vr_m£c_now
();

53 *
timeout
 = 
tv®
;

55  
VR_OK
;

56 
	}
}

62 
	$blockCl›Á
(
ş›Á
 *
c
, 
bty³
) {

63 
c
->
æags
 |ğ
CLIENT_BLOCKED
;

64 
c
->
bty³
 = btype;

65 
c
->
v–
->
bpİ_blocked_ş›Ás
++;

66 
	}
}

	@src/vr_block.c

1 
	~<vr_cÜe.h
>

7 
	$unblockCl›Á
(
ş›Á
 *
c
) {

8 ià(
c
->
bty³
 =ğ
BLOCKED_LIST
) {

9 
	`unblockCl›ÁWa™šgD©a
(
c
);

10 } ià(
c
->
bty³
 =ğ
BLOCKED_WAIT
) {

11 
	`unblockCl›ÁWa™šgR•liÿs
(
c
);

13 
	`£rv”Pªic
("Unknown btype in unblockClient().");

17 
c
->
æags
 &ğ~
CLIENT_BLOCKED
;

18 
c
->
bty³
 = 
BLOCKED_NONE
;

19 
c
->
v–
->
bpİ_blocked_ş›Ás
--;

22 ià(!(
c
->
æags
 & 
CLIENT_UNBLOCKED
)) {

23 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

24 
	`dli¡AddNodeTa
(
c
->
v–
->
unblocked_ş›Ás
,c);

26 
	}
}

37 
	$g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, *
timeout
, 
un™
) {

38 
tv®
;

40 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
objeù
,&
tv®
,

41 "timeouˆi nÙ‡Àš‹g” o¸ouˆoà¿nge"è!ğ
VR_OK
)

42  
VR_ERROR
;

44 ià(
tv®
 < 0) {

45 
	`addR•lyE¼Ü
(
c
,"timeout is‚egative");

46  
VR_ERROR
;

49 ià(
tv®
 > 0) {

50 ià(
un™
 =ğ
UNIT_SECONDS
è
tv®
 *= 1000;

51 
tv®
 +ğ
	`vr_m£c_now
();

53 *
timeout
 = 
tv®
;

55  
VR_OK
;

56 
	}
}

62 
	$blockCl›Á
(
ş›Á
 *
c
, 
bty³
) {

63 
c
->
æags
 |ğ
CLIENT_BLOCKED
;

64 
c
->
bty³
 = btype;

65 
c
->
v–
->
bpİ_blocked_ş›Ás
++;

66 
	}
}

	@src/vr_block.h

1 #iâdeà
_VR_BLOCK_H_


2 
	#_VR_BLOCK_H_


	)

7 
	sblockšgS‹
 {

10 
	mtimeout
;

15 
diù
 *
	mkeys
;

18 
robj
 *
	mrg‘
;

23 
	mnum»¶iÿs
;

24 
	m»¶off£t
;

25 } 
	tblockšgS‹
;

27 
blockCl›Á
(
ş›Á
 *
c
, 
bty³
);

28 
unblockCl›Á
(
ş›Á
 *
c
);

29 
g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, *
timeout
, 
un™
);

	@src/vr_block.h

1 #iâdeà
_VR_BLOCK_H_


2 
	#_VR_BLOCK_H_


	)

7 
	sblockšgS‹
 {

10 
	mtimeout
;

15 
diù
 *
	mkeys
;

18 
robj
 *
	mrg‘
;

23 
	mnum»¶iÿs
;

24 
	m»¶off£t
;

25 } 
	tblockšgS‹
;

27 
blockCl›Á
(
ş›Á
 *
c
, 
bty³
);

28 
unblockCl›Á
(
ş›Á
 *
c
);

29 
g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, *
timeout
, 
un™
);

	@src/vr_client.c

1 
	~<vr_cÜe.h
>

3 
	gncu¼_ccÚn
 = 0;

5 
£tPrÙocŞE¼Ü
(
ş›Á
 *
c
, 
pos
);

10 
size_t
 
	$sdsZm®locSize
(
sds
 
s
) {

11 *
sh
 = 
	`sdsAÎocPŒ
(
s
);

12  
	`dm®loc_size
(
sh
);

13 
	}
}

15 *
	$dupCl›ÁR•lyV®ue
(*
o
) {

16  
o
;

17 
	}
}

19 
	$ä“Cl›ÁR•lyV®ue
(*
o
) {

20 
	`ä“Objeù
(
o
);

21 
	}
}

23 
	$li¡M©chObjeùs
(*
a
, *
b
) {

24  
	`equ®SŒšgObjeùs
(
a
,
b
);

25 
	}
}

27 
ş›Á
 *
	$ü—‹Cl›Á
(
vr_ev’oİ
 *
v–
, 
cÚn
 *conn) {

29 
ş›Á
 *
c
 = 
	`d®loc
((client));

36 ià(
cÚn
->
sd
 != -1) {

38 
	`vr_£t_nÚblockšg
(
cÚn
->
sd
);

40 
	`vr_£t_tınod–ay
(
cÚn
->
sd
);

42 ià(
£rv”
.
tık“·live
)

43 
	`vr_£t_tık“·live
(
cÚn
->
sd
,
£rv”
.
tık“·live
,0,0);

45 ià(
	`«C»©eFeEv’t
(
v–
->
–
,
cÚn
->
sd
,
AE_READABLE
,

46 
»adQu”yFromCl›Á
, 
c
è=ğ
AE_ERR
)

48 
	`log_”rÜ
("Unrecoverableƒrror creating client ipfd fileƒvent.");

49 
	`dä“
(
c
);

50  
NULL
;

54 
	`£ËùDb
(
c
,0);

56 
c
->
id
 = 
v–
->
Ãxt_ş›Á_id
++;

58 
c
->
cÚn
 = conn;

60 
c
->
v–
 = vel;

62 
c
->
sÿnid
 = -1;

64 
c
->
Çme
 = 
NULL
;

66 
c
->
buåos
 = 0;

68 
c
->
qu”ybuf
 = 
	`sd£m±y
();

70 
c
->
qu”ybuf_³ak
 = 0;

72 
c
->
»qty³
 = 0;

74 
c
->
¬gc
 = 0;

76 
c
->
¬gv
 = 
NULL
;

78 
c
->
cmd
 = c->
Ï¡cmd
 = 
NULL
;

80 
c
->
muÉibulkËn
 = 0;

81 
c
->
bulkËn
 = -1;

82 
c
->
£ÁËn
 = 0;

83 
c
->
æags
 = 0;

84 
c
->
ùime
 = c->
Ï¡š‹¿ùiÚ
 = 
v–
->
unixtime
;

85 
c
->
auth’tiÿ‹d
 = 0;

86 
c
->
»¶¡©e
 = 
REPL_STATE_NONE
;

87 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

88 
c
->
»¶off
 = 0;

89 
c
->
»¶_ack_off
 = 0;

90 
c
->
»¶_ack_time
 = 0;

91 
c
->
¦ave_li¡’šg_pÜt
 = 0;

92 
c
->
¦ave_ÿ·
 = 
SLAVE_CAPA_NONE
;

93 
c
->
»¶y
 = 
	`dli¡C»©e
();

94 
c
->
»¶y_by‹s
 = 0;

95 
c
->
obuf_soá_lim™_»ached_time
 = 0;

97 
	`dli¡S‘F»eM‘hod
(
c
->
»¶y
,
ä“Cl›ÁR•lyV®ue
);

98 
	`dli¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

99 
c
->
bty³
 = 
BLOCKED_NONE
;

100 
c
->
bpİ
.
timeout
 = 0;

101 
c
->
bpİ
.
keys
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

102 
c
->
bpİ
.
rg‘
 = 
NULL
;

103 
c
->
bpİ
.
num»¶iÿs
 = 0;

104 
c
->
bpİ
.
»¶off£t
 = 0;

105 
c
->
woff
 = 0;

106 
c
->
w©ched_keys
 = 
	`dli¡C»©e
();

107 
c
->
pubsub_chªÃls
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

108 
c
->
pubsub_·‰”ns
 = 
	`dli¡C»©e
();

109 
c
->
³”id
 = 
NULL
;

110 
c
->
curidx
 = -1;

111 
c
->
ridx
 = -1;

112 
c
->
¡•s
 = 0;

113 
c
->
ÿche
 = 
NULL
;

114 
	`dli¡S‘F»eM‘hod
(
c
->
pubsub_·‰”ns
,
deüRefCouÁVoid
);

115 
	`dli¡S‘M©chM‘hod
(
c
->
pubsub_·‰”ns
,
li¡M©chObjeùs
);

116 ià(
cÚn
->
sd
 !ğ-1è
	`dli¡AddNodeTa
(
v–
->
ş›Ás
,
c
);

117 
	`š™Cl›ÁMuÉiS‹
(
c
);

118  
c
;

119 
	}
}

144 
	$´•¬eCl›ÁToWr™e
(
ş›Á
 *
c
) {

147 ià(
c
->
æags
 & 
CLIENT_LUA
è 
VR_OK
;

150 ià(
c
->
æags
 & (
CLIENT_REPLY_OFF
|
CLIENT_REPLY_SKIP
)è 
VR_ERROR
;

155 ià((
c
->
æags
 & 
CLIENT_MASTER
) &&

156 !(
c
->
æags
 & 
CLIENT_MASTER_FORCE_REPLY
)è 
VR_ERROR
;

158 ià(
c
->
cÚn
->
sd
 <ğ0è 
VR_ERROR
;

165 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

166 !(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) &&

167 (
c
->
»¶¡©e
 =ğ
REPL_STATE_NONE
 ||

168 (
c
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 && !c->
»¶_put_Úlše_Ú_ack
)))

176 
c
->
æags
 |ğ
CLIENT_PENDING_WRITE
;

177 
	`dli¡AddNodeH—d
(
c
->
v–
->
ş›Ás_³ndšg_wr™e
,c);

181  
VR_OK
;

182 
	}
}

187 
robj
 *
	$dupLa¡ObjeùIfN“ded
(
dli¡
 *
»¶y
) {

188 
robj
 *
Ãw
, *
cur
;

189 
dli¡Node
 *
Ê
;

190 
	`ASSERT
(
	`dli¡L’gth
(
»¶y
) > 0);

191 
Ê
 = 
	`dli¡La¡
(
»¶y
);

192 
cur
 = 
	`dli¡NodeV®ue
(
Ê
);

193 ià(
cur
->
cÚ¡ªt
) {

194 
Ãw
 = 
	`dupSŒšgObjeù
(
cur
);

195 
	`dli¡NodeV®ue
(
Ê
èğ
Ãw
;

197  
	`dli¡NodeV®ue
(
Ê
);

198 
	}
}

204 
	$_addR•lyToBufãr
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

205 
size_t
 
avaabË
 = (
c
->
buf
)-c->
buåos
;

207 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è 
VR_OK
;

211 ià(
	`dli¡L’gth
(
c
->
»¶y
è> 0è 
VR_ERROR
;

214 ià(
Ën
 > 
avaabË
è 
VR_ERROR
;

216 
	`memıy
(
c
->
buf
+c->
buåos
,
s
,
Ën
);

217 
c
->
buåos
+=
Ën
;

218  
VR_OK
;

219 
	}
}

222 
	$_addR•lyObjeùToLi¡
(
ş›Á
 *
c
, 
robj
 *
o
) {

223 
robj
 *

, *
obj
;

225 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

227 ià(
	`dli¡L’gth
(
c
->
»¶y
) == 0) {

228 ià(
o
->
cÚ¡ªt
)

229 
obj
 = 
o
;

231 
obj
 = 
	`dupSŒšgObjeù
(
o
);

232 
	`dli¡AddNodeTa
(
c
->
»¶y
,
obj
);

233 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
obj
);

235 

 = 
	`dli¡NodeV®ue
(
	`dli¡La¡
(
c
->
»¶y
));

238 ià(

->
±r
 !ğ
NULL
 &&

239 

->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

240 
	`sd¦’
(

->
±r
)+sd¦’(
o
->±rè<ğ
PROTO_REPLY_CHUNK_BYTES
)

242 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(

->
±r
);

243 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

244 

->
±r
 = 
	`sdsÿ’
Ña->±r,
o
->±r,
	`sd¦’
(o->ptr));

245 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(

->
±r
);

247 ià(
o
->
cÚ¡ªt
)

248 
obj
 = 
o
;

250 
obj
 = 
	`dupSŒšgObjeù
(
o
);

251 
	`dli¡AddNodeTa
(
c
->
»¶y
,
obj
);

252 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
obj
);

255 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

256 
	}
}

261 
	$_addR•lySdsToLi¡
(
ş›Á
 *
c
, 
sds
 
s
) {

262 
robj
 *

;

264 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

265 
	`sdsä“
(
s
);

269 ià(
	`dli¡L’gth
(
c
->
»¶y
) == 0) {

270 
	`dli¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
OBJ_STRING
,
s
));

271 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
s
);

273 

 = 
	`dli¡NodeV®ue
(
	`dli¡La¡
(
c
->
»¶y
));

276 ià(

->
±r
 !ğ
NULL
 &&a->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

277 
	`sd¦’
(

->
±r
)+sd¦’(
s
è<ğ
PROTO_REPLY_CHUNK_BYTES
)

279 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(

->
±r
);

280 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

281 

->
±r
 = 
	`sdsÿ’
Ña->±r,
s
,
	`sd¦’
(s));

282 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(

->
±r
);

283 
	`sdsä“
(
s
);

285 
	`dli¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
OBJ_STRING
,
s
));

286 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
s
);

289 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

290 
	}
}

293 
	$_addR•lySŒšgToLi¡
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

294 
robj
 *

;

296 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

298 ià(
	`dli¡L’gth
(
c
->
»¶y
) == 0) {

299 
robj
 *
o
 = 
	`ü—‹SŒšgObjeù
(
s
,
Ën
);

301 
	`dli¡AddNodeTa
(
c
->
»¶y
,
o
);

302 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

304 

 = 
	`dli¡NodeV®ue
(
	`dli¡La¡
(
c
->
»¶y
));

307 ià(

->
±r
 !ğ
NULL
 &&a->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

308 
	`sd¦’
(

->
±r
)+
Ën
 <ğ
PROTO_REPLY_CHUNK_BYTES
)

310 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(

->
±r
);

311 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

312 

->
±r
 = 
	`sdsÿ’
Ña->±r,
s
,
Ën
);

313 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(

->
±r
);

315 
robj
 *
o
 = 
	`ü—‹SŒšgObjeù
(
s
,
Ën
);

317 
	`dli¡AddNodeTa
(
c
->
»¶y
,
o
);

318 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

321 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

322 
	}
}

329 
	$addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
) {

331 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
) ;

341 ià(
	`sdsEncodedObjeù
(
obj
)) {

342 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
VR_OK
)

343 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

344 } ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

346 
robj
 *
obj_Ãw
;

350 ià(
	`dli¡L’gth
(
c
->
»¶y
è=ğ0 && ((c->
buf
è- c->
buåos
) >= 32) {

351 
buf
[32];

352 
Ën
;

354 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
obj
->
±r
);

356 ià(
	`_addR•lyToBufãr
(
c
,
buf
,
Ën
è=ğ
VR_OK
)

362 
obj_Ãw
 = 
	`g‘DecodedObjeù
(
obj
);

363 ià(
	`_addR•lyToBufãr
(
c
,
obj_Ãw
->
±r
,
	`sd¦’
(obj_Ãw->±r)è!ğ
VR_OK
)

364 
	`_addR•lyObjeùToLi¡
(
c
,
obj_Ãw
);

365 ià(
obj_Ãw
 !ğ
obj
è
	`ä“Objeù
(obj_new);

367 
	`£rv”Pªic
("Wrong obj->encoding in‡ddReply()");

369 
	}
}

372 
	$addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
) {

373 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
) {

375 
	`sdsä“
(
s
);

378 ià(
	`_addR•lyToBufãr
(
c
,
s
,
	`sd¦’
(s)è=ğ
VR_OK
) {

379 
	`sdsä“
(
s
);

382 
	`_addR•lySdsToLi¡
(
c
,
s
);

384 
	}
}

386 
	$addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

387 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
) ;

388 ià(
	`_addR•lyToBufãr
(
c
,
s
,
Ën
è!ğ
VR_OK
)

389 
	`_addR•lySŒšgToLi¡
(
c
,
s
,
Ën
);

390 
	}
}

393 
	$addR•lyE¼ÜL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

394 
	`addR•lySŒšg
(
c
,"-ERR ",5);

395 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

396 
	`addR•lySŒšg
(
c
,"\r\n",2);

397 
	}
}

399 
	$addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
) {

400 
	`addR•lyE¼ÜL’gth
(
c
,
”r
,
	`¡¾’
(err));

401 
	}
}

404 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

405 
size_t
 
l
, 
j
;

406 
va_li¡
 
­
;

407 
	`va_¡¬t
(
­
,
fmt
);

408 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

409 
	`va_’d
(
­
);

412 
l
 = 
	`sd¦’
(
s
);

413 
j
 = 0; j < 
l
; j++) {

414 ià(
s
[
j
] == '\r' || s[j] == '\n') s[j] = ' ';

416 
	`addR•lyE¼ÜL’gth
(
c
,
s
,
	`sd¦’
(s));

417 
	`sdsä“
(
s
);

418 
	}
}

420 
	$addR•lyStusL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

421 
	`addR•lySŒšg
(
c
,"+",1);

422 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

423 
	`addR•lySŒšg
(
c
,"\r\n",2);

424 
	}
}

426 
	$addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
) {

427 
	`addR•lyStusL’gth
(
c
,
¡©us
,
	`¡¾’
(status));

428 
	}
}

431 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

432 
va_li¡
 
­
;

433 
	`va_¡¬t
(
­
,
fmt
);

434 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

435 
	`va_’d
(
­
);

436 
	`addR•lyStusL’gth
(
c
,
s
,
	`sd¦’
(s));

437 
	`sdsä“
(
s
);

438 
	}
}

442 *
	$addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
) {

446 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
è 
NULL
;

447 
	`dli¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
OBJ_STRING
,
NULL
));

448  
	`dli¡La¡
(
c
->
»¶y
);

449 
	}
}

452 
	$£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
) {

453 
dli¡Node
 *
Ê
 = (dli¡Node*)
node
;

454 
robj
 *
Ën
, *
Ãxt
;

457 ià(
node
 =ğ
NULL
) ;

459 
Ën
 = 
	`dli¡NodeV®ue
(
Ê
);

460 
Ën
->
±r
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"*%ld\r\n",
Ëngth
);

461 
Ën
->
’codšg
 = 
OBJ_ENCODING_RAW
;

462 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
Ën
->
±r
);

463 ià(
Ê
->
Ãxt
 !ğ
NULL
) {

464 
Ãxt
 = 
	`dli¡NodeV®ue
(
Ê
->next);

467 ià(
Ãxt
->
±r
 !ğ
NULL
) {

468 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(
Ën
->
±r
);

469 
c
->
»¶y_by‹s
 -ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
Ãxt
);

470 
Ën
->
±r
 = 
	`sdsÿ’
Ö’->±r,
Ãxt
->±r,
	`sd¦’
(next->ptr));

471 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
Ën
->
±r
);

472 
	`dli¡D–Node
(
c
->
»¶y
,
Ê
->
Ãxt
);

475 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

476 
	}
}

480 
	$addR•lyDoubË
(
ş›Á
 *
c
, 
d
) {

481 
dbuf
[128], 
sbuf
[128];

482 
dËn
, 
¦’
;

483 ià(
	`isšf
(
d
)) {

486 
	`addR•lyBulkCSŒšg
(
c
, 
d
 > 0 ? "inf" : "-inf");

488 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

489 
¦’
 = 
	`¢´štf
(
sbuf
,(sbuf),"$%d\r\n%s\r\n",
dËn
,
dbuf
);

490 
	`addR•lySŒšg
(
c
,
sbuf
,
¦’
);

492 
	}
}

498 
	$addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
) {

499 
robj
 *
o
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
d
,1);

500 
	`addR•lyBulk
(
c
,
o
);

501 
	`deüRefCouÁ
(
o
);

502 
	}
}

507 
	$addR•lyLÚgLÚgW™hP»fix
(
ş›Á
 *
c
, 
Î
, 
´efix
) {

508 
buf
[128];

509 
Ën
;

514 ià(
´efix
 =ğ'*' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

515 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Î
]);

517 } ià(
´efix
 =ğ'$' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

518 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Î
]);

522 
buf
[0] = 
´efix
;

523 
Ën
 = 
	`Î2¡ršg
(
buf
+1,(buf)-1,
Î
);

524 
buf
[
Ën
+1] = '\r';

525 
buf
[
Ën
+2] = '\n';

526 
	`addR•lySŒšg
(
c
,
buf
,
Ën
+3);

527 
	}
}

529 
	$addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

530 ià(
Î
 == 0)

531 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

532 ià(
Î
 == 1)

533 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

535 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Î
,':');

536 
	}
}

538 
	$addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
) {

539 ià(
Ëngth
 < 
OBJ_SHARED_BULKHDR_LEN
)

540 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Ëngth
]);

542 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ëngth
,'*');

543 
	}
}

546 
	$addR•lyBulkL’
(
ş›Á
 *
c
, 
robj
 *
obj
) {

547 
size_t
 
Ën
;

549 ià(
	`sdsEncodedObjeù
(
obj
)) {

550 
Ën
 = 
	`sd¦’
(
obj
->
±r
);

552 
n
 = ()
obj
->
±r
;

555 
Ën
 = 1;

556 ià(
n
 < 0) {

557 
Ën
++;

558 
n
 = -n;

560 (
n
 =‚/10) != 0) {

561 
Ën
++;

565 ià(
Ën
 < 
OBJ_SHARED_BULKHDR_LEN
)

566 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Ën
]);

568 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

569 
	}
}

572 
	$addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
) {

573 
	`addR•lyBulkL’
(
c
,
obj
);

574 
	`addR•ly
(
c
,
obj
);

575 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

576 
	}
}

579 
	$addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
) {

580 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

581 
	`addR•lySŒšg
(
c
,
p
,
Ën
);

582 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

583 
	}
}

586 
	$addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
) {

587 
	`addR•lySds
(
c
,
	`sdsÿtfmt
(
	`sd£m±y
(),"$%u\r\n",

588 ()
	`sd¦’
(
s
)));

589 
	`addR•lySds
(
c
,
s
);

590 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

591 
	}
}

594 
	$addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
) {

595 ià(
s
 =ğ
NULL
) {

596 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

598 
	`addR•lyBulkCBufãr
(
c
,
s
,
	`¡¾’
(s));

600 
	}
}

603 
	$addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

604 
buf
[64];

605 
Ën
;

607 
Ën
 = 
	`Î2¡ršg
(
buf
,64,
Î
);

608 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

609 
	}
}

615 
	$cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
) {

616 
	`dli¡R–—£
(
d¡
->
»¶y
);

617 
d¡
->
»¶y
 = 
	`dli¡Dup
(
¤c
->reply);

618 
	`memıy
(
d¡
->
buf
,
¤c
->buf,¤c->
buåos
);

619 
d¡
->
buåos
 = 
¤c
->bufpos;

620 
d¡
->
»¶y_by‹s
 = 
¤c
->reply_bytes;

621 
	}
}

626 
	$ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
) {

627  
c
->
buåos
 || 
	`dli¡L’gth
(c->
»¶y
);

628 
	}
}

630 
	$ä“Cl›ÁArgv
(
ş›Á
 *
c
) {

631 
j
;

632 
j
 = 0; j < 
c
->
¬gc
; j++)

633 
	`ä“Objeù
(
c
->
¬gv
[
j
]);

634 
c
->
¬gc
 = 0;

635 
c
->
cmd
 = 
NULL
;

636 
	}
}

642 
	$discÚÃùSÏves
() {

643 
	`dli¡L’gth
(
»¶
.
¦aves
)) {

644 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
»¶
.
¦aves
);

645 
	`ä“Cl›Á
((
ş›Á
*)
Ê
->
v®ue
);

647 
	}
}

653 
	$uÆškCl›ÁFromEv’oİ
(
ş›Á
 *
c
) {

654 
dli¡Node
 *
Ê
;

655 
vr_ev’oİ
 *
v–
 = 
c
->vel;

657 
c
->
v–
 = 
NULL
;

659 ià(
c
->
¡•s
 >= 1) ;

662 ià(
v–
->
cu¼’t_ş›Á
 =ğ
c
èv–->cu¼’t_ş›Á = 
NULL
;

667 ià(
c
->
cÚn
->
sd
 != -1) {

669 
Ê
 = 
	`dli¡S—rchKey
(
v–
->
ş›Ás
,
c
);

670 
	`ASSERT
(
Ê
 !ğ
NULL
);

671 
	`dli¡D–Node
(
v–
->
ş›Ás
,
Ê
);

674 
	`«D–‘eFeEv’t
(
v–
->
–
,
c
->
cÚn
->
sd
,
AE_READABLE
);

675 
	`«D–‘eFeEv’t
(
v–
->
–
,
c
->
cÚn
->
sd
,
AE_WRITABLE
);

679 ià(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) {

680 
Ê
 = 
	`dli¡S—rchKey
(
v–
->
ş›Ás_³ndšg_wr™e
,
c
);

681 
	`ASSERT
(
Ê
 !ğ
NULL
);

682 
	`dli¡D–Node
(
v–
->
ş›Ás_³ndšg_wr™e
,
Ê
);

683 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

688 ià(
c
->
æags
 & 
CLIENT_UNBLOCKED
) {

689 
Ê
 = 
	`dli¡S—rchKey
(
v–
->
unblocked_ş›Ás
,
c
);

690 
	`ASSERT
(
Ê
 !ğ
NULL
);

691 
	`dli¡D–Node
(
v–
->
unblocked_ş›Ás
,
Ê
);

692 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

694 
	}
}

696 
	$lškCl›ÁToEv’oİ
(
ş›Á
 *
c
,
vr_ev’oİ
 *
v–
) {

697 
	`dli¡Push
(
v–
->
ş›Ás
,
c
);

698 
c
->
v–
 = vel;

699 ià(
	`«C»©eFeEv’t
(
v–
->
–
,
c
->
cÚn
->
sd
,
AE_READABLE
,

700 
»adQu”yFromCl›Á
,
c
è=ğ
AE_ERR
)

702 
	`ä“Cl›Á
(
c
);

707 
	`´oûssIÅutBufãr
(
c
);

708 ià(
c
->
æags
&
CLIENT_JUMP
) {

709 
	`di¥©ch_cÚn_exi¡
(
c
,c->
ridx
);

711 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

712 !(
c
->
æags
&
CLIENT_PENDING_WRITE
)) {

713 ià(
	`«C»©eFeEv’t
(
v–
->
–
, 
c
->
cÚn
->
sd
, 
AE_WRITABLE
,

714 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

716 
	`ä“Cl›ÁAsync
(
c
);

720 
	}
}

725 
	$uÆškCl›Á
(
ş›Á
 *
c
) {

726 
dli¡Node
 *
Ê
;

729 ià(
c
->
v–
->
cu¼’t_ş›Á
 =ğcèc->v–->cu¼’t_ş›Á = 
NULL
;

734 ià(
c
->
cÚn
->
sd
 != -1) {

736 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás
,c);

737 
	`ASSERT
(
Ê
 !ğ
NULL
);

738 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás
,
Ê
);

741 
	`«D–‘eFeEv’t
(
c
->
v–
->
–
,c->
cÚn
->
sd
,
AE_READABLE
);

742 
	`«D–‘eFeEv’t
(
c
->
v–
->
–
,c->
cÚn
->
sd
,
AE_WRITABLE
);

743 
	`cÚn_put
(
c
->
cÚn
);

744 
c
->
cÚn
 = 
NULL
;

748 ià(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) {

749 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás_³ndšg_wr™e
,c);

750 
	`ASSERT
(
Ê
 !ğ
NULL
);

751 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás_³ndšg_wr™e
,
Ê
);

752 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

757 ià(
c
->
æags
 & 
CLIENT_UNBLOCKED
) {

758 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
unblocked_ş›Ás
,c);

759 
	`ASSERT
(
Ê
 !ğ
NULL
);

760 
	`dli¡D–Node
(
c
->
v–
->
unblocked_ş›Ás
,
Ê
);

761 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

763 
	}
}

765 
	$ä“Cl›Á
(
ş›Á
 *
c
) {

766 
dli¡Node
 *
Ê
;

773 ià(
»¶
.
rŞe
 =ğ
REPLICATION_ROLE_MASTER
 && 
c
->
æags
 & 
CLIENT_MASTER
) {

774 
	`log_w¬n
("connection with master†ost.");

775 ià(!(
c
->
æags
 & (
CLIENT_CLOSE_AFTER_REPLY
|

776 
CLIENT_CLOSE_ASAP
|

777 
CLIENT_BLOCKED
|

778 
CLIENT_UNBLOCKED
)))

780 
	`»¶iÿtiÚCacheMa¡”
(
c
);

786 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
)) {

787 
	`log_w¬n
("connection with slave %s†ost.",

788 
	`»¶iÿtiÚG‘SÏveName
(
c
));

792 
	`sdsä“
(
c
->
qu”ybuf
);

793 
c
->
qu”ybuf
 = 
NULL
;

796 ià(
c
->
æags
 & 
CLIENT_BLOCKED
è
	`unblockCl›Á
(c);

797 
	`diùR–—£
(
c
->
bpİ
.
keys
);

800 
	`unw©chAÎKeys
(
c
);

801 
	`dli¡R–—£
(
c
->
w©ched_keys
);

804 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,0);

805 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,0);

806 
	`diùR–—£
(
c
->
pubsub_chªÃls
);

807 
	`dli¡R–—£
(
c
->
pubsub_·‰”ns
);

810 
	`dli¡R–—£
(
c
->
»¶y
);

811 
	`ä“Cl›ÁArgv
(
c
);

816 
	`uÆškCl›Á
(
c
);

820 ià(
c
->
æags
 & 
CLIENT_SLAVE
) {

821 ià(
c
->
»¶¡©e
 =ğ
SLAVE_STATE_SEND_BULK
) {

822 ià(
c
->
»¶dbfd
 !ğ-1è
	`şo£
(c->repldbfd);

823 ià(
c
->
»¶´—mbË
è
	`sdsä“
(c->replpreamble);

825 
dli¡
 *
l
 = (
c
->
æags
 & 
CLIENT_MONITOR
è? 
£rv”
.
mÚ™Üs
 : 
»¶
.
¦aves
;

826 
Ê
 = 
	`dli¡S—rchKey
(
l
,
c
);

827 
	`ASSERT
(
Ê
 !ğ
NULL
);

828 
	`dli¡D–Node
(
l
,
Ê
);

832 ià(
c
->
æags
 & 
CLIENT_SLAVE
 && 
	`dli¡L’gth
(
»¶
.
¦aves
) == 0)

833 
»¶
.
»¶_no_¦aves_sšû
 = 
c
->
v–
->
unixtime
;

834 
	`»äeshGoodSÏvesCouÁ
();

839 ià(
c
->
æags
 & 
CLIENT_MASTER
è
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

843 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
) {

844 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás_to_şo£
,c);

845 
	`ASSERT
(
Ê
 !ğ
NULL
);

846 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás_to_şo£
,
Ê
);

851 ià(
c
->
Çme
è
	`ä“Objeù
(c->name);

852 ià(
c
->
¬gv
è
	`dä“
(c->argv);

853 
	`ä“Cl›ÁMuÉiS‹
(
c
);

854 
	`sdsä“
(
c
->
³”id
);

855 
	`dä“
(
c
);

856 
	}
}

863 
	$ä“Cl›ÁAsync
(
ş›Á
 *
c
) {

864 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
 || c->æag & 
CLIENT_LUA
) ;

865 
c
->
æags
 |ğ
CLIENT_CLOSE_ASAP
;

866 
	`dli¡AddNodeTa
(
c
->
v–
->
ş›Ás_to_şo£
,c);

867 
	}
}

869 
	$ä“Cl›ÁsInAsyncF»eQueue
(
vr_ev’oİ
 *
v–
) {

870 
	`dli¡L’gth
(
v–
->
ş›Ás_to_şo£
)) {

871 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
v–
->
ş›Ás_to_şo£
);

872 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

874 
c
->
æags
 &ğ~
CLIENT_CLOSE_ASAP
;

875 
	`ä“Cl›Á
(
c
);

876 
	`dli¡D–Node
(
v–
->
ş›Ás_to_şo£
,
Ê
);

878 
	}
}

883 
	$wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
) {

884 
ssize_t
 
nwr™‹n
 = 0, 
tÙwr™‹n
 = 0;

885 
size_t
 
objËn
;

886 
size_t
 
objmem
;

887 
robj
 *
o
;

888 
maxmemÜy
;

890 
maxmemÜy
 = 
c
->
v–
->
cc
.maxmemory;

891 
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

893 ià(
c
->
buåos
 > 0) {

894 
nwr™‹n
 = 
	`vr_wr™e
(
fd
,
c
->
buf
+c->
£ÁËn
,c->
buåos
-c->sentlen);

895 ià(
nwr™‹n
 <= 0) ;

896 
c
->
£ÁËn
 +ğ
nwr™‹n
;

897 
tÙwr™‹n
 +ğ
nwr™‹n
;

902 ià(()
c
->
£ÁËn
 =ğc->
buåos
) {

903 
c
->
buåos
 = 0;

904 
c
->
£ÁËn
 = 0;

907 
o
 = 
	`dli¡NodeV®ue
(
	`dli¡Fœ¡
(
c
->
»¶y
));

908 
objËn
 = 
	`sd¦’
(
o
->
±r
);

909 
objmem
 = 
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

911 ià(
objËn
 == 0) {

912 
	`dli¡D–Node
(
c
->
»¶y
,
	`dli¡Fœ¡
(c->reply));

913 
c
->
»¶y_by‹s
 -ğ
objmem
;

917 
nwr™‹n
 = 
	`vr_wr™e
(
fd
, ((*)
o
->
±r
)+
c
->
£ÁËn
,
objËn
-c->sentlen);

918 ià(
nwr™‹n
 <= 0) ;

919 
c
->
£ÁËn
 +ğ
nwr™‹n
;

920 
tÙwr™‹n
 +ğ
nwr™‹n
;

924 ià(
c
->
£ÁËn
 =ğ
objËn
) {

925 
	`dli¡D–Node
(
c
->
»¶y
,
	`dli¡Fœ¡
(c->reply));

926 
c
->
£ÁËn
 = 0;

927 
c
->
»¶y_by‹s
 -ğ
objmem
;

938 ià(
tÙwr™‹n
 > 
NET_MAX_WRITES_PER_EVENT
 &&

939 (
maxmemÜy
 =ğ0 || 
	`d®loc_u£d_memÜy
() < maxmemory))

942 ià(
nwr™‹n
 == -1) {

943 ià(
”ºo
 =ğ
EAGAIN
) {

944 
nwr™‹n
 = 0;

946 
	`log_debug
(
LOG_VERB
,

947 "”rÜ wr™šgØş›Á: %s", 
	`¡»¼Ü
(
”ºo
));

948 
	`ä“Cl›Á
(
c
);

949  
VR_ERROR
;

952 ià(
tÙwr™‹n
 > 0) {

953 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
Ãt_ouut_by‹s
, ()
tÙwr™‹n
);

958 ià(!(
c
->
æags
 & 
CLIENT_MASTER
)èc->
Ï¡š‹¿ùiÚ
 = c->
v–
->
unixtime
;

960 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

961 
c
->
£ÁËn
 = 0;

962 ià(
hªdËr_š¡®Ëd
è
	`«D–‘eFeEv’t
(
c
->
v–
->
–
,c->
cÚn
->
sd
,
AE_WRITABLE
);

965 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

966 
	`ä“Cl›Á
(
c
);

967  
VR_ERROR
;

970  
VR_OK
;

971 
	}
}

974 
	$£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

975 
	`UNUSED
(
–
);

976 
	`UNUSED
(
mask
);

977 
	`wr™eToCl›Á
(
fd
,
´ivd©a
,1);

978 
	}
}

984 
	$hªdËCl›ÁsW™hP’dšgWr™es
(
vr_ev’oİ
 *
v–
) {

985 
dli¡I‹r
 
li
;

986 
dli¡Node
 *
Ê
;

987 
´oûs£d
 = 
	`dli¡L’gth
(
v–
->
ş›Ás_³ndšg_wr™e
);

989 
	`dli¡Rewšd
(
v–
->
ş›Ás_³ndšg_wr™e
,&
li
);

990 (
Ê
 = 
	`dli¡Next
(&
li
))) {

991 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

992 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

993 
	`dli¡D–Node
(
v–
->
ş›Ás_³ndšg_wr™e
,
Ê
);

996 ià(
	`wr™eToCl›Á
(
c
->
cÚn
->
sd
,c,0è=ğ
VR_ERROR
) ;

1000 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

1001 
	`«C»©eFeEv’t
(
v–
->
–
, 
c
->
cÚn
->
sd
, 
AE_WRITABLE
,

1002 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

1004 
	`ä“Cl›ÁAsync
(
c
);

1007  
´oûs£d
;

1008 
	}
}

1012 
	$»£tCl›Á
(
ş›Á
 *
c
) {

1013 
»disCommªdProc
 *
´evcmd
 = 
c
->
cmd
 ? c->cmd->
´oc
 : 
NULL
;

1015 ià(
c
->
æags
&
CLIENT_JUMP
)

1018 
	`ä“Cl›ÁArgv
(
c
);

1019 
c
->
»qty³
 = 0;

1020 
c
->
muÉibulkËn
 = 0;

1021 
c
->
bulkËn
 = -1;

1026 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP
;

1027 ià(
c
->
æags
 & 
CLIENT_REPLY_SKIP_NEXT
) {

1028 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP
;

1029 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP_NEXT
;

1031 
	}
}

1034 
	$´oûssIÆšeBufãr
(
ş›Á
 *
c
) {

1035 *
Ãwlše
;

1036 
¬gc
, 
j
;

1037 
sds
 *
¬gv
, 
aux
;

1038 
size_t
 
qu”yËn
;

1042 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\n');

1046 ià(
Ãwlše
 =ğ
NULL
) {

1047 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1048 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big inline„equest");

1049 
	`£tPrÙocŞE¼Ü
(
c
,0);

1051  
VR_ERROR
;

1056 ià(
Ãwlše
 &&‚ewlš!ğ
c
->
qu”ybuf
 && *(newline-1) == '\r')

1057 
Ãwlše
--;

1061 
qu”yËn
 = 
Ãwlše
-(
c
->
qu”ybuf
);

1063 
aux
 = 
	`sd¢ewËn
(
c
->
qu”ybuf
,
qu”yËn
);

1065 
¬gv
 = 
	`sds¥l™¬gs
(
aux
,&
¬gc
);

1066 
	`sdsä“
(
aux
);

1067 ià(
¬gv
 =ğ
NULL
) {

1068 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: unbalanced quotes in„equest");

1069 
	`£tPrÙocŞE¼Ü
(
c
,0);

1070  
VR_ERROR
;

1077 ià(
qu”yËn
 =ğ0 && 
c
->
æags
 & 
CLIENT_SLAVE
)

1078 
c
->
»¶_ack_time
 = c->
v–
->
unixtime
;

1081 
	`sd¤ªge
(
c
->
qu”ybuf
,
qu”yËn
+2,-1);

1084 ià(
¬gc
) {

1085 ià(
c
->
¬gv
è
	`dä“
(c->argv);

1086 
c
->
¬gv
 = 
	`d®loc
((
robj
*)*
¬gc
);

1091 
c
->
¬gc
 = 0, 
j
 = 0; j <‡rgc; j++) {

1092 ià(
	`sd¦’
(
¬gv
[
j
])) {

1093 
c
->
¬gv
[c->
¬gc
] = 
	`ü—‹Objeù
(
OBJ_STRING
,¬gv[
j
]);

1094 
c
->
¬gc
++;

1096 
	`sdsä“
(
¬gv
[
j
]);

1099 
	`dä“
(
¬gv
);

1100  
VR_OK
;

1101 
	}
}

1106 
	$£tPrÙocŞE¼Ü
(
ş›Á
 *
c
, 
pos
) {

1107 ià(
	`log_loggabË
(
LOG_VERB
)) {

1108 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1109 
	`log_debug
(
LOG_VERB
,

1110 "PrÙocŞƒ¼Ü from cl›Á: %s", 
ş›Á
);

1111 
	`sdsä“
(
ş›Á
);

1113 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1114 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1115 
	}
}

1117 
	$´oûssMuÉibulkBufãr
(
ş›Á
 *
c
) {

1118 *
Ãwlše
 = 
NULL
;

1119 
pos
 = 0, 
ok
;

1120 
Î
;

1122 ià(
c
->
muÉibulkËn
 == 0) {

1124 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
¬gc
 == 0);

1127 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\r');

1128 ià(
Ãwlše
 =ğ
NULL
) {

1129 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1130 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big mbulk count string");

1131 
	`£tPrÙocŞE¼Ü
(
c
,0);

1133  
VR_ERROR
;

1138 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1139  
VR_ERROR
;

1144 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
qu”ybuf
[0] == '*');

1146 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+1,
Ãwlše
-(c->qu”ybuf+1),&
Î
);

1147 ià(!
ok
 || 
Î
 > 1024*1024) {

1148 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid multibulk†ength");

1149 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1150  
VR_ERROR
;

1154 
pos
 = (
Ãwlše
-
c
->
qu”ybuf
)+2;

1155 ià(
Î
 <= 0) {

1156 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1157  
VR_OK
;

1160 
c
->
muÉibulkËn
 = 
Î
;

1163 ià(
c
->
¬gv
è
	`dä“
(c->argv);

1164 
c
->
¬gv
 = 
	`d®loc
((
robj
*)*c->
muÉibulkËn
);

1167 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
muÉibulkËn
 > 0);

1169 
c
->
muÉibulkËn
) {

1171 ià(
c
->
bulkËn
 == -1) {

1173 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
+
pos
,'\r');

1174 ià(
Ãwlše
 =ğ
NULL
) {

1175 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1176 
	`addR•lyE¼Ü
(
c
,

1178 
	`£tPrÙocŞE¼Ü
(
c
,0);

1179  
VR_ERROR
;

1185 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1188 ià(
c
->
qu”ybuf
[
pos
] != '$') {

1189 
	`addR•lyE¼ÜFÜm©
(
c
,

1191 
c
->
qu”ybuf
[
pos
]);

1192 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1193  
VR_ERROR
;

1196 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+
pos
+1,
Ãwlše
-(c->qu”ybuf+pos+1),&
Î
);

1197 ià(!
ok
 || 
Î
 < 0 ||†l > 512*1024*1024) {

1198 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid bulk†ength");

1199 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1200  
VR_ERROR
;

1203 
pos
 +ğ
Ãwlše
-(
c
->
qu”ybuf
+pos)+2;

1204 ià(
Î
 >ğ
PROTO_MBULK_BIG_ARG
) {

1205 
size_t
 
qbËn
;

1212 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1213 
pos
 = 0;

1214 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1218 ià(
qbËn
 < (
size_t
)
Î
+2)

1219 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf,
Î
+2-
qbËn
);

1221 
c
->
bulkËn
 = 
Î
;

1225 ià(
	`sd¦’
(
c
->
qu”ybuf
)-
pos
 < ()(c->
bulkËn
+2)) {

1232 ià(
pos
 == 0 &&

1233 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
 &&

1234 (sigÃdè
	`sd¦’
(
c
->
qu”ybuf
è=ğc->
bulkËn
+2)

1237 
c
->
¬gv
[c->
¬gc
++] = 
	`ü—‹Objeù
(
OBJ_STRING
,c->
qu”ybuf
);

1238 
	`sdsInüL’
(
c
->
qu”ybuf
,-2);

1241 
c
->
qu”ybuf
 = 
	`sd¢ewËn
(
NULL
,c->
bulkËn
+2);

1242 
	`sdsş—r
(
c
->
qu”ybuf
);

1243 
pos
 = 0;

1245 
c
->
¬gv
[c->
¬gc
++] =

1246 
	`ü—‹SŒšgObjeù
(
c
->
qu”ybuf
+
pos
,c->
bulkËn
);

1247 
pos
 +ğ
c
->
bulkËn
+2;

1249 
c
->
bulkËn
 = -1;

1250 
c
->
muÉibulkËn
--;

1255 ià(
pos
è
	`sd¤ªge
(
c
->
qu”ybuf
,pos,-1);

1258 ià(
c
->
muÉibulkËn
 =ğ0è 
VR_OK
;

1261  
VR_ERROR
;

1262 
	}
}

1264 
	$´oûssIÅutBufãr
(
ş›Á
 *
c
) {

1265 
c
->
v–
->
cu¼’t_ş›Á
 = c;

1267 
	`sd¦’
(
c
->
qu”ybuf
)) {

1269 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
è&& 
	`ş›ÁsA»Pau£d
(c->
v–
)) ;

1272 ià(
c
->
æags
 & 
CLIENT_BLOCKED
) ;

1277 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

1280 ià(!
c
->
»qty³
) {

1281 ià(
c
->
qu”ybuf
[0] == '*') {

1283 
c
->
»qty³
 = 
PROTO_REQ_MULTIBULK
;

1285 
c
->
»qty³
 = 
PROTO_REQ_INLINE
;

1289 ià(
c
->
»qty³
 =ğ
PROTO_REQ_INLINE
) {

1290 ià(
	`´oûssIÆšeBufãr
(
c
è!ğ
VR_OK
) ;

1291 } ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
) {

1293 ià(
	`´oûssMuÉibulkBufãr
(
c
è!ğ
VR_OK
) ;

1295 
	`£rv”Pªic
("Unknown„equestype");

1300 ià(
c
->
¬gc
 == 0) {

1301 
	`»£tCl›Á
(
c
);

1305 ià(
	`´oûssCommªd
(
c
è=ğ
VR_OK
)

1306 
	`»£tCl›Á
(
c
);

1309 ià(
c
->
v–
->
cu¼’t_ş›Á
 =ğ
NULL
) ;

1314 ià(
c
->
æags
&
CLIENT_JUMP
) ;

1317 
c
->
v–
->
cu¼’t_ş›Á
 = 
NULL
;

1318 
	}
}

1321 
	$»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1322 
ş›Á
 *
c
 = (ş›Á*è
´ivd©a
;

1323 
Ä—d
, 
»adËn
;

1324 
size_t
 
qbËn
;

1325 
	`UNUSED
(
–
);

1326 
	`UNUSED
(
mask
);

1328 
»adËn
 = 
PROTO_IOBUF_LEN
;

1335 ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
 && c->
muÉibulkËn
 && c->
bulkËn
 != -1

1336 && 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
)

1338 
»maššg
 = ()(
c
->
bulkËn
+2)-
	`sd¦’
(c->
qu”ybuf
);

1340 ià(
»maššg
 < 
»adËn
)„eadlen =„emaining;

1343 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1344 ià(
c
->
qu”ybuf_³ak
 < 
qbËn
) c->querybuf_peak = qblen;

1345 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf, 
»adËn
);

1347 
Ä—d
 = 
	`vr_»ad
(
fd
, 
c
->
qu”ybuf
+
qbËn
, 
»adËn
);

1348 ià(
Ä—d
 == -1) {

1349 ià(
”ºo
 =ğ
EAGAIN
) {

1352 
	`log_debug
(
LOG_VERB
, "»adšg from cl›Á: %s",
	`¡»¼Ü
(
”ºo
));

1353 
	`ä“Cl›Á
(
c
);

1356 } ià(
Ä—d
 == 0) {

1357 
	`log_debug
(
LOG_VERB
, "client closed connection");

1358 
	`ä“Cl›Á
(
c
);

1362 
	`sdsInüL’
(
c
->
qu”ybuf
,
Ä—d
);

1363 
c
->
Ï¡š‹¿ùiÚ
 = c->
v–
->
unixtime
;

1364 ià(
c
->
æags
 & 
CLIENT_MASTER
èc->
»¶off
 +ğ
Ä—d
;

1365 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
Ãt_šput_by‹s
, 
Ä—d
);

1366 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
£rv”
.
ş›Á_max_qu”ybuf_Ën
) {

1367 
sds
 
ci
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
), 
by‹s
 = sdsempty();

1369 
by‹s
 = 
	`sdsÿŒ•r
(by‹s,
c
->
qu”ybuf
,64);

1370 
	`log_w¬n
("şosšg cl›Áh©„—ched max qu”y bufã¸Ëngth: % (qbuàš™ŸÈby‹s: %s)", 
ci
, 
by‹s
);

1371 
	`sdsä“
(
ci
);

1372 
	`sdsä“
(
by‹s
);

1373 
	`ä“Cl›Á
(
c
);

1377 
	`´oûssIÅutBufãr
(
c
);

1380 ià(
c
->
æags
&
CLIENT_JUMP
) {

1381 
	`di¥©ch_cÚn_exi¡
(
c
,c->
ridx
);

1383 
	}
}

1386 
	$g‘Cl›ÁsMaxBufãrs
(
vr_ev’oİ
 *
v–
, *
lÚge¡_ouut_li¡
,

1387 *
bigge¡_šput_bufãr
) {

1388 
ş›Á
 *
c
;

1389 
dli¡Node
 *
Ê
;

1390 
dli¡I‹r
 
li
;

1391 
lŞ
 = 0, 
bib
 = 0;

1394 
	`dli¡Rewšd
(
v–
->
ş›Ás
,&
li
);

1395 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1396 
c
 = 
	`dli¡NodeV®ue
(
Ê
);

1398 ià(
	`dli¡L’gth
(
c
->
»¶y
è> 
lŞ
)†ol = dlistLength(c->reply);

1399 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
bib
) bib = sdslen(c->querybuf);

1401 *
lÚge¡_ouut_li¡
 = 
lŞ
;

1402 *
bigge¡_šput_bufãr
 = 
bib
;

1403 
	}
}

1417 
	$g’Cl›ÁP“rId
(
ş›Á
 *ş›Á, *
³”id
,

1418 
size_t
 
³”id_Ën
) {

1419 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

1421 
	`¢´štf
(
³”id
,
³”id_Ën
,"%s:0",
£rv”
.
unixsock‘
);

1424 
	`vr_Ãt_fÜm©_³”
(
ş›Á
->
cÚn
->
sd
,
³”id
,
³”id_Ën
);

1426 
	}
}

1434 *
	$g‘Cl›ÁP“rId
(
ş›Á
 *
c
) {

1435 
³”id
[
VR_INET_PEER_ID_LEN
];

1437 ià(
c
->
³”id
 =ğ
NULL
) {

1438 
	`g’Cl›ÁP“rId
(
c
,
³”id
,(peerid));

1439 
c
->
³”id
 = 
	`sd¢ew
(peerid);

1441  
c
->
³”id
;

1442 
	}
}

1447 
sds
 
	$ÿtCl›ÁInfoSŒšg
(
sds
 
s
, 
ş›Á
 *client) {

1448 
æags
[16], 
ev’ts
[3], *
p
;

1449 
emask
;

1451 
p
 = 
æags
;

1453 ià(
ş›Á
->
æags
 & 
CLIENT_SLAVE
) {

1454 ià(
ş›Á
->
æags
 & 
CLIENT_MONITOR
)

1455 *
p
++ = 'O';

1457 *
p
++ = 'S';

1459 ià(
ş›Á
->
æags
 & 
CLIENT_MASTER
è*
p
++ = 'M';

1460 ià(
ş›Á
->
æags
 & 
CLIENT_MULTI
è*
p
++ = 'x';

1461 ià(
ş›Á
->
æags
 & 
CLIENT_BLOCKED
è*
p
++ = 'b';

1462 ià(
ş›Á
->
æags
 & 
CLIENT_DIRTY_CAS
è*
p
++ = 'd';

1463 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è*
p
++ = 'c';

1464 ià(
ş›Á
->
æags
 & 
CLIENT_UNBLOCKED
è*
p
++ = 'u';

1465 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_ASAP
è*
p
++ = 'A';

1466 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
è*
p
++ = 'U';

1467 ià(
ş›Á
->
æags
 & 
CLIENT_READONLY
è*
p
++ = 'r';

1468 ià(
p
 =ğ
æags
) *p++ = 'N';

1469 *
p
++ = '\0';

1471 
emask
 = 
ş›Á
->
cÚn
->
sd
 =ğ-1 ? 0 : 
	`«G‘FeEv’ts
(ş›Á->
v–
->
–
,client->conn->sd);

1472 
p
 = 
ev’ts
;

1473 ià(
emask
 & 
AE_READABLE
è*
p
++ = 'r';

1474 ià(
emask
 & 
AE_WRITABLE
è*
p
++ = 'w';

1475 *
p
 = '\0';

1477  
	`sdsÿtfmt
(
s
,

1479 
ş›Á
->
curidx
,

1480 (è
ş›Á
->
id
,

1481 
	`g‘Cl›ÁP“rId
(
ş›Á
),

1482 
ş›Á
->
cÚn
->
sd
,

1483 
ş›Á
->
Çme
 ? (*)ş›Á->Çme->
±r
 : "",

1484 ()(
ş›Á
->
v–
->
unixtime
 - cl›Á->
ùime
),

1485 ()(
ş›Á
->
v–
->
unixtime
 - cl›Á->
Ï¡š‹¿ùiÚ
),

1486 
æags
,

1487 
ş›Á
->
diùid
,

1488 (è
	`diùSize
(
ş›Á
->
pubsub_chªÃls
),

1489 (è
	`dli¡L’gth
(
ş›Á
->
pubsub_·‰”ns
),

1490 (
ş›Á
->
æags
 & 
CLIENT_MULTI
è? cl›Á->
m¡©e
.
couÁ
 : -1,

1491 (è
	`sd¦’
(
ş›Á
->
qu”ybuf
),

1492 (è
	`sd§va
(
ş›Á
->
qu”ybuf
),

1493 (è
ş›Á
->
buåos
,

1494 (è
	`dli¡L’gth
(
ş›Á
->
»¶y
),

1495 (è
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
),

1496 
ev’ts
,

1497 
ş›Á
->
Ï¡cmd
 ? cl›Á->Ï¡cmd->
Çme
 : "NULL");

1498 
	}
}

1501 
sds
 
	$g‘AÎCl›ÁsInfoSŒšg
(
vr_ev’oİ
 *
v–
) {

1502 
dli¡Node
 *
Ê
;

1503 
dli¡I‹r
 
li
;

1504 
ş›Á
 *client;

1505 
sds
 
o
 = 
	`sd¢ewËn
(
NULL
,200*
	`dli¡L’gth
(
v–
->
ş›Ás
));

1506 
	`sdsş—r
(
o
);

1507 
	`dli¡Rewšd
(
v–
->
ş›Ás
,&
li
);

1508 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1509 
ş›Á
 = 
	`dli¡NodeV®ue
(
Ê
);

1510 
o
 = 
	`ÿtCl›ÁInfoSŒšg
(o,
ş›Á
);

1511 
o
 = 
	`sdsÿ’
(o,"\n",1);

1513  
o
;

1514 
	}
}

1516 
	sş›Ákld©a
 {

1517 
sds
 
	maddr
;

1518 
	mty³
;

1519 
ušt64_t
 
	mid
;

1520 
	mskme
;

1521 
	mkËd
;

1522 
	mşo£_this_ş›Á
;

1525 
	$ş›ÁCommªd
(
ş›Á
 *
c
) {

1526 
dli¡Node
 *
Ê
;

1527 
dli¡I‹r
 
li
;

1528 
ş›Á
 *client;

1530 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"li¡"è&& c->
¬gc
 == 2) {

1532 
sds
 
¡r
 = 
c
->
ÿche
;

1534 
sds
 
o
 = 
	`g‘AÎCl›ÁsInfoSŒšg
(
c
->
v–
);

1536 
¡r
 = 
	`sdsÿtsds
(¡r?¡r:
	`sd£m±y
(),
o
);

1538 ià(
c
->
¡•s
 >ğ(
	`d¬¿y_n
(&
wÜk”s
) - 1)) {

1539 
	`addR•lyBulkCBufãr
(
c
,
¡r
,
	`sd¦’
(str));

1540 
c
->
¡•s
 = 0;

1541 
c
->
ridx
 = -1;

1542 
	`sdsä“
(
¡r
);

1543 
c
->
ÿche
 = 
NULL
;

1544 
c
->
æags
 &ğ~
CLIENT_JUMP
;

1546 ià(!(
c
->
æags
&
CLIENT_JUMP
))

1547 
c
->
æags
 |ğ
CLIENT_JUMP
;

1548 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

1549 
c
->
ÿche
 = 
¡r
;

1551 
	`sdsä“
(
o
);

1554 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"kill")) {

1557 
ş›Ákld©a
 *
ckd
;

1559 ià(
c
->
¡•s
 == 0) {

1560 
ckd
 = 
	`d®loc
((
ş›Ákld©a
));

1561 
ckd
->
addr
 = 
NULL
;

1562 
ckd
->
ty³
 = -1;

1563 
ckd
->
id
 = 0;

1564 
ckd
->
skme
 = 1;

1565 
ckd
->
kËd
 = 0;

1566 
ckd
->
şo£_this_ş›Á
 = 0;

1568 ià(
c
->
¬gc
 == 3) {

1570 
ckd
->
addr
 = 
	`sd¢ew
(
c
->
¬gv
[2]->
±r
);

1571 
ckd
->
skme
 = 0;

1572 } ià(
c
->
¬gc
 > 3) {

1573 
i
 = 2;

1576 
i
 < 
c
->
¬gc
) {

1577 
mÜ—rgs
 = 
c
->
¬gc
 > 
i
+1;

1579 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"id"è&& 
mÜ—rgs
) {

1580 
tmp
;

1582 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
i
+1],&
tmp
,
NULL
)

1583 !ğ
VR_OK
) {

1584 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1585 
	`dä“
(
ckd
);

1588 
ckd
->
id
 = 
tmp
;

1589 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"ty³"è&& 
mÜ—rgs
) {

1590 
ckd
->
ty³
 = 
	`g‘Cl›ÁTy³ByName
(
c
->
¬gv
[
i
+1]->
±r
);

1591 ià(
ckd
->
ty³
 == -1) {

1592 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1593 
	`dä“
(
ckd
);

1594 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown clientype '%s'",

1595 (*è
c
->
¬gv
[
i
+1]->
±r
);

1598 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"addr"è&& 
mÜ—rgs
) {

1599 
ckd
->
addr
 = 
	`sd¢ew
(
c
->
¬gv
[
i
+1]->
±r
);

1600 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"skme"è&& 
mÜ—rgs
) {

1601 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"yes")) {

1602 
ckd
->
skme
 = 1;

1603 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"no")) {

1604 
ckd
->
skme
 = 0;

1606 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1607 
	`dä“
(
ckd
);

1608 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1612 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1613 
	`dä“
(
ckd
);

1614 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1617 
i
 += 2;

1620 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1621 
	`dä“
(
ckd
);

1622 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1626 ià(!(
c
->
æags
&
CLIENT_JUMP
))

1627 
c
->
æags
 |ğ
CLIENT_JUMP
;

1628 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

1629 
c
->
ÿche
 = 
ckd
;

1631 
ckd
 = 
c
->
ÿche
;

1632 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

1637 
	`dli¡Rewšd
(
c
->
v–
->
ş›Ás
,&
li
);

1638 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1639 
ş›Á
 = 
	`dli¡NodeV®ue
(
Ê
);

1640 ià(
ckd
->
addr
 && 
	`¡rcmp
(
	`g‘Cl›ÁP“rId
(
ş›Á
),ckd->addr) != 0) ;

1641 ià(
ckd
->
ty³
 !ğ-1 && 
	`g‘Cl›ÁTy³
(
ş›Á
) != ckd->type) ;

1642 ià(
ckd
->
id
 !ğ0 && 
ş›Á
->id != ckd->id) ;

1643 ià(
c
 =ğ
ş›Á
 && 
ckd
->
skme
) ;

1646 ià(
c
 =ğ
ş›Á
) {

1647 
ckd
->
şo£_this_ş›Á
 = 1;

1649 
	`ä“Cl›Á
(
ş›Á
);

1651 
ckd
->
kËd
++;

1654 ià(
c
->
¡•s
 >ğ(
	`d¬¿y_n
(&
wÜk”s
) - 1)) {

1656 ià(
c
->
¬gc
 == 3) {

1657 ià(
ckd
->
kËd
 == 0)

1658 
	`addR•lyE¼Ü
(
c
,"No such client");

1660 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1662 
	`addR•lyLÚgLÚg
(
c
,
ckd
->
kËd
);

1665 
c
->
¡•s
 = 0;

1666 
c
->
ridx
 = -1;

1667 
c
->
ÿche
 = 
NULL
;

1668 
c
->
æags
 &ğ~
CLIENT_JUMP
;

1672 ià(
ckd
->
şo£_this_ş›Á
è
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1674 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1675 
	`dä“
(
ckd
);

1679 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£Šame"è&& c->
¬gc
 == 3) {

1680 
j
, 
Ën
 = 
	`sd¦’
(
c
->
¬gv
[2]->
±r
);

1681 *
p
 = 
c
->
¬gv
[2]->
±r
;

1685 ià(
Ën
 == 0) {

1686 ià(
c
->
Çme
è
	`ä“Objeù
(c->name);

1687 
c
->
Çme
 = 
NULL
;

1688 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1695 
j
 = 0; j < 
Ën
; j++) {

1696 ià(
p
[
j
] < '!' ||…[j] > '~') {

1697 
	`addR•lyE¼Ü
(
c
,

1703 ià(
c
->
Çme
è
	`ä“Objeù
(c->name);

1704 
c
->
Çme
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(c->
¬gv
[2]);

1705 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1707 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘Çme"è&& c->
¬gc
 == 2) {

1708 ià(
c
->
Çme
)

1709 
	`addR•lyBulk
(
c
,c->
Çme
);

1711 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1714 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL ip:port | SETNAME connection-name)");

1718 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶y"è&& c->
¬gc
 == 3) {

1720 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"on")) {

1721 
c
->
æags
 &ğ~(
CLIENT_REPLY_SKIP
|
CLIENT_REPLY_OFF
);

1722 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1723 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"off")) {

1724 
c
->
æags
 |ğ
CLIENT_REPLY_OFF
;

1725 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"skip")) {

1726 ià(!(
c
->
æags
 & 
CLIENT_REPLY_OFF
))

1727 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP_NEXT
;

1729 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1732 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"·u£"è&& c->
¬gc
 == 3) {

1733 
du¿tiÚ
;

1735 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
du¿tiÚ
,
UNIT_MILLISECONDS
)

1736 !ğ
VR_OK
) ;

1737 
	`·u£Cl›Ás
(
NULL
, 
du¿tiÚ
);

1738 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1740 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL ip:port | GETNAME | SETNAME connection-name)");

1742 
	}
}

1747 
	$»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...) {

1748 
va_li¡
 
­
;

1749 
j
;

1750 
robj
 **
¬gv
;

1752 
¬gv
 = 
	`d®loc
((
robj
*)*
¬gc
);

1753 
	`va_¡¬t
(
­
,
¬gc
);

1754 
j
 = 0; j < 
¬gc
; j++) {

1755 
robj
 *
a
;

1756 
a
 = 
	`va_¬g
(
­
, 
robj
*);

1757 
¬gv
[
j
] = 
a
;

1760 
j
 = 0; j < 
c
->
¬gc
; j++è
	`ä“Objeù
(c->
¬gv
[j]);

1761 
	`dä“
(
c
->
¬gv
);

1763 
c
->
¬gv
 =‡rgv;

1764 
c
->
¬gc
 =‡rgc;

1765 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1766 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1767 
	`va_’d
(
­
);

1768 
	}
}

1772 
	$»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
) {

1773 
	`ä“Cl›ÁArgv
(
c
);

1774 
	`dä“
(
c
->
¬gv
);

1775 
c
->
¬gv
 =‡rgv;

1776 
c
->
¬gc
 =‡rgc;

1777 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1778 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1779 
	}
}

1793 
	$»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
) {

1794 
robj
 *
Şdv®
;

1796 ià(
i
 >ğ
c
->
¬gc
) {

1797 
c
->
¬gv
 = 
	`d»®loc
(c->¬gv,(
robj
*)*(
i
+1));

1798 
c
->
¬gc
 = 
i
+1;

1799 
c
->
¬gv
[
i
] = 
NULL
;

1801 
Şdv®
 = 
c
->
¬gv
[
i
];

1802 
c
->
¬gv
[
i
] = 
Ãwv®
;

1803 ià(
Şdv®
è
	`ä“Objeù
(oldval);

1806 ià(
i
 == 0) {

1807 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1808 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1810 
	}
}

1826 
	$g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
) {

1827 
li¡_™em_size
 = (
dli¡Node
)+(
robj
);

1829  
c
->
»¶y_by‹s
 + (
li¡_™em_size
*
	`dli¡L’gth
(c->
»¶y
));

1830 
	}
}

1842 
	$g‘Cl›ÁTy³
(
ş›Á
 *
c
) {

1843 ià(
c
->
æags
 & 
CLIENT_MASTER
è 
CLIENT_TYPE_MASTER
;

1844 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
))

1845  
CLIENT_TYPE_SLAVE
;

1846 ià(
c
->
æags
 & 
CLIENT_PUBSUB
è 
CLIENT_TYPE_PUBSUB
;

1847  
CLIENT_TYPE_NORMAL
;

1848 
	}
}

1851 
	$g‘Cl›ÁTy³ByName
(*
Çme
) {

1852 ià(!
	`¡rÿ£cmp
(
Çme
,"nÜm®")è 
CLIENT_TYPE_NORMAL
;

1853 ià(!
	`¡rÿ£cmp
(
Çme
,"¦ave")è 
CLIENT_TYPE_SLAVE
;

1854 ià(!
	`¡rÿ£cmp
(
Çme
,"pubsub")è 
CLIENT_TYPE_PUBSUB
;

1855 ià(!
	`¡rÿ£cmp
(
Çme
,"ma¡”")è 
CLIENT_TYPE_MASTER
;

1857 
	}
}

1860 *
	$g‘Cl›ÁTy³Name
(
şass
) {

1861 
şass
) {

1862 
CLIENT_TYPE_NORMAL
:  "normal";

1863 
CLIENT_TYPE_SLAVE
:  "slave";

1864 
CLIENT_TYPE_PUBSUB
:  "pubsub";

1865 
CLIENT_TYPE_MASTER
:  "master";

1866 :  
NULL
;

1868 
	}
}

1877 
	$checkCl›ÁOuutBufãrLim™s
(
ş›Á
 *
c
) {

1878 
soá
 = 0, 
h¬d
 = 0, 
şass
;

1879 
u£d_mem
 = 
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

1881 
şass
 = 
	`g‘Cl›ÁTy³
(
c
);

1884 ià(
şass
 =ğ
CLIENT_TYPE_MASTER
èşas ğ
CLIENT_TYPE_NORMAL
;

1886 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 &&

1887 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
)

1888 
h¬d
 = 1;

1889 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 &&

1890 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
)

1891 
soá
 = 1;

1895 ià(
soá
) {

1897 ià(
c
->
obuf_soá_lim™_»ached_time
 == 0) {

1898 
c
->
obuf_soá_lim™_»ached_time
 = c->
v–
->
unixtime
;

1899 
soá
 = 0;

1902 
time_t
 
–­£d
 = 
c
->
v–
->
unixtime
 - c->
obuf_soá_lim™_»ached_time
;

1905 ià(
–­£d
 <=

1906 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
) {

1907 
soá
 = 0;

1914 
c
->
obuf_soá_lim™_»ached_time
 = 0;

1916  
soá
 || 
h¬d
;

1917 
	}
}

1927 
	$asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
) {

1928 
	`ASSERT
(
c
->
»¶y_by‹s
 < 
SIZE_MAX
-(1024*64));

1929 ià(
c
->
»¶y_by‹s
 =ğ0 || c->
æags
 & 
CLIENT_CLOSE_ASAP
) ;

1930 ià(
	`checkCl›ÁOuutBufãrLim™s
(
c
)) {

1931 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1933 
	`ä“Cl›ÁAsync
(
c
);

1935 
	`log_w¬n
("Cl›Á % scheduËdØbşo£d ASAP fÜ ov”comšg oàouuˆbufã¸lim™s.", 
ş›Á
);

1936 
	`sdsä“
(
ş›Á
);

1938 
	}
}

1946 
	$æushSÏvesOuutBufãrs
() {

1947 
dli¡I‹r
 
li
;

1948 
dli¡Node
 *
Ê
;

1950 
	`dli¡Rewšd
(
»¶
.
¦aves
,&
li
);

1951 (
Ê
 = 
	`dli¡Next
(&
li
))) {

1952 
ş›Á
 *
¦ave
 = 
	`dli¡NodeV®ue
(
Ê
);

1953 
ev’ts
;

1961 
ev’ts
 = 
	`«G‘FeEv’ts
(
»¶
.
v–
.
–
,
¦ave
->
cÚn
->
sd
);

1963 ià(
ev’ts
 & 
AE_WRITABLE
 &&

1964 
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

1965 
	`ş›ÁHasP’dšgR•l›s
(
¦ave
))

1967 
	`wr™eToCl›Á
(
¦ave
->
cÚn
->
sd
,slave,0);

1970 
	}
}

1990 
	$·u£Cl›Ás
(
vr_ev’oİ
 *
v–
, 
’d
) {

1991 ià(
v–
 =ğ
NULL
) ;

1993 ià(!
v–
->
ş›Ás_·u£d
 || 
’d
 > v–->
ş›Ás_·u£_’d_time
)

1994 
v–
->
ş›Ás_·u£_’d_time
 = 
’d
;

1995 
v–
->
ş›Ás_·u£d
 = 1;

1996 
	}
}

2001 
	$ş›ÁsA»Pau£d
(
vr_ev’oİ
 *
v–
) {

2002 ià(
v–
->
ş›Ás_·u£d
 &&

2003 
v–
->
ş›Ás_·u£_’d_time
 < v–->
m¡ime
)

2005 
dli¡Node
 *
Ê
;

2006 
dli¡I‹r
 
li
;

2007 
ş›Á
 *
c
;

2009 
v–
->
ş›Ás_·u£d
 = 0;

2013 
	`dli¡Rewšd
(
v–
->
ş›Ás
,&
li
);

2014 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

2015 
c
 = 
	`dli¡NodeV®ue
(
Ê
);

2019 ià(
c
->
æags
 & (
CLIENT_SLAVE
|
CLIENT_BLOCKED
)) ;

2020 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

2021 
	`dli¡AddNodeTa
(
v–
->
unblocked_ş›Ás
,
c
);

2024  
v–
->
ş›Ás_·u£d
;

2025 
	}
}

2040 
	$´oûssEv’tsWheBlocked
(
vr_ev’oİ
 *
v–
) {

2041 
™”©iÚs
 = 4;

2042 
couÁ
 = 0;

2043 
™”©iÚs
--) {

2044 
ev’ts
 = 0;

2045 
ev’ts
 +ğ
	`«ProûssEv’ts
(
v–
->
–
, 
AE_FILE_EVENTS
|
AE_DONT_WAIT
);

2046 
ev’ts
 +ğ
	`hªdËCl›ÁsW™hP’dšgWr™es
(
v–
);

2047 ià(!
ev’ts
) ;

2048 
couÁ
 +ğ
ev’ts
;

2050  
couÁ
;

2051 
	}
}

2055 
	$cu¼’t_ş›Ás
()

2057 
ccs
;

2059 #ià
	`defšed
(
__ATOMIC_RELAXED
è|| defšed(
HAVE_ATOMIC
)

2060 
ccs
 = 
	`upd©e_cu¼_ş›Ás_add
(0);

2062 
	`±h»ad_mu‹x_lock
(&
cu¼_ş›Ás_mu‹x
);

2063 
ccs
 = 
ncu¼_ccÚn
;

2064 
	`±h»ad_mu‹x_uÆock
(&
cu¼_ş›Ás_mu‹x
);

2067  
ccs
;

2068 
	}
}

	@src/vr_client.c

1 
	~<vr_cÜe.h
>

3 
	gncu¼_ccÚn
 = 0;

5 
£tPrÙocŞE¼Ü
(
ş›Á
 *
c
, 
pos
);

10 
size_t
 
	$sdsZm®locSize
(
sds
 
s
) {

11 *
sh
 = 
	`sdsAÎocPŒ
(
s
);

12  
	`dm®loc_size
(
sh
);

13 
	}
}

15 *
	$dupCl›ÁR•lyV®ue
(*
o
) {

16  
o
;

17 
	}
}

19 
	$ä“Cl›ÁR•lyV®ue
(*
o
) {

20 
	`ä“Objeù
(
o
);

21 
	}
}

23 
	$li¡M©chObjeùs
(*
a
, *
b
) {

24  
	`equ®SŒšgObjeùs
(
a
,
b
);

25 
	}
}

27 
ş›Á
 *
	$ü—‹Cl›Á
(
vr_ev’oİ
 *
v–
, 
cÚn
 *conn) {

29 
ş›Á
 *
c
 = 
	`d®loc
((client));

36 ià(
cÚn
->
sd
 != -1) {

38 
	`vr_£t_nÚblockšg
(
cÚn
->
sd
);

40 
	`vr_£t_tınod–ay
(
cÚn
->
sd
);

42 ià(
£rv”
.
tık“·live
)

43 
	`vr_£t_tık“·live
(
cÚn
->
sd
,
£rv”
.
tık“·live
,0,0);

45 ià(
	`«C»©eFeEv’t
(
v–
->
–
,
cÚn
->
sd
,
AE_READABLE
,

46 
»adQu”yFromCl›Á
, 
c
è=ğ
AE_ERR
)

48 
	`log_”rÜ
("Unrecoverableƒrror creating client ipfd fileƒvent.");

49 
	`dä“
(
c
);

50  
NULL
;

54 
	`£ËùDb
(
c
,0);

56 
c
->
id
 = 
v–
->
Ãxt_ş›Á_id
++;

58 
c
->
cÚn
 = conn;

60 
c
->
v–
 = vel;

62 
c
->
sÿnid
 = -1;

64 
c
->
Çme
 = 
NULL
;

66 
c
->
buåos
 = 0;

68 
c
->
qu”ybuf
 = 
	`sd£m±y
();

70 
c
->
qu”ybuf_³ak
 = 0;

72 
c
->
»qty³
 = 0;

74 
c
->
¬gc
 = 0;

76 
c
->
¬gv
 = 
NULL
;

78 
c
->
cmd
 = c->
Ï¡cmd
 = 
NULL
;

80 
c
->
muÉibulkËn
 = 0;

81 
c
->
bulkËn
 = -1;

82 
c
->
£ÁËn
 = 0;

83 
c
->
æags
 = 0;

84 
c
->
ùime
 = c->
Ï¡š‹¿ùiÚ
 = 
v–
->
unixtime
;

85 
c
->
auth’tiÿ‹d
 = 0;

86 
c
->
»¶¡©e
 = 
REPL_STATE_NONE
;

87 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

88 
c
->
»¶off
 = 0;

89 
c
->
»¶_ack_off
 = 0;

90 
c
->
»¶_ack_time
 = 0;

91 
c
->
¦ave_li¡’šg_pÜt
 = 0;

92 
c
->
¦ave_ÿ·
 = 
SLAVE_CAPA_NONE
;

93 
c
->
»¶y
 = 
	`dli¡C»©e
();

94 
c
->
»¶y_by‹s
 = 0;

95 
c
->
obuf_soá_lim™_»ached_time
 = 0;

97 
	`dli¡S‘F»eM‘hod
(
c
->
»¶y
,
ä“Cl›ÁR•lyV®ue
);

98 
	`dli¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

99 
c
->
bty³
 = 
BLOCKED_NONE
;

100 
c
->
bpİ
.
timeout
 = 0;

101 
c
->
bpİ
.
keys
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

102 
c
->
bpİ
.
rg‘
 = 
NULL
;

103 
c
->
bpİ
.
num»¶iÿs
 = 0;

104 
c
->
bpİ
.
»¶off£t
 = 0;

105 
c
->
woff
 = 0;

106 
c
->
w©ched_keys
 = 
	`dli¡C»©e
();

107 
c
->
pubsub_chªÃls
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

108 
c
->
pubsub_·‰”ns
 = 
	`dli¡C»©e
();

109 
c
->
³”id
 = 
NULL
;

110 
c
->
curidx
 = -1;

111 
c
->
ridx
 = -1;

112 
c
->
¡•s
 = 0;

113 
c
->
ÿche
 = 
NULL
;

114 
	`dli¡S‘F»eM‘hod
(
c
->
pubsub_·‰”ns
,
deüRefCouÁVoid
);

115 
	`dli¡S‘M©chM‘hod
(
c
->
pubsub_·‰”ns
,
li¡M©chObjeùs
);

116 ià(
cÚn
->
sd
 !ğ-1è
	`dli¡AddNodeTa
(
v–
->
ş›Ás
,
c
);

117 
	`š™Cl›ÁMuÉiS‹
(
c
);

118  
c
;

119 
	}
}

144 
	$´•¬eCl›ÁToWr™e
(
ş›Á
 *
c
) {

147 ià(
c
->
æags
 & 
CLIENT_LUA
è 
VR_OK
;

150 ià(
c
->
æags
 & (
CLIENT_REPLY_OFF
|
CLIENT_REPLY_SKIP
)è 
VR_ERROR
;

155 ià((
c
->
æags
 & 
CLIENT_MASTER
) &&

156 !(
c
->
æags
 & 
CLIENT_MASTER_FORCE_REPLY
)è 
VR_ERROR
;

158 ià(
c
->
cÚn
->
sd
 <ğ0è 
VR_ERROR
;

165 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

166 !(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) &&

167 (
c
->
»¶¡©e
 =ğ
REPL_STATE_NONE
 ||

168 (
c
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 && !c->
»¶_put_Úlše_Ú_ack
)))

176 
c
->
æags
 |ğ
CLIENT_PENDING_WRITE
;

177 
	`dli¡AddNodeH—d
(
c
->
v–
->
ş›Ás_³ndšg_wr™e
,c);

181  
VR_OK
;

182 
	}
}

187 
robj
 *
	$dupLa¡ObjeùIfN“ded
(
dli¡
 *
»¶y
) {

188 
robj
 *
Ãw
, *
cur
;

189 
dli¡Node
 *
Ê
;

190 
	`ASSERT
(
	`dli¡L’gth
(
»¶y
) > 0);

191 
Ê
 = 
	`dli¡La¡
(
»¶y
);

192 
cur
 = 
	`dli¡NodeV®ue
(
Ê
);

193 ià(
cur
->
cÚ¡ªt
) {

194 
Ãw
 = 
	`dupSŒšgObjeù
(
cur
);

195 
	`dli¡NodeV®ue
(
Ê
èğ
Ãw
;

197  
	`dli¡NodeV®ue
(
Ê
);

198 
	}
}

204 
	$_addR•lyToBufãr
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

205 
size_t
 
avaabË
 = (
c
->
buf
)-c->
buåos
;

207 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è 
VR_OK
;

211 ià(
	`dli¡L’gth
(
c
->
»¶y
è> 0è 
VR_ERROR
;

214 ià(
Ën
 > 
avaabË
è 
VR_ERROR
;

216 
	`memıy
(
c
->
buf
+c->
buåos
,
s
,
Ën
);

217 
c
->
buåos
+=
Ën
;

218  
VR_OK
;

219 
	}
}

222 
	$_addR•lyObjeùToLi¡
(
ş›Á
 *
c
, 
robj
 *
o
) {

223 
robj
 *

, *
obj
;

225 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

227 ià(
	`dli¡L’gth
(
c
->
»¶y
) == 0) {

228 ià(
o
->
cÚ¡ªt
)

229 
obj
 = 
o
;

231 
obj
 = 
	`dupSŒšgObjeù
(
o
);

232 
	`dli¡AddNodeTa
(
c
->
»¶y
,
obj
);

233 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
obj
);

235 

 = 
	`dli¡NodeV®ue
(
	`dli¡La¡
(
c
->
»¶y
));

238 ià(

->
±r
 !ğ
NULL
 &&

239 

->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

240 
	`sd¦’
(

->
±r
)+sd¦’(
o
->±rè<ğ
PROTO_REPLY_CHUNK_BYTES
)

242 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(

->
±r
);

243 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

244 

->
±r
 = 
	`sdsÿ’
Ña->±r,
o
->±r,
	`sd¦’
(o->ptr));

245 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(

->
±r
);

247 ià(
o
->
cÚ¡ªt
)

248 
obj
 = 
o
;

250 
obj
 = 
	`dupSŒšgObjeù
(
o
);

251 
	`dli¡AddNodeTa
(
c
->
»¶y
,
obj
);

252 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
obj
);

255 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

256 
	}
}

261 
	$_addR•lySdsToLi¡
(
ş›Á
 *
c
, 
sds
 
s
) {

262 
robj
 *

;

264 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

265 
	`sdsä“
(
s
);

269 ià(
	`dli¡L’gth
(
c
->
»¶y
) == 0) {

270 
	`dli¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
OBJ_STRING
,
s
));

271 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
s
);

273 

 = 
	`dli¡NodeV®ue
(
	`dli¡La¡
(
c
->
»¶y
));

276 ià(

->
±r
 !ğ
NULL
 &&a->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

277 
	`sd¦’
(

->
±r
)+sd¦’(
s
è<ğ
PROTO_REPLY_CHUNK_BYTES
)

279 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(

->
±r
);

280 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

281 

->
±r
 = 
	`sdsÿ’
Ña->±r,
s
,
	`sd¦’
(s));

282 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(

->
±r
);

283 
	`sdsä“
(
s
);

285 
	`dli¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
OBJ_STRING
,
s
));

286 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
s
);

289 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

290 
	}
}

293 
	$_addR•lySŒšgToLi¡
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

294 
robj
 *

;

296 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

298 ià(
	`dli¡L’gth
(
c
->
»¶y
) == 0) {

299 
robj
 *
o
 = 
	`ü—‹SŒšgObjeù
(
s
,
Ën
);

301 
	`dli¡AddNodeTa
(
c
->
»¶y
,
o
);

302 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

304 

 = 
	`dli¡NodeV®ue
(
	`dli¡La¡
(
c
->
»¶y
));

307 ià(

->
±r
 !ğ
NULL
 &&a->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

308 
	`sd¦’
(

->
±r
)+
Ën
 <ğ
PROTO_REPLY_CHUNK_BYTES
)

310 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(

->
±r
);

311 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

312 

->
±r
 = 
	`sdsÿ’
Ña->±r,
s
,
Ën
);

313 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(

->
±r
);

315 
robj
 *
o
 = 
	`ü—‹SŒšgObjeù
(
s
,
Ën
);

317 
	`dli¡AddNodeTa
(
c
->
»¶y
,
o
);

318 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

321 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

322 
	}
}

329 
	$addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
) {

331 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
) ;

341 ià(
	`sdsEncodedObjeù
(
obj
)) {

342 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
VR_OK
)

343 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

344 } ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

346 
robj
 *
obj_Ãw
;

350 ià(
	`dli¡L’gth
(
c
->
»¶y
è=ğ0 && ((c->
buf
è- c->
buåos
) >= 32) {

351 
buf
[32];

352 
Ën
;

354 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
obj
->
±r
);

356 ià(
	`_addR•lyToBufãr
(
c
,
buf
,
Ën
è=ğ
VR_OK
)

362 
obj_Ãw
 = 
	`g‘DecodedObjeù
(
obj
);

363 ià(
	`_addR•lyToBufãr
(
c
,
obj_Ãw
->
±r
,
	`sd¦’
(obj_Ãw->±r)è!ğ
VR_OK
)

364 
	`_addR•lyObjeùToLi¡
(
c
,
obj_Ãw
);

365 ià(
obj_Ãw
 !ğ
obj
è
	`ä“Objeù
(obj_new);

367 
	`£rv”Pªic
("Wrong obj->encoding in‡ddReply()");

369 
	}
}

372 
	$addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
) {

373 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
) {

375 
	`sdsä“
(
s
);

378 ià(
	`_addR•lyToBufãr
(
c
,
s
,
	`sd¦’
(s)è=ğ
VR_OK
) {

379 
	`sdsä“
(
s
);

382 
	`_addR•lySdsToLi¡
(
c
,
s
);

384 
	}
}

386 
	$addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

387 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
) ;

388 ià(
	`_addR•lyToBufãr
(
c
,
s
,
Ën
è!ğ
VR_OK
)

389 
	`_addR•lySŒšgToLi¡
(
c
,
s
,
Ën
);

390 
	}
}

393 
	$addR•lyE¼ÜL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

394 
	`addR•lySŒšg
(
c
,"-ERR ",5);

395 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

396 
	`addR•lySŒšg
(
c
,"\r\n",2);

397 
	}
}

399 
	$addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
) {

400 
	`addR•lyE¼ÜL’gth
(
c
,
”r
,
	`¡¾’
(err));

401 
	}
}

404 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

405 
size_t
 
l
, 
j
;

406 
va_li¡
 
­
;

407 
	`va_¡¬t
(
­
,
fmt
);

408 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

409 
	`va_’d
(
­
);

412 
l
 = 
	`sd¦’
(
s
);

413 
j
 = 0; j < 
l
; j++) {

414 ià(
s
[
j
] == '\r' || s[j] == '\n') s[j] = ' ';

416 
	`addR•lyE¼ÜL’gth
(
c
,
s
,
	`sd¦’
(s));

417 
	`sdsä“
(
s
);

418 
	}
}

420 
	$addR•lyStusL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

421 
	`addR•lySŒšg
(
c
,"+",1);

422 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

423 
	`addR•lySŒšg
(
c
,"\r\n",2);

424 
	}
}

426 
	$addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
) {

427 
	`addR•lyStusL’gth
(
c
,
¡©us
,
	`¡¾’
(status));

428 
	}
}

431 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

432 
va_li¡
 
­
;

433 
	`va_¡¬t
(
­
,
fmt
);

434 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

435 
	`va_’d
(
­
);

436 
	`addR•lyStusL’gth
(
c
,
s
,
	`sd¦’
(s));

437 
	`sdsä“
(
s
);

438 
	}
}

442 *
	$addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
) {

446 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
VR_OK
è 
NULL
;

447 
	`dli¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
OBJ_STRING
,
NULL
));

448  
	`dli¡La¡
(
c
->
»¶y
);

449 
	}
}

452 
	$£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
) {

453 
dli¡Node
 *
Ê
 = (dli¡Node*)
node
;

454 
robj
 *
Ën
, *
Ãxt
;

457 ià(
node
 =ğ
NULL
) ;

459 
Ën
 = 
	`dli¡NodeV®ue
(
Ê
);

460 
Ën
->
±r
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"*%ld\r\n",
Ëngth
);

461 
Ën
->
’codšg
 = 
OBJ_ENCODING_RAW
;

462 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
Ën
->
±r
);

463 ià(
Ê
->
Ãxt
 !ğ
NULL
) {

464 
Ãxt
 = 
	`dli¡NodeV®ue
(
Ê
->next);

467 ià(
Ãxt
->
±r
 !ğ
NULL
) {

468 
c
->
»¶y_by‹s
 -ğ
	`sdsZm®locSize
(
Ën
->
±r
);

469 
c
->
»¶y_by‹s
 -ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
Ãxt
);

470 
Ën
->
±r
 = 
	`sdsÿ’
Ö’->±r,
Ãxt
->±r,
	`sd¦’
(next->ptr));

471 
c
->
»¶y_by‹s
 +ğ
	`sdsZm®locSize
(
Ën
->
±r
);

472 
	`dli¡D–Node
(
c
->
»¶y
,
Ê
->
Ãxt
);

475 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

476 
	}
}

480 
	$addR•lyDoubË
(
ş›Á
 *
c
, 
d
) {

481 
dbuf
[128], 
sbuf
[128];

482 
dËn
, 
¦’
;

483 ià(
	`isšf
(
d
)) {

486 
	`addR•lyBulkCSŒšg
(
c
, 
d
 > 0 ? "inf" : "-inf");

488 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

489 
¦’
 = 
	`¢´štf
(
sbuf
,(sbuf),"$%d\r\n%s\r\n",
dËn
,
dbuf
);

490 
	`addR•lySŒšg
(
c
,
sbuf
,
¦’
);

492 
	}
}

498 
	$addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
) {

499 
robj
 *
o
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
d
,1);

500 
	`addR•lyBulk
(
c
,
o
);

501 
	`deüRefCouÁ
(
o
);

502 
	}
}

507 
	$addR•lyLÚgLÚgW™hP»fix
(
ş›Á
 *
c
, 
Î
, 
´efix
) {

508 
buf
[128];

509 
Ën
;

514 ià(
´efix
 =ğ'*' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

515 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Î
]);

517 } ià(
´efix
 =ğ'$' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

518 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Î
]);

522 
buf
[0] = 
´efix
;

523 
Ën
 = 
	`Î2¡ršg
(
buf
+1,(buf)-1,
Î
);

524 
buf
[
Ën
+1] = '\r';

525 
buf
[
Ën
+2] = '\n';

526 
	`addR•lySŒšg
(
c
,
buf
,
Ën
+3);

527 
	}
}

529 
	$addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

530 ià(
Î
 == 0)

531 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

532 ià(
Î
 == 1)

533 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

535 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Î
,':');

536 
	}
}

538 
	$addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
) {

539 ià(
Ëngth
 < 
OBJ_SHARED_BULKHDR_LEN
)

540 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Ëngth
]);

542 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ëngth
,'*');

543 
	}
}

546 
	$addR•lyBulkL’
(
ş›Á
 *
c
, 
robj
 *
obj
) {

547 
size_t
 
Ën
;

549 ià(
	`sdsEncodedObjeù
(
obj
)) {

550 
Ën
 = 
	`sd¦’
(
obj
->
±r
);

552 
n
 = ()
obj
->
±r
;

555 
Ën
 = 1;

556 ià(
n
 < 0) {

557 
Ën
++;

558 
n
 = -n;

560 (
n
 =‚/10) != 0) {

561 
Ën
++;

565 ià(
Ën
 < 
OBJ_SHARED_BULKHDR_LEN
)

566 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Ën
]);

568 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

569 
	}
}

572 
	$addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
) {

573 
	`addR•lyBulkL’
(
c
,
obj
);

574 
	`addR•ly
(
c
,
obj
);

575 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

576 
	}
}

579 
	$addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
) {

580 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

581 
	`addR•lySŒšg
(
c
,
p
,
Ën
);

582 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

583 
	}
}

586 
	$addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
) {

587 
	`addR•lySds
(
c
,
	`sdsÿtfmt
(
	`sd£m±y
(),"$%u\r\n",

588 ()
	`sd¦’
(
s
)));

589 
	`addR•lySds
(
c
,
s
);

590 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

591 
	}
}

594 
	$addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
) {

595 ià(
s
 =ğ
NULL
) {

596 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

598 
	`addR•lyBulkCBufãr
(
c
,
s
,
	`¡¾’
(s));

600 
	}
}

603 
	$addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

604 
buf
[64];

605 
Ën
;

607 
Ën
 = 
	`Î2¡ršg
(
buf
,64,
Î
);

608 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

609 
	}
}

615 
	$cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
) {

616 
	`dli¡R–—£
(
d¡
->
»¶y
);

617 
d¡
->
»¶y
 = 
	`dli¡Dup
(
¤c
->reply);

618 
	`memıy
(
d¡
->
buf
,
¤c
->buf,¤c->
buåos
);

619 
d¡
->
buåos
 = 
¤c
->bufpos;

620 
d¡
->
»¶y_by‹s
 = 
¤c
->reply_bytes;

621 
	}
}

626 
	$ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
) {

627  
c
->
buåos
 || 
	`dli¡L’gth
(c->
»¶y
);

628 
	}
}

630 
	$ä“Cl›ÁArgv
(
ş›Á
 *
c
) {

631 
j
;

632 
j
 = 0; j < 
c
->
¬gc
; j++)

633 
	`ä“Objeù
(
c
->
¬gv
[
j
]);

634 
c
->
¬gc
 = 0;

635 
c
->
cmd
 = 
NULL
;

636 
	}
}

642 
	$discÚÃùSÏves
() {

643 
	`dli¡L’gth
(
»¶
.
¦aves
)) {

644 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
»¶
.
¦aves
);

645 
	`ä“Cl›Á
((
ş›Á
*)
Ê
->
v®ue
);

647 
	}
}

653 
	$uÆškCl›ÁFromEv’oİ
(
ş›Á
 *
c
) {

654 
dli¡Node
 *
Ê
;

655 
vr_ev’oİ
 *
v–
 = 
c
->vel;

657 
c
->
v–
 = 
NULL
;

659 ià(
c
->
¡•s
 >= 1) ;

662 ià(
v–
->
cu¼’t_ş›Á
 =ğ
c
èv–->cu¼’t_ş›Á = 
NULL
;

667 ià(
c
->
cÚn
->
sd
 != -1) {

669 
Ê
 = 
	`dli¡S—rchKey
(
v–
->
ş›Ás
,
c
);

670 
	`ASSERT
(
Ê
 !ğ
NULL
);

671 
	`dli¡D–Node
(
v–
->
ş›Ás
,
Ê
);

674 
	`«D–‘eFeEv’t
(
v–
->
–
,
c
->
cÚn
->
sd
,
AE_READABLE
);

675 
	`«D–‘eFeEv’t
(
v–
->
–
,
c
->
cÚn
->
sd
,
AE_WRITABLE
);

679 ià(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) {

680 
Ê
 = 
	`dli¡S—rchKey
(
v–
->
ş›Ás_³ndšg_wr™e
,
c
);

681 
	`ASSERT
(
Ê
 !ğ
NULL
);

682 
	`dli¡D–Node
(
v–
->
ş›Ás_³ndšg_wr™e
,
Ê
);

683 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

688 ià(
c
->
æags
 & 
CLIENT_UNBLOCKED
) {

689 
Ê
 = 
	`dli¡S—rchKey
(
v–
->
unblocked_ş›Ás
,
c
);

690 
	`ASSERT
(
Ê
 !ğ
NULL
);

691 
	`dli¡D–Node
(
v–
->
unblocked_ş›Ás
,
Ê
);

692 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

694 
	}
}

696 
	$lškCl›ÁToEv’oİ
(
ş›Á
 *
c
,
vr_ev’oİ
 *
v–
) {

697 
	`dli¡Push
(
v–
->
ş›Ás
,
c
);

698 
c
->
v–
 = vel;

699 ià(
	`«C»©eFeEv’t
(
v–
->
–
,
c
->
cÚn
->
sd
,
AE_READABLE
,

700 
»adQu”yFromCl›Á
,
c
è=ğ
AE_ERR
)

702 
	`ä“Cl›Á
(
c
);

707 
	`´oûssIÅutBufãr
(
c
);

708 ià(
c
->
æags
&
CLIENT_JUMP
) {

709 
	`di¥©ch_cÚn_exi¡
(
c
,c->
ridx
);

711 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

712 !(
c
->
æags
&
CLIENT_PENDING_WRITE
)) {

713 ià(
	`«C»©eFeEv’t
(
v–
->
–
, 
c
->
cÚn
->
sd
, 
AE_WRITABLE
,

714 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

716 
	`ä“Cl›ÁAsync
(
c
);

720 
	}
}

725 
	$uÆškCl›Á
(
ş›Á
 *
c
) {

726 
dli¡Node
 *
Ê
;

729 ià(
c
->
v–
->
cu¼’t_ş›Á
 =ğcèc->v–->cu¼’t_ş›Á = 
NULL
;

734 ià(
c
->
cÚn
->
sd
 != -1) {

736 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás
,c);

737 
	`ASSERT
(
Ê
 !ğ
NULL
);

738 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás
,
Ê
);

741 
	`«D–‘eFeEv’t
(
c
->
v–
->
–
,c->
cÚn
->
sd
,
AE_READABLE
);

742 
	`«D–‘eFeEv’t
(
c
->
v–
->
–
,c->
cÚn
->
sd
,
AE_WRITABLE
);

743 
	`cÚn_put
(
c
->
cÚn
);

744 
c
->
cÚn
 = 
NULL
;

748 ià(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) {

749 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás_³ndšg_wr™e
,c);

750 
	`ASSERT
(
Ê
 !ğ
NULL
);

751 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás_³ndšg_wr™e
,
Ê
);

752 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

757 ià(
c
->
æags
 & 
CLIENT_UNBLOCKED
) {

758 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
unblocked_ş›Ás
,c);

759 
	`ASSERT
(
Ê
 !ğ
NULL
);

760 
	`dli¡D–Node
(
c
->
v–
->
unblocked_ş›Ás
,
Ê
);

761 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

763 
	}
}

765 
	$ä“Cl›Á
(
ş›Á
 *
c
) {

766 
dli¡Node
 *
Ê
;

773 ià(
»¶
.
rŞe
 =ğ
REPLICATION_ROLE_MASTER
 && 
c
->
æags
 & 
CLIENT_MASTER
) {

774 
	`log_w¬n
("connection with master†ost.");

775 ià(!(
c
->
æags
 & (
CLIENT_CLOSE_AFTER_REPLY
|

776 
CLIENT_CLOSE_ASAP
|

777 
CLIENT_BLOCKED
|

778 
CLIENT_UNBLOCKED
)))

780 
	`»¶iÿtiÚCacheMa¡”
(
c
);

786 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
)) {

787 
	`log_w¬n
("connection with slave %s†ost.",

788 
	`»¶iÿtiÚG‘SÏveName
(
c
));

792 
	`sdsä“
(
c
->
qu”ybuf
);

793 
c
->
qu”ybuf
 = 
NULL
;

796 ià(
c
->
æags
 & 
CLIENT_BLOCKED
è
	`unblockCl›Á
(c);

797 
	`diùR–—£
(
c
->
bpİ
.
keys
);

800 
	`unw©chAÎKeys
(
c
);

801 
	`dli¡R–—£
(
c
->
w©ched_keys
);

804 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,0);

805 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,0);

806 
	`diùR–—£
(
c
->
pubsub_chªÃls
);

807 
	`dli¡R–—£
(
c
->
pubsub_·‰”ns
);

810 
	`dli¡R–—£
(
c
->
»¶y
);

811 
	`ä“Cl›ÁArgv
(
c
);

816 
	`uÆškCl›Á
(
c
);

820 ià(
c
->
æags
 & 
CLIENT_SLAVE
) {

821 ià(
c
->
»¶¡©e
 =ğ
SLAVE_STATE_SEND_BULK
) {

822 ià(
c
->
»¶dbfd
 !ğ-1è
	`şo£
(c->repldbfd);

823 ià(
c
->
»¶´—mbË
è
	`sdsä“
(c->replpreamble);

825 
dli¡
 *
l
 = (
c
->
æags
 & 
CLIENT_MONITOR
è? 
£rv”
.
mÚ™Üs
 : 
»¶
.
¦aves
;

826 
Ê
 = 
	`dli¡S—rchKey
(
l
,
c
);

827 
	`ASSERT
(
Ê
 !ğ
NULL
);

828 
	`dli¡D–Node
(
l
,
Ê
);

832 ià(
c
->
æags
 & 
CLIENT_SLAVE
 && 
	`dli¡L’gth
(
»¶
.
¦aves
) == 0)

833 
»¶
.
»¶_no_¦aves_sšû
 = 
c
->
v–
->
unixtime
;

834 
	`»äeshGoodSÏvesCouÁ
();

839 ià(
c
->
æags
 & 
CLIENT_MASTER
è
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

843 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
) {

844 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás_to_şo£
,c);

845 
	`ASSERT
(
Ê
 !ğ
NULL
);

846 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás_to_şo£
,
Ê
);

851 ià(
c
->
Çme
è
	`ä“Objeù
(c->name);

852 ià(
c
->
¬gv
è
	`dä“
(c->argv);

853 
	`ä“Cl›ÁMuÉiS‹
(
c
);

854 
	`sdsä“
(
c
->
³”id
);

855 
	`dä“
(
c
);

856 
	}
}

863 
	$ä“Cl›ÁAsync
(
ş›Á
 *
c
) {

864 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
 || c->æag & 
CLIENT_LUA
) ;

865 
c
->
æags
 |ğ
CLIENT_CLOSE_ASAP
;

866 
	`dli¡AddNodeTa
(
c
->
v–
->
ş›Ás_to_şo£
,c);

867 
	}
}

869 
	$ä“Cl›ÁsInAsyncF»eQueue
(
vr_ev’oİ
 *
v–
) {

870 
	`dli¡L’gth
(
v–
->
ş›Ás_to_şo£
)) {

871 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
v–
->
ş›Ás_to_şo£
);

872 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

874 
c
->
æags
 &ğ~
CLIENT_CLOSE_ASAP
;

875 
	`ä“Cl›Á
(
c
);

876 
	`dli¡D–Node
(
v–
->
ş›Ás_to_şo£
,
Ê
);

878 
	}
}

883 
	$wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
) {

884 
ssize_t
 
nwr™‹n
 = 0, 
tÙwr™‹n
 = 0;

885 
size_t
 
objËn
;

886 
size_t
 
objmem
;

887 
robj
 *
o
;

888 
maxmemÜy
;

890 
maxmemÜy
 = 
c
->
v–
->
cc
.maxmemory;

891 
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

893 ià(
c
->
buåos
 > 0) {

894 
nwr™‹n
 = 
	`vr_wr™e
(
fd
,
c
->
buf
+c->
£ÁËn
,c->
buåos
-c->sentlen);

895 ià(
nwr™‹n
 <= 0) ;

896 
c
->
£ÁËn
 +ğ
nwr™‹n
;

897 
tÙwr™‹n
 +ğ
nwr™‹n
;

902 ià(()
c
->
£ÁËn
 =ğc->
buåos
) {

903 
c
->
buåos
 = 0;

904 
c
->
£ÁËn
 = 0;

907 
o
 = 
	`dli¡NodeV®ue
(
	`dli¡Fœ¡
(
c
->
»¶y
));

908 
objËn
 = 
	`sd¦’
(
o
->
±r
);

909 
objmem
 = 
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

911 ià(
objËn
 == 0) {

912 
	`dli¡D–Node
(
c
->
»¶y
,
	`dli¡Fœ¡
(c->reply));

913 
c
->
»¶y_by‹s
 -ğ
objmem
;

917 
nwr™‹n
 = 
	`vr_wr™e
(
fd
, ((*)
o
->
±r
)+
c
->
£ÁËn
,
objËn
-c->sentlen);

918 ià(
nwr™‹n
 <= 0) ;

919 
c
->
£ÁËn
 +ğ
nwr™‹n
;

920 
tÙwr™‹n
 +ğ
nwr™‹n
;

924 ià(
c
->
£ÁËn
 =ğ
objËn
) {

925 
	`dli¡D–Node
(
c
->
»¶y
,
	`dli¡Fœ¡
(c->reply));

926 
c
->
£ÁËn
 = 0;

927 
c
->
»¶y_by‹s
 -ğ
objmem
;

938 ià(
tÙwr™‹n
 > 
NET_MAX_WRITES_PER_EVENT
 &&

939 (
maxmemÜy
 =ğ0 || 
	`d®loc_u£d_memÜy
() < maxmemory))

942 ià(
nwr™‹n
 == -1) {

943 ià(
”ºo
 =ğ
EAGAIN
) {

944 
nwr™‹n
 = 0;

946 
	`log_debug
(
LOG_VERB
,

947 "”rÜ wr™šgØş›Á: %s", 
	`¡»¼Ü
(
”ºo
));

948 
	`ä“Cl›Á
(
c
);

949  
VR_ERROR
;

952 ià(
tÙwr™‹n
 > 0) {

953 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
Ãt_ouut_by‹s
, ()
tÙwr™‹n
);

958 ià(!(
c
->
æags
 & 
CLIENT_MASTER
)èc->
Ï¡š‹¿ùiÚ
 = c->
v–
->
unixtime
;

960 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

961 
c
->
£ÁËn
 = 0;

962 ià(
hªdËr_š¡®Ëd
è
	`«D–‘eFeEv’t
(
c
->
v–
->
–
,c->
cÚn
->
sd
,
AE_WRITABLE
);

965 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

966 
	`ä“Cl›Á
(
c
);

967  
VR_ERROR
;

970  
VR_OK
;

971 
	}
}

974 
	$£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

975 
	`UNUSED
(
–
);

976 
	`UNUSED
(
mask
);

977 
	`wr™eToCl›Á
(
fd
,
´ivd©a
,1);

978 
	}
}

984 
	$hªdËCl›ÁsW™hP’dšgWr™es
(
vr_ev’oİ
 *
v–
) {

985 
dli¡I‹r
 
li
;

986 
dli¡Node
 *
Ê
;

987 
´oûs£d
 = 
	`dli¡L’gth
(
v–
->
ş›Ás_³ndšg_wr™e
);

989 
	`dli¡Rewšd
(
v–
->
ş›Ás_³ndšg_wr™e
,&
li
);

990 (
Ê
 = 
	`dli¡Next
(&
li
))) {

991 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

992 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

993 
	`dli¡D–Node
(
v–
->
ş›Ás_³ndšg_wr™e
,
Ê
);

996 ià(
	`wr™eToCl›Á
(
c
->
cÚn
->
sd
,c,0è=ğ
VR_ERROR
) ;

1000 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

1001 
	`«C»©eFeEv’t
(
v–
->
–
, 
c
->
cÚn
->
sd
, 
AE_WRITABLE
,

1002 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

1004 
	`ä“Cl›ÁAsync
(
c
);

1007  
´oûs£d
;

1008 
	}
}

1012 
	$»£tCl›Á
(
ş›Á
 *
c
) {

1013 
»disCommªdProc
 *
´evcmd
 = 
c
->
cmd
 ? c->cmd->
´oc
 : 
NULL
;

1015 ià(
c
->
æags
&
CLIENT_JUMP
)

1018 
	`ä“Cl›ÁArgv
(
c
);

1019 
c
->
»qty³
 = 0;

1020 
c
->
muÉibulkËn
 = 0;

1021 
c
->
bulkËn
 = -1;

1026 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP
;

1027 ià(
c
->
æags
 & 
CLIENT_REPLY_SKIP_NEXT
) {

1028 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP
;

1029 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP_NEXT
;

1031 
	}
}

1034 
	$´oûssIÆšeBufãr
(
ş›Á
 *
c
) {

1035 *
Ãwlše
;

1036 
¬gc
, 
j
;

1037 
sds
 *
¬gv
, 
aux
;

1038 
size_t
 
qu”yËn
;

1042 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\n');

1046 ià(
Ãwlše
 =ğ
NULL
) {

1047 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1048 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big inline„equest");

1049 
	`£tPrÙocŞE¼Ü
(
c
,0);

1051  
VR_ERROR
;

1056 ià(
Ãwlše
 &&‚ewlš!ğ
c
->
qu”ybuf
 && *(newline-1) == '\r')

1057 
Ãwlše
--;

1061 
qu”yËn
 = 
Ãwlše
-(
c
->
qu”ybuf
);

1063 
aux
 = 
	`sd¢ewËn
(
c
->
qu”ybuf
,
qu”yËn
);

1065 
¬gv
 = 
	`sds¥l™¬gs
(
aux
,&
¬gc
);

1066 
	`sdsä“
(
aux
);

1067 ià(
¬gv
 =ğ
NULL
) {

1068 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: unbalanced quotes in„equest");

1069 
	`£tPrÙocŞE¼Ü
(
c
,0);

1070  
VR_ERROR
;

1077 ià(
qu”yËn
 =ğ0 && 
c
->
æags
 & 
CLIENT_SLAVE
)

1078 
c
->
»¶_ack_time
 = c->
v–
->
unixtime
;

1081 
	`sd¤ªge
(
c
->
qu”ybuf
,
qu”yËn
+2,-1);

1084 ià(
¬gc
) {

1085 ià(
c
->
¬gv
è
	`dä“
(c->argv);

1086 
c
->
¬gv
 = 
	`d®loc
((
robj
*)*
¬gc
);

1091 
c
->
¬gc
 = 0, 
j
 = 0; j <‡rgc; j++) {

1092 ià(
	`sd¦’
(
¬gv
[
j
])) {

1093 
c
->
¬gv
[c->
¬gc
] = 
	`ü—‹Objeù
(
OBJ_STRING
,¬gv[
j
]);

1094 
c
->
¬gc
++;

1096 
	`sdsä“
(
¬gv
[
j
]);

1099 
	`dä“
(
¬gv
);

1100  
VR_OK
;

1101 
	}
}

1106 
	$£tPrÙocŞE¼Ü
(
ş›Á
 *
c
, 
pos
) {

1107 ià(
	`log_loggabË
(
LOG_VERB
)) {

1108 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1109 
	`log_debug
(
LOG_VERB
,

1110 "PrÙocŞƒ¼Ü from cl›Á: %s", 
ş›Á
);

1111 
	`sdsä“
(
ş›Á
);

1113 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1114 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1115 
	}
}

1117 
	$´oûssMuÉibulkBufãr
(
ş›Á
 *
c
) {

1118 *
Ãwlše
 = 
NULL
;

1119 
pos
 = 0, 
ok
;

1120 
Î
;

1122 ià(
c
->
muÉibulkËn
 == 0) {

1124 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
¬gc
 == 0);

1127 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\r');

1128 ià(
Ãwlše
 =ğ
NULL
) {

1129 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1130 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big mbulk count string");

1131 
	`£tPrÙocŞE¼Ü
(
c
,0);

1133  
VR_ERROR
;

1138 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1139  
VR_ERROR
;

1144 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
qu”ybuf
[0] == '*');

1146 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+1,
Ãwlše
-(c->qu”ybuf+1),&
Î
);

1147 ià(!
ok
 || 
Î
 > 1024*1024) {

1148 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid multibulk†ength");

1149 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1150  
VR_ERROR
;

1154 
pos
 = (
Ãwlše
-
c
->
qu”ybuf
)+2;

1155 ià(
Î
 <= 0) {

1156 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1157  
VR_OK
;

1160 
c
->
muÉibulkËn
 = 
Î
;

1163 ià(
c
->
¬gv
è
	`dä“
(c->argv);

1164 
c
->
¬gv
 = 
	`d®loc
((
robj
*)*c->
muÉibulkËn
);

1167 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
muÉibulkËn
 > 0);

1169 
c
->
muÉibulkËn
) {

1171 ià(
c
->
bulkËn
 == -1) {

1173 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
+
pos
,'\r');

1174 ià(
Ãwlše
 =ğ
NULL
) {

1175 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1176 
	`addR•lyE¼Ü
(
c
,

1178 
	`£tPrÙocŞE¼Ü
(
c
,0);

1179  
VR_ERROR
;

1185 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1188 ià(
c
->
qu”ybuf
[
pos
] != '$') {

1189 
	`addR•lyE¼ÜFÜm©
(
c
,

1191 
c
->
qu”ybuf
[
pos
]);

1192 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1193  
VR_ERROR
;

1196 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+
pos
+1,
Ãwlše
-(c->qu”ybuf+pos+1),&
Î
);

1197 ià(!
ok
 || 
Î
 < 0 ||†l > 512*1024*1024) {

1198 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid bulk†ength");

1199 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1200  
VR_ERROR
;

1203 
pos
 +ğ
Ãwlše
-(
c
->
qu”ybuf
+pos)+2;

1204 ià(
Î
 >ğ
PROTO_MBULK_BIG_ARG
) {

1205 
size_t
 
qbËn
;

1212 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1213 
pos
 = 0;

1214 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1218 ià(
qbËn
 < (
size_t
)
Î
+2)

1219 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf,
Î
+2-
qbËn
);

1221 
c
->
bulkËn
 = 
Î
;

1225 ià(
	`sd¦’
(
c
->
qu”ybuf
)-
pos
 < ()(c->
bulkËn
+2)) {

1232 ià(
pos
 == 0 &&

1233 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
 &&

1234 (sigÃdè
	`sd¦’
(
c
->
qu”ybuf
è=ğc->
bulkËn
+2)

1237 
c
->
¬gv
[c->
¬gc
++] = 
	`ü—‹Objeù
(
OBJ_STRING
,c->
qu”ybuf
);

1238 
	`sdsInüL’
(
c
->
qu”ybuf
,-2);

1241 
c
->
qu”ybuf
 = 
	`sd¢ewËn
(
NULL
,c->
bulkËn
+2);

1242 
	`sdsş—r
(
c
->
qu”ybuf
);

1243 
pos
 = 0;

1245 
c
->
¬gv
[c->
¬gc
++] =

1246 
	`ü—‹SŒšgObjeù
(
c
->
qu”ybuf
+
pos
,c->
bulkËn
);

1247 
pos
 +ğ
c
->
bulkËn
+2;

1249 
c
->
bulkËn
 = -1;

1250 
c
->
muÉibulkËn
--;

1255 ià(
pos
è
	`sd¤ªge
(
c
->
qu”ybuf
,pos,-1);

1258 ià(
c
->
muÉibulkËn
 =ğ0è 
VR_OK
;

1261  
VR_ERROR
;

1262 
	}
}

1264 
	$´oûssIÅutBufãr
(
ş›Á
 *
c
) {

1265 
c
->
v–
->
cu¼’t_ş›Á
 = c;

1267 
	`sd¦’
(
c
->
qu”ybuf
)) {

1269 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
è&& 
	`ş›ÁsA»Pau£d
(c->
v–
)) ;

1272 ià(
c
->
æags
 & 
CLIENT_BLOCKED
) ;

1277 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

1280 ià(!
c
->
»qty³
) {

1281 ià(
c
->
qu”ybuf
[0] == '*') {

1283 
c
->
»qty³
 = 
PROTO_REQ_MULTIBULK
;

1285 
c
->
»qty³
 = 
PROTO_REQ_INLINE
;

1289 ià(
c
->
»qty³
 =ğ
PROTO_REQ_INLINE
) {

1290 ià(
	`´oûssIÆšeBufãr
(
c
è!ğ
VR_OK
) ;

1291 } ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
) {

1293 ià(
	`´oûssMuÉibulkBufãr
(
c
è!ğ
VR_OK
) ;

1295 
	`£rv”Pªic
("Unknown„equestype");

1300 ià(
c
->
¬gc
 == 0) {

1301 
	`»£tCl›Á
(
c
);

1305 ià(
	`´oûssCommªd
(
c
è=ğ
VR_OK
)

1306 
	`»£tCl›Á
(
c
);

1309 ià(
c
->
v–
->
cu¼’t_ş›Á
 =ğ
NULL
) ;

1314 ià(
c
->
æags
&
CLIENT_JUMP
) ;

1317 
c
->
v–
->
cu¼’t_ş›Á
 = 
NULL
;

1318 
	}
}

1321 
	$»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1322 
ş›Á
 *
c
 = (ş›Á*è
´ivd©a
;

1323 
Ä—d
, 
»adËn
;

1324 
size_t
 
qbËn
;

1325 
	`UNUSED
(
–
);

1326 
	`UNUSED
(
mask
);

1328 
»adËn
 = 
PROTO_IOBUF_LEN
;

1335 ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
 && c->
muÉibulkËn
 && c->
bulkËn
 != -1

1336 && 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
)

1338 
»maššg
 = ()(
c
->
bulkËn
+2)-
	`sd¦’
(c->
qu”ybuf
);

1340 ià(
»maššg
 < 
»adËn
)„eadlen =„emaining;

1343 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1344 ià(
c
->
qu”ybuf_³ak
 < 
qbËn
) c->querybuf_peak = qblen;

1345 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf, 
»adËn
);

1347 
Ä—d
 = 
	`vr_»ad
(
fd
, 
c
->
qu”ybuf
+
qbËn
, 
»adËn
);

1348 ià(
Ä—d
 == -1) {

1349 ià(
”ºo
 =ğ
EAGAIN
) {

1352 
	`log_debug
(
LOG_VERB
, "»adšg from cl›Á: %s",
	`¡»¼Ü
(
”ºo
));

1353 
	`ä“Cl›Á
(
c
);

1356 } ià(
Ä—d
 == 0) {

1357 
	`log_debug
(
LOG_VERB
, "client closed connection");

1358 
	`ä“Cl›Á
(
c
);

1362 
	`sdsInüL’
(
c
->
qu”ybuf
,
Ä—d
);

1363 
c
->
Ï¡š‹¿ùiÚ
 = c->
v–
->
unixtime
;

1364 ià(
c
->
æags
 & 
CLIENT_MASTER
èc->
»¶off
 +ğ
Ä—d
;

1365 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
Ãt_šput_by‹s
, 
Ä—d
);

1366 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
£rv”
.
ş›Á_max_qu”ybuf_Ën
) {

1367 
sds
 
ci
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
), 
by‹s
 = sdsempty();

1369 
by‹s
 = 
	`sdsÿŒ•r
(by‹s,
c
->
qu”ybuf
,64);

1370 
	`log_w¬n
("şosšg cl›Áh©„—ched max qu”y bufã¸Ëngth: % (qbuàš™ŸÈby‹s: %s)", 
ci
, 
by‹s
);

1371 
	`sdsä“
(
ci
);

1372 
	`sdsä“
(
by‹s
);

1373 
	`ä“Cl›Á
(
c
);

1377 
	`´oûssIÅutBufãr
(
c
);

1380 ià(
c
->
æags
&
CLIENT_JUMP
) {

1381 
	`di¥©ch_cÚn_exi¡
(
c
,c->
ridx
);

1383 
	}
}

1386 
	$g‘Cl›ÁsMaxBufãrs
(
vr_ev’oİ
 *
v–
, *
lÚge¡_ouut_li¡
,

1387 *
bigge¡_šput_bufãr
) {

1388 
ş›Á
 *
c
;

1389 
dli¡Node
 *
Ê
;

1390 
dli¡I‹r
 
li
;

1391 
lŞ
 = 0, 
bib
 = 0;

1394 
	`dli¡Rewšd
(
v–
->
ş›Ás
,&
li
);

1395 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1396 
c
 = 
	`dli¡NodeV®ue
(
Ê
);

1398 ià(
	`dli¡L’gth
(
c
->
»¶y
è> 
lŞ
)†ol = dlistLength(c->reply);

1399 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
bib
) bib = sdslen(c->querybuf);

1401 *
lÚge¡_ouut_li¡
 = 
lŞ
;

1402 *
bigge¡_šput_bufãr
 = 
bib
;

1403 
	}
}

1417 
	$g’Cl›ÁP“rId
(
ş›Á
 *ş›Á, *
³”id
,

1418 
size_t
 
³”id_Ën
) {

1419 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

1421 
	`¢´štf
(
³”id
,
³”id_Ën
,"%s:0",
£rv”
.
unixsock‘
);

1424 
	`vr_Ãt_fÜm©_³”
(
ş›Á
->
cÚn
->
sd
,
³”id
,
³”id_Ën
);

1426 
	}
}

1434 *
	$g‘Cl›ÁP“rId
(
ş›Á
 *
c
) {

1435 
³”id
[
VR_INET_PEER_ID_LEN
];

1437 ià(
c
->
³”id
 =ğ
NULL
) {

1438 
	`g’Cl›ÁP“rId
(
c
,
³”id
,(peerid));

1439 
c
->
³”id
 = 
	`sd¢ew
(peerid);

1441  
c
->
³”id
;

1442 
	}
}

1447 
sds
 
	$ÿtCl›ÁInfoSŒšg
(
sds
 
s
, 
ş›Á
 *client) {

1448 
æags
[16], 
ev’ts
[3], *
p
;

1449 
emask
;

1451 
p
 = 
æags
;

1453 ià(
ş›Á
->
æags
 & 
CLIENT_SLAVE
) {

1454 ià(
ş›Á
->
æags
 & 
CLIENT_MONITOR
)

1455 *
p
++ = 'O';

1457 *
p
++ = 'S';

1459 ià(
ş›Á
->
æags
 & 
CLIENT_MASTER
è*
p
++ = 'M';

1460 ià(
ş›Á
->
æags
 & 
CLIENT_MULTI
è*
p
++ = 'x';

1461 ià(
ş›Á
->
æags
 & 
CLIENT_BLOCKED
è*
p
++ = 'b';

1462 ià(
ş›Á
->
æags
 & 
CLIENT_DIRTY_CAS
è*
p
++ = 'd';

1463 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è*
p
++ = 'c';

1464 ià(
ş›Á
->
æags
 & 
CLIENT_UNBLOCKED
è*
p
++ = 'u';

1465 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_ASAP
è*
p
++ = 'A';

1466 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
è*
p
++ = 'U';

1467 ià(
ş›Á
->
æags
 & 
CLIENT_READONLY
è*
p
++ = 'r';

1468 ià(
p
 =ğ
æags
) *p++ = 'N';

1469 *
p
++ = '\0';

1471 
emask
 = 
ş›Á
->
cÚn
->
sd
 =ğ-1 ? 0 : 
	`«G‘FeEv’ts
(ş›Á->
v–
->
–
,client->conn->sd);

1472 
p
 = 
ev’ts
;

1473 ià(
emask
 & 
AE_READABLE
è*
p
++ = 'r';

1474 ià(
emask
 & 
AE_WRITABLE
è*
p
++ = 'w';

1475 *
p
 = '\0';

1477  
	`sdsÿtfmt
(
s
,

1479 
ş›Á
->
curidx
,

1480 (è
ş›Á
->
id
,

1481 
	`g‘Cl›ÁP“rId
(
ş›Á
),

1482 
ş›Á
->
cÚn
->
sd
,

1483 
ş›Á
->
Çme
 ? (*)ş›Á->Çme->
±r
 : "",

1484 ()(
ş›Á
->
v–
->
unixtime
 - cl›Á->
ùime
),

1485 ()(
ş›Á
->
v–
->
unixtime
 - cl›Á->
Ï¡š‹¿ùiÚ
),

1486 
æags
,

1487 
ş›Á
->
diùid
,

1488 (è
	`diùSize
(
ş›Á
->
pubsub_chªÃls
),

1489 (è
	`dli¡L’gth
(
ş›Á
->
pubsub_·‰”ns
),

1490 (
ş›Á
->
æags
 & 
CLIENT_MULTI
è? cl›Á->
m¡©e
.
couÁ
 : -1,

1491 (è
	`sd¦’
(
ş›Á
->
qu”ybuf
),

1492 (è
	`sd§va
(
ş›Á
->
qu”ybuf
),

1493 (è
ş›Á
->
buåos
,

1494 (è
	`dli¡L’gth
(
ş›Á
->
»¶y
),

1495 (è
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
),

1496 
ev’ts
,

1497 
ş›Á
->
Ï¡cmd
 ? cl›Á->Ï¡cmd->
Çme
 : "NULL");

1498 
	}
}

1501 
sds
 
	$g‘AÎCl›ÁsInfoSŒšg
(
vr_ev’oİ
 *
v–
) {

1502 
dli¡Node
 *
Ê
;

1503 
dli¡I‹r
 
li
;

1504 
ş›Á
 *client;

1505 
sds
 
o
 = 
	`sd¢ewËn
(
NULL
,200*
	`dli¡L’gth
(
v–
->
ş›Ás
));

1506 
	`sdsş—r
(
o
);

1507 
	`dli¡Rewšd
(
v–
->
ş›Ás
,&
li
);

1508 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1509 
ş›Á
 = 
	`dli¡NodeV®ue
(
Ê
);

1510 
o
 = 
	`ÿtCl›ÁInfoSŒšg
(o,
ş›Á
);

1511 
o
 = 
	`sdsÿ’
(o,"\n",1);

1513  
o
;

1514 
	}
}

1516 
	sş›Ákld©a
 {

1517 
sds
 
	maddr
;

1518 
	mty³
;

1519 
ušt64_t
 
	mid
;

1520 
	mskme
;

1521 
	mkËd
;

1522 
	mşo£_this_ş›Á
;

1525 
	$ş›ÁCommªd
(
ş›Á
 *
c
) {

1526 
dli¡Node
 *
Ê
;

1527 
dli¡I‹r
 
li
;

1528 
ş›Á
 *client;

1530 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"li¡"è&& c->
¬gc
 == 2) {

1532 
sds
 
¡r
 = 
c
->
ÿche
;

1534 
sds
 
o
 = 
	`g‘AÎCl›ÁsInfoSŒšg
(
c
->
v–
);

1536 
¡r
 = 
	`sdsÿtsds
(¡r?¡r:
	`sd£m±y
(),
o
);

1538 ià(
c
->
¡•s
 >ğ(
	`d¬¿y_n
(&
wÜk”s
) - 1)) {

1539 
	`addR•lyBulkCBufãr
(
c
,
¡r
,
	`sd¦’
(str));

1540 
c
->
¡•s
 = 0;

1541 
c
->
ridx
 = -1;

1542 
	`sdsä“
(
¡r
);

1543 
c
->
ÿche
 = 
NULL
;

1544 
c
->
æags
 &ğ~
CLIENT_JUMP
;

1546 ià(!(
c
->
æags
&
CLIENT_JUMP
))

1547 
c
->
æags
 |ğ
CLIENT_JUMP
;

1548 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

1549 
c
->
ÿche
 = 
¡r
;

1551 
	`sdsä“
(
o
);

1554 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"kill")) {

1557 
ş›Ákld©a
 *
ckd
;

1559 ià(
c
->
¡•s
 == 0) {

1560 
ckd
 = 
	`d®loc
((
ş›Ákld©a
));

1561 
ckd
->
addr
 = 
NULL
;

1562 
ckd
->
ty³
 = -1;

1563 
ckd
->
id
 = 0;

1564 
ckd
->
skme
 = 1;

1565 
ckd
->
kËd
 = 0;

1566 
ckd
->
şo£_this_ş›Á
 = 0;

1568 ià(
c
->
¬gc
 == 3) {

1570 
ckd
->
addr
 = 
	`sd¢ew
(
c
->
¬gv
[2]->
±r
);

1571 
ckd
->
skme
 = 0;

1572 } ià(
c
->
¬gc
 > 3) {

1573 
i
 = 2;

1576 
i
 < 
c
->
¬gc
) {

1577 
mÜ—rgs
 = 
c
->
¬gc
 > 
i
+1;

1579 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"id"è&& 
mÜ—rgs
) {

1580 
tmp
;

1582 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
i
+1],&
tmp
,
NULL
)

1583 !ğ
VR_OK
) {

1584 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1585 
	`dä“
(
ckd
);

1588 
ckd
->
id
 = 
tmp
;

1589 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"ty³"è&& 
mÜ—rgs
) {

1590 
ckd
->
ty³
 = 
	`g‘Cl›ÁTy³ByName
(
c
->
¬gv
[
i
+1]->
±r
);

1591 ià(
ckd
->
ty³
 == -1) {

1592 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1593 
	`dä“
(
ckd
);

1594 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown clientype '%s'",

1595 (*è
c
->
¬gv
[
i
+1]->
±r
);

1598 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"addr"è&& 
mÜ—rgs
) {

1599 
ckd
->
addr
 = 
	`sd¢ew
(
c
->
¬gv
[
i
+1]->
±r
);

1600 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"skme"è&& 
mÜ—rgs
) {

1601 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"yes")) {

1602 
ckd
->
skme
 = 1;

1603 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"no")) {

1604 
ckd
->
skme
 = 0;

1606 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1607 
	`dä“
(
ckd
);

1608 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1612 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1613 
	`dä“
(
ckd
);

1614 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1617 
i
 += 2;

1620 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1621 
	`dä“
(
ckd
);

1622 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1626 ià(!(
c
->
æags
&
CLIENT_JUMP
))

1627 
c
->
æags
 |ğ
CLIENT_JUMP
;

1628 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

1629 
c
->
ÿche
 = 
ckd
;

1631 
ckd
 = 
c
->
ÿche
;

1632 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

1637 
	`dli¡Rewšd
(
c
->
v–
->
ş›Ás
,&
li
);

1638 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

1639 
ş›Á
 = 
	`dli¡NodeV®ue
(
Ê
);

1640 ià(
ckd
->
addr
 && 
	`¡rcmp
(
	`g‘Cl›ÁP“rId
(
ş›Á
),ckd->addr) != 0) ;

1641 ià(
ckd
->
ty³
 !ğ-1 && 
	`g‘Cl›ÁTy³
(
ş›Á
) != ckd->type) ;

1642 ià(
ckd
->
id
 !ğ0 && 
ş›Á
->id != ckd->id) ;

1643 ià(
c
 =ğ
ş›Á
 && 
ckd
->
skme
) ;

1646 ià(
c
 =ğ
ş›Á
) {

1647 
ckd
->
şo£_this_ş›Á
 = 1;

1649 
	`ä“Cl›Á
(
ş›Á
);

1651 
ckd
->
kËd
++;

1654 ià(
c
->
¡•s
 >ğ(
	`d¬¿y_n
(&
wÜk”s
) - 1)) {

1656 ià(
c
->
¬gc
 == 3) {

1657 ià(
ckd
->
kËd
 == 0)

1658 
	`addR•lyE¼Ü
(
c
,"No such client");

1660 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1662 
	`addR•lyLÚgLÚg
(
c
,
ckd
->
kËd
);

1665 
c
->
¡•s
 = 0;

1666 
c
->
ridx
 = -1;

1667 
c
->
ÿche
 = 
NULL
;

1668 
c
->
æags
 &ğ~
CLIENT_JUMP
;

1672 ià(
ckd
->
şo£_this_ş›Á
è
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1674 ià(
ckd
->
addr
è
	`sdsä“
(ckd->addr);

1675 
	`dä“
(
ckd
);

1679 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£Šame"è&& c->
¬gc
 == 3) {

1680 
j
, 
Ën
 = 
	`sd¦’
(
c
->
¬gv
[2]->
±r
);

1681 *
p
 = 
c
->
¬gv
[2]->
±r
;

1685 ià(
Ën
 == 0) {

1686 ià(
c
->
Çme
è
	`ä“Objeù
(c->name);

1687 
c
->
Çme
 = 
NULL
;

1688 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1695 
j
 = 0; j < 
Ën
; j++) {

1696 ià(
p
[
j
] < '!' ||…[j] > '~') {

1697 
	`addR•lyE¼Ü
(
c
,

1703 ià(
c
->
Çme
è
	`ä“Objeù
(c->name);

1704 
c
->
Çme
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(c->
¬gv
[2]);

1705 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1707 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘Çme"è&& c->
¬gc
 == 2) {

1708 ià(
c
->
Çme
)

1709 
	`addR•lyBulk
(
c
,c->
Çme
);

1711 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1714 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL ip:port | SETNAME connection-name)");

1718 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶y"è&& c->
¬gc
 == 3) {

1720 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"on")) {

1721 
c
->
æags
 &ğ~(
CLIENT_REPLY_SKIP
|
CLIENT_REPLY_OFF
);

1722 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1723 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"off")) {

1724 
c
->
æags
 |ğ
CLIENT_REPLY_OFF
;

1725 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"skip")) {

1726 ià(!(
c
->
æags
 & 
CLIENT_REPLY_OFF
))

1727 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP_NEXT
;

1729 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1732 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"·u£"è&& c->
¬gc
 == 3) {

1733 
du¿tiÚ
;

1735 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
du¿tiÚ
,
UNIT_MILLISECONDS
)

1736 !ğ
VR_OK
) ;

1737 
	`·u£Cl›Ás
(
NULL
, 
du¿tiÚ
);

1738 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1740 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL ip:port | GETNAME | SETNAME connection-name)");

1742 
	}
}

1747 
	$»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...) {

1748 
va_li¡
 
­
;

1749 
j
;

1750 
robj
 **
¬gv
;

1752 
¬gv
 = 
	`d®loc
((
robj
*)*
¬gc
);

1753 
	`va_¡¬t
(
­
,
¬gc
);

1754 
j
 = 0; j < 
¬gc
; j++) {

1755 
robj
 *
a
;

1756 
a
 = 
	`va_¬g
(
­
, 
robj
*);

1757 
¬gv
[
j
] = 
a
;

1760 
j
 = 0; j < 
c
->
¬gc
; j++è
	`ä“Objeù
(c->
¬gv
[j]);

1761 
	`dä“
(
c
->
¬gv
);

1763 
c
->
¬gv
 =‡rgv;

1764 
c
->
¬gc
 =‡rgc;

1765 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1766 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1767 
	`va_’d
(
­
);

1768 
	}
}

1772 
	$»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
) {

1773 
	`ä“Cl›ÁArgv
(
c
);

1774 
	`dä“
(
c
->
¬gv
);

1775 
c
->
¬gv
 =‡rgv;

1776 
c
->
¬gc
 =‡rgc;

1777 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1778 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1779 
	}
}

1793 
	$»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
) {

1794 
robj
 *
Şdv®
;

1796 ià(
i
 >ğ
c
->
¬gc
) {

1797 
c
->
¬gv
 = 
	`d»®loc
(c->¬gv,(
robj
*)*(
i
+1));

1798 
c
->
¬gc
 = 
i
+1;

1799 
c
->
¬gv
[
i
] = 
NULL
;

1801 
Şdv®
 = 
c
->
¬gv
[
i
];

1802 
c
->
¬gv
[
i
] = 
Ãwv®
;

1803 ià(
Şdv®
è
	`ä“Objeù
(oldval);

1806 ià(
i
 == 0) {

1807 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1808 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1810 
	}
}

1826 
	$g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
) {

1827 
li¡_™em_size
 = (
dli¡Node
)+(
robj
);

1829  
c
->
»¶y_by‹s
 + (
li¡_™em_size
*
	`dli¡L’gth
(c->
»¶y
));

1830 
	}
}

1842 
	$g‘Cl›ÁTy³
(
ş›Á
 *
c
) {

1843 ià(
c
->
æags
 & 
CLIENT_MASTER
è 
CLIENT_TYPE_MASTER
;

1844 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
))

1845  
CLIENT_TYPE_SLAVE
;

1846 ià(
c
->
æags
 & 
CLIENT_PUBSUB
è 
CLIENT_TYPE_PUBSUB
;

1847  
CLIENT_TYPE_NORMAL
;

1848 
	}
}

1851 
	$g‘Cl›ÁTy³ByName
(*
Çme
) {

1852 ià(!
	`¡rÿ£cmp
(
Çme
,"nÜm®")è 
CLIENT_TYPE_NORMAL
;

1853 ià(!
	`¡rÿ£cmp
(
Çme
,"¦ave")è 
CLIENT_TYPE_SLAVE
;

1854 ià(!
	`¡rÿ£cmp
(
Çme
,"pubsub")è 
CLIENT_TYPE_PUBSUB
;

1855 ià(!
	`¡rÿ£cmp
(
Çme
,"ma¡”")è 
CLIENT_TYPE_MASTER
;

1857 
	}
}

1860 *
	$g‘Cl›ÁTy³Name
(
şass
) {

1861 
şass
) {

1862 
CLIENT_TYPE_NORMAL
:  "normal";

1863 
CLIENT_TYPE_SLAVE
:  "slave";

1864 
CLIENT_TYPE_PUBSUB
:  "pubsub";

1865 
CLIENT_TYPE_MASTER
:  "master";

1866 :  
NULL
;

1868 
	}
}

1877 
	$checkCl›ÁOuutBufãrLim™s
(
ş›Á
 *
c
) {

1878 
soá
 = 0, 
h¬d
 = 0, 
şass
;

1879 
u£d_mem
 = 
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

1881 
şass
 = 
	`g‘Cl›ÁTy³
(
c
);

1884 ià(
şass
 =ğ
CLIENT_TYPE_MASTER
èşas ğ
CLIENT_TYPE_NORMAL
;

1886 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 &&

1887 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
)

1888 
h¬d
 = 1;

1889 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 &&

1890 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
)

1891 
soá
 = 1;

1895 ià(
soá
) {

1897 ià(
c
->
obuf_soá_lim™_»ached_time
 == 0) {

1898 
c
->
obuf_soá_lim™_»ached_time
 = c->
v–
->
unixtime
;

1899 
soá
 = 0;

1902 
time_t
 
–­£d
 = 
c
->
v–
->
unixtime
 - c->
obuf_soá_lim™_»ached_time
;

1905 ià(
–­£d
 <=

1906 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
) {

1907 
soá
 = 0;

1914 
c
->
obuf_soá_lim™_»ached_time
 = 0;

1916  
soá
 || 
h¬d
;

1917 
	}
}

1927 
	$asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
) {

1928 
	`ASSERT
(
c
->
»¶y_by‹s
 < 
SIZE_MAX
-(1024*64));

1929 ià(
c
->
»¶y_by‹s
 =ğ0 || c->
æags
 & 
CLIENT_CLOSE_ASAP
) ;

1930 ià(
	`checkCl›ÁOuutBufãrLim™s
(
c
)) {

1931 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1933 
	`ä“Cl›ÁAsync
(
c
);

1935 
	`log_w¬n
("Cl›Á % scheduËdØbşo£d ASAP fÜ ov”comšg oàouuˆbufã¸lim™s.", 
ş›Á
);

1936 
	`sdsä“
(
ş›Á
);

1938 
	}
}

1946 
	$æushSÏvesOuutBufãrs
() {

1947 
dli¡I‹r
 
li
;

1948 
dli¡Node
 *
Ê
;

1950 
	`dli¡Rewšd
(
»¶
.
¦aves
,&
li
);

1951 (
Ê
 = 
	`dli¡Next
(&
li
))) {

1952 
ş›Á
 *
¦ave
 = 
	`dli¡NodeV®ue
(
Ê
);

1953 
ev’ts
;

1961 
ev’ts
 = 
	`«G‘FeEv’ts
(
»¶
.
v–
.
–
,
¦ave
->
cÚn
->
sd
);

1963 ià(
ev’ts
 & 
AE_WRITABLE
 &&

1964 
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

1965 
	`ş›ÁHasP’dšgR•l›s
(
¦ave
))

1967 
	`wr™eToCl›Á
(
¦ave
->
cÚn
->
sd
,slave,0);

1970 
	}
}

1990 
	$·u£Cl›Ás
(
vr_ev’oİ
 *
v–
, 
’d
) {

1991 ià(
v–
 =ğ
NULL
) ;

1993 ià(!
v–
->
ş›Ás_·u£d
 || 
’d
 > v–->
ş›Ás_·u£_’d_time
)

1994 
v–
->
ş›Ás_·u£_’d_time
 = 
’d
;

1995 
v–
->
ş›Ás_·u£d
 = 1;

1996 
	}
}

2001 
	$ş›ÁsA»Pau£d
(
vr_ev’oİ
 *
v–
) {

2002 ià(
v–
->
ş›Ás_·u£d
 &&

2003 
v–
->
ş›Ás_·u£_’d_time
 < v–->
m¡ime
)

2005 
dli¡Node
 *
Ê
;

2006 
dli¡I‹r
 
li
;

2007 
ş›Á
 *
c
;

2009 
v–
->
ş›Ás_·u£d
 = 0;

2013 
	`dli¡Rewšd
(
v–
->
ş›Ás
,&
li
);

2014 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

2015 
c
 = 
	`dli¡NodeV®ue
(
Ê
);

2019 ià(
c
->
æags
 & (
CLIENT_SLAVE
|
CLIENT_BLOCKED
)) ;

2020 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

2021 
	`dli¡AddNodeTa
(
v–
->
unblocked_ş›Ás
,
c
);

2024  
v–
->
ş›Ás_·u£d
;

2025 
	}
}

2040 
	$´oûssEv’tsWheBlocked
(
vr_ev’oİ
 *
v–
) {

2041 
™”©iÚs
 = 4;

2042 
couÁ
 = 0;

2043 
™”©iÚs
--) {

2044 
ev’ts
 = 0;

2045 
ev’ts
 +ğ
	`«ProûssEv’ts
(
v–
->
–
, 
AE_FILE_EVENTS
|
AE_DONT_WAIT
);

2046 
ev’ts
 +ğ
	`hªdËCl›ÁsW™hP’dšgWr™es
(
v–
);

2047 ià(!
ev’ts
) ;

2048 
couÁ
 +ğ
ev’ts
;

2050  
couÁ
;

2051 
	}
}

2055 
	$cu¼’t_ş›Ás
()

2057 
ccs
;

2059 #ià
	`defšed
(
__ATOMIC_RELAXED
è|| defšed(
HAVE_ATOMIC
)

2060 
ccs
 = 
	`upd©e_cu¼_ş›Ás_add
(0);

2062 
	`±h»ad_mu‹x_lock
(&
cu¼_ş›Ás_mu‹x
);

2063 
ccs
 = 
ncu¼_ccÚn
;

2064 
	`±h»ad_mu‹x_uÆock
(&
cu¼_ş›Ás_mu‹x
);

2067  
ccs
;

2068 
	}
}

	@src/vr_client.h

1 #iâdeà
_VR_CLIENT_H_


2 
	#_VR_CLIENT_H_


	)

4 
	#NET_MAX_WRITES_PER_EVENT
 (1024*64)

	)

6 
	#PROTO_MAX_QUERYBUF_LEN
 (1024*1024*1024è

	)

7 
	#PROTO_IOBUF_LEN
 (1024*16è

	)

8 
	#PROTO_REPLY_CHUNK_BYTES
 (16*1024è

	)

9 
	#PROTO_INLINE_MAX_SIZE
 (1024*64è

	)

10 
	#PROTO_MBULK_BIG_ARG
 (1024*32)

	)

13 
	#CLIENT_SLAVE
 (1<<0è

	)

14 
	#CLIENT_MASTER
 (1<<1è

	)

15 
	#CLIENT_MONITOR
 (1<<2è

	)

16 
	#CLIENT_MULTI
 (1<<3è

	)

17 
	#CLIENT_BLOCKED
 (1<<4è

	)

18 
	#CLIENT_DIRTY_CAS
 (1<<5è

	)

19 
	#CLIENT_CLOSE_AFTER_REPLY
 (1<<6è

	)

20 
	#CLIENT_UNBLOCKED
 (1<<7è

	)

22 
	#CLIENT_LUA
 (1<<8è

	)

23 
	#CLIENT_ASKING
 (1<<9è

	)

24 
	#CLIENT_CLOSE_ASAP
 (1<<10)

	)

25 
	#CLIENT_UNIX_SOCKET
 (1<<11è

	)

26 
	#CLIENT_DIRTY_EXEC
 (1<<12è

	)

27 
	#CLIENT_MASTER_FORCE_REPLY
 (1<<13è

	)

28 
	#CLIENT_FORCE_AOF
 (1<<14è

	)

29 
	#CLIENT_FORCE_REPL
 (1<<15è

	)

30 
	#CLIENT_PRE_PSYNC
 (1<<16è

	)

31 
	#CLIENT_READONLY
 (1<<17è

	)

32 
	#CLIENT_PUBSUB
 (1<<18è

	)

33 
	#CLIENT_PREVENT_AOF_PROP
 (1<<19è

	)

34 
	#CLIENT_PREVENT_REPL_PROP
 (1<<20è

	)

35 
	#CLIENT_PREVENT_PROP
 (
CLIENT_PREVENT_AOF_PROP
|
CLIENT_PREVENT_REPL_PROP
)

	)

36 
	#CLIENT_PENDING_WRITE
 (1<<21è

	)

38 
	#CLIENT_REPLY_OFF
 (1<<22è

	)

39 
	#CLIENT_REPLY_SKIP_NEXT
 (1<<23è

	)

40 
	#CLIENT_REPLY_SKIP
 (1<<24è

	)

41 
	#CLIENT_LUA_DEBUG
 (1<<25è

	)

42 
	#CLIENT_LUA_DEBUG_SYNC
 (1<<26è

	)

43 
	#CLIENT_JUMP
 (1<<27)

	)

45 
	#REDIS_REPLY_CHUNK_BYTES
 (16*1024è

	)

48 
	#PROTO_REQ_INLINE
 1

	)

49 
	#PROTO_REQ_MULTIBULK
 2

	)

53 
	#CLIENT_TYPE_NORMAL
 0

	)

54 
	#CLIENT_TYPE_SLAVE
 1

	)

55 
	#CLIENT_TYPE_PUBSUB
 2

	)

56 
	#CLIENT_TYPE_MASTER
 3

	)

57 
	#CLIENT_TYPE_OBUF_COUNT
 3

	)

63 
	#BLOCKED_NONE
 0

	)

64 
	#BLOCKED_LIST
 1

	)

65 
	#BLOCKED_WAIT
 2

	)

70 
	sş›Á
 {

72 
ušt64_t
 
	mid
;

75 
cÚn
 *
	mcÚn
;

77 
vr_ev’oİ
 *
	mv–
;

80 
»disDb
 *
	mdb
;

82 
	mdiùid
;

84 
	msÿnid
;

86 
robj
 *
	mÇme
;

88 
sds
 
	mqu”ybuf
;

90 
size_t
 
	mqu”ybuf_³ak
;

92 
	m¬gc
;

94 
robj
 **
	m¬gv
;

96 
»disCommªd
 *
	mcmd
, *
	mÏ¡cmd
;

98 
	m»qty³
;

100 
	mmuÉibulkËn
;

101 
	mbulkËn
;

103 
dli¡
 *
	m»¶y
;

105 
	m»¶y_by‹s
;

107 
size_t
 
	m£ÁËn
;

110 
time_t
 
	mùime
;

112 
time_t
 
	mÏ¡š‹¿ùiÚ
;

113 
time_t
 
	mobuf_soá_lim™_»ached_time
;

115 
	mæags
;

117 
	mauth’tiÿ‹d
;

119 
	m»¶¡©e
;

121 
	m»¶_put_Úlše_Ú_ack
;

122 
	m»¶dbfd
;

123 
off_t
 
	m»¶dboff
;

124 
off_t
 
	m»¶dbsize
;

125 
sds
 
	m»¶´—mbË
;

126 
	m»¶off
;

127 
	m»¶_ack_off
;

128 
	m»¶_ack_time
;

129 
	mpsync_š™Ÿl_off£t
;

133 
	m»¶runid
[
CONFIG_RUN_ID_SIZE
+1];

134 
	m¦ave_li¡’šg_pÜt
;

135 
	m¦ave_ÿ·
;

136 
muÉiS‹
 
	mm¡©e
;

137 
	mbty³
;

138 
blockšgS‹
 
	mbpİ
;

139 
	mwoff
;

141 
dli¡
 *
	mw©ched_keys
;

142 
diù
 *
	mpubsub_chªÃls
;

143 
dli¡
 *
	mpubsub_·‰”ns
;

144 
sds
 
	m³”id
;

147 
	mcuridx
;

148 
	mridx
;

149 
	m¡•s
;

150 *
	mÿche
;

154 
	mbuåos
;

155 
	mbuf
[
PROTO_REPLY_CHUNK_BYTES
];

156 } 
	tş›Á
;

159 
	sş›ÁBufãrLim™sCÚfig
 {

160 
	mh¬d_lim™_by‹s
;

161 
	msoá_lim™_by‹s
;

162 
time_t
 
	msoá_lim™_£cÚds
;

163 } 
	tş›ÁBufãrLim™sCÚfig
;

167 
ş›Á
 *
ü—‹Cl›Á
(
vr_ev’oİ
 *
v–
, 
cÚn
 *conn);

168 
şo£TimedoutCl›Ás
();

169 
ä“Cl›Á
(
ş›Á
 *
c
);

170 
ä“Cl›ÁAsync
(
ş›Á
 *
c
);

171 
»£tCl›Á
(
ş›Á
 *
c
);

172 
£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

173 *
addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
);

174 
£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
);

175 
´oûssIÅutBufãr
(
ş›Á
 *
c
);

176 
»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

177 
addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
);

178 
addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
);

179 
addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
);

180 
addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

181 
addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
);

182 
addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
);

183 
addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

184 
addR•lyE¼ÜL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

185 
addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
);

186 
addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
);

187 
addR•lyStusL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

188 
addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
);

189 
addR•lyDoubË
(
ş›Á
 *
c
, 
d
);

190 
addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
);

191 
addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

192 
addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
);

193 
cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
);

194 *
dupCl›ÁR•lyV®ue
(*
o
);

195 
ä“Cl›ÁR•lyV®ue
(*
o
);

196 
g‘Cl›ÁsMaxBufãrs
(
vr_ev’oİ
 *
v–
, *
lÚge¡_ouut_li¡
,

197 *
bigge¡_šput_bufãr
);

198 *
g‘Cl›ÁP“rId
(
ş›Á
 *client);

199 
sds
 
ÿtCl›ÁInfoSŒšg
(sd 
s
, 
ş›Á
 *client);

200 
sds
 
g‘AÎCl›ÁsInfoSŒšg
(
vr_ev’oİ
 *
v–
);

201 
ş›ÁCommªd
(
ş›Á
 *
c
);

202 
»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...);

203 
»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
);

204 
»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
);

205 
g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
);

206 
ä“Cl›ÁsInAsyncF»eQueue
(
vr_ev’oİ
 *
v–
);

207 
asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
);

208 
g‘Cl›ÁTy³
(
ş›Á
 *
c
);

209 
g‘Cl›ÁTy³ByName
(*
Çme
);

210 *
g‘Cl›ÁTy³Name
(
şass
);

211 
æushSÏvesOuutBufãrs
();

212 
discÚÃùSÏves
();

213 
li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
);

214 
·u£Cl›Ás
(
vr_ev’oİ
 *
v–
, 
du¿tiÚ
);

215 
ş›ÁsA»Pau£d
(
vr_ev’oİ
 *
v–
);

216 
´oûssEv’tsWheBlocked
(
vr_ev’oİ
 *
v–
);

217 
hªdËCl›ÁsW™hP’dšgWr™es
(
vr_ev’oİ
 *
v–
);

218 
ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
);

219 
uÆškCl›ÁFromEv’oİ
(
ş›Á
 *
c
);

220 
lškCl›ÁToEv’oİ
(
ş›Á
 *
c
,
vr_ev’oİ
 *
v–
);

221 
uÆškCl›Á
(
ş›Á
 *
c
);

222 
wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
);

224 #ifdeà
__GNUC__


225 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

226 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

227 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

228 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

230 
	`addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

231 
	`addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

234 
ncu¼_ccÚn
;

236 #ià
	`defšed
(
__ATOMIC_RELAXED
)

237 
	#upd©e_cu¼_ş›Ás_add
(
__n
è
	`__©omic_add_ãtch
(&
ncu¼_ccÚn
, (__n), 
__ATOMIC_RELAXED
)

	)

238 
	#upd©e_cu¼_ş›Ás_sub
(
__n
è
	`__©omic_sub_ãtch
(&
ncu¼_ccÚn
, (__n), 
__ATOMIC_RELAXED
)

	)

239 #–ià
	`defšed
(
HAVE_ATOMIC
)

240 
	#upd©e_cu¼_ş›Ás_add
(
__n
è
	`__sync_add_ªd_ãtch
(&
ncu¼_ccÚn
, (__n))

	)

241 
	#upd©e_cu¼_ş›Ás_sub
(
__n
è
	`__sync_sub_ªd_ãtch
(&
ncu¼_ccÚn
, (__n))

	)

243 
±h»ad_mu‹x_t
 
cu¼_ş›Ás_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

245 
	#upd©e_cu¼_ş›Ás_add
(
__n
) do { \

246 
	`±h»ad_mu‹x_lock
(&
cu¼_ş›Ás_mu‹x
); \

247 
ncu¼_ccÚn
 +ğ(
__n
); \

248 
	`±h»ad_mu‹x_uÆock
(&
cu¼_ş›Ás_mu‹x
); \

249 
	}
} 0)

	)

251 
	#upd©e_cu¼_ş›Ás_sub
(
__n
) do { \

252 
	`±h»ad_mu‹x_lock
(&
cu¼_ş›Ás_mu‹x
); \

253 
ncu¼_ccÚn
 -ğ(
__n
); \

254 
	`±h»ad_mu‹x_uÆock
(&
cu¼_ş›Ás_mu‹x
); \

255 } 0)

	)

258 
cu¼’t_ş›Ás
();

	@src/vr_client.h

1 #iâdeà
_VR_CLIENT_H_


2 
	#_VR_CLIENT_H_


	)

4 
	#NET_MAX_WRITES_PER_EVENT
 (1024*64)

	)

6 
	#PROTO_MAX_QUERYBUF_LEN
 (1024*1024*1024è

	)

7 
	#PROTO_IOBUF_LEN
 (1024*16è

	)

8 
	#PROTO_REPLY_CHUNK_BYTES
 (16*1024è

	)

9 
	#PROTO_INLINE_MAX_SIZE
 (1024*64è

	)

10 
	#PROTO_MBULK_BIG_ARG
 (1024*32)

	)

13 
	#CLIENT_SLAVE
 (1<<0è

	)

14 
	#CLIENT_MASTER
 (1<<1è

	)

15 
	#CLIENT_MONITOR
 (1<<2è

	)

16 
	#CLIENT_MULTI
 (1<<3è

	)

17 
	#CLIENT_BLOCKED
 (1<<4è

	)

18 
	#CLIENT_DIRTY_CAS
 (1<<5è

	)

19 
	#CLIENT_CLOSE_AFTER_REPLY
 (1<<6è

	)

20 
	#CLIENT_UNBLOCKED
 (1<<7è

	)

22 
	#CLIENT_LUA
 (1<<8è

	)

23 
	#CLIENT_ASKING
 (1<<9è

	)

24 
	#CLIENT_CLOSE_ASAP
 (1<<10)

	)

25 
	#CLIENT_UNIX_SOCKET
 (1<<11è

	)

26 
	#CLIENT_DIRTY_EXEC
 (1<<12è

	)

27 
	#CLIENT_MASTER_FORCE_REPLY
 (1<<13è

	)

28 
	#CLIENT_FORCE_AOF
 (1<<14è

	)

29 
	#CLIENT_FORCE_REPL
 (1<<15è

	)

30 
	#CLIENT_PRE_PSYNC
 (1<<16è

	)

31 
	#CLIENT_READONLY
 (1<<17è

	)

32 
	#CLIENT_PUBSUB
 (1<<18è

	)

33 
	#CLIENT_PREVENT_AOF_PROP
 (1<<19è

	)

34 
	#CLIENT_PREVENT_REPL_PROP
 (1<<20è

	)

35 
	#CLIENT_PREVENT_PROP
 (
CLIENT_PREVENT_AOF_PROP
|
CLIENT_PREVENT_REPL_PROP
)

	)

36 
	#CLIENT_PENDING_WRITE
 (1<<21è

	)

38 
	#CLIENT_REPLY_OFF
 (1<<22è

	)

39 
	#CLIENT_REPLY_SKIP_NEXT
 (1<<23è

	)

40 
	#CLIENT_REPLY_SKIP
 (1<<24è

	)

41 
	#CLIENT_LUA_DEBUG
 (1<<25è

	)

42 
	#CLIENT_LUA_DEBUG_SYNC
 (1<<26è

	)

43 
	#CLIENT_JUMP
 (1<<27)

	)

45 
	#REDIS_REPLY_CHUNK_BYTES
 (16*1024è

	)

48 
	#PROTO_REQ_INLINE
 1

	)

49 
	#PROTO_REQ_MULTIBULK
 2

	)

53 
	#CLIENT_TYPE_NORMAL
 0

	)

54 
	#CLIENT_TYPE_SLAVE
 1

	)

55 
	#CLIENT_TYPE_PUBSUB
 2

	)

56 
	#CLIENT_TYPE_MASTER
 3

	)

57 
	#CLIENT_TYPE_OBUF_COUNT
 3

	)

63 
	#BLOCKED_NONE
 0

	)

64 
	#BLOCKED_LIST
 1

	)

65 
	#BLOCKED_WAIT
 2

	)

70 
	sş›Á
 {

72 
ušt64_t
 
	mid
;

75 
cÚn
 *
	mcÚn
;

77 
vr_ev’oİ
 *
	mv–
;

80 
»disDb
 *
	mdb
;

82 
	mdiùid
;

84 
	msÿnid
;

86 
robj
 *
	mÇme
;

88 
sds
 
	mqu”ybuf
;

90 
size_t
 
	mqu”ybuf_³ak
;

92 
	m¬gc
;

94 
robj
 **
	m¬gv
;

96 
»disCommªd
 *
	mcmd
, *
	mÏ¡cmd
;

98 
	m»qty³
;

100 
	mmuÉibulkËn
;

101 
	mbulkËn
;

103 
dli¡
 *
	m»¶y
;

105 
	m»¶y_by‹s
;

107 
size_t
 
	m£ÁËn
;

110 
time_t
 
	mùime
;

112 
time_t
 
	mÏ¡š‹¿ùiÚ
;

113 
time_t
 
	mobuf_soá_lim™_»ached_time
;

115 
	mæags
;

117 
	mauth’tiÿ‹d
;

119 
	m»¶¡©e
;

121 
	m»¶_put_Úlše_Ú_ack
;

122 
	m»¶dbfd
;

123 
off_t
 
	m»¶dboff
;

124 
off_t
 
	m»¶dbsize
;

125 
sds
 
	m»¶´—mbË
;

126 
	m»¶off
;

127 
	m»¶_ack_off
;

128 
	m»¶_ack_time
;

129 
	mpsync_š™Ÿl_off£t
;

133 
	m»¶runid
[
CONFIG_RUN_ID_SIZE
+1];

134 
	m¦ave_li¡’šg_pÜt
;

135 
	m¦ave_ÿ·
;

136 
muÉiS‹
 
	mm¡©e
;

137 
	mbty³
;

138 
blockšgS‹
 
	mbpİ
;

139 
	mwoff
;

141 
dli¡
 *
	mw©ched_keys
;

142 
diù
 *
	mpubsub_chªÃls
;

143 
dli¡
 *
	mpubsub_·‰”ns
;

144 
sds
 
	m³”id
;

147 
	mcuridx
;

148 
	mridx
;

149 
	m¡•s
;

150 *
	mÿche
;

154 
	mbuåos
;

155 
	mbuf
[
PROTO_REPLY_CHUNK_BYTES
];

156 } 
	tş›Á
;

159 
	sş›ÁBufãrLim™sCÚfig
 {

160 
	mh¬d_lim™_by‹s
;

161 
	msoá_lim™_by‹s
;

162 
time_t
 
	msoá_lim™_£cÚds
;

163 } 
	tş›ÁBufãrLim™sCÚfig
;

167 
ş›Á
 *
ü—‹Cl›Á
(
vr_ev’oİ
 *
v–
, 
cÚn
 *conn);

168 
şo£TimedoutCl›Ás
();

169 
ä“Cl›Á
(
ş›Á
 *
c
);

170 
ä“Cl›ÁAsync
(
ş›Á
 *
c
);

171 
»£tCl›Á
(
ş›Á
 *
c
);

172 
£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

173 *
addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
);

174 
£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
);

175 
´oûssIÅutBufãr
(
ş›Á
 *
c
);

176 
»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

177 
addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
);

178 
addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
);

179 
addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
);

180 
addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

181 
addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
);

182 
addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
);

183 
addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

184 
addR•lyE¼ÜL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

185 
addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
);

186 
addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
);

187 
addR•lyStusL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

188 
addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
);

189 
addR•lyDoubË
(
ş›Á
 *
c
, 
d
);

190 
addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
);

191 
addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

192 
addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
);

193 
cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
);

194 *
dupCl›ÁR•lyV®ue
(*
o
);

195 
ä“Cl›ÁR•lyV®ue
(*
o
);

196 
g‘Cl›ÁsMaxBufãrs
(
vr_ev’oİ
 *
v–
, *
lÚge¡_ouut_li¡
,

197 *
bigge¡_šput_bufãr
);

198 *
g‘Cl›ÁP“rId
(
ş›Á
 *client);

199 
sds
 
ÿtCl›ÁInfoSŒšg
(sd 
s
, 
ş›Á
 *client);

200 
sds
 
g‘AÎCl›ÁsInfoSŒšg
(
vr_ev’oİ
 *
v–
);

201 
ş›ÁCommªd
(
ş›Á
 *
c
);

202 
»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...);

203 
»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
);

204 
»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
);

205 
g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
);

206 
ä“Cl›ÁsInAsyncF»eQueue
(
vr_ev’oİ
 *
v–
);

207 
asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
);

208 
g‘Cl›ÁTy³
(
ş›Á
 *
c
);

209 
g‘Cl›ÁTy³ByName
(*
Çme
);

210 *
g‘Cl›ÁTy³Name
(
şass
);

211 
æushSÏvesOuutBufãrs
();

212 
discÚÃùSÏves
();

213 
li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
);

214 
·u£Cl›Ás
(
vr_ev’oİ
 *
v–
, 
du¿tiÚ
);

215 
ş›ÁsA»Pau£d
(
vr_ev’oİ
 *
v–
);

216 
´oûssEv’tsWheBlocked
(
vr_ev’oİ
 *
v–
);

217 
hªdËCl›ÁsW™hP’dšgWr™es
(
vr_ev’oİ
 *
v–
);

218 
ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
);

219 
uÆškCl›ÁFromEv’oİ
(
ş›Á
 *
c
);

220 
lškCl›ÁToEv’oİ
(
ş›Á
 *
c
,
vr_ev’oİ
 *
v–
);

221 
uÆškCl›Á
(
ş›Á
 *
c
);

222 
wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
);

224 #ifdeà
__GNUC__


225 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

226 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

227 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

228 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

230 
	`addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

231 
	`addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

234 
ncu¼_ccÚn
;

236 #ià
	`defšed
(
__ATOMIC_RELAXED
)

237 
	#upd©e_cu¼_ş›Ás_add
(
__n
è
	`__©omic_add_ãtch
(&
ncu¼_ccÚn
, (__n), 
__ATOMIC_RELAXED
)

	)

238 
	#upd©e_cu¼_ş›Ás_sub
(
__n
è
	`__©omic_sub_ãtch
(&
ncu¼_ccÚn
, (__n), 
__ATOMIC_RELAXED
)

	)

239 #–ià
	`defšed
(
HAVE_ATOMIC
)

240 
	#upd©e_cu¼_ş›Ás_add
(
__n
è
	`__sync_add_ªd_ãtch
(&
ncu¼_ccÚn
, (__n))

	)

241 
	#upd©e_cu¼_ş›Ás_sub
(
__n
è
	`__sync_sub_ªd_ãtch
(&
ncu¼_ccÚn
, (__n))

	)

243 
±h»ad_mu‹x_t
 
cu¼_ş›Ás_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

245 
	#upd©e_cu¼_ş›Ás_add
(
__n
) do { \

246 
	`±h»ad_mu‹x_lock
(&
cu¼_ş›Ás_mu‹x
); \

247 
ncu¼_ccÚn
 +ğ(
__n
); \

248 
	`±h»ad_mu‹x_uÆock
(&
cu¼_ş›Ás_mu‹x
); \

249 
	}
} 0)

	)

251 
	#upd©e_cu¼_ş›Ás_sub
(
__n
) do { \

252 
	`±h»ad_mu‹x_lock
(&
cu¼_ş›Ás_mu‹x
); \

253 
ncu¼_ccÚn
 -ğ(
__n
); \

254 
	`±h»ad_mu‹x_uÆock
(&
cu¼_ş›Ás_mu‹x
); \

255 } 0)

	)

258 
cu¼’t_ş›Ás
();

	@src/vr_command.c

1 
	~<vr_cÜe.h
>

5 
diùTy³
 
	gcommªdTabËDiùTy³
 = {

6 
diùSdsCa£Hash
,

7 
NULL
,

8 
NULL
,

9 
diùSdsKeyCa£Com·»
,

10 
diùSdsDe¡ruùÜ
,

11 
NULL


68 
»disCommªd
 
	g»disCommªdTabË
[] = {

70 {"pšg",
pšgCommªd
,-1,"tF",0,
NULL
,0,0,0,0,0},

71 {"echo",
echoCommªd
,2,"F",0,
NULL
,0,0,0,0,0},

72 {"£Ëù",
£ËùCommªd
,2,"lF",0,
NULL
,0,0,0,0,0},

73 {"auth",
authCommªd
,2,"¦tF",0,
NULL
,0,0,0,0,0},

74 {"admš",
admšCommªd
,2,"¦tF",0,
NULL
,0,0,0,0,0},

76 {"šfo",
šfoCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

77 {"æushdb",
æushdbCommªd
,1,"w",0,
NULL
,0,0,0,0,0},

78 {"æush®l",
æush®lCommªd
,1,"w",0,
NULL
,0,0,0,0,0},

79 {"time",
timeCommªd
,1,"RF",0,
NULL
,0,0,0,0,0},

80 {"dbsize",
dbsizeCommªd
,1,"rF",0,
NULL
,0,0,0,0,0},

81 {"commªd",
commªdCommªd
,0,"É",0,
NULL
,0,0,0,0,0},

82 {"cÚfig",
cÚfigCommªd
,-2,"Ït",0,
NULL
,0,0,0,0,0},

83 {"ş›Á",
ş›ÁCommªd
,-2,"as",0,
NULL
,0,0,0,0,0},

84 {"¦owlog",
¦owlogCommªd
,-2,"a",0,
NULL
,0,0,0,0,0},

86 {"d–",
d–Commªd
,-2,"w",0,
NULL
,1,-1,1,0,0},

87 {"exi¡s",
exi¡sCommªd
,-2,"rF",0,
NULL
,1,-1,1,0,0},

88 {"‰l",
‰lCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

89 {"±",
±Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

90 {"expœe",
expœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

91 {"expœ—t",
expœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

92 {"³xpœe",
³xpœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

93 {"³xpœ—t",
³xpœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

94 {"³rsi¡",
³rsi¡Commªd
,2,"wF",0,
NULL
,1,1,1,0,0},

95 {"¿ndomkey",
¿ndomkeyCommªd
,1,"rR",0,
NULL
,0,0,0,0,0},

96 {"ty³",
ty³Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

97 {"keys",
keysCommªd
,2,"rS",0,
NULL
,0,0,0,0,0},

98 {"sÿn",
sÿnCommªd
,-2,"rR",0,
NULL
,0,0,0,0,0},

99 {"objeù",
objeùCommªd
,3,"r",0,
NULL
,2,2,2,0,0},

101 {"g‘",
g‘Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

102 {"£t",
£tCommªd
,-3,"wm",0,
NULL
,1,1,1,0,0},

103 {"£Šx",
£ŠxCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

104 {"£‹x",
£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

105 {"p£‹x",
p£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

106 {"šü",
šüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

107 {"deü",
deüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

108 {"šüby",
šübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

109 {"deüby",
deübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

110 {"­³nd",
­³ndCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

111 {"¡¾’",
¡¾’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

112 {"g‘£t",
g‘£tCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

113 {"šübyæßt",
šübyæßtCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

114 {"£tb™",
£tb™Commªd
,4,"wm",0,
NULL
,1,1,1,0,0},

115 {"g‘b™",
g‘b™Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

116 {"£Œªge",
£ŒªgeCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

117 {"g‘¿nge",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

118 {"b™couÁ",
b™couÁCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

119 {"b™pos",
b™posCommªd
,-3,"r",0,
NULL
,1,1,1,0,0},

120 {"mg‘",
mg‘Commªd
,-2,"r",0,
NULL
,1,-1,1,0,0},

121 {"m£t",
m£tCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

123 {"h£t",
h£tCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

124 {"hg‘",
hg‘Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

125 {"hËn",
hËnCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

126 {"hd–",
hd–Commªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

127 {"hexi¡s",
hexi¡sCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

128 {"hkeys",
hkeysCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

129 {"hv®s",
hv®sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

130 {"hg‘®l",
hg‘®lCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

131 {"hšüby",
hšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

132 {"hšübyæßt",
hšübyæßtCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

133 {"hmg‘",
hmg‘Commªd
,-3,"r",0,
NULL
,1,1,1,0,0},

134 {"hm£t",
hm£tCommªd
,-4,"wm",0,
NULL
,1,1,1,0,0},

135 {"h£Šx",
h£ŠxCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

136 {"h¡¾’",
h¡¾’Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

137 {"hsÿn",
hsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

139 {"½ush",
½ushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

140 {"Íush",
ÍushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

141 {"Ìªge",
ÌªgeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

142 {"½İ",
½İCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

143 {"Íİ",
ÍİCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

144 {"Î’",
Î’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

145 {"Ìem",
ÌemCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

146 {"Érim",
ÉrimCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

147 {"lšdex",
lšdexCommªd
,3,"r",0,
NULL
,1,1,1,0,0},

148 {"l£t",
l£tCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

150 {"§dd",
§ddCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

151 {"smemb”s",
smemb”sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

152 {"sÿrd",
sÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

153 {"¤em",
¤emCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

154 {"¥İ",
¥İCommªd
,-2,"wRsF",0,
NULL
,1,1,1,0,0},

155 {"sismemb”",
sismemb”Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

156 {"ssÿn",
ssÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

157 {"suniÚ",
suniÚCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

158 {"suniÚ¡Üe",
suniÚ¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

159 {"sdiff",
sdiffCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

160 {"sdiff¡Üe",
sdiff¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

161 {"sš‹r",
sš‹rCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

162 {"sš‹r¡Üe",
sš‹r¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

164 {"zadd",
zaddCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

165 {"zšüby",
zšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

166 {"z¿nge",
z¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

167 {"z»v¿nge",
z»v¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

168 {"z»m",
z»mCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

169 {"zÿrd",
zÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

170 {"zcouÁ",
zcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

171 {"z¿ngebyscÜe",
z¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

172 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

173 {"z¿nk",
z¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

174 {"z»v¿nk",
z»v¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

175 {"zscÜe",
zscÜeCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

176 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜeCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

177 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nkCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

178 {"z»m¿ngebyËx",
z»m¿ngebyËxCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

179 {"zsÿn",
zsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

181 {"pçdd",
pçddCommªd
,-2,"wmF",0,
NULL
,1,1,1,0,0},

182 {"pfcouÁ",
pfcouÁCommªd
,-2,"r",0,
NULL
,1,-1,1,0,0}

189 
	$pİuÏ‹CommªdTabË
() {

190 
j
;

192 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

195 
j
 = 0; j < 
numcommªds
; j++) {

197 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

198 *
f
 = 
c
->
sæags
;

199 
»tv®1
;

201 *
f
 != '\0') {

202 *
f
) {

203 'w': 
c
->
æags
 |ğ
CMD_WRITE
; ;

204 'r': 
c
->
æags
 |ğ
CMD_READONLY
; ;

205 'm': 
c
->
æags
 |ğ
CMD_DENYOOM
; ;

206 'a': 
c
->
æags
 |ğ
CMD_ADMIN
; ;

207 'p': 
c
->
æags
 |ğ
CMD_PUBSUB
; ;

208 's': 
c
->
æags
 |ğ
CMD_NOSCRIPT
; ;

209 'R': 
c
->
æags
 |ğ
CMD_RANDOM
; ;

210 'S': 
c
->
æags
 |ğ
CMD_SORT_FOR_SCRIPT
; ;

211 'l': 
c
->
æags
 |ğ
CMD_LOADING
; ;

212 't': 
c
->
æags
 |ğ
CMD_STALE
; ;

213 'M': 
c
->
æags
 |ğ
CMD_SKIP_MONITOR
; ;

214 'k': 
c
->
æags
 |ğ
CMD_ASKING
; ;

215 'F': 
c
->
æags
 |ğ
CMD_FAST
; ;

216 : 
	`£rv”Pªic
("Unsupported command flag"); ;

218 
f
++;

221 
»tv®1
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

222 
	`ASSERT
(
»tv®1
 =ğ
DICT_OK
);

224 
c
->
idx
 = 
j
;

226 
	}
}

229 
	$pİuÏ‹CommªdsN“dAdmš·ss
() {

230 
d¬¿y
 
commªds_Ãed_admš·ss
;

231 
sds
 *
commªd_Çme
;

232 
»disCommªd
 *
commªd
;

235 
	`d¬¿y_š™
(&
commªds_Ãed_admš·ss
,1,(
sds
));

237 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_COMMANDSNAP
,&
commªds_Ãed_admš·ss
);

239 
	`d¬¿y_n
(&
commªds_Ãed_admš·ss
)) {

241 
commªd_Çme
 = 
	`d¬¿y_pİ
(&
commªds_Ãed_admš·ss
);

244 
commªd
 = 
	`lookupCommªd
(*
commªd_Çme
);

245 ià(
commªd
 =ğ
NULL
) {

246 
	`log_”rÜ
("Unknow command %s for commands-need-amdminpass",

247 
commªd_Çme
);

248  
VR_ERROR
;

251 
commªd
->
Ãedadmš
 = 1;

252 
	`sdsä“
(*
commªd_Çme
);

254 
	`d¬¿y_deš™
(&
commªds_Ãed_admš·ss
);

256  
VR_OK
;

257 
	}
}

259 
»disCommªd
 *
	$lookupCommªd
(
sds
 
Çme
) {

260  
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

261 
	}
}

272 
»disCommªd
 *
	$lookupCommªdOrOrigš®
(
sds
 
Çme
) {

273 
»disCommªd
 *
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

275 ià(!
cmd
ècmd = 
	`diùF‘chV®ue
(
£rv”
.
Üig_commªds
,
Çme
);

276  
cmd
;

277 
	}
}

280 
»disCommªd
 *
	$lookupCommªdByCSŒšg
(*
s
) {

281 
»disCommªd
 *
cmd
;

282 
sds
 
Çme
 = 
	`sd¢ew
(
s
);

284 
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

285 
	`sdsä“
(
Çme
);

286  
cmd
;

287 
	}
}

328 
	$ÿÎ
(
ş›Á
 *
c
, 
æags
) {

329 
dœty
, 
¡¬t
, 
du¿tiÚ
;

330 
ş›Á_Şd_æags
 = 
c
->
æags
;

334 ià(
	`dli¡L’gth
(
£rv”
.
mÚ™Üs
) &&

335 !
£rv”
.
lßdšg
 &&

336 !(
c
->
cmd
->
æags
 & (
CMD_SKIP_MONITOR
|
CMD_ADMIN
)))

338 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

343 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

344 
	`»disOpA¼ayIn™
(&
£rv”
.
®so_´İag©e
);

347 
dœty
 = 
c
->
v–
->dirty;

348 
¡¬t
 = 
	`vr_u£c_now
();

349 
c
->
cmd
->
	`´oc
(c);

350 
du¿tiÚ
 = 
	`vr_u£c_now
()-
¡¬t
;

351 
dœty
 = 
c
->
v–
->dirty-dirty;

352 ià(
dœty
 < 0) dirty = 0;

356 ià(
£rv”
.
lßdšg
 && 
c
->
æags
 & 
CLIENT_LUA
)

357 
æags
 &ğ~(
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
);

362 ià(
c
->
æags
 & 
CLIENT_LUA
 && 
£rv”
.
lua_ÿÎ”
) {

363 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
)

364 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_REPL
;

365 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
)

366 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_AOF
;

371 ià(
æags
 & 
CMD_CALL_SLOWLOG
 && 
c
->
cmd
->
´oc
 !ğ
execCommªd
) {

375 
	`¦owlogPushEÁryIfN“ded
(
c
->
v–
,c->
¬gv
,c->
¬gc
,
du¿tiÚ
);

377 ià(
æags
 & 
CMD_CALL_STATS
) {

378 
commªdSts
 *
c¡©s
 = 
	`d¬¿y_g‘
(
c
->
v–
->
c¡abË
,c->
Ï¡cmd
->
idx
);

379 
c¡©s
->
miüo£cÚds
 +ğ
du¿tiÚ
;

380 
c¡©s
->
ÿÎs
++;

384 ià(
æags
 & 
CMD_CALL_PROPAGATE
 &&

385 (
c
->
æags
 & 
CLIENT_PREVENT_PROP
) != CLIENT_PREVENT_PROP)

387 
´İag©e_æags
 = 
PROPAGATE_NONE
;

391 ià(
dœty
è
´İag©e_æags
 |ğ(
PROPAGATE_AOF
|
PROPAGATE_REPL
);

395 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
è
´İag©e_æags
 |ğ
PROPAGATE_REPL
;

396 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
è
´İag©e_æags
 |ğ
PROPAGATE_AOF
;

401 ià(
c
->
æags
 & 
CLIENT_PREVENT_REPL_PROP
 ||

402 !(
æags
 & 
CMD_CALL_PROPAGATE_REPL
))

403 
´İag©e_æags
 &ğ~
PROPAGATE_REPL
;

404 ià(
c
->
æags
 & 
CLIENT_PREVENT_AOF_PROP
 ||

405 !(
æags
 & 
CMD_CALL_PROPAGATE_AOF
))

406 
´İag©e_æags
 &ğ~
PROPAGATE_AOF
;

410 ià(
´İag©e_æags
 !ğ
PROPAGATE_NONE
)

411 
	`´İag©e
(
c
->
cmd
,c->
db
->
id
,c->
¬gv
,c->
¬gc
,
´İag©e_æags
);

416 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

417 
c
->
æags
 |ğ
ş›Á_Şd_æags
 &

418 (
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

423 ià(
£rv”
.
®so_´İag©e
.
numİs
) {

424 
j
;

425 
»disOp
 *
rİ
;

427 ià(
æags
 & 
CMD_CALL_PROPAGATE
) {

428 
j
 = 0; j < 
£rv”
.
®so_´İag©e
.
numİs
; j++) {

429 
rİ
 = &
£rv”
.
®so_´İag©e
.
İs
[
j
];

430 
rg‘
 = 
rİ
->target;

432 ià(!(
æags
&
CMD_CALL_PROPAGATE_AOF
)è
rg‘
 &ğ~
PROPAGATE_AOF
;

433 ià(!(
æags
&
CMD_CALL_PROPAGATE_REPL
)è
rg‘
 &ğ~
PROPAGATE_REPL
;

434 ià(
rg‘
)

435 
	`´İag©e
(
rİ
->
cmd
,rİ->
dbid
,rİ->
¬gv
,rİ->
¬gc
,
rg‘
);

438 
	`»disOpA¼ayF»e
(&
£rv”
.
®so_´İag©e
);

440 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
numcommªds
, 1);

441 
	}
}

452 
	$´oûssCommªd
(
ş›Á
 *
c
) {

453 
maxmemÜy
;

460 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"quit")) {

461 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

462 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

463  
VR_ERROR
;

469 
c
->
cmd
 = c->
Ï¡cmd
 = 
	`lookupCommªd
(c->
¬gv
[0]->
±r
);

470 ià(!
c
->
cmd
) {

471 
	`æagT¿n§ùiÚ
(
c
);

472 
	`addR•lyE¼ÜFÜm©
(
c
,"unknown command '%s'",

473 (*)
c
->
¬gv
[0]->
±r
);

474  
VR_OK
;

475 } ià((
c
->
cmd
->
¬™y
 > 0 && c->cmd->¬™y !ğc->
¬gc
) ||

476 (
c
->
¬gc
 < -c->
cmd
->
¬™y
)) {

477 
	`æagT¿n§ùiÚ
(
c
);

478 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

479 
c
->
cmd
->
Çme
);

480  
VR_OK
;

485 ià(
c
->
v–
->
cc
.
»quœ•ass
 && !c->
auth’tiÿ‹d
 &&

486 
c
->
cmd
->
´oc
 !ğ
authCommªd
 && c->cmd->´oø!ğ
admšCommªd
)

488 
	`æagT¿n§ùiÚ
(
c
);

489 
	`addR•ly
(
c
,
sh¬ed
.
nßuth”r
);

490  
VR_OK
;

493 ià(
c
->
cmd
->
Ãedadmš
 && c->
v–
->
cc
.
admš·ss
 &&

494 
c
->
auth’tiÿ‹d
 < 2 && c->
cmd
->
´oc
 !ğ
admšCommªd
)

496 
	`æagT¿n§ùiÚ
(
c
);

497 
	`addR•ly
(
c
,
sh¬ed
.
nßdmš”r
);

498  
VR_OK
;

507 
maxmemÜy
 = 
c
->
v–
->
cc
.maxmemory;

508 ià(
maxmemÜy
) {

509 
»tv®
 = 
	`ä“MemÜyIfN“ded
(
c
->
v–
);

512 ià(
c
->
v–
->
cu¼’t_ş›Á
 =ğ
NULL
è 
VR_ERROR
;

516 ià((
c
->
cmd
->
æags
 & 
CMD_DENYOOM
è&& 
»tv®
 =ğ
VR_ERROR
) {

517 
	`æagT¿n§ùiÚ
(
c
);

518 
	`addR•ly
(
c
, 
sh¬ed
.
oom”r
);

519  
VR_OK
;

525 ià(((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

526 
£rv”
.
§v•¬am¦’
 > 0 &&

527 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
VR_ERROR
) ||

528 
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
VR_ERROR
) &&

529 
»¶
.
ma¡”ho¡
 =ğ
NULL
 &&

530 (
c
->
cmd
->
æags
 & 
CMD_WRITE
 ||

531 
c
->
cmd
->
´oc
 =ğ
pšgCommªd
))

533 
	`æagT¿n§ùiÚ
(
c
);

534 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
VR_OK
)

535 
	`addR•ly
(
c
, 
sh¬ed
.
bg§v“¼
);

537 
	`addR•lySds
(
c
,

538 
	`sdsÿrštf
(
	`sd£m±y
(),

540 
	`¡»¼Ü
(
£rv”
.
aof_Ï¡_wr™e_”ºo
)));

541  
VR_OK
;

546 ià(
»¶
.
ma¡”ho¡
 =ğ
NULL
 &&

547 
»¶
.
»¶_mš_¦aves_to_wr™e
 &&

548 
»¶
.
»¶_mš_¦aves_max_Ïg
 &&

549 
c
->
cmd
->
æags
 & 
CMD_WRITE
 &&

550 
»¶
.
»¶_good_¦aves_couÁ
 <„•l.
»¶_mš_¦aves_to_wr™e
)

552 
	`æagT¿n§ùiÚ
(
c
);

553 
	`addR•ly
(
c
, 
sh¬ed
.
nÜ•liÿ£¼
);

554  
VR_OK
;

559 ià(
»¶
.
ma¡”ho¡
 &&„•l.
»¶_¦ave_ro
 &&

560 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

561 
c
->
cmd
->
æags
 & 
CMD_WRITE
)

563 
	`addR•ly
(
c
, 
sh¬ed
.
ro¦av“¼
);

564  
VR_OK
;

568 ià(
c
->
æags
 & 
CLIENT_PUBSUB
 &&

569 
c
->
cmd
->
´oc
 !ğ
pšgCommªd
 &&

570 
c
->
cmd
->
´oc
 !ğ
subsüibeCommªd
 &&

571 
c
->
cmd
->
´oc
 !ğ
unsubsüibeCommªd
 &&

572 
c
->
cmd
->
´oc
 !ğ
psubsüibeCommªd
 &&

573 
c
->
cmd
->
´oc
 !ğ
punsubsüibeCommªd
) {

574 
	`addR•lyE¼Ü
(
c
,"only (P)SUBSCRIBE / (P)UNSUBSCRIBE / PING / QUIT‡llowed inhis context");

575  
VR_OK
;

580 ià(
»¶
.
ma¡”ho¡
 &&„•l.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
 &&

581 
»¶
.
»¶_£rve_¡®e_d©a
 == 0 &&

582 !(
c
->
cmd
->
æags
 & 
CMD_STALE
))

584 
	`æagT¿n§ùiÚ
(
c
);

585 
	`addR•ly
(
c
, 
sh¬ed
.
ma¡”dowÃ¼
);

586  
VR_OK
;

591 ià(
£rv”
.
lßdšg
 && !(
c
->
cmd
->
æags
 & 
CMD_LOADING
)) {

592 
	`addR•ly
(
c
, 
sh¬ed
.
lßdšg”r
);

593  
VR_OK
;

597 ià(
£rv”
.
lua_timedout
 &&

598 
c
->
cmd
->
´oc
 !ğ
authCommªd
 &&

599 
c
->
cmd
->
´oc
 !ğ
»¶cÚfCommªd
 &&

600 !(
c
->
cmd
->
´oc
 =ğ
shutdownCommªd
 &&

601 
c
->
¬gc
 == 2 &&

602 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'n') &&

603 !(
c
->
cmd
->
´oc
 =ğ
sütCommªd
 &&

604 
c
->
¬gc
 == 2 &&

605 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'k'))

607 
	`æagT¿n§ùiÚ
(
c
);

608 
	`addR•ly
(
c
, 
sh¬ed
.
¦owsü‹¼
);

609  
VR_OK
;

613 ià(
c
->
æags
 & 
CLIENT_MULTI
 &&

614 
c
->
cmd
->
´oc
 !ğ
execCommªd
 && c->cmd->´oø!ğ
disÿrdCommªd
 &&

615 
c
->
cmd
->
´oc
 !ğ
muÉiCommªd
 && c->cmd->´oø!ğ
w©chCommªd
)

617 
	`queueMuÉiCommªd
(
c
);

618 
	`addR•ly
(
c
,
sh¬ed
.
queued
);

620 
	`ÿÎ
(
c
,
CMD_CALL_FULL
);

621 
c
->
woff
 = 
»¶
.
ma¡”_»¶_off£t
;

622 ià(
	`dli¡L’gth
(
£rv”
.
»ady_keys
))

623 
	`hªdËCl›ÁsBlockedOnLi¡s
();

626  
VR_OK
;

627 
	}
}

632 
	$»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
) {

633 
ß
->
İs
 = 
NULL
;

634 
ß
->
numİs
 = 0;

635 
	}
}

638 
	$»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
,

639 
robj
 **
¬gv
, 
¬gc
, 
rg‘
)

641 
»disOp
 *
İ
;

643 
ß
->
İs
 = 
	`d»®loc
(ß->İs,(
»disOp
)*((
size_t
)ß->
numİs
+1));

644 
İ
 = 
ß
->
İs
+ß->
numİs
;

645 
İ
->
cmd
 = cmd;

646 
İ
->
dbid
 = dbid;

647 
İ
->
¬gv
 =‡rgv;

648 
İ
->
¬gc
 =‡rgc;

649 
İ
->
rg‘
 =arget;

650 
ß
->
numİs
++;

651  
ß
->
numİs
;

652 
	}
}

655 
	$»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
) {

656 
ß
->
numİs
) {

657 
j
;

658 
»disOp
 *
İ
;

660 
ß
->
numİs
--;

661 
İ
 = 
ß
->
İs
+ß->
numİs
;

662 
j
 = 0; j < 
İ
->
¬gc
; j++)

663 
	`deüRefCouÁ
(
İ
->
¬gv
[
j
]);

664 
	`dä“
(
İ
->
¬gv
);

666 
	`dä“
(
ß
->
İs
);

667 
	}
}

681 
	$´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

682 
æags
)

684 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
 && 
æags
 & 
PROPAGATE_AOF
)

685 
	`ãedAµ’dOÆyFe
(
cmd
,
dbid
,
¬gv
,
¬gc
);

686 ià(
æags
 & 
PROPAGATE_REPL
)

687 
	`»¶iÿtiÚF“dSÏves
(
»¶
.
¦aves
,
dbid
,
¬gv
,
¬gc
);

688 
	}
}

702 
	$®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

703 
rg‘
)

705 
robj
 **
¬gvcİy
;

706 
j
;

708 ià(
£rv”
.
lßdšg
) ;

710 
¬gvcİy
 = 
	`d®loc
((
robj
*)*(
size_t
)
¬gc
);

711 
j
 = 0; j < 
¬gc
; j++) {

712 
¬gvcİy
[
j
] = 
	`dupSŒšgObjeùUncÚ¡ªt
(
¬gv
[j]);

714 
	`»disOpA¼ayAµ’d
(&
£rv”
.
®so_´İag©e
,
cmd
,
dbid
,
¬gvcİy
,
¬gc
,
rg‘
);

715 
	}
}

720 
	$fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
) {

721 ià(
æags
 & 
PROPAGATE_REPL
è
c
->æag |ğ
CLIENT_FORCE_REPL
;

722 ià(
æags
 & 
PROPAGATE_AOF
è
c
->æag |ğ
CLIENT_FORCE_AOF
;

723 
	}
}

728 
	$´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
) {

729 
c
->
æags
 |ğ
CLIENT_PREVENT_PROP
;

730 
	}
}

733 
	$´ev’tCommªdAOF
(
ş›Á
 *
c
) {

734 
c
->
æags
 |ğ
CLIENT_PREVENT_AOF_PROP
;

735 
	}
}

738 
	$´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
) {

739 
c
->
æags
 |ğ
CLIENT_PREVENT_REPL_PROP
;

740 
	}
}

744 
	$addR•lyCommªdFÏg
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
f
, *
»¶y
) {

745 ià(
cmd
->
æags
 & 
f
) {

746 
	`addR•lyStus
(
c
, 
»¶y
);

750 
	}
}

754 
	$addR•lyCommªd
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
) {

755 ià(!
cmd
) {

756 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

759 
	`addR•lyMuÉiBulkL’
(
c
, 6);

760 
	`addR•lyBulkCSŒšg
(
c
, 
cmd
->
Çme
);

761 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
¬™y
);

763 
æagcouÁ
 = 0;

764 *
æagËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

765 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_WRITE
, "write");

766 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_READONLY
, "readonly");

767 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_DENYOOM
, "denyoom");

768 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ADMIN
, "admin");

769 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_PUBSUB
, "pubsub");

770 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_NOSCRIPT
, "noscript");

771 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_RANDOM
, "random");

772 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SORT_FOR_SCRIPT
,"sort_for_script");

773 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_LOADING
, "loading");

774 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_STALE
, "stale");

775 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SKIP_MONITOR
, "skip_monitor");

776 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ASKING
, "asking");

777 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_FAST
, "fast");

778 ià(
cmd
->
g‘keys_´oc
) {

779 
	`addR•lyStus
(
c
, "movablekeys");

780 
æagcouÁ
 += 1;

782 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
æagËn
, 
æagcouÁ
);

784 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
fœ¡key
);

785 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
Ï¡key
);

786 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
key¡•
);

788 
	}
}

792 
	$commªdCommªd
(
ş›Á
 *
c
) {

793 ià(
c
->
¬gc
 == 1) {

794 
diùI‹¿tÜ
 *
di
;

795 
diùEÁry
 *
de
;

797 
	`addR•lyMuÉiBulkL’
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

798 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
commªds
);

799 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

800 
	`addR•lyCommªd
(
c
, 
	`diùG‘V®
(
de
));

802 
	`diùR–—£I‹¿tÜ
(
di
);

803 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "info")) {

804 
i
;

805 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

806 
i
 = 2; i < 
c
->
¬gc
; i++) {

807 
	`addR•lyCommªd
(
c
, 
	`diùF‘chV®ue
(
£rv”
.
commªds
, c->
¬gv
[
i
]->
±r
));

809 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "couÁ"è&& c->
¬gc
 == 2) {

810 
	`addR•lyLÚgLÚg
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

811 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keys"è&& c->
¬gc
 >= 3) {

812 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
c
->
¬gv
[2]->
±r
);

813 *
keys
, 
numkeys
, 
j
;

815 ià(!
cmd
) {

816 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid command specified");

818 } ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
c
->
¬gc
-2) ||

819 ((
c
->
¬gc
-2è< -
cmd
->
¬™y
))

821 
	`addR•lyE¼Ü
(
c
,"Invalid‚umber of‡rguments specified for command");

825 
keys
 = 
	`g‘KeysFromCommªd
(
cmd
,
c
->
¬gv
+2,c->
¬gc
-2,&
numkeys
);

826 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

827 
j
 = 0; j < 
numkeys
; j++è
	`addR•lyBulk
(
c
,c->
¬gv
[
keys
[j]+2]);

828 
	`g‘KeysF»eResuÉ
(
keys
);

829 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "¡©s"è&& c->
¬gc
 == 2) {

830 
j
;

831 
d¬¿y
 *
c¡abË®l
;

832 
¬¿y
 *
c¡abË
 = 
c
->
v–
->cstable;

833 
commªdSts
 *
c¡©s
, *
c¡©§Î
;

835 ià(
c
->
¡•s
 == 0) {

836 
c¡abË®l
 = 
	`commªdStsTabËC»©e
();

837 ià(!(
c
->
æags
&
CLIENT_JUMP
))

838 
c
->
æags
 |ğ
CLIENT_JUMP
;

839 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

840 
c
->
ÿche
 = 
c¡abË®l
;

842 
c¡abË®l
 = 
c
->
ÿche
;

843 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

846 
j
 = 0; j < 
	`d¬¿y_n
(
c¡abË
); j ++) {

847 
c¡©s
 = 
	`d¬¿y_g‘
(
c¡abË
, 
j
);

848 ià(!
c¡©s
->
ÿÎs
) ;

850 
c¡©§Î
 = 
	`d¬¿y_g‘
(
c¡abË®l
, 
j
);

851 
c¡©§Î
->
miüo£cÚds
 +ğ
c¡©s
->microseconds;

852 
c¡©§Î
->
ÿÎs
 +ğ
c¡©s
->calls;

855 ià(
c
->
¡•s
 >ğ(
	`d¬¿y_n
(&
wÜk”s
) - 1)) {

856 
sds
 
commªd_¡©s_šfo
;

857 *
»¶yËn_node
;

858 
»¶yËn
 = 0;

860 
c
->
¡•s
 = 0;

861 
c
->
ridx
 = -1;

862 
c
->
ÿche
 = 
NULL
;

863 
c
->
æags
 &ğ~
CLIENT_JUMP
;

865 
»¶yËn_node
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

866 
j
 = 0; j < 
	`d¬¿y_n
(
c¡abË®l
); j ++) {

867 
c¡©§Î
 = 
	`d¬¿y_g‘
(
c¡abË®l
, 
j
);

868 ià(!
c¡©§Î
->
ÿÎs
) ;

870 
commªd_¡©s_šfo
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

872 
c¡©§Î
->
Çme
, c¡©§Î->
ÿÎs
, c¡©§Î->
miüo£cÚds
,

873 ()
c¡©§Î
->
miüo£cÚds
/c¡©§Î->
ÿÎs
);

874 
	`addR•lyBulkSds
(
c
,
commªd_¡©s_šfo
);

875 
»¶yËn
 ++;

878 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn_node
,
»¶yËn
);

880 
	`commªdStsTabËDe¡roy
(
c¡abË®l
);

883 
	`addR•lyE¼Ü
(
c
, "Unknown subcommand or wrong‚umber of‡rguments.");

886 
	}
}

889 
d¬¿y
 *

890 
	$commªdStsTabËC»©e
()

892 
j
;

893 
commªdSts
 *
c¡©s
;

894 
d¬¿y
 *
c¡©¡abË
;

895 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

898 
c¡©¡abË
 = 
	`d¬¿y_ü—‹
(
numcommªds
,(
commªdSts
));

899 ià(
c¡©¡abË
 =ğ
NULL
)  NULL;

900 
j
 = 0; j < 
numcommªds
; j ++) {

901 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

902 
c¡©s
 = 
	`d¬¿y_push
(
c¡©¡abË
);

903 
c¡©s
->
Çme
 = 
c
->name;

904 
c¡©s
->
miüo£cÚds
 = 0;

905 
c¡©s
->
ÿÎs
 = 0;

906 
	`ASSERT
(
j
 =ğ
c
->
idx
);

909  
c¡©¡abË
;

910 
	}
}

913 
	$commªdStsTabËDe¡roy
(
d¬¿y
 *
c¡©¡abË
)

915 
c¡©¡abË
->
ÃËm
 = 0;

916 
	`d¬¿y_de¡roy
(
c¡©¡abË
);

917 
	}
}

	@src/vr_command.c

1 
	~<vr_cÜe.h
>

5 
diùTy³
 
	gcommªdTabËDiùTy³
 = {

6 
diùSdsCa£Hash
,

7 
NULL
,

8 
NULL
,

9 
diùSdsKeyCa£Com·»
,

10 
diùSdsDe¡ruùÜ
,

11 
NULL


68 
»disCommªd
 
	g»disCommªdTabË
[] = {

70 {"pšg",
pšgCommªd
,-1,"tF",0,
NULL
,0,0,0,0,0},

71 {"echo",
echoCommªd
,2,"F",0,
NULL
,0,0,0,0,0},

72 {"£Ëù",
£ËùCommªd
,2,"lF",0,
NULL
,0,0,0,0,0},

73 {"auth",
authCommªd
,2,"¦tF",0,
NULL
,0,0,0,0,0},

74 {"admš",
admšCommªd
,2,"¦tF",0,
NULL
,0,0,0,0,0},

76 {"šfo",
šfoCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

77 {"æushdb",
æushdbCommªd
,1,"w",0,
NULL
,0,0,0,0,0},

78 {"æush®l",
æush®lCommªd
,1,"w",0,
NULL
,0,0,0,0,0},

79 {"time",
timeCommªd
,1,"RF",0,
NULL
,0,0,0,0,0},

80 {"dbsize",
dbsizeCommªd
,1,"rF",0,
NULL
,0,0,0,0,0},

81 {"commªd",
commªdCommªd
,0,"É",0,
NULL
,0,0,0,0,0},

82 {"cÚfig",
cÚfigCommªd
,-2,"Ït",0,
NULL
,0,0,0,0,0},

83 {"ş›Á",
ş›ÁCommªd
,-2,"as",0,
NULL
,0,0,0,0,0},

84 {"¦owlog",
¦owlogCommªd
,-2,"a",0,
NULL
,0,0,0,0,0},

86 {"d–",
d–Commªd
,-2,"w",0,
NULL
,1,-1,1,0,0},

87 {"exi¡s",
exi¡sCommªd
,-2,"rF",0,
NULL
,1,-1,1,0,0},

88 {"‰l",
‰lCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

89 {"±",
±Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

90 {"expœe",
expœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

91 {"expœ—t",
expœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

92 {"³xpœe",
³xpœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

93 {"³xpœ—t",
³xpœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

94 {"³rsi¡",
³rsi¡Commªd
,2,"wF",0,
NULL
,1,1,1,0,0},

95 {"¿ndomkey",
¿ndomkeyCommªd
,1,"rR",0,
NULL
,0,0,0,0,0},

96 {"ty³",
ty³Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

97 {"keys",
keysCommªd
,2,"rS",0,
NULL
,0,0,0,0,0},

98 {"sÿn",
sÿnCommªd
,-2,"rR",0,
NULL
,0,0,0,0,0},

99 {"objeù",
objeùCommªd
,3,"r",0,
NULL
,2,2,2,0,0},

101 {"g‘",
g‘Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

102 {"£t",
£tCommªd
,-3,"wm",0,
NULL
,1,1,1,0,0},

103 {"£Šx",
£ŠxCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

104 {"£‹x",
£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

105 {"p£‹x",
p£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

106 {"šü",
šüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

107 {"deü",
deüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

108 {"šüby",
šübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

109 {"deüby",
deübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

110 {"­³nd",
­³ndCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

111 {"¡¾’",
¡¾’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

112 {"g‘£t",
g‘£tCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

113 {"šübyæßt",
šübyæßtCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

114 {"£tb™",
£tb™Commªd
,4,"wm",0,
NULL
,1,1,1,0,0},

115 {"g‘b™",
g‘b™Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

116 {"£Œªge",
£ŒªgeCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

117 {"g‘¿nge",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

118 {"b™couÁ",
b™couÁCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

119 {"b™pos",
b™posCommªd
,-3,"r",0,
NULL
,1,1,1,0,0},

120 {"mg‘",
mg‘Commªd
,-2,"r",0,
NULL
,1,-1,1,0,0},

121 {"m£t",
m£tCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

123 {"h£t",
h£tCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

124 {"hg‘",
hg‘Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

125 {"hËn",
hËnCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

126 {"hd–",
hd–Commªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

127 {"hexi¡s",
hexi¡sCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

128 {"hkeys",
hkeysCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

129 {"hv®s",
hv®sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

130 {"hg‘®l",
hg‘®lCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

131 {"hšüby",
hšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

132 {"hšübyæßt",
hšübyæßtCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

133 {"hmg‘",
hmg‘Commªd
,-3,"r",0,
NULL
,1,1,1,0,0},

134 {"hm£t",
hm£tCommªd
,-4,"wm",0,
NULL
,1,1,1,0,0},

135 {"h£Šx",
h£ŠxCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

136 {"h¡¾’",
h¡¾’Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

137 {"hsÿn",
hsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

139 {"½ush",
½ushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

140 {"Íush",
ÍushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

141 {"Ìªge",
ÌªgeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

142 {"½İ",
½İCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

143 {"Íİ",
ÍİCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

144 {"Î’",
Î’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

145 {"Ìem",
ÌemCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

146 {"Érim",
ÉrimCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

147 {"lšdex",
lšdexCommªd
,3,"r",0,
NULL
,1,1,1,0,0},

148 {"l£t",
l£tCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

150 {"§dd",
§ddCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

151 {"smemb”s",
smemb”sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

152 {"sÿrd",
sÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

153 {"¤em",
¤emCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

154 {"¥İ",
¥İCommªd
,-2,"wRsF",0,
NULL
,1,1,1,0,0},

155 {"sismemb”",
sismemb”Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

156 {"ssÿn",
ssÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

157 {"suniÚ",
suniÚCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

158 {"suniÚ¡Üe",
suniÚ¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

159 {"sdiff",
sdiffCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

160 {"sdiff¡Üe",
sdiff¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

161 {"sš‹r",
sš‹rCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

162 {"sš‹r¡Üe",
sš‹r¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

164 {"zadd",
zaddCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

165 {"zšüby",
zšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

166 {"z¿nge",
z¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

167 {"z»v¿nge",
z»v¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

168 {"z»m",
z»mCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

169 {"zÿrd",
zÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

170 {"zcouÁ",
zcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

171 {"z¿ngebyscÜe",
z¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

172 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

173 {"z¿nk",
z¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

174 {"z»v¿nk",
z»v¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

175 {"zscÜe",
zscÜeCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

176 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜeCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

177 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nkCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

178 {"z»m¿ngebyËx",
z»m¿ngebyËxCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

179 {"zsÿn",
zsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

181 {"pçdd",
pçddCommªd
,-2,"wmF",0,
NULL
,1,1,1,0,0},

182 {"pfcouÁ",
pfcouÁCommªd
,-2,"r",0,
NULL
,1,-1,1,0,0}

189 
	$pİuÏ‹CommªdTabË
() {

190 
j
;

192 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

195 
j
 = 0; j < 
numcommªds
; j++) {

197 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

198 *
f
 = 
c
->
sæags
;

199 
»tv®1
;

201 *
f
 != '\0') {

202 *
f
) {

203 'w': 
c
->
æags
 |ğ
CMD_WRITE
; ;

204 'r': 
c
->
æags
 |ğ
CMD_READONLY
; ;

205 'm': 
c
->
æags
 |ğ
CMD_DENYOOM
; ;

206 'a': 
c
->
æags
 |ğ
CMD_ADMIN
; ;

207 'p': 
c
->
æags
 |ğ
CMD_PUBSUB
; ;

208 's': 
c
->
æags
 |ğ
CMD_NOSCRIPT
; ;

209 'R': 
c
->
æags
 |ğ
CMD_RANDOM
; ;

210 'S': 
c
->
æags
 |ğ
CMD_SORT_FOR_SCRIPT
; ;

211 'l': 
c
->
æags
 |ğ
CMD_LOADING
; ;

212 't': 
c
->
æags
 |ğ
CMD_STALE
; ;

213 'M': 
c
->
æags
 |ğ
CMD_SKIP_MONITOR
; ;

214 'k': 
c
->
æags
 |ğ
CMD_ASKING
; ;

215 'F': 
c
->
æags
 |ğ
CMD_FAST
; ;

216 : 
	`£rv”Pªic
("Unsupported command flag"); ;

218 
f
++;

221 
»tv®1
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

222 
	`ASSERT
(
»tv®1
 =ğ
DICT_OK
);

224 
c
->
idx
 = 
j
;

226 
	}
}

229 
	$pİuÏ‹CommªdsN“dAdmš·ss
() {

230 
d¬¿y
 
commªds_Ãed_admš·ss
;

231 
sds
 *
commªd_Çme
;

232 
»disCommªd
 *
commªd
;

235 
	`d¬¿y_š™
(&
commªds_Ãed_admš·ss
,1,(
sds
));

237 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_COMMANDSNAP
,&
commªds_Ãed_admš·ss
);

239 
	`d¬¿y_n
(&
commªds_Ãed_admš·ss
)) {

241 
commªd_Çme
 = 
	`d¬¿y_pİ
(&
commªds_Ãed_admš·ss
);

244 
commªd
 = 
	`lookupCommªd
(*
commªd_Çme
);

245 ià(
commªd
 =ğ
NULL
) {

246 
	`log_”rÜ
("Unknow command %s for commands-need-amdminpass",

247 
commªd_Çme
);

248  
VR_ERROR
;

251 
commªd
->
Ãedadmš
 = 1;

252 
	`sdsä“
(*
commªd_Çme
);

254 
	`d¬¿y_deš™
(&
commªds_Ãed_admš·ss
);

256  
VR_OK
;

257 
	}
}

259 
»disCommªd
 *
	$lookupCommªd
(
sds
 
Çme
) {

260  
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

261 
	}
}

272 
»disCommªd
 *
	$lookupCommªdOrOrigš®
(
sds
 
Çme
) {

273 
»disCommªd
 *
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

275 ià(!
cmd
ècmd = 
	`diùF‘chV®ue
(
£rv”
.
Üig_commªds
,
Çme
);

276  
cmd
;

277 
	}
}

280 
»disCommªd
 *
	$lookupCommªdByCSŒšg
(*
s
) {

281 
»disCommªd
 *
cmd
;

282 
sds
 
Çme
 = 
	`sd¢ew
(
s
);

284 
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

285 
	`sdsä“
(
Çme
);

286  
cmd
;

287 
	}
}

328 
	$ÿÎ
(
ş›Á
 *
c
, 
æags
) {

329 
dœty
, 
¡¬t
, 
du¿tiÚ
;

330 
ş›Á_Şd_æags
 = 
c
->
æags
;

334 ià(
	`dli¡L’gth
(
£rv”
.
mÚ™Üs
) &&

335 !
£rv”
.
lßdšg
 &&

336 !(
c
->
cmd
->
æags
 & (
CMD_SKIP_MONITOR
|
CMD_ADMIN
)))

338 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

343 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

344 
	`»disOpA¼ayIn™
(&
£rv”
.
®so_´İag©e
);

347 
dœty
 = 
c
->
v–
->dirty;

348 
¡¬t
 = 
	`vr_u£c_now
();

349 
c
->
cmd
->
	`´oc
(c);

350 
du¿tiÚ
 = 
	`vr_u£c_now
()-
¡¬t
;

351 
dœty
 = 
c
->
v–
->dirty-dirty;

352 ià(
dœty
 < 0) dirty = 0;

356 ià(
£rv”
.
lßdšg
 && 
c
->
æags
 & 
CLIENT_LUA
)

357 
æags
 &ğ~(
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
);

362 ià(
c
->
æags
 & 
CLIENT_LUA
 && 
£rv”
.
lua_ÿÎ”
) {

363 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
)

364 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_REPL
;

365 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
)

366 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_AOF
;

371 ià(
æags
 & 
CMD_CALL_SLOWLOG
 && 
c
->
cmd
->
´oc
 !ğ
execCommªd
) {

375 
	`¦owlogPushEÁryIfN“ded
(
c
->
v–
,c->
¬gv
,c->
¬gc
,
du¿tiÚ
);

377 ià(
æags
 & 
CMD_CALL_STATS
) {

378 
commªdSts
 *
c¡©s
 = 
	`d¬¿y_g‘
(
c
->
v–
->
c¡abË
,c->
Ï¡cmd
->
idx
);

379 
c¡©s
->
miüo£cÚds
 +ğ
du¿tiÚ
;

380 
c¡©s
->
ÿÎs
++;

384 ià(
æags
 & 
CMD_CALL_PROPAGATE
 &&

385 (
c
->
æags
 & 
CLIENT_PREVENT_PROP
) != CLIENT_PREVENT_PROP)

387 
´İag©e_æags
 = 
PROPAGATE_NONE
;

391 ià(
dœty
è
´İag©e_æags
 |ğ(
PROPAGATE_AOF
|
PROPAGATE_REPL
);

395 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
è
´İag©e_æags
 |ğ
PROPAGATE_REPL
;

396 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
è
´İag©e_æags
 |ğ
PROPAGATE_AOF
;

401 ià(
c
->
æags
 & 
CLIENT_PREVENT_REPL_PROP
 ||

402 !(
æags
 & 
CMD_CALL_PROPAGATE_REPL
))

403 
´İag©e_æags
 &ğ~
PROPAGATE_REPL
;

404 ià(
c
->
æags
 & 
CLIENT_PREVENT_AOF_PROP
 ||

405 !(
æags
 & 
CMD_CALL_PROPAGATE_AOF
))

406 
´İag©e_æags
 &ğ~
PROPAGATE_AOF
;

410 ià(
´İag©e_æags
 !ğ
PROPAGATE_NONE
)

411 
	`´İag©e
(
c
->
cmd
,c->
db
->
id
,c->
¬gv
,c->
¬gc
,
´İag©e_æags
);

416 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

417 
c
->
æags
 |ğ
ş›Á_Şd_æags
 &

418 (
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

423 ià(
£rv”
.
®so_´İag©e
.
numİs
) {

424 
j
;

425 
»disOp
 *
rİ
;

427 ià(
æags
 & 
CMD_CALL_PROPAGATE
) {

428 
j
 = 0; j < 
£rv”
.
®so_´İag©e
.
numİs
; j++) {

429 
rİ
 = &
£rv”
.
®so_´İag©e
.
İs
[
j
];

430 
rg‘
 = 
rİ
->target;

432 ià(!(
æags
&
CMD_CALL_PROPAGATE_AOF
)è
rg‘
 &ğ~
PROPAGATE_AOF
;

433 ià(!(
æags
&
CMD_CALL_PROPAGATE_REPL
)è
rg‘
 &ğ~
PROPAGATE_REPL
;

434 ià(
rg‘
)

435 
	`´İag©e
(
rİ
->
cmd
,rİ->
dbid
,rİ->
¬gv
,rİ->
¬gc
,
rg‘
);

438 
	`»disOpA¼ayF»e
(&
£rv”
.
®so_´İag©e
);

440 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
numcommªds
, 1);

441 
	}
}

452 
	$´oûssCommªd
(
ş›Á
 *
c
) {

453 
maxmemÜy
;

460 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"quit")) {

461 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

462 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

463  
VR_ERROR
;

469 
c
->
cmd
 = c->
Ï¡cmd
 = 
	`lookupCommªd
(c->
¬gv
[0]->
±r
);

470 ià(!
c
->
cmd
) {

471 
	`æagT¿n§ùiÚ
(
c
);

472 
	`addR•lyE¼ÜFÜm©
(
c
,"unknown command '%s'",

473 (*)
c
->
¬gv
[0]->
±r
);

474  
VR_OK
;

475 } ià((
c
->
cmd
->
¬™y
 > 0 && c->cmd->¬™y !ğc->
¬gc
) ||

476 (
c
->
¬gc
 < -c->
cmd
->
¬™y
)) {

477 
	`æagT¿n§ùiÚ
(
c
);

478 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

479 
c
->
cmd
->
Çme
);

480  
VR_OK
;

485 ià(
c
->
v–
->
cc
.
»quœ•ass
 && !c->
auth’tiÿ‹d
 &&

486 
c
->
cmd
->
´oc
 !ğ
authCommªd
 && c->cmd->´oø!ğ
admšCommªd
)

488 
	`æagT¿n§ùiÚ
(
c
);

489 
	`addR•ly
(
c
,
sh¬ed
.
nßuth”r
);

490  
VR_OK
;

493 ià(
c
->
cmd
->
Ãedadmš
 && c->
v–
->
cc
.
admš·ss
 &&

494 
c
->
auth’tiÿ‹d
 < 2 && c->
cmd
->
´oc
 !ğ
admšCommªd
)

496 
	`æagT¿n§ùiÚ
(
c
);

497 
	`addR•ly
(
c
,
sh¬ed
.
nßdmš”r
);

498  
VR_OK
;

507 
maxmemÜy
 = 
c
->
v–
->
cc
.maxmemory;

508 ià(
maxmemÜy
) {

509 
»tv®
 = 
	`ä“MemÜyIfN“ded
(
c
->
v–
);

512 ià(
c
->
v–
->
cu¼’t_ş›Á
 =ğ
NULL
è 
VR_ERROR
;

516 ià((
c
->
cmd
->
æags
 & 
CMD_DENYOOM
è&& 
»tv®
 =ğ
VR_ERROR
) {

517 
	`æagT¿n§ùiÚ
(
c
);

518 
	`addR•ly
(
c
, 
sh¬ed
.
oom”r
);

519  
VR_OK
;

525 ià(((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

526 
£rv”
.
§v•¬am¦’
 > 0 &&

527 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
VR_ERROR
) ||

528 
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
VR_ERROR
) &&

529 
»¶
.
ma¡”ho¡
 =ğ
NULL
 &&

530 (
c
->
cmd
->
æags
 & 
CMD_WRITE
 ||

531 
c
->
cmd
->
´oc
 =ğ
pšgCommªd
))

533 
	`æagT¿n§ùiÚ
(
c
);

534 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
VR_OK
)

535 
	`addR•ly
(
c
, 
sh¬ed
.
bg§v“¼
);

537 
	`addR•lySds
(
c
,

538 
	`sdsÿrštf
(
	`sd£m±y
(),

540 
	`¡»¼Ü
(
£rv”
.
aof_Ï¡_wr™e_”ºo
)));

541  
VR_OK
;

546 ià(
»¶
.
ma¡”ho¡
 =ğ
NULL
 &&

547 
»¶
.
»¶_mš_¦aves_to_wr™e
 &&

548 
»¶
.
»¶_mš_¦aves_max_Ïg
 &&

549 
c
->
cmd
->
æags
 & 
CMD_WRITE
 &&

550 
»¶
.
»¶_good_¦aves_couÁ
 <„•l.
»¶_mš_¦aves_to_wr™e
)

552 
	`æagT¿n§ùiÚ
(
c
);

553 
	`addR•ly
(
c
, 
sh¬ed
.
nÜ•liÿ£¼
);

554  
VR_OK
;

559 ià(
»¶
.
ma¡”ho¡
 &&„•l.
»¶_¦ave_ro
 &&

560 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

561 
c
->
cmd
->
æags
 & 
CMD_WRITE
)

563 
	`addR•ly
(
c
, 
sh¬ed
.
ro¦av“¼
);

564  
VR_OK
;

568 ià(
c
->
æags
 & 
CLIENT_PUBSUB
 &&

569 
c
->
cmd
->
´oc
 !ğ
pšgCommªd
 &&

570 
c
->
cmd
->
´oc
 !ğ
subsüibeCommªd
 &&

571 
c
->
cmd
->
´oc
 !ğ
unsubsüibeCommªd
 &&

572 
c
->
cmd
->
´oc
 !ğ
psubsüibeCommªd
 &&

573 
c
->
cmd
->
´oc
 !ğ
punsubsüibeCommªd
) {

574 
	`addR•lyE¼Ü
(
c
,"only (P)SUBSCRIBE / (P)UNSUBSCRIBE / PING / QUIT‡llowed inhis context");

575  
VR_OK
;

580 ià(
»¶
.
ma¡”ho¡
 &&„•l.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
 &&

581 
»¶
.
»¶_£rve_¡®e_d©a
 == 0 &&

582 !(
c
->
cmd
->
æags
 & 
CMD_STALE
))

584 
	`æagT¿n§ùiÚ
(
c
);

585 
	`addR•ly
(
c
, 
sh¬ed
.
ma¡”dowÃ¼
);

586  
VR_OK
;

591 ià(
£rv”
.
lßdšg
 && !(
c
->
cmd
->
æags
 & 
CMD_LOADING
)) {

592 
	`addR•ly
(
c
, 
sh¬ed
.
lßdšg”r
);

593  
VR_OK
;

597 ià(
£rv”
.
lua_timedout
 &&

598 
c
->
cmd
->
´oc
 !ğ
authCommªd
 &&

599 
c
->
cmd
->
´oc
 !ğ
»¶cÚfCommªd
 &&

600 !(
c
->
cmd
->
´oc
 =ğ
shutdownCommªd
 &&

601 
c
->
¬gc
 == 2 &&

602 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'n') &&

603 !(
c
->
cmd
->
´oc
 =ğ
sütCommªd
 &&

604 
c
->
¬gc
 == 2 &&

605 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'k'))

607 
	`æagT¿n§ùiÚ
(
c
);

608 
	`addR•ly
(
c
, 
sh¬ed
.
¦owsü‹¼
);

609  
VR_OK
;

613 ià(
c
->
æags
 & 
CLIENT_MULTI
 &&

614 
c
->
cmd
->
´oc
 !ğ
execCommªd
 && c->cmd->´oø!ğ
disÿrdCommªd
 &&

615 
c
->
cmd
->
´oc
 !ğ
muÉiCommªd
 && c->cmd->´oø!ğ
w©chCommªd
)

617 
	`queueMuÉiCommªd
(
c
);

618 
	`addR•ly
(
c
,
sh¬ed
.
queued
);

620 
	`ÿÎ
(
c
,
CMD_CALL_FULL
);

621 
c
->
woff
 = 
»¶
.
ma¡”_»¶_off£t
;

622 ià(
	`dli¡L’gth
(
£rv”
.
»ady_keys
))

623 
	`hªdËCl›ÁsBlockedOnLi¡s
();

626  
VR_OK
;

627 
	}
}

632 
	$»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
) {

633 
ß
->
İs
 = 
NULL
;

634 
ß
->
numİs
 = 0;

635 
	}
}

638 
	$»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
,

639 
robj
 **
¬gv
, 
¬gc
, 
rg‘
)

641 
»disOp
 *
İ
;

643 
ß
->
İs
 = 
	`d»®loc
(ß->İs,(
»disOp
)*((
size_t
)ß->
numİs
+1));

644 
İ
 = 
ß
->
İs
+ß->
numİs
;

645 
İ
->
cmd
 = cmd;

646 
İ
->
dbid
 = dbid;

647 
İ
->
¬gv
 =‡rgv;

648 
İ
->
¬gc
 =‡rgc;

649 
İ
->
rg‘
 =arget;

650 
ß
->
numİs
++;

651  
ß
->
numİs
;

652 
	}
}

655 
	$»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
) {

656 
ß
->
numİs
) {

657 
j
;

658 
»disOp
 *
İ
;

660 
ß
->
numİs
--;

661 
İ
 = 
ß
->
İs
+ß->
numİs
;

662 
j
 = 0; j < 
İ
->
¬gc
; j++)

663 
	`deüRefCouÁ
(
İ
->
¬gv
[
j
]);

664 
	`dä“
(
İ
->
¬gv
);

666 
	`dä“
(
ß
->
İs
);

667 
	}
}

681 
	$´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

682 
æags
)

684 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
 && 
æags
 & 
PROPAGATE_AOF
)

685 
	`ãedAµ’dOÆyFe
(
cmd
,
dbid
,
¬gv
,
¬gc
);

686 ià(
æags
 & 
PROPAGATE_REPL
)

687 
	`»¶iÿtiÚF“dSÏves
(
»¶
.
¦aves
,
dbid
,
¬gv
,
¬gc
);

688 
	}
}

702 
	$®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

703 
rg‘
)

705 
robj
 **
¬gvcİy
;

706 
j
;

708 ià(
£rv”
.
lßdšg
) ;

710 
¬gvcİy
 = 
	`d®loc
((
robj
*)*(
size_t
)
¬gc
);

711 
j
 = 0; j < 
¬gc
; j++) {

712 
¬gvcİy
[
j
] = 
	`dupSŒšgObjeùUncÚ¡ªt
(
¬gv
[j]);

714 
	`»disOpA¼ayAµ’d
(&
£rv”
.
®so_´İag©e
,
cmd
,
dbid
,
¬gvcİy
,
¬gc
,
rg‘
);

715 
	}
}

720 
	$fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
) {

721 ià(
æags
 & 
PROPAGATE_REPL
è
c
->æag |ğ
CLIENT_FORCE_REPL
;

722 ià(
æags
 & 
PROPAGATE_AOF
è
c
->æag |ğ
CLIENT_FORCE_AOF
;

723 
	}
}

728 
	$´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
) {

729 
c
->
æags
 |ğ
CLIENT_PREVENT_PROP
;

730 
	}
}

733 
	$´ev’tCommªdAOF
(
ş›Á
 *
c
) {

734 
c
->
æags
 |ğ
CLIENT_PREVENT_AOF_PROP
;

735 
	}
}

738 
	$´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
) {

739 
c
->
æags
 |ğ
CLIENT_PREVENT_REPL_PROP
;

740 
	}
}

744 
	$addR•lyCommªdFÏg
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
f
, *
»¶y
) {

745 ià(
cmd
->
æags
 & 
f
) {

746 
	`addR•lyStus
(
c
, 
»¶y
);

750 
	}
}

754 
	$addR•lyCommªd
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
) {

755 ià(!
cmd
) {

756 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

759 
	`addR•lyMuÉiBulkL’
(
c
, 6);

760 
	`addR•lyBulkCSŒšg
(
c
, 
cmd
->
Çme
);

761 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
¬™y
);

763 
æagcouÁ
 = 0;

764 *
æagËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

765 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_WRITE
, "write");

766 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_READONLY
, "readonly");

767 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_DENYOOM
, "denyoom");

768 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ADMIN
, "admin");

769 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_PUBSUB
, "pubsub");

770 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_NOSCRIPT
, "noscript");

771 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_RANDOM
, "random");

772 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SORT_FOR_SCRIPT
,"sort_for_script");

773 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_LOADING
, "loading");

774 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_STALE
, "stale");

775 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SKIP_MONITOR
, "skip_monitor");

776 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ASKING
, "asking");

777 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_FAST
, "fast");

778 ià(
cmd
->
g‘keys_´oc
) {

779 
	`addR•lyStus
(
c
, "movablekeys");

780 
æagcouÁ
 += 1;

782 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
æagËn
, 
æagcouÁ
);

784 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
fœ¡key
);

785 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
Ï¡key
);

786 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
key¡•
);

788 
	}
}

792 
	$commªdCommªd
(
ş›Á
 *
c
) {

793 ià(
c
->
¬gc
 == 1) {

794 
diùI‹¿tÜ
 *
di
;

795 
diùEÁry
 *
de
;

797 
	`addR•lyMuÉiBulkL’
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

798 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
commªds
);

799 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

800 
	`addR•lyCommªd
(
c
, 
	`diùG‘V®
(
de
));

802 
	`diùR–—£I‹¿tÜ
(
di
);

803 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "info")) {

804 
i
;

805 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

806 
i
 = 2; i < 
c
->
¬gc
; i++) {

807 
	`addR•lyCommªd
(
c
, 
	`diùF‘chV®ue
(
£rv”
.
commªds
, c->
¬gv
[
i
]->
±r
));

809 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "couÁ"è&& c->
¬gc
 == 2) {

810 
	`addR•lyLÚgLÚg
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

811 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keys"è&& c->
¬gc
 >= 3) {

812 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
c
->
¬gv
[2]->
±r
);

813 *
keys
, 
numkeys
, 
j
;

815 ià(!
cmd
) {

816 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid command specified");

818 } ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
c
->
¬gc
-2) ||

819 ((
c
->
¬gc
-2è< -
cmd
->
¬™y
))

821 
	`addR•lyE¼Ü
(
c
,"Invalid‚umber of‡rguments specified for command");

825 
keys
 = 
	`g‘KeysFromCommªd
(
cmd
,
c
->
¬gv
+2,c->
¬gc
-2,&
numkeys
);

826 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

827 
j
 = 0; j < 
numkeys
; j++è
	`addR•lyBulk
(
c
,c->
¬gv
[
keys
[j]+2]);

828 
	`g‘KeysF»eResuÉ
(
keys
);

829 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "¡©s"è&& c->
¬gc
 == 2) {

830 
j
;

831 
d¬¿y
 *
c¡abË®l
;

832 
¬¿y
 *
c¡abË
 = 
c
->
v–
->cstable;

833 
commªdSts
 *
c¡©s
, *
c¡©§Î
;

835 ià(
c
->
¡•s
 == 0) {

836 
c¡abË®l
 = 
	`commªdStsTabËC»©e
();

837 ià(!(
c
->
æags
&
CLIENT_JUMP
))

838 
c
->
æags
 |ğ
CLIENT_JUMP
;

839 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

840 
c
->
ÿche
 = 
c¡abË®l
;

842 
c¡abË®l
 = 
c
->
ÿche
;

843 
c
->
ridx
 = 
	`wÜk”_g‘_Ãxt_idx
(c->
curidx
);

846 
j
 = 0; j < 
	`d¬¿y_n
(
c¡abË
); j ++) {

847 
c¡©s
 = 
	`d¬¿y_g‘
(
c¡abË
, 
j
);

848 ià(!
c¡©s
->
ÿÎs
) ;

850 
c¡©§Î
 = 
	`d¬¿y_g‘
(
c¡abË®l
, 
j
);

851 
c¡©§Î
->
miüo£cÚds
 +ğ
c¡©s
->microseconds;

852 
c¡©§Î
->
ÿÎs
 +ğ
c¡©s
->calls;

855 ià(
c
->
¡•s
 >ğ(
	`d¬¿y_n
(&
wÜk”s
) - 1)) {

856 
sds
 
commªd_¡©s_šfo
;

857 *
»¶yËn_node
;

858 
»¶yËn
 = 0;

860 
c
->
¡•s
 = 0;

861 
c
->
ridx
 = -1;

862 
c
->
ÿche
 = 
NULL
;

863 
c
->
æags
 &ğ~
CLIENT_JUMP
;

865 
»¶yËn_node
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

866 
j
 = 0; j < 
	`d¬¿y_n
(
c¡abË®l
); j ++) {

867 
c¡©§Î
 = 
	`d¬¿y_g‘
(
c¡abË®l
, 
j
);

868 ià(!
c¡©§Î
->
ÿÎs
) ;

870 
commªd_¡©s_šfo
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

872 
c¡©§Î
->
Çme
, c¡©§Î->
ÿÎs
, c¡©§Î->
miüo£cÚds
,

873 ()
c¡©§Î
->
miüo£cÚds
/c¡©§Î->
ÿÎs
);

874 
	`addR•lyBulkSds
(
c
,
commªd_¡©s_šfo
);

875 
»¶yËn
 ++;

878 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn_node
,
»¶yËn
);

880 
	`commªdStsTabËDe¡roy
(
c¡abË®l
);

883 
	`addR•lyE¼Ü
(
c
, "Unknown subcommand or wrong‚umber of‡rguments.");

886 
	}
}

889 
d¬¿y
 *

890 
	$commªdStsTabËC»©e
()

892 
j
;

893 
commªdSts
 *
c¡©s
;

894 
d¬¿y
 *
c¡©¡abË
;

895 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

898 
c¡©¡abË
 = 
	`d¬¿y_ü—‹
(
numcommªds
,(
commªdSts
));

899 ià(
c¡©¡abË
 =ğ
NULL
)  NULL;

900 
j
 = 0; j < 
numcommªds
; j ++) {

901 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

902 
c¡©s
 = 
	`d¬¿y_push
(
c¡©¡abË
);

903 
c¡©s
->
Çme
 = 
c
->name;

904 
c¡©s
->
miüo£cÚds
 = 0;

905 
c¡©s
->
ÿÎs
 = 0;

906 
	`ASSERT
(
j
 =ğ
c
->
idx
);

909  
c¡©¡abË
;

910 
	}
}

913 
	$commªdStsTabËDe¡roy
(
d¬¿y
 *
c¡©¡abË
)

915 
c¡©¡abË
->
ÃËm
 = 0;

916 
	`d¬¿y_de¡roy
(
c¡©¡abË
);

917 
	}
}

	@src/vr_command.h

1 #iâdeà
_VR_COMMAND_H_


2 
	#_VR_COMMAND_H_


	)

8 
	#CMD_WRITE
 1

	)

9 
	#CMD_READONLY
 2

	)

10 
	#CMD_DENYOOM
 4

	)

11 
	#CMD_NOT_USED_1
 8

	)

12 
	#CMD_ADMIN
 16

	)

13 
	#CMD_PUBSUB
 32

	)

14 
	#CMD_NOSCRIPT
 64

	)

15 
	#CMD_RANDOM
 128

	)

16 
	#CMD_SORT_FOR_SCRIPT
 256

	)

17 
	#CMD_LOADING
 512

	)

18 
	#CMD_STALE
 1024

	)

19 
	#CMD_SKIP_MONITOR
 2048

	)

20 
	#CMD_ASKING
 4096

	)

21 
	#CMD_FAST
 8192

	)

25 
	#CMD_CALL_NONE
 0

	)

26 
	#CMD_CALL_SLOWLOG
 (1<<0)

	)

27 
	#CMD_CALL_STATS
 (1<<1)

	)

28 
	#CMD_CALL_PROPAGATE_AOF
 (1<<2)

	)

29 
	#CMD_CALL_PROPAGATE_REPL
 (1<<3)

	)

30 
	#CMD_CALL_PROPAGATE
 (
CMD_CALL_PROPAGATE_AOF
|
CMD_CALL_PROPAGATE_REPL
)

	)

31 
	#CMD_CALL_FULL
 (
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
 | 
CMD_CALL_PROPAGATE
)

	)

35 
	#PROPAGATE_NONE
 0

	)

36 
	#PROPAGATE_AOF
 1

	)

37 
	#PROPAGATE_REPL
 2

	)

41 
	#SHUTDOWN_NOFLAGS
 0

	)

42 
	#SHUTDOWN_SAVE
 1

	)

44 
	#SHUTDOWN_NOSAVE
 2

	)

47 
	t»disCommªdProc
(
	tş›Á
 *
	tc
);

48 *
	t»disG‘KeysProc
(
	t»disCommªd
 *
	tcmd
, 
	trobj
 **
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

50 
	s»disCommªd
 {

52 *
	mÇme
;

54 
»disCommªdProc
 *
	m´oc
;

56 
	m¬™y
;

58 *
	msæags
;

60 
	mæags
;

64 
»disG‘KeysProc
 *
	mg‘keys_´oc
;

67 
	mfœ¡key
;

69 
	mÏ¡key
;

71 
	mkey¡•
;

72 
	midx
;

74 
	mÃedadmš
;

78 
	scommªdSts
 {

80 *
	mÇme
;

82 
	mmiüo£cÚds
;

84 
	mÿÎs
;

85 }
	tcommªdSts
;

94 
	s»disOp
 {

96 
robj
 **
	m¬gv
;

98 
	m¬gc
, 
	mdbid
, 
	mrg‘
;

100 
»disCommªd
 *
	mcmd
;

101 } 
	t»disOp
;

111 
	s»disOpA¼ay
 {

112 
»disOp
 *
	mİs
;

114 
	mnumİs
;

115 } 
	t»disOpA¼ay
;

118 
diùTy³
 
commªdTabËDiùTy³
;

121 
pİuÏ‹CommªdTabË
();

123 
pİuÏ‹CommªdsN“dAdmš·ss
();

126 
»disCommªd
 *
lookupCommªd
(
sds
 
Çme
);

128 
»disCommªd
 *
lookupCommªdOrOrigš®
(
sds
 
Çme
);

130 
»disCommªd
 *
lookupCommªdByCSŒšg
(*
s
);

133 
ÿÎ
(
ş›Á
 *
c
, 
æags
);

135 
´oûssCommªd
(
ş›Á
 *
c
);

138 
»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
);

139 
»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

140 
»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
);

142 
´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
æags
);

143 
®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

144 
fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
);

145 
´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
);

146 
´ev’tCommªdAOF
(
ş›Á
 *
c
);

147 
´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
);

149 
commªdCommªd
(
ş›Á
 *
c
);

151 
d¬¿y
 *
commªdStsTabËC»©e
();

152 
commªdStsTabËDe¡roy
(
d¬¿y
 *
c¡©¡abË
);

	@src/vr_command.h

1 #iâdeà
_VR_COMMAND_H_


2 
	#_VR_COMMAND_H_


	)

8 
	#CMD_WRITE
 1

	)

9 
	#CMD_READONLY
 2

	)

10 
	#CMD_DENYOOM
 4

	)

11 
	#CMD_NOT_USED_1
 8

	)

12 
	#CMD_ADMIN
 16

	)

13 
	#CMD_PUBSUB
 32

	)

14 
	#CMD_NOSCRIPT
 64

	)

15 
	#CMD_RANDOM
 128

	)

16 
	#CMD_SORT_FOR_SCRIPT
 256

	)

17 
	#CMD_LOADING
 512

	)

18 
	#CMD_STALE
 1024

	)

19 
	#CMD_SKIP_MONITOR
 2048

	)

20 
	#CMD_ASKING
 4096

	)

21 
	#CMD_FAST
 8192

	)

25 
	#CMD_CALL_NONE
 0

	)

26 
	#CMD_CALL_SLOWLOG
 (1<<0)

	)

27 
	#CMD_CALL_STATS
 (1<<1)

	)

28 
	#CMD_CALL_PROPAGATE_AOF
 (1<<2)

	)

29 
	#CMD_CALL_PROPAGATE_REPL
 (1<<3)

	)

30 
	#CMD_CALL_PROPAGATE
 (
CMD_CALL_PROPAGATE_AOF
|
CMD_CALL_PROPAGATE_REPL
)

	)

31 
	#CMD_CALL_FULL
 (
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
 | 
CMD_CALL_PROPAGATE
)

	)

35 
	#PROPAGATE_NONE
 0

	)

36 
	#PROPAGATE_AOF
 1

	)

37 
	#PROPAGATE_REPL
 2

	)

41 
	#SHUTDOWN_NOFLAGS
 0

	)

42 
	#SHUTDOWN_SAVE
 1

	)

44 
	#SHUTDOWN_NOSAVE
 2

	)

47 
	t»disCommªdProc
(
	tş›Á
 *
	tc
);

48 *
	t»disG‘KeysProc
(
	t»disCommªd
 *
	tcmd
, 
	trobj
 **
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

50 
	s»disCommªd
 {

52 *
	mÇme
;

54 
»disCommªdProc
 *
	m´oc
;

56 
	m¬™y
;

58 *
	msæags
;

60 
	mæags
;

64 
»disG‘KeysProc
 *
	mg‘keys_´oc
;

67 
	mfœ¡key
;

69 
	mÏ¡key
;

71 
	mkey¡•
;

72 
	midx
;

74 
	mÃedadmš
;

78 
	scommªdSts
 {

80 *
	mÇme
;

82 
	mmiüo£cÚds
;

84 
	mÿÎs
;

85 }
	tcommªdSts
;

94 
	s»disOp
 {

96 
robj
 **
	m¬gv
;

98 
	m¬gc
, 
	mdbid
, 
	mrg‘
;

100 
»disCommªd
 *
	mcmd
;

101 } 
	t»disOp
;

111 
	s»disOpA¼ay
 {

112 
»disOp
 *
	mİs
;

114 
	mnumİs
;

115 } 
	t»disOpA¼ay
;

118 
diùTy³
 
commªdTabËDiùTy³
;

121 
pİuÏ‹CommªdTabË
();

123 
pİuÏ‹CommªdsN“dAdmš·ss
();

126 
»disCommªd
 *
lookupCommªd
(
sds
 
Çme
);

128 
»disCommªd
 *
lookupCommªdOrOrigš®
(
sds
 
Çme
);

130 
»disCommªd
 *
lookupCommªdByCSŒšg
(*
s
);

133 
ÿÎ
(
ş›Á
 *
c
, 
æags
);

135 
´oûssCommªd
(
ş›Á
 *
c
);

138 
»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
);

139 
»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

140 
»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
);

142 
´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
æags
);

143 
®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

144 
fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
);

145 
´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
);

146 
´ev’tCommªdAOF
(
ş›Á
 *
c
);

147 
´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
);

149 
commªdCommªd
(
ş›Á
 *
c
);

151 
d¬¿y
 *
commªdStsTabËC»©e
();

152 
commªdStsTabËDe¡roy
(
d¬¿y
 *
c¡©¡abË
);

	@src/vr_conf.c

1 
	~<fú.h
>

3 
	~<vr_cÜe.h
>

5 cÚ¡ *(*
	tcÚfigEnumG‘SŒFun
)(
	tty³
);

7 
	#CONF_TOKEN_ORGANIZATION_START
 "["

	)

8 
	#CONF_TOKEN_ORGANIZATION_END
 "]"

	)

9 
	#CONF_TOKEN_KEY_VALUE_BETWEEN
 ":"

	)

10 
	#CONF_TOKEN_ARRAY_START
 "-"

	)

12 
	#CONF_ORGANIZATION_NAME_COMMAN
 "commÚ"

	)

13 
	#CONF_ORGANIZATION_NAME_SERVER
 "£rv”"

	)

15 
	#CONF_VALUE_YES
 "yes"

	)

16 
	#CONF_VALUE_NO
 "no"

	)

18 
	#CONF_MAX_LINE
 1024

	)

20 
	#CONF_TAG_DEFAULT_TYPE
 
GROUP_TYPE_SINGLE


	)

21 
	#CONF_TAG_DEFAULT_HASH
 
HASH_FNV1_64


	)

22 
	#CONF_TAG_DEFAULT_HASH_TAG
 
NULL


	)

23 
	#CONF_TAG_DEFAULT_DISTRIBUTION
 "k‘ama"

	)

24 
	#CONF_TAG_DEFAULT_REDIS_AUTH
 
NULL


	)

25 
	#CONF_TAG_DEFAULT_REDIS_DB
 0

	)

26 
	#CONF_TAG_DEFAULT_TIMEOUT
 300

	)

27 
	#CONF_TAG_DEFAULT_SERVERS
 "127.0.0.1:6379"

	)

28 
	#CONF_TAG_DEFAULT_LISTEN
 "127.0.0.1:6380"

	)

29 
	#CONF_TAG_DEFAULT_MAXMEMORY
 1073741824

30 
	#CONF_TAG_DEFAULT_THREADS
 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)

	)

31 
	#CONF_TAG_DEFAULT_NOREPLY
 "çl£"

	)

32 
	#CONF_TAG_DEFAULT_RDB_DISKLESS
 "çl£"

	)

34 
	#DEFINE_ACTION
(
_hash
, 
_Çme
è(*)(#_Çme),

	)

35 * 
	ghash_¡ršgs
[] = {

36 
HASH_CODEC
Ğ
DEFINE_ACTION
 )

37 
NULL


39 #undeà
DEFINE_ACTION


41 
	#DEFINE_ACTION
(
_di¡
, 
_Çme
è(*)(#_Çme),

	)

42 * 
	gdi¡_¡ršgs
[] = {

43 
DIST_CODEC
Ğ
DEFINE_ACTION
 )

44 
NULL


46 #undeà
DEFINE_ACTION


48 
	#DEFINE_ACTION
(
_pŞicy
, 
_Çme
è(*)(#_Çme),

	)

50 * 
	geviùpŞicy_¡ršgs
[] = {

51 
EVICTPOLICY_CODEC
Ğ
DEFINE_ACTION
 )

52 
NULL


54 #undeà
DEFINE_ACTION


56 
cÚf_İtiÚ
 
	gcÚf_£rv”_İtiÚs
[] = {

57 { (*)
CONFIG_SOPN_DATABASES
,

58 
CONF_FIELD_TYPE_INT
, 1,

59 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

60 
off£tof
(
cÚf_£rv”
, 
d©aba£s
) },

61 { (*)
CONFIG_SOPN_IDPDATABASE
,

62 
CONF_FIELD_TYPE_INT
, 1,

63 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

64 
off£tof
(
cÚf_£rv”
, 
š‹º®_dbs_³r_d©aba£s
) },

65 { (*)
CONFIG_SOPN_MAXMEMORY
,

66 
CONF_FIELD_TYPE_LONGLONG
, 0,

67 
cÚf_£t_maxmemÜy
, 
cÚf_g‘_lÚglÚg
,

68 
off£tof
(
cÚf_£rv”
, 
maxmemÜy
) },

69 { (*)
CONFIG_SOPN_MAXMEMORYP
,

70 
CONF_FIELD_TYPE_INT
, 0,

71 
cÚf_£t_maxmemÜy_pŞicy
, 
cÚf_g‘_št
,

72 
off£tof
(
cÚf_£rv”
, 
maxmemÜy_pŞicy
) },

73 { (*)
CONFIG_SOPN_MAXMEMORYS
,

74 
CONF_FIELD_TYPE_INT
, 0,

75 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

76 
off£tof
(
cÚf_£rv”
, 
maxmemÜy_§m¶es
) },

77 { (*)
CONFIG_SOPN_MTCLIMIT
,

78 
CONF_FIELD_TYPE_LONGLONG
, 0,

79 
cÚf_£t_lÚglÚg
, 
cÚf_g‘_lÚglÚg
,

80 
off£tof
(
cÚf_£rv”
, 
max_time_com¶ex™y_lim™
) },

81 { (*)
CONFIG_SOPN_BIND
,

82 
CONF_FIELD_TYPE_ARRAYSDS
, 1,

83 
cÚf_£t_¬¿y_sds
, 
cÚf_g‘_¬¿y_sds
,

84 
off£tof
(
cÚf_£rv”
, 
bšds
) },

85 { (*)
CONFIG_SOPN_PORT
,

86 
CONF_FIELD_TYPE_INT
, 1,

87 
cÚf_£t_št
, 
cÚf_g‘_št
,

88 
off£tof
(
cÚf_£rv”
, 
pÜt
) },

89 { (*)
CONFIG_SOPN_THREADS
,

90 
CONF_FIELD_TYPE_INT
, 1,

91 
cÚf_£t_št
, 
cÚf_g‘_št
,

92 
off£tof
(
cÚf_£rv”
, 
th»ads
) },

93 { (*)
CONFIG_SOPN_MAXCLIENTS
,

94 
CONF_FIELD_TYPE_INT
, 0,

95 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

96 
off£tof
(
cÚf_£rv”
, 
maxş›Ás
) },

97 { (*)
CONFIG_SOPN_SLOWLOGLST
,

98 
CONF_FIELD_TYPE_LONGLONG
, 0,

99 
cÚf_£t_lÚglÚg
, 
cÚf_g‘_lÚglÚg
,

100 
off£tof
(
cÚf_£rv”
, 
¦owlog_log_¦ow”_thª
) },

101 { (*)
CONFIG_SOPN_SLOWLOGML
,

102 
CONF_FIELD_TYPE_INT
, 0,

103 
cÚf_£t_št
, 
cÚf_g‘_št
,

104 
off£tof
(
cÚf_£rv”
, 
¦owlog_max_Ën
) },

105 { (*)
CONFIG_SOPN_REQUIREPASS
,

106 
CONF_FIELD_TYPE_SDS
, 0,

107 
cÚf_£t_·sswÜd
, 
cÚf_g‘_sds
,

108 
off£tof
(
cÚf_£rv”
, 
»quœ•ass
) },

109 { (*)
CONFIG_SOPN_ADMINPASS
,

110 
CONF_FIELD_TYPE_SDS
, 0,

111 
cÚf_£t_·sswÜd
, 
cÚf_g‘_sds
,

112 
off£tof
(
cÚf_£rv”
, 
admš·ss
) },

113 { (*)
CONFIG_SOPN_COMMANDSNAP
,

114 
CONF_FIELD_TYPE_ARRAYSDS
, 1,

115 
cÚf_£t_commªds_Ãed_admš·ss
, 
cÚf_g‘_¬¿y_sds
,

116 
off£tof
(
cÚf_£rv”
, 
commªds_Ãed_admš·ss
) },

117 { 
NULL
, NULL, 0 }

120 
vr_cÚf
 *
	gcÚf
 = 
NULL
;

121 
cÚf_£rv”
 *
	gc£rv”
 = 
NULL
;

124 
	$cÚf_v®ue_dump
(
cÚf_v®ue
 *
cv
, 
log_Ëv–
)

126 
ušt32_t
 
i
;

127 
cÚf_v®ue
 **
cv_sub
;

129 if(
cv
 =ğ
NULL
){

133 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
){

134 
	`log_debug
(
log_Ëv–
, "%.*s", 
	`sd¦’
(
cv
->
v®ue
), cv->value);

135 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

136 
i
 = 0; i < 
	`d¬¿y_n
(
cv
->
v®ue
); i++){

137 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
i
);

138 
	`cÚf_v®ue_dump
(*
cv_sub
, 
log_Ëv–
);

141 
	`NOT_REACHED
();

143 
	}
}

147 
	$cÚf_Ügªiz©iÚ_dump
(
sds
 
Çme
, 
diù
 *
Üg
, 
log_Ëv–
)

149 
diùI‹¿tÜ
 *
di
;

150 
diùEÁry
 *
de
;

151 
sds
 
key
;

152 
cÚf_v®ue
 *
cv
;

154 if(
Çme
 =ğ
NULL
 || 
Üg
 == NULL){

158 
	`log_debug
(
log_Ëv–
, "[%.*s]", 
	`sd¦’
(
Çme
),‚ame);

160 
di
 = 
	`diùG‘I‹¿tÜ
(
Üg
);

162 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
){

163 
key
 = 
	`diùG‘Key
(
de
);

164 
cv
 = 
	`diùG‘V®
(
de
);

166 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
){

167 
	`log_debug
(
log_Ëv–
, "%.*s: %.*s",

168 
	`sd¦’
(
key
), key,

169 
	`sd¦’
(
cv
->
v®ue
), cv->value);

170 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

171 
	`log_debug
(
log_Ëv–
, "%.*s:",
	`sd¦’
(
key
), key);

172 
	`cÚf_v®ue_dump
(
cv
, 
log_Ëv–
);

174 
	`NOT_REACHED
();

178 
	`diùR–—£I‹¿tÜ
(
di
);

179 
	}
}

182 
	$cÚf_Ügªiz©iÚs_dump
(
vr_cÚf
 *
cf
)

184 
diù
 *
Ügs
, *
Üg
;

185 
diùI‹¿tÜ
 *
di
;

186 
diùEÁry
 *
de
;

187 
sds
 
Çme
;

188 
log_Ëv–
 = 
LOG_VERB
;

190 if(
cf
 =ğ
NULL
){

194 
Ügs
 = 
cf
->
Ügªiz©iÚs
;

195 if(
Ügs
 =ğ
NULL
){

196 
	`log_debug
(
log_Ëv–
, "organization is NULL");

200 
di
 = 
	`diùG‘I‹¿tÜ
(
Ügs
);

202 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
){

203 
Çme
 = 
	`diùG‘Key
(
de
);

204 
Üg
 = 
	`diùG‘V®
(
de
);

206 
	`cÚf_Ügªiz©iÚ_dump
(
Çme
, 
Üg
, 
log_Ëv–
);

207 
	`log_debug
(
log_Ëv–
, "");

210 
	`diùR–—£I‹¿tÜ
(
di
);

211 
	}
}

215 
	$cÚf_£t_maxmemÜy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

217 
ušt8_t
 *
p
;

218 
cÚf_v®ue
 *
cv
 = 
d©a
;

219 
v®ue
;

220 *
gt
;

221 
”r
;

223 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

224 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

225 
İt
->
Çme
);

226  
VR_ERROR
;

229 
	`CONF_WLOCK
();

231 
p
 = 
obj
;

232 
gt
 = (*)(
p
 + 
İt
->
off£t
);

234 
v®ue
 = 
	`memtŞl
(
cv
->v®ue, &
”r
);

235 if(
”r
 !ğ0 || 
v®ue
 < 0){

236 
	`CONF_UNLOCK
();

237 
	`log_”rÜ
("value forhe key %s in conf file is invalid",

238 
İt
->
Çme
);

239  
VR_ERROR
;

242 *
gt
 = 
v®ue
;

243 
cÚf
->
v”siÚ
 ++;

244 
	`CONF_UNLOCK
();

245  
VR_OK
;

246 
	}
}

249 
	$cÚf_£t_maxmemÜy_pŞicy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

251 
ušt8_t
 *
p
;

252 
cÚf_v®ue
 *
cv
 = 
d©a
;

253 *
gt
;

254 **
pŞicy
;

256 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

257 
	`log_”rÜ
("conf server inhe conf file is‚ot‡ string");

258  
VR_ERROR
;

261 
	`CONF_WLOCK
();

263 
p
 = 
obj
;

264 
gt
 = (*)(
p
 + 
İt
->
off£t
);

266 
pŞicy
 = 
eviùpŞicy_¡ršgs
; *policy;…olicy ++) {

267 ià(
	`¡rcmp
(
cv
->
v®ue
, *
pŞicy
) == 0) {

269 *
gt
 = 
pŞicy
 - 
eviùpŞicy_¡ršgs
;

274 ià(*
pŞicy
 =ğ
NULL
) {

275 
	`CONF_UNLOCK
();

276 
	`log_”rÜ
("ERROR: Conf maxmemory…olicy '%s' is invalid",

277 
cv
->
v®ue
);

278  
VR_ERROR
;

281 ià(*
gt
 =ğ
MAXMEMORY_VOLATILE_LRU
 || *gˆ=ğ
MAXMEMORY_ALLKEYS_LRU
) {

282 
	`CONF_UNLOCK
();

283 
	`log_”rÜ
("ERROR: Conf maxmemory…olicy‚ow is‚ot support %s‡nd %s",

284 
eviùpŞicy_¡ršgs
[
MAXMEMORY_VOLATILE_LRU
],

285 
eviùpŞicy_¡ršgs
[
MAXMEMORY_ALLKEYS_LRU
]);

286  
VR_ERROR
;

289 
	`CONF_UNLOCK
();

290  
VR_OK
;

291 
	}
}

294 
	$cÚf_£t_št_nÚ_z”o
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

296 
ušt8_t
 *
p
;

297 
cÚf_v®ue
 *
cv
 = 
d©a
;

298 *
gt
;

300 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

301 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

302 
İt
->
Çme
);

303  
VR_ERROR
;

306 
	`CONF_WLOCK
();

309 
p
 = 
obj
;

310 
gt
 = (*)(
p
 + 
İt
->
off£t
);

312 if(!
	`sdsIsNum
(
cv
->
v®ue
)){

313 
	`CONF_UNLOCK
();

314 
	`log_”rÜ
("value ofhe key %s in conf file is‚ot‡‚umber",

315 
İt
->
Çme
);

316  
VR_ERROR
;

319 *
gt
 = 
	`vr_©oi
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

321 ià(*
gt
 < 0) {

322 
	`CONF_UNLOCK
();

323 
	`log_”rÜ
("value ofhe key %s in conf file is invalid",

324 
İt
->
Çme
);

325  
VR_ERROR
;

326 } ià(*
gt
 < 1) {

327 
	`CONF_UNLOCK
();

328 
	`log_”rÜ
("value ofhe key %s in conf file must be 1 or greater",

329 
İt
->
Çme
);

330  
VR_ERROR
;

332 
cÚf
->
v”siÚ
 ++;

333 
	`CONF_UNLOCK
();

334  
VR_OK
;

335 
	}
}

339 
	$cÚf_g‘_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

341 
ušt8_t
 *
p
;

342 
sds
 *
¡r
 = 
d©a
;

343 
sds
 *
gt
;

345 ià(
d©a
 =ğ
NULL
)

346  
VR_ERROR
;

348 
	`CONF_RLOCK
();

349 
p
 = 
obj
;

350 
gt
 = (
sds
*)(
p
 + 
İt
->
off£t
);

351 ià(*
gt
 =ğ
NULL
è*
¡r
 = NULL;

352 *
¡r
 = 
	`sdsdup
(*
gt
);

353 
	`CONF_UNLOCK
();

354  
VR_OK
;

355 
	}
}

358 
	$cÚf_£t_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

360 
ušt8_t
 *
p
;

361 
cÚf_v®ue
 *
cv
 = 
d©a
;

362 
sds
 *
gt
;

364 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

365 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string",

366 
İt
->
Çme
);

367  
VR_ERROR
;

370 
	`CONF_WLOCK
();

371 
p
 = 
obj
;

372 
gt
 = (
sds
*)(
p
 + 
İt
->
off£t
);

374 *
gt
 = 
	`sd¢ewËn
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

375 
cÚf
->
v”siÚ
 ++;

376 
	`CONF_UNLOCK
();

377  
VR_OK
;

378 
	}
}

381 
	$cÚf_£t_·sswÜd
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

383 
ušt8_t
 *
p
;

384 
cÚf_v®ue
 *
cv
 = 
d©a
;

385 
sds
 *
gt
;

387 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

388 
	`log_”rÜ
("Conf…ool %s inhe conf file is‚ot‡ string",

389 
İt
->
Çme
);

390  
VR_ERROR
;

391 } ià(
	`sd¦’
(
cv
->
v®ue
è> 
CONFIG_AUTHPASS_MAX_LEN
) {

392 
	`log_”rÜ
("Password is†ongerhan CONFIG_AUTHPASS_MAX_LEN");

393  
VR_ERROR
;

396 
	`CONF_WLOCK
();

397 
p
 = 
obj
;

398 
gt
 = (
sds
*)(
p
 + 
İt
->
off£t
);

400 ià(*
gt
 !ğ
NULL
è
	`sdsä“
(*gt);

401 ià(
	`sd¦’
(
cv
->
v®ue
è=ğ0è*
gt
 = 
NULL
;

402 *
gt
 = 
	`sd¢ewËn
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

403 
cÚf
->
v”siÚ
 ++;

404 
	`CONF_UNLOCK
();

405  
VR_OK
;

406 
	}
}

409 
	$cÚf_g‘_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

411 
ušt8_t
 *
p
;

412 *
š‹g”
 = 
d©a
;

413 *
gt
;

415 ià(
d©a
 =ğ
NULL
)

416  
VR_ERROR
;

418 
	`CONF_RLOCK
();

419 
p
 = 
obj
;

420 
gt
 = (*)(
p
 + 
İt
->
off£t
);

421 *
š‹g”
 = *
gt
;

422 
	`CONF_UNLOCK
();

423  
VR_OK
;

424 
	}
}

427 
	$cÚf_£t_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

429 
ušt8_t
 *
p
;

430 
cÚf_v®ue
 *
cv
 = 
d©a
;

431 *
gt
;

433 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

434 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

435 
İt
->
Çme
);

436  
VR_ERROR
;

439 
	`CONF_WLOCK
();

441 
p
 = 
obj
;

442 
gt
 = (*)(
p
 + 
İt
->
off£t
);

444 if(!
	`sdsIsNum
(
cv
->
v®ue
)){

445 
	`CONF_UNLOCK
();

446 
	`log_”rÜ
("value ofhe key %s in conf file is‚ot‡‚umber",

447 
İt
->
Çme
);

448  
VR_ERROR
;

451 *
gt
 = 
	`vr_©oi
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

453 ià(*
gt
 < 0) {

454 
	`CONF_UNLOCK
();

455 
	`log_”rÜ
("value ofhe key %s in conf file is invalid",

456 
İt
->
Çme
);

457  
VR_ERROR
;

459 
cÚf
->
v”siÚ
 ++;

460 
	`CONF_UNLOCK
();

461  
VR_OK
;

462 
	}
}

465 
	$cÚf_g‘_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

467 
ušt8_t
 *
p
;

468 *
š‹g”
 = 
d©a
;

469 *
gt
;

471 ià(
d©a
 =ğ
NULL
)

472  
VR_ERROR
;

474 
	`CONF_RLOCK
();

475 
p
 = 
obj
;

476 
gt
 = (*)(
p
 + 
İt
->
off£t
);

477 *
š‹g”
 = *
gt
;

478 
	`CONF_UNLOCK
();

479  
VR_OK
;

480 
	}
}

483 
	$cÚf_£t_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

485 
ušt8_t
 *
p
;

486 
cÚf_v®ue
 *
cv
 = 
d©a
;

487 *
gt
;

489 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

490 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

491 
İt
->
Çme
);

492  
VR_ERROR
;

495 
	`CONF_WLOCK
();

497 
p
 = 
obj
;

498 
gt
 = (*)(
p
 + 
İt
->
off£t
);

500 ià(!
	`¡ršg2Î
(
cv
->
v®ue
, 
	`sd¦’
(cv->v®ue), 
gt
)) {

501 
	`CONF_UNLOCK
();

502 
	`log_”rÜ
("value ofhe key %s in conf file is invalid",

503 
İt
->
Çme
);

504  
VR_ERROR
;

506 
cÚf
->
v”siÚ
 ++;

507 
	`CONF_UNLOCK
();

508  
VR_OK
;

509 
	}
}

512 
	$cÚf_£t_yesÜno
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

514 
ušt8_t
 *
p
;

515 
cÚf_v®ue
 *
cv
 = 
d©a
;

516 *
gt
;

518 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

519 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

520 
İt
->
Çme
);

521  
VR_ERROR
;

524 
	`CONF_WLOCK
();

526 
p
 = 
obj
;

527 
gt
 = (*)(
p
 + 
İt
->
off£t
);

529 if(!
	`¡rÿ£cmp
(
cv
->
v®ue
, 
CONF_VALUE_YES
)){

530 *
gt
 = 1;

531 }if(!
	`¡rÿ£cmp
(
cv
->
v®ue
, 
CONF_VALUE_NO
)){

532 *
gt
 = 0;

534 
	`CONF_UNLOCK
();

535 
	`log_”rÜ
("key %s in conf file must be %s or %s",

536 
İt
->
Çme
, 
CONF_VALUE_YES
, 
CONF_VALUE_NO
);

537  
VR_ERROR
;

539 
cÚf
->
v”siÚ
 ++;

540 
	`CONF_UNLOCK
();

541  
VR_OK
;

542 
	}
}

545 
	$cÚf_£t_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

547 
ušt8_t
 *
p
;

548 
ušt32_t
 
j
;

549 
cÚf_v®ue
 **
cv_sub
, *
cv
 = 
d©a
;

550 
d¬¿y
 *
gt
;

551 
sds
 *
¡r
;

553 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
 &&

554 
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_ARRAY
){

555 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string or‡rray",

556 
İt
->
Çme
);

557  
VR_ERROR
;

558 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

559 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

560 ià((*
cv_sub
)->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
) {

561 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string‡rray",

562 
İt
->
Çme
);

563  
VR_ERROR
;

567 
	`CONF_WLOCK
();

568 
p
 = 
obj
;

569 
gt
 = (
d¬¿y
*)(
p
 + 
İt
->
off£t
);

571 
	`d¬¿y_n
(
gt
) > 0) {

572 
¡r
 = 
	`d¬¿y_pİ
(
gt
);

573 
	`sdsä“
(*
¡r
);

576 ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
) {

577 
¡r
 = 
	`d¬¿y_push
(
gt
);

578 *
¡r
 = 
	`sdsdup
(
cv
->
v®ue
);

579 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

580 
j
 = 0; j < 
	`d¬¿y_n
(
cv
->
v®ue
); j ++) {

581 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

582 
¡r
 = 
	`d¬¿y_push
(
gt
);

583 *
¡r
 = 
	`sdsdup
((*
cv_sub
)->
v®ue
);

586 
cÚf
->
v”siÚ
 ++;

587 
	`CONF_UNLOCK
();

588  
VR_OK
;

589 
	}
}

592 
	$cÚf_£t_commªds_Ãed_admš·ss
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

594 
ušt8_t
 *
p
;

595 
ušt32_t
 
j
;

596 
cÚf_v®ue
 **
cv_sub
, *
cv
 = 
d©a
;

597 
d¬¿y
 *
gt
;

598 
sds
 *
¡r
;

600 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
 &&

601 
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_ARRAY
){

602 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string or‡rray",

603 
İt
->
Çme
);

604  
VR_ERROR
;

605 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

606 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

607 ià((*
cv_sub
)->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
) {

608 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string‡rray",

609 
İt
->
Çme
);

610  
VR_ERROR
;

614 
	`CONF_WLOCK
();

615 
p
 = 
obj
;

616 
gt
 = (
d¬¿y
*)(
p
 + 
İt
->
off£t
);

618 
	`d¬¿y_n
(
gt
) > 0) {

619 
¡r
 = 
	`d¬¿y_pİ
(
gt
);

620 
	`sdsä“
(*
¡r
);

623 ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
) {

624 
¡r
 = 
	`d¬¿y_push
(
gt
);

625 *
¡r
 = 
	`sdsdup
(
cv
->
v®ue
);

626 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

627 
j
 = 0; j < 
	`d¬¿y_n
(
cv
->
v®ue
); j ++) {

628 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

629 
¡r
 = 
	`d¬¿y_push
(
gt
);

630 *
¡r
 = 
	`sdsdup
((*
cv_sub
)->
v®ue
);

633 
cÚf
->
v”siÚ
 ++;

634 
	`CONF_UNLOCK
();

635  
VR_OK
;

636 
	}
}

639 
	$cÚf_g‘_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

641 
ušt8_t
 *
p
;

642 
ušt32_t
 
j
;

643 
d¬¿y
 *
¡rs
 = 
d©a
;

644 
¬¿y
 *
gt
;

645 
sds
 *
¡r1
, *
¡r2
;

647 ià(
d©a
 =ğ
NULL
) {

648  
VR_ERROR
;

651 
	`CONF_RLOCK
();

652 
p
 = 
obj
;

653 
gt
 = (
d¬¿y
*)(
p
 + 
İt
->
off£t
);

655 
	`ASSERT
(
	`d¬¿y_n
(
¡rs
) == 0);

657 
j
 = 0; j < 
	`d¬¿y_n
(
gt
); j ++) {

658 
¡r1
 = 
	`d¬¿y_g‘
(
gt
, 
j
);

659 
¡r2
 = 
	`d¬¿y_push
(
¡rs
);

660 *
¡r2
 = 
	`sdsdup
(*
¡r1
);

663 
	`CONF_UNLOCK
();

664  
VR_OK
;

665 
	}
}

667 
	$diùCÚfV®ueDe¡ruùÜ
(*
´ivd©a
, *
v®
)

669 
	`DICT_NOTUSED
(
´ivd©a
);

671 
	`cÚf_v®ue_de¡roy
(
v®
);

672 
	}
}

674 
	$diùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

676 
	`DICT_NOTUSED
(
´ivd©a
);

678 
	`diùR–—£
(
v®
);

679 
	}
}

682 
diùTy³
 
	gOrgªiz©iÚDiùTy³
 = {

683 
diùSdsHash
,

684 
NULL
,

685 
NULL
,

686 
diùSdsKeyCom·»
,

687 
diùSdsDe¡ruùÜ
,

688 
diùDe¡ruùÜ


692 
diùTy³
 
	gKeyV®ueDiùTy³
 = {

693 
diùSdsHash
,

694 
NULL
,

695 
NULL
,

696 
diùSdsKeyCom·»
,

697 
diùSdsDe¡ruùÜ
,

698 
diùCÚfV®ueDe¡ruùÜ


702 
diùTy³
 
	gCÚfTabËDiùTy³
 = {

703 
diùSŒCa£Hash
,

704 
NULL
,

705 
NULL
,

706 
diùSŒKeyCa£Com·»
,

707 
NULL
,

708 
NULL


712 
cÚf_v®ue
 *
	$cÚf_v®ue_ü—‹
(
ty³
)

714 
cÚf_v®ue
 *
cv
;

716 
cv
 = 
	`d®loc
((*cv));

717 if(
cv
 =ğ
NULL
){

718  
NULL
;

721 
cv
->
ty³
 =ype;

722 
cv
->
v®ue
 = 
NULL
;

724 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

725 
cv
->
v®ue
 = 
	`d¬¿y_ü—‹
(3, (
cÚf_v®ue
*));

726 if(
cv
->
v®ue
 =ğ
NULL
){

727 
	`dä“
(
cv
);

728  
NULL
;

732  
cv
;

733 
	}
}

736 
	$cÚf_v®ue_de¡roy
(
cÚf_v®ue
 *
cv
)

738 
cÚf_v®ue
 **
cv_sub
;

740 if(
cv
 =ğ
NULL
){

744 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_UNKNOW
){

745 
	`dä“
(
cv
);

747 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
){

748 if(
cv
->
v®ue
 !ğ
NULL
){

749 
	`sdsä“
(
cv
->
v®ue
);

751 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

752 if(
cv
->
v®ue
 !ğ
NULL
){

753 
	`d¬¿y_n
(
cv
->
v®ue
) > 0){

754 
cv_sub
 = 
	`d¬¿y_pİ
(
cv
->
v®ue
);

755 
	`cÚf_v®ue_de¡roy
(*
cv_sub
);

758 
	`d¬¿y_de¡roy
(
cv
->
v®ue
);

761 
	`NOT_REACHED
();

764 
	`dä“
(
cv
);

765 
	}
}

768 
	$cÚf_£rv”_š™
(
cÚf_£rv”
 *
cs
)

770 if(
cs
 =ğ
NULL
){

771  
VR_ERROR
;

774 
cs
->
ùabË
 = 
	`diùC»©e
(&
CÚfTabËDiùTy³
,
NULL
);

776 
cs
->
d©aba£s
 = 
CONF_UNSET_NUM
;

777 
cs
->
š‹º®_dbs_³r_d©aba£s
 = 
CONF_UNSET_NUM
;

778 
cs
->
max_time_com¶ex™y_lim™
 = 
CONF_UNSET_NUM
;

779 
cs
->
maxmemÜy
 = 
CONF_UNSET_NUM
;

780 
cs
->
maxmemÜy_pŞicy
 = 
CONF_UNSET_NUM
;

781 
cs
->
maxmemÜy_§m¶es
 = 
CONF_UNSET_NUM
;

782 
cs
->
maxş›Ás
 = 
CONF_UNSET_NUM
;

783 
cs
->
th»ads
 = 
CONF_UNSET_NUM
;

784 
	`d¬¿y_š™
(&
cs
->
bšds
,1,(
sds
));

785 
cs
->
pÜt
 = 
CONF_UNSET_NUM
;

786 
cs
->
»quœ•ass
 = 
CONF_UNSET_PTR
;

787 
cs
->
admš·ss
 = 
CONF_UNSET_PTR
;

788 
cs
->
dœ
 = 
CONF_UNSET_PTR
;

789 
	`d¬¿y_š™
(&
cs
->
commªds_Ãed_admš·ss
,1,(
sds
));

791  
VR_OK
;

792 
	}
}

795 
	$cÚf_£rv”_£t_deçuÉ
(
cÚf_£rv”
 *
cs
)

797 
sds
 *
¡r
;

798 
cÚf_İtiÚ
 *
İt
;

800 if(
cs
 =ğ
NULL
){

801  
VR_ERROR
;

804 
İt
 = 
cÚf_£rv”_İtiÚs
; o±&&İt->
Çme
; opt++) {

805 
	`diùAdd
(
cs
->
ùabË
,
İt
->
Çme
,opt);

808 
cs
->
d©aba£s
 = 
CONFIG_DEFAULT_LOGICAL_DBNUM
;

809 
cs
->
š‹º®_dbs_³r_d©aba£s
 = 
CONFIG_DEFAULT_INTERNAL_DBNUM
;

810 
cs
->
max_time_com¶ex™y_lim™
 = 
CONFIG_DEFAULT_MAX_TIME_COMPLEXITY_LIMIT
;

811 
cs
->
maxmemÜy
 = 
CONFIG_DEFAULT_MAXMEMORY
;

812 
cs
->
maxmemÜy_pŞicy
 = 
CONFIG_DEFAULT_MAXMEMORY_POLICY
;

813 
cs
->
maxmemÜy_§m¶es
 = 
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
;

814 
cs
->
maxş›Ás
 = 
CONFIG_DEFAULT_MAX_CLIENTS
;

815 
cs
->
th»ads
 = 
CONFIG_DEFAULT_THREADS_NUM
;

816 
cs
->
¦owlog_log_¦ow”_thª
 = 
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
;

817 
cs
->
¦owlog_max_Ën
 = 
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
;

818 
cs
->
»quœ•ass
 = 
CONF_UNSET_PTR
;

819 
cs
->
admš·ss
 = 
CONF_UNSET_PTR
;

821 
	`d¬¿y_n
(&
cs
->
bšds
) > 0) {

822 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
bšds
);

823 
	`sdsä“
(*
¡r
);

825 
¡r
 = 
	`d¬¿y_push
(&
cs
->
bšds
);

826 *
¡r
 = 
	`sd¢ew
(
CONFIG_DEFAULT_HOST
);

828 
cs
->
pÜt
 = 
CONFIG_DEFAULT_SERVER_PORT
;

830 ià(
cs
->
dœ
 !ğ
CONF_UNSET_PTR
) {

831 
	`sdsä“
(
cs
->
dœ
);

833 
cs
->
dœ
 = 
	`sd¢ew
(
CONFIG_DEFAULT_DATA_DIR
);

835 
	`d¬¿y_n
(&
cs
->
commªds_Ãed_admš·ss
) > 0) {

836 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
commªds_Ãed_admš·ss
);

837 
	`sdsä“
(*
¡r
);

840  
VR_OK
;

841 
	}
}

843 
	$cÚf_£rv”_deš™
(
cÚf_£rv”
 *
cs
)

845 
sds
 *
¡r
;

847 if(
cs
 =ğ
NULL
){

851 
cs
->
d©aba£s
 = 
CONF_UNSET_NUM
;

852 
cs
->
š‹º®_dbs_³r_d©aba£s
 = 
CONF_UNSET_NUM
;

853 
cs
->
maxmemÜy
 = 
CONF_UNSET_NUM
;

854 
cs
->
maxmemÜy_pŞicy
 = 
CONF_UNSET_NUM
;

855 
cs
->
maxmemÜy_§m¶es
 = 
CONF_UNSET_NUM
;

856 
cs
->
max_time_com¶ex™y_lim™
 = 
CONF_UNSET_NUM
;

857 
cs
->
maxş›Ás
 = 
CONF_UNSET_NUM
;

858 
cs
->
th»ads
 = 
CONF_UNSET_NUM
;

860 
	`d¬¿y_n
(&
cs
->
bšds
) > 0) {

861 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
bšds
);

862 
	`sdsä“
(*
¡r
);

864 
	`d¬¿y_deš™
(&
cs
->
bšds
);

866 
cs
->
pÜt
 = 
CONF_UNSET_NUM
;

868 ià(
cs
->
dœ
 !ğ
CONF_UNSET_PTR
) {

869 
	`sdsä“
(
cs
->
dœ
);

870 
cs
->
dœ
 = 
CONF_UNSET_PTR
;

873 ià(
cs
->
»quœ•ass
 !ğ
CONF_UNSET_PTR
) {

874 
	`sdsä“
(
cs
->
»quœ•ass
);

875 
cs
->
»quœ•ass
 = 
CONF_UNSET_PTR
;

877 ià(
cs
->
admš·ss
 !ğ
CONF_UNSET_PTR
) {

878 
	`sdsä“
(
cs
->
admš·ss
);

879 
cs
->
admš·ss
 = 
CONF_UNSET_PTR
;

882 
	`d¬¿y_n
(&
cs
->
commªds_Ãed_admš·ss
) > 0) {

883 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
commªds_Ãed_admš·ss
);

884 
	`sdsä“
(*
¡r
);

886 
	`d¬¿y_deš™
(&
cs
->
commªds_Ãed_admš·ss
);

887 
	}
}

891 
	$cÚf_£rv”_g‘
(cÚ¡ *
İtiÚ_Çme
, *
v®ue
)

893 
cÚf_İtiÚ
 *
İt
;

895 
İt
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
İtiÚ_Çme
);

896 ià(
İt
 =ğ
NULL
)

897  
VR_ERROR
;

899  
İt
->
	`g‘
(
c£rv”
, o±, 
v®ue
);

900 
	}
}

903 
	$cÚf_£rv”_£t
(cÚ¡ *
İtiÚ_Çme
, 
cÚf_v®ue
 *
v®ue
)

905 
cÚf_İtiÚ
 *
İt
;

907 
İt
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
İtiÚ_Çme
);

908 ià(
İt
 =ğ
NULL
 || o±->
æags
&
CONF_FIELD_FLAGS_NO_MODIFY
)

909  
VR_ERROR
;

911  
İt
->
	`£t
(
c£rv”
, o±, 
v®ue
);

912 
	}
}

915 
	$cÚf_š™
(
vr_cÚf
 *
cf
)

917 
»t
;

919 if(
cf
 =ğ
NULL
){

920  
VR_ERROR
;

924 
cf
->
âame
 = 
NULL
;

926 
cf
->
Ügªiz©iÚs
 = 
NULL
;

928 
cf
->
v”siÚ
 = 0;

929 
	`±h»ad_rwlock_š™
(&
cf
->
rwl
, 
NULL
);

930 
	`±h»ad_mu‹x_š™
(&
cf
->
æock
, 
NULL
);

932 
cf
->
Ügªiz©iÚs
 = 
	`diùC»©e
(&
Orgªiz©iÚDiùTy³
, 
NULL
);

933 ià(
cf
->
Ügªiz©iÚs
 =ğ
NULL
) {

934  
VR_ERROR
;

938 
	`cÚf_£rv”_š™
(&
cf
->
c£rv”
);

940 
cÚf
 = 
cf
;

942  
VR_OK
;

943 
	}
}

946 
	$cÚf_£t_deçuÉ
(
vr_cÚf
 *
cf
)

948 
	`CONF_WLOCK
();

949 
	`cÚf_£rv”_£t_deçuÉ
(&
cf
->
c£rv”
);

950 
	`CONF_UNLOCK
();

951  
VR_OK
;

952 
	}
}

954 
	$cÚf_deš™
(
vr_cÚf
 *
cf
)

956 if(
cf
 =ğ
NULL
){

960 ià(
cf
->
âame
 !ğ
NULL
) {

961 
	`sdsä“
(
cf
->
âame
);

962 
cf
->
âame
 = 
NULL
;

965 if(
cf
->
Ügªiz©iÚs
 !ğ
NULL
){

966 
	`diùR–—£
(
cf
->
Ügªiz©iÚs
);

967 
cf
->
Ügªiz©iÚs
 = 
NULL
;

970 
	`cÚf_£rv”_deš™
(&
cf
->
c£rv”
);

972 
cf
->
v”siÚ
 = 0;

973 
	`±h»ad_rwlock_de¡roy
(&
cf
->
rwl
);

974 
	`±h»ad_mu‹x_de¡roy
(&
cf
->
æock
);

975 
	}
}

979 
	$cÚf_£rv”_dump
(
cÚf_£rv”
 *
cs
, 
log_Ëv–
)

981 if(
cs
 =ğ
NULL
){

985 
	`log_debug
(
log_Ëv–
, " d©aba£ : %d", 
cs
->
d©aba£s
);

986 
	`log_debug
(
log_Ëv–
, " iÁ”Çl_dbs_³r_d©aba£ : %d", 
cs
->
š‹º®_dbs_³r_d©aba£s
);

987 
	`log_debug
(
log_Ëv–
, " maxmemÜy : %Îd", 
cs
->
maxmemÜy
);

988 
	`log_debug
(
log_Ëv–
, " maxmemÜy_pŞicy : %d", 
cs
->
maxmemÜy_pŞicy
);

989 
	`log_debug
(
log_Ëv–
, " maxmemÜy_§m¶e : %d", 
cs
->
maxmemÜy_§m¶es
);

990 
	`log_debug
(
log_Ëv–
, " max_time_com¶ex™y_lim™ : %Îd", 
cs
->
max_time_com¶ex™y_lim™
);

991 
	}
}

995 
	$cÚf_dump
(
vr_cÚf
 *
cf
)

997 
log_Ëv–
 = 
LOG_VERB
;

998 
cÚf_£rv”
 *
cs
;

1000 if(
cf
 =ğ
NULL
){

1004 
cs
 = &
cf
->
c£rv”
;

1005 
	`log_debug
(
log_Ëv–
, "server in conf file");

1006 
	`cÚf_£rv”_dump
(
cs
, 
log_Ëv–
);

1007 
	`log_debug
(
log_Ëv–
, "");

1008 
	}
}

1015 
	$cÚf_key_v®ue_š£¹
(
diù
 *
Üg
, 
sds
 
key
, 
cÚf_v®ue
 *
cv
)

1017 ià(
key
 =ğ
NULL
) {

1018 
	`log_”rÜ
("value in conf file has‚o key");

1022 ià(
cv
 =ğ
NULL
) {

1023 
	`log_”rÜ
("key % š cÚàfha nØv®ue", 
key
);

1027 ià(
Üg
 =ğ
NULL
) {

1028 
	`log_”rÜ
("key %s in conf file has‚o organization",

1029 
key
);

1033 ià(
	`diùAdd
(
Üg
,
key
,
cv
è!ğ
DICT_OK
) {

1034 
diùEÁry
 *
de
;

1035 
cÚf_v®ue
 *
cv_Şd
, *
cv_Ãw
, **
cv_sub
;

1036 
de
 = 
	`diùFšd
(
Üg
,
key
);

1037 
cv_Şd
 = 
	`diùG‘V®
(
de
);

1038 ià(
cv_Şd
->
ty³
 !ğ
CONF_VALUE_TYPE_ARRAY
) {

1039 
cv_Ãw
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_ARRAY
);

1040 
cv_sub
 = 
	`d¬¿y_push
(
cv_Ãw
->
v®ue
);

1041 *
cv_sub
 = 
cv_Şd
;

1042 
cv_sub
 = 
	`d¬¿y_push
(
cv_Ãw
->
v®ue
);

1043 *
cv_sub
 = 
cv
;

1044 
	`diùS‘V®
(
Üg
,
de
,
cv_Ãw
);

1046 
cv_sub
 = 
	`d¬¿y_push
(
cv_Şd
->
v®ue
);

1047 *
cv_sub
 = 
cv
;

1053 
	}
}

1057 
	$cÚf_´e_lßd_äom_¡ršg
(
vr_cÚf
 *
cf
, *
cÚfig
)

1059 
»t
;

1060 
lš’um
 = 0, 
tÙlšes
, 
i
, 
j
;

1061 
¦aveof_lš’um
 = 0;

1062 
sds
 *
lšes
 = 
NULL
;

1063 
diù
 *
Üg
 = 
NULL
;

1064 
sds
 
Üg_Çme
 = 
NULL
;

1065 
diùEÁry
 *
de
;

1066 
sds
 
key
 = 
NULL
;

1067 
cÚf_v®ue
 *
cv
 = 
NULL
;

1069 
lšes
 = 
	`sds¥l™Ën
(
cÚfig
,
	`¡¾’
(cÚfig),"\n",1,&
tÙlšes
);

1073 
i
 = 0; i < 
tÙlšes
; i++) {

1074 
sds
 *
¬gv
;

1075 
¬gc
;

1077 
lš’um
 = 
i
+1;

1079 
lšes
[
i
] = 
	`sd¡rim
(lines[i]," \t\r\n");

1083 ià(
lšes
[
i
][0] == '#' ||†ines[i][0] == '\0') ;

1086 ià(
lšes
[
i
][0] == '[') {

1088 ià(
	`sd¦’
(
lšes
[
i
]) <= 2 ||†ines[i][sdslen(lines[i])-1] == ']') {

1089 
	`log_”rÜ
("Organization‚ame %s in conf file %sƒrror",

1090 
lšes
[
i
], 
cf
->
âame
);

1091 
lßd”r
;

1094 
Üg_Çme
 = 
	`sd¢ewËn
(
lšes
[
i
]+1,
	`sd¦’
(lines[i])-2);

1095 
de
 = 
	`diùFšd
(
cf
->
Ügªiz©iÚs
,
Üg_Çme
);

1096 ià(
de
 =ğ
NULL
) {

1098 
Üg
 = 
	`diùC»©e
(&
KeyV®ueDiùTy³
, 
NULL
);

1099 
	`diùAdd
(
cf
->
Ügªiz©iÚs
,
Üg_Çme
,
Üg
);

1102 
Üg
 = 
	`diùG‘V®
(
de
);

1103 
	`sdsä“
(
Üg_Çme
);

1112 
¬gv
 = 
	`sds¥l™¬gs
(
lšes
[
i
],&
¬gc
);

1113 ià(
¬gv
 =ğ
NULL
) {

1114 
	`log_”rÜ
("Unbalanced quotes in configuration†ine");

1115 
lßd”r
;

1119 ià(
¬gc
 == 0) {

1120 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1124 
	`sd¡Şow”
(
¬gv
[0]);

1127 ià(
Üg
 =ğ
NULL
) {

1128 
Üg_Çme
 = 
	`sd¢ew
("server");

1129 
Üg
 = 
	`diùC»©e
(&
KeyV®ueDiùTy³
, 
NULL
);

1130 
	`diùAdd
(
cf
->
Ügªiz©iÚs
,
Üg_Çme
,
Üg
);

1134 
key
 = 
¬gv
[0];

1135 
¬gv
[0] = 
NULL
;

1136 
j
 = 1; j < 
¬gc
; j ++) {

1138 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1139 
cv
->
v®ue
 = 
¬gv
[
j
];

1140 
¬gv
[
j
] = 
NULL
;

1141 
»t
 = 
	`cÚf_key_v®ue_š£¹
(
Üg
, 
key
, 
cv
);

1142 if(
»t
 == -1){

1143 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1144 
	`sdsä“
(
key
);

1145 
	`cÚf_v®ue_de¡roy
(
cv
);

1146 
	`log_”rÜ
("key value insert into organization failed");

1147 
lßd”r
;

1148 } ià(
j
 =ğ1 && 
»t
 == 0) {

1149 
	`sdsä“
(
key
);

1153 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1156 ià(
lšes
) {

1157 
	`sdsä“¥l™»s
(
lšes
,
lš’um
);

1159  
VR_OK
;

1161 
lßd”r
:

1162 ià(
lšes
) {

1163 
	`sdsä“¥l™»s
(
lšes
,
lš’um
);

1165  
VR_ERROR
;

1166 
	}
}

1170 
	$cÚf_´e_v®id©e
(
vr_cÚf
 *
cf
)

1172 
»t
;

1173 
sds
 
cÚfig
 = 
	`sd£m±y
();

1174 
buf
[
CONF_MAX_LINE
+1];

1178 ià(
cf
->
âame
) {

1179 
FILE
 *
å
;

1181 ià(
cf
->
âame
[0] == '-' && cf->fname[1] == '\0') {

1182 
å
 = 
¡dš
;

1184 ià((
å
 = 
	`fİ’
(
cf
->
âame
,"r")è=ğ
NULL
) {

1185 
	`log_”rÜ
("O³ÀcÚfig f'%s' faed: %s", 
cf
->
âame
, 
	`¡»¼Ü
(
”ºo
));

1186 
	`sdsä“
(
cÚfig
);

1187  
VR_ERROR
;

1190 
	`fg‘s
(
buf
,
CONF_MAX_LINE
+1,
å
è!ğ
NULL
)

1191 
cÚfig
 = 
	`sdsÿt
(cÚfig,
buf
);

1192 ià(
å
 !ğ
¡dš
è
	`fşo£
(fp);

1195 
»t
 = 
	`cÚf_´e_lßd_äom_¡ršg
(
cf
,
cÚfig
);

1196 ià(
»t
 !ğ
VR_OK
) {

1197 
	`sdsä“
(
cÚfig
);

1198  
VR_ERROR
;

1201 
	`sdsä“
(
cÚfig
);

1202  
VR_OK
;

1203 
	}
}

1207 
	$cÚf_·r£_cÚf_£rv”
(
cÚf_£rv”
 *
cs
, 
diù
 *
Üg
)

1209 
»t
;

1210 
cÚf_İtiÚ
 *
İt
;

1211 
diùEÁry
 *
de
;

1212 
sds
 
key
;

1214 if(
cs
 =ğ
NULL
 || 
Üg
 == NULL){

1215  
VR_ERROR
;

1218 
key
 = 
	`sd£m±y
();

1220 
İt
 = 
cÚf_£rv”_İtiÚs
; o±&&İt->
Çme
; opt++) {

1221 
key
 = 
	`sdsıy
(key,
İt
->
Çme
);

1223 
de
 = 
	`diùFšd
(
Üg
,
key
);

1225 ià(
de
 !ğ
NULL
) {

1227 
»t
 = 
İt
->
	`£t
(
cs
, o±, 
	`diùG‘V®
(
de
));

1228 if(
»t
 !ğ
VR_OK
){

1229 
	`log_”rÜ
("·r£ key % š cÚàf”rÜ", 
key
);

1230 
	`sdsä“
(
key
);

1231  
VR_ERROR
;

1236 
	`sdsä“
(
key
);

1237  
VR_OK
;

1238 
	}
}

1243 
	$cÚf_·r£
(
vr_cÚf
 *
cf
)

1245 
»t
;

1246 
diù
 *
Ügs
, *
Üg
;

1247 
diùEÁry
 *
de
;

1248 
sds
 
key
;

1250 ià(
cf
 =ğ
NULL
) {

1251  
VR_ERROR
;

1254 
Ügs
 = 
cf
->
Ügªiz©iÚs
;

1255 ià(
Ügs
 =ğ
NULL
) {

1256  
VR_ERROR
;

1261 
key
 = 
	`sd¢ew
(
CONF_ORGANIZATION_NAME_SERVER
);

1262 
de
 = 
	`diùFšd
(
Ügs
, 
key
);

1263 ià(
de
 =ğ
NULL
) {

1264 
	`log_”rÜ
("can‚ot find %s organization in conf file %s",

1265 
CONF_ORGANIZATION_NAME_SERVER
, 
cf
->
âame
);

1266 
	`sdsä“
(
key
);

1267  
VR_ERROR
;

1270 
Üg
 = 
	`diùG‘V®
(
de
);

1271 ià(
Üg
 =ğ
NULL
) {

1272 
	`log_”rÜ
("diù % ’Œy v®ui NULL", 
	`diùG‘Key
(
de
));

1273 
	`sdsä“
(
key
);

1274  
VR_ERROR
;

1278 
»t
 = 
	`cÚf_·r£_cÚf_£rv”
(&
cf
->
c£rv”
, 
Üg
);

1279 ifĞ
»t
 !ğ
VR_OK
) {

1280 
	`log_”rÜ
("common conf…arseƒrror");

1281 
	`sdsä“
(
key
);

1282  
VR_ERROR
;

1285 
	`sdsä“
(
key
);

1287  
VR_OK
;

1288 
	}
}

1292 
	$cÚf_po¡_v®id©e
(
vr_cÚf
 *
cf
)

1294 if(
cf
 =ğ
NULL
){

1295  
VR_ERROR
;

1298 if(
cf
->
Ügªiz©iÚs
 !ğ
NULL
){

1299 
	`diùR–—£
(
cf
->
Ügªiz©iÚs
);

1300 
cf
->
Ügªiz©iÚs
 = 
NULL
;

1303  
VR_OK
;

1304 
	}
}

1306 
vr_cÚf
 *

1307 
	$cÚf_İ’
(*
f’ame
)

1309 
»t
;

1310 
vr_cÚf
 *
cf
 = 
NULL
;

1311 
sds
 
·th
 = 
NULL
;

1313 ià(
f’ame
 =ğ
NULL
) {

1314 
	`log_”rÜ
("configuration file‚ame is NULL.");

1315  
NULL
;

1318 
·th
 = 
	`g‘AbsŞu‹P©h
(
f’ame
);

1319 ià(
·th
 =ğ
NULL
) {

1320 
	`log_”rÜ
("cÚfigu¿tiÚ fÇm'%s' i ”rÜ.", 
f’ame
);

1321 
”rÜ
;

1324 
cf
 = 
	`d®loc
((*cf));

1325 ià(
cf
 =ğ
NULL
) {

1326 
”rÜ
;

1329 
»t
 = 
	`cÚf_š™
(
cf
);

1330 if(
»t
 !ğ
VR_OK
){

1331 
”rÜ
;

1335 
»t
 = 
	`cÚf_£t_deçuÉ
(
cf
);

1336 ià(
»t
 !ğ
VR_OK
) {

1337 
”rÜ
;

1340 
cf
->
âame
 = 
·th
;

1342  
cf
;

1344 
”rÜ
:

1346 ià(
cf
 !ğ
NULL
) {

1347 
	`cÚf_de¡roy
(
cf
);

1350 ià(
·th
 !ğ
NULL
) {

1351 
	`sdsä“
(
·th
);

1354  
NULL
;

1355 
	}
}

1358 
vr_cÚf
 *

1359 
	$cÚf_ü—‹
(*
f’ame
)

1361 
»t
;

1362 
vr_cÚf
 *
cf
;

1364 
cf
 = 
	`cÚf_İ’
(
f’ame
);

1365 ià(
cf
 =ğ
NULL
) {

1366  
NULL
;

1371 
»t
 = 
	`cÚf_´e_v®id©e
(
cf
);

1372 ià(
»t
 !ğ
VR_OK
) {

1373 
”rÜ
;

1377 
	`cÚf_Ügªiz©iÚs_dump
(
cf
);

1381 
»t
 = 
	`cÚf_·r£
(
cf
);

1382 ià(
»t
 !ğ
VR_OK
) {

1383 
”rÜ
;

1387 
»t
 = 
	`cÚf_po¡_v®id©e
(
cf
);

1388 ià(
»t
 !ğ
VR_OK
) {

1389 
”rÜ
;

1392 
	`cÚf_dump
(
cf
);

1394 
c£rv”
 = &
cf
->cserver;

1396  
cf
;

1398 
”rÜ
:

1399 
	`cÚf_de¡roy
(
cf
);

1400  
NULL
;

1401 
	}
}

1404 
	$cÚf_de¡roy
(
vr_cÚf
 *
cf
)

1406 ià(
cf
 =ğ
NULL
) {

1410 
	`cÚf_deš™
(
cf
);

1412 
	`dä“
(
cf
);

1413 
	}
}

1416 
	$cÚf_v”siÚ_g‘
()

1418 
v”siÚ
;

1420 
	`CONF_RLOCK
();

1421 
v”siÚ
 = 
cÚf
->version;

1422 
	`CONF_UNLOCK
();

1424  
v”siÚ
;

1425 
	}
}

1429 
	$CONF_RLOCK
()

1431  
	`±h»ad_rwlock_rdlock
(&
cÚf
->
rwl
);

1432 
	}
}

1435 
	$CONF_WLOCK
()

1437  
	`±h»ad_rwlock_w¾ock
(&
cÚf
->
rwl
);

1438 
	}
}

1442 
	$CONF_UNLOCK
()

1444  
	`±h»ad_rwlock_uÆock
(&
cÚf
->
rwl
);

1445 
	}
}

1449 
	$CONFF_LOCK
()

1451  
	`±h»ad_mu‹x_lock
(&
cÚf
->
æock
);

1452 
	}
}

1455 
	$CONFF_UNLOCK
()

1457  
	`±h»ad_mu‹x_uÆock
(&
cÚf
->
æock
);

1458 
	}
}

1461 
	$g‘_eviùpŞicy_¡ršgs
(
eviùpŞicy_ty³
)

1463  
eviùpŞicy_¡ršgs
[
eviùpŞicy_ty³
];

1464 
	}
}

1471 
	$cÚfigS‘Commªd
(
ş›Á
 *
c
) {

1472 
»t
;

1473 
sds
 
v®ue
;

1474 
sds
 *
f›lds
;

1475 
f›lds_couÁ
 = 0;

1476 
cÚf_İtiÚ
 *
İt
;

1477 
cÚf_v®ue
 *
cv
;

1479 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[2],
	`sdsEncodedObjeù
(c->argv[2]));

1480 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[3],
	`sdsEncodedObjeù
(c->argv[3]));

1483 
İt
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
c
->
¬gv
[2]->
±r
);

1485 ià(
İt
 =ğ
NULL
) {

1486 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported CONFIG…arameter: %s",

1487 (*)
c
->
¬gv
[2]->
±r
);

1489 } ià(
İt
->
æags
&
CONF_FIELD_FLAGS_NO_MODIFY
) {

1490 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported modifyhis CONFIG…arameter: %s",

1491 (*)
c
->
¬gv
[2]->
±r
);

1495 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

1498 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
CONFIG_SOPN_MAXCLIENTS
)) {

1499 
maxş›Ás
;

1500 
f–im™
, 
th»ads
;

1501 ià(
	`¡ršg2l
(
v®ue
,
	`sd¦’
(v®ue),&
maxş›Ás
è=ğ0 || maxş›Á < 1è
badfmt
;

1502 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_THREADS
,&
th»ads
);

1504 
f–im™
 = 
	`adju¡O³nFesLim™
(()
maxş›Ás
);

1505 ià((
f–im™
-
th»ads
*2-
CONFIG_MIN_RESERVED_FDS
è!ğ
maxş›Ás
) {

1506 
	`addR•lyE¼ÜFÜm©
(
c
,"The operating system is‚ot‡bleo handlehe specified‚umber of clients");

1509 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
CONFIG_SOPN_ADMINPASS
)) {

1510 ià(
c
->
v–
->
cc
.
admš·ss
 && c->
auth’tiÿ‹d
 < 2) {

1511 
	`addR•lyE¼ÜFÜm©
(
c
,"You‚eed‡dminpasso sethis CONFIG…arameter: %s",

1512 (*)
c
->
¬gv
[2]->
±r
);

1517 
f›lds
 = 
	`sds¥l™Ën
(
v®ue
,
	`sd¦’
(v®ue)," ",1,&
f›lds_couÁ
);

1518 ià(
f›lds
 =ğ
NULL
) {

1519 
badfmt
;

1520 } ià(
f›lds_couÁ
 == 0) {

1521 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1522 
cv
->
v®ue
 = 
	`sd£m±y
();

1523 } ià(
f›lds_couÁ
 == 1) {

1524 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1525 
cv
->
v®ue
 = 
f›lds
[0];

1526 
f›lds
[0] = 
NULL
;

1527 } ià(
f›lds_couÁ
 > 1) {

1528 
cÚf_v®ue
 **
cv_sub
;

1529 
ušt32_t
 
i
;

1531 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_ARRAY
);

1532 
i
 = 0; i < 
f›lds_couÁ
; i ++) {

1533 
cv_sub
 = 
	`d¬¿y_push
(
cv
->
v®ue
);

1534 *
cv_sub
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1535 (*
cv_sub
)->
v®ue
 = 
f›lds
[
i
];

1536 
f›lds
[
i
] = 
NULL
;

1539 
	`log_debug
(
LOG_NOTICE
, "f›lds_couÁ: %d", 
f›lds_couÁ
);

1540 
	`£rv”Pªic
("Error config set value");

1542 
	`sdsä“¥l™»s
(
f›lds
,
f›lds_couÁ
);

1545 
»t
 = 
İt
->
	`£t
(
c£rv”
, o±, 
cv
);

1546 
	`cÚf_v®ue_de¡roy
(
cv
);

1547 ià(
»t
 !ğ
VR_OK
) {

1548 
badfmt
;

1552 ià(!
	`¡rcmp
(
İt
->
Çme
,
CONFIG_SOPN_MAXMEMORY
)) {

1553 
maxmemÜy
;

1554 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
maxmemÜy
);

1555 ià(
maxmemÜy
) {

1556 ià(
maxmemÜy
 < 
	`d®loc_u£d_memÜy
()) {

1557 
	`log_w¬n
("WARNING:he‚ew maxmemory value set via CONFIG SET is smallerhanhe current memory usage. This will„esult in keysƒviction‡nd/or inabilityo‡ccept‚ew write commands depending onhe maxmemory-policy.");

1558 
	`ä“MemÜyIfN“ded
(
c
->
v–
);

1564 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1567 
badfmt
:

1568 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for CONFIG SET '%s'",

1569 (*)
v®ue
,

1570 (*)
c
->
¬gv
[2]->
±r
);

1571 
	}
}

1577 
	$addR•lyCÚfO±iÚ
(
ş›Á
 *
c
,
cÚf_İtiÚ
 *
cİ
)

1579 
	`addR•lyBulkCSŒšg
(
c
,
cİ
->
Çme
);

1580 ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_INT
) {

1581 
v®ue
;

1583 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ue
);

1585 ià(!
	`¡rcmp
(
cİ
->
Çme
,
CONFIG_SOPN_MAXMEMORYP
)) {

1586 
	`addR•lyBulkCSŒšg
(
c
,
	`g‘_eviùpŞicy_¡ršgs
(
v®ue
));

1588 
	`addR•lyBulkLÚgLÚg
(
c
,
v®ue
);

1590 } ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_LONGLONG
) {

1591 
v®ue
;

1592 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ue
);

1593 
	`addR•lyBulkLÚgLÚg
(
c
,
v®ue
);

1594 } ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_SDS
) {

1595 
sds
 
v®ue
;

1596 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ue
);

1597 ià(
v®ue
 =ğ
NULL
) {

1598 
	`addR•lyBulkCSŒšg
(
c
,"");

1600 
	`addR•lyBulkSds
(
c
,
v®ue
);

1602 } ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_ARRAYSDS
) {

1603 
d¬¿y
 
v®ues
;

1604 
sds
 
v®ue
 = 
	`sd£m±y
();

1605 
sds
 *
–em
;

1607 
	`d¬¿y_š™
(&
v®ues
,1,(
sds
));

1608 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ues
);

1609 
	`d¬¿y_n
(&
v®ues
) > 0) {

1610 
–em
 = 
	`d¬¿y_pİ
(&
v®ues
);

1611 
v®ue
 = 
	`sdsÿtsds
(v®ue,*
–em
);

1612 
v®ue
 = 
	`sdsÿt
(value," ");

1613 
	`sdsä“
(*
–em
);

1615 
	`d¬¿y_deš™
(&
v®ues
);

1616 ià(
	`sd¦’
(
v®ue
è> 0è
	`sd¤ªge
(value,0,-2);

1617 
	`addR•lyBulkSds
(
c
,
v®ue
);

1619 
	`£rv”Pªic
("Error conf fieldype");

1621 
	}
}

1623 
	$cÚfigG‘Commªd
(
ş›Á
 *
c
) {

1624 
robj
 *
o
 = 
c
->
¬gv
[2];

1625 *
·‰”n
 = 
o
->
±r
;

1626 
cÚf_İtiÚ
 *
cİ
;

1627 
	`£rv”As£¹W™hInfo
(
c
,
o
,
	`sdsEncodedObjeù
(o));

1629 
cİ
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
·‰”n
);

1630 ià(
cİ
 !ğ
NULL
) {

1632 ià(!
	`¡rcmp
(
cİ
->
Çme
,
CONFIG_SOPN_ADMINPASS
) &&

1633 
c
->
v–
->
cc
.
admš·ss
 && c->
auth’tiÿ‹d
 < 2) {

1634 
	`addR•ly
(
c
,
sh¬ed
.
nßdmš”r
);

1636 
	`addR•lyMuÉiBulkL’
(
c
,2);

1637 
	`addR•lyCÚfO±iÚ
(
c
,
cİ
);

1640 
m©ches
 = 0;

1641 * 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1642 
cİ
 = 
cÚf_£rv”_İtiÚs
; cİ&&cİ->
Çme
; cop++) {

1643 ià(
	`¡ršgm©ch
(
·‰”n
,
cİ
->
Çme
,1)) {

1645 ià(!
	`¡rcmp
(
cİ
->
Çme
,
CONFIG_SOPN_ADMINPASS
) &&

1646 
c
->
v–
->
cc
.
admš·ss
 && c->
auth’tiÿ‹d
 < 2)

1649 
	`addR•lyCÚfO±iÚ
(
c
,
cİ
);

1650 
m©ches
 ++;

1653 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
m©ches
*2);

1655 
	}
}

1663 
	s»wr™eCÚfigS‹
 {

1664 
diù
 *
	mİtiÚ_to_lše
;

1665 
diù
 *
	m»wr™‹n
;

1666 
	mnumlšes
;

1667 
sds
 *
	mlšes
;

1668 
	mhas_
;

1674 
	$»wr™eCÚfigAµ’dLše
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
lše
) {

1675 
¡©e
->
lšes
 = 
	`d»®loc
(¡©e->lšes, (*è* (¡©e->
numlšes
+1));

1676 
¡©e
->
lšes
[¡©e->
numlšes
++] = 
lše
;

1677 
	}
}

1681 
	$»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
İtiÚ
, 
lš’um
) {

1682 
dli¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
İtiÚ
);

1684 ià(
l
 =ğ
NULL
) {

1685 
l
 = 
	`dli¡C»©e
();

1686 
	`diùAdd
(
¡©e
->
İtiÚ_to_lše
,
	`sdsdup
(
İtiÚ
),
l
);

1688 
	`dli¡AddNodeTa
(
l
,(*)()
lš’um
);

1689 
	}
}

1691 
diùTy³
 
	gİtiÚToLšeDiùTy³
 = {

1692 
diùSdsCa£Hash
,

1693 
NULL
,

1694 
NULL
,

1695 
diùSdsKeyCa£Com·»
,

1696 
diùSdsDe¡ruùÜ
,

1697 
diùLi¡De¡ruùÜ


1700 
diùTy³
 
	gİtiÚS‘DiùTy³
 = {

1701 
diùSdsCa£Hash
,

1702 
NULL
,

1703 
NULL
,

1704 
diùSdsKeyCa£Com·»
,

1705 
diùSdsDe¡ruùÜ
,

1706 
NULL


1709 
	#CONFIG_MAX_LINE
 1024

	)

1710 
	#REDIS_CONFIG_REWRITE_SIGNATURE
 "# G’”©ed by CONFIG REWRITE"

	)

1716 
»wr™eCÚfigS‹
 *
	$»wr™eCÚfigR—dOldFe
(*
·th
) {

1717 
FILE
 *
å
 = 
	`fİ’
(
·th
,"r");

1718 
»wr™eCÚfigS‹
 *
¡©e
 = 
	`d®loc
((*state));

1719 
buf
[
CONFIG_MAX_LINE
+1];

1720 
lš’um
 = -1;

1722 ià(
å
 =ğ
NULL
 && 
”ºo
 !ğ
ENOENT
)  NULL;

1724 
¡©e
->
İtiÚ_to_lše
 = 
	`diùC»©e
(&
İtiÚToLšeDiùTy³
,
NULL
);

1725 
¡©e
->
»wr™‹n
 = 
	`diùC»©e
(&
İtiÚS‘DiùTy³
,
NULL
);

1726 
¡©e
->
numlšes
 = 0;

1727 
¡©e
->
lšes
 = 
NULL
;

1728 
¡©e
->
has_
 = 0;

1729 ià(
å
 =ğ
NULL
è 
¡©e
;

1732 
	`fg‘s
(
buf
,
CONFIG_MAX_LINE
+1,
å
è!ğ
NULL
) {

1733 
¬gc
;

1734 
sds
 *
¬gv
;

1735 
sds
 
lše
 = 
	`sd¡rim
(
	`sd¢ew
(
buf
),"\r\n\t ");

1737 
lš’um
++;

1740 ià(
lše
[0] == '#' ||†ine[0] == '\0') {

1741 ià(!
¡©e
->
has_
 && !
	`¡rcmp
(
lše
,
REDIS_CONFIG_REWRITE_SIGNATURE
))

1742 
¡©e
->
has_
 = 1;

1743 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1748 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

1749 ià(
¬gv
 =ğ
NULL
) {

1753 
sds
 
aux
 = 
	`sd¢ew
("# ??? ");

1754 
aux
 = 
	`sdsÿtsds
×ux,
lše
);

1755 
	`sdsä“
(
lše
);

1756 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
aux
);

1760 
	`sd¡Şow”
(
¬gv
[0]);

1764 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1765 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
¡©e
,
¬gv
[0],
lš’um
);

1767 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1769 
	`fşo£
(
å
);

1770  
¡©e
;

1771 
	}
}

1777 
	$»wr™eCÚfigM¬kAsProûs£d
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
) {

1778 
sds
 
İt
 = 
	`sd¢ew
(
İtiÚ
);

1780 ià(
	`diùAdd
(
¡©e
->
»wr™‹n
,
İt
,
NULL
è!ğ
DICT_OK
è
	`sdsä“
(opt);

1781 
	}
}

1799 
	$»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
, 
sds
 
lše
, 
fÜû
) {

1800 
sds
 
o
 = 
	`sd¢ew
(
İtiÚ
);

1801 
dli¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
o
);

1803 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1805 ià(!
l
 && !
fÜû
) {

1807 
	`sdsä“
(
lše
);

1808 
	`sdsä“
(
o
);

1812 ià(
l
) {

1813 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
l
);

1814 
lš’um
 = (è
Ê
->
v®ue
;

1818 
	`dli¡D–Node
(
l
,
Ê
);

1819 ià(
	`dli¡L’gth
(
l
è=ğ0è
	`diùD–‘e
(
¡©e
->
İtiÚ_to_lše
,
o
);

1820 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1821 
¡©e
->
lšes
[
lš’um
] = 
lše
;

1824 ià(!
¡©e
->
has_
) {

1825 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,

1826 
	`sd¢ew
(
REDIS_CONFIG_REWRITE_SIGNATURE
));

1827 
¡©e
->
has_
 = 1;

1829 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1831 
	`sdsä“
(
o
);

1832 
	}
}

1835 
	$»wr™eCÚfigR–—£S‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1836 
	`sdsä“¥l™»s
(
¡©e
->
lšes
,¡©e->
numlšes
);

1837 
	`diùR–—£
(
¡©e
->
İtiÚ_to_lše
);

1838 
	`diùR–—£
(
¡©e
->
»wr™‹n
);

1839 
	`dä“
(
¡©e
);

1840 
	}
}

1850 
	$»wr™eCÚfigRemoveO½hªed
(
»wr™eCÚfigS‹
 *
¡©e
) {

1851 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
¡©e
->
İtiÚ_to_lše
);

1852 
diùEÁry
 *
de
;

1854 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1855 
dli¡
 *
l
 = 
	`diùG‘V®
(
de
);

1856 
sds
 
İtiÚ
 = 
	`diùG‘Key
(
de
);

1860 ià(
	`diùFšd
(
¡©e
->
»wr™‹n
,
İtiÚ
è=ğ
NULL
) {

1861 
	`log_debug
(
LOG_DEBUG
,"NÙ„ewr™‹ÀİtiÚ: %s", 
İtiÚ
);

1865 
	`dli¡L’gth
(
l
)) {

1866 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
l
);

1867 
lš’um
 = (è
Ê
->
v®ue
;

1869 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1870 
¡©e
->
lšes
[
lš’um
] = 
	`sd£m±y
();

1871 
	`dli¡D–Node
(
l
,
Ê
);

1874 
	`diùR–—£I‹¿tÜ
(
di
);

1875 
	}
}

1879 
sds
 
	$»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1880 
sds
 
cÚ‹Á
 = 
	`sd£m±y
();

1881 
j
, 
was_em±y
 = 0;

1883 
j
 = 0; j < 
¡©e
->
numlšes
; j++) {

1885 ià(
	`sd¦’
(
¡©e
->
lšes
[
j
]) == 0) {

1886 ià(
was_em±y
) ;

1887 
was_em±y
 = 1;

1889 
was_em±y
 = 0;

1891 
cÚ‹Á
 = 
	`sdsÿtsds
(cÚ‹Á,
¡©e
->
lšes
[
j
]);

1892 
cÚ‹Á
 = 
	`sdsÿ’
(content,"\n",1);

1894  
cÚ‹Á
;

1895 
	}
}

1909 
	$»wr™eCÚfigOv”wr™eFe
(*
cÚfigfe
, 
sds
 
cÚ‹Á
) {

1910 
»tv®
 = 0;

1911 
fd
 = 
	`İ’
(
cÚfigfe
,
O_RDWR
|
O_CREAT
,0644);

1912 
cÚ‹Á_size
 = 
	`sd¦’
(
cÚ‹Á
), 
·ddšg
 = 0;

1913 
¡©
 
sb
;

1914 
sds
 
cÚ‹Á_·dded
;

1918 ià(
fd
 == -1)  -1;

1919 ià(
	`f¡©
(
fd
,&
sb
) == -1) {

1920 
	`şo£
(
fd
);

1925 
cÚ‹Á_·dded
 = 
	`sdsdup
(
cÚ‹Á
);

1926 ià(
cÚ‹Á_size
 < 
sb
.
¡_size
) {

1929 
·ddšg
 = 
sb
.
¡_size
 - 
cÚ‹Á_size
;

1930 
cÚ‹Á_·dded
 = 
	`sdsgrowz”o
(cÚ‹Á_·dded,
sb
.
¡_size
);

1931 
cÚ‹Á_·dded
[
cÚ‹Á_size
] = '\n';

1932 
	`mem£t
(
cÚ‹Á_·dded
+
cÚ‹Á_size
+1,'#',
·ddšg
-1);

1936 ià(
	`wr™e
(
fd
,
cÚ‹Á_·dded
,
	`¡¾’
(content_padded)) == -1) {

1937 
»tv®
 = -1;

1938 
ş—nup
;

1942 ià(
·ddšg
) {

1943 ià(
	`árunÿ‹
(
fd
,
cÚ‹Á_size
) == -1) {

1948 
ş—nup
:

1949 
	`sdsä“
(
cÚ‹Á_·dded
);

1950 
	`şo£
(
fd
);

1951  
»tv®
;

1952 
	}
}

1955 
	$»wr™eCÚfigIÁO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
defv®ue
) {

1956 
v®ue
;

1957 
fÜû
;

1958 
sds
 
lše
;

1960 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1961 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %d",
İtiÚ
,
v®ue
);

1962 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1964 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1965 
	}
}

1968 
	$»wr™eCÚfigSdsO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
sds
 
defv®ue
) {

1969 
sds
 
v®ue
;

1970 
fÜû
;

1971 
sds
 
lše
;

1973 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1974 ià(
defv®ue
 =ğ
NULL
 && 
v®ue
 == NULL) {

1975 
fÜû
 = 0;

1976 } ià(
defv®ue
 !ğ
NULL
 && 
v®ue
 !ğNULL && !
	`sdscmp
(value,defvalue)) {

1977 
fÜû
 = 0;

1979 
fÜû
 = 1;

1982 ià(
v®ue
 =ğ
NULL
) {

1983 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% \"\"",
İtiÚ
);

1985 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
v®ue
);

1986 
	`sdsä“
(
v®ue
);

1989 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1990 
	}
}

1993 
	$»wr™eCÚfigLÚgLÚgO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
defv®ue
) {

1994 
v®ue
;

1995 
fÜû
;

1996 
sds
 
lše
;

1998 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1999 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %Îd",
İtiÚ
,
v®ue
);

2000 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

2002 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2003 
	}
}

2007 
	$»wr™eCÚfigFÜm©MemÜy
(*
buf
, 
size_t
 
Ën
, 
by‹s
) {

2008 
gb
 = 1024*1024*1024;

2009 
mb
 = 1024*1024;

2010 
kb
 = 1024;

2012 ià(
by‹s
 && (by‹ % 
gb
) == 0) {

2013  
	`¢´štf
(
buf
,
Ën
,"%Îdgb",
by‹s
/
gb
);

2014 } ià(
by‹s
 && (by‹ % 
mb
) == 0) {

2015  
	`¢´štf
(
buf
,
Ën
,"%Îdmb",
by‹s
/
mb
);

2016 } ià(
by‹s
 && (by‹ % 
kb
) == 0) {

2017  
	`¢´štf
(
buf
,
Ën
,"%Îdkb",
by‹s
/
kb
);

2019  
	`¢´štf
(
buf
,
Ën
,"%Îd",
by‹s
);

2021 
	}
}

2024 
	$»wr™eCÚfigBy‹sO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
defv®ue
) {

2025 
v®ue
;

2026 
buf
[64];

2027 
fÜû
;

2028 
sds
 
lše
;

2030 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

2031 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

2033 
	`»wr™eCÚfigFÜm©MemÜy
(
buf
,(buf),
v®ue
);

2034 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
buf
);

2035 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2036 
	}
}

2041 
	$»wr™eCÚfigEnumO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
cÚfigEnumG‘SŒFun
 
fun
, 
defv®
) {

2042 
v®ue
;

2043 
sds
 
lše
;

2044 cÚ¡ *
Çme
;

2045 
fÜû
;

2047 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

2048 
fÜû
 = 
v®ue
 !ğ
defv®
;

2049 
Çme
 = 
	`fun
(
v®ue
);

2050 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

2051 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2052 
	}
}

2055 
	$»wr™eCÚfigBšdO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

2056 
d¬¿y
 
v®ues
;

2057 
sds
 *
v®ue
, 
lše
;

2058 
fÜû
 = 1;

2059 *
İtiÚ
 = 
CONFIG_SOPN_BIND
;

2061 
	`d¬¿y_š™
(&
v®ues
,1,(
sds
));

2062 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ues
);

2064 ià(
	`d¬¿y_n
(&
v®ues
) == 0) {

2065 
	`d¬¿y_deš™
(&
v®ues
);

2066 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

2071 
lše
 = 
	`sd¢ew
(
İtiÚ
);

2072 
	`d¬¿y_n
(&
v®ues
) > 0) {

2073 
lše
 = 
	`sdsÿt
(line," ");

2074 
v®ue
 = 
	`d¬¿y_pİ
(&
v®ues
);

2075 
lše
 = 
	`sdsÿtsds
Öše,*
v®ue
);

2076 
	`sdsä“
(*
v®ue
);

2078 
	`d¬¿y_deš™
(&
v®ues
);

2080 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2081 
	}
}

2084 
	$»wr™eCÚfigCommªdsNAPO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

2085 
d¬¿y
 
v®ues
;

2086 
sds
 *
v®ue
, 
lše
;

2087 
fÜû
 = 1;

2088 *
İtiÚ
 = 
CONFIG_SOPN_COMMANDSNAP
;

2090 
	`d¬¿y_š™
(&
v®ues
,1,(
sds
));

2091 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ues
);

2093 ià(
	`d¬¿y_n
(&
v®ues
) == 0) {

2094 
	`d¬¿y_deš™
(&
v®ues
);

2095 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

2099 
	`d¬¿y_n
(&
v®ues
) > 0) {

2100 
v®ue
 = 
	`d¬¿y_pİ
(&
v®ues
);

2101 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,*
v®ue
);

2102 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2103 
	`sdsä“
(*
v®ue
);

2105 
	`d¬¿y_deš™
(&
v®ues
);

2106 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

2107 
	}
}

2117 
	$»wr™eCÚfig
(*
·th
) {

2118 
»wr™eCÚfigS‹
 *
¡©e
;

2119 
sds
 
ÃwcÚ‹Á
;

2120 
»tv®
;

2121 
cÚf_İtiÚ
 *
cİ
;

2123 
	`CONFF_LOCK
();

2125 ià((
¡©e
 = 
	`»wr™eCÚfigR—dOldFe
(
·th
)è=ğ
NULL
) {

2126 
	`CONFF_UNLOCK
();

2132 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_DATABASES
,
CONFIG_DEFAULT_LOGICAL_DBNUM
);

2133 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_IDPDATABASE
,
CONFIG_DEFAULT_INTERNAL_DBNUM
);

2134 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXMEMORY
,
CONFIG_DEFAULT_MAXMEMORY
);

2135 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXMEMORYP
,
g‘_eviùpŞicy_¡ršgs
,
CONFIG_DEFAULT_MAXMEMORY_POLICY
);

2136 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXMEMORYS
,
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
);

2137 
	`»wr™eCÚfigLÚgLÚgO±iÚ
(
¡©e
,
CONFIG_SOPN_MTCLIMIT
,
CONFIG_DEFAULT_MAX_TIME_COMPLEXITY_LIMIT
);

2138 
	`»wr™eCÚfigBšdO±iÚ
(
¡©e
);

2139 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_PORT
,
CONFIG_DEFAULT_SERVER_PORT
);

2140 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_THREADS
,
CONFIG_DEFAULT_THREADS_NUM
);

2141 
	`»wr™eCÚfigLÚgLÚgO±iÚ
(
¡©e
,
CONFIG_SOPN_SLOWLOGLST
,
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
);

2142 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_SLOWLOGML
,
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
);

2143 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXCLIENTS
,
CONFIG_DEFAULT_MAX_CLIENTS
);

2144 
	`»wr™eCÚfigSdsO±iÚ
(
¡©e
,
CONFIG_SOPN_REQUIREPASS
,
NULL
);

2145 
	`»wr™eCÚfigSdsO±iÚ
(
¡©e
,
CONFIG_SOPN_ADMINPASS
,
NULL
);

2146 
	`»wr™eCÚfigCommªdsNAPO±iÚ
(
¡©e
);

2151 
	`»wr™eCÚfigRemoveO½hªed
(
¡©e
);

2155 
ÃwcÚ‹Á
 = 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
¡©e
);

2156 
»tv®
 = 
	`»wr™eCÚfigOv”wr™eFe
(
£rv”
.
cÚfigfe
,
ÃwcÚ‹Á
);

2157 
	`CONFF_UNLOCK
();

2159 
	`sdsä“
(
ÃwcÚ‹Á
);

2160 
	`»wr™eCÚfigR–—£S‹
(
¡©e
);

2161  
»tv®
;

2162 
	}
}

2168 
	$cÚfigCommªd
(
ş›Á
 *
c
) {

2170 ià(
£rv”
.
lßdšg
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2171 
	`addR•lyE¼Ü
(
c
,"Only CONFIG GET is‡llowed during†oading");

2175 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

2176 ià(
c
->
¬gc
 !ğ4è
bad¬™y
;

2177 
	`cÚfigS‘Commªd
(
c
);

2178 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2179 ià(
c
->
¬gc
 !ğ3è
bad¬™y
;

2180 
	`cÚfigG‘Commªd
(
c
);

2186  ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"rewrite")) {

2187 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

2188 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

2189 
	`addR•lyE¼Ü
(
c
,"The server is„unning without‡ config file");

2192 ià(
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
) == -1) {

2193 
	`log_w¬n
("CONFIG REWRITE faed: %s", 
	`¡»¼Ü
(
”ºo
));

2194 
	`addR•lyE¼ÜFÜm©
(
c
,"Rewr™šg cÚfig fe: %s", 
	`¡»¼Ü
(
”ºo
));

2196 
	`log_w¬n
("CONFIG REWRITEƒxecuted with success.");

2197 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2200 
	`addR•lyE¼Ü
(
c
,

2206 
bad¬™y
:

2207 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for CONFIG %s",

2208 (*è
c
->
¬gv
[1]->
±r
);

2209 
	}
}

2212 
	$cÚf_ÿche_š™
(
cÚf_ÿche
 *
cc
)

2214 
cc
->
ÿche_v”siÚ
 = 0;

2215 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
cc
->
maxş›Ás
);

2216 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_REQUIREPASS
,&
cc
->
»quœ•ass
);

2217 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_ADMINPASS
,&
cc
->
admš·ss
);

2218 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
cc
->
maxmemÜy
);

2219 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MTCLIMIT
,&
cc
->
max_time_com¶ex™y_lim™
);

2220 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_SLOWLOGLST
,&
cc
->
¦owlog_log_¦ow”_thª
);

2222  
VR_OK
;

2223 
	}
}

2226 
	$cÚf_ÿche_deš™
(
cÚf_ÿche
 *
cc
)

2228 
cc
->
ÿche_v”siÚ
 = 0;

2229 ià(
cc
->
»quœ•ass
 !ğ
NULL
) {

2230 
	`sdsä“
(
cc
->
»quœ•ass
);

2231 
cc
->
»quœ•ass
 = 
NULL
;

2233 ià(
cc
->
admš·ss
 !ğ
NULL
) {

2234 
	`sdsä“
(
cc
->
admš·ss
);

2235 
cc
->
admš·ss
 = 
NULL
;

2238  
VR_OK
;

2239 
	}
}

2242 
	$cÚf_ÿche_upd©e
(
cÚf_ÿche
 *
cc
)

2244 
cv”siÚ
 = 
	`cÚf_v”siÚ_g‘
();

2247 ià(
cv”siÚ
 <ğ
cc
->
ÿche_v”siÚ
) {

2251 ià(
cc
->
»quœ•ass
 !ğ
NULL
) {

2252 
	`sdsä“
(
cc
->
»quœ•ass
);

2253 
cc
->
»quœ•ass
 = 
NULL
;

2255 ià(
cc
->
admš·ss
 !ğ
NULL
) {

2256 
	`sdsä“
(
cc
->
admš·ss
);

2257 
cc
->
admš·ss
 = 
NULL
;

2260 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
cc
->
maxş›Ás
);

2261 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_REQUIREPASS
,&
cc
->
»quœ•ass
);

2262 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_ADMINPASS
,&
cc
->
admš·ss
);

2263 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
cc
->
maxmemÜy
);

2264 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MTCLIMIT
,&
cc
->
max_time_com¶ex™y_lim™
);

2265 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_SLOWLOGLST
,&
cc
->
¦owlog_log_¦ow”_thª
);

2267 
cc
->
ÿche_v”siÚ
 = 
cv”siÚ
;

2269  
VR_OK
;

2270 
	}
}

	@src/vr_conf.c

1 
	~<fú.h
>

3 
	~<vr_cÜe.h
>

5 cÚ¡ *(*
	tcÚfigEnumG‘SŒFun
)(
	tty³
);

7 
	#CONF_TOKEN_ORGANIZATION_START
 "["

	)

8 
	#CONF_TOKEN_ORGANIZATION_END
 "]"

	)

9 
	#CONF_TOKEN_KEY_VALUE_BETWEEN
 ":"

	)

10 
	#CONF_TOKEN_ARRAY_START
 "-"

	)

12 
	#CONF_ORGANIZATION_NAME_COMMAN
 "commÚ"

	)

13 
	#CONF_ORGANIZATION_NAME_SERVER
 "£rv”"

	)

15 
	#CONF_VALUE_YES
 "yes"

	)

16 
	#CONF_VALUE_NO
 "no"

	)

18 
	#CONF_MAX_LINE
 1024

	)

20 
	#CONF_TAG_DEFAULT_TYPE
 
GROUP_TYPE_SINGLE


	)

21 
	#CONF_TAG_DEFAULT_HASH
 
HASH_FNV1_64


	)

22 
	#CONF_TAG_DEFAULT_HASH_TAG
 
NULL


	)

23 
	#CONF_TAG_DEFAULT_DISTRIBUTION
 "k‘ama"

	)

24 
	#CONF_TAG_DEFAULT_REDIS_AUTH
 
NULL


	)

25 
	#CONF_TAG_DEFAULT_REDIS_DB
 0

	)

26 
	#CONF_TAG_DEFAULT_TIMEOUT
 300

	)

27 
	#CONF_TAG_DEFAULT_SERVERS
 "127.0.0.1:6379"

	)

28 
	#CONF_TAG_DEFAULT_LISTEN
 "127.0.0.1:6380"

	)

29 
	#CONF_TAG_DEFAULT_MAXMEMORY
 1073741824

30 
	#CONF_TAG_DEFAULT_THREADS
 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)

	)

31 
	#CONF_TAG_DEFAULT_NOREPLY
 "çl£"

	)

32 
	#CONF_TAG_DEFAULT_RDB_DISKLESS
 "çl£"

	)

34 
	#DEFINE_ACTION
(
_hash
, 
_Çme
è(*)(#_Çme),

	)

35 * 
	ghash_¡ršgs
[] = {

36 
HASH_CODEC
Ğ
DEFINE_ACTION
 )

37 
NULL


39 #undeà
DEFINE_ACTION


41 
	#DEFINE_ACTION
(
_di¡
, 
_Çme
è(*)(#_Çme),

	)

42 * 
	gdi¡_¡ršgs
[] = {

43 
DIST_CODEC
Ğ
DEFINE_ACTION
 )

44 
NULL


46 #undeà
DEFINE_ACTION


48 
	#DEFINE_ACTION
(
_pŞicy
, 
_Çme
è(*)(#_Çme),

	)

50 * 
	geviùpŞicy_¡ršgs
[] = {

51 
EVICTPOLICY_CODEC
Ğ
DEFINE_ACTION
 )

52 
NULL


54 #undeà
DEFINE_ACTION


56 
cÚf_İtiÚ
 
	gcÚf_£rv”_İtiÚs
[] = {

57 { (*)
CONFIG_SOPN_DATABASES
,

58 
CONF_FIELD_TYPE_INT
, 1,

59 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

60 
off£tof
(
cÚf_£rv”
, 
d©aba£s
) },

61 { (*)
CONFIG_SOPN_IDPDATABASE
,

62 
CONF_FIELD_TYPE_INT
, 1,

63 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

64 
off£tof
(
cÚf_£rv”
, 
š‹º®_dbs_³r_d©aba£s
) },

65 { (*)
CONFIG_SOPN_MAXMEMORY
,

66 
CONF_FIELD_TYPE_LONGLONG
, 0,

67 
cÚf_£t_maxmemÜy
, 
cÚf_g‘_lÚglÚg
,

68 
off£tof
(
cÚf_£rv”
, 
maxmemÜy
) },

69 { (*)
CONFIG_SOPN_MAXMEMORYP
,

70 
CONF_FIELD_TYPE_INT
, 0,

71 
cÚf_£t_maxmemÜy_pŞicy
, 
cÚf_g‘_št
,

72 
off£tof
(
cÚf_£rv”
, 
maxmemÜy_pŞicy
) },

73 { (*)
CONFIG_SOPN_MAXMEMORYS
,

74 
CONF_FIELD_TYPE_INT
, 0,

75 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

76 
off£tof
(
cÚf_£rv”
, 
maxmemÜy_§m¶es
) },

77 { (*)
CONFIG_SOPN_MTCLIMIT
,

78 
CONF_FIELD_TYPE_LONGLONG
, 0,

79 
cÚf_£t_lÚglÚg
, 
cÚf_g‘_lÚglÚg
,

80 
off£tof
(
cÚf_£rv”
, 
max_time_com¶ex™y_lim™
) },

81 { (*)
CONFIG_SOPN_BIND
,

82 
CONF_FIELD_TYPE_ARRAYSDS
, 1,

83 
cÚf_£t_¬¿y_sds
, 
cÚf_g‘_¬¿y_sds
,

84 
off£tof
(
cÚf_£rv”
, 
bšds
) },

85 { (*)
CONFIG_SOPN_PORT
,

86 
CONF_FIELD_TYPE_INT
, 1,

87 
cÚf_£t_št
, 
cÚf_g‘_št
,

88 
off£tof
(
cÚf_£rv”
, 
pÜt
) },

89 { (*)
CONFIG_SOPN_THREADS
,

90 
CONF_FIELD_TYPE_INT
, 1,

91 
cÚf_£t_št
, 
cÚf_g‘_št
,

92 
off£tof
(
cÚf_£rv”
, 
th»ads
) },

93 { (*)
CONFIG_SOPN_MAXCLIENTS
,

94 
CONF_FIELD_TYPE_INT
, 0,

95 
cÚf_£t_št_nÚ_z”o
, 
cÚf_g‘_št
,

96 
off£tof
(
cÚf_£rv”
, 
maxş›Ás
) },

97 { (*)
CONFIG_SOPN_SLOWLOGLST
,

98 
CONF_FIELD_TYPE_LONGLONG
, 0,

99 
cÚf_£t_lÚglÚg
, 
cÚf_g‘_lÚglÚg
,

100 
off£tof
(
cÚf_£rv”
, 
¦owlog_log_¦ow”_thª
) },

101 { (*)
CONFIG_SOPN_SLOWLOGML
,

102 
CONF_FIELD_TYPE_INT
, 0,

103 
cÚf_£t_št
, 
cÚf_g‘_št
,

104 
off£tof
(
cÚf_£rv”
, 
¦owlog_max_Ën
) },

105 { (*)
CONFIG_SOPN_REQUIREPASS
,

106 
CONF_FIELD_TYPE_SDS
, 0,

107 
cÚf_£t_·sswÜd
, 
cÚf_g‘_sds
,

108 
off£tof
(
cÚf_£rv”
, 
»quœ•ass
) },

109 { (*)
CONFIG_SOPN_ADMINPASS
,

110 
CONF_FIELD_TYPE_SDS
, 0,

111 
cÚf_£t_·sswÜd
, 
cÚf_g‘_sds
,

112 
off£tof
(
cÚf_£rv”
, 
admš·ss
) },

113 { (*)
CONFIG_SOPN_COMMANDSNAP
,

114 
CONF_FIELD_TYPE_ARRAYSDS
, 1,

115 
cÚf_£t_commªds_Ãed_admš·ss
, 
cÚf_g‘_¬¿y_sds
,

116 
off£tof
(
cÚf_£rv”
, 
commªds_Ãed_admš·ss
) },

117 { 
NULL
, NULL, 0 }

120 
vr_cÚf
 *
	gcÚf
 = 
NULL
;

121 
cÚf_£rv”
 *
	gc£rv”
 = 
NULL
;

124 
	$cÚf_v®ue_dump
(
cÚf_v®ue
 *
cv
, 
log_Ëv–
)

126 
ušt32_t
 
i
;

127 
cÚf_v®ue
 **
cv_sub
;

129 if(
cv
 =ğ
NULL
){

133 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
){

134 
	`log_debug
(
log_Ëv–
, "%.*s", 
	`sd¦’
(
cv
->
v®ue
), cv->value);

135 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

136 
i
 = 0; i < 
	`d¬¿y_n
(
cv
->
v®ue
); i++){

137 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
i
);

138 
	`cÚf_v®ue_dump
(*
cv_sub
, 
log_Ëv–
);

141 
	`NOT_REACHED
();

143 
	}
}

147 
	$cÚf_Ügªiz©iÚ_dump
(
sds
 
Çme
, 
diù
 *
Üg
, 
log_Ëv–
)

149 
diùI‹¿tÜ
 *
di
;

150 
diùEÁry
 *
de
;

151 
sds
 
key
;

152 
cÚf_v®ue
 *
cv
;

154 if(
Çme
 =ğ
NULL
 || 
Üg
 == NULL){

158 
	`log_debug
(
log_Ëv–
, "[%.*s]", 
	`sd¦’
(
Çme
),‚ame);

160 
di
 = 
	`diùG‘I‹¿tÜ
(
Üg
);

162 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
){

163 
key
 = 
	`diùG‘Key
(
de
);

164 
cv
 = 
	`diùG‘V®
(
de
);

166 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
){

167 
	`log_debug
(
log_Ëv–
, "%.*s: %.*s",

168 
	`sd¦’
(
key
), key,

169 
	`sd¦’
(
cv
->
v®ue
), cv->value);

170 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

171 
	`log_debug
(
log_Ëv–
, "%.*s:",
	`sd¦’
(
key
), key);

172 
	`cÚf_v®ue_dump
(
cv
, 
log_Ëv–
);

174 
	`NOT_REACHED
();

178 
	`diùR–—£I‹¿tÜ
(
di
);

179 
	}
}

182 
	$cÚf_Ügªiz©iÚs_dump
(
vr_cÚf
 *
cf
)

184 
diù
 *
Ügs
, *
Üg
;

185 
diùI‹¿tÜ
 *
di
;

186 
diùEÁry
 *
de
;

187 
sds
 
Çme
;

188 
log_Ëv–
 = 
LOG_VERB
;

190 if(
cf
 =ğ
NULL
){

194 
Ügs
 = 
cf
->
Ügªiz©iÚs
;

195 if(
Ügs
 =ğ
NULL
){

196 
	`log_debug
(
log_Ëv–
, "organization is NULL");

200 
di
 = 
	`diùG‘I‹¿tÜ
(
Ügs
);

202 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
){

203 
Çme
 = 
	`diùG‘Key
(
de
);

204 
Üg
 = 
	`diùG‘V®
(
de
);

206 
	`cÚf_Ügªiz©iÚ_dump
(
Çme
, 
Üg
, 
log_Ëv–
);

207 
	`log_debug
(
log_Ëv–
, "");

210 
	`diùR–—£I‹¿tÜ
(
di
);

211 
	}
}

215 
	$cÚf_£t_maxmemÜy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

217 
ušt8_t
 *
p
;

218 
cÚf_v®ue
 *
cv
 = 
d©a
;

219 
v®ue
;

220 *
gt
;

221 
”r
;

223 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

224 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

225 
İt
->
Çme
);

226  
VR_ERROR
;

229 
	`CONF_WLOCK
();

231 
p
 = 
obj
;

232 
gt
 = (*)(
p
 + 
İt
->
off£t
);

234 
v®ue
 = 
	`memtŞl
(
cv
->v®ue, &
”r
);

235 if(
”r
 !ğ0 || 
v®ue
 < 0){

236 
	`CONF_UNLOCK
();

237 
	`log_”rÜ
("value forhe key %s in conf file is invalid",

238 
İt
->
Çme
);

239  
VR_ERROR
;

242 *
gt
 = 
v®ue
;

243 
cÚf
->
v”siÚ
 ++;

244 
	`CONF_UNLOCK
();

245  
VR_OK
;

246 
	}
}

249 
	$cÚf_£t_maxmemÜy_pŞicy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

251 
ušt8_t
 *
p
;

252 
cÚf_v®ue
 *
cv
 = 
d©a
;

253 *
gt
;

254 **
pŞicy
;

256 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

257 
	`log_”rÜ
("conf server inhe conf file is‚ot‡ string");

258  
VR_ERROR
;

261 
	`CONF_WLOCK
();

263 
p
 = 
obj
;

264 
gt
 = (*)(
p
 + 
İt
->
off£t
);

266 
pŞicy
 = 
eviùpŞicy_¡ršgs
; *policy;…olicy ++) {

267 ià(
	`¡rcmp
(
cv
->
v®ue
, *
pŞicy
) == 0) {

269 *
gt
 = 
pŞicy
 - 
eviùpŞicy_¡ršgs
;

274 ià(*
pŞicy
 =ğ
NULL
) {

275 
	`CONF_UNLOCK
();

276 
	`log_”rÜ
("ERROR: Conf maxmemory…olicy '%s' is invalid",

277 
cv
->
v®ue
);

278  
VR_ERROR
;

281 ià(*
gt
 =ğ
MAXMEMORY_VOLATILE_LRU
 || *gˆ=ğ
MAXMEMORY_ALLKEYS_LRU
) {

282 
	`CONF_UNLOCK
();

283 
	`log_”rÜ
("ERROR: Conf maxmemory…olicy‚ow is‚ot support %s‡nd %s",

284 
eviùpŞicy_¡ršgs
[
MAXMEMORY_VOLATILE_LRU
],

285 
eviùpŞicy_¡ršgs
[
MAXMEMORY_ALLKEYS_LRU
]);

286  
VR_ERROR
;

289 
	`CONF_UNLOCK
();

290  
VR_OK
;

291 
	}
}

294 
	$cÚf_£t_št_nÚ_z”o
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

296 
ušt8_t
 *
p
;

297 
cÚf_v®ue
 *
cv
 = 
d©a
;

298 *
gt
;

300 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

301 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

302 
İt
->
Çme
);

303  
VR_ERROR
;

306 
	`CONF_WLOCK
();

309 
p
 = 
obj
;

310 
gt
 = (*)(
p
 + 
İt
->
off£t
);

312 if(!
	`sdsIsNum
(
cv
->
v®ue
)){

313 
	`CONF_UNLOCK
();

314 
	`log_”rÜ
("value ofhe key %s in conf file is‚ot‡‚umber",

315 
İt
->
Çme
);

316  
VR_ERROR
;

319 *
gt
 = 
	`vr_©oi
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

321 ià(*
gt
 < 0) {

322 
	`CONF_UNLOCK
();

323 
	`log_”rÜ
("value ofhe key %s in conf file is invalid",

324 
İt
->
Çme
);

325  
VR_ERROR
;

326 } ià(*
gt
 < 1) {

327 
	`CONF_UNLOCK
();

328 
	`log_”rÜ
("value ofhe key %s in conf file must be 1 or greater",

329 
İt
->
Çme
);

330  
VR_ERROR
;

332 
cÚf
->
v”siÚ
 ++;

333 
	`CONF_UNLOCK
();

334  
VR_OK
;

335 
	}
}

339 
	$cÚf_g‘_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

341 
ušt8_t
 *
p
;

342 
sds
 *
¡r
 = 
d©a
;

343 
sds
 *
gt
;

345 ià(
d©a
 =ğ
NULL
)

346  
VR_ERROR
;

348 
	`CONF_RLOCK
();

349 
p
 = 
obj
;

350 
gt
 = (
sds
*)(
p
 + 
İt
->
off£t
);

351 ià(*
gt
 =ğ
NULL
è*
¡r
 = NULL;

352 *
¡r
 = 
	`sdsdup
(*
gt
);

353 
	`CONF_UNLOCK
();

354  
VR_OK
;

355 
	}
}

358 
	$cÚf_£t_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

360 
ušt8_t
 *
p
;

361 
cÚf_v®ue
 *
cv
 = 
d©a
;

362 
sds
 *
gt
;

364 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

365 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string",

366 
İt
->
Çme
);

367  
VR_ERROR
;

370 
	`CONF_WLOCK
();

371 
p
 = 
obj
;

372 
gt
 = (
sds
*)(
p
 + 
İt
->
off£t
);

374 *
gt
 = 
	`sd¢ewËn
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

375 
cÚf
->
v”siÚ
 ++;

376 
	`CONF_UNLOCK
();

377  
VR_OK
;

378 
	}
}

381 
	$cÚf_£t_·sswÜd
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

383 
ušt8_t
 *
p
;

384 
cÚf_v®ue
 *
cv
 = 
d©a
;

385 
sds
 *
gt
;

387 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

388 
	`log_”rÜ
("Conf…ool %s inhe conf file is‚ot‡ string",

389 
İt
->
Çme
);

390  
VR_ERROR
;

391 } ià(
	`sd¦’
(
cv
->
v®ue
è> 
CONFIG_AUTHPASS_MAX_LEN
) {

392 
	`log_”rÜ
("Password is†ongerhan CONFIG_AUTHPASS_MAX_LEN");

393  
VR_ERROR
;

396 
	`CONF_WLOCK
();

397 
p
 = 
obj
;

398 
gt
 = (
sds
*)(
p
 + 
İt
->
off£t
);

400 ià(*
gt
 !ğ
NULL
è
	`sdsä“
(*gt);

401 ià(
	`sd¦’
(
cv
->
v®ue
è=ğ0è*
gt
 = 
NULL
;

402 *
gt
 = 
	`sd¢ewËn
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

403 
cÚf
->
v”siÚ
 ++;

404 
	`CONF_UNLOCK
();

405  
VR_OK
;

406 
	}
}

409 
	$cÚf_g‘_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

411 
ušt8_t
 *
p
;

412 *
š‹g”
 = 
d©a
;

413 *
gt
;

415 ià(
d©a
 =ğ
NULL
)

416  
VR_ERROR
;

418 
	`CONF_RLOCK
();

419 
p
 = 
obj
;

420 
gt
 = (*)(
p
 + 
İt
->
off£t
);

421 *
š‹g”
 = *
gt
;

422 
	`CONF_UNLOCK
();

423  
VR_OK
;

424 
	}
}

427 
	$cÚf_£t_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

429 
ušt8_t
 *
p
;

430 
cÚf_v®ue
 *
cv
 = 
d©a
;

431 *
gt
;

433 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

434 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

435 
İt
->
Çme
);

436  
VR_ERROR
;

439 
	`CONF_WLOCK
();

441 
p
 = 
obj
;

442 
gt
 = (*)(
p
 + 
İt
->
off£t
);

444 if(!
	`sdsIsNum
(
cv
->
v®ue
)){

445 
	`CONF_UNLOCK
();

446 
	`log_”rÜ
("value ofhe key %s in conf file is‚ot‡‚umber",

447 
İt
->
Çme
);

448  
VR_ERROR
;

451 *
gt
 = 
	`vr_©oi
(
cv
->
v®ue
, 
	`sd¦’
(cv->value));

453 ià(*
gt
 < 0) {

454 
	`CONF_UNLOCK
();

455 
	`log_”rÜ
("value ofhe key %s in conf file is invalid",

456 
İt
->
Çme
);

457  
VR_ERROR
;

459 
cÚf
->
v”siÚ
 ++;

460 
	`CONF_UNLOCK
();

461  
VR_OK
;

462 
	}
}

465 
	$cÚf_g‘_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

467 
ušt8_t
 *
p
;

468 *
š‹g”
 = 
d©a
;

469 *
gt
;

471 ià(
d©a
 =ğ
NULL
)

472  
VR_ERROR
;

474 
	`CONF_RLOCK
();

475 
p
 = 
obj
;

476 
gt
 = (*)(
p
 + 
İt
->
off£t
);

477 *
š‹g”
 = *
gt
;

478 
	`CONF_UNLOCK
();

479  
VR_OK
;

480 
	}
}

483 
	$cÚf_£t_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

485 
ušt8_t
 *
p
;

486 
cÚf_v®ue
 *
cv
 = 
d©a
;

487 *
gt
;

489 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

490 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

491 
İt
->
Çme
);

492  
VR_ERROR
;

495 
	`CONF_WLOCK
();

497 
p
 = 
obj
;

498 
gt
 = (*)(
p
 + 
İt
->
off£t
);

500 ià(!
	`¡ršg2Î
(
cv
->
v®ue
, 
	`sd¦’
(cv->v®ue), 
gt
)) {

501 
	`CONF_UNLOCK
();

502 
	`log_”rÜ
("value ofhe key %s in conf file is invalid",

503 
İt
->
Çme
);

504  
VR_ERROR
;

506 
cÚf
->
v”siÚ
 ++;

507 
	`CONF_UNLOCK
();

508  
VR_OK
;

509 
	}
}

512 
	$cÚf_£t_yesÜno
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

514 
ušt8_t
 *
p
;

515 
cÚf_v®ue
 *
cv
 = 
d©a
;

516 *
gt
;

518 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
){

519 
	`log_”rÜ
("conf…ool %s inhe conf fileƒrror",

520 
İt
->
Çme
);

521  
VR_ERROR
;

524 
	`CONF_WLOCK
();

526 
p
 = 
obj
;

527 
gt
 = (*)(
p
 + 
İt
->
off£t
);

529 if(!
	`¡rÿ£cmp
(
cv
->
v®ue
, 
CONF_VALUE_YES
)){

530 *
gt
 = 1;

531 }if(!
	`¡rÿ£cmp
(
cv
->
v®ue
, 
CONF_VALUE_NO
)){

532 *
gt
 = 0;

534 
	`CONF_UNLOCK
();

535 
	`log_”rÜ
("key %s in conf file must be %s or %s",

536 
İt
->
Çme
, 
CONF_VALUE_YES
, 
CONF_VALUE_NO
);

537  
VR_ERROR
;

539 
cÚf
->
v”siÚ
 ++;

540 
	`CONF_UNLOCK
();

541  
VR_OK
;

542 
	}
}

545 
	$cÚf_£t_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

547 
ušt8_t
 *
p
;

548 
ušt32_t
 
j
;

549 
cÚf_v®ue
 **
cv_sub
, *
cv
 = 
d©a
;

550 
d¬¿y
 *
gt
;

551 
sds
 *
¡r
;

553 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
 &&

554 
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_ARRAY
){

555 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string or‡rray",

556 
İt
->
Çme
);

557  
VR_ERROR
;

558 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

559 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

560 ià((*
cv_sub
)->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
) {

561 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string‡rray",

562 
İt
->
Çme
);

563  
VR_ERROR
;

567 
	`CONF_WLOCK
();

568 
p
 = 
obj
;

569 
gt
 = (
d¬¿y
*)(
p
 + 
İt
->
off£t
);

571 
	`d¬¿y_n
(
gt
) > 0) {

572 
¡r
 = 
	`d¬¿y_pİ
(
gt
);

573 
	`sdsä“
(*
¡r
);

576 ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
) {

577 
¡r
 = 
	`d¬¿y_push
(
gt
);

578 *
¡r
 = 
	`sdsdup
(
cv
->
v®ue
);

579 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

580 
j
 = 0; j < 
	`d¬¿y_n
(
cv
->
v®ue
); j ++) {

581 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

582 
¡r
 = 
	`d¬¿y_push
(
gt
);

583 *
¡r
 = 
	`sdsdup
((*
cv_sub
)->
v®ue
);

586 
cÚf
->
v”siÚ
 ++;

587 
	`CONF_UNLOCK
();

588  
VR_OK
;

589 
	}
}

592 
	$cÚf_£t_commªds_Ãed_admš·ss
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

594 
ušt8_t
 *
p
;

595 
ušt32_t
 
j
;

596 
cÚf_v®ue
 **
cv_sub
, *
cv
 = 
d©a
;

597 
d¬¿y
 *
gt
;

598 
sds
 *
¡r
;

600 if(
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
 &&

601 
cv
->
ty³
 !ğ
CONF_VALUE_TYPE_ARRAY
){

602 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string or‡rray",

603 
İt
->
Çme
);

604  
VR_ERROR
;

605 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

606 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

607 ià((*
cv_sub
)->
ty³
 !ğ
CONF_VALUE_TYPE_STRING
) {

608 
	`log_”rÜ
("conf…ool %s inhe conf file is‚ot‡ string‡rray",

609 
İt
->
Çme
);

610  
VR_ERROR
;

614 
	`CONF_WLOCK
();

615 
p
 = 
obj
;

616 
gt
 = (
d¬¿y
*)(
p
 + 
İt
->
off£t
);

618 
	`d¬¿y_n
(
gt
) > 0) {

619 
¡r
 = 
	`d¬¿y_pİ
(
gt
);

620 
	`sdsä“
(*
¡r
);

623 ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
) {

624 
¡r
 = 
	`d¬¿y_push
(
gt
);

625 *
¡r
 = 
	`sdsdup
(
cv
->
v®ue
);

626 } ià(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
) {

627 
j
 = 0; j < 
	`d¬¿y_n
(
cv
->
v®ue
); j ++) {

628 
cv_sub
 = 
	`d¬¿y_g‘
(
cv
->
v®ue
, 
j
);

629 
¡r
 = 
	`d¬¿y_push
(
gt
);

630 *
¡r
 = 
	`sdsdup
((*
cv_sub
)->
v®ue
);

633 
cÚf
->
v”siÚ
 ++;

634 
	`CONF_UNLOCK
();

635  
VR_OK
;

636 
	}
}

639 
	$cÚf_g‘_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
)

641 
ušt8_t
 *
p
;

642 
ušt32_t
 
j
;

643 
d¬¿y
 *
¡rs
 = 
d©a
;

644 
¬¿y
 *
gt
;

645 
sds
 *
¡r1
, *
¡r2
;

647 ià(
d©a
 =ğ
NULL
) {

648  
VR_ERROR
;

651 
	`CONF_RLOCK
();

652 
p
 = 
obj
;

653 
gt
 = (
d¬¿y
*)(
p
 + 
İt
->
off£t
);

655 
	`ASSERT
(
	`d¬¿y_n
(
¡rs
) == 0);

657 
j
 = 0; j < 
	`d¬¿y_n
(
gt
); j ++) {

658 
¡r1
 = 
	`d¬¿y_g‘
(
gt
, 
j
);

659 
¡r2
 = 
	`d¬¿y_push
(
¡rs
);

660 *
¡r2
 = 
	`sdsdup
(*
¡r1
);

663 
	`CONF_UNLOCK
();

664  
VR_OK
;

665 
	}
}

667 
	$diùCÚfV®ueDe¡ruùÜ
(*
´ivd©a
, *
v®
)

669 
	`DICT_NOTUSED
(
´ivd©a
);

671 
	`cÚf_v®ue_de¡roy
(
v®
);

672 
	}
}

674 
	$diùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

676 
	`DICT_NOTUSED
(
´ivd©a
);

678 
	`diùR–—£
(
v®
);

679 
	}
}

682 
diùTy³
 
	gOrgªiz©iÚDiùTy³
 = {

683 
diùSdsHash
,

684 
NULL
,

685 
NULL
,

686 
diùSdsKeyCom·»
,

687 
diùSdsDe¡ruùÜ
,

688 
diùDe¡ruùÜ


692 
diùTy³
 
	gKeyV®ueDiùTy³
 = {

693 
diùSdsHash
,

694 
NULL
,

695 
NULL
,

696 
diùSdsKeyCom·»
,

697 
diùSdsDe¡ruùÜ
,

698 
diùCÚfV®ueDe¡ruùÜ


702 
diùTy³
 
	gCÚfTabËDiùTy³
 = {

703 
diùSŒCa£Hash
,

704 
NULL
,

705 
NULL
,

706 
diùSŒKeyCa£Com·»
,

707 
NULL
,

708 
NULL


712 
cÚf_v®ue
 *
	$cÚf_v®ue_ü—‹
(
ty³
)

714 
cÚf_v®ue
 *
cv
;

716 
cv
 = 
	`d®loc
((*cv));

717 if(
cv
 =ğ
NULL
){

718  
NULL
;

721 
cv
->
ty³
 =ype;

722 
cv
->
v®ue
 = 
NULL
;

724 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

725 
cv
->
v®ue
 = 
	`d¬¿y_ü—‹
(3, (
cÚf_v®ue
*));

726 if(
cv
->
v®ue
 =ğ
NULL
){

727 
	`dä“
(
cv
);

728  
NULL
;

732  
cv
;

733 
	}
}

736 
	$cÚf_v®ue_de¡roy
(
cÚf_v®ue
 *
cv
)

738 
cÚf_v®ue
 **
cv_sub
;

740 if(
cv
 =ğ
NULL
){

744 if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_UNKNOW
){

745 
	`dä“
(
cv
);

747 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_STRING
){

748 if(
cv
->
v®ue
 !ğ
NULL
){

749 
	`sdsä“
(
cv
->
v®ue
);

751 }if(
cv
->
ty³
 =ğ
CONF_VALUE_TYPE_ARRAY
){

752 if(
cv
->
v®ue
 !ğ
NULL
){

753 
	`d¬¿y_n
(
cv
->
v®ue
) > 0){

754 
cv_sub
 = 
	`d¬¿y_pİ
(
cv
->
v®ue
);

755 
	`cÚf_v®ue_de¡roy
(*
cv_sub
);

758 
	`d¬¿y_de¡roy
(
cv
->
v®ue
);

761 
	`NOT_REACHED
();

764 
	`dä“
(
cv
);

765 
	}
}

768 
	$cÚf_£rv”_š™
(
cÚf_£rv”
 *
cs
)

770 if(
cs
 =ğ
NULL
){

771  
VR_ERROR
;

774 
cs
->
ùabË
 = 
	`diùC»©e
(&
CÚfTabËDiùTy³
,
NULL
);

776 
cs
->
d©aba£s
 = 
CONF_UNSET_NUM
;

777 
cs
->
š‹º®_dbs_³r_d©aba£s
 = 
CONF_UNSET_NUM
;

778 
cs
->
max_time_com¶ex™y_lim™
 = 
CONF_UNSET_NUM
;

779 
cs
->
maxmemÜy
 = 
CONF_UNSET_NUM
;

780 
cs
->
maxmemÜy_pŞicy
 = 
CONF_UNSET_NUM
;

781 
cs
->
maxmemÜy_§m¶es
 = 
CONF_UNSET_NUM
;

782 
cs
->
maxş›Ás
 = 
CONF_UNSET_NUM
;

783 
cs
->
th»ads
 = 
CONF_UNSET_NUM
;

784 
	`d¬¿y_š™
(&
cs
->
bšds
,1,(
sds
));

785 
cs
->
pÜt
 = 
CONF_UNSET_NUM
;

786 
cs
->
»quœ•ass
 = 
CONF_UNSET_PTR
;

787 
cs
->
admš·ss
 = 
CONF_UNSET_PTR
;

788 
cs
->
dœ
 = 
CONF_UNSET_PTR
;

789 
	`d¬¿y_š™
(&
cs
->
commªds_Ãed_admš·ss
,1,(
sds
));

791  
VR_OK
;

792 
	}
}

795 
	$cÚf_£rv”_£t_deçuÉ
(
cÚf_£rv”
 *
cs
)

797 
sds
 *
¡r
;

798 
cÚf_İtiÚ
 *
İt
;

800 if(
cs
 =ğ
NULL
){

801  
VR_ERROR
;

804 
İt
 = 
cÚf_£rv”_İtiÚs
; o±&&İt->
Çme
; opt++) {

805 
	`diùAdd
(
cs
->
ùabË
,
İt
->
Çme
,opt);

808 
cs
->
d©aba£s
 = 
CONFIG_DEFAULT_LOGICAL_DBNUM
;

809 
cs
->
š‹º®_dbs_³r_d©aba£s
 = 
CONFIG_DEFAULT_INTERNAL_DBNUM
;

810 
cs
->
max_time_com¶ex™y_lim™
 = 
CONFIG_DEFAULT_MAX_TIME_COMPLEXITY_LIMIT
;

811 
cs
->
maxmemÜy
 = 
CONFIG_DEFAULT_MAXMEMORY
;

812 
cs
->
maxmemÜy_pŞicy
 = 
CONFIG_DEFAULT_MAXMEMORY_POLICY
;

813 
cs
->
maxmemÜy_§m¶es
 = 
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
;

814 
cs
->
maxş›Ás
 = 
CONFIG_DEFAULT_MAX_CLIENTS
;

815 
cs
->
th»ads
 = 
CONFIG_DEFAULT_THREADS_NUM
;

816 
cs
->
¦owlog_log_¦ow”_thª
 = 
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
;

817 
cs
->
¦owlog_max_Ën
 = 
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
;

818 
cs
->
»quœ•ass
 = 
CONF_UNSET_PTR
;

819 
cs
->
admš·ss
 = 
CONF_UNSET_PTR
;

821 
	`d¬¿y_n
(&
cs
->
bšds
) > 0) {

822 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
bšds
);

823 
	`sdsä“
(*
¡r
);

825 
¡r
 = 
	`d¬¿y_push
(&
cs
->
bšds
);

826 *
¡r
 = 
	`sd¢ew
(
CONFIG_DEFAULT_HOST
);

828 
cs
->
pÜt
 = 
CONFIG_DEFAULT_SERVER_PORT
;

830 ià(
cs
->
dœ
 !ğ
CONF_UNSET_PTR
) {

831 
	`sdsä“
(
cs
->
dœ
);

833 
cs
->
dœ
 = 
	`sd¢ew
(
CONFIG_DEFAULT_DATA_DIR
);

835 
	`d¬¿y_n
(&
cs
->
commªds_Ãed_admš·ss
) > 0) {

836 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
commªds_Ãed_admš·ss
);

837 
	`sdsä“
(*
¡r
);

840  
VR_OK
;

841 
	}
}

843 
	$cÚf_£rv”_deš™
(
cÚf_£rv”
 *
cs
)

845 
sds
 *
¡r
;

847 if(
cs
 =ğ
NULL
){

851 
cs
->
d©aba£s
 = 
CONF_UNSET_NUM
;

852 
cs
->
š‹º®_dbs_³r_d©aba£s
 = 
CONF_UNSET_NUM
;

853 
cs
->
maxmemÜy
 = 
CONF_UNSET_NUM
;

854 
cs
->
maxmemÜy_pŞicy
 = 
CONF_UNSET_NUM
;

855 
cs
->
maxmemÜy_§m¶es
 = 
CONF_UNSET_NUM
;

856 
cs
->
max_time_com¶ex™y_lim™
 = 
CONF_UNSET_NUM
;

857 
cs
->
maxş›Ás
 = 
CONF_UNSET_NUM
;

858 
cs
->
th»ads
 = 
CONF_UNSET_NUM
;

860 
	`d¬¿y_n
(&
cs
->
bšds
) > 0) {

861 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
bšds
);

862 
	`sdsä“
(*
¡r
);

864 
	`d¬¿y_deš™
(&
cs
->
bšds
);

866 
cs
->
pÜt
 = 
CONF_UNSET_NUM
;

868 ià(
cs
->
dœ
 !ğ
CONF_UNSET_PTR
) {

869 
	`sdsä“
(
cs
->
dœ
);

870 
cs
->
dœ
 = 
CONF_UNSET_PTR
;

873 ià(
cs
->
»quœ•ass
 !ğ
CONF_UNSET_PTR
) {

874 
	`sdsä“
(
cs
->
»quœ•ass
);

875 
cs
->
»quœ•ass
 = 
CONF_UNSET_PTR
;

877 ià(
cs
->
admš·ss
 !ğ
CONF_UNSET_PTR
) {

878 
	`sdsä“
(
cs
->
admš·ss
);

879 
cs
->
admš·ss
 = 
CONF_UNSET_PTR
;

882 
	`d¬¿y_n
(&
cs
->
commªds_Ãed_admš·ss
) > 0) {

883 
¡r
 = 
	`d¬¿y_pİ
(&
cs
->
commªds_Ãed_admš·ss
);

884 
	`sdsä“
(*
¡r
);

886 
	`d¬¿y_deš™
(&
cs
->
commªds_Ãed_admš·ss
);

887 
	}
}

891 
	$cÚf_£rv”_g‘
(cÚ¡ *
İtiÚ_Çme
, *
v®ue
)

893 
cÚf_İtiÚ
 *
İt
;

895 
İt
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
İtiÚ_Çme
);

896 ià(
İt
 =ğ
NULL
)

897  
VR_ERROR
;

899  
İt
->
	`g‘
(
c£rv”
, o±, 
v®ue
);

900 
	}
}

903 
	$cÚf_£rv”_£t
(cÚ¡ *
İtiÚ_Çme
, 
cÚf_v®ue
 *
v®ue
)

905 
cÚf_İtiÚ
 *
İt
;

907 
İt
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
İtiÚ_Çme
);

908 ià(
İt
 =ğ
NULL
 || o±->
æags
&
CONF_FIELD_FLAGS_NO_MODIFY
)

909  
VR_ERROR
;

911  
İt
->
	`£t
(
c£rv”
, o±, 
v®ue
);

912 
	}
}

915 
	$cÚf_š™
(
vr_cÚf
 *
cf
)

917 
»t
;

919 if(
cf
 =ğ
NULL
){

920  
VR_ERROR
;

924 
cf
->
âame
 = 
NULL
;

926 
cf
->
Ügªiz©iÚs
 = 
NULL
;

928 
cf
->
v”siÚ
 = 0;

929 
	`±h»ad_rwlock_š™
(&
cf
->
rwl
, 
NULL
);

930 
	`±h»ad_mu‹x_š™
(&
cf
->
æock
, 
NULL
);

932 
cf
->
Ügªiz©iÚs
 = 
	`diùC»©e
(&
Orgªiz©iÚDiùTy³
, 
NULL
);

933 ià(
cf
->
Ügªiz©iÚs
 =ğ
NULL
) {

934  
VR_ERROR
;

938 
	`cÚf_£rv”_š™
(&
cf
->
c£rv”
);

940 
cÚf
 = 
cf
;

942  
VR_OK
;

943 
	}
}

946 
	$cÚf_£t_deçuÉ
(
vr_cÚf
 *
cf
)

948 
	`CONF_WLOCK
();

949 
	`cÚf_£rv”_£t_deçuÉ
(&
cf
->
c£rv”
);

950 
	`CONF_UNLOCK
();

951  
VR_OK
;

952 
	}
}

954 
	$cÚf_deš™
(
vr_cÚf
 *
cf
)

956 if(
cf
 =ğ
NULL
){

960 ià(
cf
->
âame
 !ğ
NULL
) {

961 
	`sdsä“
(
cf
->
âame
);

962 
cf
->
âame
 = 
NULL
;

965 if(
cf
->
Ügªiz©iÚs
 !ğ
NULL
){

966 
	`diùR–—£
(
cf
->
Ügªiz©iÚs
);

967 
cf
->
Ügªiz©iÚs
 = 
NULL
;

970 
	`cÚf_£rv”_deš™
(&
cf
->
c£rv”
);

972 
cf
->
v”siÚ
 = 0;

973 
	`±h»ad_rwlock_de¡roy
(&
cf
->
rwl
);

974 
	`±h»ad_mu‹x_de¡roy
(&
cf
->
æock
);

975 
	}
}

979 
	$cÚf_£rv”_dump
(
cÚf_£rv”
 *
cs
, 
log_Ëv–
)

981 if(
cs
 =ğ
NULL
){

985 
	`log_debug
(
log_Ëv–
, " d©aba£ : %d", 
cs
->
d©aba£s
);

986 
	`log_debug
(
log_Ëv–
, " iÁ”Çl_dbs_³r_d©aba£ : %d", 
cs
->
š‹º®_dbs_³r_d©aba£s
);

987 
	`log_debug
(
log_Ëv–
, " maxmemÜy : %Îd", 
cs
->
maxmemÜy
);

988 
	`log_debug
(
log_Ëv–
, " maxmemÜy_pŞicy : %d", 
cs
->
maxmemÜy_pŞicy
);

989 
	`log_debug
(
log_Ëv–
, " maxmemÜy_§m¶e : %d", 
cs
->
maxmemÜy_§m¶es
);

990 
	`log_debug
(
log_Ëv–
, " max_time_com¶ex™y_lim™ : %Îd", 
cs
->
max_time_com¶ex™y_lim™
);

991 
	}
}

995 
	$cÚf_dump
(
vr_cÚf
 *
cf
)

997 
log_Ëv–
 = 
LOG_VERB
;

998 
cÚf_£rv”
 *
cs
;

1000 if(
cf
 =ğ
NULL
){

1004 
cs
 = &
cf
->
c£rv”
;

1005 
	`log_debug
(
log_Ëv–
, "server in conf file");

1006 
	`cÚf_£rv”_dump
(
cs
, 
log_Ëv–
);

1007 
	`log_debug
(
log_Ëv–
, "");

1008 
	}
}

1015 
	$cÚf_key_v®ue_š£¹
(
diù
 *
Üg
, 
sds
 
key
, 
cÚf_v®ue
 *
cv
)

1017 ià(
key
 =ğ
NULL
) {

1018 
	`log_”rÜ
("value in conf file has‚o key");

1022 ià(
cv
 =ğ
NULL
) {

1023 
	`log_”rÜ
("key % š cÚàfha nØv®ue", 
key
);

1027 ià(
Üg
 =ğ
NULL
) {

1028 
	`log_”rÜ
("key %s in conf file has‚o organization",

1029 
key
);

1033 ià(
	`diùAdd
(
Üg
,
key
,
cv
è!ğ
DICT_OK
) {

1034 
diùEÁry
 *
de
;

1035 
cÚf_v®ue
 *
cv_Şd
, *
cv_Ãw
, **
cv_sub
;

1036 
de
 = 
	`diùFšd
(
Üg
,
key
);

1037 
cv_Şd
 = 
	`diùG‘V®
(
de
);

1038 ià(
cv_Şd
->
ty³
 !ğ
CONF_VALUE_TYPE_ARRAY
) {

1039 
cv_Ãw
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_ARRAY
);

1040 
cv_sub
 = 
	`d¬¿y_push
(
cv_Ãw
->
v®ue
);

1041 *
cv_sub
 = 
cv_Şd
;

1042 
cv_sub
 = 
	`d¬¿y_push
(
cv_Ãw
->
v®ue
);

1043 *
cv_sub
 = 
cv
;

1044 
	`diùS‘V®
(
Üg
,
de
,
cv_Ãw
);

1046 
cv_sub
 = 
	`d¬¿y_push
(
cv_Şd
->
v®ue
);

1047 *
cv_sub
 = 
cv
;

1053 
	}
}

1057 
	$cÚf_´e_lßd_äom_¡ršg
(
vr_cÚf
 *
cf
, *
cÚfig
)

1059 
»t
;

1060 
lš’um
 = 0, 
tÙlšes
, 
i
, 
j
;

1061 
¦aveof_lš’um
 = 0;

1062 
sds
 *
lšes
 = 
NULL
;

1063 
diù
 *
Üg
 = 
NULL
;

1064 
sds
 
Üg_Çme
 = 
NULL
;

1065 
diùEÁry
 *
de
;

1066 
sds
 
key
 = 
NULL
;

1067 
cÚf_v®ue
 *
cv
 = 
NULL
;

1069 
lšes
 = 
	`sds¥l™Ën
(
cÚfig
,
	`¡¾’
(cÚfig),"\n",1,&
tÙlšes
);

1073 
i
 = 0; i < 
tÙlšes
; i++) {

1074 
sds
 *
¬gv
;

1075 
¬gc
;

1077 
lš’um
 = 
i
+1;

1079 
lšes
[
i
] = 
	`sd¡rim
(lines[i]," \t\r\n");

1083 ià(
lšes
[
i
][0] == '#' ||†ines[i][0] == '\0') ;

1086 ià(
lšes
[
i
][0] == '[') {

1088 ià(
	`sd¦’
(
lšes
[
i
]) <= 2 ||†ines[i][sdslen(lines[i])-1] == ']') {

1089 
	`log_”rÜ
("Organization‚ame %s in conf file %sƒrror",

1090 
lšes
[
i
], 
cf
->
âame
);

1091 
lßd”r
;

1094 
Üg_Çme
 = 
	`sd¢ewËn
(
lšes
[
i
]+1,
	`sd¦’
(lines[i])-2);

1095 
de
 = 
	`diùFšd
(
cf
->
Ügªiz©iÚs
,
Üg_Çme
);

1096 ià(
de
 =ğ
NULL
) {

1098 
Üg
 = 
	`diùC»©e
(&
KeyV®ueDiùTy³
, 
NULL
);

1099 
	`diùAdd
(
cf
->
Ügªiz©iÚs
,
Üg_Çme
,
Üg
);

1102 
Üg
 = 
	`diùG‘V®
(
de
);

1103 
	`sdsä“
(
Üg_Çme
);

1112 
¬gv
 = 
	`sds¥l™¬gs
(
lšes
[
i
],&
¬gc
);

1113 ià(
¬gv
 =ğ
NULL
) {

1114 
	`log_”rÜ
("Unbalanced quotes in configuration†ine");

1115 
lßd”r
;

1119 ià(
¬gc
 == 0) {

1120 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1124 
	`sd¡Şow”
(
¬gv
[0]);

1127 ià(
Üg
 =ğ
NULL
) {

1128 
Üg_Çme
 = 
	`sd¢ew
("server");

1129 
Üg
 = 
	`diùC»©e
(&
KeyV®ueDiùTy³
, 
NULL
);

1130 
	`diùAdd
(
cf
->
Ügªiz©iÚs
,
Üg_Çme
,
Üg
);

1134 
key
 = 
¬gv
[0];

1135 
¬gv
[0] = 
NULL
;

1136 
j
 = 1; j < 
¬gc
; j ++) {

1138 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1139 
cv
->
v®ue
 = 
¬gv
[
j
];

1140 
¬gv
[
j
] = 
NULL
;

1141 
»t
 = 
	`cÚf_key_v®ue_š£¹
(
Üg
, 
key
, 
cv
);

1142 if(
»t
 == -1){

1143 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1144 
	`sdsä“
(
key
);

1145 
	`cÚf_v®ue_de¡roy
(
cv
);

1146 
	`log_”rÜ
("key value insert into organization failed");

1147 
lßd”r
;

1148 } ià(
j
 =ğ1 && 
»t
 == 0) {

1149 
	`sdsä“
(
key
);

1153 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1156 ià(
lšes
) {

1157 
	`sdsä“¥l™»s
(
lšes
,
lš’um
);

1159  
VR_OK
;

1161 
lßd”r
:

1162 ià(
lšes
) {

1163 
	`sdsä“¥l™»s
(
lšes
,
lš’um
);

1165  
VR_ERROR
;

1166 
	}
}

1170 
	$cÚf_´e_v®id©e
(
vr_cÚf
 *
cf
)

1172 
»t
;

1173 
sds
 
cÚfig
 = 
	`sd£m±y
();

1174 
buf
[
CONF_MAX_LINE
+1];

1178 ià(
cf
->
âame
) {

1179 
FILE
 *
å
;

1181 ià(
cf
->
âame
[0] == '-' && cf->fname[1] == '\0') {

1182 
å
 = 
¡dš
;

1184 ià((
å
 = 
	`fİ’
(
cf
->
âame
,"r")è=ğ
NULL
) {

1185 
	`log_”rÜ
("O³ÀcÚfig f'%s' faed: %s", 
cf
->
âame
, 
	`¡»¼Ü
(
”ºo
));

1186 
	`sdsä“
(
cÚfig
);

1187  
VR_ERROR
;

1190 
	`fg‘s
(
buf
,
CONF_MAX_LINE
+1,
å
è!ğ
NULL
)

1191 
cÚfig
 = 
	`sdsÿt
(cÚfig,
buf
);

1192 ià(
å
 !ğ
¡dš
è
	`fşo£
(fp);

1195 
»t
 = 
	`cÚf_´e_lßd_äom_¡ršg
(
cf
,
cÚfig
);

1196 ià(
»t
 !ğ
VR_OK
) {

1197 
	`sdsä“
(
cÚfig
);

1198  
VR_ERROR
;

1201 
	`sdsä“
(
cÚfig
);

1202  
VR_OK
;

1203 
	}
}

1207 
	$cÚf_·r£_cÚf_£rv”
(
cÚf_£rv”
 *
cs
, 
diù
 *
Üg
)

1209 
»t
;

1210 
cÚf_İtiÚ
 *
İt
;

1211 
diùEÁry
 *
de
;

1212 
sds
 
key
;

1214 if(
cs
 =ğ
NULL
 || 
Üg
 == NULL){

1215  
VR_ERROR
;

1218 
key
 = 
	`sd£m±y
();

1220 
İt
 = 
cÚf_£rv”_İtiÚs
; o±&&İt->
Çme
; opt++) {

1221 
key
 = 
	`sdsıy
(key,
İt
->
Çme
);

1223 
de
 = 
	`diùFšd
(
Üg
,
key
);

1225 ià(
de
 !ğ
NULL
) {

1227 
»t
 = 
İt
->
	`£t
(
cs
, o±, 
	`diùG‘V®
(
de
));

1228 if(
»t
 !ğ
VR_OK
){

1229 
	`log_”rÜ
("·r£ key % š cÚàf”rÜ", 
key
);

1230 
	`sdsä“
(
key
);

1231  
VR_ERROR
;

1236 
	`sdsä“
(
key
);

1237  
VR_OK
;

1238 
	}
}

1243 
	$cÚf_·r£
(
vr_cÚf
 *
cf
)

1245 
»t
;

1246 
diù
 *
Ügs
, *
Üg
;

1247 
diùEÁry
 *
de
;

1248 
sds
 
key
;

1250 ià(
cf
 =ğ
NULL
) {

1251  
VR_ERROR
;

1254 
Ügs
 = 
cf
->
Ügªiz©iÚs
;

1255 ià(
Ügs
 =ğ
NULL
) {

1256  
VR_ERROR
;

1261 
key
 = 
	`sd¢ew
(
CONF_ORGANIZATION_NAME_SERVER
);

1262 
de
 = 
	`diùFšd
(
Ügs
, 
key
);

1263 ià(
de
 =ğ
NULL
) {

1264 
	`log_”rÜ
("can‚ot find %s organization in conf file %s",

1265 
CONF_ORGANIZATION_NAME_SERVER
, 
cf
->
âame
);

1266 
	`sdsä“
(
key
);

1267  
VR_ERROR
;

1270 
Üg
 = 
	`diùG‘V®
(
de
);

1271 ià(
Üg
 =ğ
NULL
) {

1272 
	`log_”rÜ
("diù % ’Œy v®ui NULL", 
	`diùG‘Key
(
de
));

1273 
	`sdsä“
(
key
);

1274  
VR_ERROR
;

1278 
»t
 = 
	`cÚf_·r£_cÚf_£rv”
(&
cf
->
c£rv”
, 
Üg
);

1279 ifĞ
»t
 !ğ
VR_OK
) {

1280 
	`log_”rÜ
("common conf…arseƒrror");

1281 
	`sdsä“
(
key
);

1282  
VR_ERROR
;

1285 
	`sdsä“
(
key
);

1287  
VR_OK
;

1288 
	}
}

1292 
	$cÚf_po¡_v®id©e
(
vr_cÚf
 *
cf
)

1294 if(
cf
 =ğ
NULL
){

1295  
VR_ERROR
;

1298 if(
cf
->
Ügªiz©iÚs
 !ğ
NULL
){

1299 
	`diùR–—£
(
cf
->
Ügªiz©iÚs
);

1300 
cf
->
Ügªiz©iÚs
 = 
NULL
;

1303  
VR_OK
;

1304 
	}
}

1306 
vr_cÚf
 *

1307 
	$cÚf_İ’
(*
f’ame
)

1309 
»t
;

1310 
vr_cÚf
 *
cf
 = 
NULL
;

1311 
sds
 
·th
 = 
NULL
;

1313 ià(
f’ame
 =ğ
NULL
) {

1314 
	`log_”rÜ
("configuration file‚ame is NULL.");

1315  
NULL
;

1318 
·th
 = 
	`g‘AbsŞu‹P©h
(
f’ame
);

1319 ià(
·th
 =ğ
NULL
) {

1320 
	`log_”rÜ
("cÚfigu¿tiÚ fÇm'%s' i ”rÜ.", 
f’ame
);

1321 
”rÜ
;

1324 
cf
 = 
	`d®loc
((*cf));

1325 ià(
cf
 =ğ
NULL
) {

1326 
”rÜ
;

1329 
»t
 = 
	`cÚf_š™
(
cf
);

1330 if(
»t
 !ğ
VR_OK
){

1331 
”rÜ
;

1335 
»t
 = 
	`cÚf_£t_deçuÉ
(
cf
);

1336 ià(
»t
 !ğ
VR_OK
) {

1337 
”rÜ
;

1340 
cf
->
âame
 = 
·th
;

1342  
cf
;

1344 
”rÜ
:

1346 ià(
cf
 !ğ
NULL
) {

1347 
	`cÚf_de¡roy
(
cf
);

1350 ià(
·th
 !ğ
NULL
) {

1351 
	`sdsä“
(
·th
);

1354  
NULL
;

1355 
	}
}

1358 
vr_cÚf
 *

1359 
	$cÚf_ü—‹
(*
f’ame
)

1361 
»t
;

1362 
vr_cÚf
 *
cf
;

1364 
cf
 = 
	`cÚf_İ’
(
f’ame
);

1365 ià(
cf
 =ğ
NULL
) {

1366  
NULL
;

1371 
»t
 = 
	`cÚf_´e_v®id©e
(
cf
);

1372 ià(
»t
 !ğ
VR_OK
) {

1373 
”rÜ
;

1377 
	`cÚf_Ügªiz©iÚs_dump
(
cf
);

1381 
»t
 = 
	`cÚf_·r£
(
cf
);

1382 ià(
»t
 !ğ
VR_OK
) {

1383 
”rÜ
;

1387 
»t
 = 
	`cÚf_po¡_v®id©e
(
cf
);

1388 ià(
»t
 !ğ
VR_OK
) {

1389 
”rÜ
;

1392 
	`cÚf_dump
(
cf
);

1394 
c£rv”
 = &
cf
->cserver;

1396  
cf
;

1398 
”rÜ
:

1399 
	`cÚf_de¡roy
(
cf
);

1400  
NULL
;

1401 
	}
}

1404 
	$cÚf_de¡roy
(
vr_cÚf
 *
cf
)

1406 ià(
cf
 =ğ
NULL
) {

1410 
	`cÚf_deš™
(
cf
);

1412 
	`dä“
(
cf
);

1413 
	}
}

1416 
	$cÚf_v”siÚ_g‘
()

1418 
v”siÚ
;

1420 
	`CONF_RLOCK
();

1421 
v”siÚ
 = 
cÚf
->version;

1422 
	`CONF_UNLOCK
();

1424  
v”siÚ
;

1425 
	}
}

1429 
	$CONF_RLOCK
()

1431  
	`±h»ad_rwlock_rdlock
(&
cÚf
->
rwl
);

1432 
	}
}

1435 
	$CONF_WLOCK
()

1437  
	`±h»ad_rwlock_w¾ock
(&
cÚf
->
rwl
);

1438 
	}
}

1442 
	$CONF_UNLOCK
()

1444  
	`±h»ad_rwlock_uÆock
(&
cÚf
->
rwl
);

1445 
	}
}

1449 
	$CONFF_LOCK
()

1451  
	`±h»ad_mu‹x_lock
(&
cÚf
->
æock
);

1452 
	}
}

1455 
	$CONFF_UNLOCK
()

1457  
	`±h»ad_mu‹x_uÆock
(&
cÚf
->
æock
);

1458 
	}
}

1461 
	$g‘_eviùpŞicy_¡ršgs
(
eviùpŞicy_ty³
)

1463  
eviùpŞicy_¡ršgs
[
eviùpŞicy_ty³
];

1464 
	}
}

1471 
	$cÚfigS‘Commªd
(
ş›Á
 *
c
) {

1472 
»t
;

1473 
sds
 
v®ue
;

1474 
sds
 *
f›lds
;

1475 
f›lds_couÁ
 = 0;

1476 
cÚf_İtiÚ
 *
İt
;

1477 
cÚf_v®ue
 *
cv
;

1479 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[2],
	`sdsEncodedObjeù
(c->argv[2]));

1480 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[3],
	`sdsEncodedObjeù
(c->argv[3]));

1483 
İt
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
c
->
¬gv
[2]->
±r
);

1485 ià(
İt
 =ğ
NULL
) {

1486 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported CONFIG…arameter: %s",

1487 (*)
c
->
¬gv
[2]->
±r
);

1489 } ià(
İt
->
æags
&
CONF_FIELD_FLAGS_NO_MODIFY
) {

1490 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported modifyhis CONFIG…arameter: %s",

1491 (*)
c
->
¬gv
[2]->
±r
);

1495 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

1498 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
CONFIG_SOPN_MAXCLIENTS
)) {

1499 
maxş›Ás
;

1500 
f–im™
, 
th»ads
;

1501 ià(
	`¡ršg2l
(
v®ue
,
	`sd¦’
(v®ue),&
maxş›Ás
è=ğ0 || maxş›Á < 1è
badfmt
;

1502 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_THREADS
,&
th»ads
);

1504 
f–im™
 = 
	`adju¡O³nFesLim™
(()
maxş›Ás
);

1505 ià((
f–im™
-
th»ads
*2-
CONFIG_MIN_RESERVED_FDS
è!ğ
maxş›Ás
) {

1506 
	`addR•lyE¼ÜFÜm©
(
c
,"The operating system is‚ot‡bleo handlehe specified‚umber of clients");

1509 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
CONFIG_SOPN_ADMINPASS
)) {

1510 ià(
c
->
v–
->
cc
.
admš·ss
 && c->
auth’tiÿ‹d
 < 2) {

1511 
	`addR•lyE¼ÜFÜm©
(
c
,"You‚eed‡dminpasso sethis CONFIG…arameter: %s",

1512 (*)
c
->
¬gv
[2]->
±r
);

1517 
f›lds
 = 
	`sds¥l™Ën
(
v®ue
,
	`sd¦’
(v®ue)," ",1,&
f›lds_couÁ
);

1518 ià(
f›lds
 =ğ
NULL
) {

1519 
badfmt
;

1520 } ià(
f›lds_couÁ
 == 0) {

1521 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1522 
cv
->
v®ue
 = 
	`sd£m±y
();

1523 } ià(
f›lds_couÁ
 == 1) {

1524 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1525 
cv
->
v®ue
 = 
f›lds
[0];

1526 
f›lds
[0] = 
NULL
;

1527 } ià(
f›lds_couÁ
 > 1) {

1528 
cÚf_v®ue
 **
cv_sub
;

1529 
ušt32_t
 
i
;

1531 
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_ARRAY
);

1532 
i
 = 0; i < 
f›lds_couÁ
; i ++) {

1533 
cv_sub
 = 
	`d¬¿y_push
(
cv
->
v®ue
);

1534 *
cv_sub
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1535 (*
cv_sub
)->
v®ue
 = 
f›lds
[
i
];

1536 
f›lds
[
i
] = 
NULL
;

1539 
	`log_debug
(
LOG_NOTICE
, "f›lds_couÁ: %d", 
f›lds_couÁ
);

1540 
	`£rv”Pªic
("Error config set value");

1542 
	`sdsä“¥l™»s
(
f›lds
,
f›lds_couÁ
);

1545 
»t
 = 
İt
->
	`£t
(
c£rv”
, o±, 
cv
);

1546 
	`cÚf_v®ue_de¡roy
(
cv
);

1547 ià(
»t
 !ğ
VR_OK
) {

1548 
badfmt
;

1552 ià(!
	`¡rcmp
(
İt
->
Çme
,
CONFIG_SOPN_MAXMEMORY
)) {

1553 
maxmemÜy
;

1554 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
maxmemÜy
);

1555 ià(
maxmemÜy
) {

1556 ià(
maxmemÜy
 < 
	`d®loc_u£d_memÜy
()) {

1557 
	`log_w¬n
("WARNING:he‚ew maxmemory value set via CONFIG SET is smallerhanhe current memory usage. This will„esult in keysƒviction‡nd/or inabilityo‡ccept‚ew write commands depending onhe maxmemory-policy.");

1558 
	`ä“MemÜyIfN“ded
(
c
->
v–
);

1564 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1567 
badfmt
:

1568 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for CONFIG SET '%s'",

1569 (*)
v®ue
,

1570 (*)
c
->
¬gv
[2]->
±r
);

1571 
	}
}

1577 
	$addR•lyCÚfO±iÚ
(
ş›Á
 *
c
,
cÚf_İtiÚ
 *
cİ
)

1579 
	`addR•lyBulkCSŒšg
(
c
,
cİ
->
Çme
);

1580 ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_INT
) {

1581 
v®ue
;

1583 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ue
);

1585 ià(!
	`¡rcmp
(
cİ
->
Çme
,
CONFIG_SOPN_MAXMEMORYP
)) {

1586 
	`addR•lyBulkCSŒšg
(
c
,
	`g‘_eviùpŞicy_¡ršgs
(
v®ue
));

1588 
	`addR•lyBulkLÚgLÚg
(
c
,
v®ue
);

1590 } ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_LONGLONG
) {

1591 
v®ue
;

1592 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ue
);

1593 
	`addR•lyBulkLÚgLÚg
(
c
,
v®ue
);

1594 } ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_SDS
) {

1595 
sds
 
v®ue
;

1596 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ue
);

1597 ià(
v®ue
 =ğ
NULL
) {

1598 
	`addR•lyBulkCSŒšg
(
c
,"");

1600 
	`addR•lyBulkSds
(
c
,
v®ue
);

1602 } ià(
cİ
->
ty³
 =ğ
CONF_FIELD_TYPE_ARRAYSDS
) {

1603 
d¬¿y
 
v®ues
;

1604 
sds
 
v®ue
 = 
	`sd£m±y
();

1605 
sds
 *
–em
;

1607 
	`d¬¿y_š™
(&
v®ues
,1,(
sds
));

1608 
	`cÚf_£rv”_g‘
(
cİ
->
Çme
,&
v®ues
);

1609 
	`d¬¿y_n
(&
v®ues
) > 0) {

1610 
–em
 = 
	`d¬¿y_pİ
(&
v®ues
);

1611 
v®ue
 = 
	`sdsÿtsds
(v®ue,*
–em
);

1612 
v®ue
 = 
	`sdsÿt
(value," ");

1613 
	`sdsä“
(*
–em
);

1615 
	`d¬¿y_deš™
(&
v®ues
);

1616 ià(
	`sd¦’
(
v®ue
è> 0è
	`sd¤ªge
(value,0,-2);

1617 
	`addR•lyBulkSds
(
c
,
v®ue
);

1619 
	`£rv”Pªic
("Error conf fieldype");

1621 
	}
}

1623 
	$cÚfigG‘Commªd
(
ş›Á
 *
c
) {

1624 
robj
 *
o
 = 
c
->
¬gv
[2];

1625 *
·‰”n
 = 
o
->
±r
;

1626 
cÚf_İtiÚ
 *
cİ
;

1627 
	`£rv”As£¹W™hInfo
(
c
,
o
,
	`sdsEncodedObjeù
(o));

1629 
cİ
 = 
	`diùF‘chV®ue
(
c£rv”
->
ùabË
, 
·‰”n
);

1630 ià(
cİ
 !ğ
NULL
) {

1632 ià(!
	`¡rcmp
(
cİ
->
Çme
,
CONFIG_SOPN_ADMINPASS
) &&

1633 
c
->
v–
->
cc
.
admš·ss
 && c->
auth’tiÿ‹d
 < 2) {

1634 
	`addR•ly
(
c
,
sh¬ed
.
nßdmš”r
);

1636 
	`addR•lyMuÉiBulkL’
(
c
,2);

1637 
	`addR•lyCÚfO±iÚ
(
c
,
cİ
);

1640 
m©ches
 = 0;

1641 * 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1642 
cİ
 = 
cÚf_£rv”_İtiÚs
; cİ&&cİ->
Çme
; cop++) {

1643 ià(
	`¡ršgm©ch
(
·‰”n
,
cİ
->
Çme
,1)) {

1645 ià(!
	`¡rcmp
(
cİ
->
Çme
,
CONFIG_SOPN_ADMINPASS
) &&

1646 
c
->
v–
->
cc
.
admš·ss
 && c->
auth’tiÿ‹d
 < 2)

1649 
	`addR•lyCÚfO±iÚ
(
c
,
cİ
);

1650 
m©ches
 ++;

1653 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
m©ches
*2);

1655 
	}
}

1663 
	s»wr™eCÚfigS‹
 {

1664 
diù
 *
	mİtiÚ_to_lše
;

1665 
diù
 *
	m»wr™‹n
;

1666 
	mnumlšes
;

1667 
sds
 *
	mlšes
;

1668 
	mhas_
;

1674 
	$»wr™eCÚfigAµ’dLše
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
lše
) {

1675 
¡©e
->
lšes
 = 
	`d»®loc
(¡©e->lšes, (*è* (¡©e->
numlšes
+1));

1676 
¡©e
->
lšes
[¡©e->
numlšes
++] = 
lše
;

1677 
	}
}

1681 
	$»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
İtiÚ
, 
lš’um
) {

1682 
dli¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
İtiÚ
);

1684 ià(
l
 =ğ
NULL
) {

1685 
l
 = 
	`dli¡C»©e
();

1686 
	`diùAdd
(
¡©e
->
İtiÚ_to_lše
,
	`sdsdup
(
İtiÚ
),
l
);

1688 
	`dli¡AddNodeTa
(
l
,(*)()
lš’um
);

1689 
	}
}

1691 
diùTy³
 
	gİtiÚToLšeDiùTy³
 = {

1692 
diùSdsCa£Hash
,

1693 
NULL
,

1694 
NULL
,

1695 
diùSdsKeyCa£Com·»
,

1696 
diùSdsDe¡ruùÜ
,

1697 
diùLi¡De¡ruùÜ


1700 
diùTy³
 
	gİtiÚS‘DiùTy³
 = {

1701 
diùSdsCa£Hash
,

1702 
NULL
,

1703 
NULL
,

1704 
diùSdsKeyCa£Com·»
,

1705 
diùSdsDe¡ruùÜ
,

1706 
NULL


1709 
	#CONFIG_MAX_LINE
 1024

	)

1710 
	#REDIS_CONFIG_REWRITE_SIGNATURE
 "# G’”©ed by CONFIG REWRITE"

	)

1716 
»wr™eCÚfigS‹
 *
	$»wr™eCÚfigR—dOldFe
(*
·th
) {

1717 
FILE
 *
å
 = 
	`fİ’
(
·th
,"r");

1718 
»wr™eCÚfigS‹
 *
¡©e
 = 
	`d®loc
((*state));

1719 
buf
[
CONFIG_MAX_LINE
+1];

1720 
lš’um
 = -1;

1722 ià(
å
 =ğ
NULL
 && 
”ºo
 !ğ
ENOENT
)  NULL;

1724 
¡©e
->
İtiÚ_to_lše
 = 
	`diùC»©e
(&
İtiÚToLšeDiùTy³
,
NULL
);

1725 
¡©e
->
»wr™‹n
 = 
	`diùC»©e
(&
İtiÚS‘DiùTy³
,
NULL
);

1726 
¡©e
->
numlšes
 = 0;

1727 
¡©e
->
lšes
 = 
NULL
;

1728 
¡©e
->
has_
 = 0;

1729 ià(
å
 =ğ
NULL
è 
¡©e
;

1732 
	`fg‘s
(
buf
,
CONFIG_MAX_LINE
+1,
å
è!ğ
NULL
) {

1733 
¬gc
;

1734 
sds
 *
¬gv
;

1735 
sds
 
lše
 = 
	`sd¡rim
(
	`sd¢ew
(
buf
),"\r\n\t ");

1737 
lš’um
++;

1740 ià(
lše
[0] == '#' ||†ine[0] == '\0') {

1741 ià(!
¡©e
->
has_
 && !
	`¡rcmp
(
lše
,
REDIS_CONFIG_REWRITE_SIGNATURE
))

1742 
¡©e
->
has_
 = 1;

1743 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1748 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

1749 ià(
¬gv
 =ğ
NULL
) {

1753 
sds
 
aux
 = 
	`sd¢ew
("# ??? ");

1754 
aux
 = 
	`sdsÿtsds
×ux,
lše
);

1755 
	`sdsä“
(
lše
);

1756 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
aux
);

1760 
	`sd¡Şow”
(
¬gv
[0]);

1764 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1765 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
¡©e
,
¬gv
[0],
lš’um
);

1767 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1769 
	`fşo£
(
å
);

1770  
¡©e
;

1771 
	}
}

1777 
	$»wr™eCÚfigM¬kAsProûs£d
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
) {

1778 
sds
 
İt
 = 
	`sd¢ew
(
İtiÚ
);

1780 ià(
	`diùAdd
(
¡©e
->
»wr™‹n
,
İt
,
NULL
è!ğ
DICT_OK
è
	`sdsä“
(opt);

1781 
	}
}

1799 
	$»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
, 
sds
 
lše
, 
fÜû
) {

1800 
sds
 
o
 = 
	`sd¢ew
(
İtiÚ
);

1801 
dli¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
o
);

1803 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1805 ià(!
l
 && !
fÜû
) {

1807 
	`sdsä“
(
lše
);

1808 
	`sdsä“
(
o
);

1812 ià(
l
) {

1813 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
l
);

1814 
lš’um
 = (è
Ê
->
v®ue
;

1818 
	`dli¡D–Node
(
l
,
Ê
);

1819 ià(
	`dli¡L’gth
(
l
è=ğ0è
	`diùD–‘e
(
¡©e
->
İtiÚ_to_lše
,
o
);

1820 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1821 
¡©e
->
lšes
[
lš’um
] = 
lše
;

1824 ià(!
¡©e
->
has_
) {

1825 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,

1826 
	`sd¢ew
(
REDIS_CONFIG_REWRITE_SIGNATURE
));

1827 
¡©e
->
has_
 = 1;

1829 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1831 
	`sdsä“
(
o
);

1832 
	}
}

1835 
	$»wr™eCÚfigR–—£S‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1836 
	`sdsä“¥l™»s
(
¡©e
->
lšes
,¡©e->
numlšes
);

1837 
	`diùR–—£
(
¡©e
->
İtiÚ_to_lše
);

1838 
	`diùR–—£
(
¡©e
->
»wr™‹n
);

1839 
	`dä“
(
¡©e
);

1840 
	}
}

1850 
	$»wr™eCÚfigRemoveO½hªed
(
»wr™eCÚfigS‹
 *
¡©e
) {

1851 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
¡©e
->
İtiÚ_to_lše
);

1852 
diùEÁry
 *
de
;

1854 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1855 
dli¡
 *
l
 = 
	`diùG‘V®
(
de
);

1856 
sds
 
İtiÚ
 = 
	`diùG‘Key
(
de
);

1860 ià(
	`diùFšd
(
¡©e
->
»wr™‹n
,
İtiÚ
è=ğ
NULL
) {

1861 
	`log_debug
(
LOG_DEBUG
,"NÙ„ewr™‹ÀİtiÚ: %s", 
İtiÚ
);

1865 
	`dli¡L’gth
(
l
)) {

1866 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
l
);

1867 
lš’um
 = (è
Ê
->
v®ue
;

1869 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1870 
¡©e
->
lšes
[
lš’um
] = 
	`sd£m±y
();

1871 
	`dli¡D–Node
(
l
,
Ê
);

1874 
	`diùR–—£I‹¿tÜ
(
di
);

1875 
	}
}

1879 
sds
 
	$»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1880 
sds
 
cÚ‹Á
 = 
	`sd£m±y
();

1881 
j
, 
was_em±y
 = 0;

1883 
j
 = 0; j < 
¡©e
->
numlšes
; j++) {

1885 ià(
	`sd¦’
(
¡©e
->
lšes
[
j
]) == 0) {

1886 ià(
was_em±y
) ;

1887 
was_em±y
 = 1;

1889 
was_em±y
 = 0;

1891 
cÚ‹Á
 = 
	`sdsÿtsds
(cÚ‹Á,
¡©e
->
lšes
[
j
]);

1892 
cÚ‹Á
 = 
	`sdsÿ’
(content,"\n",1);

1894  
cÚ‹Á
;

1895 
	}
}

1909 
	$»wr™eCÚfigOv”wr™eFe
(*
cÚfigfe
, 
sds
 
cÚ‹Á
) {

1910 
»tv®
 = 0;

1911 
fd
 = 
	`İ’
(
cÚfigfe
,
O_RDWR
|
O_CREAT
,0644);

1912 
cÚ‹Á_size
 = 
	`sd¦’
(
cÚ‹Á
), 
·ddšg
 = 0;

1913 
¡©
 
sb
;

1914 
sds
 
cÚ‹Á_·dded
;

1918 ià(
fd
 == -1)  -1;

1919 ià(
	`f¡©
(
fd
,&
sb
) == -1) {

1920 
	`şo£
(
fd
);

1925 
cÚ‹Á_·dded
 = 
	`sdsdup
(
cÚ‹Á
);

1926 ià(
cÚ‹Á_size
 < 
sb
.
¡_size
) {

1929 
·ddšg
 = 
sb
.
¡_size
 - 
cÚ‹Á_size
;

1930 
cÚ‹Á_·dded
 = 
	`sdsgrowz”o
(cÚ‹Á_·dded,
sb
.
¡_size
);

1931 
cÚ‹Á_·dded
[
cÚ‹Á_size
] = '\n';

1932 
	`mem£t
(
cÚ‹Á_·dded
+
cÚ‹Á_size
+1,'#',
·ddšg
-1);

1936 ià(
	`wr™e
(
fd
,
cÚ‹Á_·dded
,
	`¡¾’
(content_padded)) == -1) {

1937 
»tv®
 = -1;

1938 
ş—nup
;

1942 ià(
·ddšg
) {

1943 ià(
	`árunÿ‹
(
fd
,
cÚ‹Á_size
) == -1) {

1948 
ş—nup
:

1949 
	`sdsä“
(
cÚ‹Á_·dded
);

1950 
	`şo£
(
fd
);

1951  
»tv®
;

1952 
	}
}

1955 
	$»wr™eCÚfigIÁO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
defv®ue
) {

1956 
v®ue
;

1957 
fÜû
;

1958 
sds
 
lše
;

1960 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1961 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %d",
İtiÚ
,
v®ue
);

1962 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1964 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1965 
	}
}

1968 
	$»wr™eCÚfigSdsO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
sds
 
defv®ue
) {

1969 
sds
 
v®ue
;

1970 
fÜû
;

1971 
sds
 
lše
;

1973 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1974 ià(
defv®ue
 =ğ
NULL
 && 
v®ue
 == NULL) {

1975 
fÜû
 = 0;

1976 } ià(
defv®ue
 !ğ
NULL
 && 
v®ue
 !ğNULL && !
	`sdscmp
(value,defvalue)) {

1977 
fÜû
 = 0;

1979 
fÜû
 = 1;

1982 ià(
v®ue
 =ğ
NULL
) {

1983 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% \"\"",
İtiÚ
);

1985 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
v®ue
);

1986 
	`sdsä“
(
v®ue
);

1989 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1990 
	}
}

1993 
	$»wr™eCÚfigLÚgLÚgO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
defv®ue
) {

1994 
v®ue
;

1995 
fÜû
;

1996 
sds
 
lše
;

1998 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

1999 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %Îd",
İtiÚ
,
v®ue
);

2000 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

2002 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2003 
	}
}

2007 
	$»wr™eCÚfigFÜm©MemÜy
(*
buf
, 
size_t
 
Ën
, 
by‹s
) {

2008 
gb
 = 1024*1024*1024;

2009 
mb
 = 1024*1024;

2010 
kb
 = 1024;

2012 ià(
by‹s
 && (by‹ % 
gb
) == 0) {

2013  
	`¢´štf
(
buf
,
Ën
,"%Îdgb",
by‹s
/
gb
);

2014 } ià(
by‹s
 && (by‹ % 
mb
) == 0) {

2015  
	`¢´štf
(
buf
,
Ën
,"%Îdmb",
by‹s
/
mb
);

2016 } ià(
by‹s
 && (by‹ % 
kb
) == 0) {

2017  
	`¢´štf
(
buf
,
Ën
,"%Îdkb",
by‹s
/
kb
);

2019  
	`¢´štf
(
buf
,
Ën
,"%Îd",
by‹s
);

2021 
	}
}

2024 
	$»wr™eCÚfigBy‹sO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
defv®ue
) {

2025 
v®ue
;

2026 
buf
[64];

2027 
fÜû
;

2028 
sds
 
lše
;

2030 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

2031 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

2033 
	`»wr™eCÚfigFÜm©MemÜy
(
buf
,(buf),
v®ue
);

2034 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
buf
);

2035 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2036 
	}
}

2041 
	$»wr™eCÚfigEnumO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
cÚfigEnumG‘SŒFun
 
fun
, 
defv®
) {

2042 
v®ue
;

2043 
sds
 
lše
;

2044 cÚ¡ *
Çme
;

2045 
fÜû
;

2047 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ue
);

2048 
fÜû
 = 
v®ue
 !ğ
defv®
;

2049 
Çme
 = 
	`fun
(
v®ue
);

2050 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

2051 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2052 
	}
}

2055 
	$»wr™eCÚfigBšdO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

2056 
d¬¿y
 
v®ues
;

2057 
sds
 *
v®ue
, 
lše
;

2058 
fÜû
 = 1;

2059 *
İtiÚ
 = 
CONFIG_SOPN_BIND
;

2061 
	`d¬¿y_š™
(&
v®ues
,1,(
sds
));

2062 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ues
);

2064 ià(
	`d¬¿y_n
(&
v®ues
) == 0) {

2065 
	`d¬¿y_deš™
(&
v®ues
);

2066 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

2071 
lše
 = 
	`sd¢ew
(
İtiÚ
);

2072 
	`d¬¿y_n
(&
v®ues
) > 0) {

2073 
lše
 = 
	`sdsÿt
(line," ");

2074 
v®ue
 = 
	`d¬¿y_pİ
(&
v®ues
);

2075 
lše
 = 
	`sdsÿtsds
Öše,*
v®ue
);

2076 
	`sdsä“
(*
v®ue
);

2078 
	`d¬¿y_deš™
(&
v®ues
);

2080 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2081 
	}
}

2084 
	$»wr™eCÚfigCommªdsNAPO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

2085 
d¬¿y
 
v®ues
;

2086 
sds
 *
v®ue
, 
lše
;

2087 
fÜû
 = 1;

2088 *
İtiÚ
 = 
CONFIG_SOPN_COMMANDSNAP
;

2090 
	`d¬¿y_š™
(&
v®ues
,1,(
sds
));

2091 
	`cÚf_£rv”_g‘
(
İtiÚ
,&
v®ues
);

2093 ià(
	`d¬¿y_n
(&
v®ues
) == 0) {

2094 
	`d¬¿y_deš™
(&
v®ues
);

2095 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

2099 
	`d¬¿y_n
(&
v®ues
) > 0) {

2100 
v®ue
 = 
	`d¬¿y_pİ
(&
v®ues
);

2101 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,*
v®ue
);

2102 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

2103 
	`sdsä“
(*
v®ue
);

2105 
	`d¬¿y_deš™
(&
v®ues
);

2106 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

2107 
	}
}

2117 
	$»wr™eCÚfig
(*
·th
) {

2118 
»wr™eCÚfigS‹
 *
¡©e
;

2119 
sds
 
ÃwcÚ‹Á
;

2120 
»tv®
;

2121 
cÚf_İtiÚ
 *
cİ
;

2123 
	`CONFF_LOCK
();

2125 ià((
¡©e
 = 
	`»wr™eCÚfigR—dOldFe
(
·th
)è=ğ
NULL
) {

2126 
	`CONFF_UNLOCK
();

2132 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_DATABASES
,
CONFIG_DEFAULT_LOGICAL_DBNUM
);

2133 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_IDPDATABASE
,
CONFIG_DEFAULT_INTERNAL_DBNUM
);

2134 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXMEMORY
,
CONFIG_DEFAULT_MAXMEMORY
);

2135 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXMEMORYP
,
g‘_eviùpŞicy_¡ršgs
,
CONFIG_DEFAULT_MAXMEMORY_POLICY
);

2136 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXMEMORYS
,
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
);

2137 
	`»wr™eCÚfigLÚgLÚgO±iÚ
(
¡©e
,
CONFIG_SOPN_MTCLIMIT
,
CONFIG_DEFAULT_MAX_TIME_COMPLEXITY_LIMIT
);

2138 
	`»wr™eCÚfigBšdO±iÚ
(
¡©e
);

2139 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_PORT
,
CONFIG_DEFAULT_SERVER_PORT
);

2140 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_THREADS
,
CONFIG_DEFAULT_THREADS_NUM
);

2141 
	`»wr™eCÚfigLÚgLÚgO±iÚ
(
¡©e
,
CONFIG_SOPN_SLOWLOGLST
,
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
);

2142 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_SLOWLOGML
,
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
);

2143 
	`»wr™eCÚfigIÁO±iÚ
(
¡©e
,
CONFIG_SOPN_MAXCLIENTS
,
CONFIG_DEFAULT_MAX_CLIENTS
);

2144 
	`»wr™eCÚfigSdsO±iÚ
(
¡©e
,
CONFIG_SOPN_REQUIREPASS
,
NULL
);

2145 
	`»wr™eCÚfigSdsO±iÚ
(
¡©e
,
CONFIG_SOPN_ADMINPASS
,
NULL
);

2146 
	`»wr™eCÚfigCommªdsNAPO±iÚ
(
¡©e
);

2151 
	`»wr™eCÚfigRemoveO½hªed
(
¡©e
);

2155 
ÃwcÚ‹Á
 = 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
¡©e
);

2156 
»tv®
 = 
	`»wr™eCÚfigOv”wr™eFe
(
£rv”
.
cÚfigfe
,
ÃwcÚ‹Á
);

2157 
	`CONFF_UNLOCK
();

2159 
	`sdsä“
(
ÃwcÚ‹Á
);

2160 
	`»wr™eCÚfigR–—£S‹
(
¡©e
);

2161  
»tv®
;

2162 
	}
}

2168 
	$cÚfigCommªd
(
ş›Á
 *
c
) {

2170 ià(
£rv”
.
lßdšg
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2171 
	`addR•lyE¼Ü
(
c
,"Only CONFIG GET is‡llowed during†oading");

2175 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

2176 ià(
c
->
¬gc
 !ğ4è
bad¬™y
;

2177 
	`cÚfigS‘Commªd
(
c
);

2178 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2179 ià(
c
->
¬gc
 !ğ3è
bad¬™y
;

2180 
	`cÚfigG‘Commªd
(
c
);

2186  ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"rewrite")) {

2187 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

2188 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

2189 
	`addR•lyE¼Ü
(
c
,"The server is„unning without‡ config file");

2192 ià(
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
) == -1) {

2193 
	`log_w¬n
("CONFIG REWRITE faed: %s", 
	`¡»¼Ü
(
”ºo
));

2194 
	`addR•lyE¼ÜFÜm©
(
c
,"Rewr™šg cÚfig fe: %s", 
	`¡»¼Ü
(
”ºo
));

2196 
	`log_w¬n
("CONFIG REWRITEƒxecuted with success.");

2197 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2200 
	`addR•lyE¼Ü
(
c
,

2206 
bad¬™y
:

2207 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for CONFIG %s",

2208 (*è
c
->
¬gv
[1]->
±r
);

2209 
	}
}

2212 
	$cÚf_ÿche_š™
(
cÚf_ÿche
 *
cc
)

2214 
cc
->
ÿche_v”siÚ
 = 0;

2215 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
cc
->
maxş›Ás
);

2216 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_REQUIREPASS
,&
cc
->
»quœ•ass
);

2217 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_ADMINPASS
,&
cc
->
admš·ss
);

2218 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
cc
->
maxmemÜy
);

2219 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MTCLIMIT
,&
cc
->
max_time_com¶ex™y_lim™
);

2220 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_SLOWLOGLST
,&
cc
->
¦owlog_log_¦ow”_thª
);

2222  
VR_OK
;

2223 
	}
}

2226 
	$cÚf_ÿche_deš™
(
cÚf_ÿche
 *
cc
)

2228 
cc
->
ÿche_v”siÚ
 = 0;

2229 ià(
cc
->
»quœ•ass
 !ğ
NULL
) {

2230 
	`sdsä“
(
cc
->
»quœ•ass
);

2231 
cc
->
»quœ•ass
 = 
NULL
;

2233 ià(
cc
->
admš·ss
 !ğ
NULL
) {

2234 
	`sdsä“
(
cc
->
admš·ss
);

2235 
cc
->
admš·ss
 = 
NULL
;

2238  
VR_OK
;

2239 
	}
}

2242 
	$cÚf_ÿche_upd©e
(
cÚf_ÿche
 *
cc
)

2244 
cv”siÚ
 = 
	`cÚf_v”siÚ_g‘
();

2247 ià(
cv”siÚ
 <ğ
cc
->
ÿche_v”siÚ
) {

2251 ià(
cc
->
»quœ•ass
 !ğ
NULL
) {

2252 
	`sdsä“
(
cc
->
»quœ•ass
);

2253 
cc
->
»quœ•ass
 = 
NULL
;

2255 ià(
cc
->
admš·ss
 !ğ
NULL
) {

2256 
	`sdsä“
(
cc
->
admš·ss
);

2257 
cc
->
admš·ss
 = 
NULL
;

2260 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
cc
->
maxş›Ás
);

2261 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_REQUIREPASS
,&
cc
->
»quœ•ass
);

2262 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_ADMINPASS
,&
cc
->
admš·ss
);

2263 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
cc
->
maxmemÜy
);

2264 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MTCLIMIT
,&
cc
->
max_time_com¶ex™y_lim™
);

2265 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_SLOWLOGLST
,&
cc
->
¦owlog_log_¦ow”_thª
);

2267 
cc
->
ÿche_v”siÚ
 = 
cv”siÚ
;

2269  
VR_OK
;

2270 
	}
}

	@src/vr_conf.h

1 #iâdeà
_VR_CONF_H_


2 
	#_VR_CONF_H_


	)

5 
	#CONFIG_SOPN_DATABASES
 "d©aba£s"

	)

6 
	#CONFIG_SOPN_IDPDATABASE
 "š‹º®-dbs-³r-d©aba£s"

	)

7 
	#CONFIG_SOPN_MAXMEMORY
 "maxmemÜy"

	)

8 
	#CONFIG_SOPN_MAXMEMORYP
 "maxmemÜy-pŞicy"

	)

9 
	#CONFIG_SOPN_MAXMEMORYS
 "maxmemÜy-§m¶es"

	)

10 
	#CONFIG_SOPN_MTCLIMIT
 "max-time-com¶ex™y-lim™"

	)

11 
	#CONFIG_SOPN_BIND
 "bšd"

	)

12 
	#CONFIG_SOPN_PORT
 "pÜt"

	)

13 
	#CONFIG_SOPN_THREADS
 "th»ads"

	)

14 
	#CONFIG_SOPN_DIR
 "dœ"

	)

15 
	#CONFIG_SOPN_MAXCLIENTS
 "maxş›Ás"

	)

16 
	#CONFIG_SOPN_SLOWLOGLST
 "¦owlog-log-¦ow”-thª"

	)

17 
	#CONFIG_SOPN_SLOWLOGML
 "¦owlog-max-Ën"

	)

18 
	#CONFIG_SOPN_REQUIREPASS
 "»quœ•ass"

	)

19 
	#CONFIG_SOPN_ADMINPASS
 "admš·ss"

	)

20 
	#CONFIG_SOPN_COMMANDSNAP
 "commªds-Ãed-admš·ss"

	)

22 
	#CONFIG_RUN_ID_SIZE
 40

	)

23 
	#CONFIG_DEFAULT_ACTIVE_REHASHING
 1

	)

25 
	#CONFIG_DEFAULT_LOGICAL_DBNUM
 6

	)

26 
	#CONFIG_DEFAULT_INTERNAL_DBNUM
 6

	)

28 
	#CONFIG_DEFAULT_MAXMEMORY
 0

	)

29 
	#CONFIG_DEFAULT_MAXMEMORY_SAMPLES
 5

	)

30 
	#CONFIG_DEFAULT_MAX_CLIENTS
 10000

	)

32 
	#CONFIG_DEFAULT_MAX_CLIENTS
 10000

	)

34 
	#CONFIG_DEFAULT_THREADS_NUM
 (
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>6?6:syscÚf(_SC_NPROCESSORS_ONLN))

	)

36 
	#CONFIG_DEFAULT_HOST
 "0.0.0.0"

	)

38 
	#CONFIG_DEFAULT_SERVER_PORT
 55555

	)

40 
	#CONFIG_DEFAULT_DATA_DIR
 "vœed©a"

	)

42 
	#CONFIG_DEFAULT_MAX_TIME_COMPLEXITY_LIMIT
 0

	)

44 
	#CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
 10000

	)

45 
	#CONFIG_DEFAULT_SLOWLOG_MAX_LEN
 128

	)

47 
	#CONFIG_AUTHPASS_MAX_LEN
 512

	)

49 
	#CONFIG_BINDADDR_MAX
 16

	)

51 
	#CONF_UNSET_NUM
 -1

	)

52 
	#CONF_UNSET_PTR
 
NULL


	)

53 
	#CONF_UNSET_GROUP
 (
group_ty³_t
è-1

	)

54 
	#CONF_UNSET_HASH
 (
hash_ty³_t
è-1

	)

55 
	#CONF_UNSET_DIST
 (
di¡_ty³_t
è-1

	)

58 
	#CONF_FIELD_TYPE_INT
 0

	)

59 
	#CONF_FIELD_TYPE_LONGLONG
 1

	)

60 
	#CONF_FIELD_TYPE_SDS
 2

	)

61 
	#CONF_FIELD_TYPE_ARRAYSDS
 3

	)

64 
	#CONF_FIELD_FLAGS_NO_MODIFY
 (1<<0)

	)

66 
	scÚf_İtiÚ
 {

67 *
	mÇme
;

68 
	mty³
;

69 
	mæags
;

70 (*
	m£t
)(*
	mcf
, 
cÚf_İtiÚ
 *
	mİt
, *
	md©a
);

71 (*
	mg‘
)(*
	mcf
, 
cÚf_İtiÚ
 *
	mİt
, *
	md©a
);

72 
	moff£t
;

73 }
	tcÚf_İtiÚ
;

76 
	#EVICTPOLICY_CODEC
(
ACTION
) \

77 
	`ACTION
Ğ
MAXMEMORY_VOLATILE_LRU
, vŞ©e-
Ìu
) \

78 
	`ACTION
Ğ
MAXMEMORY_VOLATILE_RANDOM
, vŞ©e-
¿ndom
) \

79 
	`ACTION
Ğ
MAXMEMORY_VOLATILE_TTL
, vŞ©e-
‰l
) \

80 
	`ACTION
Ğ
MAXMEMORY_ALLKEYS_LRU
, 
®lkeys
-
Ìu
) \

81 
	`ACTION
Ğ
MAXMEMORY_ALLKEYS_RANDOM
, 
®lkeys
-
¿ndom
) \

82 
	`ACTION
Ğ
MAXMEMORY_NO_EVICTION
, 
nÛviùiÚ
) \

83 

	)

84 
	#DEFINE_ACTION
(
_pŞicy
, 
_Çme
è_pŞicy,

	)

85 
	eeviùpŞicy_ty³
 {

86 
EVICTPOLICY_CODEC
Ğ
DEFINE_ACTION
 )

87 
	mEVICTPOLICY_SENTINEL


88 } 
	teviùpŞicy_ty³_t
;

89 #undeà
DEFINE_ACTION


91 
	scÚf_£rv”
 {

93 
diù
 *
	mùabË
;

95 
	md©aba£s
;

97 
	mš‹º®_dbs_³r_d©aba£s
;

101 
	mmax_time_com¶ex™y_lim™
;

103 
	mmaxmemÜy
;

105 
	mmaxmemÜy_pŞicy
;

106 
	mmaxmemÜy_§m¶es
;

108 
	mmaxş›Ás
;

110 
	mth»ads
;

113 
d¬¿y
 
	mbšds
;

115 
	mpÜt
;

117 
sds
 
	mdœ
;

119 
	m¦owlog_log_¦ow”_thª
;

121 
	m¦owlog_max_Ën
;

124 
sds
 
	m»quœ•ass
;

126 
sds
 
	madmš·ss
;

127 
d¬¿y
 
	mcommªds_Ãed_admš·ss
;

128 } 
	tcÚf_£rv”
;

131 
	svr_cÚf
 {

133 
sds
 
	mâame
;

135 
diù
 *
	mÜgªiz©iÚs
;

138 
cÚf_£rv”
 
	mc£rv”
;

140 
	mv”siÚ
;

142 
±h»ad_rwlock_t
 
	mrwl
;

144 
±h»ad_mu‹x_t
 
	mæock
;

145 }
	tvr_cÚf
;

147 
	#CONF_VALUE_TYPE_UNKNOW
 0

	)

148 
	#CONF_VALUE_TYPE_STRING
 1

	)

149 
	#CONF_VALUE_TYPE_ARRAY
 2

	)

152 
	scÚf_v®ue
{

153 
	mty³
;

154 *
	mv®ue
;

155 }
	tcÚf_v®ue
;

160 
	scÚf_ÿche
 {

161 
	mÿche_v”siÚ
;

163 
	mmaxş›Ás
;

164 
sds
 
	m»quœ•ass
;

165 
sds
 
	madmš·ss
;

166 
	mmaxmemÜy
;

167 
	mmax_time_com¶ex™y_lim™
;

168 
	m¦owlog_log_¦ow”_thª
;

169 }
	tcÚf_ÿche
;

172 
vr_cÚf
 *
cÚf
;

173 
cÚf_£rv”
 *
c£rv”
;

175 
cÚf_v®ue
 *
cÚf_v®ue_ü—‹
(
ty³
);

176 
cÚf_v®ue_de¡roy
(
cÚf_v®ue
 *
cv
);

178 
vr_cÚf
 *
cÚf_ü—‹
(*
f’ame
);

179 
cÚf_de¡roy
(
vr_cÚf
 *
cf
);

181 
cÚf_v”siÚ_g‘
();

183 
cÚf_£rv”_g‘
(cÚ¡ *
İtiÚ_Çme
, *
v®ue
);

184 
cÚf_£rv”_£t
(cÚ¡ *
İtiÚ_Çme
, 
cÚf_v®ue
 *
v®ue
);

186 
cÚf_£t_maxmemÜy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

187 
cÚf_£t_maxmemÜy_pŞicy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

188 
cÚf_£t_št_nÚ_z”o
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

190 
cÚf_g‘_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

191 
cÚf_g‘_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

192 
cÚf_g‘_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

193 
cÚf_g‘_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

195 
cÚf_£t_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

196 
cÚf_£t_·sswÜd
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

197 
cÚf_£t_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

198 
cÚf_£t_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

199 
cÚf_£t_yesÜno
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

200 
cÚf_£t_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

201 
cÚf_£t_commªds_Ãed_admš·ss
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

203 
CONF_RLOCK
();

204 
CONF_WLOCK
();

205 
CONF_UNLOCK
();

207 
CONFF_LOCK
();

208 
CONFF_UNLOCK
();

210 cÚ¡ *
g‘_eviùpŞicy_¡ršgs
(
eviùpŞicy_ty³
);

212 
cÚfigCommªd
(
ş›Á
 *
c
);

214 
cÚf_ÿche_š™
(
cÚf_ÿche
 *
cc
);

215 
cÚf_ÿche_deš™
(
cÚf_ÿche
 *
cc
);

216 
cÚf_ÿche_upd©e
(
cÚf_ÿche
 *
cc
);

	@src/vr_conf.h

1 #iâdeà
_VR_CONF_H_


2 
	#_VR_CONF_H_


	)

5 
	#CONFIG_SOPN_DATABASES
 "d©aba£s"

	)

6 
	#CONFIG_SOPN_IDPDATABASE
 "š‹º®-dbs-³r-d©aba£s"

	)

7 
	#CONFIG_SOPN_MAXMEMORY
 "maxmemÜy"

	)

8 
	#CONFIG_SOPN_MAXMEMORYP
 "maxmemÜy-pŞicy"

	)

9 
	#CONFIG_SOPN_MAXMEMORYS
 "maxmemÜy-§m¶es"

	)

10 
	#CONFIG_SOPN_MTCLIMIT
 "max-time-com¶ex™y-lim™"

	)

11 
	#CONFIG_SOPN_BIND
 "bšd"

	)

12 
	#CONFIG_SOPN_PORT
 "pÜt"

	)

13 
	#CONFIG_SOPN_THREADS
 "th»ads"

	)

14 
	#CONFIG_SOPN_DIR
 "dœ"

	)

15 
	#CONFIG_SOPN_MAXCLIENTS
 "maxş›Ás"

	)

16 
	#CONFIG_SOPN_SLOWLOGLST
 "¦owlog-log-¦ow”-thª"

	)

17 
	#CONFIG_SOPN_SLOWLOGML
 "¦owlog-max-Ën"

	)

18 
	#CONFIG_SOPN_REQUIREPASS
 "»quœ•ass"

	)

19 
	#CONFIG_SOPN_ADMINPASS
 "admš·ss"

	)

20 
	#CONFIG_SOPN_COMMANDSNAP
 "commªds-Ãed-admš·ss"

	)

22 
	#CONFIG_RUN_ID_SIZE
 40

	)

23 
	#CONFIG_DEFAULT_ACTIVE_REHASHING
 1

	)

25 
	#CONFIG_DEFAULT_LOGICAL_DBNUM
 6

	)

26 
	#CONFIG_DEFAULT_INTERNAL_DBNUM
 6

	)

28 
	#CONFIG_DEFAULT_MAXMEMORY
 0

	)

29 
	#CONFIG_DEFAULT_MAXMEMORY_SAMPLES
 5

	)

30 
	#CONFIG_DEFAULT_MAX_CLIENTS
 10000

	)

32 
	#CONFIG_DEFAULT_MAX_CLIENTS
 10000

	)

34 
	#CONFIG_DEFAULT_THREADS_NUM
 (
	`syscÚf
(
_SC_NPROCESSORS_ONLN
)>6?6:syscÚf(_SC_NPROCESSORS_ONLN))

	)

36 
	#CONFIG_DEFAULT_HOST
 "0.0.0.0"

	)

38 
	#CONFIG_DEFAULT_SERVER_PORT
 55555

	)

40 
	#CONFIG_DEFAULT_DATA_DIR
 "vœed©a"

	)

42 
	#CONFIG_DEFAULT_MAX_TIME_COMPLEXITY_LIMIT
 0

	)

44 
	#CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
 10000

	)

45 
	#CONFIG_DEFAULT_SLOWLOG_MAX_LEN
 128

	)

47 
	#CONFIG_AUTHPASS_MAX_LEN
 512

	)

49 
	#CONFIG_BINDADDR_MAX
 16

	)

51 
	#CONF_UNSET_NUM
 -1

	)

52 
	#CONF_UNSET_PTR
 
NULL


	)

53 
	#CONF_UNSET_GROUP
 (
group_ty³_t
è-1

	)

54 
	#CONF_UNSET_HASH
 (
hash_ty³_t
è-1

	)

55 
	#CONF_UNSET_DIST
 (
di¡_ty³_t
è-1

	)

58 
	#CONF_FIELD_TYPE_INT
 0

	)

59 
	#CONF_FIELD_TYPE_LONGLONG
 1

	)

60 
	#CONF_FIELD_TYPE_SDS
 2

	)

61 
	#CONF_FIELD_TYPE_ARRAYSDS
 3

	)

64 
	#CONF_FIELD_FLAGS_NO_MODIFY
 (1<<0)

	)

66 
	scÚf_İtiÚ
 {

67 *
	mÇme
;

68 
	mty³
;

69 
	mæags
;

70 (*
	m£t
)(*
	mcf
, 
cÚf_İtiÚ
 *
	mİt
, *
	md©a
);

71 (*
	mg‘
)(*
	mcf
, 
cÚf_İtiÚ
 *
	mİt
, *
	md©a
);

72 
	moff£t
;

73 }
	tcÚf_İtiÚ
;

76 
	#EVICTPOLICY_CODEC
(
ACTION
) \

77 
	`ACTION
Ğ
MAXMEMORY_VOLATILE_LRU
, vŞ©e-
Ìu
) \

78 
	`ACTION
Ğ
MAXMEMORY_VOLATILE_RANDOM
, vŞ©e-
¿ndom
) \

79 
	`ACTION
Ğ
MAXMEMORY_VOLATILE_TTL
, vŞ©e-
‰l
) \

80 
	`ACTION
Ğ
MAXMEMORY_ALLKEYS_LRU
, 
®lkeys
-
Ìu
) \

81 
	`ACTION
Ğ
MAXMEMORY_ALLKEYS_RANDOM
, 
®lkeys
-
¿ndom
) \

82 
	`ACTION
Ğ
MAXMEMORY_NO_EVICTION
, 
nÛviùiÚ
) \

83 

	)

84 
	#DEFINE_ACTION
(
_pŞicy
, 
_Çme
è_pŞicy,

	)

85 
	eeviùpŞicy_ty³
 {

86 
EVICTPOLICY_CODEC
Ğ
DEFINE_ACTION
 )

87 
	mEVICTPOLICY_SENTINEL


88 } 
	teviùpŞicy_ty³_t
;

89 #undeà
DEFINE_ACTION


91 
	scÚf_£rv”
 {

93 
diù
 *
	mùabË
;

95 
	md©aba£s
;

97 
	mš‹º®_dbs_³r_d©aba£s
;

101 
	mmax_time_com¶ex™y_lim™
;

103 
	mmaxmemÜy
;

105 
	mmaxmemÜy_pŞicy
;

106 
	mmaxmemÜy_§m¶es
;

108 
	mmaxş›Ás
;

110 
	mth»ads
;

113 
d¬¿y
 
	mbšds
;

115 
	mpÜt
;

117 
sds
 
	mdœ
;

119 
	m¦owlog_log_¦ow”_thª
;

121 
	m¦owlog_max_Ën
;

124 
sds
 
	m»quœ•ass
;

126 
sds
 
	madmš·ss
;

127 
d¬¿y
 
	mcommªds_Ãed_admš·ss
;

128 } 
	tcÚf_£rv”
;

131 
	svr_cÚf
 {

133 
sds
 
	mâame
;

135 
diù
 *
	mÜgªiz©iÚs
;

138 
cÚf_£rv”
 
	mc£rv”
;

140 
	mv”siÚ
;

142 
±h»ad_rwlock_t
 
	mrwl
;

144 
±h»ad_mu‹x_t
 
	mæock
;

145 }
	tvr_cÚf
;

147 
	#CONF_VALUE_TYPE_UNKNOW
 0

	)

148 
	#CONF_VALUE_TYPE_STRING
 1

	)

149 
	#CONF_VALUE_TYPE_ARRAY
 2

	)

152 
	scÚf_v®ue
{

153 
	mty³
;

154 *
	mv®ue
;

155 }
	tcÚf_v®ue
;

160 
	scÚf_ÿche
 {

161 
	mÿche_v”siÚ
;

163 
	mmaxş›Ás
;

164 
sds
 
	m»quœ•ass
;

165 
sds
 
	madmš·ss
;

166 
	mmaxmemÜy
;

167 
	mmax_time_com¶ex™y_lim™
;

168 
	m¦owlog_log_¦ow”_thª
;

169 }
	tcÚf_ÿche
;

172 
vr_cÚf
 *
cÚf
;

173 
cÚf_£rv”
 *
c£rv”
;

175 
cÚf_v®ue
 *
cÚf_v®ue_ü—‹
(
ty³
);

176 
cÚf_v®ue_de¡roy
(
cÚf_v®ue
 *
cv
);

178 
vr_cÚf
 *
cÚf_ü—‹
(*
f’ame
);

179 
cÚf_de¡roy
(
vr_cÚf
 *
cf
);

181 
cÚf_v”siÚ_g‘
();

183 
cÚf_£rv”_g‘
(cÚ¡ *
İtiÚ_Çme
, *
v®ue
);

184 
cÚf_£rv”_£t
(cÚ¡ *
İtiÚ_Çme
, 
cÚf_v®ue
 *
v®ue
);

186 
cÚf_£t_maxmemÜy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

187 
cÚf_£t_maxmemÜy_pŞicy
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

188 
cÚf_£t_št_nÚ_z”o
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

190 
cÚf_g‘_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

191 
cÚf_g‘_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

192 
cÚf_g‘_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

193 
cÚf_g‘_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

195 
cÚf_£t_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

196 
cÚf_£t_·sswÜd
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

197 
cÚf_£t_št
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

198 
cÚf_£t_lÚglÚg
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

199 
cÚf_£t_yesÜno
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

200 
cÚf_£t_¬¿y_sds
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

201 
cÚf_£t_commªds_Ãed_admš·ss
(*
obj
, 
cÚf_İtiÚ
 *
İt
, *
d©a
);

203 
CONF_RLOCK
();

204 
CONF_WLOCK
();

205 
CONF_UNLOCK
();

207 
CONFF_LOCK
();

208 
CONFF_UNLOCK
();

210 cÚ¡ *
g‘_eviùpŞicy_¡ršgs
(
eviùpŞicy_ty³
);

212 
cÚfigCommªd
(
ş›Á
 *
c
);

214 
cÚf_ÿche_š™
(
cÚf_ÿche
 *
cc
);

215 
cÚf_ÿche_deš™
(
cÚf_ÿche
 *
cc
);

216 
cÚf_ÿche_upd©e
(
cÚf_ÿche
 *
cc
);

	@src/vr_connection.c

1 
	~<sys/uio.h
>

3 
	~<vr_cÜe.h
>

5 
cÚn_ä“
(
cÚn
 *conn);

8 
cÚn
 *

9 
	$_cÚn_g‘
(
cÚn_ba£
 *
cb
)

11 
cÚn
 *conn;

13 ià(
cb
 !ğ
NULL
 && 
	`dli¡L’gth
(cb->
ä“_cÚnq
) > 0) {

14 
cÚn
 = 
	`dli¡Pİ
(
cb
->
ä“_cÚnq
);

16 
cÚn
 = 
	`d®loc
((*conn));

17 ià(
cÚn
 =ğ
NULL
) {

18  
NULL
;

20 
cÚn
->
cb
 = cb;

22 
cÚn
->
šqueue
 = 
NULL
;

23 
cÚn
->
outqueue
 = 
NULL
;

26 
cÚn
->
owÃr
 = 
NULL
;

28 
cÚn
->
sd
 = -1;

30 
cÚn
->
£nd_by‹s
 = 0;

31 
cÚn
->
»cv_by‹s
 = 0;

33 
cÚn
->
”r
 = 0;

34 
cÚn
->
»cv_aùive
 = 0;

35 
cÚn
->
»cv_»ady
 = 0;

36 
cÚn
->
£nd_aùive
 = 0;

37 
cÚn
->
£nd_»ady
 = 0;

39 
cÚn
->
cÚÃùšg
 = 0;

40 
cÚn
->
cÚÃùed
 = 0;

41 
cÚn
->
eof
 = 0;

42 
cÚn
->
dÚe
 = 0;

44 ià(
cÚn
->
šqueue
 =ğ
NULL
) {

45 
cÚn
->
šqueue
 = 
	`dli¡C»©e
();

46 ià(
cÚn
->
šqueue
 =ğ
NULL
) {

47 
	`cÚn_ä“
(
cÚn
);

48  
NULL
;

52 ià(
cÚn
->
outqueue
 =ğ
NULL
) {

53 
cÚn
->
outqueue
 = 
	`dli¡C»©e
();

54 ià(
cÚn
->
outqueue
 =ğ
NULL
) {

55 
	`cÚn_ä“
(
cÚn
);

56  
NULL
;

60 ià(
cb
 !ğ
NULL
) {

61 
cb
->
ÁÙ®_cÚn
++;

62 
cb
->
ncu¼_cÚn
++;

65  
cÚn
;

66 
	}
}

68 
cÚn
 *

69 
	$cÚn_g‘
(
cÚn_ba£
 *
cb
)

71 
cÚn
 *conn;

73 
cÚn
 = 
	`_cÚn_g‘
(
cb
);

74 ià(
cÚn
 =ğ
NULL
) {

75  
NULL
;

78 
	`log_debug
(
LOG_VVERB
, "g‘ cÚÀ%°ş›Á %d", 
cÚn
, cÚn->
sd
);

80  
cÚn
;

81 
	}
}

84 
	$cÚn_ä“
(
cÚn
 *conn)

86 
	`log_debug
(
LOG_VVERB
, "ä“ cÚÀ%p", 
cÚn
);

88 ià(
cÚn
 =ğ
NULL
) {

92 ià(
cÚn
->
sd
 > 0) {

93 
	`şo£
(
cÚn
->
sd
);

94 
cÚn
->
sd
 = -1;

95 
	`upd©e_cu¼_ş›Ás_sub
(1);

98 ià(
cÚn
->
šqueue
) {

99 
sds
 
buf
;

100 
buf
 = 
	`dli¡Pİ
(
cÚn
->
šqueue
)) {

101 
	`sdsä“
(
buf
);

103 
	`dli¡R–—£
(
cÚn
->
šqueue
);

104 
cÚn
->
šqueue
 = 
NULL
;

107 ià(
cÚn
->
outqueue
) {

108 
sds
 
buf
;

109 
buf
 = 
	`dli¡Pİ
(
cÚn
->
outqueue
)) {

110 
	`sdsä“
(
buf
);

112 
	`dli¡R–—£
(
cÚn
->
outqueue
);

113 
cÚn
->
outqueue
 = 
NULL
;

116 
	`dä“
(
cÚn
);

117 
	}
}

121 
	$cÚn_put
(
cÚn
 *conn)

124 
cÚn_ba£
 *
cb
 = 
cÚn
->cb;

126 
	`ASSERT
(
cÚn
->
owÃr
 =ğ
NULL
);

128 
	`log_debug
(
LOG_VVERB
, "puˆcÚÀ%p", 
cÚn
);

131 ià(
cÚn
->
sd
 > 0) {

132 
	`şo£
(
cÚn
->
sd
);

133 
cÚn
->
sd
 = -1;

134 
	`upd©e_cu¼_ş›Ás_sub
(1);

137 ià(
cb
 =ğ
NULL
) {

138 
	`cÚn_ä“
(
cÚn
);

142 ià(
cÚn
->
šqueue
) {

143 
sds
 
buf
;

144 
buf
 = 
	`dli¡Pİ
(
cÚn
->
šqueue
)) {

145 
	`sdsä“
(
buf
);

149 ià(
cÚn
->
outqueue
) {

150 
sds
 
buf
;

151 
buf
 = 
	`dli¡Pİ
(
cÚn
->
outqueue
)) {

152 
	`sdsä“
(
buf
);

156 
	`dli¡Push
(
cb
->
ä“_cÚnq
, 
cÚn
);

157 
cb
->
ncu¼_ccÚn
--;

158 
cb
->
ncu¼_cÚn
--;

159 
	}
}

163 
	$cÚn_š™
(
cÚn_ba£
 *
cb
)

165 
	`log_debug
(
LOG_DEBUG
, "cÚÀsiz%d", (
cÚn
));

167 
cb
->
ä“_cÚnq
 = 
NULL
;

168 
cb
->
ÁÙ®_cÚn
 = 0;

169 
cb
->
ncu¼_ccÚn
 = 0;

170 
cb
->
ncu¼_ccÚn
 = 0;

172 
cb
->
ä“_cÚnq
 = 
	`dli¡C»©e
();

173 ià(
cb
->
ä“_cÚnq
 =ğ
NULL
) {

174  
VR_ENOMEM
;

177  
VR_OK
;

178 
	}
}

181 
	$cÚn_deš™
(
cÚn_ba£
 *
cb
)

183 
cÚn
 *conn;

185 ià(
cb
->
ä“_cÚnq
) {

186 
cÚn
 = 
	`dli¡Pİ
(
cb
->
ä“_cÚnq
)) {

187 
	`cÚn_ä“
(
cÚn
);

189 
	`ASSERT
(
	`dli¡L’gth
(
cb
->
ä“_cÚnq
) == 0);

190 
	`dli¡R–—£
(
cb
->
ä“_cÚnq
);

192 
	}
}

194 
ssize_t


195 
	$cÚn_»cv
(
cÚn
 *cÚn, *
buf
, 
size_t
 
size
)

197 
ssize_t
 
n
;

199 
	`ASSERT
(
buf
 !ğ
NULL
);

200 
	`ASSERT
(
size
 > 0);

201 
	`ASSERT
(
cÚn
->
»cv_»ady
);

205 
n
 = 
	`vr_»ad
(
cÚn
->
sd
, 
buf
, 
size
);

208 
	`log_debug
(
LOG_VERB
, "»cv oÀsd %d %zd oà%zu", 
cÚn
->
sd
, 
n
, 
size
);

211 ià(
n
 > 0) {

212 ià(
n
 < (
ssize_t
è
size
) {

213 
cÚn
->
»cv_»ady
 = 0;

215 
cÚn
->
»cv_by‹s
 +ğ(
size_t
)
n
;

216  
n
;

219 ià(
n
 == 0) {

220 
cÚn
->
»cv_»ady
 = 0;

221 
cÚn
->
eof
 = 1;

222 
	`log_debug
(
LOG_INFO
, "»cv oÀsd %dƒoàrb %zu sb %zu", 
cÚn
->
sd
,

223 
cÚn
->
»cv_by‹s
, cÚn->
£nd_by‹s
);

224  
n
;

227 ià(
”ºo
 =ğ
EINTR
) {

228 
	`log_debug
(
LOG_VERB
, "»cv oÀsd %d‚Ù„—dy -ƒšŒ", 
cÚn
->
sd
);

230 } ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

231 
cÚn
->
»cv_»ady
 = 0;

232 
	`log_debug
(
LOG_VERB
, "»cv oÀsd %d‚Ù„—dy -ƒagaš", 
cÚn
->
sd
);

233  
VR_EAGAIN
;

235 
cÚn
->
»cv_»ady
 = 0;

236 
cÚn
->
”r
 = 
”ºo
;

237 
	`log_”rÜ
("»cv oÀsd %d faed: %s", 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

238  
VR_ERROR
;

242 
	`NOT_REACHED
();

244  
VR_ERROR
;

245 
	}
}

247 
ssize_t


248 
	$cÚn_£nd
(
cÚn
 *cÚn, *
buf
, 
size_t
 
n£nd
)

250 
ssize_t
 
n
;

252 
	`ASSERT
(
n£nd
 != 0);

253 
	`ASSERT
(
cÚn
->
£nd_»ady
);

257 
n
 = 
	`vr_wr™e
(
cÚn
->
sd
, 
buf
, 
n£nd
);

259 
	`log_debug
(
LOG_VERB
, "send on sd %d %zd of %zu",

260 
cÚn
->
sd
, 
n
, 
n£nd
);

262 ià(
n
 > 0) {

263 ià(
n
 < (
ssize_t
è
n£nd
) {

264 
cÚn
->
£nd_»ady
 = 0;

266 
cÚn
->
£nd_by‹s
 +ğ(
size_t
)
n
;

267  
n
;

270 ià(
n
 == 0) {

271 
	`log_w¬n
("£nd oÀsd %d„‘uºed z”o", 
cÚn
->
sd
);

272 
cÚn
->
£nd_»ady
 = 0;

276 ià(
”ºo
 =ğ
EINTR
) {

277 
	`log_debug
(
LOG_VERB
, "£nd oÀsd %d‚Ù„—dy -ƒšŒ", 
cÚn
->
sd
);

279 } ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

280 
cÚn
->
£nd_»ady
 = 0;

281 
	`log_debug
(
LOG_VERB
, "£nd oÀsd %d‚Ù„—dy -ƒagaš", 
cÚn
->
sd
);

282  
VR_EAGAIN
;

284 
cÚn
->
£nd_»ady
 = 0;

285 
cÚn
->
”r
 = 
”ºo
;

286 
	`log_”rÜ
("£nd oÀsd %d faed: %s", 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

287  
VR_ERROR
;

291 
	`NOT_REACHED
();

293  
VR_ERROR
;

294 
	}
}

296 
ssize_t


297 
	$cÚn_£ndv
(
cÚn
 *cÚn, 
d¬¿y
 *
£ndv
, 
size_t
 
n£nd
)

299 
ssize_t
 
n
;

301 
	`ASSERT
(
	`d¬¿y_n
(
£ndv
) > 0);

302 
	`ASSERT
(
n£nd
 != 0);

303 
	`ASSERT
(
cÚn
->
£nd_»ady
);

306 
n
 = 
	`vr_wr™ev
(
cÚn
->
sd
, 
£ndv
->
–em
, s’dv->
ÃËm
);

308 
	`log_debug
(
LOG_VERB
, "£ndv oÀsd %d %zd oà%zu iÀ%"
PRIu32
" buffers",

309 
cÚn
->
sd
, 
n
, 
n£nd
, 
£ndv
->
ÃËm
);

311 ià(
n
 > 0) {

312 ià(
n
 < (
ssize_t
è
n£nd
) {

313 
cÚn
->
£nd_»ady
 = 0;

315 
cÚn
->
£nd_by‹s
 +ğ(
size_t
)
n
;

316  
n
;

319 ià(
n
 == 0) {

320 
	`log_w¬n
("£ndv oÀsd %d„‘uºed z”o", 
cÚn
->
sd
);

321 
cÚn
->
£nd_»ady
 = 0;

325 ià(
”ºo
 =ğ
EINTR
) {

326 
	`log_debug
(
LOG_VERB
, "£ndv oÀsd %d‚Ù„—dy -ƒšŒ", 
cÚn
->
sd
);

328 } ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

329 
cÚn
->
£nd_»ady
 = 0;

330 
	`log_debug
(
LOG_VERB
, "£ndv oÀsd %d‚Ù„—dy -ƒagaš", 
cÚn
->
sd
);

331  
VR_EAGAIN
;

333 
cÚn
->
£nd_»ady
 = 0;

334 
cÚn
->
”r
 = 
”ºo
;

335 
	`log_”rÜ
("£ndv oÀsd %d faed: %s", 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

336  
VR_ERROR
;

340 
	`NOT_REACHED
();

342  
VR_ERROR
;

343 
	}
}

	@src/vr_connection.c

1 
	~<sys/uio.h
>

3 
	~<vr_cÜe.h
>

5 
cÚn_ä“
(
cÚn
 *conn);

8 
cÚn
 *

9 
	$_cÚn_g‘
(
cÚn_ba£
 *
cb
)

11 
cÚn
 *conn;

13 ià(
cb
 !ğ
NULL
 && 
	`dli¡L’gth
(cb->
ä“_cÚnq
) > 0) {

14 
cÚn
 = 
	`dli¡Pİ
(
cb
->
ä“_cÚnq
);

16 
cÚn
 = 
	`d®loc
((*conn));

17 ià(
cÚn
 =ğ
NULL
) {

18  
NULL
;

20 
cÚn
->
cb
 = cb;

22 
cÚn
->
šqueue
 = 
NULL
;

23 
cÚn
->
outqueue
 = 
NULL
;

26 
cÚn
->
owÃr
 = 
NULL
;

28 
cÚn
->
sd
 = -1;

30 
cÚn
->
£nd_by‹s
 = 0;

31 
cÚn
->
»cv_by‹s
 = 0;

33 
cÚn
->
”r
 = 0;

34 
cÚn
->
»cv_aùive
 = 0;

35 
cÚn
->
»cv_»ady
 = 0;

36 
cÚn
->
£nd_aùive
 = 0;

37 
cÚn
->
£nd_»ady
 = 0;

39 
cÚn
->
cÚÃùšg
 = 0;

40 
cÚn
->
cÚÃùed
 = 0;

41 
cÚn
->
eof
 = 0;

42 
cÚn
->
dÚe
 = 0;

44 ià(
cÚn
->
šqueue
 =ğ
NULL
) {

45 
cÚn
->
šqueue
 = 
	`dli¡C»©e
();

46 ià(
cÚn
->
šqueue
 =ğ
NULL
) {

47 
	`cÚn_ä“
(
cÚn
);

48  
NULL
;

52 ià(
cÚn
->
outqueue
 =ğ
NULL
) {

53 
cÚn
->
outqueue
 = 
	`dli¡C»©e
();

54 ià(
cÚn
->
outqueue
 =ğ
NULL
) {

55 
	`cÚn_ä“
(
cÚn
);

56  
NULL
;

60 ià(
cb
 !ğ
NULL
) {

61 
cb
->
ÁÙ®_cÚn
++;

62 
cb
->
ncu¼_cÚn
++;

65  
cÚn
;

66 
	}
}

68 
cÚn
 *

69 
	$cÚn_g‘
(
cÚn_ba£
 *
cb
)

71 
cÚn
 *conn;

73 
cÚn
 = 
	`_cÚn_g‘
(
cb
);

74 ià(
cÚn
 =ğ
NULL
) {

75  
NULL
;

78 
	`log_debug
(
LOG_VVERB
, "g‘ cÚÀ%°ş›Á %d", 
cÚn
, cÚn->
sd
);

80  
cÚn
;

81 
	}
}

84 
	$cÚn_ä“
(
cÚn
 *conn)

86 
	`log_debug
(
LOG_VVERB
, "ä“ cÚÀ%p", 
cÚn
);

88 ià(
cÚn
 =ğ
NULL
) {

92 ià(
cÚn
->
sd
 > 0) {

93 
	`şo£
(
cÚn
->
sd
);

94 
cÚn
->
sd
 = -1;

95 
	`upd©e_cu¼_ş›Ás_sub
(1);

98 ià(
cÚn
->
šqueue
) {

99 
sds
 
buf
;

100 
buf
 = 
	`dli¡Pİ
(
cÚn
->
šqueue
)) {

101 
	`sdsä“
(
buf
);

103 
	`dli¡R–—£
(
cÚn
->
šqueue
);

104 
cÚn
->
šqueue
 = 
NULL
;

107 ià(
cÚn
->
outqueue
) {

108 
sds
 
buf
;

109 
buf
 = 
	`dli¡Pİ
(
cÚn
->
outqueue
)) {

110 
	`sdsä“
(
buf
);

112 
	`dli¡R–—£
(
cÚn
->
outqueue
);

113 
cÚn
->
outqueue
 = 
NULL
;

116 
	`dä“
(
cÚn
);

117 
	}
}

121 
	$cÚn_put
(
cÚn
 *conn)

124 
cÚn_ba£
 *
cb
 = 
cÚn
->cb;

126 
	`ASSERT
(
cÚn
->
owÃr
 =ğ
NULL
);

128 
	`log_debug
(
LOG_VVERB
, "puˆcÚÀ%p", 
cÚn
);

131 ià(
cÚn
->
sd
 > 0) {

132 
	`şo£
(
cÚn
->
sd
);

133 
cÚn
->
sd
 = -1;

134 
	`upd©e_cu¼_ş›Ás_sub
(1);

137 ià(
cb
 =ğ
NULL
) {

138 
	`cÚn_ä“
(
cÚn
);

142 ià(
cÚn
->
šqueue
) {

143 
sds
 
buf
;

144 
buf
 = 
	`dli¡Pİ
(
cÚn
->
šqueue
)) {

145 
	`sdsä“
(
buf
);

149 ià(
cÚn
->
outqueue
) {

150 
sds
 
buf
;

151 
buf
 = 
	`dli¡Pİ
(
cÚn
->
outqueue
)) {

152 
	`sdsä“
(
buf
);

156 
	`dli¡Push
(
cb
->
ä“_cÚnq
, 
cÚn
);

157 
cb
->
ncu¼_ccÚn
--;

158 
cb
->
ncu¼_cÚn
--;

159 
	}
}

163 
	$cÚn_š™
(
cÚn_ba£
 *
cb
)

165 
	`log_debug
(
LOG_DEBUG
, "cÚÀsiz%d", (
cÚn
));

167 
cb
->
ä“_cÚnq
 = 
NULL
;

168 
cb
->
ÁÙ®_cÚn
 = 0;

169 
cb
->
ncu¼_ccÚn
 = 0;

170 
cb
->
ncu¼_ccÚn
 = 0;

172 
cb
->
ä“_cÚnq
 = 
	`dli¡C»©e
();

173 ià(
cb
->
ä“_cÚnq
 =ğ
NULL
) {

174  
VR_ENOMEM
;

177  
VR_OK
;

178 
	}
}

181 
	$cÚn_deš™
(
cÚn_ba£
 *
cb
)

183 
cÚn
 *conn;

185 ià(
cb
->
ä“_cÚnq
) {

186 
cÚn
 = 
	`dli¡Pİ
(
cb
->
ä“_cÚnq
)) {

187 
	`cÚn_ä“
(
cÚn
);

189 
	`ASSERT
(
	`dli¡L’gth
(
cb
->
ä“_cÚnq
) == 0);

190 
	`dli¡R–—£
(
cb
->
ä“_cÚnq
);

192 
	}
}

194 
ssize_t


195 
	$cÚn_»cv
(
cÚn
 *cÚn, *
buf
, 
size_t
 
size
)

197 
ssize_t
 
n
;

199 
	`ASSERT
(
buf
 !ğ
NULL
);

200 
	`ASSERT
(
size
 > 0);

201 
	`ASSERT
(
cÚn
->
»cv_»ady
);

205 
n
 = 
	`vr_»ad
(
cÚn
->
sd
, 
buf
, 
size
);

208 
	`log_debug
(
LOG_VERB
, "»cv oÀsd %d %zd oà%zu", 
cÚn
->
sd
, 
n
, 
size
);

211 ià(
n
 > 0) {

212 ià(
n
 < (
ssize_t
è
size
) {

213 
cÚn
->
»cv_»ady
 = 0;

215 
cÚn
->
»cv_by‹s
 +ğ(
size_t
)
n
;

216  
n
;

219 ià(
n
 == 0) {

220 
cÚn
->
»cv_»ady
 = 0;

221 
cÚn
->
eof
 = 1;

222 
	`log_debug
(
LOG_INFO
, "»cv oÀsd %dƒoàrb %zu sb %zu", 
cÚn
->
sd
,

223 
cÚn
->
»cv_by‹s
, cÚn->
£nd_by‹s
);

224  
n
;

227 ià(
”ºo
 =ğ
EINTR
) {

228 
	`log_debug
(
LOG_VERB
, "»cv oÀsd %d‚Ù„—dy -ƒšŒ", 
cÚn
->
sd
);

230 } ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

231 
cÚn
->
»cv_»ady
 = 0;

232 
	`log_debug
(
LOG_VERB
, "»cv oÀsd %d‚Ù„—dy -ƒagaš", 
cÚn
->
sd
);

233  
VR_EAGAIN
;

235 
cÚn
->
»cv_»ady
 = 0;

236 
cÚn
->
”r
 = 
”ºo
;

237 
	`log_”rÜ
("»cv oÀsd %d faed: %s", 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

238  
VR_ERROR
;

242 
	`NOT_REACHED
();

244  
VR_ERROR
;

245 
	}
}

247 
ssize_t


248 
	$cÚn_£nd
(
cÚn
 *cÚn, *
buf
, 
size_t
 
n£nd
)

250 
ssize_t
 
n
;

252 
	`ASSERT
(
n£nd
 != 0);

253 
	`ASSERT
(
cÚn
->
£nd_»ady
);

257 
n
 = 
	`vr_wr™e
(
cÚn
->
sd
, 
buf
, 
n£nd
);

259 
	`log_debug
(
LOG_VERB
, "send on sd %d %zd of %zu",

260 
cÚn
->
sd
, 
n
, 
n£nd
);

262 ià(
n
 > 0) {

263 ià(
n
 < (
ssize_t
è
n£nd
) {

264 
cÚn
->
£nd_»ady
 = 0;

266 
cÚn
->
£nd_by‹s
 +ğ(
size_t
)
n
;

267  
n
;

270 ià(
n
 == 0) {

271 
	`log_w¬n
("£nd oÀsd %d„‘uºed z”o", 
cÚn
->
sd
);

272 
cÚn
->
£nd_»ady
 = 0;

276 ià(
”ºo
 =ğ
EINTR
) {

277 
	`log_debug
(
LOG_VERB
, "£nd oÀsd %d‚Ù„—dy -ƒšŒ", 
cÚn
->
sd
);

279 } ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

280 
cÚn
->
£nd_»ady
 = 0;

281 
	`log_debug
(
LOG_VERB
, "£nd oÀsd %d‚Ù„—dy -ƒagaš", 
cÚn
->
sd
);

282  
VR_EAGAIN
;

284 
cÚn
->
£nd_»ady
 = 0;

285 
cÚn
->
”r
 = 
”ºo
;

286 
	`log_”rÜ
("£nd oÀsd %d faed: %s", 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

287  
VR_ERROR
;

291 
	`NOT_REACHED
();

293  
VR_ERROR
;

294 
	}
}

296 
ssize_t


297 
	$cÚn_£ndv
(
cÚn
 *cÚn, 
d¬¿y
 *
£ndv
, 
size_t
 
n£nd
)

299 
ssize_t
 
n
;

301 
	`ASSERT
(
	`d¬¿y_n
(
£ndv
) > 0);

302 
	`ASSERT
(
n£nd
 != 0);

303 
	`ASSERT
(
cÚn
->
£nd_»ady
);

306 
n
 = 
	`vr_wr™ev
(
cÚn
->
sd
, 
£ndv
->
–em
, s’dv->
ÃËm
);

308 
	`log_debug
(
LOG_VERB
, "£ndv oÀsd %d %zd oà%zu iÀ%"
PRIu32
" buffers",

309 
cÚn
->
sd
, 
n
, 
n£nd
, 
£ndv
->
ÃËm
);

311 ià(
n
 > 0) {

312 ià(
n
 < (
ssize_t
è
n£nd
) {

313 
cÚn
->
£nd_»ady
 = 0;

315 
cÚn
->
£nd_by‹s
 +ğ(
size_t
)
n
;

316  
n
;

319 ià(
n
 == 0) {

320 
	`log_w¬n
("£ndv oÀsd %d„‘uºed z”o", 
cÚn
->
sd
);

321 
cÚn
->
£nd_»ady
 = 0;

325 ià(
”ºo
 =ğ
EINTR
) {

326 
	`log_debug
(
LOG_VERB
, "£ndv oÀsd %d‚Ù„—dy -ƒšŒ", 
cÚn
->
sd
);

328 } ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

329 
cÚn
->
£nd_»ady
 = 0;

330 
	`log_debug
(
LOG_VERB
, "£ndv oÀsd %d‚Ù„—dy -ƒagaš", 
cÚn
->
sd
);

331  
VR_EAGAIN
;

333 
cÚn
->
£nd_»ady
 = 0;

334 
cÚn
->
”r
 = 
”ºo
;

335 
	`log_”rÜ
("£ndv oÀsd %d faed: %s", 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

336  
VR_ERROR
;

340 
	`NOT_REACHED
();

342  
VR_ERROR
;

343 
	}
}

	@src/vr_connection.h

1 #iâdeà
_VR_CONNECTION_H_


2 
	#_VR_CONNECTION_H_


	)

5 
	scÚn_ba£
 {

6 
dli¡
 *
	mä“_cÚnq
;

7 
ušt64_t
 
	mÁÙ®_cÚn
;

8 
ušt32_t
 
	mncu¼_cÚn
;

9 
ušt32_t
 
	mncu¼_ccÚn
;

10 }
	tcÚn_ba£
;

13 
	scÚn
 {

15 *
	mowÃr
;

17 
cÚn_ba£
 *
	mcb
;

19 
	msd
;

21 
size_t
 
	m»cv_by‹s
;

23 
size_t
 
	m£nd_by‹s
;

25 
”r_t
 
	m”r
;

27 
	m»cv_aùive
:1;

28 
	m»cv_»ady
:1;

29 
	m£nd_aùive
:1;

30 
	m£nd_»ady
:1;

32 
	mcÚÃùšg
:1;

33 
	mcÚÃùed
:1;

35 
	meof
:1;

36 
	mdÚe
:1;

39 
dli¡
 *
	mšqueue
;

40 
dli¡
 *
	moutqueue
;

43 
cÚn
 *
cÚn_g‘
(
cÚn_ba£
 *
cb
);

44 
cÚn_put
(
cÚn
 *conn);

46 
cÚn_š™
(
cÚn_ba£
 *
cb
);

47 
cÚn_deš™
(
cÚn_ba£
 *
cb
);

49 
ssize_t
 
cÚn_»cv
(
cÚn
 *cÚn, *
buf
, 
size_t
 
size
);

50 
ssize_t
 
cÚn_£nd
(
cÚn
 *cÚn, *
buf
, 
size_t
 
n£nd
);

51 
ssize_t
 
cÚn_£ndv
(
cÚn
 *cÚn, 
d¬¿y
 *
£ndv
, 
size_t
 
n£nd
);

	@src/vr_connection.h

1 #iâdeà
_VR_CONNECTION_H_


2 
	#_VR_CONNECTION_H_


	)

5 
	scÚn_ba£
 {

6 
dli¡
 *
	mä“_cÚnq
;

7 
ušt64_t
 
	mÁÙ®_cÚn
;

8 
ušt32_t
 
	mncu¼_cÚn
;

9 
ušt32_t
 
	mncu¼_ccÚn
;

10 }
	tcÚn_ba£
;

13 
	scÚn
 {

15 *
	mowÃr
;

17 
cÚn_ba£
 *
	mcb
;

19 
	msd
;

21 
size_t
 
	m»cv_by‹s
;

23 
size_t
 
	m£nd_by‹s
;

25 
”r_t
 
	m”r
;

27 
	m»cv_aùive
:1;

28 
	m»cv_»ady
:1;

29 
	m£nd_aùive
:1;

30 
	m£nd_»ady
:1;

32 
	mcÚÃùšg
:1;

33 
	mcÚÃùed
:1;

35 
	meof
:1;

36 
	mdÚe
:1;

39 
dli¡
 *
	mšqueue
;

40 
dli¡
 *
	moutqueue
;

43 
cÚn
 *
cÚn_g‘
(
cÚn_ba£
 *
cb
);

44 
cÚn_put
(
cÚn
 *conn);

46 
cÚn_š™
(
cÚn_ba£
 *
cb
);

47 
cÚn_deš™
(
cÚn_ba£
 *
cb
);

49 
ssize_t
 
cÚn_»cv
(
cÚn
 *cÚn, *
buf
, 
size_t
 
size
);

50 
ssize_t
 
cÚn_£nd
(
cÚn
 *cÚn, *
buf
, 
size_t
 
n£nd
);

51 
ssize_t
 
cÚn_£ndv
(
cÚn
 *cÚn, 
d¬¿y
 *
£ndv
, 
size_t
 
n£nd
);

	@src/vr_core.c

1 
	~<¡dlib.h
>

2 
	~<uni¡d.h
>

4 
	~<vr_cÜe.h
>

6 
ušt32_t
 
	g»£rved_fds
 = 0;

	@src/vr_core.c

1 
	~<¡dlib.h
>

2 
	~<uni¡d.h
>

4 
	~<vr_cÜe.h
>

6 
ušt32_t
 
	g»£rved_fds
 = 0;

	@src/vr_core.h

1 #iâdeà
_VR_CORE_H_


2 
	#_VR_CORE_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	~<d¥ecŸlcÚfig.h
>

10 #ifdeà
HAVE_STATS


11 
	#VR_STATS
 1

	)

13 
	#VR_STATS
 0

	)

16 #ifdeà
HAVE_LITTLE_ENDIAN


17 
	#VR_LITTLE_ENDIAN
 1

	)

20 #ifdeà
HAVE_BACKTRACE


21 
	#VR_HAVE_BACKTRACE
 1

	)

24 #ifdeà
HAVE_SPINLOCK


25 
	#VR_USE_SPINLOCK
 1

	)

28 
	#VR_OK
 0

	)

29 
	#VR_ERROR
 -1

	)

30 
	#VR_EAGAIN
 -2

	)

31 
	#VR_ENOMEM
 -3

	)

34 
	#RESERVED_FDS
 32

	)

36 
	tr¡©us_t
;

37 
	t”r_t
;

39 
	tm¡ime_t
;

41 
	gš¡ªû
;

42 
	gd¬¿y
;

43 
	gcÚn
;

44 
	gş›Á
;

45 
	gş›ÁBufãrLim™sCÚfig
;

46 
	g»disCommªd
;

47 
	gvr_wÜk”
;

49 
	~<¡ddef.h
>

50 
	~<¡dšt.h
>

51 
	~<š‰y³s.h
>

52 
	~<¡ršg.h
>

53 
	~<¡dio.h
>

54 
	~<ùy³.h
>

55 
	~<”ºo.h
>

56 
	~<lim™s.h
>

57 
	~<time.h
>

58 
	~<uni¡d.h
>

59 
	~<±h»ad.h
>

61 
	~<sys/ty³s.h
>

62 
	~<sys/sock‘.h
>

63 
	~<sys/un.h
>

64 
	~<sys/time.h
>

65 
	~<sys/»sourû.h
>

66 
	~<Ãtš‘/š.h
>

68 
	~<«.h
>

69 
	~<sds.h
>

70 
	~<dut.h
>

71 
	~<dlog.h
>

72 
	~<dhashk™.h
>

73 
	~<dm®loc.h
>

74 
	~<d¬¿y.h
>

75 
	~<dli¡.h
>

77 
	~<vr_ut.h
>

78 
	~<vr_sigÇl.h
>

80 
	~<vr_zli¡.h
>

81 
	~<vr_zm­.h
>

82 
	~<vr_diù.h
>

83 
	~<vr_rbŒ“.h
>

84 
	~<vr_št£t.h
>

85 
	~<vr_quickli¡.h
>

87 
	~<vr_lzf.h
>

88 
	~<vr_lzfP.h
>

90 
	~<vr_objeù.h
>

92 
	~<vr_li¡’.h
>

93 
	~<vr_cÚÃùiÚ.h
>

95 
	~<vr_¡©s.h
>

96 
	~<vr_cÚf.h
>

98 
	~<vr_th»ad.h
>

99 
	~<vr_ev’oİ.h
>

100 
	~<vr_ma¡”.h
>

101 
	~<vr_wÜk”.h
>

102 
	~<vr_back’d.h
>

104 
	~<vr_db.h
>

105 
	~<vr_muÉi.h
>

107 
	~<vr_commªd.h
>

108 
	~<vr_block.h
>

109 
	~<vr_ş›Á.h
>

110 
	~<vr_£rv”.h
>

112 
	~<vr_nÙify.h
>

113 
	~<vr_pubsub.h
>

115 
	~<vr_rdb.h
>

116 
	~<vr_aof.h
>

117 
	~<vr_»¶iÿtiÚ.h
>

118 
	~<vr_sütšg.h
>

120 
	~<vr_t_hash.h
>

121 
	~<vr_t_li¡.h
>

122 
	~<vr_t_£t.h
>

123 
	~<vr_t_¡ršg.h
>

124 
	~<vr_t_z£t.h
>

126 
	~<vr_b™İs.h
>

128 
	~<vr_hy³¾oglog.h
>

130 
	~<vr_¦owlog.h
>

132 
	sš¡ªû
 {

134 
	mlog_Ëv–
;

136 *
	mlog_f’ame
;

138 *
	mcÚf_f’ame
;

140 
	mho¡Çme
[
VR_MAXHOSTNAMELEN
];

142 
size_t
 
	mmbuf_chunk_size
;

144 
pid_t
 
	mpid
;

145 *
	mpid_f’ame
;

147 
	mpidfe
:1;

149 
	mth»ad_num
;

	@src/vr_core.h

1 #iâdeà
_VR_CORE_H_


2 
	#_VR_CORE_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	~<d¥ecŸlcÚfig.h
>

10 #ifdeà
HAVE_STATS


11 
	#VR_STATS
 1

	)

13 
	#VR_STATS
 0

	)

16 #ifdeà
HAVE_LITTLE_ENDIAN


17 
	#VR_LITTLE_ENDIAN
 1

	)

20 #ifdeà
HAVE_BACKTRACE


21 
	#VR_HAVE_BACKTRACE
 1

	)

24 #ifdeà
HAVE_SPINLOCK


25 
	#VR_USE_SPINLOCK
 1

	)

28 
	#VR_OK
 0

	)

29 
	#VR_ERROR
 -1

	)

30 
	#VR_EAGAIN
 -2

	)

31 
	#VR_ENOMEM
 -3

	)

34 
	#RESERVED_FDS
 32

	)

36 
	tr¡©us_t
;

37 
	t”r_t
;

39 
	tm¡ime_t
;

41 
	gš¡ªû
;

42 
	gd¬¿y
;

43 
	gcÚn
;

44 
	gş›Á
;

45 
	gş›ÁBufãrLim™sCÚfig
;

46 
	g»disCommªd
;

47 
	gvr_wÜk”
;

49 
	~<¡ddef.h
>

50 
	~<¡dšt.h
>

51 
	~<š‰y³s.h
>

52 
	~<¡ršg.h
>

53 
	~<¡dio.h
>

54 
	~<ùy³.h
>

55 
	~<”ºo.h
>

56 
	~<lim™s.h
>

57 
	~<time.h
>

58 
	~<uni¡d.h
>

59 
	~<±h»ad.h
>

61 
	~<sys/ty³s.h
>

62 
	~<sys/sock‘.h
>

63 
	~<sys/un.h
>

64 
	~<sys/time.h
>

65 
	~<sys/»sourû.h
>

66 
	~<Ãtš‘/š.h
>

68 
	~<«.h
>

69 
	~<sds.h
>

70 
	~<dut.h
>

71 
	~<dlog.h
>

72 
	~<dhashk™.h
>

73 
	~<dm®loc.h
>

74 
	~<d¬¿y.h
>

75 
	~<dli¡.h
>

77 
	~<vr_ut.h
>

78 
	~<vr_sigÇl.h
>

80 
	~<vr_zli¡.h
>

81 
	~<vr_zm­.h
>

82 
	~<vr_diù.h
>

83 
	~<vr_rbŒ“.h
>

84 
	~<vr_št£t.h
>

85 
	~<vr_quickli¡.h
>

87 
	~<vr_lzf.h
>

88 
	~<vr_lzfP.h
>

90 
	~<vr_objeù.h
>

92 
	~<vr_li¡’.h
>

93 
	~<vr_cÚÃùiÚ.h
>

95 
	~<vr_¡©s.h
>

96 
	~<vr_cÚf.h
>

98 
	~<vr_th»ad.h
>

99 
	~<vr_ev’oİ.h
>

100 
	~<vr_ma¡”.h
>

101 
	~<vr_wÜk”.h
>

102 
	~<vr_back’d.h
>

104 
	~<vr_db.h
>

105 
	~<vr_muÉi.h
>

107 
	~<vr_commªd.h
>

108 
	~<vr_block.h
>

109 
	~<vr_ş›Á.h
>

110 
	~<vr_£rv”.h
>

112 
	~<vr_nÙify.h
>

113 
	~<vr_pubsub.h
>

115 
	~<vr_rdb.h
>

116 
	~<vr_aof.h
>

117 
	~<vr_»¶iÿtiÚ.h
>

118 
	~<vr_sütšg.h
>

120 
	~<vr_t_hash.h
>

121 
	~<vr_t_li¡.h
>

122 
	~<vr_t_£t.h
>

123 
	~<vr_t_¡ršg.h
>

124 
	~<vr_t_z£t.h
>

126 
	~<vr_b™İs.h
>

128 
	~<vr_hy³¾oglog.h
>

130 
	~<vr_¦owlog.h
>

132 
	sš¡ªû
 {

134 
	mlog_Ëv–
;

136 *
	mlog_f’ame
;

138 *
	mcÚf_f’ame
;

140 
	mho¡Çme
[
VR_MAXHOSTNAMELEN
];

142 
size_t
 
	mmbuf_chunk_size
;

144 
pid_t
 
	mpid
;

145 *
	mpid_f’ame
;

147 
	mpidfe
:1;

149 
	mth»ad_num
;

	@src/vr_db.c

1 
	~<sigÇl.h
>

2 
	~<ùy³.h
>

4 
	~<vr_cÜe.h
>

7 
diùTy³
 
	gdbDiùTy³
 = {

8 
diùSdsHash
,

9 
NULL
,

10 
NULL
,

11 
diùSdsKeyCom·»
,

12 
diùSdsDe¡ruùÜ
,

13 
diùObjeùDe¡ruùÜ


17 
diùTy³
 
	gkey±rDiùTy³
 = {

18 
diùSdsHash
,

19 
NULL
,

20 
NULL
,

21 
diùSdsKeyCom·»
,

22 
NULL
,

23 
NULL


29 
diùTy³
 
	gkeyli¡DiùTy³
 = {

30 
diùObjHash
,

31 
NULL
,

32 
NULL
,

33 
diùObjKeyCom·»
,

34 
diùObjeùDe¡ruùÜ
,

35 
diùLi¡De¡ruùÜ


39 
eviùiÚPoŞEÁry
 *
	$eviùiÚPoŞAÎoc
() {

40 
eviùiÚPoŞEÁry
 *
•
;

41 
j
;

43 
•
 = 
	`d®loc
((*•)*
MAXMEMORY_EVICTION_POOL_SIZE
);

44 
j
 = 0; j < 
MAXMEMORY_EVICTION_POOL_SIZE
; j++) {

45 
•
[
j
].
idË
 = 0;

46 
•
[
j
].
key
 = 
NULL
;

48  
•
;

49 
	}
}

55 
	$»disDbIn™
(
»disDb
 *
db
)

57 
db
->
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

58 
db
->
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

59 
db
->
blockšg_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

60 
db
->
»ady_keys
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

61 
db
->
w©ched_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

62 
db
->
eviùiÚ_poŞ
 = 
	`eviùiÚPoŞAÎoc
();

63 
db
->
avg_‰l
 = 0;

65 
	`±h»ad_rwlock_š™
(&
db
->
rwl
, 
NULL
);

67  
VR_OK
;

68 
	}
}

71 
	$»disDbDeš™
(
»disDb
 *
db
)

73 
	`±h»ad_rwlock_de¡roy
(&
db
->
rwl
);

74  
VR_OK
;

75 
	}
}

78 
	$lockDbR—d
(
»disDb
 *
db
)

80 
	`±h»ad_rwlock_rdlock
(&
db
->
rwl
);

81  
VR_OK
;

82 
	}
}

85 
	$lockDbWr™e
(
»disDb
 *
db
)

87 
	`±h»ad_rwlock_w¾ock
(&
db
->
rwl
);

88  
VR_OK
;

89 
	}
}

92 
	$uÆockDb
(
»disDb
 *
db
)

94 
	`±h»ad_rwlock_uÆock
(&
db
->
rwl
);

95  
VR_OK
;

96 
	}
}

98 
robj
 *
	$lookupKey
(
»disDb
 *
db
, 
robj
 *
key
) {

99 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

100 ià(
de
) {

101 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

106 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1)

108 
v®
->
Ìu
 = 0;

109  
v®
;

111  
NULL
;

113 
	}
}

115 
robj
 *
	$lookupKeyR—d
(
»disDb
 *
db
, 
robj
 *
key
) {

116 ià(
	`checkIfExpœed
(
db
, 
key
)è 
NULL
;

117  
	`lookupKey
(
db
,
key
);

118 
	}
}

120 
robj
 *
	$lookupKeyWr™e
(
»disDb
 *
db
, 
robj
 *
key
, *
expœed
) {

121 ià(
expœed
è*expœed = 
	`expœeIfN“ded
(
db
,
key
);

122  
	`lookupKey
(
db
,
key
);

123 
	}
}

125 
robj
 *
	$lookupKeyR—dOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

126 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
, 
key
);

127 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

128  
o
;

129 
	}
}

131 
robj
 *
	$lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
, *
expœed
) {

132 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
, 
key
, 
expœed
);

133 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

134  
o
;

135 
	}
}

142 
	$dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

143 
sds
 
cİy
 = 
	`sdsdup
(
key
->
±r
);

144 
»tv®
 = 
	`diùAdd
(
db
->
diù
, 
cİy
, 
v®
);

145 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
»tv®
 =ğ
DICT_OK
);

146 ià(
v®
->
ty³
 =ğ
OBJ_LIST
è
	`sigÇlLi¡AsR—dy
(
db
, 
key
);

147 
	}
}

155 
	$dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

156 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

158 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
de
 != NULL);

159 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

160 
	}
}

168 
	$£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
, *
expœed
) {

169 ià(
	`lookupKeyWr™e
(
db
,
key
,
expœed
è=ğ
NULL
) {

170 
	`dbAdd
(
db
,
key
,
v®
);

172 
	`dbOv”wr™e
(
db
,
key
,
v®
);

175 
	`»moveExpœe
(
db
,
key
);

176 
	}
}

178 
	$dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
) {

179  
	`diùFšd
(
db
->
diù
,
key
->
±r
è!ğ
NULL
;

180 
	}
}

186 
robj
 *
	$dbRªdomKey
(
»disDb
 *
db
) {

187 
diùEÁry
 *
de
;

190 
sds
 
key
;

191 
robj
 *
keyobj
;

193 
	`lockDbR—d
(
db
);

194 
de
 = 
	`diùG‘RªdomKey
(
db
->
diù
);

195 ià(
de
 =ğ
NULL
) {

196 
	`uÆockDb
(
db
);

197  
NULL
;

200 
key
 = 
	`diùG‘Key
(
de
);

201 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

202 ià(
	`diùFšd
(
db
->
expœes
,
key
)) {

203 ià(
	`checkIfExpœed
(
db
,
keyobj
)) {

204 
	`uÆockDb
(
db
);

205 
	`ä“Objeù
(
keyobj
);

209 
	`uÆockDb
(
db
);

210  
keyobj
;

212 
	}
}

215 
	$dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

218 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

219 ià(
	`diùD–‘e
(
db
->
diù
,
key
->
±r
è=ğ
DICT_OK
) {

224 
	}
}

226 
robj
 *
	$dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
o
) {

227 
	`ASSERT
(
o
->
ty³
 =ğ
OBJ_STRING
);

228 ià(
o
->
cÚ¡ªt
 || o->
’codšg
 !ğ
OBJ_ENCODING_RAW
) {

229 
robj
 *
decoded
, *
Ãw
;

230 
decoded
 = 
	`g‘DecodedObjeù
(
o
);

231 
Ãw
 = 
	`ü—‹RawSŒšgObjeù
(
decoded
->
±r
, 
	`sd¦’
(decoded->ptr));

232 ià(
decoded
 !ğ
o
è
	`ä“Objeù
(decoded);

233 
	`dbOv”wr™e
(
db
,
key
,
Ãw
);

234  
Ãw
;

236  
o
;

237 
	}
}

239 
em±yDb
((
ÿÎback
)(*)) {

240 
j
;

241 
»moved
 = 0;

242 
»disDb
 *
db
;

244 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

245 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)
j
);

246 
»moved
 +ğ
	`diùSize
(
db
->
diù
);

247 
	`diùEm±y
(
db
->
diù
,
ÿÎback
);

248 
	`diùEm±y
(
db
->
expœes
,
ÿÎback
);

251  
»moved
;

252 
	}
}

254 
	$£ËùDb
(
ş›Á
 *
c
, 
id
) {

255 
»disDb
 *
db
;

257 ià(
id
 < 0 || id >ğ
£rv”
.
dbÊum
)

258  
VR_ERROR
;

260 
c
->
diùid
 = 
id
;

261  
VR_OK
;

262 
	}
}

273 
	$sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
) {

274 
	`touchW©chedKey
(
db
,
key
);

275 
	}
}

277 
	$sigÇlFlushedDb
(
dbid
) {

278 
	`touchW©chedKeysOnFlush
(
dbid
);

279 
	}
}

285 
	$æushdbCommªd
(
ş›Á
 *
c
) {

286 
idx
;

288 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

289 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

290 
	`lockDbWr™e
(
c
->
db
);

291 
c
->
v–
->
dœty
 +ğ
	`diùSize
(c->
db
->
diù
);

292 
	`sigÇlFlushedDb
(
c
->
db
->
id
);

293 
	`diùEm±y
(
c
->
db
->
diù
,
NULL
);

294 
	`diùEm±y
(
c
->
db
->
expœes
,
NULL
);

295 
	`uÆockDb
(
c
->
db
);

298 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

299 
	}
}

301 
	$æush®lCommªd
(
ş›Á
 *
c
) {

302 
idx
;

303 
»disDb
 *
db
;

305 
idx
 = 0; idx < 
£rv”
.
dbnum
; idx ++) {

306 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)
idx
);

307 
	`lockDbWr™e
(
db
);

308 
	`diùEm±y
(
db
->
diù
,
NULL
);

309 
	`diùEm±y
(
db
->
expœes
,
NULL
);

310 
	`uÆockDb
(
db
);

313 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

314 
	}
}

316 
	$d–Commªd
(
ş›Á
 *
c
) {

317 
d–‘ed
 = 0, 
j
;

318 
expœed
 = 0;

320 
j
 = 1; j < 
c
->
¬gc
; j++) {

321 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[
j
]);

322 
	`lockDbWr™e
(
c
->
db
);

323 
expœed
 +ğ
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

324 ià(
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
])) {

325 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

326 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

327 "d–",
c
->
¬gv
[
j
],c->
db
->
id
);

328 
c
->
v–
->
dœty
++;

329 
d–‘ed
++;

331 
	`uÆockDb
(
c
->
db
);

333 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

335 ià(
expœed
 > 0) {

336 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 
expœed
);

338 
	}
}

342 
	$exi¡sCommªd
(
ş›Á
 *
c
) {

343 
couÁ
 = 0;

344 
j
;

346 
j
 = 1; j < 
c
->
¬gc
; j++) {

347 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

348 
	`lockDbR—d
(
c
->
db
);

349 ià(
	`checkIfExpœed
(
c
->
db
,c->
¬gv
[
j
])) {

350 
	`uÆockDb
(
c
->
db
);

353 ià(
	`dbExi¡s
(
c
->
db
,c->
¬gv
[
j
])è
couÁ
++;

354 
	`uÆockDb
(
c
->
db
);

356 
	`addR•lyLÚgLÚg
(
c
,
couÁ
);

358 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 
couÁ
);

359 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, c->
¬gc
-1-
couÁ
);

360 
	}
}

362 
	$£ËùCommªd
(
ş›Á
 *
c
) {

363 
id
;

365 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[1], &
id
,

366 "šv®id DB index"è!ğ
VR_OK
)

369 ià(
	`£ËùDb
(
c
,
id
è=ğ
VR_ERROR
) {

370 
	`addR•lyE¼Ü
(
c
,"invalid DB index");

372 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

374 
	}
}

376 
	$¿ndomkeyCommªd
(
ş›Á
 *
c
) {

377 
robj
 *
key
;

378 
idx
, 
»Œy_couÁ
 = 0;

380 
idx
 = 
	`¿ndom
()%
£rv”
.
dbšum
;

382 
»Œy
:

383 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

384 ià((
key
 = 
	`dbRªdomKey
(
c
->
db
)è=ğ
NULL
) {

385 ià(
»Œy_couÁ
++ < 
£rv”
.
dbšum
) {

386 ià(++
idx
 >ğ
£rv”
.
dbšum
) {

387 
idx
 = 0;

389 
»Œy
;

392 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

396 
	`addR•lyBulk
(
c
,
key
);

397 
	`ä“Objeù
(
key
);

398 
	}
}

400 
	$keysCommªd
(
ş›Á
 *
c
) {

401 
diùI‹¿tÜ
 *
di
;

402 
diùEÁry
 *
de
;

403 
sds
 
·‰”n
 = 
c
->
¬gv
[1]->
±r
;

404 
¶’
 = 
	`sd¦’
(
·‰”n
), 
®lkeys
;

405 
numkeys
 = 0;

406 *
»¶yËn
;

407 
idx
;

408 
keys_couÁ
 = 0;

409 
expœed
 = 0;

410 
max_time_com¶ex™y_lim™
;

413 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

414 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

415 
	`lockDbWr™e
(
c
->
db
);

416 
keys_couÁ
 +ğ
	`diùSize
(
c
->
db
->
diù
);

417 
	`uÆockDb
(
c
->
db
);

420 
max_time_com¶ex™y_lim™
 = 
c
->
v–
->
cc
.max_time_complexity_limit;

421 ià(
max_time_com¶ex™y_lim™
 &&

422 
keys_couÁ
 > 
max_time_com¶ex™y_lim™
) {

423 
	`addR•ly
(
c
,
sh¬ed
.
outofcom¶ex™ylim™
);

427 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

428 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

429 
	`ãtchIÁ”ÇlDbById
(
c
,
idx
);

430 
	`lockDbWr™e
(
c
->
db
);

431 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
db
->
diù
);

432 
®lkeys
 = (
·‰”n
[0] == '*' &&…attern[1] == '\0');

433 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

434 
sds
 
key
 = 
	`diùG‘Key
(
de
);

435 
robj
 *
keyobj
;

437 ià(
®lkeys
 || 
	`¡ršgm©chËn
(
·‰”n
,
¶’
,
key
,
	`sd¦’
(key),0)) {

438 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

439 ià(
	`expœeIfN“ded
(
c
->
db
,
keyobj
) == 0) {

440 
	`addR•lyBulk
(
c
,
keyobj
);

441 
numkeys
++;

443 
expœed
 ++;

445 
	`ä“Objeù
(
keyobj
);

448 
	`diùR–—£I‹¿tÜ
(
di
);

449 
	`uÆockDb
(
c
->
db
);

451 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
numkeys
);

452 
	}
}

456 
	$sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
) {

457 **
pd
 = (**è
´ivd©a
;

458 
dli¡
 *
keys
 = 
pd
[0];

459 
robj
 *
o
 = 
pd
[1];

460 
robj
 *
key
, *
v®
 = 
NULL
;

462 ià(
o
 =ğ
NULL
) {

463 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

464 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
, 
	`sd¦’
(sdskey));

465 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

466 
key
 = 
	`diùG‘Key
(
de
);

467 
key
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(key);

468 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

469 
key
 = 
	`diùG‘Key
(
de
);

470 
key
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(key);

471 
v®
 = 
	`diùG‘V®
(
de
);

472 
v®
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(val);

473 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

474 
key
 = 
	`diùG‘Key
(
de
);

475 
key
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(key);

476 
v®
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(*(*)
	`diùG‘V®
(
de
),0);

478 
	`£rv”Pªic
("Type‚ot handled in SCAN callback.");

481 
	`dli¡AddNodeTa
(
keys
, 
key
);

482 ià(
v®
è
	`dli¡AddNodeTa
(
keys
, val);

483 
	}
}

489 
	$·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
) {

490 *
•Œ
;

494 
”ºo
 = 0;

495 *
cursÜ
 = 
	`¡¹oul
(
o
->
±r
, &
•Œ
, 10);

496 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
)

498 
	`addR•lyE¼Ü
(
c
, "invalid cursor");

499  
VR_ERROR
;

501  
VR_OK
;

502 
	}
}

515 
	$sÿnG’”icCommªd
(
ş›Á
 *
c
, 
sÿÁy³
) {

516 
i
, 
j
;

517 
dli¡
 *
keys
 = 
	`dli¡C»©e
();

518 
dli¡Node
 *
node
, *
ÃxŠode
;

519 
couÁ
 = 10;

520 
sds
 
·t
 = 
NULL
;

521 
·’
 = 0, 
u£_·‰”n
 = 0;

522 
cursÜ
;

523 
robj
 *
o
;

524 
diù
 *
ht
;

527 
i
 = (
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) ? 2 : 3;

528 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[
i
-1],&
cursÜ
è=ğ
VR_ERROR
) ;

531 
i
 < 
c
->
¬gc
) {

532 
j
 = 
c
->
¬gc
 - 
i
;

533 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "couÁ"è&& 
j
 >= 2) {

534 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
i
+1], &
couÁ
, 
NULL
)

535 !ğ
VR_OK
)

537 
ş—nup
;

540 ià(
couÁ
 < 1) {

541 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

542 
ş—nup
;

545 
i
 += 2;

546 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "m©ch"è&& 
j
 >= 2) {

547 
·t
 = 
c
->
¬gv
[
i
+1]->
±r
;

548 
·’
 = 
	`sd¦’
(
·t
);

552 
u£_·‰”n
 = !(
·t
[0] =ğ'*' && 
·’
 == 1);

554 
i
 += 2;

556 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

557 
ş—nup
;

561 ià(
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) {

562 
o
 = 
NULL
;

563 ià(
c
->
sÿnid
 =ğ-1 || 
cursÜ
 == 0) c->scanid = 0;

564 
	`ãtchIÁ”ÇlDbById
(
c
, c->
sÿnid
);

565 
	`lockDbR—d
(
c
->
db
);

566 } ià(
sÿÁy³
 =ğ
SCAN_TYPE_HASH
 ||

567 
sÿÁy³
 =ğ
SCAN_TYPE_SET
 ||

568 
sÿÁy³
 =ğ
SCAN_TYPE_ZSET
) {

569 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

570 
	`lockDbR—d
(
c
->
db
);

571 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
) {

572 
	`uÆockDb
(
c
->
db
);

573 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

578 
sÿÁy³
) {

579 
SCAN_TYPE_KEY
:

580 
	`ASSERT
(
o
 =ğ
NULL
);

582 
SCAN_TYPE_HASH
:

583 ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

584 
	`uÆockDb
(
c
->
db
);

585 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

589 
SCAN_TYPE_SET
:

590 ià(
	`checkTy³
(
c
,
o
,
OBJ_SET
)) {

591 
	`uÆockDb
(
c
->
db
);

592 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

596 
SCAN_TYPE_ZSET
:

597 ià(
	`checkTy³
(
c
,
o
,
OBJ_ZSET
)) {

598 
	`uÆockDb
(
c
->
db
);

599 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

607 
	`ASSERT
(
o
 =ğ
NULL
 || o->
ty³
 =ğ
OBJ_SET
 || o->ty³ =ğ
OBJ_HASH
 ||

608 
o
->
ty³
 =ğ
OBJ_ZSET
);

610 
sÿn_»Œy
:

621 
ht
 = 
NULL
;

622 ià(
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) {

623 
ht
 = 
c
->
db
->
diù
;

624 } ià(
o
->
ty³
 =ğ
OBJ_SET
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

625 
ht
 = 
o
->
±r
;

626 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

627 
ht
 = 
o
->
±r
;

628 
couÁ
 *= 2;

629 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
 && o->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

630 
z£t
 *
zs
 = 
o
->
±r
;

631 
ht
 = 
zs
->
diù
;

632 
couÁ
 *= 2;

635 ià(
ht
) {

636 *
´ivd©a
[2];

641 
max™”©iÚs
 = 
couÁ
*10;

646 
´ivd©a
[0] = 
keys
;

647 
´ivd©a
[1] = 
o
;

649 
cursÜ
 = 
	`diùSÿn
(
ht
, cursÜ, 
sÿnC®lback
, 
´ivd©a
);

650 } 
cursÜ
 &&

651 
max™”©iÚs
-- &&

652 
	`dli¡L’gth
(
keys
è< ()
couÁ
);

653 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

654 
pos
 = 0;

655 
št64_t
 
Î
;

657 
	`št£tG‘
(
o
->
±r
,
pos
++,&
Î
))

658 
	`dli¡AddNodeTa
(
keys
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î
));

659 
cursÜ
 = 0;

660 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 || o->ty³ =ğ
OBJ_ZSET
) {

661 *
p
 = 
	`zli¡Index
(
o
->
±r
,0);

662 *
v¡r
;

663 
vËn
;

664 
vÎ
;

666 
p
) {

667 
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vÎ
);

668 
	`dli¡AddNodeTa
(
keys
,

669 (
v¡r
 !ğ
NULL
è? 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
) :

670 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
));

671 
p
 = 
	`zli¡Next
(
o
->
±r
,p);

673 
cursÜ
 = 0;

675 
	`£rv”Pªic
("Not handledƒncoding in SCAN.");

678 
	`uÆockDb
(
c
->
db
);

679 ià(
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) {

680 ià(
cursÜ
 == 0) {

681 ià(
c
->
sÿnid
 < (
£rv”
.
dbšum
 - 1)) {

682 
c
->
sÿnid
 ++;

683 
	`ãtchIÁ”ÇlDbById
(
c
, c->
sÿnid
);

684 
	`lockDbR—d
(
c
->
db
);

685 
sÿn_»Œy
;

687 
c
->
sÿnid
 = -1;

690 } ià(
sÿÁy³
 =ğ
SCAN_TYPE_HASH
 ||

691 
sÿÁy³
 =ğ
SCAN_TYPE_SET
 ||

692 
sÿÁy³
 =ğ
SCAN_TYPE_ZSET
) {

693 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

697 
node
 = 
	`dli¡Fœ¡
(
keys
);

698 
node
) {

699 
robj
 *
kobj
 = 
	`dli¡NodeV®ue
(
node
);

700 
ÃxŠode
 = 
	`dli¡NextNode
(
node
);

701 
f‹r
 = 0;

704 ià(!
f‹r
 && 
u£_·‰”n
) {

705 ià(
	`sdsEncodedObjeù
(
kobj
)) {

706 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
kobj
->
±r
, 
	`sd¦’
(kobj->ptr), 0))

707 
f‹r
 = 1;

709 
buf
[
LONG_STR_SIZE
];

710 
Ën
;

712 
	`ASSERT
(
kobj
->
’codšg
 =ğ
OBJ_ENCODING_INT
);

713 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
kobj
->
±r
);

714 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
buf
, 
Ën
, 0)è
f‹r
 = 1;

719 ià(!
f‹r
 && 
o
 =ğ
NULL
 && 
	`checkIfExpœed
(
c
->
db
,
kobj
)) filter = 1;

722 ià(
f‹r
) {

723 
	`ä“Objeù
(
kobj
);

724 
	`dli¡D–Node
(
keys
, 
node
);

730 ià(
o
 && (o->
ty³
 =ğ
OBJ_ZSET
 || o->ty³ =ğ
OBJ_HASH
)) {

731 
node
 = 
ÃxŠode
;

732 
ÃxŠode
 = 
	`dli¡NextNode
(
node
);

733 ià(
f‹r
) {

734 
kobj
 = 
	`dli¡NodeV®ue
(
node
);

735 
	`ä“Objeù
(
kobj
);

736 
	`dli¡D–Node
(
keys
, 
node
);

739 
node
 = 
ÃxŠode
;

743 
	`addR•lyMuÉiBulkL’
(
c
, 2);

744 
	`addR•lyBulkLÚgLÚg
(
c
,
cursÜ
);

746 
	`addR•lyMuÉiBulkL’
(
c
, 
	`dli¡L’gth
(
keys
));

747 (
node
 = 
	`dli¡Fœ¡
(
keys
)è!ğ
NULL
) {

748 
robj
 *
kobj
 = 
	`dli¡NodeV®ue
(
node
);

749 
	`addR•lyBulk
(
c
, 
kobj
);

750 
	`ä“Objeù
(
kobj
);

751 
	`dli¡D–Node
(
keys
, 
node
);

754 
ş—nup
:

755 
	`dli¡S‘F»eM‘hod
(
keys
,
ä“ObjeùVoid
);

756 
	`dli¡R–—£
(
keys
);

757 
	}
}

760 
	$sÿnCommªd
(
ş›Á
 *
c
) {

761 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_KEY
);

762 
	}
}

764 
	$dbsizeCommªd
(
ş›Á
 *
c
) {

765 
idx
;

766 
couÁ
 = 0;

768 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

769 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

770 
	`lockDbR—d
(
c
->
db
);

771 
couÁ
 +ğ
	`diùSize
(
c
->
db
->
diù
);

772 
	`uÆockDb
(
c
->
db
);

775 
	`addR•lyLÚgLÚg
(
c
,
couÁ
);

776 
	}
}

778 
	$Ï¡§veCommªd
(
ş›Á
 *
c
) {

779 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
Ï¡§ve
);

780 
	}
}

782 
	$ty³Commªd
(
ş›Á
 *
c
) {

783 
robj
 *
o
;

784 *
ty³
;

786 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

787 
	`lockDbR—d
(
c
->
db
);

788 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

789 ià(
o
 =ğ
NULL
) {

790 
ty³
 = "none";

791 
	`uÆockDb
(
c
->
db
);

792 
	`addR•lyStus
(
c
,
ty³
);

793 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

796 
o
->
ty³
) {

797 
OBJ_STRING
: 
ty³
 = "string"; ;

798 
OBJ_LIST
: 
ty³
 = "list"; ;

799 
OBJ_SET
: 
ty³
 = "set"; ;

800 
OBJ_ZSET
: 
ty³
 = "zset"; ;

801 
OBJ_HASH
: 
ty³
 = "hash"; ;

802 : 
ty³
 = "unknown"; ;

806 
	`uÆockDb
(
c
->
db
);

807 
	`addR•lyStus
(
c
,
ty³
);

808 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

809 
	}
}

811 
	$shutdownCommªd
(
ş›Á
 *
c
) {

812 
æags
 = 0;

814 ià(
c
->
¬gc
 > 2) {

815 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

817 } ià(
c
->
¬gc
 == 2) {

818 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nosave")) {

819 
æags
 |ğ
SHUTDOWN_NOSAVE
;

820 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"save")) {

821 
æags
 |ğ
SHUTDOWN_SAVE
;

823 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

833 ià(
£rv”
.
lßdšg
)

834 
æags
 = (æag & ~
SHUTDOWN_SAVE
è| 
SHUTDOWN_NOSAVE
;

836 
	`addR•lyE¼Ü
(
c
,"Errorsryingo SHUTDOWN. Check†ogs.");

837 
	}
}

839 
	$»ÇmeG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

840 
robj
 *
o
;

841 
expœe
;

842 
§mekey
 = 0;

846 ià(
	`sdscmp
(
c
->
¬gv
[1]->
±r
,c->¬gv[2]->±rè=ğ0è
§mekey
 = 1;

848 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
,
NULL
)) == NULL)

851 ià(
§mekey
) {

852 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
ok
);

856 
	`šüRefCouÁ
(
o
);

857 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

858 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
) != NULL) {

859 ià(
nx
) {

860 
	`deüRefCouÁ
(
o
);

861 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

866 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[2]);

868 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
o
);

869 ià(
expœe
 !ğ-1è
	`£tExpœe
(
c
->
db
,c->
¬gv
[2],expire);

870 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

871 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

872 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

873 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_from",

874 
c
->
¬gv
[1],c->
db
->
id
);

875 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_to",

876 
c
->
¬gv
[2],c->
db
->
id
);

877 
£rv”
.
dœty
++;

878 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

879 
	}
}

881 
	$»ÇmeCommªd
(
ş›Á
 *
c
) {

882 
	`»ÇmeG’”icCommªd
(
c
,0);

883 
	}
}

885 
	$»Çm’xCommªd
(
ş›Á
 *
c
) {

886 
	`»ÇmeG’”icCommªd
(
c
,1);

887 
	}
}

889 
	$moveCommªd
(
ş›Á
 *
c
) {

890 
robj
 *
o
;

891 
»disDb
 *
¤c
, *
d¡
;

892 
¤cid
;

893 
dbid
, 
expœe
;

896 
¤c
 = 
c
->
db
;

897 
¤cid
 = 
c
->
db
->
id
;

899 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[2],&
dbid
è=ğ
VR_ERROR
 ||

900 
dbid
 < 
INT_MIN
 || dbid > 
INT_MAX
 ||

901 
	`£ËùDb
(
c
,
dbid
è=ğ
VR_ERROR
)

903 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

906 
d¡
 = 
c
->
db
;

907 
	`£ËùDb
(
c
,
¤cid
);

911 ià(
¤c
 =ğ
d¡
) {

912 
	`addR•ly
(
c
,
sh¬ed
.
§meobjeù”r
);

917 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
NULL
);

918 ià(!
o
) {

919 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

922 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

925 ià(
	`lookupKeyWr™e
(
d¡
,
c
->
¬gv
[1],
NULL
) != NULL) {

926 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

929 
	`dbAdd
(
d¡
,
c
->
¬gv
[1],
o
);

930 ià(
expœe
 !ğ-1è
	`£tExpœe
(
d¡
,
c
->
¬gv
[1],expire);

931 
	`šüRefCouÁ
(
o
);

934 
	`dbD–‘e
(
¤c
,
c
->
¬gv
[1]);

935 
£rv”
.
dœty
++;

936 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

937 
	}
}

943 
	$»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

946 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

947  
	`diùD–‘e
(
db
->
expœes
,
key
->
±r
è=ğ
DICT_OK
;

948 
	}
}

950 
	$£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
) {

951 
diùEÁry
 *
kde
, *
de
;

954 
kde
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

955 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
kde
 != NULL);

956 
de
 = 
	`diùR•ÏûRaw
(
db
->
expœes
,
	`diùG‘Key
(
kde
));

957 
	`diùS‘SigÃdIÁeg”V®
(
de
,
wh’
);

958 
	}
}

962 
	$g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
) {

963 
diùEÁry
 *
de
;

966 ià(
	`diùSize
(
db
->
expœes
) == 0 ||

967 (
de
 = 
	`diùFšd
(
db
->
expœes
,
key
->
±r
)è=ğ
NULL
)  -1;

971 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

972  
	`diùG‘SigÃdIÁeg”V®
(
de
);

973 
	}
}

983 
	$´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

984 
robj
 *
¬gv
[2];

986 
¬gv
[0] = 
sh¬ed
.
d–
;

987 
¬gv
[1] = 
key
;

988 
	`šüRefCouÁ
(
¬gv
[0]);

989 
	`šüRefCouÁ
(
¬gv
[1]);

991 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
)

992 
	`ãedAµ’dOÆyFe
(
£rv”
.
d–Commªd
,
db
->
id
,
¬gv
,2);

993 
	`»¶iÿtiÚF“dSÏves
(
»¶
.
¦aves
,
db
->
id
,
¬gv
,2);

995 
	`deüRefCouÁ
(
¬gv
[0]);

996 
	`deüRefCouÁ
(
¬gv
[1]);

997 
	}
}

1000 
	$checkIfExpœed
(
»disDb
 *
db
, 
robj
 *
key
) {

1001 
wh’
;

1003 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

1004 ià(
wh’
 > 0 && 
	`vr_m£c_now
() > when) {

1009 
	}
}

1011 
	$expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
) {

1012 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

1013 
now
;

1015 ià(
wh’
 < 0)  0;

1018 ià(
£rv”
.
lßdšg
)  0;

1025 
now
 = 
£rv”
.
lua_ÿÎ”
 ? s”v”.
lua_time_¡¬t
 : 
	`vr_m£c_now
();

1034 ià(
»¶
.
ma¡”ho¡
 !ğ
NULL
è 
now
 > 
wh’
;

1037 ià(
now
 <ğ
wh’
)  0;

1041 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EXPIRED
,

1042 "expœed",
key
,
db
->
id
);

1043  
	`dbD–‘e
(
db
,
key
);

1044 
	}
}

1057 
	$expœeG’”icCommªd
(
ş›Á
 *
c
, 
ba£time
, 
un™
) {

1058 
robj
 *
key
 = 
c
->
¬gv
[1], *
·¿m
 = c->argv[2];

1059 
wh’
;

1060 
expœed
 = 0;

1062 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
·¿m
, &
wh’
, 
NULL
è!ğ
VR_OK
)

1065 ià(
un™
 =ğ
UNIT_SECONDS
è
wh’
 *= 1000;

1066 
wh’
 +ğ
ba£time
;

1068 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1069 
	`lockDbWr™e
(
c
->
db
);

1071 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
,&
expœed
è=ğ
NULL
) {

1072 
	`uÆockDb
(
c
->
db
);

1073 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1074 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1084 ià(
wh’
 <ğ
	`vr_m£c_now
(è&& !
£rv”
.
lßdšg
 && !
»¶
.
ma¡”ho¡
) {

1085 
robj
 *
aux
;

1087 
	`£rv”As£¹W™hInfo
(
c
,
key
,
	`dbD–‘e
(c->
db
,key));

1088 
c
->
v–
->
dœty
++;

1091 
aux
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
key
);

1092 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
sh¬ed
.
d–
,
aux
);

1093 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1094 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1095 
	`uÆockDb
(
c
->
db
);

1096 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1097 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

1100 
	`£tExpœe
(
c
->
db
,
key
,
wh’
);

1101 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1102 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1103 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"expœe",
key
,
c
->
db
->
id
);

1104 
	`uÆockDb
(
c
->
db
);

1105 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1106 
c
->
v–
->
dœty
++;

1109 
	}
}

1111 
	$expœeCommªd
(
ş›Á
 *
c
) {

1112 
	`expœeG’”icCommªd
(
c
,
	`vr_m£c_now
(),
UNIT_SECONDS
);

1113 
	}
}

1115 
	$expœ—tCommªd
(
ş›Á
 *
c
) {

1116 
	`expœeG’”icCommªd
(
c
,0,
UNIT_SECONDS
);

1117 
	}
}

1119 
	$³xpœeCommªd
(
ş›Á
 *
c
) {

1120 
	`expœeG’”icCommªd
(
c
,
	`vr_m£c_now
(),
UNIT_MILLISECONDS
);

1121 
	}
}

1123 
	$³xpœ—tCommªd
(
ş›Á
 *
c
) {

1124 
	`expœeG’”icCommªd
(
c
,0,
UNIT_MILLISECONDS
);

1125 
	}
}

1127 
	$‰lG’”icCommªd
(
ş›Á
 *
c
, 
ouut_ms
) {

1128 
expœe
, 
‰l
 = -1;

1130 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

1131 
	`lockDbR—d
(
c
->
db
);

1133 ià(
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]è=ğ
NULL
) {

1134 
	`uÆockDb
(
c
->
db
);

1135 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

1136 
	`addR•lyLÚgLÚg
(
c
,-2);

1141 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

1142 
	`uÆockDb
(
c
->
db
);

1143 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

1145 ià(
expœe
 != -1) {

1146 
‰l
 = 
expœe
-
	`vr_m£c_now
();

1147 ià(
‰l
 < 0)tl = 0;

1149 ià(
‰l
 == -1) {

1150 
	`addR•lyLÚgLÚg
(
c
,-1);

1152 
	`addR•lyLÚgLÚg
(
c
,
ouut_ms
 ? 
‰l
 : ((ttl+500)/1000));

1154 
	}
}

1156 
	$‰lCommªd
(
ş›Á
 *
c
) {

1157 
	`‰lG’”icCommªd
(
c
, 0);

1158 
	}
}

1160 
	$±Commªd
(
ş›Á
 *
c
) {

1161 
	`‰lG’”icCommªd
(
c
, 1);

1162 
	}
}

1164 
	$³rsi¡Commªd
(
ş›Á
 *
c
) {

1165 
diùEÁry
 *
de
;

1167 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

1168 
	`lockDbWr™e
(
c
->
db
);

1169 
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[1]->
±r
);

1170 ià(
de
 =ğ
NULL
) {

1171 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1173 ià(
	`»moveExpœe
(
c
->
db
,c->
¬gv
[1])) {

1174 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1175 
c
->
v–
->
dœty
++;

1177 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1180 
	`uÆockDb
(
c
->
db
);

1181 
	}
}

1189 *
	$g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1190 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

1191 
	`UNUSED
(
¬gv
);

1193 ià(
cmd
->
fœ¡key
 == 0) {

1194 *
numkeys
 = 0;

1195  
NULL
;

1197 
Ï¡
 = 
cmd
->
Ï¡key
;

1198 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

1199 
keys
 = 
	`d®loc
(()*((
Ï¡
 - 
cmd
->
fœ¡key
)+1));

1200 
j
 = 
cmd
->
fœ¡key
; j <ğ
Ï¡
; j +ğcmd->
key¡•
) {

1201 
	`ASSERT
(
j
 < 
¬gc
);

1202 
keys
[
i
++] = 
j
;

1204 *
numkeys
 = 
i
;

1205  
keys
;

1206 
	}
}

1219 *
	$g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1220 ià(
cmd
->
g‘keys_´oc
) {

1221  
cmd
->
	`g‘keys_´oc
(cmd,
¬gv
,
¬gc
,
numkeys
);

1223  
	`g‘KeysUsšgCommªdTabË
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1225 
	}
}

1228 
	$g‘KeysF»eResuÉ
(*
»suÉ
) {

1229 
	`dä“
(
»suÉ
);

1230 
	}
}

1235 *
	$zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1236 
i
, 
num
, *
keys
;

1237 
	`UNUSED
(
cmd
);

1239 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1242 ià(
num
 > (
¬gc
-3)) {

1243 *
numkeys
 = 0;

1244  
NULL
;

1250 
keys
 = 
	`d®loc
(()*(
num
+1));

1253 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1256 
keys
[
num
] = 1;

1257 *
numkeys
 = 
num
+1;

1258  
keys
;

1259 
	}
}

1264 *
	$ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1265 
i
, 
num
, *
keys
;

1266 
	`UNUSED
(
cmd
);

1268 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1271 ià(
num
 > (
¬gc
-3)) {

1272 *
numkeys
 = 0;

1273  
NULL
;

1276 
keys
 = 
	`d®loc
(()*
num
);

1277 *
numkeys
 = 
num
;

1280 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1282  
keys
;

1283 
	}
}

1292 *
	$sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1293 
i
, 
j
, 
num
, *
keys
, 
found_¡Üe
 = 0;

1294 
	`UNUSED
(
cmd
);

1296 
num
 = 0;

1297 
keys
 = 
	`d®loc
(()*2);

1299 
keys
[
num
++] = 1;

1306 *
Çme
;

1307 
sk
;

1308 } 
skli¡
[] = {

1312 {
NULL
, 0}

1315 
i
 = 2; i < 
¬gc
; i++) {

1316 
j
 = 0; 
skli¡
[j].
Çme
 !ğ
NULL
; j++) {

1317 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,
skli¡
[
j
].
Çme
)) {

1318 
i
 +ğ
skli¡
[
j
].
sk
;

1320 } ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"¡Üe"è&& i+1 < 
¬gc
) {

1324 
found_¡Üe
 = 1;

1325 
keys
[
num
] = 
i
+1;

1330 *
numkeys
 = 
num
 + 
found_¡Üe
;

1331  
keys
;

1332 
	}
}

1334 *
	$mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1335 
i
, 
num
, 
fœ¡
, *
keys
;

1336 
	`UNUSED
(
cmd
);

1339 
fœ¡
 = 3;

1340 
num
 = 1;

1343 ià(
¬gc
 > 6) {

1344 
i
 = 6; i < 
¬gc
; i++) {

1345 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"keys") &&

1346 
	`sd¦’
(
¬gv
[3]->
±r
) == 0)

1348 
fœ¡
 = 
i
+1;

1349 
num
 = 
¬gc
-
fœ¡
;

1355 
keys
 = 
	`d®loc
(()*
num
);

1356 
i
 = 0; i < 
num
; i++è
keys
[i] = 
fœ¡
+i;

1357 *
numkeys
 = 
num
;

1358  
keys
;

1359 
	}
}

1361 
	$ãtchIÁ”ÇlDbByKey
(
ş›Á
 *
c
, 
robj
 *
key
) {

1362 
c
->
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
	`hash_üc16
(
key
->
±r
,
	`¡ršgObjeùL’
(key))&0x3FFF)%£rv”.
dbšum
+c->
diùid
*server.dbinum);

1363  
VR_OK
;

1364 
	}
}

1366 
	$ãtchIÁ”ÇlDbById
(
ş›Á
 *
c
, 
idx
) {

1367 
c
->
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
idx
+c->
diùid
*£rv”.
dbšum
);

1368  
VR_OK
;

1369 
	}
}

1373 
	$ŒyResizeHashTabËsFÜDb
(
dbid
) {

1374 
»disDb
 *
db
;

1376 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
dbid
);

1377 
	`lockDbWr™e
(
db
);

1378 ià(
	`htN“dsResize
(
db
->
diù
))

1379 
	`diùResize
(
db
->
diù
);

1380 ià(
	`htN“dsResize
(
db
->
expœes
))

1381 
	`diùResize
(
db
->
expœes
);

1382 
	`uÆockDb
(
db
);

1383 
	}
}

1392 
	$šüem’ÎyRehashFÜDb
(
dbid
) {

1393 
»disDb
 *
db
;

1395 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
dbid
);

1396 
	`lockDbWr™e
(
db
);

1399 ià(
	`diùIsRehashšg
(
db
->
diù
)) {

1400 
	`diùRehashMli£cÚds
(
db
->
diù
,1);

1401 
	`uÆockDb
(
db
);

1405 ià(
	`diùIsRehashšg
(
db
->
expœes
)) {

1406 
	`diùRehashMli£cÚds
(
db
->
expœes
,1);

1407 
	`uÆockDb
(
db
);

1411 
	`uÆockDb
(
db
);

1413 
	}
}

1437 
	$aùiveExpœeCyşe
(
vr_back’d
 *
back’d
, 
ty³
) {

1438 
j
, 
™”©iÚ
 = 0;

1439 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

1440 
¡¬t
 = 
	`vr_u£c_now
(), 
tim–im™
;

1441 
expœed_tÙ®
 = 0;

1443 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
) {

1447 ià(!
back’d
->
tim–im™_ex™
) ;

1448 ià(
¡¬t
 < 
back’d
->
Ï¡_ç¡_cyşe
 + 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
*2) ;

1449 
back’d
->
Ï¡_ç¡_cyşe
 = 
¡¬t
;

1459 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
 || 
back’d
->
tim–im™_ex™
)

1460 
dbs_³r_ÿÎ
 = 
£rv”
.
dbnum
;

1466 
tim–im™
 = 1000000*
ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
/
£rv”
.
hz
/100;

1467 
back’d
->
tim–im™_ex™
 = 0;

1468 ià(
tim–im™
 <= 0)imelimit = 1;

1470 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
)

1471 
tim–im™
 = 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
;

1473 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1474 
expœed
;

1475 
»disDb
 *
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
back’d
->
cu¼’t_db
%£rv”.
dbnum
);

1480 
back’d
->
cu¼’t_db
++;

1482 
	`lockDbWr™e
(
db
);

1486 
num
, 
¦Ùs
;

1487 
now
, 
‰l_sum
;

1488 
‰l_§m¶es
;

1490 ià((
num
 = 
	`diùSize
(
db
->
expœes
)) == 0) {

1491 
db
->
avg_‰l
 = 0;

1494 
¦Ùs
 = 
	`diùSlÙs
(
db
->
expœes
);

1495 
now
 = 
	`vr_m£c_now
();

1500 ià(
num
 && 
¦Ùs
 > 
DICT_HT_INITIAL_SIZE
 &&

1501 (
num
*100/
¦Ùs
 < 1)) ;

1505 
expœed
 = 0;

1506 
‰l_sum
 = 0;

1507 
‰l_§m¶es
 = 0;

1509 ià(
num
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
)

1510 
num
 = 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
;

1512 
num
--) {

1513 
diùEÁry
 *
de
;

1514 
‰l
;

1516 ià((
de
 = 
	`diùG‘RªdomKey
(
db
->
expœes
)è=ğ
NULL
) ;

1517 
‰l
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
)-
now
;

1518 ià(
	`aùiveExpœeCyşeTryExpœe
(
db
,
de
,
now
)è
expœed
++;

1519 ià(
‰l
 > 0) {

1521 
‰l_sum
 +ğ
‰l
;

1522 
‰l_§m¶es
++;

1526 
expœed_tÙ®
 +ğ
expœed
;

1529 ià(
‰l_§m¶es
) {

1530 
avg_‰l
 = 
‰l_sum
/
‰l_§m¶es
;

1535 ià(
db
->
avg_‰l
 == 0) db->avg_ttl =‡vg_ttl;

1536 
db
->
avg_‰l
 = (db->avg_ttl/50)*49 + (avg_ttl/50);

1542 
™”©iÚ
++;

1543 ià((
™”©iÚ
 & 0xf) == 0) {

1544 
–­£d
 = 
	`vr_u£c_now
()-
¡¬t
;

1547 ià(
–­£d
 > 
tim–im™
è
back’d
->
tim–im™_ex™
 = 1;

1549 ià(
back’d
->
tim–im™_ex™
) {

1550 
	`uÆockDb
(
db
);

1552 ià(
expœed_tÙ®
 > 0) {

1553 
	`upd©e_¡©s_add
(
back’d
->
v–
.
¡©s
, 
expœedkeys
, 
expœed_tÙ®
);

1559 } 
expœed
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
/4);

1560 
	`uÆockDb
(
db
);

1563 ià(
expœed_tÙ®
 > 0) {

1564 
	`upd©e_¡©s_add
(
back’d
->
v–
.
¡©s
, 
expœedkeys
, 
expœed_tÙ®
);

1566 
	}
}

1568 
	$aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
) {

1569 
t
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
);

1570 ià(
now
 > 
t
) {

1571 
sds
 
key
 = 
	`diùG‘Key
(
de
);

1572 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

1573 
	`dbD–‘e
(
db
,
keyobj
);

1574 
	`ä“Objeù
(
keyobj
);

1579 
	}
}

1584 
	$d©aba£sCrÚ
(
vr_back’d
 *
back’d
) {

1587 ià(
»¶
.
ma¡”ho¡
 =ğ
NULL
)

1588 
	`aùiveExpœeCyşe
(
back’d
, 
ACTIVE_EXPIRE_CYCLE_SLOW
);

1593 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

1594 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

1595 
j
;

1598 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
) dbs_per_call = server.dbnum;

1601 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1602 
	`ŒyResizeHashTabËsFÜDb
(
back’d
->
»size_db
%
£rv”
.
dbnum
);

1603 
back’d
->
»size_db
++;

1607 ià(
£rv”
.
aùiv”ehashšg
) {

1608 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1609 
wÜk_dÚe
 = 
	`šüem’ÎyRehashFÜDb
(
back’d
->
»hash_db
%
£rv”
.
dbnum
);

1610 
back’d
->
»hash_db
++;

1611 ià(
wÜk_dÚe
) {

1619 
	}
}

	@src/vr_db.c

1 
	~<sigÇl.h
>

2 
	~<ùy³.h
>

4 
	~<vr_cÜe.h
>

7 
diùTy³
 
	gdbDiùTy³
 = {

8 
diùSdsHash
,

9 
NULL
,

10 
NULL
,

11 
diùSdsKeyCom·»
,

12 
diùSdsDe¡ruùÜ
,

13 
diùObjeùDe¡ruùÜ


17 
diùTy³
 
	gkey±rDiùTy³
 = {

18 
diùSdsHash
,

19 
NULL
,

20 
NULL
,

21 
diùSdsKeyCom·»
,

22 
NULL
,

23 
NULL


29 
diùTy³
 
	gkeyli¡DiùTy³
 = {

30 
diùObjHash
,

31 
NULL
,

32 
NULL
,

33 
diùObjKeyCom·»
,

34 
diùObjeùDe¡ruùÜ
,

35 
diùLi¡De¡ruùÜ


39 
eviùiÚPoŞEÁry
 *
	$eviùiÚPoŞAÎoc
() {

40 
eviùiÚPoŞEÁry
 *
•
;

41 
j
;

43 
•
 = 
	`d®loc
((*•)*
MAXMEMORY_EVICTION_POOL_SIZE
);

44 
j
 = 0; j < 
MAXMEMORY_EVICTION_POOL_SIZE
; j++) {

45 
•
[
j
].
idË
 = 0;

46 
•
[
j
].
key
 = 
NULL
;

48  
•
;

49 
	}
}

55 
	$»disDbIn™
(
»disDb
 *
db
)

57 
db
->
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

58 
db
->
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

59 
db
->
blockšg_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

60 
db
->
»ady_keys
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

61 
db
->
w©ched_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

62 
db
->
eviùiÚ_poŞ
 = 
	`eviùiÚPoŞAÎoc
();

63 
db
->
avg_‰l
 = 0;

65 
	`±h»ad_rwlock_š™
(&
db
->
rwl
, 
NULL
);

67  
VR_OK
;

68 
	}
}

71 
	$»disDbDeš™
(
»disDb
 *
db
)

73 
	`±h»ad_rwlock_de¡roy
(&
db
->
rwl
);

74  
VR_OK
;

75 
	}
}

78 
	$lockDbR—d
(
»disDb
 *
db
)

80 
	`±h»ad_rwlock_rdlock
(&
db
->
rwl
);

81  
VR_OK
;

82 
	}
}

85 
	$lockDbWr™e
(
»disDb
 *
db
)

87 
	`±h»ad_rwlock_w¾ock
(&
db
->
rwl
);

88  
VR_OK
;

89 
	}
}

92 
	$uÆockDb
(
»disDb
 *
db
)

94 
	`±h»ad_rwlock_uÆock
(&
db
->
rwl
);

95  
VR_OK
;

96 
	}
}

98 
robj
 *
	$lookupKey
(
»disDb
 *
db
, 
robj
 *
key
) {

99 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

100 ià(
de
) {

101 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

106 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1)

108 
v®
->
Ìu
 = 0;

109  
v®
;

111  
NULL
;

113 
	}
}

115 
robj
 *
	$lookupKeyR—d
(
»disDb
 *
db
, 
robj
 *
key
) {

116 ià(
	`checkIfExpœed
(
db
, 
key
)è 
NULL
;

117  
	`lookupKey
(
db
,
key
);

118 
	}
}

120 
robj
 *
	$lookupKeyWr™e
(
»disDb
 *
db
, 
robj
 *
key
, *
expœed
) {

121 ià(
expœed
è*expœed = 
	`expœeIfN“ded
(
db
,
key
);

122  
	`lookupKey
(
db
,
key
);

123 
	}
}

125 
robj
 *
	$lookupKeyR—dOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

126 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
, 
key
);

127 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

128  
o
;

129 
	}
}

131 
robj
 *
	$lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
, *
expœed
) {

132 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
, 
key
, 
expœed
);

133 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

134  
o
;

135 
	}
}

142 
	$dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

143 
sds
 
cİy
 = 
	`sdsdup
(
key
->
±r
);

144 
»tv®
 = 
	`diùAdd
(
db
->
diù
, 
cİy
, 
v®
);

145 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
»tv®
 =ğ
DICT_OK
);

146 ià(
v®
->
ty³
 =ğ
OBJ_LIST
è
	`sigÇlLi¡AsR—dy
(
db
, 
key
);

147 
	}
}

155 
	$dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

156 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

158 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
de
 != NULL);

159 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

160 
	}
}

168 
	$£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
, *
expœed
) {

169 ià(
	`lookupKeyWr™e
(
db
,
key
,
expœed
è=ğ
NULL
) {

170 
	`dbAdd
(
db
,
key
,
v®
);

172 
	`dbOv”wr™e
(
db
,
key
,
v®
);

175 
	`»moveExpœe
(
db
,
key
);

176 
	}
}

178 
	$dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
) {

179  
	`diùFšd
(
db
->
diù
,
key
->
±r
è!ğ
NULL
;

180 
	}
}

186 
robj
 *
	$dbRªdomKey
(
»disDb
 *
db
) {

187 
diùEÁry
 *
de
;

190 
sds
 
key
;

191 
robj
 *
keyobj
;

193 
	`lockDbR—d
(
db
);

194 
de
 = 
	`diùG‘RªdomKey
(
db
->
diù
);

195 ià(
de
 =ğ
NULL
) {

196 
	`uÆockDb
(
db
);

197  
NULL
;

200 
key
 = 
	`diùG‘Key
(
de
);

201 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

202 ià(
	`diùFšd
(
db
->
expœes
,
key
)) {

203 ià(
	`checkIfExpœed
(
db
,
keyobj
)) {

204 
	`uÆockDb
(
db
);

205 
	`ä“Objeù
(
keyobj
);

209 
	`uÆockDb
(
db
);

210  
keyobj
;

212 
	}
}

215 
	$dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

218 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

219 ià(
	`diùD–‘e
(
db
->
diù
,
key
->
±r
è=ğ
DICT_OK
) {

224 
	}
}

226 
robj
 *
	$dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
o
) {

227 
	`ASSERT
(
o
->
ty³
 =ğ
OBJ_STRING
);

228 ià(
o
->
cÚ¡ªt
 || o->
’codšg
 !ğ
OBJ_ENCODING_RAW
) {

229 
robj
 *
decoded
, *
Ãw
;

230 
decoded
 = 
	`g‘DecodedObjeù
(
o
);

231 
Ãw
 = 
	`ü—‹RawSŒšgObjeù
(
decoded
->
±r
, 
	`sd¦’
(decoded->ptr));

232 ià(
decoded
 !ğ
o
è
	`ä“Objeù
(decoded);

233 
	`dbOv”wr™e
(
db
,
key
,
Ãw
);

234  
Ãw
;

236  
o
;

237 
	}
}

239 
em±yDb
((
ÿÎback
)(*)) {

240 
j
;

241 
»moved
 = 0;

242 
»disDb
 *
db
;

244 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

245 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)
j
);

246 
»moved
 +ğ
	`diùSize
(
db
->
diù
);

247 
	`diùEm±y
(
db
->
diù
,
ÿÎback
);

248 
	`diùEm±y
(
db
->
expœes
,
ÿÎback
);

251  
»moved
;

252 
	}
}

254 
	$£ËùDb
(
ş›Á
 *
c
, 
id
) {

255 
»disDb
 *
db
;

257 ià(
id
 < 0 || id >ğ
£rv”
.
dbÊum
)

258  
VR_ERROR
;

260 
c
->
diùid
 = 
id
;

261  
VR_OK
;

262 
	}
}

273 
	$sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
) {

274 
	`touchW©chedKey
(
db
,
key
);

275 
	}
}

277 
	$sigÇlFlushedDb
(
dbid
) {

278 
	`touchW©chedKeysOnFlush
(
dbid
);

279 
	}
}

285 
	$æushdbCommªd
(
ş›Á
 *
c
) {

286 
idx
;

288 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

289 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

290 
	`lockDbWr™e
(
c
->
db
);

291 
c
->
v–
->
dœty
 +ğ
	`diùSize
(c->
db
->
diù
);

292 
	`sigÇlFlushedDb
(
c
->
db
->
id
);

293 
	`diùEm±y
(
c
->
db
->
diù
,
NULL
);

294 
	`diùEm±y
(
c
->
db
->
expœes
,
NULL
);

295 
	`uÆockDb
(
c
->
db
);

298 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

299 
	}
}

301 
	$æush®lCommªd
(
ş›Á
 *
c
) {

302 
idx
;

303 
»disDb
 *
db
;

305 
idx
 = 0; idx < 
£rv”
.
dbnum
; idx ++) {

306 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)
idx
);

307 
	`lockDbWr™e
(
db
);

308 
	`diùEm±y
(
db
->
diù
,
NULL
);

309 
	`diùEm±y
(
db
->
expœes
,
NULL
);

310 
	`uÆockDb
(
db
);

313 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

314 
	}
}

316 
	$d–Commªd
(
ş›Á
 *
c
) {

317 
d–‘ed
 = 0, 
j
;

318 
expœed
 = 0;

320 
j
 = 1; j < 
c
->
¬gc
; j++) {

321 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[
j
]);

322 
	`lockDbWr™e
(
c
->
db
);

323 
expœed
 +ğ
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

324 ià(
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
])) {

325 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

326 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

327 "d–",
c
->
¬gv
[
j
],c->
db
->
id
);

328 
c
->
v–
->
dœty
++;

329 
d–‘ed
++;

331 
	`uÆockDb
(
c
->
db
);

333 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

335 ià(
expœed
 > 0) {

336 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 
expœed
);

338 
	}
}

342 
	$exi¡sCommªd
(
ş›Á
 *
c
) {

343 
couÁ
 = 0;

344 
j
;

346 
j
 = 1; j < 
c
->
¬gc
; j++) {

347 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

348 
	`lockDbR—d
(
c
->
db
);

349 ià(
	`checkIfExpœed
(
c
->
db
,c->
¬gv
[
j
])) {

350 
	`uÆockDb
(
c
->
db
);

353 ià(
	`dbExi¡s
(
c
->
db
,c->
¬gv
[
j
])è
couÁ
++;

354 
	`uÆockDb
(
c
->
db
);

356 
	`addR•lyLÚgLÚg
(
c
,
couÁ
);

358 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 
couÁ
);

359 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, c->
¬gc
-1-
couÁ
);

360 
	}
}

362 
	$£ËùCommªd
(
ş›Á
 *
c
) {

363 
id
;

365 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[1], &
id
,

366 "šv®id DB index"è!ğ
VR_OK
)

369 ià(
	`£ËùDb
(
c
,
id
è=ğ
VR_ERROR
) {

370 
	`addR•lyE¼Ü
(
c
,"invalid DB index");

372 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

374 
	}
}

376 
	$¿ndomkeyCommªd
(
ş›Á
 *
c
) {

377 
robj
 *
key
;

378 
idx
, 
»Œy_couÁ
 = 0;

380 
idx
 = 
	`¿ndom
()%
£rv”
.
dbšum
;

382 
»Œy
:

383 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

384 ià((
key
 = 
	`dbRªdomKey
(
c
->
db
)è=ğ
NULL
) {

385 ià(
»Œy_couÁ
++ < 
£rv”
.
dbšum
) {

386 ià(++
idx
 >ğ
£rv”
.
dbšum
) {

387 
idx
 = 0;

389 
»Œy
;

392 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

396 
	`addR•lyBulk
(
c
,
key
);

397 
	`ä“Objeù
(
key
);

398 
	}
}

400 
	$keysCommªd
(
ş›Á
 *
c
) {

401 
diùI‹¿tÜ
 *
di
;

402 
diùEÁry
 *
de
;

403 
sds
 
·‰”n
 = 
c
->
¬gv
[1]->
±r
;

404 
¶’
 = 
	`sd¦’
(
·‰”n
), 
®lkeys
;

405 
numkeys
 = 0;

406 *
»¶yËn
;

407 
idx
;

408 
keys_couÁ
 = 0;

409 
expœed
 = 0;

410 
max_time_com¶ex™y_lim™
;

413 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

414 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

415 
	`lockDbWr™e
(
c
->
db
);

416 
keys_couÁ
 +ğ
	`diùSize
(
c
->
db
->
diù
);

417 
	`uÆockDb
(
c
->
db
);

420 
max_time_com¶ex™y_lim™
 = 
c
->
v–
->
cc
.max_time_complexity_limit;

421 ià(
max_time_com¶ex™y_lim™
 &&

422 
keys_couÁ
 > 
max_time_com¶ex™y_lim™
) {

423 
	`addR•ly
(
c
,
sh¬ed
.
outofcom¶ex™ylim™
);

427 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

428 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

429 
	`ãtchIÁ”ÇlDbById
(
c
,
idx
);

430 
	`lockDbWr™e
(
c
->
db
);

431 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
db
->
diù
);

432 
®lkeys
 = (
·‰”n
[0] == '*' &&…attern[1] == '\0');

433 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

434 
sds
 
key
 = 
	`diùG‘Key
(
de
);

435 
robj
 *
keyobj
;

437 ià(
®lkeys
 || 
	`¡ršgm©chËn
(
·‰”n
,
¶’
,
key
,
	`sd¦’
(key),0)) {

438 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

439 ià(
	`expœeIfN“ded
(
c
->
db
,
keyobj
) == 0) {

440 
	`addR•lyBulk
(
c
,
keyobj
);

441 
numkeys
++;

443 
expœed
 ++;

445 
	`ä“Objeù
(
keyobj
);

448 
	`diùR–—£I‹¿tÜ
(
di
);

449 
	`uÆockDb
(
c
->
db
);

451 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
numkeys
);

452 
	}
}

456 
	$sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
) {

457 **
pd
 = (**è
´ivd©a
;

458 
dli¡
 *
keys
 = 
pd
[0];

459 
robj
 *
o
 = 
pd
[1];

460 
robj
 *
key
, *
v®
 = 
NULL
;

462 ià(
o
 =ğ
NULL
) {

463 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

464 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
, 
	`sd¦’
(sdskey));

465 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

466 
key
 = 
	`diùG‘Key
(
de
);

467 
key
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(key);

468 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

469 
key
 = 
	`diùG‘Key
(
de
);

470 
key
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(key);

471 
v®
 = 
	`diùG‘V®
(
de
);

472 
v®
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(val);

473 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

474 
key
 = 
	`diùG‘Key
(
de
);

475 
key
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(key);

476 
v®
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(*(*)
	`diùG‘V®
(
de
),0);

478 
	`£rv”Pªic
("Type‚ot handled in SCAN callback.");

481 
	`dli¡AddNodeTa
(
keys
, 
key
);

482 ià(
v®
è
	`dli¡AddNodeTa
(
keys
, val);

483 
	}
}

489 
	$·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
) {

490 *
•Œ
;

494 
”ºo
 = 0;

495 *
cursÜ
 = 
	`¡¹oul
(
o
->
±r
, &
•Œ
, 10);

496 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
)

498 
	`addR•lyE¼Ü
(
c
, "invalid cursor");

499  
VR_ERROR
;

501  
VR_OK
;

502 
	}
}

515 
	$sÿnG’”icCommªd
(
ş›Á
 *
c
, 
sÿÁy³
) {

516 
i
, 
j
;

517 
dli¡
 *
keys
 = 
	`dli¡C»©e
();

518 
dli¡Node
 *
node
, *
ÃxŠode
;

519 
couÁ
 = 10;

520 
sds
 
·t
 = 
NULL
;

521 
·’
 = 0, 
u£_·‰”n
 = 0;

522 
cursÜ
;

523 
robj
 *
o
;

524 
diù
 *
ht
;

527 
i
 = (
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) ? 2 : 3;

528 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[
i
-1],&
cursÜ
è=ğ
VR_ERROR
) ;

531 
i
 < 
c
->
¬gc
) {

532 
j
 = 
c
->
¬gc
 - 
i
;

533 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "couÁ"è&& 
j
 >= 2) {

534 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
i
+1], &
couÁ
, 
NULL
)

535 !ğ
VR_OK
)

537 
ş—nup
;

540 ià(
couÁ
 < 1) {

541 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

542 
ş—nup
;

545 
i
 += 2;

546 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "m©ch"è&& 
j
 >= 2) {

547 
·t
 = 
c
->
¬gv
[
i
+1]->
±r
;

548 
·’
 = 
	`sd¦’
(
·t
);

552 
u£_·‰”n
 = !(
·t
[0] =ğ'*' && 
·’
 == 1);

554 
i
 += 2;

556 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

557 
ş—nup
;

561 ià(
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) {

562 
o
 = 
NULL
;

563 ià(
c
->
sÿnid
 =ğ-1 || 
cursÜ
 == 0) c->scanid = 0;

564 
	`ãtchIÁ”ÇlDbById
(
c
, c->
sÿnid
);

565 
	`lockDbR—d
(
c
->
db
);

566 } ià(
sÿÁy³
 =ğ
SCAN_TYPE_HASH
 ||

567 
sÿÁy³
 =ğ
SCAN_TYPE_SET
 ||

568 
sÿÁy³
 =ğ
SCAN_TYPE_ZSET
) {

569 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

570 
	`lockDbR—d
(
c
->
db
);

571 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
) {

572 
	`uÆockDb
(
c
->
db
);

573 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

578 
sÿÁy³
) {

579 
SCAN_TYPE_KEY
:

580 
	`ASSERT
(
o
 =ğ
NULL
);

582 
SCAN_TYPE_HASH
:

583 ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

584 
	`uÆockDb
(
c
->
db
);

585 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

589 
SCAN_TYPE_SET
:

590 ià(
	`checkTy³
(
c
,
o
,
OBJ_SET
)) {

591 
	`uÆockDb
(
c
->
db
);

592 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

596 
SCAN_TYPE_ZSET
:

597 ià(
	`checkTy³
(
c
,
o
,
OBJ_ZSET
)) {

598 
	`uÆockDb
(
c
->
db
);

599 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

607 
	`ASSERT
(
o
 =ğ
NULL
 || o->
ty³
 =ğ
OBJ_SET
 || o->ty³ =ğ
OBJ_HASH
 ||

608 
o
->
ty³
 =ğ
OBJ_ZSET
);

610 
sÿn_»Œy
:

621 
ht
 = 
NULL
;

622 ià(
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) {

623 
ht
 = 
c
->
db
->
diù
;

624 } ià(
o
->
ty³
 =ğ
OBJ_SET
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

625 
ht
 = 
o
->
±r
;

626 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

627 
ht
 = 
o
->
±r
;

628 
couÁ
 *= 2;

629 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
 && o->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

630 
z£t
 *
zs
 = 
o
->
±r
;

631 
ht
 = 
zs
->
diù
;

632 
couÁ
 *= 2;

635 ià(
ht
) {

636 *
´ivd©a
[2];

641 
max™”©iÚs
 = 
couÁ
*10;

646 
´ivd©a
[0] = 
keys
;

647 
´ivd©a
[1] = 
o
;

649 
cursÜ
 = 
	`diùSÿn
(
ht
, cursÜ, 
sÿnC®lback
, 
´ivd©a
);

650 } 
cursÜ
 &&

651 
max™”©iÚs
-- &&

652 
	`dli¡L’gth
(
keys
è< ()
couÁ
);

653 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

654 
pos
 = 0;

655 
št64_t
 
Î
;

657 
	`št£tG‘
(
o
->
±r
,
pos
++,&
Î
))

658 
	`dli¡AddNodeTa
(
keys
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î
));

659 
cursÜ
 = 0;

660 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 || o->ty³ =ğ
OBJ_ZSET
) {

661 *
p
 = 
	`zli¡Index
(
o
->
±r
,0);

662 *
v¡r
;

663 
vËn
;

664 
vÎ
;

666 
p
) {

667 
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vÎ
);

668 
	`dli¡AddNodeTa
(
keys
,

669 (
v¡r
 !ğ
NULL
è? 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
) :

670 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
));

671 
p
 = 
	`zli¡Next
(
o
->
±r
,p);

673 
cursÜ
 = 0;

675 
	`£rv”Pªic
("Not handledƒncoding in SCAN.");

678 
	`uÆockDb
(
c
->
db
);

679 ià(
sÿÁy³
 =ğ
SCAN_TYPE_KEY
) {

680 ià(
cursÜ
 == 0) {

681 ià(
c
->
sÿnid
 < (
£rv”
.
dbšum
 - 1)) {

682 
c
->
sÿnid
 ++;

683 
	`ãtchIÁ”ÇlDbById
(
c
, c->
sÿnid
);

684 
	`lockDbR—d
(
c
->
db
);

685 
sÿn_»Œy
;

687 
c
->
sÿnid
 = -1;

690 } ià(
sÿÁy³
 =ğ
SCAN_TYPE_HASH
 ||

691 
sÿÁy³
 =ğ
SCAN_TYPE_SET
 ||

692 
sÿÁy³
 =ğ
SCAN_TYPE_ZSET
) {

693 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

697 
node
 = 
	`dli¡Fœ¡
(
keys
);

698 
node
) {

699 
robj
 *
kobj
 = 
	`dli¡NodeV®ue
(
node
);

700 
ÃxŠode
 = 
	`dli¡NextNode
(
node
);

701 
f‹r
 = 0;

704 ià(!
f‹r
 && 
u£_·‰”n
) {

705 ià(
	`sdsEncodedObjeù
(
kobj
)) {

706 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
kobj
->
±r
, 
	`sd¦’
(kobj->ptr), 0))

707 
f‹r
 = 1;

709 
buf
[
LONG_STR_SIZE
];

710 
Ën
;

712 
	`ASSERT
(
kobj
->
’codšg
 =ğ
OBJ_ENCODING_INT
);

713 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
kobj
->
±r
);

714 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
buf
, 
Ën
, 0)è
f‹r
 = 1;

719 ià(!
f‹r
 && 
o
 =ğ
NULL
 && 
	`checkIfExpœed
(
c
->
db
,
kobj
)) filter = 1;

722 ià(
f‹r
) {

723 
	`ä“Objeù
(
kobj
);

724 
	`dli¡D–Node
(
keys
, 
node
);

730 ià(
o
 && (o->
ty³
 =ğ
OBJ_ZSET
 || o->ty³ =ğ
OBJ_HASH
)) {

731 
node
 = 
ÃxŠode
;

732 
ÃxŠode
 = 
	`dli¡NextNode
(
node
);

733 ià(
f‹r
) {

734 
kobj
 = 
	`dli¡NodeV®ue
(
node
);

735 
	`ä“Objeù
(
kobj
);

736 
	`dli¡D–Node
(
keys
, 
node
);

739 
node
 = 
ÃxŠode
;

743 
	`addR•lyMuÉiBulkL’
(
c
, 2);

744 
	`addR•lyBulkLÚgLÚg
(
c
,
cursÜ
);

746 
	`addR•lyMuÉiBulkL’
(
c
, 
	`dli¡L’gth
(
keys
));

747 (
node
 = 
	`dli¡Fœ¡
(
keys
)è!ğ
NULL
) {

748 
robj
 *
kobj
 = 
	`dli¡NodeV®ue
(
node
);

749 
	`addR•lyBulk
(
c
, 
kobj
);

750 
	`ä“Objeù
(
kobj
);

751 
	`dli¡D–Node
(
keys
, 
node
);

754 
ş—nup
:

755 
	`dli¡S‘F»eM‘hod
(
keys
,
ä“ObjeùVoid
);

756 
	`dli¡R–—£
(
keys
);

757 
	}
}

760 
	$sÿnCommªd
(
ş›Á
 *
c
) {

761 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_KEY
);

762 
	}
}

764 
	$dbsizeCommªd
(
ş›Á
 *
c
) {

765 
idx
;

766 
couÁ
 = 0;

768 
idx
 = 0; idx < 
£rv”
.
dbšum
; idx ++) {

769 
	`ãtchIÁ”ÇlDbById
(
c
, 
idx
);

770 
	`lockDbR—d
(
c
->
db
);

771 
couÁ
 +ğ
	`diùSize
(
c
->
db
->
diù
);

772 
	`uÆockDb
(
c
->
db
);

775 
	`addR•lyLÚgLÚg
(
c
,
couÁ
);

776 
	}
}

778 
	$Ï¡§veCommªd
(
ş›Á
 *
c
) {

779 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
Ï¡§ve
);

780 
	}
}

782 
	$ty³Commªd
(
ş›Á
 *
c
) {

783 
robj
 *
o
;

784 *
ty³
;

786 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

787 
	`lockDbR—d
(
c
->
db
);

788 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

789 ià(
o
 =ğ
NULL
) {

790 
ty³
 = "none";

791 
	`uÆockDb
(
c
->
db
);

792 
	`addR•lyStus
(
c
,
ty³
);

793 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

796 
o
->
ty³
) {

797 
OBJ_STRING
: 
ty³
 = "string"; ;

798 
OBJ_LIST
: 
ty³
 = "list"; ;

799 
OBJ_SET
: 
ty³
 = "set"; ;

800 
OBJ_ZSET
: 
ty³
 = "zset"; ;

801 
OBJ_HASH
: 
ty³
 = "hash"; ;

802 : 
ty³
 = "unknown"; ;

806 
	`uÆockDb
(
c
->
db
);

807 
	`addR•lyStus
(
c
,
ty³
);

808 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

809 
	}
}

811 
	$shutdownCommªd
(
ş›Á
 *
c
) {

812 
æags
 = 0;

814 ià(
c
->
¬gc
 > 2) {

815 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

817 } ià(
c
->
¬gc
 == 2) {

818 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nosave")) {

819 
æags
 |ğ
SHUTDOWN_NOSAVE
;

820 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"save")) {

821 
æags
 |ğ
SHUTDOWN_SAVE
;

823 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

833 ià(
£rv”
.
lßdšg
)

834 
æags
 = (æag & ~
SHUTDOWN_SAVE
è| 
SHUTDOWN_NOSAVE
;

836 
	`addR•lyE¼Ü
(
c
,"Errorsryingo SHUTDOWN. Check†ogs.");

837 
	}
}

839 
	$»ÇmeG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

840 
robj
 *
o
;

841 
expœe
;

842 
§mekey
 = 0;

846 ià(
	`sdscmp
(
c
->
¬gv
[1]->
±r
,c->¬gv[2]->±rè=ğ0è
§mekey
 = 1;

848 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
,
NULL
)) == NULL)

851 ià(
§mekey
) {

852 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
ok
);

856 
	`šüRefCouÁ
(
o
);

857 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

858 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
) != NULL) {

859 ià(
nx
) {

860 
	`deüRefCouÁ
(
o
);

861 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

866 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[2]);

868 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
o
);

869 ià(
expœe
 !ğ-1è
	`£tExpœe
(
c
->
db
,c->
¬gv
[2],expire);

870 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

871 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

872 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

873 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_from",

874 
c
->
¬gv
[1],c->
db
->
id
);

875 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_to",

876 
c
->
¬gv
[2],c->
db
->
id
);

877 
£rv”
.
dœty
++;

878 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

879 
	}
}

881 
	$»ÇmeCommªd
(
ş›Á
 *
c
) {

882 
	`»ÇmeG’”icCommªd
(
c
,0);

883 
	}
}

885 
	$»Çm’xCommªd
(
ş›Á
 *
c
) {

886 
	`»ÇmeG’”icCommªd
(
c
,1);

887 
	}
}

889 
	$moveCommªd
(
ş›Á
 *
c
) {

890 
robj
 *
o
;

891 
»disDb
 *
¤c
, *
d¡
;

892 
¤cid
;

893 
dbid
, 
expœe
;

896 
¤c
 = 
c
->
db
;

897 
¤cid
 = 
c
->
db
->
id
;

899 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[2],&
dbid
è=ğ
VR_ERROR
 ||

900 
dbid
 < 
INT_MIN
 || dbid > 
INT_MAX
 ||

901 
	`£ËùDb
(
c
,
dbid
è=ğ
VR_ERROR
)

903 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

906 
d¡
 = 
c
->
db
;

907 
	`£ËùDb
(
c
,
¤cid
);

911 ià(
¤c
 =ğ
d¡
) {

912 
	`addR•ly
(
c
,
sh¬ed
.
§meobjeù”r
);

917 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
NULL
);

918 ià(!
o
) {

919 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

922 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

925 ià(
	`lookupKeyWr™e
(
d¡
,
c
->
¬gv
[1],
NULL
) != NULL) {

926 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

929 
	`dbAdd
(
d¡
,
c
->
¬gv
[1],
o
);

930 ià(
expœe
 !ğ-1è
	`£tExpœe
(
d¡
,
c
->
¬gv
[1],expire);

931 
	`šüRefCouÁ
(
o
);

934 
	`dbD–‘e
(
¤c
,
c
->
¬gv
[1]);

935 
£rv”
.
dœty
++;

936 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

937 
	}
}

943 
	$»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

946 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

947  
	`diùD–‘e
(
db
->
expœes
,
key
->
±r
è=ğ
DICT_OK
;

948 
	}
}

950 
	$£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
) {

951 
diùEÁry
 *
kde
, *
de
;

954 
kde
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

955 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
kde
 != NULL);

956 
de
 = 
	`diùR•ÏûRaw
(
db
->
expœes
,
	`diùG‘Key
(
kde
));

957 
	`diùS‘SigÃdIÁeg”V®
(
de
,
wh’
);

958 
	}
}

962 
	$g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
) {

963 
diùEÁry
 *
de
;

966 ià(
	`diùSize
(
db
->
expœes
) == 0 ||

967 (
de
 = 
	`diùFšd
(
db
->
expœes
,
key
->
±r
)è=ğ
NULL
)  -1;

971 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

972  
	`diùG‘SigÃdIÁeg”V®
(
de
);

973 
	}
}

983 
	$´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

984 
robj
 *
¬gv
[2];

986 
¬gv
[0] = 
sh¬ed
.
d–
;

987 
¬gv
[1] = 
key
;

988 
	`šüRefCouÁ
(
¬gv
[0]);

989 
	`šüRefCouÁ
(
¬gv
[1]);

991 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
)

992 
	`ãedAµ’dOÆyFe
(
£rv”
.
d–Commªd
,
db
->
id
,
¬gv
,2);

993 
	`»¶iÿtiÚF“dSÏves
(
»¶
.
¦aves
,
db
->
id
,
¬gv
,2);

995 
	`deüRefCouÁ
(
¬gv
[0]);

996 
	`deüRefCouÁ
(
¬gv
[1]);

997 
	}
}

1000 
	$checkIfExpœed
(
»disDb
 *
db
, 
robj
 *
key
) {

1001 
wh’
;

1003 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

1004 ià(
wh’
 > 0 && 
	`vr_m£c_now
() > when) {

1009 
	}
}

1011 
	$expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
) {

1012 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

1013 
now
;

1015 ià(
wh’
 < 0)  0;

1018 ià(
£rv”
.
lßdšg
)  0;

1025 
now
 = 
£rv”
.
lua_ÿÎ”
 ? s”v”.
lua_time_¡¬t
 : 
	`vr_m£c_now
();

1034 ià(
»¶
.
ma¡”ho¡
 !ğ
NULL
è 
now
 > 
wh’
;

1037 ià(
now
 <ğ
wh’
)  0;

1041 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EXPIRED
,

1042 "expœed",
key
,
db
->
id
);

1043  
	`dbD–‘e
(
db
,
key
);

1044 
	}
}

1057 
	$expœeG’”icCommªd
(
ş›Á
 *
c
, 
ba£time
, 
un™
) {

1058 
robj
 *
key
 = 
c
->
¬gv
[1], *
·¿m
 = c->argv[2];

1059 
wh’
;

1060 
expœed
 = 0;

1062 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
·¿m
, &
wh’
, 
NULL
è!ğ
VR_OK
)

1065 ià(
un™
 =ğ
UNIT_SECONDS
è
wh’
 *= 1000;

1066 
wh’
 +ğ
ba£time
;

1068 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1069 
	`lockDbWr™e
(
c
->
db
);

1071 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
,&
expœed
è=ğ
NULL
) {

1072 
	`uÆockDb
(
c
->
db
);

1073 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1074 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1084 ià(
wh’
 <ğ
	`vr_m£c_now
(è&& !
£rv”
.
lßdšg
 && !
»¶
.
ma¡”ho¡
) {

1085 
robj
 *
aux
;

1087 
	`£rv”As£¹W™hInfo
(
c
,
key
,
	`dbD–‘e
(c->
db
,key));

1088 
c
->
v–
->
dœty
++;

1091 
aux
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
key
);

1092 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
sh¬ed
.
d–
,
aux
);

1093 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1094 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1095 
	`uÆockDb
(
c
->
db
);

1096 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1097 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

1100 
	`£tExpœe
(
c
->
db
,
key
,
wh’
);

1101 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1102 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1103 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"expœe",
key
,
c
->
db
->
id
);

1104 
	`uÆockDb
(
c
->
db
);

1105 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1106 
c
->
v–
->
dœty
++;

1109 
	}
}

1111 
	$expœeCommªd
(
ş›Á
 *
c
) {

1112 
	`expœeG’”icCommªd
(
c
,
	`vr_m£c_now
(),
UNIT_SECONDS
);

1113 
	}
}

1115 
	$expœ—tCommªd
(
ş›Á
 *
c
) {

1116 
	`expœeG’”icCommªd
(
c
,0,
UNIT_SECONDS
);

1117 
	}
}

1119 
	$³xpœeCommªd
(
ş›Á
 *
c
) {

1120 
	`expœeG’”icCommªd
(
c
,
	`vr_m£c_now
(),
UNIT_MILLISECONDS
);

1121 
	}
}

1123 
	$³xpœ—tCommªd
(
ş›Á
 *
c
) {

1124 
	`expœeG’”icCommªd
(
c
,0,
UNIT_MILLISECONDS
);

1125 
	}
}

1127 
	$‰lG’”icCommªd
(
ş›Á
 *
c
, 
ouut_ms
) {

1128 
expœe
, 
‰l
 = -1;

1130 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

1131 
	`lockDbR—d
(
c
->
db
);

1133 ià(
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]è=ğ
NULL
) {

1134 
	`uÆockDb
(
c
->
db
);

1135 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

1136 
	`addR•lyLÚgLÚg
(
c
,-2);

1141 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

1142 
	`uÆockDb
(
c
->
db
);

1143 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

1145 ià(
expœe
 != -1) {

1146 
‰l
 = 
expœe
-
	`vr_m£c_now
();

1147 ià(
‰l
 < 0)tl = 0;

1149 ià(
‰l
 == -1) {

1150 
	`addR•lyLÚgLÚg
(
c
,-1);

1152 
	`addR•lyLÚgLÚg
(
c
,
ouut_ms
 ? 
‰l
 : ((ttl+500)/1000));

1154 
	}
}

1156 
	$‰lCommªd
(
ş›Á
 *
c
) {

1157 
	`‰lG’”icCommªd
(
c
, 0);

1158 
	}
}

1160 
	$±Commªd
(
ş›Á
 *
c
) {

1161 
	`‰lG’”icCommªd
(
c
, 1);

1162 
	}
}

1164 
	$³rsi¡Commªd
(
ş›Á
 *
c
) {

1165 
diùEÁry
 *
de
;

1167 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

1168 
	`lockDbWr™e
(
c
->
db
);

1169 
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[1]->
±r
);

1170 ià(
de
 =ğ
NULL
) {

1171 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1173 ià(
	`»moveExpœe
(
c
->
db
,c->
¬gv
[1])) {

1174 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1175 
c
->
v–
->
dœty
++;

1177 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1180 
	`uÆockDb
(
c
->
db
);

1181 
	}
}

1189 *
	$g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1190 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

1191 
	`UNUSED
(
¬gv
);

1193 ià(
cmd
->
fœ¡key
 == 0) {

1194 *
numkeys
 = 0;

1195  
NULL
;

1197 
Ï¡
 = 
cmd
->
Ï¡key
;

1198 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

1199 
keys
 = 
	`d®loc
(()*((
Ï¡
 - 
cmd
->
fœ¡key
)+1));

1200 
j
 = 
cmd
->
fœ¡key
; j <ğ
Ï¡
; j +ğcmd->
key¡•
) {

1201 
	`ASSERT
(
j
 < 
¬gc
);

1202 
keys
[
i
++] = 
j
;

1204 *
numkeys
 = 
i
;

1205  
keys
;

1206 
	}
}

1219 *
	$g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1220 ià(
cmd
->
g‘keys_´oc
) {

1221  
cmd
->
	`g‘keys_´oc
(cmd,
¬gv
,
¬gc
,
numkeys
);

1223  
	`g‘KeysUsšgCommªdTabË
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1225 
	}
}

1228 
	$g‘KeysF»eResuÉ
(*
»suÉ
) {

1229 
	`dä“
(
»suÉ
);

1230 
	}
}

1235 *
	$zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1236 
i
, 
num
, *
keys
;

1237 
	`UNUSED
(
cmd
);

1239 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1242 ià(
num
 > (
¬gc
-3)) {

1243 *
numkeys
 = 0;

1244  
NULL
;

1250 
keys
 = 
	`d®loc
(()*(
num
+1));

1253 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1256 
keys
[
num
] = 1;

1257 *
numkeys
 = 
num
+1;

1258  
keys
;

1259 
	}
}

1264 *
	$ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1265 
i
, 
num
, *
keys
;

1266 
	`UNUSED
(
cmd
);

1268 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1271 ià(
num
 > (
¬gc
-3)) {

1272 *
numkeys
 = 0;

1273  
NULL
;

1276 
keys
 = 
	`d®loc
(()*
num
);

1277 *
numkeys
 = 
num
;

1280 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1282  
keys
;

1283 
	}
}

1292 *
	$sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1293 
i
, 
j
, 
num
, *
keys
, 
found_¡Üe
 = 0;

1294 
	`UNUSED
(
cmd
);

1296 
num
 = 0;

1297 
keys
 = 
	`d®loc
(()*2);

1299 
keys
[
num
++] = 1;

1306 *
Çme
;

1307 
sk
;

1308 } 
skli¡
[] = {

1312 {
NULL
, 0}

1315 
i
 = 2; i < 
¬gc
; i++) {

1316 
j
 = 0; 
skli¡
[j].
Çme
 !ğ
NULL
; j++) {

1317 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,
skli¡
[
j
].
Çme
)) {

1318 
i
 +ğ
skli¡
[
j
].
sk
;

1320 } ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"¡Üe"è&& i+1 < 
¬gc
) {

1324 
found_¡Üe
 = 1;

1325 
keys
[
num
] = 
i
+1;

1330 *
numkeys
 = 
num
 + 
found_¡Üe
;

1331  
keys
;

1332 
	}
}

1334 *
	$mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1335 
i
, 
num
, 
fœ¡
, *
keys
;

1336 
	`UNUSED
(
cmd
);

1339 
fœ¡
 = 3;

1340 
num
 = 1;

1343 ià(
¬gc
 > 6) {

1344 
i
 = 6; i < 
¬gc
; i++) {

1345 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"keys") &&

1346 
	`sd¦’
(
¬gv
[3]->
±r
) == 0)

1348 
fœ¡
 = 
i
+1;

1349 
num
 = 
¬gc
-
fœ¡
;

1355 
keys
 = 
	`d®loc
(()*
num
);

1356 
i
 = 0; i < 
num
; i++è
keys
[i] = 
fœ¡
+i;

1357 *
numkeys
 = 
num
;

1358  
keys
;

1359 
	}
}

1361 
	$ãtchIÁ”ÇlDbByKey
(
ş›Á
 *
c
, 
robj
 *
key
) {

1362 
c
->
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
	`hash_üc16
(
key
->
±r
,
	`¡ršgObjeùL’
(key))&0x3FFF)%£rv”.
dbšum
+c->
diùid
*server.dbinum);

1363  
VR_OK
;

1364 
	}
}

1366 
	$ãtchIÁ”ÇlDbById
(
ş›Á
 *
c
, 
idx
) {

1367 
c
->
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
idx
+c->
diùid
*£rv”.
dbšum
);

1368  
VR_OK
;

1369 
	}
}

1373 
	$ŒyResizeHashTabËsFÜDb
(
dbid
) {

1374 
»disDb
 *
db
;

1376 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
dbid
);

1377 
	`lockDbWr™e
(
db
);

1378 ià(
	`htN“dsResize
(
db
->
diù
))

1379 
	`diùResize
(
db
->
diù
);

1380 ià(
	`htN“dsResize
(
db
->
expœes
))

1381 
	`diùResize
(
db
->
expœes
);

1382 
	`uÆockDb
(
db
);

1383 
	}
}

1392 
	$šüem’ÎyRehashFÜDb
(
dbid
) {

1393 
»disDb
 *
db
;

1395 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
dbid
);

1396 
	`lockDbWr™e
(
db
);

1399 ià(
	`diùIsRehashšg
(
db
->
diù
)) {

1400 
	`diùRehashMli£cÚds
(
db
->
diù
,1);

1401 
	`uÆockDb
(
db
);

1405 ià(
	`diùIsRehashšg
(
db
->
expœes
)) {

1406 
	`diùRehashMli£cÚds
(
db
->
expœes
,1);

1407 
	`uÆockDb
(
db
);

1411 
	`uÆockDb
(
db
);

1413 
	}
}

1437 
	$aùiveExpœeCyşe
(
vr_back’d
 *
back’d
, 
ty³
) {

1438 
j
, 
™”©iÚ
 = 0;

1439 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

1440 
¡¬t
 = 
	`vr_u£c_now
(), 
tim–im™
;

1441 
expœed_tÙ®
 = 0;

1443 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
) {

1447 ià(!
back’d
->
tim–im™_ex™
) ;

1448 ià(
¡¬t
 < 
back’d
->
Ï¡_ç¡_cyşe
 + 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
*2) ;

1449 
back’d
->
Ï¡_ç¡_cyşe
 = 
¡¬t
;

1459 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
 || 
back’d
->
tim–im™_ex™
)

1460 
dbs_³r_ÿÎ
 = 
£rv”
.
dbnum
;

1466 
tim–im™
 = 1000000*
ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
/
£rv”
.
hz
/100;

1467 
back’d
->
tim–im™_ex™
 = 0;

1468 ià(
tim–im™
 <= 0)imelimit = 1;

1470 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
)

1471 
tim–im™
 = 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
;

1473 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1474 
expœed
;

1475 
»disDb
 *
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
back’d
->
cu¼’t_db
%£rv”.
dbnum
);

1480 
back’d
->
cu¼’t_db
++;

1482 
	`lockDbWr™e
(
db
);

1486 
num
, 
¦Ùs
;

1487 
now
, 
‰l_sum
;

1488 
‰l_§m¶es
;

1490 ià((
num
 = 
	`diùSize
(
db
->
expœes
)) == 0) {

1491 
db
->
avg_‰l
 = 0;

1494 
¦Ùs
 = 
	`diùSlÙs
(
db
->
expœes
);

1495 
now
 = 
	`vr_m£c_now
();

1500 ià(
num
 && 
¦Ùs
 > 
DICT_HT_INITIAL_SIZE
 &&

1501 (
num
*100/
¦Ùs
 < 1)) ;

1505 
expœed
 = 0;

1506 
‰l_sum
 = 0;

1507 
‰l_§m¶es
 = 0;

1509 ià(
num
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
)

1510 
num
 = 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
;

1512 
num
--) {

1513 
diùEÁry
 *
de
;

1514 
‰l
;

1516 ià((
de
 = 
	`diùG‘RªdomKey
(
db
->
expœes
)è=ğ
NULL
) ;

1517 
‰l
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
)-
now
;

1518 ià(
	`aùiveExpœeCyşeTryExpœe
(
db
,
de
,
now
)è
expœed
++;

1519 ià(
‰l
 > 0) {

1521 
‰l_sum
 +ğ
‰l
;

1522 
‰l_§m¶es
++;

1526 
expœed_tÙ®
 +ğ
expœed
;

1529 ià(
‰l_§m¶es
) {

1530 
avg_‰l
 = 
‰l_sum
/
‰l_§m¶es
;

1535 ià(
db
->
avg_‰l
 == 0) db->avg_ttl =‡vg_ttl;

1536 
db
->
avg_‰l
 = (db->avg_ttl/50)*49 + (avg_ttl/50);

1542 
™”©iÚ
++;

1543 ià((
™”©iÚ
 & 0xf) == 0) {

1544 
–­£d
 = 
	`vr_u£c_now
()-
¡¬t
;

1547 ià(
–­£d
 > 
tim–im™
è
back’d
->
tim–im™_ex™
 = 1;

1549 ià(
back’d
->
tim–im™_ex™
) {

1550 
	`uÆockDb
(
db
);

1552 ià(
expœed_tÙ®
 > 0) {

1553 
	`upd©e_¡©s_add
(
back’d
->
v–
.
¡©s
, 
expœedkeys
, 
expœed_tÙ®
);

1559 } 
expœed
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
/4);

1560 
	`uÆockDb
(
db
);

1563 ià(
expœed_tÙ®
 > 0) {

1564 
	`upd©e_¡©s_add
(
back’d
->
v–
.
¡©s
, 
expœedkeys
, 
expœed_tÙ®
);

1566 
	}
}

1568 
	$aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
) {

1569 
t
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
);

1570 ià(
now
 > 
t
) {

1571 
sds
 
key
 = 
	`diùG‘Key
(
de
);

1572 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

1573 
	`dbD–‘e
(
db
,
keyobj
);

1574 
	`ä“Objeù
(
keyobj
);

1579 
	}
}

1584 
	$d©aba£sCrÚ
(
vr_back’d
 *
back’d
) {

1587 ià(
»¶
.
ma¡”ho¡
 =ğ
NULL
)

1588 
	`aùiveExpœeCyşe
(
back’d
, 
ACTIVE_EXPIRE_CYCLE_SLOW
);

1593 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

1594 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

1595 
j
;

1598 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
) dbs_per_call = server.dbnum;

1601 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1602 
	`ŒyResizeHashTabËsFÜDb
(
back’d
->
»size_db
%
£rv”
.
dbnum
);

1603 
back’d
->
»size_db
++;

1607 ià(
£rv”
.
aùiv”ehashšg
) {

1608 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1609 
wÜk_dÚe
 = 
	`šüem’ÎyRehashFÜDb
(
back’d
->
»hash_db
%
£rv”
.
dbnum
);

1610 
back’d
->
»hash_db
++;

1611 ià(
wÜk_dÚe
) {

1619 
	}
}

	@src/vr_db.h

1 #iâdeà
_VR_DB_H_


2 
	#_VR_DB_H_


	)

11 
	#MAXMEMORY_EVICTION_POOL_SIZE
 16

	)

13 
	seviùiÚPoŞEÁry
 {

14 
	midË
;

15 
sds
 
	mkey
;

22 
	s»disDb
 {

23 
diù
 *
	mdiù
;

24 
diù
 *
	mexpœes
;

25 
diù
 *
	mblockšg_keys
;

26 
diù
 *
	m»ady_keys
;

27 
diù
 *
	mw©ched_keys
;

28 
eviùiÚPoŞEÁry
 *
	meviùiÚ_poŞ
;

29 
	mid
;

30 
	mavg_‰l
;

32 
±h»ad_rwlock_t
 
	mrwl
;

33 } 
	t»disDb
;

35 
diùTy³
 
dbDiùTy³
;

36 
diùTy³
 
key±rDiùTy³
;

37 
diùTy³
 
keyli¡DiùTy³
;

39 
»disDbIn™
(
»disDb
 *
db
);

40 
»disDbDeš™
(
»disDb
 *
db
);

42 
lockDbR—d
(
»disDb
 *
db
);

43 
lockDbWr™e
(
»disDb
 *
db
);

44 
uÆockDb
(
»disDb
 *
db
);

46 
robj
 *
lookupKey
(
»disDb
 *
db
,„obj *
key
);

47 
robj
 *
lookupKeyR—d
(
»disDb
 *
db
,„obj *
key
);

48 
robj
 *
lookupKeyWr™e
(
»disDb
 *
db
,„obj *
key
, *
expœed
);

49 
robj
 *
lookupKeyR—dOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

50 
robj
 *
lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
, *
expœed
);

51 
dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

52 
dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

53 
£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
, *
expœed
);

54 
dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
);

55 
robj
 *
dbRªdomKey
(
»disDb
 *
db
);

56 
dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

57 
robj
 *
dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
,„obj *
key
,„obj *
o
);

58 
em±yDb
((
ÿÎback
)(*));

59 
	`£ËùDb
(
ş›Á
 *
c
, 
id
);

60 
	`sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
);

61 
	`sigÇlFlushedDb
(
dbid
);

62 
	`æushdbCommªd
(
ş›Á
 *
c
);

63 
	`æush®lCommªd
(
ş›Á
 *
c
);

64 
	`d–Commªd
(
ş›Á
 *
c
);

65 
	`exi¡sCommªd
(
ş›Á
 *
c
);

66 
	`£ËùCommªd
(
ş›Á
 *
c
);

67 
	`¿ndomkeyCommªd
(
ş›Á
 *
c
);

68 
	`keysCommªd
(
ş›Á
 *
c
);

69 
	`sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
);

70 
	`·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
);

71 
	`sÿnG’”icCommªd
(
ş›Á
 *
c
, 
sÿÁy³
);

72 
	`sÿnCommªd
(
ş›Á
 *
c
);

73 
	`dbsizeCommªd
(
ş›Á
 *
c
);

74 
	`Ï¡§veCommªd
(
ş›Á
 *
c
);

75 
	`ty³Commªd
(
ş›Á
 *
c
);

76 
	`shutdownCommªd
(
ş›Á
 *
c
);

77 
	`»ÇmeG’”icCommªd
(
ş›Á
 *
c
, 
nx
);

78 
	`»ÇmeCommªd
(
ş›Á
 *
c
);

79 
	`»Çm’xCommªd
(
ş›Á
 *
c
);

80 
	`moveCommªd
(
ş›Á
 *
c
);

81 
	`»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

82 
	`£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
);

83 
	`g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
);

84 
	`´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

85 
	`checkIfExpœed
(
»disDb
 *
db
, 
robj
 *
key
);

86 
	`expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
);

87 
	`expœeG’”icCommªd
(
ş›Á
 *
c
, 
ba£time
, 
un™
);

88 
	`expœeCommªd
(
ş›Á
 *
c
);

89 
	`expœ—tCommªd
(
ş›Á
 *
c
);

90 
	`³xpœeCommªd
(
ş›Á
 *
c
);

91 
	`³xpœ—tCommªd
(
ş›Á
 *
c
);

92 
	`‰lG’”icCommªd
(
ş›Á
 *
c
, 
ouut_ms
);

93 
	`‰lCommªd
(
ş›Á
 *
c
);

94 
	`±Commªd
(
ş›Á
 *
c
);

95 
	`³rsi¡Commªd
(
ş›Á
 *
c
);

96 *
	`g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

97 *
	`g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

98 
	`g‘KeysF»eResuÉ
(*
»suÉ
);

99 *
	`zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

100 *
	`ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

101 *
	`sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

102 *
	`mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

104 
	`ãtchIÁ”ÇlDbByKey
(
ş›Á
 *
c
, 
robj
 *
key
);

105 
	`ãtchIÁ”ÇlDbById
(
ş›Á
 *
c
, 
idx
);

107 
	`ŒyResizeHashTabËsFÜDb
(
dbid
);

108 
	`šüem’ÎyRehashFÜDb
(
dbid
);

109 
	`aùiveExpœeCyşe
(
vr_back’d
 *
back’d
, 
ty³
);

110 
	`aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
);

111 
	`d©aba£sCrÚ
(
vr_back’d
 *
back’d
);

	@src/vr_db.h

1 #iâdeà
_VR_DB_H_


2 
	#_VR_DB_H_


	)

11 
	#MAXMEMORY_EVICTION_POOL_SIZE
 16

	)

13 
	seviùiÚPoŞEÁry
 {

14 
	midË
;

15 
sds
 
	mkey
;

22 
	s»disDb
 {

23 
diù
 *
	mdiù
;

24 
diù
 *
	mexpœes
;

25 
diù
 *
	mblockšg_keys
;

26 
diù
 *
	m»ady_keys
;

27 
diù
 *
	mw©ched_keys
;

28 
eviùiÚPoŞEÁry
 *
	meviùiÚ_poŞ
;

29 
	mid
;

30 
	mavg_‰l
;

32 
±h»ad_rwlock_t
 
	mrwl
;

33 } 
	t»disDb
;

35 
diùTy³
 
dbDiùTy³
;

36 
diùTy³
 
key±rDiùTy³
;

37 
diùTy³
 
keyli¡DiùTy³
;

39 
»disDbIn™
(
»disDb
 *
db
);

40 
»disDbDeš™
(
»disDb
 *
db
);

42 
lockDbR—d
(
»disDb
 *
db
);

43 
lockDbWr™e
(
»disDb
 *
db
);

44 
uÆockDb
(
»disDb
 *
db
);

46 
robj
 *
lookupKey
(
»disDb
 *
db
,„obj *
key
);

47 
robj
 *
lookupKeyR—d
(
»disDb
 *
db
,„obj *
key
);

48 
robj
 *
lookupKeyWr™e
(
»disDb
 *
db
,„obj *
key
, *
expœed
);

49 
robj
 *
lookupKeyR—dOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

50 
robj
 *
lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
, *
expœed
);

51 
dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

52 
dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

53 
£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
, *
expœed
);

54 
dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
);

55 
robj
 *
dbRªdomKey
(
»disDb
 *
db
);

56 
dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

57 
robj
 *
dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
,„obj *
key
,„obj *
o
);

58 
em±yDb
((
ÿÎback
)(*));

59 
	`£ËùDb
(
ş›Á
 *
c
, 
id
);

60 
	`sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
);

61 
	`sigÇlFlushedDb
(
dbid
);

62 
	`æushdbCommªd
(
ş›Á
 *
c
);

63 
	`æush®lCommªd
(
ş›Á
 *
c
);

64 
	`d–Commªd
(
ş›Á
 *
c
);

65 
	`exi¡sCommªd
(
ş›Á
 *
c
);

66 
	`£ËùCommªd
(
ş›Á
 *
c
);

67 
	`¿ndomkeyCommªd
(
ş›Á
 *
c
);

68 
	`keysCommªd
(
ş›Á
 *
c
);

69 
	`sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
);

70 
	`·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
);

71 
	`sÿnG’”icCommªd
(
ş›Á
 *
c
, 
sÿÁy³
);

72 
	`sÿnCommªd
(
ş›Á
 *
c
);

73 
	`dbsizeCommªd
(
ş›Á
 *
c
);

74 
	`Ï¡§veCommªd
(
ş›Á
 *
c
);

75 
	`ty³Commªd
(
ş›Á
 *
c
);

76 
	`shutdownCommªd
(
ş›Á
 *
c
);

77 
	`»ÇmeG’”icCommªd
(
ş›Á
 *
c
, 
nx
);

78 
	`»ÇmeCommªd
(
ş›Á
 *
c
);

79 
	`»Çm’xCommªd
(
ş›Á
 *
c
);

80 
	`moveCommªd
(
ş›Á
 *
c
);

81 
	`»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

82 
	`£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
);

83 
	`g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
);

84 
	`´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

85 
	`checkIfExpœed
(
»disDb
 *
db
, 
robj
 *
key
);

86 
	`expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
);

87 
	`expœeG’”icCommªd
(
ş›Á
 *
c
, 
ba£time
, 
un™
);

88 
	`expœeCommªd
(
ş›Á
 *
c
);

89 
	`expœ—tCommªd
(
ş›Á
 *
c
);

90 
	`³xpœeCommªd
(
ş›Á
 *
c
);

91 
	`³xpœ—tCommªd
(
ş›Á
 *
c
);

92 
	`‰lG’”icCommªd
(
ş›Á
 *
c
, 
ouut_ms
);

93 
	`‰lCommªd
(
ş›Á
 *
c
);

94 
	`±Commªd
(
ş›Á
 *
c
);

95 
	`³rsi¡Commªd
(
ş›Á
 *
c
);

96 *
	`g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

97 *
	`g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

98 
	`g‘KeysF»eResuÉ
(*
»suÉ
);

99 *
	`zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

100 *
	`ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

101 *
	`sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

102 *
	`mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

104 
	`ãtchIÁ”ÇlDbByKey
(
ş›Á
 *
c
, 
robj
 *
key
);

105 
	`ãtchIÁ”ÇlDbById
(
ş›Á
 *
c
, 
idx
);

107 
	`ŒyResizeHashTabËsFÜDb
(
dbid
);

108 
	`šüem’ÎyRehashFÜDb
(
dbid
);

109 
	`aùiveExpœeCyşe
(
vr_back’d
 *
back’d
, 
ty³
);

110 
	`aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
);

111 
	`d©aba£sCrÚ
(
vr_back’d
 *
back’d
);

	@src/vr_dict.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<¡d¬g.h
>

5 
	~<lim™s.h
>

6 
	~<sys/time.h
>

7 
	~<ùy³.h
>

9 
	~<vr_cÜe.h
>

19 
	gdiù_ÿn_»size
 = 1;

20 
	gdiù_fÜû_»size_¿tio
 = 5;

24 
_diùEx·ndIfN“ded
(
diù
 *
ht
);

25 
_diùNextPow”
(
size
);

26 
_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
);

27 
_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

32 
	$diùIÁHashFunùiÚ
(
key
)

34 
key
 += ~(key << 15);

35 
key
 ^= (key >> 10);

36 
key
 += (key << 3);

37 
key
 ^= (key >> 6);

38 
key
 += ~(key << 11);

39 
key
 ^= (key >> 16);

40  
key
;

41 
	}
}

43 
ušt32_t
 
	gdiù_hash_funùiÚ_£ed
 = 5381;

45 
	$diùS‘HashFunùiÚS“d
(
ušt32_t
 
£ed
) {

46 
diù_hash_funùiÚ_£ed
 = 
£ed
;

47 
	}
}

49 
ušt32_t
 
	$diùG‘HashFunùiÚS“d
() {

50  
diù_hash_funùiÚ_£ed
;

51 
	}
}

64 
	$diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
) {

67 
ušt32_t
 
£ed
 = 
diù_hash_funùiÚ_£ed
;

68 cÚ¡ 
ušt32_t
 
m
 = 0x5bd1e995;

69 cÚ¡ 
r
 = 24;

72 
ušt32_t
 
h
 = 
£ed
 ^ 
Ën
;

75 cÚ¡ *
d©a
 = (cÚ¡ *)
key
;

77 
Ën
 >= 4) {

78 
ušt32_t
 
k
 = *(ušt32_t*)
d©a
;

80 
k
 *ğ
m
;

81 
k
 ^ğk >> 
r
;

82 
k
 *ğ
m
;

84 
h
 *ğ
m
;

85 
h
 ^ğ
k
;

87 
d©a
 += 4;

88 
Ën
 -= 4;

92 
Ën
) {

93 3: 
h
 ^ğ
d©a
[2] << 16;

94 2: 
h
 ^ğ
d©a
[1] << 8;

95 1: 
h
 ^ğ
d©a
[0]; h *ğ
m
;

100 
h
 ^= h >> 13;

101 
h
 *ğ
m
;

102 
h
 ^= h >> 15;

104  ()
h
;

105 
	}
}

108 
	$diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
) {

109 
hash
 = ()
diù_hash_funùiÚ_£ed
;

111 
Ën
--)

112 
hash
 = ((hash << 5è+ hashè+ (
	`tŞow”
(*
buf
++));

113  
hash
;

114 
	}
}

120 
	$_diùRe£t
(
diùht
 *
ht
)

122 
ht
->
bË
 = 
NULL
;

123 
ht
->
size
 = 0;

124 
ht
->
sizemask
 = 0;

125 
ht
->
u£d
 = 0;

126 
	}
}

129 
diù
 *
	$diùC»©e
(
diùTy³
 *
ty³
,

130 *
´ivD©aPŒ
)

132 
diù
 *
d
 = 
	`d®loc
((*d));

134 
	`_diùIn™
(
d
,
ty³
,
´ivD©aPŒ
);

135  
d
;

136 
	}
}

139 
	$_diùIn™
(
diù
 *
d
, 
diùTy³
 *
ty³
,

140 *
´ivD©aPŒ
)

142 
	`_diùRe£t
(&
d
->
ht
[0]);

143 
	`_diùRe£t
(&
d
->
ht
[1]);

144 
d
->
ty³
 =ype;

145 
d
->
´ivd©a
 = 
´ivD©aPŒ
;

146 
d
->
»hashidx
 = -1;

147 
d
->
™”©Üs
 = 0;

148  
DICT_OK
;

149 
	}
}

153 
	$diùResize
(
diù
 *
d
)

155 
mšim®
;

157 ià(!
diù_ÿn_»size
 || 
	`diùIsRehashšg
(
d
)è 
DICT_ERR
;

158 
mšim®
 = 
d
->
ht
[0].
u£d
;

159 ià(
mšim®
 < 
DICT_HT_INITIAL_SIZE
)

160 
mšim®
 = 
DICT_HT_INITIAL_SIZE
;

161  
	`diùEx·nd
(
d
, 
mšim®
);

162 
	}
}

165 
	$diùEx·nd
(
diù
 *
d
, 
size
)

167 
diùht
 
n
;

168 
»®size
 = 
	`_diùNextPow”
(
size
);

172 ià(
	`diùIsRehashšg
(
d
è|| d->
ht
[0].
u£d
 > 
size
)

173  
DICT_ERR
;

176 ià(
»®size
 =ğ
d
->
ht
[0].
size
è 
DICT_ERR
;

179 
n
.
size
 = 
»®size
;

180 
n
.
sizemask
 = 
»®size
-1;

181 
n
.
bË
 = 
	`dÿÎoc
(
»®size
, (
diùEÁry
*));

182 
n
.
u£d
 = 0;

186 ià(
d
->
ht
[0].
bË
 =ğ
NULL
) {

187 
d
->
ht
[0] = 
n
;

188  
DICT_OK
;

192 
d
->
ht
[1] = 
n
;

193 
d
->
»hashidx
 = 0;

194  
DICT_OK
;

195 
	}
}

206 
	$diùRehash
(
diù
 *
d
, 
n
) {

207 
em±y_vis™s
 = 
n
*10;

208 ià(!
	`diùIsRehashšg
(
d
))  0;

210 
n
-- && 
d
->
ht
[0].
u£d
 != 0) {

211 
diùEÁry
 *
de
, *
Ãxtde
;

215 
	`ASSERT
(
d
->
ht
[0].
size
 > ()d->
»hashidx
);

216 
d
->
ht
[0].
bË
[d->
»hashidx
] =ğ
NULL
) {

217 
d
->
»hashidx
++;

218 ià(--
em±y_vis™s
 == 0)  1;

220 
de
 = 
d
->
ht
[0].
bË
[d->
»hashidx
];

222 
de
) {

223 
h
;

225 
Ãxtde
 = 
de
->
Ãxt
;

227 
h
 = 
	`diùHashKey
(
d
, 
de
->
key
è& d->
ht
[1].
sizemask
;

228 
de
->
Ãxt
 = 
d
->
ht
[1].
bË
[
h
];

229 
d
->
ht
[1].
bË
[
h
] = 
de
;

230 
d
->
ht
[0].
u£d
--;

231 
d
->
ht
[1].
u£d
++;

232 
de
 = 
Ãxtde
;

234 
d
->
ht
[0].
bË
[d->
»hashidx
] = 
NULL
;

235 
d
->
»hashidx
++;

239 ià(
d
->
ht
[0].
u£d
 == 0) {

240 
	`dä“
(
d
->
ht
[0].
bË
);

241 
d
->
ht
[0] = d->ht[1];

242 
	`_diùRe£t
(&
d
->
ht
[1]);

243 
d
->
»hashidx
 = -1;

249 
	}
}

251 
	$timeInMli£cÚds
() {

252 
timev®
 
tv
;

254 
	`g‘timeofday
(&
tv
,
NULL
);

255  ((()
tv
.
tv_£c
)*1000)+Ñv.
tv_u£c
/1000);

256 
	}
}

259 
	$diùRehashMli£cÚds
(
diù
 *
d
, 
ms
) {

260 
¡¬t
 = 
	`timeInMli£cÚds
();

261 
»hashes
 = 0;

263 
	`diùRehash
(
d
,100)) {

264 
»hashes
 += 100;

265 ià(
	`timeInMli£cÚds
()-
¡¬t
 > 
ms
) ;

267  
»hashes
;

268 
	}
}

278 
	$_diùRehashS‹p
(
diù
 *
d
) {

279 ià(
d
->
™”©Üs
 =ğ0è
	`diùRehash
(d,1);

280 
	}
}

283 
	$diùAdd
(
diù
 *
d
, *
key
, *
v®
)

285 
diùEÁry
 *
’Œy
 = 
	`diùAddRaw
(
d
,
key
);

287 ià(!
’Œy
è 
DICT_ERR
;

288 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

289  
DICT_OK
;

290 
	}
}

307 
diùEÁry
 *
	$diùAddRaw
(
diù
 *
d
, *
key
)

309 
šdex
;

310 
diùEÁry
 *
’Œy
;

311 
diùht
 *
ht
;

313 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

317 ià((
šdex
 = 
	`_diùKeyIndex
(
d
, 
key
)) == -1)

318  
NULL
;

324 
ht
 = 
	`diùIsRehashšg
(
d
) ? &d->ht[1] : &d->ht[0];

325 
’Œy
 = 
	`d®loc
((*entry));

326 
’Œy
->
Ãxt
 = 
ht
->
bË
[
šdex
];

327 
ht
->
bË
[
šdex
] = 
’Œy
;

328 
ht
->
u£d
++;

331 
	`diùS‘Key
(
d
, 
’Œy
, 
key
);

332  
’Œy
;

333 
	}
}

339 
	$diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
)

341 
diùEÁry
 *
’Œy
, 
aux’Œy
;

345 ià(
	`diùAdd
(
d
, 
key
, 
v®
è=ğ
DICT_OK
)

348 
’Œy
 = 
	`diùFšd
(
d
, 
key
);

354 
aux’Œy
 = *
’Œy
;

355 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

356 
	`diùF»eV®
(
d
, &
aux’Œy
);

358 
	}
}

366 
diùEÁry
 *
	$diùR•ÏûRaw
(
diù
 *
d
, *
key
) {

367 
diùEÁry
 *
’Œy
 = 
	`diùFšd
(
d
,
key
);

369  
’Œy
 ?ƒÁry : 
	`diùAddRaw
(
d
,
key
);

370 
	}
}

373 
	$diùG’”icD–‘e
(
diù
 *
d
, cÚ¡ *
key
, 
noä“
)

375 
h
, 
idx
;

376 
diùEÁry
 *
he
, *
´evHe
;

377 
bË
;

379 ià(
d
->
ht
[0].
size
 =ğ0è 
DICT_ERR
;

380 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

381 
h
 = 
	`diùHashKey
(
d
, 
key
);

383 
bË
 = 0;able <= 1;able++) {

384 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

385 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

386 
´evHe
 = 
NULL
;

387 
he
) {

388 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key)) {

390 ià(
´evHe
)

391 
´evHe
->
Ãxt
 = 
he
->next;

393 
d
->
ht
[
bË
].bË[
idx
] = 
he
->
Ãxt
;

394 ià(!
noä“
) {

395 
	`diùF»eKey
(
d
, 
he
);

396 
	`diùF»eV®
(
d
, 
he
);

398 
	`dä“
(
he
);

399 
d
->
ht
[
bË
].
u£d
--;

400  
DICT_OK
;

402 
´evHe
 = 
he
;

403 
he
 = he->
Ãxt
;

405 ià(!
	`diùIsRehashšg
(
d
)) ;

407  
DICT_ERR
;

408 
	}
}

410 
	$diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
) {

411  
	`diùG’”icD–‘e
(
ht
,
key
,0);

412 
	}
}

414 
	$diùD–‘eNoF»e
(
diù
 *
ht
, cÚ¡ *
key
) {

415  
	`diùG’”icD–‘e
(
ht
,
key
,1);

416 
	}
}

419 
_diùCË¬
(
diù
 *
d
, 
diùht
 *
ht
, (
ÿÎback
)(*)) {

420 
i
;

423 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

424 
diùEÁry
 *
he
, *
ÃxtHe
;

426 ià(
ÿÎback
 && (
i
 & 65535è=ğ0è
	`ÿÎback
(
d
->
´ivd©a
);

428 ià((
he
 = 
ht
->
bË
[
i
]è=ğ
NULL
) ;

429 
he
) {

430 
ÃxtHe
 = 
he
->
Ãxt
;

431 
	`diùF»eKey
(
d
, 
he
);

432 
	`diùF»eV®
(
d
, 
he
);

433 
	`dä“
(
he
);

434 
ht
->
u£d
--;

435 
he
 = 
ÃxtHe
;

439 if(
ht
->
bË
è
	`dä“
(ht->table);

441 
	`_diùRe£t
(
ht
);

442  
DICT_OK
;

443 
	}
}

446 
	$diùR–—£
(
diù
 *
d
)

448 
	`_diùCË¬
(
d
,&d->
ht
[0],
NULL
);

449 
	`_diùCË¬
(
d
,&d->
ht
[1],
NULL
);

450 
	`dä“
(
d
);

451 
	}
}

453 
diùEÁry
 *
	$diùFšd
(
diù
 *
d
, cÚ¡ *
key
)

455 
diùEÁry
 *
he
;

456 
h
, 
idx
, 
bË
;

458 ià(
d
->
ht
[0].
u£d
 + d->ht[1].u£d =ğ0è 
NULL
;

460 
h
 = 
	`diùHashKey
(
d
, 
key
);

461 
bË
 = 0;able <= 1;able++) {

462 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

463 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

464 
he
) {

465 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

466  
he
;

467 
he
 = he->
Ãxt
;

469 ià(!
	`diùIsRehashšg
(
d
)è 
NULL
;

471  
NULL
;

472 
	}
}

474 *
	$diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
) {

475 
diùEÁry
 *
he
;

477 
he
 = 
	`diùFšd
(
d
,
key
);

478  
he
 ? 
	`diùG‘V®
(heè: 
NULL
;

479 
	}
}

487 
	$diùFšg”´št
(
diù
 *
d
) {

488 
š‹g”s
[6], 
hash
 = 0;

489 
j
;

491 
š‹g”s
[0] = (è
d
->
ht
[0].
bË
;

492 
š‹g”s
[1] = 
d
->
ht
[0].
size
;

493 
š‹g”s
[2] = 
d
->
ht
[0].
u£d
;

494 
š‹g”s
[3] = (è
d
->
ht
[1].
bË
;

495 
š‹g”s
[4] = 
d
->
ht
[1].
size
;

496 
š‹g”s
[5] = 
d
->
ht
[1].
u£d
;

505 
j
 = 0; j < 6; j++) {

506 
hash
 +ğ
š‹g”s
[
j
];

508 
hash
 = (~hash) + (hash << 21);

509 
hash
 = hash ^ (hash >> 24);

510 
hash
 = (hash + (hash << 3)) + (hash << 8);

511 
hash
 = hash ^ (hash >> 14);

512 
hash
 = (hash + (hash << 2)) + (hash << 4);

513 
hash
 = hash ^ (hash >> 28);

514 
hash
 = hash + (hash << 31);

516  
hash
;

517 
	}
}

519 
diùI‹¿tÜ
 *
	$diùG‘I‹¿tÜ
(
diù
 *
d
)

521 
diùI‹¿tÜ
 *
™”
 = 
	`d®loc
((*iter));

523 
™”
->
d
 = d;

524 
™”
->
bË
 = 0;

525 
™”
->
šdex
 = -1;

526 
™”
->
§ã
 = 0;

527 
™”
->
’Œy
 = 
NULL
;

528 
™”
->
ÃxtEÁry
 = 
NULL
;

529  
™”
;

530 
	}
}

532 
diùI‹¿tÜ
 *
	$diùG‘SaãI‹¿tÜ
(
diù
 *
d
) {

533 
diùI‹¿tÜ
 *
i
 = 
	`diùG‘I‹¿tÜ
(
d
);

535 
i
->
§ã
 = 1;

536  
i
;

537 
	}
}

539 
diùEÁry
 *
	$diùNext
(
diùI‹¿tÜ
 *
™”
)

542 ià(
™”
->
’Œy
 =ğ
NULL
) {

543 
diùht
 *
ht
 = &
™”
->
d
->ht[™”->
bË
];

544 ià(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0) {

545 ià(
™”
->
§ã
)

546 
™”
->
d
->
™”©Üs
++;

548 
™”
->
fšg”´št
 = 
	`diùFšg”´št
(™”->
d
);

550 
™”
->
šdex
++;

551 ià(
™”
->
šdex
 >ğ(è
ht
->
size
) {

552 ià(
	`diùIsRehashšg
(
™”
->
d
è&& i‹r->
bË
 == 0) {

553 
™”
->
bË
++;

554 
™”
->
šdex
 = 0;

555 
ht
 = &
™”
->
d
->ht[1];

560 
™”
->
’Œy
 = 
ht
->
bË
[™”->
šdex
];

562 
™”
->
’Œy
 = i‹r->
ÃxtEÁry
;

564 ià(
™”
->
’Œy
) {

567 
™”
->
ÃxtEÁry
 = i‹r->
’Œy
->
Ãxt
;

568  
™”
->
’Œy
;

571  
NULL
;

572 
	}
}

574 
	$diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
)

576 ià(!(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0)) {

577 ià(
™”
->
§ã
) {

578 
™”
->
d
->
™”©Üs
--;

580 
hv
 = 
	`diùFšg”´št
(
™”
->
d
);

581 
	`ASSERT
(
™”
->
fšg”´št
 =ğ
hv
);

584 
	`dä“
(
™”
);

585 
	}
}

589 
diùEÁry
 *
	$diùG‘RªdomKey
(
diù
 *
d
)

591 
diùEÁry
 *
he
, *
Üighe
;

592 
h
;

593 
li¡Ën
, 
li¡–e
;

595 ià(
	`diùSize
(
d
è=ğ0è 
NULL
;

596 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

597 ià(
	`diùIsRehashšg
(
d
)) {

601 
h
 = 
d
->
»hashidx
 + (
	`¿ndom
(è% (d->
ht
[0].
size
 +

602 
d
->
ht
[1].
size
 -

603 
d
->
»hashidx
));

604 
he
 = (
h
 >ğ
d
->
ht
[0].
size
è? d->ht[1].
bË
[h - d->ht[0].size] :

605 
d
->
ht
[0].
bË
[
h
];

606 } 
he
 =ğ
NULL
);

609 
h
 = 
	`¿ndom
(è& 
d
->
ht
[0].
sizemask
;

610 
he
 = 
d
->
ht
[0].
bË
[
h
];

611 } 
he
 =ğ
NULL
);

618 
li¡Ën
 = 0;

619 
Üighe
 = 
he
;

620 
he
) {

621 
he
 = he->
Ãxt
;

622 
li¡Ën
++;

624 
li¡–e
 = 
	`¿ndom
(è% 
li¡Ën
;

625 
he
 = 
Üighe
;

626 
li¡–e
--è
he
 = he->
Ãxt
;

627  
he
;

628 
	}
}

652 
	$diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
) {

653 
j
;

654 
bËs
;

655 
¡Üed
 = 0, 
maxsizemask
;

656 
max¡•s
;

658 ià(
	`diùSize
(
d
è< 
couÁ
) count = dictSize(d);

659 
max¡•s
 = 
couÁ
*10;

662 
j
 = 0; j < 
couÁ
; j++) {

663 ià(
	`diùIsRehashšg
(
d
))

664 
	`_diùRehashS‹p
(
d
);

669 
bËs
 = 
	`diùIsRehashšg
(
d
) ? 2 : 1;

670 
maxsizemask
 = 
d
->
ht
[0].
sizemask
;

671 ià(
bËs
 > 1 && 
maxsizemask
 < 
d
->
ht
[1].
sizemask
)

672 
maxsizemask
 = 
d
->
ht
[1].
sizemask
;

675 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

676 
em±yËn
 = 0;

677 
¡Üed
 < 
couÁ
 && 
max¡•s
--) {

678 
j
 = 0; j < 
bËs
; j++) {

682 ià(
bËs
 =ğ2 && 
j
 =ğ0 && 
i
 < (è
d
->
»hashidx
) {

687 ià(
i
 >ğ
d
->
ht
[1].
size
è˜ğd->
»hashidx
;

690 ià(
i
 >ğ
d
->
ht
[
j
].
size
) ;

691 
diùEÁry
 *
he
 = 
d
->
ht
[
j
].
bË
[
i
];

695 ià(
he
 =ğ
NULL
) {

696 
em±yËn
++;

697 ià(
em±yËn
 >ğ5 &&ƒm±yËÀ> 
couÁ
) {

698 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

699 
em±yËn
 = 0;

702 
em±yËn
 = 0;

703 
he
) {

706 *
des
 = 
he
;

707 
des
++;

708 
he
 = he->
Ãxt
;

709 
¡Üed
++;

710 ià(
¡Üed
 =ğ
couÁ
)  stored;

714 
i
 = (i+1è& 
maxsizemask
;

716  
¡Üed
;

717 
	}
}

721 
	$»v
(
v
) {

722 
s
 = 8 * (
v
);

723 
mask
 = ~0;

724 (
s
 >>= 1) > 0) {

725 
mask
 ^ğ(mask << 
s
);

726 
v
 = ((v >> 
s
è& 
mask
) | ((v << s) & ~mask);

728  
v
;

729 
	}
}

815 
	$diùSÿn
(
diù
 *
d
,

816 
v
,

817 
diùSÿnFunùiÚ
 *
â
,

818 *
´ivd©a
)

820 
diùht
 *
t0
, *
t1
;

821 cÚ¡ 
diùEÁry
 *
de
;

822 
m0
, 
m1
;

824 ià(
	`diùSize
(
d
) == 0)  0;

826 ià(!
	`diùIsRehashšg
(
d
)) {

827 
t0
 = &(
d
->
ht
[0]);

828 
m0
 = 
t0
->
sizemask
;

831 
de
 = 
t0
->
bË
[
v
 & 
m0
];

832 
de
) {

833 
	`â
(
´ivd©a
, 
de
);

834 
de
 = de->
Ãxt
;

838 
t0
 = &
d
->
ht
[0];

839 
t1
 = &
d
->
ht
[1];

842 ià(
t0
->
size
 > 
t1
->size) {

843 
t0
 = &
d
->
ht
[1];

844 
t1
 = &
d
->
ht
[0];

847 
m0
 = 
t0
->
sizemask
;

848 
m1
 = 
t1
->
sizemask
;

851 
de
 = 
t0
->
bË
[
v
 & 
m0
];

852 
de
) {

853 
	`â
(
´ivd©a
, 
de
);

854 
de
 = de->
Ãxt
;

861 
de
 = 
t1
->
bË
[
v
 & 
m1
];

862 
de
) {

863 
	`â
(
´ivd©a
, 
de
);

864 
de
 = de->
Ãxt
;

868 
v
 = (((v | 
m0
) + 1) & ~m0) | (v & m0);

871 } 
v
 & (
m0
 ^ 
m1
));

876 
v
 |ğ~
m0
;

879 
v
 = 
	`»v
(v);

880 
v
++;

881 
v
 = 
	`»v
(v);

883  
v
;

884 
	}
}

889 
	$_diùEx·ndIfN“ded
(
diù
 *
d
)

892 ià(
	`diùIsRehashšg
(
d
)è 
DICT_OK
;

895 ià(
d
->
ht
[0].
size
 =ğ0è 
	`diùEx·nd
(d, 
DICT_HT_INITIAL_SIZE
);

901 ià(
d
->
ht
[0].
u£d
 >ğd->ht[0].
size
 &&

902 (
diù_ÿn_»size
 ||

903 
d
->
ht
[0].
u£d
/d->ht[0].
size
 > 
diù_fÜû_»size_¿tio
))

905  
	`diùEx·nd
(
d
, d->
ht
[0].
u£d
*2);

907  
DICT_OK
;

908 
	}
}

911 
	$_diùNextPow”
(
size
)

913 
i
 = 
DICT_HT_INITIAL_SIZE
;

915 ià(
size
 >ğ
LONG_MAX
)  LONG_MAX;

917 ià(
i
 >ğ
size
)

918  
i
;

919 
i
 *= 2;

921 
	}
}

929 
	$_diùKeyIndex
(
diù
 *
d
, cÚ¡ *
key
)

931 
h
, 
idx
, 
bË
;

932 
diùEÁry
 *
he
;

935 ià(
	`_diùEx·ndIfN“ded
(
d
è=ğ
DICT_ERR
)

938 
h
 = 
	`diùHashKey
(
d
, 
key
);

939 
bË
 = 0;able <= 1;able++) {

940 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

942 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

943 
he
) {

944 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

946 
he
 = he->
Ãxt
;

948 ià(!
	`diùIsRehashšg
(
d
)) ;

950  
idx
;

951 
	}
}

953 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*)) {

954 
	`_diùCË¬
(
d
,&d->
ht
[0],
ÿÎback
);

955 
	`_diùCË¬
(
d
,&d->
ht
[1],
ÿÎback
);

956 
d
->
»hashidx
 = -1;

957 
d
->
™”©Üs
 = 0;

958 
	}
}

960 
	$diùEÇbËResize
() {

961 
diù_ÿn_»size
 = 1;

962 
	}
}

964 
	$diùDi§bËResize
() {

965 
diù_ÿn_»size
 = 0;

966 
	}
}

970 
	#DICT_STATS_VECTLEN
 50

	)

971 
size_t
 
	$_diùG‘StsHt
(*
buf
, 
size_t
 
bufsize
, 
diùht
 *
ht
, 
bËid
) {

972 
i
, 
¦Ùs
 = 0, 
chašËn
, 
maxchašËn
 = 0;

973 
tÙchašËn
 = 0;

974 
şveùÜ
[
DICT_STATS_VECTLEN
];

975 
size_t
 
l
 = 0;

977 ià(
ht
->
u£d
 == 0) {

978  
	`¢´štf
(
buf
,
bufsize
,

983 
i
 = 0; i < 
DICT_STATS_VECTLEN
; i++è
şveùÜ
[i] = 0;

984 
i
 = 0; i < 
ht
->
size
; i++) {

985 
diùEÁry
 *
he
;

987 ià(
ht
->
bË
[
i
] =ğ
NULL
) {

988 
şveùÜ
[0]++;

991 
¦Ùs
++;

993 
chašËn
 = 0;

994 
he
 = 
ht
->
bË
[
i
];

995 
he
) {

996 
chašËn
++;

997 
he
 = he->
Ãxt
;

999 
şveùÜ
[(
chašËn
 < 
DICT_STATS_VECTLEN
) ? chainlen : (DICT_STATS_VECTLEN-1)]++;

1000 ià(
chašËn
 > 
maxchašËn
) maxchainlen = chainlen;

1001 
tÙchašËn
 +ğ
chašËn
;

1005 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1014 
bËid
, (tableid == 0) ? "main hashable" : "rehashingarget",

1015 
ht
->
size
, ht->
u£d
, 
¦Ùs
, 
maxchašËn
,

1016 ()
tÙchašËn
/
¦Ùs
, ()
ht
->
u£d
/slots);

1018 
i
 = 0; i < 
DICT_STATS_VECTLEN
-1; i++) {

1019 ià(
şveùÜ
[
i
] == 0) ;

1020 ià(
l
 >ğ
bufsize
) ;

1021 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1023 (
i
 =ğ
DICT_STATS_VECTLEN
-1)?">= ":"",

1024 
i
, 
şveùÜ
[i], (()şveùÜ[i]/
ht
->
size
)*100);

1028 ià(
bufsize
è
buf
[bufsize-1] = '\0';

1029  
	`¡¾’
(
buf
);

1030 
	}
}

1032 
	$diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
) {

1033 
size_t
 
l
;

1034 *
Üig_buf
 = 
buf
;

1035 
size_t
 
Üig_bufsize
 = 
bufsize
;

1037 
l
 = 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[0],0);

1038 
buf
 +ğ
l
;

1039 
bufsize
 -ğ
l
;

1040 ià(
	`diùIsRehashšg
(
d
è&& 
bufsize
 > 0) {

1041 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[1],1);

1044 ià(
Üig_bufsize
è
Üig_buf
[orig_bufsize-1] = '\0';

1045 
	}
}

	@src/vr_dict.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<¡d¬g.h
>

5 
	~<lim™s.h
>

6 
	~<sys/time.h
>

7 
	~<ùy³.h
>

9 
	~<vr_cÜe.h
>

19 
	gdiù_ÿn_»size
 = 1;

20 
	gdiù_fÜû_»size_¿tio
 = 5;

24 
_diùEx·ndIfN“ded
(
diù
 *
ht
);

25 
_diùNextPow”
(
size
);

26 
_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
);

27 
_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

32 
	$diùIÁHashFunùiÚ
(
key
)

34 
key
 += ~(key << 15);

35 
key
 ^= (key >> 10);

36 
key
 += (key << 3);

37 
key
 ^= (key >> 6);

38 
key
 += ~(key << 11);

39 
key
 ^= (key >> 16);

40  
key
;

41 
	}
}

43 
ušt32_t
 
	gdiù_hash_funùiÚ_£ed
 = 5381;

45 
	$diùS‘HashFunùiÚS“d
(
ušt32_t
 
£ed
) {

46 
diù_hash_funùiÚ_£ed
 = 
£ed
;

47 
	}
}

49 
ušt32_t
 
	$diùG‘HashFunùiÚS“d
() {

50  
diù_hash_funùiÚ_£ed
;

51 
	}
}

64 
	$diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
) {

67 
ušt32_t
 
£ed
 = 
diù_hash_funùiÚ_£ed
;

68 cÚ¡ 
ušt32_t
 
m
 = 0x5bd1e995;

69 cÚ¡ 
r
 = 24;

72 
ušt32_t
 
h
 = 
£ed
 ^ 
Ën
;

75 cÚ¡ *
d©a
 = (cÚ¡ *)
key
;

77 
Ën
 >= 4) {

78 
ušt32_t
 
k
 = *(ušt32_t*)
d©a
;

80 
k
 *ğ
m
;

81 
k
 ^ğk >> 
r
;

82 
k
 *ğ
m
;

84 
h
 *ğ
m
;

85 
h
 ^ğ
k
;

87 
d©a
 += 4;

88 
Ën
 -= 4;

92 
Ën
) {

93 3: 
h
 ^ğ
d©a
[2] << 16;

94 2: 
h
 ^ğ
d©a
[1] << 8;

95 1: 
h
 ^ğ
d©a
[0]; h *ğ
m
;

100 
h
 ^= h >> 13;

101 
h
 *ğ
m
;

102 
h
 ^= h >> 15;

104  ()
h
;

105 
	}
}

108 
	$diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
) {

109 
hash
 = ()
diù_hash_funùiÚ_£ed
;

111 
Ën
--)

112 
hash
 = ((hash << 5è+ hashè+ (
	`tŞow”
(*
buf
++));

113  
hash
;

114 
	}
}

120 
	$_diùRe£t
(
diùht
 *
ht
)

122 
ht
->
bË
 = 
NULL
;

123 
ht
->
size
 = 0;

124 
ht
->
sizemask
 = 0;

125 
ht
->
u£d
 = 0;

126 
	}
}

129 
diù
 *
	$diùC»©e
(
diùTy³
 *
ty³
,

130 *
´ivD©aPŒ
)

132 
diù
 *
d
 = 
	`d®loc
((*d));

134 
	`_diùIn™
(
d
,
ty³
,
´ivD©aPŒ
);

135  
d
;

136 
	}
}

139 
	$_diùIn™
(
diù
 *
d
, 
diùTy³
 *
ty³
,

140 *
´ivD©aPŒ
)

142 
	`_diùRe£t
(&
d
->
ht
[0]);

143 
	`_diùRe£t
(&
d
->
ht
[1]);

144 
d
->
ty³
 =ype;

145 
d
->
´ivd©a
 = 
´ivD©aPŒ
;

146 
d
->
»hashidx
 = -1;

147 
d
->
™”©Üs
 = 0;

148  
DICT_OK
;

149 
	}
}

153 
	$diùResize
(
diù
 *
d
)

155 
mšim®
;

157 ià(!
diù_ÿn_»size
 || 
	`diùIsRehashšg
(
d
)è 
DICT_ERR
;

158 
mšim®
 = 
d
->
ht
[0].
u£d
;

159 ià(
mšim®
 < 
DICT_HT_INITIAL_SIZE
)

160 
mšim®
 = 
DICT_HT_INITIAL_SIZE
;

161  
	`diùEx·nd
(
d
, 
mšim®
);

162 
	}
}

165 
	$diùEx·nd
(
diù
 *
d
, 
size
)

167 
diùht
 
n
;

168 
»®size
 = 
	`_diùNextPow”
(
size
);

172 ià(
	`diùIsRehashšg
(
d
è|| d->
ht
[0].
u£d
 > 
size
)

173  
DICT_ERR
;

176 ià(
»®size
 =ğ
d
->
ht
[0].
size
è 
DICT_ERR
;

179 
n
.
size
 = 
»®size
;

180 
n
.
sizemask
 = 
»®size
-1;

181 
n
.
bË
 = 
	`dÿÎoc
(
»®size
, (
diùEÁry
*));

182 
n
.
u£d
 = 0;

186 ià(
d
->
ht
[0].
bË
 =ğ
NULL
) {

187 
d
->
ht
[0] = 
n
;

188  
DICT_OK
;

192 
d
->
ht
[1] = 
n
;

193 
d
->
»hashidx
 = 0;

194  
DICT_OK
;

195 
	}
}

206 
	$diùRehash
(
diù
 *
d
, 
n
) {

207 
em±y_vis™s
 = 
n
*10;

208 ià(!
	`diùIsRehashšg
(
d
))  0;

210 
n
-- && 
d
->
ht
[0].
u£d
 != 0) {

211 
diùEÁry
 *
de
, *
Ãxtde
;

215 
	`ASSERT
(
d
->
ht
[0].
size
 > ()d->
»hashidx
);

216 
d
->
ht
[0].
bË
[d->
»hashidx
] =ğ
NULL
) {

217 
d
->
»hashidx
++;

218 ià(--
em±y_vis™s
 == 0)  1;

220 
de
 = 
d
->
ht
[0].
bË
[d->
»hashidx
];

222 
de
) {

223 
h
;

225 
Ãxtde
 = 
de
->
Ãxt
;

227 
h
 = 
	`diùHashKey
(
d
, 
de
->
key
è& d->
ht
[1].
sizemask
;

228 
de
->
Ãxt
 = 
d
->
ht
[1].
bË
[
h
];

229 
d
->
ht
[1].
bË
[
h
] = 
de
;

230 
d
->
ht
[0].
u£d
--;

231 
d
->
ht
[1].
u£d
++;

232 
de
 = 
Ãxtde
;

234 
d
->
ht
[0].
bË
[d->
»hashidx
] = 
NULL
;

235 
d
->
»hashidx
++;

239 ià(
d
->
ht
[0].
u£d
 == 0) {

240 
	`dä“
(
d
->
ht
[0].
bË
);

241 
d
->
ht
[0] = d->ht[1];

242 
	`_diùRe£t
(&
d
->
ht
[1]);

243 
d
->
»hashidx
 = -1;

249 
	}
}

251 
	$timeInMli£cÚds
() {

252 
timev®
 
tv
;

254 
	`g‘timeofday
(&
tv
,
NULL
);

255  ((()
tv
.
tv_£c
)*1000)+Ñv.
tv_u£c
/1000);

256 
	}
}

259 
	$diùRehashMli£cÚds
(
diù
 *
d
, 
ms
) {

260 
¡¬t
 = 
	`timeInMli£cÚds
();

261 
»hashes
 = 0;

263 
	`diùRehash
(
d
,100)) {

264 
»hashes
 += 100;

265 ià(
	`timeInMli£cÚds
()-
¡¬t
 > 
ms
) ;

267  
»hashes
;

268 
	}
}

278 
	$_diùRehashS‹p
(
diù
 *
d
) {

279 ià(
d
->
™”©Üs
 =ğ0è
	`diùRehash
(d,1);

280 
	}
}

283 
	$diùAdd
(
diù
 *
d
, *
key
, *
v®
)

285 
diùEÁry
 *
’Œy
 = 
	`diùAddRaw
(
d
,
key
);

287 ià(!
’Œy
è 
DICT_ERR
;

288 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

289  
DICT_OK
;

290 
	}
}

307 
diùEÁry
 *
	$diùAddRaw
(
diù
 *
d
, *
key
)

309 
šdex
;

310 
diùEÁry
 *
’Œy
;

311 
diùht
 *
ht
;

313 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

317 ià((
šdex
 = 
	`_diùKeyIndex
(
d
, 
key
)) == -1)

318  
NULL
;

324 
ht
 = 
	`diùIsRehashšg
(
d
) ? &d->ht[1] : &d->ht[0];

325 
’Œy
 = 
	`d®loc
((*entry));

326 
’Œy
->
Ãxt
 = 
ht
->
bË
[
šdex
];

327 
ht
->
bË
[
šdex
] = 
’Œy
;

328 
ht
->
u£d
++;

331 
	`diùS‘Key
(
d
, 
’Œy
, 
key
);

332  
’Œy
;

333 
	}
}

339 
	$diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
)

341 
diùEÁry
 *
’Œy
, 
aux’Œy
;

345 ià(
	`diùAdd
(
d
, 
key
, 
v®
è=ğ
DICT_OK
)

348 
’Œy
 = 
	`diùFšd
(
d
, 
key
);

354 
aux’Œy
 = *
’Œy
;

355 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

356 
	`diùF»eV®
(
d
, &
aux’Œy
);

358 
	}
}

366 
diùEÁry
 *
	$diùR•ÏûRaw
(
diù
 *
d
, *
key
) {

367 
diùEÁry
 *
’Œy
 = 
	`diùFšd
(
d
,
key
);

369  
’Œy
 ?ƒÁry : 
	`diùAddRaw
(
d
,
key
);

370 
	}
}

373 
	$diùG’”icD–‘e
(
diù
 *
d
, cÚ¡ *
key
, 
noä“
)

375 
h
, 
idx
;

376 
diùEÁry
 *
he
, *
´evHe
;

377 
bË
;

379 ià(
d
->
ht
[0].
size
 =ğ0è 
DICT_ERR
;

380 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

381 
h
 = 
	`diùHashKey
(
d
, 
key
);

383 
bË
 = 0;able <= 1;able++) {

384 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

385 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

386 
´evHe
 = 
NULL
;

387 
he
) {

388 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key)) {

390 ià(
´evHe
)

391 
´evHe
->
Ãxt
 = 
he
->next;

393 
d
->
ht
[
bË
].bË[
idx
] = 
he
->
Ãxt
;

394 ià(!
noä“
) {

395 
	`diùF»eKey
(
d
, 
he
);

396 
	`diùF»eV®
(
d
, 
he
);

398 
	`dä“
(
he
);

399 
d
->
ht
[
bË
].
u£d
--;

400  
DICT_OK
;

402 
´evHe
 = 
he
;

403 
he
 = he->
Ãxt
;

405 ià(!
	`diùIsRehashšg
(
d
)) ;

407  
DICT_ERR
;

408 
	}
}

410 
	$diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
) {

411  
	`diùG’”icD–‘e
(
ht
,
key
,0);

412 
	}
}

414 
	$diùD–‘eNoF»e
(
diù
 *
ht
, cÚ¡ *
key
) {

415  
	`diùG’”icD–‘e
(
ht
,
key
,1);

416 
	}
}

419 
_diùCË¬
(
diù
 *
d
, 
diùht
 *
ht
, (
ÿÎback
)(*)) {

420 
i
;

423 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

424 
diùEÁry
 *
he
, *
ÃxtHe
;

426 ià(
ÿÎback
 && (
i
 & 65535è=ğ0è
	`ÿÎback
(
d
->
´ivd©a
);

428 ià((
he
 = 
ht
->
bË
[
i
]è=ğ
NULL
) ;

429 
he
) {

430 
ÃxtHe
 = 
he
->
Ãxt
;

431 
	`diùF»eKey
(
d
, 
he
);

432 
	`diùF»eV®
(
d
, 
he
);

433 
	`dä“
(
he
);

434 
ht
->
u£d
--;

435 
he
 = 
ÃxtHe
;

439 if(
ht
->
bË
è
	`dä“
(ht->table);

441 
	`_diùRe£t
(
ht
);

442  
DICT_OK
;

443 
	}
}

446 
	$diùR–—£
(
diù
 *
d
)

448 
	`_diùCË¬
(
d
,&d->
ht
[0],
NULL
);

449 
	`_diùCË¬
(
d
,&d->
ht
[1],
NULL
);

450 
	`dä“
(
d
);

451 
	}
}

453 
diùEÁry
 *
	$diùFšd
(
diù
 *
d
, cÚ¡ *
key
)

455 
diùEÁry
 *
he
;

456 
h
, 
idx
, 
bË
;

458 ià(
d
->
ht
[0].
u£d
 + d->ht[1].u£d =ğ0è 
NULL
;

460 
h
 = 
	`diùHashKey
(
d
, 
key
);

461 
bË
 = 0;able <= 1;able++) {

462 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

463 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

464 
he
) {

465 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

466  
he
;

467 
he
 = he->
Ãxt
;

469 ià(!
	`diùIsRehashšg
(
d
)è 
NULL
;

471  
NULL
;

472 
	}
}

474 *
	$diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
) {

475 
diùEÁry
 *
he
;

477 
he
 = 
	`diùFšd
(
d
,
key
);

478  
he
 ? 
	`diùG‘V®
(heè: 
NULL
;

479 
	}
}

487 
	$diùFšg”´št
(
diù
 *
d
) {

488 
š‹g”s
[6], 
hash
 = 0;

489 
j
;

491 
š‹g”s
[0] = (è
d
->
ht
[0].
bË
;

492 
š‹g”s
[1] = 
d
->
ht
[0].
size
;

493 
š‹g”s
[2] = 
d
->
ht
[0].
u£d
;

494 
š‹g”s
[3] = (è
d
->
ht
[1].
bË
;

495 
š‹g”s
[4] = 
d
->
ht
[1].
size
;

496 
š‹g”s
[5] = 
d
->
ht
[1].
u£d
;

505 
j
 = 0; j < 6; j++) {

506 
hash
 +ğ
š‹g”s
[
j
];

508 
hash
 = (~hash) + (hash << 21);

509 
hash
 = hash ^ (hash >> 24);

510 
hash
 = (hash + (hash << 3)) + (hash << 8);

511 
hash
 = hash ^ (hash >> 14);

512 
hash
 = (hash + (hash << 2)) + (hash << 4);

513 
hash
 = hash ^ (hash >> 28);

514 
hash
 = hash + (hash << 31);

516  
hash
;

517 
	}
}

519 
diùI‹¿tÜ
 *
	$diùG‘I‹¿tÜ
(
diù
 *
d
)

521 
diùI‹¿tÜ
 *
™”
 = 
	`d®loc
((*iter));

523 
™”
->
d
 = d;

524 
™”
->
bË
 = 0;

525 
™”
->
šdex
 = -1;

526 
™”
->
§ã
 = 0;

527 
™”
->
’Œy
 = 
NULL
;

528 
™”
->
ÃxtEÁry
 = 
NULL
;

529  
™”
;

530 
	}
}

532 
diùI‹¿tÜ
 *
	$diùG‘SaãI‹¿tÜ
(
diù
 *
d
) {

533 
diùI‹¿tÜ
 *
i
 = 
	`diùG‘I‹¿tÜ
(
d
);

535 
i
->
§ã
 = 1;

536  
i
;

537 
	}
}

539 
diùEÁry
 *
	$diùNext
(
diùI‹¿tÜ
 *
™”
)

542 ià(
™”
->
’Œy
 =ğ
NULL
) {

543 
diùht
 *
ht
 = &
™”
->
d
->ht[™”->
bË
];

544 ià(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0) {

545 ià(
™”
->
§ã
)

546 
™”
->
d
->
™”©Üs
++;

548 
™”
->
fšg”´št
 = 
	`diùFšg”´št
(™”->
d
);

550 
™”
->
šdex
++;

551 ià(
™”
->
šdex
 >ğ(è
ht
->
size
) {

552 ià(
	`diùIsRehashšg
(
™”
->
d
è&& i‹r->
bË
 == 0) {

553 
™”
->
bË
++;

554 
™”
->
šdex
 = 0;

555 
ht
 = &
™”
->
d
->ht[1];

560 
™”
->
’Œy
 = 
ht
->
bË
[™”->
šdex
];

562 
™”
->
’Œy
 = i‹r->
ÃxtEÁry
;

564 ià(
™”
->
’Œy
) {

567 
™”
->
ÃxtEÁry
 = i‹r->
’Œy
->
Ãxt
;

568  
™”
->
’Œy
;

571  
NULL
;

572 
	}
}

574 
	$diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
)

576 ià(!(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0)) {

577 ià(
™”
->
§ã
) {

578 
™”
->
d
->
™”©Üs
--;

580 
hv
 = 
	`diùFšg”´št
(
™”
->
d
);

581 
	`ASSERT
(
™”
->
fšg”´št
 =ğ
hv
);

584 
	`dä“
(
™”
);

585 
	}
}

589 
diùEÁry
 *
	$diùG‘RªdomKey
(
diù
 *
d
)

591 
diùEÁry
 *
he
, *
Üighe
;

592 
h
;

593 
li¡Ën
, 
li¡–e
;

595 ià(
	`diùSize
(
d
è=ğ0è 
NULL
;

596 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

597 ià(
	`diùIsRehashšg
(
d
)) {

601 
h
 = 
d
->
»hashidx
 + (
	`¿ndom
(è% (d->
ht
[0].
size
 +

602 
d
->
ht
[1].
size
 -

603 
d
->
»hashidx
));

604 
he
 = (
h
 >ğ
d
->
ht
[0].
size
è? d->ht[1].
bË
[h - d->ht[0].size] :

605 
d
->
ht
[0].
bË
[
h
];

606 } 
he
 =ğ
NULL
);

609 
h
 = 
	`¿ndom
(è& 
d
->
ht
[0].
sizemask
;

610 
he
 = 
d
->
ht
[0].
bË
[
h
];

611 } 
he
 =ğ
NULL
);

618 
li¡Ën
 = 0;

619 
Üighe
 = 
he
;

620 
he
) {

621 
he
 = he->
Ãxt
;

622 
li¡Ën
++;

624 
li¡–e
 = 
	`¿ndom
(è% 
li¡Ën
;

625 
he
 = 
Üighe
;

626 
li¡–e
--è
he
 = he->
Ãxt
;

627  
he
;

628 
	}
}

652 
	$diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
) {

653 
j
;

654 
bËs
;

655 
¡Üed
 = 0, 
maxsizemask
;

656 
max¡•s
;

658 ià(
	`diùSize
(
d
è< 
couÁ
) count = dictSize(d);

659 
max¡•s
 = 
couÁ
*10;

662 
j
 = 0; j < 
couÁ
; j++) {

663 ià(
	`diùIsRehashšg
(
d
))

664 
	`_diùRehashS‹p
(
d
);

669 
bËs
 = 
	`diùIsRehashšg
(
d
) ? 2 : 1;

670 
maxsizemask
 = 
d
->
ht
[0].
sizemask
;

671 ià(
bËs
 > 1 && 
maxsizemask
 < 
d
->
ht
[1].
sizemask
)

672 
maxsizemask
 = 
d
->
ht
[1].
sizemask
;

675 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

676 
em±yËn
 = 0;

677 
¡Üed
 < 
couÁ
 && 
max¡•s
--) {

678 
j
 = 0; j < 
bËs
; j++) {

682 ià(
bËs
 =ğ2 && 
j
 =ğ0 && 
i
 < (è
d
->
»hashidx
) {

687 ià(
i
 >ğ
d
->
ht
[1].
size
è˜ğd->
»hashidx
;

690 ià(
i
 >ğ
d
->
ht
[
j
].
size
) ;

691 
diùEÁry
 *
he
 = 
d
->
ht
[
j
].
bË
[
i
];

695 ià(
he
 =ğ
NULL
) {

696 
em±yËn
++;

697 ià(
em±yËn
 >ğ5 &&ƒm±yËÀ> 
couÁ
) {

698 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

699 
em±yËn
 = 0;

702 
em±yËn
 = 0;

703 
he
) {

706 *
des
 = 
he
;

707 
des
++;

708 
he
 = he->
Ãxt
;

709 
¡Üed
++;

710 ià(
¡Üed
 =ğ
couÁ
)  stored;

714 
i
 = (i+1è& 
maxsizemask
;

716  
¡Üed
;

717 
	}
}

721 
	$»v
(
v
) {

722 
s
 = 8 * (
v
);

723 
mask
 = ~0;

724 (
s
 >>= 1) > 0) {

725 
mask
 ^ğ(mask << 
s
);

726 
v
 = ((v >> 
s
è& 
mask
) | ((v << s) & ~mask);

728  
v
;

729 
	}
}

815 
	$diùSÿn
(
diù
 *
d
,

816 
v
,

817 
diùSÿnFunùiÚ
 *
â
,

818 *
´ivd©a
)

820 
diùht
 *
t0
, *
t1
;

821 cÚ¡ 
diùEÁry
 *
de
;

822 
m0
, 
m1
;

824 ià(
	`diùSize
(
d
) == 0)  0;

826 ià(!
	`diùIsRehashšg
(
d
)) {

827 
t0
 = &(
d
->
ht
[0]);

828 
m0
 = 
t0
->
sizemask
;

831 
de
 = 
t0
->
bË
[
v
 & 
m0
];

832 
de
) {

833 
	`â
(
´ivd©a
, 
de
);

834 
de
 = de->
Ãxt
;

838 
t0
 = &
d
->
ht
[0];

839 
t1
 = &
d
->
ht
[1];

842 ià(
t0
->
size
 > 
t1
->size) {

843 
t0
 = &
d
->
ht
[1];

844 
t1
 = &
d
->
ht
[0];

847 
m0
 = 
t0
->
sizemask
;

848 
m1
 = 
t1
->
sizemask
;

851 
de
 = 
t0
->
bË
[
v
 & 
m0
];

852 
de
) {

853 
	`â
(
´ivd©a
, 
de
);

854 
de
 = de->
Ãxt
;

861 
de
 = 
t1
->
bË
[
v
 & 
m1
];

862 
de
) {

863 
	`â
(
´ivd©a
, 
de
);

864 
de
 = de->
Ãxt
;

868 
v
 = (((v | 
m0
) + 1) & ~m0) | (v & m0);

871 } 
v
 & (
m0
 ^ 
m1
));

876 
v
 |ğ~
m0
;

879 
v
 = 
	`»v
(v);

880 
v
++;

881 
v
 = 
	`»v
(v);

883  
v
;

884 
	}
}

889 
	$_diùEx·ndIfN“ded
(
diù
 *
d
)

892 ià(
	`diùIsRehashšg
(
d
)è 
DICT_OK
;

895 ià(
d
->
ht
[0].
size
 =ğ0è 
	`diùEx·nd
(d, 
DICT_HT_INITIAL_SIZE
);

901 ià(
d
->
ht
[0].
u£d
 >ğd->ht[0].
size
 &&

902 (
diù_ÿn_»size
 ||

903 
d
->
ht
[0].
u£d
/d->ht[0].
size
 > 
diù_fÜû_»size_¿tio
))

905  
	`diùEx·nd
(
d
, d->
ht
[0].
u£d
*2);

907  
DICT_OK
;

908 
	}
}

911 
	$_diùNextPow”
(
size
)

913 
i
 = 
DICT_HT_INITIAL_SIZE
;

915 ià(
size
 >ğ
LONG_MAX
)  LONG_MAX;

917 ià(
i
 >ğ
size
)

918  
i
;

919 
i
 *= 2;

921 
	}
}

929 
	$_diùKeyIndex
(
diù
 *
d
, cÚ¡ *
key
)

931 
h
, 
idx
, 
bË
;

932 
diùEÁry
 *
he
;

935 ià(
	`_diùEx·ndIfN“ded
(
d
è=ğ
DICT_ERR
)

938 
h
 = 
	`diùHashKey
(
d
, 
key
);

939 
bË
 = 0;able <= 1;able++) {

940 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

942 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

943 
he
) {

944 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

946 
he
 = he->
Ãxt
;

948 ià(!
	`diùIsRehashšg
(
d
)) ;

950  
idx
;

951 
	}
}

953 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*)) {

954 
	`_diùCË¬
(
d
,&d->
ht
[0],
ÿÎback
);

955 
	`_diùCË¬
(
d
,&d->
ht
[1],
ÿÎback
);

956 
d
->
»hashidx
 = -1;

957 
d
->
™”©Üs
 = 0;

958 
	}
}

960 
	$diùEÇbËResize
() {

961 
diù_ÿn_»size
 = 1;

962 
	}
}

964 
	$diùDi§bËResize
() {

965 
diù_ÿn_»size
 = 0;

966 
	}
}

970 
	#DICT_STATS_VECTLEN
 50

	)

971 
size_t
 
	$_diùG‘StsHt
(*
buf
, 
size_t
 
bufsize
, 
diùht
 *
ht
, 
bËid
) {

972 
i
, 
¦Ùs
 = 0, 
chašËn
, 
maxchašËn
 = 0;

973 
tÙchašËn
 = 0;

974 
şveùÜ
[
DICT_STATS_VECTLEN
];

975 
size_t
 
l
 = 0;

977 ià(
ht
->
u£d
 == 0) {

978  
	`¢´štf
(
buf
,
bufsize
,

983 
i
 = 0; i < 
DICT_STATS_VECTLEN
; i++è
şveùÜ
[i] = 0;

984 
i
 = 0; i < 
ht
->
size
; i++) {

985 
diùEÁry
 *
he
;

987 ià(
ht
->
bË
[
i
] =ğ
NULL
) {

988 
şveùÜ
[0]++;

991 
¦Ùs
++;

993 
chašËn
 = 0;

994 
he
 = 
ht
->
bË
[
i
];

995 
he
) {

996 
chašËn
++;

997 
he
 = he->
Ãxt
;

999 
şveùÜ
[(
chašËn
 < 
DICT_STATS_VECTLEN
) ? chainlen : (DICT_STATS_VECTLEN-1)]++;

1000 ià(
chašËn
 > 
maxchašËn
) maxchainlen = chainlen;

1001 
tÙchašËn
 +ğ
chašËn
;

1005 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1014 
bËid
, (tableid == 0) ? "main hashable" : "rehashingarget",

1015 
ht
->
size
, ht->
u£d
, 
¦Ùs
, 
maxchašËn
,

1016 ()
tÙchašËn
/
¦Ùs
, ()
ht
->
u£d
/slots);

1018 
i
 = 0; i < 
DICT_STATS_VECTLEN
-1; i++) {

1019 ià(
şveùÜ
[
i
] == 0) ;

1020 ià(
l
 >ğ
bufsize
) ;

1021 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1023 (
i
 =ğ
DICT_STATS_VECTLEN
-1)?">= ":"",

1024 
i
, 
şveùÜ
[i], (()şveùÜ[i]/
ht
->
size
)*100);

1028 ià(
bufsize
è
buf
[bufsize-1] = '\0';

1029  
	`¡¾’
(
buf
);

1030 
	}
}

1032 
	$diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
) {

1033 
size_t
 
l
;

1034 *
Üig_buf
 = 
buf
;

1035 
size_t
 
Üig_bufsize
 = 
bufsize
;

1037 
l
 = 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[0],0);

1038 
buf
 +ğ
l
;

1039 
bufsize
 -ğ
l
;

1040 ià(
	`diùIsRehashšg
(
d
è&& 
bufsize
 > 0) {

1041 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[1],1);

1044 ià(
Üig_bufsize
è
Üig_buf
[orig_bufsize-1] = '\0';

1045 
	}
}

	@src/vr_dict.h

1 #iâdeà
_VR_DICT_H_


2 
	#_VR_DICT_H_


	)

4 
	~<¡dšt.h
>

6 
	#DICT_OK
 0

	)

7 
	#DICT_ERR
 1

	)

10 
	#DICT_NOTUSED
(
V
è((èV)

	)

12 
	sdiùEÁry
 {

13 *
	mkey
;

15 *
	mv®
;

16 
ušt64_t
 
	mu64
;

17 
št64_t
 
	ms64
;

18 
	md
;

19 } 
	mv
;

20 
diùEÁry
 *
	mÃxt
;

21 } 
	tdiùEÁry
;

23 
	sdiùTy³
 {

24 (*
	mhashFunùiÚ
)(cÚ¡ *
	mkey
);

25 *(*
	mkeyDup
)(*
	m´ivd©a
, cÚ¡ *
	mkey
);

26 *(*
	mv®Dup
)(*
	m´ivd©a
, cÚ¡ *
	mobj
);

27 (*
	mkeyCom·»
)(*
	m´ivd©a
, cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

28 (*
	mkeyDe¡ruùÜ
)(*
	m´ivd©a
, *
	mkey
);

29 (*
	mv®De¡ruùÜ
)(*
	m´ivd©a
, *
	mobj
);

30 } 
	tdiùTy³
;

34 
	sdiùht
 {

35 
diùEÁry
 **
	mbË
;

36 
	msize
;

37 
	msizemask
;

38 
	mu£d
;

39 } 
	tdiùht
;

41 
	sdiù
 {

42 
diùTy³
 *
	mty³
;

43 *
	m´ivd©a
;

44 
diùht
 
	mht
[2];

45 
	m»hashidx
;

46 
	m™”©Üs
;

47 } 
	tdiù
;

53 
	sdiùI‹¿tÜ
 {

54 
diù
 *
	md
;

55 
	mšdex
;

56 
	mbË
, 
	m§ã
;

57 
diùEÁry
 *
	m’Œy
, *
	mÃxtEÁry
;

59 
	mfšg”´št
;

60 } 
	tdiùI‹¿tÜ
;

62 (
	tdiùSÿnFunùiÚ
)(*
	t´ivd©a
, cÚ¡ 
	tdiùEÁry
 *
	tde
);

65 
	#DICT_HT_INITIAL_SIZE
 4

	)

68 
	#diùF»eV®
(
d
, 
’Œy
) \

69 ià((
d
)->
ty³
->
v®De¡ruùÜ
) \

70 (
d
)->
ty³
->
	`v®De¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
v
.
v®
)

	)

72 
	#diùS‘V®
(
d
, 
’Œy
, 
_v®_
) do { \

73 ià((
d
)->
ty³
->
v®Dup
) \

74 
’Œy
->
v
.
v®
 = (
d
)->
ty³
->
	`v®Dup
((d)->
´ivd©a
, 
_v®_
); \

76 
’Œy
->
v
.
v®
 = (
_v®_
); \

77 
	}
} 0)

	)

79 
	#diùS‘SigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

80 dØ{ 
’Œy
->
v
.
s64
 = 
_v®_
; } 0)

	)

82 
	#diùS‘UnsigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

83 dØ{ 
’Œy
->
v
.
u64
 = 
_v®_
; } 0)

	)

85 
	#diùS‘DoubËV®
(
’Œy
, 
_v®_
) \

86 dØ{ 
’Œy
->
v
.
d
 = 
_v®_
; } 0)

	)

88 
	#diùF»eKey
(
d
, 
’Œy
) \

89 ià((
d
)->
ty³
->
keyDe¡ruùÜ
) \

90 (
d
)->
ty³
->
	`keyDe¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
key
)

	)

92 
	#diùS‘Key
(
d
, 
’Œy
, 
_key_
) do { \

93 ià((
d
)->
ty³
->
keyDup
) \

94 
’Œy
->
key
 = (
d
)->
ty³
->
	`keyDup
((d)->
´ivd©a
, 
_key_
); \

96 
’Œy
->
key
 = (
_key_
); \

97 } 0)

	)

99 
	#diùCom·»Keys
(
d
, 
key1
, 
key2
) \

100 (((
d
)->
ty³
->
keyCom·»
) ? \

101 (
d
)->
ty³
->
	`keyCom·»
((d)->
´ivd©a
, 
key1
, 
key2
) : \

102 (
key1
è=ğ(
key2
))

	)

104 
	#diùHashKey
(
d
, 
key
è(d)->
ty³
->
	`hashFunùiÚ
(key)

	)

105 
	#diùG‘Key
(
he
è((he)->
key
)

	)

106 
	#diùG‘V®
(
he
è((he)->
v
.
v®
)

	)

107 
	#diùG‘SigÃdIÁeg”V®
(
he
è((he)->
v
.
s64
)

	)

108 
	#diùG‘UnsigÃdIÁeg”V®
(
he
è((he)->
v
.
u64
)

	)

109 
	#diùG‘DoubËV®
(
he
è((he)->
v
.
d
)

	)

110 
	#diùSlÙs
(
d
è((d)->
ht
[0].
size
+(d)->ht[1].size)

	)

111 
	#diùSize
(
d
è((d)->
ht
[0].
u£d
+(d)->ht[1].u£d)

	)

112 
	#diùIsRehashšg
(
d
è((d)->
»hashidx
 !ğ-1)

	)

115 
diù
 *
diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

116 
diùEx·nd
(
diù
 *
d
, 
size
);

117 
diùAdd
(
diù
 *
d
, *
key
, *
v®
);

118 
diùEÁry
 *
diùAddRaw
(
diù
 *
d
, *
key
);

119 
diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
);

120 
diùEÁry
 *
diùR•ÏûRaw
(
diù
 *
d
, *
key
);

121 
diùD–‘e
(
diù
 *
d
, cÚ¡ *
key
);

122 
diùD–‘eNoF»e
(
diù
 *
d
, cÚ¡ *
key
);

123 
diùR–—£
(
diù
 *
d
);

124 
diùEÁry
 * 
diùFšd
(
diù
 *
d
, cÚ¡ *
key
);

125 *
diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
);

126 
diùResize
(
diù
 *
d
);

127 
diùI‹¿tÜ
 *
diùG‘I‹¿tÜ
(
diù
 *
d
);

128 
diùI‹¿tÜ
 *
diùG‘SaãI‹¿tÜ
(
diù
 *
d
);

129 
diùEÁry
 *
diùNext
(
diùI‹¿tÜ
 *
™”
);

130 
diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
);

131 
diùEÁry
 *
diùG‘RªdomKey
(
diù
 *
d
);

132 
diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
);

133 
diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
);

134 
diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
);

135 
diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
);

136 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*));

137 
	`diùEÇbËResize
();

138 
	`diùDi§bËResize
();

139 
	`diùRehash
(
diù
 *
d
, 
n
);

140 
	`diùRehashMli£cÚds
(
diù
 *
d
, 
ms
);

141 
	`diùS‘HashFunùiÚS“d
(
š™v®
);

142 
	`diùG‘HashFunùiÚS“d
();

143 
	`diùSÿn
(
diù
 *
d
, 
v
, 
diùSÿnFunùiÚ
 *
â
, *
´ivd©a
);

146 
diùTy³
 
diùTy³H—pSŒšgCİyKey
;

147 
diùTy³
 
diùTy³H—pSŒšgs
;

148 
diùTy³
 
diùTy³H—pSŒšgCİyKeyV®ue
;

	@src/vr_dict.h

1 #iâdeà
_VR_DICT_H_


2 
	#_VR_DICT_H_


	)

4 
	~<¡dšt.h
>

6 
	#DICT_OK
 0

	)

7 
	#DICT_ERR
 1

	)

10 
	#DICT_NOTUSED
(
V
è((èV)

	)

12 
	sdiùEÁry
 {

13 *
	mkey
;

15 *
	mv®
;

16 
ušt64_t
 
	mu64
;

17 
št64_t
 
	ms64
;

18 
	md
;

19 } 
	mv
;

20 
diùEÁry
 *
	mÃxt
;

21 } 
	tdiùEÁry
;

23 
	sdiùTy³
 {

24 (*
	mhashFunùiÚ
)(cÚ¡ *
	mkey
);

25 *(*
	mkeyDup
)(*
	m´ivd©a
, cÚ¡ *
	mkey
);

26 *(*
	mv®Dup
)(*
	m´ivd©a
, cÚ¡ *
	mobj
);

27 (*
	mkeyCom·»
)(*
	m´ivd©a
, cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

28 (*
	mkeyDe¡ruùÜ
)(*
	m´ivd©a
, *
	mkey
);

29 (*
	mv®De¡ruùÜ
)(*
	m´ivd©a
, *
	mobj
);

30 } 
	tdiùTy³
;

34 
	sdiùht
 {

35 
diùEÁry
 **
	mbË
;

36 
	msize
;

37 
	msizemask
;

38 
	mu£d
;

39 } 
	tdiùht
;

41 
	sdiù
 {

42 
diùTy³
 *
	mty³
;

43 *
	m´ivd©a
;

44 
diùht
 
	mht
[2];

45 
	m»hashidx
;

46 
	m™”©Üs
;

47 } 
	tdiù
;

53 
	sdiùI‹¿tÜ
 {

54 
diù
 *
	md
;

55 
	mšdex
;

56 
	mbË
, 
	m§ã
;

57 
diùEÁry
 *
	m’Œy
, *
	mÃxtEÁry
;

59 
	mfšg”´št
;

60 } 
	tdiùI‹¿tÜ
;

62 (
	tdiùSÿnFunùiÚ
)(*
	t´ivd©a
, cÚ¡ 
	tdiùEÁry
 *
	tde
);

65 
	#DICT_HT_INITIAL_SIZE
 4

	)

68 
	#diùF»eV®
(
d
, 
’Œy
) \

69 ià((
d
)->
ty³
->
v®De¡ruùÜ
) \

70 (
d
)->
ty³
->
	`v®De¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
v
.
v®
)

	)

72 
	#diùS‘V®
(
d
, 
’Œy
, 
_v®_
) do { \

73 ià((
d
)->
ty³
->
v®Dup
) \

74 
’Œy
->
v
.
v®
 = (
d
)->
ty³
->
	`v®Dup
((d)->
´ivd©a
, 
_v®_
); \

76 
’Œy
->
v
.
v®
 = (
_v®_
); \

77 
	}
} 0)

	)

79 
	#diùS‘SigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

80 dØ{ 
’Œy
->
v
.
s64
 = 
_v®_
; } 0)

	)

82 
	#diùS‘UnsigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

83 dØ{ 
’Œy
->
v
.
u64
 = 
_v®_
; } 0)

	)

85 
	#diùS‘DoubËV®
(
’Œy
, 
_v®_
) \

86 dØ{ 
’Œy
->
v
.
d
 = 
_v®_
; } 0)

	)

88 
	#diùF»eKey
(
d
, 
’Œy
) \

89 ià((
d
)->
ty³
->
keyDe¡ruùÜ
) \

90 (
d
)->
ty³
->
	`keyDe¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
key
)

	)

92 
	#diùS‘Key
(
d
, 
’Œy
, 
_key_
) do { \

93 ià((
d
)->
ty³
->
keyDup
) \

94 
’Œy
->
key
 = (
d
)->
ty³
->
	`keyDup
((d)->
´ivd©a
, 
_key_
); \

96 
’Œy
->
key
 = (
_key_
); \

97 } 0)

	)

99 
	#diùCom·»Keys
(
d
, 
key1
, 
key2
) \

100 (((
d
)->
ty³
->
keyCom·»
) ? \

101 (
d
)->
ty³
->
	`keyCom·»
((d)->
´ivd©a
, 
key1
, 
key2
) : \

102 (
key1
è=ğ(
key2
))

	)

104 
	#diùHashKey
(
d
, 
key
è(d)->
ty³
->
	`hashFunùiÚ
(key)

	)

105 
	#diùG‘Key
(
he
è((he)->
key
)

	)

106 
	#diùG‘V®
(
he
è((he)->
v
.
v®
)

	)

107 
	#diùG‘SigÃdIÁeg”V®
(
he
è((he)->
v
.
s64
)

	)

108 
	#diùG‘UnsigÃdIÁeg”V®
(
he
è((he)->
v
.
u64
)

	)

109 
	#diùG‘DoubËV®
(
he
è((he)->
v
.
d
)

	)

110 
	#diùSlÙs
(
d
è((d)->
ht
[0].
size
+(d)->ht[1].size)

	)

111 
	#diùSize
(
d
è((d)->
ht
[0].
u£d
+(d)->ht[1].u£d)

	)

112 
	#diùIsRehashšg
(
d
è((d)->
»hashidx
 !ğ-1)

	)

115 
diù
 *
diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

116 
diùEx·nd
(
diù
 *
d
, 
size
);

117 
diùAdd
(
diù
 *
d
, *
key
, *
v®
);

118 
diùEÁry
 *
diùAddRaw
(
diù
 *
d
, *
key
);

119 
diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
);

120 
diùEÁry
 *
diùR•ÏûRaw
(
diù
 *
d
, *
key
);

121 
diùD–‘e
(
diù
 *
d
, cÚ¡ *
key
);

122 
diùD–‘eNoF»e
(
diù
 *
d
, cÚ¡ *
key
);

123 
diùR–—£
(
diù
 *
d
);

124 
diùEÁry
 * 
diùFšd
(
diù
 *
d
, cÚ¡ *
key
);

125 *
diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
);

126 
diùResize
(
diù
 *
d
);

127 
diùI‹¿tÜ
 *
diùG‘I‹¿tÜ
(
diù
 *
d
);

128 
diùI‹¿tÜ
 *
diùG‘SaãI‹¿tÜ
(
diù
 *
d
);

129 
diùEÁry
 *
diùNext
(
diùI‹¿tÜ
 *
™”
);

130 
diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
);

131 
diùEÁry
 *
diùG‘RªdomKey
(
diù
 *
d
);

132 
diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
);

133 
diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
);

134 
diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
);

135 
diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
);

136 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*));

137 
	`diùEÇbËResize
();

138 
	`diùDi§bËResize
();

139 
	`diùRehash
(
diù
 *
d
, 
n
);

140 
	`diùRehashMli£cÚds
(
diù
 *
d
, 
ms
);

141 
	`diùS‘HashFunùiÚS“d
(
š™v®
);

142 
	`diùG‘HashFunùiÚS“d
();

143 
	`diùSÿn
(
diù
 *
d
, 
v
, 
diùSÿnFunùiÚ
 *
â
, *
´ivd©a
);

146 
diùTy³
 
diùTy³H—pSŒšgCİyKey
;

147 
diùTy³
 
diùTy³H—pSŒšgs
;

148 
diùTy³
 
diùTy³H—pSŒšgCİyKeyV®ue
;

	@src/vr_eventloop.c

1 
	~<vr_cÜe.h
>

5 
	$vr_ev’oİ_š™
(
vr_ev’oİ
 *
v–
, 
f–im™
)

7 
r¡©us_t
 
¡©us
;

8 
maxş›Ás
, 
th»ads_num
;

10 ià(
v–
 =ğ
NULL
 || 
f–im™
 <= 0) {

11  
VR_ERROR
;

14 
	`vr_th»ad_š™
(&
v–
->
th»ad
);

16 
v–
->
–
 = 
NULL
;

17 
v–
->
hz
 = 10;

18 
v–
->
üÚloİs
 = 0;

19 
v–
->
unixtime
 = 
	`time
(
NULL
);

20 
v–
->
m¡ime
 = 
	`vr_m£c_now
();

21 
v–
->
Ìuşock
 = 
	`g‘LRUClock
();

22 
v–
->
cb
 = 
NULL
;

23 
v–
->
Ãxt_ş›Á_id
 = 1;

24 
v–
->
cu¼’t_ş›Á
 = 
NULL
;

25 
v–
->
ş›Ás
 = 
NULL
;

26 
v–
->
ş›Ás_³ndšg_wr™e
 = 
NULL
;

27 
v–
->
ş›Ás_to_şo£
 = 
NULL
;

28 
v–
->
ş›Ás_·u£d
 = 0;

29 
v–
->
ş›Ás_·u£_’d_time
 = 0;

30 
v–
->
¡©s
 = 
NULL
;

31 
v–
->
»sid’t_£t_size
 = 0;

32 
v–
->
dœty
 = 0;

33 
v–
->
bpİ_blocked_ş›Ás
 = 0;

34 
v–
->
unblocked_ş›Ás
 = 
NULL
;

35 
v–
->
ş›Ás_wa™šg_acks
 = 
NULL
;

36 
v–
->
pubsub_chªÃls
 = 
NULL
;

37 
v–
->
pubsub_·‰”ns
 = 
NULL
;

38 
v–
->
nÙify_key¥aû_ev’ts
 = 0;

39 
v–
->
c¡abË
 = 
NULL
;

41 
v–
->
–
 = 
	`«C»©eEv’tLoİ
(
f–im™
);

42 ià(
v–
->
–
 =ğ
NULL
) {

43 
	`log_”rÜ
("createƒventloop failed.");

44  
VR_ERROR
;

47 
v–
->
cb
 = 
	`d®loc
((
cÚn_ba£
));

48 ià(
v–
->
cb
 =ğ
NULL
) {

49 
	`log_”rÜ
("create conn_base failed: out of memory");

50  
VR_ENOMEM
;

52 
¡©us
 = 
	`cÚn_š™
(
v–
->
cb
);

53 ià(
¡©us
 !ğ
VR_OK
) {

54 
	`log_”rÜ
("init conn_base failed");

55  
VR_ERROR
;

58 
v–
->
ş›Ás
 = 
	`dli¡C»©e
();

59 ià(
v–
->
ş›Ás
 =ğ
NULL
) {

60 
	`log_”rÜ
("create†ist failed: out of memory");

61  
VR_ENOMEM
;

64 
v–
->
ş›Ás_³ndšg_wr™e
 = 
	`dli¡C»©e
();

65 ià(
v–
->
ş›Ás_³ndšg_wr™e
 =ğ
NULL
) {

66 
	`log_”rÜ
("create†ist failed: out of memory");

67  
VR_ENOMEM
;

70 
v–
->
ş›Ás_to_şo£
 = 
	`dli¡C»©e
();

71 ià(
v–
->
ş›Ás_to_şo£
 =ğ
NULL
) {

72 
	`log_”rÜ
("create†ist failed: out of memory");

73  
VR_ENOMEM
;

76 
v–
->
unblocked_ş›Ás
 = 
	`dli¡C»©e
();

77 ià(
v–
->
unblocked_ş›Ás
 =ğ
NULL
) {

78 
	`log_”rÜ
("create†ist failed: out of memory");

79  
VR_ENOMEM
;

82 
v–
->
¡©s
 = 
	`d®loc
((
vr_¡©s
));

83 ià(
v–
->
¡©s
 =ğ
NULL
) {

84 
	`log_”rÜ
("out of memory");

85  
VR_ENOMEM
;

88 
	`vr_¡©s_š™
(
v–
->
¡©s
);

90 
	`cÚf_ÿche_š™
(&
v–
->
cc
);

92  
VR_OK
;

93 
	}
}

96 
	$vr_ev’oİ_deš™
(
vr_ev’oİ
 *
v–
)

98 ià(
v–
 =ğ
NULL
) {

102 
	`vr_th»ad_deš™
(&
v–
->
th»ad
);

104 ià(
v–
->
–
 !ğ
NULL
) {

105 
	`«D–‘eEv’tLoİ
(
v–
->
–
);

106 
v–
->
–
 = 
NULL
;

109 ià(
v–
->
ş›Ás
 !ğ
NULL
) {

110 
ş›Á
 *
c
;

111 
c
 = 
	`dli¡Pİ
(
v–
->
ş›Ás
)) {

112 
	`ä“Cl›Á
(
c
);

114 
	`dli¡R–—£
(
v–
->
ş›Ás
);

115 
v–
->
ş›Ás
 = 
NULL
;

118 ià(
v–
->
ş›Ás_³ndšg_wr™e
 !ğ
NULL
) {

119 
ş›Á
 *
c
;

120 
c
 = 
	`dli¡Pİ
(
v–
->
ş›Ás_³ndšg_wr™e
)) {}

121 
	`dli¡R–—£
(
v–
->
ş›Ás_³ndšg_wr™e
);

122 
v–
->
ş›Ás_³ndšg_wr™e
 = 
NULL
;

125 ià(
v–
->
ş›Ás_to_şo£
 !ğ
NULL
) {

126 
ş›Á
 *
c
;

127 
c
 = 
	`dli¡Pİ
(
v–
->
ş›Ás_to_şo£
)) {

128 
	`ä“Cl›Á
(
c
);

130 
	`dli¡R–—£
(
v–
->
ş›Ás_to_şo£
);

131 
v–
->
ş›Ás_to_şo£
 = 
NULL
;

134 ià(
v–
->
unblocked_ş›Ás
 !ğ
NULL
) {

135 
ş›Á
 *
c
;

136 
c
 = 
	`dli¡Pİ
(
v–
->
unblocked_ş›Ás
)) {}

137 
	`dli¡R–—£
(
v–
->
unblocked_ş›Ás
);

138 
v–
->
unblocked_ş›Ás
 = 
NULL
;

141 ià(
v–
->
cb
 !ğ
NULL
) {

142 
	`cÚn_deš™
(
v–
->
cb
);

143 
	`dä“
(
v–
->
cb
);

144 
v–
->
cb
 = 
NULL
;

147 ià(
v–
->
¡©s
 !ğ
NULL
) {

148 
	`vr_¡©s_deš™
(
v–
->
¡©s
);

149 
	`dä“
(
v–
->
¡©s
);

150 
v–
->
¡©s
 = 
NULL
;

153 ià(
v–
->
c¡abË
 !ğ
NULL
) {

154 
	`commªdStsTabËDe¡roy
(
v–
->
c¡abË
);

155 
v–
->
c¡abË
 = 
NULL
;

158 
	`cÚf_ÿche_deš™
(&
v–
->
cc
);

159 
	}
}

	@src/vr_eventloop.c

1 
	~<vr_cÜe.h
>

5 
	$vr_ev’oİ_š™
(
vr_ev’oİ
 *
v–
, 
f–im™
)

7 
r¡©us_t
 
¡©us
;

8 
maxş›Ás
, 
th»ads_num
;

10 ià(
v–
 =ğ
NULL
 || 
f–im™
 <= 0) {

11  
VR_ERROR
;

14 
	`vr_th»ad_š™
(&
v–
->
th»ad
);

16 
v–
->
–
 = 
NULL
;

17 
v–
->
hz
 = 10;

18 
v–
->
üÚloİs
 = 0;

19 
v–
->
unixtime
 = 
	`time
(
NULL
);

20 
v–
->
m¡ime
 = 
	`vr_m£c_now
();

21 
v–
->
Ìuşock
 = 
	`g‘LRUClock
();

22 
v–
->
cb
 = 
NULL
;

23 
v–
->
Ãxt_ş›Á_id
 = 1;

24 
v–
->
cu¼’t_ş›Á
 = 
NULL
;

25 
v–
->
ş›Ás
 = 
NULL
;

26 
v–
->
ş›Ás_³ndšg_wr™e
 = 
NULL
;

27 
v–
->
ş›Ás_to_şo£
 = 
NULL
;

28 
v–
->
ş›Ás_·u£d
 = 0;

29 
v–
->
ş›Ás_·u£_’d_time
 = 0;

30 
v–
->
¡©s
 = 
NULL
;

31 
v–
->
»sid’t_£t_size
 = 0;

32 
v–
->
dœty
 = 0;

33 
v–
->
bpİ_blocked_ş›Ás
 = 0;

34 
v–
->
unblocked_ş›Ás
 = 
NULL
;

35 
v–
->
ş›Ás_wa™šg_acks
 = 
NULL
;

36 
v–
->
pubsub_chªÃls
 = 
NULL
;

37 
v–
->
pubsub_·‰”ns
 = 
NULL
;

38 
v–
->
nÙify_key¥aû_ev’ts
 = 0;

39 
v–
->
c¡abË
 = 
NULL
;

41 
v–
->
–
 = 
	`«C»©eEv’tLoİ
(
f–im™
);

42 ià(
v–
->
–
 =ğ
NULL
) {

43 
	`log_”rÜ
("createƒventloop failed.");

44  
VR_ERROR
;

47 
v–
->
cb
 = 
	`d®loc
((
cÚn_ba£
));

48 ià(
v–
->
cb
 =ğ
NULL
) {

49 
	`log_”rÜ
("create conn_base failed: out of memory");

50  
VR_ENOMEM
;

52 
¡©us
 = 
	`cÚn_š™
(
v–
->
cb
);

53 ià(
¡©us
 !ğ
VR_OK
) {

54 
	`log_”rÜ
("init conn_base failed");

55  
VR_ERROR
;

58 
v–
->
ş›Ás
 = 
	`dli¡C»©e
();

59 ià(
v–
->
ş›Ás
 =ğ
NULL
) {

60 
	`log_”rÜ
("create†ist failed: out of memory");

61  
VR_ENOMEM
;

64 
v–
->
ş›Ás_³ndšg_wr™e
 = 
	`dli¡C»©e
();

65 ià(
v–
->
ş›Ás_³ndšg_wr™e
 =ğ
NULL
) {

66 
	`log_”rÜ
("create†ist failed: out of memory");

67  
VR_ENOMEM
;

70 
v–
->
ş›Ás_to_şo£
 = 
	`dli¡C»©e
();

71 ià(
v–
->
ş›Ás_to_şo£
 =ğ
NULL
) {

72 
	`log_”rÜ
("create†ist failed: out of memory");

73  
VR_ENOMEM
;

76 
v–
->
unblocked_ş›Ás
 = 
	`dli¡C»©e
();

77 ià(
v–
->
unblocked_ş›Ás
 =ğ
NULL
) {

78 
	`log_”rÜ
("create†ist failed: out of memory");

79  
VR_ENOMEM
;

82 
v–
->
¡©s
 = 
	`d®loc
((
vr_¡©s
));

83 ià(
v–
->
¡©s
 =ğ
NULL
) {

84 
	`log_”rÜ
("out of memory");

85  
VR_ENOMEM
;

88 
	`vr_¡©s_š™
(
v–
->
¡©s
);

90 
	`cÚf_ÿche_š™
(&
v–
->
cc
);

92  
VR_OK
;

93 
	}
}

96 
	$vr_ev’oİ_deš™
(
vr_ev’oİ
 *
v–
)

98 ià(
v–
 =ğ
NULL
) {

102 
	`vr_th»ad_deš™
(&
v–
->
th»ad
);

104 ià(
v–
->
–
 !ğ
NULL
) {

105 
	`«D–‘eEv’tLoİ
(
v–
->
–
);

106 
v–
->
–
 = 
NULL
;

109 ià(
v–
->
ş›Ás
 !ğ
NULL
) {

110 
ş›Á
 *
c
;

111 
c
 = 
	`dli¡Pİ
(
v–
->
ş›Ás
)) {

112 
	`ä“Cl›Á
(
c
);

114 
	`dli¡R–—£
(
v–
->
ş›Ás
);

115 
v–
->
ş›Ás
 = 
NULL
;

118 ià(
v–
->
ş›Ás_³ndšg_wr™e
 !ğ
NULL
) {

119 
ş›Á
 *
c
;

120 
c
 = 
	`dli¡Pİ
(
v–
->
ş›Ás_³ndšg_wr™e
)) {}

121 
	`dli¡R–—£
(
v–
->
ş›Ás_³ndšg_wr™e
);

122 
v–
->
ş›Ás_³ndšg_wr™e
 = 
NULL
;

125 ià(
v–
->
ş›Ás_to_şo£
 !ğ
NULL
) {

126 
ş›Á
 *
c
;

127 
c
 = 
	`dli¡Pİ
(
v–
->
ş›Ás_to_şo£
)) {

128 
	`ä“Cl›Á
(
c
);

130 
	`dli¡R–—£
(
v–
->
ş›Ás_to_şo£
);

131 
v–
->
ş›Ás_to_şo£
 = 
NULL
;

134 ià(
v–
->
unblocked_ş›Ás
 !ğ
NULL
) {

135 
ş›Á
 *
c
;

136 
c
 = 
	`dli¡Pİ
(
v–
->
unblocked_ş›Ás
)) {}

137 
	`dli¡R–—£
(
v–
->
unblocked_ş›Ás
);

138 
v–
->
unblocked_ş›Ás
 = 
NULL
;

141 ià(
v–
->
cb
 !ğ
NULL
) {

142 
	`cÚn_deš™
(
v–
->
cb
);

143 
	`dä“
(
v–
->
cb
);

144 
v–
->
cb
 = 
NULL
;

147 ià(
v–
->
¡©s
 !ğ
NULL
) {

148 
	`vr_¡©s_deš™
(
v–
->
¡©s
);

149 
	`dä“
(
v–
->
¡©s
);

150 
v–
->
¡©s
 = 
NULL
;

153 ià(
v–
->
c¡abË
 !ğ
NULL
) {

154 
	`commªdStsTabËDe¡roy
(
v–
->
c¡abË
);

155 
v–
->
c¡abË
 = 
NULL
;

158 
	`cÚf_ÿche_deš™
(&
v–
->
cc
);

159 
	}
}

	@src/vr_eventloop.h

1 #iâdeà
_VR_EVENTLOOP_H_


2 
	#_VR_EVENTLOOP_H_


	)

4 
	svr_ev’oİ
 {

6 
vr_th»ad
 
	mth»ad
;

9 
«Ev’tLoİ
 *
	m–
;

11 
	mhz
;

13 
	müÚloİs
;

18 
time_t
 
	munixtime
;

20 
	mm¡ime
;

23 
	mÌuşock
:
LRU_BITS
;

26 
cÚn_ba£
 *
	mcb
;

29 
ušt64_t
 
	mÃxt_ş›Á_id
;

31 
ş›Á
 *
	mcu¼’t_ş›Á
;

33 
dli¡
 *
	mş›Ás
;

36 
dli¡
 *
	mş›Ás_³ndšg_wr™e
;

38 
dli¡
 *
	mş›Ás_to_şo£
;

41 
	mş›Ás_·u£d
;

43 
	mş›Ás_·u£_’d_time
;

46 
vr_¡©s
 *
	m¡©s
;

48 
size_t
 
	m»sid’t_£t_size
;

51 
	mdœty
;

54 
	mbpİ_blocked_ş›Ás
;

56 
dli¡
 *
	munblocked_ş›Ás
;

60 
dli¡
 *
	mş›Ás_wa™šg_acks
;

64 
diù
 *
	mpubsub_chªÃls
;

66 
dli¡
 *
	mpubsub_·‰”ns
;

68 
	mnÙify_key¥aû_ev’ts
;

72 
cÚf_ÿche
 
	mcc
;

75 
d¬¿y
 *
	mc¡abË
;

76 }
	tvr_ev’oİ
;

78 
vr_ev’oİ_š™
(
vr_ev’oİ
 *
v–
, 
f–im™
);

79 
vr_ev’oİ_deš™
(
vr_ev’oİ
 *
v–
);

	@src/vr_eventloop.h

1 #iâdeà
_VR_EVENTLOOP_H_


2 
	#_VR_EVENTLOOP_H_


	)

4 
	svr_ev’oİ
 {

6 
vr_th»ad
 
	mth»ad
;

9 
«Ev’tLoİ
 *
	m–
;

11 
	mhz
;

13 
	müÚloİs
;

18 
time_t
 
	munixtime
;

20 
	mm¡ime
;

23 
	mÌuşock
:
LRU_BITS
;

26 
cÚn_ba£
 *
	mcb
;

29 
ušt64_t
 
	mÃxt_ş›Á_id
;

31 
ş›Á
 *
	mcu¼’t_ş›Á
;

33 
dli¡
 *
	mş›Ás
;

36 
dli¡
 *
	mş›Ás_³ndšg_wr™e
;

38 
dli¡
 *
	mş›Ás_to_şo£
;

41 
	mş›Ás_·u£d
;

43 
	mş›Ás_·u£_’d_time
;

46 
vr_¡©s
 *
	m¡©s
;

48 
size_t
 
	m»sid’t_£t_size
;

51 
	mdœty
;

54 
	mbpİ_blocked_ş›Ás
;

56 
dli¡
 *
	munblocked_ş›Ás
;

60 
dli¡
 *
	mş›Ás_wa™šg_acks
;

64 
diù
 *
	mpubsub_chªÃls
;

66 
dli¡
 *
	mpubsub_·‰”ns
;

68 
	mnÙify_key¥aû_ev’ts
;

72 
cÚf_ÿche
 
	mcc
;

75 
d¬¿y
 *
	mc¡abË
;

76 }
	tvr_ev’oİ
;

78 
vr_ev’oİ_š™
(
vr_ev’oİ
 *
v–
, 
f–im™
);

79 
vr_ev’oİ_deš™
(
vr_ev’oİ
 *
v–
);

	@src/vr_hyperloglog.c

1 
	~<vr_cÜe.h
>

3 
	~<¡dšt.h
>

4 
	~<m©h.h
>

151 
	shÎhdr
 {

152 
	mmagic
[4];

153 
ušt8_t
 
	m’codšg
;

154 
ušt8_t
 
	mnÙu£d
[3];

155 
ušt8_t
 
	mÿrd
[8];

156 
ušt8_t
 
	m»gi¡”s
[];

160 
	#HLL_INVALIDATE_CACHE
(
hdr
è(hdr)->
ÿrd
[7] |ğ(1<<7)

	)

161 
	#HLL_VALID_CACHE
(
hdr
è(((hdr)->
ÿrd
[7] & (1<<7)è=ğ0)

	)

163 
	#HLL_P
 14

	)

164 
	#HLL_REGISTERS
 (1<<
HLL_P
è

	)

165 
	#HLL_P_MASK
 (
HLL_REGISTERS
-1è

	)

166 
	#HLL_BITS
 6

	)

167 
	#HLL_REGISTER_MAX
 ((1<<
HLL_BITS
)-1)

	)

168 
	#HLL_HDR_SIZE
 (
hÎhdr
)

	)

169 
	#HLL_DENSE_SIZE
 (
HLL_HDR_SIZE
+((
HLL_REGISTERS
*
HLL_BITS
+7)/8))

	)

170 
	#HLL_DENSE
 0

	)

171 
	#HLL_SPARSE
 1

	)

172 
	#HLL_RAW
 255

	)

173 
	#HLL_MAX_ENCODING
 1

	)

175 *
	gšv®id_hÎ_”r
 = "-INVALIDOBJ Corrupted HLL object detected\r\n";

306 
	#HLL_DENSE_GET_REGISTER
(
rg‘
,
p
,
»gnum
) do { \

307 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

308 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

309 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

310 
_fb8
 = 8 - 
_fb
; \

311 
b0
 = 
_p
[
_by‹
]; \

312 
b1
 = 
_p
[
_by‹
+1]; \

313 
rg‘
 = ((
b0
 >> 
_fb
è| (
b1
 << 
_fb8
)è& 
HLL_REGISTER_MAX
; \

314 } 0)

	)

318 
	#HLL_DENSE_SET_REGISTER
(
p
,
»gnum
,
v®
) do { \

319 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

320 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

321 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

322 
_fb8
 = 8 - 
_fb
; \

323 
_v
 = 
v®
; \

324 
_p
[
_by‹
] &ğ~(
HLL_REGISTER_MAX
 << 
_fb
); \

325 
_p
[
_by‹
] |ğ
_v
 << 
_fb
; \

326 
_p
[
_by‹
+1] &ğ~(
HLL_REGISTER_MAX
 >> 
_fb8
); \

327 
_p
[
_by‹
+1] |ğ
_v
 >> 
_fb8
; \

328 } 0)

	)

332 
	#HLL_SPARSE_XZERO_BIT
 0x40

	)

333 
	#HLL_SPARSE_VAL_BIT
 0x80

	)

334 
	#HLL_SPARSE_IS_ZERO
(
p
è(((*Õ)è& 0xc0è=ğ0è

	)

335 
	#HLL_SPARSE_IS_XZERO
(
p
è(((*Õ)è& 0xc0è=ğ
HLL_SPARSE_XZERO_BIT
)

	)

336 
	#HLL_SPARSE_IS_VAL
(
p
è((*Õ)è& 
HLL_SPARSE_VAL_BIT
)

	)

337 
	#HLL_SPARSE_ZERO_LEN
(
p
è(((*Õ)è& 0x3f)+1)

	)

338 
	#HLL_SPARSE_XZERO_LEN
(
p
è(((((*Õ)è& 0x3fè<< 8è| (*(Õ)+1)))+1)

	)

339 
	#HLL_SPARSE_VAL_VALUE
(
p
è((((*Õ)è>> 2è& 0x1f)+1)

	)

340 
	#HLL_SPARSE_VAL_LEN
(
p
è(((*Õ)è& 0x3)+1)

	)

341 
	#HLL_SPARSE_VAL_MAX_VALUE
 32

	)

342 
	#HLL_SPARSE_VAL_MAX_LEN
 4

	)

343 
	#HLL_SPARSE_ZERO_MAX_LEN
 64

	)

344 
	#HLL_SPARSE_XZERO_MAX_LEN
 16384

	)

345 
	#HLL_SPARSE_VAL_SET
(
p
,
v®
,
Ën
) do { \

346 *(
p
èğ(((
v®
)-1)<<2|((
Ën
)-1))|
HLL_SPARSE_VAL_BIT
; \

347 } 0)

	)

348 
	#HLL_SPARSE_ZERO_SET
(
p
,
Ën
) do { \

349 *(
p
èğ(
Ën
)-1; \

350 } 0)

	)

351 
	#HLL_SPARSE_XZERO_SET
(
p
,
Ën
) do { \

352 
_l
 = (
Ën
)-1; \

353 *(
p
èğ(
_l
>>8è| 
HLL_SPARSE_XZERO_BIT
; \

354 *((
p
)+1èğ(
_l
&0xff); \

355 } 0)

	)

362 
ušt64_t
 
	$MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
) {

363 cÚ¡ 
ušt64_t
 
m
 = 0xc6a4a7935bd1e995;

364 cÚ¡ 
r
 = 47;

365 
ušt64_t
 
h
 = 
£ed
 ^ (
Ën
 * 
m
);

366 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*)
key
;

367 cÚ¡ 
ušt8_t
 *
’d
 = 
d©a
 + (
Ën
-(len&7));

369 
d©a
 !ğ
’d
) {

370 
ušt64_t
 
k
;

372 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

373 
k
 = *((
ušt64_t
*)
d©a
);

375 
k
 = (
ušt64_t
è
d©a
[0];

376 
k
 |ğ(
ušt64_t
è
d©a
[1] << 8;

377 
k
 |ğ(
ušt64_t
è
d©a
[2] << 16;

378 
k
 |ğ(
ušt64_t
è
d©a
[3] << 24;

379 
k
 |ğ(
ušt64_t
è
d©a
[4] << 32;

380 
k
 |ğ(
ušt64_t
è
d©a
[5] << 40;

381 
k
 |ğ(
ušt64_t
è
d©a
[6] << 48;

382 
k
 |ğ(
ušt64_t
è
d©a
[7] << 56;

385 
k
 *ğ
m
;

386 
k
 ^ğk >> 
r
;

387 
k
 *ğ
m
;

388 
h
 ^ğ
k
;

389 
h
 *ğ
m
;

390 
d©a
 += 8;

393 
Ën
 & 7) {

394 7: 
h
 ^ğ(
ušt64_t
)
d©a
[6] << 48;

395 6: 
h
 ^ğ(
ušt64_t
)
d©a
[5] << 40;

396 5: 
h
 ^ğ(
ušt64_t
)
d©a
[4] << 32;

397 4: 
h
 ^ğ(
ušt64_t
)
d©a
[3] << 24;

398 3: 
h
 ^ğ(
ušt64_t
)
d©a
[2] << 16;

399 2: 
h
 ^ğ(
ušt64_t
)
d©a
[1] << 8;

400 1: 
h
 ^ğ(
ušt64_t
)
d©a
[0];

401 
h
 *ğ
m
;

404 
h
 ^ğh >> 
r
;

405 
h
 *ğ
m
;

406 
h
 ^ğh >> 
r
;

407  
h
;

408 
	}
}

413 
	$hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
) {

414 
ušt64_t
 
hash
, 
b™
, 
šdex
;

415 
couÁ
;

428 
hash
 = 
	`MurmurHash64A
(
–e
,
–esize
,0xadc83b19ULL);

429 
šdex
 = 
hash
 & 
HLL_P_MASK
;

430 
hash
 |ğ((
ušt64_t
)1<<63);

431 
b™
 = 
HLL_REGISTERS
;

432 
couÁ
 = 1;

433 (
hash
 & 
b™
) == 0) {

434 
couÁ
++;

435 
b™
 <<= 1;

437 *
»gp
 = (è
šdex
;

438  
couÁ
;

439 
	}
}

454 
	$hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
) {

455 
ušt8_t
 
ŞdcouÁ
, 
couÁ
;

456 
šdex
;

459 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

460 
	`HLL_DENSE_GET_REGISTER
(
ŞdcouÁ
,
»gi¡”s
,
šdex
);

461 ià(
couÁ
 > 
ŞdcouÁ
) {

462 
	`HLL_DENSE_SET_REGISTER
(
»gi¡”s
,
šdex
,
couÁ
);

467 
	}
}

473 
	$hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

474 
E
 = 0;

475 
j
, 
ez
 = 0;

480 ià(
HLL_REGISTERS
 =ğ16384 && 
HLL_BITS
 == 6) {

481 
ušt8_t
 *
r
 = 
»gi¡”s
;

482 
r0
, 
r1
, 
r2
, 
r3
, 
r4
, 
r5
, 
r6
, 
r7
, 
r8
, 
r9
,

483 
r10
, 
r11
, 
r12
, 
r13
, 
r14
, 
r15
;

484 
j
 = 0; j < 1024; j++) {

486 
r0
 = 
r
[0] & 63; iàÔ0 =ğ0è
ez
++;

487 
r1
 = (
r
[0] >> 6 |„[1] << 2è& 63; iàÔ1 =ğ0è
ez
++;

488 
r2
 = (
r
[1] >> 4 |„[2] << 4è& 63; iàÔ2 =ğ0è
ez
++;

489 
r3
 = (
r
[2] >> 2è& 63; iàÔ3 =ğ0è
ez
++;

490 
r4
 = 
r
[3] & 63; iàÔ4 =ğ0è
ez
++;

491 
r5
 = (
r
[3] >> 6 |„[4] << 2è& 63; iàÔ5 =ğ0è
ez
++;

492 
r6
 = (
r
[4] >> 4 |„[5] << 4è& 63; iàÔ6 =ğ0è
ez
++;

493 
r7
 = (
r
[5] >> 2è& 63; iàÔ7 =ğ0è
ez
++;

494 
r8
 = 
r
[6] & 63; iàÔ8 =ğ0è
ez
++;

495 
r9
 = (
r
[6] >> 6 |„[7] << 2è& 63; iàÔ9 =ğ0è
ez
++;

496 
r10
 = (
r
[7] >> 4 |„[8] << 4è& 63; iàÔ10 =ğ0è
ez
++;

497 
r11
 = (
r
[8] >> 2è& 63; iàÔ11 =ğ0è
ez
++;

498 
r12
 = 
r
[9] & 63; iàÔ12 =ğ0è
ez
++;

499 
r13
 = (
r
[9] >> 6 |„[10] << 2è& 63; iàÔ13 =ğ0è
ez
++;

500 
r14
 = (
r
[10] >> 4 |„[11] << 4è& 63; iàÔ14 =ğ0è
ez
++;

501 
r15
 = (
r
[11] >> 2è& 63; iàÔ15 =ğ0è
ez
++;

506 
E
 +ğ(
PE
[
r0
] + PE[
r1
]è+ (PE[
r2
] + PE[
r3
]è+ (PE[
r4
] + PE[
r5
]) +

507 (
PE
[
r6
] + PE[
r7
]è+ (PE[
r8
] + PE[
r9
]è+ (PE[
r10
] + PE[
r11
]) +

508 (
PE
[
r12
] + PE[
r13
]è+ (PE[
r14
] + PE[
r15
]);

509 
r
 += 12;

512 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

513 
»g
;

515 
	`HLL_DENSE_GET_REGISTER
(
»g
,
»gi¡”s
,
j
);

516 ià(
»g
 == 0) {

517 
ez
++;

520 
E
 +ğ
PE
[
»g
];

523 
E
 +ğ
ez
;

525 *
ezp
 = 
ez
;

526  
E
;

527 
	}
}

537 
	$hÎS·r£ToD’£
(
robj
 *
o
) {

538 
sds
 
¥¬£
 = 
o
->
±r
, 
d’£
;

539 
hÎhdr
 *
hdr
, *
Şdhdr
 = (hÎhdr*)
¥¬£
;

540 
idx
 = 0, 
ruÆ’
, 
»gv®
;

541 
ušt8_t
 *
p
 = (ušt8_t*)
¥¬£
, *
’d
 =…+
	`sd¦’
(sparse);

544 
hdr
 = (
hÎhdr
*è
¥¬£
;

545 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
è 
VR_OK
;

550 
d’£
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

551 
hdr
 = (
hÎhdr
*è
d’£
;

552 *
hdr
 = *
Şdhdr
;

553 
hdr
->
’codšg
 = 
HLL_DENSE
;

557 
p
 +ğ
HLL_HDR_SIZE
;

558 
p
 < 
’d
) {

559 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

560 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

561 
idx
 +ğ
ruÆ’
;

562 
p
++;

563 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

564 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

565 
idx
 +ğ
ruÆ’
;

566 
p
 += 2;

568 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

569 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

570 
ruÆ’
--) {

571 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
idx
,
»gv®
);

572 
idx
++;

574 
p
++;

580 ià(
idx
 !ğ
HLL_REGISTERS
) {

581 
	`sdsä“
(
d’£
);

582  
VR_ERROR
;

586 
	`sdsä“
(
o
->
±r
);

587 
o
->
±r
 = 
d’£
;

588  
VR_OK
;

589 
	}
}

607 
	$hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

608 
hÎhdr
 *
hdr
;

609 
ušt8_t
 
ŞdcouÁ
, 
couÁ
, *
¥¬£
, *
’d
, *
p
, *
´ev
, *
Ãxt
;

610 
šdex
, 
fœ¡
, 
¥ª
;

611 
is_z”o
 = 0, 
is_xz”o
 = 0, 
is_v®
 = 0, 
ruÆ’
 = 0;

614 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

618 ià(
couÁ
 > 
HLL_SPARSE_VAL_MAX_VALUE
è
´omÙe
;

625 
o
->
±r
 = 
	`sdsMakeRoomFÜ
(o->ptr,3);

629 
¥¬£
 = 
p
 = ((
ušt8_t
*)
o
->
±r
è+ 
HLL_HDR_SIZE
;

630 
’d
 = 
p
 + 
	`sd¦’
(
o
->
±r
è- 
HLL_HDR_SIZE
;

632 
fœ¡
 = 0;

633 
´ev
 = 
NULL
;

634 
Ãxt
 = 
NULL
;

635 
¥ª
 = 0;

636 
p
 < 
’d
) {

637 
İËn
;

644 
İËn
 = 1;

645 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

646 
¥ª
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

647 } ià(
	`HLL_SPARSE_IS_VAL
(
p
)) {

648 
¥ª
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

650 
¥ª
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

651 
İËn
 = 2;

654 ià(
šdex
 <ğ
fœ¡
+
¥ª
-1) ;

655 
´ev
 = 
p
;

656 
p
 +ğ
İËn
;

657 
fœ¡
 +ğ
¥ª
;

659 ià(
¥ª
 == 0)  -1;

661 
Ãxt
 = 
	`HLL_SPARSE_IS_XZERO
(
p
) ?…+2 :…+1;

662 ià(
Ãxt
 >ğ
’d
èÃxˆğ
NULL
;

667 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

668 
is_z”o
 = 1;

669 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

670 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

671 
is_xz”o
 = 1;

672 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

674 
is_v®
 = 1;

675 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

699 ià(
is_v®
) {

700 
ŞdcouÁ
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

702 ià(
ŞdcouÁ
 >ğ
couÁ
)  0;

705 ià(
ruÆ’
 == 1) {

706 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

707 
upd©ed
;

713 ià(
is_z”o
 && 
ruÆ’
 == 1) {

714 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

715 
upd©ed
;

733 
ušt8_t
 
£q
[5], *
n
 = seq;

734 
Ï¡
 = 
fœ¡
+
¥ª
-1;

735 
Ën
;

737 ià(
is_z”o
 || 
is_xz”o
) {

739 ià(
šdex
 !ğ
fœ¡
) {

740 
Ën
 = 
šdex
-
fœ¡
;

741 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

742 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

743 
n
 += 2;

745 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

746 
n
++;

749 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

750 
n
++;

751 ià(
šdex
 !ğ
Ï¡
) {

752 
Ën
 = 
Ï¡
-
šdex
;

753 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

754 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

755 
n
 += 2;

757 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

758 
n
++;

763 
curv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

765 ià(
šdex
 !ğ
fœ¡
) {

766 
Ën
 = 
šdex
-
fœ¡
;

767 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

768 
n
++;

770 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

771 
n
++;

772 ià(
šdex
 !ğ
Ï¡
) {

773 
Ën
 = 
Ï¡
-
šdex
;

774 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

775 
n
++;

783 
£qËn
 = 
n
-
£q
;

784 
ŞdËn
 = 
is_xz”o
 ? 2 : 1;

785 
d–Ën
 = 
£qËn
-
ŞdËn
;

787 ià(
d–Ën
 > 0 &&

788 
	`sd¦’
(
o
->
±r
)+
d–Ën
 > 
£rv”
.
hÎ_¥¬£_max_by‹s
è
´omÙe
;

789 ià(
d–Ën
 && 
Ãxt
è
	`memmove
Òext+d–Ën,Ãxt,
’d
-next);

790 
	`sdsInüL’
(
o
->
±r
,
d–Ën
);

791 
	`memıy
(
p
,
£q
,
£qËn
);

792 
’d
 +ğ
d–Ën
;

794 
upd©ed
:

800 
p
 = 
´ev
 ?…»v : 
¥¬£
;

801 
sÿÆ’
 = 5;

802 
p
 < 
’d
 && 
sÿÆ’
--) {

803 ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

804 
p
 += 2;

806 } ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

807 
p
++;

812 ià(
p
+1 < 
’d
 && 
	`HLL_SPARSE_IS_VAL
(p+1)) {

813 
v1
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

814 
v2
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
+1);

815 ià(
v1
 =ğ
v2
) {

816 
Ën
 = 
	`HLL_SPARSE_VAL_LEN
(
p
)+HLL_SPARSE_VAL_LEN(p+1);

817 ià(
Ën
 <ğ
HLL_SPARSE_VAL_MAX_LEN
) {

818 
	`HLL_SPARSE_VAL_SET
(
p
+1,
v1
,
Ën
);

819 
	`memmove
(
p
,p+1,
’d
-p);

820 
	`sdsInüL’
(
o
->
±r
,-1);

821 
’d
--;

829 
p
++;

833 
hdr
 = 
o
->
±r
;

834 
	`HLL_INVALIDATE_CACHE
(
hdr
);

837 
´omÙe
:

838 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
)  -1;

839 
hdr
 = 
o
->
±r
;

848 
d’£_»tv®
 = 
	`hÎD’£Add
(
hdr
->
»gi¡”s
, 
–e
, 
–esize
);

849 
	`ASSERT
(
d’£_»tv®
 == 1);

850  
d’£_»tv®
;

851 
	}
}

857 
	$hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
) {

858 
E
 = 0;

859 
ez
 = 0, 
idx
 = 0, 
ruÆ’
, 
»gv®
;

860 
ušt8_t
 *
’d
 = 
¥¬£
+
¥¬£Ën
, *
p
 = sparse;

862 
p
 < 
’d
) {

863 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

864 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

865 
idx
 +ğ
ruÆ’
;

866 
ez
 +ğ
ruÆ’
;

868 
p
++;

869 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

870 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

871 
idx
 +ğ
ruÆ’
;

872 
ez
 +ğ
ruÆ’
;

874 
p
 += 2;

876 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

877 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

878 
idx
 +ğ
ruÆ’
;

879 
E
 +ğ
PE
[
»gv®
]*
ruÆ’
;

880 
p
++;

883 ià(
idx
 !ğ
HLL_REGISTERS
 && 
šv®id
) *invalid = 1;

884 
E
 +ğ
ez
;

885 *
ezp
 = 
ez
;

886  
E
;

887 
	}
}

897 
	$hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

898 
E
 = 0;

899 
j
, 
ez
 = 0;

900 
ušt64_t
 *
wÜd
 = (ušt64_t*è
»gi¡”s
;

901 
ušt8_t
 *
by‹s
;

903 
j
 = 0; j < 
HLL_REGISTERS
/8; j++) {

904 ià(*
wÜd
 == 0) {

905 
ez
 += 8;

907 
by‹s
 = (
ušt8_t
*è
wÜd
;

908 ià(
by‹s
[0]è
E
 +ğ
PE
[by‹s[0]]; 
ez
++;

909 ià(
by‹s
[1]è
E
 +ğ
PE
[by‹s[1]]; 
ez
++;

910 ià(
by‹s
[2]è
E
 +ğ
PE
[by‹s[2]]; 
ez
++;

911 ià(
by‹s
[3]è
E
 +ğ
PE
[by‹s[3]]; 
ez
++;

912 ià(
by‹s
[4]è
E
 +ğ
PE
[by‹s[4]]; 
ez
++;

913 ià(
by‹s
[5]è
E
 +ğ
PE
[by‹s[5]]; 
ez
++;

914 ià(
by‹s
[6]è
E
 +ğ
PE
[by‹s[6]]; 
ez
++;

915 ià(
by‹s
[7]è
E
 +ğ
PE
[by‹s[7]]; 
ez
++;

917 
wÜd
++;

919 
E
 +ğ
ez
;

921 *
ezp
 = 
ez
;

922  
E
;

923 
	}
}

936 
ušt64_t
 
	$hÎCouÁ
(
hÎhdr
 *
hdr
, *
šv®id
) {

937 
m
 = 
HLL_REGISTERS
;

938 
E
, 
®pha
 = 0.7213/(1+1.079/
m
);

939 
j
, 
ez
;

943 
š™Ÿlized
 = 0;

944 
PE
[64];

945 ià(!
š™Ÿlized
) {

946 
PE
[0] = 1;

947 
j
 = 1; j < 64; j++) {

949 
PE
[
j
] = 1.0/(1ULL << j);

951 
š™Ÿlized
 = 1;

955 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

956 
E
 = 
	`hÎD’£Sum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

957 } ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

958 
E
 = 
	`hÎS·r£Sum
(
hdr
->
»gi¡”s
,

959 
	`sd¦’
((
sds
)
hdr
)-
HLL_HDR_SIZE
,
PE
,&
ez
,
šv®id
);

960 } ià(
hdr
->
’codšg
 =ğ
HLL_RAW
) {

961 
E
 = 
	`hÎRawSum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

963 
	`£rv”Pªic
("Unknown HyperLogLogƒncoding in hllCount()");

967 
E
 = (1/E)*
®pha
*
m
*m;

974 ià(
E
 < 
m
*2.5 && 
ez
 != 0) {

975 
E
 = 
m
*
	`log
(m/
ez
);

976 } ià(
m
 =ğ16384 && 
E
 < 72000) {

981 
bŸs
 = 5.9119*1.0e-18*(
E
*E*E*E)

982 -1.4253*1.0e-12*(
E
*E*E)+

983 1.2940*1.0e-7*(
E
*E)

984 -5.2921*1.0e-3*
E
+

986 
E
 -ğE*(
bŸs
/100);

992  (
ušt64_t
è
E
;

993 
	}
}

996 
	$hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

997 
hÎhdr
 *
hdr
 = 
o
->
±r
;

998 
hdr
->
’codšg
) {

999 
HLL_DENSE
:  
	`hÎD’£Add
(
hdr
->
»gi¡”s
,
–e
,
–esize
);

1000 
HLL_SPARSE
:  
	`hÎS·r£Add
(
o
,
–e
,
–esize
);

1003 
	}
}

1013 
	$hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
) {

1014 
hÎhdr
 *
hdr
 = 
hÎ
->
±r
;

1015 
i
;

1017 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

1018 
ušt8_t
 
v®
;

1020 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1021 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1022 ià(
v®
 > 
max
[
i
]) max[i] = val;

1025 
ušt8_t
 *
p
 = 
hÎ
->
±r
, *
’d
 =… + 
	`sd¦’
(hll->ptr);

1026 
ruÆ’
, 
»gv®
;

1028 
p
 +ğ
HLL_HDR_SIZE
;

1029 
i
 = 0;

1030 
p
 < 
’d
) {

1031 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1032 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1033 
i
 +ğ
ruÆ’
;

1034 
p
++;

1035 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1036 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1037 
i
 +ğ
ruÆ’
;

1038 
p
 += 2;

1040 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1041 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1042 
ruÆ’
--) {

1043 ià(
»gv®
 > 
max
[
i
]) max[i] =„egval;

1044 
i
++;

1046 
p
++;

1049 ià(
i
 !ğ
HLL_REGISTERS
è 
VR_ERROR
;

1051  
VR_OK
;

1052 
	}
}

1058 
robj
 *
	$ü—‹HLLObjeù
() {

1059 
robj
 *
o
;

1060 
hÎhdr
 *
hdr
;

1061 
sds
 
s
;

1062 
ušt8_t
 *
p
;

1063 
¥¬£Ën
 = 
HLL_HDR_SIZE
 +

1064 (((
HLL_REGISTERS
+(
HLL_SPARSE_XZERO_MAX_LEN
-1)) /

1065 
HLL_SPARSE_XZERO_MAX_LEN
)*2);

1066 
aux
;

1070 
aux
 = 
HLL_REGISTERS
;

1071 
s
 = 
	`sd¢ewËn
(
NULL
,
¥¬£Ën
);

1072 
p
 = (
ušt8_t
*)
s
 + 
HLL_HDR_SIZE
;

1073 
aux
) {

1074 
xz”o
 = 
HLL_SPARSE_XZERO_MAX_LEN
;

1075 ià(
xz”o
 > 
aux
) xzero =‡ux;

1076 
	`HLL_SPARSE_XZERO_SET
(
p
,
xz”o
);

1077 
p
 += 2;

1078 
aux
 -ğ
xz”o
;

1080 
	`ASSERT
((
p
-(
ušt8_t
*)
s
è=ğ
¥¬£Ën
);

1083 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

1084 
hdr
 = 
o
->
±r
;

1085 
	`memıy
(
hdr
->
magic
,"HYLL",4);

1086 
hdr
->
’codšg
 = 
HLL_SPARSE
;

1087  
o
;

1088 
	}
}

1093 
	$isHLLObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
) {

1094 
hÎhdr
 *
hdr
;

1097 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

1098  
VR_ERROR
;

1100 ià(
	`¡ršgObjeùL’
(
o
è< (*
hdr
)è
šv®id
;

1101 
hdr
 = 
o
->
±r
;

1104 ià(
hdr
->
magic
[0] != 'H' || hdr->magic[1] != 'Y' ||

1105 
hdr
->
magic
[2] !ğ'L' || hdr->magic[3] !ğ'L'è
šv®id
;

1107 ià(
hdr
->
’codšg
 > 
HLL_MAX_ENCODING
è
šv®id
;

1110 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
 &&

1111 
	`¡ršgObjeùL’
(
o
è!ğ
HLL_DENSE_SIZE
è
šv®id
;

1114  
VR_OK
;

1116 
šv®id
:

1117 
	`addR•lySds
(
c
,

1118 
	`sd¢ew
("-WRONGTYPE Key is‚ot‡ valid "

1120  
VR_ERROR
;

1121 
	}
}

1124 
	$pçddCommªd
(
ş›Á
 *
c
) {

1125 
robj
 *
o
;

1126 
hÎhdr
 *
hdr
;

1127 
upd©ed
 = 0, 
j
;

1128 
expœed
 = 0;

1130 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

1131 
	`lockDbWr™e
(
c
->
db
);

1132 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

1133 ià(
o
 =ğ
NULL
) {

1137 
o
 = 
	`ü—‹HLLObjeù
();

1138 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1139 
upd©ed
++;

1141 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) {

1142 
	`uÆockDb
(
c
->
db
);

1143 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1146 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1149 
j
 = 2; j < 
c
->
¬gc
; j++) {

1150 
»tv®
 = 
	`hÎAdd
(
o
, (*)
c
->
¬gv
[
j
]->
±r
,

1151 
	`sd¦’
(
c
->
¬gv
[
j
]->
±r
));

1152 
»tv®
) {

1154 
upd©ed
++;

1157 
	`uÆockDb
(
c
->
db
);

1158 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1159 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1163 
hdr
 = 
o
->
±r
;

1164 ià(
upd©ed
) {

1165 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1166 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1167 
c
->
v–
->
dœty
++;

1168 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1170 
	`addR•ly
(
c
, 
upd©ed
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1171 
	`uÆockDb
(
c
->
db
);

1172 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1173 
	}
}

1176 
	$pfcouÁCommªd
(
ş›Á
 *
c
) {

1177 
robj
 *
o
;

1178 
hÎhdr
 *
hdr
;

1179 
ušt64_t
 
ÿrd
;

1180 
expœed
;

1186 ià(
c
->
¬gc
 > 2) {

1187 
ušt8_t
 
max
[
HLL_HDR_SIZE
+
HLL_REGISTERS
], *
»gi¡”s
;

1188 
j
;

1191 
	`mem£t
(
max
,0,(max));

1192 
hdr
 = (
hÎhdr
*è
max
;

1193 
hdr
->
’codšg
 = 
HLL_RAW
;

1194 
»gi¡”s
 = 
max
 + 
HLL_HDR_SIZE
;

1195 
j
 = 1; j < 
c
->
¬gc
; j++) {

1197 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

1198 
	`lockDbR—d
(
c
->
db
);

1199 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1200 ià(
o
 =ğ
NULL
) {

1201 
	`uÆockDb
(
c
->
db
);

1204 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) {

1205 
	`uÆockDb
(
c
->
db
);

1210 ià(
	`hÎM”ge
(
»gi¡”s
,
o
è=ğ
VR_ERROR
) {

1211 
	`uÆockDb
(
c
->
db
);

1212 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1216 
	`uÆockDb
(
c
->
db
);

1220 
	`addR•lyLÚgLÚg
(
c
,
	`hÎCouÁ
(
hdr
,
NULL
));

1228 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[1]);

1229 
	`lockDbWr™e
(
c
->
db
);

1230 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

1231 ià(
o
 =ğ
NULL
) {

1234 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1236 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) {

1237 
	`uÆockDb
(
c
->
db
);

1238 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1241 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1244 
hdr
 = 
o
->
±r
;

1245 ià(
	`HLL_VALID_CACHE
(
hdr
)) {

1247 
ÿrd
 = (
ušt64_t
)
hdr
->card[0];

1248 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[1] << 8;

1249 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[2] << 16;

1250 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[3] << 24;

1251 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[4] << 32;

1252 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[5] << 40;

1253 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[6] << 48;

1254 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[7] << 56;

1256 
šv®id
 = 0;

1258 
ÿrd
 = 
	`hÎCouÁ
(
hdr
,&
šv®id
);

1259 ià(
šv®id
) {

1260 
	`uÆockDb
(
c
->
db
);

1261 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1262 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1265 
hdr
->
ÿrd
[0] = card & 0xff;

1266 
hdr
->
ÿrd
[1] = (card >> 8) & 0xff;

1267 
hdr
->
ÿrd
[2] = (card >> 16) & 0xff;

1268 
hdr
->
ÿrd
[3] = (card >> 24) & 0xff;

1269 
hdr
->
ÿrd
[4] = (card >> 32) & 0xff;

1270 
hdr
->
ÿrd
[5] = (card >> 40) & 0xff;

1271 
hdr
->
ÿrd
[6] = (card >> 48) & 0xff;

1272 
hdr
->
ÿrd
[7] = (card >> 56) & 0xff;

1277 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1278 
£rv”
.
dœty
++;

1279 
c
->
v–
->
dœty
++;

1281 
	`addR•lyLÚgLÚg
(
c
,
ÿrd
);

1284 
	`uÆockDb
(
c
->
db
);

1285 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1286 
	}
}

1289 
	$pfm”geCommªd
(
ş›Á
 *
c
) {

1290 
ušt8_t
 
max
[
HLL_REGISTERS
];

1291 
hÎhdr
 *
hdr
;

1292 
j
;

1297 
	`mem£t
(
max
,0,(max));

1298 
j
 = 1; j < 
c
->
¬gc
; j++) {

1300 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1301 ià(
o
 =ğ
NULL
) ;

1302 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) ;

1306 ià(
	`hÎM”ge
(
max
,
o
è=ğ
VR_ERROR
) {

1307 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1313 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
NULL
);

1314 ià(
o
 =ğ
NULL
) {

1318 
o
 = 
	`ü—‹HLLObjeù
();

1319 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1324 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1328 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
) {

1329 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1335 
hdr
 = 
o
->
±r
;

1336 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1337 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
j
,
max
[j]);

1339 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1341 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1344 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1345 
£rv”
.
dœty
++;

1346 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1347 
	}
}

1354 
	#HLL_TEST_CYCLES
 1000

	)

1355 
	$pf£láe¡Commªd
(
ş›Á
 *
c
) {

1356 
j
, 
i
;

1357 
sds
 
b™couÁ”s
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

1358 
hÎhdr
 *
hdr
 = (hÎhdr*è
b™couÁ”s
, *
hdr2
;

1359 
robj
 *
o
 = 
NULL
;

1360 
ušt8_t
 
by‹couÁ”s
[
HLL_REGISTERS
];

1366 
j
 = 0; j < 
HLL_TEST_CYCLES
; j++) {

1369 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1370 
r
 = 
	`¿nd
(è& 
HLL_REGISTER_MAX
;

1372 
by‹couÁ”s
[
i
] = 
r
;

1373 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
i
,
r
);

1376 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1377 
v®
;

1379 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1380 ià(
v®
 !ğ
by‹couÁ”s
[
i
]) {

1381 
	`addR•lyE¼ÜFÜm©
(
c
,

1383 
i
, (è
by‹couÁ”s
[i], (è
v®
);

1384 
ş—nup
;

1399 
	`mem£t
(
hdr
->
»gi¡”s
,0,
HLL_DENSE_SIZE
-
HLL_HDR_SIZE
);

1400 
o
 = 
	`ü—‹HLLObjeù
();

1401 
»Ë¼
 = 1.04/
	`sq¹
(
HLL_REGISTERS
);

1402 
št64_t
 
checkpošt
 = 1;

1403 
ušt64_t
 
£ed
 = (ušt64_t)
	`¿nd
() | (uint64_t)rand() << 32;

1404 
ušt64_t
 
–e
;

1405 
j
 = 1; j <= 10000000; j++) {

1406 
–e
 = 
j
 ^ 
£ed
;

1407 
	`hÎD’£Add
(
hdr
->
»gi¡”s
,(*)&
–e
,(ele));

1408 
	`hÎAdd
(
o
,(*)&
–e
,(ele));

1412 ià(
j
 =ğ
checkpošt
 && j < 
£rv”
.
hÎ_¥¬£_max_by‹s
/2) {

1413 
hdr2
 = 
o
->
±r
;

1414 ià(
hdr2
->
’codšg
 !ğ
HLL_SPARSE
) {

1415 
	`addR•lyE¼Ü
(
c
, "TESTFAILED sparseƒncoding‚ot used");

1416 
ş—nup
;

1421 ià(
j
 =ğ
checkpošt
 && 
	`hÎCouÁ
(
hdr
,
NULL
è!ğhÎCouÁ(
o
->
±r
,NULL)) {

1422 
	`addR•lyE¼Ü
(
c
, "TESTFAILED dense/sparse disagree");

1423 
ş—nup
;

1427 ià(
j
 =ğ
checkpošt
) {

1428 
št64_t
 
ab£¼
 = 
checkpošt
 - (št64_t)
	`hÎCouÁ
(
hdr
,
NULL
);

1429 
ušt64_t
 
max”r
 = 
	`û
(
»Ë¼
*6*
checkpošt
);

1435 ià(
j
 =ğ10è
max”r
 = 1;

1437 ià(
ab£¼
 < 0)‡bserr = -abserr;

1438 ià(
ab£¼
 > (
št64_t
)
max”r
) {

1439 
	`addR•lyE¼ÜFÜm©
(
c
,

1441 (è
checkpošt
,

1442 (è
ab£¼
);

1443 
ş—nup
;

1445 
checkpošt
 *= 10;

1450 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1452 
ş—nup
:

1453 
	`sdsä“
(
b™couÁ”s
);

1454 ià(
o
è
	`deüRefCouÁ
(o);

1455 
	}
}

1459 
	$pfdebugCommªd
(
ş›Á
 *
c
) {

1460 *
cmd
 = 
c
->
¬gv
[1]->
±r
;

1461 
hÎhdr
 *
hdr
;

1462 
robj
 *
o
;

1463 
j
;

1465 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
);

1466 ià(
o
 =ğ
NULL
) {

1467 
	`addR•lyE¼Ü
(
c
,"The specified key does‚otƒxist");

1470 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) ;

1471 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[2],o);

1472 
hdr
 = 
o
->
±r
;

1475 ià(!
	`¡rÿ£cmp
(
cmd
,"getreg")) {

1476 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1478 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1479 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
) {

1480 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1483 
£rv”
.
dœty
++;

1486 
hdr
 = 
o
->
±r
;

1487 
	`addR•lyMuÉiBulkL’
(
c
,
HLL_REGISTERS
);

1488 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1489 
ušt8_t
 
v®
;

1491 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
j
);

1492 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1496 ià(!
	`¡rÿ£cmp
(
cmd
,"decode")) {

1497 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1499 
ušt8_t
 *
p
 = 
o
->
±r
, *
’d
 =…+
	`sd¦’
(o->ptr);

1500 
sds
 
decoded
 = 
	`sd£m±y
();

1502 ià(
hdr
->
’codšg
 !ğ
HLL_SPARSE
) {

1503 
	`addR•lyE¼Ü
(
c
,"HLLƒncoding is‚ot sparse");

1507 
p
 +ğ
HLL_HDR_SIZE
;

1508 
p
 < 
’d
) {

1509 
ruÆ’
, 
»gv®
;

1511 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1512 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1513 
p
++;

1514 
decoded
 = 
	`sdsÿrštf
(decoded,"z:%d ",
ruÆ’
);

1515 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1516 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1517 
p
 += 2;

1518 
decoded
 = 
	`sdsÿrštf
(decoded,"Z:%d ",
ruÆ’
);

1520 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1521 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1522 
p
++;

1523 
decoded
 = 
	`sdsÿrštf
(decoded,"v:%d,%d ",
»gv®
,
ruÆ’
);

1526 
decoded
 = 
	`sd¡rim
(decoded," ");

1527 
	`addR•lyBulkCBufãr
(
c
,
decoded
,
	`sd¦’
(decoded));

1528 
	`sdsä“
(
decoded
);

1531 ià(!
	`¡rÿ£cmp
(
cmd
,"encoding")) {

1532 *
’codšg¡r
[2] = {"dense","sparse"};

1533 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1535 
	`addR•lyStus
(
c
,
’codšg¡r
[
hdr
->
’codšg
]);

1538 ià(!
	`¡rÿ£cmp
(
cmd
,"todense")) {

1539 
cÚv
 = 0;

1540 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1542 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1543 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
) {

1544 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1547 
cÚv
 = 1;

1548 
£rv”
.
dœty
++;

1550 
	`addR•ly
(
c
,
cÚv
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1552 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀPFDEBUG subcommªd '%s'", 
cmd
);

1556 
¬™y”r
:

1557 
	`addR•lyE¼ÜFÜm©
(
c
,

1558 "WrÚg‚umb” oà¬gum’t fÜh'%s' subcommªd",
cmd
);

1559 
	}
}

	@src/vr_hyperloglog.c

1 
	~<vr_cÜe.h
>

3 
	~<¡dšt.h
>

4 
	~<m©h.h
>

151 
	shÎhdr
 {

152 
	mmagic
[4];

153 
ušt8_t
 
	m’codšg
;

154 
ušt8_t
 
	mnÙu£d
[3];

155 
ušt8_t
 
	mÿrd
[8];

156 
ušt8_t
 
	m»gi¡”s
[];

160 
	#HLL_INVALIDATE_CACHE
(
hdr
è(hdr)->
ÿrd
[7] |ğ(1<<7)

	)

161 
	#HLL_VALID_CACHE
(
hdr
è(((hdr)->
ÿrd
[7] & (1<<7)è=ğ0)

	)

163 
	#HLL_P
 14

	)

164 
	#HLL_REGISTERS
 (1<<
HLL_P
è

	)

165 
	#HLL_P_MASK
 (
HLL_REGISTERS
-1è

	)

166 
	#HLL_BITS
 6

	)

167 
	#HLL_REGISTER_MAX
 ((1<<
HLL_BITS
)-1)

	)

168 
	#HLL_HDR_SIZE
 (
hÎhdr
)

	)

169 
	#HLL_DENSE_SIZE
 (
HLL_HDR_SIZE
+((
HLL_REGISTERS
*
HLL_BITS
+7)/8))

	)

170 
	#HLL_DENSE
 0

	)

171 
	#HLL_SPARSE
 1

	)

172 
	#HLL_RAW
 255

	)

173 
	#HLL_MAX_ENCODING
 1

	)

175 *
	gšv®id_hÎ_”r
 = "-INVALIDOBJ Corrupted HLL object detected\r\n";

306 
	#HLL_DENSE_GET_REGISTER
(
rg‘
,
p
,
»gnum
) do { \

307 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

308 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

309 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

310 
_fb8
 = 8 - 
_fb
; \

311 
b0
 = 
_p
[
_by‹
]; \

312 
b1
 = 
_p
[
_by‹
+1]; \

313 
rg‘
 = ((
b0
 >> 
_fb
è| (
b1
 << 
_fb8
)è& 
HLL_REGISTER_MAX
; \

314 } 0)

	)

318 
	#HLL_DENSE_SET_REGISTER
(
p
,
»gnum
,
v®
) do { \

319 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

320 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

321 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

322 
_fb8
 = 8 - 
_fb
; \

323 
_v
 = 
v®
; \

324 
_p
[
_by‹
] &ğ~(
HLL_REGISTER_MAX
 << 
_fb
); \

325 
_p
[
_by‹
] |ğ
_v
 << 
_fb
; \

326 
_p
[
_by‹
+1] &ğ~(
HLL_REGISTER_MAX
 >> 
_fb8
); \

327 
_p
[
_by‹
+1] |ğ
_v
 >> 
_fb8
; \

328 } 0)

	)

332 
	#HLL_SPARSE_XZERO_BIT
 0x40

	)

333 
	#HLL_SPARSE_VAL_BIT
 0x80

	)

334 
	#HLL_SPARSE_IS_ZERO
(
p
è(((*Õ)è& 0xc0è=ğ0è

	)

335 
	#HLL_SPARSE_IS_XZERO
(
p
è(((*Õ)è& 0xc0è=ğ
HLL_SPARSE_XZERO_BIT
)

	)

336 
	#HLL_SPARSE_IS_VAL
(
p
è((*Õ)è& 
HLL_SPARSE_VAL_BIT
)

	)

337 
	#HLL_SPARSE_ZERO_LEN
(
p
è(((*Õ)è& 0x3f)+1)

	)

338 
	#HLL_SPARSE_XZERO_LEN
(
p
è(((((*Õ)è& 0x3fè<< 8è| (*(Õ)+1)))+1)

	)

339 
	#HLL_SPARSE_VAL_VALUE
(
p
è((((*Õ)è>> 2è& 0x1f)+1)

	)

340 
	#HLL_SPARSE_VAL_LEN
(
p
è(((*Õ)è& 0x3)+1)

	)

341 
	#HLL_SPARSE_VAL_MAX_VALUE
 32

	)

342 
	#HLL_SPARSE_VAL_MAX_LEN
 4

	)

343 
	#HLL_SPARSE_ZERO_MAX_LEN
 64

	)

344 
	#HLL_SPARSE_XZERO_MAX_LEN
 16384

	)

345 
	#HLL_SPARSE_VAL_SET
(
p
,
v®
,
Ën
) do { \

346 *(
p
èğ(((
v®
)-1)<<2|((
Ën
)-1))|
HLL_SPARSE_VAL_BIT
; \

347 } 0)

	)

348 
	#HLL_SPARSE_ZERO_SET
(
p
,
Ën
) do { \

349 *(
p
èğ(
Ën
)-1; \

350 } 0)

	)

351 
	#HLL_SPARSE_XZERO_SET
(
p
,
Ën
) do { \

352 
_l
 = (
Ën
)-1; \

353 *(
p
èğ(
_l
>>8è| 
HLL_SPARSE_XZERO_BIT
; \

354 *((
p
)+1èğ(
_l
&0xff); \

355 } 0)

	)

362 
ušt64_t
 
	$MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
) {

363 cÚ¡ 
ušt64_t
 
m
 = 0xc6a4a7935bd1e995;

364 cÚ¡ 
r
 = 47;

365 
ušt64_t
 
h
 = 
£ed
 ^ (
Ën
 * 
m
);

366 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*)
key
;

367 cÚ¡ 
ušt8_t
 *
’d
 = 
d©a
 + (
Ën
-(len&7));

369 
d©a
 !ğ
’d
) {

370 
ušt64_t
 
k
;

372 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

373 
k
 = *((
ušt64_t
*)
d©a
);

375 
k
 = (
ušt64_t
è
d©a
[0];

376 
k
 |ğ(
ušt64_t
è
d©a
[1] << 8;

377 
k
 |ğ(
ušt64_t
è
d©a
[2] << 16;

378 
k
 |ğ(
ušt64_t
è
d©a
[3] << 24;

379 
k
 |ğ(
ušt64_t
è
d©a
[4] << 32;

380 
k
 |ğ(
ušt64_t
è
d©a
[5] << 40;

381 
k
 |ğ(
ušt64_t
è
d©a
[6] << 48;

382 
k
 |ğ(
ušt64_t
è
d©a
[7] << 56;

385 
k
 *ğ
m
;

386 
k
 ^ğk >> 
r
;

387 
k
 *ğ
m
;

388 
h
 ^ğ
k
;

389 
h
 *ğ
m
;

390 
d©a
 += 8;

393 
Ën
 & 7) {

394 7: 
h
 ^ğ(
ušt64_t
)
d©a
[6] << 48;

395 6: 
h
 ^ğ(
ušt64_t
)
d©a
[5] << 40;

396 5: 
h
 ^ğ(
ušt64_t
)
d©a
[4] << 32;

397 4: 
h
 ^ğ(
ušt64_t
)
d©a
[3] << 24;

398 3: 
h
 ^ğ(
ušt64_t
)
d©a
[2] << 16;

399 2: 
h
 ^ğ(
ušt64_t
)
d©a
[1] << 8;

400 1: 
h
 ^ğ(
ušt64_t
)
d©a
[0];

401 
h
 *ğ
m
;

404 
h
 ^ğh >> 
r
;

405 
h
 *ğ
m
;

406 
h
 ^ğh >> 
r
;

407  
h
;

408 
	}
}

413 
	$hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
) {

414 
ušt64_t
 
hash
, 
b™
, 
šdex
;

415 
couÁ
;

428 
hash
 = 
	`MurmurHash64A
(
–e
,
–esize
,0xadc83b19ULL);

429 
šdex
 = 
hash
 & 
HLL_P_MASK
;

430 
hash
 |ğ((
ušt64_t
)1<<63);

431 
b™
 = 
HLL_REGISTERS
;

432 
couÁ
 = 1;

433 (
hash
 & 
b™
) == 0) {

434 
couÁ
++;

435 
b™
 <<= 1;

437 *
»gp
 = (è
šdex
;

438  
couÁ
;

439 
	}
}

454 
	$hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
) {

455 
ušt8_t
 
ŞdcouÁ
, 
couÁ
;

456 
šdex
;

459 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

460 
	`HLL_DENSE_GET_REGISTER
(
ŞdcouÁ
,
»gi¡”s
,
šdex
);

461 ià(
couÁ
 > 
ŞdcouÁ
) {

462 
	`HLL_DENSE_SET_REGISTER
(
»gi¡”s
,
šdex
,
couÁ
);

467 
	}
}

473 
	$hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

474 
E
 = 0;

475 
j
, 
ez
 = 0;

480 ià(
HLL_REGISTERS
 =ğ16384 && 
HLL_BITS
 == 6) {

481 
ušt8_t
 *
r
 = 
»gi¡”s
;

482 
r0
, 
r1
, 
r2
, 
r3
, 
r4
, 
r5
, 
r6
, 
r7
, 
r8
, 
r9
,

483 
r10
, 
r11
, 
r12
, 
r13
, 
r14
, 
r15
;

484 
j
 = 0; j < 1024; j++) {

486 
r0
 = 
r
[0] & 63; iàÔ0 =ğ0è
ez
++;

487 
r1
 = (
r
[0] >> 6 |„[1] << 2è& 63; iàÔ1 =ğ0è
ez
++;

488 
r2
 = (
r
[1] >> 4 |„[2] << 4è& 63; iàÔ2 =ğ0è
ez
++;

489 
r3
 = (
r
[2] >> 2è& 63; iàÔ3 =ğ0è
ez
++;

490 
r4
 = 
r
[3] & 63; iàÔ4 =ğ0è
ez
++;

491 
r5
 = (
r
[3] >> 6 |„[4] << 2è& 63; iàÔ5 =ğ0è
ez
++;

492 
r6
 = (
r
[4] >> 4 |„[5] << 4è& 63; iàÔ6 =ğ0è
ez
++;

493 
r7
 = (
r
[5] >> 2è& 63; iàÔ7 =ğ0è
ez
++;

494 
r8
 = 
r
[6] & 63; iàÔ8 =ğ0è
ez
++;

495 
r9
 = (
r
[6] >> 6 |„[7] << 2è& 63; iàÔ9 =ğ0è
ez
++;

496 
r10
 = (
r
[7] >> 4 |„[8] << 4è& 63; iàÔ10 =ğ0è
ez
++;

497 
r11
 = (
r
[8] >> 2è& 63; iàÔ11 =ğ0è
ez
++;

498 
r12
 = 
r
[9] & 63; iàÔ12 =ğ0è
ez
++;

499 
r13
 = (
r
[9] >> 6 |„[10] << 2è& 63; iàÔ13 =ğ0è
ez
++;

500 
r14
 = (
r
[10] >> 4 |„[11] << 4è& 63; iàÔ14 =ğ0è
ez
++;

501 
r15
 = (
r
[11] >> 2è& 63; iàÔ15 =ğ0è
ez
++;

506 
E
 +ğ(
PE
[
r0
] + PE[
r1
]è+ (PE[
r2
] + PE[
r3
]è+ (PE[
r4
] + PE[
r5
]) +

507 (
PE
[
r6
] + PE[
r7
]è+ (PE[
r8
] + PE[
r9
]è+ (PE[
r10
] + PE[
r11
]) +

508 (
PE
[
r12
] + PE[
r13
]è+ (PE[
r14
] + PE[
r15
]);

509 
r
 += 12;

512 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

513 
»g
;

515 
	`HLL_DENSE_GET_REGISTER
(
»g
,
»gi¡”s
,
j
);

516 ià(
»g
 == 0) {

517 
ez
++;

520 
E
 +ğ
PE
[
»g
];

523 
E
 +ğ
ez
;

525 *
ezp
 = 
ez
;

526  
E
;

527 
	}
}

537 
	$hÎS·r£ToD’£
(
robj
 *
o
) {

538 
sds
 
¥¬£
 = 
o
->
±r
, 
d’£
;

539 
hÎhdr
 *
hdr
, *
Şdhdr
 = (hÎhdr*)
¥¬£
;

540 
idx
 = 0, 
ruÆ’
, 
»gv®
;

541 
ušt8_t
 *
p
 = (ušt8_t*)
¥¬£
, *
’d
 =…+
	`sd¦’
(sparse);

544 
hdr
 = (
hÎhdr
*è
¥¬£
;

545 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
è 
VR_OK
;

550 
d’£
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

551 
hdr
 = (
hÎhdr
*è
d’£
;

552 *
hdr
 = *
Şdhdr
;

553 
hdr
->
’codšg
 = 
HLL_DENSE
;

557 
p
 +ğ
HLL_HDR_SIZE
;

558 
p
 < 
’d
) {

559 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

560 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

561 
idx
 +ğ
ruÆ’
;

562 
p
++;

563 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

564 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

565 
idx
 +ğ
ruÆ’
;

566 
p
 += 2;

568 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

569 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

570 
ruÆ’
--) {

571 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
idx
,
»gv®
);

572 
idx
++;

574 
p
++;

580 ià(
idx
 !ğ
HLL_REGISTERS
) {

581 
	`sdsä“
(
d’£
);

582  
VR_ERROR
;

586 
	`sdsä“
(
o
->
±r
);

587 
o
->
±r
 = 
d’£
;

588  
VR_OK
;

589 
	}
}

607 
	$hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

608 
hÎhdr
 *
hdr
;

609 
ušt8_t
 
ŞdcouÁ
, 
couÁ
, *
¥¬£
, *
’d
, *
p
, *
´ev
, *
Ãxt
;

610 
šdex
, 
fœ¡
, 
¥ª
;

611 
is_z”o
 = 0, 
is_xz”o
 = 0, 
is_v®
 = 0, 
ruÆ’
 = 0;

614 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

618 ià(
couÁ
 > 
HLL_SPARSE_VAL_MAX_VALUE
è
´omÙe
;

625 
o
->
±r
 = 
	`sdsMakeRoomFÜ
(o->ptr,3);

629 
¥¬£
 = 
p
 = ((
ušt8_t
*)
o
->
±r
è+ 
HLL_HDR_SIZE
;

630 
’d
 = 
p
 + 
	`sd¦’
(
o
->
±r
è- 
HLL_HDR_SIZE
;

632 
fœ¡
 = 0;

633 
´ev
 = 
NULL
;

634 
Ãxt
 = 
NULL
;

635 
¥ª
 = 0;

636 
p
 < 
’d
) {

637 
İËn
;

644 
İËn
 = 1;

645 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

646 
¥ª
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

647 } ià(
	`HLL_SPARSE_IS_VAL
(
p
)) {

648 
¥ª
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

650 
¥ª
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

651 
İËn
 = 2;

654 ià(
šdex
 <ğ
fœ¡
+
¥ª
-1) ;

655 
´ev
 = 
p
;

656 
p
 +ğ
İËn
;

657 
fœ¡
 +ğ
¥ª
;

659 ià(
¥ª
 == 0)  -1;

661 
Ãxt
 = 
	`HLL_SPARSE_IS_XZERO
(
p
) ?…+2 :…+1;

662 ià(
Ãxt
 >ğ
’d
èÃxˆğ
NULL
;

667 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

668 
is_z”o
 = 1;

669 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

670 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

671 
is_xz”o
 = 1;

672 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

674 
is_v®
 = 1;

675 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

699 ià(
is_v®
) {

700 
ŞdcouÁ
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

702 ià(
ŞdcouÁ
 >ğ
couÁ
)  0;

705 ià(
ruÆ’
 == 1) {

706 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

707 
upd©ed
;

713 ià(
is_z”o
 && 
ruÆ’
 == 1) {

714 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

715 
upd©ed
;

733 
ušt8_t
 
£q
[5], *
n
 = seq;

734 
Ï¡
 = 
fœ¡
+
¥ª
-1;

735 
Ën
;

737 ià(
is_z”o
 || 
is_xz”o
) {

739 ià(
šdex
 !ğ
fœ¡
) {

740 
Ën
 = 
šdex
-
fœ¡
;

741 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

742 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

743 
n
 += 2;

745 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

746 
n
++;

749 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

750 
n
++;

751 ià(
šdex
 !ğ
Ï¡
) {

752 
Ën
 = 
Ï¡
-
šdex
;

753 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

754 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

755 
n
 += 2;

757 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

758 
n
++;

763 
curv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

765 ià(
šdex
 !ğ
fœ¡
) {

766 
Ën
 = 
šdex
-
fœ¡
;

767 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

768 
n
++;

770 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

771 
n
++;

772 ià(
šdex
 !ğ
Ï¡
) {

773 
Ën
 = 
Ï¡
-
šdex
;

774 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

775 
n
++;

783 
£qËn
 = 
n
-
£q
;

784 
ŞdËn
 = 
is_xz”o
 ? 2 : 1;

785 
d–Ën
 = 
£qËn
-
ŞdËn
;

787 ià(
d–Ën
 > 0 &&

788 
	`sd¦’
(
o
->
±r
)+
d–Ën
 > 
£rv”
.
hÎ_¥¬£_max_by‹s
è
´omÙe
;

789 ià(
d–Ën
 && 
Ãxt
è
	`memmove
Òext+d–Ën,Ãxt,
’d
-next);

790 
	`sdsInüL’
(
o
->
±r
,
d–Ën
);

791 
	`memıy
(
p
,
£q
,
£qËn
);

792 
’d
 +ğ
d–Ën
;

794 
upd©ed
:

800 
p
 = 
´ev
 ?…»v : 
¥¬£
;

801 
sÿÆ’
 = 5;

802 
p
 < 
’d
 && 
sÿÆ’
--) {

803 ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

804 
p
 += 2;

806 } ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

807 
p
++;

812 ià(
p
+1 < 
’d
 && 
	`HLL_SPARSE_IS_VAL
(p+1)) {

813 
v1
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

814 
v2
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
+1);

815 ià(
v1
 =ğ
v2
) {

816 
Ën
 = 
	`HLL_SPARSE_VAL_LEN
(
p
)+HLL_SPARSE_VAL_LEN(p+1);

817 ià(
Ën
 <ğ
HLL_SPARSE_VAL_MAX_LEN
) {

818 
	`HLL_SPARSE_VAL_SET
(
p
+1,
v1
,
Ën
);

819 
	`memmove
(
p
,p+1,
’d
-p);

820 
	`sdsInüL’
(
o
->
±r
,-1);

821 
’d
--;

829 
p
++;

833 
hdr
 = 
o
->
±r
;

834 
	`HLL_INVALIDATE_CACHE
(
hdr
);

837 
´omÙe
:

838 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
)  -1;

839 
hdr
 = 
o
->
±r
;

848 
d’£_»tv®
 = 
	`hÎD’£Add
(
hdr
->
»gi¡”s
, 
–e
, 
–esize
);

849 
	`ASSERT
(
d’£_»tv®
 == 1);

850  
d’£_»tv®
;

851 
	}
}

857 
	$hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
) {

858 
E
 = 0;

859 
ez
 = 0, 
idx
 = 0, 
ruÆ’
, 
»gv®
;

860 
ušt8_t
 *
’d
 = 
¥¬£
+
¥¬£Ën
, *
p
 = sparse;

862 
p
 < 
’d
) {

863 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

864 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

865 
idx
 +ğ
ruÆ’
;

866 
ez
 +ğ
ruÆ’
;

868 
p
++;

869 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

870 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

871 
idx
 +ğ
ruÆ’
;

872 
ez
 +ğ
ruÆ’
;

874 
p
 += 2;

876 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

877 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

878 
idx
 +ğ
ruÆ’
;

879 
E
 +ğ
PE
[
»gv®
]*
ruÆ’
;

880 
p
++;

883 ià(
idx
 !ğ
HLL_REGISTERS
 && 
šv®id
) *invalid = 1;

884 
E
 +ğ
ez
;

885 *
ezp
 = 
ez
;

886  
E
;

887 
	}
}

897 
	$hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

898 
E
 = 0;

899 
j
, 
ez
 = 0;

900 
ušt64_t
 *
wÜd
 = (ušt64_t*è
»gi¡”s
;

901 
ušt8_t
 *
by‹s
;

903 
j
 = 0; j < 
HLL_REGISTERS
/8; j++) {

904 ià(*
wÜd
 == 0) {

905 
ez
 += 8;

907 
by‹s
 = (
ušt8_t
*è
wÜd
;

908 ià(
by‹s
[0]è
E
 +ğ
PE
[by‹s[0]]; 
ez
++;

909 ià(
by‹s
[1]è
E
 +ğ
PE
[by‹s[1]]; 
ez
++;

910 ià(
by‹s
[2]è
E
 +ğ
PE
[by‹s[2]]; 
ez
++;

911 ià(
by‹s
[3]è
E
 +ğ
PE
[by‹s[3]]; 
ez
++;

912 ià(
by‹s
[4]è
E
 +ğ
PE
[by‹s[4]]; 
ez
++;

913 ià(
by‹s
[5]è
E
 +ğ
PE
[by‹s[5]]; 
ez
++;

914 ià(
by‹s
[6]è
E
 +ğ
PE
[by‹s[6]]; 
ez
++;

915 ià(
by‹s
[7]è
E
 +ğ
PE
[by‹s[7]]; 
ez
++;

917 
wÜd
++;

919 
E
 +ğ
ez
;

921 *
ezp
 = 
ez
;

922  
E
;

923 
	}
}

936 
ušt64_t
 
	$hÎCouÁ
(
hÎhdr
 *
hdr
, *
šv®id
) {

937 
m
 = 
HLL_REGISTERS
;

938 
E
, 
®pha
 = 0.7213/(1+1.079/
m
);

939 
j
, 
ez
;

943 
š™Ÿlized
 = 0;

944 
PE
[64];

945 ià(!
š™Ÿlized
) {

946 
PE
[0] = 1;

947 
j
 = 1; j < 64; j++) {

949 
PE
[
j
] = 1.0/(1ULL << j);

951 
š™Ÿlized
 = 1;

955 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

956 
E
 = 
	`hÎD’£Sum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

957 } ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

958 
E
 = 
	`hÎS·r£Sum
(
hdr
->
»gi¡”s
,

959 
	`sd¦’
((
sds
)
hdr
)-
HLL_HDR_SIZE
,
PE
,&
ez
,
šv®id
);

960 } ià(
hdr
->
’codšg
 =ğ
HLL_RAW
) {

961 
E
 = 
	`hÎRawSum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

963 
	`£rv”Pªic
("Unknown HyperLogLogƒncoding in hllCount()");

967 
E
 = (1/E)*
®pha
*
m
*m;

974 ià(
E
 < 
m
*2.5 && 
ez
 != 0) {

975 
E
 = 
m
*
	`log
(m/
ez
);

976 } ià(
m
 =ğ16384 && 
E
 < 72000) {

981 
bŸs
 = 5.9119*1.0e-18*(
E
*E*E*E)

982 -1.4253*1.0e-12*(
E
*E*E)+

983 1.2940*1.0e-7*(
E
*E)

984 -5.2921*1.0e-3*
E
+

986 
E
 -ğE*(
bŸs
/100);

992  (
ušt64_t
è
E
;

993 
	}
}

996 
	$hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

997 
hÎhdr
 *
hdr
 = 
o
->
±r
;

998 
hdr
->
’codšg
) {

999 
HLL_DENSE
:  
	`hÎD’£Add
(
hdr
->
»gi¡”s
,
–e
,
–esize
);

1000 
HLL_SPARSE
:  
	`hÎS·r£Add
(
o
,
–e
,
–esize
);

1003 
	}
}

1013 
	$hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
) {

1014 
hÎhdr
 *
hdr
 = 
hÎ
->
±r
;

1015 
i
;

1017 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

1018 
ušt8_t
 
v®
;

1020 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1021 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1022 ià(
v®
 > 
max
[
i
]) max[i] = val;

1025 
ušt8_t
 *
p
 = 
hÎ
->
±r
, *
’d
 =… + 
	`sd¦’
(hll->ptr);

1026 
ruÆ’
, 
»gv®
;

1028 
p
 +ğ
HLL_HDR_SIZE
;

1029 
i
 = 0;

1030 
p
 < 
’d
) {

1031 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1032 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1033 
i
 +ğ
ruÆ’
;

1034 
p
++;

1035 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1036 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1037 
i
 +ğ
ruÆ’
;

1038 
p
 += 2;

1040 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1041 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1042 
ruÆ’
--) {

1043 ià(
»gv®
 > 
max
[
i
]) max[i] =„egval;

1044 
i
++;

1046 
p
++;

1049 ià(
i
 !ğ
HLL_REGISTERS
è 
VR_ERROR
;

1051  
VR_OK
;

1052 
	}
}

1058 
robj
 *
	$ü—‹HLLObjeù
() {

1059 
robj
 *
o
;

1060 
hÎhdr
 *
hdr
;

1061 
sds
 
s
;

1062 
ušt8_t
 *
p
;

1063 
¥¬£Ën
 = 
HLL_HDR_SIZE
 +

1064 (((
HLL_REGISTERS
+(
HLL_SPARSE_XZERO_MAX_LEN
-1)) /

1065 
HLL_SPARSE_XZERO_MAX_LEN
)*2);

1066 
aux
;

1070 
aux
 = 
HLL_REGISTERS
;

1071 
s
 = 
	`sd¢ewËn
(
NULL
,
¥¬£Ën
);

1072 
p
 = (
ušt8_t
*)
s
 + 
HLL_HDR_SIZE
;

1073 
aux
) {

1074 
xz”o
 = 
HLL_SPARSE_XZERO_MAX_LEN
;

1075 ià(
xz”o
 > 
aux
) xzero =‡ux;

1076 
	`HLL_SPARSE_XZERO_SET
(
p
,
xz”o
);

1077 
p
 += 2;

1078 
aux
 -ğ
xz”o
;

1080 
	`ASSERT
((
p
-(
ušt8_t
*)
s
è=ğ
¥¬£Ën
);

1083 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

1084 
hdr
 = 
o
->
±r
;

1085 
	`memıy
(
hdr
->
magic
,"HYLL",4);

1086 
hdr
->
’codšg
 = 
HLL_SPARSE
;

1087  
o
;

1088 
	}
}

1093 
	$isHLLObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
) {

1094 
hÎhdr
 *
hdr
;

1097 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

1098  
VR_ERROR
;

1100 ià(
	`¡ršgObjeùL’
(
o
è< (*
hdr
)è
šv®id
;

1101 
hdr
 = 
o
->
±r
;

1104 ià(
hdr
->
magic
[0] != 'H' || hdr->magic[1] != 'Y' ||

1105 
hdr
->
magic
[2] !ğ'L' || hdr->magic[3] !ğ'L'è
šv®id
;

1107 ià(
hdr
->
’codšg
 > 
HLL_MAX_ENCODING
è
šv®id
;

1110 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
 &&

1111 
	`¡ršgObjeùL’
(
o
è!ğ
HLL_DENSE_SIZE
è
šv®id
;

1114  
VR_OK
;

1116 
šv®id
:

1117 
	`addR•lySds
(
c
,

1118 
	`sd¢ew
("-WRONGTYPE Key is‚ot‡ valid "

1120  
VR_ERROR
;

1121 
	}
}

1124 
	$pçddCommªd
(
ş›Á
 *
c
) {

1125 
robj
 *
o
;

1126 
hÎhdr
 *
hdr
;

1127 
upd©ed
 = 0, 
j
;

1128 
expœed
 = 0;

1130 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

1131 
	`lockDbWr™e
(
c
->
db
);

1132 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

1133 ià(
o
 =ğ
NULL
) {

1137 
o
 = 
	`ü—‹HLLObjeù
();

1138 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1139 
upd©ed
++;

1141 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) {

1142 
	`uÆockDb
(
c
->
db
);

1143 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1146 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1149 
j
 = 2; j < 
c
->
¬gc
; j++) {

1150 
»tv®
 = 
	`hÎAdd
(
o
, (*)
c
->
¬gv
[
j
]->
±r
,

1151 
	`sd¦’
(
c
->
¬gv
[
j
]->
±r
));

1152 
»tv®
) {

1154 
upd©ed
++;

1157 
	`uÆockDb
(
c
->
db
);

1158 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1159 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1163 
hdr
 = 
o
->
±r
;

1164 ià(
upd©ed
) {

1165 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1166 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1167 
c
->
v–
->
dœty
++;

1168 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1170 
	`addR•ly
(
c
, 
upd©ed
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1171 
	`uÆockDb
(
c
->
db
);

1172 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1173 
	}
}

1176 
	$pfcouÁCommªd
(
ş›Á
 *
c
) {

1177 
robj
 *
o
;

1178 
hÎhdr
 *
hdr
;

1179 
ušt64_t
 
ÿrd
;

1180 
expœed
;

1186 ià(
c
->
¬gc
 > 2) {

1187 
ušt8_t
 
max
[
HLL_HDR_SIZE
+
HLL_REGISTERS
], *
»gi¡”s
;

1188 
j
;

1191 
	`mem£t
(
max
,0,(max));

1192 
hdr
 = (
hÎhdr
*è
max
;

1193 
hdr
->
’codšg
 = 
HLL_RAW
;

1194 
»gi¡”s
 = 
max
 + 
HLL_HDR_SIZE
;

1195 
j
 = 1; j < 
c
->
¬gc
; j++) {

1197 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

1198 
	`lockDbR—d
(
c
->
db
);

1199 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1200 ià(
o
 =ğ
NULL
) {

1201 
	`uÆockDb
(
c
->
db
);

1204 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) {

1205 
	`uÆockDb
(
c
->
db
);

1210 ià(
	`hÎM”ge
(
»gi¡”s
,
o
è=ğ
VR_ERROR
) {

1211 
	`uÆockDb
(
c
->
db
);

1212 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1216 
	`uÆockDb
(
c
->
db
);

1220 
	`addR•lyLÚgLÚg
(
c
,
	`hÎCouÁ
(
hdr
,
NULL
));

1228 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[1]);

1229 
	`lockDbWr™e
(
c
->
db
);

1230 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

1231 ià(
o
 =ğ
NULL
) {

1234 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1236 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) {

1237 
	`uÆockDb
(
c
->
db
);

1238 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1241 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1244 
hdr
 = 
o
->
±r
;

1245 ià(
	`HLL_VALID_CACHE
(
hdr
)) {

1247 
ÿrd
 = (
ušt64_t
)
hdr
->card[0];

1248 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[1] << 8;

1249 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[2] << 16;

1250 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[3] << 24;

1251 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[4] << 32;

1252 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[5] << 40;

1253 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[6] << 48;

1254 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[7] << 56;

1256 
šv®id
 = 0;

1258 
ÿrd
 = 
	`hÎCouÁ
(
hdr
,&
šv®id
);

1259 ià(
šv®id
) {

1260 
	`uÆockDb
(
c
->
db
);

1261 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1262 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1265 
hdr
->
ÿrd
[0] = card & 0xff;

1266 
hdr
->
ÿrd
[1] = (card >> 8) & 0xff;

1267 
hdr
->
ÿrd
[2] = (card >> 16) & 0xff;

1268 
hdr
->
ÿrd
[3] = (card >> 24) & 0xff;

1269 
hdr
->
ÿrd
[4] = (card >> 32) & 0xff;

1270 
hdr
->
ÿrd
[5] = (card >> 40) & 0xff;

1271 
hdr
->
ÿrd
[6] = (card >> 48) & 0xff;

1272 
hdr
->
ÿrd
[7] = (card >> 56) & 0xff;

1277 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1278 
£rv”
.
dœty
++;

1279 
c
->
v–
->
dœty
++;

1281 
	`addR•lyLÚgLÚg
(
c
,
ÿrd
);

1284 
	`uÆockDb
(
c
->
db
);

1285 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1286 
	}
}

1289 
	$pfm”geCommªd
(
ş›Á
 *
c
) {

1290 
ušt8_t
 
max
[
HLL_REGISTERS
];

1291 
hÎhdr
 *
hdr
;

1292 
j
;

1297 
	`mem£t
(
max
,0,(max));

1298 
j
 = 1; j < 
c
->
¬gc
; j++) {

1300 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1301 ià(
o
 =ğ
NULL
) ;

1302 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) ;

1306 ià(
	`hÎM”ge
(
max
,
o
è=ğ
VR_ERROR
) {

1307 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1313 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
NULL
);

1314 ià(
o
 =ğ
NULL
) {

1318 
o
 = 
	`ü—‹HLLObjeù
();

1319 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1324 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1328 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
) {

1329 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1335 
hdr
 = 
o
->
±r
;

1336 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1337 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
j
,
max
[j]);

1339 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1341 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1344 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1345 
£rv”
.
dœty
++;

1346 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1347 
	}
}

1354 
	#HLL_TEST_CYCLES
 1000

	)

1355 
	$pf£láe¡Commªd
(
ş›Á
 *
c
) {

1356 
j
, 
i
;

1357 
sds
 
b™couÁ”s
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

1358 
hÎhdr
 *
hdr
 = (hÎhdr*è
b™couÁ”s
, *
hdr2
;

1359 
robj
 *
o
 = 
NULL
;

1360 
ušt8_t
 
by‹couÁ”s
[
HLL_REGISTERS
];

1366 
j
 = 0; j < 
HLL_TEST_CYCLES
; j++) {

1369 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1370 
r
 = 
	`¿nd
(è& 
HLL_REGISTER_MAX
;

1372 
by‹couÁ”s
[
i
] = 
r
;

1373 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
i
,
r
);

1376 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1377 
v®
;

1379 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1380 ià(
v®
 !ğ
by‹couÁ”s
[
i
]) {

1381 
	`addR•lyE¼ÜFÜm©
(
c
,

1383 
i
, (è
by‹couÁ”s
[i], (è
v®
);

1384 
ş—nup
;

1399 
	`mem£t
(
hdr
->
»gi¡”s
,0,
HLL_DENSE_SIZE
-
HLL_HDR_SIZE
);

1400 
o
 = 
	`ü—‹HLLObjeù
();

1401 
»Ë¼
 = 1.04/
	`sq¹
(
HLL_REGISTERS
);

1402 
št64_t
 
checkpošt
 = 1;

1403 
ušt64_t
 
£ed
 = (ušt64_t)
	`¿nd
() | (uint64_t)rand() << 32;

1404 
ušt64_t
 
–e
;

1405 
j
 = 1; j <= 10000000; j++) {

1406 
–e
 = 
j
 ^ 
£ed
;

1407 
	`hÎD’£Add
(
hdr
->
»gi¡”s
,(*)&
–e
,(ele));

1408 
	`hÎAdd
(
o
,(*)&
–e
,(ele));

1412 ià(
j
 =ğ
checkpošt
 && j < 
£rv”
.
hÎ_¥¬£_max_by‹s
/2) {

1413 
hdr2
 = 
o
->
±r
;

1414 ià(
hdr2
->
’codšg
 !ğ
HLL_SPARSE
) {

1415 
	`addR•lyE¼Ü
(
c
, "TESTFAILED sparseƒncoding‚ot used");

1416 
ş—nup
;

1421 ià(
j
 =ğ
checkpošt
 && 
	`hÎCouÁ
(
hdr
,
NULL
è!ğhÎCouÁ(
o
->
±r
,NULL)) {

1422 
	`addR•lyE¼Ü
(
c
, "TESTFAILED dense/sparse disagree");

1423 
ş—nup
;

1427 ià(
j
 =ğ
checkpošt
) {

1428 
št64_t
 
ab£¼
 = 
checkpošt
 - (št64_t)
	`hÎCouÁ
(
hdr
,
NULL
);

1429 
ušt64_t
 
max”r
 = 
	`û
(
»Ë¼
*6*
checkpošt
);

1435 ià(
j
 =ğ10è
max”r
 = 1;

1437 ià(
ab£¼
 < 0)‡bserr = -abserr;

1438 ià(
ab£¼
 > (
št64_t
)
max”r
) {

1439 
	`addR•lyE¼ÜFÜm©
(
c
,

1441 (è
checkpošt
,

1442 (è
ab£¼
);

1443 
ş—nup
;

1445 
checkpošt
 *= 10;

1450 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1452 
ş—nup
:

1453 
	`sdsä“
(
b™couÁ”s
);

1454 ià(
o
è
	`deüRefCouÁ
(o);

1455 
	}
}

1459 
	$pfdebugCommªd
(
ş›Á
 *
c
) {

1460 *
cmd
 = 
c
->
¬gv
[1]->
±r
;

1461 
hÎhdr
 *
hdr
;

1462 
robj
 *
o
;

1463 
j
;

1465 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
);

1466 ià(
o
 =ğ
NULL
) {

1467 
	`addR•lyE¼Ü
(
c
,"The specified key does‚otƒxist");

1470 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
VR_OK
) ;

1471 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[2],o);

1472 
hdr
 = 
o
->
±r
;

1475 ià(!
	`¡rÿ£cmp
(
cmd
,"getreg")) {

1476 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1478 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1479 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
) {

1480 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1483 
£rv”
.
dœty
++;

1486 
hdr
 = 
o
->
±r
;

1487 
	`addR•lyMuÉiBulkL’
(
c
,
HLL_REGISTERS
);

1488 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1489 
ušt8_t
 
v®
;

1491 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
j
);

1492 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1496 ià(!
	`¡rÿ£cmp
(
cmd
,"decode")) {

1497 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1499 
ušt8_t
 *
p
 = 
o
->
±r
, *
’d
 =…+
	`sd¦’
(o->ptr);

1500 
sds
 
decoded
 = 
	`sd£m±y
();

1502 ià(
hdr
->
’codšg
 !ğ
HLL_SPARSE
) {

1503 
	`addR•lyE¼Ü
(
c
,"HLLƒncoding is‚ot sparse");

1507 
p
 +ğ
HLL_HDR_SIZE
;

1508 
p
 < 
’d
) {

1509 
ruÆ’
, 
»gv®
;

1511 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1512 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1513 
p
++;

1514 
decoded
 = 
	`sdsÿrštf
(decoded,"z:%d ",
ruÆ’
);

1515 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1516 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1517 
p
 += 2;

1518 
decoded
 = 
	`sdsÿrštf
(decoded,"Z:%d ",
ruÆ’
);

1520 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1521 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1522 
p
++;

1523 
decoded
 = 
	`sdsÿrštf
(decoded,"v:%d,%d ",
»gv®
,
ruÆ’
);

1526 
decoded
 = 
	`sd¡rim
(decoded," ");

1527 
	`addR•lyBulkCBufãr
(
c
,
decoded
,
	`sd¦’
(decoded));

1528 
	`sdsä“
(
decoded
);

1531 ià(!
	`¡rÿ£cmp
(
cmd
,"encoding")) {

1532 *
’codšg¡r
[2] = {"dense","sparse"};

1533 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1535 
	`addR•lyStus
(
c
,
’codšg¡r
[
hdr
->
’codšg
]);

1538 ià(!
	`¡rÿ£cmp
(
cmd
,"todense")) {

1539 
cÚv
 = 0;

1540 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1542 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1543 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
VR_ERROR
) {

1544 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1547 
cÚv
 = 1;

1548 
£rv”
.
dœty
++;

1550 
	`addR•ly
(
c
,
cÚv
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1552 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀPFDEBUG subcommªd '%s'", 
cmd
);

1556 
¬™y”r
:

1557 
	`addR•lyE¼ÜFÜm©
(
c
,

1558 "WrÚg‚umb” oà¬gum’t fÜh'%s' subcommªd",
cmd
);

1559 
	}
}

	@src/vr_hyperloglog.h

1 #iâdeà
_VR_HYPERLOGLOG_H_


2 
	#_VR_HYPERLOGLOG_H_


	)

4 
ušt64_t
 
MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
);

5 
hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
);

6 
hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
);

7 
hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
);

8 
hÎS·r£ToD’£
(
robj
 *
o
);

9 
hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
);

10 
hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
);

11 
hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
);

12 
hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
);

13 
hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
);

14 
robj
 *
ü—‹HLLObjeù
();

15 
isHLLObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
);

16 
pçddCommªd
(
ş›Á
 *
c
);

17 
pfcouÁCommªd
(
ş›Á
 *
c
);

18 
pfm”geCommªd
(
ş›Á
 *
c
);

19 
pf£láe¡Commªd
(
ş›Á
 *
c
);

20 
pfdebugCommªd
(
ş›Á
 *
c
);

	@src/vr_hyperloglog.h

1 #iâdeà
_VR_HYPERLOGLOG_H_


2 
	#_VR_HYPERLOGLOG_H_


	)

4 
ušt64_t
 
MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
);

5 
hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
);

6 
hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
);

7 
hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
);

8 
hÎS·r£ToD’£
(
robj
 *
o
);

9 
hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
);

10 
hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
);

11 
hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
);

12 
hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
);

13 
hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
);

14 
robj
 *
ü—‹HLLObjeù
();

15 
isHLLObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
);

16 
pçddCommªd
(
ş›Á
 *
c
);

17 
pfcouÁCommªd
(
ş›Á
 *
c
);

18 
pfm”geCommªd
(
ş›Á
 *
c
);

19 
pf£láe¡Commªd
(
ş›Á
 *
c
);

20 
pfdebugCommªd
(
ş›Á
 *
c
);

	@src/vr_intset.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

5 
	~<vr_cÜe.h
>

9 
	#INTSET_ENC_INT16
 ((
št16_t
))

	)

10 
	#INTSET_ENC_INT32
 ((
št32_t
))

	)

11 
	#INTSET_ENC_INT64
 ((
št64_t
))

	)

14 
ušt8_t
 
	$_št£tV®ueEncodšg
(
št64_t
 
v
) {

15 ià(
v
 < 
INT32_MIN
 || v > 
INT32_MAX
)

16  
INTSET_ENC_INT64
;

17 ià(
v
 < 
INT16_MIN
 || v > 
INT16_MAX
)

18  
INTSET_ENC_INT32
;

20  
INTSET_ENC_INT16
;

21 
	}
}

24 
št64_t
 
	$_št£tG‘Encoded
(
št£t
 *
is
, 
pos
, 
ušt8_t
 
’c
) {

25 
št64_t
 
v64
;

26 
št32_t
 
v32
;

27 
št16_t
 
v16
;

29 ià(
’c
 =ğ
INTSET_ENC_INT64
) {

30 
	`memıy
(&
v64
,((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
,(v64));

31 
	`mem»v64ifbe
(&
v64
);

32  
v64
;

33 } ià(
’c
 =ğ
INTSET_ENC_INT32
) {

34 
	`memıy
(&
v32
,((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
,(v32));

35 
	`mem»v32ifbe
(&
v32
);

36  
v32
;

38 
	`memıy
(&
v16
,((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
,(v16));

39 
	`mem»v16ifbe
(&
v16
);

40  
v16
;

42 
	}
}

45 
št64_t
 
	$_št£tG‘
(
št£t
 *
is
, 
pos
) {

46  
	`_št£tG‘Encoded
(
is
,
pos
,
	`šŒev32ifbe
(is->
’codšg
));

47 
	}
}

50 
	$_št£tS‘
(
št£t
 *
is
, 
pos
, 
št64_t
 
v®ue
) {

51 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

53 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

54 ((
št64_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

55 
	`mem»v64ifbe
(((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
);

56 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

57 ((
št32_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

58 
	`mem»v32ifbe
(((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
);

60 ((
št16_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

61 
	`mem»v16ifbe
(((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
);

63 
	}
}

66 
št£t
 *
	$št£tNew
() {

67 
št£t
 *
is
 = 
	`d®loc
((intset));

68 
is
->
’codšg
 = 
	`šŒev32ifbe
(
INTSET_ENC_INT16
);

69 
is
->
Ëngth
 = 0;

70  
is
;

71 
	}
}

74 
št£t
 *
	$št£tResize
(
št£t
 *
is
, 
ušt32_t
 
Ën
) {

75 
ušt32_t
 
size
 = 
Ën
*
	`šŒev32ifbe
(
is
->
’codšg
);

76 
is
 = 
	`d»®loc
(is,(
št£t
)+
size
);

77  
is
;

78 
	}
}

84 
ušt8_t
 
	$št£tS—rch
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt32_t
 *
pos
) {

85 
mš
 = 0, 
max
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-1, 
mid
 = -1;

86 
št64_t
 
cur
 = -1;

89 ià(
	`šŒev32ifbe
(
is
->
Ëngth
) == 0) {

90 ià(
pos
) *pos = 0;

95 ià(
v®ue
 > 
	`_št£tG‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
)-1)) {

96 ià(
pos
è*po ğ
	`šŒev32ifbe
(
is
->
Ëngth
);

98 } ià(
v®ue
 < 
	`_št£tG‘
(
is
,0)) {

99 ià(
pos
) *pos = 0;

104 
max
 >ğ
mš
) {

105 
mid
 = (()
mš
 + ()
max
) >> 1;

106 
cur
 = 
	`_št£tG‘
(
is
,
mid
);

107 ià(
v®ue
 > 
cur
) {

108 
mš
 = 
mid
+1;

109 } ià(
v®ue
 < 
cur
) {

110 
max
 = 
mid
-1;

116 ià(
v®ue
 =ğ
cur
) {

117 ià(
pos
è*po ğ
mid
;

120 ià(
pos
è*po ğ
mš
;

123 
	}
}

126 
št£t
 *
	$št£tUpg¿deAndAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

127 
ušt8_t
 
cu»nc
 = 
	`šŒev32ifbe
(
is
->
’codšg
);

128 
ušt8_t
 
Ãw’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

129 
Ëngth
 = 
	`šŒev32ifbe
(
is
->length);

130 
´•’d
 = 
v®ue
 < 0 ? 1 : 0;

133 
is
->
’codšg
 = 
	`šŒev32ifbe
(
Ãw’c
);

134 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

139 
Ëngth
--)

140 
	`_št£tS‘
(
is
,
Ëngth
+
´•’d
,
	`_št£tG‘Encoded
(is,Ëngth,
cu»nc
));

143 ià(
´•’d
)

144 
	`_št£tS‘
(
is
,0,
v®ue
);

146 
	`_št£tS‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
),
v®ue
);

147 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

148  
is
;

149 
	}
}

151 
	$št£tMoveTa
(
št£t
 *
is
, 
ušt32_t
 
äom
, ušt32_ˆ
to
) {

152 *
¤c
, *
d¡
;

153 
ušt32_t
 
by‹s
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-
äom
;

154 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

156 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

157 
¤c
 = (
št64_t
*)
is
->
cÚ‹Ás
+
äom
;

158 
d¡
 = (
št64_t
*)
is
->
cÚ‹Ás
+
to
;

159 
by‹s
 *ğ(
št64_t
);

160 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

161 
¤c
 = (
št32_t
*)
is
->
cÚ‹Ás
+
äom
;

162 
d¡
 = (
št32_t
*)
is
->
cÚ‹Ás
+
to
;

163 
by‹s
 *ğ(
št32_t
);

165 
¤c
 = (
št16_t
*)
is
->
cÚ‹Ás
+
äom
;

166 
d¡
 = (
št16_t
*)
is
->
cÚ‹Ás
+
to
;

167 
by‹s
 *ğ(
št16_t
);

169 
	`memmove
(
d¡
,
¤c
,
by‹s
);

170 
	}
}

173 
št£t
 *
	$št£tAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
) {

174 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

175 
ušt32_t
 
pos
;

176 ià(
sucûss
) *success = 1;

181 ià(
v®’c
 > 
	`šŒev32ifbe
(
is
->
’codšg
)) {

183  
	`št£tUpg¿deAndAdd
(
is
,
v®ue
);

188 ià(
	`št£tS—rch
(
is
,
v®ue
,&
pos
)) {

189 ià(
sucûss
) *success = 0;

190  
is
;

193 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

194 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)è
	`št£tMoveTa
(is,pos,pos+1);

197 
	`_št£tS‘
(
is
,
pos
,
v®ue
);

198 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

199  
is
;

200 
	}
}

203 
št£t
 *
	$št£tRemove
(
št£t
 *
is
, 
št64_t
 
v®ue
, *
sucûss
) {

204 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

205 
ušt32_t
 
pos
;

206 ià(
sucûss
) *success = 0;

208 ià(
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,&
pos
)) {

209 
ušt32_t
 
Ën
 = 
	`šŒev32ifbe
(
is
->
Ëngth
);

212 ià(
sucûss
) *success = 1;

215 ià(
pos
 < (
Ën
-1)è
	`št£tMoveTa
(
is
,pos+1,pos);

216 
is
 = 
	`št£tResize
(is,
Ën
-1);

217 
is
->
Ëngth
 = 
	`šŒev32ifbe
(
Ën
-1);

219  
is
;

220 
	}
}

223 
ušt8_t
 
	$št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

224 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

225  
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,
NULL
);

226 
	}
}

229 
št64_t
 
	$št£tRªdom
(
št£t
 *
is
) {

230  
	`_št£tG‘
(
is
,
	`¿nd
()%
	`šŒev32ifbe
(is->
Ëngth
));

231 
	}
}

235 
ušt8_t
 
	$št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
) {

236 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)) {

237 *
v®ue
 = 
	`_št£tG‘
(
is
,
pos
);

241 
	}
}

244 
ušt32_t
 
	$št£tL’
(
št£t
 *
is
) {

245  
	`šŒev32ifbe
(
is
->
Ëngth
);

246 
	}
}

249 
size_t
 
	$št£tBlobL’
(
št£t
 *
is
) {

250  (
št£t
)+
	`šŒev32ifbe
(
is
->
Ëngth
)*šŒev32ifbe(is->
’codšg
);

251 
	}
}

	@src/vr_intset.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

5 
	~<vr_cÜe.h
>

9 
	#INTSET_ENC_INT16
 ((
št16_t
))

	)

10 
	#INTSET_ENC_INT32
 ((
št32_t
))

	)

11 
	#INTSET_ENC_INT64
 ((
št64_t
))

	)

14 
ušt8_t
 
	$_št£tV®ueEncodšg
(
št64_t
 
v
) {

15 ià(
v
 < 
INT32_MIN
 || v > 
INT32_MAX
)

16  
INTSET_ENC_INT64
;

17 ià(
v
 < 
INT16_MIN
 || v > 
INT16_MAX
)

18  
INTSET_ENC_INT32
;

20  
INTSET_ENC_INT16
;

21 
	}
}

24 
št64_t
 
	$_št£tG‘Encoded
(
št£t
 *
is
, 
pos
, 
ušt8_t
 
’c
) {

25 
št64_t
 
v64
;

26 
št32_t
 
v32
;

27 
št16_t
 
v16
;

29 ià(
’c
 =ğ
INTSET_ENC_INT64
) {

30 
	`memıy
(&
v64
,((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
,(v64));

31 
	`mem»v64ifbe
(&
v64
);

32  
v64
;

33 } ià(
’c
 =ğ
INTSET_ENC_INT32
) {

34 
	`memıy
(&
v32
,((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
,(v32));

35 
	`mem»v32ifbe
(&
v32
);

36  
v32
;

38 
	`memıy
(&
v16
,((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
,(v16));

39 
	`mem»v16ifbe
(&
v16
);

40  
v16
;

42 
	}
}

45 
št64_t
 
	$_št£tG‘
(
št£t
 *
is
, 
pos
) {

46  
	`_št£tG‘Encoded
(
is
,
pos
,
	`šŒev32ifbe
(is->
’codšg
));

47 
	}
}

50 
	$_št£tS‘
(
št£t
 *
is
, 
pos
, 
št64_t
 
v®ue
) {

51 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

53 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

54 ((
št64_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

55 
	`mem»v64ifbe
(((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
);

56 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

57 ((
št32_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

58 
	`mem»v32ifbe
(((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
);

60 ((
št16_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

61 
	`mem»v16ifbe
(((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
);

63 
	}
}

66 
št£t
 *
	$št£tNew
() {

67 
št£t
 *
is
 = 
	`d®loc
((intset));

68 
is
->
’codšg
 = 
	`šŒev32ifbe
(
INTSET_ENC_INT16
);

69 
is
->
Ëngth
 = 0;

70  
is
;

71 
	}
}

74 
št£t
 *
	$št£tResize
(
št£t
 *
is
, 
ušt32_t
 
Ën
) {

75 
ušt32_t
 
size
 = 
Ën
*
	`šŒev32ifbe
(
is
->
’codšg
);

76 
is
 = 
	`d»®loc
(is,(
št£t
)+
size
);

77  
is
;

78 
	}
}

84 
ušt8_t
 
	$št£tS—rch
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt32_t
 *
pos
) {

85 
mš
 = 0, 
max
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-1, 
mid
 = -1;

86 
št64_t
 
cur
 = -1;

89 ià(
	`šŒev32ifbe
(
is
->
Ëngth
) == 0) {

90 ià(
pos
) *pos = 0;

95 ià(
v®ue
 > 
	`_št£tG‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
)-1)) {

96 ià(
pos
è*po ğ
	`šŒev32ifbe
(
is
->
Ëngth
);

98 } ià(
v®ue
 < 
	`_št£tG‘
(
is
,0)) {

99 ià(
pos
) *pos = 0;

104 
max
 >ğ
mš
) {

105 
mid
 = (()
mš
 + ()
max
) >> 1;

106 
cur
 = 
	`_št£tG‘
(
is
,
mid
);

107 ià(
v®ue
 > 
cur
) {

108 
mš
 = 
mid
+1;

109 } ià(
v®ue
 < 
cur
) {

110 
max
 = 
mid
-1;

116 ià(
v®ue
 =ğ
cur
) {

117 ià(
pos
è*po ğ
mid
;

120 ià(
pos
è*po ğ
mš
;

123 
	}
}

126 
št£t
 *
	$št£tUpg¿deAndAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

127 
ušt8_t
 
cu»nc
 = 
	`šŒev32ifbe
(
is
->
’codšg
);

128 
ušt8_t
 
Ãw’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

129 
Ëngth
 = 
	`šŒev32ifbe
(
is
->length);

130 
´•’d
 = 
v®ue
 < 0 ? 1 : 0;

133 
is
->
’codšg
 = 
	`šŒev32ifbe
(
Ãw’c
);

134 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

139 
Ëngth
--)

140 
	`_št£tS‘
(
is
,
Ëngth
+
´•’d
,
	`_št£tG‘Encoded
(is,Ëngth,
cu»nc
));

143 ià(
´•’d
)

144 
	`_št£tS‘
(
is
,0,
v®ue
);

146 
	`_št£tS‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
),
v®ue
);

147 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

148  
is
;

149 
	}
}

151 
	$št£tMoveTa
(
št£t
 *
is
, 
ušt32_t
 
äom
, ušt32_ˆ
to
) {

152 *
¤c
, *
d¡
;

153 
ušt32_t
 
by‹s
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-
äom
;

154 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

156 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

157 
¤c
 = (
št64_t
*)
is
->
cÚ‹Ás
+
äom
;

158 
d¡
 = (
št64_t
*)
is
->
cÚ‹Ás
+
to
;

159 
by‹s
 *ğ(
št64_t
);

160 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

161 
¤c
 = (
št32_t
*)
is
->
cÚ‹Ás
+
äom
;

162 
d¡
 = (
št32_t
*)
is
->
cÚ‹Ás
+
to
;

163 
by‹s
 *ğ(
št32_t
);

165 
¤c
 = (
št16_t
*)
is
->
cÚ‹Ás
+
äom
;

166 
d¡
 = (
št16_t
*)
is
->
cÚ‹Ás
+
to
;

167 
by‹s
 *ğ(
št16_t
);

169 
	`memmove
(
d¡
,
¤c
,
by‹s
);

170 
	}
}

173 
št£t
 *
	$št£tAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
) {

174 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

175 
ušt32_t
 
pos
;

176 ià(
sucûss
) *success = 1;

181 ià(
v®’c
 > 
	`šŒev32ifbe
(
is
->
’codšg
)) {

183  
	`št£tUpg¿deAndAdd
(
is
,
v®ue
);

188 ià(
	`št£tS—rch
(
is
,
v®ue
,&
pos
)) {

189 ià(
sucûss
) *success = 0;

190  
is
;

193 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

194 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)è
	`št£tMoveTa
(is,pos,pos+1);

197 
	`_št£tS‘
(
is
,
pos
,
v®ue
);

198 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

199  
is
;

200 
	}
}

203 
št£t
 *
	$št£tRemove
(
št£t
 *
is
, 
št64_t
 
v®ue
, *
sucûss
) {

204 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

205 
ušt32_t
 
pos
;

206 ià(
sucûss
) *success = 0;

208 ià(
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,&
pos
)) {

209 
ušt32_t
 
Ën
 = 
	`šŒev32ifbe
(
is
->
Ëngth
);

212 ià(
sucûss
) *success = 1;

215 ià(
pos
 < (
Ën
-1)è
	`št£tMoveTa
(
is
,pos+1,pos);

216 
is
 = 
	`št£tResize
(is,
Ën
-1);

217 
is
->
Ëngth
 = 
	`šŒev32ifbe
(
Ën
-1);

219  
is
;

220 
	}
}

223 
ušt8_t
 
	$št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

224 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

225  
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,
NULL
);

226 
	}
}

229 
št64_t
 
	$št£tRªdom
(
št£t
 *
is
) {

230  
	`_št£tG‘
(
is
,
	`¿nd
()%
	`šŒev32ifbe
(is->
Ëngth
));

231 
	}
}

235 
ušt8_t
 
	$št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
) {

236 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)) {

237 *
v®ue
 = 
	`_št£tG‘
(
is
,
pos
);

241 
	}
}

244 
ušt32_t
 
	$št£tL’
(
št£t
 *
is
) {

245  
	`šŒev32ifbe
(
is
->
Ëngth
);

246 
	}
}

249 
size_t
 
	$št£tBlobL’
(
št£t
 *
is
) {

250  (
št£t
)+
	`šŒev32ifbe
(
is
->
Ëngth
)*šŒev32ifbe(is->
’codšg
);

251 
	}
}

	@src/vr_intset.h

1 #iâdeà
_VR_INTSET_H_


2 
	#_VR_INTSET_H_


	)

4 
	~<¡dšt.h
>

6 
	sšt£t
 {

7 
ušt32_t
 
	m’codšg
;

8 
ušt32_t
 
	mËngth
;

9 
št8_t
 
	mcÚ‹Ás
[];

10 } 
	tšt£t
;

12 
št£t
 *
št£tNew
();

13 
št£t
 *
št£tAdd
(št£ˆ*
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
);

14 
št£t
 *
št£tRemove
(št£ˆ*
is
, 
št64_t
 
v®ue
, *
sucûss
);

15 
ušt8_t
 
št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
);

16 
št64_t
 
št£tRªdom
(
št£t
 *
is
);

17 
ušt8_t
 
št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
);

18 
ušt32_t
 
št£tL’
(
št£t
 *
is
);

19 
size_t
 
št£tBlobL’
(
št£t
 *
is
);

	@src/vr_intset.h

1 #iâdeà
_VR_INTSET_H_


2 
	#_VR_INTSET_H_


	)

4 
	~<¡dšt.h
>

6 
	sšt£t
 {

7 
ušt32_t
 
	m’codšg
;

8 
ušt32_t
 
	mËngth
;

9 
št8_t
 
	mcÚ‹Ás
[];

10 } 
	tšt£t
;

12 
št£t
 *
št£tNew
();

13 
št£t
 *
št£tAdd
(št£ˆ*
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
);

14 
št£t
 *
št£tRemove
(št£ˆ*
is
, 
št64_t
 
v®ue
, *
sucûss
);

15 
ušt8_t
 
št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
);

16 
št64_t
 
št£tRªdom
(
št£t
 *
is
);

17 
ušt8_t
 
št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
);

18 
ušt32_t
 
št£tL’
(
št£t
 *
is
);

19 
size_t
 
št£tBlobL’
(
št£t
 *
is
);

	@src/vr_listen.c

1 
	~<sys/¡©.h
>

2 
	~<sys/un.h
>

4 
	~<vr_cÜe.h
>

7 
vr_li¡’
 *

8 
	$vr_li¡’_ü—‹
(
sds
 
li¡’_¡r
)

10 
r¡©us_t
 
¡©us
;

11 
vr_li¡’
 *
vli¡’
;

12 
ušt8_t
 *
p
, *
Çme
;

13 
ušt32_t
 
Çm–’
;

15 ià(
li¡’_¡r
 =ğ
NULL
) {

16  
NULL
;

19 
vli¡’
 = 
	`d®loc
((
vr_li¡’
));

20 ià(
vli¡’
 =ğ
NULL
) {

21  
NULL
;

24 
vli¡’
->
Çme
 = 
NULL
;

25 
vli¡’
->
pÜt
 = 0;

26 
	`mem£t
(&
vli¡’
->
šfo
, 0, (vlisten->info));

27 
vli¡’
->
sd
 = -1;

29 ià(
li¡’_¡r
 == '/') {

30 
ušt8_t
 *
q
, *
¡¬t
, *
³rm
;

31 
ušt32_t
 
³rmËn
;

34 
p
 = 
li¡’_¡r
 + 
	`sd¦’
(listen_str) - 1;

35 
¡¬t
 = 
li¡’_¡r
;

36 
q
 = 
	`vr_¡¼chr
(
p
, 
¡¬t
, ' ');

37 ià(
q
 =ğ
NULL
) {

39 
Çme
 = 
li¡’_¡r
;

40 
Çm–’
 = 
	`sd¦’
(
li¡’_¡r
);

42 
³rm
 = 
q
 + 1;

43 
³rmËn
 = (
ušt32_t
)(
p
 - 
³rm
 + 1);

45 
p
 = 
q
 - 1;

46 
Çme
 = 
¡¬t
;

47 
Çm–’
 = (
ušt32_t
)(
p
 - 
¡¬t
 + 1);

49 
”ºo
 = 0;

50 
vli¡’
->
³rm
 = (
mode_t
)
	`¡¹Ş
((*í”m, 
NULL
, 8);

51 ià(
”ºo
 || 
vli¡’
->
³rm
 > 0777) {

52 
	`log_”rÜ
("config file has‡n invalid file…ermission in \"socket_path…ermission\" format string");

53 
	`vr_li¡’_de¡roy
(
vli¡’
);

54  
NULL
;

58 
ušt8_t
 *
q
, *
¡¬t
, *
pÜt
;

59 
ušt32_t
 
pÜ’
;

62 
p
 = 
li¡’_¡r
 + 
	`sd¦’
(listen_str) - 1;

63 
¡¬t
 = 
li¡’_¡r
;

64 
q
 = 
	`vr_¡¼chr
(
p
, 
¡¬t
, ':');

65 ià(
q
 =ğ
NULL
) {

66 
	`log_”rÜ
("config file has‡n invalid \"hostname:port\" format string");

67 
	`vr_li¡’_de¡roy
(
vli¡’
);

68  
NULL
;

71 
pÜt
 = 
q
 + 1;

72 
pÜ’
 = (
ušt32_t
)(
p
 - 
pÜt
 + 1);

74 
p
 = 
q
 - 1;

76 
Çme
 = 
¡¬t
;

77 
Çm–’
 = (
ušt32_t
)(
p
 - 
¡¬t
 + 1);

79 
vli¡’
->
pÜt
 = 
	`vr_©oi
ÕÜt, 
pÜ’
);

80 ià(
vli¡’
->
pÜt
 < 0 || !
	`vr_v®id_pÜt
(vlisten->port)) {

81 
	`log_”rÜ
("config file has‡n invalid…ort in \"hostname:port\" format string");

82 
	`vr_li¡’_de¡roy
(
vli¡’
);

83  
NULL
;

87 
vli¡’
->
Çme
 = 
	`sd¢ewËn
Òame, 
Çm–’
);

88 ià(
vli¡’
->
Çme
 =ğ
NULL
) {

89 
	`log_”rÜ
("create‡ sds string failed: out of memory.");

90 
	`vr_li¡’_de¡roy
(
vli¡’
);

91  
NULL
;

94 
¡©us
 = 
	`vr_»sŞve
(
vli¡’
->
Çme
, vli¡’->
pÜt
, &vli¡’->
šfo
);

95 ià(
¡©us
 !ğ
VR_OK
) {

96 
	`vr_li¡’_de¡roy
(
vli¡’
);

97  
NULL
;

100  
vli¡’
;

101 
	}
}

104 
	$vr_li¡’_de¡roy
(
vr_li¡’
 *
vli¡Ú
)

106 ià(
vli¡Ú
 =ğ
NULL
) {

110 ià(
vli¡Ú
->
Çme
) {

111 
	`sdsä“
(
vli¡Ú
->
Çme
);

112 
vli¡Ú
->
Çme
 = 
NULL
;

115 ià(
vli¡Ú
->
sd
 > 0) {

116 
	`şo£
(
vli¡Ú
->
sd
);

117 
vli¡Ú
->
sd
 = -1;

120 
	`dä“
(
vli¡Ú
);

121 
	}
}

123 
r¡©us_t


124 
	$vr_li¡’_»u£
(
vr_li¡’
 *
p
)

126 
r¡©us_t
 
¡©us
;

127 
sockaddr_un
 *
un
;

129 
p
->
šfo
.
çmy
) {

130 
AF_INET
:

131 
AF_INET6
:

132 
¡©us
 = 
	`vr_£t_»u£addr
(
p
->
sd
);

135 
AF_UNIX
:

141 
un
 = (
sockaddr_un
 *è&
p
->
šfo
.
addr
;

142 
	`uÆšk
(
un
->
sun_·th
);

143 
¡©us
 = 
VR_OK
;

147 
	`NOT_REACHED
();

148 
¡©us
 = 
VR_ERROR
;

151  
¡©us
;

152 
	}
}

154 
r¡©us_t


155 
	$vr_li¡’_begš
(
vr_li¡’
 *
vli¡’
)

157 
r¡©us_t
 
¡©us
;

159 
vli¡’
->
sd
 = 
	`sock‘
(vli¡’->
šfo
.
çmy
, 
SOCK_STREAM
, 0);

160 ià(
vli¡’
->
sd
 < 0) {

161 
	`log_”rÜ
("sock‘ faed: %s", 
	`¡»¼Ü
(
”ºo
));

162  
VR_ERROR
;

165 
¡©us
 = 
	`vr_li¡’_»u£
(
vli¡’
);

166 ià(
¡©us
 < 0) {

167 
	`log_”rÜ
("reuse of‡ddr %s for†istening on… %d failed: %s",

168 
vli¡’
->
Çme
, vli¡’->
sd
, 
	`¡»¼Ü
(
”ºo
));

169  
VR_ERROR
;

172 
¡©us
 = 
	`bšd
(
vli¡’
->
sd
, (
sockaddr
 *)&vli¡’->
šfo
.
addr
, vli¡’->šfo.
add¾’
);

173 ià(
¡©us
 < 0) {

174 
	`log_”rÜ
("bšd oÀ°%dØadd¸% çed: %s", 
vli¡’
->
sd
,

175 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

176  
VR_ERROR
;

179 ià(
vli¡’
->
šfo
.
çmy
 =ğ
AF_UNIX
 && vli¡’->
³rm
) {

180 
sockaddr_un
 *
un
 = (sockaddr_uÀ*)&
vli¡’
->
šfo
.
addr
;

181 
¡©us
 = 
	`chmod
(
un
->
sun_·th
, 
vli¡’
->
³rm
);

182 ià(
¡©us
 < 0) {

183 
	`log_”rÜ
("chmod oÀ°%d oÀadd¸% çed: %s", 
vli¡’
->
sd
,

184 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

185  
VR_ERROR
;

189 
¡©us
 = 
	`li¡’
(
vli¡’
->
sd
, 512);

190 ià(
¡©us
 < 0) {

191 
	`log_”rÜ
("li¡’ oÀ°%d oÀadd¸% çed: %s", 
vli¡’
->
sd
,

192 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

193  
VR_ERROR
;

196 
¡©us
 = 
	`vr_£t_nÚblockšg
(
vli¡’
->
sd
);

197 ià(
¡©us
 < 0) {

198 
	`log_”rÜ
("£ˆnÚblock oÀ°%d oÀadd¸% çed: %s", 
vli¡’
->
sd
,

199 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

200  
VR_ERROR
;

203  
VR_OK
;

204 
	}
}

207 
	$vr_li¡’_acû±
(
vr_li¡’
 *
vli¡’
)

209 
r¡©us_t
 
¡©us
;

210 
sd
;

211 
maxş›Ás
;

213 
	`ASSERT
(
vli¡’
->
sd
 > 0);

215 
	`log_debug
(
LOG_DEBUG
,"client_accept");

217 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
maxş›Ás
);

220 
sd
 = 
	`acû±
(
vli¡’
->sd, 
NULL
, NULL);

221 ià(
sd
 < 0) {

222 ià(
”ºo
 =ğ
EINTR
) {

223 
	`log_debug
(
LOG_VERB
, "acû± oÀ°%d‚Ù„—dy -ƒšŒ", 
vli¡’
->
sd
);

227 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
 ||ƒ¼nØ=ğ
ECONNABORTED
) {

228 
	`log_debug
(
LOG_VERB
, "acû± oÀ°%d‚Ù„—dy -ƒagaš", 
vli¡’
->
sd
);

232 ià(
”ºo
 =ğ
EMFILE
 ||ƒ¼nØ=ğ
ENFILE
) {

233 
	`log_debug
(
LOG_CRIT
, "accept on… %d "

236 
vli¡’
->
sd
, 
maxş›Ás
,

237 
	`cu¼’t_ş›Ás
(), 
	`¡»¼Ü
(
”ºo
));

241 
	`log_w¬n
("acû± oÀ°%d faed: %s", 
vli¡’
->
sd
, 
	`¡»¼Ü
(
”ºo
));

249 ià(
	`cu¼’t_ş›Ás
(è>ğ
maxş›Ás
) {

250 
	`log_debug
(
LOG_CRIT
, "client connections %dƒxceed†imit %d",

251 
	`cu¼’t_ş›Ás
(), 
maxş›Ás
);

252 
¡©us
 = 
	`şo£
(
sd
);

253 ià(
¡©us
 < 0) {

254 
	`log_”rÜ
("şo£ c %d faed, ignÜed: %s", 
sd
, 
	`¡»¼Ü
(
”ºo
));

257 
	`upd©e_¡©s_add
(
ma¡”
.
v–
.
¡©s
, 
»jeùed_cÚn
, 1);

262  
sd
;

263 
	}
}

	@src/vr_listen.c

1 
	~<sys/¡©.h
>

2 
	~<sys/un.h
>

4 
	~<vr_cÜe.h
>

7 
vr_li¡’
 *

8 
	$vr_li¡’_ü—‹
(
sds
 
li¡’_¡r
)

10 
r¡©us_t
 
¡©us
;

11 
vr_li¡’
 *
vli¡’
;

12 
ušt8_t
 *
p
, *
Çme
;

13 
ušt32_t
 
Çm–’
;

15 ià(
li¡’_¡r
 =ğ
NULL
) {

16  
NULL
;

19 
vli¡’
 = 
	`d®loc
((
vr_li¡’
));

20 ià(
vli¡’
 =ğ
NULL
) {

21  
NULL
;

24 
vli¡’
->
Çme
 = 
NULL
;

25 
vli¡’
->
pÜt
 = 0;

26 
	`mem£t
(&
vli¡’
->
šfo
, 0, (vlisten->info));

27 
vli¡’
->
sd
 = -1;

29 ià(
li¡’_¡r
 == '/') {

30 
ušt8_t
 *
q
, *
¡¬t
, *
³rm
;

31 
ušt32_t
 
³rmËn
;

34 
p
 = 
li¡’_¡r
 + 
	`sd¦’
(listen_str) - 1;

35 
¡¬t
 = 
li¡’_¡r
;

36 
q
 = 
	`vr_¡¼chr
(
p
, 
¡¬t
, ' ');

37 ià(
q
 =ğ
NULL
) {

39 
Çme
 = 
li¡’_¡r
;

40 
Çm–’
 = 
	`sd¦’
(
li¡’_¡r
);

42 
³rm
 = 
q
 + 1;

43 
³rmËn
 = (
ušt32_t
)(
p
 - 
³rm
 + 1);

45 
p
 = 
q
 - 1;

46 
Çme
 = 
¡¬t
;

47 
Çm–’
 = (
ušt32_t
)(
p
 - 
¡¬t
 + 1);

49 
”ºo
 = 0;

50 
vli¡’
->
³rm
 = (
mode_t
)
	`¡¹Ş
((*í”m, 
NULL
, 8);

51 ià(
”ºo
 || 
vli¡’
->
³rm
 > 0777) {

52 
	`log_”rÜ
("config file has‡n invalid file…ermission in \"socket_path…ermission\" format string");

53 
	`vr_li¡’_de¡roy
(
vli¡’
);

54  
NULL
;

58 
ušt8_t
 *
q
, *
¡¬t
, *
pÜt
;

59 
ušt32_t
 
pÜ’
;

62 
p
 = 
li¡’_¡r
 + 
	`sd¦’
(listen_str) - 1;

63 
¡¬t
 = 
li¡’_¡r
;

64 
q
 = 
	`vr_¡¼chr
(
p
, 
¡¬t
, ':');

65 ià(
q
 =ğ
NULL
) {

66 
	`log_”rÜ
("config file has‡n invalid \"hostname:port\" format string");

67 
	`vr_li¡’_de¡roy
(
vli¡’
);

68  
NULL
;

71 
pÜt
 = 
q
 + 1;

72 
pÜ’
 = (
ušt32_t
)(
p
 - 
pÜt
 + 1);

74 
p
 = 
q
 - 1;

76 
Çme
 = 
¡¬t
;

77 
Çm–’
 = (
ušt32_t
)(
p
 - 
¡¬t
 + 1);

79 
vli¡’
->
pÜt
 = 
	`vr_©oi
ÕÜt, 
pÜ’
);

80 ià(
vli¡’
->
pÜt
 < 0 || !
	`vr_v®id_pÜt
(vlisten->port)) {

81 
	`log_”rÜ
("config file has‡n invalid…ort in \"hostname:port\" format string");

82 
	`vr_li¡’_de¡roy
(
vli¡’
);

83  
NULL
;

87 
vli¡’
->
Çme
 = 
	`sd¢ewËn
Òame, 
Çm–’
);

88 ià(
vli¡’
->
Çme
 =ğ
NULL
) {

89 
	`log_”rÜ
("create‡ sds string failed: out of memory.");

90 
	`vr_li¡’_de¡roy
(
vli¡’
);

91  
NULL
;

94 
¡©us
 = 
	`vr_»sŞve
(
vli¡’
->
Çme
, vli¡’->
pÜt
, &vli¡’->
šfo
);

95 ià(
¡©us
 !ğ
VR_OK
) {

96 
	`vr_li¡’_de¡roy
(
vli¡’
);

97  
NULL
;

100  
vli¡’
;

101 
	}
}

104 
	$vr_li¡’_de¡roy
(
vr_li¡’
 *
vli¡Ú
)

106 ià(
vli¡Ú
 =ğ
NULL
) {

110 ià(
vli¡Ú
->
Çme
) {

111 
	`sdsä“
(
vli¡Ú
->
Çme
);

112 
vli¡Ú
->
Çme
 = 
NULL
;

115 ià(
vli¡Ú
->
sd
 > 0) {

116 
	`şo£
(
vli¡Ú
->
sd
);

117 
vli¡Ú
->
sd
 = -1;

120 
	`dä“
(
vli¡Ú
);

121 
	}
}

123 
r¡©us_t


124 
	$vr_li¡’_»u£
(
vr_li¡’
 *
p
)

126 
r¡©us_t
 
¡©us
;

127 
sockaddr_un
 *
un
;

129 
p
->
šfo
.
çmy
) {

130 
AF_INET
:

131 
AF_INET6
:

132 
¡©us
 = 
	`vr_£t_»u£addr
(
p
->
sd
);

135 
AF_UNIX
:

141 
un
 = (
sockaddr_un
 *è&
p
->
šfo
.
addr
;

142 
	`uÆšk
(
un
->
sun_·th
);

143 
¡©us
 = 
VR_OK
;

147 
	`NOT_REACHED
();

148 
¡©us
 = 
VR_ERROR
;

151  
¡©us
;

152 
	}
}

154 
r¡©us_t


155 
	$vr_li¡’_begš
(
vr_li¡’
 *
vli¡’
)

157 
r¡©us_t
 
¡©us
;

159 
vli¡’
->
sd
 = 
	`sock‘
(vli¡’->
šfo
.
çmy
, 
SOCK_STREAM
, 0);

160 ià(
vli¡’
->
sd
 < 0) {

161 
	`log_”rÜ
("sock‘ faed: %s", 
	`¡»¼Ü
(
”ºo
));

162  
VR_ERROR
;

165 
¡©us
 = 
	`vr_li¡’_»u£
(
vli¡’
);

166 ià(
¡©us
 < 0) {

167 
	`log_”rÜ
("reuse of‡ddr %s for†istening on… %d failed: %s",

168 
vli¡’
->
Çme
, vli¡’->
sd
, 
	`¡»¼Ü
(
”ºo
));

169  
VR_ERROR
;

172 
¡©us
 = 
	`bšd
(
vli¡’
->
sd
, (
sockaddr
 *)&vli¡’->
šfo
.
addr
, vli¡’->šfo.
add¾’
);

173 ià(
¡©us
 < 0) {

174 
	`log_”rÜ
("bšd oÀ°%dØadd¸% çed: %s", 
vli¡’
->
sd
,

175 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

176  
VR_ERROR
;

179 ià(
vli¡’
->
šfo
.
çmy
 =ğ
AF_UNIX
 && vli¡’->
³rm
) {

180 
sockaddr_un
 *
un
 = (sockaddr_uÀ*)&
vli¡’
->
šfo
.
addr
;

181 
¡©us
 = 
	`chmod
(
un
->
sun_·th
, 
vli¡’
->
³rm
);

182 ià(
¡©us
 < 0) {

183 
	`log_”rÜ
("chmod oÀ°%d oÀadd¸% çed: %s", 
vli¡’
->
sd
,

184 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

185  
VR_ERROR
;

189 
¡©us
 = 
	`li¡’
(
vli¡’
->
sd
, 512);

190 ià(
¡©us
 < 0) {

191 
	`log_”rÜ
("li¡’ oÀ°%d oÀadd¸% çed: %s", 
vli¡’
->
sd
,

192 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

193  
VR_ERROR
;

196 
¡©us
 = 
	`vr_£t_nÚblockšg
(
vli¡’
->
sd
);

197 ià(
¡©us
 < 0) {

198 
	`log_”rÜ
("£ˆnÚblock oÀ°%d oÀadd¸% çed: %s", 
vli¡’
->
sd
,

199 
vli¡’
->
Çme
, 
	`¡»¼Ü
(
”ºo
));

200  
VR_ERROR
;

203  
VR_OK
;

204 
	}
}

207 
	$vr_li¡’_acû±
(
vr_li¡’
 *
vli¡’
)

209 
r¡©us_t
 
¡©us
;

210 
sd
;

211 
maxş›Ás
;

213 
	`ASSERT
(
vli¡’
->
sd
 > 0);

215 
	`log_debug
(
LOG_DEBUG
,"client_accept");

217 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
maxş›Ás
);

220 
sd
 = 
	`acû±
(
vli¡’
->sd, 
NULL
, NULL);

221 ià(
sd
 < 0) {

222 ià(
”ºo
 =ğ
EINTR
) {

223 
	`log_debug
(
LOG_VERB
, "acû± oÀ°%d‚Ù„—dy -ƒšŒ", 
vli¡’
->
sd
);

227 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
 ||ƒ¼nØ=ğ
ECONNABORTED
) {

228 
	`log_debug
(
LOG_VERB
, "acû± oÀ°%d‚Ù„—dy -ƒagaš", 
vli¡’
->
sd
);

232 ià(
”ºo
 =ğ
EMFILE
 ||ƒ¼nØ=ğ
ENFILE
) {

233 
	`log_debug
(
LOG_CRIT
, "accept on… %d "

236 
vli¡’
->
sd
, 
maxş›Ás
,

237 
	`cu¼’t_ş›Ás
(), 
	`¡»¼Ü
(
”ºo
));

241 
	`log_w¬n
("acû± oÀ°%d faed: %s", 
vli¡’
->
sd
, 
	`¡»¼Ü
(
”ºo
));

249 ià(
	`cu¼’t_ş›Ás
(è>ğ
maxş›Ás
) {

250 
	`log_debug
(
LOG_CRIT
, "client connections %dƒxceed†imit %d",

251 
	`cu¼’t_ş›Ás
(), 
maxş›Ás
);

252 
¡©us
 = 
	`şo£
(
sd
);

253 ià(
¡©us
 < 0) {

254 
	`log_”rÜ
("şo£ c %d faed, ignÜed: %s", 
sd
, 
	`¡»¼Ü
(
”ºo
));

257 
	`upd©e_¡©s_add
(
ma¡”
.
v–
.
¡©s
, 
»jeùed_cÚn
, 1);

262  
sd
;

263 
	}
}

	@src/vr_listen.h

1 #iâdeà
_VR_LISTEN_H_


2 
	#_VR_LISTEN_H_


	)

5 
	svr_li¡’
 {

6 
sds
 
	mÇme
;

7 
	mpÜt
;

8 
mode_t
 
	m³rm
;

9 
sockšfo
 
	mšfo
;

10 
	msd
;

11 }
	tvr_li¡’
;

13 
vr_li¡’
 *
vr_li¡’_ü—‹
(
sds
 
lš‹n_¡r
);

14 
vr_li¡’_de¡roy
(
vr_li¡’
 *
vli¡Ú
);

15 
r¡©us_t
 
vr_li¡’_begš
(
vr_li¡’
 *
vli¡’
);

16 
vr_li¡’_acû±
(
vr_li¡’
 *
vli¡’
);

	@src/vr_listen.h

1 #iâdeà
_VR_LISTEN_H_


2 
	#_VR_LISTEN_H_


	)

5 
	svr_li¡’
 {

6 
sds
 
	mÇme
;

7 
	mpÜt
;

8 
mode_t
 
	m³rm
;

9 
sockšfo
 
	mšfo
;

10 
	msd
;

11 }
	tvr_li¡’
;

13 
vr_li¡’
 *
vr_li¡’_ü—‹
(
sds
 
lš‹n_¡r
);

14 
vr_li¡’_de¡roy
(
vr_li¡’
 *
vli¡Ú
);

15 
r¡©us_t
 
vr_li¡’_begš
(
vr_li¡’
 *
vli¡’
);

16 
vr_li¡’_acû±
(
vr_li¡’
 *
vli¡’
);

	@src/vr_lzf.h

1 #iâdeà
_VR_LZF_H_


2 
	#_VR_LZF_H_


	)

13 
	#LZF_VERSION
 0x0105

	)

41 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

42 *
out_d©a
, 
out_Ën
);

60 
lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

61 *
out_d©a
, 
out_Ën
);

	@src/vr_lzf.h

1 #iâdeà
_VR_LZF_H_


2 
	#_VR_LZF_H_


	)

13 
	#LZF_VERSION
 0x0105

	)

41 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

42 *
out_d©a
, 
out_Ën
);

60 
lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

61 *
out_d©a
, 
out_Ën
);

	@src/vr_lzfP.h

1 #iâdeà
_VR_LZFP_H_


2 
	#_VR_LZFP_H_


	)

4 
	#STANDALONE
 1

	)

6 #iâdeà
STANDALONE


7 
	~<vr_lzf.h
>

18 #iâdeà
HLOG


19 
	#HLOG
 16

	)

27 #iâdeà
VERY_FAST


28 
	#VERY_FAST
 1

	)

38 #iâdeà
ULTRA_FAST


39 
	#ULTRA_FAST
 0

	)

45 #iâdeà
STRICT_ALIGN


46 
	#STRICT_ALIGN
 !(
	`defšed
(
__i386
è|| defšed (
__amd64
))

	)

54 #iâdeà
INIT_HTAB


55 
	#INIT_HTAB
 0

	)

63 #iâdeà
AVOID_ERRNO


64 
	#AVOID_ERRNO
 0

	)

72 #iâdeà
LZF_STATE_ARG


73 
	#LZF_STATE_ARG
 0

	)

84 #iâdeà
CHECK_INPUT


85 
	#CHECK_INPUT
 1

	)

98 #ifdeà
__ılu¥lus


99 
	~<c¡ršg
>

100 
	~<şim™s
>

101 
usšg
 
Çme¥aû
 
	g¡d
;

103 
	~<¡ršg.h
>

104 
	~<lim™s.h
>

107 #iâdeà
LZF_USE_OFFSETS


108 #ià
defšed
 (
WIN32
)

109 
	#LZF_USE_OFFSETS
 
	`defšed
(
_M_X64
)

	)

111 #ià
__ılu¥lus
 > 199711L

112 
	~<c¡dšt
>

114 
	~<¡dšt.h
>

116 
	#LZF_USE_OFFSETS
 (
UINTPTR_MAX
 > 0xffffffffU)

	)

120 
	tu8
;

122 #ià
LZF_USE_OFFSETS


123 
	#LZF_HSLOT_BIAS
 ((cÚ¡ 
u8
 *)
š_d©a
)

	)

124 
	tLZF_HSLOT
;

126 
	#LZF_HSLOT_BIAS
 0

	)

127 cÚ¡ 
	tu8
 *
	tLZF_HSLOT
;

130 
LZF_HSLOT
 
	tLZF_STATE
[1 << (
HLOG
)];

132 #ià!
STRICT_ALIGN


134 #ià
USHRT_MAX
 == 65535

135 
	tu16
;

136 #–ià
UINT_MAX
 == 65535

137 
	tu16
;

139 #undeà
STRICT_ALIGN


140 
	#STRICT_ALIGN
 1

	)

144 #ià
ULTRA_FAST


145 #undeà
VERY_FAST


	@src/vr_lzfP.h

1 #iâdeà
_VR_LZFP_H_


2 
	#_VR_LZFP_H_


	)

4 
	#STANDALONE
 1

	)

6 #iâdeà
STANDALONE


7 
	~<vr_lzf.h
>

18 #iâdeà
HLOG


19 
	#HLOG
 16

	)

27 #iâdeà
VERY_FAST


28 
	#VERY_FAST
 1

	)

38 #iâdeà
ULTRA_FAST


39 
	#ULTRA_FAST
 0

	)

45 #iâdeà
STRICT_ALIGN


46 
	#STRICT_ALIGN
 !(
	`defšed
(
__i386
è|| defšed (
__amd64
))

	)

54 #iâdeà
INIT_HTAB


55 
	#INIT_HTAB
 0

	)

63 #iâdeà
AVOID_ERRNO


64 
	#AVOID_ERRNO
 0

	)

72 #iâdeà
LZF_STATE_ARG


73 
	#LZF_STATE_ARG
 0

	)

84 #iâdeà
CHECK_INPUT


85 
	#CHECK_INPUT
 1

	)

98 #ifdeà
__ılu¥lus


99 
	~<c¡ršg
>

100 
	~<şim™s
>

101 
usšg
 
Çme¥aû
 
	g¡d
;

103 
	~<¡ršg.h
>

104 
	~<lim™s.h
>

107 #iâdeà
LZF_USE_OFFSETS


108 #ià
defšed
 (
WIN32
)

109 
	#LZF_USE_OFFSETS
 
	`defšed
(
_M_X64
)

	)

111 #ià
__ılu¥lus
 > 199711L

112 
	~<c¡dšt
>

114 
	~<¡dšt.h
>

116 
	#LZF_USE_OFFSETS
 (
UINTPTR_MAX
 > 0xffffffffU)

	)

120 
	tu8
;

122 #ià
LZF_USE_OFFSETS


123 
	#LZF_HSLOT_BIAS
 ((cÚ¡ 
u8
 *)
š_d©a
)

	)

124 
	tLZF_HSLOT
;

126 
	#LZF_HSLOT_BIAS
 0

	)

127 cÚ¡ 
	tu8
 *
	tLZF_HSLOT
;

130 
LZF_HSLOT
 
	tLZF_STATE
[1 << (
HLOG
)];

132 #ià!
STRICT_ALIGN


134 #ià
USHRT_MAX
 == 65535

135 
	tu16
;

136 #–ià
UINT_MAX
 == 65535

137 
	tu16
;

139 #undeà
STRICT_ALIGN


140 
	#STRICT_ALIGN
 1

	)

144 #ià
ULTRA_FAST


145 #undeà
VERY_FAST


	@src/vr_lzf_c.c

1 
	~<vr_lzfP.h
>

3 
	#HSIZE
 (1 << (
HLOG
))

	)

11 #iâdeà
FRST


12 
	#FRST
(
p
è((Õ[0]è<< 8è|…[1])

	)

13 
	#NEXT
(
v
,
p
è(((vè<< 8è|…[2])

	)

14 #ià
ULTRA_FAST


15 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h ) & (
HSIZE
 - 1))

	)

16 #–ià
VERY_FAST


17 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

19 
	#IDX
(
h
è((((h ^ (h << 5)è>> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

33 
	#FRST
(
p
èÕ[0] << 5è^…[1]

	)

34 
	#NEXT
(
v
,
p
è((vè<< 5è^…[2]

	)

35 
	#IDX
(
h
è((hè& (
HSIZE
 - 1))

	)

38 
	#MAX_LIT
 (1 << 5)

	)

39 
	#MAX_OFF
 (1 << 13)

	)

40 
	#MAX_REF
 ((1 << 8è+ (1 << 3))

	)

42 #ià
__GNUC__
 >= 3

43 
	#ex³ù
(
ex´
,
v®ue
è
	`__butš_ex³ù
 (Óx´),(v®ue))

	)

44 
	#šlše
 
šlše


	)

46 
	#ex³ù
(
ex´
,
v®ue
èÓx´)

	)

47 
	#šlše
 

	)

50 
	#ex³ù_çl£
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 0)

	)

51 
	#ex³ù_Œue
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 1)

	)

63 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

64 *
out_d©a
, 
out_Ën


65 #ià
LZF_STATE_ARG


66 , 
LZF_STATE
 
hb


70 #ià!
LZF_STATE_ARG


71 
LZF_STATE
 
	ghb
;

73 cÚ¡ 
u8
 *
	g
 = (cÚ¡ u8 *)
š_d©a
;

74 
u8
 *
	gİ
 = (u8 *)
out_d©a
;

75 cÚ¡ 
u8
 *
	gš_’d
 = 

 + 
š_Ën
;

76 
u8
 *
	gout_’d
 = 
İ
 + 
out_Ën
;

77 cÚ¡ 
u8
 *
	g»f
;

86 #ià
defšed
 (
WIN32
è&& defšed (
_M_X64
)

87 
_št64
 
	goff
;

89 
	goff
;

91 
	ghv®
;

92 
	gl™
;

94 ià(!
	gš_Ën
 || !
	gout_Ën
)

97 #ià
INIT_HTAB


98 
mem£t
 (
hb
, 0,  (htab));

101 
	gl™
 = 0; 
	gİ
++;

103 
	ghv®
 = 
FRST
 (

);

104 
	g
 < 
	gš_’d
 - 2)

106 
LZF_HSLOT
 *
	gh¦Ù
;

108 
	ghv®
 = 
NEXT
 (
hv®
, 

);

109 
	gh¦Ù
 = 
hb
 + 
IDX
 (
hv®
);

110 
	g»f
 = *
h¦Ù
 + 
LZF_HSLOT_BIAS
; *
	gh¦Ù
 = 

 - LZF_HSLOT_BIAS;

113 #ià
INIT_HTAB


114 && 
	g»f
 < 
	g


116 && (
	goff
 = 

 - 
»f
 - 1è< 
MAX_OFF


117 && 
»f
 > (
u8
 *)
š_d©a


118 && 
»f
[2] =ğ

[2]

119 #ià
STRICT_ALIGN


120 && ((
»f
[1] << 8è|„ef[0]è=ğ((

[1] << 8) | ip[0])

122 && *(
u16
 *)
»f
 =ğ*(u16 *)



127 
Ën
 = 2;

128 
	gmaxËn
 = 
š_’d
 - 

 - 
Ën
;

129 
	gmaxËn
 = 
maxËn
 > 
MAX_REF
 ? MAX_REF : maxlen;

131 ià(
ex³ù_çl£
 (
İ
 + 3 + 1 >ğ
out_’d
))

132 ià(
İ
 - !
l™
 + 3 + 1 >ğ
out_’d
)

135 
	gİ
 [- 
l™
 - 1] =†it - 1;

136 
	gİ
 -ğ!
l™
;

140 ià(
ex³ù_Œue
 (
maxËn
 > 16))

142 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

143 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

144 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

145 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

147 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

148 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

149 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

150 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

152 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

153 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

154 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

155 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

157 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

158 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

159 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

160 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

164 
	gËn
++;

165 
	gËn
 < 
	gmaxËn
 && 
	g»f
[
Ën
] =ğ

[len]);

170 
	gËn
 -= 2;

171 
	g
++;

173 ià(
	gËn
 < 7)

175 *
	gİ
++ = (
off
 >> 8è+ (
Ën
 << 5);

179 *
	gİ
++ = (
off
 >> 8) + ( 7 << 5);

180 *
	gİ
++ = 
Ën
 - 7;

183 *
	gİ
++ = 
off
;

185 
	gl™
 = 0; 
	gİ
++;

187 
	g
 +ğ
Ën
 + 1;

189 ià(
ex³ù_çl£
 (

 >ğ
š_’d
 - 2))

192 #ià
ULTRA_FAST
 || 
VERY_FAST


193 --
	g
;

194 #ià
VERY_FAST
 && !
ULTRA_FAST


195 --
	g
;

197 
	ghv®
 = 
FRST
 (

);

199 
	ghv®
 = 
NEXT
 (
hv®
, 

);

200 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

201 
	g
++;

203 #ià
VERY_FAST
 && !
ULTRA_FAST


204 
	ghv®
 = 
NEXT
 (
hv®
, 

);

205 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

206 
	g
++;

209 
	g
 -ğ
Ën
 + 1;

213 
	ghv®
 = 
NEXT
 (
hv®
, 

);

214 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

215 
	g
++;

217 
	gËn
--);

223 ià(
ex³ù_çl£
 (
İ
 >ğ
out_’d
))

226 
	gl™
++; *
	gİ
++ = *

++;

228 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

230 
İ
 [- 
l™
 - 1] =†it - 1;

231 
	gl™
 = 0; 
	gİ
++;

236 ià(
	gİ
 + 3 > 
	gout_’d
)

239 
	g
 < 
	gš_’d
)

241 
	gl™
++; *
	gİ
++ = *

++;

243 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

245 
İ
 [- 
l™
 - 1] =†it - 1;

246 
	gl™
 = 0; 
	gİ
++;

250 
	gİ
 [- 
l™
 - 1] =†it - 1;

251 
	gİ
 -ğ!
l™
;

253  
	gİ
 - (
	gu8
 *)
	gout_d©a
;

	@src/vr_lzf_c.c

1 
	~<vr_lzfP.h
>

3 
	#HSIZE
 (1 << (
HLOG
))

	)

11 #iâdeà
FRST


12 
	#FRST
(
p
è((Õ[0]è<< 8è|…[1])

	)

13 
	#NEXT
(
v
,
p
è(((vè<< 8è|…[2])

	)

14 #ià
ULTRA_FAST


15 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h ) & (
HSIZE
 - 1))

	)

16 #–ià
VERY_FAST


17 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

19 
	#IDX
(
h
è((((h ^ (h << 5)è>> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

33 
	#FRST
(
p
èÕ[0] << 5è^…[1]

	)

34 
	#NEXT
(
v
,
p
è((vè<< 5è^…[2]

	)

35 
	#IDX
(
h
è((hè& (
HSIZE
 - 1))

	)

38 
	#MAX_LIT
 (1 << 5)

	)

39 
	#MAX_OFF
 (1 << 13)

	)

40 
	#MAX_REF
 ((1 << 8è+ (1 << 3))

	)

42 #ià
__GNUC__
 >= 3

43 
	#ex³ù
(
ex´
,
v®ue
è
	`__butš_ex³ù
 (Óx´),(v®ue))

	)

44 
	#šlše
 
šlše


	)

46 
	#ex³ù
(
ex´
,
v®ue
èÓx´)

	)

47 
	#šlše
 

	)

50 
	#ex³ù_çl£
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 0)

	)

51 
	#ex³ù_Œue
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 1)

	)

63 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

64 *
out_d©a
, 
out_Ën


65 #ià
LZF_STATE_ARG


66 , 
LZF_STATE
 
hb


70 #ià!
LZF_STATE_ARG


71 
LZF_STATE
 
	ghb
;

73 cÚ¡ 
u8
 *
	g
 = (cÚ¡ u8 *)
š_d©a
;

74 
u8
 *
	gİ
 = (u8 *)
out_d©a
;

75 cÚ¡ 
u8
 *
	gš_’d
 = 

 + 
š_Ën
;

76 
u8
 *
	gout_’d
 = 
İ
 + 
out_Ën
;

77 cÚ¡ 
u8
 *
	g»f
;

86 #ià
defšed
 (
WIN32
è&& defšed (
_M_X64
)

87 
_št64
 
	goff
;

89 
	goff
;

91 
	ghv®
;

92 
	gl™
;

94 ià(!
	gš_Ën
 || !
	gout_Ën
)

97 #ià
INIT_HTAB


98 
mem£t
 (
hb
, 0,  (htab));

101 
	gl™
 = 0; 
	gİ
++;

103 
	ghv®
 = 
FRST
 (

);

104 
	g
 < 
	gš_’d
 - 2)

106 
LZF_HSLOT
 *
	gh¦Ù
;

108 
	ghv®
 = 
NEXT
 (
hv®
, 

);

109 
	gh¦Ù
 = 
hb
 + 
IDX
 (
hv®
);

110 
	g»f
 = *
h¦Ù
 + 
LZF_HSLOT_BIAS
; *
	gh¦Ù
 = 

 - LZF_HSLOT_BIAS;

113 #ià
INIT_HTAB


114 && 
	g»f
 < 
	g


116 && (
	goff
 = 

 - 
»f
 - 1è< 
MAX_OFF


117 && 
»f
 > (
u8
 *)
š_d©a


118 && 
»f
[2] =ğ

[2]

119 #ià
STRICT_ALIGN


120 && ((
»f
[1] << 8è|„ef[0]è=ğ((

[1] << 8) | ip[0])

122 && *(
u16
 *)
»f
 =ğ*(u16 *)



127 
Ën
 = 2;

128 
	gmaxËn
 = 
š_’d
 - 

 - 
Ën
;

129 
	gmaxËn
 = 
maxËn
 > 
MAX_REF
 ? MAX_REF : maxlen;

131 ià(
ex³ù_çl£
 (
İ
 + 3 + 1 >ğ
out_’d
))

132 ià(
İ
 - !
l™
 + 3 + 1 >ğ
out_’d
)

135 
	gİ
 [- 
l™
 - 1] =†it - 1;

136 
	gİ
 -ğ!
l™
;

140 ià(
ex³ù_Œue
 (
maxËn
 > 16))

142 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

143 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

144 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

145 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

147 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

148 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

149 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

150 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

152 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

153 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

154 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

155 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

157 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

158 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

159 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

160 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

164 
	gËn
++;

165 
	gËn
 < 
	gmaxËn
 && 
	g»f
[
Ën
] =ğ

[len]);

170 
	gËn
 -= 2;

171 
	g
++;

173 ià(
	gËn
 < 7)

175 *
	gİ
++ = (
off
 >> 8è+ (
Ën
 << 5);

179 *
	gİ
++ = (
off
 >> 8) + ( 7 << 5);

180 *
	gİ
++ = 
Ën
 - 7;

183 *
	gİ
++ = 
off
;

185 
	gl™
 = 0; 
	gİ
++;

187 
	g
 +ğ
Ën
 + 1;

189 ià(
ex³ù_çl£
 (

 >ğ
š_’d
 - 2))

192 #ià
ULTRA_FAST
 || 
VERY_FAST


193 --
	g
;

194 #ià
VERY_FAST
 && !
ULTRA_FAST


195 --
	g
;

197 
	ghv®
 = 
FRST
 (

);

199 
	ghv®
 = 
NEXT
 (
hv®
, 

);

200 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

201 
	g
++;

203 #ià
VERY_FAST
 && !
ULTRA_FAST


204 
	ghv®
 = 
NEXT
 (
hv®
, 

);

205 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

206 
	g
++;

209 
	g
 -ğ
Ën
 + 1;

213 
	ghv®
 = 
NEXT
 (
hv®
, 

);

214 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

215 
	g
++;

217 
	gËn
--);

223 ià(
ex³ù_çl£
 (
İ
 >ğ
out_’d
))

226 
	gl™
++; *
	gİ
++ = *

++;

228 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

230 
İ
 [- 
l™
 - 1] =†it - 1;

231 
	gl™
 = 0; 
	gİ
++;

236 ià(
	gİ
 + 3 > 
	gout_’d
)

239 
	g
 < 
	gš_’d
)

241 
	gl™
++; *
	gİ
++ = *

++;

243 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

245 
İ
 [- 
l™
 - 1] =†it - 1;

246 
	gl™
 = 0; 
	gİ
++;

250 
	gİ
 [- 
l™
 - 1] =†it - 1;

251 
	gİ
 -ğ!
l™
;

253  
	gİ
 - (
	gu8
 *)
	gout_d©a
;

	@src/vr_lzf_d.c

1 
	~<vr_lzfP.h
>

3 #ià
AVOID_ERRNO


4 
	#SET_ERRNO
(
n
)

	)

6 
	~<”ºo.h
>

7 
	#SET_ERRNO
(
n
è
”ºo
 = (n)

	)

10 #ià
USE_REP_MOVSB


11 #ià(
__i386
 || 
__amd64
è&& 
__GNUC__
 >= 3

12 
	#lzf_movsb
(
d¡
, 
¤c
, 
Ën
) \

13 
	`asm
 ("rep movsb" \

14 : "=D" (
d¡
), "=S" (
¤c
), "=c" (
Ën
) \

15 : "0" (
d¡
), "1" (
¤c
), "2" (
Ën
));

	)

20 
	$lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

21 *
out_d©a
, 
out_Ën
)

23 
u8
 cÚ¡ *

 = (cÚ¡ u8 *)
š_d©a
;

24 
u8
 *
İ
 = (u8 *)
out_d©a
;

25 
u8
 cÚ¡ *cÚ¡ 
š_’d
 = 

 + 
š_Ën
;

26 
u8
 *cÚ¡ 
out_’d
 = 
İ
 + 
out_Ën
;

30 
ù¾
 = *

++;

32 ià(
ù¾
 < (1 << 5))

34 
ù¾
++;

36 ià(
İ
 + 
ù¾
 > 
out_’d
)

38 
	`SET_ERRNO
 (
E2BIG
);

42 #ià
CHECK_INPUT


43 ià(

 + 
ù¾
 > 
š_’d
)

45 
	`SET_ERRNO
 (
EINVAL
);

50 #ifdeà
lzf_movsb


51 
	`lzf_movsb
 (
İ
, 

, 
ù¾
);

53 
ù¾
)

55 32: *
İ
++ = *

++; 31: *op++ = *ip++; 30: *op++ = *ip++; 29: *op++ = *ip++;

56 28: *
İ
++ = *

++; 27: *op++ = *ip++; 26: *op++ = *ip++; 25: *op++ = *ip++;

57 24: *
İ
++ = *

++; 23: *op++ = *ip++; 22: *op++ = *ip++; 21: *op++ = *ip++;

58 20: *
İ
++ = *

++; 19: *op++ = *ip++; 18: *op++ = *ip++; 17: *op++ = *ip++;

59 16: *
İ
++ = *

++; 15: *op++ = *ip++; 14: *op++ = *ip++; 13: *op++ = *ip++;

60 12: *
İ
++ = *

++; 11: *op++ = *ip++; 10: *op++ = *ip++; 9: *op++ = *ip++;

61 8: *
İ
++ = *

++; 7: *op++ = *ip++; 6: *op++ = *ip++; 5: *op++ = *ip++;

62 4: *
İ
++ = *

++; 3: *op++ = *ip++; 2: *op++ = *ip++; 1: *op++ = *ip++;

68 
Ën
 = 
ù¾
 >> 5;

70 
u8
 *
»f
 = 
İ
 - ((
ù¾
 & 0x1f) << 8) - 1;

72 #ià
CHECK_INPUT


73 ià(

 >ğ
š_’d
)

75 
	`SET_ERRNO
 (
EINVAL
);

79 ià(
Ën
 == 7)

81 
Ën
 +ğ*

++;

82 #ià
CHECK_INPUT


83 ià(

 >ğ
š_’d
)

85 
	`SET_ERRNO
 (
EINVAL
);

91 
»f
 -ğ*

++;

93 ià(
İ
 + 
Ën
 + 2 > 
out_’d
)

95 
	`SET_ERRNO
 (
E2BIG
);

99 ià(
»f
 < (
u8
 *)
out_d©a
)

101 
	`SET_ERRNO
 (
EINVAL
);

105 #ifdeà
lzf_movsb


106 
Ën
 += 2;

107 
	`lzf_movsb
 (
İ
, 
»f
, 
Ën
);

109 
Ën
)

112 
Ën
 += 2;

114 ià(
İ
 >ğ
»f
 + 
Ën
)

117 
	`memıy
 (
İ
, 
»f
, 
Ën
);

118 
İ
 +ğ
Ën
;

124 *
İ
++ = *
»f
++;

125 --
Ën
);

130 9: *
İ
++ = *
»f
++;

131 8: *
İ
++ = *
»f
++;

132 7: *
İ
++ = *
»f
++;

133 6: *
İ
++ = *
»f
++;

134 5: *
İ
++ = *
»f
++;

135 4: *
İ
++ = *
»f
++;

136 3: *
İ
++ = *
»f
++;

137 2: *
İ
++ = *
»f
++;

138 1: *
İ
++ = *
»f
++;

139 0: *
İ
++ = *
»f
++;

140 *
İ
++ = *
»f
++;

145 

 < 
š_’d
);

147  
İ
 - (
u8
 *)
out_d©a
;

148 
	}
}

	@src/vr_lzf_d.c

1 
	~<vr_lzfP.h
>

3 #ià
AVOID_ERRNO


4 
	#SET_ERRNO
(
n
)

	)

6 
	~<”ºo.h
>

7 
	#SET_ERRNO
(
n
è
”ºo
 = (n)

	)

10 #ià
USE_REP_MOVSB


11 #ià(
__i386
 || 
__amd64
è&& 
__GNUC__
 >= 3

12 
	#lzf_movsb
(
d¡
, 
¤c
, 
Ën
) \

13 
	`asm
 ("rep movsb" \

14 : "=D" (
d¡
), "=S" (
¤c
), "=c" (
Ën
) \

15 : "0" (
d¡
), "1" (
¤c
), "2" (
Ën
));

	)

20 
	$lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

21 *
out_d©a
, 
out_Ën
)

23 
u8
 cÚ¡ *

 = (cÚ¡ u8 *)
š_d©a
;

24 
u8
 *
İ
 = (u8 *)
out_d©a
;

25 
u8
 cÚ¡ *cÚ¡ 
š_’d
 = 

 + 
š_Ën
;

26 
u8
 *cÚ¡ 
out_’d
 = 
İ
 + 
out_Ën
;

30 
ù¾
 = *

++;

32 ià(
ù¾
 < (1 << 5))

34 
ù¾
++;

36 ià(
İ
 + 
ù¾
 > 
out_’d
)

38 
	`SET_ERRNO
 (
E2BIG
);

42 #ià
CHECK_INPUT


43 ià(

 + 
ù¾
 > 
š_’d
)

45 
	`SET_ERRNO
 (
EINVAL
);

50 #ifdeà
lzf_movsb


51 
	`lzf_movsb
 (
İ
, 

, 
ù¾
);

53 
ù¾
)

55 32: *
İ
++ = *

++; 31: *op++ = *ip++; 30: *op++ = *ip++; 29: *op++ = *ip++;

56 28: *
İ
++ = *

++; 27: *op++ = *ip++; 26: *op++ = *ip++; 25: *op++ = *ip++;

57 24: *
İ
++ = *

++; 23: *op++ = *ip++; 22: *op++ = *ip++; 21: *op++ = *ip++;

58 20: *
İ
++ = *

++; 19: *op++ = *ip++; 18: *op++ = *ip++; 17: *op++ = *ip++;

59 16: *
İ
++ = *

++; 15: *op++ = *ip++; 14: *op++ = *ip++; 13: *op++ = *ip++;

60 12: *
İ
++ = *

++; 11: *op++ = *ip++; 10: *op++ = *ip++; 9: *op++ = *ip++;

61 8: *
İ
++ = *

++; 7: *op++ = *ip++; 6: *op++ = *ip++; 5: *op++ = *ip++;

62 4: *
İ
++ = *

++; 3: *op++ = *ip++; 2: *op++ = *ip++; 1: *op++ = *ip++;

68 
Ën
 = 
ù¾
 >> 5;

70 
u8
 *
»f
 = 
İ
 - ((
ù¾
 & 0x1f) << 8) - 1;

72 #ià
CHECK_INPUT


73 ià(

 >ğ
š_’d
)

75 
	`SET_ERRNO
 (
EINVAL
);

79 ià(
Ën
 == 7)

81 
Ën
 +ğ*

++;

82 #ià
CHECK_INPUT


83 ià(

 >ğ
š_’d
)

85 
	`SET_ERRNO
 (
EINVAL
);

91 
»f
 -ğ*

++;

93 ià(
İ
 + 
Ën
 + 2 > 
out_’d
)

95 
	`SET_ERRNO
 (
E2BIG
);

99 ià(
»f
 < (
u8
 *)
out_d©a
)

101 
	`SET_ERRNO
 (
EINVAL
);

105 #ifdeà
lzf_movsb


106 
Ën
 += 2;

107 
	`lzf_movsb
 (
İ
, 
»f
, 
Ën
);

109 
Ën
)

112 
Ën
 += 2;

114 ià(
İ
 >ğ
»f
 + 
Ën
)

117 
	`memıy
 (
İ
, 
»f
, 
Ën
);

118 
İ
 +ğ
Ën
;

124 *
İ
++ = *
»f
++;

125 --
Ën
);

130 9: *
İ
++ = *
»f
++;

131 8: *
İ
++ = *
»f
++;

132 7: *
İ
++ = *
»f
++;

133 6: *
İ
++ = *
»f
++;

134 5: *
İ
++ = *
»f
++;

135 4: *
İ
++ = *
»f
++;

136 3: *
İ
++ = *
»f
++;

137 2: *
İ
++ = *
»f
++;

138 1: *
İ
++ = *
»f
++;

139 0: *
İ
++ = *
»f
++;

140 *
İ
++ = *
»f
++;

145 

 < 
š_’d
);

147  
İ
 - (
u8
 *)
out_d©a
;

148 
	}
}

	@src/vr_master.c

1 
	~<vr_cÜe.h
>

3 
vr_ma¡”
 
	gma¡”
;

5 
£tup_ma¡”
();

6 *
ma¡”_th»ad_run
(*
¬gs
);

9 
	$ma¡”_š™
(
vr_cÚf
 *
cÚf
)

11 
r¡©us_t
 
¡©us
;

12 
ušt32_t
 
j
;

13 
sds
 *
ho¡
, 
li¡’_¡r
;

15 
vr_li¡’
 **
vli¡’
;

17 
th»ads_num
;

19 
f–im™
;

22 
ma¡”
.
cbsul
 = 
NULL
;

23 
	`±h»ad_mu‹x_š™
(&
ma¡”
.
cbsuÎock
, 
NULL
);

25 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_THREADS
,&
th»ads_num
);

27 
f–im™
 = 
th»ads_num
*2+
CONFIG_MIN_RESERVED_FDS
;

29 
	`vr_ev’oİ_š™
(&
ma¡”
.
v–
,
f–im™
);

31 
ma¡”
.
v–
.
th»ad
.
fun_run
 = 
ma¡”_th»ad_run
;

33 
	`d¬¿y_š™
(&
ma¡”
.
li¡’s
,
	`d¬¿y_n
(&
c£rv”
->
bšds
),(
vr_li¡’
*));

36 
j
 = 0; j < 
	`d¬¿y_n
(&
c£rv”
->
bšds
); j ++) {

38 
ho¡
 = 
	`d¬¿y_g‘
(&
c£rv”
->
bšds
,
j
);

40 
li¡’_¡r
 = 
	`sdsdup
(*
ho¡
);

42 
li¡’_¡r
 = 
	`sdsÿtfmt
Öi¡’_¡r, ":%i", 
c£rv”
->
pÜt
);

44 
vli¡’
 = 
	`d¬¿y_push
(&
ma¡”
.
li¡’s
);

45 *
vli¡’
 = 
	`vr_li¡’_ü—‹
(
li¡’_¡r
);

47 ià(*
vli¡’
 =ğ
NULL
) {

48 
	`d¬¿y_pİ
(&
ma¡”
.
li¡’s
);

49 
	`log_”rÜ
("C»©li¡’ % çed", 
li¡’_¡r
);

50 
	`sdsä“
(
li¡’_¡r
);

51  
VR_ERROR
;

53 
	`sdsä“
(
li¡’_¡r
);

56 
j
 = 0; j < 
	`d¬¿y_n
(&
ma¡”
.
li¡’s
); j ++) {

57 
vli¡’
 = 
	`d¬¿y_g‘
(&
ma¡”
.
li¡’s
, 
j
);

58 
¡©us
 = 
	`vr_li¡’_begš
(*
vli¡’
);

59 ià(
¡©us
 !ğ
VR_OK
) {

60 
	`log_”rÜ
("Begš†i¡’Ø% çed", (*
vli¡’
)->
Çme
);

61  
VR_ERROR
;

65 
ma¡”
.
cbsul
 = 
	`dli¡C»©e
();

66 ià(
ma¡”
.
cbsul
 =ğ
NULL
) {

67 
	`log_”rÜ
("Create†ist failed: out of memory");

68  
VR_ENOMEM
;

71 
	`£tup_ma¡”
();

73  
VR_OK
;

74 
	}
}

77 
	$ma¡”_deš™
()

79 
vr_li¡’
 **
vli¡’
;

81 
	`vr_ev’oİ_deš™
(&
ma¡”
.
v–
);

83 
	`d¬¿y_n
(&
ma¡”
.
li¡’s
) > 0) {

84 
vli¡’
 = 
	`d¬¿y_pİ
(&
ma¡”
.
li¡’s
);

85 
	`vr_li¡’_de¡roy
(*
vli¡’
);

87 
	`d¬¿y_deš™
(&
ma¡”
.
li¡’s
);

89 
	}
}

93 
	$ş›Á_acû±
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

94 
sd
;

95 
vr_li¡’
 *
vli¡’
 = 
´ivd©a
;

97 (
sd
 = 
	`vr_li¡’_acû±
(
vli¡’
)) > 0) {

98 
	`di¥©ch_cÚn_Ãw
(
vli¡’
, 
sd
);

100 
	}
}

104 
	$cbsul_push
(
cÚnsw­un™
 *
su
)

106 
	`±h»ad_mu‹x_lock
(&
ma¡”
.
cbsuÎock
);

107 
	`dli¡Push
(
ma¡”
.
cbsul
, 
su
);

108 
	`±h»ad_mu‹x_uÆock
(&
ma¡”
.
cbsuÎock
);

109 
	}
}

111 
cÚnsw­un™
 *

112 
	$cbsul_pİ
()

114 
cÚnsw­un™
 *
su
 = 
NULL
;

116 
	`±h»ad_mu‹x_lock
(&
ma¡”
.
cbsuÎock
);

117 
su
 = 
	`dli¡Pİ
(
ma¡”
.
cbsul
);

118 
	`±h»ad_mu‹x_uÆock
(&
ma¡”
.
cbsuÎock
);

120  
su
;

121 
	}
}

124 
	$di¥©ch_cÚn_exi¡
(
ş›Á
 *
c
, 
tid
)

126 
cÚnsw­un™
 *
su
 = 
	`csui_Ãw
();

127 
buf
[1];

128 
vr_wÜk”
 *
wÜk”
;

130 ià(
su
 =ğ
NULL
) {

131 
	`ä“Cl›Á
(
c
);

133 
	`log_”rÜ
("Failedo‡llocate memory for connection swap object\n");

137 
su
->
num
 = 
tid
;

138 
su
->
d©a
 = 
c
;

140 
	`uÆškCl›ÁFromEv’oİ
(
c
);

142 
	`cbsul_push
(
su
);

145 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, (
ušt32_t
)
c
->
curidx
);

149 
buf
[0] = 'b';

150 ià(
	`vr_wr™e
(
wÜk”
->
sock‘·œs
[1], 
buf
, 1) != 1) {

151 
	`log_”rÜ
("Noticehe worker failed.");

153 
	}
}

156 
	$th»ad_ev’t_´oûss
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

158 
r¡©us_t
 
¡©us
;

159 
vr_wÜk”
 *
wÜk”
 = 
´ivd©a
;

160 
buf
[1];

161 
idx
;

162 
ş›Á
 *
c
;

163 
cÚnsw­un™
 *
su
;

165 
	`ASSERT
(
–
 =ğ
ma¡”
.
v–
.el);

166 
	`ASSERT
(
fd
 =ğ
wÜk”
->
sock‘·œs
[0]);

168 ià(
	`vr_»ad
(
fd
, 
buf
, 1) != 1) {

169 
	`log_w¬n
("Can't„ead for worker(id:%d) socketpairs[1](%d)",

170 
wÜk”
->
v–
.
th»ad
.
id
, 
fd
);

171 
buf
[0] = 'b';

174 
buf
[0]) {

178 
su
 = 
	`cbsul_pİ
();

179 ià(
su
 =ğ
NULL
) {

180 
	`log_w¬n
("Pop from connection back swap†ist is‚ull");

184 
idx
 = 
su
->
num
;

185 
su
->
num
 = 
wÜk”
->
id
;

187 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, (
ušt32_t
)
idx
);

189 
	`csul_push
(
wÜk”
, 
su
);

193 
buf
[0] = 'j';

194 ià(
	`vr_wr™e
(
wÜk”
->
sock‘·œs
[0], 
buf
, 1) != 1) {

195 
	`log_”rÜ
("Noticehe worker failed.");

199 
	`log_”rÜ
("readƒrror char '%c' for worker(id:%d) socketpairs[0](%d)",

200 
buf
[0], 
wÜk”
->
v–
.
th»ad
.
id
, wÜk”->
sock‘·œs
[1]);

203 
	}
}

207 
	$£tup_ma¡”
()

209 
r¡©us_t
 
¡©us
;

210 
ušt32_t
 
j
;

211 
vr_li¡’
 **
vli¡’
;

212 
vr_wÜk”
 *
wÜk”
;

215 
j
 = 0; j < 
	`d¬¿y_n
(&
wÜk”s
); j ++) {

216 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
j
);

218 
¡©us
 = 
	`«C»©eFeEv’t
(
ma¡”
.
v–
.
–
, 
wÜk”
->
sock‘·œs
[0],

219 
AE_READABLE
, 
th»ad_ev’t_´oûss
, 
wÜk”
);

220 ià(
¡©us
 =ğ
AE_ERR
) {

221 
	`log_”rÜ
("Unrecoverableƒrror creating master ipfd fileƒvent.");

222  
VR_ERROR
;

227 
j
 = 0; j < 
	`d¬¿y_n
(&
ma¡”
.
li¡’s
); j ++) {

228 
vli¡’
 = 
	`d¬¿y_g‘
(&
ma¡”
.
li¡’s
,
j
);

229 
¡©us
 = 
	`«C»©eFeEv’t
(
ma¡”
.
v–
.
–
, (*
vli¡’
)->
sd
, 
AE_READABLE
,

230 
ş›Á_acû±
, *
vli¡’
);

231 ià(
¡©us
 =ğ
AE_ERR
) {

232 
	`log_”rÜ
("Unrecoverableƒrror creating master ipfd fileƒvent.");

233  
VR_ERROR
;

237  
VR_OK
;

238 
	}
}

242 
	$ma¡”_th»ad_run
(*
¬gs
)

245 
	`«Maš
(
ma¡”
.
v–
.
–
);

247  
NULL
;

248 
	}
}

251 
	$ma¡”_run
()

253 
	`vr_th»ad_¡¬t
(&
ma¡”
.
v–
.
th»ad
);

254  
VR_OK
;

255 
	}
}

	@src/vr_master.c

1 
	~<vr_cÜe.h
>

3 
vr_ma¡”
 
	gma¡”
;

5 
£tup_ma¡”
();

6 *
ma¡”_th»ad_run
(*
¬gs
);

9 
	$ma¡”_š™
(
vr_cÚf
 *
cÚf
)

11 
r¡©us_t
 
¡©us
;

12 
ušt32_t
 
j
;

13 
sds
 *
ho¡
, 
li¡’_¡r
;

15 
vr_li¡’
 **
vli¡’
;

17 
th»ads_num
;

19 
f–im™
;

22 
ma¡”
.
cbsul
 = 
NULL
;

23 
	`±h»ad_mu‹x_š™
(&
ma¡”
.
cbsuÎock
, 
NULL
);

25 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_THREADS
,&
th»ads_num
);

27 
f–im™
 = 
th»ads_num
*2+
CONFIG_MIN_RESERVED_FDS
;

29 
	`vr_ev’oİ_š™
(&
ma¡”
.
v–
,
f–im™
);

31 
ma¡”
.
v–
.
th»ad
.
fun_run
 = 
ma¡”_th»ad_run
;

33 
	`d¬¿y_š™
(&
ma¡”
.
li¡’s
,
	`d¬¿y_n
(&
c£rv”
->
bšds
),(
vr_li¡’
*));

36 
j
 = 0; j < 
	`d¬¿y_n
(&
c£rv”
->
bšds
); j ++) {

38 
ho¡
 = 
	`d¬¿y_g‘
(&
c£rv”
->
bšds
,
j
);

40 
li¡’_¡r
 = 
	`sdsdup
(*
ho¡
);

42 
li¡’_¡r
 = 
	`sdsÿtfmt
Öi¡’_¡r, ":%i", 
c£rv”
->
pÜt
);

44 
vli¡’
 = 
	`d¬¿y_push
(&
ma¡”
.
li¡’s
);

45 *
vli¡’
 = 
	`vr_li¡’_ü—‹
(
li¡’_¡r
);

47 ià(*
vli¡’
 =ğ
NULL
) {

48 
	`d¬¿y_pİ
(&
ma¡”
.
li¡’s
);

49 
	`log_”rÜ
("C»©li¡’ % çed", 
li¡’_¡r
);

50 
	`sdsä“
(
li¡’_¡r
);

51  
VR_ERROR
;

53 
	`sdsä“
(
li¡’_¡r
);

56 
j
 = 0; j < 
	`d¬¿y_n
(&
ma¡”
.
li¡’s
); j ++) {

57 
vli¡’
 = 
	`d¬¿y_g‘
(&
ma¡”
.
li¡’s
, 
j
);

58 
¡©us
 = 
	`vr_li¡’_begš
(*
vli¡’
);

59 ià(
¡©us
 !ğ
VR_OK
) {

60 
	`log_”rÜ
("Begš†i¡’Ø% çed", (*
vli¡’
)->
Çme
);

61  
VR_ERROR
;

65 
ma¡”
.
cbsul
 = 
	`dli¡C»©e
();

66 ià(
ma¡”
.
cbsul
 =ğ
NULL
) {

67 
	`log_”rÜ
("Create†ist failed: out of memory");

68  
VR_ENOMEM
;

71 
	`£tup_ma¡”
();

73  
VR_OK
;

74 
	}
}

77 
	$ma¡”_deš™
()

79 
vr_li¡’
 **
vli¡’
;

81 
	`vr_ev’oİ_deš™
(&
ma¡”
.
v–
);

83 
	`d¬¿y_n
(&
ma¡”
.
li¡’s
) > 0) {

84 
vli¡’
 = 
	`d¬¿y_pİ
(&
ma¡”
.
li¡’s
);

85 
	`vr_li¡’_de¡roy
(*
vli¡’
);

87 
	`d¬¿y_deš™
(&
ma¡”
.
li¡’s
);

89 
	}
}

93 
	$ş›Á_acû±
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

94 
sd
;

95 
vr_li¡’
 *
vli¡’
 = 
´ivd©a
;

97 (
sd
 = 
	`vr_li¡’_acû±
(
vli¡’
)) > 0) {

98 
	`di¥©ch_cÚn_Ãw
(
vli¡’
, 
sd
);

100 
	}
}

104 
	$cbsul_push
(
cÚnsw­un™
 *
su
)

106 
	`±h»ad_mu‹x_lock
(&
ma¡”
.
cbsuÎock
);

107 
	`dli¡Push
(
ma¡”
.
cbsul
, 
su
);

108 
	`±h»ad_mu‹x_uÆock
(&
ma¡”
.
cbsuÎock
);

109 
	}
}

111 
cÚnsw­un™
 *

112 
	$cbsul_pİ
()

114 
cÚnsw­un™
 *
su
 = 
NULL
;

116 
	`±h»ad_mu‹x_lock
(&
ma¡”
.
cbsuÎock
);

117 
su
 = 
	`dli¡Pİ
(
ma¡”
.
cbsul
);

118 
	`±h»ad_mu‹x_uÆock
(&
ma¡”
.
cbsuÎock
);

120  
su
;

121 
	}
}

124 
	$di¥©ch_cÚn_exi¡
(
ş›Á
 *
c
, 
tid
)

126 
cÚnsw­un™
 *
su
 = 
	`csui_Ãw
();

127 
buf
[1];

128 
vr_wÜk”
 *
wÜk”
;

130 ià(
su
 =ğ
NULL
) {

131 
	`ä“Cl›Á
(
c
);

133 
	`log_”rÜ
("Failedo‡llocate memory for connection swap object\n");

137 
su
->
num
 = 
tid
;

138 
su
->
d©a
 = 
c
;

140 
	`uÆškCl›ÁFromEv’oİ
(
c
);

142 
	`cbsul_push
(
su
);

145 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, (
ušt32_t
)
c
->
curidx
);

149 
buf
[0] = 'b';

150 ià(
	`vr_wr™e
(
wÜk”
->
sock‘·œs
[1], 
buf
, 1) != 1) {

151 
	`log_”rÜ
("Noticehe worker failed.");

153 
	}
}

156 
	$th»ad_ev’t_´oûss
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

158 
r¡©us_t
 
¡©us
;

159 
vr_wÜk”
 *
wÜk”
 = 
´ivd©a
;

160 
buf
[1];

161 
idx
;

162 
ş›Á
 *
c
;

163 
cÚnsw­un™
 *
su
;

165 
	`ASSERT
(
–
 =ğ
ma¡”
.
v–
.el);

166 
	`ASSERT
(
fd
 =ğ
wÜk”
->
sock‘·œs
[0]);

168 ià(
	`vr_»ad
(
fd
, 
buf
, 1) != 1) {

169 
	`log_w¬n
("Can't„ead for worker(id:%d) socketpairs[1](%d)",

170 
wÜk”
->
v–
.
th»ad
.
id
, 
fd
);

171 
buf
[0] = 'b';

174 
buf
[0]) {

178 
su
 = 
	`cbsul_pİ
();

179 ià(
su
 =ğ
NULL
) {

180 
	`log_w¬n
("Pop from connection back swap†ist is‚ull");

184 
idx
 = 
su
->
num
;

185 
su
->
num
 = 
wÜk”
->
id
;

187 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, (
ušt32_t
)
idx
);

189 
	`csul_push
(
wÜk”
, 
su
);

193 
buf
[0] = 'j';

194 ià(
	`vr_wr™e
(
wÜk”
->
sock‘·œs
[0], 
buf
, 1) != 1) {

195 
	`log_”rÜ
("Noticehe worker failed.");

199 
	`log_”rÜ
("readƒrror char '%c' for worker(id:%d) socketpairs[0](%d)",

200 
buf
[0], 
wÜk”
->
v–
.
th»ad
.
id
, wÜk”->
sock‘·œs
[1]);

203 
	}
}

207 
	$£tup_ma¡”
()

209 
r¡©us_t
 
¡©us
;

210 
ušt32_t
 
j
;

211 
vr_li¡’
 **
vli¡’
;

212 
vr_wÜk”
 *
wÜk”
;

215 
j
 = 0; j < 
	`d¬¿y_n
(&
wÜk”s
); j ++) {

216 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
j
);

218 
¡©us
 = 
	`«C»©eFeEv’t
(
ma¡”
.
v–
.
–
, 
wÜk”
->
sock‘·œs
[0],

219 
AE_READABLE
, 
th»ad_ev’t_´oûss
, 
wÜk”
);

220 ià(
¡©us
 =ğ
AE_ERR
) {

221 
	`log_”rÜ
("Unrecoverableƒrror creating master ipfd fileƒvent.");

222  
VR_ERROR
;

227 
j
 = 0; j < 
	`d¬¿y_n
(&
ma¡”
.
li¡’s
); j ++) {

228 
vli¡’
 = 
	`d¬¿y_g‘
(&
ma¡”
.
li¡’s
,
j
);

229 
¡©us
 = 
	`«C»©eFeEv’t
(
ma¡”
.
v–
.
–
, (*
vli¡’
)->
sd
, 
AE_READABLE
,

230 
ş›Á_acû±
, *
vli¡’
);

231 ià(
¡©us
 =ğ
AE_ERR
) {

232 
	`log_”rÜ
("Unrecoverableƒrror creating master ipfd fileƒvent.");

233  
VR_ERROR
;

237  
VR_OK
;

238 
	}
}

242 
	$ma¡”_th»ad_run
(*
¬gs
)

245 
	`«Maš
(
ma¡”
.
v–
.
–
);

247  
NULL
;

248 
	}
}

251 
	$ma¡”_run
()

253 
	`vr_th»ad_¡¬t
(&
ma¡”
.
v–
.
th»ad
);

254  
VR_OK
;

255 
	}
}

	@src/vr_master.h

1 #iâdeà
_VR_MASTER_H_


2 
	#_VR_MASTER_H_


	)

4 
	svr_ma¡”
 {

7 
vr_ev’oİ
 
	mv–
;

9 
d¬¿y
 
	mli¡’s
;

11 
dli¡
 *
	mcbsul
;

13 
±h»ad_mu‹x_t
 
	mcbsuÎock
;

14 }
	tvr_ma¡”
;

16 
vr_ma¡”
 
ma¡”
;

18 
ma¡”_š™
(
vr_cÚf
 *
cÚf
);

19 
ma¡”_deš™
();

21 
di¥©ch_cÚn_exi¡
(
ş›Á
 *
c
, 
tid
);

23 
ma¡”_run
();

	@src/vr_master.h

1 #iâdeà
_VR_MASTER_H_


2 
	#_VR_MASTER_H_


	)

4 
	svr_ma¡”
 {

7 
vr_ev’oİ
 
	mv–
;

9 
d¬¿y
 
	mli¡’s
;

11 
dli¡
 *
	mcbsul
;

13 
±h»ad_mu‹x_t
 
	mcbsuÎock
;

14 }
	tvr_ma¡”
;

16 
vr_ma¡”
 
ma¡”
;

18 
ma¡”_š™
(
vr_cÚf
 *
cÚf
);

19 
ma¡”_deš™
();

21 
di¥©ch_cÚn_exi¡
(
ş›Á
 *
c
, 
tid
);

23 
ma¡”_run
();

	@src/vr_multi.c

1 
	~<vr_cÜe.h
>

16 
	sw©chedKey
 {

17 
robj
 *
	mkey
;

18 
»disDb
 *
	mdb
;

19 } 
	tw©chedKey
;

24 
	$unw©chAÎKeys
(
ş›Á
 *
c
) {

25 
dli¡I‹r
 
li
;

26 
dli¡Node
 *
Ê
;

28 ià(
	`dli¡L’gth
(
c
->
w©ched_keys
) == 0) ;

29 
	`dli¡Rewšd
(
c
->
w©ched_keys
,&
li
);

30 (
Ê
 = 
	`dli¡Next
(&
li
))) {

31 
dli¡
 *
ş›Ás
;

32 
w©chedKey
 *
wk
;

36 
wk
 = 
	`dli¡NodeV®ue
(
Ê
);

37 
ş›Ás
 = 
	`diùF‘chV®ue
(
wk
->
db
->
w©ched_keys
, wk->
key
);

38 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
ş›Ás
 != NULL);

39 
	`dli¡D–Node
(
ş›Ás
,
	`dli¡S—rchKey
(ş›Ás,
c
));

41 ià(
	`dli¡L’gth
(
ş›Ás
) == 0)

42 
	`diùD–‘e
(
wk
->
db
->
w©ched_keys
, wk->
key
);

44 
	`dli¡D–Node
(
c
->
w©ched_keys
,
Ê
);

45 
	`deüRefCouÁ
(
wk
->
key
);

46 
	`dä“
(
wk
);

48 
	}
}

51 
	$š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

52 
c
->
m¡©e
.
commªds
 = 
NULL
;

53 
c
->
m¡©e
.
couÁ
 = 0;

54 
	}
}

57 
	$ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

58 
j
;

60 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

61 
i
;

62 
muÉiCmd
 *
mc
 = 
c
->
m¡©e
.
commªds
+
j
;

64 
i
 = 0; i < 
mc
->
¬gc
; i++)

65 
	`deüRefCouÁ
(
mc
->
¬gv
[
i
]);

66 
	`dä“
(
mc
->
¬gv
);

68 ià(
c
->
m¡©e
.
commªds
è
	`dä“
(c->mstate.commands);

69 
	}
}

72 
	$queueMuÉiCommªd
(
ş›Á
 *
c
) {

73 
muÉiCmd
 *
mc
;

74 
j
;

76 
c
->
m¡©e
.
commªds
 = 
	`d»®loc
(c->mstate.commands,

77 (
muÉiCmd
)*(
c
->
m¡©e
.
couÁ
+1));

78 
mc
 = 
c
->
m¡©e
.
commªds
+c->m¡©e.
couÁ
;

79 
mc
->
cmd
 = 
c
->cmd;

80 
mc
->
¬gc
 = 
c
->argc;

81 
mc
->
¬gv
 = 
	`d®loc
((
robj
*)*
c
->
¬gc
);

82 
	`memıy
(
mc
->
¬gv
,
c
->¬gv,(
robj
*)*c->
¬gc
);

83 
j
 = 0; j < 
c
->
¬gc
; j++)

84 
	`šüRefCouÁ
(
mc
->
¬gv
[
j
]);

85 
c
->
m¡©e
.
couÁ
++;

86 
	}
}

90 
	$æagT¿n§ùiÚ
(
ş›Á
 *
c
) {

91 ià(
c
->
æags
 & 
CLIENT_MULTI
)

92 
c
->
æags
 |ğ
CLIENT_DIRTY_EXEC
;

93 
	}
}

95 
	$execCommªd
(
ş›Á
 *
c
) {

96 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

97 
	}
}

99 
	$disÿrdCommªd
(
ş›Á
 *
c
) {

100 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)) {

101 
	`addR•lyE¼Ü
(
c
,"DISCARD without MULTI");

104 
	`disÿrdT¿n§ùiÚ
(
c
);

105 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

106 
	}
}

108 
	$disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
) {

109 
	`ä“Cl›ÁMuÉiS‹
(
c
);

110 
	`š™Cl›ÁMuÉiS‹
(
c
);

111 
c
->
æags
 &ğ~(
CLIENT_MULTI
|
CLIENT_DIRTY_CAS
|
CLIENT_DIRTY_EXEC
);

112 
	`unw©chAÎKeys
(
c
);

113 
	}
}

115 
	$muÉiCommªd
(
ş›Á
 *
c
) {

116 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

117 
	`addR•lyE¼Ü
(
c
,"MULTI calls can‚ot be‚ested");

120 
c
->
æags
 |ğ
CLIENT_MULTI
;

121 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

122 
	}
}

125 
	$w©chFÜKey
(
ş›Á
 *
c
, 
robj
 *
key
) {

126 
dli¡
 *
ş›Ás
 = 
NULL
;

127 
dli¡I‹r
 
li
;

128 
dli¡Node
 *
Ê
;

129 
w©chedKey
 *
wk
;

132 
	`dli¡Rewšd
(
c
->
w©ched_keys
,&
li
);

133 (
Ê
 = 
	`dli¡Next
(&
li
))) {

134 
wk
 = 
	`dli¡NodeV®ue
(
Ê
);

135 ià(
wk
->
db
 =ğ
c
->db && 
	`equ®SŒšgObjeùs
(
key
,wk->key))

139 
ş›Ás
 = 
	`diùF‘chV®ue
(
c
->
db
->
w©ched_keys
,
key
);

140 ià(!
ş›Ás
) {

141 
ş›Ás
 = 
	`dli¡C»©e
();

142 
	`diùAdd
(
c
->
db
->
w©ched_keys
,
key
,
ş›Ás
);

143 
	`šüRefCouÁ
(
key
);

145 
	`dli¡AddNodeTa
(
ş›Ás
,
c
);

147 
wk
 = 
	`d®loc
((*wk));

148 
wk
->
key
 = key;

149 
wk
->
db
 = 
c
->db;

150 
	`šüRefCouÁ
(
key
);

151 
	`dli¡AddNodeTa
(
c
->
w©ched_keys
,
wk
);

152 
	}
}

154 
	$w©chCommªd
(
ş›Á
 *
c
) {

155 
j
;

157 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

158 
	`addR•lyE¼Ü
(
c
,"WATCH inside MULTI is‚ot‡llowed");

161 
j
 = 1; j < 
c
->
¬gc
; j++)

162 
	`w©chFÜKey
(
c
,c->
¬gv
[
j
]);

163 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

164 
	}
}

168 
	$touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
) {

169 
dli¡
 *
ş›Ás
;

170 
dli¡I‹r
 
li
;

171 
dli¡Node
 *
Ê
;

173 ià(
	`diùSize
(
db
->
w©ched_keys
) == 0) ;

174 
ş›Ás
 = 
	`diùF‘chV®ue
(
db
->
w©ched_keys
, 
key
);

175 ià(!
ş›Ás
) ;

179 
	`dli¡Rewšd
(
ş›Ás
,&
li
);

180 (
Ê
 = 
	`dli¡Next
(&
li
))) {

181 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

183 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

185 
	}
}

191 
	$touchW©chedKeysOnFlush
(
dbid
) {

192 
dli¡I‹r
 
li1
, 
li2
;

193 
dli¡Node
 *
Ê
;

196 
	`dli¡Rewšd
(
£rv”
.
ş›Ás
,&
li1
);

197 (
Ê
 = 
	`dli¡Next
(&
li1
))) {

198 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

199 
	`dli¡Rewšd
(
c
->
w©ched_keys
,&
li2
);

200 (
Ê
 = 
	`dli¡Next
(&
li2
))) {

201 
w©chedKey
 *
wk
 = 
	`dli¡NodeV®ue
(
Ê
);

206 ià(
dbid
 =ğ-1 || 
wk
->
db
->
id
 == dbid) {

207 ià(
	`diùFšd
(
wk
->
db
->
diù
, wk->
key
->
±r
è!ğ
NULL
)

208 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

212 
	}
}

	@src/vr_multi.c

1 
	~<vr_cÜe.h
>

16 
	sw©chedKey
 {

17 
robj
 *
	mkey
;

18 
»disDb
 *
	mdb
;

19 } 
	tw©chedKey
;

24 
	$unw©chAÎKeys
(
ş›Á
 *
c
) {

25 
dli¡I‹r
 
li
;

26 
dli¡Node
 *
Ê
;

28 ià(
	`dli¡L’gth
(
c
->
w©ched_keys
) == 0) ;

29 
	`dli¡Rewšd
(
c
->
w©ched_keys
,&
li
);

30 (
Ê
 = 
	`dli¡Next
(&
li
))) {

31 
dli¡
 *
ş›Ás
;

32 
w©chedKey
 *
wk
;

36 
wk
 = 
	`dli¡NodeV®ue
(
Ê
);

37 
ş›Ás
 = 
	`diùF‘chV®ue
(
wk
->
db
->
w©ched_keys
, wk->
key
);

38 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
ş›Ás
 != NULL);

39 
	`dli¡D–Node
(
ş›Ás
,
	`dli¡S—rchKey
(ş›Ás,
c
));

41 ià(
	`dli¡L’gth
(
ş›Ás
) == 0)

42 
	`diùD–‘e
(
wk
->
db
->
w©ched_keys
, wk->
key
);

44 
	`dli¡D–Node
(
c
->
w©ched_keys
,
Ê
);

45 
	`deüRefCouÁ
(
wk
->
key
);

46 
	`dä“
(
wk
);

48 
	}
}

51 
	$š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

52 
c
->
m¡©e
.
commªds
 = 
NULL
;

53 
c
->
m¡©e
.
couÁ
 = 0;

54 
	}
}

57 
	$ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

58 
j
;

60 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

61 
i
;

62 
muÉiCmd
 *
mc
 = 
c
->
m¡©e
.
commªds
+
j
;

64 
i
 = 0; i < 
mc
->
¬gc
; i++)

65 
	`deüRefCouÁ
(
mc
->
¬gv
[
i
]);

66 
	`dä“
(
mc
->
¬gv
);

68 ià(
c
->
m¡©e
.
commªds
è
	`dä“
(c->mstate.commands);

69 
	}
}

72 
	$queueMuÉiCommªd
(
ş›Á
 *
c
) {

73 
muÉiCmd
 *
mc
;

74 
j
;

76 
c
->
m¡©e
.
commªds
 = 
	`d»®loc
(c->mstate.commands,

77 (
muÉiCmd
)*(
c
->
m¡©e
.
couÁ
+1));

78 
mc
 = 
c
->
m¡©e
.
commªds
+c->m¡©e.
couÁ
;

79 
mc
->
cmd
 = 
c
->cmd;

80 
mc
->
¬gc
 = 
c
->argc;

81 
mc
->
¬gv
 = 
	`d®loc
((
robj
*)*
c
->
¬gc
);

82 
	`memıy
(
mc
->
¬gv
,
c
->¬gv,(
robj
*)*c->
¬gc
);

83 
j
 = 0; j < 
c
->
¬gc
; j++)

84 
	`šüRefCouÁ
(
mc
->
¬gv
[
j
]);

85 
c
->
m¡©e
.
couÁ
++;

86 
	}
}

90 
	$æagT¿n§ùiÚ
(
ş›Á
 *
c
) {

91 ià(
c
->
æags
 & 
CLIENT_MULTI
)

92 
c
->
æags
 |ğ
CLIENT_DIRTY_EXEC
;

93 
	}
}

95 
	$execCommªd
(
ş›Á
 *
c
) {

96 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

97 
	}
}

99 
	$disÿrdCommªd
(
ş›Á
 *
c
) {

100 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)) {

101 
	`addR•lyE¼Ü
(
c
,"DISCARD without MULTI");

104 
	`disÿrdT¿n§ùiÚ
(
c
);

105 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

106 
	}
}

108 
	$disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
) {

109 
	`ä“Cl›ÁMuÉiS‹
(
c
);

110 
	`š™Cl›ÁMuÉiS‹
(
c
);

111 
c
->
æags
 &ğ~(
CLIENT_MULTI
|
CLIENT_DIRTY_CAS
|
CLIENT_DIRTY_EXEC
);

112 
	`unw©chAÎKeys
(
c
);

113 
	}
}

115 
	$muÉiCommªd
(
ş›Á
 *
c
) {

116 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

117 
	`addR•lyE¼Ü
(
c
,"MULTI calls can‚ot be‚ested");

120 
c
->
æags
 |ğ
CLIENT_MULTI
;

121 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

122 
	}
}

125 
	$w©chFÜKey
(
ş›Á
 *
c
, 
robj
 *
key
) {

126 
dli¡
 *
ş›Ás
 = 
NULL
;

127 
dli¡I‹r
 
li
;

128 
dli¡Node
 *
Ê
;

129 
w©chedKey
 *
wk
;

132 
	`dli¡Rewšd
(
c
->
w©ched_keys
,&
li
);

133 (
Ê
 = 
	`dli¡Next
(&
li
))) {

134 
wk
 = 
	`dli¡NodeV®ue
(
Ê
);

135 ià(
wk
->
db
 =ğ
c
->db && 
	`equ®SŒšgObjeùs
(
key
,wk->key))

139 
ş›Ás
 = 
	`diùF‘chV®ue
(
c
->
db
->
w©ched_keys
,
key
);

140 ià(!
ş›Ás
) {

141 
ş›Ás
 = 
	`dli¡C»©e
();

142 
	`diùAdd
(
c
->
db
->
w©ched_keys
,
key
,
ş›Ás
);

143 
	`šüRefCouÁ
(
key
);

145 
	`dli¡AddNodeTa
(
ş›Ás
,
c
);

147 
wk
 = 
	`d®loc
((*wk));

148 
wk
->
key
 = key;

149 
wk
->
db
 = 
c
->db;

150 
	`šüRefCouÁ
(
key
);

151 
	`dli¡AddNodeTa
(
c
->
w©ched_keys
,
wk
);

152 
	}
}

154 
	$w©chCommªd
(
ş›Á
 *
c
) {

155 
j
;

157 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

158 
	`addR•lyE¼Ü
(
c
,"WATCH inside MULTI is‚ot‡llowed");

161 
j
 = 1; j < 
c
->
¬gc
; j++)

162 
	`w©chFÜKey
(
c
,c->
¬gv
[
j
]);

163 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

164 
	}
}

168 
	$touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
) {

169 
dli¡
 *
ş›Ás
;

170 
dli¡I‹r
 
li
;

171 
dli¡Node
 *
Ê
;

173 ià(
	`diùSize
(
db
->
w©ched_keys
) == 0) ;

174 
ş›Ás
 = 
	`diùF‘chV®ue
(
db
->
w©ched_keys
, 
key
);

175 ià(!
ş›Ás
) ;

179 
	`dli¡Rewšd
(
ş›Ás
,&
li
);

180 (
Ê
 = 
	`dli¡Next
(&
li
))) {

181 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

183 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

185 
	}
}

191 
	$touchW©chedKeysOnFlush
(
dbid
) {

192 
dli¡I‹r
 
li1
, 
li2
;

193 
dli¡Node
 *
Ê
;

196 
	`dli¡Rewšd
(
£rv”
.
ş›Ás
,&
li1
);

197 (
Ê
 = 
	`dli¡Next
(&
li1
))) {

198 
ş›Á
 *
c
 = 
	`dli¡NodeV®ue
(
Ê
);

199 
	`dli¡Rewšd
(
c
->
w©ched_keys
,&
li2
);

200 (
Ê
 = 
	`dli¡Next
(&
li2
))) {

201 
w©chedKey
 *
wk
 = 
	`dli¡NodeV®ue
(
Ê
);

206 ià(
dbid
 =ğ-1 || 
wk
->
db
->
id
 == dbid) {

207 ià(
	`diùFšd
(
wk
->
db
->
diù
, wk->
key
->
±r
è!ğ
NULL
)

208 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

212 
	}
}

	@src/vr_multi.h

1 #iâdeà
_VR_MULTI_H_


2 
	#_VR_MULTI_H_


	)

5 
	smuÉiCmd
 {

6 
robj
 **
	m¬gv
;

7 
	m¬gc
;

8 
»disCommªd
 *
	mcmd
;

9 } 
	tmuÉiCmd
;

11 
	smuÉiS‹
 {

12 
muÉiCmd
 *
	mcommªds
;

13 
	mcouÁ
;

14 
	mmš»¶iÿs
;

15 
time_t
 
	mmš»¶iÿs_timeout
;

16 } 
	tmuÉiS‹
;

18 
unw©chAÎKeys
(
ş›Á
 *
c
);

19 
š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

20 
ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

21 
queueMuÉiCommªd
(
ş›Á
 *
c
);

23 
æagT¿n§ùiÚ
(
ş›Á
 *
c
);

24 
execCommªd
(
ş›Á
 *
c
);

25 
disÿrdCommªd
(
ş›Á
 *
c
);

26 
disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
);

27 
muÉiCommªd
(
ş›Á
 *
c
);

28 
w©chFÜKey
(
ş›Á
 *
c
, 
robj
 *
key
);

29 
w©chCommªd
(
ş›Á
 *
c
);

30 
touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
);

31 
touchW©chedKeysOnFlush
(
dbid
) ;

	@src/vr_multi.h

1 #iâdeà
_VR_MULTI_H_


2 
	#_VR_MULTI_H_


	)

5 
	smuÉiCmd
 {

6 
robj
 **
	m¬gv
;

7 
	m¬gc
;

8 
»disCommªd
 *
	mcmd
;

9 } 
	tmuÉiCmd
;

11 
	smuÉiS‹
 {

12 
muÉiCmd
 *
	mcommªds
;

13 
	mcouÁ
;

14 
	mmš»¶iÿs
;

15 
time_t
 
	mmš»¶iÿs_timeout
;

16 } 
	tmuÉiS‹
;

18 
unw©chAÎKeys
(
ş›Á
 *
c
);

19 
š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

20 
ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

21 
queueMuÉiCommªd
(
ş›Á
 *
c
);

23 
æagT¿n§ùiÚ
(
ş›Á
 *
c
);

24 
execCommªd
(
ş›Á
 *
c
);

25 
disÿrdCommªd
(
ş›Á
 *
c
);

26 
disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
);

27 
muÉiCommªd
(
ş›Á
 *
c
);

28 
w©chFÜKey
(
ş›Á
 *
c
, 
robj
 *
key
);

29 
w©chCommªd
(
ş›Á
 *
c
);

30 
touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
);

31 
touchW©chedKeysOnFlush
(
dbid
) ;

	@src/vr_notify.c

1 
	~<vr_cÜe.h
>

12 
	$key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
) {

13 *
p
 = 
şas£s
;

14 
c
, 
æags
 = 0;

16 (
c
 = *
p
++) != '\0') {

17 
c
) {

18 'A': 
æags
 |ğ
NOTIFY_ALL
; ;

19 'g': 
æags
 |ğ
NOTIFY_GENERIC
; ;

20 '$': 
æags
 |ğ
NOTIFY_STRING
; ;

21 'l': 
æags
 |ğ
NOTIFY_LIST
; ;

22 's': 
æags
 |ğ
NOTIFY_SET
; ;

23 'h': 
æags
 |ğ
NOTIFY_HASH
; ;

24 'z': 
æags
 |ğ
NOTIFY_ZSET
; ;

25 'x': 
æags
 |ğ
NOTIFY_EXPIRED
; ;

26 'e': 
æags
 |ğ
NOTIFY_EVICTED
; ;

27 'K': 
æags
 |ğ
NOTIFY_KEYSPACE
; ;

28 'E': 
æags
 |ğ
NOTIFY_KEYEVENT
; ;

32  
æags
;

33 
	}
}

40 
sds
 
	$key¥aûEv’tsFÏgsToSŒšg
(
æags
) {

41 
sds
 
»s
;

43 
»s
 = 
	`sd£m±y
();

44 ià((
æags
 & 
NOTIFY_ALL
) == NOTIFY_ALL) {

45 
»s
 = 
	`sdsÿ’
(res,"A",1);

47 ià(
æags
 & 
NOTIFY_GENERIC
è
»s
 = 
	`sdsÿ’
(res,"g",1);

48 ià(
æags
 & 
NOTIFY_STRING
è
»s
 = 
	`sdsÿ’
(res,"$",1);

49 ià(
æags
 & 
NOTIFY_LIST
è
»s
 = 
	`sdsÿ’
(res,"l",1);

50 ià(
æags
 & 
NOTIFY_SET
è
»s
 = 
	`sdsÿ’
(res,"s",1);

51 ià(
æags
 & 
NOTIFY_HASH
è
»s
 = 
	`sdsÿ’
(res,"h",1);

52 ià(
æags
 & 
NOTIFY_ZSET
è
»s
 = 
	`sdsÿ’
(res,"z",1);

53 ià(
æags
 & 
NOTIFY_EXPIRED
è
»s
 = 
	`sdsÿ’
(res,"x",1);

54 ià(
æags
 & 
NOTIFY_EVICTED
è
»s
 = 
	`sdsÿ’
(res,"e",1);

56 ià(
æags
 & 
NOTIFY_KEYSPACE
è
»s
 = 
	`sdsÿ’
(res,"K",1);

57 ià(
æags
 & 
NOTIFY_KEYEVENT
è
»s
 = 
	`sdsÿ’
(res,"E",1);

58  
»s
;

59 
	}
}

69 
	$nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
) {

70 
sds
 
chª
;

71 
robj
 *
chªobj
, *
ev’tobj
;

72 
Ën
 = -1;

73 
buf
[24];

76 ià(!(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
ty³
)) ;

78 
ev’tobj
 = 
	`ü—‹SŒšgObjeù
(
ev’t
,
	`¡¾’
(event));

81 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYSPACE
) {

82 
chª
 = 
	`sd¢ewËn
("__keyspace@",11);

84 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
dbid
);

86 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

87 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

88 
chª
 = 
	`sdsÿtsds
(chª, 
key
->
±r
);

89 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

91 
	`pubsubPublishMes§ge
(
chªobj
, 
ev’tobj
);

92 
	`deüRefCouÁ
(
chªobj
);

96 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYEVENT
) {

97 
chª
 = 
	`sd¢ewËn
("__keyevent@",11);

98 ià(
Ën
 =ğ-1èËÀğ
	`Î2¡ršg
(
buf
,(buf),
dbid
);

99 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

100 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

101 
chª
 = 
	`sdsÿtsds
(chª, 
ev’tobj
->
±r
);

102 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

103 
	`pubsubPublishMes§ge
(
chªobj
, 
key
);

104 
	`deüRefCouÁ
(
chªobj
);

106 
	`deüRefCouÁ
(
ev’tobj
);

107 
	}
}

	@src/vr_notify.c

1 
	~<vr_cÜe.h
>

12 
	$key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
) {

13 *
p
 = 
şas£s
;

14 
c
, 
æags
 = 0;

16 (
c
 = *
p
++) != '\0') {

17 
c
) {

18 'A': 
æags
 |ğ
NOTIFY_ALL
; ;

19 'g': 
æags
 |ğ
NOTIFY_GENERIC
; ;

20 '$': 
æags
 |ğ
NOTIFY_STRING
; ;

21 'l': 
æags
 |ğ
NOTIFY_LIST
; ;

22 's': 
æags
 |ğ
NOTIFY_SET
; ;

23 'h': 
æags
 |ğ
NOTIFY_HASH
; ;

24 'z': 
æags
 |ğ
NOTIFY_ZSET
; ;

25 'x': 
æags
 |ğ
NOTIFY_EXPIRED
; ;

26 'e': 
æags
 |ğ
NOTIFY_EVICTED
; ;

27 'K': 
æags
 |ğ
NOTIFY_KEYSPACE
; ;

28 'E': 
æags
 |ğ
NOTIFY_KEYEVENT
; ;

32  
æags
;

33 
	}
}

40 
sds
 
	$key¥aûEv’tsFÏgsToSŒšg
(
æags
) {

41 
sds
 
»s
;

43 
»s
 = 
	`sd£m±y
();

44 ià((
æags
 & 
NOTIFY_ALL
) == NOTIFY_ALL) {

45 
»s
 = 
	`sdsÿ’
(res,"A",1);

47 ià(
æags
 & 
NOTIFY_GENERIC
è
»s
 = 
	`sdsÿ’
(res,"g",1);

48 ià(
æags
 & 
NOTIFY_STRING
è
»s
 = 
	`sdsÿ’
(res,"$",1);

49 ià(
æags
 & 
NOTIFY_LIST
è
»s
 = 
	`sdsÿ’
(res,"l",1);

50 ià(
æags
 & 
NOTIFY_SET
è
»s
 = 
	`sdsÿ’
(res,"s",1);

51 ià(
æags
 & 
NOTIFY_HASH
è
»s
 = 
	`sdsÿ’
(res,"h",1);

52 ià(
æags
 & 
NOTIFY_ZSET
è
»s
 = 
	`sdsÿ’
(res,"z",1);

53 ià(
æags
 & 
NOTIFY_EXPIRED
è
»s
 = 
	`sdsÿ’
(res,"x",1);

54 ià(
æags
 & 
NOTIFY_EVICTED
è
»s
 = 
	`sdsÿ’
(res,"e",1);

56 ià(
æags
 & 
NOTIFY_KEYSPACE
è
»s
 = 
	`sdsÿ’
(res,"K",1);

57 ià(
æags
 & 
NOTIFY_KEYEVENT
è
»s
 = 
	`sdsÿ’
(res,"E",1);

58  
»s
;

59 
	}
}

69 
	$nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
) {

70 
sds
 
chª
;

71 
robj
 *
chªobj
, *
ev’tobj
;

72 
Ën
 = -1;

73 
buf
[24];

76 ià(!(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
ty³
)) ;

78 
ev’tobj
 = 
	`ü—‹SŒšgObjeù
(
ev’t
,
	`¡¾’
(event));

81 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYSPACE
) {

82 
chª
 = 
	`sd¢ewËn
("__keyspace@",11);

84 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
dbid
);

86 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

87 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

88 
chª
 = 
	`sdsÿtsds
(chª, 
key
->
±r
);

89 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

91 
	`pubsubPublishMes§ge
(
chªobj
, 
ev’tobj
);

92 
	`deüRefCouÁ
(
chªobj
);

96 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYEVENT
) {

97 
chª
 = 
	`sd¢ewËn
("__keyevent@",11);

98 ià(
Ën
 =ğ-1èËÀğ
	`Î2¡ršg
(
buf
,(buf),
dbid
);

99 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

100 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

101 
chª
 = 
	`sdsÿtsds
(chª, 
ev’tobj
->
±r
);

102 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

103 
	`pubsubPublishMes§ge
(
chªobj
, 
key
);

104 
	`deüRefCouÁ
(
chªobj
);

106 
	`deüRefCouÁ
(
ev’tobj
);

107 
	}
}

	@src/vr_notify.h

1 #iâdeà
_VR_NOTIFY_H_


2 
	#_VR_NOTIFY_H_


	)

6 
	#NOTIFY_KEYSPACE
 (1<<0è

	)

7 
	#NOTIFY_KEYEVENT
 (1<<1è

	)

8 
	#NOTIFY_GENERIC
 (1<<2è

	)

9 
	#NOTIFY_STRING
 (1<<3è

	)

10 
	#NOTIFY_LIST
 (1<<4è

	)

11 
	#NOTIFY_SET
 (1<<5è

	)

12 
	#NOTIFY_HASH
 (1<<6è

	)

13 
	#NOTIFY_ZSET
 (1<<7è

	)

14 
	#NOTIFY_EXPIRED
 (1<<8è

	)

15 
	#NOTIFY_EVICTED
 (1<<9è

	)

16 
	#NOTIFY_ALL
 (
NOTIFY_GENERIC
 | 
NOTIFY_STRING
 | 
NOTIFY_LIST
 | 
NOTIFY_SET
 | 
NOTIFY_HASH
 | 
NOTIFY_ZSET
 | 
NOTIFY_EXPIRED
 | 
NOTIFY_EVICTED
è

	)

	@src/vr_notify.h

1 #iâdeà
_VR_NOTIFY_H_


2 
	#_VR_NOTIFY_H_


	)

6 
	#NOTIFY_KEYSPACE
 (1<<0è

	)

7 
	#NOTIFY_KEYEVENT
 (1<<1è

	)

8 
	#NOTIFY_GENERIC
 (1<<2è

	)

9 
	#NOTIFY_STRING
 (1<<3è

	)

10 
	#NOTIFY_LIST
 (1<<4è

	)

11 
	#NOTIFY_SET
 (1<<5è

	)

12 
	#NOTIFY_HASH
 (1<<6è

	)

13 
	#NOTIFY_ZSET
 (1<<7è

	)

14 
	#NOTIFY_EXPIRED
 (1<<8è

	)

15 
	#NOTIFY_EVICTED
 (1<<9è

	)

16 
	#NOTIFY_ALL
 (
NOTIFY_GENERIC
 | 
NOTIFY_STRING
 | 
NOTIFY_LIST
 | 
NOTIFY_SET
 | 
NOTIFY_HASH
 | 
NOTIFY_ZSET
 | 
NOTIFY_EXPIRED
 | 
NOTIFY_EVICTED
è

	)

	@src/vr_object.c

1 
	~<m©h.h
>

2 
	~<ùy³.h
>

4 
	~<vr_cÜe.h
>

7 #ifdeà
__CYGWIN__


8 
	#¡¹Şd
(
a
,
b
è(()
	`¡¹od
(×),(b)))

	)

12 
robj
 *
	$ü—‹Objeù
(
ty³
, *
±r
) {

14 
robj
 *
o
 = 
	`d®loc
((*o));

16 
o
->
ty³
 =ype;

18 
o
->
’codšg
 = 
OBJ_ENCODING_RAW
;

20 
o
->
±r
 =…tr;

22 
o
->
cÚ¡ªt
 = 0;

24 
o
->
»fcouÁ
 = -1;

26 
o
->
Ìu
 = 0;

27  
o
;

28 
	}
}

34 
robj
 *
	$ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

35  
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
±r
,
Ën
));

36 
	}
}

42 
robj
 *
	$ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

44 
robj
 *
o
 = 
	`d®loc
(Ôobj)+(
sdshdr8
)+
Ën
+1);

45 
sdshdr8
 *
sh
 = (*)(
o
+1);

47 
o
->
ty³
 = 
OBJ_STRING
;

48 
o
->
’codšg
 = 
OBJ_ENCODING_EMBSTR
;

49 
o
->
±r
 = 
sh
+1;

50 
o
->
cÚ¡ªt
 = 0;

51 
o
->
»fcouÁ
 = -1;

52 
o
->
Ìu
 = 0;

54 
sh
->
Ën
 =†en;

55 
sh
->
®loc
 = 
Ën
;

56 
sh
->
æags
 = 
SDS_TYPE_8
;

57 ià(
±r
) {

58 
	`memıy
(
sh
->
buf
,
±r
,
Ën
);

59 
sh
->
buf
[
Ën
] = '\0';

61 
	`mem£t
(
sh
->
buf
,0,
Ën
+1);

63  
o
;

64 
	}
}

72 
	#OBJ_ENCODING_EMBSTR_SIZE_LIMIT
 44

	)

74 
robj
 *
	$ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

75 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
)

76  
	`ü—‹EmbeddedSŒšgObjeù
(
±r
,
Ën
);

78  
	`ü—‹RawSŒšgObjeù
(
±r
,
Ën
);

79 
	}
}

81 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
) {

82 
robj
 *
o
;

83 ià(
v®ue
 >ğ0 && v®u< 
OBJ_SHARED_INTEGERS
) {

84 
o
 = 
sh¬ed
.
š‹g”s
[
v®ue
];

86 ià(
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
) {

87 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

88 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

89 
o
->
±r
 = (*)(()
v®ue
);

91 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
v®ue
));

94  
o
;

95 
	}
}

104 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
) {

105 
buf
[256];

106 
Ën
;

108 ià(
	`isšf
(
v®ue
)) {

111 ià(
v®ue
 > 0) {

112 
	`memıy
(
buf
,"inf",3);

113 
Ën
 = 3;

115 
	`memıy
(
buf
,"-inf",4);

116 
Ën
 = 4;

118 } ià(
humªä›ndly
) {

124 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%.17Lf", 
v®ue
);

126 ià(
	`¡rchr
(
buf
,'.'è!ğ
NULL
) {

127 *
p
 = 
buf
+
Ën
-1;

128 *
p
 == '0') {

129 
p
--;

130 
Ën
--;

132 ià(*
p
 =ğ'.'è
Ën
--;

135 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%.17Lg", 
v®ue
);

137  
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

138 
	}
}

149 
robj
 *
	$dupSŒšgObjeù
(
robj
 *
o
) {

150 
robj
 *
d
;

152 
	`ASSERT
(
o
->
ty³
 =ğ
OBJ_STRING
);

154 
o
->
’codšg
) {

155 
OBJ_ENCODING_RAW
:

156  
	`ü—‹RawSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

157 
OBJ_ENCODING_EMBSTR
:

158  
	`ü—‹EmbeddedSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

159 
OBJ_ENCODING_INT
:

160 
d
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

161 
d
->
’codšg
 = 
OBJ_ENCODING_INT
;

162 
d
->
±r
 = 
o
->ptr;

163  
d
;

165 
	`£rv”Pªic
("Wrongƒncoding.");

168 
	}
}

170 
robj
 *
	$dupSŒšgObjeùUncÚ¡ªt
(
robj
 *
o
) {

171 ià(
o
->
cÚ¡ªt
)  o;

172  
	`dupSŒšgObjeù
(
o
);

173 
	}
}

175 
robj
 *
	$ü—‹Quickli¡Objeù
() {

176 
quickli¡
 *
l
 = 
	`quickli¡C»©e
();

177 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
l
);

178 
o
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

179  
o
;

180 
	}
}

182 
robj
 *
	$ü—‹Zli¡Objeù
() {

183 *
zl
 = 
	`zli¡New
();

184 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
zl
);

185 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

186  
o
;

187 
	}
}

189 
robj
 *
	$ü—‹S‘Objeù
() {

190 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

191 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
d
);

192 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

193  
o
;

194 
	}
}

196 
robj
 *
	$ü—‹IÁ£tObjeù
() {

197 
št£t
 *
is
 = 
	`št£tNew
();

198 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
is
);

199 
o
->
’codšg
 = 
OBJ_ENCODING_INTSET
;

200  
o
;

201 
	}
}

203 
robj
 *
	$ü—‹HashObjeù
() {

204 *
zl
 = 
	`zli¡New
();

205 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_HASH
, 
zl
);

206 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

207  
o
;

208 
	}
}

214 
robj
 *
	$ü—‹Z£tObjeù
() {

215 
z£t
 *
zs
 = 
	`d®loc
((*zs));

216 
robj
 *
o
;

218 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

219 
zs
->
z¦
 = 
	`z¦C»©e
();

220 
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zs
);

221 
o
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

222  
o
;

223 
	}
}

225 
robj
 *
	$ü—‹Z£tZli¡Objeù
() {

226 *
zl
 = 
	`zli¡New
();

227 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zl
);

228 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

229  
o
;

230 
	}
}

232 
	$ä“SŒšgObjeù
(
robj
 *
o
) {

233 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
) {

234 
	`sdsä“
(
o
->
±r
);

236 
	}
}

238 
	$ä“Li¡Objeù
(
robj
 *
o
) {

239 
o
->
’codšg
) {

240 
OBJ_ENCODING_QUICKLIST
:

241 
	`quickli¡R–—£
(
o
->
±r
);

244 
	`£rv”Pªic
("Unknown†istƒncodingype");

246 
	}
}

248 
	$ä“S‘Objeù
(
robj
 *
o
) {

249 
o
->
’codšg
) {

250 
OBJ_ENCODING_HT
:

251 
	`diùR–—£
((
diù
*è
o
->
±r
);

253 
OBJ_ENCODING_INTSET
:

254 
	`dä“
(
o
->
±r
);

257 
	`£rv”Pªic
("Unknown setƒncodingype");

259 
	}
}

261 
	$ä“Z£tObjeù
(
robj
 *
o
) {

262 
z£t
 *
zs
;

263 
o
->
’codšg
) {

264 
OBJ_ENCODING_SKIPLIST
:

265 
zs
 = 
o
->
±r
;

266 
	`diùR–—£
(
zs
->
diù
);

267 
	`z¦F»e
(
zs
->
z¦
);

268 
	`dä“
(
zs
);

270 
OBJ_ENCODING_ZIPLIST
:

271 
	`dä“
(
o
->
±r
);

274 
	`£rv”Pªic
("Unknown sorted setƒncoding");

276 
	}
}

278 
	$ä“HashObjeù
(
robj
 *
o
) {

279 
o
->
’codšg
) {

280 
OBJ_ENCODING_HT
:

281 
	`diùR–—£
((
diù
*è
o
->
±r
);

283 
OBJ_ENCODING_ZIPLIST
:

284 
	`dä“
(
o
->
±r
);

287 
	`£rv”Pªic
("Unknown hashƒncodingype");

290 
	}
}

292 
	$šüRefCouÁ
(
robj
 *
o
) {

293 
o
->
»fcouÁ
++;

294 
	}
}

296 
	$deüRefCouÁ
(
robj
 *
o
) {

297 ià(
o
->
»fcouÁ
 <ğ0è
	`£rv”Pªic
("decrRefCount‡gainst„efcount <= 0");

298 ià(
o
->
»fcouÁ
 == 1) {

299 
o
->
ty³
) {

300 
OBJ_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

301 
OBJ_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

302 
OBJ_SET
: 
	`ä“S‘Objeù
(
o
); ;

303 
OBJ_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

304 
OBJ_HASH
: 
	`ä“HashObjeù
(
o
); ;

305 : 
	`£rv”Pªic
("Unknown objectype"); ;

307 
	`dä“
(
o
);

309 
o
->
»fcouÁ
--;

311 
	}
}

316 
	$deüRefCouÁVoid
(*
o
) {

317 
	`deüRefCouÁ
(
o
);

318 
	}
}

320 
	$ä“Objeù
(
robj
 *
o
) {

321 ià(
o
->
cÚ¡ªt
) ;

323 
o
->
ty³
) {

324 
OBJ_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

325 
OBJ_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

326 
OBJ_SET
: 
	`ä“S‘Objeù
(
o
); ;

327 
OBJ_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

328 
OBJ_HASH
: 
	`ä“HashObjeù
(
o
); ;

329 : 
	`£rv”Pªic
("Unknown objectype"); ;

331 
	`dä“
(
o
);

332 
	}
}

334 
	$ä“ObjeùVoid
(*
o
) {

335 
	`ä“Objeù
(
o
);

336 
	}
}

350 
robj
 *
	$»£tRefCouÁ
(
robj
 *
obj
) {

351 
obj
->
»fcouÁ
 = 0;

352  
obj
;

353 
	}
}

355 
	$checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
) {

356 ià(
o
->
ty³
 !=ype) {

357 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

361 
	}
}

363 
	$isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
Îv®
) {

364 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

365 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

366 ià(
Îv®
è*Îv® = (è
o
->
±r
;

367  
VR_OK
;

369  
	`¡ršg2Î
(
o
->
±r
,
	`sd¦’
(o->±r),
Îv®
è? 
VR_OK
 : 
VR_ERROR
;

371 
	}
}

375 
robj
 *
	$ŒyObjeùEncodšg
(
robj
 *
o
) {

376 
v®ue
;

377 
sds
 
s
 = 
o
->
±r
;

378 
size_t
 
Ën
;

384 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

390 ià(!
	`sdsEncodedObjeù
(
o
))  o;

393 ià(
o
->
cÚ¡ªt
)  o;

398 
Ën
 = 
	`sd¦’
(
s
);

400 ià(
Ën
 <ğ21 && 
	`¡ršg2l
(
s
,Ën,&
v®ue
)) {

409 
v®ue
 >= 0 &&

410 
v®ue
 < 
OBJ_SHARED_INTEGERS
)

412 
	`ä“Objeù
(
o
);

413  
sh¬ed
.
š‹g”s
[
v®ue
];

415 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
è
	`sdsä“
(o->
±r
);

416 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

417 
o
->
±r
 = (*è
v®ue
;

418  
o
;

426 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
) {

427 
robj
 *
emb
;

429 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
)  o;

430 
emb
 = 
	`ü—‹EmbeddedSŒšgObjeù
(
s
,
	`sd¦’
(s));

431 
	`ä“Objeù
(
o
);

432  
emb
;

444 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

445 
	`sd§va
(
s
è> 
Ën
/10)

447 
o
->
±r
 = 
	`sdsRemoveF»eS·û
(o->ptr);

451  
o
;

452 
	}
}

457 
robj
 *
	$g‘DecodedObjeù
(
robj
 *
o
) {

458 
robj
 *
dec
;

460 ià(
	`sdsEncodedObjeù
(
o
)) {

461  
o
;

463 ià(
o
->
ty³
 =ğ
OBJ_STRING
 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

464 
buf
[32];

466 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

467 
dec
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

468  
dec
;

470 
	`£rv”Pªic
("Unknownƒncodingype");

472 
	}
}

482 
	#REDIS_COMPARE_BINARY
 (1<<0)

	)

483 
	#REDIS_COMPARE_COLL
 (1<<1)

	)

485 
	$com·»SŒšgObjeùsW™hFÏgs
(
robj
 *
a
,„obj *
b
, 
æags
) {

486 
	`£rv”As£¹W™hInfo
(
NULL
,
a
,a->
ty³
 =ğ
OBJ_STRING
 && 
b
->type == OBJ_STRING);

487 
buç
[128], 
bufb
[128], *
a¡r
, *
b¡r
;

488 
size_t
 
®’
, 
bËn
, 
mšËn
;

490 ià(
a
 =ğ
b
)  0;

491 ià(
	`sdsEncodedObjeù
(
a
)) {

492 
a¡r
 = 
a
->
±r
;

493 
®’
 = 
	`sd¦’
(
a¡r
);

495 
®’
 = 
	`Î2¡ršg
(
buç
,(buç),(è
a
->
±r
);

496 
a¡r
 = 
buç
;

498 ià(
	`sdsEncodedObjeù
(
b
)) {

499 
b¡r
 = 
b
->
±r
;

500 
bËn
 = 
	`sd¦’
(
b¡r
);

502 
bËn
 = 
	`Î2¡ršg
(
bufb
,(bufb),(è
b
->
±r
);

503 
b¡r
 = 
bufb
;

506 ià(
æags
 & 
REDIS_COMPARE_COLL
) {

507  
	`¡rcŞl
(
a¡r
,
b¡r
);

509 
cmp
;

511 
mšËn
 = (
®’
 < 
bËn
) ?‡len : blen;

512 
cmp
 = 
	`memcmp
(
a¡r
,
b¡r
,
mšËn
);

513 ià(
cmp
 =ğ0è 
®’
-
bËn
;

514  
cmp
;

516 
	}
}

519 
	$com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

520  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_BINARY
);

521 
	}
}

525 
	$cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

526  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_COLL
);

527 
	}
}

534 
	$equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

535 ià(
a
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

536 
b
->
’codšg
 =ğ
OBJ_ENCODING_INT
){

539  
a
->
±r
 =ğ
b
->ptr;

541  
	`com·»SŒšgObjeùs
(
a
,
b
) == 0;

543 
	}
}

545 
size_t
 
	$¡ršgObjeùL’
(
robj
 *
o
) {

546 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

547 ià(
	`sdsEncodedObjeù
(
o
)) {

548  
	`sd¦’
(
o
->
±r
);

550  
	`sdig™s10
(()
o
->
±r
);

552 
	}
}

554 
	$g‘DoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

555 
v®ue
;

556 *
•Œ
;

558 ià(
o
 =ğ
NULL
) {

559 
v®ue
 = 0;

561 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

562 ià(
	`sdsEncodedObjeù
(
o
)) {

563 
”ºo
 = 0;

564 
v®ue
 = 
	`¡¹od
(
o
->
±r
, &
•Œ
);

565 ià(
	`is¥aû
(((*)
o
->
±r
)[0]) ||

566 
•Œ
[0] != '\0' ||

567 (
”ºo
 =ğ
ERANGE
 &&

568 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

569 
”ºo
 =ğ
EINVAL
 ||

570 
	`i¢ª
(
v®ue
))

571  
VR_ERROR
;

572 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

573 
v®ue
 = ()
o
->
±r
;

575 
	`£rv”Pªic
("Unknown stringƒncoding");

578 *
rg‘
 = 
v®ue
;

579  
VR_OK
;

580 
	}
}

583 
	$g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

584 
v®ue
;

585 ià(
	`g‘DoubËFromObjeù
(
o
, &
v®ue
è!ğ
VR_OK
) {

586 ià(
msg
 !ğ
NULL
) {

587 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

589 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

591  
VR_ERROR
;

593 *
rg‘
 = 
v®ue
;

594  
VR_OK
;

595 
	}
}

597 
	$g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

598 
v®ue
;

599 *
•Œ
;

601 ià(
o
 =ğ
NULL
) {

602 
v®ue
 = 0;

604 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

605 ià(
	`sdsEncodedObjeù
(
o
)) {

606 
”ºo
 = 0;

607 
v®ue
 = 
	`¡¹Şd
(
o
->
±r
, &
•Œ
);

608 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

609 
”ºo
 =ğ
ERANGE
 || 
	`i¢ª
(
v®ue
))

610  
VR_ERROR
;

611 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

612 
v®ue
 = ()
o
->
±r
;

614 
	`£rv”Pªic
("Unknown stringƒncoding");

617 *
rg‘
 = 
v®ue
;

618  
VR_OK
;

619 
	}
}

621 
	$g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

622 
v®ue
;

623 ià(
	`g‘LÚgDoubËFromObjeù
(
o
, &
v®ue
è!ğ
VR_OK
) {

624 ià(
msg
 !ğ
NULL
) {

625 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

627 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

629  
VR_ERROR
;

631 *
rg‘
 = 
v®ue
;

632  
VR_OK
;

633 
	}
}

635 
	$g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
) {

636 
v®ue
;

637 *
•Œ
;

639 ià(
o
 =ğ
NULL
) {

640 
v®ue
 = 0;

642 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

643 ià(
	`sdsEncodedObjeù
(
o
)) {

644 
”ºo
 = 0;

645 
v®ue
 = 
	`¡¹Şl
(
o
->
±r
, &
•Œ
, 10);

646 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

647 
”ºo
 =ğ
ERANGE
)

648  
VR_ERROR
;

649 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

650 
v®ue
 = ()
o
->
±r
;

652 
	`£rv”Pªic
("Unknown stringƒncoding");

655 ià(
rg‘
è*rg‘ = 
v®ue
;

656  
VR_OK
;

657 
	}
}

659 
	$g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

660 
v®ue
;

661 ià(
	`g‘LÚgLÚgFromObjeù
(
o
, &
v®ue
è!ğ
VR_OK
) {

662 ià(
msg
 !ğ
NULL
) {

663 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

665 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡n integer or out of„ange");

667  
VR_ERROR
;

669 *
rg‘
 = 
v®ue
;

670  
VR_OK
;

671 
	}
}

673 
	$g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

674 
v®ue
;

676 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
o
, &
v®ue
, 
msg
è!ğ
VR_OK
è 
VR_ERROR
;

677 ià(
v®ue
 < 
LONG_MIN
 || v®u> 
LONG_MAX
) {

678 ià(
msg
 !ğ
NULL
) {

679 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

681 
	`addR•lyE¼Ü
(
c
,"value is out of„ange");

683  
VR_ERROR
;

685 *
rg‘
 = 
v®ue
;

686  
VR_OK
;

687 
	}
}

689 *
	$¡rEncodšg
(
’codšg
) {

690 
’codšg
) {

691 
OBJ_ENCODING_RAW
:  "raw";

692 
OBJ_ENCODING_INT
:  "int";

693 
OBJ_ENCODING_HT
:  "hashtable";

694 
OBJ_ENCODING_QUICKLIST
:  "quicklist";

695 
OBJ_ENCODING_ZIPLIST
:  "ziplist";

696 
OBJ_ENCODING_INTSET
:  "intset";

697 
OBJ_ENCODING_SKIPLIST
:  "skiplist";

698 
OBJ_ENCODING_EMBSTR
:  "embstr";

701 
	}
}

705 
	$e¡im©eObjeùIdËTime
(
robj
 *
o
) {

706 
Ìuşock
 = 
	`LRU_CLOCK
();

707 ià(
Ìuşock
 >ğ
o
->
Ìu
) {

708  (
Ìuşock
 - 
o
->
Ìu
è* 
LRU_CLOCK_RESOLUTION
;

710  (
Ìuşock
 + (
LRU_CLOCK_MAX
 - 
o
->
Ìu
)) *

711 
LRU_CLOCK_RESOLUTION
;

713 
	}
}

717 
size_t
 
	$g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
) {

718 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

719 
o
->
’codšg
) {

720 
OBJ_ENCODING_RAW
:  
	`sdsZm®locSize
(
o
->
±r
);

721 
OBJ_ENCODING_EMBSTR
:  
	`dm®loc_size
(
o
)-(
robj
);

724 
	}
}

729 
robj
 *
	$objeùCommªdLookup
(
ş›Á
 *
c
, 
robj
 *
key
) {

730 
diùEÁry
 *
de
;

732 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,
key
->
±r
)è=ğ
NULL
)  NULL;

733  (
robj
*è
	`diùG‘V®
(
de
);

734 
	}
}

736 
robj
 *
	$objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

737 
robj
 *
o
 = 
	`objeùCommªdLookup
(
c
,
key
);

739 ià(!
o
è
	`addR•ly
(
c
, 
»¶y
);

740  
o
;

741 
	}
}

746 
	$objeùCommªd
(
ş›Á
 *
c
) {

747 
robj
 *
o
;

749 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"’codšg"è&& c->
¬gc
 == 3) {

750 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[2]);

751 
	`lockDbR—d
(
c
->
db
);

752 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

753 =ğ
NULL
) {

754 
	`uÆockDb
(
c
->
db
);

757 
	`addR•lyBulkCSŒšg
(
c
,
	`¡rEncodšg
(
o
->
’codšg
));

758 
	`uÆockDb
(
c
->
db
);

759 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"idËtime"è&& c->
¬gc
 == 3) {

760 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[2]);

761 
	`lockDbR—d
(
c
->
db
);

762 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

763 =ğ
NULL
) {

764 
	`uÆockDb
(
c
->
db
);

767 
	`addR•lyLÚgLÚg
(
c
,
	`e¡im©eObjeùIdËTime
(
o
)/1000);

768 
	`uÆockDb
(
c
->
db
);

770 
	`addR•lyE¼Ü
(
c
,"Syntaxƒrror. Try OBJECT (encoding|idletime)");

772 
	}
}

	@src/vr_object.c

1 
	~<m©h.h
>

2 
	~<ùy³.h
>

4 
	~<vr_cÜe.h
>

7 #ifdeà
__CYGWIN__


8 
	#¡¹Şd
(
a
,
b
è(()
	`¡¹od
(×),(b)))

	)

12 
robj
 *
	$ü—‹Objeù
(
ty³
, *
±r
) {

14 
robj
 *
o
 = 
	`d®loc
((*o));

16 
o
->
ty³
 =ype;

18 
o
->
’codšg
 = 
OBJ_ENCODING_RAW
;

20 
o
->
±r
 =…tr;

22 
o
->
cÚ¡ªt
 = 0;

24 
o
->
»fcouÁ
 = -1;

26 
o
->
Ìu
 = 0;

27  
o
;

28 
	}
}

34 
robj
 *
	$ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

35  
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
±r
,
Ën
));

36 
	}
}

42 
robj
 *
	$ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

44 
robj
 *
o
 = 
	`d®loc
(Ôobj)+(
sdshdr8
)+
Ën
+1);

45 
sdshdr8
 *
sh
 = (*)(
o
+1);

47 
o
->
ty³
 = 
OBJ_STRING
;

48 
o
->
’codšg
 = 
OBJ_ENCODING_EMBSTR
;

49 
o
->
±r
 = 
sh
+1;

50 
o
->
cÚ¡ªt
 = 0;

51 
o
->
»fcouÁ
 = -1;

52 
o
->
Ìu
 = 0;

54 
sh
->
Ën
 =†en;

55 
sh
->
®loc
 = 
Ën
;

56 
sh
->
æags
 = 
SDS_TYPE_8
;

57 ià(
±r
) {

58 
	`memıy
(
sh
->
buf
,
±r
,
Ën
);

59 
sh
->
buf
[
Ën
] = '\0';

61 
	`mem£t
(
sh
->
buf
,0,
Ën
+1);

63  
o
;

64 
	}
}

72 
	#OBJ_ENCODING_EMBSTR_SIZE_LIMIT
 44

	)

74 
robj
 *
	$ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

75 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
)

76  
	`ü—‹EmbeddedSŒšgObjeù
(
±r
,
Ën
);

78  
	`ü—‹RawSŒšgObjeù
(
±r
,
Ën
);

79 
	}
}

81 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
) {

82 
robj
 *
o
;

83 ià(
v®ue
 >ğ0 && v®u< 
OBJ_SHARED_INTEGERS
) {

84 
o
 = 
sh¬ed
.
š‹g”s
[
v®ue
];

86 ià(
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
) {

87 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

88 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

89 
o
->
±r
 = (*)(()
v®ue
);

91 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
v®ue
));

94  
o
;

95 
	}
}

104 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
) {

105 
buf
[256];

106 
Ën
;

108 ià(
	`isšf
(
v®ue
)) {

111 ià(
v®ue
 > 0) {

112 
	`memıy
(
buf
,"inf",3);

113 
Ën
 = 3;

115 
	`memıy
(
buf
,"-inf",4);

116 
Ën
 = 4;

118 } ià(
humªä›ndly
) {

124 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%.17Lf", 
v®ue
);

126 ià(
	`¡rchr
(
buf
,'.'è!ğ
NULL
) {

127 *
p
 = 
buf
+
Ën
-1;

128 *
p
 == '0') {

129 
p
--;

130 
Ën
--;

132 ià(*
p
 =ğ'.'è
Ën
--;

135 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%.17Lg", 
v®ue
);

137  
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

138 
	}
}

149 
robj
 *
	$dupSŒšgObjeù
(
robj
 *
o
) {

150 
robj
 *
d
;

152 
	`ASSERT
(
o
->
ty³
 =ğ
OBJ_STRING
);

154 
o
->
’codšg
) {

155 
OBJ_ENCODING_RAW
:

156  
	`ü—‹RawSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

157 
OBJ_ENCODING_EMBSTR
:

158  
	`ü—‹EmbeddedSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

159 
OBJ_ENCODING_INT
:

160 
d
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

161 
d
->
’codšg
 = 
OBJ_ENCODING_INT
;

162 
d
->
±r
 = 
o
->ptr;

163  
d
;

165 
	`£rv”Pªic
("Wrongƒncoding.");

168 
	}
}

170 
robj
 *
	$dupSŒšgObjeùUncÚ¡ªt
(
robj
 *
o
) {

171 ià(
o
->
cÚ¡ªt
)  o;

172  
	`dupSŒšgObjeù
(
o
);

173 
	}
}

175 
robj
 *
	$ü—‹Quickli¡Objeù
() {

176 
quickli¡
 *
l
 = 
	`quickli¡C»©e
();

177 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
l
);

178 
o
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

179  
o
;

180 
	}
}

182 
robj
 *
	$ü—‹Zli¡Objeù
() {

183 *
zl
 = 
	`zli¡New
();

184 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
zl
);

185 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

186  
o
;

187 
	}
}

189 
robj
 *
	$ü—‹S‘Objeù
() {

190 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

191 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
d
);

192 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

193  
o
;

194 
	}
}

196 
robj
 *
	$ü—‹IÁ£tObjeù
() {

197 
št£t
 *
is
 = 
	`št£tNew
();

198 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
is
);

199 
o
->
’codšg
 = 
OBJ_ENCODING_INTSET
;

200  
o
;

201 
	}
}

203 
robj
 *
	$ü—‹HashObjeù
() {

204 *
zl
 = 
	`zli¡New
();

205 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_HASH
, 
zl
);

206 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

207  
o
;

208 
	}
}

214 
robj
 *
	$ü—‹Z£tObjeù
() {

215 
z£t
 *
zs
 = 
	`d®loc
((*zs));

216 
robj
 *
o
;

218 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

219 
zs
->
z¦
 = 
	`z¦C»©e
();

220 
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zs
);

221 
o
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

222  
o
;

223 
	}
}

225 
robj
 *
	$ü—‹Z£tZli¡Objeù
() {

226 *
zl
 = 
	`zli¡New
();

227 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zl
);

228 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

229  
o
;

230 
	}
}

232 
	$ä“SŒšgObjeù
(
robj
 *
o
) {

233 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
) {

234 
	`sdsä“
(
o
->
±r
);

236 
	}
}

238 
	$ä“Li¡Objeù
(
robj
 *
o
) {

239 
o
->
’codšg
) {

240 
OBJ_ENCODING_QUICKLIST
:

241 
	`quickli¡R–—£
(
o
->
±r
);

244 
	`£rv”Pªic
("Unknown†istƒncodingype");

246 
	}
}

248 
	$ä“S‘Objeù
(
robj
 *
o
) {

249 
o
->
’codšg
) {

250 
OBJ_ENCODING_HT
:

251 
	`diùR–—£
((
diù
*è
o
->
±r
);

253 
OBJ_ENCODING_INTSET
:

254 
	`dä“
(
o
->
±r
);

257 
	`£rv”Pªic
("Unknown setƒncodingype");

259 
	}
}

261 
	$ä“Z£tObjeù
(
robj
 *
o
) {

262 
z£t
 *
zs
;

263 
o
->
’codšg
) {

264 
OBJ_ENCODING_SKIPLIST
:

265 
zs
 = 
o
->
±r
;

266 
	`diùR–—£
(
zs
->
diù
);

267 
	`z¦F»e
(
zs
->
z¦
);

268 
	`dä“
(
zs
);

270 
OBJ_ENCODING_ZIPLIST
:

271 
	`dä“
(
o
->
±r
);

274 
	`£rv”Pªic
("Unknown sorted setƒncoding");

276 
	}
}

278 
	$ä“HashObjeù
(
robj
 *
o
) {

279 
o
->
’codšg
) {

280 
OBJ_ENCODING_HT
:

281 
	`diùR–—£
((
diù
*è
o
->
±r
);

283 
OBJ_ENCODING_ZIPLIST
:

284 
	`dä“
(
o
->
±r
);

287 
	`£rv”Pªic
("Unknown hashƒncodingype");

290 
	}
}

292 
	$šüRefCouÁ
(
robj
 *
o
) {

293 
o
->
»fcouÁ
++;

294 
	}
}

296 
	$deüRefCouÁ
(
robj
 *
o
) {

297 ià(
o
->
»fcouÁ
 <ğ0è
	`£rv”Pªic
("decrRefCount‡gainst„efcount <= 0");

298 ià(
o
->
»fcouÁ
 == 1) {

299 
o
->
ty³
) {

300 
OBJ_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

301 
OBJ_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

302 
OBJ_SET
: 
	`ä“S‘Objeù
(
o
); ;

303 
OBJ_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

304 
OBJ_HASH
: 
	`ä“HashObjeù
(
o
); ;

305 : 
	`£rv”Pªic
("Unknown objectype"); ;

307 
	`dä“
(
o
);

309 
o
->
»fcouÁ
--;

311 
	}
}

316 
	$deüRefCouÁVoid
(*
o
) {

317 
	`deüRefCouÁ
(
o
);

318 
	}
}

320 
	$ä“Objeù
(
robj
 *
o
) {

321 ià(
o
->
cÚ¡ªt
) ;

323 
o
->
ty³
) {

324 
OBJ_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

325 
OBJ_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

326 
OBJ_SET
: 
	`ä“S‘Objeù
(
o
); ;

327 
OBJ_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

328 
OBJ_HASH
: 
	`ä“HashObjeù
(
o
); ;

329 : 
	`£rv”Pªic
("Unknown objectype"); ;

331 
	`dä“
(
o
);

332 
	}
}

334 
	$ä“ObjeùVoid
(*
o
) {

335 
	`ä“Objeù
(
o
);

336 
	}
}

350 
robj
 *
	$»£tRefCouÁ
(
robj
 *
obj
) {

351 
obj
->
»fcouÁ
 = 0;

352  
obj
;

353 
	}
}

355 
	$checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
) {

356 ià(
o
->
ty³
 !=ype) {

357 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

361 
	}
}

363 
	$isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
Îv®
) {

364 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

365 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

366 ià(
Îv®
è*Îv® = (è
o
->
±r
;

367  
VR_OK
;

369  
	`¡ršg2Î
(
o
->
±r
,
	`sd¦’
(o->±r),
Îv®
è? 
VR_OK
 : 
VR_ERROR
;

371 
	}
}

375 
robj
 *
	$ŒyObjeùEncodšg
(
robj
 *
o
) {

376 
v®ue
;

377 
sds
 
s
 = 
o
->
±r
;

378 
size_t
 
Ën
;

384 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

390 ià(!
	`sdsEncodedObjeù
(
o
))  o;

393 ià(
o
->
cÚ¡ªt
)  o;

398 
Ën
 = 
	`sd¦’
(
s
);

400 ià(
Ën
 <ğ21 && 
	`¡ršg2l
(
s
,Ën,&
v®ue
)) {

409 
v®ue
 >= 0 &&

410 
v®ue
 < 
OBJ_SHARED_INTEGERS
)

412 
	`ä“Objeù
(
o
);

413  
sh¬ed
.
š‹g”s
[
v®ue
];

415 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
è
	`sdsä“
(o->
±r
);

416 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

417 
o
->
±r
 = (*è
v®ue
;

418  
o
;

426 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
) {

427 
robj
 *
emb
;

429 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
)  o;

430 
emb
 = 
	`ü—‹EmbeddedSŒšgObjeù
(
s
,
	`sd¦’
(s));

431 
	`ä“Objeù
(
o
);

432  
emb
;

444 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

445 
	`sd§va
(
s
è> 
Ën
/10)

447 
o
->
±r
 = 
	`sdsRemoveF»eS·û
(o->ptr);

451  
o
;

452 
	}
}

457 
robj
 *
	$g‘DecodedObjeù
(
robj
 *
o
) {

458 
robj
 *
dec
;

460 ià(
	`sdsEncodedObjeù
(
o
)) {

461  
o
;

463 ià(
o
->
ty³
 =ğ
OBJ_STRING
 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

464 
buf
[32];

466 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

467 
dec
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

468  
dec
;

470 
	`£rv”Pªic
("Unknownƒncodingype");

472 
	}
}

482 
	#REDIS_COMPARE_BINARY
 (1<<0)

	)

483 
	#REDIS_COMPARE_COLL
 (1<<1)

	)

485 
	$com·»SŒšgObjeùsW™hFÏgs
(
robj
 *
a
,„obj *
b
, 
æags
) {

486 
	`£rv”As£¹W™hInfo
(
NULL
,
a
,a->
ty³
 =ğ
OBJ_STRING
 && 
b
->type == OBJ_STRING);

487 
buç
[128], 
bufb
[128], *
a¡r
, *
b¡r
;

488 
size_t
 
®’
, 
bËn
, 
mšËn
;

490 ià(
a
 =ğ
b
)  0;

491 ià(
	`sdsEncodedObjeù
(
a
)) {

492 
a¡r
 = 
a
->
±r
;

493 
®’
 = 
	`sd¦’
(
a¡r
);

495 
®’
 = 
	`Î2¡ršg
(
buç
,(buç),(è
a
->
±r
);

496 
a¡r
 = 
buç
;

498 ià(
	`sdsEncodedObjeù
(
b
)) {

499 
b¡r
 = 
b
->
±r
;

500 
bËn
 = 
	`sd¦’
(
b¡r
);

502 
bËn
 = 
	`Î2¡ršg
(
bufb
,(bufb),(è
b
->
±r
);

503 
b¡r
 = 
bufb
;

506 ià(
æags
 & 
REDIS_COMPARE_COLL
) {

507  
	`¡rcŞl
(
a¡r
,
b¡r
);

509 
cmp
;

511 
mšËn
 = (
®’
 < 
bËn
) ?‡len : blen;

512 
cmp
 = 
	`memcmp
(
a¡r
,
b¡r
,
mšËn
);

513 ià(
cmp
 =ğ0è 
®’
-
bËn
;

514  
cmp
;

516 
	}
}

519 
	$com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

520  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_BINARY
);

521 
	}
}

525 
	$cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

526  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_COLL
);

527 
	}
}

534 
	$equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

535 ià(
a
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

536 
b
->
’codšg
 =ğ
OBJ_ENCODING_INT
){

539  
a
->
±r
 =ğ
b
->ptr;

541  
	`com·»SŒšgObjeùs
(
a
,
b
) == 0;

543 
	}
}

545 
size_t
 
	$¡ršgObjeùL’
(
robj
 *
o
) {

546 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

547 ià(
	`sdsEncodedObjeù
(
o
)) {

548  
	`sd¦’
(
o
->
±r
);

550  
	`sdig™s10
(()
o
->
±r
);

552 
	}
}

554 
	$g‘DoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

555 
v®ue
;

556 *
•Œ
;

558 ià(
o
 =ğ
NULL
) {

559 
v®ue
 = 0;

561 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

562 ià(
	`sdsEncodedObjeù
(
o
)) {

563 
”ºo
 = 0;

564 
v®ue
 = 
	`¡¹od
(
o
->
±r
, &
•Œ
);

565 ià(
	`is¥aû
(((*)
o
->
±r
)[0]) ||

566 
•Œ
[0] != '\0' ||

567 (
”ºo
 =ğ
ERANGE
 &&

568 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

569 
”ºo
 =ğ
EINVAL
 ||

570 
	`i¢ª
(
v®ue
))

571  
VR_ERROR
;

572 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

573 
v®ue
 = ()
o
->
±r
;

575 
	`£rv”Pªic
("Unknown stringƒncoding");

578 *
rg‘
 = 
v®ue
;

579  
VR_OK
;

580 
	}
}

583 
	$g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

584 
v®ue
;

585 ià(
	`g‘DoubËFromObjeù
(
o
, &
v®ue
è!ğ
VR_OK
) {

586 ià(
msg
 !ğ
NULL
) {

587 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

589 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

591  
VR_ERROR
;

593 *
rg‘
 = 
v®ue
;

594  
VR_OK
;

595 
	}
}

597 
	$g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

598 
v®ue
;

599 *
•Œ
;

601 ià(
o
 =ğ
NULL
) {

602 
v®ue
 = 0;

604 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

605 ià(
	`sdsEncodedObjeù
(
o
)) {

606 
”ºo
 = 0;

607 
v®ue
 = 
	`¡¹Şd
(
o
->
±r
, &
•Œ
);

608 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

609 
”ºo
 =ğ
ERANGE
 || 
	`i¢ª
(
v®ue
))

610  
VR_ERROR
;

611 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

612 
v®ue
 = ()
o
->
±r
;

614 
	`£rv”Pªic
("Unknown stringƒncoding");

617 *
rg‘
 = 
v®ue
;

618  
VR_OK
;

619 
	}
}

621 
	$g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

622 
v®ue
;

623 ià(
	`g‘LÚgDoubËFromObjeù
(
o
, &
v®ue
è!ğ
VR_OK
) {

624 ià(
msg
 !ğ
NULL
) {

625 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

627 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

629  
VR_ERROR
;

631 *
rg‘
 = 
v®ue
;

632  
VR_OK
;

633 
	}
}

635 
	$g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
) {

636 
v®ue
;

637 *
•Œ
;

639 ià(
o
 =ğ
NULL
) {

640 
v®ue
 = 0;

642 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

643 ià(
	`sdsEncodedObjeù
(
o
)) {

644 
”ºo
 = 0;

645 
v®ue
 = 
	`¡¹Şl
(
o
->
±r
, &
•Œ
, 10);

646 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

647 
”ºo
 =ğ
ERANGE
)

648  
VR_ERROR
;

649 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

650 
v®ue
 = ()
o
->
±r
;

652 
	`£rv”Pªic
("Unknown stringƒncoding");

655 ià(
rg‘
è*rg‘ = 
v®ue
;

656  
VR_OK
;

657 
	}
}

659 
	$g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

660 
v®ue
;

661 ià(
	`g‘LÚgLÚgFromObjeù
(
o
, &
v®ue
è!ğ
VR_OK
) {

662 ià(
msg
 !ğ
NULL
) {

663 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

665 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡n integer or out of„ange");

667  
VR_ERROR
;

669 *
rg‘
 = 
v®ue
;

670  
VR_OK
;

671 
	}
}

673 
	$g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

674 
v®ue
;

676 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
o
, &
v®ue
, 
msg
è!ğ
VR_OK
è 
VR_ERROR
;

677 ià(
v®ue
 < 
LONG_MIN
 || v®u> 
LONG_MAX
) {

678 ià(
msg
 !ğ
NULL
) {

679 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

681 
	`addR•lyE¼Ü
(
c
,"value is out of„ange");

683  
VR_ERROR
;

685 *
rg‘
 = 
v®ue
;

686  
VR_OK
;

687 
	}
}

689 *
	$¡rEncodšg
(
’codšg
) {

690 
’codšg
) {

691 
OBJ_ENCODING_RAW
:  "raw";

692 
OBJ_ENCODING_INT
:  "int";

693 
OBJ_ENCODING_HT
:  "hashtable";

694 
OBJ_ENCODING_QUICKLIST
:  "quicklist";

695 
OBJ_ENCODING_ZIPLIST
:  "ziplist";

696 
OBJ_ENCODING_INTSET
:  "intset";

697 
OBJ_ENCODING_SKIPLIST
:  "skiplist";

698 
OBJ_ENCODING_EMBSTR
:  "embstr";

701 
	}
}

705 
	$e¡im©eObjeùIdËTime
(
robj
 *
o
) {

706 
Ìuşock
 = 
	`LRU_CLOCK
();

707 ià(
Ìuşock
 >ğ
o
->
Ìu
) {

708  (
Ìuşock
 - 
o
->
Ìu
è* 
LRU_CLOCK_RESOLUTION
;

710  (
Ìuşock
 + (
LRU_CLOCK_MAX
 - 
o
->
Ìu
)) *

711 
LRU_CLOCK_RESOLUTION
;

713 
	}
}

717 
size_t
 
	$g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
) {

718 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

719 
o
->
’codšg
) {

720 
OBJ_ENCODING_RAW
:  
	`sdsZm®locSize
(
o
->
±r
);

721 
OBJ_ENCODING_EMBSTR
:  
	`dm®loc_size
(
o
)-(
robj
);

724 
	}
}

729 
robj
 *
	$objeùCommªdLookup
(
ş›Á
 *
c
, 
robj
 *
key
) {

730 
diùEÁry
 *
de
;

732 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,
key
->
±r
)è=ğ
NULL
)  NULL;

733  (
robj
*è
	`diùG‘V®
(
de
);

734 
	}
}

736 
robj
 *
	$objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

737 
robj
 *
o
 = 
	`objeùCommªdLookup
(
c
,
key
);

739 ià(!
o
è
	`addR•ly
(
c
, 
»¶y
);

740  
o
;

741 
	}
}

746 
	$objeùCommªd
(
ş›Á
 *
c
) {

747 
robj
 *
o
;

749 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"’codšg"è&& c->
¬gc
 == 3) {

750 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[2]);

751 
	`lockDbR—d
(
c
->
db
);

752 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

753 =ğ
NULL
) {

754 
	`uÆockDb
(
c
->
db
);

757 
	`addR•lyBulkCSŒšg
(
c
,
	`¡rEncodšg
(
o
->
’codšg
));

758 
	`uÆockDb
(
c
->
db
);

759 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"idËtime"è&& c->
¬gc
 == 3) {

760 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[2]);

761 
	`lockDbR—d
(
c
->
db
);

762 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

763 =ğ
NULL
) {

764 
	`uÆockDb
(
c
->
db
);

767 
	`addR•lyLÚgLÚg
(
c
,
	`e¡im©eObjeùIdËTime
(
o
)/1000);

768 
	`uÆockDb
(
c
->
db
);

770 
	`addR•lyE¼Ü
(
c
,"Syntaxƒrror. Try OBJECT (encoding|idletime)");

772 
	}
}

	@src/vr_object.h

1 #iâdeà
_VR_OBJECT_H_


2 
	#_VR_OBJECT_H_


	)

4 
	#OBJ_SHARED_INTEGERS
 10000

	)

5 
	#OBJ_SHARED_BULKHDR_LEN
 32

	)

9 
	#OBJ_STRING
 0

	)

10 
	#OBJ_LIST
 1

	)

11 
	#OBJ_SET
 2

	)

12 
	#OBJ_ZSET
 3

	)

13 
	#OBJ_HASH
 4

	)

20 
	#OBJ_ENCODING_RAW
 0

	)

22 
	#OBJ_ENCODING_INT
 1

	)

24 
	#OBJ_ENCODING_HT
 2

	)

26 
	#OBJ_ENCODING_ZIPMAP
 3

	)

28 
	#OBJ_ENCODING_LINKEDLIST
 4

	)

30 
	#OBJ_ENCODING_ZIPLIST
 5

	)

32 
	#OBJ_ENCODING_INTSET
 6

	)

34 
	#OBJ_ENCODING_SKIPLIST
 7

	)

36 
	#OBJ_ENCODING_EMBSTR
 8

	)

38 
	#OBJ_ENCODING_QUICKLIST
 9

	)

41 
	#OBJ_HASH_KEY
 1

	)

43 
	#OBJ_HASH_VALUE
 2

	)

46 
	#sdsEncodedObjeù
(
obj±r
è(obj±r->
’codšg
 =ğ
OBJ_ENCODING_RAW
 || obj±r->’codšg =ğ
OBJ_ENCODING_EMBSTR
)

	)

50 
	#LRU_BITS
 24

	)

51 
	#LRU_CLOCK_MAX
 ((1<<
LRU_BITS
)-1è

	)

52 
	#LRU_CLOCK_RESOLUTION
 1000

	)

55 
	svr_objeù
 {

57 
	mty³
:4;

59 
	m’codšg
:4;

61 
	mÌu
:
LRU_BITS
;

63 
	mcÚ¡ªt
:1;

65 
	m»fcouÁ
;

67 *
	m±r
;

68 } 
	trobj
;

73 
deüRefCouÁ
(
robj
 *
o
);

74 
deüRefCouÁVoid
(*
o
);

75 
šüRefCouÁ
(
robj
 *
o
);

76 
robj
 *
»£tRefCouÁ
Ôobj *
obj
);

77 
ä“Objeù
(
robj
 *
o
);

78 
ä“ObjeùVoid
(*
o
);

79 
ä“SŒšgObjeù
(
robj
 *
o
);

80 
ä“Li¡Objeù
(
robj
 *
o
);

81 
ä“S‘Objeù
(
robj
 *
o
);

82 
ä“Z£tObjeù
(
robj
 *
o
);

83 
ä“HashObjeù
(
robj
 *
o
);

84 
robj
 *
ü—‹Objeù
(
ty³
, *
±r
);

85 
robj
 *
ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

86 
robj
 *
ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

87 
robj
 *
ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

88 
robj
 *
dupSŒšgObjeù
Ôobj *
o
);

89 
robj
 *
dupSŒšgObjeùUncÚ¡ªt
Ôobj *
o
);

90 
isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
ÎÚgv®
);

91 
robj
 *
ŒyObjeùEncodšg
Ôobj *
o
);

92 
robj
 *
g‘DecodedObjeù
Ôobj *
o
);

93 
size_t
 
¡ršgObjeùL’
(
robj
 *
o
);

94 
robj
 *
ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

95 
robj
 *
ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
);

96 
robj
 *
ü—‹Quickli¡Objeù
();

97 
robj
 *
ü—‹Zli¡Objeù
();

98 
robj
 *
ü—‹S‘Objeù
();

99 
robj
 *
ü—‹IÁ£tObjeù
();

100 
robj
 *
ü—‹HashObjeù
();

101 
robj
 *
ü—‹Z£tObjeù
();

102 
robj
 *
ü—‹Z£tZli¡Objeù
();

103 
g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

104 
checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
);

105 
g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

106 
g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

107 
g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
);

108 
g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
);

109 
g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

110 *
¡rEncodšg
(
’codšg
);

111 
com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

112 
cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

113 
equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

114 
e¡im©eObjeùIdËTime
(
robj
 *
o
);

116 
size_t
 
g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
);

118 
robj
 *
objeùCommªdLookup
(
ş›Á
 *
c
,„obj *
key
);

119 
robj
 *
objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

120 
objeùCommªd
(
ş›Á
 *
c
);

	@src/vr_object.h

1 #iâdeà
_VR_OBJECT_H_


2 
	#_VR_OBJECT_H_


	)

4 
	#OBJ_SHARED_INTEGERS
 10000

	)

5 
	#OBJ_SHARED_BULKHDR_LEN
 32

	)

9 
	#OBJ_STRING
 0

	)

10 
	#OBJ_LIST
 1

	)

11 
	#OBJ_SET
 2

	)

12 
	#OBJ_ZSET
 3

	)

13 
	#OBJ_HASH
 4

	)

20 
	#OBJ_ENCODING_RAW
 0

	)

22 
	#OBJ_ENCODING_INT
 1

	)

24 
	#OBJ_ENCODING_HT
 2

	)

26 
	#OBJ_ENCODING_ZIPMAP
 3

	)

28 
	#OBJ_ENCODING_LINKEDLIST
 4

	)

30 
	#OBJ_ENCODING_ZIPLIST
 5

	)

32 
	#OBJ_ENCODING_INTSET
 6

	)

34 
	#OBJ_ENCODING_SKIPLIST
 7

	)

36 
	#OBJ_ENCODING_EMBSTR
 8

	)

38 
	#OBJ_ENCODING_QUICKLIST
 9

	)

41 
	#OBJ_HASH_KEY
 1

	)

43 
	#OBJ_HASH_VALUE
 2

	)

46 
	#sdsEncodedObjeù
(
obj±r
è(obj±r->
’codšg
 =ğ
OBJ_ENCODING_RAW
 || obj±r->’codšg =ğ
OBJ_ENCODING_EMBSTR
)

	)

50 
	#LRU_BITS
 24

	)

51 
	#LRU_CLOCK_MAX
 ((1<<
LRU_BITS
)-1è

	)

52 
	#LRU_CLOCK_RESOLUTION
 1000

	)

55 
	svr_objeù
 {

57 
	mty³
:4;

59 
	m’codšg
:4;

61 
	mÌu
:
LRU_BITS
;

63 
	mcÚ¡ªt
:1;

65 
	m»fcouÁ
;

67 *
	m±r
;

68 } 
	trobj
;

73 
deüRefCouÁ
(
robj
 *
o
);

74 
deüRefCouÁVoid
(*
o
);

75 
šüRefCouÁ
(
robj
 *
o
);

76 
robj
 *
»£tRefCouÁ
Ôobj *
obj
);

77 
ä“Objeù
(
robj
 *
o
);

78 
ä“ObjeùVoid
(*
o
);

79 
ä“SŒšgObjeù
(
robj
 *
o
);

80 
ä“Li¡Objeù
(
robj
 *
o
);

81 
ä“S‘Objeù
(
robj
 *
o
);

82 
ä“Z£tObjeù
(
robj
 *
o
);

83 
ä“HashObjeù
(
robj
 *
o
);

84 
robj
 *
ü—‹Objeù
(
ty³
, *
±r
);

85 
robj
 *
ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

86 
robj
 *
ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

87 
robj
 *
ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

88 
robj
 *
dupSŒšgObjeù
Ôobj *
o
);

89 
robj
 *
dupSŒšgObjeùUncÚ¡ªt
Ôobj *
o
);

90 
isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
ÎÚgv®
);

91 
robj
 *
ŒyObjeùEncodšg
Ôobj *
o
);

92 
robj
 *
g‘DecodedObjeù
Ôobj *
o
);

93 
size_t
 
¡ršgObjeùL’
(
robj
 *
o
);

94 
robj
 *
ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

95 
robj
 *
ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
);

96 
robj
 *
ü—‹Quickli¡Objeù
();

97 
robj
 *
ü—‹Zli¡Objeù
();

98 
robj
 *
ü—‹S‘Objeù
();

99 
robj
 *
ü—‹IÁ£tObjeù
();

100 
robj
 *
ü—‹HashObjeù
();

101 
robj
 *
ü—‹Z£tObjeù
();

102 
robj
 *
ü—‹Z£tZli¡Objeù
();

103 
g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

104 
checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
);

105 
g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

106 
g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

107 
g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
);

108 
g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
);

109 
g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

110 *
¡rEncodšg
(
’codšg
);

111 
com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

112 
cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

113 
equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

114 
e¡im©eObjeùIdËTime
(
robj
 *
o
);

116 
size_t
 
g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
);

118 
robj
 *
objeùCommªdLookup
(
ş›Á
 *
c
,„obj *
key
);

119 
robj
 *
objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

120 
objeùCommªd
(
ş›Á
 *
c
);

	@src/vr_pubsub.c

1 
	~<vr_cÜe.h
>

5 
	$pubsubUnsubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
) {

6 
diùEÁry
 *
de
;

7 
dli¡
 *
ş›Ás
;

8 
dli¡Node
 *
Ê
;

9 
»tv®
 = 0;

12 
	`šüRefCouÁ
(
chªÃl
);

14 ià(
	`diùD–‘e
(
c
->
pubsub_chªÃls
,
chªÃl
è=ğ
DICT_OK
) {

15 
»tv®
 = 1;

17 
de
 = 
	`diùFšd
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
);

18 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
de
 != NULL);

19 
ş›Ás
 = 
	`diùG‘V®
(
de
);

20 
Ê
 = 
	`dli¡S—rchKey
(
ş›Ás
,
c
);

21 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
Ê
 != NULL);

22 
	`dli¡D–Node
(
ş›Ás
,
Ê
);

23 ià(
	`dli¡L’gth
(
ş›Ás
) == 0) {

27 
	`diùD–‘e
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
);

31 ià(
nÙify
) {

32 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

33 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

34 
	`addR•lyBulk
(
c
,
chªÃl
);

35 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

36 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

39 
	`deüRefCouÁ
(
chªÃl
);

40  
»tv®
;

41 
	}
}

45 
	$pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
) {

46 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
pubsub_chªÃls
);

47 
diùEÁry
 *
de
;

48 
couÁ
 = 0;

50 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

51 
robj
 *
chªÃl
 = 
	`diùG‘Key
(
de
);

53 
couÁ
 +ğ
	`pubsubUnsubsüibeChªÃl
(
c
,
chªÃl
,
nÙify
);

56 ià(
nÙify
 && 
couÁ
 == 0) {

57 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

58 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

59 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

60 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

61 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

63 
	`diùR–—£I‹¿tÜ
(
di
);

64  
couÁ
;

65 
	}
}

69 
	$pubsubUnsubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
) {

70 
dli¡Node
 *
Ê
;

71 
pubsubP©‹º
 
·t
;

72 
»tv®
 = 0;

74 
	`šüRefCouÁ
(
·‰”n
);

75 ià((
Ê
 = 
	`dli¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
)è!ğ
NULL
) {

76 
»tv®
 = 1;

77 
	`dli¡D–Node
(
c
->
pubsub_·‰”ns
,
Ê
);

78 
·t
.
ş›Á
 = 
c
;

79 
·t
.
·‰”n
 =…attern;

80 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
pubsub_·‰”ns
,&
·t
);

81 
	`dli¡D–Node
(
c
->
v–
->
pubsub_·‰”ns
,
Ê
);

84 ià(
nÙify
) {

85 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

86 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

87 
	`addR•lyBulk
(
c
,
·‰”n
);

88 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

89 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

91 
	`deüRefCouÁ
(
·‰”n
);

92  
»tv®
;

93 
	}
}

97 
	$pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
) {

98 
dli¡Node
 *
Ê
;

99 
dli¡I‹r
 
li
;

100 
couÁ
 = 0;

102 
	`dli¡Rewšd
(
c
->
pubsub_·‰”ns
,&
li
);

103 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

104 
robj
 *
·‰”n
 = 
Ê
->
v®ue
;

106 
couÁ
 +ğ
	`pubsubUnsubsüibeP©‹º
(
c
,
·‰”n
,
nÙify
);

108 ià(
nÙify
 && 
couÁ
 == 0) {

110 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

111 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

112 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

113 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

114 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

116  
couÁ
;

117 
	}
}

126 
	$pubsubSubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
) {

127 
diùEÁry
 *
de
;

128 
dli¡
 *
ş›Ás
 = 
NULL
;

129 
»tv®
 = 0;

132 ià(
	`diùAdd
(
c
->
pubsub_chªÃls
,
chªÃl
,
NULL
è=ğ
DICT_OK
) {

133 
»tv®
 = 1;

134 
	`šüRefCouÁ
(
chªÃl
);

136 
de
 = 
	`diùFšd
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
);

137 ià(
de
 =ğ
NULL
) {

138 
ş›Ás
 = 
	`dli¡C»©e
();

139 
	`diùAdd
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
,
ş›Ás
);

140 
	`šüRefCouÁ
(
chªÃl
);

142 
ş›Ás
 = 
	`diùG‘V®
(
de
);

144 
	`dli¡AddNodeTa
(
ş›Ás
,
c
);

147 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

148 
	`addR•ly
(
c
,
sh¬ed
.
subsüibebulk
);

149 
	`addR•lyBulk
(
c
,
chªÃl
);

150 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

151  
»tv®
;

152 
	}
}

154 
	$subsüibeCommªd
(
ş›Á
 *
c
) {

155 
j
;

157 
j
 = 1; j < 
c
->
¬gc
; j++)

158 
	`pubsubSubsüibeChªÃl
(
c
,c->
¬gv
[
j
]);

159 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

160 
	}
}

163 
	$ş›ÁSubsütiÚsCouÁ
(
ş›Á
 *
c
) {

164  
	`diùSize
(
c
->
pubsub_chªÃls
)+

165 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
);

166 
	}
}

168 
	$unsubsüibeCommªd
(
ş›Á
 *
c
) {

169 ià(
c
->
¬gc
 == 1) {

170 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,1);

172 
j
;

174 
j
 = 1; j < 
c
->
¬gc
; j++)

175 
	`pubsubUnsubsüibeChªÃl
(
c
,c->
¬gv
[
j
],1);

177 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

178 
	}
}

181 
	$pubsubSubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
) {

182 
»tv®
 = 0;

184 ià(
	`dli¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
è=ğ
NULL
) {

185 
»tv®
 = 1;

186 
pubsubP©‹º
 *
·t
;

187 
	`dli¡AddNodeTa
(
c
->
pubsub_·‰”ns
,
·‰”n
);

188 
	`šüRefCouÁ
(
·‰”n
);

189 
·t
 = 
	`d®loc
((*pat));

190 
·t
->
·‰”n
 = 
	`g‘DecodedObjeù
(pattern);

191 
·t
->
ş›Á
 = 
c
;

192 
	`dli¡AddNodeTa
(
c
->
v–
->
pubsub_·‰”ns
,
·t
);

195 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

196 
	`addR•ly
(
c
,
sh¬ed
.
psubsüibebulk
);

197 
	`addR•lyBulk
(
c
,
·‰”n
);

198 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

199  
»tv®
;

200 
	}
}

202 
	$psubsüibeCommªd
(
ş›Á
 *
c
) {

203 
j
;

205 
j
 = 1; j < 
c
->
¬gc
; j++)

206 
	`pubsubSubsüibeP©‹º
(
c
,c->
¬gv
[
j
]);

207 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

208 
	}
}

210 
	$punsubsüibeCommªd
(
ş›Á
 *
c
) {

211 ià(
c
->
¬gc
 == 1) {

212 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,1);

214 
j
;

216 
j
 = 1; j < 
c
->
¬gc
; j++)

217 
	`pubsubUnsubsüibeP©‹º
(
c
,c->
¬gv
[
j
],1);

219 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

220 
	}
}

223 
	$pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

224 
»ûiv”s
 = 0;

225 
diùEÁry
 *
de
;

226 
dli¡Node
 *
Ê
;

227 
dli¡I‹r
 
li
;

230 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

231 ià(
de
) {

232 
dli¡
 *
li¡
 = 
	`diùG‘V®
(
de
);

233 
dli¡Node
 *
Ê
;

234 
dli¡I‹r
 
li
;

236 
	`dli¡Rewšd
(
li¡
,&
li
);

237 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

238 
ş›Á
 *
c
 = 
Ê
->
v®ue
;

240 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

241 
	`addR•ly
(
c
,
sh¬ed
.
mes§gebulk
);

242 
	`addR•lyBulk
(
c
,
chªÃl
);

243 
	`addR•lyBulk
(
c
,
mes§ge
);

244 
»ûiv”s
++;

248 ià(
	`dli¡L’gth
(
£rv”
.
pubsub_·‰”ns
)) {

249 
	`dli¡Rewšd
(
£rv”
.
pubsub_·‰”ns
,&
li
);

250 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

251 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

252 
pubsubP©‹º
 *
·t
 = 
Ê
->
v®ue
;

254 ià(
	`¡ršgm©chËn
((*)
·t
->
·‰”n
->
±r
,

255 
	`sd¦’
(
·t
->
·‰”n
->
±r
),

256 (*)
chªÃl
->
±r
,

257 
	`sd¦’
(
chªÃl
->
±r
),0)) {

258 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
mbulkhdr
[4]);

259 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
pmes§gebulk
);

260 
	`addR•lyBulk
(
·t
->
ş›Á
,·t->
·‰”n
);

261 
	`addR•lyBulk
(
·t
->
ş›Á
,
chªÃl
);

262 
	`addR•lyBulk
(
·t
->
ş›Á
,
mes§ge
);

263 
»ûiv”s
++;

266 
	`deüRefCouÁ
(
chªÃl
);

268  
»ûiv”s
;

269 
	}
}

	@src/vr_pubsub.c

1 
	~<vr_cÜe.h
>

5 
	$pubsubUnsubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
) {

6 
diùEÁry
 *
de
;

7 
dli¡
 *
ş›Ás
;

8 
dli¡Node
 *
Ê
;

9 
»tv®
 = 0;

12 
	`šüRefCouÁ
(
chªÃl
);

14 ià(
	`diùD–‘e
(
c
->
pubsub_chªÃls
,
chªÃl
è=ğ
DICT_OK
) {

15 
»tv®
 = 1;

17 
de
 = 
	`diùFšd
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
);

18 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
de
 != NULL);

19 
ş›Ás
 = 
	`diùG‘V®
(
de
);

20 
Ê
 = 
	`dli¡S—rchKey
(
ş›Ás
,
c
);

21 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
Ê
 != NULL);

22 
	`dli¡D–Node
(
ş›Ás
,
Ê
);

23 ià(
	`dli¡L’gth
(
ş›Ás
) == 0) {

27 
	`diùD–‘e
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
);

31 ià(
nÙify
) {

32 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

33 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

34 
	`addR•lyBulk
(
c
,
chªÃl
);

35 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

36 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

39 
	`deüRefCouÁ
(
chªÃl
);

40  
»tv®
;

41 
	}
}

45 
	$pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
) {

46 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
pubsub_chªÃls
);

47 
diùEÁry
 *
de
;

48 
couÁ
 = 0;

50 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

51 
robj
 *
chªÃl
 = 
	`diùG‘Key
(
de
);

53 
couÁ
 +ğ
	`pubsubUnsubsüibeChªÃl
(
c
,
chªÃl
,
nÙify
);

56 ià(
nÙify
 && 
couÁ
 == 0) {

57 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

58 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

59 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

60 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

61 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

63 
	`diùR–—£I‹¿tÜ
(
di
);

64  
couÁ
;

65 
	}
}

69 
	$pubsubUnsubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
) {

70 
dli¡Node
 *
Ê
;

71 
pubsubP©‹º
 
·t
;

72 
»tv®
 = 0;

74 
	`šüRefCouÁ
(
·‰”n
);

75 ià((
Ê
 = 
	`dli¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
)è!ğ
NULL
) {

76 
»tv®
 = 1;

77 
	`dli¡D–Node
(
c
->
pubsub_·‰”ns
,
Ê
);

78 
·t
.
ş›Á
 = 
c
;

79 
·t
.
·‰”n
 =…attern;

80 
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
pubsub_·‰”ns
,&
·t
);

81 
	`dli¡D–Node
(
c
->
v–
->
pubsub_·‰”ns
,
Ê
);

84 ià(
nÙify
) {

85 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

86 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

87 
	`addR•lyBulk
(
c
,
·‰”n
);

88 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

89 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

91 
	`deüRefCouÁ
(
·‰”n
);

92  
»tv®
;

93 
	}
}

97 
	$pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
) {

98 
dli¡Node
 *
Ê
;

99 
dli¡I‹r
 
li
;

100 
couÁ
 = 0;

102 
	`dli¡Rewšd
(
c
->
pubsub_·‰”ns
,&
li
);

103 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

104 
robj
 *
·‰”n
 = 
Ê
->
v®ue
;

106 
couÁ
 +ğ
	`pubsubUnsubsüibeP©‹º
(
c
,
·‰”n
,
nÙify
);

108 ià(
nÙify
 && 
couÁ
 == 0) {

110 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

111 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

112 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

113 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

114 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
));

116  
couÁ
;

117 
	}
}

126 
	$pubsubSubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
) {

127 
diùEÁry
 *
de
;

128 
dli¡
 *
ş›Ás
 = 
NULL
;

129 
»tv®
 = 0;

132 ià(
	`diùAdd
(
c
->
pubsub_chªÃls
,
chªÃl
,
NULL
è=ğ
DICT_OK
) {

133 
»tv®
 = 1;

134 
	`šüRefCouÁ
(
chªÃl
);

136 
de
 = 
	`diùFšd
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
);

137 ià(
de
 =ğ
NULL
) {

138 
ş›Ás
 = 
	`dli¡C»©e
();

139 
	`diùAdd
(
c
->
v–
->
pubsub_chªÃls
,
chªÃl
,
ş›Ás
);

140 
	`šüRefCouÁ
(
chªÃl
);

142 
ş›Ás
 = 
	`diùG‘V®
(
de
);

144 
	`dli¡AddNodeTa
(
ş›Ás
,
c
);

147 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

148 
	`addR•ly
(
c
,
sh¬ed
.
subsüibebulk
);

149 
	`addR•lyBulk
(
c
,
chªÃl
);

150 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

151  
»tv®
;

152 
	}
}

154 
	$subsüibeCommªd
(
ş›Á
 *
c
) {

155 
j
;

157 
j
 = 1; j < 
c
->
¬gc
; j++)

158 
	`pubsubSubsüibeChªÃl
(
c
,c->
¬gv
[
j
]);

159 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

160 
	}
}

163 
	$ş›ÁSubsütiÚsCouÁ
(
ş›Á
 *
c
) {

164  
	`diùSize
(
c
->
pubsub_chªÃls
)+

165 
	`dli¡L’gth
(
c
->
pubsub_·‰”ns
);

166 
	}
}

168 
	$unsubsüibeCommªd
(
ş›Á
 *
c
) {

169 ià(
c
->
¬gc
 == 1) {

170 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,1);

172 
j
;

174 
j
 = 1; j < 
c
->
¬gc
; j++)

175 
	`pubsubUnsubsüibeChªÃl
(
c
,c->
¬gv
[
j
],1);

177 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

178 
	}
}

181 
	$pubsubSubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
) {

182 
»tv®
 = 0;

184 ià(
	`dli¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
è=ğ
NULL
) {

185 
»tv®
 = 1;

186 
pubsubP©‹º
 *
·t
;

187 
	`dli¡AddNodeTa
(
c
->
pubsub_·‰”ns
,
·‰”n
);

188 
	`šüRefCouÁ
(
·‰”n
);

189 
·t
 = 
	`d®loc
((*pat));

190 
·t
->
·‰”n
 = 
	`g‘DecodedObjeù
(pattern);

191 
·t
->
ş›Á
 = 
c
;

192 
	`dli¡AddNodeTa
(
c
->
v–
->
pubsub_·‰”ns
,
·t
);

195 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

196 
	`addR•ly
(
c
,
sh¬ed
.
psubsüibebulk
);

197 
	`addR•lyBulk
(
c
,
·‰”n
);

198 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

199  
»tv®
;

200 
	}
}

202 
	$psubsüibeCommªd
(
ş›Á
 *
c
) {

203 
j
;

205 
j
 = 1; j < 
c
->
¬gc
; j++)

206 
	`pubsubSubsüibeP©‹º
(
c
,c->
¬gv
[
j
]);

207 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

208 
	}
}

210 
	$punsubsüibeCommªd
(
ş›Á
 *
c
) {

211 ià(
c
->
¬gc
 == 1) {

212 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,1);

214 
j
;

216 
j
 = 1; j < 
c
->
¬gc
; j++)

217 
	`pubsubUnsubsüibeP©‹º
(
c
,c->
¬gv
[
j
],1);

219 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

220 
	}
}

223 
	$pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

224 
»ûiv”s
 = 0;

225 
diùEÁry
 *
de
;

226 
dli¡Node
 *
Ê
;

227 
dli¡I‹r
 
li
;

230 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

231 ià(
de
) {

232 
dli¡
 *
li¡
 = 
	`diùG‘V®
(
de
);

233 
dli¡Node
 *
Ê
;

234 
dli¡I‹r
 
li
;

236 
	`dli¡Rewšd
(
li¡
,&
li
);

237 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

238 
ş›Á
 *
c
 = 
Ê
->
v®ue
;

240 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

241 
	`addR•ly
(
c
,
sh¬ed
.
mes§gebulk
);

242 
	`addR•lyBulk
(
c
,
chªÃl
);

243 
	`addR•lyBulk
(
c
,
mes§ge
);

244 
»ûiv”s
++;

248 ià(
	`dli¡L’gth
(
£rv”
.
pubsub_·‰”ns
)) {

249 
	`dli¡Rewšd
(
£rv”
.
pubsub_·‰”ns
,&
li
);

250 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

251 (
Ê
 = 
	`dli¡Next
(&
li
)è!ğ
NULL
) {

252 
pubsubP©‹º
 *
·t
 = 
Ê
->
v®ue
;

254 ià(
	`¡ršgm©chËn
((*)
·t
->
·‰”n
->
±r
,

255 
	`sd¦’
(
·t
->
·‰”n
->
±r
),

256 (*)
chªÃl
->
±r
,

257 
	`sd¦’
(
chªÃl
->
±r
),0)) {

258 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
mbulkhdr
[4]);

259 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
pmes§gebulk
);

260 
	`addR•lyBulk
(
·t
->
ş›Á
,·t->
·‰”n
);

261 
	`addR•lyBulk
(
·t
->
ş›Á
,
chªÃl
);

262 
	`addR•lyBulk
(
·t
->
ş›Á
,
mes§ge
);

263 
»ûiv”s
++;

266 
	`deüRefCouÁ
(
chªÃl
);

268  
»ûiv”s
;

269 
	}
}

	@src/vr_pubsub.h

1 #iâdeà
_VR_PUBSUB_H_


2 
	#_VR_PUBSUB_H_


	)

4 
	spubsubP©‹º
 {

5 
ş›Á
 *
	mş›Á
;

6 
robj
 *
	m·‰”n
;

7 } 
	tpubsubP©‹º
;

9 
pubsubUnsubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
);

10 
pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
);

11 
pubsubUnsubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
);

12 
pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
);

13 
pubsubSubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
);

14 
ş›ÁSubsütiÚsCouÁ
(
ş›Á
 *
c
);

15 
subsüibeCommªd
(
ş›Á
 *
c
);

16 
unsubsüibeCommªd
(
ş›Á
 *
c
);

17 
psubsüibeCommªd
(
ş›Á
 *
c
);

18 
punsubsüibeCommªd
(
ş›Á
 *
c
);

19 
pubsubSubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
);

20 
pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
);

	@src/vr_pubsub.h

1 #iâdeà
_VR_PUBSUB_H_


2 
	#_VR_PUBSUB_H_


	)

4 
	spubsubP©‹º
 {

5 
ş›Á
 *
	mş›Á
;

6 
robj
 *
	m·‰”n
;

7 } 
	tpubsubP©‹º
;

9 
pubsubUnsubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
);

10 
pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
);

11 
pubsubUnsubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
);

12 
pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
);

13 
pubsubSubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
);

14 
ş›ÁSubsütiÚsCouÁ
(
ş›Á
 *
c
);

15 
subsüibeCommªd
(
ş›Á
 *
c
);

16 
unsubsüibeCommªd
(
ş›Á
 *
c
);

17 
psubsüibeCommªd
(
ş›Á
 *
c
);

18 
punsubsüibeCommªd
(
ş›Á
 *
c
);

19 
pubsubSubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
);

20 
pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
);

	@src/vr_quicklist.c

1 
	~<¡ršg.h
>

3 
	~<vr_cÜe.h
>

5 #ià
defšed
(
REDIS_TEST
è|| defšed(
REDIS_TEST_VERBOSE
)

6 
	~<¡dio.h
>

9 #iâdeà
REDIS_STATIC


10 
	#REDIS_STATIC
 

	)

14 cÚ¡ 
size_t
 
	gİtimiz©iÚ_Ëv–
[] = {4096, 8192, 16384, 32768, 65536};

18 
	#SIZE_SAFETY_LIMIT
 8192

	)

21 
	#MIN_COMPRESS_BYTES
 48

	)

26 
	#MIN_COMPRESS_IMPROVE
 8

	)

29 #iâdeà
REDIS_TEST_VERBOSE


30 
	#D
(...)

	)

32 
	#D
(...) \

34 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

35 
	`´štf
(
__VA_ARGS__
); \

36 
	`´štf
("\n"); \

37 } 0);

	)

41 
	#š™EÁry
(
e
) \

43 (
e
)->
zi
 = (e)->
v®ue
 = 
NULL
; \

44 (
e
)->
lÚgv®
 = -123456789; \

45 (
e
)->
quickli¡
 = 
NULL
; \

46 (
e
)->
node
 = 
NULL
; \

47 (
e
)->
off£t
 = 123456789; \

48 (
e
)->
sz
 = 0; \

49 } 0)

	)

51 #ià
__GNUC__
 >= 3

52 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

53 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

55 
	#lik–y
(
x
è(x)

	)

56 
	#uÆik–y
(
x
è(x)

	)

61 
quickli¡
 *
	$quickli¡C»©e
() {

62 
quickli¡
 *quicklist;

64 
quickli¡
 = 
	`d®loc
((*quicklist));

65 
quickli¡
->
h—d
 = quickli¡->

 = 
NULL
;

66 
quickli¡
->
Ën
 = 0;

67 
quickli¡
->
couÁ
 = 0;

68 
quickli¡
->
com´ess
 = 0;

69 
quickli¡
->
fl
 = -2;

70  
quickli¡
;

71 
	}
}

73 
	#COMPRESS_MAX
 (1 << 16)

	)

74 
	$quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
com´ess
) {

75 ià(
com´ess
 > 
COMPRESS_MAX
) {

76 
com´ess
 = 
COMPRESS_MAX
;

77 } ià(
com´ess
 < 0) {

78 
com´ess
 = 0;

80 
quickli¡
->
com´ess
 = compress;

81 
	}
}

83 
	#FILL_MAX
 (1 << 15)

	)

84 
	$quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
) {

85 ià(
fl
 > 
FILL_MAX
) {

86 
fl
 = 
FILL_MAX
;

87 } ià(
fl
 < -5) {

88 
fl
 = -5;

90 
quickli¡
->
fl
 = fill;

91 
	}
}

93 
	$quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
) {

94 
	`quickli¡S‘Fl
(
quickli¡
, 
fl
);

95 
	`quickli¡S‘Com´essD•th
(
quickli¡
, 
d•th
);

96 
	}
}

99 
quickli¡
 *
	$quickli¡New
(
fl
, 
com´ess
) {

100 
quickli¡
 *quickli¡ = 
	`quickli¡C»©e
();

101 
	`quickli¡S‘O±iÚs
(
quickli¡
, 
fl
, 
com´ess
);

102  
quickli¡
;

103 
	}
}

105 
REDIS_STATIC
 
quickli¡Node
 *
	$quickli¡C»©eNode
() {

106 
quickli¡Node
 *
node
;

107 
node
 = 
	`d®loc
((*node));

108 
node
->
zl
 = 
NULL
;

109 
node
->
couÁ
 = 0;

110 
node
->
sz
 = 0;

111 
node
->
Ãxt
 =‚ode->
´ev
 = 
NULL
;

112 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

113 
node
->
cÚš”
 = 
QUICKLIST_NODE_CONTAINER_ZIPLIST
;

114 
node
->
»com´ess
 = 0;

115  
node
;

116 
	}
}

119 
	$quickli¡CouÁ
(
quickli¡
 *
ql
è{  ql->
couÁ
; 
	}
}

122 
	$quickli¡R–—£
(
quickli¡
 *quicklist) {

123 
Ën
;

124 
quickli¡Node
 *
cu¼’t
, *
Ãxt
;

126 
cu¼’t
 = 
quickli¡
->
h—d
;

127 
Ën
 = 
quickli¡
->len;

128 
Ën
--) {

129 
Ãxt
 = 
cu¼’t
->next;

131 
	`dä“
(
cu¼’t
->
zl
);

132 
quickli¡
->
couÁ
 -ğ
cu¼’t
->count;

134 
	`dä“
(
cu¼’t
);

136 
quickli¡
->
Ën
--;

137 
cu¼’t
 = 
Ãxt
;

139 
	`dä“
(
quickli¡
);

140 
	}
}

145 
REDIS_STATIC
 
	$__quickli¡Com´essNode
(
quickli¡Node
 *
node
) {

146 #ifdeà
REDIS_TEST


147 
node
->
©‹m±ed_com´ess
 = 1;

151 ià(
node
->
sz
 < 
MIN_COMPRESS_BYTES
)

154 
quickli¡LZF
 *
lzf
 = 
	`d®loc
((*lzfè+ 
node
->
sz
);

157 ià(((
lzf
->
sz
 = 
	`lzf_com´ess
(
node
->
zl
,‚ode->sz,†zf->
com´es£d
,

158 
node
->
sz
)) == 0) ||

159 
lzf
->
sz
 + 
MIN_COMPRESS_IMPROVE
 >ğ
node
->sz) {

161 
	`dä“
(
lzf
);

164 
lzf
 = 
	`d»®loc
Özf, (*lzfè+†zf->
sz
);

165 
	`dä“
(
node
->
zl
);

166 
node
->
zl
 = (*)
lzf
;

167 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_LZF
;

168 
node
->
»com´ess
 = 0;

170 
	}
}

173 
	#quickli¡Com´essNode
(
_node
) \

175 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) { \

176 
	`__quickli¡Com´essNode
((
_node
)); \

178 } 0)

	)

182 
REDIS_STATIC
 
	$__quickli¡Decom´essNode
(
quickli¡Node
 *
node
) {

183 #ifdeà
REDIS_TEST


184 
node
->
©‹m±ed_com´ess
 = 0;

187 *
decom´es£d
 = 
	`d®loc
(
node
->
sz
);

188 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

189 ià(
	`lzf_decom´ess
(
lzf
->
com´es£d
,†zf->
sz
, 
decom´es£d
, 
node
->sz) == 0) {

191 
	`dä“
(
decom´es£d
);

194 
	`dä“
(
lzf
);

195 
node
->
zl
 = 
decom´es£d
;

196 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

198 
	}
}

201 
	#quickli¡Decom´essNode
(
_node
) \

203 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

204 
	`__quickli¡Decom´essNode
((
_node
)); \

206 } 0)

	)

209 
	#quickli¡Decom´essNodeFÜU£
(
_node
) \

211 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

212 
	`__quickli¡Decom´essNode
((
_node
)); \

213 (
_node
)->
»com´ess
 = 1; \

215 } 0)

	)

220 
size_t
 
	$quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
) {

221 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

222 *
d©a
 = 
lzf
->
com´es£d
;

223  
lzf
->
sz
;

224 
	}
}

226 
	#quickli¡AÎowsCom´essiÚ
(
_ql
è((_ql)->
com´ess
 !ğ0)

	)

232 
REDIS_STATIC
 
	$__quickli¡Com´ess
(cÚ¡ 
quickli¡
 *quicklist,

233 
quickli¡Node
 *
node
) {

236 ià(!
	`quickli¡AÎowsCom´essiÚ
(
quickli¡
) ||

237 
quickli¡
->
Ën
 < ()(quickli¡->
com´ess
 * 2))

242 ià(
quickli¡
->
com´ess
 == 1) {

243 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
t
 = quickli¡->

;

244 
	`quickli¡Decom´essNode
(
h
);

245 
	`quickli¡Decom´essNode
(
t
);

246 ià(
h
 !ğ
node
 && 
t
 !=‚ode)

247 
	`quickli¡Com´essNode
(
node
);

249 } ià(
quickli¡
->
com´ess
 == 2) {

250 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
hn
 = h->
Ãxt
, *
hÂ
 = hn->next;

251 
quickli¡Node
 *
t
 = 
quickli¡
->

, *

 =->
´ev
, *
p
 =p->prev;

252 
	`quickli¡Decom´essNode
(
h
);

253 
	`quickli¡Decom´essNode
(
hn
);

254 
	`quickli¡Decom´essNode
(
t
);

255 
	`quickli¡Decom´essNode
(

);

256 ià(
h
 !ğ
node
 && 
hn
 !ğnod&& 
t
 !ğnod&& 

 !=‚ode) {

257 
	`quickli¡Com´essNode
(
node
);

259 ià(
hÂ
 !ğ
t
) {

260 
	`quickli¡Com´essNode
(
hÂ
);

262 ià(
p
 !ğ
h
) {

263 
	`quickli¡Com´essNode
(
p
);

272 
quickli¡Node
 *
fÜw¬d
 = 
quickli¡
->
h—d
;

273 
quickli¡Node
 *
»v”£
 = 
quickli¡
->

;

274 
d•th
 = 0;

275 
š_d•th
 = 0;

276 
d•th
++ < 
quickli¡
->
com´ess
) {

277 
	`quickli¡Decom´essNode
(
fÜw¬d
);

278 
	`quickli¡Decom´essNode
(
»v”£
);

280 ià(
fÜw¬d
 =ğ
node
 || 
»v”£
 ==‚ode)

281 
š_d•th
 = 1;

283 ià(
fÜw¬d
 =ğ
»v”£
)

286 
fÜw¬d
 = fÜw¬d->
Ãxt
;

287 
»v”£
 =„ev”£->
´ev
;

290 ià(!
š_d•th
)

291 
	`quickli¡Com´essNode
(
node
);

293 ià(
d•th
 > 2) {

295 
	`quickli¡Com´essNode
(
fÜw¬d
);

296 
	`quickli¡Com´essNode
(
»v”£
);

298 
	}
}

300 
	#quickli¡Com´ess
(
_ql
, 
_node
) \

302 ià((
_node
)->
»com´ess
) \

303 
	`quickli¡Com´essNode
((
_node
)); \

305 
	`__quickli¡Com´ess
((
_ql
), (
_node
)); \

306 } 0)

	)

309 
	#quickli¡Recom´essOÆy
(
_ql
, 
_node
) \

311 ià((
_node
)->
»com´ess
) \

312 
	`quickli¡Com´essNode
((
_node
)); \

313 } 0)

	)

319 
REDIS_STATIC
 
	$__quickli¡In£¹Node
(
quickli¡
 *quicklist,

320 
quickli¡Node
 *
Şd_node
,

321 
quickli¡Node
 *
Ãw_node
, 
aá”
) {

322 ià(
aá”
) {

323 
Ãw_node
->
´ev
 = 
Şd_node
;

324 ià(
Şd_node
) {

325 
Ãw_node
->
Ãxt
 = 
Şd_node
->next;

326 ià(
Şd_node
->
Ãxt
)

327 
Şd_node
->
Ãxt
->
´ev
 = 
Ãw_node
;

328 
Şd_node
->
Ãxt
 = 
Ãw_node
;

330 ià(
quickli¡
->

 =ğ
Şd_node
)

331 
quickli¡
->

 = 
Ãw_node
;

333 
Ãw_node
->
Ãxt
 = 
Şd_node
;

334 ià(
Şd_node
) {

335 
Ãw_node
->
´ev
 = 
Şd_node
->prev;

336 ià(
Şd_node
->
´ev
)

337 
Şd_node
->
´ev
->
Ãxt
 = 
Ãw_node
;

338 
Şd_node
->
´ev
 = 
Ãw_node
;

340 ià(
quickli¡
->
h—d
 =ğ
Şd_node
)

341 
quickli¡
->
h—d
 = 
Ãw_node
;

344 ià(
quickli¡
->
Ën
 == 0) {

345 
quickli¡
->
h—d
 = quickli¡->

 = 
Ãw_node
;

348 ià(
Şd_node
)

349 
	`quickli¡Com´ess
(
quickli¡
, 
Şd_node
);

351 
quickli¡
->
Ën
++;

352 
	}
}

355 
REDIS_STATIC
 
	$_quickli¡In£¹NodeBefÜe
(
quickli¡
 *quicklist,

356 
quickli¡Node
 *
Şd_node
,

357 
quickli¡Node
 *
Ãw_node
) {

358 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 0);

359 
	}
}

361 
REDIS_STATIC
 
	$_quickli¡In£¹NodeAá”
(
quickli¡
 *quicklist,

362 
quickli¡Node
 *
Şd_node
,

363 
quickli¡Node
 *
Ãw_node
) {

364 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 1);

365 
	}
}

367 
REDIS_STATIC
 

368 
	$_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(cÚ¡ 
size_t
 
sz
,

369 cÚ¡ 
fl
) {

370 ià(
fl
 >= 0)

373 
size_t
 
off£t
 = (-
fl
) - 1;

374 ià(
off£t
 < ((
İtimiz©iÚ_Ëv–
) / (*optimization_level))) {

375 ià(
sz
 <ğ
İtimiz©iÚ_Ëv–
[
off£t
]) {

383 
	}
}

385 
	#sizeM“tsSaãtyLim™
(
sz
è((szè<ğ
SIZE_SAFETY_LIMIT
)

	)

387 
REDIS_STATIC
 
	$_quickli¡NodeAÎowIn£¹
(cÚ¡ 
quickli¡Node
 *
node
,

388 cÚ¡ 
fl
, cÚ¡ 
size_t
 
sz
) {

389 ià(
	`uÆik–y
(!
node
))

392 
zli¡_ov”h—d
;

394 ià(
sz
 < 254)

395 
zli¡_ov”h—d
 = 1;

397 
zli¡_ov”h—d
 = 5;

400 ià(
sz
 < 64)

401 
zli¡_ov”h—d
 += 1;

402 ià(
	`lik–y
(
sz
 < 16384))

403 
zli¡_ov”h—d
 += 2;

405 
zli¡_ov”h—d
 += 5;

408 
Ãw_sz
 = 
node
->
sz
 + sz + 
zli¡_ov”h—d
;

409 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
Ãw_sz
, 
fl
)))

411 ià(!
	`sizeM“tsSaãtyLim™
(
Ãw_sz
))

413 ià(()
node
->
couÁ
 < 
fl
)

417 
	}
}

419 
REDIS_STATIC
 
	$_quickli¡NodeAÎowM”ge
(cÚ¡ 
quickli¡Node
 *
a
,

420 cÚ¡ 
quickli¡Node
 *
b
,

421 cÚ¡ 
fl
) {

422 ià(!
a
 || !
b
)

427 
m”ge_sz
 = 
a
->
sz
 + 
b
->sz - 11;

428 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
m”ge_sz
, 
fl
)))

430 ià(!
	`sizeM“tsSaãtyLim™
(
m”ge_sz
))

432 ià(()(
a
->
couÁ
 + 
b
->couÁè<ğ
fl
)

436 
	}
}

438 
	#quickli¡NodeUpd©eSz
(
node
) \

440 (
node
)->
sz
 = 
	`zli¡BlobL’
(Òode)->
zl
); \

441 } 0)

	)

447 
	$quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

448 
quickli¡Node
 *
Üig_h—d
 = 
quickli¡
->
h—d
;

449 ià(
	`lik–y
(

450 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->
h—d
, quickli¡->
fl
, 
sz
))) {

451 
quickli¡
->
h—d
->
zl
 =

452 
	`zli¡Push
(
quickli¡
->
h—d
->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

453 
	`quickli¡NodeUpd©eSz
(
quickli¡
->
h—d
);

455 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

456 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

458 
	`quickli¡NodeUpd©eSz
(
node
);

459 
	`_quickli¡In£¹NodeBefÜe
(
quickli¡
, quickli¡->
h—d
, 
node
);

461 
quickli¡
->
couÁ
++;

462 
quickli¡
->
h—d
->
couÁ
++;

463  (
Üig_h—d
 !ğ
quickli¡
->
h—d
);

464 
	}
}

470 
	$quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

471 
quickli¡Node
 *
Üig_
 = 
quickli¡
->

;

472 ià(
	`lik–y
(

473 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->

, quickli¡->
fl
, 
sz
))) {

474 
quickli¡
->

->
zl
 =

475 
	`zli¡Push
(
quickli¡
->

->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

476 
	`quickli¡NodeUpd©eSz
(
quickli¡
->

);

478 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

479 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

481 
	`quickli¡NodeUpd©eSz
(
node
);

482 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

484 
quickli¡
->
couÁ
++;

485 
quickli¡
->

->
couÁ
++;

486  (
Üig_
 !ğ
quickli¡
->

);

487 
	}
}

492 
	$quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
) {

493 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

495 
node
->
zl
 = zl;

496 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

497 
node
->
sz
 = 
	`zli¡BlobL’
(
zl
);

499 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

500 
quickli¡
->
couÁ
 +ğ
node
->count;

501 
	}
}

509 
quickli¡
 *
	$quickli¡Aµ’dV®uesFromZli¡
(
quickli¡
 *quicklist,

510 *
zl
) {

511 *
v®ue
;

512 
sz
;

513 
lÚgv®
;

514 
lÚg¡r
[32] = {0};

516 *
p
 = 
	`zli¡Index
(
zl
, 0);

517 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
)) {

518 ià(!
v®ue
) {

520 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

521 
v®ue
 = (*)
lÚg¡r
;

523 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

524 
p
 = 
	`zli¡Next
(
zl
,…);

526 
	`dä“
(
zl
);

527  
quickli¡
;

528 
	}
}

533 
quickli¡
 *
	$quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

534 *
zl
) {

535  
	`quickli¡Aµ’dV®uesFromZli¡
(
	`quickli¡New
(
fl
, 
com´ess
), 
zl
);

536 
	}
}

538 
	#quickli¡D–‘eIfEm±y
(
ql
, 
n
) \

540 ià((
n
)->
couÁ
 == 0) { \

541 
	`__quickli¡D–Node
((
ql
), (
n
)); \

542 (
n
èğ
NULL
; \

544 } 0)

	)

546 
REDIS_STATIC
 
	$__quickli¡D–Node
(
quickli¡
 *quicklist,

547 
quickli¡Node
 *
node
) {

548 ià(
node
->
Ãxt
)

549 
node
->
Ãxt
->
´ev
 =‚ode->prev;

550 ià(
node
->
´ev
)

551 
node
->
´ev
->
Ãxt
 =‚ode->next;

553 ià(
node
 =ğ
quickli¡
->

) {

554 
quickli¡
->

 = 
node
->
´ev
;

557 ià(
node
 =ğ
quickli¡
->
h—d
) {

558 
quickli¡
->
h—d
 = 
node
->
Ãxt
;

563 
	`__quickli¡Com´ess
(
quickli¡
, 
NULL
);

565 
quickli¡
->
couÁ
 -ğ
node
->count;

567 
	`dä“
(
node
->
zl
);

568 
	`dä“
(
node
);

569 
quickli¡
->
Ën
--;

570 
	}
}

580 
REDIS_STATIC
 
	$quickli¡D–Index
(
quickli¡
 *quickli¡, 
quickli¡Node
 *
node
,

581 **
p
) {

582 
gÚe
 = 0;

584 
node
->
zl
 = 
	`zli¡D–‘e
Òode->zl, 
p
);

585 
node
->
couÁ
--;

586 ià(
node
->
couÁ
 == 0) {

587 
gÚe
 = 1;

588 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

590 
	`quickli¡NodeUpd©eSz
(
node
);

592 
quickli¡
->
couÁ
--;

594  
gÚe
 ? 1 : 0;

595 
	}
}

601 
	$quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

602 
quickli¡Node
 *
´ev
 = 
’Œy
->
node
->prev;

603 
quickli¡Node
 *
Ãxt
 = 
’Œy
->
node
->next;

604 
d–‘ed_node
 = 
	`quickli¡D–Index
((
quickli¡
 *)
’Œy
->quicklist,

605 
’Œy
->
node
, &’Œy->
zi
);

608 
™”
->
zi
 = 
NULL
;

611 ià(
d–‘ed_node
) {

612 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

613 
™”
->
cu¼’t
 = 
Ãxt
;

614 
™”
->
off£t
 = 0;

615 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

616 
™”
->
cu¼’t
 = 
´ev
;

617 
™”
->
off£t
 = -1;

628 
	}
}

634 
	$quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

635 
sz
) {

636 
quickli¡EÁry
 
’Œy
;

637 ià(
	`lik–y
(
	`quickli¡Index
(
quickli¡
, 
šdex
, &
’Œy
))) {

639 
’Œy
.
node
->
zl
 = 
	`zli¡D–‘e
ÓÁry.node->zl, &’Œy.
zi
);

640 
’Œy
.
node
->
zl
 = 
	`zli¡In£¹
ÓÁry.node->zl,ƒÁry.
zi
, 
d©a
, 
sz
);

641 
	`quickli¡Com´ess
(
quickli¡
, 
’Œy
.
node
);

646 
	}
}

661 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡Zli¡M”ge
(
quickli¡
 *quicklist,

662 
quickli¡Node
 *
a
,

663 
quickli¡Node
 *
b
) {

664 
	`D
("Reque¡ed m”g×,bè(%u, %u)", 
a
->
couÁ
, 
b
->count);

666 
	`quickli¡Decom´essNode
(
a
);

667 
	`quickli¡Decom´essNode
(
b
);

668 ià((
	`zli¡M”ge
(&
a
->
zl
, &
b
->zl))) {

670 
quickli¡Node
 *
k“p
 = 
NULL
, *
nok“p
 = NULL;

671 ià(!
a
->
zl
) {

672 
nok“p
 = 
a
;

673 
k“p
 = 
b
;

674 } ià(!
b
->
zl
) {

675 
nok“p
 = 
b
;

676 
k“p
 = 
a
;

678 
k“p
->
couÁ
 = 
	`zli¡L’
(k“p->
zl
);

679 
	`quickli¡NodeUpd©eSz
(
k“p
);

681 
nok“p
->
couÁ
 = 0;

682 
	`__quickli¡D–Node
(
quickli¡
, 
nok“p
);

683 
	`quickli¡Com´ess
(
quickli¡
, 
k“p
);

684  
k“p
;

687  
NULL
;

689 
	}
}

699 
REDIS_STATIC
 
	$_quickli¡M”geNodes
(
quickli¡
 *quicklist,

700 
quickli¡Node
 *
ûÁ”
) {

701 
fl
 = 
quickli¡
->fill;

702 
quickli¡Node
 *
´ev
, *
´ev_´ev
, *
Ãxt
, *
Ãxt_Ãxt
, *
rg‘
;

703 
´ev
 = 
´ev_´ev
 = 
Ãxt
 = 
Ãxt_Ãxt
 = 
rg‘
 = 
NULL
;

705 ià(
ûÁ”
->
´ev
) {

706 
´ev
 = 
ûÁ”
->prev;

707 ià(
ûÁ”
->
´ev
->prev)

708 
´ev_´ev
 = 
ûÁ”
->
´ev
->prev;

711 ià(
ûÁ”
->
Ãxt
) {

712 
Ãxt
 = 
ûÁ”
->next;

713 ià(
ûÁ”
->
Ãxt
->next)

714 
Ãxt_Ãxt
 = 
ûÁ”
->
Ãxt
->next;

718 ià(
	`_quickli¡NodeAÎowM”ge
(
´ev
, 
´ev_´ev
, 
fl
)) {

719 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
´ev_´ev
, 
´ev
);

720 
´ev_´ev
 = 
´ev
 = 
NULL
;

724 ià(
	`_quickli¡NodeAÎowM”ge
(
Ãxt
, 
Ãxt_Ãxt
, 
fl
)) {

725 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
Ãxt
, 
Ãxt_Ãxt
);

726 
Ãxt
 = 
Ãxt_Ãxt
 = 
NULL
;

730 ià(
	`_quickli¡NodeAÎowM”ge
(
ûÁ”
, c’‹r->
´ev
, 
fl
)) {

731 
rg‘
 = 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
ûÁ”
->
´ev
, center);

732 
ûÁ”
 = 
NULL
;

735 
rg‘
 = 
ûÁ”
;

739 ià(
	`_quickli¡NodeAÎowM”ge
(
rg‘
,¬g‘->
Ãxt
, 
fl
)) {

740 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
rg‘
,¬g‘->
Ãxt
);

742 
	}
}

763 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡S¶™Node
(
quickli¡Node
 *
node
, 
off£t
,

764 
aá”
) {

765 
size_t
 
zl_sz
 = 
node
->
sz
;

767 
quickli¡Node
 *
Ãw_node
 = 
	`quickli¡C»©eNode
();

768 
Ãw_node
->
zl
 = 
	`d®loc
(
zl_sz
);

771 
	`memıy
(
Ãw_node
->
zl
, 
node
->zl, 
zl_sz
);

774 
Üig_¡¬t
 = 
aá”
 ? 
off£t
 + 1 : 0;

775 
Üig_ex‹Á
 = 
aá”
 ? -1 : 
off£t
;

776 
Ãw_¡¬t
 = 
aá”
 ? 0 : 
off£t
;

777 
Ãw_ex‹Á
 = 
aá”
 ? 
off£t
 + 1 : -1;

779 
	`D
("Aá” %d (%d);„ªges: [%d, %d], [%d, %d]", 
aá”
, 
off£t
, 
Üig_¡¬t
,

780 
Üig_ex‹Á
, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

782 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
Üig_¡¬t
, 
Üig_ex‹Á
);

783 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

784 
	`quickli¡NodeUpd©eSz
(
node
);

786 
Ãw_node
->
zl
 = 
	`zli¡D–‘eRªge
Òew_node->zl, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

787 
Ãw_node
->
couÁ
 = 
	`zli¡L’
Òew_node->
zl
);

788 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

790 
	`D
("Aá” s¶™†’gths: orig (%d),‚ew (%d)", 
node
->
couÁ
, 
Ãw_node
->count);

791  
Ãw_node
;

792 
	}
}

798 
REDIS_STATIC
 
	$_quickli¡In£¹
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

799 *
v®ue
, cÚ¡ 
size_t
 
sz
, 
aá”
) {

800 
fuÎ
 = 0, 
©_
 = 0, 
©_h—d
 = 0, 
fuÎ_Ãxt
 = 0, 
fuÎ_´ev
 = 0;

801 
fl
 = 
quickli¡
->fill;

802 
quickli¡Node
 *
node
 = 
’Œy
->node;

803 
quickli¡Node
 *
Ãw_node
 = 
NULL
;

805 ià(!
node
) {

807 
	`D
("No‚ode given!");

808 
Ãw_node
 = 
	`quickli¡C»©eNode
();

809 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

810 
	`__quickli¡In£¹Node
(
quickli¡
, 
NULL
, 
Ãw_node
, 
aá”
);

811 
Ãw_node
->
couÁ
++;

812 
quickli¡
->
couÁ
++;

817 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
, 
fl
, 
sz
)) {

818 
	`D
("Current‚ode is full with count %d with„equested fill %lu",

819 
node
->
couÁ
, 
fl
);

820 
fuÎ
 = 1;

823 ià(
aá”
 && (
’Œy
->
off£t
 =ğ
node
->
couÁ
)) {

824 
	`D
("At Tail of current ziplist");

825 
©_
 = 1;

826 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
Ãxt
, 
fl
, 
sz
)) {

827 
	`D
("Next‚ode is fulloo.");

828 
fuÎ_Ãxt
 = 1;

832 ià(!
aá”
 && (
’Œy
->
off£t
 == 0)) {

833 
	`D
("At Head");

834 
©_h—d
 = 1;

835 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
´ev
, 
fl
, 
sz
)) {

836 
	`D
("Prev‚ode is fulloo.");

837 
fuÎ_´ev
 = 1;

842 ià(!
fuÎ
 && 
aá”
) {

843 
	`D
("Not full, inserting‡fter current…osition.");

844 
	`quickli¡Decom´essNodeFÜU£
(
node
);

845 *
Ãxt
 = 
	`zli¡Next
(
node
->
zl
, 
’Œy
->
zi
);

846 ià(
Ãxt
 =ğ
NULL
) {

847 
node
->
zl
 = 
	`zli¡Push
Òode->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

849 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
Ãxt
, 
v®ue
, 
sz
);

851 
node
->
couÁ
++;

852 
	`quickli¡NodeUpd©eSz
(
node
);

853 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

854 } ià(!
fuÎ
 && !
aá”
) {

855 
	`D
("Not full, inserting before current…osition.");

856 
	`quickli¡Decom´essNodeFÜU£
(
node
);

857 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
’Œy
->
zi
, 
v®ue
, 
sz
);

858 
node
->
couÁ
++;

859 
	`quickli¡NodeUpd©eSz
(
node
);

860 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

861 } ià(
fuÎ
 && 
©_
 && 
node
->
Ãxt
 && !
fuÎ_Ãxt
 && 
aá”
) {

864 
	`D
("Full‡ndail, but‚ext isn't full; inserting‚ext‚ode head");

865 
Ãw_node
 = 
node
->
Ãxt
;

866 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

867 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

868 
Ãw_node
->
couÁ
++;

869 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

870 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

871 } ià(
fuÎ
 && 
©_h—d
 && 
node
->
´ev
 && !
fuÎ_´ev
 && !
aá”
) {

874 
	`D
("Full‡nd head, but…rev isn't full, inserting…rev‚odeail");

875 
Ãw_node
 = 
node
->
´ev
;

876 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

877 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

878 
Ãw_node
->
couÁ
++;

879 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

880 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

881 } ià(
fuÎ
 && ((
©_
 && 
node
->
Ãxt
 && 
fuÎ_Ãxt
 && 
aá”
) ||

882 (
©_h—d
 && 
node
->
´ev
 && 
fuÎ_´ev
 && !
aá”
))) {

885 
	`D
("\tprovisioning‚ew‚ode...");

886 
Ãw_node
 = 
	`quickli¡C»©eNode
();

887 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

888 
Ãw_node
->
couÁ
++;

889 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

890 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

891 } ià(
fuÎ
) {

894 
	`D
("\tsplitting‚ode...");

895 
	`quickli¡Decom´essNodeFÜU£
(
node
);

896 
Ãw_node
 = 
	`_quickli¡S¶™Node
(
node
, 
’Œy
->
off£t
, 
aá”
);

897 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
,

898 
aá”
 ? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
);

899 
Ãw_node
->
couÁ
++;

900 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

901 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

902 
	`_quickli¡M”geNodes
(
quickli¡
, 
node
);

905 
quickli¡
->
couÁ
++;

906 
	}
}

908 
	$quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

909 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

910 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 0);

911 
	}
}

913 
	$quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

914 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

915 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 1);

916 
	}
}

924 
	$quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
,

925 cÚ¡ 
couÁ
) {

926 ià(
couÁ
 <= 0)

929 
ex‹Á
 = 
couÁ
;

931 ià(
¡¬t
 >ğ0 && 
ex‹Á
 > (
quickli¡
->
couÁ
 - start)) {

933 
ex‹Á
 = 
quickli¡
->
couÁ
 - 
¡¬t
;

934 } ià(
¡¬t
 < 0 && 
ex‹Á
 > ()(-start)) {

936 
ex‹Á
 = -
¡¬t
;

939 
quickli¡EÁry
 
’Œy
;

940 ià(!
	`quickli¡Index
(
quickli¡
, 
¡¬t
, &
’Œy
))

943 
	`D
("Quickli¡ d–‘»que¡ fÜ s¹ %ld, couÁ %ld,ƒx‹Á: %ld", 
¡¬t
,

944 
couÁ
, 
ex‹Á
);

945 
quickli¡Node
 *
node
 = 
’Œy
.node;

948 
ex‹Á
) {

949 
quickli¡Node
 *
Ãxt
 = 
node
->next;

951 
d–
;

952 
d–‘e_’tœe_node
 = 0;

953 ià(
’Œy
.
off£t
 =ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

956 
d–‘e_’tœe_node
 = 1;

957 
d–
 = 
node
->
couÁ
;

958 } ià(
’Œy
.
off£t
 >ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

961 
d–
 = 
node
->
couÁ
 - 
’Œy
.
off£t
;

962 } ià(
’Œy
.
off£t
 < 0) {

968 
d–
 = -
’Œy
.
off£t
;

973 ià(
d–
 > 
ex‹Á
)

974 
d–
 = 
ex‹Á
;

978 
d–
 = 
ex‹Á
;

981 
	`D
("[%ld]:‡skingo del: %ld because offset: %d; (ENTIRE NODE: %d), "

983 
ex‹Á
, 
d–
, 
’Œy
.
off£t
, 
d–‘e_’tœe_node
, 
node
->
couÁ
);

985 ià(
d–‘e_’tœe_node
) {

986 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

988 
	`quickli¡Decom´essNodeFÜU£
(
node
);

989 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
’Œy
.
off£t
, 
d–
);

990 
	`quickli¡NodeUpd©eSz
(
node
);

991 
node
->
couÁ
 -ğ
d–
;

992 
quickli¡
->
couÁ
 -ğ
d–
;

993 
	`quickli¡D–‘eIfEm±y
(
quickli¡
, 
node
);

994 ià(
node
)

995 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

998 
ex‹Á
 -ğ
d–
;

1000 
node
 = 
Ãxt
;

1002 
’Œy
.
off£t
 = 0;

1005 
	}
}

1008 
	$quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
) {

1009  
	`zli¡Com·»
(
p1
, 
p2
, 
p2_Ën
);

1010 
	}
}

1014 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
) {

1015 
quickli¡I‹r
 *
™”
;

1017 
™”
 = 
	`d®loc
((*iter));

1019 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1020 
™”
->
cu¼’t
 = 
quickli¡
->
h—d
;

1021 
™”
->
off£t
 = 0;

1022 } ià(
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1023 
™”
->
cu¼’t
 = 
quickli¡
->

;

1024 
™”
->
off£t
 = -1;

1027 
™”
->
dœeùiÚ
 = direction;

1028 
™”
->
quickli¡
 = quicklist;

1030 
™”
->
zi
 = 
NULL
;

1032  
™”
;

1033 
	}
}

1037 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

1038 cÚ¡ 
dœeùiÚ
,

1039 cÚ¡ 
idx
) {

1040 
quickli¡EÁry
 
’Œy
;

1042 ià(
	`quickli¡Index
(
quickli¡
, 
idx
, &
’Œy
)) {

1043 
quickli¡I‹r
 *
ba£
 = 
	`quickli¡G‘I‹¿tÜ
(
quickli¡
, 
dœeùiÚ
);

1044 
ba£
->
zi
 = 
NULL
;

1045 
ba£
->
cu¼’t
 = 
’Œy
.
node
;

1046 
ba£
->
off£t
 = 
’Œy
.offset;

1047  
ba£
;

1049  
NULL
;

1051 
	}
}

1055 
	$quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
) {

1056 ià(
™”
->
cu¼’t
)

1057 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1059 
	`dä“
(
™”
);

1060 
	}
}

1083 
	$quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

1084 
	`š™EÁry
(
’Œy
);

1086 ià(!
™”
) {

1087 
	`D
("Returning because‚o iter!");

1091 
’Œy
->
quickli¡
 = 
™”
->quicklist;

1092 
’Œy
->
node
 = 
™”
->
cu¼’t
;

1094 ià(!
™”
->
cu¼’t
) {

1095 
	`D
("Returning because current‚ode is NULL")

1099 *(*
ÃxtFn
)(*, *èğ
NULL
;

1100 
off£t_upd©e
 = 0;

1102 ià(!
™”
->
zi
) {

1104 
	`quickli¡Decom´essNodeFÜU£
(
™”
->
cu¼’t
);

1105 
™”
->
zi
 = 
	`zli¡Index
(™”->
cu¼’t
->
zl
, i‹r->
off£t
);

1108 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1109 
ÃxtFn
 = 
zli¡Next
;

1110 
off£t_upd©e
 = 1;

1111 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1112 
ÃxtFn
 = 
zli¡P»v
;

1113 
off£t_upd©e
 = -1;

1115 
™”
->
zi
 = 
	`ÃxtFn
(™”->
cu¼’t
->
zl
, iter->zi);

1116 
™”
->
off£t
 +ğ
off£t_upd©e
;

1119 
’Œy
->
zi
 = 
™”
->zi;

1120 
’Œy
->
off£t
 = 
™”
->offset;

1122 ià(
™”
->
zi
) {

1124 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1129 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1130 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1132 
	`D
("Jumpingo start of‚ext‚ode");

1133 
™”
->
cu¼’t
 = i‹r->cu¼’t->
Ãxt
;

1134 
™”
->
off£t
 = 0;

1135 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1137 
	`D
("Jumpingoƒnd of…revious‚ode");

1138 
™”
->
cu¼’t
 = i‹r->cu¼’t->
´ev
;

1139 
™”
->
off£t
 = -1;

1141 
™”
->
zi
 = 
NULL
;

1142  
	`quickli¡Next
(
™”
, 
’Œy
);

1144 
	}
}

1152 
quickli¡
 *
	$quickli¡Dup
(
quickli¡
 *
Üig
) {

1153 
quickli¡
 *
cİy
;

1154 
quickli¡Node
 *
cu¼’t
;

1156 
cİy
 = 
	`quickli¡New
(
Üig
->
fl
, orig->
com´ess
);

1158 
cu¼’t
 = 
Üig
->
h—d
; current;

1159 
cu¼’t
 = cu¼’t->
Ãxt
) {

1160 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

1162 ià(
node
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) {

1163 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

1164 
size_t
 
lzf_sz
 = (*
lzf
è+†zf->
sz
;

1165 
node
->
zl
 = 
	`d®loc
(
lzf_sz
);

1166 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, 
lzf_sz
);

1167 } ià(
node
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) {

1168 
node
->
zl
 = 
	`d®loc
(
cu¼’t
->
sz
);

1169 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, cu¼’t->
sz
);

1172 
node
->
couÁ
 = 
cu¼’t
->count;

1173 
cİy
->
couÁ
 +ğ
node
->count;

1174 
node
->
sz
 = 
cu¼’t
->sz;

1175 
node
->
’codšg
 = 
cu¼’t
->encoding;

1177 
	`_quickli¡In£¹NodeAá”
(
cİy
, cİy->

, 
node
);

1181  
cİy
;

1182 
	}
}

1192 
	$quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
idx
,

1193 
quickli¡EÁry
 *
’Œy
) {

1194 
quickli¡Node
 *
n
;

1195 
accum
 = 0;

1196 
šdex
;

1197 
fÜw¬d
 = 
idx
 < 0 ? 0 : 1;

1199 
	`š™EÁry
(
’Œy
);

1200 
’Œy
->
quickli¡
 = quicklist;

1202 ià(!
fÜw¬d
) {

1203 
šdex
 = (-
idx
) - 1;

1204 
n
 = 
quickli¡
->

;

1206 
šdex
 = 
idx
;

1207 
n
 = 
quickli¡
->
h—d
;

1210 ià(
šdex
 >ğ
quickli¡
->
couÁ
)

1213 
	`lik–y
(
n
)) {

1214 ià((
accum
 + 
n
->
couÁ
è> 
šdex
) {

1217 
	`D
("Skpšg ov” (%pè%u‡ˆaccum %Îd", (*)
n
,‚->
couÁ
,

1218 
accum
);

1219 
accum
 +ğ
n
->
couÁ
;

1220 
n
 = 
fÜw¬d
 ?‚->
Ãxt
 :‚->
´ev
;

1224 ià(!
n
)

1227 
	`D
("Found‚ode: %°©‡ccum %Îu, idx %Îu, sub+ %Îu, sub- %Îu", (*)
n
,

1228 
accum
, 
šdex
, index -‡ccum, (-index) - 1 +‡ccum);

1230 
’Œy
->
node
 = 
n
;

1231 ià(
fÜw¬d
) {

1233 
’Œy
->
off£t
 = 
šdex
 - 
accum
;

1237 
’Œy
->
off£t
 = (-
šdex
è- 1 + 
accum
;

1240 
	`quickli¡Decom´essNodeFÜU£
(
’Œy
->
node
);

1241 
’Œy
->
zi
 = 
	`zli¡Index
ÓÁry->
node
->
zl
,ƒÁry->
off£t
);

1242 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1246 
	}
}

1249 
	$quickli¡RÙ©e
(
quickli¡
 *quicklist) {

1250 ià(
quickli¡
->
couÁ
 <= 1)

1254 *
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1255 *
v®ue
;

1256 
lÚgv®
;

1257 
sz
;

1258 
lÚg¡r
[32] = {0};

1259 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
);

1262 ià(!
v®ue
) {

1264 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

1265 
v®ue
 = (*)
lÚg¡r
;

1269 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1274 ià(
quickli¡
->
Ën
 == 1) {

1275 
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1279 
	`quickli¡D–Index
(
quickli¡
, quickli¡->

, &
p
);

1280 
	}
}

1291 
	$quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1292 *
sz
, *
sv®
,

1293 *(*
§v”
)(*
d©a
, 
sz
)) {

1294 *
p
;

1295 *
v¡r
;

1296 
vËn
;

1297 
vlÚg
;

1298 
pos
 = (
wh”e
 =ğ
QUICKLIST_HEAD
) ? 0 : -1;

1300 ià(
quickli¡
->
couÁ
 == 0)

1303 ià(
d©a
)

1304 *
d©a
 = 
NULL
;

1305 ià(
sz
)

1306 *
sz
 = 0;

1307 ià(
sv®
)

1308 *
sv®
 = -123456789;

1310 
quickli¡Node
 *
node
;

1311 ià(
wh”e
 =ğ
QUICKLIST_HEAD
 && 
quickli¡
->
h—d
) {

1312 
node
 = 
quickli¡
->
h—d
;

1313 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
 && 
quickli¡
->

) {

1314 
node
 = 
quickli¡
->

;

1319 
p
 = 
	`zli¡Index
(
node
->
zl
, 
pos
);

1320 ià(
	`zli¡G‘
(
p
, &
v¡r
, &
vËn
, &
vlÚg
)) {

1321 ià(
v¡r
) {

1322 ià(
d©a
)

1323 *
d©a
 = 
	`§v”
(
v¡r
, 
vËn
);

1324 ià(
sz
)

1325 *
sz
 = 
vËn
;

1327 ià(
d©a
)

1328 *
d©a
 = 
NULL
;

1329 ià(
sv®
)

1330 *
sv®
 = 
vlÚg
;

1332 
	`quickli¡D–Index
(
quickli¡
, 
node
, &
p
);

1336 
	}
}

1339 
REDIS_STATIC
 *
	$_quickli¡Sav”
(*
d©a
, 
sz
) {

1340 *
v¡r
;

1341 ià(
d©a
) {

1342 
v¡r
 = 
	`d®loc
(
sz
);

1343 
	`memıy
(
v¡r
, 
d©a
, 
sz
);

1344  
v¡r
;

1346  
NULL
;

1347 
	}
}

1352 
	$quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1353 *
sz
, *
¦Úg
) {

1354 *
v¡r
;

1355 
vËn
;

1356 
vlÚg
;

1357 ià(
quickli¡
->
couÁ
 == 0)

1359 
»t
 = 
	`quickli¡PİCu¡om
(
quickli¡
, 
wh”e
, &
v¡r
, &
vËn
, &
vlÚg
,

1360 
_quickli¡Sav”
);

1361 ià(
d©a
)

1362 *
d©a
 = 
v¡r
;

1363 ià(
¦Úg
)

1364 *
¦Úg
 = 
vlÚg
;

1365 ià(
sz
)

1366 *
sz
 = 
vËn
;

1367  
»t
;

1368 
	}
}

1371 
	$quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

1372 
wh”e
) {

1373 ià(
wh”e
 =ğ
QUICKLIST_HEAD
) {

1374 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1375 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
) {

1376 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

1378 
	}
}

	@src/vr_quicklist.c

1 
	~<¡ršg.h
>

3 
	~<vr_cÜe.h
>

5 #ià
defšed
(
REDIS_TEST
è|| defšed(
REDIS_TEST_VERBOSE
)

6 
	~<¡dio.h
>

9 #iâdeà
REDIS_STATIC


10 
	#REDIS_STATIC
 

	)

14 cÚ¡ 
size_t
 
	gİtimiz©iÚ_Ëv–
[] = {4096, 8192, 16384, 32768, 65536};

18 
	#SIZE_SAFETY_LIMIT
 8192

	)

21 
	#MIN_COMPRESS_BYTES
 48

	)

26 
	#MIN_COMPRESS_IMPROVE
 8

	)

29 #iâdeà
REDIS_TEST_VERBOSE


30 
	#D
(...)

	)

32 
	#D
(...) \

34 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

35 
	`´štf
(
__VA_ARGS__
); \

36 
	`´štf
("\n"); \

37 } 0);

	)

41 
	#š™EÁry
(
e
) \

43 (
e
)->
zi
 = (e)->
v®ue
 = 
NULL
; \

44 (
e
)->
lÚgv®
 = -123456789; \

45 (
e
)->
quickli¡
 = 
NULL
; \

46 (
e
)->
node
 = 
NULL
; \

47 (
e
)->
off£t
 = 123456789; \

48 (
e
)->
sz
 = 0; \

49 } 0)

	)

51 #ià
__GNUC__
 >= 3

52 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

53 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

55 
	#lik–y
(
x
è(x)

	)

56 
	#uÆik–y
(
x
è(x)

	)

61 
quickli¡
 *
	$quickli¡C»©e
() {

62 
quickli¡
 *quicklist;

64 
quickli¡
 = 
	`d®loc
((*quicklist));

65 
quickli¡
->
h—d
 = quickli¡->

 = 
NULL
;

66 
quickli¡
->
Ën
 = 0;

67 
quickli¡
->
couÁ
 = 0;

68 
quickli¡
->
com´ess
 = 0;

69 
quickli¡
->
fl
 = -2;

70  
quickli¡
;

71 
	}
}

73 
	#COMPRESS_MAX
 (1 << 16)

	)

74 
	$quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
com´ess
) {

75 ià(
com´ess
 > 
COMPRESS_MAX
) {

76 
com´ess
 = 
COMPRESS_MAX
;

77 } ià(
com´ess
 < 0) {

78 
com´ess
 = 0;

80 
quickli¡
->
com´ess
 = compress;

81 
	}
}

83 
	#FILL_MAX
 (1 << 15)

	)

84 
	$quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
) {

85 ià(
fl
 > 
FILL_MAX
) {

86 
fl
 = 
FILL_MAX
;

87 } ià(
fl
 < -5) {

88 
fl
 = -5;

90 
quickli¡
->
fl
 = fill;

91 
	}
}

93 
	$quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
) {

94 
	`quickli¡S‘Fl
(
quickli¡
, 
fl
);

95 
	`quickli¡S‘Com´essD•th
(
quickli¡
, 
d•th
);

96 
	}
}

99 
quickli¡
 *
	$quickli¡New
(
fl
, 
com´ess
) {

100 
quickli¡
 *quickli¡ = 
	`quickli¡C»©e
();

101 
	`quickli¡S‘O±iÚs
(
quickli¡
, 
fl
, 
com´ess
);

102  
quickli¡
;

103 
	}
}

105 
REDIS_STATIC
 
quickli¡Node
 *
	$quickli¡C»©eNode
() {

106 
quickli¡Node
 *
node
;

107 
node
 = 
	`d®loc
((*node));

108 
node
->
zl
 = 
NULL
;

109 
node
->
couÁ
 = 0;

110 
node
->
sz
 = 0;

111 
node
->
Ãxt
 =‚ode->
´ev
 = 
NULL
;

112 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

113 
node
->
cÚš”
 = 
QUICKLIST_NODE_CONTAINER_ZIPLIST
;

114 
node
->
»com´ess
 = 0;

115  
node
;

116 
	}
}

119 
	$quickli¡CouÁ
(
quickli¡
 *
ql
è{  ql->
couÁ
; 
	}
}

122 
	$quickli¡R–—£
(
quickli¡
 *quicklist) {

123 
Ën
;

124 
quickli¡Node
 *
cu¼’t
, *
Ãxt
;

126 
cu¼’t
 = 
quickli¡
->
h—d
;

127 
Ën
 = 
quickli¡
->len;

128 
Ën
--) {

129 
Ãxt
 = 
cu¼’t
->next;

131 
	`dä“
(
cu¼’t
->
zl
);

132 
quickli¡
->
couÁ
 -ğ
cu¼’t
->count;

134 
	`dä“
(
cu¼’t
);

136 
quickli¡
->
Ën
--;

137 
cu¼’t
 = 
Ãxt
;

139 
	`dä“
(
quickli¡
);

140 
	}
}

145 
REDIS_STATIC
 
	$__quickli¡Com´essNode
(
quickli¡Node
 *
node
) {

146 #ifdeà
REDIS_TEST


147 
node
->
©‹m±ed_com´ess
 = 1;

151 ià(
node
->
sz
 < 
MIN_COMPRESS_BYTES
)

154 
quickli¡LZF
 *
lzf
 = 
	`d®loc
((*lzfè+ 
node
->
sz
);

157 ià(((
lzf
->
sz
 = 
	`lzf_com´ess
(
node
->
zl
,‚ode->sz,†zf->
com´es£d
,

158 
node
->
sz
)) == 0) ||

159 
lzf
->
sz
 + 
MIN_COMPRESS_IMPROVE
 >ğ
node
->sz) {

161 
	`dä“
(
lzf
);

164 
lzf
 = 
	`d»®loc
Özf, (*lzfè+†zf->
sz
);

165 
	`dä“
(
node
->
zl
);

166 
node
->
zl
 = (*)
lzf
;

167 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_LZF
;

168 
node
->
»com´ess
 = 0;

170 
	}
}

173 
	#quickli¡Com´essNode
(
_node
) \

175 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) { \

176 
	`__quickli¡Com´essNode
((
_node
)); \

178 } 0)

	)

182 
REDIS_STATIC
 
	$__quickli¡Decom´essNode
(
quickli¡Node
 *
node
) {

183 #ifdeà
REDIS_TEST


184 
node
->
©‹m±ed_com´ess
 = 0;

187 *
decom´es£d
 = 
	`d®loc
(
node
->
sz
);

188 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

189 ià(
	`lzf_decom´ess
(
lzf
->
com´es£d
,†zf->
sz
, 
decom´es£d
, 
node
->sz) == 0) {

191 
	`dä“
(
decom´es£d
);

194 
	`dä“
(
lzf
);

195 
node
->
zl
 = 
decom´es£d
;

196 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

198 
	}
}

201 
	#quickli¡Decom´essNode
(
_node
) \

203 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

204 
	`__quickli¡Decom´essNode
((
_node
)); \

206 } 0)

	)

209 
	#quickli¡Decom´essNodeFÜU£
(
_node
) \

211 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

212 
	`__quickli¡Decom´essNode
((
_node
)); \

213 (
_node
)->
»com´ess
 = 1; \

215 } 0)

	)

220 
size_t
 
	$quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
) {

221 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

222 *
d©a
 = 
lzf
->
com´es£d
;

223  
lzf
->
sz
;

224 
	}
}

226 
	#quickli¡AÎowsCom´essiÚ
(
_ql
è((_ql)->
com´ess
 !ğ0)

	)

232 
REDIS_STATIC
 
	$__quickli¡Com´ess
(cÚ¡ 
quickli¡
 *quicklist,

233 
quickli¡Node
 *
node
) {

236 ià(!
	`quickli¡AÎowsCom´essiÚ
(
quickli¡
) ||

237 
quickli¡
->
Ën
 < ()(quickli¡->
com´ess
 * 2))

242 ià(
quickli¡
->
com´ess
 == 1) {

243 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
t
 = quickli¡->

;

244 
	`quickli¡Decom´essNode
(
h
);

245 
	`quickli¡Decom´essNode
(
t
);

246 ià(
h
 !ğ
node
 && 
t
 !=‚ode)

247 
	`quickli¡Com´essNode
(
node
);

249 } ià(
quickli¡
->
com´ess
 == 2) {

250 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
hn
 = h->
Ãxt
, *
hÂ
 = hn->next;

251 
quickli¡Node
 *
t
 = 
quickli¡
->

, *

 =->
´ev
, *
p
 =p->prev;

252 
	`quickli¡Decom´essNode
(
h
);

253 
	`quickli¡Decom´essNode
(
hn
);

254 
	`quickli¡Decom´essNode
(
t
);

255 
	`quickli¡Decom´essNode
(

);

256 ià(
h
 !ğ
node
 && 
hn
 !ğnod&& 
t
 !ğnod&& 

 !=‚ode) {

257 
	`quickli¡Com´essNode
(
node
);

259 ià(
hÂ
 !ğ
t
) {

260 
	`quickli¡Com´essNode
(
hÂ
);

262 ià(
p
 !ğ
h
) {

263 
	`quickli¡Com´essNode
(
p
);

272 
quickli¡Node
 *
fÜw¬d
 = 
quickli¡
->
h—d
;

273 
quickli¡Node
 *
»v”£
 = 
quickli¡
->

;

274 
d•th
 = 0;

275 
š_d•th
 = 0;

276 
d•th
++ < 
quickli¡
->
com´ess
) {

277 
	`quickli¡Decom´essNode
(
fÜw¬d
);

278 
	`quickli¡Decom´essNode
(
»v”£
);

280 ià(
fÜw¬d
 =ğ
node
 || 
»v”£
 ==‚ode)

281 
š_d•th
 = 1;

283 ià(
fÜw¬d
 =ğ
»v”£
)

286 
fÜw¬d
 = fÜw¬d->
Ãxt
;

287 
»v”£
 =„ev”£->
´ev
;

290 ià(!
š_d•th
)

291 
	`quickli¡Com´essNode
(
node
);

293 ià(
d•th
 > 2) {

295 
	`quickli¡Com´essNode
(
fÜw¬d
);

296 
	`quickli¡Com´essNode
(
»v”£
);

298 
	}
}

300 
	#quickli¡Com´ess
(
_ql
, 
_node
) \

302 ià((
_node
)->
»com´ess
) \

303 
	`quickli¡Com´essNode
((
_node
)); \

305 
	`__quickli¡Com´ess
((
_ql
), (
_node
)); \

306 } 0)

	)

309 
	#quickli¡Recom´essOÆy
(
_ql
, 
_node
) \

311 ià((
_node
)->
»com´ess
) \

312 
	`quickli¡Com´essNode
((
_node
)); \

313 } 0)

	)

319 
REDIS_STATIC
 
	$__quickli¡In£¹Node
(
quickli¡
 *quicklist,

320 
quickli¡Node
 *
Şd_node
,

321 
quickli¡Node
 *
Ãw_node
, 
aá”
) {

322 ià(
aá”
) {

323 
Ãw_node
->
´ev
 = 
Şd_node
;

324 ià(
Şd_node
) {

325 
Ãw_node
->
Ãxt
 = 
Şd_node
->next;

326 ià(
Şd_node
->
Ãxt
)

327 
Şd_node
->
Ãxt
->
´ev
 = 
Ãw_node
;

328 
Şd_node
->
Ãxt
 = 
Ãw_node
;

330 ià(
quickli¡
->

 =ğ
Şd_node
)

331 
quickli¡
->

 = 
Ãw_node
;

333 
Ãw_node
->
Ãxt
 = 
Şd_node
;

334 ià(
Şd_node
) {

335 
Ãw_node
->
´ev
 = 
Şd_node
->prev;

336 ià(
Şd_node
->
´ev
)

337 
Şd_node
->
´ev
->
Ãxt
 = 
Ãw_node
;

338 
Şd_node
->
´ev
 = 
Ãw_node
;

340 ià(
quickli¡
->
h—d
 =ğ
Şd_node
)

341 
quickli¡
->
h—d
 = 
Ãw_node
;

344 ià(
quickli¡
->
Ën
 == 0) {

345 
quickli¡
->
h—d
 = quickli¡->

 = 
Ãw_node
;

348 ià(
Şd_node
)

349 
	`quickli¡Com´ess
(
quickli¡
, 
Şd_node
);

351 
quickli¡
->
Ën
++;

352 
	}
}

355 
REDIS_STATIC
 
	$_quickli¡In£¹NodeBefÜe
(
quickli¡
 *quicklist,

356 
quickli¡Node
 *
Şd_node
,

357 
quickli¡Node
 *
Ãw_node
) {

358 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 0);

359 
	}
}

361 
REDIS_STATIC
 
	$_quickli¡In£¹NodeAá”
(
quickli¡
 *quicklist,

362 
quickli¡Node
 *
Şd_node
,

363 
quickli¡Node
 *
Ãw_node
) {

364 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 1);

365 
	}
}

367 
REDIS_STATIC
 

368 
	$_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(cÚ¡ 
size_t
 
sz
,

369 cÚ¡ 
fl
) {

370 ià(
fl
 >= 0)

373 
size_t
 
off£t
 = (-
fl
) - 1;

374 ià(
off£t
 < ((
İtimiz©iÚ_Ëv–
) / (*optimization_level))) {

375 ià(
sz
 <ğ
İtimiz©iÚ_Ëv–
[
off£t
]) {

383 
	}
}

385 
	#sizeM“tsSaãtyLim™
(
sz
è((szè<ğ
SIZE_SAFETY_LIMIT
)

	)

387 
REDIS_STATIC
 
	$_quickli¡NodeAÎowIn£¹
(cÚ¡ 
quickli¡Node
 *
node
,

388 cÚ¡ 
fl
, cÚ¡ 
size_t
 
sz
) {

389 ià(
	`uÆik–y
(!
node
))

392 
zli¡_ov”h—d
;

394 ià(
sz
 < 254)

395 
zli¡_ov”h—d
 = 1;

397 
zli¡_ov”h—d
 = 5;

400 ià(
sz
 < 64)

401 
zli¡_ov”h—d
 += 1;

402 ià(
	`lik–y
(
sz
 < 16384))

403 
zli¡_ov”h—d
 += 2;

405 
zli¡_ov”h—d
 += 5;

408 
Ãw_sz
 = 
node
->
sz
 + sz + 
zli¡_ov”h—d
;

409 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
Ãw_sz
, 
fl
)))

411 ià(!
	`sizeM“tsSaãtyLim™
(
Ãw_sz
))

413 ià(()
node
->
couÁ
 < 
fl
)

417 
	}
}

419 
REDIS_STATIC
 
	$_quickli¡NodeAÎowM”ge
(cÚ¡ 
quickli¡Node
 *
a
,

420 cÚ¡ 
quickli¡Node
 *
b
,

421 cÚ¡ 
fl
) {

422 ià(!
a
 || !
b
)

427 
m”ge_sz
 = 
a
->
sz
 + 
b
->sz - 11;

428 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
m”ge_sz
, 
fl
)))

430 ià(!
	`sizeM“tsSaãtyLim™
(
m”ge_sz
))

432 ià(()(
a
->
couÁ
 + 
b
->couÁè<ğ
fl
)

436 
	}
}

438 
	#quickli¡NodeUpd©eSz
(
node
) \

440 (
node
)->
sz
 = 
	`zli¡BlobL’
(Òode)->
zl
); \

441 } 0)

	)

447 
	$quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

448 
quickli¡Node
 *
Üig_h—d
 = 
quickli¡
->
h—d
;

449 ià(
	`lik–y
(

450 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->
h—d
, quickli¡->
fl
, 
sz
))) {

451 
quickli¡
->
h—d
->
zl
 =

452 
	`zli¡Push
(
quickli¡
->
h—d
->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

453 
	`quickli¡NodeUpd©eSz
(
quickli¡
->
h—d
);

455 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

456 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

458 
	`quickli¡NodeUpd©eSz
(
node
);

459 
	`_quickli¡In£¹NodeBefÜe
(
quickli¡
, quickli¡->
h—d
, 
node
);

461 
quickli¡
->
couÁ
++;

462 
quickli¡
->
h—d
->
couÁ
++;

463  (
Üig_h—d
 !ğ
quickli¡
->
h—d
);

464 
	}
}

470 
	$quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

471 
quickli¡Node
 *
Üig_
 = 
quickli¡
->

;

472 ià(
	`lik–y
(

473 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->

, quickli¡->
fl
, 
sz
))) {

474 
quickli¡
->

->
zl
 =

475 
	`zli¡Push
(
quickli¡
->

->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

476 
	`quickli¡NodeUpd©eSz
(
quickli¡
->

);

478 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

479 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

481 
	`quickli¡NodeUpd©eSz
(
node
);

482 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

484 
quickli¡
->
couÁ
++;

485 
quickli¡
->

->
couÁ
++;

486  (
Üig_
 !ğ
quickli¡
->

);

487 
	}
}

492 
	$quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
) {

493 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

495 
node
->
zl
 = zl;

496 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

497 
node
->
sz
 = 
	`zli¡BlobL’
(
zl
);

499 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

500 
quickli¡
->
couÁ
 +ğ
node
->count;

501 
	}
}

509 
quickli¡
 *
	$quickli¡Aµ’dV®uesFromZli¡
(
quickli¡
 *quicklist,

510 *
zl
) {

511 *
v®ue
;

512 
sz
;

513 
lÚgv®
;

514 
lÚg¡r
[32] = {0};

516 *
p
 = 
	`zli¡Index
(
zl
, 0);

517 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
)) {

518 ià(!
v®ue
) {

520 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

521 
v®ue
 = (*)
lÚg¡r
;

523 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

524 
p
 = 
	`zli¡Next
(
zl
,…);

526 
	`dä“
(
zl
);

527  
quickli¡
;

528 
	}
}

533 
quickli¡
 *
	$quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

534 *
zl
) {

535  
	`quickli¡Aµ’dV®uesFromZli¡
(
	`quickli¡New
(
fl
, 
com´ess
), 
zl
);

536 
	}
}

538 
	#quickli¡D–‘eIfEm±y
(
ql
, 
n
) \

540 ià((
n
)->
couÁ
 == 0) { \

541 
	`__quickli¡D–Node
((
ql
), (
n
)); \

542 (
n
èğ
NULL
; \

544 } 0)

	)

546 
REDIS_STATIC
 
	$__quickli¡D–Node
(
quickli¡
 *quicklist,

547 
quickli¡Node
 *
node
) {

548 ià(
node
->
Ãxt
)

549 
node
->
Ãxt
->
´ev
 =‚ode->prev;

550 ià(
node
->
´ev
)

551 
node
->
´ev
->
Ãxt
 =‚ode->next;

553 ià(
node
 =ğ
quickli¡
->

) {

554 
quickli¡
->

 = 
node
->
´ev
;

557 ià(
node
 =ğ
quickli¡
->
h—d
) {

558 
quickli¡
->
h—d
 = 
node
->
Ãxt
;

563 
	`__quickli¡Com´ess
(
quickli¡
, 
NULL
);

565 
quickli¡
->
couÁ
 -ğ
node
->count;

567 
	`dä“
(
node
->
zl
);

568 
	`dä“
(
node
);

569 
quickli¡
->
Ën
--;

570 
	}
}

580 
REDIS_STATIC
 
	$quickli¡D–Index
(
quickli¡
 *quickli¡, 
quickli¡Node
 *
node
,

581 **
p
) {

582 
gÚe
 = 0;

584 
node
->
zl
 = 
	`zli¡D–‘e
Òode->zl, 
p
);

585 
node
->
couÁ
--;

586 ià(
node
->
couÁ
 == 0) {

587 
gÚe
 = 1;

588 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

590 
	`quickli¡NodeUpd©eSz
(
node
);

592 
quickli¡
->
couÁ
--;

594  
gÚe
 ? 1 : 0;

595 
	}
}

601 
	$quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

602 
quickli¡Node
 *
´ev
 = 
’Œy
->
node
->prev;

603 
quickli¡Node
 *
Ãxt
 = 
’Œy
->
node
->next;

604 
d–‘ed_node
 = 
	`quickli¡D–Index
((
quickli¡
 *)
’Œy
->quicklist,

605 
’Œy
->
node
, &’Œy->
zi
);

608 
™”
->
zi
 = 
NULL
;

611 ià(
d–‘ed_node
) {

612 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

613 
™”
->
cu¼’t
 = 
Ãxt
;

614 
™”
->
off£t
 = 0;

615 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

616 
™”
->
cu¼’t
 = 
´ev
;

617 
™”
->
off£t
 = -1;

628 
	}
}

634 
	$quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

635 
sz
) {

636 
quickli¡EÁry
 
’Œy
;

637 ià(
	`lik–y
(
	`quickli¡Index
(
quickli¡
, 
šdex
, &
’Œy
))) {

639 
’Œy
.
node
->
zl
 = 
	`zli¡D–‘e
ÓÁry.node->zl, &’Œy.
zi
);

640 
’Œy
.
node
->
zl
 = 
	`zli¡In£¹
ÓÁry.node->zl,ƒÁry.
zi
, 
d©a
, 
sz
);

641 
	`quickli¡Com´ess
(
quickli¡
, 
’Œy
.
node
);

646 
	}
}

661 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡Zli¡M”ge
(
quickli¡
 *quicklist,

662 
quickli¡Node
 *
a
,

663 
quickli¡Node
 *
b
) {

664 
	`D
("Reque¡ed m”g×,bè(%u, %u)", 
a
->
couÁ
, 
b
->count);

666 
	`quickli¡Decom´essNode
(
a
);

667 
	`quickli¡Decom´essNode
(
b
);

668 ià((
	`zli¡M”ge
(&
a
->
zl
, &
b
->zl))) {

670 
quickli¡Node
 *
k“p
 = 
NULL
, *
nok“p
 = NULL;

671 ià(!
a
->
zl
) {

672 
nok“p
 = 
a
;

673 
k“p
 = 
b
;

674 } ià(!
b
->
zl
) {

675 
nok“p
 = 
b
;

676 
k“p
 = 
a
;

678 
k“p
->
couÁ
 = 
	`zli¡L’
(k“p->
zl
);

679 
	`quickli¡NodeUpd©eSz
(
k“p
);

681 
nok“p
->
couÁ
 = 0;

682 
	`__quickli¡D–Node
(
quickli¡
, 
nok“p
);

683 
	`quickli¡Com´ess
(
quickli¡
, 
k“p
);

684  
k“p
;

687  
NULL
;

689 
	}
}

699 
REDIS_STATIC
 
	$_quickli¡M”geNodes
(
quickli¡
 *quicklist,

700 
quickli¡Node
 *
ûÁ”
) {

701 
fl
 = 
quickli¡
->fill;

702 
quickli¡Node
 *
´ev
, *
´ev_´ev
, *
Ãxt
, *
Ãxt_Ãxt
, *
rg‘
;

703 
´ev
 = 
´ev_´ev
 = 
Ãxt
 = 
Ãxt_Ãxt
 = 
rg‘
 = 
NULL
;

705 ià(
ûÁ”
->
´ev
) {

706 
´ev
 = 
ûÁ”
->prev;

707 ià(
ûÁ”
->
´ev
->prev)

708 
´ev_´ev
 = 
ûÁ”
->
´ev
->prev;

711 ià(
ûÁ”
->
Ãxt
) {

712 
Ãxt
 = 
ûÁ”
->next;

713 ià(
ûÁ”
->
Ãxt
->next)

714 
Ãxt_Ãxt
 = 
ûÁ”
->
Ãxt
->next;

718 ià(
	`_quickli¡NodeAÎowM”ge
(
´ev
, 
´ev_´ev
, 
fl
)) {

719 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
´ev_´ev
, 
´ev
);

720 
´ev_´ev
 = 
´ev
 = 
NULL
;

724 ià(
	`_quickli¡NodeAÎowM”ge
(
Ãxt
, 
Ãxt_Ãxt
, 
fl
)) {

725 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
Ãxt
, 
Ãxt_Ãxt
);

726 
Ãxt
 = 
Ãxt_Ãxt
 = 
NULL
;

730 ià(
	`_quickli¡NodeAÎowM”ge
(
ûÁ”
, c’‹r->
´ev
, 
fl
)) {

731 
rg‘
 = 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
ûÁ”
->
´ev
, center);

732 
ûÁ”
 = 
NULL
;

735 
rg‘
 = 
ûÁ”
;

739 ià(
	`_quickli¡NodeAÎowM”ge
(
rg‘
,¬g‘->
Ãxt
, 
fl
)) {

740 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
rg‘
,¬g‘->
Ãxt
);

742 
	}
}

763 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡S¶™Node
(
quickli¡Node
 *
node
, 
off£t
,

764 
aá”
) {

765 
size_t
 
zl_sz
 = 
node
->
sz
;

767 
quickli¡Node
 *
Ãw_node
 = 
	`quickli¡C»©eNode
();

768 
Ãw_node
->
zl
 = 
	`d®loc
(
zl_sz
);

771 
	`memıy
(
Ãw_node
->
zl
, 
node
->zl, 
zl_sz
);

774 
Üig_¡¬t
 = 
aá”
 ? 
off£t
 + 1 : 0;

775 
Üig_ex‹Á
 = 
aá”
 ? -1 : 
off£t
;

776 
Ãw_¡¬t
 = 
aá”
 ? 0 : 
off£t
;

777 
Ãw_ex‹Á
 = 
aá”
 ? 
off£t
 + 1 : -1;

779 
	`D
("Aá” %d (%d);„ªges: [%d, %d], [%d, %d]", 
aá”
, 
off£t
, 
Üig_¡¬t
,

780 
Üig_ex‹Á
, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

782 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
Üig_¡¬t
, 
Üig_ex‹Á
);

783 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

784 
	`quickli¡NodeUpd©eSz
(
node
);

786 
Ãw_node
->
zl
 = 
	`zli¡D–‘eRªge
Òew_node->zl, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

787 
Ãw_node
->
couÁ
 = 
	`zli¡L’
Òew_node->
zl
);

788 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

790 
	`D
("Aá” s¶™†’gths: orig (%d),‚ew (%d)", 
node
->
couÁ
, 
Ãw_node
->count);

791  
Ãw_node
;

792 
	}
}

798 
REDIS_STATIC
 
	$_quickli¡In£¹
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

799 *
v®ue
, cÚ¡ 
size_t
 
sz
, 
aá”
) {

800 
fuÎ
 = 0, 
©_
 = 0, 
©_h—d
 = 0, 
fuÎ_Ãxt
 = 0, 
fuÎ_´ev
 = 0;

801 
fl
 = 
quickli¡
->fill;

802 
quickli¡Node
 *
node
 = 
’Œy
->node;

803 
quickli¡Node
 *
Ãw_node
 = 
NULL
;

805 ià(!
node
) {

807 
	`D
("No‚ode given!");

808 
Ãw_node
 = 
	`quickli¡C»©eNode
();

809 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

810 
	`__quickli¡In£¹Node
(
quickli¡
, 
NULL
, 
Ãw_node
, 
aá”
);

811 
Ãw_node
->
couÁ
++;

812 
quickli¡
->
couÁ
++;

817 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
, 
fl
, 
sz
)) {

818 
	`D
("Current‚ode is full with count %d with„equested fill %lu",

819 
node
->
couÁ
, 
fl
);

820 
fuÎ
 = 1;

823 ià(
aá”
 && (
’Œy
->
off£t
 =ğ
node
->
couÁ
)) {

824 
	`D
("At Tail of current ziplist");

825 
©_
 = 1;

826 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
Ãxt
, 
fl
, 
sz
)) {

827 
	`D
("Next‚ode is fulloo.");

828 
fuÎ_Ãxt
 = 1;

832 ià(!
aá”
 && (
’Œy
->
off£t
 == 0)) {

833 
	`D
("At Head");

834 
©_h—d
 = 1;

835 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
´ev
, 
fl
, 
sz
)) {

836 
	`D
("Prev‚ode is fulloo.");

837 
fuÎ_´ev
 = 1;

842 ià(!
fuÎ
 && 
aá”
) {

843 
	`D
("Not full, inserting‡fter current…osition.");

844 
	`quickli¡Decom´essNodeFÜU£
(
node
);

845 *
Ãxt
 = 
	`zli¡Next
(
node
->
zl
, 
’Œy
->
zi
);

846 ià(
Ãxt
 =ğ
NULL
) {

847 
node
->
zl
 = 
	`zli¡Push
Òode->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

849 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
Ãxt
, 
v®ue
, 
sz
);

851 
node
->
couÁ
++;

852 
	`quickli¡NodeUpd©eSz
(
node
);

853 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

854 } ià(!
fuÎ
 && !
aá”
) {

855 
	`D
("Not full, inserting before current…osition.");

856 
	`quickli¡Decom´essNodeFÜU£
(
node
);

857 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
’Œy
->
zi
, 
v®ue
, 
sz
);

858 
node
->
couÁ
++;

859 
	`quickli¡NodeUpd©eSz
(
node
);

860 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

861 } ià(
fuÎ
 && 
©_
 && 
node
->
Ãxt
 && !
fuÎ_Ãxt
 && 
aá”
) {

864 
	`D
("Full‡ndail, but‚ext isn't full; inserting‚ext‚ode head");

865 
Ãw_node
 = 
node
->
Ãxt
;

866 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

867 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

868 
Ãw_node
->
couÁ
++;

869 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

870 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

871 } ià(
fuÎ
 && 
©_h—d
 && 
node
->
´ev
 && !
fuÎ_´ev
 && !
aá”
) {

874 
	`D
("Full‡nd head, but…rev isn't full, inserting…rev‚odeail");

875 
Ãw_node
 = 
node
->
´ev
;

876 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

877 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

878 
Ãw_node
->
couÁ
++;

879 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

880 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

881 } ià(
fuÎ
 && ((
©_
 && 
node
->
Ãxt
 && 
fuÎ_Ãxt
 && 
aá”
) ||

882 (
©_h—d
 && 
node
->
´ev
 && 
fuÎ_´ev
 && !
aá”
))) {

885 
	`D
("\tprovisioning‚ew‚ode...");

886 
Ãw_node
 = 
	`quickli¡C»©eNode
();

887 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

888 
Ãw_node
->
couÁ
++;

889 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

890 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

891 } ià(
fuÎ
) {

894 
	`D
("\tsplitting‚ode...");

895 
	`quickli¡Decom´essNodeFÜU£
(
node
);

896 
Ãw_node
 = 
	`_quickli¡S¶™Node
(
node
, 
’Œy
->
off£t
, 
aá”
);

897 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
,

898 
aá”
 ? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
);

899 
Ãw_node
->
couÁ
++;

900 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

901 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

902 
	`_quickli¡M”geNodes
(
quickli¡
, 
node
);

905 
quickli¡
->
couÁ
++;

906 
	}
}

908 
	$quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

909 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

910 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 0);

911 
	}
}

913 
	$quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

914 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

915 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 1);

916 
	}
}

924 
	$quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
,

925 cÚ¡ 
couÁ
) {

926 ià(
couÁ
 <= 0)

929 
ex‹Á
 = 
couÁ
;

931 ià(
¡¬t
 >ğ0 && 
ex‹Á
 > (
quickli¡
->
couÁ
 - start)) {

933 
ex‹Á
 = 
quickli¡
->
couÁ
 - 
¡¬t
;

934 } ià(
¡¬t
 < 0 && 
ex‹Á
 > ()(-start)) {

936 
ex‹Á
 = -
¡¬t
;

939 
quickli¡EÁry
 
’Œy
;

940 ià(!
	`quickli¡Index
(
quickli¡
, 
¡¬t
, &
’Œy
))

943 
	`D
("Quickli¡ d–‘»que¡ fÜ s¹ %ld, couÁ %ld,ƒx‹Á: %ld", 
¡¬t
,

944 
couÁ
, 
ex‹Á
);

945 
quickli¡Node
 *
node
 = 
’Œy
.node;

948 
ex‹Á
) {

949 
quickli¡Node
 *
Ãxt
 = 
node
->next;

951 
d–
;

952 
d–‘e_’tœe_node
 = 0;

953 ià(
’Œy
.
off£t
 =ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

956 
d–‘e_’tœe_node
 = 1;

957 
d–
 = 
node
->
couÁ
;

958 } ià(
’Œy
.
off£t
 >ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

961 
d–
 = 
node
->
couÁ
 - 
’Œy
.
off£t
;

962 } ià(
’Œy
.
off£t
 < 0) {

968 
d–
 = -
’Œy
.
off£t
;

973 ià(
d–
 > 
ex‹Á
)

974 
d–
 = 
ex‹Á
;

978 
d–
 = 
ex‹Á
;

981 
	`D
("[%ld]:‡skingo del: %ld because offset: %d; (ENTIRE NODE: %d), "

983 
ex‹Á
, 
d–
, 
’Œy
.
off£t
, 
d–‘e_’tœe_node
, 
node
->
couÁ
);

985 ià(
d–‘e_’tœe_node
) {

986 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

988 
	`quickli¡Decom´essNodeFÜU£
(
node
);

989 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
’Œy
.
off£t
, 
d–
);

990 
	`quickli¡NodeUpd©eSz
(
node
);

991 
node
->
couÁ
 -ğ
d–
;

992 
quickli¡
->
couÁ
 -ğ
d–
;

993 
	`quickli¡D–‘eIfEm±y
(
quickli¡
, 
node
);

994 ià(
node
)

995 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

998 
ex‹Á
 -ğ
d–
;

1000 
node
 = 
Ãxt
;

1002 
’Œy
.
off£t
 = 0;

1005 
	}
}

1008 
	$quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
) {

1009  
	`zli¡Com·»
(
p1
, 
p2
, 
p2_Ën
);

1010 
	}
}

1014 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
) {

1015 
quickli¡I‹r
 *
™”
;

1017 
™”
 = 
	`d®loc
((*iter));

1019 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1020 
™”
->
cu¼’t
 = 
quickli¡
->
h—d
;

1021 
™”
->
off£t
 = 0;

1022 } ià(
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1023 
™”
->
cu¼’t
 = 
quickli¡
->

;

1024 
™”
->
off£t
 = -1;

1027 
™”
->
dœeùiÚ
 = direction;

1028 
™”
->
quickli¡
 = quicklist;

1030 
™”
->
zi
 = 
NULL
;

1032  
™”
;

1033 
	}
}

1037 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

1038 cÚ¡ 
dœeùiÚ
,

1039 cÚ¡ 
idx
) {

1040 
quickli¡EÁry
 
’Œy
;

1042 ià(
	`quickli¡Index
(
quickli¡
, 
idx
, &
’Œy
)) {

1043 
quickli¡I‹r
 *
ba£
 = 
	`quickli¡G‘I‹¿tÜ
(
quickli¡
, 
dœeùiÚ
);

1044 
ba£
->
zi
 = 
NULL
;

1045 
ba£
->
cu¼’t
 = 
’Œy
.
node
;

1046 
ba£
->
off£t
 = 
’Œy
.offset;

1047  
ba£
;

1049  
NULL
;

1051 
	}
}

1055 
	$quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
) {

1056 ià(
™”
->
cu¼’t
)

1057 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1059 
	`dä“
(
™”
);

1060 
	}
}

1083 
	$quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

1084 
	`š™EÁry
(
’Œy
);

1086 ià(!
™”
) {

1087 
	`D
("Returning because‚o iter!");

1091 
’Œy
->
quickli¡
 = 
™”
->quicklist;

1092 
’Œy
->
node
 = 
™”
->
cu¼’t
;

1094 ià(!
™”
->
cu¼’t
) {

1095 
	`D
("Returning because current‚ode is NULL")

1099 *(*
ÃxtFn
)(*, *èğ
NULL
;

1100 
off£t_upd©e
 = 0;

1102 ià(!
™”
->
zi
) {

1104 
	`quickli¡Decom´essNodeFÜU£
(
™”
->
cu¼’t
);

1105 
™”
->
zi
 = 
	`zli¡Index
(™”->
cu¼’t
->
zl
, i‹r->
off£t
);

1108 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1109 
ÃxtFn
 = 
zli¡Next
;

1110 
off£t_upd©e
 = 1;

1111 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1112 
ÃxtFn
 = 
zli¡P»v
;

1113 
off£t_upd©e
 = -1;

1115 
™”
->
zi
 = 
	`ÃxtFn
(™”->
cu¼’t
->
zl
, iter->zi);

1116 
™”
->
off£t
 +ğ
off£t_upd©e
;

1119 
’Œy
->
zi
 = 
™”
->zi;

1120 
’Œy
->
off£t
 = 
™”
->offset;

1122 ià(
™”
->
zi
) {

1124 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1129 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1130 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1132 
	`D
("Jumpingo start of‚ext‚ode");

1133 
™”
->
cu¼’t
 = i‹r->cu¼’t->
Ãxt
;

1134 
™”
->
off£t
 = 0;

1135 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1137 
	`D
("Jumpingoƒnd of…revious‚ode");

1138 
™”
->
cu¼’t
 = i‹r->cu¼’t->
´ev
;

1139 
™”
->
off£t
 = -1;

1141 
™”
->
zi
 = 
NULL
;

1142  
	`quickli¡Next
(
™”
, 
’Œy
);

1144 
	}
}

1152 
quickli¡
 *
	$quickli¡Dup
(
quickli¡
 *
Üig
) {

1153 
quickli¡
 *
cİy
;

1154 
quickli¡Node
 *
cu¼’t
;

1156 
cİy
 = 
	`quickli¡New
(
Üig
->
fl
, orig->
com´ess
);

1158 
cu¼’t
 = 
Üig
->
h—d
; current;

1159 
cu¼’t
 = cu¼’t->
Ãxt
) {

1160 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

1162 ià(
node
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) {

1163 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

1164 
size_t
 
lzf_sz
 = (*
lzf
è+†zf->
sz
;

1165 
node
->
zl
 = 
	`d®loc
(
lzf_sz
);

1166 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, 
lzf_sz
);

1167 } ià(
node
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) {

1168 
node
->
zl
 = 
	`d®loc
(
cu¼’t
->
sz
);

1169 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, cu¼’t->
sz
);

1172 
node
->
couÁ
 = 
cu¼’t
->count;

1173 
cİy
->
couÁ
 +ğ
node
->count;

1174 
node
->
sz
 = 
cu¼’t
->sz;

1175 
node
->
’codšg
 = 
cu¼’t
->encoding;

1177 
	`_quickli¡In£¹NodeAá”
(
cİy
, cİy->

, 
node
);

1181  
cİy
;

1182 
	}
}

1192 
	$quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
idx
,

1193 
quickli¡EÁry
 *
’Œy
) {

1194 
quickli¡Node
 *
n
;

1195 
accum
 = 0;

1196 
šdex
;

1197 
fÜw¬d
 = 
idx
 < 0 ? 0 : 1;

1199 
	`š™EÁry
(
’Œy
);

1200 
’Œy
->
quickli¡
 = quicklist;

1202 ià(!
fÜw¬d
) {

1203 
šdex
 = (-
idx
) - 1;

1204 
n
 = 
quickli¡
->

;

1206 
šdex
 = 
idx
;

1207 
n
 = 
quickli¡
->
h—d
;

1210 ià(
šdex
 >ğ
quickli¡
->
couÁ
)

1213 
	`lik–y
(
n
)) {

1214 ià((
accum
 + 
n
->
couÁ
è> 
šdex
) {

1217 
	`D
("Skpšg ov” (%pè%u‡ˆaccum %Îd", (*)
n
,‚->
couÁ
,

1218 
accum
);

1219 
accum
 +ğ
n
->
couÁ
;

1220 
n
 = 
fÜw¬d
 ?‚->
Ãxt
 :‚->
´ev
;

1224 ià(!
n
)

1227 
	`D
("Found‚ode: %°©‡ccum %Îu, idx %Îu, sub+ %Îu, sub- %Îu", (*)
n
,

1228 
accum
, 
šdex
, index -‡ccum, (-index) - 1 +‡ccum);

1230 
’Œy
->
node
 = 
n
;

1231 ià(
fÜw¬d
) {

1233 
’Œy
->
off£t
 = 
šdex
 - 
accum
;

1237 
’Œy
->
off£t
 = (-
šdex
è- 1 + 
accum
;

1240 
	`quickli¡Decom´essNodeFÜU£
(
’Œy
->
node
);

1241 
’Œy
->
zi
 = 
	`zli¡Index
ÓÁry->
node
->
zl
,ƒÁry->
off£t
);

1242 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1246 
	}
}

1249 
	$quickli¡RÙ©e
(
quickli¡
 *quicklist) {

1250 ià(
quickli¡
->
couÁ
 <= 1)

1254 *
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1255 *
v®ue
;

1256 
lÚgv®
;

1257 
sz
;

1258 
lÚg¡r
[32] = {0};

1259 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
);

1262 ià(!
v®ue
) {

1264 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

1265 
v®ue
 = (*)
lÚg¡r
;

1269 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1274 ià(
quickli¡
->
Ën
 == 1) {

1275 
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1279 
	`quickli¡D–Index
(
quickli¡
, quickli¡->

, &
p
);

1280 
	}
}

1291 
	$quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1292 *
sz
, *
sv®
,

1293 *(*
§v”
)(*
d©a
, 
sz
)) {

1294 *
p
;

1295 *
v¡r
;

1296 
vËn
;

1297 
vlÚg
;

1298 
pos
 = (
wh”e
 =ğ
QUICKLIST_HEAD
) ? 0 : -1;

1300 ià(
quickli¡
->
couÁ
 == 0)

1303 ià(
d©a
)

1304 *
d©a
 = 
NULL
;

1305 ià(
sz
)

1306 *
sz
 = 0;

1307 ià(
sv®
)

1308 *
sv®
 = -123456789;

1310 
quickli¡Node
 *
node
;

1311 ià(
wh”e
 =ğ
QUICKLIST_HEAD
 && 
quickli¡
->
h—d
) {

1312 
node
 = 
quickli¡
->
h—d
;

1313 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
 && 
quickli¡
->

) {

1314 
node
 = 
quickli¡
->

;

1319 
p
 = 
	`zli¡Index
(
node
->
zl
, 
pos
);

1320 ià(
	`zli¡G‘
(
p
, &
v¡r
, &
vËn
, &
vlÚg
)) {

1321 ià(
v¡r
) {

1322 ià(
d©a
)

1323 *
d©a
 = 
	`§v”
(
v¡r
, 
vËn
);

1324 ià(
sz
)

1325 *
sz
 = 
vËn
;

1327 ià(
d©a
)

1328 *
d©a
 = 
NULL
;

1329 ià(
sv®
)

1330 *
sv®
 = 
vlÚg
;

1332 
	`quickli¡D–Index
(
quickli¡
, 
node
, &
p
);

1336 
	}
}

1339 
REDIS_STATIC
 *
	$_quickli¡Sav”
(*
d©a
, 
sz
) {

1340 *
v¡r
;

1341 ià(
d©a
) {

1342 
v¡r
 = 
	`d®loc
(
sz
);

1343 
	`memıy
(
v¡r
, 
d©a
, 
sz
);

1344  
v¡r
;

1346  
NULL
;

1347 
	}
}

1352 
	$quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1353 *
sz
, *
¦Úg
) {

1354 *
v¡r
;

1355 
vËn
;

1356 
vlÚg
;

1357 ià(
quickli¡
->
couÁ
 == 0)

1359 
»t
 = 
	`quickli¡PİCu¡om
(
quickli¡
, 
wh”e
, &
v¡r
, &
vËn
, &
vlÚg
,

1360 
_quickli¡Sav”
);

1361 ià(
d©a
)

1362 *
d©a
 = 
v¡r
;

1363 ià(
¦Úg
)

1364 *
¦Úg
 = 
vlÚg
;

1365 ià(
sz
)

1366 *
sz
 = 
vËn
;

1367  
»t
;

1368 
	}
}

1371 
	$quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

1372 
wh”e
) {

1373 ià(
wh”e
 =ğ
QUICKLIST_HEAD
) {

1374 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1375 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
) {

1376 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

1378 
	}
}

	@src/vr_quicklist.h

1 #iâdeà
_VR_QUICKLIST_H_


2 
	#_VR_QUICKLIST_H_


	)

14 
	squickli¡Node
 {

15 
quickli¡Node
 *
	m´ev
;

16 
quickli¡Node
 *
	mÃxt
;

17 *
	mzl
;

18 
	msz
;

19 
	mcouÁ
 : 16;

20 
	m’codšg
 : 2;

21 
	mcÚš”
 : 2;

22 
	m»com´ess
 : 1;

23 
	m©‹m±ed_com´ess
 : 1;

24 
	mexŒa
 : 10;

25 } 
	tquickli¡Node
;

32 
	squickli¡LZF
 {

33 
	msz
;

34 
	mcom´es£d
[];

35 } 
	tquickli¡LZF
;

43 
	squickli¡
 {

44 
quickli¡Node
 *
	mh—d
;

45 
quickli¡Node
 *
	m
;

46 
	mcouÁ
;

47 
	mËn
;

48 
	mfl
 : 16;

49 
	mcom´ess
 : 16;

50 } 
	tquickli¡
;

52 
	squickli¡I‹r
 {

53 cÚ¡ 
quickli¡
 *
	mquickli¡
;

54 
quickli¡Node
 *
	mcu¼’t
;

55 *
	mzi
;

56 
	moff£t
;

57 
	mdœeùiÚ
;

58 } 
	tquickli¡I‹r
;

60 
	squickli¡EÁry
 {

61 cÚ¡ 
quickli¡
 *
	mquickli¡
;

62 
quickli¡Node
 *
	mnode
;

63 *
	mzi
;

64 *
	mv®ue
;

65 
	msz
;

66 
	mlÚgv®
;

67 
	moff£t
;

68 } 
	tquickli¡EÁry
;

70 
	#QUICKLIST_HEAD
 0

	)

71 
	#QUICKLIST_TAIL
 -1

	)

74 
	#QUICKLIST_NODE_ENCODING_RAW
 1

	)

75 
	#QUICKLIST_NODE_ENCODING_LZF
 2

	)

78 
	#QUICKLIST_NOCOMPRESS
 0

	)

81 
	#QUICKLIST_NODE_CONTAINER_NONE
 1

	)

82 
	#QUICKLIST_NODE_CONTAINER_ZIPLIST
 2

	)

84 
	#quickli¡NodeIsCom´es£d
(
node
) \

85 ((
node
)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
)

	)

88 
quickli¡
 *
quickli¡C»©e
();

89 
quickli¡
 *
quickli¡New
(
fl
, 
com´ess
);

90 
quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
d•th
);

91 
quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
);

92 
quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
);

93 
quickli¡R–—£
(
quickli¡
 *quicklist);

94 
quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

95 
quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

96 
quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

97 
wh”e
);

98 
quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
);

99 
quickli¡
 *
quickli¡Aµ’dV®uesFromZli¡
(quicklist *quicklist,

100 *
zl
);

101 
quickli¡
 *
quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

102 *
zl
);

103 
quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

104 *
v®ue
, cÚ¡ 
size_t
 
sz
);

105 
quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

106 *
v®ue
, cÚ¡ 
size_t
 
sz
);

107 
quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
);

108 
quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

109 
sz
);

110 
quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
, cÚ¡ 
¡İ
);

111 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
);

112 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

113 
dœeùiÚ
, cÚ¡ 
idx
);

114 
quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
node
);

115 
quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
);

116 
quickli¡
 *
quickli¡Dup
(quickli¡ *
Üig
);

117 
quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
šdex
,

118 
quickli¡EÁry
 *
’Œy
);

119 
quickli¡Rewšd
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

120 
quickli¡RewšdTa
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

121 
quickli¡RÙ©e
(
quickli¡
 *quicklist);

122 
quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

123 *
sz
, *
sv®
,

124 *(*
§v”
)(*
d©a
, 
sz
));

125 
quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

126 *
sz
, *
¦Úg
);

127 
quickli¡CouÁ
(
quickli¡
 *
ql
);

128 
quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
);

129 
size_t
 
quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
);

132 
	#AL_START_HEAD
 0

	)

133 
	#AL_START_TAIL
 1

	)

	@src/vr_quicklist.h

1 #iâdeà
_VR_QUICKLIST_H_


2 
	#_VR_QUICKLIST_H_


	)

14 
	squickli¡Node
 {

15 
quickli¡Node
 *
	m´ev
;

16 
quickli¡Node
 *
	mÃxt
;

17 *
	mzl
;

18 
	msz
;

19 
	mcouÁ
 : 16;

20 
	m’codšg
 : 2;

21 
	mcÚš”
 : 2;

22 
	m»com´ess
 : 1;

23 
	m©‹m±ed_com´ess
 : 1;

24 
	mexŒa
 : 10;

25 } 
	tquickli¡Node
;

32 
	squickli¡LZF
 {

33 
	msz
;

34 
	mcom´es£d
[];

35 } 
	tquickli¡LZF
;

43 
	squickli¡
 {

44 
quickli¡Node
 *
	mh—d
;

45 
quickli¡Node
 *
	m
;

46 
	mcouÁ
;

47 
	mËn
;

48 
	mfl
 : 16;

49 
	mcom´ess
 : 16;

50 } 
	tquickli¡
;

52 
	squickli¡I‹r
 {

53 cÚ¡ 
quickli¡
 *
	mquickli¡
;

54 
quickli¡Node
 *
	mcu¼’t
;

55 *
	mzi
;

56 
	moff£t
;

57 
	mdœeùiÚ
;

58 } 
	tquickli¡I‹r
;

60 
	squickli¡EÁry
 {

61 cÚ¡ 
quickli¡
 *
	mquickli¡
;

62 
quickli¡Node
 *
	mnode
;

63 *
	mzi
;

64 *
	mv®ue
;

65 
	msz
;

66 
	mlÚgv®
;

67 
	moff£t
;

68 } 
	tquickli¡EÁry
;

70 
	#QUICKLIST_HEAD
 0

	)

71 
	#QUICKLIST_TAIL
 -1

	)

74 
	#QUICKLIST_NODE_ENCODING_RAW
 1

	)

75 
	#QUICKLIST_NODE_ENCODING_LZF
 2

	)

78 
	#QUICKLIST_NOCOMPRESS
 0

	)

81 
	#QUICKLIST_NODE_CONTAINER_NONE
 1

	)

82 
	#QUICKLIST_NODE_CONTAINER_ZIPLIST
 2

	)

84 
	#quickli¡NodeIsCom´es£d
(
node
) \

85 ((
node
)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
)

	)

88 
quickli¡
 *
quickli¡C»©e
();

89 
quickli¡
 *
quickli¡New
(
fl
, 
com´ess
);

90 
quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
d•th
);

91 
quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
);

92 
quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
);

93 
quickli¡R–—£
(
quickli¡
 *quicklist);

94 
quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

95 
quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

96 
quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

97 
wh”e
);

98 
quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
);

99 
quickli¡
 *
quickli¡Aµ’dV®uesFromZli¡
(quicklist *quicklist,

100 *
zl
);

101 
quickli¡
 *
quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

102 *
zl
);

103 
quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

104 *
v®ue
, cÚ¡ 
size_t
 
sz
);

105 
quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

106 *
v®ue
, cÚ¡ 
size_t
 
sz
);

107 
quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
);

108 
quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

109 
sz
);

110 
quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
, cÚ¡ 
¡İ
);

111 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
);

112 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

113 
dœeùiÚ
, cÚ¡ 
idx
);

114 
quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
node
);

115 
quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
);

116 
quickli¡
 *
quickli¡Dup
(quickli¡ *
Üig
);

117 
quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
šdex
,

118 
quickli¡EÁry
 *
’Œy
);

119 
quickli¡Rewšd
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

120 
quickli¡RewšdTa
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

121 
quickli¡RÙ©e
(
quickli¡
 *quicklist);

122 
quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

123 *
sz
, *
sv®
,

124 *(*
§v”
)(*
d©a
, 
sz
));

125 
quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

126 *
sz
, *
¦Úg
);

127 
quickli¡CouÁ
(
quickli¡
 *
ql
);

128 
quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
);

129 
size_t
 
quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
);

132 
	#AL_START_HEAD
 0

	)

133 
	#AL_START_TAIL
 1

	)

	@src/vr_rbtree.c

1 
	~<vr_cÜe.h
>

4 
	$rbŒ“_node_š™
(
rbnode
 *
node
)

6 
node
->
Ëá
 = 
NULL
;

7 
node
->
right
 = 
NULL
;

8 
node
->
·»Á
 = 
NULL
;

9 
node
->
key
 = 0ULL;

10 
node
->
d©a
 = 
NULL
;

12 
	}
}

15 
	$rbŒ“_š™
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
)

17 
	`rbŒ“_node_š™
(
node
);

18 
	`rbŒ“_bÏck
(
node
);

19 
Œ“
->
roÙ
 = 
node
;

20 
Œ“
->
£Áš–
 = 
node
;

21 
	}
}

23 
rbnode
 *

24 
	$rbŒ“_node_mš
(
rbnode
 *
node
, rbnod*
£Áš–
)

28 
node
->
Ëá
 !ğ
£Áš–
) {

29 
node
 =‚ode->
Ëá
;

32  
node
;

33 
	}
}

35 
rbnode
 *

36 
	$rbŒ“_mš
(
rbŒ“
 *
Œ“
)

38 
rbnode
 *
node
 = 
Œ“
->
roÙ
;

39 
rbnode
 *
£Áš–
 = 
Œ“
->sentinel;

43 ià(
node
 =ğ
£Áš–
) {

44  
NULL
;

47  
	`rbŒ“_node_mš
(
node
, 
£Áš–
);

48 
	}
}

51 
	$rbŒ“_Ëá_rÙ©e
(
rbnode
 **
roÙ
, rbnod*
£Áš–
,

52 
rbnode
 *
node
)

54 
rbnode
 *
‹mp
;

56 
‹mp
 = 
node
->
right
;

57 
node
->
right
 = 
‹mp
->
Ëá
;

59 ià(
‹mp
->
Ëá
 !ğ
£Áš–
) {

60 
‹mp
->
Ëá
->
·»Á
 = 
node
;

63 
‹mp
->
·»Á
 = 
node
->parent;

65 ià(
node
 =ğ*
roÙ
) {

66 *
roÙ
 = 
‹mp
;

67 } ià(
node
 =ğnode->
·»Á
->
Ëá
) {

68 
node
->
·»Á
->
Ëá
 = 
‹mp
;

70 
node
->
·»Á
->
right
 = 
‹mp
;

73 
‹mp
->
Ëá
 = 
node
;

74 
node
->
·»Á
 = 
‹mp
;

75 
	}
}

78 
	$rbŒ“_right_rÙ©e
(
rbnode
 **
roÙ
, rbnod*
£Áš–
,

79 
rbnode
 *
node
)

81 
rbnode
 *
‹mp
;

83 
‹mp
 = 
node
->
Ëá
;

84 
node
->
Ëá
 = 
‹mp
->
right
;

86 ià(
‹mp
->
right
 !ğ
£Áš–
) {

87 
‹mp
->
right
->
·»Á
 = 
node
;

90 
‹mp
->
·»Á
 = 
node
->parent;

92 ià(
node
 =ğ*
roÙ
) {

93 *
roÙ
 = 
‹mp
;

94 } ià(
node
 =ğnode->
·»Á
->
right
) {

95 
node
->
·»Á
->
right
 = 
‹mp
;

97 
node
->
·»Á
->
Ëá
 = 
‹mp
;

100 
‹mp
->
right
 = 
node
;

101 
node
->
·»Á
 = 
‹mp
;

102 
	}
}

105 
	$rbŒ“_š£¹
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
)

107 
rbnode
 **
roÙ
 = &
Œ“
->root;

108 
rbnode
 *
£Áš–
 = 
Œ“
->sentinel;

109 
rbnode
 *
‹mp
, **
p
;

113 ià(*
roÙ
 =ğ
£Áš–
) {

114 
node
->
·»Á
 = 
NULL
;

115 
node
->
Ëá
 = 
£Áš–
;

116 
node
->
right
 = 
£Áš–
;

117 
	`rbŒ“_bÏck
(
node
);

118 *
roÙ
 = 
node
;

124 
‹mp
 = *
roÙ
;

127 
p
 = (
node
->
key
 < 
‹mp
->keyè? &‹mp->
Ëá
 : &‹mp->
right
;

128 ià(*
p
 =ğ
£Áš–
) {

131 
‹mp
 = *
p
;

134 *
p
 = 
node
;

135 
node
->
·»Á
 = 
‹mp
;

136 
node
->
Ëá
 = 
£Áš–
;

137 
node
->
right
 = 
£Áš–
;

138 
	`rbŒ“_»d
(
node
);

142 
node
 !ğ*
roÙ
 && 
	`rbŒ“_is_»d
Òode->
·»Á
)) {

144 ià(
node
->
·»Á
 =ğnode->·»Á->·»Á->
Ëá
) {

145 
‹mp
 = 
node
->
·»Á
->·»Á->
right
;

147 ià(
	`rbŒ“_is_»d
(
‹mp
)) {

148 
	`rbŒ“_bÏck
(
node
->
·»Á
);

149 
	`rbŒ“_bÏck
(
‹mp
);

150 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

151 
node
 =‚ode->
·»Á
->parent;

153 ià(
node
 =ğnode->
·»Á
->
right
) {

154 
node
 =‚ode->
·»Á
;

155 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
node
);

158 
	`rbŒ“_bÏck
(
node
->
·»Á
);

159 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

160 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
node
->
·»Á
->parent);

163 
‹mp
 = 
node
->
·»Á
->·»Á->
Ëá
;

165 ià(
	`rbŒ“_is_»d
(
‹mp
)) {

166 
	`rbŒ“_bÏck
(
node
->
·»Á
);

167 
	`rbŒ“_bÏck
(
‹mp
);

168 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

169 
node
 =‚ode->
·»Á
->parent;

171 ià(
node
 =ğnode->
·»Á
->
Ëá
) {

172 
node
 =‚ode->
·»Á
;

173 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
node
);

176 
	`rbŒ“_bÏck
(
node
->
·»Á
);

177 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

178 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
node
->
·»Á
->parent);

183 
	`rbŒ“_bÏck
(*
roÙ
);

184 
	}
}

187 
	$rbŒ“_d–‘e
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
)

189 
rbnode
 **
roÙ
 = &
Œ“
->root;

190 
rbnode
 *
£Áš–
 = 
Œ“
->sentinel;

191 
rbnode
 *
sub¡
, *
‹mp
, *
w
;

192 
ušt8_t
 
»d
;

196 ià(
node
->
Ëá
 =ğ
£Áš–
) {

197 
‹mp
 = 
node
->
right
;

198 
sub¡
 = 
node
;

199 } ià(
node
->
right
 =ğ
£Áš–
) {

200 
‹mp
 = 
node
->
Ëá
;

201 
sub¡
 = 
node
;

203 
sub¡
 = 
	`rbŒ“_node_mš
(
node
->
right
, 
£Áš–
);

204 
‹mp
 = 
sub¡
->
right
;

207 ià(
sub¡
 =ğ*
roÙ
) {

208 *
roÙ
 = 
‹mp
;

209 
	`rbŒ“_bÏck
(
‹mp
);

211 
	`rbŒ“_node_š™
(
node
);

216 
»d
 = 
	`rbŒ“_is_»d
(
sub¡
);

218 ià(
sub¡
 =ğsub¡->
·»Á
->
Ëá
) {

219 
sub¡
->
·»Á
->
Ëá
 = 
‹mp
;

221 
sub¡
->
·»Á
->
right
 = 
‹mp
;

224 ià(
sub¡
 =ğ
node
) {

225 
‹mp
->
·»Á
 = 
sub¡
->parent;

228 ià(
sub¡
->
·»Á
 =ğ
node
) {

229 
‹mp
->
·»Á
 = 
sub¡
;

231 
‹mp
->
·»Á
 = 
sub¡
->parent;

234 
sub¡
->
Ëá
 = 
node
->left;

235 
sub¡
->
right
 = 
node
->right;

236 
sub¡
->
·»Á
 = 
node
->parent;

237 
	`rbŒ“_cİy_cŞÜ
(
sub¡
, 
node
);

239 ià(
node
 =ğ*
roÙ
) {

240 *
roÙ
 = 
sub¡
;

242 ià(
node
 =ğnode->
·»Á
->
Ëá
) {

243 
node
->
·»Á
->
Ëá
 = 
sub¡
;

245 
node
->
·»Á
->
right
 = 
sub¡
;

249 ià(
sub¡
->
Ëá
 !ğ
£Áš–
) {

250 
sub¡
->
Ëá
->
·»Á
 = subst;

253 ià(
sub¡
->
right
 !ğ
£Áš–
) {

254 
sub¡
->
right
->
·»Á
 = subst;

258 
	`rbŒ“_node_š™
(
node
);

260 ià(
»d
) {

266 
‹mp
 !ğ*
roÙ
 && 
	`rbŒ“_is_bÏck
(temp)) {

268 ià(
‹mp
 =ğ‹mp->
·»Á
->
Ëá
) {

269 
w
 = 
‹mp
->
·»Á
->
right
;

271 ià(
	`rbŒ“_is_»d
(
w
)) {

272 
	`rbŒ“_bÏck
(
w
);

273 
	`rbŒ“_»d
(
‹mp
->
·»Á
);

274 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

275 
w
 = 
‹mp
->
·»Á
->
right
;

278 ià(
	`rbŒ“_is_bÏck
(
w
->
Ëá
è&&„bŒ“_is_bÏck(w->
right
)) {

279 
	`rbŒ“_»d
(
w
);

280 
‹mp
 =emp->
·»Á
;

282 ià(
	`rbŒ“_is_bÏck
(
w
->
right
)) {

283 
	`rbŒ“_bÏck
(
w
->
Ëá
);

284 
	`rbŒ“_»d
(
w
);

285 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
w
);

286 
w
 = 
‹mp
->
·»Á
->
right
;

289 
	`rbŒ“_cİy_cŞÜ
(
w
, 
‹mp
->
·»Á
);

290 
	`rbŒ“_bÏck
(
‹mp
->
·»Á
);

291 
	`rbŒ“_bÏck
(
w
->
right
);

292 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

293 
‹mp
 = *
roÙ
;

297 
w
 = 
‹mp
->
·»Á
->
Ëá
;

299 ià(
	`rbŒ“_is_»d
(
w
)) {

300 
	`rbŒ“_bÏck
(
w
);

301 
	`rbŒ“_»d
(
‹mp
->
·»Á
);

302 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

303 
w
 = 
‹mp
->
·»Á
->
Ëá
;

306 ià(
	`rbŒ“_is_bÏck
(
w
->
Ëá
è&&„bŒ“_is_bÏck(w->
right
)) {

307 
	`rbŒ“_»d
(
w
);

308 
‹mp
 =emp->
·»Á
;

310 ià(
	`rbŒ“_is_bÏck
(
w
->
Ëá
)) {

311 
	`rbŒ“_bÏck
(
w
->
right
);

312 
	`rbŒ“_»d
(
w
);

313 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
w
);

314 
w
 = 
‹mp
->
·»Á
->
Ëá
;

317 
	`rbŒ“_cİy_cŞÜ
(
w
, 
‹mp
->
·»Á
);

318 
	`rbŒ“_bÏck
(
‹mp
->
·»Á
);

319 
	`rbŒ“_bÏck
(
w
->
Ëá
);

320 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

321 
‹mp
 = *
roÙ
;

326 
	`rbŒ“_bÏck
(
‹mp
);

327 
	}
}

	@src/vr_rbtree.c

1 
	~<vr_cÜe.h
>

4 
	$rbŒ“_node_š™
(
rbnode
 *
node
)

6 
node
->
Ëá
 = 
NULL
;

7 
node
->
right
 = 
NULL
;

8 
node
->
·»Á
 = 
NULL
;

9 
node
->
key
 = 0ULL;

10 
node
->
d©a
 = 
NULL
;

12 
	}
}

15 
	$rbŒ“_š™
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
)

17 
	`rbŒ“_node_š™
(
node
);

18 
	`rbŒ“_bÏck
(
node
);

19 
Œ“
->
roÙ
 = 
node
;

20 
Œ“
->
£Áš–
 = 
node
;

21 
	}
}

23 
rbnode
 *

24 
	$rbŒ“_node_mš
(
rbnode
 *
node
, rbnod*
£Áš–
)

28 
node
->
Ëá
 !ğ
£Áš–
) {

29 
node
 =‚ode->
Ëá
;

32  
node
;

33 
	}
}

35 
rbnode
 *

36 
	$rbŒ“_mš
(
rbŒ“
 *
Œ“
)

38 
rbnode
 *
node
 = 
Œ“
->
roÙ
;

39 
rbnode
 *
£Áš–
 = 
Œ“
->sentinel;

43 ià(
node
 =ğ
£Áš–
) {

44  
NULL
;

47  
	`rbŒ“_node_mš
(
node
, 
£Áš–
);

48 
	}
}

51 
	$rbŒ“_Ëá_rÙ©e
(
rbnode
 **
roÙ
, rbnod*
£Áš–
,

52 
rbnode
 *
node
)

54 
rbnode
 *
‹mp
;

56 
‹mp
 = 
node
->
right
;

57 
node
->
right
 = 
‹mp
->
Ëá
;

59 ià(
‹mp
->
Ëá
 !ğ
£Áš–
) {

60 
‹mp
->
Ëá
->
·»Á
 = 
node
;

63 
‹mp
->
·»Á
 = 
node
->parent;

65 ià(
node
 =ğ*
roÙ
) {

66 *
roÙ
 = 
‹mp
;

67 } ià(
node
 =ğnode->
·»Á
->
Ëá
) {

68 
node
->
·»Á
->
Ëá
 = 
‹mp
;

70 
node
->
·»Á
->
right
 = 
‹mp
;

73 
‹mp
->
Ëá
 = 
node
;

74 
node
->
·»Á
 = 
‹mp
;

75 
	}
}

78 
	$rbŒ“_right_rÙ©e
(
rbnode
 **
roÙ
, rbnod*
£Áš–
,

79 
rbnode
 *
node
)

81 
rbnode
 *
‹mp
;

83 
‹mp
 = 
node
->
Ëá
;

84 
node
->
Ëá
 = 
‹mp
->
right
;

86 ià(
‹mp
->
right
 !ğ
£Áš–
) {

87 
‹mp
->
right
->
·»Á
 = 
node
;

90 
‹mp
->
·»Á
 = 
node
->parent;

92 ià(
node
 =ğ*
roÙ
) {

93 *
roÙ
 = 
‹mp
;

94 } ià(
node
 =ğnode->
·»Á
->
right
) {

95 
node
->
·»Á
->
right
 = 
‹mp
;

97 
node
->
·»Á
->
Ëá
 = 
‹mp
;

100 
‹mp
->
right
 = 
node
;

101 
node
->
·»Á
 = 
‹mp
;

102 
	}
}

105 
	$rbŒ“_š£¹
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
)

107 
rbnode
 **
roÙ
 = &
Œ“
->root;

108 
rbnode
 *
£Áš–
 = 
Œ“
->sentinel;

109 
rbnode
 *
‹mp
, **
p
;

113 ià(*
roÙ
 =ğ
£Áš–
) {

114 
node
->
·»Á
 = 
NULL
;

115 
node
->
Ëá
 = 
£Áš–
;

116 
node
->
right
 = 
£Áš–
;

117 
	`rbŒ“_bÏck
(
node
);

118 *
roÙ
 = 
node
;

124 
‹mp
 = *
roÙ
;

127 
p
 = (
node
->
key
 < 
‹mp
->keyè? &‹mp->
Ëá
 : &‹mp->
right
;

128 ià(*
p
 =ğ
£Áš–
) {

131 
‹mp
 = *
p
;

134 *
p
 = 
node
;

135 
node
->
·»Á
 = 
‹mp
;

136 
node
->
Ëá
 = 
£Áš–
;

137 
node
->
right
 = 
£Áš–
;

138 
	`rbŒ“_»d
(
node
);

142 
node
 !ğ*
roÙ
 && 
	`rbŒ“_is_»d
Òode->
·»Á
)) {

144 ià(
node
->
·»Á
 =ğnode->·»Á->·»Á->
Ëá
) {

145 
‹mp
 = 
node
->
·»Á
->·»Á->
right
;

147 ià(
	`rbŒ“_is_»d
(
‹mp
)) {

148 
	`rbŒ“_bÏck
(
node
->
·»Á
);

149 
	`rbŒ“_bÏck
(
‹mp
);

150 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

151 
node
 =‚ode->
·»Á
->parent;

153 ià(
node
 =ğnode->
·»Á
->
right
) {

154 
node
 =‚ode->
·»Á
;

155 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
node
);

158 
	`rbŒ“_bÏck
(
node
->
·»Á
);

159 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

160 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
node
->
·»Á
->parent);

163 
‹mp
 = 
node
->
·»Á
->·»Á->
Ëá
;

165 ià(
	`rbŒ“_is_»d
(
‹mp
)) {

166 
	`rbŒ“_bÏck
(
node
->
·»Á
);

167 
	`rbŒ“_bÏck
(
‹mp
);

168 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

169 
node
 =‚ode->
·»Á
->parent;

171 ià(
node
 =ğnode->
·»Á
->
Ëá
) {

172 
node
 =‚ode->
·»Á
;

173 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
node
);

176 
	`rbŒ“_bÏck
(
node
->
·»Á
);

177 
	`rbŒ“_»d
(
node
->
·»Á
->parent);

178 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
node
->
·»Á
->parent);

183 
	`rbŒ“_bÏck
(*
roÙ
);

184 
	}
}

187 
	$rbŒ“_d–‘e
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
)

189 
rbnode
 **
roÙ
 = &
Œ“
->root;

190 
rbnode
 *
£Áš–
 = 
Œ“
->sentinel;

191 
rbnode
 *
sub¡
, *
‹mp
, *
w
;

192 
ušt8_t
 
»d
;

196 ià(
node
->
Ëá
 =ğ
£Áš–
) {

197 
‹mp
 = 
node
->
right
;

198 
sub¡
 = 
node
;

199 } ià(
node
->
right
 =ğ
£Áš–
) {

200 
‹mp
 = 
node
->
Ëá
;

201 
sub¡
 = 
node
;

203 
sub¡
 = 
	`rbŒ“_node_mš
(
node
->
right
, 
£Áš–
);

204 
‹mp
 = 
sub¡
->
right
;

207 ià(
sub¡
 =ğ*
roÙ
) {

208 *
roÙ
 = 
‹mp
;

209 
	`rbŒ“_bÏck
(
‹mp
);

211 
	`rbŒ“_node_š™
(
node
);

216 
»d
 = 
	`rbŒ“_is_»d
(
sub¡
);

218 ià(
sub¡
 =ğsub¡->
·»Á
->
Ëá
) {

219 
sub¡
->
·»Á
->
Ëá
 = 
‹mp
;

221 
sub¡
->
·»Á
->
right
 = 
‹mp
;

224 ià(
sub¡
 =ğ
node
) {

225 
‹mp
->
·»Á
 = 
sub¡
->parent;

228 ià(
sub¡
->
·»Á
 =ğ
node
) {

229 
‹mp
->
·»Á
 = 
sub¡
;

231 
‹mp
->
·»Á
 = 
sub¡
->parent;

234 
sub¡
->
Ëá
 = 
node
->left;

235 
sub¡
->
right
 = 
node
->right;

236 
sub¡
->
·»Á
 = 
node
->parent;

237 
	`rbŒ“_cİy_cŞÜ
(
sub¡
, 
node
);

239 ià(
node
 =ğ*
roÙ
) {

240 *
roÙ
 = 
sub¡
;

242 ià(
node
 =ğnode->
·»Á
->
Ëá
) {

243 
node
->
·»Á
->
Ëá
 = 
sub¡
;

245 
node
->
·»Á
->
right
 = 
sub¡
;

249 ià(
sub¡
->
Ëá
 !ğ
£Áš–
) {

250 
sub¡
->
Ëá
->
·»Á
 = subst;

253 ià(
sub¡
->
right
 !ğ
£Áš–
) {

254 
sub¡
->
right
->
·»Á
 = subst;

258 
	`rbŒ“_node_š™
(
node
);

260 ià(
»d
) {

266 
‹mp
 !ğ*
roÙ
 && 
	`rbŒ“_is_bÏck
(temp)) {

268 ià(
‹mp
 =ğ‹mp->
·»Á
->
Ëá
) {

269 
w
 = 
‹mp
->
·»Á
->
right
;

271 ià(
	`rbŒ“_is_»d
(
w
)) {

272 
	`rbŒ“_bÏck
(
w
);

273 
	`rbŒ“_»d
(
‹mp
->
·»Á
);

274 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

275 
w
 = 
‹mp
->
·»Á
->
right
;

278 ià(
	`rbŒ“_is_bÏck
(
w
->
Ëá
è&&„bŒ“_is_bÏck(w->
right
)) {

279 
	`rbŒ“_»d
(
w
);

280 
‹mp
 =emp->
·»Á
;

282 ià(
	`rbŒ“_is_bÏck
(
w
->
right
)) {

283 
	`rbŒ“_bÏck
(
w
->
Ëá
);

284 
	`rbŒ“_»d
(
w
);

285 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
w
);

286 
w
 = 
‹mp
->
·»Á
->
right
;

289 
	`rbŒ“_cİy_cŞÜ
(
w
, 
‹mp
->
·»Á
);

290 
	`rbŒ“_bÏck
(
‹mp
->
·»Á
);

291 
	`rbŒ“_bÏck
(
w
->
right
);

292 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

293 
‹mp
 = *
roÙ
;

297 
w
 = 
‹mp
->
·»Á
->
Ëá
;

299 ià(
	`rbŒ“_is_»d
(
w
)) {

300 
	`rbŒ“_bÏck
(
w
);

301 
	`rbŒ“_»d
(
‹mp
->
·»Á
);

302 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

303 
w
 = 
‹mp
->
·»Á
->
Ëá
;

306 ià(
	`rbŒ“_is_bÏck
(
w
->
Ëá
è&&„bŒ“_is_bÏck(w->
right
)) {

307 
	`rbŒ“_»d
(
w
);

308 
‹mp
 =emp->
·»Á
;

310 ià(
	`rbŒ“_is_bÏck
(
w
->
Ëá
)) {

311 
	`rbŒ“_bÏck
(
w
->
right
);

312 
	`rbŒ“_»d
(
w
);

313 
	`rbŒ“_Ëá_rÙ©e
(
roÙ
, 
£Áš–
, 
w
);

314 
w
 = 
‹mp
->
·»Á
->
Ëá
;

317 
	`rbŒ“_cİy_cŞÜ
(
w
, 
‹mp
->
·»Á
);

318 
	`rbŒ“_bÏck
(
‹mp
->
·»Á
);

319 
	`rbŒ“_bÏck
(
w
->
Ëá
);

320 
	`rbŒ“_right_rÙ©e
(
roÙ
, 
£Áš–
, 
‹mp
->
·»Á
);

321 
‹mp
 = *
roÙ
;

326 
	`rbŒ“_bÏck
(
‹mp
);

327 
	}
}

	@src/vr_rbtree.h

1 #iâdeà
_VR_RBTREE_


2 
	#_VR_RBTREE_


	)

4 
	#rbŒ“_»d
(
_node
è((_node)->
cŞÜ
 = 1)

	)

5 
	#rbŒ“_bÏck
(
_node
è((_node)->
cŞÜ
 = 0)

	)

6 
	#rbŒ“_is_»d
(
_node
è((_node)->
cŞÜ
)

	)

7 
	#rbŒ“_is_bÏck
(
_node
è(!
	`rbŒ“_is_»d
(_node))

	)

8 
	#rbŒ“_cİy_cŞÜ
(
_n1
, 
_n2
è((_n1)->
cŞÜ
 = (_n2)->cŞÜ)

	)

10 
	srbnode
 {

11 
rbnode
 *
	mËá
;

12 
rbnode
 *
	mright
;

13 
rbnode
 *
	m·»Á
;

14 
št64_t
 
	mkey
;

15 *
	md©a
;

16 
ušt8_t
 
	mcŞÜ
;

19 
	srbŒ“
 {

20 
rbnode
 *
	mroÙ
;

21 
rbnode
 *
	m£Áš–
;

24 
rbŒ“_node_š™
(
rbnode
 *
node
);

25 
rbŒ“_š™
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
);

26 
rbnode
 *
rbŒ“_mš
(
rbŒ“
 *
Œ“
);

27 
rbŒ“_š£¹
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
);

28 
rbŒ“_d–‘e
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
);

	@src/vr_rbtree.h

1 #iâdeà
_VR_RBTREE_


2 
	#_VR_RBTREE_


	)

4 
	#rbŒ“_»d
(
_node
è((_node)->
cŞÜ
 = 1)

	)

5 
	#rbŒ“_bÏck
(
_node
è((_node)->
cŞÜ
 = 0)

	)

6 
	#rbŒ“_is_»d
(
_node
è((_node)->
cŞÜ
)

	)

7 
	#rbŒ“_is_bÏck
(
_node
è(!
	`rbŒ“_is_»d
(_node))

	)

8 
	#rbŒ“_cİy_cŞÜ
(
_n1
, 
_n2
è((_n1)->
cŞÜ
 = (_n2)->cŞÜ)

	)

10 
	srbnode
 {

11 
rbnode
 *
	mËá
;

12 
rbnode
 *
	mright
;

13 
rbnode
 *
	m·»Á
;

14 
št64_t
 
	mkey
;

15 *
	md©a
;

16 
ušt8_t
 
	mcŞÜ
;

19 
	srbŒ“
 {

20 
rbnode
 *
	mroÙ
;

21 
rbnode
 *
	m£Áš–
;

24 
rbŒ“_node_š™
(
rbnode
 *
node
);

25 
rbŒ“_š™
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
);

26 
rbnode
 *
rbŒ“_mš
(
rbŒ“
 *
Œ“
);

27 
rbŒ“_š£¹
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
);

28 
rbŒ“_d–‘e
(
rbŒ“
 *
Œ“
, 
rbnode
 *
node
);

	@src/vr_rdb.c

1 
	~<vr_cÜe.h
>

4 
	$rdbSave
(*
f’ame
) {

5  
VR_OK
;

6 
	}
}

8 
	$rdbRemoveTempFe
(
pid_t
 
chdpid
) {

9 
tmpfe
[256];

11 
	`¢´štf
(
tmpfe
,Ñmpfe),"‹mp-%d.rdb", (è
chdpid
);

12 
	`uÆšk
(
tmpfe
);

13 
	}
}

	@src/vr_rdb.c

1 
	~<vr_cÜe.h
>

4 
	$rdbSave
(*
f’ame
) {

5  
VR_OK
;

6 
	}
}

8 
	$rdbRemoveTempFe
(
pid_t
 
chdpid
) {

9 
tmpfe
[256];

11 
	`¢´štf
(
tmpfe
,Ñmpfe),"‹mp-%d.rdb", (è
chdpid
);

12 
	`uÆšk
(
tmpfe
);

13 
	}
}

	@src/vr_rdb.h

1 #iâdeà
_VR_RDB_H_


2 
	#_VR_RDB_H_


	)

17 
	#RDB_6BITLEN
 0

	)

18 
	#RDB_14BITLEN
 1

	)

19 
	#RDB_32BITLEN
 2

	)

20 
	#RDB_ENCVAL
 3

	)

21 
	#RDB_LENERR
 
UINT_MAX


	)

26 
	#RDB_ENC_INT8
 0

	)

27 
	#RDB_ENC_INT16
 1

	)

28 
	#RDB_ENC_INT32
 2

	)

29 
	#RDB_ENC_LZF
 3

	)

31 
	s§v•¬am
 {

32 
time_t
 
	m£cÚds
;

33 
	mchªges
;

36 
rdbSave
(*
f’ame
);

37 
rdbRemoveTempFe
(
pid_t
 
chdpid
);

	@src/vr_rdb.h

1 #iâdeà
_VR_RDB_H_


2 
	#_VR_RDB_H_


	)

17 
	#RDB_6BITLEN
 0

	)

18 
	#RDB_14BITLEN
 1

	)

19 
	#RDB_32BITLEN
 2

	)

20 
	#RDB_ENCVAL
 3

	)

21 
	#RDB_LENERR
 
UINT_MAX


	)

26 
	#RDB_ENC_INT8
 0

	)

27 
	#RDB_ENC_INT16
 1

	)

28 
	#RDB_ENC_INT32
 2

	)

29 
	#RDB_ENC_LZF
 3

	)

31 
	s§v•¬am
 {

32 
time_t
 
	m£cÚds
;

33 
	mchªges
;

36 
rdbSave
(*
f’ame
);

37 
rdbRemoveTempFe
(
pid_t
 
chdpid
);

	@src/vr_replication.c

1 
	~<vr_cÜe.h
>

3 
vr_»¶iÿtiÚ
 
	g»¶
;

5 
	$vr_»¶iÿtiÚ_š™
()

7 
	`vr_ev’oİ_š™
(&
»¶
.
v–
,1000);

9 
»¶
.
rŞe
 = 
REPLICATION_ROLE_MASTER
;

10 
»¶
.
ma¡”
 = 
NULL
;

11 
»¶
.
ÿched_ma¡”
 = 
NULL
;

12 
»¶
.
¦aves
 = 
NULL
;

13 
»¶
.
»¶_no_¦aves_sšû
 = 0;

14 
»¶
.
»¶_mš_¦aves_to_wr™e
 = 0;

15 
»¶
.
»¶_mš_¦aves_max_Ïg
 = 0;

16 
»¶
.
»¶_good_¦aves_couÁ
 = 0;

17 
»¶
.
»¶_¡©e
 = 
REPL_STATE_NONE
;

18 
»¶
.
»¶_down_sšû
 = 0;

21 
»¶
.
»¶_backlog
 = 
NULL
;

22 
»¶
.
»¶_backlog_size
 = 
CONFIG_DEFAULT_REPL_BACKLOG_SIZE
;

23 
»¶
.
»¶_backlog_hi¡Ën
 = 0;

24 
»¶
.
»¶_backlog_idx
 = 0;

25 
»¶
.
»¶_backlog_off
 = 0;

26 
»¶
.
»¶_backlog_time_lim™
 = 
CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
;

27 
»¶
.
»¶_no_¦aves_sšû
 = 
	`time
(
NULL
);

29 
»¶
.
¦aves
 = 
	`dli¡C»©e
();

31  
VR_OK
;

32 
	}
}

34 
	$vr_»¶iÿtiÚ_deš™
()

36 
	`vr_ev’oİ_deš™
(&
»¶
.
v–
);

38 ià(
»¶
.
ma¡”
 !ğ
NULL
) {

39 
	`ä“Cl›Á
(
»¶
.
ma¡”
);

40 
»¶
.
ma¡”
 = 
NULL
;

43 ià(
»¶
.
ÿched_ma¡”
 !ğ
NULL
) {

44 
	`ä“Cl›Á
(
»¶
.
ÿched_ma¡”
);

45 
»¶
.
ÿched_ma¡”
 = 
NULL
;

48 ià(
»¶
.
»¶_backlog
 !ğ
NULL
) {

49 
	`dä“
(
»¶
.
»¶_backlog
);

50 
»¶
.
»¶_backlog
 = 
NULL
;

53 ià(
»¶
.
¦aves
 !ğ
NULL
) {

54 
ş›Á
 *
¦ave
;

55 
¦ave
 = 
	`dli¡Pİ
(
»¶
.
¦aves
)) {

56 
	`ä“Cl›Á
(
¦ave
);

58 
	`dli¡R–—£
(
»¶
.
¦aves
);

59 
»¶
.
¦aves
 = 
NULL
;

61 
	}
}

68 
	$unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
) {

69 
dli¡Node
 *
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás_wa™šg_acks
,c);

70 
	`ASSERT
(
Ê
 !ğ
NULL
);

71 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás_wa™šg_acks
,
Ê
);

72 
	}
}

80 
	$»äeshGoodSÏvesCouÁ
() {

81 
dli¡I‹r
 
li
;

82 
dli¡Node
 *
Ê
;

83 
good
 = 0;

85 ià(!
»¶
.
»¶_mš_¦aves_to_wr™e
 ||

86 !
»¶
.
»¶_mš_¦aves_max_Ïg
) ;

88 
	`dli¡Rewšd
(
»¶
.
¦aves
,&
li
);

89 (
Ê
 = 
	`dli¡Next
(&
li
))) {

90 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

91 
time_t
 
Ïg
 = 
»¶
.
v–
.
unixtime
 - 
¦ave
->
»¶_ack_time
;

93 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

94 
Ïg
 <ğ
»¶
.
»¶_mš_¦aves_max_Ïg
è
good
++;

96 
»¶
.
»¶_good_¦aves_couÁ
 = 
good
;

97 
	}
}

102 
	$»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
() {

103 
»¶
.
ma¡”
 = 
NULL
;

104 
»¶
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

105 
»¶
.
»¶_down_sšû
 =„•l.
v–
.
unixtime
;

109 
	}
}

133 
	$»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
) {

134 
	`ASSERT
(
»¶
.
ma¡”
 !ğ
NULL
 &&„•l.
ÿched_ma¡”
 == NULL);

135 
	`log_debug
(
LOG_NOTICE
,"Cachinghe disconnected master state.");

138 
	`uÆškCl›Á
(
c
);

142 
»¶
.
ÿched_ma¡”
 =„•l.
ma¡”
;

145 ià(
c
->
³”id
) {

146 
	`sdsä“
(
c
->
³”id
);

147 
c
->
³”id
 = 
NULL
;

153 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

154 
	}
}

161 *
	$»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
) {

162 
buf
[
VR_INET_PEER_ID_LEN
];

163 

[
VR_INET_ADDRSTRLEN
];

165 

[0] = '\0';

166 
buf
[0] = '\0';

168  
buf
;

169 
	}
}

184 
	$»¶cÚfCommªd
(
ş›Á
 *
c
) {

185 
j
;

187 ià((
c
->
¬gc
 % 2) == 0) {

190 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

195 
j
 = 1; j < 
c
->
¬gc
; j+=2) {

196 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"listening-port")) {

197 
pÜt
;

199 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+1],

200 &
pÜt
,
NULL
è!ğ
VR_OK
))

202 
c
->
¦ave_li¡’šg_pÜt
 = 
pÜt
;

203 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"capa")) {

205 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
+1]->
±r
,"eof"))

206 
c
->
¦ave_ÿ·
 |ğ
SLAVE_CAPA_EOF
;

207 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"ack")) {

211 
off£t
;

213 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
)) ;

214 ià((
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[
j
+1], &
off£t
è!ğ
VR_OK
))

216 ià(
off£t
 > 
c
->
»¶_ack_off
)

217 
c
->
»¶_ack_off
 = 
off£t
;

218 
c
->
»¶_ack_time
 = c->
v–
->
unixtime
;

222 ià(
c
->
»¶_put_Úlše_Ú_ack
 && c->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
)

223 
	`putSÏveOÆše
(
c
);

226 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"getack")) {

229 ià(
»¶
.
ma¡”ho¡
 &&„•l.
ma¡”
è
	`»¶iÿtiÚS’dAck
();

232 
	`addR•lyE¼ÜFÜm©
(
c
,"Unrecognized REPLCONF option: %s",

233 (*)
c
->
¬gv
[
j
]->
±r
);

237 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

238 
	}
}

252 
	$putSÏveOÆše
(
ş›Á
 *
¦ave
) {

253 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

254 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 0;

255 
¦ave
->
»¶_ack_time
 = sÏve->
v–
->
unixtime
;

256 ià(
	`«C»©eFeEv’t
(
¦ave
->
v–
->
–
, sÏve->
cÚn
->
sd
, 
AE_WRITABLE
,

257 
£ndR•lyToCl›Á
, 
¦ave
è=ğ
AE_ERR
) {

258 
	`log_w¬n
("uÇbËØ»gi¡” wr™abËƒv’ˆfÜ sÏvbulk¿nsãr: %s", 
	`¡»¼Ü
(
”ºo
));

259 
	`ä“Cl›Á
(
¦ave
);

262 
	`»äeshGoodSÏvesCouÁ
();

263 
	`log_debug
(
LOG_NOTICE
,"Synchronization with slave %s succeeded",

264 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

265 
	}
}

270 
	$»¶iÿtiÚS’dAck
() {

271 
ş›Á
 *
c
 = 
»¶
.
ma¡”
;

273 ià(
c
 !ğ
NULL
) {

274 
c
->
æags
 |ğ
CLIENT_MASTER_FORCE_REPLY
;

275 
	`addR•lyMuÉiBulkL’
(
c
,3);

276 
	`addR•lyBulkCSŒšg
(
c
,"REPLCONF");

277 
	`addR•lyBulkCSŒšg
(
c
,"ACK");

278 
	`addR•lyBulkLÚgLÚg
(
c
,c->
»¶off
);

279 
c
->
æags
 &ğ~
CLIENT_MASTER_FORCE_REPLY
;

281 
	}
}

283 
	$»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
dli¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

284 
dli¡Node
 *
Ê
;

285 
dli¡I‹r
 
li
;

286 
j
;

287 
sds
 
cmd»´
 = 
	`sd¢ew
("+");

288 
robj
 *
cmdobj
;

289 
timev®
 
tv
;

291 
	`g‘timeofday
(&
tv
,
NULL
);

292 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"%ld.%06ld ",()
tv
.
tv_£c
,(év.
tv_u£c
);

293 ià(
c
->
æags
 & 
CLIENT_LUA
) {

294 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d†ua] ",
diùid
);

295 } ià(
c
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

296 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d unix:%s] ",
diùid
,
£rv”
.
unixsock‘
);

298 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d %s] ",
diùid
,
	`g‘Cl›ÁP“rId
(
c
));

301 
j
 = 0; j < 
¬gc
; j++) {

302 ià(
¬gv
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

303 
cmd»´
 = 
	`sdsÿrštf
(cmd»´, "\"%ld\"", ()
¬gv
[
j
]->
±r
);

305 
cmd»´
 = 
	`sdsÿŒ•r
(cmd»´,(*)
¬gv
[
j
]->
±r
,

306 
	`sd¦’
(
¬gv
[
j
]->
±r
));

308 ià(
j
 !ğ
¬gc
-1)

309 
cmd»´
 = 
	`sdsÿ’
(cmdrepr," ",1);

311 
cmd»´
 = 
	`sdsÿ’
(cmdrepr,"\r\n",2);

312 
cmdobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
cmd»´
);

314 
	`dli¡Rewšd
(
mÚ™Üs
,&
li
);

315 (
Ê
 = 
	`dli¡Next
(&
li
))) {

316 
ş›Á
 *
mÚ™Ü
 = 
Ê
->
v®ue
;

317 
	`addR•ly
(
mÚ™Ü
,
cmdobj
);

319 
	`deüRefCouÁ
(
cmdobj
);

320 
	}
}

326 
	$ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
) {

327 *
p
 = 
±r
;

329 
»¶
.
ma¡”_»¶_off£t
 +ğ
Ën
;

333 
Ën
) {

334 
size_t
 
thi¦’
 = 
»¶
.
»¶_backlog_size
 -„•l.
»¶_backlog_idx
;

335 ià(
thi¦’
 > 
Ën
)hislen =†en;

336 
	`memıy
(
»¶
.
»¶_backlog
+»¶.
»¶_backlog_idx
,
p
,
thi¦’
);

337 
»¶
.
»¶_backlog_idx
 +ğ
thi¦’
;

338 ià(
»¶
.
»¶_backlog_idx
 =ğ»¶.
»¶_backlog_size
)

339 
»¶
.
»¶_backlog_idx
 = 0;

340 
Ën
 -ğ
thi¦’
;

341 
p
 +ğ
thi¦’
;

342 
»¶
.
»¶_backlog_hi¡Ën
 +ğ
thi¦’
;

344 ià(
»¶
.
»¶_backlog_hi¡Ën
 >„•l.
»¶_backlog_size
)

345 
»¶
.
»¶_backlog_hi¡Ën
 =„•l.
»¶_backlog_size
;

347 
»¶
.
»¶_backlog_off
 =„•l.
ma¡”_»¶_off£t
 -

348 
»¶
.
»¶_backlog_hi¡Ën
 + 1;

349 
	}
}

353 
	$ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
) {

354 
Î¡r
[
LONG_STR_SIZE
];

355 *
p
;

356 
size_t
 
Ën
;

358 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

359 
Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),()
o
->
±r
);

360 
p
 = 
Î¡r
;

362 
Ën
 = 
	`sd¦’
(
o
->
±r
);

363 
p
 = 
o
->
±r
;

365 
	`ãedR•liÿtiÚBacklog
(
p
,
Ën
);

366 
	}
}

368 
	$»¶iÿtiÚF“dSÏves
(
dli¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

369 
dli¡Node
 *
Ê
;

370 
dli¡I‹r
 
li
;

371 
j
, 
Ën
;

372 
Î¡r
[
LONG_STR_SIZE
];

376 ià(
»¶
.
»¶_backlog
 =ğ
NULL
 && 
	`dli¡L’gth
(
¦aves
) == 0) ;

379 
	`ASSERT
(!(
	`dli¡L’gth
(
¦aves
è!ğ0 && 
»¶
.
»¶_backlog
 =ğ
NULL
));

382 ià(
»¶
.
¦ave£ldb
 !ğ
diùid
) {

383 
robj
 *
£Ëùcmd
;

386 ià(
diùid
 >ğ0 && diùid < 
PROTO_SHARED_SELECT_CMDS
) {

387 
£Ëùcmd
 = 
sh¬ed
.
£Ëù
[
diùid
];

389 
diùid_Ën
;

391 
diùid_Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),
diùid
);

392 
£Ëùcmd
 = 
	`ü—‹Objeù
(
OBJ_STRING
,

393 
	`sdsÿrštf
(
	`sd£m±y
(),

395 
diùid_Ën
, 
Î¡r
));

399 ià(
»¶
.
»¶_backlog
è
	`ãedR•liÿtiÚBacklogW™hObjeù
(
£Ëùcmd
);

402 
	`dli¡Rewšd
(
¦aves
,&
li
);

403 (
Ê
 = 
	`dli¡Next
(&
li
))) {

404 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

405 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

406 
	`addR•ly
(
¦ave
,
£Ëùcmd
);

409 ià(
diùid
 < 0 || diùid >ğ
PROTO_SHARED_SELECT_CMDS
)

410 
	`deüRefCouÁ
(
£Ëùcmd
);

412 
»¶
.
¦ave£ldb
 = 
diùid
;

415 ià(
»¶
.
»¶_backlog
) {

416 
aux
[
LONG_STR_SIZE
+3];

419 
aux
[0] = '*';

420 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
¬gc
);

421 
aux
[
Ën
+1] = '\r';

422 
aux
[
Ën
+2] = '\n';

423 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

425 
j
 = 0; j < 
¬gc
; j++) {

426 
objËn
 = 
	`¡ršgObjeùL’
(
¬gv
[
j
]);

431 
aux
[0] = '$';

432 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
objËn
);

433 
aux
[
Ën
+1] = '\r';

434 
aux
[
Ën
+2] = '\n';

435 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

436 
	`ãedR•liÿtiÚBacklogW™hObjeù
(
¬gv
[
j
]);

437 
	`ãedR•liÿtiÚBacklog
(
aux
+
Ën
+1,2);

442 
	`dli¡Rewšd
(
»¶
.
¦aves
,&
li
);

443 (
Ê
 = 
	`dli¡Next
(&
li
))) {

444 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

447 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

454 
	`addR•lyMuÉiBulkL’
(
¦ave
,
¬gc
);

458 
j
 = 0; j < 
¬gc
; j++)

459 
	`addR•lyBulk
(
¦ave
,
¬gv
[
j
]);

461 
	}
}

	@src/vr_replication.c

1 
	~<vr_cÜe.h
>

3 
vr_»¶iÿtiÚ
 
	g»¶
;

5 
	$vr_»¶iÿtiÚ_š™
()

7 
	`vr_ev’oİ_š™
(&
»¶
.
v–
,1000);

9 
»¶
.
rŞe
 = 
REPLICATION_ROLE_MASTER
;

10 
»¶
.
ma¡”
 = 
NULL
;

11 
»¶
.
ÿched_ma¡”
 = 
NULL
;

12 
»¶
.
¦aves
 = 
NULL
;

13 
»¶
.
»¶_no_¦aves_sšû
 = 0;

14 
»¶
.
»¶_mš_¦aves_to_wr™e
 = 0;

15 
»¶
.
»¶_mš_¦aves_max_Ïg
 = 0;

16 
»¶
.
»¶_good_¦aves_couÁ
 = 0;

17 
»¶
.
»¶_¡©e
 = 
REPL_STATE_NONE
;

18 
»¶
.
»¶_down_sšû
 = 0;

21 
»¶
.
»¶_backlog
 = 
NULL
;

22 
»¶
.
»¶_backlog_size
 = 
CONFIG_DEFAULT_REPL_BACKLOG_SIZE
;

23 
»¶
.
»¶_backlog_hi¡Ën
 = 0;

24 
»¶
.
»¶_backlog_idx
 = 0;

25 
»¶
.
»¶_backlog_off
 = 0;

26 
»¶
.
»¶_backlog_time_lim™
 = 
CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
;

27 
»¶
.
»¶_no_¦aves_sšû
 = 
	`time
(
NULL
);

29 
»¶
.
¦aves
 = 
	`dli¡C»©e
();

31  
VR_OK
;

32 
	}
}

34 
	$vr_»¶iÿtiÚ_deš™
()

36 
	`vr_ev’oİ_deš™
(&
»¶
.
v–
);

38 ià(
»¶
.
ma¡”
 !ğ
NULL
) {

39 
	`ä“Cl›Á
(
»¶
.
ma¡”
);

40 
»¶
.
ma¡”
 = 
NULL
;

43 ià(
»¶
.
ÿched_ma¡”
 !ğ
NULL
) {

44 
	`ä“Cl›Á
(
»¶
.
ÿched_ma¡”
);

45 
»¶
.
ÿched_ma¡”
 = 
NULL
;

48 ià(
»¶
.
»¶_backlog
 !ğ
NULL
) {

49 
	`dä“
(
»¶
.
»¶_backlog
);

50 
»¶
.
»¶_backlog
 = 
NULL
;

53 ià(
»¶
.
¦aves
 !ğ
NULL
) {

54 
ş›Á
 *
¦ave
;

55 
¦ave
 = 
	`dli¡Pİ
(
»¶
.
¦aves
)) {

56 
	`ä“Cl›Á
(
¦ave
);

58 
	`dli¡R–—£
(
»¶
.
¦aves
);

59 
»¶
.
¦aves
 = 
NULL
;

61 
	}
}

68 
	$unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
) {

69 
dli¡Node
 *
Ê
 = 
	`dli¡S—rchKey
(
c
->
v–
->
ş›Ás_wa™šg_acks
,c);

70 
	`ASSERT
(
Ê
 !ğ
NULL
);

71 
	`dli¡D–Node
(
c
->
v–
->
ş›Ás_wa™šg_acks
,
Ê
);

72 
	}
}

80 
	$»äeshGoodSÏvesCouÁ
() {

81 
dli¡I‹r
 
li
;

82 
dli¡Node
 *
Ê
;

83 
good
 = 0;

85 ià(!
»¶
.
»¶_mš_¦aves_to_wr™e
 ||

86 !
»¶
.
»¶_mš_¦aves_max_Ïg
) ;

88 
	`dli¡Rewšd
(
»¶
.
¦aves
,&
li
);

89 (
Ê
 = 
	`dli¡Next
(&
li
))) {

90 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

91 
time_t
 
Ïg
 = 
»¶
.
v–
.
unixtime
 - 
¦ave
->
»¶_ack_time
;

93 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

94 
Ïg
 <ğ
»¶
.
»¶_mš_¦aves_max_Ïg
è
good
++;

96 
»¶
.
»¶_good_¦aves_couÁ
 = 
good
;

97 
	}
}

102 
	$»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
() {

103 
»¶
.
ma¡”
 = 
NULL
;

104 
»¶
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

105 
»¶
.
»¶_down_sšû
 =„•l.
v–
.
unixtime
;

109 
	}
}

133 
	$»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
) {

134 
	`ASSERT
(
»¶
.
ma¡”
 !ğ
NULL
 &&„•l.
ÿched_ma¡”
 == NULL);

135 
	`log_debug
(
LOG_NOTICE
,"Cachinghe disconnected master state.");

138 
	`uÆškCl›Á
(
c
);

142 
»¶
.
ÿched_ma¡”
 =„•l.
ma¡”
;

145 ià(
c
->
³”id
) {

146 
	`sdsä“
(
c
->
³”id
);

147 
c
->
³”id
 = 
NULL
;

153 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

154 
	}
}

161 *
	$»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
) {

162 
buf
[
VR_INET_PEER_ID_LEN
];

163 

[
VR_INET_ADDRSTRLEN
];

165 

[0] = '\0';

166 
buf
[0] = '\0';

168  
buf
;

169 
	}
}

184 
	$»¶cÚfCommªd
(
ş›Á
 *
c
) {

185 
j
;

187 ià((
c
->
¬gc
 % 2) == 0) {

190 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

195 
j
 = 1; j < 
c
->
¬gc
; j+=2) {

196 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"listening-port")) {

197 
pÜt
;

199 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+1],

200 &
pÜt
,
NULL
è!ğ
VR_OK
))

202 
c
->
¦ave_li¡’šg_pÜt
 = 
pÜt
;

203 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"capa")) {

205 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
+1]->
±r
,"eof"))

206 
c
->
¦ave_ÿ·
 |ğ
SLAVE_CAPA_EOF
;

207 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"ack")) {

211 
off£t
;

213 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
)) ;

214 ià((
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[
j
+1], &
off£t
è!ğ
VR_OK
))

216 ià(
off£t
 > 
c
->
»¶_ack_off
)

217 
c
->
»¶_ack_off
 = 
off£t
;

218 
c
->
»¶_ack_time
 = c->
v–
->
unixtime
;

222 ià(
c
->
»¶_put_Úlše_Ú_ack
 && c->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
)

223 
	`putSÏveOÆše
(
c
);

226 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"getack")) {

229 ià(
»¶
.
ma¡”ho¡
 &&„•l.
ma¡”
è
	`»¶iÿtiÚS’dAck
();

232 
	`addR•lyE¼ÜFÜm©
(
c
,"Unrecognized REPLCONF option: %s",

233 (*)
c
->
¬gv
[
j
]->
±r
);

237 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

238 
	}
}

252 
	$putSÏveOÆše
(
ş›Á
 *
¦ave
) {

253 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

254 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 0;

255 
¦ave
->
»¶_ack_time
 = sÏve->
v–
->
unixtime
;

256 ià(
	`«C»©eFeEv’t
(
¦ave
->
v–
->
–
, sÏve->
cÚn
->
sd
, 
AE_WRITABLE
,

257 
£ndR•lyToCl›Á
, 
¦ave
è=ğ
AE_ERR
) {

258 
	`log_w¬n
("uÇbËØ»gi¡” wr™abËƒv’ˆfÜ sÏvbulk¿nsãr: %s", 
	`¡»¼Ü
(
”ºo
));

259 
	`ä“Cl›Á
(
¦ave
);

262 
	`»äeshGoodSÏvesCouÁ
();

263 
	`log_debug
(
LOG_NOTICE
,"Synchronization with slave %s succeeded",

264 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

265 
	}
}

270 
	$»¶iÿtiÚS’dAck
() {

271 
ş›Á
 *
c
 = 
»¶
.
ma¡”
;

273 ià(
c
 !ğ
NULL
) {

274 
c
->
æags
 |ğ
CLIENT_MASTER_FORCE_REPLY
;

275 
	`addR•lyMuÉiBulkL’
(
c
,3);

276 
	`addR•lyBulkCSŒšg
(
c
,"REPLCONF");

277 
	`addR•lyBulkCSŒšg
(
c
,"ACK");

278 
	`addR•lyBulkLÚgLÚg
(
c
,c->
»¶off
);

279 
c
->
æags
 &ğ~
CLIENT_MASTER_FORCE_REPLY
;

281 
	}
}

283 
	$»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
dli¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

284 
dli¡Node
 *
Ê
;

285 
dli¡I‹r
 
li
;

286 
j
;

287 
sds
 
cmd»´
 = 
	`sd¢ew
("+");

288 
robj
 *
cmdobj
;

289 
timev®
 
tv
;

291 
	`g‘timeofday
(&
tv
,
NULL
);

292 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"%ld.%06ld ",()
tv
.
tv_£c
,(év.
tv_u£c
);

293 ià(
c
->
æags
 & 
CLIENT_LUA
) {

294 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d†ua] ",
diùid
);

295 } ià(
c
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

296 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d unix:%s] ",
diùid
,
£rv”
.
unixsock‘
);

298 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d %s] ",
diùid
,
	`g‘Cl›ÁP“rId
(
c
));

301 
j
 = 0; j < 
¬gc
; j++) {

302 ià(
¬gv
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

303 
cmd»´
 = 
	`sdsÿrštf
(cmd»´, "\"%ld\"", ()
¬gv
[
j
]->
±r
);

305 
cmd»´
 = 
	`sdsÿŒ•r
(cmd»´,(*)
¬gv
[
j
]->
±r
,

306 
	`sd¦’
(
¬gv
[
j
]->
±r
));

308 ià(
j
 !ğ
¬gc
-1)

309 
cmd»´
 = 
	`sdsÿ’
(cmdrepr," ",1);

311 
cmd»´
 = 
	`sdsÿ’
(cmdrepr,"\r\n",2);

312 
cmdobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
cmd»´
);

314 
	`dli¡Rewšd
(
mÚ™Üs
,&
li
);

315 (
Ê
 = 
	`dli¡Next
(&
li
))) {

316 
ş›Á
 *
mÚ™Ü
 = 
Ê
->
v®ue
;

317 
	`addR•ly
(
mÚ™Ü
,
cmdobj
);

319 
	`deüRefCouÁ
(
cmdobj
);

320 
	}
}

326 
	$ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
) {

327 *
p
 = 
±r
;

329 
»¶
.
ma¡”_»¶_off£t
 +ğ
Ën
;

333 
Ën
) {

334 
size_t
 
thi¦’
 = 
»¶
.
»¶_backlog_size
 -„•l.
»¶_backlog_idx
;

335 ià(
thi¦’
 > 
Ën
)hislen =†en;

336 
	`memıy
(
»¶
.
»¶_backlog
+»¶.
»¶_backlog_idx
,
p
,
thi¦’
);

337 
»¶
.
»¶_backlog_idx
 +ğ
thi¦’
;

338 ià(
»¶
.
»¶_backlog_idx
 =ğ»¶.
»¶_backlog_size
)

339 
»¶
.
»¶_backlog_idx
 = 0;

340 
Ën
 -ğ
thi¦’
;

341 
p
 +ğ
thi¦’
;

342 
»¶
.
»¶_backlog_hi¡Ën
 +ğ
thi¦’
;

344 ià(
»¶
.
»¶_backlog_hi¡Ën
 >„•l.
»¶_backlog_size
)

345 
»¶
.
»¶_backlog_hi¡Ën
 =„•l.
»¶_backlog_size
;

347 
»¶
.
»¶_backlog_off
 =„•l.
ma¡”_»¶_off£t
 -

348 
»¶
.
»¶_backlog_hi¡Ën
 + 1;

349 
	}
}

353 
	$ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
) {

354 
Î¡r
[
LONG_STR_SIZE
];

355 *
p
;

356 
size_t
 
Ën
;

358 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

359 
Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),()
o
->
±r
);

360 
p
 = 
Î¡r
;

362 
Ën
 = 
	`sd¦’
(
o
->
±r
);

363 
p
 = 
o
->
±r
;

365 
	`ãedR•liÿtiÚBacklog
(
p
,
Ën
);

366 
	}
}

368 
	$»¶iÿtiÚF“dSÏves
(
dli¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

369 
dli¡Node
 *
Ê
;

370 
dli¡I‹r
 
li
;

371 
j
, 
Ën
;

372 
Î¡r
[
LONG_STR_SIZE
];

376 ià(
»¶
.
»¶_backlog
 =ğ
NULL
 && 
	`dli¡L’gth
(
¦aves
) == 0) ;

379 
	`ASSERT
(!(
	`dli¡L’gth
(
¦aves
è!ğ0 && 
»¶
.
»¶_backlog
 =ğ
NULL
));

382 ià(
»¶
.
¦ave£ldb
 !ğ
diùid
) {

383 
robj
 *
£Ëùcmd
;

386 ià(
diùid
 >ğ0 && diùid < 
PROTO_SHARED_SELECT_CMDS
) {

387 
£Ëùcmd
 = 
sh¬ed
.
£Ëù
[
diùid
];

389 
diùid_Ën
;

391 
diùid_Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),
diùid
);

392 
£Ëùcmd
 = 
	`ü—‹Objeù
(
OBJ_STRING
,

393 
	`sdsÿrštf
(
	`sd£m±y
(),

395 
diùid_Ën
, 
Î¡r
));

399 ià(
»¶
.
»¶_backlog
è
	`ãedR•liÿtiÚBacklogW™hObjeù
(
£Ëùcmd
);

402 
	`dli¡Rewšd
(
¦aves
,&
li
);

403 (
Ê
 = 
	`dli¡Next
(&
li
))) {

404 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

405 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

406 
	`addR•ly
(
¦ave
,
£Ëùcmd
);

409 ià(
diùid
 < 0 || diùid >ğ
PROTO_SHARED_SELECT_CMDS
)

410 
	`deüRefCouÁ
(
£Ëùcmd
);

412 
»¶
.
¦ave£ldb
 = 
diùid
;

415 ià(
»¶
.
»¶_backlog
) {

416 
aux
[
LONG_STR_SIZE
+3];

419 
aux
[0] = '*';

420 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
¬gc
);

421 
aux
[
Ën
+1] = '\r';

422 
aux
[
Ën
+2] = '\n';

423 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

425 
j
 = 0; j < 
¬gc
; j++) {

426 
objËn
 = 
	`¡ršgObjeùL’
(
¬gv
[
j
]);

431 
aux
[0] = '$';

432 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
objËn
);

433 
aux
[
Ën
+1] = '\r';

434 
aux
[
Ën
+2] = '\n';

435 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

436 
	`ãedR•liÿtiÚBacklogW™hObjeù
(
¬gv
[
j
]);

437 
	`ãedR•liÿtiÚBacklog
(
aux
+
Ën
+1,2);

442 
	`dli¡Rewšd
(
»¶
.
¦aves
,&
li
);

443 (
Ê
 = 
	`dli¡Next
(&
li
))) {

444 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

447 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

454 
	`addR•lyMuÉiBulkL’
(
¦ave
,
¬gc
);

458 
j
 = 0; j < 
¬gc
; j++)

459 
	`addR•lyBulk
(
¦ave
,
¬gv
[
j
]);

461 
	}
}

	@src/vr_replication.h

1 #iâdeà
_VR_REPLICATION_H_


2 
	#_VR_REPLICATION_H_


	)

10 
	#REPL_STATE_NONE
 0

	)

11 
	#REPL_STATE_CONNECT
 1

	)

12 
	#REPL_STATE_CONNECTING
 2

	)

17 
	#REPL_STATE_RECEIVE_PONG
 3

	)

21 
	#REPL_STATE_SEND_AUTH
 4

	)

23 
	#REPL_STATE_RECEIVE_AUTH
 5

	)

27 
	#REPL_STATE_SEND_PORT
 6

	)

29 
	#REPL_STATE_RECEIVE_PORT
 7

	)

32 
	#REPL_STATE_SEND_CAPA
 8

	)

34 
	#REPL_STATE_RECEIVE_CAPA
 9

	)

37 
	#REPL_STATE_SEND_PSYNC
 10

	)

39 
	#REPL_STATE_RECEIVE_PSYNC
 11

	)

45 
	#REPL_STATE_TRANSFER
 12

	)

47 
	#REPL_STATE_CONNECTED
 13

	)

56 
	#SLAVE_STATE_WAIT_BGSAVE_START
 6

	)

58 
	#SLAVE_STATE_WAIT_BGSAVE_END
 7

	)

60 
	#SLAVE_STATE_SEND_BULK
 8

	)

62 
	#SLAVE_STATE_ONLINE
 9

	)

66 
	#SLAVE_CAPA_NONE
 0

	)

67 
	#SLAVE_CAPA_EOF
 (1<<0è

	)

70 
	#CONFIG_REPL_SYNCIO_TIMEOUT
 5

	)

72 
	#REPLICATION_ROLE_MASTER
 0

	)

73 
	#REPLICATION_ROLE_SLAVE
 1

	)

76 
	#CONFIG_DEFAULT_REPL_BACKLOG_SIZE
 (1024*1024è

	)

77 
	#CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
 (60*60è

	)

78 
	#CONFIG_REPL_BACKLOG_MIN_SIZE
 (1024*16è

	)

81 
	svr_»¶iÿtiÚ
 {

82 
vr_ev’oİ
 
	mv–
;

84 
	mrŞe
;

88 
dli¡
 *
	m¦aves
;

90 
	m¦ave£ldb
;

92 
	mma¡”_»¶_off£t
;

94 
	m»¶_pšg_¦ave_³riod
;

96 *
	m»¶_backlog
;

98 
	m»¶_backlog_size
;

100 
	m»¶_backlog_hi¡Ën
;

102 
	m»¶_backlog_idx
;

104 
	m»¶_backlog_off
;

107 
time_t
 
	m»¶_backlog_time_lim™
;

110 
time_t
 
	m»¶_no_¦aves_sšû
;

114 
	m»¶_mš_¦aves_to_wr™e
;

115 
	m»¶_mš_¦aves_max_Ïg
;

117 
	m»¶_good_¦aves_couÁ
;

119 
	m»¶_diskËss_sync
;

121 
	m»¶_diskËss_sync_d–ay
;

125 *
	mma¡”auth
;

127 *
	mma¡”ho¡
;

129 
	mma¡”pÜt
;

131 
	m»¶_timeout
;

133 
ş›Á
 *
	mma¡”
;

135 
ş›Á
 *
	mÿched_ma¡”
;

137 
	m»¶_syncio_timeout
;

139 
	m»¶_¡©e
;

141 
off_t
 
	m»¶_Œªsãr_size
;

143 
off_t
 
	m»¶_Œªsãr_»ad
;

145 
off_t
 
	m»¶_Œªsãr_Ï¡_fsync_off
;

147 
	m»¶_Œªsãr_s
;

149 
	m»¶_Œªsãr_fd
;

152 *
	m»¶_Œªsãr_tmpfe
;

153 
time_t
 
	m»¶_Œªsãr_Ï¡io
;

154 
	m»¶_£rve_¡®e_d©a
;

155 
	m»¶_¦ave_ro
;

156 
time_t
 
	m»¶_down_sšû
;

158 
	m»¶_di§bË_tı_nod–ay
;

160 
	m¦ave_´iÜ™y
;

162 
	m»¶_ma¡”_runid
[
CONFIG_RUN_ID_SIZE
+1];

163 
	m»¶_ma¡”_š™Ÿl_off£t
;

166 
vr_»¶iÿtiÚ
 
»¶
;

168 
vr_»¶iÿtiÚ_š™
();

169 
vr_»¶iÿtiÚ_deš™
();

171 
unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
);

172 
»äeshGoodSÏvesCouÁ
();

173 
»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

174 
»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
);

175 *
»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
);

176 
»¶cÚfCommªd
(
ş›Á
 *
c
);

177 
putSÏveOÆše
(
ş›Á
 *
¦ave
);

178 
»¶iÿtiÚS’dAck
();

179 
»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
dli¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

180 
»¶iÿtiÚF“dSÏves
(
dli¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

181 
ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
);

182 
ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
);

	@src/vr_replication.h

1 #iâdeà
_VR_REPLICATION_H_


2 
	#_VR_REPLICATION_H_


	)

10 
	#REPL_STATE_NONE
 0

	)

11 
	#REPL_STATE_CONNECT
 1

	)

12 
	#REPL_STATE_CONNECTING
 2

	)

17 
	#REPL_STATE_RECEIVE_PONG
 3

	)

21 
	#REPL_STATE_SEND_AUTH
 4

	)

23 
	#REPL_STATE_RECEIVE_AUTH
 5

	)

27 
	#REPL_STATE_SEND_PORT
 6

	)

29 
	#REPL_STATE_RECEIVE_PORT
 7

	)

32 
	#REPL_STATE_SEND_CAPA
 8

	)

34 
	#REPL_STATE_RECEIVE_CAPA
 9

	)

37 
	#REPL_STATE_SEND_PSYNC
 10

	)

39 
	#REPL_STATE_RECEIVE_PSYNC
 11

	)

45 
	#REPL_STATE_TRANSFER
 12

	)

47 
	#REPL_STATE_CONNECTED
 13

	)

56 
	#SLAVE_STATE_WAIT_BGSAVE_START
 6

	)

58 
	#SLAVE_STATE_WAIT_BGSAVE_END
 7

	)

60 
	#SLAVE_STATE_SEND_BULK
 8

	)

62 
	#SLAVE_STATE_ONLINE
 9

	)

66 
	#SLAVE_CAPA_NONE
 0

	)

67 
	#SLAVE_CAPA_EOF
 (1<<0è

	)

70 
	#CONFIG_REPL_SYNCIO_TIMEOUT
 5

	)

72 
	#REPLICATION_ROLE_MASTER
 0

	)

73 
	#REPLICATION_ROLE_SLAVE
 1

	)

76 
	#CONFIG_DEFAULT_REPL_BACKLOG_SIZE
 (1024*1024è

	)

77 
	#CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
 (60*60è

	)

78 
	#CONFIG_REPL_BACKLOG_MIN_SIZE
 (1024*16è

	)

81 
	svr_»¶iÿtiÚ
 {

82 
vr_ev’oİ
 
	mv–
;

84 
	mrŞe
;

88 
dli¡
 *
	m¦aves
;

90 
	m¦ave£ldb
;

92 
	mma¡”_»¶_off£t
;

94 
	m»¶_pšg_¦ave_³riod
;

96 *
	m»¶_backlog
;

98 
	m»¶_backlog_size
;

100 
	m»¶_backlog_hi¡Ën
;

102 
	m»¶_backlog_idx
;

104 
	m»¶_backlog_off
;

107 
time_t
 
	m»¶_backlog_time_lim™
;

110 
time_t
 
	m»¶_no_¦aves_sšû
;

114 
	m»¶_mš_¦aves_to_wr™e
;

115 
	m»¶_mš_¦aves_max_Ïg
;

117 
	m»¶_good_¦aves_couÁ
;

119 
	m»¶_diskËss_sync
;

121 
	m»¶_diskËss_sync_d–ay
;

125 *
	mma¡”auth
;

127 *
	mma¡”ho¡
;

129 
	mma¡”pÜt
;

131 
	m»¶_timeout
;

133 
ş›Á
 *
	mma¡”
;

135 
ş›Á
 *
	mÿched_ma¡”
;

137 
	m»¶_syncio_timeout
;

139 
	m»¶_¡©e
;

141 
off_t
 
	m»¶_Œªsãr_size
;

143 
off_t
 
	m»¶_Œªsãr_»ad
;

145 
off_t
 
	m»¶_Œªsãr_Ï¡_fsync_off
;

147 
	m»¶_Œªsãr_s
;

149 
	m»¶_Œªsãr_fd
;

152 *
	m»¶_Œªsãr_tmpfe
;

153 
time_t
 
	m»¶_Œªsãr_Ï¡io
;

154 
	m»¶_£rve_¡®e_d©a
;

155 
	m»¶_¦ave_ro
;

156 
time_t
 
	m»¶_down_sšû
;

158 
	m»¶_di§bË_tı_nod–ay
;

160 
	m¦ave_´iÜ™y
;

162 
	m»¶_ma¡”_runid
[
CONFIG_RUN_ID_SIZE
+1];

163 
	m»¶_ma¡”_š™Ÿl_off£t
;

166 
vr_»¶iÿtiÚ
 
»¶
;

168 
vr_»¶iÿtiÚ_š™
();

169 
vr_»¶iÿtiÚ_deš™
();

171 
unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
);

172 
»äeshGoodSÏvesCouÁ
();

173 
»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

174 
»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
);

175 *
»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
);

176 
»¶cÚfCommªd
(
ş›Á
 *
c
);

177 
putSÏveOÆše
(
ş›Á
 *
¦ave
);

178 
»¶iÿtiÚS’dAck
();

179 
»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
dli¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

180 
»¶iÿtiÚF“dSÏves
(
dli¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

181 
ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
);

182 
ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
);

	@src/vr_scripting.c

1 
	~<vr_cÜe.h
>

3 
	$sütCommªd
(
ş›Á
 *
c
) {

4 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5 
	}
}

	@src/vr_scripting.c

1 
	~<vr_cÜe.h
>

3 
	$sütCommªd
(
ş›Á
 *
c
) {

4 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5 
	}
}

	@src/vr_scripting.h

1 #iâdeà
_VR_SCRIPTING_H_


2 
	#_VR_SCRIPTING_H_


	)

4 
sütCommªd
(
ş›Á
 *
c
);

	@src/vr_scripting.h

1 #iâdeà
_VR_SCRIPTING_H_


2 
	#_VR_SCRIPTING_H_


	)

4 
sütCommªd
(
ş›Á
 *
c
);

	@src/vr_server.c

1 
	~<sys/ut¢ame.h
>

3 
	~<vr_cÜe.h
>

6 
vr_£rv”
 
	g£rv”
;

9 
sh¬edObjeùsSŒuù
 
	gsh¬ed
;

13 
	$diùSŒHash
(cÚ¡ *
key
) {

14  
	`diùG’HashFunùiÚ
((*)
key
, 
	`¡¾’
((*)key));

15 
	}
}

18 
	$diùSŒCa£Hash
(cÚ¡ *
key
) {

19  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`¡¾’
((*)key));

20 
	}
}

23 
	$diùSdsHash
(cÚ¡ *
key
) {

24  
	`diùG’HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

25 
	}
}

28 
	$diùSdsCa£Hash
(cÚ¡ *
key
) {

29  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

30 
	}
}

33 
	$diùSŒKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

34 cÚ¡ *
key2
)

36 
l1
,
l2
;

37 
	`DICT_NOTUSED
(
´ivd©a
);

39 
l1
 = 
	`¡¾’
((*)
key1
);

40 
l2
 = 
	`¡¾’
((*)
key2
);

41 ià(
l1
 !ğ
l2
)  0;

42  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

43 
	}
}

48 
	$diùSŒKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

49 cÚ¡ *
key2
)

51 
	`DICT_NOTUSED
(
´ivd©a
);

53  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

54 
	}
}

57 
	$diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

58 cÚ¡ *
key2
)

60 
l1
,
l2
;

61 
	`DICT_NOTUSED
(
´ivd©a
);

63 
l1
 = 
	`sd¦’
((
sds
)
key1
);

64 
l2
 = 
	`sd¦’
((
sds
)
key2
);

65 ià(
l1
 !ğ
l2
)  0;

66  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

67 
	}
}

72 
	$diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

73 cÚ¡ *
key2
)

75 
	`DICT_NOTUSED
(
´ivd©a
);

77  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

78 
	}
}

81 
	$diùSdsKeyDupFromSŒ
(*
´ivd©a
, cÚ¡ *
key
)

83 
	`DICT_NOTUSED
(
´ivd©a
);

85  
	`sd¢ew
(
key
);

86 
	}
}

89 
	$diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
)

91 
	`DICT_NOTUSED
(
´ivd©a
);

93 
	`sdsä“
(
v®
);

94 
	}
}

97 
	$diùObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

99 
	`DICT_NOTUSED
(
´ivd©a
);

101 ià(
v®
 =ğ
NULL
) ;

102 
	`ä“Objeù
(
v®
);

103 
	}
}

106 
	$diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

107 cÚ¡ *
key2
)

109 
robj
 *
o1
 = (robj*è
key1
, *
o2
 = (robj*è
key2
;

110 
robj
 *
o1_Ãw
, *
o2_Ãw
;

111 
cmp
;

113 ià(
o1
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

114 
o2
->
’codšg
 =ğ
OBJ_ENCODING_INT
)

115  
o1
->
±r
 =ğ
o2
->ptr;

117 
o1_Ãw
 = 
	`g‘DecodedObjeù
(
o1
);

118 
o2_Ãw
 = 
	`g‘DecodedObjeù
(
o2
);

119 
cmp
 = 
	`diùSdsKeyCom·»
(
´ivd©a
,
o1_Ãw
->
±r
,
o2_Ãw
->ptr);

120 ià(
o1_Ãw
 !ğ
o1
è
	`ä“Objeù
(o1_new);

121 ià(
o2_Ãw
 !ğ
o2
è
	`ä“Objeù
(o2_new);

122  
cmp
;

123 
	}
}

126 
	$diùEncObjHash
(cÚ¡ *
key
) {

127 
robj
 *
o
 = (robj*è
key
;

129 ià(
	`sdsEncodedObjeù
(
o
)) {

130  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

132 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

133 
buf
[32];

134 
Ën
;

136 
Ën
 = 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

137  
	`diùG’HashFunùiÚ
((*)
buf
, 
Ën
);

139 
hash
;

140 
robj
 *
o_Ãw
;

142 
o_Ãw
 = 
	`g‘DecodedObjeù
(
o
);

143 
hash
 = 
	`diùG’HashFunùiÚ
(
o_Ãw
->
±r
, 
	`sd¦’
((
sds
)o_new->ptr));

144 ià(
o_Ãw
!ğ
o
è
	`ä“Objeù
(o_new);

145  
hash
;

148 
	}
}

151 
	$diùObjHash
(cÚ¡ *
key
) {

152 cÚ¡ 
robj
 *
o
 = 
key
;

153  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

154 
	}
}

157 
	$diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

158 cÚ¡ *
key2
)

160 cÚ¡ 
robj
 *
o1
 = 
key1
, *
o2
 = 
key2
;

161  
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

162 
	}
}

165 
	$diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
)

167 
	`DICT_NOTUSED
(
´ivd©a
);

168 
	`dli¡R–—£
((
dli¡
*)
v®
);

169 
	}
}

172 
diùTy³
 
	ghashDiùTy³
 = {

173 
diùEncObjHash
,

174 
NULL
,

175 
NULL
,

176 
diùEncObjKeyCom·»
,

177 
diùObjeùDe¡ruùÜ
,

178 
diùObjeùDe¡ruùÜ


182 
diùTy³
 
	g£tDiùTy³
 = {

183 
diùEncObjHash
,

184 
NULL
,

185 
NULL
,

186 
diùEncObjKeyCom·»
,

187 
diùObjeùDe¡ruùÜ
,

188 
NULL


192 
diùTy³
 
	gz£tDiùTy³
 = {

193 
diùEncObjHash
,

194 
NULL
,

195 
NULL
,

196 
diùEncObjKeyCom·»
,

197 
diùObjeùDe¡ruùÜ
,

198 
NULL


205 
	$ü—‹Sh¬edObjeùs
() {

206 
j
;

207 
robj
 **
obj
;

209 
sh¬ed
.
ülf
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("\r\n"));

210 
sh¬ed
.
ok
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+OK\r\n"));

211 
sh¬ed
.
”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("-ERR\r\n"));

212 
sh¬ed
.
em±ybulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$0\r\n\r\n"));

213 
sh¬ed
.
cz”o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":0\r\n"));

214 
sh¬ed
.
cÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":1\r\n"));

215 
sh¬ed
.
úegÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":-1\r\n"));

216 
sh¬ed
.
nuÎbulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$-1\r\n"));

217 
sh¬ed
.
nuÎmuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*-1\r\n"));

218 
sh¬ed
.
em±ymuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*0\r\n"));

219 
sh¬ed
.
pÚg
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+PONG\r\n"));

220 
sh¬ed
.
queued
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+QUEUED\r\n"));

221 
sh¬ed
.
em±ysÿn
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*2\r\n$1\r\n0\r\n*0\r\n"));

222 
sh¬ed
.
wrÚgty³”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

224 
sh¬ed
.
nokey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

226 
sh¬ed
.
syÁax”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

228 
sh¬ed
.
§meobjeù”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

230 
sh¬ed
.
outoäªg“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

232 
sh¬ed
.
nosü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

234 
sh¬ed
.
lßdšg”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

236 
sh¬ed
.
¦owsü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

238 
sh¬ed
.
ma¡”dowÃ¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

240 
sh¬ed
.
bg§v“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

242 
sh¬ed
.
ro¦av“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

244 
sh¬ed
.
nßuth”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

246 
sh¬ed
.
nßdmš”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

248 
sh¬ed
.
oom”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

250 
sh¬ed
.
exeÿbÜ‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

252 
sh¬ed
.
nÜ•liÿ£¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

254 
sh¬ed
.
busykey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

256 
sh¬ed
.
¥aû
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(" "));

257 
sh¬ed
.
cŞÚ
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":"));

258 
sh¬ed
.
¶us
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+"));

260 
j
 = 0; j < 
PROTO_SHARED_SELECT_CMDS
; j++) {

261 
diùid_¡r
[64];

262 
diùid_Ën
;

264 
diùid_Ën
 = 
	`Î2¡ršg
(
diùid_¡r
,(diùid_¡r),
j
);

265 
sh¬ed
.
£Ëù
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

266 
	`sdsÿrštf
(
	`sd£m±y
(),

268 
diùid_Ën
, 
diùid_¡r
));

270 
sh¬ed
.
mes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$7\r\nmessage\r\n",13);

271 
sh¬ed
.
pmes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$8\r\npmessage\r\n",14);

272 
sh¬ed
.
subsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$9\r\nsubscribe\r\n",15);

273 
sh¬ed
.
unsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$11\r\nunsubscribe\r\n",18);

274 
sh¬ed
.
psubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$10\r\npsubscribe\r\n",17);

275 
sh¬ed
.
punsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$12\r\npunsubscribe\r\n",19);

276 
sh¬ed
.
d–
 = 
	`ü—‹SŒšgObjeù
("DEL",3);

277 
sh¬ed
.
½İ
 = 
	`ü—‹SŒšgObjeù
("RPOP",4);

278 
sh¬ed
.
Íİ
 = 
	`ü—‹SŒšgObjeù
("LPOP",4);

279 
sh¬ed
.
Íush
 = 
	`ü—‹SŒšgObjeù
("LPUSH",5);

280 
j
 = 0; j < 
OBJ_SHARED_INTEGERS
; j++) {

281 
sh¬ed
.
š‹g”s
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,(*)()j);

282 
sh¬ed
.
š‹g”s
[
j
]->
’codšg
 = 
OBJ_ENCODING_INT
;

284 
j
 = 0; j < 
OBJ_SHARED_BULKHDR_LEN
; j++) {

285 
sh¬ed
.
mbulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

286 
	`sdsÿrštf
(
	`sd£m±y
(),"*%d\r\n",
j
));

287 
sh¬ed
.
bulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

288 
	`sdsÿrštf
(
	`sd£m±y
(),"$%d\r\n",
j
));

294 
sh¬ed
.
mš¡ršg
 = 
	`ü—‹SŒšgObjeù
("minstring",9);

295 
sh¬ed
.
max¡ršg
 = 
	`ü—‹SŒšgObjeù
("maxstring",9);

297 
sh¬ed
.
outofcom¶ex™ylim™
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

301 
obj
 = &
sh¬ed
; *obj !ğ
NULL
; obj ++) {

302 (*
obj
)->
cÚ¡ªt
 = 1;

304 
	}
}

308 
	$š™_£rv”
(
š¡ªû
 *
nci
)

310 
»t
;

311 
ušt32_t
 
i
;

312 
»disDb
 *
db
;

314 
£rv”
.
pid
 = 
	`g‘pid
();

315 
£rv”
.
¬ch_b™s
 = (() == 8) ? 64 : 32;

316 
£rv”
.
¡¬‰ime
 = 
	`time
(
NULL
);

317 
	`g‘_¿ndom_hex_ch¬s
(
£rv”
.
runid
, 
CONFIG_RUN_ID_SIZE
);

319 
£rv”
.
commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

321 
	`pİuÏ‹CommªdTabË
();

323 
£rv”
.
d–Commªd
 = 
	`lookupCommªdByCSŒšg
("del");

324 
£rv”
.
muÉiCommªd
 = 
	`lookupCommªdByCSŒšg
("multi");

325 
£rv”
.
ÍushCommªd
 = 
	`lookupCommªdByCSŒšg
("lpush");

326 
£rv”
.
ÍİCommªd
 = 
	`lookupCommªdByCSŒšg
("lpop");

327 
£rv”
.
½İCommªd
 = 
	`lookupCommªdByCSŒšg
("rpop");

328 
£rv”
.
¤emCommªd
 = 
	`lookupCommªdByCSŒšg
("srem");

329 
£rv”
.
execCommªd
 = 
	`lookupCommªdByCSŒšg
("exec");

332 
cÚf
 = 
	`cÚf_ü—‹
(
nci
->
cÚf_f’ame
);

335 
»t
 = 
	`pİuÏ‹CommªdsN“dAdmš·ss
();

336 ià(
»t
 !ğ
VR_OK
) {

337 
	`log_”rÜ
("Populate‚eed‡dminpass commands failed");

338  
VR_ERROR
;

341 
£rv”
.
cÚfigfe
 = 
	`g‘AbsŞu‹P©h
(
nci
->
cÚf_f’ame
);

342 
£rv”
.
hz
 = 10;

343 
£rv”
.
dbÊum
 = 
c£rv”
->
d©aba£s
;

344 
£rv”
.
dbšum
 = 
c£rv”
->
š‹º®_dbs_³r_d©aba£s
;

345 
£rv”
.
dbnum
 = s”v”.
dbÊum
*£rv”.
dbšum
;

347 
	`d¬¿y_š™
(&
£rv”
.
dbs
, s”v”.
dbnum
, (
»disDb
));

348 
£rv”
.
pidfe
 = 
nci
->
pid_f’ame
;

349 
£rv”
.
execubË
 = 
NULL
;

350 
£rv”
.
aùiv”ehashšg
 = 
CONFIG_DEFAULT_ACTIVE_REHASHING
;

352 
£rv”
.
ş›Á_max_qu”ybuf_Ën
 = 
PROTO_MAX_QUERYBUF_LEN
;

355 
i
 = 0; i < 
£rv”
.
dbnum
; i ++) {

356 
db
 = 
	`d¬¿y_push
(&
£rv”
.
dbs
);

357 
	`»disDbIn™
(
db
);

360 
£rv”
.
ş›Ás
 = 
	`dli¡C»©e
();

362 
£rv”
.
mÚ™Üs
 = 
	`dli¡C»©e
();

364 
£rv”
.
lßdšg
 = 0;

366 
£rv”
.
lua_timedout
 = 0;

368 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

370 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 0;

372 
£rv”
.
»ady_keys
 = 
	`dli¡C»©e
();

374 
£rv”
.
sy¡em_memÜy_size
 = 
	`d®loc_g‘_memÜy_size
();

376 
£rv”
.
rdb_chd_pid
 = -1;

377 
£rv”
.
aof_chd_pid
 = -1;

379 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
OBJ_HASH_MAX_ZIPLIST_ENTRIES
;

380 
£rv”
.
hash_max_zli¡_v®ue
 = 
OBJ_HASH_MAX_ZIPLIST_VALUE
;

381 
£rv”
.
li¡_max_zli¡_size
 = 
OBJ_LIST_MAX_ZIPLIST_SIZE
;

382 
£rv”
.
li¡_com´ess_d•th
 = 
OBJ_LIST_COMPRESS_DEPTH
;

383 
£rv”
.
£t_max_št£t_’Œ›s
 = 
OBJ_SET_MAX_INTSET_ENTRIES
;

384 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
OBJ_ZSET_MAX_ZIPLIST_ENTRIES
;

385 
£rv”
.
z£t_max_zli¡_v®ue
 = 
OBJ_ZSET_MAX_ZIPLIST_VALUE
;

386 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
;

388 
£rv”
.
nÙify_key¥aû_ev’ts
 = 0;

390 
	`¦owlogIn™
();

392 
	`vr_»¶iÿtiÚ_š™
();

394 
	`ü—‹Sh¬edObjeùs
();

399 
£rv”
.
pÜt
 = 
c£rv”
->port;

403 
»t
 = 
	`wÜk”s_š™
(
nci
->
th»ad_num
);

404 ià(
»t
 !ğ
VR_OK
) {

405 
	`log_”rÜ
("Init workerhreads failed");

406  
VR_ERROR
;

411 
»t
 = 
	`ma¡”_š™
(
cÚf
);

412 ià(
»t
 !ğ
VR_OK
) {

413 
	`log_”rÜ
("Init masterhread failed");

414  
VR_ERROR
;

417 
»t
 = 
	`back’ds_š™
(1);

418 ià(
»t
 !ğ
VR_OK
) {

419 
	`log_”rÜ
("Init backendhreads failed");

420  
VR_ERROR
;

423 
	`log_debug
(
LOG_NOTICE
, "memÜy‡Îoølocky³: %s", 
	`m®loc_lock_ty³
());

424 
	`log_debug
(
LOG_NOTICE
, "m®loølib: %s", 
DMALLOC_LIB
);

426 
	`log_debug
(
LOG_NOTICE
, "¡© locky³: %s", 
STATS_LOCK_TYPE
);

428  
VR_OK
;

429 
	}
}

431 
	$g‘LRUClock
() {

432  (
	`vr_m£c_now
()/
LRU_CLOCK_RESOLUTION
è& 
LRU_CLOCK_MAX
;

433 
	}
}

444 
	#EVICTION_SAMPLES_ARRAY_SIZE
 16

	)

445 
	$eviùiÚPoŞPİuÏ‹
(
diù
 *
§m¶ediù
, diù *
keydiù
,

446 
eviùiÚPoŞEÁry
 *
poŞ
, 
maxmemÜy_§m¶es
) {

447 
j
, 
k
, 
couÁ
;

448 
diùEÁry
 *
_§m¶es
[
EVICTION_SAMPLES_ARRAY_SIZE
];

449 
diùEÁry
 **
§m¶es
;

453 ià(
maxmemÜy_§m¶es
 <ğ
EVICTION_SAMPLES_ARRAY_SIZE
) {

454 
§m¶es
 = 
_§m¶es
;

456 
§m¶es
 = 
	`d®loc
((§m¶es[0])*
maxmemÜy_§m¶es
);

459 
couÁ
 = 
	`diùG‘SomeKeys
(
§m¶ediù
,
§m¶es
,
maxmemÜy_§m¶es
);

460 
j
 = 0; j < 
couÁ
; j++) {

461 
idË
;

462 
sds
 
key
;

463 
robj
 *
o
;

464 
diùEÁry
 *
de
;

466 
de
 = 
§m¶es
[
j
];

467 
key
 = 
	`diùG‘Key
(
de
);

471 ià(
§m¶ediù
 !ğ
keydiù
è
de
 = 
	`diùFšd
(keydiù, 
key
);

472 
o
 = 
	`diùG‘V®
(
de
);

473 
idË
 = 
	`e¡im©eObjeùIdËTime
(
o
);

478 
k
 = 0;

479 
k
 < 
MAXMEMORY_EVICTION_POOL_SIZE
 &&

480 
poŞ
[
k
].
key
 &&

481 
poŞ
[
k
].
idË
 < idle) k++;

482 ià(
k
 =ğ0 && 
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
key
 !ğ
NULL
) {

486 } ià(
k
 < 
MAXMEMORY_EVICTION_POOL_SIZE
 && 
poŞ
[k].
key
 =ğ
NULL
) {

491 ià(
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
key
 =ğ
NULL
) {

494 
	`memmove
(
poŞ
+
k
+1,pool+k,

495 (
poŞ
[0])*(
MAXMEMORY_EVICTION_POOL_SIZE
-
k
-1));

498 
k
--;

501 
	`sdsä“
(
poŞ
[0].
key
);

502 
	`memmove
(
poŞ
,poŞ+1,ÕoŞ[0])*
k
);

505 
poŞ
[
k
].
key
 = 
	`sdsdup
(key);

506 
poŞ
[
k
].
idË
 = idle;

508 ià(
§m¶es
 !ğ
_§m¶es
è
	`dä“
(samples);

509 
	}
}

511 
	$ä“MemÜyIfN“ded
(
vr_ev’oİ
 *
v–
) {

512 
size_t
 
mem_u£d
, 
mem_toä“
, 
mem_ä“d
;

513 
m¡ime_t
 
Ï‹ncy
, 
eviùiÚ_Ï‹ncy
;

514 
keys_ä“d
 = 0;

515 
maxmemÜy
;

516 
maxmemÜy_pŞicy
, 
maxmemÜy_§m¶es
;

517 
»t
;

519 
maxmemÜy
 = 
v–
->
cc
.maxmemory;

520 ià(
	`d®loc_u£d_memÜy
(è<ğ
maxmemÜy
)

521  
VR_OK
;

523 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORYP
, &
maxmemÜy_pŞicy
);

524 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_NO_EVICTION
)

525  
VR_ERROR
;

527 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORYS
, &
maxmemÜy_§m¶es
);

529 
j
, 
k
;

531 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

532 
be¡v®
 = 0;

533 
sds
 
be¡key
 = 
NULL
;

534 
diùEÁry
 *
de
;

535 
»disDb
 *
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
j
);

536 
diù
 *dict;

538 
	`lockDbWr™e
(
db
);

539 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_LRU
 ||

540 
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
)

542 
diù
 = 
db
->dict;

544 
diù
 = 
db
->
expœes
;

546 ià(
	`diùSize
(
diù
) == 0) {

547 
	`uÆockDb
(
db
);

552 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
 ||

553 
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_RANDOM
)

555 
de
 = 
	`diùG‘RªdomKey
(
diù
);

556 
be¡key
 = 
	`diùG‘Key
(
de
);

560 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_LRU
 ||

561 
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_LRU
)

563 
eviùiÚPoŞEÁry
 *
poŞ
 = 
db
->
eviùiÚ_poŞ
;

565 
be¡key
 =ğ
NULL
) {

566 
	`eviùiÚPoŞPİuÏ‹
(
diù
, 
db
->diù, db->
eviùiÚ_poŞ
, 
maxmemÜy_§m¶es
);

568 
k
 = 
MAXMEMORY_EVICTION_POOL_SIZE
-1; k >= 0; k--) {

569 ià(
poŞ
[
k
].
key
 =ğ
NULL
) ;

570 
de
 = 
	`diùFšd
(
diù
,
poŞ
[
k
].
key
);

573 
	`sdsä“
(
poŞ
[
k
].
key
);

575 
	`memmove
(
poŞ
+
k
,pool+k+1,

576 (
poŞ
[0])*(
MAXMEMORY_EVICTION_POOL_SIZE
-
k
-1));

579 
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
key
 = 
NULL
;

580 
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
idË
 = 0;

584 ià(
de
) {

585 
be¡key
 = 
	`diùG‘Key
(
de
);

596 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_TTL
) {

597 
k
 = 0; k < 
maxmemÜy_§m¶es
; k++) {

598 
sds
 
thiskey
;

599 
thisv®
;

601 
de
 = 
	`diùG‘RªdomKey
(
diù
);

602 
thiskey
 = 
	`diùG‘Key
(
de
);

603 
thisv®
 = (è
	`diùG‘V®
(
de
);

607 ià(
be¡key
 =ğ
NULL
 || 
thisv®
 < 
be¡v®
) {

608 
be¡key
 = 
thiskey
;

609 
be¡v®
 = 
thisv®
;

615 ià(
be¡key
) {

616 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
be¡key
,
	`sd¦’
(bestkey));

617 
	`dbD–‘e
(
db
,
keyobj
);

618 
	`ä“Objeù
(
keyobj
);

619 
keys_ä“d
++;

622 
	`uÆockDb
(
db
);

624 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
, &
maxmemÜy
);

625 ià(
	`d®loc_u£d_memÜy
(è<ğ
maxmemÜy
) {

626 
¡İ
;

630 ià(!
keys_ä“d
) {

631  
VR_ERROR
;

634 
	`upd©e_¡©s_add
(
v–
->
¡©s
, 
eviùedkeys
, 
keys_ä“d
);

635 
keys_ä“d
 = 0;

638 
¡İ
:

639 
	`upd©e_¡©s_add
(
v–
->
¡©s
, 
eviùedkeys
, 
keys_ä“d
);

640  
VR_OK
;

641 
	}
}

645 
	$pšgCommªd
(
ş›Á
 *
c
) {

647 ià(
c
->
¬gc
 > 2) {

648 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

649 
c
->
cmd
->
Çme
);

653 ià(
c
->
æags
 & 
CLIENT_PUBSUB
) {

654 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[2]);

655 
	`addR•lyBulkCBufãr
(
c
,"pong",4);

656 ià(
c
->
¬gc
 == 1)

657 
	`addR•lyBulkCBufãr
(
c
,"",0);

659 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

661 ià(
c
->
¬gc
 == 1)

662 
	`addR•ly
(
c
,
sh¬ed
.
pÚg
);

664 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

666 
	}
}

677 
	$time_šd•’d’t_¡rcmp
(*
a
, *
b
) {

678 
buç
[
CONFIG_AUTHPASS_MAX_LEN
], 
bufb
[CONFIG_AUTHPASS_MAX_LEN];

683 
®’
 = 
	`¡¾’
(
a
);

684 
bËn
 = 
	`¡¾’
(
b
);

685 
j
;

686 
diff
 = 0;

691 ià(
®’
 > (
buç
è|| 
bËn
 > (
bufb
))  1;

693 
	`mem£t
(
buç
,0,(bufa));

694 
	`mem£t
(
bufb
,0,(bufb));

697 
	`memıy
(
buç
,
a
,
®’
);

698 
	`memıy
(
bufb
,
b
,
bËn
);

702 
j
 = 0; j < (
buç
); j++) {

703 
diff
 |ğ(
buç
[
j
] ^ 
bufb
[j]);

706 
diff
 |ğ
®’
 ^ 
bËn
;

707  
diff
;

708 
	}
}

710 
	$authCommªd
(
ş›Á
 *
c
) {

711 
sds
 
»quœ•ass
;

713 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_REQUIREPASS
,&
»quœ•ass
);

714 ià(!
»quœ•ass
) {

715 
	`addR•lyE¼Ü
(
c
,"Client sent AUTH, but‚o…assword is set");

717 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
»quœ•ass
)) {

718 ià(!
c
->
auth’tiÿ‹d
)

719 
c
->
auth’tiÿ‹d
 = 1;

720 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

722 
c
->
auth’tiÿ‹d
 = 0;

723 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

725 
	`sdsä“
(
»quœ•ass
);

726 
	}
}

728 
	$admšCommªd
(
ş›Á
 *
c
) {

729 
sds
 
admš·ss
;

731 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_ADMINPASS
,&
admš·ss
);

732 ià(!
admš·ss
) {

733 
	`addR•lyE¼Ü
(
c
,"Client sent ADMIN, but‚o…assword is set");

735 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
admš·ss
)) {

736 
c
->
auth’tiÿ‹d
 = 2;

737 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

739 
c
->
auth’tiÿ‹d
 = 0;

740 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

742 
	`sdsä“
(
admš·ss
);

743 
	}
}

745 
	$htN“dsResize
(
diù
 *dict) {

746 
size
, 
u£d
;

748 
size
 = 
	`diùSlÙs
(
diù
);

749 
u£d
 = 
	`diùSize
(
diù
);

750  (
size
 && 
u£d
 && siz> 
DICT_HT_INITIAL_SIZE
 &&

751 (
u£d
*100/
size
 < 
HASHTABLE_MIN_FILL
));

752 
	}
}

754 
	skeys_¡©i¡ics
 {

755 
	mkeys_®l
;

756 
	mvkeys_®l
;

757 
	mavg_‰l_®l
;

758 
	mÃxi¡
;

764 
sds
 
	$g’VœeInfoSŒšg
(
vr_ev’oİ
 *
v–
, *
£ùiÚ
) {

765 
sds
 
šfo
 = 
	`sd£m±y
();

766 
time_t
 
u±ime
 = 
	`time
(
NULL
)-
£rv”
.
¡¬‰ime
;

767 
j
, 
k
, 
numcommªds
;

768 
ru§ge
 
£lf_ru
;

769 
lŞ
, 
bib
;

770 
®l£ùiÚs
 = 0, 
def£ùiÚs
 = 0;

771 
£ùiÚs
 = 0;

772 
d¬¿y
 *
kss
 = 
NULL
;

774 ià(
£ùiÚ
 =ğ
NULL
) section = "default";

775 
®l£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"all") == 0;

776 
def£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"default") == 0;

778 
	`g‘ru§ge
(
RUSAGE_SELF
, &
£lf_ru
);

781 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"server")) {

782 
ÿÎ_uÇme
 = 1;

783 
ut¢ame
 
Çme
;

784 *
mode
;

786 
mode
 = "standalone";

788 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

790 ià(
ÿÎ_uÇme
) {

792 
	`uÇme
(&
Çme
);

793 
ÿÎ_uÇme
 = 0;

796 
šfo
 = 
	`sdsÿrštf
(info,

814 
VR_VERSION_STRING
,

815 
mode
,

816 
Çme
.
sy¢ame
,‚ame.
»Ëa£
,‚ame.
machše
,

817 
£rv”
.
¬ch_b™s
,

818 
	`«G‘ApiName
(),

819 #ifdeà
__GNUC__


820 
__GNUC__
,
__GNUC_MINOR__
,
__GNUC_PATCHLEVEL__
,

824 (è
	`g‘pid
(),

825 
£rv”
.
runid
,

826 
£rv”
.
pÜt
,

827 (
štmax_t
)
u±ime
,

828 (
štmax_t
)(
u±ime
/(3600*24)),

829 
£rv”
.
hz
,

830 
£rv”
.
execubË
 ? server.executable : "",

831 
£rv”
.
cÚfigfe
 ? server.configfile : "",

832 
£rv”
.
dbÊum
,

833 
£rv”
.
dbšum
);

837 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"clients")) {

838 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

839 
šfo
 = 
	`sdsÿrštf
(info,

842 
	`cu¼’t_ş›Ás
());

846 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"memory")) {

847 
ušt32_t
 
idx
;

848 
vr_wÜk”
 *
wÜk”
;

849 
hmem
[64];

850 
³ak_hmem
[64];

851 
tÙ®_sy¡em_hmem
[64];

852 
u£d_memÜy_lua_hmem
[64];

853 
u£d_memÜy_rss_hmem
[64];

854 
maxmemÜy_hmem
[64];

855 
size_t
 
vr_u£d_memÜy
 = 
	`d®loc_u£d_memÜy
();

856 
size_t
 
tÙ®_sy¡em_mem
 = 
£rv”
.
sy¡em_memÜy_size
;

857 cÚ¡ *
eviù_pŞicy
;

858 
size_t
 
³ak_memÜy
 = 0, 
³ak_memÜy_fÜ_Úe_wÜk”
;

859 
maxmemÜy
;

860 
maxmemÜy_pŞicy
;

866 
idx
 = 0; idx < 
	`d¬¿y_n
(&
wÜk”s
); idx ++) {

867 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
idx
);

868 
	`upd©e_¡©s_g‘
(
wÜk”
->
v–
.
¡©s
, 
³ak_memÜy
,

869 &
³ak_memÜy_fÜ_Úe_wÜk”
);

870 ià(
³ak_memÜy
 < 
³ak_memÜy_fÜ_Úe_wÜk”
)

871 
³ak_memÜy
 = 
³ak_memÜy_fÜ_Úe_wÜk”
;

873 ià(
vr_u£d_memÜy
 > 
³ak_memÜy
) {

874 
³ak_memÜy
 = 
vr_u£d_memÜy
;

875 
	`upd©e_¡©s_£t
(
v–
->
¡©s
, 
³ak_memÜy
, 
vr_u£d_memÜy
);

878 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
maxmemÜy
);

879 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORYP
,&
maxmemÜy_pŞicy
);

880 
eviù_pŞicy
 = 
	`g‘_eviùpŞicy_¡ršgs
(
maxmemÜy_pŞicy
);

882 
	`by‹sToHumª
(
hmem
,
vr_u£d_memÜy
);

883 
	`by‹sToHumª
(
³ak_hmem
,
³ak_memÜy
);

884 
	`by‹sToHumª
(
tÙ®_sy¡em_hmem
,
tÙ®_sy¡em_mem
);

885 
	`by‹sToHumª
(
u£d_memÜy_rss_hmem
,
v–
->
»sid’t_£t_size
);

886 
	`by‹sToHumª
(
maxmemÜy_hmem
,
maxmemÜy
);

888 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

889 
šfo
 = 
	`sdsÿrštf
(info,

904 
vr_u£d_memÜy
,

905 
hmem
,

906 
v–
->
»sid’t_£t_size
,

907 
u£d_memÜy_rss_hmem
,

908 
³ak_memÜy
,

909 
³ak_hmem
,

910 ()
tÙ®_sy¡em_mem
,

911 
tÙ®_sy¡em_hmem
,

912 
maxmemÜy
,

913 
maxmemÜy_hmem
,

914 
eviù_pŞicy
,

915 ()
v–
->
»sid’t_£t_size
/
vr_u£d_memÜy
,

916 
DMALLOC_LIB


921 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"stats")) {

922 
ušt32_t
 
idx
;

923 
vr_¡©s
 *
¡©s
;

924 
¡©_numcÚÃùiÚs
=0, 
¡©_numcommªds
=0;

925 
¡©_Ãt_šput_by‹s
=0, 
¡©_Ãt_ouut_by‹s
=0;

926 
¡©_»jeùed_cÚn
=0;

927 
¡©_expœedkeys
=0;

928 
¡©_eviùedkeys
=0;

929 
¡©_key¥aû_h™s
=0, 
¡©_key¥aû_mis£s
=0;

930 
¡©_numcommªds_İs
=0;

931 
¡©_Ãt_šput_by‹s_İs
=0, 
¡©_Ãt_ouut_by‹s_İs
=0;

933 
idx
 = 0; idx < 
	`d¬¿y_n
(&
wÜk”s
); idx ++) {

934 
¡©s_v®ue
;

935 
vr_wÜk”
 *
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
idx
);

936 
¡©s
 = 
wÜk”
->
v–
.stats;

938 
	`upd©e_¡©s_g‘
(
¡©s
, 
numcommªds
, &
¡©s_v®ue
);

939 
¡©_numcommªds
 +ğ
¡©s_v®ue
;

940 
	`upd©e_¡©s_g‘
(
¡©s
, 
numcÚÃùiÚs
, &
¡©s_v®ue
);

941 
¡©_numcÚÃùiÚs
 +ğ
¡©s_v®ue
;

942 
	`upd©e_¡©s_g‘
(
¡©s
, 
expœedkeys
, &
¡©s_v®ue
);

943 
¡©_expœedkeys
 +ğ
¡©s_v®ue
;

944 
	`upd©e_¡©s_g‘
(
¡©s
, 
eviùedkeys
, &
¡©s_v®ue
);

945 
¡©_eviùedkeys
 +ğ
¡©s_v®ue
;

946 
	`upd©e_¡©s_g‘
(
¡©s
, 
Ãt_šput_by‹s
, &
¡©s_v®ue
);

947 
¡©_Ãt_šput_by‹s
 +ğ
¡©s_v®ue
;

948 
	`upd©e_¡©s_g‘
(
¡©s
, 
Ãt_ouut_by‹s
, &
¡©s_v®ue
);

949 
¡©_Ãt_ouut_by‹s
 +ğ
¡©s_v®ue
;

950 
	`upd©e_¡©s_g‘
(
¡©s
, 
key¥aû_h™s
, &
¡©s_v®ue
);

951 
¡©_key¥aû_h™s
 +ğ
¡©s_v®ue
;

952 
	`upd©e_¡©s_g‘
(
¡©s
, 
key¥aû_mis£s
, &
¡©s_v®ue
);

953 
¡©_key¥aû_mis£s
 +ğ
¡©s_v®ue
;

955 
¡©_numcommªds_İs
 +ğ
	`g‘In¡ªÃousM‘ric
(
¡©s
, 
STATS_METRIC_COMMAND
);

956 
¡©_Ãt_šput_by‹s_İs
 +ğ()
	`g‘In¡ªÃousM‘ric
(
¡©s
, 
STATS_METRIC_NET_INPUT
)/1024;

957 
¡©_Ãt_ouut_by‹s_İs
 +ğ()
	`g‘In¡ªÃousM‘ric
(
¡©s
, 
STATS_METRIC_NET_OUTPUT
)/1024;

959 
idx
 = 0; idx < 
	`d¬¿y_n
(&
back’ds
); idx ++) {

960 
¡©s_v®ue
;

961 
vr_back’d
 *
back’d
 = 
	`d¬¿y_g‘
(&
back’ds
, 
idx
);

962 
¡©s
 = 
back’d
->
v–
.stats;

964 
	`upd©e_¡©s_g‘
(
¡©s
, 
expœedkeys
, &
¡©s_v®ue
);

965 
¡©_expœedkeys
 +ğ
¡©s_v®ue
;

967 
	`upd©e_¡©s_g‘
(
ma¡”
.
v–
.
¡©s
, 
»jeùed_cÚn
, &
¡©_»jeùed_cÚn
);

969 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

970 
šfo
 = 
	`sdsÿrštf
(info,

984 
¡©_numcÚÃùiÚs
,

985 
¡©_numcommªds
,

986 
¡©_numcommªds_İs
,

987 
¡©_Ãt_šput_by‹s
,

988 
¡©_Ãt_ouut_by‹s
,

989 
¡©_Ãt_šput_by‹s_İs
,

990 
¡©_Ãt_ouut_by‹s_İs
,

991 
¡©_»jeùed_cÚn
,

992 
¡©_expœedkeys
,

993 
¡©_eviùedkeys
,

994 
¡©_key¥aû_h™s
,

995 
¡©_key¥aû_mis£s
);

999 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cpu")) {

1000 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

1001 
šfo
 = 
	`sdsÿrštf
(info,

1005 ()
£lf_ru
.
ru_¡ime
.
tv_£c
+()£lf_ru.ru_¡ime.
tv_u£c
/1000000,

1006 ()
£lf_ru
.
ru_utime
.
tv_£c
+()£lf_ru.ru_utime.
tv_u£c
/1000000);

1010 ià(
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"internal")) {

1011 
»disDb
 *
db
;

1012 
keys_¡©i¡ics
 *
ks
;

1013 
keys
, 
vkeys
, 
avg_‰l
;

1015 
kss
 = 
	`d¬¿y_ü—‹
(
£rv”
.
dbÊum
, (
keys_¡©i¡ics
));

1017 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

1018 
šfo
 = 
	`sdsÿrštf
(info, "# Internal\r\n");

1019 
j
 = 0; j < 
£rv”
.
dbÊum
; j++) {

1020 
ks
 = 
	`d¬¿y_push
(
kss
);

1021 
ks
->
keys_®l
 = ks->
vkeys_®l
 = ks->
avg_‰l_®l
 = 0;

1022 
ks
->
Ãxi¡
 = 0;

1023 
k
 = 0; k < 
£rv”
.
dbšum
; k ++) {

1024 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)(
j
*£rv”.
dbšum
+
k
));

1025 
	`lockDbR—d
(
db
);

1026 
keys
 = 
	`diùSize
(
db
->
diù
);

1027 
vkeys
 = 
	`diùSize
(
db
->
expœes
);

1028 
avg_‰l
 = 
db
->avg_ttl;

1029 
	`uÆockDb
(
db
);

1030 ià(
keys
 || 
vkeys
) {

1031 
šfo
 = 
	`sdsÿrštf
(info,

1033 
j
, 
k
, 
keys
, 
vkeys
, 
db
->
avg_‰l
);

1035 
ks
->
keys_®l
 +ğ
keys
;

1036 
ks
->
vkeys_®l
 +ğ
vkeys
;

1037 
ks
->
avg_‰l_®l
 +ğ
avg_‰l
;

1038 ià(
avg_‰l
 > 0è
ks
->
Ãxi¡
 ++;

1044 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"keyspace")) {

1045 
»disDb
 *
db
;

1046 
keys_¡©i¡ics
 *
ks
;

1047 
keys_®l
, 
vkeys_®l
, 
avg_‰l_®l
;

1048 
Ãxi¡
;

1050 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

1051 
šfo
 = 
	`sdsÿrštf
(info, "# Keyspace\r\n");

1052 ià(
kss
 =ğ
NULL
) {

1053 
j
 = 0; j < 
£rv”
.
dbÊum
; j++) {

1054 
keys_®l
 = 
vkeys_®l
 = 
avg_‰l_®l
 = 0;

1055 
Ãxi¡
 = 0;

1056 
k
 = 0; k < 
£rv”
.
dbšum
; k ++) {

1057 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)(
j
*£rv”.
dbšum
+
k
));

1058 
	`lockDbR—d
(
db
);

1059 
keys_®l
 +ğ
	`diùSize
(
db
->
diù
);

1060 
vkeys_®l
 +ğ
	`diùSize
(
db
->
expœes
);

1061 
avg_‰l_®l
 +ğ
db
->
avg_‰l
;

1062 ià(
db
->
avg_‰l
 > 0è
Ãxi¡
 ++;

1063 
	`uÆockDb
(
db
);

1065 ià(
keys_®l
 || 
vkeys_®l
) {

1066 
šfo
 = 
	`sdsÿrštf
(info,

1068 
j
, 
keys_®l
, 
vkeys_®l
, 
Ãxi¡
>0?(
avg_‰l_®l
/nexist):0);

1072 
j
 = 0; j < 
£rv”
.
dbÊum
; j ++) {

1073 
ks
 = 
	`d¬¿y_g‘
(
kss
, 
j
);

1074 ià(
ks
->
keys_®l
 || ks->
vkeys_®l
) {

1075 
šfo
 = 
	`sdsÿrštf
(info,

1077 
j
, 
ks
->
keys_®l
, ks->
vkeys_®l
,

1078 
ks
->
Ãxi¡
>0?(ks->
avg_‰l_®l
/ks->nexist):0);

1084 
šfo
 = 
	`sdsÿrštf
(info,"\n--------------------------create by:å¼ èª--------------------------------------\n\r");

1086 ià(
kss
 !ğ
NULL
) {

1087 
kss
->
ÃËm
 = 0;

1088 
	`d¬¿y_de¡roy
(
kss
);

1089 
kss
 = 
NULL
;

1092  
šfo
;

1093 
	}
}

1095 
	$šfoCommªd
(
ş›Á
 *
c
) {

1096 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : "default";

1098 ià(
c
->
¬gc
 > 2) {

1099 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1102 
	`addR•lyBulkSds
(
c
, 
	`g’VœeInfoSŒšg
(c->
v–
, 
£ùiÚ
));

1103 
	}
}

1105 
	$echoCommªd
(
ş›Á
 *
c
) {

1106 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

1107 
	}
}

1109 
	$timeCommªd
(
ş›Á
 *
c
) {

1110 
timev®
 
tv
;

1114 
	`g‘timeofday
(&
tv
,
NULL
);

1115 
	`addR•lyMuÉiBulkL’
(
c
,2);

1116 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_£c
);

1117 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_u£c
);

1118 
	}
}

1129 
	$adju¡O³nFesLim™
(
maxş›Ás
) {

1130 
¾im_t
 
maxfes
, 
fš®lim™
 = 0;

1131 
¾im_t
 
Şdlim™
;

1132 
fš®maxş›Ás
;

1133 
¾im™
 
lim™
;

1134 
th»ads
;

1136 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_THREADS
,&
th»ads
);

1137 
maxfes
 = 
maxş›Ás
+
th»ads
*2+
CONFIG_MIN_RESERVED_FDS
;

1138 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
,&
lim™
) == -1) {

1139 
	`log_w¬n
("Unableo obtainhe current NOFILE†imit (%s),‡ssuming 1024‡nd settinghe max clients configuration‡ccordingly.",

1140 
	`¡»¼Ü
(
”ºo
));

1141 
Şdlim™
 = 1024;

1142 
fš®lim™
 = 
Şdlim™
;

1144 
Şdlim™
 = 
lim™
.
¾im_cur
;

1148 ià(
Şdlim™
 < 
maxfes
) {

1149 
¾im_t
 
be¡lim™
;

1150 
£Œlim™_”rÜ
 = 0;

1154 
be¡lim™
 = 
maxfes
;

1155 
be¡lim™
 > 
Şdlim™
) {

1156 
¾im_t
 
deü_¡•
 = 16;

1158 
lim™
.
¾im_cur
 = 
be¡lim™
;

1159 
lim™
.
¾im_max
 = 
be¡lim™
;

1160 ià(
	`£Œlim™
(
RLIMIT_NOFILE
,&
lim™
) != -1) ;

1161 
£Œlim™_”rÜ
 = 
”ºo
;

1165 ià(
be¡lim™
 < 
deü_¡•
) ;

1166 
be¡lim™
 -ğ
deü_¡•
;

1171 ià(
be¡lim™
 < 
Şdlim™
) bestlimit = oldlimit;

1173 
fš®lim™
 = 
be¡lim™
;

1174 ià(
be¡lim™
 < 
maxfes
) {

1175 
	`log_w¬n
("You„equested maxclients of %d "

1177 
maxş›Ás
,

1178 (è
maxfes
);

1179 
	`log_w¬n
("Server can't set maximum open files "

1181 (è
maxfes
, 
	`¡»¼Ü
(
£Œlim™_”rÜ
));

1182 
	`log_w¬n
("Current maximum open files is %llu. ",

1183 (è
be¡lim™
);

1185 
	`log_w¬n
("Increased maximum‚umber of open files "

1187 (è
maxfes
,

1188 (è
Şdlim™
);

1191 
fš®lim™
 = 
maxfes
;

1195 
fš®maxş›Ás
 = 
fš®lim™
-
th»ads
*2-
CONFIG_MIN_RESERVED_FDS
;

1196 ià(
fš®maxş›Ás
 < 1) {

1197 
	`log_w¬n
("Your current 'ulimit -n' "

1201 (è
Şdlim™
,

1202 (è
maxfes
);

1206 ià(
fš®lim™
 < 
maxfes
) {

1207 
cÚf_v®ue
 *
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1208 
cv
->
v®ue
 = 
	`sdsäomlÚglÚg
(()
fš®maxş›Ás
);

1209 
	`cÚf_£rv”_£t
(
CONFIG_SOPN_MAXCLIENTS
,
cv
);

1210 
	`cÚf_v®ue_de¡roy
(
cv
);

1211 
	`log_w¬n
("maxclients has been„educedo %do compensate for "

1214 
fš®maxş›Ás
);

1217  ()
fš®lim™
;

1218 
	}
}

	@src/vr_server.c

1 
	~<sys/ut¢ame.h
>

3 
	~<vr_cÜe.h
>

6 
vr_£rv”
 
	g£rv”
;

9 
sh¬edObjeùsSŒuù
 
	gsh¬ed
;

13 
	$diùSŒHash
(cÚ¡ *
key
) {

14  
	`diùG’HashFunùiÚ
((*)
key
, 
	`¡¾’
((*)key));

15 
	}
}

18 
	$diùSŒCa£Hash
(cÚ¡ *
key
) {

19  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`¡¾’
((*)key));

20 
	}
}

23 
	$diùSdsHash
(cÚ¡ *
key
) {

24  
	`diùG’HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

25 
	}
}

28 
	$diùSdsCa£Hash
(cÚ¡ *
key
) {

29  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

30 
	}
}

33 
	$diùSŒKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

34 cÚ¡ *
key2
)

36 
l1
,
l2
;

37 
	`DICT_NOTUSED
(
´ivd©a
);

39 
l1
 = 
	`¡¾’
((*)
key1
);

40 
l2
 = 
	`¡¾’
((*)
key2
);

41 ià(
l1
 !ğ
l2
)  0;

42  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

43 
	}
}

48 
	$diùSŒKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

49 cÚ¡ *
key2
)

51 
	`DICT_NOTUSED
(
´ivd©a
);

53  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

54 
	}
}

57 
	$diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

58 cÚ¡ *
key2
)

60 
l1
,
l2
;

61 
	`DICT_NOTUSED
(
´ivd©a
);

63 
l1
 = 
	`sd¦’
((
sds
)
key1
);

64 
l2
 = 
	`sd¦’
((
sds
)
key2
);

65 ià(
l1
 !ğ
l2
)  0;

66  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

67 
	}
}

72 
	$diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

73 cÚ¡ *
key2
)

75 
	`DICT_NOTUSED
(
´ivd©a
);

77  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

78 
	}
}

81 
	$diùSdsKeyDupFromSŒ
(*
´ivd©a
, cÚ¡ *
key
)

83 
	`DICT_NOTUSED
(
´ivd©a
);

85  
	`sd¢ew
(
key
);

86 
	}
}

89 
	$diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
)

91 
	`DICT_NOTUSED
(
´ivd©a
);

93 
	`sdsä“
(
v®
);

94 
	}
}

97 
	$diùObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

99 
	`DICT_NOTUSED
(
´ivd©a
);

101 ià(
v®
 =ğ
NULL
) ;

102 
	`ä“Objeù
(
v®
);

103 
	}
}

106 
	$diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

107 cÚ¡ *
key2
)

109 
robj
 *
o1
 = (robj*è
key1
, *
o2
 = (robj*è
key2
;

110 
robj
 *
o1_Ãw
, *
o2_Ãw
;

111 
cmp
;

113 ià(
o1
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

114 
o2
->
’codšg
 =ğ
OBJ_ENCODING_INT
)

115  
o1
->
±r
 =ğ
o2
->ptr;

117 
o1_Ãw
 = 
	`g‘DecodedObjeù
(
o1
);

118 
o2_Ãw
 = 
	`g‘DecodedObjeù
(
o2
);

119 
cmp
 = 
	`diùSdsKeyCom·»
(
´ivd©a
,
o1_Ãw
->
±r
,
o2_Ãw
->ptr);

120 ià(
o1_Ãw
 !ğ
o1
è
	`ä“Objeù
(o1_new);

121 ià(
o2_Ãw
 !ğ
o2
è
	`ä“Objeù
(o2_new);

122  
cmp
;

123 
	}
}

126 
	$diùEncObjHash
(cÚ¡ *
key
) {

127 
robj
 *
o
 = (robj*è
key
;

129 ià(
	`sdsEncodedObjeù
(
o
)) {

130  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

132 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

133 
buf
[32];

134 
Ën
;

136 
Ën
 = 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

137  
	`diùG’HashFunùiÚ
((*)
buf
, 
Ën
);

139 
hash
;

140 
robj
 *
o_Ãw
;

142 
o_Ãw
 = 
	`g‘DecodedObjeù
(
o
);

143 
hash
 = 
	`diùG’HashFunùiÚ
(
o_Ãw
->
±r
, 
	`sd¦’
((
sds
)o_new->ptr));

144 ià(
o_Ãw
!ğ
o
è
	`ä“Objeù
(o_new);

145  
hash
;

148 
	}
}

151 
	$diùObjHash
(cÚ¡ *
key
) {

152 cÚ¡ 
robj
 *
o
 = 
key
;

153  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

154 
	}
}

157 
	$diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

158 cÚ¡ *
key2
)

160 cÚ¡ 
robj
 *
o1
 = 
key1
, *
o2
 = 
key2
;

161  
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

162 
	}
}

165 
	$diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
)

167 
	`DICT_NOTUSED
(
´ivd©a
);

168 
	`dli¡R–—£
((
dli¡
*)
v®
);

169 
	}
}

172 
diùTy³
 
	ghashDiùTy³
 = {

173 
diùEncObjHash
,

174 
NULL
,

175 
NULL
,

176 
diùEncObjKeyCom·»
,

177 
diùObjeùDe¡ruùÜ
,

178 
diùObjeùDe¡ruùÜ


182 
diùTy³
 
	g£tDiùTy³
 = {

183 
diùEncObjHash
,

184 
NULL
,

185 
NULL
,

186 
diùEncObjKeyCom·»
,

187 
diùObjeùDe¡ruùÜ
,

188 
NULL


192 
diùTy³
 
	gz£tDiùTy³
 = {

193 
diùEncObjHash
,

194 
NULL
,

195 
NULL
,

196 
diùEncObjKeyCom·»
,

197 
diùObjeùDe¡ruùÜ
,

198 
NULL


205 
	$ü—‹Sh¬edObjeùs
() {

206 
j
;

207 
robj
 **
obj
;

209 
sh¬ed
.
ülf
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("\r\n"));

210 
sh¬ed
.
ok
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+OK\r\n"));

211 
sh¬ed
.
”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("-ERR\r\n"));

212 
sh¬ed
.
em±ybulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$0\r\n\r\n"));

213 
sh¬ed
.
cz”o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":0\r\n"));

214 
sh¬ed
.
cÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":1\r\n"));

215 
sh¬ed
.
úegÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":-1\r\n"));

216 
sh¬ed
.
nuÎbulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$-1\r\n"));

217 
sh¬ed
.
nuÎmuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*-1\r\n"));

218 
sh¬ed
.
em±ymuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*0\r\n"));

219 
sh¬ed
.
pÚg
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+PONG\r\n"));

220 
sh¬ed
.
queued
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+QUEUED\r\n"));

221 
sh¬ed
.
em±ysÿn
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*2\r\n$1\r\n0\r\n*0\r\n"));

222 
sh¬ed
.
wrÚgty³”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

224 
sh¬ed
.
nokey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

226 
sh¬ed
.
syÁax”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

228 
sh¬ed
.
§meobjeù”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

230 
sh¬ed
.
outoäªg“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

232 
sh¬ed
.
nosü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

234 
sh¬ed
.
lßdšg”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

236 
sh¬ed
.
¦owsü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

238 
sh¬ed
.
ma¡”dowÃ¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

240 
sh¬ed
.
bg§v“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

242 
sh¬ed
.
ro¦av“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

244 
sh¬ed
.
nßuth”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

246 
sh¬ed
.
nßdmš”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

248 
sh¬ed
.
oom”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

250 
sh¬ed
.
exeÿbÜ‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

252 
sh¬ed
.
nÜ•liÿ£¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

254 
sh¬ed
.
busykey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

256 
sh¬ed
.
¥aû
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(" "));

257 
sh¬ed
.
cŞÚ
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":"));

258 
sh¬ed
.
¶us
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+"));

260 
j
 = 0; j < 
PROTO_SHARED_SELECT_CMDS
; j++) {

261 
diùid_¡r
[64];

262 
diùid_Ën
;

264 
diùid_Ën
 = 
	`Î2¡ršg
(
diùid_¡r
,(diùid_¡r),
j
);

265 
sh¬ed
.
£Ëù
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

266 
	`sdsÿrštf
(
	`sd£m±y
(),

268 
diùid_Ën
, 
diùid_¡r
));

270 
sh¬ed
.
mes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$7\r\nmessage\r\n",13);

271 
sh¬ed
.
pmes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$8\r\npmessage\r\n",14);

272 
sh¬ed
.
subsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$9\r\nsubscribe\r\n",15);

273 
sh¬ed
.
unsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$11\r\nunsubscribe\r\n",18);

274 
sh¬ed
.
psubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$10\r\npsubscribe\r\n",17);

275 
sh¬ed
.
punsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$12\r\npunsubscribe\r\n",19);

276 
sh¬ed
.
d–
 = 
	`ü—‹SŒšgObjeù
("DEL",3);

277 
sh¬ed
.
½İ
 = 
	`ü—‹SŒšgObjeù
("RPOP",4);

278 
sh¬ed
.
Íİ
 = 
	`ü—‹SŒšgObjeù
("LPOP",4);

279 
sh¬ed
.
Íush
 = 
	`ü—‹SŒšgObjeù
("LPUSH",5);

280 
j
 = 0; j < 
OBJ_SHARED_INTEGERS
; j++) {

281 
sh¬ed
.
š‹g”s
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,(*)()j);

282 
sh¬ed
.
š‹g”s
[
j
]->
’codšg
 = 
OBJ_ENCODING_INT
;

284 
j
 = 0; j < 
OBJ_SHARED_BULKHDR_LEN
; j++) {

285 
sh¬ed
.
mbulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

286 
	`sdsÿrštf
(
	`sd£m±y
(),"*%d\r\n",
j
));

287 
sh¬ed
.
bulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

288 
	`sdsÿrštf
(
	`sd£m±y
(),"$%d\r\n",
j
));

294 
sh¬ed
.
mš¡ršg
 = 
	`ü—‹SŒšgObjeù
("minstring",9);

295 
sh¬ed
.
max¡ršg
 = 
	`ü—‹SŒšgObjeù
("maxstring",9);

297 
sh¬ed
.
outofcom¶ex™ylim™
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

301 
obj
 = &
sh¬ed
; *obj !ğ
NULL
; obj ++) {

302 (*
obj
)->
cÚ¡ªt
 = 1;

304 
	}
}

308 
	$š™_£rv”
(
š¡ªû
 *
nci
)

310 
»t
;

311 
ušt32_t
 
i
;

312 
»disDb
 *
db
;

314 
£rv”
.
pid
 = 
	`g‘pid
();

315 
£rv”
.
¬ch_b™s
 = (() == 8) ? 64 : 32;

316 
£rv”
.
¡¬‰ime
 = 
	`time
(
NULL
);

317 
	`g‘_¿ndom_hex_ch¬s
(
£rv”
.
runid
, 
CONFIG_RUN_ID_SIZE
);

319 
£rv”
.
commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

321 
	`pİuÏ‹CommªdTabË
();

323 
£rv”
.
d–Commªd
 = 
	`lookupCommªdByCSŒšg
("del");

324 
£rv”
.
muÉiCommªd
 = 
	`lookupCommªdByCSŒšg
("multi");

325 
£rv”
.
ÍushCommªd
 = 
	`lookupCommªdByCSŒšg
("lpush");

326 
£rv”
.
ÍİCommªd
 = 
	`lookupCommªdByCSŒšg
("lpop");

327 
£rv”
.
½İCommªd
 = 
	`lookupCommªdByCSŒšg
("rpop");

328 
£rv”
.
¤emCommªd
 = 
	`lookupCommªdByCSŒšg
("srem");

329 
£rv”
.
execCommªd
 = 
	`lookupCommªdByCSŒšg
("exec");

332 
cÚf
 = 
	`cÚf_ü—‹
(
nci
->
cÚf_f’ame
);

335 
»t
 = 
	`pİuÏ‹CommªdsN“dAdmš·ss
();

336 ià(
»t
 !ğ
VR_OK
) {

337 
	`log_”rÜ
("Populate‚eed‡dminpass commands failed");

338  
VR_ERROR
;

341 
£rv”
.
cÚfigfe
 = 
	`g‘AbsŞu‹P©h
(
nci
->
cÚf_f’ame
);

342 
£rv”
.
hz
 = 10;

343 
£rv”
.
dbÊum
 = 
c£rv”
->
d©aba£s
;

344 
£rv”
.
dbšum
 = 
c£rv”
->
š‹º®_dbs_³r_d©aba£s
;

345 
£rv”
.
dbnum
 = s”v”.
dbÊum
*£rv”.
dbšum
;

347 
	`d¬¿y_š™
(&
£rv”
.
dbs
, s”v”.
dbnum
, (
»disDb
));

348 
£rv”
.
pidfe
 = 
nci
->
pid_f’ame
;

349 
£rv”
.
execubË
 = 
NULL
;

350 
£rv”
.
aùiv”ehashšg
 = 
CONFIG_DEFAULT_ACTIVE_REHASHING
;

352 
£rv”
.
ş›Á_max_qu”ybuf_Ën
 = 
PROTO_MAX_QUERYBUF_LEN
;

355 
i
 = 0; i < 
£rv”
.
dbnum
; i ++) {

356 
db
 = 
	`d¬¿y_push
(&
£rv”
.
dbs
);

357 
	`»disDbIn™
(
db
);

360 
£rv”
.
ş›Ás
 = 
	`dli¡C»©e
();

362 
£rv”
.
mÚ™Üs
 = 
	`dli¡C»©e
();

364 
£rv”
.
lßdšg
 = 0;

366 
£rv”
.
lua_timedout
 = 0;

368 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

370 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 0;

372 
£rv”
.
»ady_keys
 = 
	`dli¡C»©e
();

374 
£rv”
.
sy¡em_memÜy_size
 = 
	`d®loc_g‘_memÜy_size
();

376 
£rv”
.
rdb_chd_pid
 = -1;

377 
£rv”
.
aof_chd_pid
 = -1;

379 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
OBJ_HASH_MAX_ZIPLIST_ENTRIES
;

380 
£rv”
.
hash_max_zli¡_v®ue
 = 
OBJ_HASH_MAX_ZIPLIST_VALUE
;

381 
£rv”
.
li¡_max_zli¡_size
 = 
OBJ_LIST_MAX_ZIPLIST_SIZE
;

382 
£rv”
.
li¡_com´ess_d•th
 = 
OBJ_LIST_COMPRESS_DEPTH
;

383 
£rv”
.
£t_max_št£t_’Œ›s
 = 
OBJ_SET_MAX_INTSET_ENTRIES
;

384 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
OBJ_ZSET_MAX_ZIPLIST_ENTRIES
;

385 
£rv”
.
z£t_max_zli¡_v®ue
 = 
OBJ_ZSET_MAX_ZIPLIST_VALUE
;

386 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
;

388 
£rv”
.
nÙify_key¥aû_ev’ts
 = 0;

390 
	`¦owlogIn™
();

392 
	`vr_»¶iÿtiÚ_š™
();

394 
	`ü—‹Sh¬edObjeùs
();

399 
£rv”
.
pÜt
 = 
c£rv”
->port;

403 
»t
 = 
	`wÜk”s_š™
(
nci
->
th»ad_num
);

404 ià(
»t
 !ğ
VR_OK
) {

405 
	`log_”rÜ
("Init workerhreads failed");

406  
VR_ERROR
;

411 
»t
 = 
	`ma¡”_š™
(
cÚf
);

412 ià(
»t
 !ğ
VR_OK
) {

413 
	`log_”rÜ
("Init masterhread failed");

414  
VR_ERROR
;

417 
»t
 = 
	`back’ds_š™
(1);

418 ià(
»t
 !ğ
VR_OK
) {

419 
	`log_”rÜ
("Init backendhreads failed");

420  
VR_ERROR
;

423 
	`log_debug
(
LOG_NOTICE
, "memÜy‡Îoølocky³: %s", 
	`m®loc_lock_ty³
());

424 
	`log_debug
(
LOG_NOTICE
, "m®loølib: %s", 
DMALLOC_LIB
);

426 
	`log_debug
(
LOG_NOTICE
, "¡© locky³: %s", 
STATS_LOCK_TYPE
);

428  
VR_OK
;

429 
	}
}

431 
	$g‘LRUClock
() {

432  (
	`vr_m£c_now
()/
LRU_CLOCK_RESOLUTION
è& 
LRU_CLOCK_MAX
;

433 
	}
}

444 
	#EVICTION_SAMPLES_ARRAY_SIZE
 16

	)

445 
	$eviùiÚPoŞPİuÏ‹
(
diù
 *
§m¶ediù
, diù *
keydiù
,

446 
eviùiÚPoŞEÁry
 *
poŞ
, 
maxmemÜy_§m¶es
) {

447 
j
, 
k
, 
couÁ
;

448 
diùEÁry
 *
_§m¶es
[
EVICTION_SAMPLES_ARRAY_SIZE
];

449 
diùEÁry
 **
§m¶es
;

453 ià(
maxmemÜy_§m¶es
 <ğ
EVICTION_SAMPLES_ARRAY_SIZE
) {

454 
§m¶es
 = 
_§m¶es
;

456 
§m¶es
 = 
	`d®loc
((§m¶es[0])*
maxmemÜy_§m¶es
);

459 
couÁ
 = 
	`diùG‘SomeKeys
(
§m¶ediù
,
§m¶es
,
maxmemÜy_§m¶es
);

460 
j
 = 0; j < 
couÁ
; j++) {

461 
idË
;

462 
sds
 
key
;

463 
robj
 *
o
;

464 
diùEÁry
 *
de
;

466 
de
 = 
§m¶es
[
j
];

467 
key
 = 
	`diùG‘Key
(
de
);

471 ià(
§m¶ediù
 !ğ
keydiù
è
de
 = 
	`diùFšd
(keydiù, 
key
);

472 
o
 = 
	`diùG‘V®
(
de
);

473 
idË
 = 
	`e¡im©eObjeùIdËTime
(
o
);

478 
k
 = 0;

479 
k
 < 
MAXMEMORY_EVICTION_POOL_SIZE
 &&

480 
poŞ
[
k
].
key
 &&

481 
poŞ
[
k
].
idË
 < idle) k++;

482 ià(
k
 =ğ0 && 
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
key
 !ğ
NULL
) {

486 } ià(
k
 < 
MAXMEMORY_EVICTION_POOL_SIZE
 && 
poŞ
[k].
key
 =ğ
NULL
) {

491 ià(
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
key
 =ğ
NULL
) {

494 
	`memmove
(
poŞ
+
k
+1,pool+k,

495 (
poŞ
[0])*(
MAXMEMORY_EVICTION_POOL_SIZE
-
k
-1));

498 
k
--;

501 
	`sdsä“
(
poŞ
[0].
key
);

502 
	`memmove
(
poŞ
,poŞ+1,ÕoŞ[0])*
k
);

505 
poŞ
[
k
].
key
 = 
	`sdsdup
(key);

506 
poŞ
[
k
].
idË
 = idle;

508 ià(
§m¶es
 !ğ
_§m¶es
è
	`dä“
(samples);

509 
	}
}

511 
	$ä“MemÜyIfN“ded
(
vr_ev’oİ
 *
v–
) {

512 
size_t
 
mem_u£d
, 
mem_toä“
, 
mem_ä“d
;

513 
m¡ime_t
 
Ï‹ncy
, 
eviùiÚ_Ï‹ncy
;

514 
keys_ä“d
 = 0;

515 
maxmemÜy
;

516 
maxmemÜy_pŞicy
, 
maxmemÜy_§m¶es
;

517 
»t
;

519 
maxmemÜy
 = 
v–
->
cc
.maxmemory;

520 ià(
	`d®loc_u£d_memÜy
(è<ğ
maxmemÜy
)

521  
VR_OK
;

523 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORYP
, &
maxmemÜy_pŞicy
);

524 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_NO_EVICTION
)

525  
VR_ERROR
;

527 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORYS
, &
maxmemÜy_§m¶es
);

529 
j
, 
k
;

531 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

532 
be¡v®
 = 0;

533 
sds
 
be¡key
 = 
NULL
;

534 
diùEÁry
 *
de
;

535 
»disDb
 *
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, 
j
);

536 
diù
 *dict;

538 
	`lockDbWr™e
(
db
);

539 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_LRU
 ||

540 
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
)

542 
diù
 = 
db
->dict;

544 
diù
 = 
db
->
expœes
;

546 ià(
	`diùSize
(
diù
) == 0) {

547 
	`uÆockDb
(
db
);

552 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
 ||

553 
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_RANDOM
)

555 
de
 = 
	`diùG‘RªdomKey
(
diù
);

556 
be¡key
 = 
	`diùG‘Key
(
de
);

560 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_LRU
 ||

561 
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_LRU
)

563 
eviùiÚPoŞEÁry
 *
poŞ
 = 
db
->
eviùiÚ_poŞ
;

565 
be¡key
 =ğ
NULL
) {

566 
	`eviùiÚPoŞPİuÏ‹
(
diù
, 
db
->diù, db->
eviùiÚ_poŞ
, 
maxmemÜy_§m¶es
);

568 
k
 = 
MAXMEMORY_EVICTION_POOL_SIZE
-1; k >= 0; k--) {

569 ià(
poŞ
[
k
].
key
 =ğ
NULL
) ;

570 
de
 = 
	`diùFšd
(
diù
,
poŞ
[
k
].
key
);

573 
	`sdsä“
(
poŞ
[
k
].
key
);

575 
	`memmove
(
poŞ
+
k
,pool+k+1,

576 (
poŞ
[0])*(
MAXMEMORY_EVICTION_POOL_SIZE
-
k
-1));

579 
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
key
 = 
NULL
;

580 
poŞ
[
MAXMEMORY_EVICTION_POOL_SIZE
-1].
idË
 = 0;

584 ià(
de
) {

585 
be¡key
 = 
	`diùG‘Key
(
de
);

596 ià(
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_TTL
) {

597 
k
 = 0; k < 
maxmemÜy_§m¶es
; k++) {

598 
sds
 
thiskey
;

599 
thisv®
;

601 
de
 = 
	`diùG‘RªdomKey
(
diù
);

602 
thiskey
 = 
	`diùG‘Key
(
de
);

603 
thisv®
 = (è
	`diùG‘V®
(
de
);

607 ià(
be¡key
 =ğ
NULL
 || 
thisv®
 < 
be¡v®
) {

608 
be¡key
 = 
thiskey
;

609 
be¡v®
 = 
thisv®
;

615 ià(
be¡key
) {

616 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
be¡key
,
	`sd¦’
(bestkey));

617 
	`dbD–‘e
(
db
,
keyobj
);

618 
	`ä“Objeù
(
keyobj
);

619 
keys_ä“d
++;

622 
	`uÆockDb
(
db
);

624 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
, &
maxmemÜy
);

625 ià(
	`d®loc_u£d_memÜy
(è<ğ
maxmemÜy
) {

626 
¡İ
;

630 ià(!
keys_ä“d
) {

631  
VR_ERROR
;

634 
	`upd©e_¡©s_add
(
v–
->
¡©s
, 
eviùedkeys
, 
keys_ä“d
);

635 
keys_ä“d
 = 0;

638 
¡İ
:

639 
	`upd©e_¡©s_add
(
v–
->
¡©s
, 
eviùedkeys
, 
keys_ä“d
);

640  
VR_OK
;

641 
	}
}

645 
	$pšgCommªd
(
ş›Á
 *
c
) {

647 ià(
c
->
¬gc
 > 2) {

648 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

649 
c
->
cmd
->
Çme
);

653 ià(
c
->
æags
 & 
CLIENT_PUBSUB
) {

654 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[2]);

655 
	`addR•lyBulkCBufãr
(
c
,"pong",4);

656 ià(
c
->
¬gc
 == 1)

657 
	`addR•lyBulkCBufãr
(
c
,"",0);

659 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

661 ià(
c
->
¬gc
 == 1)

662 
	`addR•ly
(
c
,
sh¬ed
.
pÚg
);

664 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

666 
	}
}

677 
	$time_šd•’d’t_¡rcmp
(*
a
, *
b
) {

678 
buç
[
CONFIG_AUTHPASS_MAX_LEN
], 
bufb
[CONFIG_AUTHPASS_MAX_LEN];

683 
®’
 = 
	`¡¾’
(
a
);

684 
bËn
 = 
	`¡¾’
(
b
);

685 
j
;

686 
diff
 = 0;

691 ià(
®’
 > (
buç
è|| 
bËn
 > (
bufb
))  1;

693 
	`mem£t
(
buç
,0,(bufa));

694 
	`mem£t
(
bufb
,0,(bufb));

697 
	`memıy
(
buç
,
a
,
®’
);

698 
	`memıy
(
bufb
,
b
,
bËn
);

702 
j
 = 0; j < (
buç
); j++) {

703 
diff
 |ğ(
buç
[
j
] ^ 
bufb
[j]);

706 
diff
 |ğ
®’
 ^ 
bËn
;

707  
diff
;

708 
	}
}

710 
	$authCommªd
(
ş›Á
 *
c
) {

711 
sds
 
»quœ•ass
;

713 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_REQUIREPASS
,&
»quœ•ass
);

714 ià(!
»quœ•ass
) {

715 
	`addR•lyE¼Ü
(
c
,"Client sent AUTH, but‚o…assword is set");

717 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
»quœ•ass
)) {

718 ià(!
c
->
auth’tiÿ‹d
)

719 
c
->
auth’tiÿ‹d
 = 1;

720 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

722 
c
->
auth’tiÿ‹d
 = 0;

723 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

725 
	`sdsä“
(
»quœ•ass
);

726 
	}
}

728 
	$admšCommªd
(
ş›Á
 *
c
) {

729 
sds
 
admš·ss
;

731 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_ADMINPASS
,&
admš·ss
);

732 ià(!
admš·ss
) {

733 
	`addR•lyE¼Ü
(
c
,"Client sent ADMIN, but‚o…assword is set");

735 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
admš·ss
)) {

736 
c
->
auth’tiÿ‹d
 = 2;

737 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

739 
c
->
auth’tiÿ‹d
 = 0;

740 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

742 
	`sdsä“
(
admš·ss
);

743 
	}
}

745 
	$htN“dsResize
(
diù
 *dict) {

746 
size
, 
u£d
;

748 
size
 = 
	`diùSlÙs
(
diù
);

749 
u£d
 = 
	`diùSize
(
diù
);

750  (
size
 && 
u£d
 && siz> 
DICT_HT_INITIAL_SIZE
 &&

751 (
u£d
*100/
size
 < 
HASHTABLE_MIN_FILL
));

752 
	}
}

754 
	skeys_¡©i¡ics
 {

755 
	mkeys_®l
;

756 
	mvkeys_®l
;

757 
	mavg_‰l_®l
;

758 
	mÃxi¡
;

764 
sds
 
	$g’VœeInfoSŒšg
(
vr_ev’oİ
 *
v–
, *
£ùiÚ
) {

765 
sds
 
šfo
 = 
	`sd£m±y
();

766 
time_t
 
u±ime
 = 
	`time
(
NULL
)-
£rv”
.
¡¬‰ime
;

767 
j
, 
k
, 
numcommªds
;

768 
ru§ge
 
£lf_ru
;

769 
lŞ
, 
bib
;

770 
®l£ùiÚs
 = 0, 
def£ùiÚs
 = 0;

771 
£ùiÚs
 = 0;

772 
d¬¿y
 *
kss
 = 
NULL
;

774 ià(
£ùiÚ
 =ğ
NULL
) section = "default";

775 
®l£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"all") == 0;

776 
def£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"default") == 0;

778 
	`g‘ru§ge
(
RUSAGE_SELF
, &
£lf_ru
);

781 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"server")) {

782 
ÿÎ_uÇme
 = 1;

783 
ut¢ame
 
Çme
;

784 *
mode
;

786 
mode
 = "standalone";

788 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

790 ià(
ÿÎ_uÇme
) {

792 
	`uÇme
(&
Çme
);

793 
ÿÎ_uÇme
 = 0;

796 
šfo
 = 
	`sdsÿrštf
(info,

814 
VR_VERSION_STRING
,

815 
mode
,

816 
Çme
.
sy¢ame
,‚ame.
»Ëa£
,‚ame.
machše
,

817 
£rv”
.
¬ch_b™s
,

818 
	`«G‘ApiName
(),

819 #ifdeà
__GNUC__


820 
__GNUC__
,
__GNUC_MINOR__
,
__GNUC_PATCHLEVEL__
,

824 (è
	`g‘pid
(),

825 
£rv”
.
runid
,

826 
£rv”
.
pÜt
,

827 (
štmax_t
)
u±ime
,

828 (
štmax_t
)(
u±ime
/(3600*24)),

829 
£rv”
.
hz
,

830 
£rv”
.
execubË
 ? server.executable : "",

831 
£rv”
.
cÚfigfe
 ? server.configfile : "",

832 
£rv”
.
dbÊum
,

833 
£rv”
.
dbšum
);

837 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"clients")) {

838 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

839 
šfo
 = 
	`sdsÿrštf
(info,

842 
	`cu¼’t_ş›Ás
());

846 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"memory")) {

847 
ušt32_t
 
idx
;

848 
vr_wÜk”
 *
wÜk”
;

849 
hmem
[64];

850 
³ak_hmem
[64];

851 
tÙ®_sy¡em_hmem
[64];

852 
u£d_memÜy_lua_hmem
[64];

853 
u£d_memÜy_rss_hmem
[64];

854 
maxmemÜy_hmem
[64];

855 
size_t
 
vr_u£d_memÜy
 = 
	`d®loc_u£d_memÜy
();

856 
size_t
 
tÙ®_sy¡em_mem
 = 
£rv”
.
sy¡em_memÜy_size
;

857 cÚ¡ *
eviù_pŞicy
;

858 
size_t
 
³ak_memÜy
 = 0, 
³ak_memÜy_fÜ_Úe_wÜk”
;

859 
maxmemÜy
;

860 
maxmemÜy_pŞicy
;

866 
idx
 = 0; idx < 
	`d¬¿y_n
(&
wÜk”s
); idx ++) {

867 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
idx
);

868 
	`upd©e_¡©s_g‘
(
wÜk”
->
v–
.
¡©s
, 
³ak_memÜy
,

869 &
³ak_memÜy_fÜ_Úe_wÜk”
);

870 ià(
³ak_memÜy
 < 
³ak_memÜy_fÜ_Úe_wÜk”
)

871 
³ak_memÜy
 = 
³ak_memÜy_fÜ_Úe_wÜk”
;

873 ià(
vr_u£d_memÜy
 > 
³ak_memÜy
) {

874 
³ak_memÜy
 = 
vr_u£d_memÜy
;

875 
	`upd©e_¡©s_£t
(
v–
->
¡©s
, 
³ak_memÜy
, 
vr_u£d_memÜy
);

878 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORY
,&
maxmemÜy
);

879 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXMEMORYP
,&
maxmemÜy_pŞicy
);

880 
eviù_pŞicy
 = 
	`g‘_eviùpŞicy_¡ršgs
(
maxmemÜy_pŞicy
);

882 
	`by‹sToHumª
(
hmem
,
vr_u£d_memÜy
);

883 
	`by‹sToHumª
(
³ak_hmem
,
³ak_memÜy
);

884 
	`by‹sToHumª
(
tÙ®_sy¡em_hmem
,
tÙ®_sy¡em_mem
);

885 
	`by‹sToHumª
(
u£d_memÜy_rss_hmem
,
v–
->
»sid’t_£t_size
);

886 
	`by‹sToHumª
(
maxmemÜy_hmem
,
maxmemÜy
);

888 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

889 
šfo
 = 
	`sdsÿrštf
(info,

904 
vr_u£d_memÜy
,

905 
hmem
,

906 
v–
->
»sid’t_£t_size
,

907 
u£d_memÜy_rss_hmem
,

908 
³ak_memÜy
,

909 
³ak_hmem
,

910 ()
tÙ®_sy¡em_mem
,

911 
tÙ®_sy¡em_hmem
,

912 
maxmemÜy
,

913 
maxmemÜy_hmem
,

914 
eviù_pŞicy
,

915 ()
v–
->
»sid’t_£t_size
/
vr_u£d_memÜy
,

916 
DMALLOC_LIB


921 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"stats")) {

922 
ušt32_t
 
idx
;

923 
vr_¡©s
 *
¡©s
;

924 
¡©_numcÚÃùiÚs
=0, 
¡©_numcommªds
=0;

925 
¡©_Ãt_šput_by‹s
=0, 
¡©_Ãt_ouut_by‹s
=0;

926 
¡©_»jeùed_cÚn
=0;

927 
¡©_expœedkeys
=0;

928 
¡©_eviùedkeys
=0;

929 
¡©_key¥aû_h™s
=0, 
¡©_key¥aû_mis£s
=0;

930 
¡©_numcommªds_İs
=0;

931 
¡©_Ãt_šput_by‹s_İs
=0, 
¡©_Ãt_ouut_by‹s_İs
=0;

933 
idx
 = 0; idx < 
	`d¬¿y_n
(&
wÜk”s
); idx ++) {

934 
¡©s_v®ue
;

935 
vr_wÜk”
 *
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
idx
);

936 
¡©s
 = 
wÜk”
->
v–
.stats;

938 
	`upd©e_¡©s_g‘
(
¡©s
, 
numcommªds
, &
¡©s_v®ue
);

939 
¡©_numcommªds
 +ğ
¡©s_v®ue
;

940 
	`upd©e_¡©s_g‘
(
¡©s
, 
numcÚÃùiÚs
, &
¡©s_v®ue
);

941 
¡©_numcÚÃùiÚs
 +ğ
¡©s_v®ue
;

942 
	`upd©e_¡©s_g‘
(
¡©s
, 
expœedkeys
, &
¡©s_v®ue
);

943 
¡©_expœedkeys
 +ğ
¡©s_v®ue
;

944 
	`upd©e_¡©s_g‘
(
¡©s
, 
eviùedkeys
, &
¡©s_v®ue
);

945 
¡©_eviùedkeys
 +ğ
¡©s_v®ue
;

946 
	`upd©e_¡©s_g‘
(
¡©s
, 
Ãt_šput_by‹s
, &
¡©s_v®ue
);

947 
¡©_Ãt_šput_by‹s
 +ğ
¡©s_v®ue
;

948 
	`upd©e_¡©s_g‘
(
¡©s
, 
Ãt_ouut_by‹s
, &
¡©s_v®ue
);

949 
¡©_Ãt_ouut_by‹s
 +ğ
¡©s_v®ue
;

950 
	`upd©e_¡©s_g‘
(
¡©s
, 
key¥aû_h™s
, &
¡©s_v®ue
);

951 
¡©_key¥aû_h™s
 +ğ
¡©s_v®ue
;

952 
	`upd©e_¡©s_g‘
(
¡©s
, 
key¥aû_mis£s
, &
¡©s_v®ue
);

953 
¡©_key¥aû_mis£s
 +ğ
¡©s_v®ue
;

955 
¡©_numcommªds_İs
 +ğ
	`g‘In¡ªÃousM‘ric
(
¡©s
, 
STATS_METRIC_COMMAND
);

956 
¡©_Ãt_šput_by‹s_İs
 +ğ()
	`g‘In¡ªÃousM‘ric
(
¡©s
, 
STATS_METRIC_NET_INPUT
)/1024;

957 
¡©_Ãt_ouut_by‹s_İs
 +ğ()
	`g‘In¡ªÃousM‘ric
(
¡©s
, 
STATS_METRIC_NET_OUTPUT
)/1024;

959 
idx
 = 0; idx < 
	`d¬¿y_n
(&
back’ds
); idx ++) {

960 
¡©s_v®ue
;

961 
vr_back’d
 *
back’d
 = 
	`d¬¿y_g‘
(&
back’ds
, 
idx
);

962 
¡©s
 = 
back’d
->
v–
.stats;

964 
	`upd©e_¡©s_g‘
(
¡©s
, 
expœedkeys
, &
¡©s_v®ue
);

965 
¡©_expœedkeys
 +ğ
¡©s_v®ue
;

967 
	`upd©e_¡©s_g‘
(
ma¡”
.
v–
.
¡©s
, 
»jeùed_cÚn
, &
¡©_»jeùed_cÚn
);

969 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

970 
šfo
 = 
	`sdsÿrštf
(info,

984 
¡©_numcÚÃùiÚs
,

985 
¡©_numcommªds
,

986 
¡©_numcommªds_İs
,

987 
¡©_Ãt_šput_by‹s
,

988 
¡©_Ãt_ouut_by‹s
,

989 
¡©_Ãt_šput_by‹s_İs
,

990 
¡©_Ãt_ouut_by‹s_İs
,

991 
¡©_»jeùed_cÚn
,

992 
¡©_expœedkeys
,

993 
¡©_eviùedkeys
,

994 
¡©_key¥aû_h™s
,

995 
¡©_key¥aû_mis£s
);

999 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cpu")) {

1000 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

1001 
šfo
 = 
	`sdsÿrštf
(info,

1005 ()
£lf_ru
.
ru_¡ime
.
tv_£c
+()£lf_ru.ru_¡ime.
tv_u£c
/1000000,

1006 ()
£lf_ru
.
ru_utime
.
tv_£c
+()£lf_ru.ru_utime.
tv_u£c
/1000000);

1010 ià(
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"internal")) {

1011 
»disDb
 *
db
;

1012 
keys_¡©i¡ics
 *
ks
;

1013 
keys
, 
vkeys
, 
avg_‰l
;

1015 
kss
 = 
	`d¬¿y_ü—‹
(
£rv”
.
dbÊum
, (
keys_¡©i¡ics
));

1017 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

1018 
šfo
 = 
	`sdsÿrštf
(info, "# Internal\r\n");

1019 
j
 = 0; j < 
£rv”
.
dbÊum
; j++) {

1020 
ks
 = 
	`d¬¿y_push
(
kss
);

1021 
ks
->
keys_®l
 = ks->
vkeys_®l
 = ks->
avg_‰l_®l
 = 0;

1022 
ks
->
Ãxi¡
 = 0;

1023 
k
 = 0; k < 
£rv”
.
dbšum
; k ++) {

1024 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)(
j
*£rv”.
dbšum
+
k
));

1025 
	`lockDbR—d
(
db
);

1026 
keys
 = 
	`diùSize
(
db
->
diù
);

1027 
vkeys
 = 
	`diùSize
(
db
->
expœes
);

1028 
avg_‰l
 = 
db
->avg_ttl;

1029 
	`uÆockDb
(
db
);

1030 ià(
keys
 || 
vkeys
) {

1031 
šfo
 = 
	`sdsÿrštf
(info,

1033 
j
, 
k
, 
keys
, 
vkeys
, 
db
->
avg_‰l
);

1035 
ks
->
keys_®l
 +ğ
keys
;

1036 
ks
->
vkeys_®l
 +ğ
vkeys
;

1037 
ks
->
avg_‰l_®l
 +ğ
avg_‰l
;

1038 ià(
avg_‰l
 > 0è
ks
->
Ãxi¡
 ++;

1044 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"keyspace")) {

1045 
»disDb
 *
db
;

1046 
keys_¡©i¡ics
 *
ks
;

1047 
keys_®l
, 
vkeys_®l
, 
avg_‰l_®l
;

1048 
Ãxi¡
;

1050 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

1051 
šfo
 = 
	`sdsÿrštf
(info, "# Keyspace\r\n");

1052 ià(
kss
 =ğ
NULL
) {

1053 
j
 = 0; j < 
£rv”
.
dbÊum
; j++) {

1054 
keys_®l
 = 
vkeys_®l
 = 
avg_‰l_®l
 = 0;

1055 
Ãxi¡
 = 0;

1056 
k
 = 0; k < 
£rv”
.
dbšum
; k ++) {

1057 
db
 = 
	`d¬¿y_g‘
(&
£rv”
.
dbs
, (
ušt32_t
)(
j
*£rv”.
dbšum
+
k
));

1058 
	`lockDbR—d
(
db
);

1059 
keys_®l
 +ğ
	`diùSize
(
db
->
diù
);

1060 
vkeys_®l
 +ğ
	`diùSize
(
db
->
expœes
);

1061 
avg_‰l_®l
 +ğ
db
->
avg_‰l
;

1062 ià(
db
->
avg_‰l
 > 0è
Ãxi¡
 ++;

1063 
	`uÆockDb
(
db
);

1065 ià(
keys_®l
 || 
vkeys_®l
) {

1066 
šfo
 = 
	`sdsÿrštf
(info,

1068 
j
, 
keys_®l
, 
vkeys_®l
, 
Ãxi¡
>0?(
avg_‰l_®l
/nexist):0);

1072 
j
 = 0; j < 
£rv”
.
dbÊum
; j ++) {

1073 
ks
 = 
	`d¬¿y_g‘
(
kss
, 
j
);

1074 ià(
ks
->
keys_®l
 || ks->
vkeys_®l
) {

1075 
šfo
 = 
	`sdsÿrštf
(info,

1077 
j
, 
ks
->
keys_®l
, ks->
vkeys_®l
,

1078 
ks
->
Ãxi¡
>0?(ks->
avg_‰l_®l
/ks->nexist):0);

1084 
šfo
 = 
	`sdsÿrštf
(info,"\n--------------------------create by:å¼ èª--------------------------------------\n\r");

1086 ià(
kss
 !ğ
NULL
) {

1087 
kss
->
ÃËm
 = 0;

1088 
	`d¬¿y_de¡roy
(
kss
);

1089 
kss
 = 
NULL
;

1092  
šfo
;

1093 
	}
}

1095 
	$šfoCommªd
(
ş›Á
 *
c
) {

1096 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : "default";

1098 ià(
c
->
¬gc
 > 2) {

1099 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1102 
	`addR•lyBulkSds
(
c
, 
	`g’VœeInfoSŒšg
(c->
v–
, 
£ùiÚ
));

1103 
	}
}

1105 
	$echoCommªd
(
ş›Á
 *
c
) {

1106 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

1107 
	}
}

1109 
	$timeCommªd
(
ş›Á
 *
c
) {

1110 
timev®
 
tv
;

1114 
	`g‘timeofday
(&
tv
,
NULL
);

1115 
	`addR•lyMuÉiBulkL’
(
c
,2);

1116 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_£c
);

1117 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_u£c
);

1118 
	}
}

1129 
	$adju¡O³nFesLim™
(
maxş›Ás
) {

1130 
¾im_t
 
maxfes
, 
fš®lim™
 = 0;

1131 
¾im_t
 
Şdlim™
;

1132 
fš®maxş›Ás
;

1133 
¾im™
 
lim™
;

1134 
th»ads
;

1136 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_THREADS
,&
th»ads
);

1137 
maxfes
 = 
maxş›Ás
+
th»ads
*2+
CONFIG_MIN_RESERVED_FDS
;

1138 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
,&
lim™
) == -1) {

1139 
	`log_w¬n
("Unableo obtainhe current NOFILE†imit (%s),‡ssuming 1024‡nd settinghe max clients configuration‡ccordingly.",

1140 
	`¡»¼Ü
(
”ºo
));

1141 
Şdlim™
 = 1024;

1142 
fš®lim™
 = 
Şdlim™
;

1144 
Şdlim™
 = 
lim™
.
¾im_cur
;

1148 ià(
Şdlim™
 < 
maxfes
) {

1149 
¾im_t
 
be¡lim™
;

1150 
£Œlim™_”rÜ
 = 0;

1154 
be¡lim™
 = 
maxfes
;

1155 
be¡lim™
 > 
Şdlim™
) {

1156 
¾im_t
 
deü_¡•
 = 16;

1158 
lim™
.
¾im_cur
 = 
be¡lim™
;

1159 
lim™
.
¾im_max
 = 
be¡lim™
;

1160 ià(
	`£Œlim™
(
RLIMIT_NOFILE
,&
lim™
) != -1) ;

1161 
£Œlim™_”rÜ
 = 
”ºo
;

1165 ià(
be¡lim™
 < 
deü_¡•
) ;

1166 
be¡lim™
 -ğ
deü_¡•
;

1171 ià(
be¡lim™
 < 
Şdlim™
) bestlimit = oldlimit;

1173 
fš®lim™
 = 
be¡lim™
;

1174 ià(
be¡lim™
 < 
maxfes
) {

1175 
	`log_w¬n
("You„equested maxclients of %d "

1177 
maxş›Ás
,

1178 (è
maxfes
);

1179 
	`log_w¬n
("Server can't set maximum open files "

1181 (è
maxfes
, 
	`¡»¼Ü
(
£Œlim™_”rÜ
));

1182 
	`log_w¬n
("Current maximum open files is %llu. ",

1183 (è
be¡lim™
);

1185 
	`log_w¬n
("Increased maximum‚umber of open files "

1187 (è
maxfes
,

1188 (è
Şdlim™
);

1191 
fš®lim™
 = 
maxfes
;

1195 
fš®maxş›Ás
 = 
fš®lim™
-
th»ads
*2-
CONFIG_MIN_RESERVED_FDS
;

1196 ià(
fš®maxş›Ás
 < 1) {

1197 
	`log_w¬n
("Your current 'ulimit -n' "

1201 (è
Şdlim™
,

1202 (è
maxfes
);

1206 ià(
fš®lim™
 < 
maxfes
) {

1207 
cÚf_v®ue
 *
cv
 = 
	`cÚf_v®ue_ü—‹
(
CONF_VALUE_TYPE_STRING
);

1208 
cv
->
v®ue
 = 
	`sdsäomlÚglÚg
(()
fš®maxş›Ás
);

1209 
	`cÚf_£rv”_£t
(
CONFIG_SOPN_MAXCLIENTS
,
cv
);

1210 
	`cÚf_v®ue_de¡roy
(
cv
);

1211 
	`log_w¬n
("maxclients has been„educedo %do compensate for "

1214 
fš®maxş›Ás
);

1217  ()
fš®lim™
;

1218 
	}
}

	@src/vr_server.h

1 #iâdeà
_VR_SERVER_H_


2 
	#_VR_SERVER_H_


	)

4 
	#CONFIG_MIN_RESERVED_FDS
 32

	)

7 
	#CONFIG_AUTHPASS_MAX_LEN
 512

	)

9 
	#PROTO_SHARED_SELECT_CMDS
 10

	)

10 
	#CRON_DBS_PER_CALL
 16

	)

14 
	#ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
 20

	)

15 
	#ACTIVE_EXPIRE_CYCLE_FAST_DURATION
 1000

	)

16 
	#ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
 25

	)

17 
	#ACTIVE_EXPIRE_CYCLE_SLOW
 0

	)

18 
	#ACTIVE_EXPIRE_CYCLE_FAST
 1

	)

21 
	#SCAN_TYPE_KEY
 0

	)

22 
	#SCAN_TYPE_HASH
 1

	)

23 
	#SCAN_TYPE_SET
 2

	)

24 
	#SCAN_TYPE_ZSET
 3

	)

27 
	#CONFIG_DEFAULT_MAXMEMORY_POLICY
 
MAXMEMORY_NO_EVICTION


	)

30 
	#OBJ_HASH_MAX_ZIPLIST_ENTRIES
 512

	)

31 
	#OBJ_HASH_MAX_ZIPLIST_VALUE
 64

	)

32 
	#OBJ_SET_MAX_INTSET_ENTRIES
 512

	)

33 
	#OBJ_ZSET_MAX_ZIPLIST_ENTRIES
 128

	)

34 
	#OBJ_ZSET_MAX_ZIPLIST_VALUE
 64

	)

37 
	#OBJ_LIST_MAX_ZIPLIST_SIZE
 -2

	)

38 
	#OBJ_LIST_COMPRESS_DEPTH
 0

	)

41 
	#CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
 3000

	)

44 
	#LIST_HEAD
 0

	)

45 
	#LIST_TAIL
 1

	)

47 
	#ZSKIPLIST_MAXLEVEL
 32

	)

48 
	#ZSKIPLIST_P
 0.25

	)

51 
	#UNIT_SECONDS
 0

	)

52 
	#UNIT_MILLISECONDS
 1

	)

55 
	#HASHTABLE_MIN_FILL
 10

	)

60 
	#run_w™h_³riod
(
_ms_
, 
üÚloİs
èià((_ms_ <ğ1000/
£rv”
.
hz
è|| !(üÚloİs%((_ms_)/(1000/£rv”.hz))))

	)

66 
	#LRU_CLOCK
(è((1000/
£rv”
.
hz
 <ğ
LRU_CLOCK_RESOLUTION
è? s”v”.
Ìuşock
 : 
	`g‘LRUClock
())

	)

80 
	s»adyLi¡
 {

81 
»disDb
 *
	mdb
;

82 
robj
 *
	mkey
;

83 } 
	t»adyLi¡
;

85 
	svr_£rv”
 {

86 
«Ev’tLoİ
 *
	m–
;

87 
dli¡
 *
	mş›Ás
;

90 
pid_t
 
	mpid
;

91 *
	mexecubË
;

92 *
	mcÚfigfe
;

93 
	mhz
;

95 
d¬¿y
 
	mdbs
;

96 
	mdbnum
;

97 
	mdbÊum
;

98 
	mdbšum
;

100 
diù
 *
	mcommªds
;

101 
diù
 *
	mÜig_commªds
;

103 
	mÌuşock
:
LRU_BITS
;

104 
	maùiv”ehashšg
;

106 *
	mpidfe
;

107 
	m¬ch_b™s
;

108 
	mrunid
[
CONFIG_RUN_ID_SIZE
+1];

111 
	mpÜt
;

112 
	mtı_backlog
;

114 
	mtık“·live
;

115 
size_t
 
	mş›Á_max_qu”ybuf_Ën
;

119 
size_t
 
	mhash_max_zli¡_’Œ›s
;

120 
size_t
 
	mhash_max_zli¡_v®ue
;

121 
size_t
 
	m£t_max_št£t_’Œ›s
;

122 
size_t
 
	mz£t_max_zli¡_’Œ›s
;

123 
size_t
 
	mz£t_max_zli¡_v®ue
;

124 
size_t
 
	mhÎ_¥¬£_max_by‹s
;

127 
	mli¡_max_zli¡_size
;

128 
	mli¡_com´ess_d•th
;

131 
ş›ÁBufãrLim™sCÚfig
 
	mş›Á_obuf_lim™s
[
CLIENT_TYPE_OBUF_COUNT
];

133 
dli¡
 *
	mmÚ™Üs
;

135 
time_t
 
	m¡¬‰ime
;

138 
time_t
 
	munixtime
;

139 
	mm¡ime
;

142 *
	munixsock‘
;

145 
	mlßdšg
;

146 
off_t
 
	mlßdšg_tÙ®_by‹s
;

147 
off_t
 
	mlßdšg_lßded_by‹s
;

148 
time_t
 
	mlßdšg_¡¬t_time
;

149 
off_t
 
	mlßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

152 
	maof_¡©e
;

153 
	maof_fsync
;

154 *
	maof_f’ame
;

155 
	maof_no_fsync_Ú_»wr™e
;

156 
	maof_»wr™e_³rc
;

157 
off_t
 
	maof_»wr™e_mš_size
;

158 
off_t
 
	maof_»wr™e_ba£_size
;

159 
off_t
 
	maof_cu¼’t_size
;

160 
	maof_»wr™e_scheduËd
;

161 
pid_t
 
	maof_chd_pid
;

162 
dli¡
 *
	maof_»wr™e_buf_blocks
;

163 
sds
 
	maof_buf
;

164 
	maof_fd
;

165 
	maof_£Ëùed_db
;

166 
time_t
 
	maof_æush_po¡pÚed_¡¬t
;

167 
time_t
 
	maof_Ï¡_fsync
;

168 
time_t
 
	maof_»wr™e_time_Ï¡
;

169 
time_t
 
	maof_»wr™e_time_¡¬t
;

170 
	maof_Ï¡bg»wr™e_¡©us
;

171 
	maof_d–ayed_fsync
;

172 
	maof_»wr™e_šüem’l_fsync
;

173 
	maof_Ï¡_wr™e_¡©us
;

174 
	maof_Ï¡_wr™e_”ºo
;

175 
	maof_lßd_Œunÿ‹d
;

177 
	maof_pe_wr™e_d©a_to_chd
;

178 
	maof_pe_»ad_d©a_äom_·»Á
;

179 
	maof_pe_wr™e_ack_to_·»Á
;

180 
	maof_pe_»ad_ack_äom_chd
;

181 
	maof_pe_wr™e_ack_to_chd
;

182 
	maof_pe_»ad_ack_äom_·»Á
;

183 
	maof_¡İ_£ndšg_diff
;

185 
sds
 
	maof_chd_diff
;

188 
	mdœty
;

189 
	mdœty_befÜe_bg§ve
;

190 
pid_t
 
	mrdb_chd_pid
;

191 
§v•¬am
 *
	m§v•¬ams
;

192 
	m§v•¬am¦’
;

193 *
	mrdb_f’ame
;

194 
	mrdb_com´essiÚ
;

195 
	mrdb_checksum
;

196 
time_t
 
	mÏ¡§ve
;

197 
time_t
 
	mÏ¡bg§ve_Œy
;

198 
time_t
 
	mrdb_§ve_time_Ï¡
;

199 
time_t
 
	mrdb_§ve_time_¡¬t
;

200 
	mrdb_chd_ty³
;

201 
	mÏ¡bg§ve_¡©us
;

202 
	m¡İ_wr™es_Ú_bg§ve_”r
;

203 
	mrdb_pe_wr™e_»suÉ_to_·»Á
;

204 
	mrdb_pe_»ad_»suÉ_äom_chd
;

208 
ş›Á
 *
	mlua_ş›Á
;

209 
ş›Á
 *
	mlua_ÿÎ”
;

210 
diù
 *
	mlua_süts
;

211 
m¡ime_t
 
	mlua_time_lim™
;

212 
m¡ime_t
 
	mlua_time_¡¬t
;

213 
	mlua_wr™e_dœty
;

215 
	mlua_¿ndom_dœty
;

217 
	mlua_»¶iÿ‹_commªds
;

218 
	mlua_muÉi_em™‹d
;

219 
	mlua_»¶
;

220 
	mlua_timedout
;

222 
	mlua_kl
;

223 
	mlua_®ways_»¶iÿ‹_commªds
;

227 
dli¡
 *
	m»ady_keys
;

230 
»disOpA¼ay
 
	m®so_´İag©e
;

234 
diù
 *
	mpubsub_chªÃls
;

236 
dli¡
 *
	mpubsub_·‰”ns
;

238 
	mnÙify_key¥aû_ev’ts
;

243 
»disCommªd
 *
	md–Commªd
, *
	mmuÉiCommªd
, *
	mÍushCommªd
, *
	mÍİCommªd
,

244 *
	m½İCommªd
, *
	m¤emCommªd
, *
	mexecCommªd
;

248 
size_t
 
	msy¡em_memÜy_size
;

253 
	szskli¡Node
 {

254 
robj
 *
	mobj
;

255 
	mscÜe
;

256 
zskli¡Node
 *
	mbackw¬d
;

257 
	szskli¡Lev–
 {

258 
zskli¡Node
 *
	mfÜw¬d
;

259 
	m¥ª
;

260 } 
	mËv–
[];

261 } 
	tzskli¡Node
;

263 
	szskli¡
 {

264 
zskli¡Node
 *
	mh—d”
, *
	m
;

265 
	mËngth
;

266 
	mËv–
;

267 } 
	tzskli¡
;

269 
	sz£t
 {

270 
diù
 *
	mdiù
;

271 
zskli¡
 *
	mz¦
;

272 } 
	tz£t
;

277 
robj
 *
	msubjeù
;

278 
	m’codšg
;

279 
	mdœeùiÚ
;

280 
quickli¡I‹r
 *
	m™”
;

281 } 
	tli¡Ty³I‹¿tÜ
;

286 
li¡Ty³I‹¿tÜ
 *
	mli
;

287 
quickli¡EÁry
 
	m’Œy
;

288 } 
	tli¡Ty³EÁry
;

293 
robj
 *
	msubjeù
;

294 
	m’codšg
;

295 
	mii
;

296 
diùI‹¿tÜ
 *
	mdi
;

297 } 
	t£tTy³I‹¿tÜ
;

305 
robj
 *
	msubjeù
;

306 
	m’codšg
;

308 *
	måŒ
, *
	mv±r
;

310 
diùI‹¿tÜ
 *
	mdi
;

311 
diùEÁry
 *
	mde
;

312 } 
	thashTy³I‹¿tÜ
;

315 
	ssh¬edObjeùsSŒuù
 {

316 
robj
 *
	mülf
, *
	mok
, *
	m”r
, *
	mem±ybulk
, *
	mcz”o
, *
	mcÚe
, *
	múegÚe
, *
	mpÚg
, *
	m¥aû
,

317 *
	mcŞÚ
, *
	mnuÎbulk
, *
	mnuÎmuÉibulk
, *
	mqueued
,

318 *
	mem±ymuÉibulk
, *
	mwrÚgty³”r
, *
	mnokey”r
, *
	msyÁax”r
, *
	m§meobjeù”r
,

319 *
	moutoäªg“¼
, *
	mnosü‹¼
, *
	mlßdšg”r
, *
	m¦owsü‹¼
, *
	mbg§v“¼
,

320 *
	mma¡”dowÃ¼
, *
	mro¦av“¼
, *
	mexeÿbÜ‹¼
, *
	mnßuth”r
, *
	mnßdmš”r
, *
	mnÜ•liÿ£¼
,

321 *
	mbusykey”r
, *
	moom”r
, *
	m¶us
, *
	mmes§gebulk
, *
	mpmes§gebulk
, *
	msubsüibebulk
,

322 *
	munsubsüibebulk
, *
	mpsubsüibebulk
, *
	mpunsubsüibebulk
, *
	md–
, *
	m½İ
, *
	mÍİ
,

323 *
	mÍush
, *
	mem±ysÿn
, *
	mmš¡ršg
, *
	mmax¡ršg
,

324 *
	m£Ëù
[
PROTO_SHARED_SELECT_CMDS
],

325 *
	mš‹g”s
[
OBJ_SHARED_INTEGERS
],

326 *
	mmbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
],

327 *
	mbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
],

328 *
	moutofcom¶ex™ylim™
,

329 *
	m£Áš–
;

333 
vr_£rv”
 
£rv”
;

335 
sh¬edObjeùsSŒuù
 
sh¬ed
;;

337 
diùTy³
 
hashDiùTy³
;

339 
diùTy³
 
£tDiùTy³
;

341 
diùTy³
 
z£tDiùTy³
;

343 
	#£rv”Pªic
(
_e
è
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 1, "as£¹ fad: %s", #_e)

	)

345 
	#£rv”As£¹W™hInfo
(
_c
,
_o
,
_e
è((_e)?()0 : (
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 1, "as£¹ fad: %s", #_e)))

	)

347 
diùSŒHash
(cÚ¡ *
key
);

348 
diùSŒCa£Hash
(cÚ¡ *
key
);

349 
diùSdsHash
(cÚ¡ *
key
);

350 
diùSdsCa£Hash
(cÚ¡ *
key
);

351 
diùSŒKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

352 
diùSŒKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

353 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

354 
diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

355 *
diùSdsKeyDupFromSŒ
(*
´ivd©a
, cÚ¡ *
key
);

356 
diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
);

357 
diùObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
);

358 
diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

359 
diùEncObjHash
(cÚ¡ *
key
);

360 
diùObjHash
(cÚ¡ *
key
);

361 
diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

362 
diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
);

364 
š™_£rv”
(
š¡ªû
 *
nci
);

366 
g‘LRUClock
();

368 
ä“MemÜyIfN“ded
(
vr_ev’oİ
 *
v–
);

369 
pšgCommªd
(
ş›Á
 *
c
);

370 
time_šd•’d’t_¡rcmp
(*
a
, *
b
);

371 
authCommªd
(
ş›Á
 *
c
) ;

372 
admšCommªd
(
ş›Á
 *
c
) ;

374 
htN“dsResize
(
diù
 *dict);

376 
sds
 
g’VœeInfoSŒšg
(
vr_ev’oİ
 *
v–
, *
£ùiÚ
);

377 
šfoCommªd
(
ş›Á
 *
c
);

378 
echoCommªd
(
ş›Á
 *
c
);

379 
timeCommªd
(
ş›Á
 *
c
);

381 
adju¡O³nFesLim™
(
maxş›Ás
);

	@src/vr_server.h

1 #iâdeà
_VR_SERVER_H_


2 
	#_VR_SERVER_H_


	)

4 
	#CONFIG_MIN_RESERVED_FDS
 32

	)

7 
	#CONFIG_AUTHPASS_MAX_LEN
 512

	)

9 
	#PROTO_SHARED_SELECT_CMDS
 10

	)

10 
	#CRON_DBS_PER_CALL
 16

	)

14 
	#ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
 20

	)

15 
	#ACTIVE_EXPIRE_CYCLE_FAST_DURATION
 1000

	)

16 
	#ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
 25

	)

17 
	#ACTIVE_EXPIRE_CYCLE_SLOW
 0

	)

18 
	#ACTIVE_EXPIRE_CYCLE_FAST
 1

	)

21 
	#SCAN_TYPE_KEY
 0

	)

22 
	#SCAN_TYPE_HASH
 1

	)

23 
	#SCAN_TYPE_SET
 2

	)

24 
	#SCAN_TYPE_ZSET
 3

	)

27 
	#CONFIG_DEFAULT_MAXMEMORY_POLICY
 
MAXMEMORY_NO_EVICTION


	)

30 
	#OBJ_HASH_MAX_ZIPLIST_ENTRIES
 512

	)

31 
	#OBJ_HASH_MAX_ZIPLIST_VALUE
 64

	)

32 
	#OBJ_SET_MAX_INTSET_ENTRIES
 512

	)

33 
	#OBJ_ZSET_MAX_ZIPLIST_ENTRIES
 128

	)

34 
	#OBJ_ZSET_MAX_ZIPLIST_VALUE
 64

	)

37 
	#OBJ_LIST_MAX_ZIPLIST_SIZE
 -2

	)

38 
	#OBJ_LIST_COMPRESS_DEPTH
 0

	)

41 
	#CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
 3000

	)

44 
	#LIST_HEAD
 0

	)

45 
	#LIST_TAIL
 1

	)

47 
	#ZSKIPLIST_MAXLEVEL
 32

	)

48 
	#ZSKIPLIST_P
 0.25

	)

51 
	#UNIT_SECONDS
 0

	)

52 
	#UNIT_MILLISECONDS
 1

	)

55 
	#HASHTABLE_MIN_FILL
 10

	)

60 
	#run_w™h_³riod
(
_ms_
, 
üÚloİs
èià((_ms_ <ğ1000/
£rv”
.
hz
è|| !(üÚloİs%((_ms_)/(1000/£rv”.hz))))

	)

66 
	#LRU_CLOCK
(è((1000/
£rv”
.
hz
 <ğ
LRU_CLOCK_RESOLUTION
è? s”v”.
Ìuşock
 : 
	`g‘LRUClock
())

	)

80 
	s»adyLi¡
 {

81 
»disDb
 *
	mdb
;

82 
robj
 *
	mkey
;

83 } 
	t»adyLi¡
;

85 
	svr_£rv”
 {

86 
«Ev’tLoİ
 *
	m–
;

87 
dli¡
 *
	mş›Ás
;

90 
pid_t
 
	mpid
;

91 *
	mexecubË
;

92 *
	mcÚfigfe
;

93 
	mhz
;

95 
d¬¿y
 
	mdbs
;

96 
	mdbnum
;

97 
	mdbÊum
;

98 
	mdbšum
;

100 
diù
 *
	mcommªds
;

101 
diù
 *
	mÜig_commªds
;

103 
	mÌuşock
:
LRU_BITS
;

104 
	maùiv”ehashšg
;

106 *
	mpidfe
;

107 
	m¬ch_b™s
;

108 
	mrunid
[
CONFIG_RUN_ID_SIZE
+1];

111 
	mpÜt
;

112 
	mtı_backlog
;

114 
	mtık“·live
;

115 
size_t
 
	mş›Á_max_qu”ybuf_Ën
;

119 
size_t
 
	mhash_max_zli¡_’Œ›s
;

120 
size_t
 
	mhash_max_zli¡_v®ue
;

121 
size_t
 
	m£t_max_št£t_’Œ›s
;

122 
size_t
 
	mz£t_max_zli¡_’Œ›s
;

123 
size_t
 
	mz£t_max_zli¡_v®ue
;

124 
size_t
 
	mhÎ_¥¬£_max_by‹s
;

127 
	mli¡_max_zli¡_size
;

128 
	mli¡_com´ess_d•th
;

131 
ş›ÁBufãrLim™sCÚfig
 
	mş›Á_obuf_lim™s
[
CLIENT_TYPE_OBUF_COUNT
];

133 
dli¡
 *
	mmÚ™Üs
;

135 
time_t
 
	m¡¬‰ime
;

138 
time_t
 
	munixtime
;

139 
	mm¡ime
;

142 *
	munixsock‘
;

145 
	mlßdšg
;

146 
off_t
 
	mlßdšg_tÙ®_by‹s
;

147 
off_t
 
	mlßdšg_lßded_by‹s
;

148 
time_t
 
	mlßdšg_¡¬t_time
;

149 
off_t
 
	mlßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

152 
	maof_¡©e
;

153 
	maof_fsync
;

154 *
	maof_f’ame
;

155 
	maof_no_fsync_Ú_»wr™e
;

156 
	maof_»wr™e_³rc
;

157 
off_t
 
	maof_»wr™e_mš_size
;

158 
off_t
 
	maof_»wr™e_ba£_size
;

159 
off_t
 
	maof_cu¼’t_size
;

160 
	maof_»wr™e_scheduËd
;

161 
pid_t
 
	maof_chd_pid
;

162 
dli¡
 *
	maof_»wr™e_buf_blocks
;

163 
sds
 
	maof_buf
;

164 
	maof_fd
;

165 
	maof_£Ëùed_db
;

166 
time_t
 
	maof_æush_po¡pÚed_¡¬t
;

167 
time_t
 
	maof_Ï¡_fsync
;

168 
time_t
 
	maof_»wr™e_time_Ï¡
;

169 
time_t
 
	maof_»wr™e_time_¡¬t
;

170 
	maof_Ï¡bg»wr™e_¡©us
;

171 
	maof_d–ayed_fsync
;

172 
	maof_»wr™e_šüem’l_fsync
;

173 
	maof_Ï¡_wr™e_¡©us
;

174 
	maof_Ï¡_wr™e_”ºo
;

175 
	maof_lßd_Œunÿ‹d
;

177 
	maof_pe_wr™e_d©a_to_chd
;

178 
	maof_pe_»ad_d©a_äom_·»Á
;

179 
	maof_pe_wr™e_ack_to_·»Á
;

180 
	maof_pe_»ad_ack_äom_chd
;

181 
	maof_pe_wr™e_ack_to_chd
;

182 
	maof_pe_»ad_ack_äom_·»Á
;

183 
	maof_¡İ_£ndšg_diff
;

185 
sds
 
	maof_chd_diff
;

188 
	mdœty
;

189 
	mdœty_befÜe_bg§ve
;

190 
pid_t
 
	mrdb_chd_pid
;

191 
§v•¬am
 *
	m§v•¬ams
;

192 
	m§v•¬am¦’
;

193 *
	mrdb_f’ame
;

194 
	mrdb_com´essiÚ
;

195 
	mrdb_checksum
;

196 
time_t
 
	mÏ¡§ve
;

197 
time_t
 
	mÏ¡bg§ve_Œy
;

198 
time_t
 
	mrdb_§ve_time_Ï¡
;

199 
time_t
 
	mrdb_§ve_time_¡¬t
;

200 
	mrdb_chd_ty³
;

201 
	mÏ¡bg§ve_¡©us
;

202 
	m¡İ_wr™es_Ú_bg§ve_”r
;

203 
	mrdb_pe_wr™e_»suÉ_to_·»Á
;

204 
	mrdb_pe_»ad_»suÉ_äom_chd
;

208 
ş›Á
 *
	mlua_ş›Á
;

209 
ş›Á
 *
	mlua_ÿÎ”
;

210 
diù
 *
	mlua_süts
;

211 
m¡ime_t
 
	mlua_time_lim™
;

212 
m¡ime_t
 
	mlua_time_¡¬t
;

213 
	mlua_wr™e_dœty
;

215 
	mlua_¿ndom_dœty
;

217 
	mlua_»¶iÿ‹_commªds
;

218 
	mlua_muÉi_em™‹d
;

219 
	mlua_»¶
;

220 
	mlua_timedout
;

222 
	mlua_kl
;

223 
	mlua_®ways_»¶iÿ‹_commªds
;

227 
dli¡
 *
	m»ady_keys
;

230 
»disOpA¼ay
 
	m®so_´İag©e
;

234 
diù
 *
	mpubsub_chªÃls
;

236 
dli¡
 *
	mpubsub_·‰”ns
;

238 
	mnÙify_key¥aû_ev’ts
;

243 
»disCommªd
 *
	md–Commªd
, *
	mmuÉiCommªd
, *
	mÍushCommªd
, *
	mÍİCommªd
,

244 *
	m½İCommªd
, *
	m¤emCommªd
, *
	mexecCommªd
;

248 
size_t
 
	msy¡em_memÜy_size
;

253 
	szskli¡Node
 {

254 
robj
 *
	mobj
;

255 
	mscÜe
;

256 
zskli¡Node
 *
	mbackw¬d
;

257 
	szskli¡Lev–
 {

258 
zskli¡Node
 *
	mfÜw¬d
;

259 
	m¥ª
;

260 } 
	mËv–
[];

261 } 
	tzskli¡Node
;

263 
	szskli¡
 {

264 
zskli¡Node
 *
	mh—d”
, *
	m
;

265 
	mËngth
;

266 
	mËv–
;

267 } 
	tzskli¡
;

269 
	sz£t
 {

270 
diù
 *
	mdiù
;

271 
zskli¡
 *
	mz¦
;

272 } 
	tz£t
;

277 
robj
 *
	msubjeù
;

278 
	m’codšg
;

279 
	mdœeùiÚ
;

280 
quickli¡I‹r
 *
	m™”
;

281 } 
	tli¡Ty³I‹¿tÜ
;

286 
li¡Ty³I‹¿tÜ
 *
	mli
;

287 
quickli¡EÁry
 
	m’Œy
;

288 } 
	tli¡Ty³EÁry
;

293 
robj
 *
	msubjeù
;

294 
	m’codšg
;

295 
	mii
;

296 
diùI‹¿tÜ
 *
	mdi
;

297 } 
	t£tTy³I‹¿tÜ
;

305 
robj
 *
	msubjeù
;

306 
	m’codšg
;

308 *
	måŒ
, *
	mv±r
;

310 
diùI‹¿tÜ
 *
	mdi
;

311 
diùEÁry
 *
	mde
;

312 } 
	thashTy³I‹¿tÜ
;

315 
	ssh¬edObjeùsSŒuù
 {

316 
robj
 *
	mülf
, *
	mok
, *
	m”r
, *
	mem±ybulk
, *
	mcz”o
, *
	mcÚe
, *
	múegÚe
, *
	mpÚg
, *
	m¥aû
,

317 *
	mcŞÚ
, *
	mnuÎbulk
, *
	mnuÎmuÉibulk
, *
	mqueued
,

318 *
	mem±ymuÉibulk
, *
	mwrÚgty³”r
, *
	mnokey”r
, *
	msyÁax”r
, *
	m§meobjeù”r
,

319 *
	moutoäªg“¼
, *
	mnosü‹¼
, *
	mlßdšg”r
, *
	m¦owsü‹¼
, *
	mbg§v“¼
,

320 *
	mma¡”dowÃ¼
, *
	mro¦av“¼
, *
	mexeÿbÜ‹¼
, *
	mnßuth”r
, *
	mnßdmš”r
, *
	mnÜ•liÿ£¼
,

321 *
	mbusykey”r
, *
	moom”r
, *
	m¶us
, *
	mmes§gebulk
, *
	mpmes§gebulk
, *
	msubsüibebulk
,

322 *
	munsubsüibebulk
, *
	mpsubsüibebulk
, *
	mpunsubsüibebulk
, *
	md–
, *
	m½İ
, *
	mÍİ
,

323 *
	mÍush
, *
	mem±ysÿn
, *
	mmš¡ršg
, *
	mmax¡ršg
,

324 *
	m£Ëù
[
PROTO_SHARED_SELECT_CMDS
],

325 *
	mš‹g”s
[
OBJ_SHARED_INTEGERS
],

326 *
	mmbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
],

327 *
	mbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
],

328 *
	moutofcom¶ex™ylim™
,

329 *
	m£Áš–
;

333 
vr_£rv”
 
£rv”
;

335 
sh¬edObjeùsSŒuù
 
sh¬ed
;;

337 
diùTy³
 
hashDiùTy³
;

339 
diùTy³
 
£tDiùTy³
;

341 
diùTy³
 
z£tDiùTy³
;

343 
	#£rv”Pªic
(
_e
è
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 1, "as£¹ fad: %s", #_e)

	)

345 
	#£rv”As£¹W™hInfo
(
_c
,
_o
,
_e
è((_e)?()0 : (
	`_log
(
__FILE__
, 
__LINE__
, 
LOG_EMERG
, 1, "as£¹ fad: %s", #_e)))

	)

347 
diùSŒHash
(cÚ¡ *
key
);

348 
diùSŒCa£Hash
(cÚ¡ *
key
);

349 
diùSdsHash
(cÚ¡ *
key
);

350 
diùSdsCa£Hash
(cÚ¡ *
key
);

351 
diùSŒKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

352 
diùSŒKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

353 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

354 
diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

355 *
diùSdsKeyDupFromSŒ
(*
´ivd©a
, cÚ¡ *
key
);

356 
diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
);

357 
diùObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
);

358 
diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

359 
diùEncObjHash
(cÚ¡ *
key
);

360 
diùObjHash
(cÚ¡ *
key
);

361 
diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

362 
diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
);

364 
š™_£rv”
(
š¡ªû
 *
nci
);

366 
g‘LRUClock
();

368 
ä“MemÜyIfN“ded
(
vr_ev’oİ
 *
v–
);

369 
pšgCommªd
(
ş›Á
 *
c
);

370 
time_šd•’d’t_¡rcmp
(*
a
, *
b
);

371 
authCommªd
(
ş›Á
 *
c
) ;

372 
admšCommªd
(
ş›Á
 *
c
) ;

374 
htN“dsResize
(
diù
 *dict);

376 
sds
 
g’VœeInfoSŒšg
(
vr_ev’oİ
 *
v–
, *
£ùiÚ
);

377 
šfoCommªd
(
ş›Á
 *
c
);

378 
echoCommªd
(
ş›Á
 *
c
);

379 
timeCommªd
(
ş›Á
 *
c
);

381 
adju¡O³nFesLim™
(
maxş›Ás
);

	@src/vr_signal.c

1 
	~<¡dlib.h
>

2 
	~<sigÇl.h
>

4 
	~<vr_cÜe.h
>

5 
	~<vr_sigÇl.h
>

7 
sigÇl
 
	gsigÇls
[] = {

8 { 
SIGUSR1
, "SIGUSR1", 0, 
sigÇl_hªdËr
 },

9 { 
SIGUSR2
, "SIGUSR2", 0, 
sigÇl_hªdËr
 },

10 { 
SIGTTIN
, "SIGTTIN", 0, 
sigÇl_hªdËr
 },

11 { 
SIGTTOU
, "SIGTTOU", 0, 
sigÇl_hªdËr
 },

12 { 
SIGHUP
, "SIGHUP", 0, 
sigÇl_hªdËr
 },

13 { 
SIGINT
, "SIGINT", 0, 
sigÇl_hªdËr
 },

14 { 
SIGSEGV
, "SIGSEGV", ()
SA_RESETHAND
, 
sigÇl_hªdËr
 },

15 { 
SIGPIPE
, "SIGPIPE", 0, 
SIG_IGN
 },

16 { 0, 
NULL
, 0, NULL }

19 
r¡©us_t


20 
	$sigÇl_š™
()

22 
sigÇl
 *
sig
;

24 
sig
 = 
sigÇls
; sig->
signo
 != 0; sig++) {

25 
r¡©us_t
 
¡©us
;

26 
sigaùiÚ
 
§
;

28 
	`mem£t
(&
§
, 0, (sa));

29 
§
.
§_hªdËr
 = 
sig
->
hªdËr
;

30 
§
.
§_æags
 = 
sig
->
æags
;

31 
	`sigem±y£t
(&
§
.
§_mask
);

33 
¡©us
 = 
	`sigaùiÚ
(
sig
->
signo
, &
§
, 
NULL
);

34 ià(
¡©us
 < 0) {

35 
	`log_”rÜ
("sigaùiÚ(%sèçed: %s", 
sig
->
sigÇme
,

36 
	`¡»¼Ü
(
”ºo
));

37  
VR_ERROR
;

41  
VR_OK
;

42 
	}
}

45 
	$sigÇl_deš™
()

47 
	}
}

50 
	$sigÇl_hªdËr
(
signo
)

52 
sigÇl
 *
sig
;

53 (*
aùiÚ
)();

54 *
aùiÚ¡r
;

55 
boŞ
 
dÚe
;

57 
sig
 = 
sigÇls
; sig->
signo
 != 0; sig++) {

58 ià(
sig
->
signo
 == signo) {

62 
	`ASSERT
(
sig
->
signo
 != 0);

64 
aùiÚ¡r
 = "";

65 
aùiÚ
 = 
NULL
;

66 
dÚe
 = 
çl£
;

68 
signo
) {

69 
SIGUSR1
:

72 
SIGUSR2
:

75 
SIGTTIN
:

76 
aùiÚ¡r
 = ", up†ogging†evel";

77 
aùiÚ
 = 
log_Ëv–_up
;

80 
SIGTTOU
:

81 
aùiÚ¡r
 = ", down†ogging†evel";

82 
aùiÚ
 = 
log_Ëv–_down
;

85 
SIGHUP
:

86 
aùiÚ¡r
 = ",„eopening†og file";

87 
aùiÚ
 = 
log_»İ’
;

90 
SIGINT
:

91 
dÚe
 = 
Œue
;

92 
aùiÚ¡r
 = ",ƒxiting";

95 
SIGSEGV
:

96 
	`log_¡ackŒaû
();

97 
aùiÚ¡r
 = ", core dumping";

98 
	`¿i£
(
SIGSEGV
);

102 
	`NOT_REACHED
();

105 
	`log_§ã
("sigÇÈ%d (%sè»ûived%s", 
signo
, 
sig
->
sigÇme
, 
aùiÚ¡r
);

107 ià(
aùiÚ
 !ğ
NULL
) {

108 
	`aùiÚ
();

111 ià(
dÚe
) {

112 
	`ex™
(1);

114 
	}
}

	@src/vr_signal.c

1 
	~<¡dlib.h
>

2 
	~<sigÇl.h
>

4 
	~<vr_cÜe.h
>

5 
	~<vr_sigÇl.h
>

7 
sigÇl
 
	gsigÇls
[] = {

8 { 
SIGUSR1
, "SIGUSR1", 0, 
sigÇl_hªdËr
 },

9 { 
SIGUSR2
, "SIGUSR2", 0, 
sigÇl_hªdËr
 },

10 { 
SIGTTIN
, "SIGTTIN", 0, 
sigÇl_hªdËr
 },

11 { 
SIGTTOU
, "SIGTTOU", 0, 
sigÇl_hªdËr
 },

12 { 
SIGHUP
, "SIGHUP", 0, 
sigÇl_hªdËr
 },

13 { 
SIGINT
, "SIGINT", 0, 
sigÇl_hªdËr
 },

14 { 
SIGSEGV
, "SIGSEGV", ()
SA_RESETHAND
, 
sigÇl_hªdËr
 },

15 { 
SIGPIPE
, "SIGPIPE", 0, 
SIG_IGN
 },

16 { 0, 
NULL
, 0, NULL }

19 
r¡©us_t


20 
	$sigÇl_š™
()

22 
sigÇl
 *
sig
;

24 
sig
 = 
sigÇls
; sig->
signo
 != 0; sig++) {

25 
r¡©us_t
 
¡©us
;

26 
sigaùiÚ
 
§
;

28 
	`mem£t
(&
§
, 0, (sa));

29 
§
.
§_hªdËr
 = 
sig
->
hªdËr
;

30 
§
.
§_æags
 = 
sig
->
æags
;

31 
	`sigem±y£t
(&
§
.
§_mask
);

33 
¡©us
 = 
	`sigaùiÚ
(
sig
->
signo
, &
§
, 
NULL
);

34 ià(
¡©us
 < 0) {

35 
	`log_”rÜ
("sigaùiÚ(%sèçed: %s", 
sig
->
sigÇme
,

36 
	`¡»¼Ü
(
”ºo
));

37  
VR_ERROR
;

41  
VR_OK
;

42 
	}
}

45 
	$sigÇl_deš™
()

47 
	}
}

50 
	$sigÇl_hªdËr
(
signo
)

52 
sigÇl
 *
sig
;

53 (*
aùiÚ
)();

54 *
aùiÚ¡r
;

55 
boŞ
 
dÚe
;

57 
sig
 = 
sigÇls
; sig->
signo
 != 0; sig++) {

58 ià(
sig
->
signo
 == signo) {

62 
	`ASSERT
(
sig
->
signo
 != 0);

64 
aùiÚ¡r
 = "";

65 
aùiÚ
 = 
NULL
;

66 
dÚe
 = 
çl£
;

68 
signo
) {

69 
SIGUSR1
:

72 
SIGUSR2
:

75 
SIGTTIN
:

76 
aùiÚ¡r
 = ", up†ogging†evel";

77 
aùiÚ
 = 
log_Ëv–_up
;

80 
SIGTTOU
:

81 
aùiÚ¡r
 = ", down†ogging†evel";

82 
aùiÚ
 = 
log_Ëv–_down
;

85 
SIGHUP
:

86 
aùiÚ¡r
 = ",„eopening†og file";

87 
aùiÚ
 = 
log_»İ’
;

90 
SIGINT
:

91 
dÚe
 = 
Œue
;

92 
aùiÚ¡r
 = ",ƒxiting";

95 
SIGSEGV
:

96 
	`log_¡ackŒaû
();

97 
aùiÚ¡r
 = ", core dumping";

98 
	`¿i£
(
SIGSEGV
);

102 
	`NOT_REACHED
();

105 
	`log_§ã
("sigÇÈ%d (%sè»ûived%s", 
signo
, 
sig
->
sigÇme
, 
aùiÚ¡r
);

107 ià(
aùiÚ
 !ğ
NULL
) {

108 
	`aùiÚ
();

111 ià(
dÚe
) {

112 
	`ex™
(1);

114 
	}
}

	@src/vr_signal.h

1 #iâdeà
_VR_SIGNAL_H_


2 
	#_VR_SIGNAL_H_


	)

4 
	ssigÇl
 {

5 
	msigno
;

6 *
	msigÇme
;

7 
	mæags
;

8 (*
	mhªdËr
)(
	msigno
);

12 
r¡©us_t
 
sigÇl_š™
();

14 
sigÇl_deš™
();

16 
sigÇl_hªdËr
(
signo
);

	@src/vr_signal.h

1 #iâdeà
_VR_SIGNAL_H_


2 
	#_VR_SIGNAL_H_


	)

4 
	ssigÇl
 {

5 
	msigno
;

6 *
	msigÇme
;

7 
	mæags
;

8 (*
	mhªdËr
)(
	msigno
);

12 
r¡©us_t
 
sigÇl_š™
();

14 
sigÇl_deš™
();

16 
sigÇl_hªdËr
(
signo
);

	@src/vr_slowlog.c

1 
	~<vr_cÜe.h
>

3 
±h»ad_rwlock_t
 
	grwlock”
;

5 
dli¡
 *
	g¦owlog
;

7 
	g¦owlog_’Œy_id
;

12 
¦owlogEÁry
 *
	$¦owlogC»©eEÁry
(
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

13 
¦owlogEÁry
 *
£
 = 
	`d®loc
((*se));

14 
j
, 
¦¬gc
 = 
¬gc
;

16 ià(
¦¬gc
 > 
SLOWLOG_ENTRY_MAX_ARGC
) slargc = SLOWLOG_ENTRY_MAX_ARGC;

17 
£
->
¬gc
 = 
¦¬gc
;

18 
£
->
¬gv
 = 
	`d®loc
((
robj
*)*
¦¬gc
);

19 
j
 = 0; j < 
¦¬gc
; j++) {

23 ià(
¦¬gc
 !ğ
¬gc
 && 
j
 == slargc-1) {

24 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

25 
	`sdsÿrštf
(
	`sd£m±y
(),"... (%d more‡rguments)",

26 
¬gc
-
¦¬gc
+1));

29 ià(
¬gv
[
j
]->
ty³
 =ğ
OBJ_STRING
 &&

30 
	`sdsEncodedObjeù
(
¬gv
[
j
]) &&

31 
	`sd¦’
(
¬gv
[
j
]->
±r
è> 
SLOWLOG_ENTRY_MAX_STRING
)

33 
sds
 
s
 = 
	`sd¢ewËn
(
¬gv
[
j
]->
±r
, 
SLOWLOG_ENTRY_MAX_STRING
);

35 
s
 = 
	`sdsÿrštf
(s,"... (%lu more bytes)",

37 
	`sd¦’
(
¬gv
[
j
]->
±r
è- 
SLOWLOG_ENTRY_MAX_STRING
);

38 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

40 
£
->
¬gv
[
j
] = 
	`dupSŒšgObjeùUncÚ¡ªt
(argv[j]);

44 
£
->
time
 = 
	`time
(
NULL
);

45 
£
->
du¿tiÚ
 = duration;

46  
£
;

47 
	}
}

53 
	$¦owlogF»eEÁry
(*
£±r
) {

54 
¦owlogEÁry
 *
£
 = 
£±r
;

55 
j
;

57 
j
 = 0; j < 
£
->
¬gc
; j++)

58 
	`ä“Objeù
(
£
->
¬gv
[
j
]);

59 
	`dä“
(
£
->
¬gv
);

60 
	`dä“
(
£
);

61 
	}
}

65 
	$¦owlogIn™
() {

66 
	`±h»ad_rwlock_š™
(&
rwlock”
,
NULL
);

67 
¦owlog
 = 
	`dli¡C»©e
();

68 
¦owlog_’Œy_id
 = 0;

69 
	`dli¡S‘F»eM‘hod
(
¦owlog
,
¦owlogF»eEÁry
);

70 
	}
}

75 
	$¦owlogPushEÁryIfN“ded
(
vr_ev’oİ
 *
v–
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

76 
¦owlog_log_¦ow”_thª
;

77 
¦owlog_max_Ën
;

79 
¦owlog_log_¦ow”_thª
 = 
v–
->
cc
.slowlog_log_slower_than;

80 ià(
¦owlog_log_¦ow”_thª
 < 0) ;

81 ià(
du¿tiÚ
 >ğ
¦owlog_log_¦ow”_thª
) {

82 
¦owlogEÁry
 *
£
 = 
	`¦owlogC»©eEÁry
(
¬gv
,
¬gc
,
du¿tiÚ
);

83 
	`±h»ad_rwlock_w¾ock
(&
rwlock”
);

84 
£
->
id
 = 
¦owlog_’Œy_id
++;

85 
	`dli¡AddNodeH—d
(
¦owlog
,
£
);

86 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

89 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_SLOWLOGML
,&
¦owlog_max_Ën
);

91 
	`±h»ad_rwlock_w¾ock
(&
rwlock”
);

92 
	`dli¡L’gth
(
¦owlog
è> 
¦owlog_max_Ën
)

93 
	`dli¡D–Node
(
¦owlog
,
	`dli¡La¡
(slowlog));

94 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

95 
	}
}

98 
	$¦owlogRe£t
() {

99 
	`±h»ad_rwlock_w¾ock
(&
rwlock”
);

100 
	`dli¡L’gth
(
¦owlog
) > 0)

101 
	`dli¡D–Node
(
¦owlog
,
	`dli¡La¡
(slowlog));

102 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

103 
	}
}

107 
	$¦owlogCommªd
(
ş›Á
 *
c
) {

108 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"reset")) {

109 
	`¦owlogRe£t
();

110 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

111 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"len")) {

112 
Ën
;

113 
	`±h»ad_rwlock_rdlock
(&
rwlock”
);

114 
Ën
 = 
	`dli¡L’gth
(
¦owlog
);

115 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

116 
	`addR•lyLÚgLÚg
(
c
,
Ën
);

117 } ià((
c
->
¬gc
 == 2 || c->argc == 3) &&

118 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get"))

120 
couÁ
 = 10, 
£Á
 = 0;

121 
dli¡I‹r
 
li
;

122 *
tÙ’Œ›s
;

123 
dli¡Node
 *
Ê
;

124 
¦owlogEÁry
 *
£
;

126 ià(
c
->
¬gc
 == 3 &&

127 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
couÁ
,
NULL
è!ğ
VR_OK
)

130 
	`±h»ad_rwlock_rdlock
(&
rwlock”
);

131 
	`dli¡Rewšd
(
¦owlog
,&
li
);

132 
tÙ’Œ›s
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

133 
couÁ
-- && (
Ê
 = 
	`dli¡Next
(&
li
))) {

134 
j
;

136 
£
 = 
Ê
->
v®ue
;

137 
	`addR•lyMuÉiBulkL’
(
c
,4);

138 
	`addR•lyLÚgLÚg
(
c
,
£
->
id
);

139 
	`addR•lyLÚgLÚg
(
c
,
£
->
time
);

140 
	`addR•lyLÚgLÚg
(
c
,
£
->
du¿tiÚ
);

141 
	`addR•lyMuÉiBulkL’
(
c
,
£
->
¬gc
);

142 
j
 = 0; j < 
£
->
¬gc
; j++)

143 
	`addR•lyBulk
(
c
,
£
->
¬gv
[
j
]);

144 
£Á
++;

146 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

147 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
tÙ’Œ›s
,
£Á
);

149 
	`addR•lyE¼Ü
(
c
,

152 
	}
}

	@src/vr_slowlog.c

1 
	~<vr_cÜe.h
>

3 
±h»ad_rwlock_t
 
	grwlock”
;

5 
dli¡
 *
	g¦owlog
;

7 
	g¦owlog_’Œy_id
;

12 
¦owlogEÁry
 *
	$¦owlogC»©eEÁry
(
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

13 
¦owlogEÁry
 *
£
 = 
	`d®loc
((*se));

14 
j
, 
¦¬gc
 = 
¬gc
;

16 ià(
¦¬gc
 > 
SLOWLOG_ENTRY_MAX_ARGC
) slargc = SLOWLOG_ENTRY_MAX_ARGC;

17 
£
->
¬gc
 = 
¦¬gc
;

18 
£
->
¬gv
 = 
	`d®loc
((
robj
*)*
¦¬gc
);

19 
j
 = 0; j < 
¦¬gc
; j++) {

23 ià(
¦¬gc
 !ğ
¬gc
 && 
j
 == slargc-1) {

24 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

25 
	`sdsÿrštf
(
	`sd£m±y
(),"... (%d more‡rguments)",

26 
¬gc
-
¦¬gc
+1));

29 ià(
¬gv
[
j
]->
ty³
 =ğ
OBJ_STRING
 &&

30 
	`sdsEncodedObjeù
(
¬gv
[
j
]) &&

31 
	`sd¦’
(
¬gv
[
j
]->
±r
è> 
SLOWLOG_ENTRY_MAX_STRING
)

33 
sds
 
s
 = 
	`sd¢ewËn
(
¬gv
[
j
]->
±r
, 
SLOWLOG_ENTRY_MAX_STRING
);

35 
s
 = 
	`sdsÿrštf
(s,"... (%lu more bytes)",

37 
	`sd¦’
(
¬gv
[
j
]->
±r
è- 
SLOWLOG_ENTRY_MAX_STRING
);

38 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

40 
£
->
¬gv
[
j
] = 
	`dupSŒšgObjeùUncÚ¡ªt
(argv[j]);

44 
£
->
time
 = 
	`time
(
NULL
);

45 
£
->
du¿tiÚ
 = duration;

46  
£
;

47 
	}
}

53 
	$¦owlogF»eEÁry
(*
£±r
) {

54 
¦owlogEÁry
 *
£
 = 
£±r
;

55 
j
;

57 
j
 = 0; j < 
£
->
¬gc
; j++)

58 
	`ä“Objeù
(
£
->
¬gv
[
j
]);

59 
	`dä“
(
£
->
¬gv
);

60 
	`dä“
(
£
);

61 
	}
}

65 
	$¦owlogIn™
() {

66 
	`±h»ad_rwlock_š™
(&
rwlock”
,
NULL
);

67 
¦owlog
 = 
	`dli¡C»©e
();

68 
¦owlog_’Œy_id
 = 0;

69 
	`dli¡S‘F»eM‘hod
(
¦owlog
,
¦owlogF»eEÁry
);

70 
	}
}

75 
	$¦owlogPushEÁryIfN“ded
(
vr_ev’oİ
 *
v–
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

76 
¦owlog_log_¦ow”_thª
;

77 
¦owlog_max_Ën
;

79 
¦owlog_log_¦ow”_thª
 = 
v–
->
cc
.slowlog_log_slower_than;

80 ià(
¦owlog_log_¦ow”_thª
 < 0) ;

81 ià(
du¿tiÚ
 >ğ
¦owlog_log_¦ow”_thª
) {

82 
¦owlogEÁry
 *
£
 = 
	`¦owlogC»©eEÁry
(
¬gv
,
¬gc
,
du¿tiÚ
);

83 
	`±h»ad_rwlock_w¾ock
(&
rwlock”
);

84 
£
->
id
 = 
¦owlog_’Œy_id
++;

85 
	`dli¡AddNodeH—d
(
¦owlog
,
£
);

86 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

89 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_SLOWLOGML
,&
¦owlog_max_Ën
);

91 
	`±h»ad_rwlock_w¾ock
(&
rwlock”
);

92 
	`dli¡L’gth
(
¦owlog
è> 
¦owlog_max_Ën
)

93 
	`dli¡D–Node
(
¦owlog
,
	`dli¡La¡
(slowlog));

94 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

95 
	}
}

98 
	$¦owlogRe£t
() {

99 
	`±h»ad_rwlock_w¾ock
(&
rwlock”
);

100 
	`dli¡L’gth
(
¦owlog
) > 0)

101 
	`dli¡D–Node
(
¦owlog
,
	`dli¡La¡
(slowlog));

102 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

103 
	}
}

107 
	$¦owlogCommªd
(
ş›Á
 *
c
) {

108 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"reset")) {

109 
	`¦owlogRe£t
();

110 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

111 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"len")) {

112 
Ën
;

113 
	`±h»ad_rwlock_rdlock
(&
rwlock”
);

114 
Ën
 = 
	`dli¡L’gth
(
¦owlog
);

115 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

116 
	`addR•lyLÚgLÚg
(
c
,
Ën
);

117 } ià((
c
->
¬gc
 == 2 || c->argc == 3) &&

118 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get"))

120 
couÁ
 = 10, 
£Á
 = 0;

121 
dli¡I‹r
 
li
;

122 *
tÙ’Œ›s
;

123 
dli¡Node
 *
Ê
;

124 
¦owlogEÁry
 *
£
;

126 ià(
c
->
¬gc
 == 3 &&

127 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
couÁ
,
NULL
è!ğ
VR_OK
)

130 
	`±h»ad_rwlock_rdlock
(&
rwlock”
);

131 
	`dli¡Rewšd
(
¦owlog
,&
li
);

132 
tÙ’Œ›s
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

133 
couÁ
-- && (
Ê
 = 
	`dli¡Next
(&
li
))) {

134 
j
;

136 
£
 = 
Ê
->
v®ue
;

137 
	`addR•lyMuÉiBulkL’
(
c
,4);

138 
	`addR•lyLÚgLÚg
(
c
,
£
->
id
);

139 
	`addR•lyLÚgLÚg
(
c
,
£
->
time
);

140 
	`addR•lyLÚgLÚg
(
c
,
£
->
du¿tiÚ
);

141 
	`addR•lyMuÉiBulkL’
(
c
,
£
->
¬gc
);

142 
j
 = 0; j < 
£
->
¬gc
; j++)

143 
	`addR•lyBulk
(
c
,
£
->
¬gv
[
j
]);

144 
£Á
++;

146 
	`±h»ad_rwlock_uÆock
(&
rwlock”
);

147 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
tÙ’Œ›s
,
£Á
);

149 
	`addR•lyE¼Ü
(
c
,

152 
	}
}

	@src/vr_slowlog.h

1 #iâdeà
_VR_SLOWLOG_H_


2 
	#_VR_SLOWLOG_H_


	)

4 
	#SLOWLOG_ENTRY_MAX_ARGC
 32

	)

5 
	#SLOWLOG_ENTRY_MAX_STRING
 128

	)

9 
	s¦owlogEÁry
 {

11 
robj
 **
	m¬gv
;

12 
	m¬gc
;

13 
	mid
;

14 
	mdu¿tiÚ
;

15 
time_t
 
	mtime
;

16 } 
	t¦owlogEÁry
;

19 
¦owlogIn™
();

20 
¦owlogPushEÁryIfN“ded
(
vr_ev’oİ
 *
v–
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
);

23 
¦owlogCommªd
(
ş›Á
 *
c
);

	@src/vr_slowlog.h

1 #iâdeà
_VR_SLOWLOG_H_


2 
	#_VR_SLOWLOG_H_


	)

4 
	#SLOWLOG_ENTRY_MAX_ARGC
 32

	)

5 
	#SLOWLOG_ENTRY_MAX_STRING
 128

	)

9 
	s¦owlogEÁry
 {

11 
robj
 **
	m¬gv
;

12 
	m¬gc
;

13 
	mid
;

14 
	mdu¿tiÚ
;

15 
time_t
 
	mtime
;

16 } 
	t¦owlogEÁry
;

19 
¦owlogIn™
();

20 
¦owlogPushEÁryIfN“ded
(
vr_ev’oİ
 *
v–
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
);

23 
¦owlogCommªd
(
ş›Á
 *
c
);

	@src/vr_stats.c

1 
	~<vr_cÜe.h
>

4 
	$vr_¡©s_š™
(
vr_¡©s
 *
¡©s
)

6 
r¡©us_t
 
»t
;

8 ià(
¡©s
 =ğ
NULL
) {

9  
VR_ERROR
;

12 
¡©s
->
¡¬‰ime
 = 0;

13 
¡©s
->
numcommªds
 = 0;

14 
¡©s
->
numcÚÃùiÚs
 = 0;

15 
¡©s
->
expœedkeys
 = 0;

16 
¡©s
->
eviùedkeys
 = 0;

17 
¡©s
->
key¥aû_h™s
 = 0;

18 
¡©s
->
key¥aû_mis£s
 = 0;

19 
¡©s
->
»jeùed_cÚn
 = 0;

20 
¡©s
->
sync_fuÎ
 = 0;

21 
¡©s
->
sync_·¹Ÿl_ok
 = 0;

22 
¡©s
->
sync_·¹Ÿl_”r
 = 0;

23 
¡©s
->
Ãt_šput_by‹s
 = 0;

24 
¡©s
->
Ãt_ouut_by‹s
 = 0;

25 
¡©s
->
³ak_memÜy
 = 0;

27 #ià!
	`defšed
(
STATS_ATOMIC_FIRST
è|| (!defšed(
__ATOMIC_RELAXED
è&& !defšed(
HAVE_ATOMIC
))

28 
»t
 = 
	`±h»ad_¥š_š™
(&
¡©s
->
¡©¦ock
, 0);

29 ià(
»t
 != 0) {

30  
VR_ERROR
;

34 
¡©s
->
¡¬‰ime
 = 
	`time
(
NULL
);

36  
VR_OK
;

37 
	}
}

40 
	$vr_¡©s_deš™
(
vr_¡©s
 *
¡©s
)

42 ià(
¡©s
 =ğ
NULL
) {

46 
¡©s
->
¡¬‰ime
 = 0;

47 
¡©s
->
numcommªds
 = 0;

48 
¡©s
->
numcÚÃùiÚs
 = 0;

49 
¡©s
->
expœedkeys
 = 0;

50 
¡©s
->
eviùedkeys
 = 0;

51 
¡©s
->
key¥aû_h™s
 = 0;

52 
¡©s
->
key¥aû_mis£s
 = 0;

53 
¡©s
->
»jeùed_cÚn
 = 0;

54 
¡©s
->
sync_fuÎ
 = 0;

55 
¡©s
->
sync_·¹Ÿl_ok
 = 0;

56 
¡©s
->
sync_·¹Ÿl_”r
 = 0;

57 
¡©s
->
Ãt_šput_by‹s
 = 0;

58 
¡©s
->
Ãt_ouut_by‹s
 = 0;

60 #ià!
	`defšed
(
STATS_ATOMIC_FIRST
è|| (!defšed(
__ATOMIC_RELAXED
è&& !defšed(
HAVE_ATOMIC
))

61 
	`±h»ad_¥š_de¡roy
(&
¡©s
->
¡©¦ock
);

63 
	}
}

66 
	$ŒackIn¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
, 
cu¼’t_»adšg
) {

67 
t
 = 
	`vr_m£c_now
(è- 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
;

68 
İs
 = 
cu¼’t_»adšg
 -

69 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
;

70 
İs_£c
;

72 
İs_£c
 = 
t
 > 0 ? (
İs
*1000/t) : 0;

74 
	`upd©e_¡©s_£t
(
¡©s
,
š¡_m‘ric
[
m‘ric
].
§m¶es
[¡©s->š¡_m‘ric[m‘ric].
idx
],
İs_£c
);

75 
¡©s
->
š¡_m‘ric
[
m‘ric
].
idx
++;

76 
¡©s
->
š¡_m‘ric
[
m‘ric
].
idx
 %ğ
STATS_METRIC_SAMPLES
;

77 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
 = 
	`vr_m£c_now
();

78 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
 = 
cu¼’t_»adšg
;

79 
	}
}

82 
	$g‘In¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
) {

83 
j
;

84 
sum
 = 0;

86 
j
 = 0; j < 
STATS_METRIC_SAMPLES
; j++) {

87 
v®ue
;

88 
	`upd©e_¡©s_g‘
(
¡©s
, 
š¡_m‘ric
[
m‘ric
].
§m¶es
[
j
], &
v®ue
);

89 
sum
 +ğ
v®ue
;

91  
sum
 / 
STATS_METRIC_SAMPLES
;

92 
	}
}

	@src/vr_stats.c

1 
	~<vr_cÜe.h
>

4 
	$vr_¡©s_š™
(
vr_¡©s
 *
¡©s
)

6 
r¡©us_t
 
»t
;

8 ià(
¡©s
 =ğ
NULL
) {

9  
VR_ERROR
;

12 
¡©s
->
¡¬‰ime
 = 0;

13 
¡©s
->
numcommªds
 = 0;

14 
¡©s
->
numcÚÃùiÚs
 = 0;

15 
¡©s
->
expœedkeys
 = 0;

16 
¡©s
->
eviùedkeys
 = 0;

17 
¡©s
->
key¥aû_h™s
 = 0;

18 
¡©s
->
key¥aû_mis£s
 = 0;

19 
¡©s
->
»jeùed_cÚn
 = 0;

20 
¡©s
->
sync_fuÎ
 = 0;

21 
¡©s
->
sync_·¹Ÿl_ok
 = 0;

22 
¡©s
->
sync_·¹Ÿl_”r
 = 0;

23 
¡©s
->
Ãt_šput_by‹s
 = 0;

24 
¡©s
->
Ãt_ouut_by‹s
 = 0;

25 
¡©s
->
³ak_memÜy
 = 0;

27 #ià!
	`defšed
(
STATS_ATOMIC_FIRST
è|| (!defšed(
__ATOMIC_RELAXED
è&& !defšed(
HAVE_ATOMIC
))

28 
»t
 = 
	`±h»ad_¥š_š™
(&
¡©s
->
¡©¦ock
, 0);

29 ià(
»t
 != 0) {

30  
VR_ERROR
;

34 
¡©s
->
¡¬‰ime
 = 
	`time
(
NULL
);

36  
VR_OK
;

37 
	}
}

40 
	$vr_¡©s_deš™
(
vr_¡©s
 *
¡©s
)

42 ià(
¡©s
 =ğ
NULL
) {

46 
¡©s
->
¡¬‰ime
 = 0;

47 
¡©s
->
numcommªds
 = 0;

48 
¡©s
->
numcÚÃùiÚs
 = 0;

49 
¡©s
->
expœedkeys
 = 0;

50 
¡©s
->
eviùedkeys
 = 0;

51 
¡©s
->
key¥aû_h™s
 = 0;

52 
¡©s
->
key¥aû_mis£s
 = 0;

53 
¡©s
->
»jeùed_cÚn
 = 0;

54 
¡©s
->
sync_fuÎ
 = 0;

55 
¡©s
->
sync_·¹Ÿl_ok
 = 0;

56 
¡©s
->
sync_·¹Ÿl_”r
 = 0;

57 
¡©s
->
Ãt_šput_by‹s
 = 0;

58 
¡©s
->
Ãt_ouut_by‹s
 = 0;

60 #ià!
	`defšed
(
STATS_ATOMIC_FIRST
è|| (!defšed(
__ATOMIC_RELAXED
è&& !defšed(
HAVE_ATOMIC
))

61 
	`±h»ad_¥š_de¡roy
(&
¡©s
->
¡©¦ock
);

63 
	}
}

66 
	$ŒackIn¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
, 
cu¼’t_»adšg
) {

67 
t
 = 
	`vr_m£c_now
(è- 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
;

68 
İs
 = 
cu¼’t_»adšg
 -

69 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
;

70 
İs_£c
;

72 
İs_£c
 = 
t
 > 0 ? (
İs
*1000/t) : 0;

74 
	`upd©e_¡©s_£t
(
¡©s
,
š¡_m‘ric
[
m‘ric
].
§m¶es
[¡©s->š¡_m‘ric[m‘ric].
idx
],
İs_£c
);

75 
¡©s
->
š¡_m‘ric
[
m‘ric
].
idx
++;

76 
¡©s
->
š¡_m‘ric
[
m‘ric
].
idx
 %ğ
STATS_METRIC_SAMPLES
;

77 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
 = 
	`vr_m£c_now
();

78 
¡©s
->
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
 = 
cu¼’t_»adšg
;

79 
	}
}

82 
	$g‘In¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
) {

83 
j
;

84 
sum
 = 0;

86 
j
 = 0; j < 
STATS_METRIC_SAMPLES
; j++) {

87 
v®ue
;

88 
	`upd©e_¡©s_g‘
(
¡©s
, 
š¡_m‘ric
[
m‘ric
].
§m¶es
[
j
], &
v®ue
);

89 
sum
 +ğ
v®ue
;

91  
sum
 / 
STATS_METRIC_SAMPLES
;

92 
	}
}

	@src/vr_stats.h

1 #iâdeà
_VR_STATS_H_


2 
	#_VR_STATS_H_


	)

5 
	#STATS_ATOMIC_FIRST
 1

	)

9 
	#STATS_METRIC_SAMPLES
 16

	)

10 
	#STATS_METRIC_COMMAND
 0

	)

11 
	#STATS_METRIC_NET_INPUT
 1

	)

12 
	#STATS_METRIC_NET_OUTPUT
 2

	)

13 
	#STATS_METRIC_COUNT
 3

	)

15 
	svr_¡©s
 {

17 
time_t
 
	m¡¬‰ime
;

18 
	mnumcommªds
;

19 
	mnumcÚÃùiÚs
;

20 
	mexpœedkeys
;

21 
	meviùedkeys
;

22 
	mkey¥aû_h™s
;

23 
	mkey¥aû_mis£s
;

24 
	m»jeùed_cÚn
;

25 
	msync_fuÎ
;

26 
	msync_·¹Ÿl_ok
;

27 
	msync_·¹Ÿl_”r
;

28 
	mÃt_šput_by‹s
;

29 
	mÃt_ouut_by‹s
;

30 
size_t
 
	m³ak_memÜy
;

35 
	mÏ¡_§m¶e_time
;

36 
	mÏ¡_§m¶e_couÁ
;

37 
	m§m¶es
[
STATS_METRIC_SAMPLES
];

38 
	midx
;

39 } 
	mš¡_m‘ric
[
STATS_METRIC_COUNT
];

41 #ià!
defšed
(
STATS_ATOMIC_FIRST
è|| (!defšed(
__ATOMIC_RELAXED
è&& !defšed(
HAVE_ATOMIC
))

42 
±h»ad_¥šlock_t
 
	m¡©¦ock
;

44 }
	tvr_¡©s
;

47 #ià
defšed
(
__ATOMIC_RELAXED
è&& defšed(
STATS_ATOMIC_FIRST
)

48 
	#upd©e_¡©s_add
(
_¡©s
, 
_f›ld
, 
_n
è
	`__©omic_add_ãtch
(&(_¡©s)->_f›ld, (_n), 
__ATOMIC_RELAXED
)

	)

49 
	#upd©e_¡©s_sub
(
_¡©s
, 
_f›ld
, 
_n
è
	`__©omic_sub_ãtch
(&(_¡©s)->_f›ld, (_n), 
__ATOMIC_RELAXED
)

	)

50 
	#upd©e_¡©s_£t
(
_¡©s
, 
_f›ld
, 
_n
è
	`__©omic_¡Üe_n
(&(_¡©s)->_f›ld, (_n), 
__ATOMIC_RELAXED
)

	)

51 
	#upd©e_¡©s_g‘
(
_¡©s
, 
_f›ld
, 
_v
) do { \

52 
	`__©omic_lßd
(&(
_¡©s
)->
_f›ld
, 
_v
, 
__ATOMIC_RELAXED
); \

53 } 0)

	)

55 
	#STATS_LOCK_TYPE
 "__ATOMIC_RELAXED"

	)

57 #–ià
defšed
(
HAVE_ATOMIC
è&& defšed(
STATS_ATOMIC_FIRST
)

58 
	#upd©e_¡©s_add
(
_¡©s
, 
_f›ld
, 
_n
è
	`__sync_add_ªd_ãtch
(&(_¡©s)->_f›ld, (_n))

	)

59 
	#upd©e_¡©s_sub
(
_¡©s
, 
_f›ld
, 
_n
è
	`__sync_sub_ªd_ãtch
(&(_¡©s)->_f›ld, (_n))

	)

60 
	#upd©e_¡©s_£t
(
_¡©s
, 
_f›ld
, 
_n
è
	`__sync_lock_‹¡_ªd_£t
(&(_¡©s)->_f›ld, (_n))

	)

61 
	#upd©e_¡©s_g‘
(
_¡©s
, 
_f›ld
, 
_v
) do { \

62 (*
_v
èğ
	`__sync_add_ªd_ãtch
(&(
_¡©s
)->
_f›ld
, 0); \

63 } 0)

	)

65 
	#STATS_LOCK_TYPE
 "HAVE_ATOMIC"

	)

67 
	#upd©e_¡©s_add
(
_¡©s
, 
_f›ld
, 
_n
) do { \

68 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

69 (
_¡©s
)->
_f›ld
 +ğ(
_n
); \

70 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

71 } 0)

	)

73 
	#upd©e_¡©s_sub
(
_¡©s
, 
_f›ld
, 
_n
) do { \

74 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

75 (
_¡©s
)->
_f›ld
 -ğ(
_n
); \

76 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

77 } 0)

	)

79 
	#upd©e_¡©s_£t
(
_¡©s
, 
_f›ld
, 
_n
) do { \

80 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

81 (
_¡©s
)->
_f›ld
 = (
_n
); \

82 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

83 } 0)

	)

85 
	#upd©e_¡©s_g‘
(
_¡©s
, 
_f›ld
, 
_v
) do { \

86 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

87 (*
_v
èğ(
_¡©s
)->
_f›ld
; \

88 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

89 } 0)

	)

91 
	#STATS_LOCK_TYPE
 "±h»ad_¥š_lock"

	)

94 
vr_¡©s_š™
(
vr_¡©s
 *
¡©s
);

95 
vr_¡©s_deš™
(
vr_¡©s
 *
¡©s
);

97 
ŒackIn¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
, 
cu¼’t_»adšg
);

98 
g‘In¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
);

	@src/vr_stats.h

1 #iâdeà
_VR_STATS_H_


2 
	#_VR_STATS_H_


	)

5 
	#STATS_ATOMIC_FIRST
 1

	)

9 
	#STATS_METRIC_SAMPLES
 16

	)

10 
	#STATS_METRIC_COMMAND
 0

	)

11 
	#STATS_METRIC_NET_INPUT
 1

	)

12 
	#STATS_METRIC_NET_OUTPUT
 2

	)

13 
	#STATS_METRIC_COUNT
 3

	)

15 
	svr_¡©s
 {

17 
time_t
 
	m¡¬‰ime
;

18 
	mnumcommªds
;

19 
	mnumcÚÃùiÚs
;

20 
	mexpœedkeys
;

21 
	meviùedkeys
;

22 
	mkey¥aû_h™s
;

23 
	mkey¥aû_mis£s
;

24 
	m»jeùed_cÚn
;

25 
	msync_fuÎ
;

26 
	msync_·¹Ÿl_ok
;

27 
	msync_·¹Ÿl_”r
;

28 
	mÃt_šput_by‹s
;

29 
	mÃt_ouut_by‹s
;

30 
size_t
 
	m³ak_memÜy
;

35 
	mÏ¡_§m¶e_time
;

36 
	mÏ¡_§m¶e_couÁ
;

37 
	m§m¶es
[
STATS_METRIC_SAMPLES
];

38 
	midx
;

39 } 
	mš¡_m‘ric
[
STATS_METRIC_COUNT
];

41 #ià!
defšed
(
STATS_ATOMIC_FIRST
è|| (!defšed(
__ATOMIC_RELAXED
è&& !defšed(
HAVE_ATOMIC
))

42 
±h»ad_¥šlock_t
 
	m¡©¦ock
;

44 }
	tvr_¡©s
;

47 #ià
defšed
(
__ATOMIC_RELAXED
è&& defšed(
STATS_ATOMIC_FIRST
)

48 
	#upd©e_¡©s_add
(
_¡©s
, 
_f›ld
, 
_n
è
	`__©omic_add_ãtch
(&(_¡©s)->_f›ld, (_n), 
__ATOMIC_RELAXED
)

	)

49 
	#upd©e_¡©s_sub
(
_¡©s
, 
_f›ld
, 
_n
è
	`__©omic_sub_ãtch
(&(_¡©s)->_f›ld, (_n), 
__ATOMIC_RELAXED
)

	)

50 
	#upd©e_¡©s_£t
(
_¡©s
, 
_f›ld
, 
_n
è
	`__©omic_¡Üe_n
(&(_¡©s)->_f›ld, (_n), 
__ATOMIC_RELAXED
)

	)

51 
	#upd©e_¡©s_g‘
(
_¡©s
, 
_f›ld
, 
_v
) do { \

52 
	`__©omic_lßd
(&(
_¡©s
)->
_f›ld
, 
_v
, 
__ATOMIC_RELAXED
); \

53 } 0)

	)

55 
	#STATS_LOCK_TYPE
 "__ATOMIC_RELAXED"

	)

57 #–ià
defšed
(
HAVE_ATOMIC
è&& defšed(
STATS_ATOMIC_FIRST
)

58 
	#upd©e_¡©s_add
(
_¡©s
, 
_f›ld
, 
_n
è
	`__sync_add_ªd_ãtch
(&(_¡©s)->_f›ld, (_n))

	)

59 
	#upd©e_¡©s_sub
(
_¡©s
, 
_f›ld
, 
_n
è
	`__sync_sub_ªd_ãtch
(&(_¡©s)->_f›ld, (_n))

	)

60 
	#upd©e_¡©s_£t
(
_¡©s
, 
_f›ld
, 
_n
è
	`__sync_lock_‹¡_ªd_£t
(&(_¡©s)->_f›ld, (_n))

	)

61 
	#upd©e_¡©s_g‘
(
_¡©s
, 
_f›ld
, 
_v
) do { \

62 (*
_v
èğ
	`__sync_add_ªd_ãtch
(&(
_¡©s
)->
_f›ld
, 0); \

63 } 0)

	)

65 
	#STATS_LOCK_TYPE
 "HAVE_ATOMIC"

	)

67 
	#upd©e_¡©s_add
(
_¡©s
, 
_f›ld
, 
_n
) do { \

68 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

69 (
_¡©s
)->
_f›ld
 +ğ(
_n
); \

70 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

71 } 0)

	)

73 
	#upd©e_¡©s_sub
(
_¡©s
, 
_f›ld
, 
_n
) do { \

74 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

75 (
_¡©s
)->
_f›ld
 -ğ(
_n
); \

76 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

77 } 0)

	)

79 
	#upd©e_¡©s_£t
(
_¡©s
, 
_f›ld
, 
_n
) do { \

80 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

81 (
_¡©s
)->
_f›ld
 = (
_n
); \

82 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

83 } 0)

	)

85 
	#upd©e_¡©s_g‘
(
_¡©s
, 
_f›ld
, 
_v
) do { \

86 
	`±h»ad_¥š_lock
(&(
_¡©s
)->
¡©¦ock
); \

87 (*
_v
èğ(
_¡©s
)->
_f›ld
; \

88 
	`±h»ad_¥š_uÆock
(&(
_¡©s
)->
¡©¦ock
); \

89 } 0)

	)

91 
	#STATS_LOCK_TYPE
 "±h»ad_¥š_lock"

	)

94 
vr_¡©s_š™
(
vr_¡©s
 *
¡©s
);

95 
vr_¡©s_deš™
(
vr_¡©s
 *
¡©s
);

97 
ŒackIn¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
, 
cu¼’t_»adšg
);

98 
g‘In¡ªÃousM‘ric
(
vr_¡©s
 *
¡©s
, 
m‘ric
);

	@src/vr_t_hash.c

1 
	~<m©h.h
>

3 
	~<vr_cÜe.h
>

12 
	$hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
) {

13 
i
;

15 ià(
o
->
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
) ;

17 
i
 = 
¡¬t
; i <ğ
’d
; i++) {

18 ià(
	`sdsEncodedObjeù
(
¬gv
[
i
]) &&

19 
	`sd¦’
(
¬gv
[
i
]->
±r
è> 
£rv”
.
hash_max_zli¡_v®ue
)

21 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

25 
	}
}

28 
	$hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
) {

29 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

30 ià(
o1
è*o1 = 
	`ŒyObjeùEncodšg
(*o1);

31 ià(
o2
è*o2 = 
	`ŒyObjeùEncodšg
(*o2);

33 
	}
}

37 
	$hashTy³G‘FromZli¡
(
robj
 *
o
,„obj *
f›ld
,

38 **
v¡r
,

39 *
vËn
,

40 *
vÎ
)

42 *
zl
, *
åŒ
 = 
NULL
, *
v±r
 = NULL;

43 
»t
;

44 
robj
 *
f›ld_Ãw
;

46 
	`ASSERT
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

48 
f›ld_Ãw
 = 
	`g‘DecodedObjeù
(
f›ld
);

50 
zl
 = 
o
->
±r
;

51 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

52 ià(
åŒ
 !ğ
NULL
) {

53 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(field_new->ptr), 1);

54 ià(
åŒ
 !ğ
NULL
) {

56 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

57 
	`ASSERT
(
v±r
 !ğ
NULL
);

61 ià(
f›ld_Ãw
 !ğ
f›ld
è
	`ä“Objeù
(field_new);

63 ià(
v±r
 !ğ
NULL
) {

64 
»t
 = 
	`zli¡G‘
(
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

65 
	`ASSERT
(
»t
);

70 
	}
}

74 
	$hashTy³G‘FromHashTabË
(
robj
 *
o
,„obj *
f›ld
,„obj **
v®ue
) {

75 
diùEÁry
 *
de
;

77 
	`ASSERT
(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

79 
de
 = 
	`diùFšd
(
o
->
±r
, 
f›ld
);

80 ià(
de
 =ğ
NULL
)  -1;

81 *
v®ue
 = 
	`diùG‘V®
(
de
);

83 
	}
}

91 
robj
 *
	$hashTy³G‘Objeù
(
robj
 *
o
,„obj *
f›ld
) {

92 
robj
 *
v®ue
 = 
NULL
;

94 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

95 *
v¡r
 = 
NULL
;

96 
vËn
 = 
UINT_MAX
;

97 
vÎ
 = 
LLONG_MAX
;

99 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0) {

100 ià(
v¡r
) {

101 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
, 
vËn
);

103 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

106 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

107 
robj
 *
aux
;

109 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0) {

110 
v®ue
 = 
aux
;

113 
	`£rv”Pªic
("Unknown hashƒncoding");

115  
v®ue
;

116 
	}
}

121 
size_t
 
	$hashTy³G‘V®ueL’gth
(
robj
 *
o
,„obj *
f›ld
) {

122 
size_t
 
Ën
 = 0;

123 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

124 *
v¡r
 = 
NULL
;

125 
vËn
 = 
UINT_MAX
;

126 
vÎ
 = 
LLONG_MAX
;

128 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)

129 
Ën
 = 
v¡r
 ? 
vËn
 : 
	`sdig™s10
(
vÎ
);

130 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

131 
robj
 *
aux
;

133 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0)

134 
Ën
 = 
	`¡ršgObjeùL’
(
aux
);

136 
	`£rv”Pªic
("Unknown hashƒncoding");

138  
Ën
;

139 
	}
}

143 
	$hashTy³Exi¡s
(
robj
 *
o
,„obj *
f›ld
) {

144 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

145 *
v¡r
 = 
NULL
;

146 
vËn
 = 
UINT_MAX
;

147 
vÎ
 = 
LLONG_MAX
;

149 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)  1;

150 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

151 
robj
 *
aux
;

153 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0)  1;

155 
	`£rv”Pªic
("Unknown hashƒncoding");

158 
	}
}

165 
	$hashTy³S‘
(
robj
 *
o
,„obj *
f›ld
,„obj *
v®ue
) {

166 
upd©e
 = 0;

167 
robj
 *
f›ld_Ãw
, *
v®ue_Ãw
;

169 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

170 *
zl
, *
åŒ
, *
v±r
;

172 
f›ld_Ãw
 = 
	`g‘DecodedObjeù
(
f›ld
);

173 
v®ue_Ãw
 = 
	`g‘DecodedObjeù
(
v®ue
);

175 
zl
 = 
o
->
±r
;

176 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

177 ià(
åŒ
 !ğ
NULL
) {

178 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(field_new->ptr), 1);

179 ià(
åŒ
 !ğ
NULL
) {

181 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

182 
	`ASSERT
(
v±r
 !ğ
NULL
);

183 
upd©e
 = 1;

186 
zl
 = 
	`zli¡D–‘e
(zl, &
v±r
);

189 
zl
 = 
	`zli¡In£¹
(zl, 
v±r
, 
v®ue_Ãw
->
±r
, 
	`sd¦’
(value_new->ptr));

193 ià(!
upd©e
) {

195 
zl
 = 
	`zli¡Push
(zl, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(f›ld_Ãw->±r), 
ZIPLIST_TAIL
);

196 
zl
 = 
	`zli¡Push
(zl, 
v®ue_Ãw
->
±r
, 
	`sd¦’
(v®ue_Ãw->±r), 
ZIPLIST_TAIL
);

198 
o
->
±r
 = 
zl
;

199 ià(
f›ld_Ãw
 !ğ
f›ld
è
	`ä“Objeù
(field_new);

200 ià(
v®ue_Ãw
 !ğ
v®ue
è
	`ä“Objeù
(value_new);

203 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

204 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

205 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

206 
f›ld_Ãw
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
f›ld
);

207 
v®ue_Ãw
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
v®ue
);

208 ià(
	`diùR•Ïû
(
o
->
±r
, 
f›ld_Ãw
, 
v®ue_Ãw
)) {

211 
upd©e
 = 1;

212 
	`ä“Objeù
(
f›ld_Ãw
);

215 
	`£rv”Pªic
("Unknown hashƒncoding");

217  
upd©e
;

218 
	}
}

222 
	$hashTy³D–‘e
(
robj
 *
o
,„obj *
f›ld
) {

223 
d–‘ed
 = 0;

225 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

226 *
zl
, *
åŒ
;

227 
robj
 *
f›ld_Ãw
;

229 
f›ld_Ãw
 = 
	`g‘DecodedObjeù
(
f›ld
);

231 
zl
 = 
o
->
±r
;

232 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

233 ià(
åŒ
 !ğ
NULL
) {

234 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(field_new->ptr), 1);

235 ià(
åŒ
 !ğ
NULL
) {

236 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

237 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

238 
o
->
±r
 = 
zl
;

239 
d–‘ed
 = 1;

243 ià(
f›ld_Ãw
 !ğ
f›ld
è
	`ä“Objeù
(field_new);

244 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

245 ià(
	`diùD–‘e
((
diù
*)
o
->
±r
, 
f›ld
è=ğ
VR_OK
) {

246 
d–‘ed
 = 1;

249 ià(
	`htN“dsResize
(
o
->
±r
)è
	`diùResize
(o->ptr);

253 
	`£rv”Pªic
("Unknown hashƒncoding");

256  
d–‘ed
;

257 
	}
}

260 
	$hashTy³L’gth
(
robj
 *
o
) {

261 
Ëngth
 = 
ULONG_MAX
;

263 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

264 
Ëngth
 = 
	`zli¡L’
(
o
->
±r
) / 2;

265 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

266 
Ëngth
 = 
	`diùSize
((
diù
*)
o
->
±r
);

268 
	`£rv”Pªic
("Unknown hashƒncoding");

271  
Ëngth
;

272 
	}
}

274 
hashTy³I‹¿tÜ
 *
	$hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

275 
hashTy³I‹¿tÜ
 *
hi
 = 
	`d®loc
((hashTypeIterator));

276 
hi
->
subjeù
 = subject;

277 
hi
->
’codšg
 = 
subjeù
->encoding;

279 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

280 
hi
->
åŒ
 = 
NULL
;

281 
hi
->
v±r
 = 
NULL
;

282 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

283 
hi
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

285 
	`£rv”Pªic
("Unknown hashƒncoding");

288  
hi
;

289 
	}
}

291 
	$hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
) {

292 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

293 
	`diùR–—£I‹¿tÜ
(
hi
->
di
);

296 
	`dä“
(
hi
);

297 
	}
}

301 
	$hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
) {

302 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

303 *
zl
;

304 *
åŒ
, *
v±r
;

306 
zl
 = 
hi
->
subjeù
->
±r
;

307 
åŒ
 = 
hi
->fptr;

308 
v±r
 = 
hi
->vptr;

310 ià(
åŒ
 =ğ
NULL
) {

312 
	`ASSERT
(
v±r
 =ğ
NULL
);

313 
åŒ
 = 
	`zli¡Index
(
zl
, 0);

316 
	`ASSERT
(
v±r
 !ğ
NULL
);

317 
åŒ
 = 
	`zli¡Next
(
zl
, 
v±r
);

319 ià(
åŒ
 =ğ
NULL
è 
VR_ERROR
;

322 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

323 
	`ASSERT
(
v±r
 !ğ
NULL
);

326 
hi
->
åŒ
 = fptr;

327 
hi
->
v±r
 = vptr;

328 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

329 ià((
hi
->
de
 = 
	`diùNext
(hi->
di
)è=ğ
NULL
è 
VR_ERROR
;

331 
	`£rv”Pªic
("Unknown hashƒncoding");

333  
VR_OK
;

334 
	}
}

338 
	$hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

339 **
v¡r
,

340 *
vËn
,

341 *
vÎ
)

343 
»t
;

345 
	`ASSERT
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

347 ià(
wh©
 & 
OBJ_HASH_KEY
) {

348 
»t
 = 
	`zli¡G‘
(
hi
->
åŒ
, 
v¡r
, 
vËn
, 
vÎ
);

349 
	`ASSERT
(
»t
);

351 
»t
 = 
	`zli¡G‘
(
hi
->
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

352 
	`ASSERT
(
»t
);

354 
	}
}

358 
	$hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, 
robj
 **
d¡
) {

359 
	`ASSERT
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

361 ià(
wh©
 & 
OBJ_HASH_KEY
) {

362 *
d¡
 = 
	`diùG‘Key
(
hi
->
de
);

364 *
d¡
 = 
	`diùG‘V®
(
hi
->
de
);

366 
	}
}

371 
robj
 *
	$hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

372 
robj
 *
d¡
;

374 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

375 *
v¡r
 = 
NULL
;

376 
vËn
 = 
UINT_MAX
;

377 
vÎ
 = 
LLONG_MAX
;

379 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

380 ià(
v¡r
) {

381 
d¡
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
, 
vËn
);

383 
d¡
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

385 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

386 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
, &
d¡
);

388 
	`£rv”Pªic
("Unknown hashƒncoding");

390  
d¡
;

391 
	}
}

393 
robj
 *
	$hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
, 
robj
 *
key
, *
expœed
) {

394 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
,
expœed
);

395 ià(
o
 =ğ
NULL
) {

396 
o
 = 
	`ü—‹HashObjeù
();

397 
	`dbAdd
(
c
->
db
,
key
,
o
);

399 ià(
o
->
ty³
 !ğ
OBJ_HASH
) {

400 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

401  
NULL
;

404  
o
;

405 
	}
}

407 
	$hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
) {

408 
	`ASSERT
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

410 ià(
’c
 =ğ
OBJ_ENCODING_ZIPLIST
) {

413 } ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

414 
hashTy³I‹¿tÜ
 *
hi
;

415 
diù
 *
d
;

416 
»t
;

418 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

419 
d
 = 
	`diùC»©e
(&
hashDiùTy³
, 
NULL
);

421 
	`hashTy³Next
(
hi
è!ğ
VR_ERROR
) {

422 
robj
 *
f›ld
, *
v®ue
;

424 
f›ld
 = 
	`hashTy³Cu¼’tObjeù
(
hi
, 
OBJ_HASH_KEY
);

425 
f›ld
 = 
	`ŒyObjeùEncodšg
(field);

426 
v®ue
 = 
	`hashTy³Cu¼’tObjeù
(
hi
, 
OBJ_HASH_VALUE
);

427 
v®ue
 = 
	`ŒyObjeùEncodšg
(value);

428 
»t
 = 
	`diùAdd
(
d
, 
f›ld
, 
v®ue
);

429 ià(
»t
 !ğ
DICT_OK
) {

432 
	`ASSERT
(
»t
 =ğ
DICT_OK
);

436 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

437 
	`dä“
(
o
->
±r
);

439 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

440 
o
->
±r
 = 
d
;

443 
	`£rv”Pªic
("Unknown hashƒncoding");

445 
	}
}

447 
	$hashTy³CÚv”t
(
robj
 *
o
, 
’c
) {

448 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

449 
	`hashTy³CÚv”tZli¡
(
o
, 
’c
);

450 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

451 
	`£rv”Pªic
("Not implemented");

453 
	`£rv”Pªic
("Unknown hashƒncoding");

455 
	}
}

461 
	$h£tCommªd
(
ş›Á
 *
c
) {

462 
upd©e
;

463 
robj
 *
o
;

464 
expœed
 = 0;

466 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

467 
	`lockDbWr™e
(
c
->
db
);

468 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

469 
	`uÆockDb
(
c
->
db
);

470 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

473 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

474 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2], &c->argv[3]);

475 
upd©e
 = 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],c->argv[3]);

476 
	`addR•ly
(
c
, 
upd©e
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
cÚe
);

477 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

478 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

479 
c
->
v–
->
dœty
++;

480 
	`uÆockDb
(
c
->
db
);

481 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

482 
	}
}

484 
	$h£ŠxCommªd
(
ş›Á
 *
c
) {

485 
robj
 *
o
;

486 
expœed
 = 0;

488 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

489 
	`lockDbWr™e
(
c
->
db
);

490 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

491 
	`uÆockDb
(
c
->
db
);

492 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

495 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

497 ià(
	`hashTy³Exi¡s
(
o
, 
c
->
¬gv
[2])) {

498 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

500 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2], &c->argv[3]);

501 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],c->argv[3]);

502 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

503 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

504 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

505 
£rv”
.
dœty
++;

508 
	`uÆockDb
(
c
->
db
);

509 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

510 
	}
}

512 
	$hm£tCommªd
(
ş›Á
 *
c
) {

513 
i
;

514 
robj
 *
o
;

515 
expœed
 = 0;

517 ià((
c
->
¬gc
 % 2) == 1) {

518 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for HMSET");

522 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

523 
	`lockDbWr™e
(
c
->
db
);

524 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

525 
	`uÆockDb
(
c
->
db
);

526 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

529 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,c->
¬gc
-1);

530 
i
 = 2; i < 
c
->
¬gc
; i += 2) {

531 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[
i
], &c->argv[i+1]);

532 
	`hashTy³S‘
(
o
,
c
->
¬gv
[
i
],c->argv[i+1]);

534 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

535 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

536 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

537 
c
->
v–
->
dœty
++;

539 
	`uÆockDb
(
c
->
db
);

540 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

541 
	}
}

543 
	$hšübyCommªd
(
ş›Á
 *
c
) {

544 
v®ue
, 
šü
, 
Şdv®ue
;

545 
robj
 *
o
, *
cu¼’t
, *
Ãw
;

546 
expœed
 = 0;

548 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
VR_OK
) ;

550 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

551 
	`lockDbWr™e
(
c
->
db
);

552 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
è
’d
;

553 ià((
cu¼’t
 = 
	`hashTy³G‘Objeù
(
o
,
c
->
¬gv
[2])è!ğ
NULL
) {

554 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
cu¼’t
,&
v®ue
,

555 "hash v®ui nÙ‡Àš‹g”"è!ğ
VR_OK
) {

556 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

557 
’d
;

559 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

561 
v®ue
 = 0;

564 
Şdv®ue
 = 
v®ue
;

565 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

566 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

567 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

568 
’d
;

570 
v®ue
 +ğ
šü
;

571 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

572 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2],
NULL
);

573 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],
Ãw
);

574 
	`ä“Objeù
(
Ãw
);

575 
	`addR•lyLÚgLÚg
(
c
,
v®ue
);

576 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

577 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšüby",
c
->
¬gv
[1],c->
db
->
id
);

578 
c
->
v–
->
dœty
++;

580 
’d
:

581 
	`uÆockDb
(
c
->
db
);

582 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

583 
	}
}

585 
	$hšübyæßtCommªd
(
ş›Á
 *
c
) {

586 
v®ue
, 
šü
;

587 
robj
 *
o
, *
cu¼’t
, *
Ãw
, *
aux
;

588 
expœed
 = 0;

590 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
VR_OK
) ;

592 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

593 
	`lockDbWr™e
(
c
->
db
);

594 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

595 
	`uÆockDb
(
c
->
db
);

596 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

599 ià((
cu¼’t
 = 
	`hashTy³G‘Objeù
(
o
,
c
->
¬gv
[2])è!ğ
NULL
) {

600 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
cu¼’t
,&
v®ue
,

601 "hash v®ui nÙ‡ v®id flßt"è!ğ
VR_OK
) {

602 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

603 
	`uÆockDb
(
c
->
db
);

604 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

607 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

609 
v®ue
 = 0;

612 
v®ue
 +ğ
šü
;

613 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

614 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2],
NULL
);

615 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],
Ãw
);

616 
	`addR•lyBulk
(
c
,
Ãw
);

617 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

618 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

619 
c
->
v–
->
dœty
++;

621 
	`uÆockDb
(
c
->
db
);

622 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

627 
aux
 = 
	`ü—‹SŒšgObjeù
("HSET",4);

628 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

629 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,3,
Ãw
);

630 
	}
}

632 
	$addHashF›ldToR•ly
(
ş›Á
 *
c
, 
robj
 *
o
,„obj *
f›ld
) {

633 
»t
;

635 ià(
o
 =ğ
NULL
) {

636 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

640 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

641 *
v¡r
 = 
NULL
;

642 
vËn
 = 
UINT_MAX
;

643 
vÎ
 = 
LLONG_MAX
;

645 
»t
 = 
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
);

646 ià(
»t
 < 0) {

647 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

649 ià(
v¡r
) {

650 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

652 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

656 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

657 
robj
 *
v®ue
;

659 
»t
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
v®ue
);

660 ià(
»t
 < 0) {

661 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

663 
	`addR•lyBulk
(
c
, 
v®ue
);

667 
	`£rv”Pªic
("Unknown hashƒncoding");

669 
	}
}

671 
	$hg‘Commªd
(
ş›Á
 *
c
) {

672 
robj
 *
o
;

674 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

675 
	`lockDbR—d
(
c
->
db
);

676 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

677 
	`uÆockDb
(
c
->
db
);

678 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

680 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

681 
	`uÆockDb
(
c
->
db
);

682 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

686 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[2]);

687 
	`uÆockDb
(
c
->
db
);

688 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

689 
	}
}

691 
	$hmg‘Commªd
(
ş›Á
 *
c
) {

692 
robj
 *
o
;

693 
i
;

695 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

696 
	`lockDbR—d
(
c
->
db
);

699 
o
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

700 ià(
o
 !ğ
NULL
 && o->
ty³
 !ğ
OBJ_HASH
) {

701 
	`uÆockDb
(
c
->
db
);

702 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

703 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

707 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

708 
i
 = 2; i < 
c
->
¬gc
; i++) {

709 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[
i
]);

712 ià(
o
 =ğ
NULL
) {

713 
	`uÆockDb
(
c
->
db
);

714 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

718 
	`uÆockDb
(
c
->
db
);

719 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

720 
	}
}

722 
	$hd–Commªd
(
ş›Á
 *
c
) {

723 
robj
 *
o
;

724 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

725 
expœed
 = 0;

727 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

728 
	`lockDbWr™e
(
c
->
db
);

729 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

730 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

731 
	`uÆockDb
(
c
->
db
);

732 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

736 
j
 = 2; j < 
c
->
¬gc
; j++) {

737 ià(
	`hashTy³D–‘e
(
o
,
c
->
¬gv
[
j
])) {

738 
d–‘ed
++;

739 ià(
	`hashTy³L’gth
(
o
) == 0) {

740 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

741 
key»moved
 = 1;

747 
	`uÆockDb
(
c
->
db
);

748 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

750 ià(
d–‘ed
) {

751 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

752 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hd–",
c
->
¬gv
[1],c->
db
->
id
);

753 ià(
key»moved
)

754 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

755 
c
->
db
->
id
);

756 
£rv”
.
dœty
 +ğ
d–‘ed
;

758 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

759 
	}
}

761 
	$hËnCommªd
(
ş›Á
 *
c
) {

762 
robj
 *
o
;

764 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

765 
	`lockDbR—d
(
c
->
db
);

766 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

767 
	`uÆockDb
(
c
->
db
);

768 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

770 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

771 
	`uÆockDb
(
c
->
db
);

772 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

776 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³L’gth
(
o
));

777 
	`uÆockDb
(
c
->
db
);

778 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

779 
	}
}

781 
	$h¡¾’Commªd
(
ş›Á
 *
c
) {

782 
robj
 *
o
;

784 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

785 
	`lockDbR—d
(
c
->
db
);

786 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

787 
	`uÆockDb
(
c
->
db
);

788 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

790 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

791 
	`uÆockDb
(
c
->
db
);

792 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

796 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³G‘V®ueL’gth
(
o
,c->
¬gv
[2]));

798 
	`uÆockDb
(
c
->
db
);

799 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

800 
	}
}

802 
	$addHashI‹¿tÜCursÜToR•ly
(
ş›Á
 *
c
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

803 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

804 *
v¡r
 = 
NULL
;

805 
vËn
 = 
UINT_MAX
;

806 
vÎ
 = 
LLONG_MAX
;

808 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

809 ià(
v¡r
) {

810 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

812 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

815 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

816 
robj
 *
v®ue
;

818 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
, &
v®ue
);

819 
	`addR•lyBulk
(
c
, 
v®ue
);

822 
	`£rv”Pªic
("Unknown hashƒncoding");

824 
	}
}

826 
	$g’”icHg‘®lCommªd
(
ş›Á
 *
c
, 
æags
) {

827 
robj
 *
o
;

828 
hashTy³I‹¿tÜ
 *
hi
;

829 
muÉl›r
 = 0;

830 
Ëngth
, 
couÁ
 = 0;

832 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

833 
	`lockDbR—d
(
c
->
db
);

834 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

835 
	`uÆockDb
(
c
->
db
);

836 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

838 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

839 
	`uÆockDb
(
c
->
db
);

840 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

843 ià(
æags
 & 
OBJ_HASH_KEY
è
muÉl›r
++;

844 ià(
æags
 & 
OBJ_HASH_VALUE
è
muÉl›r
++;

846 
Ëngth
 = 
	`hashTy³L’gth
(
o
è* 
muÉl›r
;

847 
	`addR•lyMuÉiBulkL’
(
c
, 
Ëngth
);

849 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

850 
	`hashTy³Next
(
hi
è!ğ
VR_ERROR
) {

851 ià(
æags
 & 
OBJ_HASH_KEY
) {

852 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_KEY
);

853 
couÁ
++;

855 ià(
æags
 & 
OBJ_HASH_VALUE
) {

856 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_VALUE
);

857 
couÁ
++;

861 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

862 
	`ASSERT
(
couÁ
 =ğ
Ëngth
);

864 
	`uÆockDb
(
c
->
db
);

865 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

866 
	}
}

868 
	$hkeysCommªd
(
ş›Á
 *
c
) {

869 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
);

870 
	}
}

872 
	$hv®sCommªd
(
ş›Á
 *
c
) {

873 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_VALUE
);

874 
	}
}

876 
	$hg‘®lCommªd
(
ş›Á
 *
c
) {

877 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
|
OBJ_HASH_VALUE
);

878 
	}
}

880 
	$hexi¡sCommªd
(
ş›Á
 *
c
) {

881 
robj
 *
o
;

883 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

884 
	`lockDbR—d
(
c
->
db
);

885 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

886 
	`uÆockDb
(
c
->
db
);

887 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

889 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

890 
	`uÆockDb
(
c
->
db
);

891 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

895 
	`addR•ly
(
c
, 
	`hashTy³Exi¡s
(
o
,c->
¬gv
[2]è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

896 
	`uÆockDb
(
c
->
db
);

897 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

898 
	}
}

900 
	$hsÿnCommªd
(
ş›Á
 *
c
) {

901 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_HASH
);

902 
	}
}

	@src/vr_t_hash.c

1 
	~<m©h.h
>

3 
	~<vr_cÜe.h
>

12 
	$hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
) {

13 
i
;

15 ià(
o
->
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
) ;

17 
i
 = 
¡¬t
; i <ğ
’d
; i++) {

18 ià(
	`sdsEncodedObjeù
(
¬gv
[
i
]) &&

19 
	`sd¦’
(
¬gv
[
i
]->
±r
è> 
£rv”
.
hash_max_zli¡_v®ue
)

21 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

25 
	}
}

28 
	$hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
) {

29 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

30 ià(
o1
è*o1 = 
	`ŒyObjeùEncodšg
(*o1);

31 ià(
o2
è*o2 = 
	`ŒyObjeùEncodšg
(*o2);

33 
	}
}

37 
	$hashTy³G‘FromZli¡
(
robj
 *
o
,„obj *
f›ld
,

38 **
v¡r
,

39 *
vËn
,

40 *
vÎ
)

42 *
zl
, *
åŒ
 = 
NULL
, *
v±r
 = NULL;

43 
»t
;

44 
robj
 *
f›ld_Ãw
;

46 
	`ASSERT
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

48 
f›ld_Ãw
 = 
	`g‘DecodedObjeù
(
f›ld
);

50 
zl
 = 
o
->
±r
;

51 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

52 ià(
åŒ
 !ğ
NULL
) {

53 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(field_new->ptr), 1);

54 ià(
åŒ
 !ğ
NULL
) {

56 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

57 
	`ASSERT
(
v±r
 !ğ
NULL
);

61 ià(
f›ld_Ãw
 !ğ
f›ld
è
	`ä“Objeù
(field_new);

63 ià(
v±r
 !ğ
NULL
) {

64 
»t
 = 
	`zli¡G‘
(
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

65 
	`ASSERT
(
»t
);

70 
	}
}

74 
	$hashTy³G‘FromHashTabË
(
robj
 *
o
,„obj *
f›ld
,„obj **
v®ue
) {

75 
diùEÁry
 *
de
;

77 
	`ASSERT
(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

79 
de
 = 
	`diùFšd
(
o
->
±r
, 
f›ld
);

80 ià(
de
 =ğ
NULL
)  -1;

81 *
v®ue
 = 
	`diùG‘V®
(
de
);

83 
	}
}

91 
robj
 *
	$hashTy³G‘Objeù
(
robj
 *
o
,„obj *
f›ld
) {

92 
robj
 *
v®ue
 = 
NULL
;

94 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

95 *
v¡r
 = 
NULL
;

96 
vËn
 = 
UINT_MAX
;

97 
vÎ
 = 
LLONG_MAX
;

99 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0) {

100 ià(
v¡r
) {

101 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
, 
vËn
);

103 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

106 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

107 
robj
 *
aux
;

109 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0) {

110 
v®ue
 = 
aux
;

113 
	`£rv”Pªic
("Unknown hashƒncoding");

115  
v®ue
;

116 
	}
}

121 
size_t
 
	$hashTy³G‘V®ueL’gth
(
robj
 *
o
,„obj *
f›ld
) {

122 
size_t
 
Ën
 = 0;

123 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

124 *
v¡r
 = 
NULL
;

125 
vËn
 = 
UINT_MAX
;

126 
vÎ
 = 
LLONG_MAX
;

128 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)

129 
Ën
 = 
v¡r
 ? 
vËn
 : 
	`sdig™s10
(
vÎ
);

130 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

131 
robj
 *
aux
;

133 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0)

134 
Ën
 = 
	`¡ršgObjeùL’
(
aux
);

136 
	`£rv”Pªic
("Unknown hashƒncoding");

138  
Ën
;

139 
	}
}

143 
	$hashTy³Exi¡s
(
robj
 *
o
,„obj *
f›ld
) {

144 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

145 *
v¡r
 = 
NULL
;

146 
vËn
 = 
UINT_MAX
;

147 
vÎ
 = 
LLONG_MAX
;

149 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)  1;

150 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

151 
robj
 *
aux
;

153 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0)  1;

155 
	`£rv”Pªic
("Unknown hashƒncoding");

158 
	}
}

165 
	$hashTy³S‘
(
robj
 *
o
,„obj *
f›ld
,„obj *
v®ue
) {

166 
upd©e
 = 0;

167 
robj
 *
f›ld_Ãw
, *
v®ue_Ãw
;

169 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

170 *
zl
, *
åŒ
, *
v±r
;

172 
f›ld_Ãw
 = 
	`g‘DecodedObjeù
(
f›ld
);

173 
v®ue_Ãw
 = 
	`g‘DecodedObjeù
(
v®ue
);

175 
zl
 = 
o
->
±r
;

176 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

177 ià(
åŒ
 !ğ
NULL
) {

178 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(field_new->ptr), 1);

179 ià(
åŒ
 !ğ
NULL
) {

181 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

182 
	`ASSERT
(
v±r
 !ğ
NULL
);

183 
upd©e
 = 1;

186 
zl
 = 
	`zli¡D–‘e
(zl, &
v±r
);

189 
zl
 = 
	`zli¡In£¹
(zl, 
v±r
, 
v®ue_Ãw
->
±r
, 
	`sd¦’
(value_new->ptr));

193 ià(!
upd©e
) {

195 
zl
 = 
	`zli¡Push
(zl, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(f›ld_Ãw->±r), 
ZIPLIST_TAIL
);

196 
zl
 = 
	`zli¡Push
(zl, 
v®ue_Ãw
->
±r
, 
	`sd¦’
(v®ue_Ãw->±r), 
ZIPLIST_TAIL
);

198 
o
->
±r
 = 
zl
;

199 ià(
f›ld_Ãw
 !ğ
f›ld
è
	`ä“Objeù
(field_new);

200 ià(
v®ue_Ãw
 !ğ
v®ue
è
	`ä“Objeù
(value_new);

203 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

204 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

205 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

206 
f›ld_Ãw
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
f›ld
);

207 
v®ue_Ãw
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
v®ue
);

208 ià(
	`diùR•Ïû
(
o
->
±r
, 
f›ld_Ãw
, 
v®ue_Ãw
)) {

211 
upd©e
 = 1;

212 
	`ä“Objeù
(
f›ld_Ãw
);

215 
	`£rv”Pªic
("Unknown hashƒncoding");

217  
upd©e
;

218 
	}
}

222 
	$hashTy³D–‘e
(
robj
 *
o
,„obj *
f›ld
) {

223 
d–‘ed
 = 0;

225 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

226 *
zl
, *
åŒ
;

227 
robj
 *
f›ld_Ãw
;

229 
f›ld_Ãw
 = 
	`g‘DecodedObjeù
(
f›ld
);

231 
zl
 = 
o
->
±r
;

232 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

233 ià(
åŒ
 !ğ
NULL
) {

234 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld_Ãw
->
±r
, 
	`sd¦’
(field_new->ptr), 1);

235 ià(
åŒ
 !ğ
NULL
) {

236 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

237 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

238 
o
->
±r
 = 
zl
;

239 
d–‘ed
 = 1;

243 ià(
f›ld_Ãw
 !ğ
f›ld
è
	`ä“Objeù
(field_new);

244 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

245 ià(
	`diùD–‘e
((
diù
*)
o
->
±r
, 
f›ld
è=ğ
VR_OK
) {

246 
d–‘ed
 = 1;

249 ià(
	`htN“dsResize
(
o
->
±r
)è
	`diùResize
(o->ptr);

253 
	`£rv”Pªic
("Unknown hashƒncoding");

256  
d–‘ed
;

257 
	}
}

260 
	$hashTy³L’gth
(
robj
 *
o
) {

261 
Ëngth
 = 
ULONG_MAX
;

263 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

264 
Ëngth
 = 
	`zli¡L’
(
o
->
±r
) / 2;

265 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

266 
Ëngth
 = 
	`diùSize
((
diù
*)
o
->
±r
);

268 
	`£rv”Pªic
("Unknown hashƒncoding");

271  
Ëngth
;

272 
	}
}

274 
hashTy³I‹¿tÜ
 *
	$hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

275 
hashTy³I‹¿tÜ
 *
hi
 = 
	`d®loc
((hashTypeIterator));

276 
hi
->
subjeù
 = subject;

277 
hi
->
’codšg
 = 
subjeù
->encoding;

279 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

280 
hi
->
åŒ
 = 
NULL
;

281 
hi
->
v±r
 = 
NULL
;

282 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

283 
hi
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

285 
	`£rv”Pªic
("Unknown hashƒncoding");

288  
hi
;

289 
	}
}

291 
	$hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
) {

292 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

293 
	`diùR–—£I‹¿tÜ
(
hi
->
di
);

296 
	`dä“
(
hi
);

297 
	}
}

301 
	$hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
) {

302 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

303 *
zl
;

304 *
åŒ
, *
v±r
;

306 
zl
 = 
hi
->
subjeù
->
±r
;

307 
åŒ
 = 
hi
->fptr;

308 
v±r
 = 
hi
->vptr;

310 ià(
åŒ
 =ğ
NULL
) {

312 
	`ASSERT
(
v±r
 =ğ
NULL
);

313 
åŒ
 = 
	`zli¡Index
(
zl
, 0);

316 
	`ASSERT
(
v±r
 !ğ
NULL
);

317 
åŒ
 = 
	`zli¡Next
(
zl
, 
v±r
);

319 ià(
åŒ
 =ğ
NULL
è 
VR_ERROR
;

322 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

323 
	`ASSERT
(
v±r
 !ğ
NULL
);

326 
hi
->
åŒ
 = fptr;

327 
hi
->
v±r
 = vptr;

328 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

329 ià((
hi
->
de
 = 
	`diùNext
(hi->
di
)è=ğ
NULL
è 
VR_ERROR
;

331 
	`£rv”Pªic
("Unknown hashƒncoding");

333  
VR_OK
;

334 
	}
}

338 
	$hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

339 **
v¡r
,

340 *
vËn
,

341 *
vÎ
)

343 
»t
;

345 
	`ASSERT
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

347 ià(
wh©
 & 
OBJ_HASH_KEY
) {

348 
»t
 = 
	`zli¡G‘
(
hi
->
åŒ
, 
v¡r
, 
vËn
, 
vÎ
);

349 
	`ASSERT
(
»t
);

351 
»t
 = 
	`zli¡G‘
(
hi
->
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

352 
	`ASSERT
(
»t
);

354 
	}
}

358 
	$hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, 
robj
 **
d¡
) {

359 
	`ASSERT
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

361 ià(
wh©
 & 
OBJ_HASH_KEY
) {

362 *
d¡
 = 
	`diùG‘Key
(
hi
->
de
);

364 *
d¡
 = 
	`diùG‘V®
(
hi
->
de
);

366 
	}
}

371 
robj
 *
	$hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

372 
robj
 *
d¡
;

374 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

375 *
v¡r
 = 
NULL
;

376 
vËn
 = 
UINT_MAX
;

377 
vÎ
 = 
LLONG_MAX
;

379 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

380 ià(
v¡r
) {

381 
d¡
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
, 
vËn
);

383 
d¡
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

385 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

386 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
, &
d¡
);

388 
	`£rv”Pªic
("Unknown hashƒncoding");

390  
d¡
;

391 
	}
}

393 
robj
 *
	$hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
, 
robj
 *
key
, *
expœed
) {

394 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
,
expœed
);

395 ià(
o
 =ğ
NULL
) {

396 
o
 = 
	`ü—‹HashObjeù
();

397 
	`dbAdd
(
c
->
db
,
key
,
o
);

399 ià(
o
->
ty³
 !ğ
OBJ_HASH
) {

400 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

401  
NULL
;

404  
o
;

405 
	}
}

407 
	$hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
) {

408 
	`ASSERT
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

410 ià(
’c
 =ğ
OBJ_ENCODING_ZIPLIST
) {

413 } ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

414 
hashTy³I‹¿tÜ
 *
hi
;

415 
diù
 *
d
;

416 
»t
;

418 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

419 
d
 = 
	`diùC»©e
(&
hashDiùTy³
, 
NULL
);

421 
	`hashTy³Next
(
hi
è!ğ
VR_ERROR
) {

422 
robj
 *
f›ld
, *
v®ue
;

424 
f›ld
 = 
	`hashTy³Cu¼’tObjeù
(
hi
, 
OBJ_HASH_KEY
);

425 
f›ld
 = 
	`ŒyObjeùEncodšg
(field);

426 
v®ue
 = 
	`hashTy³Cu¼’tObjeù
(
hi
, 
OBJ_HASH_VALUE
);

427 
v®ue
 = 
	`ŒyObjeùEncodšg
(value);

428 
»t
 = 
	`diùAdd
(
d
, 
f›ld
, 
v®ue
);

429 ià(
»t
 !ğ
DICT_OK
) {

432 
	`ASSERT
(
»t
 =ğ
DICT_OK
);

436 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

437 
	`dä“
(
o
->
±r
);

439 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

440 
o
->
±r
 = 
d
;

443 
	`£rv”Pªic
("Unknown hashƒncoding");

445 
	}
}

447 
	$hashTy³CÚv”t
(
robj
 *
o
, 
’c
) {

448 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

449 
	`hashTy³CÚv”tZli¡
(
o
, 
’c
);

450 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

451 
	`£rv”Pªic
("Not implemented");

453 
	`£rv”Pªic
("Unknown hashƒncoding");

455 
	}
}

461 
	$h£tCommªd
(
ş›Á
 *
c
) {

462 
upd©e
;

463 
robj
 *
o
;

464 
expœed
 = 0;

466 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

467 
	`lockDbWr™e
(
c
->
db
);

468 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

469 
	`uÆockDb
(
c
->
db
);

470 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

473 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

474 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2], &c->argv[3]);

475 
upd©e
 = 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],c->argv[3]);

476 
	`addR•ly
(
c
, 
upd©e
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
cÚe
);

477 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

478 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

479 
c
->
v–
->
dœty
++;

480 
	`uÆockDb
(
c
->
db
);

481 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

482 
	}
}

484 
	$h£ŠxCommªd
(
ş›Á
 *
c
) {

485 
robj
 *
o
;

486 
expœed
 = 0;

488 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

489 
	`lockDbWr™e
(
c
->
db
);

490 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

491 
	`uÆockDb
(
c
->
db
);

492 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

495 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

497 ià(
	`hashTy³Exi¡s
(
o
, 
c
->
¬gv
[2])) {

498 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

500 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2], &c->argv[3]);

501 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],c->argv[3]);

502 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

503 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

504 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

505 
£rv”
.
dœty
++;

508 
	`uÆockDb
(
c
->
db
);

509 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

510 
	}
}

512 
	$hm£tCommªd
(
ş›Á
 *
c
) {

513 
i
;

514 
robj
 *
o
;

515 
expœed
 = 0;

517 ià((
c
->
¬gc
 % 2) == 1) {

518 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for HMSET");

522 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

523 
	`lockDbWr™e
(
c
->
db
);

524 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

525 
	`uÆockDb
(
c
->
db
);

526 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

529 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,c->
¬gc
-1);

530 
i
 = 2; i < 
c
->
¬gc
; i += 2) {

531 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[
i
], &c->argv[i+1]);

532 
	`hashTy³S‘
(
o
,
c
->
¬gv
[
i
],c->argv[i+1]);

534 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

535 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

536 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

537 
c
->
v–
->
dœty
++;

539 
	`uÆockDb
(
c
->
db
);

540 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

541 
	}
}

543 
	$hšübyCommªd
(
ş›Á
 *
c
) {

544 
v®ue
, 
šü
, 
Şdv®ue
;

545 
robj
 *
o
, *
cu¼’t
, *
Ãw
;

546 
expœed
 = 0;

548 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
VR_OK
) ;

550 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

551 
	`lockDbWr™e
(
c
->
db
);

552 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
è
’d
;

553 ià((
cu¼’t
 = 
	`hashTy³G‘Objeù
(
o
,
c
->
¬gv
[2])è!ğ
NULL
) {

554 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
cu¼’t
,&
v®ue
,

555 "hash v®ui nÙ‡Àš‹g”"è!ğ
VR_OK
) {

556 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

557 
’d
;

559 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

561 
v®ue
 = 0;

564 
Şdv®ue
 = 
v®ue
;

565 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

566 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

567 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

568 
’d
;

570 
v®ue
 +ğ
šü
;

571 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

572 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2],
NULL
);

573 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],
Ãw
);

574 
	`ä“Objeù
(
Ãw
);

575 
	`addR•lyLÚgLÚg
(
c
,
v®ue
);

576 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

577 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšüby",
c
->
¬gv
[1],c->
db
->
id
);

578 
c
->
v–
->
dœty
++;

580 
’d
:

581 
	`uÆockDb
(
c
->
db
);

582 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

583 
	}
}

585 
	$hšübyæßtCommªd
(
ş›Á
 *
c
) {

586 
v®ue
, 
šü
;

587 
robj
 *
o
, *
cu¼’t
, *
Ãw
, *
aux
;

588 
expœed
 = 0;

590 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
VR_OK
) ;

592 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

593 
	`lockDbWr™e
(
c
->
db
);

594 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1],&
expœed
)è=ğ
NULL
) {

595 
	`uÆockDb
(
c
->
db
);

596 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

599 ià((
cu¼’t
 = 
	`hashTy³G‘Objeù
(
o
,
c
->
¬gv
[2])è!ğ
NULL
) {

600 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
cu¼’t
,&
v®ue
,

601 "hash v®ui nÙ‡ v®id flßt"è!ğ
VR_OK
) {

602 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

603 
	`uÆockDb
(
c
->
db
);

604 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

607 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
è
	`ä“Objeù
(
cu¼’t
);

609 
v®ue
 = 0;

612 
v®ue
 +ğ
šü
;

613 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

614 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2],
NULL
);

615 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],
Ãw
);

616 
	`addR•lyBulk
(
c
,
Ãw
);

617 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

618 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

619 
c
->
v–
->
dœty
++;

621 
	`uÆockDb
(
c
->
db
);

622 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

627 
aux
 = 
	`ü—‹SŒšgObjeù
("HSET",4);

628 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

629 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,3,
Ãw
);

630 
	}
}

632 
	$addHashF›ldToR•ly
(
ş›Á
 *
c
, 
robj
 *
o
,„obj *
f›ld
) {

633 
»t
;

635 ià(
o
 =ğ
NULL
) {

636 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

640 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

641 *
v¡r
 = 
NULL
;

642 
vËn
 = 
UINT_MAX
;

643 
vÎ
 = 
LLONG_MAX
;

645 
»t
 = 
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
);

646 ià(
»t
 < 0) {

647 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

649 ià(
v¡r
) {

650 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

652 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

656 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

657 
robj
 *
v®ue
;

659 
»t
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
v®ue
);

660 ià(
»t
 < 0) {

661 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

663 
	`addR•lyBulk
(
c
, 
v®ue
);

667 
	`£rv”Pªic
("Unknown hashƒncoding");

669 
	}
}

671 
	$hg‘Commªd
(
ş›Á
 *
c
) {

672 
robj
 *
o
;

674 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

675 
	`lockDbR—d
(
c
->
db
);

676 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

677 
	`uÆockDb
(
c
->
db
);

678 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

680 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

681 
	`uÆockDb
(
c
->
db
);

682 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

686 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[2]);

687 
	`uÆockDb
(
c
->
db
);

688 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

689 
	}
}

691 
	$hmg‘Commªd
(
ş›Á
 *
c
) {

692 
robj
 *
o
;

693 
i
;

695 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

696 
	`lockDbR—d
(
c
->
db
);

699 
o
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

700 ià(
o
 !ğ
NULL
 && o->
ty³
 !ğ
OBJ_HASH
) {

701 
	`uÆockDb
(
c
->
db
);

702 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

703 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

707 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

708 
i
 = 2; i < 
c
->
¬gc
; i++) {

709 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[
i
]);

712 ià(
o
 =ğ
NULL
) {

713 
	`uÆockDb
(
c
->
db
);

714 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

718 
	`uÆockDb
(
c
->
db
);

719 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

720 
	}
}

722 
	$hd–Commªd
(
ş›Á
 *
c
) {

723 
robj
 *
o
;

724 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

725 
expœed
 = 0;

727 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

728 
	`lockDbWr™e
(
c
->
db
);

729 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

730 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

731 
	`uÆockDb
(
c
->
db
);

732 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

736 
j
 = 2; j < 
c
->
¬gc
; j++) {

737 ià(
	`hashTy³D–‘e
(
o
,
c
->
¬gv
[
j
])) {

738 
d–‘ed
++;

739 ià(
	`hashTy³L’gth
(
o
) == 0) {

740 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

741 
key»moved
 = 1;

747 
	`uÆockDb
(
c
->
db
);

748 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

750 ià(
d–‘ed
) {

751 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

752 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hd–",
c
->
¬gv
[1],c->
db
->
id
);

753 ià(
key»moved
)

754 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

755 
c
->
db
->
id
);

756 
£rv”
.
dœty
 +ğ
d–‘ed
;

758 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

759 
	}
}

761 
	$hËnCommªd
(
ş›Á
 *
c
) {

762 
robj
 *
o
;

764 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

765 
	`lockDbR—d
(
c
->
db
);

766 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

767 
	`uÆockDb
(
c
->
db
);

768 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

770 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

771 
	`uÆockDb
(
c
->
db
);

772 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

776 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³L’gth
(
o
));

777 
	`uÆockDb
(
c
->
db
);

778 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

779 
	}
}

781 
	$h¡¾’Commªd
(
ş›Á
 *
c
) {

782 
robj
 *
o
;

784 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

785 
	`lockDbR—d
(
c
->
db
);

786 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

787 
	`uÆockDb
(
c
->
db
);

788 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

790 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

791 
	`uÆockDb
(
c
->
db
);

792 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

796 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³G‘V®ueL’gth
(
o
,c->
¬gv
[2]));

798 
	`uÆockDb
(
c
->
db
);

799 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

800 
	}
}

802 
	$addHashI‹¿tÜCursÜToR•ly
(
ş›Á
 *
c
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

803 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

804 *
v¡r
 = 
NULL
;

805 
vËn
 = 
UINT_MAX
;

806 
vÎ
 = 
LLONG_MAX
;

808 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

809 ià(
v¡r
) {

810 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

812 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

815 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

816 
robj
 *
v®ue
;

818 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
, &
v®ue
);

819 
	`addR•lyBulk
(
c
, 
v®ue
);

822 
	`£rv”Pªic
("Unknown hashƒncoding");

824 
	}
}

826 
	$g’”icHg‘®lCommªd
(
ş›Á
 *
c
, 
æags
) {

827 
robj
 *
o
;

828 
hashTy³I‹¿tÜ
 *
hi
;

829 
muÉl›r
 = 0;

830 
Ëngth
, 
couÁ
 = 0;

832 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

833 
	`lockDbR—d
(
c
->
db
);

834 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

835 
	`uÆockDb
(
c
->
db
);

836 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

838 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

839 
	`uÆockDb
(
c
->
db
);

840 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

843 ià(
æags
 & 
OBJ_HASH_KEY
è
muÉl›r
++;

844 ià(
æags
 & 
OBJ_HASH_VALUE
è
muÉl›r
++;

846 
Ëngth
 = 
	`hashTy³L’gth
(
o
è* 
muÉl›r
;

847 
	`addR•lyMuÉiBulkL’
(
c
, 
Ëngth
);

849 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

850 
	`hashTy³Next
(
hi
è!ğ
VR_ERROR
) {

851 ià(
æags
 & 
OBJ_HASH_KEY
) {

852 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_KEY
);

853 
couÁ
++;

855 ià(
æags
 & 
OBJ_HASH_VALUE
) {

856 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_VALUE
);

857 
couÁ
++;

861 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

862 
	`ASSERT
(
couÁ
 =ğ
Ëngth
);

864 
	`uÆockDb
(
c
->
db
);

865 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

866 
	}
}

868 
	$hkeysCommªd
(
ş›Á
 *
c
) {

869 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
);

870 
	}
}

872 
	$hv®sCommªd
(
ş›Á
 *
c
) {

873 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_VALUE
);

874 
	}
}

876 
	$hg‘®lCommªd
(
ş›Á
 *
c
) {

877 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
|
OBJ_HASH_VALUE
);

878 
	}
}

880 
	$hexi¡sCommªd
(
ş›Á
 *
c
) {

881 
robj
 *
o
;

883 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

884 
	`lockDbR—d
(
c
->
db
);

885 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

886 
	`uÆockDb
(
c
->
db
);

887 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

889 } ià(
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) {

890 
	`uÆockDb
(
c
->
db
);

891 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

895 
	`addR•ly
(
c
, 
	`hashTy³Exi¡s
(
o
,c->
¬gv
[2]è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

896 
	`uÆockDb
(
c
->
db
);

897 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

898 
	}
}

900 
	$hsÿnCommªd
(
ş›Á
 *
c
) {

901 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_HASH
);

902 
	}
}

	@src/vr_t_hash.h

1 #iâdeà
_VR_T_HASH_H_


2 
	#_VR_T_HASH_H_


	)

4 
hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
);

5 
hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
);

6 
hashTy³G‘FromZli¡
(
robj
 *
o
,„obj *
f›ld
, **
v¡r
, *
vËn
, *
vÎ
);

7 
hashTy³G‘FromHashTabË
(
robj
 *
o
,„obj *
f›ld
,„obj **
v®ue
);

8 
robj
 *
hashTy³G‘Objeù
Ôobj *
o
,„obj *
f›ld
);

9 
size_t
 
hashTy³G‘V®ueL’gth
(
robj
 *
o
,„obj *
f›ld
);

10 
hashTy³Exi¡s
(
robj
 *
o
,„obj *
f›ld
);

11 
hashTy³S‘
(
robj
 *
o
,„obj *
f›ld
,„obj *
v®ue
);

12 
hashTy³D–‘e
(
robj
 *
o
,„obj *
f›ld
);

13 
hashTy³L’gth
(
robj
 *
o
);

14 
hashTy³I‹¿tÜ
 *
hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

15 
hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
);

16 
hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
);

17 
hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, **
v¡r
, *
vËn
, *
vÎ
);

18 
hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, 
robj
 **
d¡
);

19 
robj
 *
hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

20 
robj
 *
hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
,„obj *
key
, *
expœed
);

21 
hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
);

22 
hashTy³CÚv”t
(
robj
 *
o
, 
’c
);

23 
h£tCommªd
(
ş›Á
 *
c
);

24 
h£ŠxCommªd
(
ş›Á
 *
c
);

25 
hm£tCommªd
(
ş›Á
 *
c
);

26 
hšübyCommªd
(
ş›Á
 *
c
);

27 
hšübyæßtCommªd
(
ş›Á
 *
c
);

28 
hg‘Commªd
(
ş›Á
 *
c
);

29 
hmg‘Commªd
(
ş›Á
 *
c
);

30 
hd–Commªd
(
ş›Á
 *
c
);

31 
hËnCommªd
(
ş›Á
 *
c
);

32 
h¡¾’Commªd
(
ş›Á
 *
c
);

33 
g’”icHg‘®lCommªd
(
ş›Á
 *
c
, 
æags
);

34 
hkeysCommªd
(
ş›Á
 *
c
);

35 
hv®sCommªd
(
ş›Á
 *
c
);

36 
hg‘®lCommªd
(
ş›Á
 *
c
);

37 
hexi¡sCommªd
(
ş›Á
 *
c
);

38 
hsÿnCommªd
(
ş›Á
 *
c
);

	@src/vr_t_hash.h

1 #iâdeà
_VR_T_HASH_H_


2 
	#_VR_T_HASH_H_


	)

4 
hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
);

5 
hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
);

6 
hashTy³G‘FromZli¡
(
robj
 *
o
,„obj *
f›ld
, **
v¡r
, *
vËn
, *
vÎ
);

7 
hashTy³G‘FromHashTabË
(
robj
 *
o
,„obj *
f›ld
,„obj **
v®ue
);

8 
robj
 *
hashTy³G‘Objeù
Ôobj *
o
,„obj *
f›ld
);

9 
size_t
 
hashTy³G‘V®ueL’gth
(
robj
 *
o
,„obj *
f›ld
);

10 
hashTy³Exi¡s
(
robj
 *
o
,„obj *
f›ld
);

11 
hashTy³S‘
(
robj
 *
o
,„obj *
f›ld
,„obj *
v®ue
);

12 
hashTy³D–‘e
(
robj
 *
o
,„obj *
f›ld
);

13 
hashTy³L’gth
(
robj
 *
o
);

14 
hashTy³I‹¿tÜ
 *
hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

15 
hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
);

16 
hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
);

17 
hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, **
v¡r
, *
vËn
, *
vÎ
);

18 
hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, 
robj
 **
d¡
);

19 
robj
 *
hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

20 
robj
 *
hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
,„obj *
key
, *
expœed
);

21 
hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
);

22 
hashTy³CÚv”t
(
robj
 *
o
, 
’c
);

23 
h£tCommªd
(
ş›Á
 *
c
);

24 
h£ŠxCommªd
(
ş›Á
 *
c
);

25 
hm£tCommªd
(
ş›Á
 *
c
);

26 
hšübyCommªd
(
ş›Á
 *
c
);

27 
hšübyæßtCommªd
(
ş›Á
 *
c
);

28 
hg‘Commªd
(
ş›Á
 *
c
);

29 
hmg‘Commªd
(
ş›Á
 *
c
);

30 
hd–Commªd
(
ş›Á
 *
c
);

31 
hËnCommªd
(
ş›Á
 *
c
);

32 
h¡¾’Commªd
(
ş›Á
 *
c
);

33 
g’”icHg‘®lCommªd
(
ş›Á
 *
c
, 
æags
);

34 
hkeysCommªd
(
ş›Á
 *
c
);

35 
hv®sCommªd
(
ş›Á
 *
c
);

36 
hg‘®lCommªd
(
ş›Á
 *
c
);

37 
hexi¡sCommªd
(
ş›Á
 *
c
);

38 
hsÿnCommªd
(
ş›Á
 *
c
);

	@src/vr_t_list.c

1 
	~<vr_cÜe.h
>

12 
	$li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
) {

13 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

14 
robj
 *
v®ue_Ãw
;

15 
pos
 = (
wh”e
 =ğ
LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

16 
v®ue_Ãw
 = 
	`g‘DecodedObjeù
(
v®ue
);

17 
size_t
 
Ën
 = 
	`sd¦’
(
v®ue_Ãw
->
±r
);

18 
	`quickli¡Push
(
subjeù
->
±r
, 
v®ue_Ãw
->±r, 
Ën
, 
pos
);

19 ià(
v®ue_Ãw
 !ğ
v®ue
è
	`ä“Objeù
(value_new);

21 
	`£rv”Pªic
("Unknown†istƒncoding");

23 
	}
}

25 *
	$li¡PİSav”
(*
d©a
, 
sz
) {

26  
	`ü—‹SŒšgObjeù
((*)
d©a
,
sz
);

27 
	}
}

29 
robj
 *
	$li¡Ty³Pİ
(
robj
 *
subjeù
, 
wh”e
) {

30 
vlÚg
;

31 
robj
 *
v®ue
 = 
NULL
;

33 
ql_wh”e
 = 
wh”e
 =ğ
LIST_HEAD
 ? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

34 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

35 ià(
	`quickli¡PİCu¡om
(
subjeù
->
±r
, 
ql_wh”e
, (**)&
v®ue
,

36 
NULL
, &
vlÚg
, 
li¡PİSav”
)) {

37 ià(!
v®ue
)

38 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

41 
	`£rv”Pªic
("Unknown†istƒncoding");

43  
v®ue
;

44 
	}
}

46 
	$li¡Ty³L’gth
(
robj
 *
subjeù
) {

47 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

48  
	`quickli¡CouÁ
(
subjeù
->
±r
);

50 
	`£rv”Pªic
("Unknown†istƒncoding");

52 
	}
}

55 
li¡Ty³I‹¿tÜ
 *
	$li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
,

56 
dœeùiÚ
) {

57 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`d®loc
((listTypeIterator));

58 
li
->
subjeù
 = subject;

59 
li
->
’codšg
 = 
subjeù
->encoding;

60 
li
->
dœeùiÚ
 = direction;

61 
li
->
™”
 = 
NULL
;

64 
™”_dœeùiÚ
 =

65 
dœeùiÚ
 =ğ
LIST_HEAD
 ? 
AL_START_TAIL
 : 
AL_START_HEAD
;

66 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

67 
li
->
™”
 = 
	`quickli¡G‘I‹¿tÜAtIdx
Öi->
subjeù
->
±r
,

68 
™”_dœeùiÚ
, 
šdex
);

70 
	`£rv”Pªic
("Unknown†istƒncoding");

72  
li
;

73 
	}
}

76 
	$li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
) {

77 
	`dä“
(
li
->
™”
);

78 
	`dä“
(
li
);

79 
	}
}

84 
	$li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
) {

86 
	`ASSERT
(
li
->
subjeù
->
’codšg
 ==†i->encoding);

88 
’Œy
->
li
 =†i;

89 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

90  
	`quickli¡Next
(
li
->
™”
, &
’Œy
->entry);

92 
	`£rv”Pªic
("Unknown†istƒncoding");

95 
	}
}

98 
robj
 *
	$li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
) {

99 
robj
 *
v®ue
 = 
NULL
;

100 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

101 ià(
’Œy
->’Œy.
v®ue
) {

102 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
->entry.value,

103 
’Œy
->’Œy.
sz
);

105 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
->’Œy.
lÚgv®
);

108 
	`£rv”Pªic
("Unknown†istƒncoding");

110  
v®ue
;

111 
	}
}

113 
	$li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
) {

114 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

115 
v®ue
 = 
	`g‘DecodedObjeù
(value);

116 
sds
 
¡r
 = 
v®ue
->
±r
;

117 
size_t
 
Ën
 = 
	`sd¦’
(
¡r
);

118 ià(
wh”e
 =ğ
LIST_TAIL
) {

119 
	`quickli¡In£¹Aá”
((
quickli¡
 *)
’Œy
->entry.quicklist,

120 &
’Œy
->’Œy, 
¡r
, 
Ën
);

121 } ià(
wh”e
 =ğ
LIST_HEAD
) {

122 
	`quickli¡In£¹BefÜe
((
quickli¡
 *)
’Œy
->entry.quicklist,

123 &
’Œy
->’Œy, 
¡r
, 
Ën
);

125 
	`deüRefCouÁ
(
v®ue
);

127 
	`£rv”Pªic
("Unknown†istƒncoding");

129 
	}
}

132 
	$li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
) {

133 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

134 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,
	`sdsEncodedObjeù
(o));

135  
	`quickli¡Com·»
(
’Œy
->’Œy.
zi
,
o
->
±r
,
	`sd¦’
(o->ptr));

137 
	`£rv”Pªic
("Unknown†istƒncoding");

139 
	}
}

142 
	$li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
) {

143 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

144 
	`quickli¡D–EÁry
(
™”
->™”, &
’Œy
->entry);

146 
	`£rv”Pªic
("Unknown†istƒncoding");

148 
	}
}

151 
	$li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
) {

152 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
ty³
==
OBJ_LIST
);

153 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
’codšg
==
OBJ_ENCODING_ZIPLIST
);

155 ià(
’c
 =ğ
OBJ_ENCODING_QUICKLIST
) {

156 
size_t
 
zËn
 = 
£rv”
.
li¡_max_zli¡_size
;

157 
d•th
 = 
£rv”
.
li¡_com´ess_d•th
;

158 
subjeù
->
±r
 = 
	`quickli¡C»©eFromZli¡
(
zËn
, 
d•th
, subject->ptr);

159 
subjeù
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

161 
	`£rv”Pªic
("Unsupported†ist conversion");

163 
	}
}

169 
	$pushG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

170 
j
, 
wa™šg
 = 0, 
pushed
 = 0;

171 
robj
 *
lobj
;

172 
expœed
 = 0;

174 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

175 
	`lockDbWr™e
(
c
->
db
);

176 
lobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

177 ià(
lobj
 &&†obj->
ty³
 !ğ
OBJ_LIST
) {

178 
	`uÆockDb
(
c
->
db
);

179 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

180 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

184 
j
 = 2; j < 
c
->
¬gc
; j++) {

185 
c
->
¬gv
[
j
] = 
	`ŒyObjeùEncodšg
(c->argv[j]);

186 ià(!
lobj
) {

187 
lobj
 = 
	`ü—‹Quickli¡Objeù
();

188 
	`quickli¡S‘O±iÚs
(
lobj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

189 
£rv”
.
li¡_com´ess_d•th
);

190 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
lobj
);

192 
	`li¡Ty³Push
(
lobj
,
c
->
¬gv
[
j
],
wh”e
);

193 
pushed
++;

195 
	`addR•lyLÚgLÚg
(
c
, 
wa™šg
 + (
lobj
 ? 
	`li¡Ty³L’gth
(lobj) : 0));

196 ià(
pushed
) {

197 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

199 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

200 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

202 
c
->
v–
->
dœty
 +ğ
pushed
;

204 
	`uÆockDb
(
c
->
db
);

205 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

206 
	}
}

208 
	$ÍushCommªd
(
ş›Á
 *
c
) {

209 
	`pushG’”icCommªd
(
c
,
LIST_HEAD
);

210 
	}
}

212 
	$½ushCommªd
(
ş›Á
 *
c
) {

213 
	`pushG’”icCommªd
(
c
,
LIST_TAIL
);

214 
	}
}

216 
	$pushxG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
»fv®
,„obj *
v®
, 
wh”e
) {

217 
robj
 *
subjeù
;

218 
li¡Ty³I‹¿tÜ
 *
™”
;

219 
li¡Ty³EÁry
 
’Œy
;

220 
š£¹ed
 = 0;

222 ià((
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,
NULL
)) == NULL ||

223 
	`checkTy³
(
c
,
subjeù
,
OBJ_LIST
)) ;

225 ià(
»fv®
 !ğ
NULL
) {

227 
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

228 
	`li¡Ty³Next
(
™”
,&
’Œy
)) {

229 ià(
	`li¡Ty³Equ®
(&
’Œy
,
»fv®
)) {

230 
	`li¡Ty³In£¹
(&
’Œy
,
v®
,
wh”e
);

231 
š£¹ed
 = 1;

235 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

237 ià(
š£¹ed
) {

238 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

239 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"linsert",

240 
c
->
¬gv
[1],c->
db
->
id
);

241 
£rv”
.
dœty
++;

244 
	`addR•ly
(
c
,
sh¬ed
.
úegÚe
);

248 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

250 
	`li¡Ty³Push
(
subjeù
,
v®
,
wh”e
);

251 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

252 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

253 
£rv”
.
dœty
++;

256 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

257 
	}
}

259 
	$ÍushxCommªd
(
ş›Á
 *
c
) {

260 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

261 
	`pushxG’”icCommªd
(
c
,
NULL
,c->
¬gv
[2],
LIST_HEAD
);

262 
	}
}

264 
	$½ushxCommªd
(
ş›Á
 *
c
) {

265 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

266 
	`pushxG’”icCommªd
(
c
,
NULL
,c->
¬gv
[2],
LIST_TAIL
);

267 
	}
}

269 
	$lš£¹Commªd
(
ş›Á
 *
c
) {

270 
c
->
¬gv
[4] = 
	`ŒyObjeùEncodšg
(c->argv[4]);

271 ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"after") == 0) {

272 
	`pushxG’”icCommªd
(
c
,c->
¬gv
[3],c->¬gv[4],
LIST_TAIL
);

273 } ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"before") == 0) {

274 
	`pushxG’”icCommªd
(
c
,c->
¬gv
[3],c->¬gv[4],
LIST_HEAD
);

276 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

278 
	}
}

280 
	$Î’Commªd
(
ş›Á
 *
c
) {

281 
robj
 *
o
;

283 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

284 
	`lockDbR—d
(
c
->
db
);

285 
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

286 ià(
o
 =ğ
NULL
) {

287 
	`uÆockDb
(
c
->
db
);

288 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

290 } if(
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

291 
	`uÆockDb
(
c
->
db
);

292 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

296 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
o
));

297 
	`uÆockDb
(
c
->
db
);

298 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

299 
	}
}

301 
	$lšdexCommªd
(
ş›Á
 *
c
) {

302 
robj
 *
o
;

303 
šdex
;

304 
robj
 *
v®ue
 = 
NULL
;

306 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
VR_OK
))

309 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[1]);

310 
	`lockDbR—d
(
c
->
db
);

311 
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

312 ià(
o
 =ğ
NULL
) {

313 
	`uÆockDb
(
c
->
db
);

314 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

316 } if(
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

317 
	`uÆockDb
(
c
->
db
);

318 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

321 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

322 
quickli¡EÁry
 
’Œy
;

323 ià(
	`quickli¡Index
(
o
->
±r
, 
šdex
, &
’Œy
)) {

324 ià(
’Œy
.
v®ue
) {

325 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
.v®ue,’Œy.
sz
);

327 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
.
lÚgv®
);

329 
	`addR•lyBulk
(
c
,
v®ue
);

330 
	`ä“Objeù
(
v®ue
);

332 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

335 
	`£rv”Pªic
("Unknown†istƒncoding");

337 
	`uÆockDb
(
c
->
db
);

338 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

339 
	}
}

341 
	$l£tCommªd
(
ş›Á
 *
c
) {

342 
robj
 *
o
;

343 
šdex
;

344 
robj
 *
v®ue
 = 
c
->
¬gv
[3];

345 
expœed
 = 0;

347 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
VR_OK
))

350 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

351 
	`lockDbWr™e
(
c
->
db
);

352 
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
,&
expœed
);

353 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) {

354 
	`uÆockDb
(
c
->
db
);

355 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

358 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

359 
quickli¡
 *
ql
 = 
o
->
±r
;

360 
»¶aûd
 = 
	`quickli¡R•ÏûAtIndex
(
ql
, 
šdex
,

361 
v®ue
->
±r
, 
	`sd¦’
(value->ptr));

362 ià(!
»¶aûd
) {

363 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

365 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

366 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

367 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"l£t",
c
->
¬gv
[1],c->
db
->
id
);

368 
c
->
v–
->
dœty
++;

371 
	`£rv”Pªic
("Unknown†istƒncoding");

374 
	`uÆockDb
(
c
->
db
);

375 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

376 
	}
}

378 
	$pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

379 
robj
 *
o
, *
v®ue
;

380 
expœed
 = 0;

382 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

383 
	`lockDbWr™e
(
c
->
db
);

384 
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
,&
expœed
);

385 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) {

386 
	`uÆockDb
(
c
->
db
);

387 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

391 
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

392 ià(
v®ue
 =ğ
NULL
) {

393 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

395 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

397 
	`addR•lyBulk
(
c
,
v®ue
);

398 
	`ä“Objeù
(
v®ue
);

399 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

400 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

401 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

402 
c
->
¬gv
[1],c->
db
->
id
);

403 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

405 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

406 
c
->
v–
->
dœty
++;

408 
	`uÆockDb
(
c
->
db
);

409 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

410 
	}
}

412 
	$ÍİCommªd
(
ş›Á
 *
c
) {

413 
	`pİG’”icCommªd
(
c
,
LIST_HEAD
);

414 
	}
}

416 
	$½İCommªd
(
ş›Á
 *
c
) {

417 
	`pİG’”icCommªd
(
c
,
LIST_TAIL
);

418 
	}
}

420 
	$ÌªgeCommªd
(
ş›Á
 *
c
) {

421 
robj
 *
o
;

422 
¡¬t
, 
’d
, 
Î’
, 
¿ng–’
;

424 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
VR_OK
) ||

425 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
VR_OK
)) ;

427 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

428 
	`lockDbR—d
(
c
->
db
);

429 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

430 
	`uÆockDb
(
c
->
db
);

431 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

433 } ià(
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

434 
	`uÆockDb
(
c
->
db
);

435 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

439 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

442 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

443 ià(
’d
 < 0è’d = 
Î’
+end;

444 ià(
¡¬t
 < 0) start = 0;

448 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

449 
	`uÆockDb
(
c
->
db
);

450 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

451 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

454 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

455 
¿ng–’
 = (
’d
-
¡¬t
)+1;

458 
	`addR•lyMuÉiBulkL’
(
c
,
¿ng–’
);

459 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

460 
li¡Ty³I‹¿tÜ
 *
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
, 
¡¬t
, 
LIST_TAIL
);

462 
¿ng–’
--) {

463 
li¡Ty³EÁry
 
’Œy
;

464 
	`li¡Ty³Next
(
™”
, &
’Œy
);

465 
quickli¡EÁry
 *
qe
 = &
’Œy
.entry;

466 ià(
qe
->
v®ue
) {

467 
	`addR•lyBulkCBufãr
(
c
,
qe
->
v®ue
,qe->
sz
);

469 
	`addR•lyBulkLÚgLÚg
(
c
,
qe
->
lÚgv®
);

472 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

474 
	`£rv”Pªic
("Listƒncoding is‚ot QUICKLIST!");

477 
	`uÆockDb
(
c
->
db
);

478 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

479 
	}
}

481 
	$ÉrimCommªd
(
ş›Á
 *
c
) {

482 
robj
 *
o
;

483 
¡¬t
, 
’d
, 
Î’
, 
Érim
, 
¹rim
;

484 
expœed
 = 0;

486 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
VR_OK
) ||

487 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
VR_OK
)) ;

489 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

490 
	`lockDbWr™e
(
c
->
db
);

491 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
ok
,&
expœed
)è=ğ
NULL
 ||

492 
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

493 
	`uÆockDb
(
c
->
db
);

494 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

497 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

500 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

501 ià(
’d
 < 0è’d = 
Î’
+end;

502 ià(
¡¬t
 < 0) start = 0;

506 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

508 
Érim
 = 
Î’
;

509 
¹rim
 = 0;

511 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

512 
Érim
 = 
¡¬t
;

513 
¹rim
 = 
Î’
-
’d
-1;

517 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

518 
	`quickli¡D–Rªge
(
o
->
±r
,0,
Érim
);

519 
	`quickli¡D–Rªge
(
o
->
±r
,-
¹rim
,rtrim);

521 
	`£rv”Pªic
("Unknown†istƒncoding");

524 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Érim",
c
->
¬gv
[1],c->
db
->
id
);

525 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

526 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

527 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

529 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

530 
c
->
v–
->
dœty
++;

531 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

532 
	`uÆockDb
(
c
->
db
);

533 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

534 
	}
}

536 
	$ÌemCommªd
(
ş›Á
 *
c
) {

537 
robj
 *
subjeù
, *
obj
;

538 
obj
 = 
c
->
¬gv
[3];

539 
tÜemove
;

540 
»moved
 = 0;

541 
expœed
 = 0;

543 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
tÜemove
, 
NULL
è!ğ
VR_OK
))

546 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

547 
	`lockDbWr™e
(
c
->
db
);

548 
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,&
expœed
);

549 ià(
subjeù
 =ğ
NULL
 || 
	`checkTy³
(
c
,subjeù,
OBJ_LIST
)) {

550 
	`uÆockDb
(
c
->
db
);

551 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

554 
li¡Ty³I‹¿tÜ
 *
li
;

555 ià(
tÜemove
 < 0) {

556 
tÜemove
 = -toremove;

557 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,-1,
LIST_HEAD
);

559 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

562 
li¡Ty³EÁry
 
’Œy
;

563 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

564 ià(
	`li¡Ty³Equ®
(&
’Œy
,
obj
)) {

565 
	`li¡Ty³D–‘e
(
li
, &
’Œy
);

566 
c
->
v–
->
dœty
++;

567 
»moved
++;

568 ià(
tÜemove
 && 
»moved
 ==oremove) ;

571 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

573 ià(
»moved
) {

574 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

575 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"Ìem",
c
->
¬gv
[1],c->
db
->
id
);

578 ià(
	`li¡Ty³L’gth
(
subjeù
) == 0) {

579 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

580 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

583 
	`addR•lyLÚgLÚg
(
c
,
»moved
);

584 
	`uÆockDb
(
c
->
db
);

585 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

586 
	}
}

604 
	$½İÍushHªdËPush
(
ş›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
) {

606 ià(!
d¡obj
) {

607 
d¡obj
 = 
	`ü—‹Quickli¡Objeù
();

608 
	`quickli¡S‘O±iÚs
(
d¡obj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

609 
£rv”
.
li¡_com´ess_d•th
);

610 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

612 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

613 
	`li¡Ty³Push
(
d¡obj
,
v®ue
,
LIST_HEAD
);

614 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Íush",
d¡key
,
c
->
db
->
id
);

616 
	`addR•lyBulk
(
c
,
v®ue
);

617 
	}
}

619 
	$½İÍushCommªd
(
ş›Á
 *
c
) {

620 
robj
 *
sobj
, *
v®ue
;

621 ià((
sobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
,
NULL
)) == NULL ||

622 
	`checkTy³
(
c
,
sobj
,
OBJ_LIST
)) ;

624 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

627 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

629 
robj
 *
dobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
);

630 
robj
 *
touchedkey
 = 
c
->
¬gv
[1];

632 ià(
dobj
 && 
	`checkTy³
(
c
,dobj,
OBJ_LIST
)) ;

633 
v®ue
 = 
	`li¡Ty³Pİ
(
sobj
,
LIST_TAIL
);

637 
	`šüRefCouÁ
(
touchedkey
);

638 
	`½İÍushHªdËPush
(
c
,c->
¬gv
[2],
dobj
,
v®ue
);

641 
	`deüRefCouÁ
(
v®ue
);

644 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"½İ",
touchedkey
,
c
->
db
->
id
);

645 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

646 
	`dbD–‘e
(
c
->
db
,
touchedkey
);

647 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

648 
touchedkey
,
c
->
db
->
id
);

650 
	`sigÇlModif›dKey
(
c
->
db
,
touchedkey
);

651 
	`deüRefCouÁ
(
touchedkey
);

652 
£rv”
.
dœty
++;

654 
	}
}

679 
	$blockFÜKeys
(
ş›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
) {

680 
diùEÁry
 *
de
;

681 
dli¡
 *
l
;

682 
j
;

684 
c
->
bpİ
.
timeout
 =imeout;

685 
c
->
bpİ
.
rg‘
 =arget;

687 ià(
rg‘
 !ğ
NULL
è
	`šüRefCouÁ
(target);

689 
j
 = 0; j < 
numkeys
; j++) {

691 ià(
	`diùAdd
(
c
->
bpİ
.
keys
,keys[
j
],
NULL
è!ğ
DICT_OK
) ;

692 
	`šüRefCouÁ
(
keys
[
j
]);

695 
de
 = 
	`diùFšd
(
c
->
db
->
blockšg_keys
,
keys
[
j
]);

696 ià(
de
 =ğ
NULL
) {

697 
»tv®
;

700 
l
 = 
	`dli¡C»©e
();

701 
»tv®
 = 
	`diùAdd
(
c
->
db
->
blockšg_keys
,
keys
[
j
],
l
);

702 
	`šüRefCouÁ
(
keys
[
j
]);

703 
	`£rv”As£¹W™hInfo
(
c
,
keys
[
j
],
»tv®
 =ğ
DICT_OK
);

705 
l
 = 
	`diùG‘V®
(
de
);

707 
	`dli¡AddNodeTa
(
l
,
c
);

709 
	`blockCl›Á
(
c
,
BLOCKED_LIST
);

710 
	}
}

714 
	$unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
) {

715 
diùEÁry
 *
de
;

716 
diùI‹¿tÜ
 *
di
;

717 
dli¡
 *
l
;

719 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`diùSize
(c->
bpİ
.
keys
) != 0);

720 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

722 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

723 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

726 
l
 = 
	`diùF‘chV®ue
(
c
->
db
->
blockšg_keys
,
key
);

727 
	`£rv”As£¹W™hInfo
(
c
,
key
,
l
 !ğ
NULL
);

728 
	`dli¡D–Node
(
l
,
	`dli¡S—rchKey
Ö,
c
));

730 ià(
	`dli¡L’gth
(
l
) == 0)

731 
	`diùD–‘e
(
c
->
db
->
blockšg_keys
,
key
);

733 
	`diùR–—£I‹¿tÜ
(
di
);

736 
	`diùEm±y
(
c
->
bpİ
.
keys
,
NULL
);

737 ià(
c
->
bpİ
.
rg‘
) {

738 
	`deüRefCouÁ
(
c
->
bpİ
.
rg‘
);

739 
c
->
bpİ
.
rg‘
 = 
NULL
;

741 
	}
}

750 
	$sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
) {

751 
»t
;

752 
»adyLi¡
 *
¾
;

755 ià(
	`diùFšd
(
db
->
blockšg_keys
,
key
è=ğ
NULL
) ;

758 ià(
	`diùFšd
(
db
->
»ady_keys
,
key
è!ğ
NULL
) ;

761 
¾
 = 
	`d®loc
((*rl));

762 
¾
->
key
 = key;

763 
¾
->
db
 = db;

764 
	`šüRefCouÁ
(
key
);

765 
	`dli¡AddNodeTa
(
£rv”
.
»ady_keys
,
¾
);

770 
	`šüRefCouÁ
(
key
);

771 
»t
 = 
	`diùAdd
(
db
->
»ady_keys
,
key
,
NULL
);

772 
	`ASSERT
(
»t
 =ğ
DICT_OK
);

773 
	}
}

794 
	$£rveCl›ÁBlockedOnLi¡
(
ş›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
)

796 
robj
 *
¬gv
[3];

798 ià(
d¡key
 =ğ
NULL
) {

800 
¬gv
[0] = (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 :

801 
sh¬ed
.
½İ
;

802 
¬gv
[1] = 
key
;

803 
	`´İag©e
((
wh”e
 =ğ
LIST_HEAD
) ?

804 
£rv”
.
ÍİCommªd
 : s”v”.
½İCommªd
,

805 
db
->
id
,
¬gv
,2,
PROPAGATE_AOF
|
PROPAGATE_REPL
);

808 
	`addR•lyMuÉiBulkL’
(
»ûiv”
,2);

809 
	`addR•lyBulk
(
»ûiv”
,
key
);

810 
	`addR•lyBulk
(
»ûiv”
,
v®ue
);

813 
robj
 *
d¡obj
 =

814 
	`lookupKeyWr™e
(
»ûiv”
->
db
,
d¡key
,
NULL
);

815 ià(!(
d¡obj
 &&

816 
	`checkTy³
(
»ûiv”
,
d¡obj
,
OBJ_LIST
)))

819 
¬gv
[0] = 
sh¬ed
.
½İ
;

820 
¬gv
[1] = 
key
;

821 
	`´İag©e
(
£rv”
.
½İCommªd
,

822 
db
->
id
,
¬gv
,2,

823 
PROPAGATE_AOF
|

824 
PROPAGATE_REPL
);

825 
	`½İÍushHªdËPush
(
»ûiv”
,
d¡key
,
d¡obj
,

826 
v®ue
);

828 
¬gv
[0] = 
sh¬ed
.
Íush
;

829 
¬gv
[1] = 
d¡key
;

830 
¬gv
[2] = 
v®ue
;

831 
	`´İag©e
(
£rv”
.
ÍushCommªd
,

832 
db
->
id
,
¬gv
,3,

833 
PROPAGATE_AOF
|

834 
PROPAGATE_REPL
);

838  
VR_ERROR
;

841  
VR_OK
;

842 
	}
}

854 
	$hªdËCl›ÁsBlockedOnLi¡s
() {

855 
	`dli¡L’gth
(
£rv”
.
»ady_keys
) != 0) {

856 
dli¡
 *
l
;

862 
l
 = 
£rv”
.
»ady_keys
;

863 
£rv”
.
»ady_keys
 = 
	`dli¡C»©e
();

865 
	`dli¡L’gth
(
l
) != 0) {

866 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
l
);

867 
»adyLi¡
 *
¾
 = 
Ê
->
v®ue
;

871 
	`diùD–‘e
(
¾
->
db
->
»ady_keys
,¾->
key
);

875 
robj
 *
o
 = 
	`lookupKeyWr™e
(
¾
->
db
,¾->
key
,
NULL
);

876 ià(
o
 !ğ
NULL
 && o->
ty³
 =ğ
OBJ_LIST
) {

877 
diùEÁry
 *
de
;

881 
de
 = 
	`diùFšd
(
¾
->
db
->
blockšg_keys
,¾->
key
);

882 ià(
de
) {

883 
dli¡
 *
ş›Ás
 = 
	`diùG‘V®
(
de
);

884 
numş›Ás
 = 
	`dli¡L’gth
(
ş›Ás
);

886 
numş›Ás
--) {

887 
dli¡Node
 *
ş›Ánode
 = 
	`dli¡Fœ¡
(
ş›Ás
);

888 
ş›Á
 *
»ûiv”
 = 
ş›Ánode
->
v®ue
;

889 
robj
 *
d¡key
 = 
»ûiv”
->
bpİ
.
rg‘
;

890 
wh”e
 = (
»ûiv”
->
Ï¡cmd
 &&

891 
»ûiv”
->
Ï¡cmd
->
´oc
 =ğ
bÍİCommªd
) ?

892 
LIST_HEAD
 : 
LIST_TAIL
;

893 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

895 ià(
v®ue
) {

899 ià(
d¡key
è
	`šüRefCouÁ
(dstkey);

900 
	`unblockCl›Á
(
»ûiv”
);

902 ià(
	`£rveCl›ÁBlockedOnLi¡
(
»ûiv”
,

903 
¾
->
key
,
d¡key
,¾->
db
,
v®ue
,

904 
wh”e
è=ğ
VR_ERROR
)

908 
	`li¡Ty³Push
(
o
,
v®ue
,
wh”e
);

911 ià(
d¡key
è
	`deüRefCouÁ
(dstkey);

912 
	`deüRefCouÁ
(
v®ue
);

919 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

920 
	`dbD–‘e
(
¾
->
db
,¾->
key
);

927 
	`deüRefCouÁ
(
¾
->
key
);

928 
	`dä“
(
¾
);

929 
	`dli¡D–Node
(
l
,
Ê
);

931 
	`dli¡R–—£
(
l
);

933 
	}
}

936 
	$blockšgPİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

937 
robj
 *
o
;

938 
m¡ime_t
 
timeout
;

939 
j
;

941 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[c->
¬gc
-1],&
timeout
,
UNIT_SECONDS
)

942 !ğ
VR_OK
) ;

944 
j
 = 1; j < 
c
->
¬gc
-1; j++) {

945 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
],
NULL
);

946 ià(
o
 !ğ
NULL
) {

947 ià(
o
->
ty³
 !ğ
OBJ_LIST
) {

948 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

951 ià(
	`li¡Ty³L’gth
(
o
) != 0) {

953 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

954 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

955 
	`ASSERT
(
v®ue
 !ğ
NULL
);

957 
	`addR•lyMuÉiBulkL’
(
c
,2);

958 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

959 
	`addR•lyBulk
(
c
,
v®ue
);

960 
	`deüRefCouÁ
(
v®ue
);

961 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,

962 
c
->
¬gv
[
j
],c->
db
->
id
);

963 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

964 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

965 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

966 
c
->
¬gv
[
j
],c->
db
->
id
);

968 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

969 
£rv”
.
dœty
++;

972 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,

973 (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 : sh¬ed.
½İ
,

974 
c
->
¬gv
[
j
]);

983 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

984 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

989 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, c->
¬gc
 - 2, 
timeout
, 
NULL
);

990 
	}
}

992 
	$bÍİCommªd
(
ş›Á
 *
c
) {

993 
	`blockšgPİG’”icCommªd
(
c
,
LIST_HEAD
);

994 
	}
}

996 
	$b½İCommªd
(
ş›Á
 *
c
) {

997 
	`blockšgPİG’”icCommªd
(
c
,
LIST_TAIL
);

998 
	}
}

1000 
	$b½İÍushCommªd
(
ş›Á
 *
c
) {

1001 
m¡ime_t
 
timeout
;

1003 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
timeout
,
UNIT_SECONDS
)

1004 !ğ
VR_OK
) ;

1006 
robj
 *
key
 = 
	`lookupKeyWr™e
(
c
->
db
, c->
¬gv
[1],
NULL
);

1008 ià(
key
 =ğ
NULL
) {

1009 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

1012 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

1015 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, 1, 
timeout
, c->argv[2]);

1018 ià(
key
->
ty³
 !ğ
OBJ_LIST
) {

1019 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

1023 
	`£rv”As£¹W™hInfo
(
c
,
key
,
	`li¡Ty³L’gth
(key) > 0);

1024 
	`½İÍushCommªd
(
c
);

1027 
	}
}

	@src/vr_t_list.c

1 
	~<vr_cÜe.h
>

12 
	$li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
) {

13 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

14 
robj
 *
v®ue_Ãw
;

15 
pos
 = (
wh”e
 =ğ
LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

16 
v®ue_Ãw
 = 
	`g‘DecodedObjeù
(
v®ue
);

17 
size_t
 
Ën
 = 
	`sd¦’
(
v®ue_Ãw
->
±r
);

18 
	`quickli¡Push
(
subjeù
->
±r
, 
v®ue_Ãw
->±r, 
Ën
, 
pos
);

19 ià(
v®ue_Ãw
 !ğ
v®ue
è
	`ä“Objeù
(value_new);

21 
	`£rv”Pªic
("Unknown†istƒncoding");

23 
	}
}

25 *
	$li¡PİSav”
(*
d©a
, 
sz
) {

26  
	`ü—‹SŒšgObjeù
((*)
d©a
,
sz
);

27 
	}
}

29 
robj
 *
	$li¡Ty³Pİ
(
robj
 *
subjeù
, 
wh”e
) {

30 
vlÚg
;

31 
robj
 *
v®ue
 = 
NULL
;

33 
ql_wh”e
 = 
wh”e
 =ğ
LIST_HEAD
 ? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

34 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

35 ià(
	`quickli¡PİCu¡om
(
subjeù
->
±r
, 
ql_wh”e
, (**)&
v®ue
,

36 
NULL
, &
vlÚg
, 
li¡PİSav”
)) {

37 ià(!
v®ue
)

38 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

41 
	`£rv”Pªic
("Unknown†istƒncoding");

43  
v®ue
;

44 
	}
}

46 
	$li¡Ty³L’gth
(
robj
 *
subjeù
) {

47 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

48  
	`quickli¡CouÁ
(
subjeù
->
±r
);

50 
	`£rv”Pªic
("Unknown†istƒncoding");

52 
	}
}

55 
li¡Ty³I‹¿tÜ
 *
	$li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
,

56 
dœeùiÚ
) {

57 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`d®loc
((listTypeIterator));

58 
li
->
subjeù
 = subject;

59 
li
->
’codšg
 = 
subjeù
->encoding;

60 
li
->
dœeùiÚ
 = direction;

61 
li
->
™”
 = 
NULL
;

64 
™”_dœeùiÚ
 =

65 
dœeùiÚ
 =ğ
LIST_HEAD
 ? 
AL_START_TAIL
 : 
AL_START_HEAD
;

66 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

67 
li
->
™”
 = 
	`quickli¡G‘I‹¿tÜAtIdx
Öi->
subjeù
->
±r
,

68 
™”_dœeùiÚ
, 
šdex
);

70 
	`£rv”Pªic
("Unknown†istƒncoding");

72  
li
;

73 
	}
}

76 
	$li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
) {

77 
	`dä“
(
li
->
™”
);

78 
	`dä“
(
li
);

79 
	}
}

84 
	$li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
) {

86 
	`ASSERT
(
li
->
subjeù
->
’codšg
 ==†i->encoding);

88 
’Œy
->
li
 =†i;

89 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

90  
	`quickli¡Next
(
li
->
™”
, &
’Œy
->entry);

92 
	`£rv”Pªic
("Unknown†istƒncoding");

95 
	}
}

98 
robj
 *
	$li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
) {

99 
robj
 *
v®ue
 = 
NULL
;

100 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

101 ià(
’Œy
->’Œy.
v®ue
) {

102 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
->entry.value,

103 
’Œy
->’Œy.
sz
);

105 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
->’Œy.
lÚgv®
);

108 
	`£rv”Pªic
("Unknown†istƒncoding");

110  
v®ue
;

111 
	}
}

113 
	$li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
) {

114 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

115 
v®ue
 = 
	`g‘DecodedObjeù
(value);

116 
sds
 
¡r
 = 
v®ue
->
±r
;

117 
size_t
 
Ën
 = 
	`sd¦’
(
¡r
);

118 ià(
wh”e
 =ğ
LIST_TAIL
) {

119 
	`quickli¡In£¹Aá”
((
quickli¡
 *)
’Œy
->entry.quicklist,

120 &
’Œy
->’Œy, 
¡r
, 
Ën
);

121 } ià(
wh”e
 =ğ
LIST_HEAD
) {

122 
	`quickli¡In£¹BefÜe
((
quickli¡
 *)
’Œy
->entry.quicklist,

123 &
’Œy
->’Œy, 
¡r
, 
Ën
);

125 
	`deüRefCouÁ
(
v®ue
);

127 
	`£rv”Pªic
("Unknown†istƒncoding");

129 
	}
}

132 
	$li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
) {

133 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

134 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,
	`sdsEncodedObjeù
(o));

135  
	`quickli¡Com·»
(
’Œy
->’Œy.
zi
,
o
->
±r
,
	`sd¦’
(o->ptr));

137 
	`£rv”Pªic
("Unknown†istƒncoding");

139 
	}
}

142 
	$li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
) {

143 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

144 
	`quickli¡D–EÁry
(
™”
->™”, &
’Œy
->entry);

146 
	`£rv”Pªic
("Unknown†istƒncoding");

148 
	}
}

151 
	$li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
) {

152 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
ty³
==
OBJ_LIST
);

153 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
’codšg
==
OBJ_ENCODING_ZIPLIST
);

155 ià(
’c
 =ğ
OBJ_ENCODING_QUICKLIST
) {

156 
size_t
 
zËn
 = 
£rv”
.
li¡_max_zli¡_size
;

157 
d•th
 = 
£rv”
.
li¡_com´ess_d•th
;

158 
subjeù
->
±r
 = 
	`quickli¡C»©eFromZli¡
(
zËn
, 
d•th
, subject->ptr);

159 
subjeù
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

161 
	`£rv”Pªic
("Unsupported†ist conversion");

163 
	}
}

169 
	$pushG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

170 
j
, 
wa™šg
 = 0, 
pushed
 = 0;

171 
robj
 *
lobj
;

172 
expœed
 = 0;

174 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

175 
	`lockDbWr™e
(
c
->
db
);

176 
lobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

177 ià(
lobj
 &&†obj->
ty³
 !ğ
OBJ_LIST
) {

178 
	`uÆockDb
(
c
->
db
);

179 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

180 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

184 
j
 = 2; j < 
c
->
¬gc
; j++) {

185 
c
->
¬gv
[
j
] = 
	`ŒyObjeùEncodšg
(c->argv[j]);

186 ià(!
lobj
) {

187 
lobj
 = 
	`ü—‹Quickli¡Objeù
();

188 
	`quickli¡S‘O±iÚs
(
lobj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

189 
£rv”
.
li¡_com´ess_d•th
);

190 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
lobj
);

192 
	`li¡Ty³Push
(
lobj
,
c
->
¬gv
[
j
],
wh”e
);

193 
pushed
++;

195 
	`addR•lyLÚgLÚg
(
c
, 
wa™šg
 + (
lobj
 ? 
	`li¡Ty³L’gth
(lobj) : 0));

196 ià(
pushed
) {

197 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

199 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

200 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

202 
c
->
v–
->
dœty
 +ğ
pushed
;

204 
	`uÆockDb
(
c
->
db
);

205 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

206 
	}
}

208 
	$ÍushCommªd
(
ş›Á
 *
c
) {

209 
	`pushG’”icCommªd
(
c
,
LIST_HEAD
);

210 
	}
}

212 
	$½ushCommªd
(
ş›Á
 *
c
) {

213 
	`pushG’”icCommªd
(
c
,
LIST_TAIL
);

214 
	}
}

216 
	$pushxG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
»fv®
,„obj *
v®
, 
wh”e
) {

217 
robj
 *
subjeù
;

218 
li¡Ty³I‹¿tÜ
 *
™”
;

219 
li¡Ty³EÁry
 
’Œy
;

220 
š£¹ed
 = 0;

222 ià((
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,
NULL
)) == NULL ||

223 
	`checkTy³
(
c
,
subjeù
,
OBJ_LIST
)) ;

225 ià(
»fv®
 !ğ
NULL
) {

227 
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

228 
	`li¡Ty³Next
(
™”
,&
’Œy
)) {

229 ià(
	`li¡Ty³Equ®
(&
’Œy
,
»fv®
)) {

230 
	`li¡Ty³In£¹
(&
’Œy
,
v®
,
wh”e
);

231 
š£¹ed
 = 1;

235 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

237 ià(
š£¹ed
) {

238 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

239 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"linsert",

240 
c
->
¬gv
[1],c->
db
->
id
);

241 
£rv”
.
dœty
++;

244 
	`addR•ly
(
c
,
sh¬ed
.
úegÚe
);

248 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

250 
	`li¡Ty³Push
(
subjeù
,
v®
,
wh”e
);

251 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

252 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

253 
£rv”
.
dœty
++;

256 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

257 
	}
}

259 
	$ÍushxCommªd
(
ş›Á
 *
c
) {

260 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

261 
	`pushxG’”icCommªd
(
c
,
NULL
,c->
¬gv
[2],
LIST_HEAD
);

262 
	}
}

264 
	$½ushxCommªd
(
ş›Á
 *
c
) {

265 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

266 
	`pushxG’”icCommªd
(
c
,
NULL
,c->
¬gv
[2],
LIST_TAIL
);

267 
	}
}

269 
	$lš£¹Commªd
(
ş›Á
 *
c
) {

270 
c
->
¬gv
[4] = 
	`ŒyObjeùEncodšg
(c->argv[4]);

271 ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"after") == 0) {

272 
	`pushxG’”icCommªd
(
c
,c->
¬gv
[3],c->¬gv[4],
LIST_TAIL
);

273 } ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"before") == 0) {

274 
	`pushxG’”icCommªd
(
c
,c->
¬gv
[3],c->¬gv[4],
LIST_HEAD
);

276 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

278 
	}
}

280 
	$Î’Commªd
(
ş›Á
 *
c
) {

281 
robj
 *
o
;

283 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

284 
	`lockDbR—d
(
c
->
db
);

285 
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

286 ià(
o
 =ğ
NULL
) {

287 
	`uÆockDb
(
c
->
db
);

288 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

290 } if(
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

291 
	`uÆockDb
(
c
->
db
);

292 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

296 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
o
));

297 
	`uÆockDb
(
c
->
db
);

298 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

299 
	}
}

301 
	$lšdexCommªd
(
ş›Á
 *
c
) {

302 
robj
 *
o
;

303 
šdex
;

304 
robj
 *
v®ue
 = 
NULL
;

306 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
VR_OK
))

309 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[1]);

310 
	`lockDbR—d
(
c
->
db
);

311 
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

312 ià(
o
 =ğ
NULL
) {

313 
	`uÆockDb
(
c
->
db
);

314 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

316 } if(
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

317 
	`uÆockDb
(
c
->
db
);

318 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

321 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

322 
quickli¡EÁry
 
’Œy
;

323 ià(
	`quickli¡Index
(
o
->
±r
, 
šdex
, &
’Œy
)) {

324 ià(
’Œy
.
v®ue
) {

325 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
.v®ue,’Œy.
sz
);

327 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
.
lÚgv®
);

329 
	`addR•lyBulk
(
c
,
v®ue
);

330 
	`ä“Objeù
(
v®ue
);

332 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

335 
	`£rv”Pªic
("Unknown†istƒncoding");

337 
	`uÆockDb
(
c
->
db
);

338 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

339 
	}
}

341 
	$l£tCommªd
(
ş›Á
 *
c
) {

342 
robj
 *
o
;

343 
šdex
;

344 
robj
 *
v®ue
 = 
c
->
¬gv
[3];

345 
expœed
 = 0;

347 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
VR_OK
))

350 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

351 
	`lockDbWr™e
(
c
->
db
);

352 
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
,&
expœed
);

353 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) {

354 
	`uÆockDb
(
c
->
db
);

355 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

358 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

359 
quickli¡
 *
ql
 = 
o
->
±r
;

360 
»¶aûd
 = 
	`quickli¡R•ÏûAtIndex
(
ql
, 
šdex
,

361 
v®ue
->
±r
, 
	`sd¦’
(value->ptr));

362 ià(!
»¶aûd
) {

363 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

365 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

366 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

367 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"l£t",
c
->
¬gv
[1],c->
db
->
id
);

368 
c
->
v–
->
dœty
++;

371 
	`£rv”Pªic
("Unknown†istƒncoding");

374 
	`uÆockDb
(
c
->
db
);

375 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

376 
	}
}

378 
	$pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

379 
robj
 *
o
, *
v®ue
;

380 
expœed
 = 0;

382 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

383 
	`lockDbWr™e
(
c
->
db
);

384 
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
,&
expœed
);

385 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) {

386 
	`uÆockDb
(
c
->
db
);

387 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

391 
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

392 ià(
v®ue
 =ğ
NULL
) {

393 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

395 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

397 
	`addR•lyBulk
(
c
,
v®ue
);

398 
	`ä“Objeù
(
v®ue
);

399 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

400 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

401 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

402 
c
->
¬gv
[1],c->
db
->
id
);

403 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

405 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

406 
c
->
v–
->
dœty
++;

408 
	`uÆockDb
(
c
->
db
);

409 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

410 
	}
}

412 
	$ÍİCommªd
(
ş›Á
 *
c
) {

413 
	`pİG’”icCommªd
(
c
,
LIST_HEAD
);

414 
	}
}

416 
	$½İCommªd
(
ş›Á
 *
c
) {

417 
	`pİG’”icCommªd
(
c
,
LIST_TAIL
);

418 
	}
}

420 
	$ÌªgeCommªd
(
ş›Á
 *
c
) {

421 
robj
 *
o
;

422 
¡¬t
, 
’d
, 
Î’
, 
¿ng–’
;

424 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
VR_OK
) ||

425 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
VR_OK
)) ;

427 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

428 
	`lockDbR—d
(
c
->
db
);

429 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

430 
	`uÆockDb
(
c
->
db
);

431 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

433 } ià(
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

434 
	`uÆockDb
(
c
->
db
);

435 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

439 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

442 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

443 ià(
’d
 < 0è’d = 
Î’
+end;

444 ià(
¡¬t
 < 0) start = 0;

448 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

449 
	`uÆockDb
(
c
->
db
);

450 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

451 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

454 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

455 
¿ng–’
 = (
’d
-
¡¬t
)+1;

458 
	`addR•lyMuÉiBulkL’
(
c
,
¿ng–’
);

459 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

460 
li¡Ty³I‹¿tÜ
 *
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
, 
¡¬t
, 
LIST_TAIL
);

462 
¿ng–’
--) {

463 
li¡Ty³EÁry
 
’Œy
;

464 
	`li¡Ty³Next
(
™”
, &
’Œy
);

465 
quickli¡EÁry
 *
qe
 = &
’Œy
.entry;

466 ià(
qe
->
v®ue
) {

467 
	`addR•lyBulkCBufãr
(
c
,
qe
->
v®ue
,qe->
sz
);

469 
	`addR•lyBulkLÚgLÚg
(
c
,
qe
->
lÚgv®
);

472 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

474 
	`£rv”Pªic
("Listƒncoding is‚ot QUICKLIST!");

477 
	`uÆockDb
(
c
->
db
);

478 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

479 
	}
}

481 
	$ÉrimCommªd
(
ş›Á
 *
c
) {

482 
robj
 *
o
;

483 
¡¬t
, 
’d
, 
Î’
, 
Érim
, 
¹rim
;

484 
expœed
 = 0;

486 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
VR_OK
) ||

487 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
VR_OK
)) ;

489 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

490 
	`lockDbWr™e
(
c
->
db
);

491 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
ok
,&
expœed
)è=ğ
NULL
 ||

492 
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) {

493 
	`uÆockDb
(
c
->
db
);

494 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

497 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

500 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

501 ià(
’d
 < 0è’d = 
Î’
+end;

502 ià(
¡¬t
 < 0) start = 0;

506 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

508 
Érim
 = 
Î’
;

509 
¹rim
 = 0;

511 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

512 
Érim
 = 
¡¬t
;

513 
¹rim
 = 
Î’
-
’d
-1;

517 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

518 
	`quickli¡D–Rªge
(
o
->
±r
,0,
Érim
);

519 
	`quickli¡D–Rªge
(
o
->
±r
,-
¹rim
,rtrim);

521 
	`£rv”Pªic
("Unknown†istƒncoding");

524 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Érim",
c
->
¬gv
[1],c->
db
->
id
);

525 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

526 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

527 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

529 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

530 
c
->
v–
->
dœty
++;

531 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

532 
	`uÆockDb
(
c
->
db
);

533 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

534 
	}
}

536 
	$ÌemCommªd
(
ş›Á
 *
c
) {

537 
robj
 *
subjeù
, *
obj
;

538 
obj
 = 
c
->
¬gv
[3];

539 
tÜemove
;

540 
»moved
 = 0;

541 
expœed
 = 0;

543 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
tÜemove
, 
NULL
è!ğ
VR_OK
))

546 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

547 
	`lockDbWr™e
(
c
->
db
);

548 
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,&
expœed
);

549 ià(
subjeù
 =ğ
NULL
 || 
	`checkTy³
(
c
,subjeù,
OBJ_LIST
)) {

550 
	`uÆockDb
(
c
->
db
);

551 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

554 
li¡Ty³I‹¿tÜ
 *
li
;

555 ià(
tÜemove
 < 0) {

556 
tÜemove
 = -toremove;

557 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,-1,
LIST_HEAD
);

559 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

562 
li¡Ty³EÁry
 
’Œy
;

563 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

564 ià(
	`li¡Ty³Equ®
(&
’Œy
,
obj
)) {

565 
	`li¡Ty³D–‘e
(
li
, &
’Œy
);

566 
c
->
v–
->
dœty
++;

567 
»moved
++;

568 ià(
tÜemove
 && 
»moved
 ==oremove) ;

571 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

573 ià(
»moved
) {

574 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

575 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"Ìem",
c
->
¬gv
[1],c->
db
->
id
);

578 ià(
	`li¡Ty³L’gth
(
subjeù
) == 0) {

579 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

580 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

583 
	`addR•lyLÚgLÚg
(
c
,
»moved
);

584 
	`uÆockDb
(
c
->
db
);

585 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

586 
	}
}

604 
	$½İÍushHªdËPush
(
ş›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
) {

606 ià(!
d¡obj
) {

607 
d¡obj
 = 
	`ü—‹Quickli¡Objeù
();

608 
	`quickli¡S‘O±iÚs
(
d¡obj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

609 
£rv”
.
li¡_com´ess_d•th
);

610 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

612 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

613 
	`li¡Ty³Push
(
d¡obj
,
v®ue
,
LIST_HEAD
);

614 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Íush",
d¡key
,
c
->
db
->
id
);

616 
	`addR•lyBulk
(
c
,
v®ue
);

617 
	}
}

619 
	$½İÍushCommªd
(
ş›Á
 *
c
) {

620 
robj
 *
sobj
, *
v®ue
;

621 ià((
sobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
,
NULL
)) == NULL ||

622 
	`checkTy³
(
c
,
sobj
,
OBJ_LIST
)) ;

624 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

627 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

629 
robj
 *
dobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
);

630 
robj
 *
touchedkey
 = 
c
->
¬gv
[1];

632 ià(
dobj
 && 
	`checkTy³
(
c
,dobj,
OBJ_LIST
)) ;

633 
v®ue
 = 
	`li¡Ty³Pİ
(
sobj
,
LIST_TAIL
);

637 
	`šüRefCouÁ
(
touchedkey
);

638 
	`½İÍushHªdËPush
(
c
,c->
¬gv
[2],
dobj
,
v®ue
);

641 
	`deüRefCouÁ
(
v®ue
);

644 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"½İ",
touchedkey
,
c
->
db
->
id
);

645 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

646 
	`dbD–‘e
(
c
->
db
,
touchedkey
);

647 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

648 
touchedkey
,
c
->
db
->
id
);

650 
	`sigÇlModif›dKey
(
c
->
db
,
touchedkey
);

651 
	`deüRefCouÁ
(
touchedkey
);

652 
£rv”
.
dœty
++;

654 
	}
}

679 
	$blockFÜKeys
(
ş›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
) {

680 
diùEÁry
 *
de
;

681 
dli¡
 *
l
;

682 
j
;

684 
c
->
bpİ
.
timeout
 =imeout;

685 
c
->
bpİ
.
rg‘
 =arget;

687 ià(
rg‘
 !ğ
NULL
è
	`šüRefCouÁ
(target);

689 
j
 = 0; j < 
numkeys
; j++) {

691 ià(
	`diùAdd
(
c
->
bpİ
.
keys
,keys[
j
],
NULL
è!ğ
DICT_OK
) ;

692 
	`šüRefCouÁ
(
keys
[
j
]);

695 
de
 = 
	`diùFšd
(
c
->
db
->
blockšg_keys
,
keys
[
j
]);

696 ià(
de
 =ğ
NULL
) {

697 
»tv®
;

700 
l
 = 
	`dli¡C»©e
();

701 
»tv®
 = 
	`diùAdd
(
c
->
db
->
blockšg_keys
,
keys
[
j
],
l
);

702 
	`šüRefCouÁ
(
keys
[
j
]);

703 
	`£rv”As£¹W™hInfo
(
c
,
keys
[
j
],
»tv®
 =ğ
DICT_OK
);

705 
l
 = 
	`diùG‘V®
(
de
);

707 
	`dli¡AddNodeTa
(
l
,
c
);

709 
	`blockCl›Á
(
c
,
BLOCKED_LIST
);

710 
	}
}

714 
	$unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
) {

715 
diùEÁry
 *
de
;

716 
diùI‹¿tÜ
 *
di
;

717 
dli¡
 *
l
;

719 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`diùSize
(c->
bpİ
.
keys
) != 0);

720 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

722 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

723 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

726 
l
 = 
	`diùF‘chV®ue
(
c
->
db
->
blockšg_keys
,
key
);

727 
	`£rv”As£¹W™hInfo
(
c
,
key
,
l
 !ğ
NULL
);

728 
	`dli¡D–Node
(
l
,
	`dli¡S—rchKey
Ö,
c
));

730 ià(
	`dli¡L’gth
(
l
) == 0)

731 
	`diùD–‘e
(
c
->
db
->
blockšg_keys
,
key
);

733 
	`diùR–—£I‹¿tÜ
(
di
);

736 
	`diùEm±y
(
c
->
bpİ
.
keys
,
NULL
);

737 ià(
c
->
bpİ
.
rg‘
) {

738 
	`deüRefCouÁ
(
c
->
bpİ
.
rg‘
);

739 
c
->
bpİ
.
rg‘
 = 
NULL
;

741 
	}
}

750 
	$sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
) {

751 
»t
;

752 
»adyLi¡
 *
¾
;

755 ià(
	`diùFšd
(
db
->
blockšg_keys
,
key
è=ğ
NULL
) ;

758 ià(
	`diùFšd
(
db
->
»ady_keys
,
key
è!ğ
NULL
) ;

761 
¾
 = 
	`d®loc
((*rl));

762 
¾
->
key
 = key;

763 
¾
->
db
 = db;

764 
	`šüRefCouÁ
(
key
);

765 
	`dli¡AddNodeTa
(
£rv”
.
»ady_keys
,
¾
);

770 
	`šüRefCouÁ
(
key
);

771 
»t
 = 
	`diùAdd
(
db
->
»ady_keys
,
key
,
NULL
);

772 
	`ASSERT
(
»t
 =ğ
DICT_OK
);

773 
	}
}

794 
	$£rveCl›ÁBlockedOnLi¡
(
ş›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
)

796 
robj
 *
¬gv
[3];

798 ià(
d¡key
 =ğ
NULL
) {

800 
¬gv
[0] = (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 :

801 
sh¬ed
.
½İ
;

802 
¬gv
[1] = 
key
;

803 
	`´İag©e
((
wh”e
 =ğ
LIST_HEAD
) ?

804 
£rv”
.
ÍİCommªd
 : s”v”.
½İCommªd
,

805 
db
->
id
,
¬gv
,2,
PROPAGATE_AOF
|
PROPAGATE_REPL
);

808 
	`addR•lyMuÉiBulkL’
(
»ûiv”
,2);

809 
	`addR•lyBulk
(
»ûiv”
,
key
);

810 
	`addR•lyBulk
(
»ûiv”
,
v®ue
);

813 
robj
 *
d¡obj
 =

814 
	`lookupKeyWr™e
(
»ûiv”
->
db
,
d¡key
,
NULL
);

815 ià(!(
d¡obj
 &&

816 
	`checkTy³
(
»ûiv”
,
d¡obj
,
OBJ_LIST
)))

819 
¬gv
[0] = 
sh¬ed
.
½İ
;

820 
¬gv
[1] = 
key
;

821 
	`´İag©e
(
£rv”
.
½İCommªd
,

822 
db
->
id
,
¬gv
,2,

823 
PROPAGATE_AOF
|

824 
PROPAGATE_REPL
);

825 
	`½İÍushHªdËPush
(
»ûiv”
,
d¡key
,
d¡obj
,

826 
v®ue
);

828 
¬gv
[0] = 
sh¬ed
.
Íush
;

829 
¬gv
[1] = 
d¡key
;

830 
¬gv
[2] = 
v®ue
;

831 
	`´İag©e
(
£rv”
.
ÍushCommªd
,

832 
db
->
id
,
¬gv
,3,

833 
PROPAGATE_AOF
|

834 
PROPAGATE_REPL
);

838  
VR_ERROR
;

841  
VR_OK
;

842 
	}
}

854 
	$hªdËCl›ÁsBlockedOnLi¡s
() {

855 
	`dli¡L’gth
(
£rv”
.
»ady_keys
) != 0) {

856 
dli¡
 *
l
;

862 
l
 = 
£rv”
.
»ady_keys
;

863 
£rv”
.
»ady_keys
 = 
	`dli¡C»©e
();

865 
	`dli¡L’gth
(
l
) != 0) {

866 
dli¡Node
 *
Ê
 = 
	`dli¡Fœ¡
(
l
);

867 
»adyLi¡
 *
¾
 = 
Ê
->
v®ue
;

871 
	`diùD–‘e
(
¾
->
db
->
»ady_keys
,¾->
key
);

875 
robj
 *
o
 = 
	`lookupKeyWr™e
(
¾
->
db
,¾->
key
,
NULL
);

876 ià(
o
 !ğ
NULL
 && o->
ty³
 =ğ
OBJ_LIST
) {

877 
diùEÁry
 *
de
;

881 
de
 = 
	`diùFšd
(
¾
->
db
->
blockšg_keys
,¾->
key
);

882 ià(
de
) {

883 
dli¡
 *
ş›Ás
 = 
	`diùG‘V®
(
de
);

884 
numş›Ás
 = 
	`dli¡L’gth
(
ş›Ás
);

886 
numş›Ás
--) {

887 
dli¡Node
 *
ş›Ánode
 = 
	`dli¡Fœ¡
(
ş›Ás
);

888 
ş›Á
 *
»ûiv”
 = 
ş›Ánode
->
v®ue
;

889 
robj
 *
d¡key
 = 
»ûiv”
->
bpİ
.
rg‘
;

890 
wh”e
 = (
»ûiv”
->
Ï¡cmd
 &&

891 
»ûiv”
->
Ï¡cmd
->
´oc
 =ğ
bÍİCommªd
) ?

892 
LIST_HEAD
 : 
LIST_TAIL
;

893 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

895 ià(
v®ue
) {

899 ià(
d¡key
è
	`šüRefCouÁ
(dstkey);

900 
	`unblockCl›Á
(
»ûiv”
);

902 ià(
	`£rveCl›ÁBlockedOnLi¡
(
»ûiv”
,

903 
¾
->
key
,
d¡key
,¾->
db
,
v®ue
,

904 
wh”e
è=ğ
VR_ERROR
)

908 
	`li¡Ty³Push
(
o
,
v®ue
,
wh”e
);

911 ià(
d¡key
è
	`deüRefCouÁ
(dstkey);

912 
	`deüRefCouÁ
(
v®ue
);

919 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

920 
	`dbD–‘e
(
¾
->
db
,¾->
key
);

927 
	`deüRefCouÁ
(
¾
->
key
);

928 
	`dä“
(
¾
);

929 
	`dli¡D–Node
(
l
,
Ê
);

931 
	`dli¡R–—£
(
l
);

933 
	}
}

936 
	$blockšgPİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

937 
robj
 *
o
;

938 
m¡ime_t
 
timeout
;

939 
j
;

941 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[c->
¬gc
-1],&
timeout
,
UNIT_SECONDS
)

942 !ğ
VR_OK
) ;

944 
j
 = 1; j < 
c
->
¬gc
-1; j++) {

945 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
],
NULL
);

946 ià(
o
 !ğ
NULL
) {

947 ià(
o
->
ty³
 !ğ
OBJ_LIST
) {

948 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

951 ià(
	`li¡Ty³L’gth
(
o
) != 0) {

953 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

954 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

955 
	`ASSERT
(
v®ue
 !ğ
NULL
);

957 
	`addR•lyMuÉiBulkL’
(
c
,2);

958 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

959 
	`addR•lyBulk
(
c
,
v®ue
);

960 
	`deüRefCouÁ
(
v®ue
);

961 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,

962 
c
->
¬gv
[
j
],c->
db
->
id
);

963 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

964 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

965 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

966 
c
->
¬gv
[
j
],c->
db
->
id
);

968 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

969 
£rv”
.
dœty
++;

972 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,

973 (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 : sh¬ed.
½İ
,

974 
c
->
¬gv
[
j
]);

983 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

984 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

989 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, c->
¬gc
 - 2, 
timeout
, 
NULL
);

990 
	}
}

992 
	$bÍİCommªd
(
ş›Á
 *
c
) {

993 
	`blockšgPİG’”icCommªd
(
c
,
LIST_HEAD
);

994 
	}
}

996 
	$b½İCommªd
(
ş›Á
 *
c
) {

997 
	`blockšgPİG’”icCommªd
(
c
,
LIST_TAIL
);

998 
	}
}

1000 
	$b½İÍushCommªd
(
ş›Á
 *
c
) {

1001 
m¡ime_t
 
timeout
;

1003 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
timeout
,
UNIT_SECONDS
)

1004 !ğ
VR_OK
) ;

1006 
robj
 *
key
 = 
	`lookupKeyWr™e
(
c
->
db
, c->
¬gv
[1],
NULL
);

1008 ià(
key
 =ğ
NULL
) {

1009 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

1012 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

1015 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, 1, 
timeout
, c->argv[2]);

1018 ià(
key
->
ty³
 !ğ
OBJ_LIST
) {

1019 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

1023 
	`£rv”As£¹W™hInfo
(
c
,
key
,
	`li¡Ty³L’gth
(key) > 0);

1024 
	`½İÍushCommªd
(
c
);

1027 
	}
}

	@src/vr_t_list.h

1 #iâdeà
_VR_T_LIST_H_


2 
	#_VR_T_LIST_H_


	)

4 
li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
);

5 *
li¡PİSav”
(*
d©a
, 
sz
);

6 
robj
 *
li¡Ty³Pİ
Ôobj *
subjeù
, 
wh”e
);

7 
li¡Ty³L’gth
(
robj
 *
subjeù
);

8 
li¡Ty³I‹¿tÜ
 *
li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
, 
dœeùiÚ
);

9 
li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
);

10 
li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
);

11 
robj
 *
li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
);

12 
li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
);

13 
li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
);

14 
li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
);

15 
li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
);

16 
pushG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

17 
ÍushCommªd
(
ş›Á
 *
c
);

18 
½ushCommªd
(
ş›Á
 *
c
);

19 
pushxG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
»fv®
,„obj *
v®
, 
wh”e
);

20 
ÍushxCommªd
(
ş›Á
 *
c
);

21 
½ushxCommªd
(
ş›Á
 *
c
);

22 
lš£¹Commªd
(
ş›Á
 *
c
);

23 
Î’Commªd
(
ş›Á
 *
c
);

24 
lšdexCommªd
(
ş›Á
 *
c
);

25 
l£tCommªd
(
ş›Á
 *
c
);

26 
pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

27 
ÍİCommªd
(
ş›Á
 *
c
);

28 
½İCommªd
(
ş›Á
 *
c
);

29 
ÌªgeCommªd
(
ş›Á
 *
c
);

30 
ÉrimCommªd
(
ş›Á
 *
c
);

31 
ÌemCommªd
(
ş›Á
 *
c
);

32 
½İÍushHªdËPush
(
ş›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
);

33 
½İÍushCommªd
(
ş›Á
 *
c
);

34 
blockFÜKeys
(
ş›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
);

35 
unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
);

36 
sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
);

37 
£rveCl›ÁBlockedOnLi¡
(
ş›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
);

38 
hªdËCl›ÁsBlockedOnLi¡s
();

39 
blockšgPİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

40 
bÍİCommªd
(
ş›Á
 *
c
);

41 
b½İCommªd
(
ş›Á
 *
c
);

42 
b½İÍushCommªd
(
ş›Á
 *
c
);

	@src/vr_t_list.h

1 #iâdeà
_VR_T_LIST_H_


2 
	#_VR_T_LIST_H_


	)

4 
li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
);

5 *
li¡PİSav”
(*
d©a
, 
sz
);

6 
robj
 *
li¡Ty³Pİ
Ôobj *
subjeù
, 
wh”e
);

7 
li¡Ty³L’gth
(
robj
 *
subjeù
);

8 
li¡Ty³I‹¿tÜ
 *
li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
, 
dœeùiÚ
);

9 
li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
);

10 
li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
);

11 
robj
 *
li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
);

12 
li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
);

13 
li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
);

14 
li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
);

15 
li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
);

16 
pushG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

17 
ÍushCommªd
(
ş›Á
 *
c
);

18 
½ushCommªd
(
ş›Á
 *
c
);

19 
pushxG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
»fv®
,„obj *
v®
, 
wh”e
);

20 
ÍushxCommªd
(
ş›Á
 *
c
);

21 
½ushxCommªd
(
ş›Á
 *
c
);

22 
lš£¹Commªd
(
ş›Á
 *
c
);

23 
Î’Commªd
(
ş›Á
 *
c
);

24 
lšdexCommªd
(
ş›Á
 *
c
);

25 
l£tCommªd
(
ş›Á
 *
c
);

26 
pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

27 
ÍİCommªd
(
ş›Á
 *
c
);

28 
½İCommªd
(
ş›Á
 *
c
);

29 
ÌªgeCommªd
(
ş›Á
 *
c
);

30 
ÉrimCommªd
(
ş›Á
 *
c
);

31 
ÌemCommªd
(
ş›Á
 *
c
);

32 
½İÍushHªdËPush
(
ş›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
);

33 
½İÍushCommªd
(
ş›Á
 *
c
);

34 
blockFÜKeys
(
ş›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
);

35 
unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
);

36 
sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
);

37 
£rveCl›ÁBlockedOnLi¡
(
ş›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
);

38 
hªdËCl›ÁsBlockedOnLi¡s
();

39 
blockšgPİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

40 
bÍİCommªd
(
ş›Á
 *
c
);

41 
b½İCommªd
(
ş›Á
 *
c
);

42 
b½İÍushCommªd
(
ş›Á
 *
c
);

	@src/vr_t_set.c

1 
	~<vr_cÜe.h
>

7 
suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

8 
robj
 *
d¡key
, 
İ
);

13 
robj
 *
	$£tTy³C»©e
(
robj
 *
v®ue
) {

14 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,
NULL
è=ğ
VR_OK
)

15  
	`ü—‹IÁ£tObjeù
();

16  
	`ü—‹S‘Objeù
();

17 
	}
}

24 
	$£tTy³Add
(
robj
 *
subjeù
,„obj *
v®ue
) {

25 
Îv®
;

26 
robj
 *
obj
;

27 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

28 
obj
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
v®ue
);

29 ià(
	`diùAdd
(
subjeù
->
±r
,
obj
,
NULL
è=ğ
DICT_OK
) {

32 
	`ä“Objeù
(
obj
);

34 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

35 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
VR_OK
) {

36 
ušt8_t
 
sucûss
 = 0;

37 
subjeù
->
±r
 = 
	`št£tAdd
(subjeù->±r,
Îv®
,&
sucûss
);

38 ià(
sucûss
) {

41 ià(
	`št£tL’
(
subjeù
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

42 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

47 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

48 
obj
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
v®ue
);

51 
	`£rv”As£¹W™hInfo
(
NULL
,
obj
,

52 
	`diùAdd
(
subjeù
->
±r
,
obj
,
NULL
è=ğ
DICT_OK
);

56 
	`£rv”Pªic
("Unknown setƒncoding");

59 
	}
}

61 
	$£tTy³Remove
(
robj
 *
£tobj
,„obj *
v®ue
) {

62 
Îv®
;

63 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

64 ià(
	`diùD–‘e
(
£tobj
->
±r
,
v®ue
è=ğ
DICT_OK
) {

65 ià(
	`htN“dsResize
(
£tobj
->
±r
)è
	`diùResize
(setobj->ptr);

68 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

69 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
VR_OK
) {

70 
sucûss
;

71 
£tobj
->
±r
 = 
	`št£tRemove
(£tobj->±r,
Îv®
,&
sucûss
);

72 ià(
sucûss
)  1;

75 
	`£rv”Pªic
("Unknown setƒncoding");

78 
	}
}

80 
	$£tTy³IsMemb”
(
robj
 *
subjeù
,„obj *
v®ue
) {

81 
Îv®
;

82 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

83  
	`diùFšd
((
diù
*)
subjeù
->
±r
,
v®ue
è!ğ
NULL
;

84 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

85 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
VR_OK
) {

86  
	`št£tFšd
((
št£t
*)
subjeù
->
±r
,
Îv®
);

89 
	`£rv”Pªic
("Unknown setƒncoding");

92 
	}
}

94 
£tTy³I‹¿tÜ
 *
	$£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

95 
£tTy³I‹¿tÜ
 *
si
 = 
	`d®loc
((setTypeIterator));

96 
si
->
subjeù
 = subject;

97 
si
->
’codšg
 = 
subjeù
->encoding;

98 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

99 
si
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

100 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

101 
si
->
ii
 = 0;

103 
	`£rv”Pªic
("Unknown setƒncoding");

105  
si
;

106 
	}
}

108 
	$£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
) {

109 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

110 
	`diùR–—£I‹¿tÜ
(
si
->
di
);

111 
	`dä“
(
si
);

112 
	}
}

129 
	$£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
robj
 **
obj–e
, 
št64_t
 *
Î–e
) {

130 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

131 
diùEÁry
 *
de
 = 
	`diùNext
(
si
->
di
);

132 ià(
de
 =ğ
NULL
)  -1;

133 *
obj–e
 = 
	`diùG‘Key
(
de
);

134 *
Î–e
 = -123456789;

135 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

136 ià(!
	`št£tG‘
(
si
->
subjeù
->
±r
,si->
ii
++,
Î–e
))

138 *
obj–e
 = 
NULL
;

140 
	`£rv”Pªic
("Wrong setƒncoding in setTypeNext");

142  
si
->
’codšg
;

143 
	}
}

153 
robj
 *
	$£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
) {

154 
št64_t
 
š‹Ë
;

155 
robj
 *
obj–e
;

156 
’codšg
;

158 
’codšg
 = 
	`£tTy³Next
(
si
,&
obj–e
,&
š‹Ë
);

159 
’codšg
) {

160 -1:  
NULL
;

161 
OBJ_ENCODING_INTSET
:

162  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
š‹Ë
);

163 
OBJ_ENCODING_HT
:

164  
obj–e
;

166 
	`£rv”Pªic
("Unsupportedƒncoding");

168  
NULL
;

169 
	}
}

188 
	$£tTy³RªdomEËm’t
(
robj
 *
£tobj
,„obj **
obj–e
, 
št64_t
 *
Î–e
) {

189 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

190 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£tobj
->
±r
);

191 *
obj–e
 = 
	`diùG‘Key
(
de
);

192 *
Î–e
 = -123456789;

193 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

194 *
Î–e
 = 
	`št£tRªdom
(
£tobj
->
±r
);

195 *
obj–e
 = 
NULL
;

197 
	`£rv”Pªic
("Unknown setƒncoding");

199  
£tobj
->
’codšg
;

200 
	}
}

202 
	$£tTy³Size
(
robj
 *
subjeù
) {

203 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

204  
	`diùSize
((
diù
*)
subjeù
->
±r
);

205 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

206  
	`št£tL’
((
št£t
*)
subjeù
->
±r
);

208 
	`£rv”Pªic
("Unknown setƒncoding");

210 
	}
}

215 
	$£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
) {

216 
£tTy³I‹¿tÜ
 *
si
;

217 
	`£rv”As£¹W™hInfo
(
NULL
,
£tobj
,£tobj->
ty³
 =ğ
OBJ_SET
 &&

218 
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
);

220 ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

221 
št64_t
 
š‹Ë
;

222 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

223 
robj
 *
–em’t
;

226 
	`diùEx·nd
(
d
,
	`št£tL’
(
£tobj
->
±r
));

229 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

230 
	`£tTy³Next
(
si
,&
–em’t
,&
š‹Ë
) != -1) {

231 
–em’t
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
š‹Ë
);

232 
	`£rv”As£¹W™hInfo
(
NULL
,
–em’t
,

233 
	`diùAdd
(
d
,
–em’t
,
NULL
è=ğ
DICT_OK
);

235 
	`£tTy³R–—£I‹¿tÜ
(
si
);

237 
£tobj
->
’codšg
 = 
OBJ_ENCODING_HT
;

238 
	`dä“
(
£tobj
->
±r
);

239 
£tobj
->
±r
 = 
d
;

241 
	`£rv”Pªic
("Unsupported set conversion");

243 
	}
}

245 
	$§ddCommªd
(
ş›Á
 *
c
) {

246 
robj
 *
£t
;

247 
j
, 
added
 = 0;

248 
expœed
 = 0;

250 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

251 
	`lockDbWr™e
(
c
->
db
);

252 
£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

253 ià(
£t
 =ğ
NULL
) {

254 
£t
 = 
	`£tTy³C»©e
(
c
->
¬gv
[2]);

255 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
£t
);

257 ià(
£t
->
ty³
 !ğ
OBJ_SET
) {

258 
	`uÆockDb
(
c
->
db
);

259 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

260 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

265 
j
 = 2; j < 
c
->
¬gc
; j++) {

266 
c
->
¬gv
[
j
] = 
	`ŒyObjeùEncodšg
(c->argv[j]);

267 ià(
	`£tTy³Add
(
£t
,
c
->
¬gv
[
j
])è
added
++;

269 ià(
added
) {

270 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

271 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[1],c->
db
->
id
);

273 
c
->
v–
->
dœty
 +ğ
added
;

274 
	`addR•lyLÚgLÚg
(
c
,
added
);

275 
	`uÆockDb
(
c
->
db
);

276 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

277 
	}
}

279 
	$¤emCommªd
(
ş›Á
 *
c
) {

280 
robj
 *
£t
;

281 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

282 
expœed
 = 0;

284 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

285 
	`lockDbWr™e
(
c
->
db
);

286 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

287 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

288 
	`uÆockDb
(
c
->
db
);

289 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

293 
j
 = 2; j < 
c
->
¬gc
; j++) {

294 ià(
	`£tTy³Remove
(
£t
,
c
->
¬gv
[
j
])) {

295 
d–‘ed
++;

296 ià(
	`£tTy³Size
(
£t
) == 0) {

297 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

298 
key»moved
 = 1;

303 ià(
d–‘ed
) {

304 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

305 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

306 ià(
key»moved
)

307 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

308 
c
->
db
->
id
);

309 
c
->
v–
->
dœty
 +ğ
d–‘ed
;

311 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

312 
	`uÆockDb
(
c
->
db
);

313 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

314 
	}
}

316 
	$smoveCommªd
(
ş›Á
 *
c
) {

317 
robj
 *
¤c£t
, *
d¡£t
, *
–e
;

318 
¤c£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
NULL
);

319 
d¡£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
);

320 
–e
 = 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

323 ià(
¤c£t
 =ğ
NULL
) {

324 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

330 ià(
	`checkTy³
(
c
,
¤c£t
,
OBJ_SET
) ||

331 (
d¡£t
 && 
	`checkTy³
(
c
,d¡£t,
OBJ_SET
))) ;

334 ià(
¤c£t
 =ğ
d¡£t
) {

335 
	`addR•ly
(
c
,
	`£tTy³IsMemb”
(
¤c£t
,
–e
è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

340 ià(!
	`£tTy³Remove
(
¤c£t
,
–e
)) {

341 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

344 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

347 ià(
	`£tTy³Size
(
¤c£t
) == 0) {

348 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

349 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

351 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

352 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

353 
£rv”
.
dœty
++;

356 ià(!
d¡£t
) {

357 
d¡£t
 = 
	`£tTy³C»©e
(
–e
);

358 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
d¡£t
);

362 ià(
	`£tTy³Add
(
d¡£t
,
–e
)) {

363 
£rv”
.
dœty
++;

364 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[2],c->
db
->
id
);

366 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

367 
	}
}

369 
	$sismemb”Commªd
(
ş›Á
 *
c
) {

370 
robj
 *
£t
;

372 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

373 
	`lockDbR—d
(
c
->
db
);

374 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

375 
	`uÆockDb
(
c
->
db
);

376 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

378 } ià(
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

379 
	`uÆockDb
(
c
->
db
);

380 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

384 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

385 ià(
	`£tTy³IsMemb”
(
£t
,
c
->
¬gv
[2]))

386 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

388 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

390 
	`uÆockDb
(
c
->
db
);

391 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

392 
	}
}

394 
	$sÿrdCommªd
(
ş›Á
 *
c
) {

395 
robj
 *
o
;

397 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

398 
	`lockDbR—d
(
c
->
db
);

399 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

400 
	`uÆockDb
(
c
->
db
);

401 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

403 } ià(
	`checkTy³
(
c
,
o
,
OBJ_SET
)) {

404 
	`uÆockDb
(
c
->
db
);

405 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

409 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
o
));

410 
	`uÆockDb
(
c
->
db
);

411 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

412 
	}
}

414 
	$smemb”sG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
£t
)

416 
£tTy³I‹¿tÜ
 *
si
;

417 
robj
 *
–eobj
;

418 
št64_t
 
štobj
;

419 
’codšg
;

421 
	`addR•lyMuÉiBulkL’
(
c
, 
	`£tTy³Size
(
£t
));

422 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

423 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–eobj
,&
štobj
)) != -1) {

424 ià(
’codšg
 =ğ
OBJ_ENCODING_HT
) {

425 
	`addR•lyBulk
(
c
, 
–eobj
);

426 } ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

427 
	`addR•lyBulkLÚgLÚg
(
c
, 
štobj
);

430 
	`£tTy³R–—£I‹¿tÜ
(
si
);

431 
	}
}

439 
	#SPOP_MOVE_STRATEGY_MUL
 5

	)

441 
	$¥İW™hCouÁCommªd
(
ş›Á
 *
c
) {

442 
l
;

443 
couÁ
, 
size
;

444 
robj
 *
£t
;

445 
expœed
 = 0;

448 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
VR_OK
) ;

449 ià(
l
 >= 0) {

450 
couÁ
 = (è
l
;

452 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

456 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

457 
	`lockDbWr™e
(
c
->
db
);

460 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
,&
expœed
))

461 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

462 
	`uÆockDb
(
c
->
db
);

463 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

469 ià(
couÁ
 == 0) {

470 
	`uÆockDb
(
c
->
db
);

471 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

472 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

476 
size
 = 
	`£tTy³Size
(
£t
);

479 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

480 
c
->
v–
->
dœty
 +ğ
couÁ
;

485 ià(
couÁ
 >ğ
size
) {

486 
robj
 *
aux
;

489 
	`smemb”sG’”icCommªd
(
c
, 
£t
);

492 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

493 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

496 
aux
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
c
->
¬gv
[1]);

497 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
sh¬ed
.
d–
,
aux
);

498 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

499 
c
->
v–
->
dœty
++;

500 
	`uÆockDb
(
c
->
db
);

501 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

508 
robj
 *
´İ¬gv
[3];

509 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("SREM",4);

510 
´İ¬gv
[1] = 
c
->
¬gv
[1];

511 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

514 
robj
 *
obj–e
;

515 
’codšg
;

516 
št64_t
 
Î–e
;

517 
»maššg
 = 
size
-
couÁ
;

526 ià(
»maššg
*
SPOP_MOVE_STRATEGY_MUL
 > 
couÁ
) {

527 
couÁ
--) {

528 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
obj–e
,&
Î–e
);

529 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

530 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

532 
obj–e
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(objele);

536 
	`addR•lyBulk
(
c
,
obj–e
);

537 
	`£tTy³Remove
(
£t
,
obj–e
);

540 
´İ¬gv
[2] = 
obj–e
;

541 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

542 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

543 
	`ä“Objeù
(
obj–e
);

554 
robj
 *
Ãw£t
 = 
NULL
;

557 
»maššg
--) {

558 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
obj–e
,&
Î–e
);

559 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

560 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

562 ià(!
Ãw£t
èÃw£ˆğ
	`£tTy³C»©e
(
obj–e
);

563 
	`£tTy³Add
(
Ãw£t
,
obj–e
);

564 
	`£tTy³Remove
(
£t
,
obj–e
);

565 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

566 
	`ä“Objeù
(
obj–e
);

570 
£tTy³I‹¿tÜ
 *
si
;

571 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

572 (
’codšg
 = 
	`£tTy³Next
(
si
,&
obj–e
,&
Î–e
)) != -1) {

573 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

574 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

575 
	`addR•lyBulk
(
c
,
obj–e
);

578 
´İ¬gv
[2] = 
obj–e
;

579 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

580 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

581 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

582 
	`ä“Objeù
(
obj–e
);

584 
	`£tTy³R–—£I‹¿tÜ
(
si
);

587 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw£t
);

594 
	`ä“Objeù
(
´İ¬gv
[0]);

595 
	`´ev’tCommªdPrİag©iÚ
(
c
);

596 
	`uÆockDb
(
c
->
db
);

597 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

598 
	}
}

600 
	$¥İCommªd
(
ş›Á
 *
c
) {

601 
robj
 *
£t
, *
–e
, *
aux1
, *
aux2
;

602 
št64_t
 
Î–e
;

603 
’codšg
;

604 
expœed
 = 0;

606 ià(
c
->
¬gc
 == 3) {

607 
	`¥İW™hCouÁCommªd
(
c
);

609 } ià(
c
->
¬gc
 > 3) {

610 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

614 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

615 
	`lockDbWr™e
(
c
->
db
);

618 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
,&
expœed
)è=ğ
NULL
 ||

619 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

620 
	`uÆockDb
(
c
->
db
);

621 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

626 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

629 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

630 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

631 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

633 
–e
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(ele);

634 
	`£tTy³Remove
(
£t
,
–e
);

637 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

640 
aux1
 = 
	`ü—‹SŒšgObjeù
("SREM",4);

641 
aux2
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
c
->
¬gv
[1]);

642 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,3,
aux1
,
aux2
,
–e
);

645 
	`addR•lyBulk
(
c
,
–e
);

648 ià(
	`£tTy³Size
(
£t
) == 0) {

649 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

650 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

654 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

655 
c
->
v–
->
dœty
++;

656 
	`uÆockDb
(
c
->
db
);

657 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

658 
	}
}

666 
	#SRANDMEMBER_SUB_STRATEGY_MUL
 3

	)

668 
	$¤ªdmemb”W™hCouÁCommªd
(
ş›Á
 *
c
) {

669 
l
;

670 
couÁ
, 
size
;

671 
uniq
 = 1;

672 
robj
 *
£t
, *
–e
;

673 
št64_t
 
Î–e
;

674 
’codšg
;

676 
diù
 *
d
;

678 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
VR_OK
) ;

679 ià(
l
 >= 0) {

680 
couÁ
 = (è
l
;

684 
couÁ
 = -
l
;

685 
uniq
 = 0;

688 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

689 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

690 
size
 = 
	`£tTy³Size
(
£t
);

693 ià(
couÁ
 == 0) {

694 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

702 ià(!
uniq
) {

703 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

704 
couÁ
--) {

705 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

706 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

707 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

709 
	`addR•lyBulk
(
c
,
–e
);

718 ià(
couÁ
 >ğ
size
) {

720 
	`smemb”sG’”icCommªd
(
c
, 
£t
);

725 
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

736 ià(
couÁ
*
SRANDMEMBER_SUB_STRATEGY_MUL
 > 
size
) {

737 
£tTy³I‹¿tÜ
 *
si
;

740 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

741 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–e
,&
Î–e
)) != -1) {

742 
»tv®
 = 
DICT_ERR
;

744 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

745 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
),
NULL
);

747 
»tv®
 = 
	`diùAdd
(
d
,
	`dupSŒšgObjeù
(
–e
),
NULL
);

749 
	`ASSERT
(
»tv®
 =ğ
DICT_OK
);

751 
	`£tTy³R–—£I‹¿tÜ
(
si
);

752 
	`ASSERT
(
	`diùSize
(
d
è=ğ
size
);

755 
size
 > 
couÁ
) {

756 
diùEÁry
 *
de
;

758 
de
 = 
	`diùG‘RªdomKey
(
d
);

759 
	`diùD–‘e
(
d
,
	`diùG‘Key
(
de
));

760 
size
--;

769 
added
 = 0;

771 
added
 < 
couÁ
) {

772 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

773 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

774 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

776 
–e
 = 
	`dupSŒšgObjeù
(ele);

781 ià(
	`diùAdd
(
d
,
–e
,
NULL
è=ğ
DICT_OK
)

782 
added
++;

784 
	`deüRefCouÁ
(
–e
);

790 
diùI‹¿tÜ
 *
di
;

791 
diùEÁry
 *
de
;

793 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

794 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

795 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

796 
	`addR•lyBulk
(
c
,
	`diùG‘Key
(
de
));

797 
	`diùR–—£I‹¿tÜ
(
di
);

798 
	`diùR–—£
(
d
);

800 
	}
}

802 
	$¤ªdmemb”Commªd
(
ş›Á
 *
c
) {

803 
robj
 *
£t
, *
–e
;

804 
št64_t
 
Î–e
;

805 
’codšg
;

807 ià(
c
->
¬gc
 == 3) {

808 
	`¤ªdmemb”W™hCouÁCommªd
(
c
);

810 } ià(
c
->
¬gc
 > 3) {

811 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

815 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

816 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

818 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

819 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

820 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

822 
	`addR•lyBulk
(
c
,
–e
);

824 
	}
}

826 
	$smemb”sCommªd
(
ş›Á
 *
c
) {

827 
robj
 *
£t
;

829 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

830 
	`lockDbR—d
(
c
->
db
);

831 
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
);

832 ià(
£t
 =ğ
NULL
) {

833 
	`uÆockDb
(
c
->
db
);

834 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

836 } if(
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

837 
	`uÆockDb
(
c
->
db
);

838 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

842 
	`smemb”sG’”icCommªd
(
c
, 
£t
);

843 
	`uÆockDb
(
c
->
db
);

844 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

845 
	}
}

847 
	$qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

848  
	`£tTy³Size
(*(
robj
**)
s1
)-£tTy³Size(*Ôobj**)
s2
);

849 
	}
}

853 
	$qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

854 
robj
 *
o1
 = *Ôobj**)
s1
, *
o2
 = *Ôobj**)
s2
;

856  (
o2
 ? 
	`£tTy³Size
(o2è: 0è- (
o1
 ? setTypeSize(o1) : 0);

857 
	}
}

859 
	$sš‹rG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
,

860 
£Šum
, 
robj
 *
d¡key
) {

861 
£tTy³I‹¿tÜ
 *
si
;

862 
robj
 *
–eobj
, *
d¡£t
 = 
NULL
;

863 
št64_t
 
štobj
;

864 
j
, 
ÿrdš®™y
 = 0;

865 
’codšg
;

866 
robj
 *
£tobj
, *
mš_Ën_£t
;

867 
mš_Ën
 = -1;

868 
mš_Ën_idx
 = 0;

870 
j
 = 0; j < 
£Šum
; j++) {

871 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

872 
	`lockDbR—d
(
c
->
db
);

873 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

874 ià(!
£tobj
) {

875 
	`uÆockDb
(
c
->
db
);

876 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_mis£s
,1);

877 ià(
d¡key
) {

878 
	`ãtchIÁ”ÇlDbByKey
(
c
,
d¡key
);

879 
	`lockDbWr™e
(
c
->
db
);

880 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

881 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

882 
c
->
v–
->
dœty
++;

884 
	`uÆockDb
(
c
->
db
);

885 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

887 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

891 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

892 
	`uÆockDb
(
c
->
db
);

893 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

897 ià(
mš_Ën
 =ğ-1 || 
	`£tTy³Size
(
£tobj
) < min_len) {

898 
mš_Ën
 = 
	`£tTy³Size
(
£tobj
);

899 
mš_Ën_idx
 = 
j
;

902 
	`uÆockDb
(
c
->
db
);

903 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

906 
mš_Ën_£t
 = 
	`ü—‹IÁ£tObjeù
();

907 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
mš_Ën_idx
]);

908 
	`lockDbR—d
(
c
->
db
);

909 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
mš_Ën_idx
]);

910 ià(!
£tobj
) {

911 
	`uÆockDb
(
c
->
db
);

912 
	`ä“Objeù
(
mš_Ën_£t
);

913 
dÚe
;

915 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

916 
	`uÆockDb
(
c
->
db
);

917 
	`ä“Objeù
(
mš_Ën_£t
);

920 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

921 (
–eobj
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

922 
	`£tTy³Add
(
mš_Ën_£t
,
–eobj
);

923 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

924 
	`ä“Objeù
(
–eobj
);

926 
	`£tTy³R–—£I‹¿tÜ
(
si
);

927 
	`uÆockDb
(
c
->
db
);

929 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

934 
si
 = 
	`£tTy³In™I‹¿tÜ
(
mš_Ën_£t
);

935 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–eobj
,&
štobj
)) != -1) {

936 
j
 = 0; j < 
£Šum
; j++) {

937 ià(
j
 =ğ
mš_Ën_idx
) ;

938 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

939 
	`lockDbR—d
(
c
->
db
);

940 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

941 ià(!
£tobj
) {

942 
	`uÆockDb
(
c
->
db
);

943 
	`ä“Objeù
(
mš_Ën_£t
);

944 ià(
d¡£t
) {

945 
	`ä“Objeù
(
d¡£t
);

946 
d¡£t
 = 
NULL
;

948 
	`£tTy³R–—£I‹¿tÜ
(
si
);

949 
dÚe
;

951 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

952 
	`uÆockDb
(
c
->
db
);

953 
	`ä“Objeù
(
mš_Ën_£t
);

954 ià(
d¡£t
) {

955 
	`ä“Objeù
(
d¡£t
);

956 
d¡£t
 = 
NULL
;

958 
	`£tTy³R–—£I‹¿tÜ
(
si
);

962 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

964 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
 &&

965 !
	`št£tFšd
((
št£t
*)
£tobj
->
±r
,
štobj
))

967 
	`uÆockDb
(
c
->
db
);

972 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

973 
–eobj
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
štobj
);

974 ià(!
	`£tTy³IsMemb”
(
£tobj
,
–eobj
)) {

975 
	`uÆockDb
(
c
->
db
);

976 
	`ä“Objeù
(
–eobj
);

979 
	`ä“Objeù
(
–eobj
);

981 } ià(
’codšg
 =ğ
OBJ_ENCODING_HT
) {

985 ià(
–eobj
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

986 
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
 &&

987 !
	`št£tFšd
((
št£t
*)
£tobj
->
±r
,()
–eobj
->ptr))

989 
	`uÆockDb
(
c
->
db
);

993 } ià(!
	`£tTy³IsMemb”
(
£tobj
,
–eobj
)) {

994 
	`uÆockDb
(
c
->
db
);

998 
	`uÆockDb
(
c
->
db
);

1002 ià(
j
 =ğ
£Šum
) {

1003 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1004 
–eobj
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
štobj
);

1005 
	`£tTy³Add
(
d¡£t
,
–eobj
);

1006 
	`ä“Objeù
(
–eobj
);

1008 
	`£tTy³Add
(
d¡£t
,
–eobj
);

1010 
ÿrdš®™y
 ++;

1013 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1014 
	`ä“Objeù
(
mš_Ën_£t
);

1016 
dÚe
:

1017 ià(
d¡key
) {

1018 
	`ãtchIÁ”ÇlDbByKey
(
c
,
d¡key
);

1019 
	`lockDbWr™e
(
c
->
db
);

1022 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

1023 ià(
d¡£t
 && 
	`£tTy³Size
(dstset) > 0) {

1024 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

1025 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

1026 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"sinterstore",

1027 
d¡key
,
c
->
db
->
id
);

1029 ià(
d¡£t
) {

1030 
	`ä“Objeù
(
d¡£t
);

1031 
d¡£t
 = 
NULL
;

1033 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1034 ià(
d–‘ed
)

1035 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

1036 
d¡key
,
c
->
db
->
id
);

1038 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

1039 
	`uÆockDb
(
c
->
db
);

1040 
c
->
v–
->
dœty
++;

1042 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

1043 ià(
d¡£t
 && 
	`£tTy³Size
(dstset) > 0) {

1044 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

1045 (
–eobj
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1046 
	`addR•lyBulk
(
c
,
–eobj
);

1047 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1048 
	`ä“Objeù
(
–eobj
);

1050 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1052 ià(
d¡£t
è
	`ä“Objeù
(dstset);

1054 
	}
}

1056 
	$sš‹rCommªd
(
ş›Á
 *
c
) {

1057 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
);

1058 
	}
}

1060 
	$sš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

1061 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->argv[1]);

1062 
	}
}

1064 
	#SET_OP_UNION
 0

	)

1065 
	#SET_OP_DIFF
 1

	)

1066 
	#SET_OP_INTER
 2

	)

1068 
	$suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

1069 
robj
 *
d¡key
, 
İ
) {

1070 
£tTy³I‹¿tÜ
 *
si
;

1071 
robj
 *
–e
, *
d¡£t
 = 
NULL
;

1072 
j
, 
ÿrdš®™y
 = 0;

1073 
diff_®go
 = 1;

1074 
robj
 *
£tobj
;

1075 
®go_Úe_wÜk
 = 0, 
®go_two_wÜk
 = 0;

1076 
fœ¡_Ëngth
 = 0;

1078 
j
 = 0; j < 
£Šum
; j++) {

1079 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

1080 
	`lockDbR—d
(
c
->
db
);

1081 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

1082 ià(!
£tobj
) {

1083 
	`uÆockDb
(
c
->
db
);

1084 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_mis£s
,1);

1087 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1088 
	`uÆockDb
(
c
->
db
);

1089 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

1093 ià(
İ
 =ğ
SET_OP_DIFF
) {

1094 ià(
j
 =ğ0è
fœ¡_Ëngth
 = 
	`£tTy³Size
(
£tobj
);

1095 
®go_Úe_wÜk
 +ğ
fœ¡_Ëngth
;

1096 
®go_two_wÜk
 +ğ
	`£tTy³Size
(
£tobj
);

1099 
	`uÆockDb
(
c
->
db
);

1100 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

1112 ià(
İ
 =ğ
SET_OP_DIFF
) {

1115 
®go_Úe_wÜk
 /= 2;

1116 
diff_®go
 = (
®go_Úe_wÜk
 <ğ
®go_two_wÜk
) ? 1 : 2;

1122 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

1124 ià(
İ
 =ğ
SET_OP_UNION
) {

1127 
j
 = 0; j < 
£Šum
; j++) {

1128 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

1129 
	`lockDbR—d
(
c
->
db
);

1130 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

1132 ià(!
£tobj
) {

1133 
	`uÆockDb
(
c
->
db
);

1136 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1137 
	`uÆockDb
(
c
->
db
);

1138 
	`ä“Objeù
(
d¡£t
);

1142 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

1143 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1144 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1145 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1146 
	`ä“Objeù
(
–e
);

1148 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1149 
	`uÆockDb
(
c
->
db
);

1151 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
diff_®go
 == 1) {

1160 
robj
 *
fœ¡_£t
;

1162 
fœ¡_£t
 = 
	`ü—‹IÁ£tObjeù
();

1163 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[0]);

1164 
	`lockDbR—d
(
c
->
db
);

1165 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[0]);

1166 ià(!
£tobj
) {

1167 
	`uÆockDb
(
c
->
db
);

1168 
	`ä“Objeù
(
fœ¡_£t
);

1169 
dÚe
;

1171 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1172 
	`uÆockDb
(
c
->
db
);

1173 
	`ä“Objeù
(
d¡£t
);

1174 
	`ä“Objeù
(
fœ¡_£t
);

1177 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

1178 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1179 
	`£tTy³Add
(
fœ¡_£t
,
–e
);

1180 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1181 
	`ä“Objeù
(
–e
);

1183 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1184 
	`uÆockDb
(
c
->
db
);

1186 
si
 = 
	`£tTy³In™I‹¿tÜ
(
fœ¡_£t
);

1187 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1188 
j
 = 1; j < 
£Šum
; j++) {

1189 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

1190 
	`lockDbR—d
(
c
->
db
);

1191 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

1192 ià(!
£tobj
) {

1193 
	`uÆockDb
(
c
->
db
);

1196 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1197 
	`uÆockDb
(
c
->
db
);

1198 
	`ä“Objeù
(
d¡£t
);

1199 
	`ä“Objeù
(
fœ¡_£t
);

1200 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1201 
	`ä“Objeù
(
–e
);

1202 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1205 ià(
	`£tTy³IsMemb”
(
£tobj
,
–e
)) {

1206 
	`uÆockDb
(
c
->
db
);

1209 
	`uÆockDb
(
c
->
db
);

1212 ià(
j
 =ğ
£Šum
) {

1214 
	`£tTy³Add
(
d¡£t
,
–e
);

1215 
ÿrdš®™y
++;

1218 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1219 
	`ä“Objeù
(
–e
);

1221 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1222 
	`ä“Objeù
(
fœ¡_£t
);

1223 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
diff_®go
 == 2) {

1231 
j
 = 0; j < 
£Šum
; j++) {

1232 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[0]);

1233 
	`lockDbR—d
(
c
->
db
);

1234 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[0]);

1235 ià(!
£tobj
) {

1236 ià(
j
 == 0) {

1237 
	`uÆockDb
(
c
->
db
);

1238 
dÚe
;

1241 
	`uÆockDb
(
c
->
db
);

1244 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1245 
	`uÆockDb
(
c
->
db
);

1246 
	`ä“Objeù
(
d¡£t
);

1250 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

1251 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1252 ià(
j
 == 0) {

1253 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1255 ià(
	`£tTy³Remove
(
d¡£t
,
–e
)è
ÿrdš®™y
--;

1257 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1258 
	`ä“Objeù
(
–e
);

1260 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1264 ià(
ÿrdš®™y
 == 0) {

1265 
	`uÆockDb
(
c
->
db
);

1268 
	`uÆockDb
(
c
->
db
);

1272 
dÚe
:

1274 ià(!
d¡key
) {

1275 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

1276 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

1277 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1278 
	`addR•lyBulk
(
c
,
–e
);

1279 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1280 
	`ä“Objeù
(
–e
);

1282 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1283 
	`ä“Objeù
(
d¡£t
);

1285 
	`ãtchIÁ”ÇlDbByKey
(
c
,
d¡key
);

1286 
	`lockDbWr™e
(
c
->
db
);

1289 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

1290 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

1291 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

1292 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

1293 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,

1294 
İ
 =ğ
SET_OP_UNION
 ? "sunionstore" : "sdiffstore",

1295 
d¡key
,
c
->
db
->
id
);

1297 
	`ä“Objeù
(
d¡£t
);

1298 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1299 ià(
d–‘ed
)

1300 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

1301 
d¡key
,
c
->
db
->
id
);

1303 
	`uÆockDb
(
c
->
db
);

1304 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

1305 
c
->
v–
->
dœty
++;

1307 
	}
}

1309 
	$suniÚCommªd
(
ş›Á
 *
c
) {

1310 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_UNION
);

1311 
	}
}

1313 
	$suniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

1314 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_UNION
);

1315 
	}
}

1317 
	$sdiffCommªd
(
ş›Á
 *
c
) {

1318 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_DIFF
);

1319 
	}
}

1321 
	$sdiff¡ÜeCommªd
(
ş›Á
 *
c
) {

1322 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_DIFF
);

1323 
	}
}

1325 
	$ssÿnCommªd
(
ş›Á
 *
c
) {

1326 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_SET
);

1327 
	}
}

	@src/vr_t_set.c

1 
	~<vr_cÜe.h
>

7 
suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

8 
robj
 *
d¡key
, 
İ
);

13 
robj
 *
	$£tTy³C»©e
(
robj
 *
v®ue
) {

14 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,
NULL
è=ğ
VR_OK
)

15  
	`ü—‹IÁ£tObjeù
();

16  
	`ü—‹S‘Objeù
();

17 
	}
}

24 
	$£tTy³Add
(
robj
 *
subjeù
,„obj *
v®ue
) {

25 
Îv®
;

26 
robj
 *
obj
;

27 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

28 
obj
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
v®ue
);

29 ià(
	`diùAdd
(
subjeù
->
±r
,
obj
,
NULL
è=ğ
DICT_OK
) {

32 
	`ä“Objeù
(
obj
);

34 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

35 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
VR_OK
) {

36 
ušt8_t
 
sucûss
 = 0;

37 
subjeù
->
±r
 = 
	`št£tAdd
(subjeù->±r,
Îv®
,&
sucûss
);

38 ià(
sucûss
) {

41 ià(
	`št£tL’
(
subjeù
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

42 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

47 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

48 
obj
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
v®ue
);

51 
	`£rv”As£¹W™hInfo
(
NULL
,
obj
,

52 
	`diùAdd
(
subjeù
->
±r
,
obj
,
NULL
è=ğ
DICT_OK
);

56 
	`£rv”Pªic
("Unknown setƒncoding");

59 
	}
}

61 
	$£tTy³Remove
(
robj
 *
£tobj
,„obj *
v®ue
) {

62 
Îv®
;

63 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

64 ià(
	`diùD–‘e
(
£tobj
->
±r
,
v®ue
è=ğ
DICT_OK
) {

65 ià(
	`htN“dsResize
(
£tobj
->
±r
)è
	`diùResize
(setobj->ptr);

68 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

69 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
VR_OK
) {

70 
sucûss
;

71 
£tobj
->
±r
 = 
	`št£tRemove
(£tobj->±r,
Îv®
,&
sucûss
);

72 ià(
sucûss
)  1;

75 
	`£rv”Pªic
("Unknown setƒncoding");

78 
	}
}

80 
	$£tTy³IsMemb”
(
robj
 *
subjeù
,„obj *
v®ue
) {

81 
Îv®
;

82 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

83  
	`diùFšd
((
diù
*)
subjeù
->
±r
,
v®ue
è!ğ
NULL
;

84 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

85 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
VR_OK
) {

86  
	`št£tFšd
((
št£t
*)
subjeù
->
±r
,
Îv®
);

89 
	`£rv”Pªic
("Unknown setƒncoding");

92 
	}
}

94 
£tTy³I‹¿tÜ
 *
	$£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

95 
£tTy³I‹¿tÜ
 *
si
 = 
	`d®loc
((setTypeIterator));

96 
si
->
subjeù
 = subject;

97 
si
->
’codšg
 = 
subjeù
->encoding;

98 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

99 
si
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

100 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

101 
si
->
ii
 = 0;

103 
	`£rv”Pªic
("Unknown setƒncoding");

105  
si
;

106 
	}
}

108 
	$£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
) {

109 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

110 
	`diùR–—£I‹¿tÜ
(
si
->
di
);

111 
	`dä“
(
si
);

112 
	}
}

129 
	$£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
robj
 **
obj–e
, 
št64_t
 *
Î–e
) {

130 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

131 
diùEÁry
 *
de
 = 
	`diùNext
(
si
->
di
);

132 ià(
de
 =ğ
NULL
)  -1;

133 *
obj–e
 = 
	`diùG‘Key
(
de
);

134 *
Î–e
 = -123456789;

135 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

136 ià(!
	`št£tG‘
(
si
->
subjeù
->
±r
,si->
ii
++,
Î–e
))

138 *
obj–e
 = 
NULL
;

140 
	`£rv”Pªic
("Wrong setƒncoding in setTypeNext");

142  
si
->
’codšg
;

143 
	}
}

153 
robj
 *
	$£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
) {

154 
št64_t
 
š‹Ë
;

155 
robj
 *
obj–e
;

156 
’codšg
;

158 
’codšg
 = 
	`£tTy³Next
(
si
,&
obj–e
,&
š‹Ë
);

159 
’codšg
) {

160 -1:  
NULL
;

161 
OBJ_ENCODING_INTSET
:

162  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
š‹Ë
);

163 
OBJ_ENCODING_HT
:

164  
obj–e
;

166 
	`£rv”Pªic
("Unsupportedƒncoding");

168  
NULL
;

169 
	}
}

188 
	$£tTy³RªdomEËm’t
(
robj
 *
£tobj
,„obj **
obj–e
, 
št64_t
 *
Î–e
) {

189 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

190 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£tobj
->
±r
);

191 *
obj–e
 = 
	`diùG‘Key
(
de
);

192 *
Î–e
 = -123456789;

193 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

194 *
Î–e
 = 
	`št£tRªdom
(
£tobj
->
±r
);

195 *
obj–e
 = 
NULL
;

197 
	`£rv”Pªic
("Unknown setƒncoding");

199  
£tobj
->
’codšg
;

200 
	}
}

202 
	$£tTy³Size
(
robj
 *
subjeù
) {

203 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

204  
	`diùSize
((
diù
*)
subjeù
->
±r
);

205 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

206  
	`št£tL’
((
št£t
*)
subjeù
->
±r
);

208 
	`£rv”Pªic
("Unknown setƒncoding");

210 
	}
}

215 
	$£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
) {

216 
£tTy³I‹¿tÜ
 *
si
;

217 
	`£rv”As£¹W™hInfo
(
NULL
,
£tobj
,£tobj->
ty³
 =ğ
OBJ_SET
 &&

218 
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
);

220 ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

221 
št64_t
 
š‹Ë
;

222 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

223 
robj
 *
–em’t
;

226 
	`diùEx·nd
(
d
,
	`št£tL’
(
£tobj
->
±r
));

229 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

230 
	`£tTy³Next
(
si
,&
–em’t
,&
š‹Ë
) != -1) {

231 
–em’t
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
š‹Ë
);

232 
	`£rv”As£¹W™hInfo
(
NULL
,
–em’t
,

233 
	`diùAdd
(
d
,
–em’t
,
NULL
è=ğ
DICT_OK
);

235 
	`£tTy³R–—£I‹¿tÜ
(
si
);

237 
£tobj
->
’codšg
 = 
OBJ_ENCODING_HT
;

238 
	`dä“
(
£tobj
->
±r
);

239 
£tobj
->
±r
 = 
d
;

241 
	`£rv”Pªic
("Unsupported set conversion");

243 
	}
}

245 
	$§ddCommªd
(
ş›Á
 *
c
) {

246 
robj
 *
£t
;

247 
j
, 
added
 = 0;

248 
expœed
 = 0;

250 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

251 
	`lockDbWr™e
(
c
->
db
);

252 
£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

253 ià(
£t
 =ğ
NULL
) {

254 
£t
 = 
	`£tTy³C»©e
(
c
->
¬gv
[2]);

255 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
£t
);

257 ià(
£t
->
ty³
 !ğ
OBJ_SET
) {

258 
	`uÆockDb
(
c
->
db
);

259 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

260 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

265 
j
 = 2; j < 
c
->
¬gc
; j++) {

266 
c
->
¬gv
[
j
] = 
	`ŒyObjeùEncodšg
(c->argv[j]);

267 ià(
	`£tTy³Add
(
£t
,
c
->
¬gv
[
j
])è
added
++;

269 ià(
added
) {

270 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

271 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[1],c->
db
->
id
);

273 
c
->
v–
->
dœty
 +ğ
added
;

274 
	`addR•lyLÚgLÚg
(
c
,
added
);

275 
	`uÆockDb
(
c
->
db
);

276 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

277 
	}
}

279 
	$¤emCommªd
(
ş›Á
 *
c
) {

280 
robj
 *
£t
;

281 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

282 
expœed
 = 0;

284 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

285 
	`lockDbWr™e
(
c
->
db
);

286 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

287 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

288 
	`uÆockDb
(
c
->
db
);

289 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

293 
j
 = 2; j < 
c
->
¬gc
; j++) {

294 ià(
	`£tTy³Remove
(
£t
,
c
->
¬gv
[
j
])) {

295 
d–‘ed
++;

296 ià(
	`£tTy³Size
(
£t
) == 0) {

297 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

298 
key»moved
 = 1;

303 ià(
d–‘ed
) {

304 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

305 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

306 ià(
key»moved
)

307 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

308 
c
->
db
->
id
);

309 
c
->
v–
->
dœty
 +ğ
d–‘ed
;

311 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

312 
	`uÆockDb
(
c
->
db
);

313 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

314 
	}
}

316 
	$smoveCommªd
(
ş›Á
 *
c
) {

317 
robj
 *
¤c£t
, *
d¡£t
, *
–e
;

318 
¤c£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],
NULL
);

319 
d¡£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2],
NULL
);

320 
–e
 = 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

323 ià(
¤c£t
 =ğ
NULL
) {

324 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

330 ià(
	`checkTy³
(
c
,
¤c£t
,
OBJ_SET
) ||

331 (
d¡£t
 && 
	`checkTy³
(
c
,d¡£t,
OBJ_SET
))) ;

334 ià(
¤c£t
 =ğ
d¡£t
) {

335 
	`addR•ly
(
c
,
	`£tTy³IsMemb”
(
¤c£t
,
–e
è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

340 ià(!
	`£tTy³Remove
(
¤c£t
,
–e
)) {

341 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

344 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

347 ià(
	`£tTy³Size
(
¤c£t
) == 0) {

348 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

349 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

351 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

352 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

353 
£rv”
.
dœty
++;

356 ià(!
d¡£t
) {

357 
d¡£t
 = 
	`£tTy³C»©e
(
–e
);

358 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
d¡£t
);

362 ià(
	`£tTy³Add
(
d¡£t
,
–e
)) {

363 
£rv”
.
dœty
++;

364 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[2],c->
db
->
id
);

366 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

367 
	}
}

369 
	$sismemb”Commªd
(
ş›Á
 *
c
) {

370 
robj
 *
£t
;

372 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

373 
	`lockDbR—d
(
c
->
db
);

374 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

375 
	`uÆockDb
(
c
->
db
);

376 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

378 } ià(
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

379 
	`uÆockDb
(
c
->
db
);

380 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

384 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

385 ià(
	`£tTy³IsMemb”
(
£t
,
c
->
¬gv
[2]))

386 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

388 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

390 
	`uÆockDb
(
c
->
db
);

391 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

392 
	}
}

394 
	$sÿrdCommªd
(
ş›Á
 *
c
) {

395 
robj
 *
o
;

397 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

398 
	`lockDbR—d
(
c
->
db
);

399 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

400 
	`uÆockDb
(
c
->
db
);

401 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

403 } ià(
	`checkTy³
(
c
,
o
,
OBJ_SET
)) {

404 
	`uÆockDb
(
c
->
db
);

405 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

409 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
o
));

410 
	`uÆockDb
(
c
->
db
);

411 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

412 
	}
}

414 
	$smemb”sG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
£t
)

416 
£tTy³I‹¿tÜ
 *
si
;

417 
robj
 *
–eobj
;

418 
št64_t
 
štobj
;

419 
’codšg
;

421 
	`addR•lyMuÉiBulkL’
(
c
, 
	`£tTy³Size
(
£t
));

422 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

423 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–eobj
,&
štobj
)) != -1) {

424 ià(
’codšg
 =ğ
OBJ_ENCODING_HT
) {

425 
	`addR•lyBulk
(
c
, 
–eobj
);

426 } ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

427 
	`addR•lyBulkLÚgLÚg
(
c
, 
štobj
);

430 
	`£tTy³R–—£I‹¿tÜ
(
si
);

431 
	}
}

439 
	#SPOP_MOVE_STRATEGY_MUL
 5

	)

441 
	$¥İW™hCouÁCommªd
(
ş›Á
 *
c
) {

442 
l
;

443 
couÁ
, 
size
;

444 
robj
 *
£t
;

445 
expœed
 = 0;

448 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
VR_OK
) ;

449 ià(
l
 >= 0) {

450 
couÁ
 = (è
l
;

452 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

456 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

457 
	`lockDbWr™e
(
c
->
db
);

460 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
,&
expœed
))

461 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

462 
	`uÆockDb
(
c
->
db
);

463 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

469 ià(
couÁ
 == 0) {

470 
	`uÆockDb
(
c
->
db
);

471 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

472 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

476 
size
 = 
	`£tTy³Size
(
£t
);

479 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

480 
c
->
v–
->
dœty
 +ğ
couÁ
;

485 ià(
couÁ
 >ğ
size
) {

486 
robj
 *
aux
;

489 
	`smemb”sG’”icCommªd
(
c
, 
£t
);

492 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

493 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

496 
aux
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
c
->
¬gv
[1]);

497 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
sh¬ed
.
d–
,
aux
);

498 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

499 
c
->
v–
->
dœty
++;

500 
	`uÆockDb
(
c
->
db
);

501 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

508 
robj
 *
´İ¬gv
[3];

509 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("SREM",4);

510 
´İ¬gv
[1] = 
c
->
¬gv
[1];

511 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

514 
robj
 *
obj–e
;

515 
’codšg
;

516 
št64_t
 
Î–e
;

517 
»maššg
 = 
size
-
couÁ
;

526 ià(
»maššg
*
SPOP_MOVE_STRATEGY_MUL
 > 
couÁ
) {

527 
couÁ
--) {

528 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
obj–e
,&
Î–e
);

529 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

530 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

532 
obj–e
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(objele);

536 
	`addR•lyBulk
(
c
,
obj–e
);

537 
	`£tTy³Remove
(
£t
,
obj–e
);

540 
´İ¬gv
[2] = 
obj–e
;

541 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

542 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

543 
	`ä“Objeù
(
obj–e
);

554 
robj
 *
Ãw£t
 = 
NULL
;

557 
»maššg
--) {

558 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
obj–e
,&
Î–e
);

559 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

560 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

562 ià(!
Ãw£t
èÃw£ˆğ
	`£tTy³C»©e
(
obj–e
);

563 
	`£tTy³Add
(
Ãw£t
,
obj–e
);

564 
	`£tTy³Remove
(
£t
,
obj–e
);

565 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

566 
	`ä“Objeù
(
obj–e
);

570 
£tTy³I‹¿tÜ
 *
si
;

571 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

572 (
’codšg
 = 
	`£tTy³Next
(
si
,&
obj–e
,&
Î–e
)) != -1) {

573 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

574 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

575 
	`addR•lyBulk
(
c
,
obj–e
);

578 
´İ¬gv
[2] = 
obj–e
;

579 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

580 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

581 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

582 
	`ä“Objeù
(
obj–e
);

584 
	`£tTy³R–—£I‹¿tÜ
(
si
);

587 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw£t
);

594 
	`ä“Objeù
(
´İ¬gv
[0]);

595 
	`´ev’tCommªdPrİag©iÚ
(
c
);

596 
	`uÆockDb
(
c
->
db
);

597 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

598 
	}
}

600 
	$¥İCommªd
(
ş›Á
 *
c
) {

601 
robj
 *
£t
, *
–e
, *
aux1
, *
aux2
;

602 
št64_t
 
Î–e
;

603 
’codšg
;

604 
expœed
 = 0;

606 ià(
c
->
¬gc
 == 3) {

607 
	`¥İW™hCouÁCommªd
(
c
);

609 } ià(
c
->
¬gc
 > 3) {

610 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

614 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

615 
	`lockDbWr™e
(
c
->
db
);

618 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
,&
expœed
)è=ğ
NULL
 ||

619 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

620 
	`uÆockDb
(
c
->
db
);

621 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

626 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

629 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

630 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

631 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

633 
–e
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(ele);

634 
	`£tTy³Remove
(
£t
,
–e
);

637 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

640 
aux1
 = 
	`ü—‹SŒšgObjeù
("SREM",4);

641 
aux2
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
c
->
¬gv
[1]);

642 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,3,
aux1
,
aux2
,
–e
);

645 
	`addR•lyBulk
(
c
,
–e
);

648 ià(
	`£tTy³Size
(
£t
) == 0) {

649 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

650 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

654 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

655 
c
->
v–
->
dœty
++;

656 
	`uÆockDb
(
c
->
db
);

657 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

658 
	}
}

666 
	#SRANDMEMBER_SUB_STRATEGY_MUL
 3

	)

668 
	$¤ªdmemb”W™hCouÁCommªd
(
ş›Á
 *
c
) {

669 
l
;

670 
couÁ
, 
size
;

671 
uniq
 = 1;

672 
robj
 *
£t
, *
–e
;

673 
št64_t
 
Î–e
;

674 
’codšg
;

676 
diù
 *
d
;

678 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
VR_OK
) ;

679 ià(
l
 >= 0) {

680 
couÁ
 = (è
l
;

684 
couÁ
 = -
l
;

685 
uniq
 = 0;

688 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

689 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

690 
size
 = 
	`£tTy³Size
(
£t
);

693 ià(
couÁ
 == 0) {

694 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

702 ià(!
uniq
) {

703 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

704 
couÁ
--) {

705 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

706 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

707 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

709 
	`addR•lyBulk
(
c
,
–e
);

718 ià(
couÁ
 >ğ
size
) {

720 
	`smemb”sG’”icCommªd
(
c
, 
£t
);

725 
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

736 ià(
couÁ
*
SRANDMEMBER_SUB_STRATEGY_MUL
 > 
size
) {

737 
£tTy³I‹¿tÜ
 *
si
;

740 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

741 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–e
,&
Î–e
)) != -1) {

742 
»tv®
 = 
DICT_ERR
;

744 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

745 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
),
NULL
);

747 
»tv®
 = 
	`diùAdd
(
d
,
	`dupSŒšgObjeù
(
–e
),
NULL
);

749 
	`ASSERT
(
»tv®
 =ğ
DICT_OK
);

751 
	`£tTy³R–—£I‹¿tÜ
(
si
);

752 
	`ASSERT
(
	`diùSize
(
d
è=ğ
size
);

755 
size
 > 
couÁ
) {

756 
diùEÁry
 *
de
;

758 
de
 = 
	`diùG‘RªdomKey
(
d
);

759 
	`diùD–‘e
(
d
,
	`diùG‘Key
(
de
));

760 
size
--;

769 
added
 = 0;

771 
added
 < 
couÁ
) {

772 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

773 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

774 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

776 
–e
 = 
	`dupSŒšgObjeù
(ele);

781 ià(
	`diùAdd
(
d
,
–e
,
NULL
è=ğ
DICT_OK
)

782 
added
++;

784 
	`deüRefCouÁ
(
–e
);

790 
diùI‹¿tÜ
 *
di
;

791 
diùEÁry
 *
de
;

793 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

794 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

795 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

796 
	`addR•lyBulk
(
c
,
	`diùG‘Key
(
de
));

797 
	`diùR–—£I‹¿tÜ
(
di
);

798 
	`diùR–—£
(
d
);

800 
	}
}

802 
	$¤ªdmemb”Commªd
(
ş›Á
 *
c
) {

803 
robj
 *
£t
, *
–e
;

804 
št64_t
 
Î–e
;

805 
’codšg
;

807 ià(
c
->
¬gc
 == 3) {

808 
	`¤ªdmemb”W™hCouÁCommªd
(
c
);

810 } ià(
c
->
¬gc
 > 3) {

811 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

815 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

816 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

818 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

819 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

820 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

822 
	`addR•lyBulk
(
c
,
–e
);

824 
	}
}

826 
	$smemb”sCommªd
(
ş›Á
 *
c
) {

827 
robj
 *
£t
;

829 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

830 
	`lockDbR—d
(
c
->
db
);

831 
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
);

832 ià(
£t
 =ğ
NULL
) {

833 
	`uÆockDb
(
c
->
db
);

834 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

836 } if(
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) {

837 
	`uÆockDb
(
c
->
db
);

838 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

842 
	`smemb”sG’”icCommªd
(
c
, 
£t
);

843 
	`uÆockDb
(
c
->
db
);

844 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

845 
	}
}

847 
	$qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

848  
	`£tTy³Size
(*(
robj
**)
s1
)-£tTy³Size(*Ôobj**)
s2
);

849 
	}
}

853 
	$qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

854 
robj
 *
o1
 = *Ôobj**)
s1
, *
o2
 = *Ôobj**)
s2
;

856  (
o2
 ? 
	`£tTy³Size
(o2è: 0è- (
o1
 ? setTypeSize(o1) : 0);

857 
	}
}

859 
	$sš‹rG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
,

860 
£Šum
, 
robj
 *
d¡key
) {

861 
£tTy³I‹¿tÜ
 *
si
;

862 
robj
 *
–eobj
, *
d¡£t
 = 
NULL
;

863 
št64_t
 
štobj
;

864 
j
, 
ÿrdš®™y
 = 0;

865 
’codšg
;

866 
robj
 *
£tobj
, *
mš_Ën_£t
;

867 
mš_Ën
 = -1;

868 
mš_Ën_idx
 = 0;

870 
j
 = 0; j < 
£Šum
; j++) {

871 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

872 
	`lockDbR—d
(
c
->
db
);

873 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

874 ià(!
£tobj
) {

875 
	`uÆockDb
(
c
->
db
);

876 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_mis£s
,1);

877 ià(
d¡key
) {

878 
	`ãtchIÁ”ÇlDbByKey
(
c
,
d¡key
);

879 
	`lockDbWr™e
(
c
->
db
);

880 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

881 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

882 
c
->
v–
->
dœty
++;

884 
	`uÆockDb
(
c
->
db
);

885 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

887 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

891 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

892 
	`uÆockDb
(
c
->
db
);

893 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

897 ià(
mš_Ën
 =ğ-1 || 
	`£tTy³Size
(
£tobj
) < min_len) {

898 
mš_Ën
 = 
	`£tTy³Size
(
£tobj
);

899 
mš_Ën_idx
 = 
j
;

902 
	`uÆockDb
(
c
->
db
);

903 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

906 
mš_Ën_£t
 = 
	`ü—‹IÁ£tObjeù
();

907 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
mš_Ën_idx
]);

908 
	`lockDbR—d
(
c
->
db
);

909 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
mš_Ën_idx
]);

910 ià(!
£tobj
) {

911 
	`uÆockDb
(
c
->
db
);

912 
	`ä“Objeù
(
mš_Ën_£t
);

913 
dÚe
;

915 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

916 
	`uÆockDb
(
c
->
db
);

917 
	`ä“Objeù
(
mš_Ën_£t
);

920 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

921 (
–eobj
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

922 
	`£tTy³Add
(
mš_Ën_£t
,
–eobj
);

923 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

924 
	`ä“Objeù
(
–eobj
);

926 
	`£tTy³R–—£I‹¿tÜ
(
si
);

927 
	`uÆockDb
(
c
->
db
);

929 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

934 
si
 = 
	`£tTy³In™I‹¿tÜ
(
mš_Ën_£t
);

935 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–eobj
,&
štobj
)) != -1) {

936 
j
 = 0; j < 
£Šum
; j++) {

937 ià(
j
 =ğ
mš_Ën_idx
) ;

938 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

939 
	`lockDbR—d
(
c
->
db
);

940 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

941 ià(!
£tobj
) {

942 
	`uÆockDb
(
c
->
db
);

943 
	`ä“Objeù
(
mš_Ën_£t
);

944 ià(
d¡£t
) {

945 
	`ä“Objeù
(
d¡£t
);

946 
d¡£t
 = 
NULL
;

948 
	`£tTy³R–—£I‹¿tÜ
(
si
);

949 
dÚe
;

951 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

952 
	`uÆockDb
(
c
->
db
);

953 
	`ä“Objeù
(
mš_Ën_£t
);

954 ià(
d¡£t
) {

955 
	`ä“Objeù
(
d¡£t
);

956 
d¡£t
 = 
NULL
;

958 
	`£tTy³R–—£I‹¿tÜ
(
si
);

962 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

964 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
 &&

965 !
	`št£tFšd
((
št£t
*)
£tobj
->
±r
,
štobj
))

967 
	`uÆockDb
(
c
->
db
);

972 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

973 
–eobj
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
štobj
);

974 ià(!
	`£tTy³IsMemb”
(
£tobj
,
–eobj
)) {

975 
	`uÆockDb
(
c
->
db
);

976 
	`ä“Objeù
(
–eobj
);

979 
	`ä“Objeù
(
–eobj
);

981 } ià(
’codšg
 =ğ
OBJ_ENCODING_HT
) {

985 ià(
–eobj
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

986 
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
 &&

987 !
	`št£tFšd
((
št£t
*)
£tobj
->
±r
,()
–eobj
->ptr))

989 
	`uÆockDb
(
c
->
db
);

993 } ià(!
	`£tTy³IsMemb”
(
£tobj
,
–eobj
)) {

994 
	`uÆockDb
(
c
->
db
);

998 
	`uÆockDb
(
c
->
db
);

1002 ià(
j
 =ğ
£Šum
) {

1003 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1004 
–eobj
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
štobj
);

1005 
	`£tTy³Add
(
d¡£t
,
–eobj
);

1006 
	`ä“Objeù
(
–eobj
);

1008 
	`£tTy³Add
(
d¡£t
,
–eobj
);

1010 
ÿrdš®™y
 ++;

1013 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1014 
	`ä“Objeù
(
mš_Ën_£t
);

1016 
dÚe
:

1017 ià(
d¡key
) {

1018 
	`ãtchIÁ”ÇlDbByKey
(
c
,
d¡key
);

1019 
	`lockDbWr™e
(
c
->
db
);

1022 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

1023 ià(
d¡£t
 && 
	`£tTy³Size
(dstset) > 0) {

1024 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

1025 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

1026 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"sinterstore",

1027 
d¡key
,
c
->
db
->
id
);

1029 ià(
d¡£t
) {

1030 
	`ä“Objeù
(
d¡£t
);

1031 
d¡£t
 = 
NULL
;

1033 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1034 ià(
d–‘ed
)

1035 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

1036 
d¡key
,
c
->
db
->
id
);

1038 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

1039 
	`uÆockDb
(
c
->
db
);

1040 
c
->
v–
->
dœty
++;

1042 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

1043 ià(
d¡£t
 && 
	`£tTy³Size
(dstset) > 0) {

1044 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

1045 (
–eobj
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1046 
	`addR•lyBulk
(
c
,
–eobj
);

1047 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1048 
	`ä“Objeù
(
–eobj
);

1050 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1052 ià(
d¡£t
è
	`ä“Objeù
(dstset);

1054 
	}
}

1056 
	$sš‹rCommªd
(
ş›Á
 *
c
) {

1057 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
);

1058 
	}
}

1060 
	$sš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

1061 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->argv[1]);

1062 
	}
}

1064 
	#SET_OP_UNION
 0

	)

1065 
	#SET_OP_DIFF
 1

	)

1066 
	#SET_OP_INTER
 2

	)

1068 
	$suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

1069 
robj
 *
d¡key
, 
İ
) {

1070 
£tTy³I‹¿tÜ
 *
si
;

1071 
robj
 *
–e
, *
d¡£t
 = 
NULL
;

1072 
j
, 
ÿrdš®™y
 = 0;

1073 
diff_®go
 = 1;

1074 
robj
 *
£tobj
;

1075 
®go_Úe_wÜk
 = 0, 
®go_two_wÜk
 = 0;

1076 
fœ¡_Ëngth
 = 0;

1078 
j
 = 0; j < 
£Šum
; j++) {

1079 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

1080 
	`lockDbR—d
(
c
->
db
);

1081 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

1082 ià(!
£tobj
) {

1083 
	`uÆockDb
(
c
->
db
);

1084 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_mis£s
,1);

1087 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1088 
	`uÆockDb
(
c
->
db
);

1089 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

1093 ià(
İ
 =ğ
SET_OP_DIFF
) {

1094 ià(
j
 =ğ0è
fœ¡_Ëngth
 = 
	`£tTy³Size
(
£tobj
);

1095 
®go_Úe_wÜk
 +ğ
fœ¡_Ëngth
;

1096 
®go_two_wÜk
 +ğ
	`£tTy³Size
(
£tobj
);

1099 
	`uÆockDb
(
c
->
db
);

1100 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
key¥aû_h™s
,1);

1112 ià(
İ
 =ğ
SET_OP_DIFF
) {

1115 
®go_Úe_wÜk
 /= 2;

1116 
diff_®go
 = (
®go_Úe_wÜk
 <ğ
®go_two_wÜk
) ? 1 : 2;

1122 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

1124 ià(
İ
 =ğ
SET_OP_UNION
) {

1127 
j
 = 0; j < 
£Šum
; j++) {

1128 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

1129 
	`lockDbR—d
(
c
->
db
);

1130 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

1132 ià(!
£tobj
) {

1133 
	`uÆockDb
(
c
->
db
);

1136 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1137 
	`uÆockDb
(
c
->
db
);

1138 
	`ä“Objeù
(
d¡£t
);

1142 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

1143 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1144 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1145 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1146 
	`ä“Objeù
(
–e
);

1148 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1149 
	`uÆockDb
(
c
->
db
);

1151 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
diff_®go
 == 1) {

1160 
robj
 *
fœ¡_£t
;

1162 
fœ¡_£t
 = 
	`ü—‹IÁ£tObjeù
();

1163 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[0]);

1164 
	`lockDbR—d
(
c
->
db
);

1165 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[0]);

1166 ià(!
£tobj
) {

1167 
	`uÆockDb
(
c
->
db
);

1168 
	`ä“Objeù
(
fœ¡_£t
);

1169 
dÚe
;

1171 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1172 
	`uÆockDb
(
c
->
db
);

1173 
	`ä“Objeù
(
d¡£t
);

1174 
	`ä“Objeù
(
fœ¡_£t
);

1177 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

1178 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1179 
	`£tTy³Add
(
fœ¡_£t
,
–e
);

1180 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1181 
	`ä“Objeù
(
–e
);

1183 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1184 
	`uÆockDb
(
c
->
db
);

1186 
si
 = 
	`£tTy³In™I‹¿tÜ
(
fœ¡_£t
);

1187 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1188 
j
 = 1; j < 
£Šum
; j++) {

1189 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[
j
]);

1190 
	`lockDbR—d
(
c
->
db
);

1191 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

1192 ià(!
£tobj
) {

1193 
	`uÆockDb
(
c
->
db
);

1196 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1197 
	`uÆockDb
(
c
->
db
);

1198 
	`ä“Objeù
(
d¡£t
);

1199 
	`ä“Objeù
(
fœ¡_£t
);

1200 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1201 
	`ä“Objeù
(
–e
);

1202 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1205 ià(
	`£tTy³IsMemb”
(
£tobj
,
–e
)) {

1206 
	`uÆockDb
(
c
->
db
);

1209 
	`uÆockDb
(
c
->
db
);

1212 ià(
j
 =ğ
£Šum
) {

1214 
	`£tTy³Add
(
d¡£t
,
–e
);

1215 
ÿrdš®™y
++;

1218 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1219 
	`ä“Objeù
(
–e
);

1221 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1222 
	`ä“Objeù
(
fœ¡_£t
);

1223 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
diff_®go
 == 2) {

1231 
j
 = 0; j < 
£Šum
; j++) {

1232 
	`ãtchIÁ”ÇlDbByKey
(
c
,
£tkeys
[0]);

1233 
	`lockDbR—d
(
c
->
db
);

1234 
£tobj
 = 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[0]);

1235 ià(!
£tobj
) {

1236 ià(
j
 == 0) {

1237 
	`uÆockDb
(
c
->
db
);

1238 
dÚe
;

1241 
	`uÆockDb
(
c
->
db
);

1244 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

1245 
	`uÆockDb
(
c
->
db
);

1246 
	`ä“Objeù
(
d¡£t
);

1250 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

1251 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1252 ià(
j
 == 0) {

1253 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1255 ià(
	`£tTy³Remove
(
d¡£t
,
–e
)è
ÿrdš®™y
--;

1257 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1258 
	`ä“Objeù
(
–e
);

1260 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1264 ià(
ÿrdš®™y
 == 0) {

1265 
	`uÆockDb
(
c
->
db
);

1268 
	`uÆockDb
(
c
->
db
);

1272 
dÚe
:

1274 ià(!
d¡key
) {

1275 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

1276 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

1277 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1278 
	`addR•lyBulk
(
c
,
–e
);

1279 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

1280 
	`ä“Objeù
(
–e
);

1282 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1283 
	`ä“Objeù
(
d¡£t
);

1285 
	`ãtchIÁ”ÇlDbByKey
(
c
,
d¡key
);

1286 
	`lockDbWr™e
(
c
->
db
);

1289 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

1290 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

1291 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

1292 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

1293 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,

1294 
İ
 =ğ
SET_OP_UNION
 ? "sunionstore" : "sdiffstore",

1295 
d¡key
,
c
->
db
->
id
);

1297 
	`ä“Objeù
(
d¡£t
);

1298 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1299 ià(
d–‘ed
)

1300 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

1301 
d¡key
,
c
->
db
->
id
);

1303 
	`uÆockDb
(
c
->
db
);

1304 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

1305 
c
->
v–
->
dœty
++;

1307 
	}
}

1309 
	$suniÚCommªd
(
ş›Á
 *
c
) {

1310 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_UNION
);

1311 
	}
}

1313 
	$suniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

1314 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_UNION
);

1315 
	}
}

1317 
	$sdiffCommªd
(
ş›Á
 *
c
) {

1318 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_DIFF
);

1319 
	}
}

1321 
	$sdiff¡ÜeCommªd
(
ş›Á
 *
c
) {

1322 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_DIFF
);

1323 
	}
}

1325 
	$ssÿnCommªd
(
ş›Á
 *
c
) {

1326 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_SET
);

1327 
	}
}

	@src/vr_t_set.h

1 #iâdeà
_VR_T_SET_H_


2 
	#_VR_T_SET_H_


	)

4 
robj
 *
£tTy³C»©e
Ôobj *
v®ue
);

5 
£tTy³Add
(
robj
 *
subjeù
,„obj *
v®ue
);

6 
£tTy³Remove
(
robj
 *
£tobj
,„obj *
v®ue
);

7 
£tTy³IsMemb”
(
robj
 *
subjeù
,„obj *
v®ue
);

8 
£tTy³I‹¿tÜ
 *
£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

9 
£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
);

10 
£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
robj
 **
obj–e
, 
št64_t
 *
Î–e
);

11 
robj
 *
£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
);

12 
£tTy³RªdomEËm’t
(
robj
 *
£tobj
,„obj **
obj–e
, 
št64_t
 *
Î–e
);

14 
£tTy³Size
(
robj
 *
subjeù
);

15 
£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
);

16 
§ddCommªd
(
ş›Á
 *
c
);

17 
¤emCommªd
(
ş›Á
 *
c
);

18 
smoveCommªd
(
ş›Á
 *
c
);

19 
sismemb”Commªd
(
ş›Á
 *
c
);

20 
sÿrdCommªd
(
ş›Á
 *
c
);

21 
¥İW™hCouÁCommªd
(
ş›Á
 *
c
);

22 
¥İCommªd
(
ş›Á
 *
c
);

23 
¤ªdmemb”W™hCouÁCommªd
(
ş›Á
 *
c
);

24 
¤ªdmemb”Commªd
(
ş›Á
 *
c
);

25 
smemb”sCommªd
(
ş›Á
 *
c
);

26 
qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
);

27 
qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
);

28 
sš‹rG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,„obj *
d¡key
);

29 
sš‹rCommªd
(
ş›Á
 *
c
);

30 
sš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

31 
suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,„obj *
d¡key
, 
İ
);

32 
suniÚCommªd
(
ş›Á
 *
c
);

33 
suniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

34 
sdiffCommªd
(
ş›Á
 *
c
);

35 
sdiff¡ÜeCommªd
(
ş›Á
 *
c
);

36 
ssÿnCommªd
(
ş›Á
 *
c
);

	@src/vr_t_set.h

1 #iâdeà
_VR_T_SET_H_


2 
	#_VR_T_SET_H_


	)

4 
robj
 *
£tTy³C»©e
Ôobj *
v®ue
);

5 
£tTy³Add
(
robj
 *
subjeù
,„obj *
v®ue
);

6 
£tTy³Remove
(
robj
 *
£tobj
,„obj *
v®ue
);

7 
£tTy³IsMemb”
(
robj
 *
subjeù
,„obj *
v®ue
);

8 
£tTy³I‹¿tÜ
 *
£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

9 
£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
);

10 
£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
robj
 **
obj–e
, 
št64_t
 *
Î–e
);

11 
robj
 *
£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
);

12 
£tTy³RªdomEËm’t
(
robj
 *
£tobj
,„obj **
obj–e
, 
št64_t
 *
Î–e
);

14 
£tTy³Size
(
robj
 *
subjeù
);

15 
£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
);

16 
§ddCommªd
(
ş›Á
 *
c
);

17 
¤emCommªd
(
ş›Á
 *
c
);

18 
smoveCommªd
(
ş›Á
 *
c
);

19 
sismemb”Commªd
(
ş›Á
 *
c
);

20 
sÿrdCommªd
(
ş›Á
 *
c
);

21 
¥İW™hCouÁCommªd
(
ş›Á
 *
c
);

22 
¥İCommªd
(
ş›Á
 *
c
);

23 
¤ªdmemb”W™hCouÁCommªd
(
ş›Á
 *
c
);

24 
¤ªdmemb”Commªd
(
ş›Á
 *
c
);

25 
smemb”sCommªd
(
ş›Á
 *
c
);

26 
qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
);

27 
qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
);

28 
sš‹rG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,„obj *
d¡key
);

29 
sš‹rCommªd
(
ş›Á
 *
c
);

30 
sš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

31 
suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,„obj *
d¡key
, 
İ
);

32 
suniÚCommªd
(
ş›Á
 *
c
);

33 
suniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

34 
sdiffCommªd
(
ş›Á
 *
c
);

35 
sdiff¡ÜeCommªd
(
ş›Á
 *
c
);

36 
ssÿnCommªd
(
ş›Á
 *
c
);

	@src/vr_t_string.c

1 
	~<vr_cÜe.h
>

7 
	$checkSŒšgL’gth
(
ş›Á
 *
c
, 
size
) {

8 ià(
size
 > 512*1024*1024) {

9 
	`addR•lyE¼Ü
(
c
,"stringƒxceeds maximum‡llowed size (512MB)");

10  
VR_ERROR
;

12  
VR_OK
;

13 
	}
}

31 
	#OBJ_SET_NO_FLAGS
 0

	)

32 
	#OBJ_SET_NX
 (1<<0è

	)

33 
	#OBJ_SET_XX
 (1<<1è

	)

34 
	#OBJ_SET_EX
 (1<<2è

	)

35 
	#OBJ_SET_PX
 (1<<3è

	)

37 
	$£tG’”icCommªd
(
ş›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
) {

38 
mli£cÚds
 = 0;

39 
expœed
 = 0;

40 
exi¡
;

42 ià(
expœe
) {

43 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
expœe
, &
mli£cÚds
, 
NULL
è!ğ
VR_OK
)

45 ià(
mli£cÚds
 <= 0) {

46 
	`addR•lyE¼ÜFÜm©
(
c
,"šv®idƒxpœtimš %s",c->
cmd
->
Çme
);

49 ià(
un™
 =ğ
UNIT_SECONDS
è
mli£cÚds
 *= 1000;

52 
	`ãtchIÁ”ÇlDbByKey
(
c
,
key
);

53 
	`lockDbWr™e
(
c
->
db
);

54 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
,&
expœed
è=ğ
NULL
)

55 
exi¡
 = 0;

57 
exi¡
 = 1;

59 ià((
æags
 & 
OBJ_SET_NX
 && 
exi¡
) ||

60 (
æags
 & 
OBJ_SET_XX
 && !
exi¡
))

62 
	`uÆockDb
(
c
->
db
);

63 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

64 
	`addR•ly
(
c
, 
abÜt_»¶y
 ?‡bÜt_»¶y : 
sh¬ed
.
nuÎbulk
);

68 
	`£tKey
(
c
->
db
,
key
,
	`dupSŒšgObjeùUncÚ¡ªt
(
v®
),
NULL
);

69 
c
->
v–
->
dœty
++;

70 ià(
expœe
è
	`£tExpœe
(
c
->
db
,
key
,
	`vr_m£c_now
()+
mli£cÚds
);

71 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
key
,
c
->
db
->
id
);

72 ià(
expœe
è
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

73 "expœe",
key
,
c
->
db
->
id
);

74 
	`addR•ly
(
c
, 
ok_»¶y
 ? ok_»¶y : 
sh¬ed
.
ok
);

75 
	`uÆockDb
(
c
->
db
);

76 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

77 
	}
}

80 
	$£tCommªd
(
ş›Á
 *
c
) {

81 
j
;

82 
robj
 *
expœe
 = 
NULL
;

83 
un™
 = 
UNIT_SECONDS
;

84 
æags
 = 
OBJ_SET_NO_FLAGS
;

86 
j
 = 3; j < 
c
->
¬gc
; j++) {

87 *
a
 = 
c
->
¬gv
[
j
]->
±r
;

88 
robj
 *
Ãxt
 = (
j
 =ğ
c
->
¬gc
-1è? 
NULL
 : c->
¬gv
[j+1];

90 ià((
a
[0] == 'n' ||‡[0] == 'N') &&

91 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

92 !(
æags
 & 
OBJ_SET_XX
))

94 
æags
 |ğ
OBJ_SET_NX
;

95 } ià((
a
[0] == 'x' ||‡[0] == 'X') &&

96 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

97 !(
æags
 & 
OBJ_SET_NX
))

99 
æags
 |ğ
OBJ_SET_XX
;

100 } ià((
a
[0] == 'e' ||‡[0] == 'E') &&

101 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

102 !(
æags
 & 
OBJ_SET_PX
è&& 
Ãxt
)

104 
æags
 |ğ
OBJ_SET_EX
;

105 
un™
 = 
UNIT_SECONDS
;

106 
expœe
 = 
Ãxt
;

107 
j
++;

108 } ià((
a
[0] == 'p' ||‡[0] == 'P') &&

109 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

110 !(
æags
 & 
OBJ_SET_EX
è&& 
Ãxt
)

112 
æags
 |ğ
OBJ_SET_PX
;

113 
un™
 = 
UNIT_MILLISECONDS
;

114 
expœe
 = 
Ãxt
;

115 
j
++;

117 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

122 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

123 
	`£tG’”icCommªd
(
c
,
æags
,c->
¬gv
[1],c->¬gv[2],
expœe
,
un™
,
NULL
,NULL);

124 
	}
}

126 
	$£ŠxCommªd
(
ş›Á
 *
c
) {

127 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

128 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NX
,c->
¬gv
[1],c->¬gv[2],
NULL
,0,
sh¬ed
.
cÚe
,sh¬ed.
cz”o
);

129 
	}
}

131 
	$£‹xCommªd
(
ş›Á
 *
c
) {

132 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

133 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_SECONDS
,
NULL
,NULL);

134 
	}
}

136 
	$p£‹xCommªd
(
ş›Á
 *
c
) {

137 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

138 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_MILLISECONDS
,
NULL
,NULL);

139 
	}
}

141 
	$g‘G’”icCommªd
(
ş›Á
 *
c
) {

142 
robj
 *
o
;

144 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

145  
VR_OK
;

148 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

149 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

150  
VR_ERROR
;

152 
	`addR•lyBulk
(
c
,
o
);

153  
VR_OK
;

155 
	}
}

157 
	$g‘Commªd
(
ş›Á
 *
c
) {

158 
robj
 *
o
;

160 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[1]);

161 
	`lockDbR—d
(
c
->
db
);

162 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

163 
	`uÆockDb
(
c
->
db
);

164 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

168 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

169 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

171 
	`addR•lyBulk
(
c
,
o
);

174 
	`uÆockDb
(
c
->
db
);

175 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

176 
	}
}

178 
	$g‘£tCommªd
(
ş›Á
 *
c
) {

179 
robj
 *
key
, *
v®
;

180 
expœed
 = 0;

181 
exi¡
;

183 
key
 = 
c
->
¬gv
[1];

184 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

186 
	`ãtchIÁ”ÇlDbByKey
(
c
,
key
);

187 
	`lockDbWr™e
(
c
->
db
);

188 
v®
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
,&
expœed
);

189 ià(
v®
 =ğ
NULL
) {

190 
exi¡
 = 0;

191 
	`dbAdd
(
c
->
db
,
key
,
	`dupSŒšgObjeùUncÚ¡ªt
(c->
¬gv
[2]));

193 
exi¡
 = 1;

194 ià(
v®
->
ty³
 !ğ
OBJ_STRING
) {

195 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

196 
’d
;

199 
	`addR•lyBulk
(
c
,
v®
);

200 
	`dbOv”wr™e
(
c
->
db
,
key
,
	`dupSŒšgObjeùUncÚ¡ªt
(c->
¬gv
[2]));

201 
	`»moveExpœe
(
c
->
db
,
key
);

204 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[1],c->
db
->
id
);

205 
c
->
v–
->
dœty
++;

207 
’d
:

208 
	`uÆockDb
(
c
->
db
);

209 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

210 ià(
exi¡
)

211 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

213 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

214 
	}
}

216 
	$£ŒªgeCommªd
(
ş›Á
 *
c
) {

217 
robj
 *
o
;

218 
off£t
;

219 
sds
 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

220 
expœed
 = 0;

222 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
off£t
,
NULL
è!ğ
VR_OK
)

225 ià(
off£t
 < 0) {

226 
	`addR•lyE¼Ü
(
c
,"offset is out of„ange");

230 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

231 
	`lockDbWr™e
(
c
->
db
);

232 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

233 ià(
o
 =ğ
NULL
) {

235 ià(
	`sd¦’
(
v®ue
) == 0) {

236 
	`uÆockDb
(
c
->
db
);

237 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

238 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

243 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
VR_OK
) {

244 
	`uÆockDb
(
c
->
db
);

245 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

249 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
off£t
+
	`sd¦’
(
v®ue
)));

250 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

252 
size_t
 
Ş’
;

255 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

256 
	`uÆockDb
(
c
->
db
);

257 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

262 
Ş’
 = 
	`¡ršgObjeùL’
(
o
);

263 ià(
	`sd¦’
(
v®ue
) == 0) {

264 
	`uÆockDb
(
c
->
db
);

265 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

266 
	`addR•lyLÚgLÚg
(
c
,
Ş’
);

271 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
VR_OK
) {

272 
	`uÆockDb
(
c
->
db
);

273 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

278 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

281 ià(
	`sd¦’
(
v®ue
) > 0) {

282 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
off£t
+
	`sd¦’
(
v®ue
));

283 
	`memıy
((*)
o
->
±r
+
off£t
,
v®ue
,
	`sd¦’
(value));

284 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

285 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,

286 "£Œªge",
c
->
¬gv
[1],c->
db
->
id
);

287 
c
->
v–
->
dœty
++;

289 
	`addR•lyLÚgLÚg
(
c
,
	`sd¦’
(
o
->
±r
));

290 
	`uÆockDb
(
c
->
db
);

291 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

292 
	}
}

294 
	$g‘¿ngeCommªd
(
ş›Á
 *
c
) {

295 
robj
 *
o
;

296 
¡¬t
, 
’d
;

297 *
¡r
, 
Îbuf
[32];

298 
size_t
 
¡¾’
;

300 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
VR_OK
)

302 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
VR_OK
)

305 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

306 
	`lockDbR—d
(
c
->
db
);

307 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ybulk
)è=ğ
NULL
) {

308 
	`uÆockDb
(
c
->
db
);

309 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

311 } ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

312 
	`uÆockDb
(
c
->
db
);

313 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

317 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

318 
¡r
 = 
Îbuf
;

319 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

321 
¡r
 = 
o
->
±r
;

322 
¡¾’
 = 
	`sd¦’
(
¡r
);

326 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

327 ià(
’d
 < 0è’d = 
¡¾’
+end;

328 ià(
¡¬t
 < 0) start = 0;

329 ià(
’d
 < 0)ƒnd = 0;

330 ià(()
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

334 ià(
¡¬t
 > 
’d
 || 
¡¾’
 == 0) {

335 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

337 
	`addR•lyBulkCBufãr
(
c
,(*)
¡r
+
¡¬t
,
’d
-start+1);

339 
	`uÆockDb
(
c
->
db
);

340 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

341 
	}
}

343 
	$mg‘Commªd
(
ş›Á
 *
c
) {

344 
j
;

346 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-1);

347 
j
 = 1; j < 
c
->
¬gc
; j++) {

348 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

349 
	`lockDbR—d
(
c
->
db
);

350 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

351 ià(
o
 =ğ
NULL
) {

352 
	`uÆockDb
(
c
->
db
);

353 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

354 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

356 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

357 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

359 
	`addR•lyBulk
(
c
,
o
);

361 
	`uÆockDb
(
c
->
db
);

362 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

365 
	}
}

367 
	$m£tG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

368 
j
, 
busykeys
 = 0;

370 ià((
c
->
¬gc
 % 2) == 0) {

371 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

376 ià(
nx
) {

377 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

378 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
],
NULL
) != NULL) {

379 
busykeys
++;

382 ià(
busykeys
) {

383 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

388 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

389 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

390 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],c->¬gv[j+1],
NULL
);

391 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

393 
£rv”
.
dœty
 +ğ(
c
->
¬gc
-1)/2;

394 
	`addR•ly
(
c
, 
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

395 
	}
}

397 
	$m£tCommªd
(
ş›Á
 *
c
) {

398 
j
;

399 
expœed
 = 0, 
expœed_tÙ®
 = 0;

401 ià((
c
->
¬gc
 % 2) == 0) {

402 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

406 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

407 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

408 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

409 
	`lockDbWr™e
(
c
->
db
);

410 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],
	`dupSŒšgObjeùUncÚ¡ªt
(c->¬gv[j+1]),&
expœed
);

411 
	`uÆockDb
(
c
->
db
);

412 ià(
expœed
è
expœed_tÙ®
 ++;

413 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

416 ià(
expœed_tÙ®
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,expired_total);

417 
c
->
v–
->
dœty
 +ğ(c->
¬gc
-1)/2;

418 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

419 
	}
}

421 
	$m£ŠxCommªd
(
ş›Á
 *
c
) {

422 
	`m£tG’”icCommªd
(
c
,1);

423 
	}
}

425 
	$šüDeüCommªd
(
ş›Á
 *
c
, 
šü
) {

426 
v®ue
, 
Şdv®ue
;

427 
robj
 *
o
, *
Ãw
;

428 
expœed
 = 0;

430 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

431 
	`lockDbWr™e
(
c
->
db
);

432 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

433 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)è
’d
;

434 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
VR_OK
è
’d
;

436 
Şdv®ue
 = 
v®ue
;

437 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

438 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

439 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

440 
’d
;

442 
v®ue
 +ğ
šü
;

444 ià(
o
 && o->
»fcouÁ
 =ğ1 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

445 (
v®ue
 < 0 || v®u>ğ
OBJ_SHARED_INTEGERS
) &&

446 
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
)

448 
Ãw
 = 
o
;

449 
o
->
±r
 = (*)(()
v®ue
);

451 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

452 ià(
o
) {

453 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

455 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

458 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

459 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šüby",
c
->
¬gv
[1],c->
db
->
id
);

460 
c
->
v–
->
dœty
++;

461 
	`addR•ly
(
c
,
sh¬ed
.
cŞÚ
);

462 
	`addR•ly
(
c
,
Ãw
);

463 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

465 
’d
:

466 
	`uÆockDb
(
c
->
db
);

467 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

468 
	}
}

470 
	$šüCommªd
(
ş›Á
 *
c
) {

471 
	`šüDeüCommªd
(
c
,1);

472 
	}
}

474 
	$deüCommªd
(
ş›Á
 *
c
) {

475 
	`šüDeüCommªd
(
c
,-1);

476 
	}
}

478 
	$šübyCommªd
(
ş›Á
 *
c
) {

479 
šü
;

481 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
VR_OK
) ;

482 
	`šüDeüCommªd
(
c
,
šü
);

483 
	}
}

485 
	$deübyCommªd
(
ş›Á
 *
c
) {

486 
šü
;

488 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
VR_OK
) ;

489 
	`šüDeüCommªd
(
c
,-
šü
);

490 
	}
}

492 
	$šübyæßtCommªd
(
ş›Á
 *
c
) {

493 
šü
, 
v®ue
;

494 
robj
 *
o
, *
Ãw
, *
aux
;

495 
expœed
 = 0;

497 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

498 
	`lockDbWr™e
(
c
->
db
);

499 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

500 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)è
’d
;

501 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
VR_OK
 ||

502 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
šü
,
NULL
è!ğ
VR_OK
)

503 
’d
;

505 
v®ue
 +ğ
šü
;

506 ià(
	`i¢ª
(
v®ue
è|| 
	`isšf
(value)) {

507 
	`addR•lyE¼Ü
(
c
,"increment would…roduce NaN or Infinity");

508 
’d
;

510 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

511 ià(
o
)

512 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

514 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

515 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

516 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

517 
c
->
v–
->
dœty
++;

518 
	`addR•lyBulk
(
c
,
Ãw
);

523 
aux
 = 
	`ü—‹SŒšgObjeù
("SET",3);

524 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

525 
aux
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
Ãw
);

526 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,2,
aux
);

528 
’d
:

529 
	`uÆockDb
(
c
->
db
);

530 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

531 
	}
}

533 
	$­³ndCommªd
(
ş›Á
 *
c
) {

534 
size_t
 
tÙËn
;

535 
robj
 *
o
, *
­³nd
;

536 
expœed
 = 0;

538 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

539 
	`lockDbWr™e
(
c
->
db
);

540 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

541 ià(
o
 =ğ
NULL
) {

543 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

544 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
	`dupSŒšgObjeùUncÚ¡ªt
(c->argv[2]));

545 
tÙËn
 = 
	`¡ršgObjeùL’
(
c
->
¬gv
[2]);

548 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

549 
’d
;

552 
­³nd
 = 
c
->
¬gv
[2];

553 
tÙËn
 = 
	`¡ršgObjeùL’
(
o
)+
	`sd¦’
(
­³nd
->
±r
);

554 ià(
	`checkSŒšgL’gth
(
c
,
tÙËn
è!ğ
VR_OK
)

555 
’d
;

558 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

559 
o
->
±r
 = 
	`sdsÿ’
(o->±r,
­³nd
->±r,
	`sd¦’
(append->ptr));

560 
tÙËn
 = 
	`sd¦’
(
o
->
±r
);

562 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

563 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"­³nd",
c
->
¬gv
[1],c->
db
->
id
);

564 
c
->
v–
->
dœty
++;

565 
	`addR•lyLÚgLÚg
(
c
,
tÙËn
);

567 
’d
:

568 
	`uÆockDb
(
c
->
db
);

569 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

570 
	}
}

572 
	$¡¾’Commªd
(
ş›Á
 *
c
) {

573 
robj
 *
o
;

575 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

576 
	`lockDbR—d
(
c
->
db
);

577 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

578 
	`uÆockDb
(
c
->
db
);

579 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

581 } if(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

582 
	`uÆockDb
(
c
->
db
);

583 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

587 
	`addR•lyLÚgLÚg
(
c
,
	`¡ršgObjeùL’
(
o
));

588 
	`uÆockDb
(
c
->
db
);

589 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

590 
	}
}

	@src/vr_t_string.c

1 
	~<vr_cÜe.h
>

7 
	$checkSŒšgL’gth
(
ş›Á
 *
c
, 
size
) {

8 ià(
size
 > 512*1024*1024) {

9 
	`addR•lyE¼Ü
(
c
,"stringƒxceeds maximum‡llowed size (512MB)");

10  
VR_ERROR
;

12  
VR_OK
;

13 
	}
}

31 
	#OBJ_SET_NO_FLAGS
 0

	)

32 
	#OBJ_SET_NX
 (1<<0è

	)

33 
	#OBJ_SET_XX
 (1<<1è

	)

34 
	#OBJ_SET_EX
 (1<<2è

	)

35 
	#OBJ_SET_PX
 (1<<3è

	)

37 
	$£tG’”icCommªd
(
ş›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
) {

38 
mli£cÚds
 = 0;

39 
expœed
 = 0;

40 
exi¡
;

42 ià(
expœe
) {

43 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
expœe
, &
mli£cÚds
, 
NULL
è!ğ
VR_OK
)

45 ià(
mli£cÚds
 <= 0) {

46 
	`addR•lyE¼ÜFÜm©
(
c
,"šv®idƒxpœtimš %s",c->
cmd
->
Çme
);

49 ià(
un™
 =ğ
UNIT_SECONDS
è
mli£cÚds
 *= 1000;

52 
	`ãtchIÁ”ÇlDbByKey
(
c
,
key
);

53 
	`lockDbWr™e
(
c
->
db
);

54 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
,&
expœed
è=ğ
NULL
)

55 
exi¡
 = 0;

57 
exi¡
 = 1;

59 ià((
æags
 & 
OBJ_SET_NX
 && 
exi¡
) ||

60 (
æags
 & 
OBJ_SET_XX
 && !
exi¡
))

62 
	`uÆockDb
(
c
->
db
);

63 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

64 
	`addR•ly
(
c
, 
abÜt_»¶y
 ?‡bÜt_»¶y : 
sh¬ed
.
nuÎbulk
);

68 
	`£tKey
(
c
->
db
,
key
,
	`dupSŒšgObjeùUncÚ¡ªt
(
v®
),
NULL
);

69 
c
->
v–
->
dœty
++;

70 ià(
expœe
è
	`£tExpœe
(
c
->
db
,
key
,
	`vr_m£c_now
()+
mli£cÚds
);

71 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
key
,
c
->
db
->
id
);

72 ià(
expœe
è
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

73 "expœe",
key
,
c
->
db
->
id
);

74 
	`addR•ly
(
c
, 
ok_»¶y
 ? ok_»¶y : 
sh¬ed
.
ok
);

75 
	`uÆockDb
(
c
->
db
);

76 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

77 
	}
}

80 
	$£tCommªd
(
ş›Á
 *
c
) {

81 
j
;

82 
robj
 *
expœe
 = 
NULL
;

83 
un™
 = 
UNIT_SECONDS
;

84 
æags
 = 
OBJ_SET_NO_FLAGS
;

86 
j
 = 3; j < 
c
->
¬gc
; j++) {

87 *
a
 = 
c
->
¬gv
[
j
]->
±r
;

88 
robj
 *
Ãxt
 = (
j
 =ğ
c
->
¬gc
-1è? 
NULL
 : c->
¬gv
[j+1];

90 ià((
a
[0] == 'n' ||‡[0] == 'N') &&

91 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

92 !(
æags
 & 
OBJ_SET_XX
))

94 
æags
 |ğ
OBJ_SET_NX
;

95 } ià((
a
[0] == 'x' ||‡[0] == 'X') &&

96 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

97 !(
æags
 & 
OBJ_SET_NX
))

99 
æags
 |ğ
OBJ_SET_XX
;

100 } ià((
a
[0] == 'e' ||‡[0] == 'E') &&

101 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

102 !(
æags
 & 
OBJ_SET_PX
è&& 
Ãxt
)

104 
æags
 |ğ
OBJ_SET_EX
;

105 
un™
 = 
UNIT_SECONDS
;

106 
expœe
 = 
Ãxt
;

107 
j
++;

108 } ià((
a
[0] == 'p' ||‡[0] == 'P') &&

109 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

110 !(
æags
 & 
OBJ_SET_EX
è&& 
Ãxt
)

112 
æags
 |ğ
OBJ_SET_PX
;

113 
un™
 = 
UNIT_MILLISECONDS
;

114 
expœe
 = 
Ãxt
;

115 
j
++;

117 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

122 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

123 
	`£tG’”icCommªd
(
c
,
æags
,c->
¬gv
[1],c->¬gv[2],
expœe
,
un™
,
NULL
,NULL);

124 
	}
}

126 
	$£ŠxCommªd
(
ş›Á
 *
c
) {

127 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

128 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NX
,c->
¬gv
[1],c->¬gv[2],
NULL
,0,
sh¬ed
.
cÚe
,sh¬ed.
cz”o
);

129 
	}
}

131 
	$£‹xCommªd
(
ş›Á
 *
c
) {

132 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

133 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_SECONDS
,
NULL
,NULL);

134 
	}
}

136 
	$p£‹xCommªd
(
ş›Á
 *
c
) {

137 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

138 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_MILLISECONDS
,
NULL
,NULL);

139 
	}
}

141 
	$g‘G’”icCommªd
(
ş›Á
 *
c
) {

142 
robj
 *
o
;

144 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

145  
VR_OK
;

148 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

149 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

150  
VR_ERROR
;

152 
	`addR•lyBulk
(
c
,
o
);

153  
VR_OK
;

155 
	}
}

157 
	$g‘Commªd
(
ş›Á
 *
c
) {

158 
robj
 *
o
;

160 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[1]);

161 
	`lockDbR—d
(
c
->
db
);

162 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

163 
	`uÆockDb
(
c
->
db
);

164 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

168 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

169 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

171 
	`addR•lyBulk
(
c
,
o
);

174 
	`uÆockDb
(
c
->
db
);

175 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

176 
	}
}

178 
	$g‘£tCommªd
(
ş›Á
 *
c
) {

179 
robj
 *
key
, *
v®
;

180 
expœed
 = 0;

181 
exi¡
;

183 
key
 = 
c
->
¬gv
[1];

184 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

186 
	`ãtchIÁ”ÇlDbByKey
(
c
,
key
);

187 
	`lockDbWr™e
(
c
->
db
);

188 
v®
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
,&
expœed
);

189 ià(
v®
 =ğ
NULL
) {

190 
exi¡
 = 0;

191 
	`dbAdd
(
c
->
db
,
key
,
	`dupSŒšgObjeùUncÚ¡ªt
(c->
¬gv
[2]));

193 
exi¡
 = 1;

194 ià(
v®
->
ty³
 !ğ
OBJ_STRING
) {

195 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

196 
’d
;

199 
	`addR•lyBulk
(
c
,
v®
);

200 
	`dbOv”wr™e
(
c
->
db
,
key
,
	`dupSŒšgObjeùUncÚ¡ªt
(c->
¬gv
[2]));

201 
	`»moveExpœe
(
c
->
db
,
key
);

204 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[1],c->
db
->
id
);

205 
c
->
v–
->
dœty
++;

207 
’d
:

208 
	`uÆockDb
(
c
->
db
);

209 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

210 ià(
exi¡
)

211 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

213 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

214 
	}
}

216 
	$£ŒªgeCommªd
(
ş›Á
 *
c
) {

217 
robj
 *
o
;

218 
off£t
;

219 
sds
 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

220 
expœed
 = 0;

222 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
off£t
,
NULL
è!ğ
VR_OK
)

225 ià(
off£t
 < 0) {

226 
	`addR•lyE¼Ü
(
c
,"offset is out of„ange");

230 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

231 
	`lockDbWr™e
(
c
->
db
);

232 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

233 ià(
o
 =ğ
NULL
) {

235 ià(
	`sd¦’
(
v®ue
) == 0) {

236 
	`uÆockDb
(
c
->
db
);

237 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

238 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

243 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
VR_OK
) {

244 
	`uÆockDb
(
c
->
db
);

245 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

249 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
off£t
+
	`sd¦’
(
v®ue
)));

250 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

252 
size_t
 
Ş’
;

255 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

256 
	`uÆockDb
(
c
->
db
);

257 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

262 
Ş’
 = 
	`¡ršgObjeùL’
(
o
);

263 ià(
	`sd¦’
(
v®ue
) == 0) {

264 
	`uÆockDb
(
c
->
db
);

265 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

266 
	`addR•lyLÚgLÚg
(
c
,
Ş’
);

271 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
VR_OK
) {

272 
	`uÆockDb
(
c
->
db
);

273 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

278 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

281 ià(
	`sd¦’
(
v®ue
) > 0) {

282 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
off£t
+
	`sd¦’
(
v®ue
));

283 
	`memıy
((*)
o
->
±r
+
off£t
,
v®ue
,
	`sd¦’
(value));

284 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

285 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,

286 "£Œªge",
c
->
¬gv
[1],c->
db
->
id
);

287 
c
->
v–
->
dœty
++;

289 
	`addR•lyLÚgLÚg
(
c
,
	`sd¦’
(
o
->
±r
));

290 
	`uÆockDb
(
c
->
db
);

291 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

292 
	}
}

294 
	$g‘¿ngeCommªd
(
ş›Á
 *
c
) {

295 
robj
 *
o
;

296 
¡¬t
, 
’d
;

297 *
¡r
, 
Îbuf
[32];

298 
size_t
 
¡¾’
;

300 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
VR_OK
)

302 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
VR_OK
)

305 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

306 
	`lockDbR—d
(
c
->
db
);

307 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ybulk
)è=ğ
NULL
) {

308 
	`uÆockDb
(
c
->
db
);

309 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

311 } ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

312 
	`uÆockDb
(
c
->
db
);

313 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

317 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

318 
¡r
 = 
Îbuf
;

319 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

321 
¡r
 = 
o
->
±r
;

322 
¡¾’
 = 
	`sd¦’
(
¡r
);

326 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

327 ià(
’d
 < 0è’d = 
¡¾’
+end;

328 ià(
¡¬t
 < 0) start = 0;

329 ià(
’d
 < 0)ƒnd = 0;

330 ià(()
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

334 ià(
¡¬t
 > 
’d
 || 
¡¾’
 == 0) {

335 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

337 
	`addR•lyBulkCBufãr
(
c
,(*)
¡r
+
¡¬t
,
’d
-start+1);

339 
	`uÆockDb
(
c
->
db
);

340 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

341 
	}
}

343 
	$mg‘Commªd
(
ş›Á
 *
c
) {

344 
j
;

346 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-1);

347 
j
 = 1; j < 
c
->
¬gc
; j++) {

348 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

349 
	`lockDbR—d
(
c
->
db
);

350 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

351 ià(
o
 =ğ
NULL
) {

352 
	`uÆockDb
(
c
->
db
);

353 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

354 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

356 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

357 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

359 
	`addR•lyBulk
(
c
,
o
);

361 
	`uÆockDb
(
c
->
db
);

362 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

365 
	}
}

367 
	$m£tG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

368 
j
, 
busykeys
 = 0;

370 ià((
c
->
¬gc
 % 2) == 0) {

371 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

376 ià(
nx
) {

377 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

378 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
],
NULL
) != NULL) {

379 
busykeys
++;

382 ià(
busykeys
) {

383 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

388 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

389 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

390 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],c->¬gv[j+1],
NULL
);

391 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

393 
£rv”
.
dœty
 +ğ(
c
->
¬gc
-1)/2;

394 
	`addR•ly
(
c
, 
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

395 
	}
}

397 
	$m£tCommªd
(
ş›Á
 *
c
) {

398 
j
;

399 
expœed
 = 0, 
expœed_tÙ®
 = 0;

401 ià((
c
->
¬gc
 % 2) == 0) {

402 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

406 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

407 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

408 
	`ãtchIÁ”ÇlDbByKey
(
c
,c->
¬gv
[
j
]);

409 
	`lockDbWr™e
(
c
->
db
);

410 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],
	`dupSŒšgObjeùUncÚ¡ªt
(c->¬gv[j+1]),&
expœed
);

411 
	`uÆockDb
(
c
->
db
);

412 ià(
expœed
è
expœed_tÙ®
 ++;

413 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

416 ià(
expœed_tÙ®
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,expired_total);

417 
c
->
v–
->
dœty
 +ğ(c->
¬gc
-1)/2;

418 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

419 
	}
}

421 
	$m£ŠxCommªd
(
ş›Á
 *
c
) {

422 
	`m£tG’”icCommªd
(
c
,1);

423 
	}
}

425 
	$šüDeüCommªd
(
ş›Á
 *
c
, 
šü
) {

426 
v®ue
, 
Şdv®ue
;

427 
robj
 *
o
, *
Ãw
;

428 
expœed
 = 0;

430 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

431 
	`lockDbWr™e
(
c
->
db
);

432 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

433 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)è
’d
;

434 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
VR_OK
è
’d
;

436 
Şdv®ue
 = 
v®ue
;

437 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

438 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

439 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

440 
’d
;

442 
v®ue
 +ğ
šü
;

444 ià(
o
 && o->
»fcouÁ
 =ğ1 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

445 (
v®ue
 < 0 || v®u>ğ
OBJ_SHARED_INTEGERS
) &&

446 
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
)

448 
Ãw
 = 
o
;

449 
o
->
±r
 = (*)(()
v®ue
);

451 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

452 ià(
o
) {

453 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

455 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

458 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

459 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šüby",
c
->
¬gv
[1],c->
db
->
id
);

460 
c
->
v–
->
dœty
++;

461 
	`addR•ly
(
c
,
sh¬ed
.
cŞÚ
);

462 
	`addR•ly
(
c
,
Ãw
);

463 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

465 
’d
:

466 
	`uÆockDb
(
c
->
db
);

467 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
expœedkeys
, 1);

468 
	}
}

470 
	$šüCommªd
(
ş›Á
 *
c
) {

471 
	`šüDeüCommªd
(
c
,1);

472 
	}
}

474 
	$deüCommªd
(
ş›Á
 *
c
) {

475 
	`šüDeüCommªd
(
c
,-1);

476 
	}
}

478 
	$šübyCommªd
(
ş›Á
 *
c
) {

479 
šü
;

481 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
VR_OK
) ;

482 
	`šüDeüCommªd
(
c
,
šü
);

483 
	}
}

485 
	$deübyCommªd
(
ş›Á
 *
c
) {

486 
šü
;

488 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
VR_OK
) ;

489 
	`šüDeüCommªd
(
c
,-
šü
);

490 
	}
}

492 
	$šübyæßtCommªd
(
ş›Á
 *
c
) {

493 
šü
, 
v®ue
;

494 
robj
 *
o
, *
Ãw
, *
aux
;

495 
expœed
 = 0;

497 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

498 
	`lockDbWr™e
(
c
->
db
);

499 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

500 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)è
’d
;

501 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
VR_OK
 ||

502 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
šü
,
NULL
è!ğ
VR_OK
)

503 
’d
;

505 
v®ue
 +ğ
šü
;

506 ià(
	`i¢ª
(
v®ue
è|| 
	`isšf
(value)) {

507 
	`addR•lyE¼Ü
(
c
,"increment would…roduce NaN or Infinity");

508 
’d
;

510 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

511 ià(
o
)

512 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

514 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

515 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

516 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

517 
c
->
v–
->
dœty
++;

518 
	`addR•lyBulk
(
c
,
Ãw
);

523 
aux
 = 
	`ü—‹SŒšgObjeù
("SET",3);

524 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

525 
aux
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
Ãw
);

526 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,2,
aux
);

528 
’d
:

529 
	`uÆockDb
(
c
->
db
);

530 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

531 
	}
}

533 
	$­³ndCommªd
(
ş›Á
 *
c
) {

534 
size_t
 
tÙËn
;

535 
robj
 *
o
, *
­³nd
;

536 
expœed
 = 0;

538 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

539 
	`lockDbWr™e
(
c
->
db
);

540 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1],&
expœed
);

541 ià(
o
 =ğ
NULL
) {

543 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

544 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
	`dupSŒšgObjeùUncÚ¡ªt
(c->argv[2]));

545 
tÙËn
 = 
	`¡ršgObjeùL’
(
c
->
¬gv
[2]);

548 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

549 
’d
;

552 
­³nd
 = 
c
->
¬gv
[2];

553 
tÙËn
 = 
	`¡ršgObjeùL’
(
o
)+
	`sd¦’
(
­³nd
->
±r
);

554 ià(
	`checkSŒšgL’gth
(
c
,
tÙËn
è!ğ
VR_OK
)

555 
’d
;

558 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

559 
o
->
±r
 = 
	`sdsÿ’
(o->±r,
­³nd
->±r,
	`sd¦’
(append->ptr));

560 
tÙËn
 = 
	`sd¦’
(
o
->
±r
);

562 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

563 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"­³nd",
c
->
¬gv
[1],c->
db
->
id
);

564 
c
->
v–
->
dœty
++;

565 
	`addR•lyLÚgLÚg
(
c
,
tÙËn
);

567 
’d
:

568 
	`uÆockDb
(
c
->
db
);

569 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

570 
	}
}

572 
	$¡¾’Commªd
(
ş›Á
 *
c
) {

573 
robj
 *
o
;

575 
	`ãtchIÁ”ÇlDbByKey
(
c
, c->
¬gv
[1]);

576 
	`lockDbR—d
(
c
->
db
);

577 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
) {

578 
	`uÆockDb
(
c
->
db
);

579 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

581 } if(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

582 
	`uÆockDb
(
c
->
db
);

583 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

587 
	`addR•lyLÚgLÚg
(
c
,
	`¡ršgObjeùL’
(
o
));

588 
	`uÆockDb
(
c
->
db
);

589 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

590 
	}
}

	@src/vr_t_string.h

1 #iâdeà
_VR_T_STRING_H_


2 
	#_VR_T_STRING_H_


	)

4 
£tG’”icCommªd
(
ş›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
);

5 
£tCommªd
(
ş›Á
 *
c
);

6 
£ŠxCommªd
(
ş›Á
 *
c
);

7 
£‹xCommªd
(
ş›Á
 *
c
);

8 
p£‹xCommªd
(
ş›Á
 *
c
);

9 
g‘G’”icCommªd
(
ş›Á
 *
c
);

10 
g‘Commªd
(
ş›Á
 *
c
);

11 
g‘£tCommªd
(
ş›Á
 *
c
);

12 
£ŒªgeCommªd
(
ş›Á
 *
c
);

13 
g‘¿ngeCommªd
(
ş›Á
 *
c
);

14 
mg‘Commªd
(
ş›Á
 *
c
);

15 
m£tG’”icCommªd
(
ş›Á
 *
c
, 
nx
);

16 
m£tCommªd
(
ş›Á
 *
c
);

17 
m£ŠxCommªd
(
ş›Á
 *
c
);

18 
šüDeüCommªd
(
ş›Á
 *
c
, 
šü
);

19 
šüCommªd
(
ş›Á
 *
c
);

20 
deüCommªd
(
ş›Á
 *
c
);

21 
šübyCommªd
(
ş›Á
 *
c
);

22 
deübyCommªd
(
ş›Á
 *
c
);

23 
šübyæßtCommªd
(
ş›Á
 *
c
);

24 
­³ndCommªd
(
ş›Á
 *
c
);

25 
¡¾’Commªd
(
ş›Á
 *
c
);

	@src/vr_t_string.h

1 #iâdeà
_VR_T_STRING_H_


2 
	#_VR_T_STRING_H_


	)

4 
£tG’”icCommªd
(
ş›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
);

5 
£tCommªd
(
ş›Á
 *
c
);

6 
£ŠxCommªd
(
ş›Á
 *
c
);

7 
£‹xCommªd
(
ş›Á
 *
c
);

8 
p£‹xCommªd
(
ş›Á
 *
c
);

9 
g‘G’”icCommªd
(
ş›Á
 *
c
);

10 
g‘Commªd
(
ş›Á
 *
c
);

11 
g‘£tCommªd
(
ş›Á
 *
c
);

12 
£ŒªgeCommªd
(
ş›Á
 *
c
);

13 
g‘¿ngeCommªd
(
ş›Á
 *
c
);

14 
mg‘Commªd
(
ş›Á
 *
c
);

15 
m£tG’”icCommªd
(
ş›Á
 *
c
, 
nx
);

16 
m£tCommªd
(
ş›Á
 *
c
);

17 
m£ŠxCommªd
(
ş›Á
 *
c
);

18 
šüDeüCommªd
(
ş›Á
 *
c
, 
šü
);

19 
šüCommªd
(
ş›Á
 *
c
);

20 
deüCommªd
(
ş›Á
 *
c
);

21 
šübyCommªd
(
ş›Á
 *
c
);

22 
deübyCommªd
(
ş›Á
 *
c
);

23 
šübyæßtCommªd
(
ş›Á
 *
c
);

24 
­³ndCommªd
(
ş›Á
 *
c
);

25 
¡¾’Commªd
(
ş›Á
 *
c
);

	@src/vr_t_zset.c

1 
	~<vr_cÜe.h
>

3 
z¦LexV®ueG‹Mš
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

4 
z¦LexV®ueL‹Max
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

6 
zskli¡Node
 *
	$z¦C»©eNode
(
Ëv–
, 
scÜe
, 
robj
 *
obj
) {

7 
zskli¡Node
 *
zn
 = 
	`d®loc
((*zn)+
Ëv–
*(
zskli¡Lev–
));

8 
zn
->
scÜe
 = score;

9 
zn
->
obj
 = obj;

10  
zn
;

11 
	}
}

13 
zskli¡
 *
	$z¦C»©e
() {

14 
j
;

15 
zskli¡
 *
z¦
;

17 
z¦
 = 
	`d®loc
((*zsl));

18 
z¦
->
Ëv–
 = 1;

19 
z¦
->
Ëngth
 = 0;

20 
z¦
->
h—d”
 = 
	`z¦C»©eNode
(
ZSKIPLIST_MAXLEVEL
,0,
NULL
);

21 
j
 = 0; j < 
ZSKIPLIST_MAXLEVEL
; j++) {

22 
z¦
->
h—d”
->
Ëv–
[
j
].
fÜw¬d
 = 
NULL
;

23 
z¦
->
h—d”
->
Ëv–
[
j
].
¥ª
 = 0;

25 
z¦
->
h—d”
->
backw¬d
 = 
NULL
;

26 
z¦
->

 = 
NULL
;

27  
z¦
;

28 
	}
}

30 
	$z¦F»eNode
(
zskli¡Node
 *
node
) {

32 
	`dä“
(
node
);

33 
	}
}

35 
	$z¦F»e
(
zskli¡
 *
z¦
) {

36 
zskli¡Node
 *
node
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
, *
Ãxt
;

38 
	`dä“
(
z¦
->
h—d”
);

39 
node
) {

40 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

41 
	`z¦F»eNode
(
node
);

42 
node
 = 
Ãxt
;

44 
	`dä“
(
z¦
);

45 
	}
}

51 
	$z¦RªdomLev–
() {

52 
Ëv–
 = 1;

53 (
	`¿ndom
()&0xFFFFè< (
ZSKIPLIST_P
 * 0xFFFF))

54 
Ëv–
 += 1;

55  (
Ëv–
<
ZSKIPLIST_MAXLEVEL
) ?†evel : ZSKIPLIST_MAXLEVEL;

56 
	}
}

58 
zskli¡Node
 *
	$z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
) {

59 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

60 
¿nk
[
ZSKIPLIST_MAXLEVEL
];

61 
i
, 
Ëv–
;

63 
	`ASSERT
(!
	`i¢ª
(
scÜe
));

64 
x
 = 
z¦
->
h—d”
;

65 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

67 
¿nk
[
i
] = i =ğ(
z¦
->
Ëv–
-1) ? 0 :„ank[i+1];

68 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

69 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

70 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

71 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,obj) < 0))) {

72 
¿nk
[
i
] +ğ
x
->
Ëv–
[i].
¥ª
;

73 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

75 
upd©e
[
i
] = 
x
;

81 
Ëv–
 = 
	`z¦RªdomLev–
();

82 ià(
Ëv–
 > 
z¦
->level) {

83 
i
 = 
z¦
->
Ëv–
; i <†evel; i++) {

84 
¿nk
[
i
] = 0;

85 
upd©e
[
i
] = 
z¦
->
h—d”
;

86 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = 
z¦
->
Ëngth
;

88 
z¦
->
Ëv–
 =†evel;

90 
x
 = 
	`z¦C»©eNode
(
Ëv–
,
scÜe
,
obj
);

91 
i
 = 0; i < 
Ëv–
; i++) {

92 
x
->
Ëv–
[
i
].
fÜw¬d
 = 
upd©e
[i]->level[i].forward;

93 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
;

96 
x
->
Ëv–
[
i
].
¥ª
 = 
upd©e
[i]->Ëv–[i].¥ª - (
¿nk
[0] -„ank[i]);

97 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = (
¿nk
[0] -„ank[i]) + 1;

101 
i
 = 
Ëv–
; i < 
z¦
->level; i++) {

102 
upd©e
[
i
]->
Ëv–
[i].
¥ª
++;

105 
x
->
backw¬d
 = (
upd©e
[0] =ğ
z¦
->
h—d”
è? 
NULL
 : update[0];

106 ià(
x
->
Ëv–
[0].
fÜw¬d
)

107 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x;

109 
z¦
->

 = 
x
;

110 
z¦
->
Ëngth
++;

111  
x
;

112 
	}
}

115 
	$z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
) {

116 
i
;

117 
i
 = 0; i < 
z¦
->
Ëv–
; i++) {

118 ià(
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 =ğ
x
) {

119 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 +ğ
x
->level[i].span - 1;

120 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
->level[i].forward;

122 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 -= 1;

125 ià(
x
->
Ëv–
[0].
fÜw¬d
) {

126 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x->backward;

128 
z¦
->

 = 
x
->
backw¬d
;

130 
z¦
->
Ëv–
 > 1 && z¦->
h—d”
->Ëv–[z¦->Ëv–-1].
fÜw¬d
 =ğ
NULL
)

131 
z¦
->
Ëv–
--;

132 
z¦
->
Ëngth
--;

133 
	}
}

136 
	$z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
) {

137 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

138 
i
;

140 
x
 = 
z¦
->
h—d”
;

141 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

142 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

143 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

144 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

145 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,obj) < 0)))

146 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

147 
upd©e
[
i
] = 
x
;

151 
x
 = x->
Ëv–
[0].
fÜw¬d
;

152 ià(
x
 && 
scÜe
 =ğx->scÜ&& 
	`equ®SŒšgObjeùs
(x->
obj
,obj)) {

153 
	`z¦D–‘eNode
(
z¦
, 
x
, 
upd©e
);

154 
	`z¦F»eNode
(
x
);

158 
	}
}

160 
	$z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

161  
¥ec
->
mšex
 ? (
v®ue
 > s³c->
mš
) : (value >= spec->min);

162 
	}
}

164 
	$z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

165  
¥ec
->
maxex
 ? (
v®ue
 < s³c->
max
) : (value <= spec->max);

166 
	}
}

169 
	$z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

170 
zskli¡Node
 *
x
;

173 ià(
¿nge
->
mš
 >„ªge->
max
 ||

174 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

176 
x
 = 
z¦
->

;

177 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueG‹Mš
(x->
scÜe
,
¿nge
))

179 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

180 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueL‹Max
(x->
scÜe
,
¿nge
))

183 
	}
}

187 
zskli¡Node
 *
	$z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

188 
zskli¡Node
 *
x
;

189 
i
;

192 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

194 
x
 = 
z¦
->
h—d”
;

195 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

197 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

198 !
	`z¦V®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

199 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

203 
x
 = x->
Ëv–
[0].
fÜw¬d
;

204 
	`ASSERT
(
x
 !ğ
NULL
);

207 ià(!
	`z¦V®ueL‹Max
(
x
->
scÜe
,
¿nge
)è 
NULL
;

208  
x
;

209 
	}
}

213 
zskli¡Node
 *
	$z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

214 
zskli¡Node
 *
x
;

215 
i
;

218 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

220 
x
 = 
z¦
->
h—d”
;

221 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

223 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

224 
	`z¦V®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

225 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

229 
	`ASSERT
(
x
 !ğ
NULL
);

232 ià(!
	`z¦V®ueG‹Mš
(
x
->
scÜe
,
¿nge
)è 
NULL
;

233  
x
;

234 
	}
}

240 
	$z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

241 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

242 
»moved
 = 0;

243 
i
;

245 
x
 = 
z¦
->
h—d”
;

246 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

247 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
¿nge
->
mšex
 ?

248 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 <ğ
¿nge
->
mš
 :

249 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < 
¿nge
->
mš
))

250 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

251 
upd©e
[
i
] = 
x
;

255 
x
 = x->
Ëv–
[0].
fÜw¬d
;

258 
x
 &&

259 (
¿nge
->
maxex
 ? 
x
->
scÜe
 <„ªge->
max
 : x->score <=„ange->max))

261 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

262 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

263 
	`diùD–‘e
(
diù
,
x
->
obj
);

264 
	`z¦F»eNode
(
x
);

265 
»moved
++;

266 
x
 = 
Ãxt
;

268  
»moved
;

269 
	}
}

271 
	$z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

272 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

273 
»moved
 = 0;

274 
i
;

277 
x
 = 
z¦
->
h—d”
;

278 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

279 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

280 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

281 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

282 
upd©e
[
i
] = 
x
;

286 
x
 = x->
Ëv–
[0].
fÜw¬d
;

289 
x
 && 
	`z¦LexV®ueL‹Max
(x->
obj
,
¿nge
)) {

290 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

291 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

292 
	`diùD–‘e
(
diù
,
x
->
obj
);

293 
	`z¦F»eNode
(
x
);

294 
»moved
++;

295 
x
 = 
Ãxt
;

297  
»moved
;

298 
	}
}

302 
	$z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict) {

303 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

304 
Œav”£d
 = 0, 
»moved
 = 0;

305 
i
;

307 
x
 = 
z¦
->
h—d”
;

308 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

309 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è< 
¡¬t
) {

310 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

311 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

313 
upd©e
[
i
] = 
x
;

316 
Œav”£d
++;

317 
x
 = x->
Ëv–
[0].
fÜw¬d
;

318 
x
 && 
Œav”£d
 <ğ
’d
) {

319 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

320 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

321 
	`diùD–‘e
(
diù
,
x
->
obj
);

322 
	`z¦F»eNode
(
x
);

323 
»moved
++;

324 
Œav”£d
++;

325 
x
 = 
Ãxt
;

327  
»moved
;

328 
	}
}

334 
	$z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
o
) {

335 
zskli¡Node
 *
x
;

336 
¿nk
 = 0;

337 
i
;

339 
x
 = 
z¦
->
h—d”
;

340 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

341 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

342 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

343 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

344 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
o
) <= 0))) {

345 
¿nk
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

346 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

350 ià(
x
->
obj
 && 
	`equ®SŒšgObjeùs
(x->obj,
o
)) {

351  
¿nk
;

355 
	}
}

358 
zskli¡Node
* 
	$z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
) {

359 
zskli¡Node
 *
x
;

360 
Œav”£d
 = 0;

361 
i
;

363 
x
 = 
z¦
->
h—d”
;

364 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

365 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è<ğ
¿nk
)

367 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

368 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

370 ià(
Œav”£d
 =ğ
¿nk
) {

371  
x
;

374  
NULL
;

375 
	}
}

378 
	$z¦P¬£Rªge
(
robj
 *
mš
,„obj *
max
, 
z¿nge¥ec
 *
¥ec
) {

379 *
•Œ
;

380 
¥ec
->
mšex
 = s³c->
maxex
 = 0;

386 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

387 
¥ec
->
mš
 = ()mš->
±r
;

389 ià(((*)
mš
->
±r
)[0] == '(') {

390 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
+1,&
•Œ
);

391 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
VR_ERROR
;

392 
¥ec
->
mšex
 = 1;

394 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
,&
•Œ
);

395 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
VR_ERROR
;

398 ià(
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

399 
¥ec
->
max
 = ()max->
±r
;

401 ià(((*)
max
->
±r
)[0] == '(') {

402 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
+1,&
•Œ
);

403 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
VR_ERROR
;

404 
¥ec
->
maxex
 = 1;

406 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
,&
•Œ
);

407 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
VR_ERROR
;

411  
VR_OK
;

412 
	}
}

429 
	$z¦P¬£LexRªgeI‹m
(
robj
 *
™em
,„obj **
de¡
, *
ex
) {

430 *
c
 = 
™em
->
±r
;

432 
c
[0]) {

434 ià(
c
[1] !ğ'\0'è 
VR_ERROR
;

435 *
ex
 = 0;

436 *
de¡
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
sh¬ed
.
max¡ršg
);

437  
VR_OK
;

439 ià(
c
[1] !ğ'\0'è 
VR_ERROR
;

440 *
ex
 = 0;

441 *
de¡
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
sh¬ed
.
mš¡ršg
);

442  
VR_OK
;

444 *
ex
 = 1;

445 *
de¡
 = 
	`ü—‹SŒšgObjeù
(
c
+1,
	`sd¦’
(c)-1);

446  
VR_OK
;

448 *
ex
 = 0;

449 *
de¡
 = 
	`ü—‹SŒšgObjeù
(
c
+1,
	`sd¦’
(c)-1);

450  
VR_OK
;

452  
VR_ERROR
;

454 
	}
}

461 
	$z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
) {

464 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
 ||

465 
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
è 
VR_ERROR
;

467 
¥ec
->
mš
 = s³c->
max
 = 
NULL
;

468 ià(
	`z¦P¬£LexRªgeI‹m
(
mš
, &
¥ec
->mš, &¥ec->
mšex
è=ğ
VR_ERROR
 ||

469 
	`z¦P¬£LexRªgeI‹m
(
max
, &
¥ec
->max, &¥ec->
maxex
è=ğ
VR_ERROR
) {

470 ià(
¥ec
->
mš
è
	`ä“Objeù
(spec->min);

471 ià(
¥ec
->
max
è
	`ä“Objeù
(spec->max);

472  
VR_ERROR
;

474  
VR_OK
;

476 
	}
}

480 
	$z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
) {

481 
	`ä“Objeù
(
¥ec
->
mš
);

482 
	`ä“Objeù
(
¥ec
->
max
);

483 
	}
}

488 
	$com·»SŒšgObjeùsFÜLexRªge
(
robj
 *
a
,„obj *
b
) {

489 ià(
a
 =ğ
b
)  0;

491 ià(
a
 =ğ
sh¬ed
.
mš¡ršg
 || 
b
 =ğsh¬ed.
max¡ršg
)  -1;

492 ià(
a
 =ğ
sh¬ed
.
max¡ršg
 || 
b
 =ğsh¬ed.
mš¡ršg
)  1;

493  
	`com·»SŒšgObjeùs
(
a
,
b
);

494 
	}
}

496 
	$z¦LexV®ueG‹Mš
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

497  
¥ec
->
mšex
 ?

498 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
mš
) > 0) :

499 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
mš
) >= 0);

500 
	}
}

502 
	$z¦LexV®ueL‹Max
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

503  
¥ec
->
maxex
 ?

504 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
max
) < 0) :

505 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
max
) <= 0);

506 
	}
}

509 
	$z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

510 
zskli¡Node
 *
x
;

513 ià(
	`com·»SŒšgObjeùsFÜLexRªge
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

514 (
	`com·»SŒšgObjeùs
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

515 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

517 
x
 = 
z¦
->

;

518 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueG‹Mš
(x->
obj
,
¿nge
))

520 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

521 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueL‹Max
(x->
obj
,
¿nge
))

524 
	}
}

528 
zskli¡Node
 *
	$z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

529 
zskli¡Node
 *
x
;

530 
i
;

533 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

535 
x
 = 
z¦
->
h—d”
;

536 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

538 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

539 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

540 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

544 
x
 = x->
Ëv–
[0].
fÜw¬d
;

545 
	`ASSERT
(
x
 !ğ
NULL
);

548 ià(!
	`z¦LexV®ueL‹Max
(
x
->
obj
,
¿nge
)è 
NULL
;

549  
x
;

550 
	}
}

554 
zskli¡Node
 *
	$z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

555 
zskli¡Node
 *
x
;

556 
i
;

559 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

561 
x
 = 
z¦
->
h—d”
;

562 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

564 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

565 
	`z¦LexV®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

566 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

570 
	`ASSERT
(
x
 !ğ
NULL
);

573 ià(!
	`z¦LexV®ueG‹Mš
(
x
->
obj
,
¿nge
)è 
NULL
;

574  
x
;

575 
	}
}

581 
	$zzlG‘ScÜe
(*
¥Œ
) {

582 
»t
;

583 *
v¡r
;

584 
vËn
;

585 
vlÚg
;

586 
buf
[128];

587 
scÜe
;

589 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

591 
»t
 = ()
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
);

592 
	`ASSERT
(
»t
 > 0);

594 ià(
v¡r
) {

595 
	`memıy
(
buf
,
v¡r
,
vËn
);

596 
buf
[
vËn
] = '\0';

597 
scÜe
 = 
	`¡¹od
(
buf
,
NULL
);

599 
scÜe
 = 
vlÚg
;

602  
scÜe
;

603 
	}
}

608 
robj
 *
	$zli¡G‘Objeù
(*
¥Œ
) {

609 
»t
;

610 *
v¡r
;

611 
vËn
;

612 
vlÚg
;

614 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

616 
»t
 = ()
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
);

617 
	`ASSERT
(
»t
 > 0);

619 ià(
v¡r
) {

620  
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

622  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

624 
	}
}

627 
	$zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
) {

628 
»t
;

629 *
v¡r
;

630 
vËn
;

631 
vlÚg
;

632 
vbuf
[32];

633 
mšËn
, 
cmp
;

635 
»t
 = ()
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
);

636 
	`ASSERT
(
»t
 > 0);

637 ià(
v¡r
 =ğ
NULL
) {

639 
vËn
 = 
	`Î2¡ršg
((*)
vbuf
,(vbuf),
vlÚg
);

640 
v¡r
 = 
vbuf
;

643 
mšËn
 = (
vËn
 < 
ş’
) ? vlen : clen;

644 
cmp
 = 
	`memcmp
(
v¡r
,
c¡r
,
mšËn
);

645 ià(
cmp
 =ğ0è 
vËn
-
ş’
;

646  
cmp
;

647 
	}
}

649 
	$zzlL’gth
(*
zl
) {

650  
	`zli¡L’
(
zl
)/2;

651 
	}
}

655 
	$zzlNext
(*
zl
, **
•Œ
, **
¥Œ
) {

656 *
_•Œ
, *
_¥Œ
;

657 
	`ASSERT
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

659 
_•Œ
 = 
	`zli¡Next
(
zl
,*
¥Œ
);

660 ià(
_•Œ
 !ğ
NULL
) {

661 
_¥Œ
 = 
	`zli¡Next
(
zl
,
_•Œ
);

662 
	`ASSERT
(
_¥Œ
 !ğ
NULL
);

665 
_¥Œ
 = 
NULL
;

668 *
•Œ
 = 
_•Œ
;

669 *
¥Œ
 = 
_¥Œ
;

670 
	}
}

674 
	$zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
) {

675 *
_•Œ
, *
_¥Œ
;

676 
	`ASSERT
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

678 
_¥Œ
 = 
	`zli¡P»v
(
zl
,*
•Œ
);

679 ià(
_¥Œ
 !ğ
NULL
) {

680 
_•Œ
 = 
	`zli¡P»v
(
zl
,
_¥Œ
);

681 
	`ASSERT
(
_•Œ
 !ğ
NULL
);

684 
_•Œ
 = 
NULL
;

687 *
•Œ
 = 
_•Œ
;

688 *
¥Œ
 = 
_¥Œ
;

689 
	}
}

693 
	$zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

694 *
p
;

695 
scÜe
;

698 ià(
¿nge
->
mš
 >„ªge->
max
 ||

699 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

702 
p
 = 
	`zli¡Index
(
zl
,-1);

703 ià(
p
 =ğ
NULL
)  0;

704 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

705 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

708 
p
 = 
	`zli¡Index
(
zl
,1);

709 
	`ASSERT
(
p
 !ğ
NULL
);

710 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

711 ià(!
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

715 
	}
}

719 *
	$zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

720 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

721 
scÜe
;

724 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

726 
•Œ
 !ğ
NULL
) {

727 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

728 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

730 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

731 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
)) {

733 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

734  
•Œ
;

735  
NULL
;

739 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

742  
NULL
;

743 
	}
}

747 *
	$zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

748 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

749 
scÜe
;

752 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

754 
•Œ
 !ğ
NULL
) {

755 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

756 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

758 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

759 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

761 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

762  
•Œ
;

763  
NULL
;

768 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

769 ià(
¥Œ
 !ğ
NULL
) {

770 
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
);

771 
	`ASSERT
(
•Œ
 !ğ
NULL
);

773 
•Œ
 = 
NULL
;

777  
NULL
;

778 
	}
}

780 
	$zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

781 
robj
 *
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

782 
»s
 = 
	`z¦LexV®ueG‹Mš
(
v®ue
,
¥ec
);

783 
	`ä“Objeù
(
v®ue
);

784  
»s
;

785 
	}
}

787 
	$zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

788 
robj
 *
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

789 
»s
 = 
	`z¦LexV®ueL‹Max
(
v®ue
,
¥ec
);

790 
	`ä“Objeù
(
v®ue
);

791  
»s
;

792 
	}
}

796 
	$zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

797 *
p
;

800 ià(
	`com·»SŒšgObjeùsFÜLexRªge
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

801 (
	`com·»SŒšgObjeùs
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

802 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

805 
p
 = 
	`zli¡Index
(
zl
,-2);

806 ià(
p
 =ğ
NULL
)  0;

807 ià(!
	`zzlLexV®ueG‹Mš
(
p
,
¿nge
))

810 
p
 = 
	`zli¡Index
(
zl
,0);

811 
	`ASSERT
(
p
 !ğ
NULL
);

812 ià(!
	`zzlLexV®ueL‹Max
(
p
,
¿nge
))

816 
	}
}

820 *
	$zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

821 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

824 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

826 
•Œ
 !ğ
NULL
) {

827 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
)) {

829 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
))

830  
•Œ
;

831  
NULL
;

835 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

836 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

837 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

840  
NULL
;

841 
	}
}

845 *
	$zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

846 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

849 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

851 
•Œ
 !ğ
NULL
) {

852 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

854 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
))

855  
•Œ
;

856  
NULL
;

861 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

862 ià(
¥Œ
 !ğ
NULL
) {

863 
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
);

864 
	`ASSERT
(
•Œ
 !ğ
NULL
);

866 
•Œ
 = 
NULL
;

870  
NULL
;

871 
	}
}

873 *
	$zzlFšd
(*
zl
, 
robj
 *
–e
, *
scÜe
) {

874 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

875 
robj
 *
–e_Ãw
;

877 
–e_Ãw
 = 
	`g‘DecodedObjeù
(
–e
);

878 
•Œ
 !ğ
NULL
) {

879 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

880 
	`£rv”As£¹W™hInfo
(
NULL
,
–e_Ãw
,
¥Œ
 != NULL);

882 ià(
	`zli¡Com·»
(
•Œ
,
–e_Ãw
->
±r
,
	`sd¦’
(ele_new->ptr))) {

884 ià(
scÜe
 !ğ
NULL
è*scÜğ
	`zzlG‘ScÜe
(
¥Œ
);

885 ià(
–e_Ãw
!ğ
–e
è
	`ä“Objeù
(ele_new);

886  
•Œ
;

890 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

893 ià(
–e_Ãw
!ğ
–e
è
	`ä“Objeù
(ele_new);

894  
NULL
;

895 
	}
}

899 *
	$zzlD–‘e
(*
zl
, *
•Œ
) {

900 *
p
 = 
•Œ
;

903 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

904 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

905  
zl
;

906 
	}
}

908 *
	$zzlIn£¹At
(*
zl
, *
•Œ
, 
robj
 *
–e
, 
scÜe
) {

909 *
¥Œ
;

910 
scÜebuf
[128];

911 
scÜ–’
;

912 
size_t
 
off£t
;

914 
	`£rv”As£¹W™hInfo
(
NULL
,
–e
,
	`sdsEncodedObjeù
(ele));

915 
scÜ–’
 = 
	`d2¡ršg
(
scÜebuf
,(scÜebuf),
scÜe
);

916 ià(
•Œ
 =ğ
NULL
) {

917 
zl
 = 
	`zli¡Push
(zl,
–e
->
±r
,
	`sd¦’
ÓË->±r),
ZIPLIST_TAIL
);

918 
zl
 = 
	`zli¡Push
(zl,(*)
scÜebuf
,
scÜ–’
,
ZIPLIST_TAIL
);

921 
off£t
 = 
•Œ
-
zl
;

922 
zl
 = 
	`zli¡In£¹
(zl,
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr));

923 
•Œ
 = 
zl
+
off£t
;

926 
	`£rv”As£¹W™hInfo
(
NULL
,
–e
,(
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)) != NULL);

927 
zl
 = 
	`zli¡In£¹
(zl,
¥Œ
,(*)
scÜebuf
,
scÜ–’
);

930  
zl
;

931 
	}
}

935 *
	$zzlIn£¹
(*
zl
, 
robj
 *
–e
, 
scÜe
) {

936 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

937 
s
;

938 
robj
 *
–e_Ãw
;

940 
–e_Ãw
 = 
	`g‘DecodedObjeù
(
–e
);

941 
•Œ
 !ğ
NULL
) {

942 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

943 
	`£rv”As£¹W™hInfo
(
NULL
,
–e_Ãw
,
¥Œ
 != NULL);

944 
s
 = 
	`zzlG‘ScÜe
(
¥Œ
);

946 ià(
s
 > 
scÜe
) {

950 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e_Ãw
,
scÜe
);

952 } ià(
s
 =ğ
scÜe
) {

954 ià(
	`zzlCom·»EËm’ts
(
•Œ
,
–e_Ãw
->
±r
,
	`sd¦’
(ele_new->ptr)) > 0) {

955 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e_Ãw
,
scÜe
);

961 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

965 ià(
•Œ
 =ğ
NULL
)

966 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e_Ãw
,
scÜe
);

968 ià(
–e_Ãw
 !ğ
–e
è
	`ä“Objeù
(ele_new);

969  
zl
;

970 
	}
}

972 *
	$zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

973 *
•Œ
, *
¥Œ
;

974 
scÜe
;

975 
num
 = 0;

977 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

979 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,
¿nge
);

980 ià(
•Œ
 =ğ
NULL
è 
zl
;

984 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

985 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

986 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

988 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

989 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

990 
num
++;

997 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

998  
zl
;

999 
	}
}

1001 *
	$zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1002 *
•Œ
, *
¥Œ
;

1003 
num
 = 0;

1005 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1007 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,
¿nge
);

1008 ià(
•Œ
 =ğ
NULL
è 
zl
;

1012 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1013 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

1015 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1016 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1017 
num
++;

1024 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1025  
zl
;

1026 
	}
}

1030 *
	$zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
) {

1031 
num
 = (
’d
-
¡¬t
)+1;

1032 ià(
d–‘ed
è*d–‘ed = 
num
;

1033 
zl
 = 
	`zli¡D–‘eRªge
(zl,2*(
¡¬t
-1),2*
num
);

1034  
zl
;

1035 
	}
}

1041 
	$z£tL’gth
(
robj
 *
zobj
) {

1042 
Ëngth
 = -1;

1043 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1044 
Ëngth
 = 
	`zzlL’gth
(
zobj
->
±r
);

1045 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1046 
Ëngth
 = ((
z£t
*)
zobj
->
±r
)->
z¦
->length;

1048 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1050  
Ëngth
;

1051 
	}
}

1053 
	$z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
) {

1054 
z£t
 *
zs
;

1055 
zskli¡Node
 *
node
, *
Ãxt
;

1056 
robj
 *
–e
;

1057 
scÜe
;

1059 ià(
zobj
->
’codšg
 ==ƒncoding) ;

1060 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1061 *
zl
 = 
zobj
->
±r
;

1062 *
•Œ
, *
¥Œ
;

1063 *
v¡r
;

1064 
vËn
;

1065 
vlÚg
;

1067 ià(
’codšg
 !ğ
OBJ_ENCODING_SKIPLIST
)

1068 
	`£rv”Pªic
("Unknownargetƒncoding");

1070 
zs
 = 
	`d®loc
((*zs));

1071 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

1072 
zs
->
z¦
 = 
	`z¦C»©e
();

1074 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1075 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
•Œ
 != NULL);

1076 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1077 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
¥Œ
 != NULL);

1079 
•Œ
 !ğ
NULL
) {

1080 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1081 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

1082 ià(
v¡r
 =ğ
NULL
)

1083 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

1085 
–e
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

1088 
node
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1089 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
	`diùAdd
(
zs
->
diù
,
–e
,&
node
->
scÜe
è=ğ
DICT_OK
);

1090 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1093 
	`dä“
(
zobj
->
±r
);

1094 
zobj
->
±r
 = 
zs
;

1095 
zobj
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

1096 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1097 *
zl
 = 
	`zli¡New
();

1099 ià(
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
)

1100 
	`£rv”Pªic
("Unknownargetƒncoding");

1104 
zs
 = 
zobj
->
±r
;

1105 
node
 = 
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1106 
	`dä“
(
zs
->
z¦
->
h—d”
);

1107 
	`dä“
(
zs
->
z¦
);

1109 
node
) {

1110 
–e
 = 
	`g‘DecodedObjeù
(
node
->
obj
);

1111 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e
,
node
->
scÜe
);

1112 ià(
–e
 !ğ
node
->
obj
è
	`ä“Objeù
(ele);

1113 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

1114 
	`z¦F»eNode
(
node
);

1115 
node
 = 
Ãxt
;

1118 
	`diùR–—£
(
zs
->
diù
);

1119 
	`dä“
(
zs
);

1120 
zobj
->
±r
 = 
zl
;

1121 
zobj
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1123 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1125 
	}
}

1130 
	$z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
) {

1131 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) ;

1132 
z£t
 *z£ˆğ
zobj
->
±r
;

1134 ià(
z£t
->
z¦
->
Ëngth
 <ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

1135 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

1136 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_ZIPLIST
);

1137 
	}
}

1143 
	$z£tScÜe
(
robj
 *
zobj
,„obj *
memb”
, *
scÜe
) {

1144 ià(!
zobj
 || !
memb”
è 
VR_ERROR
;

1146 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1147 ià(
	`zzlFšd
(
zobj
->
±r
, 
memb”
, 
scÜe
è=ğ
NULL
è 
VR_ERROR
;

1148 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1149 
z£t
 *
zs
 = 
zobj
->
±r
;

1150 
diùEÁry
 *
de
 = 
	`diùFšd
(
zs
->
diù
, 
memb”
);

1151 ià(
de
 =ğ
NULL
è 
VR_ERROR
;

1152 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1154 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1156  
VR_OK
;

1157 
	}
}

1164 
	#ZADD_NONE
 0

	)

1165 
	#ZADD_INCR
 (1<<0è

	)

1166 
	#ZADD_NX
 (1<<1è

	)

1167 
	#ZADD_XX
 (1<<2è

	)

1168 
	#ZADD_CH
 (1<<3è

	)

1170 
	$zaddG’”icCommªd
(
ş›Á
 *
c
, 
æags
) {

1171 *
ÇÃ¼
 = "resulting score is‚ot‡‚umber (NaN)";

1172 
robj
 *
key
 = 
c
->
¬gv
[1];

1173 
robj
 *
–e
;

1174 
robj
 *
zobj
;

1175 
robj
 *
curobj
;

1176 
scÜe
 = 0, *
scÜes
 = 
NULL
, 
curscÜe
 = 0.0;

1177 
j
, 
–em’ts
;

1178 
scÜeidx
 = 0;

1182 
added
 = 0;

1183 
upd©ed
 = 0;

1184 
´oûs£d
 = 0;

1186 
expœed
 = 0;

1190 
scÜeidx
 = 2;

1191 
scÜeidx
 < 
c
->
¬gc
) {

1192 *
İt
 = 
c
->
¬gv
[
scÜeidx
]->
±r
;

1193 ià(!
	`¡rÿ£cmp
(
İt
,"nx")è
æags
 |ğ
ZADD_NX
;

1194 ià(!
	`¡rÿ£cmp
(
İt
,"xx")è
æags
 |ğ
ZADD_XX
;

1195 ià(!
	`¡rÿ£cmp
(
İt
,"ch")è
æags
 |ğ
ZADD_CH
;

1196 ià(!
	`¡rÿ£cmp
(
İt
,"šü")è
æags
 |ğ
ZADD_INCR
;

1198 
scÜeidx
++;

1202 
šü
 = (
æags
 & 
ZADD_INCR
) != 0;

1203 
nx
 = (
æags
 & 
ZADD_NX
) != 0;

1204 
xx
 = (
æags
 & 
ZADD_XX
) != 0;

1205 
ch
 = (
æags
 & 
ZADD_CH
) != 0;

1209 
–em’ts
 = 
c
->
¬gc
-
scÜeidx
;

1210 ià(
–em’ts
 % 2) {

1211 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1214 
–em’ts
 /= 2;

1217 ià(
nx
 && 
xx
) {

1218 
	`addR•lyE¼Ü
(
c
,

1223 ià(
šü
 && 
–em’ts
 > 1) {

1224 
	`addR•lyE¼Ü
(
c
,

1232 
scÜes
 = 
	`d®loc
(()*
–em’ts
);

1233 
j
 = 0; j < 
–em’ts
; j++) {

1234 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
scÜeidx
+
j
*2],&
scÜes
[j],
NULL
)

1235 !ğ
VR_OK
è
ş—nup
;

1238 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1239 
	`lockDbWr™e
(
c
->
db
);

1241 
zobj
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
,&
expœed
);

1242 ià(
zobj
 =ğ
NULL
) {

1243 ià(
xx
) {

1244 
	`uÆockDb
(
c
->
db
);

1245 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1246 
»¶y_to_ş›Á
;

1248 ià(
£rv”
.
z£t_max_zli¡_’Œ›s
 == 0 ||

1249 
£rv”
.
z£t_max_zli¡_v®ue
 < 
	`sd¦’
(
c
->
¬gv
[
scÜeidx
+1]->
±r
))

1251 
zobj
 = 
	`ü—‹Z£tObjeù
();

1253 
zobj
 = 
	`ü—‹Z£tZli¡Objeù
();

1255 
	`dbAdd
(
c
->
db
,
key
,
zobj
);

1257 ià(
zobj
->
ty³
 !ğ
OBJ_ZSET
) {

1258 
	`uÆockDb
(
c
->
db
);

1259 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1260 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1261 
ş—nup
;

1265 
j
 = 0; j < 
–em’ts
; j++) {

1266 
scÜe
 = 
scÜes
[
j
];

1268 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1269 *
•Œ
;

1272 
–e
 = 
c
->
¬gv
[
scÜeidx
+1+
j
*2];

1273 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,&
curscÜe
)è!ğ
NULL
) {

1274 ià(
nx
) ;

1275 ià(
šü
) {

1276 
scÜe
 +ğ
curscÜe
;

1277 ià(
	`i¢ª
(
scÜe
)) {

1278 
	`uÆockDb
(
c
->
db
);

1279 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1280 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1281 
ş—nup
;

1286 ià(
scÜe
 !ğ
curscÜe
) {

1287 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1288 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1289 
c
->
v–
->
dœty
++;

1290 
upd©ed
++;

1292 
´oûs£d
++;

1293 } ià(!
xx
) {

1296 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1297 ià(
	`zzlL’gth
(
zobj
->
±r
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1298 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1299 ià(
	`sd¦’
(
–e
->
±r
è> 
£rv”
.
z£t_max_zli¡_v®ue
)

1300 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1301 
c
->
v–
->
dœty
++;

1302 
added
++;

1303 
´oûs£d
++;

1305 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1306 
z£t
 *
zs
 = 
zobj
->
±r
;

1307 
zskli¡Node
 *
znode
;

1308 
diùEÁry
 *
de
;

1310 
–e
 = 
c
->
¬gv
[
scÜeidx
+1+
j
*2] =

1311 
	`ŒyObjeùEncodšg
(
c
->
¬gv
[
scÜeidx
+1+
j
*2]);

1312 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1313 ià(
de
 !ğ
NULL
) {

1314 ià(
nx
) ;

1315 
curobj
 = 
	`diùG‘Key
(
de
);

1316 
curscÜe
 = *(*)
	`diùG‘V®
(
de
);

1318 ià(
šü
) {

1319 
scÜe
 +ğ
curscÜe
;

1320 ià(
	`i¢ª
(
scÜe
)) {

1321 
	`uÆockDb
(
c
->
db
);

1322 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1323 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1326 
ş—nup
;

1333 ià(
scÜe
 !ğ
curscÜe
) {

1334 
	`£rv”As£¹W™hInfo
(
c
,
curobj
,
	`z¦D–‘e
(
zs
->
z¦
,
curscÜe
,curobj));

1335 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
curobj
);

1336 
	`diùG‘V®
(
de
èğ&
znode
->
scÜe
;

1337 
c
->
v–
->
dœty
++;

1338 
upd©ed
++;

1340 
´oûs£d
++;

1341 } ià(!
xx
) {

1342 
–e
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(ele);

1343 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1344 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`diùAdd
(
zs
->
diù
,
–e
,&
znode
->
scÜe
è=ğ
DICT_OK
);

1345 
c
->
v–
->
dœty
++;

1346 
added
++;

1347 
´oûs£d
++;

1350 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1354 
	`uÆockDb
(
c
->
db
);

1355 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1357 
»¶y_to_ş›Á
:

1358 ià(
šü
) {

1359 ià(
´oûs£d
)

1360 
	`addR•lyDoubË
(
c
,
scÜe
);

1362 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1364 
	`addR•lyLÚgLÚg
(
c
,
ch
 ? 
added
+
upd©ed
 :‡dded);

1367 
ş—nup
:

1368 
	`dä“
(
scÜes
);

1369 ià(
added
 || 
upd©ed
) {

1370 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1371 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

1372 
šü
 ? "zšü" : "zadd", 
key
, 
c
->
db
->
id
);

1374 
	}
}

1376 
	$zaddCommªd
(
ş›Á
 *
c
) {

1377 
	`zaddG’”icCommªd
(
c
,
ZADD_NONE
);

1378 
	}
}

1380 
	$zšübyCommªd
(
ş›Á
 *
c
) {

1381 
	`zaddG’”icCommªd
(
c
,
ZADD_INCR
);

1382 
	}
}

1384 
	$z»mCommªd
(
ş›Á
 *
c
) {

1385 
robj
 *
key
 = 
c
->
¬gv
[1];

1386 
robj
 *
zobj
;

1387 
d–‘ed
 = 0, 
key»moved
 = 0, 
j
;

1388 
expœed
 = 0;

1390 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1391 
	`lockDbWr™e
(
c
->
db
);

1392 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

1393 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

1394 
	`uÆockDb
(
c
->
db
);

1395 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1399 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1400 *
•Œ
;

1402 
j
 = 2; j < 
c
->
¬gc
; j++) {

1403 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
c
->
¬gv
[
j
],
NULL
)) != NULL) {

1404 
d–‘ed
++;

1405 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1406 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1407 
	`dbD–‘e
(
c
->
db
,
key
);

1408 
key»moved
 = 1;

1413 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1414 
z£t
 *
zs
 = 
zobj
->
±r
;

1415 
diùEÁry
 *
de
;

1416 
scÜe
;

1418 
j
 = 2; j < 
c
->
¬gc
; j++) {

1419 
de
 = 
	`diùFšd
(
zs
->
diù
,
c
->
¬gv
[
j
]);

1420 ià(
de
 !ğ
NULL
) {

1421 
d–‘ed
++;

1424 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1425 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[
j
],
	`z¦D–‘e
(
zs
->
z¦
,
scÜe
,c->argv[j]));

1428 
	`diùD–‘e
(
zs
->
diù
,
c
->
¬gv
[
j
]);

1429 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1430 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1431 
	`dbD–‘e
(
c
->
db
,
key
);

1432 
key»moved
 = 1;

1438 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1441 ià(
d–‘ed
) {

1442 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,"z»m",
key
,
c
->
db
->
id
);

1443 ià(
key»moved
)

1444 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1445 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1446 
c
->
v–
->
dœty
 +ğ
d–‘ed
;

1448 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1449 
	`uÆockDb
(
c
->
db
);

1450 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1451 
	}
}

1454 
	#ZRANGE_RANK
 0

	)

1455 
	#ZRANGE_SCORE
 1

	)

1456 
	#ZRANGE_LEX
 2

	)

1457 
	$z»m¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
¿ng‘y³
) {

1458 
robj
 *
key
 = 
c
->
¬gv
[1];

1459 
robj
 *
zobj
;

1460 
key»moved
 = 0;

1461 
d–‘ed
 = 0;

1462 
z¿nge¥ec
 
¿nge
;

1463 
zËx¿nge¥ec
 
Ëx¿nge
;

1464 
¡¬t
, 
’d
, 
Î’
;

1465 
expœed
 = 0;

1468 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1469 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
VR_OK
) ||

1470 (
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
VR_OK
))

1472 } ià(
¿ng‘y³
 =ğ
ZRANGE_SCORE
) {

1473 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
VR_OK
) {

1474 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

1477 } ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
) {

1478 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
Ëx¿nge
è!ğ
VR_OK
) {

1479 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

1484 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1485 
	`lockDbWr™e
(
c
->
db
);

1487 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

1488 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)è
ş—nup
;

1490 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1492 
Î’
 = 
	`z£tL’gth
(
zobj
);

1493 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

1494 ià(
’d
 < 0è’d = 
Î’
+end;

1495 ià(
¡¬t
 < 0) start = 0;

1499 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

1500 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1501 
ş—nup
;

1503 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

1507 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1508 
¿ng‘y³
) {

1509 
ZRANGE_RANK
:

1510 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByRªk
(zobj->±r,
¡¬t
+1,
’d
+1,&
d–‘ed
);

1512 
ZRANGE_SCORE
:

1513 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByScÜe
(zobj->±r,&
¿nge
,&
d–‘ed
);

1515 
ZRANGE_LEX
:

1516 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByLex
(zobj->±r,&
Ëx¿nge
,&
d–‘ed
);

1519 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1520 
	`dbD–‘e
(
c
->
db
,
key
);

1521 
key»moved
 = 1;

1523 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1524 
z£t
 *
zs
 = 
zobj
->
±r
;

1525 
¿ng‘y³
) {

1526 
ZRANGE_RANK
:

1527 
d–‘ed
 = 
	`z¦D–‘eRªgeByRªk
(
zs
->
z¦
,
¡¬t
+1,
’d
+1,zs->
diù
);

1529 
ZRANGE_SCORE
:

1530 
d–‘ed
 = 
	`z¦D–‘eRªgeByScÜe
(
zs
->
z¦
,&
¿nge
,zs->
diù
);

1532 
ZRANGE_LEX
:

1533 
d–‘ed
 = 
	`z¦D–‘eRªgeByLex
(
zs
->
z¦
,&
Ëx¿nge
,zs->
diù
);

1536 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1537 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1538 
	`dbD–‘e
(
c
->
db
,
key
);

1539 
key»moved
 = 1;

1542 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1546 ià(
d–‘ed
) {

1547 *
ev’t
[3] = {"zremrangebyrank","zremrangebyscore","zremrangebylex"};

1548 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1549 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,
ev’t
[
¿ng‘y³
],
key
,
c
->
db
->
id
);

1550 ià(
key»moved
)

1551 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1553 
c
->
v–
->
dœty
 +ğ
d–‘ed
;

1554 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1556 
ş—nup
:

1557 ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
è
	`z¦F»eLexRªge
(&
Ëx¿nge
);

1558 
	`uÆockDb
(
c
->
db
);

1559 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1560 
	}
}

1562 
	$z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
) {

1563 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_RANK
);

1564 
	}
}

1566 
	$z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

1567 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_SCORE
);

1568 
	}
}

1570 
	$z»m¿ngebyËxCommªd
(
ş›Á
 *
c
) {

1571 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_LEX
);

1572 
	}
}

1580 
	#OPVAL_DIRTY_ROBJ
 1

	)

1581 
	#OPVAL_DIRTY_LL
 2

	)

1582 
	#OPVAL_VALID_LL
 4

	)

1584 
_™”£t
 
	t™”£t
;

1585 
_™”z£t
 
	t™”z£t
;

1587 
	$zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1588 ià(
İ
->
subjeù
 =ğ
NULL
)

1591 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1592 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1593 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1594 
™
->
is
.i ğ
İ
->
subjeù
->
±r
;

1595 
™
->
is
.
ii
 = 0;

1596 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1597 
™
->
ht
.
diù
 = 
İ
->
subjeù
->
±r
;

1598 
™
->
ht
.
di
 = 
	`diùG‘I‹¿tÜ
(
İ
->
subjeù
->
±r
);

1599 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1601 
	`£rv”Pªic
("Unknown setƒncoding");

1603 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1604 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1605 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1606 
™
->
zl
.zÈğ
İ
->
subjeù
->
±r
;

1607 
™
->
zl
.
•Œ
 = 
	`zli¡Index
(it->zl.zl,0);

1608 ià(
™
->
zl
.
•Œ
 !ğ
NULL
) {

1609 
™
->
zl
.
¥Œ
 = 
	`zli¡Next
(™->zl.zl,™->zl.
•Œ
);

1610 
	`ASSERT
(
™
->
zl
.
¥Œ
 !ğ
NULL
);

1612 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1613 
™
->
¦
.
zs
 = 
İ
->
subjeù
->
±r
;

1614 
™
->
¦
.
node
 = it->¦.
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1616 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1619 
	`£rv”Pªic
("Unsupportedype");

1621 
	}
}

1623 
	$zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1624 ià(
İ
->
subjeù
 =ğ
NULL
)

1627 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1628 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1629 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1630 
	`UNUSED
(
™
);

1631 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1632 
	`diùR–—£I‹¿tÜ
(
™
->
ht
.
di
);

1634 
	`£rv”Pªic
("Unknown setƒncoding");

1636 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1637 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1638 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1639 
	`UNUSED
(
™
);

1640 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1641 
	`UNUSED
(
™
);

1643 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1646 
	`£rv”Pªic
("Unsupportedype");

1648 
	}
}

1650 
	$zuiL’gth
(
z£tİ¤c
 *
İ
) {

1651 ià(
İ
->
subjeù
 =ğ
NULL
)

1654 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1655 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1656  
	`št£tL’
(
İ
->
subjeù
->
±r
);

1657 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1658 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1659  
	`diùSize
(
ht
);

1661 
	`£rv”Pªic
("Unknown setƒncoding");

1663 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1664 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1665  
	`zzlL’gth
(
İ
->
subjeù
->
±r
);

1666 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1667 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1668  
zs
->
z¦
->
Ëngth
;

1670 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1673 
	`£rv”Pªic
("Unsupportedype");

1675 
	}
}

1680 
	$zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
) {

1681 
»t
;

1683 ià(
İ
->
subjeù
 =ğ
NULL
)

1686 ià(
v®
->
æags
 & 
OPVAL_DIRTY_ROBJ
)

1687 
	`deüRefCouÁ
(
v®
->
–e
);

1689 
	`mem£t
(
v®
,0,(
z£tİv®
));

1691 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1692 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1693 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1694 
št64_t
 
–l
;

1696 ià(!
	`št£tG‘
(
™
->
is
.is,™->is.
ii
,&
–l
))

1698 
v®
->
–l
 =ƒll;

1699 
v®
->
scÜe
 = 1.0;

1702 
™
->
is
.
ii
++;

1703 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1704 ià(
™
->
ht
.
de
 =ğ
NULL
)

1706 
v®
->
–e
 = 
	`diùG‘Key
(
™
->
ht
.
de
);

1707 
v®
->
scÜe
 = 1.0;

1710 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1712 
	`£rv”Pªic
("Unknown setƒncoding");

1714 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1715 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1716 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1718 ià(
™
->
zl
.
•Œ
 =ğ
NULL
 || it->zl.
¥Œ
 == NULL)

1720 
»t
 = (è
	`zli¡G‘
(
™
->
zl
.
•Œ
,&
v®
->
e¡r
,&v®->
–’
,&v®->
–l
);

1721 
	`ASSERT
(
»t
 > 0);

1722 
v®
->
scÜe
 = 
	`zzlG‘ScÜe
(
™
->
zl
.
¥Œ
);

1725 
	`zzlNext
(
™
->
zl
.zl,&™->zl.
•Œ
,&™->zl.
¥Œ
);

1726 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1727 ià(
™
->
¦
.
node
 =ğ
NULL
)

1729 
v®
->
–e
 = 
™
->
¦
.
node
->
obj
;

1730 
v®
->
scÜe
 = 
™
->
¦
.
node
->score;

1733 
™
->
¦
.
node
 = it->¦.node->
Ëv–
[0].
fÜw¬d
;

1735 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1738 
	`£rv”Pªic
("Unsupportedype");

1741 
	}
}

1743 
	$zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
) {

1744 ià(!(
v®
->
æags
 & 
OPVAL_DIRTY_LL
)) {

1745 
v®
->
æags
 |ğ
OPVAL_DIRTY_LL
;

1747 ià(
v®
->
–e
 !ğ
NULL
) {

1748 ià(
v®
->
–e
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

1749 
v®
->
–l
 = ()v®->
–e
->
±r
;

1750 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1751 } ià(
	`sdsEncodedObjeù
(
v®
->
–e
)) {

1752 ià(
	`¡ršg2Î
(
v®
->
–e
->
±r
,
	`sd¦’
(v®->–e->±r),&v®->
–l
))

1753 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1755 
	`£rv”Pªic
("Unsupportedƒlementƒncoding");

1757 } ià(
v®
->
e¡r
 !ğ
NULL
) {

1758 ià(
	`¡ršg2Î
((*)
v®
->
e¡r
,v®->
–’
,&v®->
–l
))

1759 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1762 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1765  
v®
->
æags
 & 
OPVAL_VALID_LL
;

1766 
	}
}

1768 
robj
 *
	$zuiObjeùFromV®ue
(
z£tİv®
 *
v®
) {

1769 ià(
v®
->
–e
 =ğ
NULL
) {

1770 ià(
v®
->
e¡r
 !ğ
NULL
) {

1771 
v®
->
–e
 = 
	`ü—‹SŒšgObjeù
((*)v®->
e¡r
,v®->
–’
);

1773 
v®
->
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(v®->
–l
);

1775 
v®
->
æags
 |ğ
OPVAL_DIRTY_ROBJ
;

1777  
v®
->
–e
;

1778 
	}
}

1780 
	$zuiBufãrFromV®ue
(
z£tİv®
 *
v®
) {

1781 ià(
v®
->
e¡r
 =ğ
NULL
) {

1782 ià(
v®
->
–e
 !ğ
NULL
) {

1783 ià(
v®
->
–e
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

1784 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),()v®->
–e
->
±r
);

1785 
v®
->
e¡r
 = v®->
_buf
;

1786 } ià(
	`sdsEncodedObjeù
(
v®
->
–e
)) {

1787 
v®
->
–’
 = 
	`sd¦’
(v®->
–e
->
±r
);

1788 
v®
->
e¡r
 = v®->
–e
->
±r
;

1790 
	`£rv”Pªic
("Unsupportedƒlementƒncoding");

1793 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),v®->
–l
);

1794 
v®
->
e¡r
 = v®->
_buf
;

1798 
	}
}

1802 
	$zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
) {

1803 ià(
İ
->
subjeù
 =ğ
NULL
)

1806 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1807 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1808 ià(
	`zuiLÚgLÚgFromV®ue
(
v®
) &&

1809 
	`št£tFšd
(
İ
->
subjeù
->
±r
,
v®
->
–l
))

1811 *
scÜe
 = 1.0;

1816 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1817 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1818 
	`zuiObjeùFromV®ue
(
v®
);

1819 ià(
	`diùFšd
(
ht
,
v®
->
–e
è!ğ
NULL
) {

1820 *
scÜe
 = 1.0;

1826 
	`£rv”Pªic
("Unknown setƒncoding");

1828 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1829 
	`zuiObjeùFromV®ue
(
v®
);

1831 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1832 ià(
	`zzlFšd
(
İ
->
subjeù
->
±r
,
v®
->
–e
,
scÜe
è!ğ
NULL
) {

1838 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1839 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1840 
diùEÁry
 *
de
;

1841 ià((
de
 = 
	`diùFšd
(
zs
->
diù
,
v®
->
–e
)è!ğ
NULL
) {

1842 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1848 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1851 
	`£rv”Pªic
("Unsupportedype");

1853 
	}
}

1855 
	$zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

1856  
	`zuiL’gth
((
z£tİ¤c
*)
s1
è- zuiL’gth((z£tİ¤c*)
s2
);

1857 
	}
}

1859 
	#REDIS_AGGR_SUM
 1

	)

1860 
	#REDIS_AGGR_MIN
 2

	)

1861 
	#REDIS_AGGR_MAX
 3

	)

1862 
	#zuniÚIÁ”DiùV®ue
(
_e
è(
	`diùG‘V®
(_eè=ğ
NULL
 ? 1.0 : *(*)diùG‘V®(_e))

	)

1864 
šlše
 
	$zuniÚIÁ”Agg»g©e
(*
rg‘
, 
v®
, 
agg»g©e
) {

1865 ià(
agg»g©e
 =ğ
REDIS_AGGR_SUM
) {

1866 *
rg‘
 = *rg‘ + 
v®
;

1870 ià(
	`i¢ª
(*
rg‘
)) *target = 0.0;

1871 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MIN
) {

1872 *
rg‘
 = 
v®
 < *target ? val : *target;

1873 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MAX
) {

1874 *
rg‘
 = 
v®
 > *target ? val : *target;

1877 
	`£rv”Pªic
("Unknown ZUNION/INTER‡ggregateype");

1879 
	}
}

1881 
	#SET_OP_UNION
 0

	)

1882 
	#SET_OP_DIFF
 1

	)

1883 
	#SET_OP_INTER
 2

	)

1885 
	$zuniÚIÁ”G’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
d¡key
, 
İ
) {

1886 
i
, 
j
;

1887 
£Šum
;

1888 
agg»g©e
 = 
REDIS_AGGR_SUM
;

1889 
z£tİ¤c
 *
¤c
;

1890 
z£tİv®
 
zv®
;

1891 
robj
 *
tmp
;

1892 
max––’
 = 0;

1893 
robj
 *
d¡obj
;

1894 
z£t
 *
d¡z£t
;

1895 
zskli¡Node
 *
znode
;

1896 
touched
 = 0;

1899 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
£Šum
, 
NULL
è!ğ
VR_OK
))

1902 ià(
£Šum
 < 1) {

1903 
	`addR•lyE¼Ü
(
c
,

1909 ià(
£Šum
 > 
c
->
¬gc
-3) {

1910 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1915 
¤c
 = 
	`dÿÎoc
(
£Šum
, (
z£tİ¤c
));

1916 
i
 = 0, 
j
 = 3; i < 
£Šum
; i++, j++) {

1917 
robj
 *
obj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
],
NULL
);

1918 ià(
obj
 !ğ
NULL
) {

1919 ià(
obj
->
ty³
 !ğ
OBJ_ZSET
 && obj->ty³ !ğ
OBJ_SET
) {

1920 
	`dä“
(
¤c
);

1921 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1925 
¤c
[
i
].
subjeù
 = 
obj
;

1926 
¤c
[
i
].
ty³
 = 
obj
->type;

1927 
¤c
[
i
].
’codšg
 = 
obj
->encoding;

1929 
¤c
[
i
].
subjeù
 = 
NULL
;

1933 
¤c
[
i
].
weight
 = 1.0;

1937 ià(
j
 < 
c
->
¬gc
) {

1938 
»maššg
 = 
c
->
¬gc
 - 
j
;

1940 
»maššg
) {

1941 ià(
»maššg
 >ğ(
£Šum
 + 1è&& !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"weights")) {

1942 
j
++; 
»maššg
--;

1943 
i
 = 0; i < 
£Šum
; i++, 
j
++, 
»maššg
--) {

1944 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
],&
¤c
[
i
].
weight
,

1945 "weighˆv®ui nÙ‡ flßt"è!ğ
VR_OK
)

1947 
	`dä“
(
¤c
);

1951 } ià(
»maššg
 >ğ2 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"aggregate")) {

1952 
j
++; 
»maššg
--;

1953 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"sum")) {

1954 
agg»g©e
 = 
REDIS_AGGR_SUM
;

1955 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"min")) {

1956 
agg»g©e
 = 
REDIS_AGGR_MIN
;

1957 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"max")) {

1958 
agg»g©e
 = 
REDIS_AGGR_MAX
;

1960 
	`dä“
(
¤c
);

1961 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1964 
j
++; 
»maššg
--;

1966 
	`dä“
(
¤c
);

1967 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1975 
	`qsÜt
(
¤c
,
£Šum
,(
z£tİ¤c
),
zuiCom·»ByC¬dš®™y
);

1977 
d¡obj
 = 
	`ü—‹Z£tObjeù
();

1978 
d¡z£t
 = 
d¡obj
->
±r
;

1979 
	`mem£t
(&
zv®
, 0, (zval));

1981 ià(
İ
 =ğ
SET_OP_INTER
) {

1983 ià(
	`zuiL’gth
(&
¤c
[0]) > 0) {

1986 
	`zuiIn™I‹¿tÜ
(&
¤c
[0]);

1987 
	`zuiNext
(&
¤c
[0],&
zv®
)) {

1988 
scÜe
, 
v®ue
;

1990 
scÜe
 = 
¤c
[0].
weight
 * 
zv®
.score;

1991 ià(
	`i¢ª
(
scÜe
)) score = 0;

1993 
j
 = 1; j < 
£Šum
; j++) {

1996 ià(
¤c
[
j
].
subjeù
 == src[0].subject) {

1997 
v®ue
 = 
zv®
.
scÜe
*
¤c
[
j
].
weight
;

1998 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

1999 } ià(
	`zuiFšd
(&
¤c
[
j
],&
zv®
,&
v®ue
)) {

2000 
v®ue
 *ğ
¤c
[
j
].
weight
;

2001 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

2008 ià(
j
 =ğ
£Šum
) {

2009 
tmp
 = 
	`zuiObjeùFromV®ue
(&
zv®
);

2010 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
tmp
);

2011 
	`šüRefCouÁ
(
tmp
);

2012 
	`diùAdd
(
d¡z£t
->
diù
,
tmp
,&
znode
->
scÜe
);

2013 
	`šüRefCouÁ
(
tmp
);

2015 ià(
	`sdsEncodedObjeù
(
tmp
)) {

2016 ià(
	`sd¦’
(
tmp
->
±r
è> 
max––’
)

2017 
max––’
 = 
	`sd¦’
(
tmp
->
±r
);

2021 
	`zuiCË¬I‹¿tÜ
(&
¤c
[0]);

2023 } ià(
İ
 =ğ
SET_OP_UNION
) {

2024 
diù
 *
accumuÏtÜ
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

2025 
diùI‹¿tÜ
 *
di
;

2026 
diùEÁry
 *
de
;

2027 
scÜe
;

2029 ià(
£Šum
) {

2032 
	`diùEx·nd
(
accumuÏtÜ
,
	`zuiL’gth
(&
¤c
[
£Šum
-1]));

2037 
i
 = 0; i < 
£Šum
; i++) {

2038 ià(
	`zuiL’gth
(&
¤c
[
i
]) == 0) ;

2040 
	`zuiIn™I‹¿tÜ
(&
¤c
[
i
]);

2041 
	`zuiNext
(&
¤c
[
i
],&
zv®
)) {

2043 
scÜe
 = 
¤c
[
i
].
weight
 * 
zv®
.score;

2044 ià(
	`i¢ª
(
scÜe
)) score = 0;

2047 
de
 = 
	`diùFšd
(
accumuÏtÜ
,
	`zuiObjeùFromV®ue
(&
zv®
));

2049 ià(
de
 =ğ
NULL
) {

2050 
tmp
 = 
	`zuiObjeùFromV®ue
(&
zv®
);

2054 ià(
	`sdsEncodedObjeù
(
tmp
)) {

2055 ià(
	`sd¦’
(
tmp
->
±r
è> 
max––’
)

2056 
max––’
 = 
	`sd¦’
(
tmp
->
±r
);

2059 
de
 = 
	`diùAddRaw
(
accumuÏtÜ
,
tmp
);

2060 
	`šüRefCouÁ
(
tmp
);

2061 
	`diùS‘DoubËV®
(
de
,
scÜe
);

2069 
	`zuniÚIÁ”Agg»g©e
(&
de
->
v
.
d
,
scÜe
,
agg»g©e
);

2072 
	`zuiCË¬I‹¿tÜ
(&
¤c
[
i
]);

2076 
di
 = 
	`diùG‘I‹¿tÜ
(
accumuÏtÜ
);

2081 
	`diùEx·nd
(
d¡z£t
->
diù
,
	`diùSize
(
accumuÏtÜ
));

2083 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2084 
robj
 *
–e
 = 
	`diùG‘Key
(
de
);

2085 
scÜe
 = 
	`diùG‘DoubËV®
(
de
);

2086 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
–e
);

2087 
	`šüRefCouÁ
(
–e
);

2088 
	`diùAdd
(
d¡z£t
->
diù
,
–e
,&
znode
->
scÜe
);

2089 
	`šüRefCouÁ
(
–e
);

2091 
	`diùR–—£I‹¿tÜ
(
di
);

2094 
	`diùR–—£
(
accumuÏtÜ
);

2096 
	`£rv”Pªic
("Unknown operator");

2099 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

2100 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2101 
touched
 = 1;

2102 
£rv”
.
dœty
++;

2104 ià(
d¡z£t
->
z¦
->
Ëngth
) {

2105 
	`z£tCÚv”tToZli¡IfN“ded
(
d¡obj
,
max––’
);

2106 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

2107 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
d¡obj
));

2108 ià(!
touched
è
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2109 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

2110 (
İ
 =ğ
SET_OP_UNION
) ? "zunionstore" : "zinterstore",

2111 
d¡key
,
c
->
db
->
id
);

2112 
£rv”
.
dœty
++;

2114 
	`deüRefCouÁ
(
d¡obj
);

2115 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

2116 ià(
touched
)

2117 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
d¡key
,
c
->
db
->
id
);

2119 
	`dä“
(
¤c
);

2120 
	}
}

2122 
	$zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

2123 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_UNION
);

2124 
	}
}

2126 
	$zš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

2127 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_INTER
);

2128 
	}
}

2130 
	$z¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2131 
robj
 *
key
 = 
c
->
¬gv
[1];

2132 
robj
 *
zobj
;

2133 
w™hscÜes
 = 0;

2134 
¡¬t
;

2135 
’d
;

2136 
Î’
;

2137 
¿ng–’
;

2139 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
VR_OK
) ||

2140 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
VR_OK
)) ;

2142 ià(
c
->
¬gc
 =ğ5 && !
	`¡rÿ£cmp
(c->
¬gv
[4]->
±r
,"withscores")) {

2143 
w™hscÜes
 = 1;

2144 } ià(
c
->
¬gc
 >= 5) {

2145 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2149 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2150 
	`lockDbR—d
(
c
->
db
);

2151 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

2152 
	`uÆockDb
(
c
->
db
);

2153 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2155 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2156 
	`uÆockDb
(
c
->
db
);

2157 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2162 
Î’
 = 
	`z£tL’gth
(
zobj
);

2163 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

2164 ià(
’d
 < 0è’d = 
Î’
+end;

2165 ià(
¡¬t
 < 0) start = 0;

2169 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

2170 
	`uÆockDb
(
c
->
db
);

2171 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2172 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

2175 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

2176 
¿ng–’
 = (
’d
-
¡¬t
)+1;

2179 
	`addR•lyMuÉiBulkL’
(
c
, 
w™hscÜes
 ? (
¿ng–’
*2) :„angelen);

2181 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2182 *
zl
 = 
zobj
->
±r
;

2183 *
•Œ
, *
¥Œ
;

2184 *
v¡r
;

2185 
vËn
;

2186 
vlÚg
;

2188 ià(
»v”£
)

2189 
•Œ
 = 
	`zli¡Index
(
zl
,-2-(2*
¡¬t
));

2191 
•Œ
 = 
	`zli¡Index
(
zl
,2*
¡¬t
);

2193 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2194 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2196 
¿ng–’
--) {

2197 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
 && 
¥Œ
 != NULL);

2198 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2199 ià(
v¡r
 =ğ
NULL
)

2200 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2202 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2204 ià(
w™hscÜes
)

2205 
	`addR•lyDoubË
(
c
,
	`zzlG‘ScÜe
(
¥Œ
));

2207 ià(
»v”£
)

2208 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2210 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2213 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2214 
z£t
 *
zs
 = 
zobj
->
±r
;

2215 
zskli¡
 *
z¦
 = 
zs
->zsl;

2216 
zskli¡Node
 *
Ê
;

2217 
robj
 *
–e
;

2220 ià(
»v”£
) {

2221 
Ê
 = 
z¦
->

;

2222 ià(
¡¬t
 > 0)

2223 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
Î’
-
¡¬t
);

2225 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

2226 ià(
¡¬t
 > 0)

2227 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

2230 
¿ng–’
--) {

2231 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
Ê
 !ğ
NULL
);

2232 
–e
 = 
Ê
->
obj
;

2233 
	`addR•lyBulk
(
c
,
–e
);

2234 ià(
w™hscÜes
)

2235 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2236 
Ê
 = 
»v”£
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

2239 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2242 
	`uÆockDb
(
c
->
db
);

2243 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2244 
	}
}

2246 
	$z¿ngeCommªd
(
ş›Á
 *
c
) {

2247 
	`z¿ngeG’”icCommªd
(
c
,0);

2248 
	}
}

2250 
	$z»v¿ngeCommªd
(
ş›Á
 *
c
) {

2251 
	`z¿ngeG’”icCommªd
(
c
,1);

2252 
	}
}

2255 
	$g’”icZ¿ngebyscÜeCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2256 
z¿nge¥ec
 
¿nge
;

2257 
robj
 *
key
 = 
c
->
¬gv
[1];

2258 
robj
 *
zobj
;

2259 
off£t
 = 0, 
lim™
 = -1;

2260 
w™hscÜes
 = 0;

2261 
¿ng–’
 = 0;

2262 *
»¶yËn
 = 
NULL
;

2263 
mšidx
, 
maxidx
;

2266 ià(
»v”£
) {

2268 
maxidx
 = 2; 
mšidx
 = 3;

2271 
mšidx
 = 2; 
maxidx
 = 3;

2274 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
VR_OK
) {

2275 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2281 ià(
c
->
¬gc
 > 4) {

2282 
»maššg
 = 
c
->
¬gc
 - 4;

2283 
pos
 = 4;

2285 
»maššg
) {

2286 ià(
»maššg
 >ğ1 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"withscores")) {

2287 
pos
++; 
»maššg
--;

2288 
w™hscÜes
 = 1;

2289 } ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2290 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
VR_OK
) ||

2291 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
VR_OK
)) ;

2292 
pos
 +ğ3; 
»maššg
 -= 3;

2294 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2300 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2301 
	`lockDbR—d
(
c
->
db
);

2303 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

2304 
	`uÆockDb
(
c
->
db
);

2305 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2307 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2308 
	`uÆockDb
(
c
->
db
);

2309 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2313 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2314 *
zl
 = 
zobj
->
±r
;

2315 *
•Œ
, *
¥Œ
;

2316 *
v¡r
;

2317 
vËn
;

2318 
vlÚg
;

2319 
scÜe
;

2322 ià(
»v”£
) {

2323 
•Œ
 = 
	`zzlLa¡InRªge
(
zl
,&
¿nge
);

2325 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2329 ià(
•Œ
 =ğ
NULL
) {

2330 
	`uÆockDb
(
c
->
db
);

2331 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2332 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2337 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2338 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2343 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2347 
•Œ
 && 
off£t
--) {

2348 ià(
»v”£
) {

2349 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2351 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2355 
•Œ
 && 
lim™
--) {

2356 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2359 ià(
»v”£
) {

2360 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
¿nge
)) ;

2362 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) ;

2366 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2368 
¿ng–’
++;

2369 ià(
v¡r
 =ğ
NULL
) {

2370 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2372 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2375 ià(
w™hscÜes
) {

2376 
	`addR•lyDoubË
(
c
,
scÜe
);

2380 ià(
»v”£
) {

2381 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2383 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2386 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2387 
z£t
 *
zs
 = 
zobj
->
±r
;

2388 
zskli¡
 *
z¦
 = 
zs
->zsl;

2389 
zskli¡Node
 *
Ê
;

2392 ià(
»v”£
) {

2393 
Ê
 = 
	`z¦La¡InRªge
(
z¦
,&
¿nge
);

2395 
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
,&
¿nge
);

2399 ià(
Ê
 =ğ
NULL
) {

2400 
	`uÆockDb
(
c
->
db
);

2401 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2402 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2409 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2413 
Ê
 && 
off£t
--) {

2414 ià(
»v”£
) {

2415 
Ê
 =†n->
backw¬d
;

2417 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2421 
Ê
 && 
lim™
--) {

2423 ià(
»v”£
) {

2424 ià(!
	`z¦V®ueG‹Mš
(
Ê
->
scÜe
,&
¿nge
)) ;

2426 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
,&
¿nge
)) ;

2429 
¿ng–’
++;

2430 
	`addR•lyBulk
(
c
,
Ê
->
obj
);

2432 ià(
w™hscÜes
) {

2433 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2437 ià(
»v”£
) {

2438 
Ê
 =†n->
backw¬d
;

2440 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2444 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2447 ià(
w™hscÜes
) {

2448 
¿ng–’
 *= 2;

2451 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2452 
	`uÆockDb
(
c
->
db
);

2453 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2454 
	}
}

2456 
	$z¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2457 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,0);

2458 
	}
}

2460 
	$z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2461 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,1);

2462 
	}
}

2464 
	$zcouÁCommªd
(
ş›Á
 *
c
) {

2465 
robj
 *
key
 = 
c
->
¬gv
[1];

2466 
robj
 *
zobj
;

2467 
z¿nge¥ec
 
¿nge
;

2468 
couÁ
 = 0;

2471 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
VR_OK
) {

2472 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2476 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2477 
	`lockDbR—d
(
c
->
db
);

2479 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
) {

2480 
	`uÆockDb
(
c
->
db
);

2481 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2483 } ià(
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) {

2484 
	`uÆockDb
(
c
->
db
);

2485 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2489 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2490 *
zl
 = 
zobj
->
±r
;

2491 *
•Œ
, *
¥Œ
;

2492 
scÜe
;

2495 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2498 ià(
•Œ
 =ğ
NULL
) {

2499 
	`uÆockDb
(
c
->
db
);

2500 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2501 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2506 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2507 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2508 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
));

2511 
•Œ
) {

2512 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2515 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) {

2518 
couÁ
++;

2519 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2522 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2523 
z£t
 *
zs
 = 
zobj
->
±r
;

2524 
zskli¡
 *
z¦
 = 
zs
->zsl;

2525 
zskli¡Node
 *
zn
;

2526 
¿nk
;

2529 
zn
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
);

2532 ià(
zn
 !ğ
NULL
) {

2533 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2534 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2537 
zn
 = 
	`z¦La¡InRªge
(
z¦
, &
¿nge
);

2540 ià(
zn
 !ğ
NULL
) {

2541 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2542 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2546 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2549 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2550 
	`uÆockDb
(
c
->
db
);

2551 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2552 
	}
}

2554 
	$zËxcouÁCommªd
(
ş›Á
 *
c
) {

2555 
robj
 *
key
 = 
c
->
¬gv
[1];

2556 
robj
 *
zobj
;

2557 
zËx¿nge¥ec
 
¿nge
;

2558 
couÁ
 = 0;

2561 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
VR_OK
) {

2562 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2567 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2568 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
))

2570 
	`z¦F»eLexRªge
(&
¿nge
);

2574 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2575 *
zl
 = 
zobj
->
±r
;

2576 *
•Œ
, *
¥Œ
;

2579 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2582 ià(
•Œ
 =ğ
NULL
) {

2583 
	`z¦F»eLexRªge
(&
¿nge
);

2584 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2589 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2590 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
));

2593 
•Œ
) {

2595 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) {

2598 
couÁ
++;

2599 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2602 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2603 
z£t
 *
zs
 = 
zobj
->
±r
;

2604 
zskli¡
 *
z¦
 = 
zs
->zsl;

2605 
zskli¡Node
 *
zn
;

2606 
¿nk
;

2609 
zn
 = 
	`z¦Fœ¡InLexRªge
(
z¦
, &
¿nge
);

2612 ià(
zn
 !ğ
NULL
) {

2613 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2614 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2617 
zn
 = 
	`z¦La¡InLexRªge
(
z¦
, &
¿nge
);

2620 ià(
zn
 !ğ
NULL
) {

2621 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2622 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2626 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2629 
	`z¦F»eLexRªge
(&
¿nge
);

2630 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2631 
	}
}

2634 
	$g’”icZ¿ngebyËxCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2635 
zËx¿nge¥ec
 
¿nge
;

2636 
robj
 *
key
 = 
c
->
¬gv
[1];

2637 
robj
 *
zobj
;

2638 
off£t
 = 0, 
lim™
 = -1;

2639 
¿ng–’
 = 0;

2640 *
»¶yËn
 = 
NULL
;

2641 
mšidx
, 
maxidx
;

2644 ià(
»v”£
) {

2646 
maxidx
 = 2; 
mšidx
 = 3;

2649 
mšidx
 = 2; 
maxidx
 = 3;

2652 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
VR_OK
) {

2653 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2659 ià(
c
->
¬gc
 > 4) {

2660 
»maššg
 = 
c
->
¬gc
 - 4;

2661 
pos
 = 4;

2663 
»maššg
) {

2664 ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2665 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
VR_OK
) ||

2666 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
VR_OK
)) ;

2667 
pos
 +ğ3; 
»maššg
 -= 3;

2669 
	`z¦F»eLexRªge
(&
¿nge
);

2670 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2677 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2678 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
))

2680 
	`z¦F»eLexRªge
(&
¿nge
);

2684 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2685 *
zl
 = 
zobj
->
±r
;

2686 *
•Œ
, *
¥Œ
;

2687 *
v¡r
;

2688 
vËn
;

2689 
vlÚg
;

2692 ià(
»v”£
) {

2693 
•Œ
 = 
	`zzlLa¡InLexRªge
(
zl
,&
¿nge
);

2695 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2699 ià(
•Œ
 =ğ
NULL
) {

2700 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2701 
	`z¦F»eLexRªge
(&
¿nge
);

2706 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2707 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2712 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2716 
•Œ
 && 
off£t
--) {

2717 ià(
»v”£
) {

2718 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2720 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2724 
•Œ
 && 
lim™
--) {

2726 ià(
»v”£
) {

2727 ià(!
	`zzlLexV®ueG‹Mš
(
•Œ
,&
¿nge
)) ;

2729 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) ;

2734 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2736 
¿ng–’
++;

2737 ià(
v¡r
 =ğ
NULL
) {

2738 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2740 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2744 ià(
»v”£
) {

2745 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2747 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2750 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2751 
z£t
 *
zs
 = 
zobj
->
±r
;

2752 
zskli¡
 *
z¦
 = 
zs
->zsl;

2753 
zskli¡Node
 *
Ê
;

2756 ià(
»v”£
) {

2757 
Ê
 = 
	`z¦La¡InLexRªge
(
z¦
,&
¿nge
);

2759 
Ê
 = 
	`z¦Fœ¡InLexRªge
(
z¦
,&
¿nge
);

2763 ià(
Ê
 =ğ
NULL
) {

2764 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2765 
	`z¦F»eLexRªge
(&
¿nge
);

2772 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2776 
Ê
 && 
off£t
--) {

2777 ià(
»v”£
) {

2778 
Ê
 =†n->
backw¬d
;

2780 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2784 
Ê
 && 
lim™
--) {

2786 ià(
»v”£
) {

2787 ià(!
	`z¦LexV®ueG‹Mš
(
Ê
->
obj
,&
¿nge
)) ;

2789 ià(!
	`z¦LexV®ueL‹Max
(
Ê
->
obj
,&
¿nge
)) ;

2792 
¿ng–’
++;

2793 
	`addR•lyBulk
(
c
,
Ê
->
obj
);

2796 ià(
»v”£
) {

2797 
Ê
 =†n->
backw¬d
;

2799 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2803 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2806 
	`z¦F»eLexRªge
(&
¿nge
);

2807 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2808 
	}
}

2810 
	$z¿ngebyËxCommªd
(
ş›Á
 *
c
) {

2811 
	`g’”icZ¿ngebyËxCommªd
(
c
,0);

2812 
	}
}

2814 
	$z»v¿ngebyËxCommªd
(
ş›Á
 *
c
) {

2815 
	`g’”icZ¿ngebyËxCommªd
(
c
,1);

2816 
	}
}

2818 
	$zÿrdCommªd
(
ş›Á
 *
c
) {

2819 
robj
 *
key
 = 
c
->
¬gv
[1];

2820 
robj
 *
zobj
;

2822 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2823 
	`lockDbR—d
(
c
->
db
);

2824 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
) {

2825 
	`uÆockDb
(
c
->
db
);

2826 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2828 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2829 
	`uÆockDb
(
c
->
db
);

2830 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2834 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
zobj
));

2836 
	`uÆockDb
(
c
->
db
);

2837 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2838 
	}
}

2840 
	$zscÜeCommªd
(
ş›Á
 *
c
) {

2841 
robj
 *
key
 = 
c
->
¬gv
[1];

2842 
robj
 *
zobj
;

2843 
scÜe
;

2845 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2846 
	`lockDbR—d
(
c
->
db
);

2847 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

2848 
	`uÆockDb
(
c
->
db
);

2849 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2851 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2852 
	`uÆockDb
(
c
->
db
);

2853 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2857 ià(
	`z£tScÜe
(
zobj
,
c
->
¬gv
[2],&
scÜe
è=ğ
VR_ERROR
) {

2858 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2860 
	`addR•lyDoubË
(
c
,
scÜe
);

2863 
	`uÆockDb
(
c
->
db
);

2864 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2865 
	}
}

2867 
	$z¿nkG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2868 
robj
 *
key
 = 
c
->
¬gv
[1];

2869 
robj
 *
–e
 = 
c
->
¬gv
[2];

2870 
robj
 *
zobj
;

2871 
Î’
;

2872 
¿nk
;

2874 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2875 
	`lockDbR—d
(
c
->
db
);

2876 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

2877 
	`uÆockDb
(
c
->
db
);

2878 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2880 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2881 
	`uÆockDb
(
c
->
db
);

2882 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2885 
Î’
 = 
	`z£tL’gth
(
zobj
);

2887 
	`£rv”As£¹W™hInfo
(
c
,
–e
,
	`sdsEncodedObjeù
(ele));

2889 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2890 *
zl
 = 
zobj
->
±r
;

2891 *
•Œ
, *
¥Œ
;

2893 
•Œ
 = 
	`zli¡Index
(
zl
,0);

2894 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2895 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2896 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
¥Œ
 !ğ
NULL
);

2898 
¿nk
 = 1;

2899 
•Œ
 !ğ
NULL
) {

2900 ià(
	`zli¡Com·»
(
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr)))

2902 
¿nk
++;

2903 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2906 ià(
•Œ
 !ğ
NULL
) {

2907 ià(
»v”£
)

2908 
	`addR•lyLÚgLÚg
(
c
,
Î’
-
¿nk
);

2910 
	`addR•lyLÚgLÚg
(
c
,
¿nk
-1);

2912 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2914 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2915 
z£t
 *
zs
 = 
zobj
->
±r
;

2916 
zskli¡
 *
z¦
 = 
zs
->zsl;

2917 
diùEÁry
 *
de
;

2918 
scÜe
;

2920 
–e
 = 
c
->
¬gv
[2];

2921 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

2922 ià(
de
 !ğ
NULL
) {

2923 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

2924 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
,
scÜe
,
–e
);

2925 
	`£rv”As£¹W™hInfo
(
c
,
–e
,
¿nk
);

2926 ià(
»v”£
)

2927 
	`addR•lyLÚgLÚg
(
c
,
Î’
-
¿nk
);

2929 
	`addR•lyLÚgLÚg
(
c
,
¿nk
-1);

2931 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2934 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2937 
	`uÆockDb
(
c
->
db
);

2938 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2939 
	}
}

2941 
	$z¿nkCommªd
(
ş›Á
 *
c
) {

2942 
	`z¿nkG’”icCommªd
(
c
, 0);

2943 
	}
}

2945 
	$z»v¿nkCommªd
(
ş›Á
 *
c
) {

2946 
	`z¿nkG’”icCommªd
(
c
, 1);

2947 
	}
}

2949 
	$zsÿnCommªd
(
ş›Á
 *
c
) {

2950 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_ZSET
);

2951 
	}
}

	@src/vr_t_zset.c

1 
	~<vr_cÜe.h
>

3 
z¦LexV®ueG‹Mš
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

4 
z¦LexV®ueL‹Max
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

6 
zskli¡Node
 *
	$z¦C»©eNode
(
Ëv–
, 
scÜe
, 
robj
 *
obj
) {

7 
zskli¡Node
 *
zn
 = 
	`d®loc
((*zn)+
Ëv–
*(
zskli¡Lev–
));

8 
zn
->
scÜe
 = score;

9 
zn
->
obj
 = obj;

10  
zn
;

11 
	}
}

13 
zskli¡
 *
	$z¦C»©e
() {

14 
j
;

15 
zskli¡
 *
z¦
;

17 
z¦
 = 
	`d®loc
((*zsl));

18 
z¦
->
Ëv–
 = 1;

19 
z¦
->
Ëngth
 = 0;

20 
z¦
->
h—d”
 = 
	`z¦C»©eNode
(
ZSKIPLIST_MAXLEVEL
,0,
NULL
);

21 
j
 = 0; j < 
ZSKIPLIST_MAXLEVEL
; j++) {

22 
z¦
->
h—d”
->
Ëv–
[
j
].
fÜw¬d
 = 
NULL
;

23 
z¦
->
h—d”
->
Ëv–
[
j
].
¥ª
 = 0;

25 
z¦
->
h—d”
->
backw¬d
 = 
NULL
;

26 
z¦
->

 = 
NULL
;

27  
z¦
;

28 
	}
}

30 
	$z¦F»eNode
(
zskli¡Node
 *
node
) {

32 
	`dä“
(
node
);

33 
	}
}

35 
	$z¦F»e
(
zskli¡
 *
z¦
) {

36 
zskli¡Node
 *
node
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
, *
Ãxt
;

38 
	`dä“
(
z¦
->
h—d”
);

39 
node
) {

40 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

41 
	`z¦F»eNode
(
node
);

42 
node
 = 
Ãxt
;

44 
	`dä“
(
z¦
);

45 
	}
}

51 
	$z¦RªdomLev–
() {

52 
Ëv–
 = 1;

53 (
	`¿ndom
()&0xFFFFè< (
ZSKIPLIST_P
 * 0xFFFF))

54 
Ëv–
 += 1;

55  (
Ëv–
<
ZSKIPLIST_MAXLEVEL
) ?†evel : ZSKIPLIST_MAXLEVEL;

56 
	}
}

58 
zskli¡Node
 *
	$z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
) {

59 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

60 
¿nk
[
ZSKIPLIST_MAXLEVEL
];

61 
i
, 
Ëv–
;

63 
	`ASSERT
(!
	`i¢ª
(
scÜe
));

64 
x
 = 
z¦
->
h—d”
;

65 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

67 
¿nk
[
i
] = i =ğ(
z¦
->
Ëv–
-1) ? 0 :„ank[i+1];

68 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

69 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

70 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

71 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,obj) < 0))) {

72 
¿nk
[
i
] +ğ
x
->
Ëv–
[i].
¥ª
;

73 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

75 
upd©e
[
i
] = 
x
;

81 
Ëv–
 = 
	`z¦RªdomLev–
();

82 ià(
Ëv–
 > 
z¦
->level) {

83 
i
 = 
z¦
->
Ëv–
; i <†evel; i++) {

84 
¿nk
[
i
] = 0;

85 
upd©e
[
i
] = 
z¦
->
h—d”
;

86 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = 
z¦
->
Ëngth
;

88 
z¦
->
Ëv–
 =†evel;

90 
x
 = 
	`z¦C»©eNode
(
Ëv–
,
scÜe
,
obj
);

91 
i
 = 0; i < 
Ëv–
; i++) {

92 
x
->
Ëv–
[
i
].
fÜw¬d
 = 
upd©e
[i]->level[i].forward;

93 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
;

96 
x
->
Ëv–
[
i
].
¥ª
 = 
upd©e
[i]->Ëv–[i].¥ª - (
¿nk
[0] -„ank[i]);

97 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = (
¿nk
[0] -„ank[i]) + 1;

101 
i
 = 
Ëv–
; i < 
z¦
->level; i++) {

102 
upd©e
[
i
]->
Ëv–
[i].
¥ª
++;

105 
x
->
backw¬d
 = (
upd©e
[0] =ğ
z¦
->
h—d”
è? 
NULL
 : update[0];

106 ià(
x
->
Ëv–
[0].
fÜw¬d
)

107 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x;

109 
z¦
->

 = 
x
;

110 
z¦
->
Ëngth
++;

111  
x
;

112 
	}
}

115 
	$z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
) {

116 
i
;

117 
i
 = 0; i < 
z¦
->
Ëv–
; i++) {

118 ià(
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 =ğ
x
) {

119 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 +ğ
x
->level[i].span - 1;

120 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
->level[i].forward;

122 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 -= 1;

125 ià(
x
->
Ëv–
[0].
fÜw¬d
) {

126 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x->backward;

128 
z¦
->

 = 
x
->
backw¬d
;

130 
z¦
->
Ëv–
 > 1 && z¦->
h—d”
->Ëv–[z¦->Ëv–-1].
fÜw¬d
 =ğ
NULL
)

131 
z¦
->
Ëv–
--;

132 
z¦
->
Ëngth
--;

133 
	}
}

136 
	$z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
) {

137 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

138 
i
;

140 
x
 = 
z¦
->
h—d”
;

141 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

142 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

143 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

144 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

145 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,obj) < 0)))

146 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

147 
upd©e
[
i
] = 
x
;

151 
x
 = x->
Ëv–
[0].
fÜw¬d
;

152 ià(
x
 && 
scÜe
 =ğx->scÜ&& 
	`equ®SŒšgObjeùs
(x->
obj
,obj)) {

153 
	`z¦D–‘eNode
(
z¦
, 
x
, 
upd©e
);

154 
	`z¦F»eNode
(
x
);

158 
	}
}

160 
	$z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

161  
¥ec
->
mšex
 ? (
v®ue
 > s³c->
mš
) : (value >= spec->min);

162 
	}
}

164 
	$z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

165  
¥ec
->
maxex
 ? (
v®ue
 < s³c->
max
) : (value <= spec->max);

166 
	}
}

169 
	$z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

170 
zskli¡Node
 *
x
;

173 ià(
¿nge
->
mš
 >„ªge->
max
 ||

174 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

176 
x
 = 
z¦
->

;

177 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueG‹Mš
(x->
scÜe
,
¿nge
))

179 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

180 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueL‹Max
(x->
scÜe
,
¿nge
))

183 
	}
}

187 
zskli¡Node
 *
	$z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

188 
zskli¡Node
 *
x
;

189 
i
;

192 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

194 
x
 = 
z¦
->
h—d”
;

195 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

197 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

198 !
	`z¦V®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

199 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

203 
x
 = x->
Ëv–
[0].
fÜw¬d
;

204 
	`ASSERT
(
x
 !ğ
NULL
);

207 ià(!
	`z¦V®ueL‹Max
(
x
->
scÜe
,
¿nge
)è 
NULL
;

208  
x
;

209 
	}
}

213 
zskli¡Node
 *
	$z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

214 
zskli¡Node
 *
x
;

215 
i
;

218 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

220 
x
 = 
z¦
->
h—d”
;

221 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

223 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

224 
	`z¦V®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

225 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

229 
	`ASSERT
(
x
 !ğ
NULL
);

232 ià(!
	`z¦V®ueG‹Mš
(
x
->
scÜe
,
¿nge
)è 
NULL
;

233  
x
;

234 
	}
}

240 
	$z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

241 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

242 
»moved
 = 0;

243 
i
;

245 
x
 = 
z¦
->
h—d”
;

246 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

247 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
¿nge
->
mšex
 ?

248 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 <ğ
¿nge
->
mš
 :

249 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < 
¿nge
->
mš
))

250 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

251 
upd©e
[
i
] = 
x
;

255 
x
 = x->
Ëv–
[0].
fÜw¬d
;

258 
x
 &&

259 (
¿nge
->
maxex
 ? 
x
->
scÜe
 <„ªge->
max
 : x->score <=„ange->max))

261 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

262 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

263 
	`diùD–‘e
(
diù
,
x
->
obj
);

264 
	`z¦F»eNode
(
x
);

265 
»moved
++;

266 
x
 = 
Ãxt
;

268  
»moved
;

269 
	}
}

271 
	$z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

272 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

273 
»moved
 = 0;

274 
i
;

277 
x
 = 
z¦
->
h—d”
;

278 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

279 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

280 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

281 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

282 
upd©e
[
i
] = 
x
;

286 
x
 = x->
Ëv–
[0].
fÜw¬d
;

289 
x
 && 
	`z¦LexV®ueL‹Max
(x->
obj
,
¿nge
)) {

290 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

291 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

292 
	`diùD–‘e
(
diù
,
x
->
obj
);

293 
	`z¦F»eNode
(
x
);

294 
»moved
++;

295 
x
 = 
Ãxt
;

297  
»moved
;

298 
	}
}

302 
	$z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict) {

303 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

304 
Œav”£d
 = 0, 
»moved
 = 0;

305 
i
;

307 
x
 = 
z¦
->
h—d”
;

308 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

309 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è< 
¡¬t
) {

310 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

311 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

313 
upd©e
[
i
] = 
x
;

316 
Œav”£d
++;

317 
x
 = x->
Ëv–
[0].
fÜw¬d
;

318 
x
 && 
Œav”£d
 <ğ
’d
) {

319 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

320 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

321 
	`diùD–‘e
(
diù
,
x
->
obj
);

322 
	`z¦F»eNode
(
x
);

323 
»moved
++;

324 
Œav”£d
++;

325 
x
 = 
Ãxt
;

327  
»moved
;

328 
	}
}

334 
	$z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
o
) {

335 
zskli¡Node
 *
x
;

336 
¿nk
 = 0;

337 
i
;

339 
x
 = 
z¦
->
h—d”
;

340 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

341 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

342 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

343 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

344 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
o
) <= 0))) {

345 
¿nk
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

346 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

350 ià(
x
->
obj
 && 
	`equ®SŒšgObjeùs
(x->obj,
o
)) {

351  
¿nk
;

355 
	}
}

358 
zskli¡Node
* 
	$z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
) {

359 
zskli¡Node
 *
x
;

360 
Œav”£d
 = 0;

361 
i
;

363 
x
 = 
z¦
->
h—d”
;

364 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

365 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è<ğ
¿nk
)

367 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

368 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

370 ià(
Œav”£d
 =ğ
¿nk
) {

371  
x
;

374  
NULL
;

375 
	}
}

378 
	$z¦P¬£Rªge
(
robj
 *
mš
,„obj *
max
, 
z¿nge¥ec
 *
¥ec
) {

379 *
•Œ
;

380 
¥ec
->
mšex
 = s³c->
maxex
 = 0;

386 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

387 
¥ec
->
mš
 = ()mš->
±r
;

389 ià(((*)
mš
->
±r
)[0] == '(') {

390 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
+1,&
•Œ
);

391 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
VR_ERROR
;

392 
¥ec
->
mšex
 = 1;

394 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
,&
•Œ
);

395 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
VR_ERROR
;

398 ià(
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

399 
¥ec
->
max
 = ()max->
±r
;

401 ià(((*)
max
->
±r
)[0] == '(') {

402 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
+1,&
•Œ
);

403 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
VR_ERROR
;

404 
¥ec
->
maxex
 = 1;

406 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
,&
•Œ
);

407 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
VR_ERROR
;

411  
VR_OK
;

412 
	}
}

429 
	$z¦P¬£LexRªgeI‹m
(
robj
 *
™em
,„obj **
de¡
, *
ex
) {

430 *
c
 = 
™em
->
±r
;

432 
c
[0]) {

434 ià(
c
[1] !ğ'\0'è 
VR_ERROR
;

435 *
ex
 = 0;

436 *
de¡
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
sh¬ed
.
max¡ršg
);

437  
VR_OK
;

439 ià(
c
[1] !ğ'\0'è 
VR_ERROR
;

440 *
ex
 = 0;

441 *
de¡
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(
sh¬ed
.
mš¡ršg
);

442  
VR_OK
;

444 *
ex
 = 1;

445 *
de¡
 = 
	`ü—‹SŒšgObjeù
(
c
+1,
	`sd¦’
(c)-1);

446  
VR_OK
;

448 *
ex
 = 0;

449 *
de¡
 = 
	`ü—‹SŒšgObjeù
(
c
+1,
	`sd¦’
(c)-1);

450  
VR_OK
;

452  
VR_ERROR
;

454 
	}
}

461 
	$z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
) {

464 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
 ||

465 
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
è 
VR_ERROR
;

467 
¥ec
->
mš
 = s³c->
max
 = 
NULL
;

468 ià(
	`z¦P¬£LexRªgeI‹m
(
mš
, &
¥ec
->mš, &¥ec->
mšex
è=ğ
VR_ERROR
 ||

469 
	`z¦P¬£LexRªgeI‹m
(
max
, &
¥ec
->max, &¥ec->
maxex
è=ğ
VR_ERROR
) {

470 ià(
¥ec
->
mš
è
	`ä“Objeù
(spec->min);

471 ià(
¥ec
->
max
è
	`ä“Objeù
(spec->max);

472  
VR_ERROR
;

474  
VR_OK
;

476 
	}
}

480 
	$z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
) {

481 
	`ä“Objeù
(
¥ec
->
mš
);

482 
	`ä“Objeù
(
¥ec
->
max
);

483 
	}
}

488 
	$com·»SŒšgObjeùsFÜLexRªge
(
robj
 *
a
,„obj *
b
) {

489 ià(
a
 =ğ
b
)  0;

491 ià(
a
 =ğ
sh¬ed
.
mš¡ršg
 || 
b
 =ğsh¬ed.
max¡ršg
)  -1;

492 ià(
a
 =ğ
sh¬ed
.
max¡ršg
 || 
b
 =ğsh¬ed.
mš¡ršg
)  1;

493  
	`com·»SŒšgObjeùs
(
a
,
b
);

494 
	}
}

496 
	$z¦LexV®ueG‹Mš
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

497  
¥ec
->
mšex
 ?

498 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
mš
) > 0) :

499 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
mš
) >= 0);

500 
	}
}

502 
	$z¦LexV®ueL‹Max
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

503  
¥ec
->
maxex
 ?

504 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
max
) < 0) :

505 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
max
) <= 0);

506 
	}
}

509 
	$z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

510 
zskli¡Node
 *
x
;

513 ià(
	`com·»SŒšgObjeùsFÜLexRªge
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

514 (
	`com·»SŒšgObjeùs
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

515 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

517 
x
 = 
z¦
->

;

518 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueG‹Mš
(x->
obj
,
¿nge
))

520 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

521 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueL‹Max
(x->
obj
,
¿nge
))

524 
	}
}

528 
zskli¡Node
 *
	$z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

529 
zskli¡Node
 *
x
;

530 
i
;

533 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

535 
x
 = 
z¦
->
h—d”
;

536 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

538 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

539 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

540 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

544 
x
 = x->
Ëv–
[0].
fÜw¬d
;

545 
	`ASSERT
(
x
 !ğ
NULL
);

548 ià(!
	`z¦LexV®ueL‹Max
(
x
->
obj
,
¿nge
)è 
NULL
;

549  
x
;

550 
	}
}

554 
zskli¡Node
 *
	$z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

555 
zskli¡Node
 *
x
;

556 
i
;

559 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

561 
x
 = 
z¦
->
h—d”
;

562 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

564 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

565 
	`z¦LexV®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

566 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

570 
	`ASSERT
(
x
 !ğ
NULL
);

573 ià(!
	`z¦LexV®ueG‹Mš
(
x
->
obj
,
¿nge
)è 
NULL
;

574  
x
;

575 
	}
}

581 
	$zzlG‘ScÜe
(*
¥Œ
) {

582 
»t
;

583 *
v¡r
;

584 
vËn
;

585 
vlÚg
;

586 
buf
[128];

587 
scÜe
;

589 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

591 
»t
 = ()
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
);

592 
	`ASSERT
(
»t
 > 0);

594 ià(
v¡r
) {

595 
	`memıy
(
buf
,
v¡r
,
vËn
);

596 
buf
[
vËn
] = '\0';

597 
scÜe
 = 
	`¡¹od
(
buf
,
NULL
);

599 
scÜe
 = 
vlÚg
;

602  
scÜe
;

603 
	}
}

608 
robj
 *
	$zli¡G‘Objeù
(*
¥Œ
) {

609 
»t
;

610 *
v¡r
;

611 
vËn
;

612 
vlÚg
;

614 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

616 
»t
 = ()
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
);

617 
	`ASSERT
(
»t
 > 0);

619 ià(
v¡r
) {

620  
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

622  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

624 
	}
}

627 
	$zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
) {

628 
»t
;

629 *
v¡r
;

630 
vËn
;

631 
vlÚg
;

632 
vbuf
[32];

633 
mšËn
, 
cmp
;

635 
»t
 = ()
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
);

636 
	`ASSERT
(
»t
 > 0);

637 ià(
v¡r
 =ğ
NULL
) {

639 
vËn
 = 
	`Î2¡ršg
((*)
vbuf
,(vbuf),
vlÚg
);

640 
v¡r
 = 
vbuf
;

643 
mšËn
 = (
vËn
 < 
ş’
) ? vlen : clen;

644 
cmp
 = 
	`memcmp
(
v¡r
,
c¡r
,
mšËn
);

645 ià(
cmp
 =ğ0è 
vËn
-
ş’
;

646  
cmp
;

647 
	}
}

649 
	$zzlL’gth
(*
zl
) {

650  
	`zli¡L’
(
zl
)/2;

651 
	}
}

655 
	$zzlNext
(*
zl
, **
•Œ
, **
¥Œ
) {

656 *
_•Œ
, *
_¥Œ
;

657 
	`ASSERT
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

659 
_•Œ
 = 
	`zli¡Next
(
zl
,*
¥Œ
);

660 ià(
_•Œ
 !ğ
NULL
) {

661 
_¥Œ
 = 
	`zli¡Next
(
zl
,
_•Œ
);

662 
	`ASSERT
(
_¥Œ
 !ğ
NULL
);

665 
_¥Œ
 = 
NULL
;

668 *
•Œ
 = 
_•Œ
;

669 *
¥Œ
 = 
_¥Œ
;

670 
	}
}

674 
	$zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
) {

675 *
_•Œ
, *
_¥Œ
;

676 
	`ASSERT
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

678 
_¥Œ
 = 
	`zli¡P»v
(
zl
,*
•Œ
);

679 ià(
_¥Œ
 !ğ
NULL
) {

680 
_•Œ
 = 
	`zli¡P»v
(
zl
,
_¥Œ
);

681 
	`ASSERT
(
_•Œ
 !ğ
NULL
);

684 
_•Œ
 = 
NULL
;

687 *
•Œ
 = 
_•Œ
;

688 *
¥Œ
 = 
_¥Œ
;

689 
	}
}

693 
	$zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

694 *
p
;

695 
scÜe
;

698 ià(
¿nge
->
mš
 >„ªge->
max
 ||

699 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

702 
p
 = 
	`zli¡Index
(
zl
,-1);

703 ià(
p
 =ğ
NULL
)  0;

704 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

705 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

708 
p
 = 
	`zli¡Index
(
zl
,1);

709 
	`ASSERT
(
p
 !ğ
NULL
);

710 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

711 ià(!
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

715 
	}
}

719 *
	$zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

720 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

721 
scÜe
;

724 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

726 
•Œ
 !ğ
NULL
) {

727 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

728 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

730 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

731 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
)) {

733 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

734  
•Œ
;

735  
NULL
;

739 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

742  
NULL
;

743 
	}
}

747 *
	$zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

748 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

749 
scÜe
;

752 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

754 
•Œ
 !ğ
NULL
) {

755 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

756 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

758 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

759 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

761 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

762  
•Œ
;

763  
NULL
;

768 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

769 ià(
¥Œ
 !ğ
NULL
) {

770 
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
);

771 
	`ASSERT
(
•Œ
 !ğ
NULL
);

773 
•Œ
 = 
NULL
;

777  
NULL
;

778 
	}
}

780 
	$zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

781 
robj
 *
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

782 
»s
 = 
	`z¦LexV®ueG‹Mš
(
v®ue
,
¥ec
);

783 
	`ä“Objeù
(
v®ue
);

784  
»s
;

785 
	}
}

787 
	$zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

788 
robj
 *
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

789 
»s
 = 
	`z¦LexV®ueL‹Max
(
v®ue
,
¥ec
);

790 
	`ä“Objeù
(
v®ue
);

791  
»s
;

792 
	}
}

796 
	$zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

797 *
p
;

800 ià(
	`com·»SŒšgObjeùsFÜLexRªge
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

801 (
	`com·»SŒšgObjeùs
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

802 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

805 
p
 = 
	`zli¡Index
(
zl
,-2);

806 ià(
p
 =ğ
NULL
)  0;

807 ià(!
	`zzlLexV®ueG‹Mš
(
p
,
¿nge
))

810 
p
 = 
	`zli¡Index
(
zl
,0);

811 
	`ASSERT
(
p
 !ğ
NULL
);

812 ià(!
	`zzlLexV®ueL‹Max
(
p
,
¿nge
))

816 
	}
}

820 *
	$zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

821 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

824 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

826 
•Œ
 !ğ
NULL
) {

827 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
)) {

829 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
))

830  
•Œ
;

831  
NULL
;

835 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

836 
	`ASSERT
(
¥Œ
 !ğ
NULL
);

837 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

840  
NULL
;

841 
	}
}

845 *
	$zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

846 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

849 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

851 
•Œ
 !ğ
NULL
) {

852 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

854 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
))

855  
•Œ
;

856  
NULL
;

861 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

862 ià(
¥Œ
 !ğ
NULL
) {

863 
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
);

864 
	`ASSERT
(
•Œ
 !ğ
NULL
);

866 
•Œ
 = 
NULL
;

870  
NULL
;

871 
	}
}

873 *
	$zzlFšd
(*
zl
, 
robj
 *
–e
, *
scÜe
) {

874 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

875 
robj
 *
–e_Ãw
;

877 
–e_Ãw
 = 
	`g‘DecodedObjeù
(
–e
);

878 
•Œ
 !ğ
NULL
) {

879 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

880 
	`£rv”As£¹W™hInfo
(
NULL
,
–e_Ãw
,
¥Œ
 != NULL);

882 ià(
	`zli¡Com·»
(
•Œ
,
–e_Ãw
->
±r
,
	`sd¦’
(ele_new->ptr))) {

884 ià(
scÜe
 !ğ
NULL
è*scÜğ
	`zzlG‘ScÜe
(
¥Œ
);

885 ià(
–e_Ãw
!ğ
–e
è
	`ä“Objeù
(ele_new);

886  
•Œ
;

890 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

893 ià(
–e_Ãw
!ğ
–e
è
	`ä“Objeù
(ele_new);

894  
NULL
;

895 
	}
}

899 *
	$zzlD–‘e
(*
zl
, *
•Œ
) {

900 *
p
 = 
•Œ
;

903 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

904 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

905  
zl
;

906 
	}
}

908 *
	$zzlIn£¹At
(*
zl
, *
•Œ
, 
robj
 *
–e
, 
scÜe
) {

909 *
¥Œ
;

910 
scÜebuf
[128];

911 
scÜ–’
;

912 
size_t
 
off£t
;

914 
	`£rv”As£¹W™hInfo
(
NULL
,
–e
,
	`sdsEncodedObjeù
(ele));

915 
scÜ–’
 = 
	`d2¡ršg
(
scÜebuf
,(scÜebuf),
scÜe
);

916 ià(
•Œ
 =ğ
NULL
) {

917 
zl
 = 
	`zli¡Push
(zl,
–e
->
±r
,
	`sd¦’
ÓË->±r),
ZIPLIST_TAIL
);

918 
zl
 = 
	`zli¡Push
(zl,(*)
scÜebuf
,
scÜ–’
,
ZIPLIST_TAIL
);

921 
off£t
 = 
•Œ
-
zl
;

922 
zl
 = 
	`zli¡In£¹
(zl,
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr));

923 
•Œ
 = 
zl
+
off£t
;

926 
	`£rv”As£¹W™hInfo
(
NULL
,
–e
,(
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)) != NULL);

927 
zl
 = 
	`zli¡In£¹
(zl,
¥Œ
,(*)
scÜebuf
,
scÜ–’
);

930  
zl
;

931 
	}
}

935 *
	$zzlIn£¹
(*
zl
, 
robj
 *
–e
, 
scÜe
) {

936 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

937 
s
;

938 
robj
 *
–e_Ãw
;

940 
–e_Ãw
 = 
	`g‘DecodedObjeù
(
–e
);

941 
•Œ
 !ğ
NULL
) {

942 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

943 
	`£rv”As£¹W™hInfo
(
NULL
,
–e_Ãw
,
¥Œ
 != NULL);

944 
s
 = 
	`zzlG‘ScÜe
(
¥Œ
);

946 ià(
s
 > 
scÜe
) {

950 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e_Ãw
,
scÜe
);

952 } ià(
s
 =ğ
scÜe
) {

954 ià(
	`zzlCom·»EËm’ts
(
•Œ
,
–e_Ãw
->
±r
,
	`sd¦’
(ele_new->ptr)) > 0) {

955 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e_Ãw
,
scÜe
);

961 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

965 ià(
•Œ
 =ğ
NULL
)

966 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e_Ãw
,
scÜe
);

968 ià(
–e_Ãw
 !ğ
–e
è
	`ä“Objeù
(ele_new);

969  
zl
;

970 
	}
}

972 *
	$zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

973 *
•Œ
, *
¥Œ
;

974 
scÜe
;

975 
num
 = 0;

977 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

979 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,
¿nge
);

980 ià(
•Œ
 =ğ
NULL
è 
zl
;

984 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

985 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

986 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

988 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

989 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

990 
num
++;

997 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

998  
zl
;

999 
	}
}

1001 *
	$zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1002 *
•Œ
, *
¥Œ
;

1003 
num
 = 0;

1005 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1007 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,
¿nge
);

1008 ià(
•Œ
 =ğ
NULL
è 
zl
;

1012 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1013 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

1015 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1016 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1017 
num
++;

1024 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1025  
zl
;

1026 
	}
}

1030 *
	$zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
) {

1031 
num
 = (
’d
-
¡¬t
)+1;

1032 ià(
d–‘ed
è*d–‘ed = 
num
;

1033 
zl
 = 
	`zli¡D–‘eRªge
(zl,2*(
¡¬t
-1),2*
num
);

1034  
zl
;

1035 
	}
}

1041 
	$z£tL’gth
(
robj
 *
zobj
) {

1042 
Ëngth
 = -1;

1043 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1044 
Ëngth
 = 
	`zzlL’gth
(
zobj
->
±r
);

1045 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1046 
Ëngth
 = ((
z£t
*)
zobj
->
±r
)->
z¦
->length;

1048 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1050  
Ëngth
;

1051 
	}
}

1053 
	$z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
) {

1054 
z£t
 *
zs
;

1055 
zskli¡Node
 *
node
, *
Ãxt
;

1056 
robj
 *
–e
;

1057 
scÜe
;

1059 ià(
zobj
->
’codšg
 ==ƒncoding) ;

1060 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1061 *
zl
 = 
zobj
->
±r
;

1062 *
•Œ
, *
¥Œ
;

1063 *
v¡r
;

1064 
vËn
;

1065 
vlÚg
;

1067 ià(
’codšg
 !ğ
OBJ_ENCODING_SKIPLIST
)

1068 
	`£rv”Pªic
("Unknownargetƒncoding");

1070 
zs
 = 
	`d®loc
((*zs));

1071 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

1072 
zs
->
z¦
 = 
	`z¦C»©e
();

1074 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1075 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
•Œ
 != NULL);

1076 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1077 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
¥Œ
 != NULL);

1079 
•Œ
 !ğ
NULL
) {

1080 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1081 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

1082 ià(
v¡r
 =ğ
NULL
)

1083 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

1085 
–e
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

1088 
node
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1089 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
	`diùAdd
(
zs
->
diù
,
–e
,&
node
->
scÜe
è=ğ
DICT_OK
);

1090 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1093 
	`dä“
(
zobj
->
±r
);

1094 
zobj
->
±r
 = 
zs
;

1095 
zobj
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

1096 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1097 *
zl
 = 
	`zli¡New
();

1099 ià(
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
)

1100 
	`£rv”Pªic
("Unknownargetƒncoding");

1104 
zs
 = 
zobj
->
±r
;

1105 
node
 = 
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1106 
	`dä“
(
zs
->
z¦
->
h—d”
);

1107 
	`dä“
(
zs
->
z¦
);

1109 
node
) {

1110 
–e
 = 
	`g‘DecodedObjeù
(
node
->
obj
);

1111 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e
,
node
->
scÜe
);

1112 ià(
–e
 !ğ
node
->
obj
è
	`ä“Objeù
(ele);

1113 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

1114 
	`z¦F»eNode
(
node
);

1115 
node
 = 
Ãxt
;

1118 
	`diùR–—£
(
zs
->
diù
);

1119 
	`dä“
(
zs
);

1120 
zobj
->
±r
 = 
zl
;

1121 
zobj
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1123 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1125 
	}
}

1130 
	$z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
) {

1131 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) ;

1132 
z£t
 *z£ˆğ
zobj
->
±r
;

1134 ià(
z£t
->
z¦
->
Ëngth
 <ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

1135 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

1136 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_ZIPLIST
);

1137 
	}
}

1143 
	$z£tScÜe
(
robj
 *
zobj
,„obj *
memb”
, *
scÜe
) {

1144 ià(!
zobj
 || !
memb”
è 
VR_ERROR
;

1146 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1147 ià(
	`zzlFšd
(
zobj
->
±r
, 
memb”
, 
scÜe
è=ğ
NULL
è 
VR_ERROR
;

1148 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1149 
z£t
 *
zs
 = 
zobj
->
±r
;

1150 
diùEÁry
 *
de
 = 
	`diùFšd
(
zs
->
diù
, 
memb”
);

1151 ià(
de
 =ğ
NULL
è 
VR_ERROR
;

1152 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1154 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1156  
VR_OK
;

1157 
	}
}

1164 
	#ZADD_NONE
 0

	)

1165 
	#ZADD_INCR
 (1<<0è

	)

1166 
	#ZADD_NX
 (1<<1è

	)

1167 
	#ZADD_XX
 (1<<2è

	)

1168 
	#ZADD_CH
 (1<<3è

	)

1170 
	$zaddG’”icCommªd
(
ş›Á
 *
c
, 
æags
) {

1171 *
ÇÃ¼
 = "resulting score is‚ot‡‚umber (NaN)";

1172 
robj
 *
key
 = 
c
->
¬gv
[1];

1173 
robj
 *
–e
;

1174 
robj
 *
zobj
;

1175 
robj
 *
curobj
;

1176 
scÜe
 = 0, *
scÜes
 = 
NULL
, 
curscÜe
 = 0.0;

1177 
j
, 
–em’ts
;

1178 
scÜeidx
 = 0;

1182 
added
 = 0;

1183 
upd©ed
 = 0;

1184 
´oûs£d
 = 0;

1186 
expœed
 = 0;

1190 
scÜeidx
 = 2;

1191 
scÜeidx
 < 
c
->
¬gc
) {

1192 *
İt
 = 
c
->
¬gv
[
scÜeidx
]->
±r
;

1193 ià(!
	`¡rÿ£cmp
(
İt
,"nx")è
æags
 |ğ
ZADD_NX
;

1194 ià(!
	`¡rÿ£cmp
(
İt
,"xx")è
æags
 |ğ
ZADD_XX
;

1195 ià(!
	`¡rÿ£cmp
(
İt
,"ch")è
æags
 |ğ
ZADD_CH
;

1196 ià(!
	`¡rÿ£cmp
(
İt
,"šü")è
æags
 |ğ
ZADD_INCR
;

1198 
scÜeidx
++;

1202 
šü
 = (
æags
 & 
ZADD_INCR
) != 0;

1203 
nx
 = (
æags
 & 
ZADD_NX
) != 0;

1204 
xx
 = (
æags
 & 
ZADD_XX
) != 0;

1205 
ch
 = (
æags
 & 
ZADD_CH
) != 0;

1209 
–em’ts
 = 
c
->
¬gc
-
scÜeidx
;

1210 ià(
–em’ts
 % 2) {

1211 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1214 
–em’ts
 /= 2;

1217 ià(
nx
 && 
xx
) {

1218 
	`addR•lyE¼Ü
(
c
,

1223 ià(
šü
 && 
–em’ts
 > 1) {

1224 
	`addR•lyE¼Ü
(
c
,

1232 
scÜes
 = 
	`d®loc
(()*
–em’ts
);

1233 
j
 = 0; j < 
–em’ts
; j++) {

1234 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
scÜeidx
+
j
*2],&
scÜes
[j],
NULL
)

1235 !ğ
VR_OK
è
ş—nup
;

1238 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1239 
	`lockDbWr™e
(
c
->
db
);

1241 
zobj
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
,&
expœed
);

1242 ià(
zobj
 =ğ
NULL
) {

1243 ià(
xx
) {

1244 
	`uÆockDb
(
c
->
db
);

1245 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1246 
»¶y_to_ş›Á
;

1248 ià(
£rv”
.
z£t_max_zli¡_’Œ›s
 == 0 ||

1249 
£rv”
.
z£t_max_zli¡_v®ue
 < 
	`sd¦’
(
c
->
¬gv
[
scÜeidx
+1]->
±r
))

1251 
zobj
 = 
	`ü—‹Z£tObjeù
();

1253 
zobj
 = 
	`ü—‹Z£tZli¡Objeù
();

1255 
	`dbAdd
(
c
->
db
,
key
,
zobj
);

1257 ià(
zobj
->
ty³
 !ğ
OBJ_ZSET
) {

1258 
	`uÆockDb
(
c
->
db
);

1259 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1260 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1261 
ş—nup
;

1265 
j
 = 0; j < 
–em’ts
; j++) {

1266 
scÜe
 = 
scÜes
[
j
];

1268 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1269 *
•Œ
;

1272 
–e
 = 
c
->
¬gv
[
scÜeidx
+1+
j
*2];

1273 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,&
curscÜe
)è!ğ
NULL
) {

1274 ià(
nx
) ;

1275 ià(
šü
) {

1276 
scÜe
 +ğ
curscÜe
;

1277 ià(
	`i¢ª
(
scÜe
)) {

1278 
	`uÆockDb
(
c
->
db
);

1279 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1280 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1281 
ş—nup
;

1286 ià(
scÜe
 !ğ
curscÜe
) {

1287 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1288 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1289 
c
->
v–
->
dœty
++;

1290 
upd©ed
++;

1292 
´oûs£d
++;

1293 } ià(!
xx
) {

1296 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1297 ià(
	`zzlL’gth
(
zobj
->
±r
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1298 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1299 ià(
	`sd¦’
(
–e
->
±r
è> 
£rv”
.
z£t_max_zli¡_v®ue
)

1300 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1301 
c
->
v–
->
dœty
++;

1302 
added
++;

1303 
´oûs£d
++;

1305 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1306 
z£t
 *
zs
 = 
zobj
->
±r
;

1307 
zskli¡Node
 *
znode
;

1308 
diùEÁry
 *
de
;

1310 
–e
 = 
c
->
¬gv
[
scÜeidx
+1+
j
*2] =

1311 
	`ŒyObjeùEncodšg
(
c
->
¬gv
[
scÜeidx
+1+
j
*2]);

1312 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1313 ià(
de
 !ğ
NULL
) {

1314 ià(
nx
) ;

1315 
curobj
 = 
	`diùG‘Key
(
de
);

1316 
curscÜe
 = *(*)
	`diùG‘V®
(
de
);

1318 ià(
šü
) {

1319 
scÜe
 +ğ
curscÜe
;

1320 ià(
	`i¢ª
(
scÜe
)) {

1321 
	`uÆockDb
(
c
->
db
);

1322 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1323 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1326 
ş—nup
;

1333 ià(
scÜe
 !ğ
curscÜe
) {

1334 
	`£rv”As£¹W™hInfo
(
c
,
curobj
,
	`z¦D–‘e
(
zs
->
z¦
,
curscÜe
,curobj));

1335 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
curobj
);

1336 
	`diùG‘V®
(
de
èğ&
znode
->
scÜe
;

1337 
c
->
v–
->
dœty
++;

1338 
upd©ed
++;

1340 
´oûs£d
++;

1341 } ià(!
xx
) {

1342 
–e
 = 
	`dupSŒšgObjeùUncÚ¡ªt
(ele);

1343 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1344 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`diùAdd
(
zs
->
diù
,
–e
,&
znode
->
scÜe
è=ğ
DICT_OK
);

1345 
c
->
v–
->
dœty
++;

1346 
added
++;

1347 
´oûs£d
++;

1350 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1354 
	`uÆockDb
(
c
->
db
);

1355 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1357 
»¶y_to_ş›Á
:

1358 ià(
šü
) {

1359 ià(
´oûs£d
)

1360 
	`addR•lyDoubË
(
c
,
scÜe
);

1362 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1364 
	`addR•lyLÚgLÚg
(
c
,
ch
 ? 
added
+
upd©ed
 :‡dded);

1367 
ş—nup
:

1368 
	`dä“
(
scÜes
);

1369 ià(
added
 || 
upd©ed
) {

1370 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1371 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

1372 
šü
 ? "zšü" : "zadd", 
key
, 
c
->
db
->
id
);

1374 
	}
}

1376 
	$zaddCommªd
(
ş›Á
 *
c
) {

1377 
	`zaddG’”icCommªd
(
c
,
ZADD_NONE
);

1378 
	}
}

1380 
	$zšübyCommªd
(
ş›Á
 *
c
) {

1381 
	`zaddG’”icCommªd
(
c
,
ZADD_INCR
);

1382 
	}
}

1384 
	$z»mCommªd
(
ş›Á
 *
c
) {

1385 
robj
 *
key
 = 
c
->
¬gv
[1];

1386 
robj
 *
zobj
;

1387 
d–‘ed
 = 0, 
key»moved
 = 0, 
j
;

1388 
expœed
 = 0;

1390 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1391 
	`lockDbWr™e
(
c
->
db
);

1392 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

1393 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

1394 
	`uÆockDb
(
c
->
db
);

1395 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1399 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1400 *
•Œ
;

1402 
j
 = 2; j < 
c
->
¬gc
; j++) {

1403 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
c
->
¬gv
[
j
],
NULL
)) != NULL) {

1404 
d–‘ed
++;

1405 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1406 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1407 
	`dbD–‘e
(
c
->
db
,
key
);

1408 
key»moved
 = 1;

1413 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1414 
z£t
 *
zs
 = 
zobj
->
±r
;

1415 
diùEÁry
 *
de
;

1416 
scÜe
;

1418 
j
 = 2; j < 
c
->
¬gc
; j++) {

1419 
de
 = 
	`diùFšd
(
zs
->
diù
,
c
->
¬gv
[
j
]);

1420 ià(
de
 !ğ
NULL
) {

1421 
d–‘ed
++;

1424 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1425 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[
j
],
	`z¦D–‘e
(
zs
->
z¦
,
scÜe
,c->argv[j]));

1428 
	`diùD–‘e
(
zs
->
diù
,
c
->
¬gv
[
j
]);

1429 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1430 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1431 
	`dbD–‘e
(
c
->
db
,
key
);

1432 
key»moved
 = 1;

1438 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1441 ià(
d–‘ed
) {

1442 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,"z»m",
key
,
c
->
db
->
id
);

1443 ià(
key»moved
)

1444 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1445 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1446 
c
->
v–
->
dœty
 +ğ
d–‘ed
;

1448 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1449 
	`uÆockDb
(
c
->
db
);

1450 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1451 
	}
}

1454 
	#ZRANGE_RANK
 0

	)

1455 
	#ZRANGE_SCORE
 1

	)

1456 
	#ZRANGE_LEX
 2

	)

1457 
	$z»m¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
¿ng‘y³
) {

1458 
robj
 *
key
 = 
c
->
¬gv
[1];

1459 
robj
 *
zobj
;

1460 
key»moved
 = 0;

1461 
d–‘ed
 = 0;

1462 
z¿nge¥ec
 
¿nge
;

1463 
zËx¿nge¥ec
 
Ëx¿nge
;

1464 
¡¬t
, 
’d
, 
Î’
;

1465 
expœed
 = 0;

1468 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1469 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
VR_OK
) ||

1470 (
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
VR_OK
))

1472 } ià(
¿ng‘y³
 =ğ
ZRANGE_SCORE
) {

1473 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
VR_OK
) {

1474 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

1477 } ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
) {

1478 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
Ëx¿nge
è!ğ
VR_OK
) {

1479 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

1484 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

1485 
	`lockDbWr™e
(
c
->
db
);

1487 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
,&
expœed
)è=ğ
NULL
 ||

1488 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)è
ş—nup
;

1490 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1492 
Î’
 = 
	`z£tL’gth
(
zobj
);

1493 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

1494 ià(
’d
 < 0è’d = 
Î’
+end;

1495 ià(
¡¬t
 < 0) start = 0;

1499 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

1500 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1501 
ş—nup
;

1503 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

1507 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1508 
¿ng‘y³
) {

1509 
ZRANGE_RANK
:

1510 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByRªk
(zobj->±r,
¡¬t
+1,
’d
+1,&
d–‘ed
);

1512 
ZRANGE_SCORE
:

1513 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByScÜe
(zobj->±r,&
¿nge
,&
d–‘ed
);

1515 
ZRANGE_LEX
:

1516 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByLex
(zobj->±r,&
Ëx¿nge
,&
d–‘ed
);

1519 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1520 
	`dbD–‘e
(
c
->
db
,
key
);

1521 
key»moved
 = 1;

1523 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1524 
z£t
 *
zs
 = 
zobj
->
±r
;

1525 
¿ng‘y³
) {

1526 
ZRANGE_RANK
:

1527 
d–‘ed
 = 
	`z¦D–‘eRªgeByRªk
(
zs
->
z¦
,
¡¬t
+1,
’d
+1,zs->
diù
);

1529 
ZRANGE_SCORE
:

1530 
d–‘ed
 = 
	`z¦D–‘eRªgeByScÜe
(
zs
->
z¦
,&
¿nge
,zs->
diù
);

1532 
ZRANGE_LEX
:

1533 
d–‘ed
 = 
	`z¦D–‘eRªgeByLex
(
zs
->
z¦
,&
Ëx¿nge
,zs->
diù
);

1536 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1537 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1538 
	`dbD–‘e
(
c
->
db
,
key
);

1539 
key»moved
 = 1;

1542 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1546 ià(
d–‘ed
) {

1547 *
ev’t
[3] = {"zremrangebyrank","zremrangebyscore","zremrangebylex"};

1548 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1549 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,
ev’t
[
¿ng‘y³
],
key
,
c
->
db
->
id
);

1550 ià(
key»moved
)

1551 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1553 
c
->
v–
->
dœty
 +ğ
d–‘ed
;

1554 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1556 
ş—nup
:

1557 ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
è
	`z¦F»eLexRªge
(&
Ëx¿nge
);

1558 
	`uÆockDb
(
c
->
db
);

1559 ià(
expœed
è
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
,
expœedkeys
,1);

1560 
	}
}

1562 
	$z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
) {

1563 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_RANK
);

1564 
	}
}

1566 
	$z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

1567 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_SCORE
);

1568 
	}
}

1570 
	$z»m¿ngebyËxCommªd
(
ş›Á
 *
c
) {

1571 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_LEX
);

1572 
	}
}

1580 
	#OPVAL_DIRTY_ROBJ
 1

	)

1581 
	#OPVAL_DIRTY_LL
 2

	)

1582 
	#OPVAL_VALID_LL
 4

	)

1584 
_™”£t
 
	t™”£t
;

1585 
_™”z£t
 
	t™”z£t
;

1587 
	$zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1588 ià(
İ
->
subjeù
 =ğ
NULL
)

1591 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1592 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1593 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1594 
™
->
is
.i ğ
İ
->
subjeù
->
±r
;

1595 
™
->
is
.
ii
 = 0;

1596 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1597 
™
->
ht
.
diù
 = 
İ
->
subjeù
->
±r
;

1598 
™
->
ht
.
di
 = 
	`diùG‘I‹¿tÜ
(
İ
->
subjeù
->
±r
);

1599 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1601 
	`£rv”Pªic
("Unknown setƒncoding");

1603 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1604 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1605 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1606 
™
->
zl
.zÈğ
İ
->
subjeù
->
±r
;

1607 
™
->
zl
.
•Œ
 = 
	`zli¡Index
(it->zl.zl,0);

1608 ià(
™
->
zl
.
•Œ
 !ğ
NULL
) {

1609 
™
->
zl
.
¥Œ
 = 
	`zli¡Next
(™->zl.zl,™->zl.
•Œ
);

1610 
	`ASSERT
(
™
->
zl
.
¥Œ
 !ğ
NULL
);

1612 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1613 
™
->
¦
.
zs
 = 
İ
->
subjeù
->
±r
;

1614 
™
->
¦
.
node
 = it->¦.
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1616 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1619 
	`£rv”Pªic
("Unsupportedype");

1621 
	}
}

1623 
	$zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1624 ià(
İ
->
subjeù
 =ğ
NULL
)

1627 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1628 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1629 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1630 
	`UNUSED
(
™
);

1631 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1632 
	`diùR–—£I‹¿tÜ
(
™
->
ht
.
di
);

1634 
	`£rv”Pªic
("Unknown setƒncoding");

1636 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1637 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1638 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1639 
	`UNUSED
(
™
);

1640 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1641 
	`UNUSED
(
™
);

1643 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1646 
	`£rv”Pªic
("Unsupportedype");

1648 
	}
}

1650 
	$zuiL’gth
(
z£tİ¤c
 *
İ
) {

1651 ià(
İ
->
subjeù
 =ğ
NULL
)

1654 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1655 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1656  
	`št£tL’
(
İ
->
subjeù
->
±r
);

1657 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1658 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1659  
	`diùSize
(
ht
);

1661 
	`£rv”Pªic
("Unknown setƒncoding");

1663 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1664 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1665  
	`zzlL’gth
(
İ
->
subjeù
->
±r
);

1666 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1667 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1668  
zs
->
z¦
->
Ëngth
;

1670 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1673 
	`£rv”Pªic
("Unsupportedype");

1675 
	}
}

1680 
	$zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
) {

1681 
»t
;

1683 ià(
İ
->
subjeù
 =ğ
NULL
)

1686 ià(
v®
->
æags
 & 
OPVAL_DIRTY_ROBJ
)

1687 
	`deüRefCouÁ
(
v®
->
–e
);

1689 
	`mem£t
(
v®
,0,(
z£tİv®
));

1691 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1692 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1693 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1694 
št64_t
 
–l
;

1696 ià(!
	`št£tG‘
(
™
->
is
.is,™->is.
ii
,&
–l
))

1698 
v®
->
–l
 =ƒll;

1699 
v®
->
scÜe
 = 1.0;

1702 
™
->
is
.
ii
++;

1703 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1704 ià(
™
->
ht
.
de
 =ğ
NULL
)

1706 
v®
->
–e
 = 
	`diùG‘Key
(
™
->
ht
.
de
);

1707 
v®
->
scÜe
 = 1.0;

1710 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1712 
	`£rv”Pªic
("Unknown setƒncoding");

1714 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1715 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1716 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1718 ià(
™
->
zl
.
•Œ
 =ğ
NULL
 || it->zl.
¥Œ
 == NULL)

1720 
»t
 = (è
	`zli¡G‘
(
™
->
zl
.
•Œ
,&
v®
->
e¡r
,&v®->
–’
,&v®->
–l
);

1721 
	`ASSERT
(
»t
 > 0);

1722 
v®
->
scÜe
 = 
	`zzlG‘ScÜe
(
™
->
zl
.
¥Œ
);

1725 
	`zzlNext
(
™
->
zl
.zl,&™->zl.
•Œ
,&™->zl.
¥Œ
);

1726 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1727 ià(
™
->
¦
.
node
 =ğ
NULL
)

1729 
v®
->
–e
 = 
™
->
¦
.
node
->
obj
;

1730 
v®
->
scÜe
 = 
™
->
¦
.
node
->score;

1733 
™
->
¦
.
node
 = it->¦.node->
Ëv–
[0].
fÜw¬d
;

1735 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1738 
	`£rv”Pªic
("Unsupportedype");

1741 
	}
}

1743 
	$zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
) {

1744 ià(!(
v®
->
æags
 & 
OPVAL_DIRTY_LL
)) {

1745 
v®
->
æags
 |ğ
OPVAL_DIRTY_LL
;

1747 ià(
v®
->
–e
 !ğ
NULL
) {

1748 ià(
v®
->
–e
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

1749 
v®
->
–l
 = ()v®->
–e
->
±r
;

1750 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1751 } ià(
	`sdsEncodedObjeù
(
v®
->
–e
)) {

1752 ià(
	`¡ršg2Î
(
v®
->
–e
->
±r
,
	`sd¦’
(v®->–e->±r),&v®->
–l
))

1753 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1755 
	`£rv”Pªic
("Unsupportedƒlementƒncoding");

1757 } ià(
v®
->
e¡r
 !ğ
NULL
) {

1758 ià(
	`¡ršg2Î
((*)
v®
->
e¡r
,v®->
–’
,&v®->
–l
))

1759 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1762 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1765  
v®
->
æags
 & 
OPVAL_VALID_LL
;

1766 
	}
}

1768 
robj
 *
	$zuiObjeùFromV®ue
(
z£tİv®
 *
v®
) {

1769 ià(
v®
->
–e
 =ğ
NULL
) {

1770 ià(
v®
->
e¡r
 !ğ
NULL
) {

1771 
v®
->
–e
 = 
	`ü—‹SŒšgObjeù
((*)v®->
e¡r
,v®->
–’
);

1773 
v®
->
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(v®->
–l
);

1775 
v®
->
æags
 |ğ
OPVAL_DIRTY_ROBJ
;

1777  
v®
->
–e
;

1778 
	}
}

1780 
	$zuiBufãrFromV®ue
(
z£tİv®
 *
v®
) {

1781 ià(
v®
->
e¡r
 =ğ
NULL
) {

1782 ià(
v®
->
–e
 !ğ
NULL
) {

1783 ià(
v®
->
–e
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

1784 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),()v®->
–e
->
±r
);

1785 
v®
->
e¡r
 = v®->
_buf
;

1786 } ià(
	`sdsEncodedObjeù
(
v®
->
–e
)) {

1787 
v®
->
–’
 = 
	`sd¦’
(v®->
–e
->
±r
);

1788 
v®
->
e¡r
 = v®->
–e
->
±r
;

1790 
	`£rv”Pªic
("Unsupportedƒlementƒncoding");

1793 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),v®->
–l
);

1794 
v®
->
e¡r
 = v®->
_buf
;

1798 
	}
}

1802 
	$zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
) {

1803 ià(
İ
->
subjeù
 =ğ
NULL
)

1806 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1807 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1808 ià(
	`zuiLÚgLÚgFromV®ue
(
v®
) &&

1809 
	`št£tFšd
(
İ
->
subjeù
->
±r
,
v®
->
–l
))

1811 *
scÜe
 = 1.0;

1816 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1817 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1818 
	`zuiObjeùFromV®ue
(
v®
);

1819 ià(
	`diùFšd
(
ht
,
v®
->
–e
è!ğ
NULL
) {

1820 *
scÜe
 = 1.0;

1826 
	`£rv”Pªic
("Unknown setƒncoding");

1828 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1829 
	`zuiObjeùFromV®ue
(
v®
);

1831 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1832 ià(
	`zzlFšd
(
İ
->
subjeù
->
±r
,
v®
->
–e
,
scÜe
è!ğ
NULL
) {

1838 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1839 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1840 
diùEÁry
 *
de
;

1841 ià((
de
 = 
	`diùFšd
(
zs
->
diù
,
v®
->
–e
)è!ğ
NULL
) {

1842 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1848 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1851 
	`£rv”Pªic
("Unsupportedype");

1853 
	}
}

1855 
	$zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

1856  
	`zuiL’gth
((
z£tİ¤c
*)
s1
è- zuiL’gth((z£tİ¤c*)
s2
);

1857 
	}
}

1859 
	#REDIS_AGGR_SUM
 1

	)

1860 
	#REDIS_AGGR_MIN
 2

	)

1861 
	#REDIS_AGGR_MAX
 3

	)

1862 
	#zuniÚIÁ”DiùV®ue
(
_e
è(
	`diùG‘V®
(_eè=ğ
NULL
 ? 1.0 : *(*)diùG‘V®(_e))

	)

1864 
šlše
 
	$zuniÚIÁ”Agg»g©e
(*
rg‘
, 
v®
, 
agg»g©e
) {

1865 ià(
agg»g©e
 =ğ
REDIS_AGGR_SUM
) {

1866 *
rg‘
 = *rg‘ + 
v®
;

1870 ià(
	`i¢ª
(*
rg‘
)) *target = 0.0;

1871 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MIN
) {

1872 *
rg‘
 = 
v®
 < *target ? val : *target;

1873 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MAX
) {

1874 *
rg‘
 = 
v®
 > *target ? val : *target;

1877 
	`£rv”Pªic
("Unknown ZUNION/INTER‡ggregateype");

1879 
	}
}

1881 
	#SET_OP_UNION
 0

	)

1882 
	#SET_OP_DIFF
 1

	)

1883 
	#SET_OP_INTER
 2

	)

1885 
	$zuniÚIÁ”G’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
d¡key
, 
İ
) {

1886 
i
, 
j
;

1887 
£Šum
;

1888 
agg»g©e
 = 
REDIS_AGGR_SUM
;

1889 
z£tİ¤c
 *
¤c
;

1890 
z£tİv®
 
zv®
;

1891 
robj
 *
tmp
;

1892 
max––’
 = 0;

1893 
robj
 *
d¡obj
;

1894 
z£t
 *
d¡z£t
;

1895 
zskli¡Node
 *
znode
;

1896 
touched
 = 0;

1899 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
£Šum
, 
NULL
è!ğ
VR_OK
))

1902 ià(
£Šum
 < 1) {

1903 
	`addR•lyE¼Ü
(
c
,

1909 ià(
£Šum
 > 
c
->
¬gc
-3) {

1910 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1915 
¤c
 = 
	`dÿÎoc
(
£Šum
, (
z£tİ¤c
));

1916 
i
 = 0, 
j
 = 3; i < 
£Šum
; i++, j++) {

1917 
robj
 *
obj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
],
NULL
);

1918 ià(
obj
 !ğ
NULL
) {

1919 ià(
obj
->
ty³
 !ğ
OBJ_ZSET
 && obj->ty³ !ğ
OBJ_SET
) {

1920 
	`dä“
(
¤c
);

1921 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1925 
¤c
[
i
].
subjeù
 = 
obj
;

1926 
¤c
[
i
].
ty³
 = 
obj
->type;

1927 
¤c
[
i
].
’codšg
 = 
obj
->encoding;

1929 
¤c
[
i
].
subjeù
 = 
NULL
;

1933 
¤c
[
i
].
weight
 = 1.0;

1937 ià(
j
 < 
c
->
¬gc
) {

1938 
»maššg
 = 
c
->
¬gc
 - 
j
;

1940 
»maššg
) {

1941 ià(
»maššg
 >ğ(
£Šum
 + 1è&& !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"weights")) {

1942 
j
++; 
»maššg
--;

1943 
i
 = 0; i < 
£Šum
; i++, 
j
++, 
»maššg
--) {

1944 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
],&
¤c
[
i
].
weight
,

1945 "weighˆv®ui nÙ‡ flßt"è!ğ
VR_OK
)

1947 
	`dä“
(
¤c
);

1951 } ià(
»maššg
 >ğ2 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"aggregate")) {

1952 
j
++; 
»maššg
--;

1953 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"sum")) {

1954 
agg»g©e
 = 
REDIS_AGGR_SUM
;

1955 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"min")) {

1956 
agg»g©e
 = 
REDIS_AGGR_MIN
;

1957 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"max")) {

1958 
agg»g©e
 = 
REDIS_AGGR_MAX
;

1960 
	`dä“
(
¤c
);

1961 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1964 
j
++; 
»maššg
--;

1966 
	`dä“
(
¤c
);

1967 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1975 
	`qsÜt
(
¤c
,
£Šum
,(
z£tİ¤c
),
zuiCom·»ByC¬dš®™y
);

1977 
d¡obj
 = 
	`ü—‹Z£tObjeù
();

1978 
d¡z£t
 = 
d¡obj
->
±r
;

1979 
	`mem£t
(&
zv®
, 0, (zval));

1981 ià(
İ
 =ğ
SET_OP_INTER
) {

1983 ià(
	`zuiL’gth
(&
¤c
[0]) > 0) {

1986 
	`zuiIn™I‹¿tÜ
(&
¤c
[0]);

1987 
	`zuiNext
(&
¤c
[0],&
zv®
)) {

1988 
scÜe
, 
v®ue
;

1990 
scÜe
 = 
¤c
[0].
weight
 * 
zv®
.score;

1991 ià(
	`i¢ª
(
scÜe
)) score = 0;

1993 
j
 = 1; j < 
£Šum
; j++) {

1996 ià(
¤c
[
j
].
subjeù
 == src[0].subject) {

1997 
v®ue
 = 
zv®
.
scÜe
*
¤c
[
j
].
weight
;

1998 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

1999 } ià(
	`zuiFšd
(&
¤c
[
j
],&
zv®
,&
v®ue
)) {

2000 
v®ue
 *ğ
¤c
[
j
].
weight
;

2001 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

2008 ià(
j
 =ğ
£Šum
) {

2009 
tmp
 = 
	`zuiObjeùFromV®ue
(&
zv®
);

2010 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
tmp
);

2011 
	`šüRefCouÁ
(
tmp
);

2012 
	`diùAdd
(
d¡z£t
->
diù
,
tmp
,&
znode
->
scÜe
);

2013 
	`šüRefCouÁ
(
tmp
);

2015 ià(
	`sdsEncodedObjeù
(
tmp
)) {

2016 ià(
	`sd¦’
(
tmp
->
±r
è> 
max––’
)

2017 
max––’
 = 
	`sd¦’
(
tmp
->
±r
);

2021 
	`zuiCË¬I‹¿tÜ
(&
¤c
[0]);

2023 } ià(
İ
 =ğ
SET_OP_UNION
) {

2024 
diù
 *
accumuÏtÜ
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

2025 
diùI‹¿tÜ
 *
di
;

2026 
diùEÁry
 *
de
;

2027 
scÜe
;

2029 ià(
£Šum
) {

2032 
	`diùEx·nd
(
accumuÏtÜ
,
	`zuiL’gth
(&
¤c
[
£Šum
-1]));

2037 
i
 = 0; i < 
£Šum
; i++) {

2038 ià(
	`zuiL’gth
(&
¤c
[
i
]) == 0) ;

2040 
	`zuiIn™I‹¿tÜ
(&
¤c
[
i
]);

2041 
	`zuiNext
(&
¤c
[
i
],&
zv®
)) {

2043 
scÜe
 = 
¤c
[
i
].
weight
 * 
zv®
.score;

2044 ià(
	`i¢ª
(
scÜe
)) score = 0;

2047 
de
 = 
	`diùFšd
(
accumuÏtÜ
,
	`zuiObjeùFromV®ue
(&
zv®
));

2049 ià(
de
 =ğ
NULL
) {

2050 
tmp
 = 
	`zuiObjeùFromV®ue
(&
zv®
);

2054 ià(
	`sdsEncodedObjeù
(
tmp
)) {

2055 ià(
	`sd¦’
(
tmp
->
±r
è> 
max––’
)

2056 
max––’
 = 
	`sd¦’
(
tmp
->
±r
);

2059 
de
 = 
	`diùAddRaw
(
accumuÏtÜ
,
tmp
);

2060 
	`šüRefCouÁ
(
tmp
);

2061 
	`diùS‘DoubËV®
(
de
,
scÜe
);

2069 
	`zuniÚIÁ”Agg»g©e
(&
de
->
v
.
d
,
scÜe
,
agg»g©e
);

2072 
	`zuiCË¬I‹¿tÜ
(&
¤c
[
i
]);

2076 
di
 = 
	`diùG‘I‹¿tÜ
(
accumuÏtÜ
);

2081 
	`diùEx·nd
(
d¡z£t
->
diù
,
	`diùSize
(
accumuÏtÜ
));

2083 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2084 
robj
 *
–e
 = 
	`diùG‘Key
(
de
);

2085 
scÜe
 = 
	`diùG‘DoubËV®
(
de
);

2086 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
–e
);

2087 
	`šüRefCouÁ
(
–e
);

2088 
	`diùAdd
(
d¡z£t
->
diù
,
–e
,&
znode
->
scÜe
);

2089 
	`šüRefCouÁ
(
–e
);

2091 
	`diùR–—£I‹¿tÜ
(
di
);

2094 
	`diùR–—£
(
accumuÏtÜ
);

2096 
	`£rv”Pªic
("Unknown operator");

2099 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

2100 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2101 
touched
 = 1;

2102 
£rv”
.
dœty
++;

2104 ià(
d¡z£t
->
z¦
->
Ëngth
) {

2105 
	`z£tCÚv”tToZli¡IfN“ded
(
d¡obj
,
max––’
);

2106 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

2107 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
d¡obj
));

2108 ià(!
touched
è
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2109 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

2110 (
İ
 =ğ
SET_OP_UNION
) ? "zunionstore" : "zinterstore",

2111 
d¡key
,
c
->
db
->
id
);

2112 
£rv”
.
dœty
++;

2114 
	`deüRefCouÁ
(
d¡obj
);

2115 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

2116 ià(
touched
)

2117 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
d¡key
,
c
->
db
->
id
);

2119 
	`dä“
(
¤c
);

2120 
	}
}

2122 
	$zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

2123 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_UNION
);

2124 
	}
}

2126 
	$zš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

2127 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_INTER
);

2128 
	}
}

2130 
	$z¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2131 
robj
 *
key
 = 
c
->
¬gv
[1];

2132 
robj
 *
zobj
;

2133 
w™hscÜes
 = 0;

2134 
¡¬t
;

2135 
’d
;

2136 
Î’
;

2137 
¿ng–’
;

2139 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
VR_OK
) ||

2140 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
VR_OK
)) ;

2142 ià(
c
->
¬gc
 =ğ5 && !
	`¡rÿ£cmp
(c->
¬gv
[4]->
±r
,"withscores")) {

2143 
w™hscÜes
 = 1;

2144 } ià(
c
->
¬gc
 >= 5) {

2145 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2149 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2150 
	`lockDbR—d
(
c
->
db
);

2151 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

2152 
	`uÆockDb
(
c
->
db
);

2153 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2155 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2156 
	`uÆockDb
(
c
->
db
);

2157 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2162 
Î’
 = 
	`z£tL’gth
(
zobj
);

2163 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

2164 ià(
’d
 < 0è’d = 
Î’
+end;

2165 ià(
¡¬t
 < 0) start = 0;

2169 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

2170 
	`uÆockDb
(
c
->
db
);

2171 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2172 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

2175 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

2176 
¿ng–’
 = (
’d
-
¡¬t
)+1;

2179 
	`addR•lyMuÉiBulkL’
(
c
, 
w™hscÜes
 ? (
¿ng–’
*2) :„angelen);

2181 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2182 *
zl
 = 
zobj
->
±r
;

2183 *
•Œ
, *
¥Œ
;

2184 *
v¡r
;

2185 
vËn
;

2186 
vlÚg
;

2188 ià(
»v”£
)

2189 
•Œ
 = 
	`zli¡Index
(
zl
,-2-(2*
¡¬t
));

2191 
•Œ
 = 
	`zli¡Index
(
zl
,2*
¡¬t
);

2193 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2194 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2196 
¿ng–’
--) {

2197 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
 && 
¥Œ
 != NULL);

2198 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2199 ià(
v¡r
 =ğ
NULL
)

2200 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2202 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2204 ià(
w™hscÜes
)

2205 
	`addR•lyDoubË
(
c
,
	`zzlG‘ScÜe
(
¥Œ
));

2207 ià(
»v”£
)

2208 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2210 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2213 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2214 
z£t
 *
zs
 = 
zobj
->
±r
;

2215 
zskli¡
 *
z¦
 = 
zs
->zsl;

2216 
zskli¡Node
 *
Ê
;

2217 
robj
 *
–e
;

2220 ià(
»v”£
) {

2221 
Ê
 = 
z¦
->

;

2222 ià(
¡¬t
 > 0)

2223 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
Î’
-
¡¬t
);

2225 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

2226 ià(
¡¬t
 > 0)

2227 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

2230 
¿ng–’
--) {

2231 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
Ê
 !ğ
NULL
);

2232 
–e
 = 
Ê
->
obj
;

2233 
	`addR•lyBulk
(
c
,
–e
);

2234 ià(
w™hscÜes
)

2235 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2236 
Ê
 = 
»v”£
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

2239 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2242 
	`uÆockDb
(
c
->
db
);

2243 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2244 
	}
}

2246 
	$z¿ngeCommªd
(
ş›Á
 *
c
) {

2247 
	`z¿ngeG’”icCommªd
(
c
,0);

2248 
	}
}

2250 
	$z»v¿ngeCommªd
(
ş›Á
 *
c
) {

2251 
	`z¿ngeG’”icCommªd
(
c
,1);

2252 
	}
}

2255 
	$g’”icZ¿ngebyscÜeCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2256 
z¿nge¥ec
 
¿nge
;

2257 
robj
 *
key
 = 
c
->
¬gv
[1];

2258 
robj
 *
zobj
;

2259 
off£t
 = 0, 
lim™
 = -1;

2260 
w™hscÜes
 = 0;

2261 
¿ng–’
 = 0;

2262 *
»¶yËn
 = 
NULL
;

2263 
mšidx
, 
maxidx
;

2266 ià(
»v”£
) {

2268 
maxidx
 = 2; 
mšidx
 = 3;

2271 
mšidx
 = 2; 
maxidx
 = 3;

2274 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
VR_OK
) {

2275 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2281 ià(
c
->
¬gc
 > 4) {

2282 
»maššg
 = 
c
->
¬gc
 - 4;

2283 
pos
 = 4;

2285 
»maššg
) {

2286 ià(
»maššg
 >ğ1 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"withscores")) {

2287 
pos
++; 
»maššg
--;

2288 
w™hscÜes
 = 1;

2289 } ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2290 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
VR_OK
) ||

2291 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
VR_OK
)) ;

2292 
pos
 +ğ3; 
»maššg
 -= 3;

2294 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2300 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2301 
	`lockDbR—d
(
c
->
db
);

2303 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
) {

2304 
	`uÆockDb
(
c
->
db
);

2305 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2307 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2308 
	`uÆockDb
(
c
->
db
);

2309 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2313 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2314 *
zl
 = 
zobj
->
±r
;

2315 *
•Œ
, *
¥Œ
;

2316 *
v¡r
;

2317 
vËn
;

2318 
vlÚg
;

2319 
scÜe
;

2322 ià(
»v”£
) {

2323 
•Œ
 = 
	`zzlLa¡InRªge
(
zl
,&
¿nge
);

2325 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2329 ià(
•Œ
 =ğ
NULL
) {

2330 
	`uÆockDb
(
c
->
db
);

2331 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2332 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2337 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2338 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2343 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2347 
•Œ
 && 
off£t
--) {

2348 ià(
»v”£
) {

2349 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2351 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2355 
•Œ
 && 
lim™
--) {

2356 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2359 ià(
»v”£
) {

2360 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
¿nge
)) ;

2362 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) ;

2366 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2368 
¿ng–’
++;

2369 ià(
v¡r
 =ğ
NULL
) {

2370 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2372 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2375 ià(
w™hscÜes
) {

2376 
	`addR•lyDoubË
(
c
,
scÜe
);

2380 ià(
»v”£
) {

2381 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2383 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2386 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2387 
z£t
 *
zs
 = 
zobj
->
±r
;

2388 
zskli¡
 *
z¦
 = 
zs
->zsl;

2389 
zskli¡Node
 *
Ê
;

2392 ià(
»v”£
) {

2393 
Ê
 = 
	`z¦La¡InRªge
(
z¦
,&
¿nge
);

2395 
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
,&
¿nge
);

2399 ià(
Ê
 =ğ
NULL
) {

2400 
	`uÆockDb
(
c
->
db
);

2401 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2402 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2409 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2413 
Ê
 && 
off£t
--) {

2414 ià(
»v”£
) {

2415 
Ê
 =†n->
backw¬d
;

2417 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2421 
Ê
 && 
lim™
--) {

2423 ià(
»v”£
) {

2424 ià(!
	`z¦V®ueG‹Mš
(
Ê
->
scÜe
,&
¿nge
)) ;

2426 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
,&
¿nge
)) ;

2429 
¿ng–’
++;

2430 
	`addR•lyBulk
(
c
,
Ê
->
obj
);

2432 ià(
w™hscÜes
) {

2433 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2437 ià(
»v”£
) {

2438 
Ê
 =†n->
backw¬d
;

2440 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2444 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2447 ià(
w™hscÜes
) {

2448 
¿ng–’
 *= 2;

2451 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2452 
	`uÆockDb
(
c
->
db
);

2453 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2454 
	}
}

2456 
	$z¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2457 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,0);

2458 
	}
}

2460 
	$z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2461 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,1);

2462 
	}
}

2464 
	$zcouÁCommªd
(
ş›Á
 *
c
) {

2465 
robj
 *
key
 = 
c
->
¬gv
[1];

2466 
robj
 *
zobj
;

2467 
z¿nge¥ec
 
¿nge
;

2468 
couÁ
 = 0;

2471 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
VR_OK
) {

2472 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2476 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2477 
	`lockDbR—d
(
c
->
db
);

2479 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
) {

2480 
	`uÆockDb
(
c
->
db
);

2481 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2483 } ià(
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) {

2484 
	`uÆockDb
(
c
->
db
);

2485 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2489 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2490 *
zl
 = 
zobj
->
±r
;

2491 *
•Œ
, *
¥Œ
;

2492 
scÜe
;

2495 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2498 ià(
•Œ
 =ğ
NULL
) {

2499 
	`uÆockDb
(
c
->
db
);

2500 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2501 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2506 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2507 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2508 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
));

2511 
•Œ
) {

2512 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2515 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) {

2518 
couÁ
++;

2519 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2522 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2523 
z£t
 *
zs
 = 
zobj
->
±r
;

2524 
zskli¡
 *
z¦
 = 
zs
->zsl;

2525 
zskli¡Node
 *
zn
;

2526 
¿nk
;

2529 
zn
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
);

2532 ià(
zn
 !ğ
NULL
) {

2533 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2534 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2537 
zn
 = 
	`z¦La¡InRªge
(
z¦
, &
¿nge
);

2540 ià(
zn
 !ğ
NULL
) {

2541 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2542 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2546 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2549 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2550 
	`uÆockDb
(
c
->
db
);

2551 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2552 
	}
}

2554 
	$zËxcouÁCommªd
(
ş›Á
 *
c
) {

2555 
robj
 *
key
 = 
c
->
¬gv
[1];

2556 
robj
 *
zobj
;

2557 
zËx¿nge¥ec
 
¿nge
;

2558 
couÁ
 = 0;

2561 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
VR_OK
) {

2562 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2567 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2568 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
))

2570 
	`z¦F»eLexRªge
(&
¿nge
);

2574 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2575 *
zl
 = 
zobj
->
±r
;

2576 *
•Œ
, *
¥Œ
;

2579 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2582 ià(
•Œ
 =ğ
NULL
) {

2583 
	`z¦F»eLexRªge
(&
¿nge
);

2584 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2589 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2590 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
));

2593 
•Œ
) {

2595 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) {

2598 
couÁ
++;

2599 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2602 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2603 
z£t
 *
zs
 = 
zobj
->
±r
;

2604 
zskli¡
 *
z¦
 = 
zs
->zsl;

2605 
zskli¡Node
 *
zn
;

2606 
¿nk
;

2609 
zn
 = 
	`z¦Fœ¡InLexRªge
(
z¦
, &
¿nge
);

2612 ià(
zn
 !ğ
NULL
) {

2613 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2614 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2617 
zn
 = 
	`z¦La¡InLexRªge
(
z¦
, &
¿nge
);

2620 ià(
zn
 !ğ
NULL
) {

2621 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2622 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2626 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2629 
	`z¦F»eLexRªge
(&
¿nge
);

2630 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2631 
	}
}

2634 
	$g’”icZ¿ngebyËxCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2635 
zËx¿nge¥ec
 
¿nge
;

2636 
robj
 *
key
 = 
c
->
¬gv
[1];

2637 
robj
 *
zobj
;

2638 
off£t
 = 0, 
lim™
 = -1;

2639 
¿ng–’
 = 0;

2640 *
»¶yËn
 = 
NULL
;

2641 
mšidx
, 
maxidx
;

2644 ià(
»v”£
) {

2646 
maxidx
 = 2; 
mšidx
 = 3;

2649 
mšidx
 = 2; 
maxidx
 = 3;

2652 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
VR_OK
) {

2653 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2659 ià(
c
->
¬gc
 > 4) {

2660 
»maššg
 = 
c
->
¬gc
 - 4;

2661 
pos
 = 4;

2663 
»maššg
) {

2664 ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2665 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
VR_OK
) ||

2666 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
VR_OK
)) ;

2667 
pos
 +ğ3; 
»maššg
 -= 3;

2669 
	`z¦F»eLexRªge
(&
¿nge
);

2670 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2677 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2678 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
))

2680 
	`z¦F»eLexRªge
(&
¿nge
);

2684 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2685 *
zl
 = 
zobj
->
±r
;

2686 *
•Œ
, *
¥Œ
;

2687 *
v¡r
;

2688 
vËn
;

2689 
vlÚg
;

2692 ià(
»v”£
) {

2693 
•Œ
 = 
	`zzlLa¡InLexRªge
(
zl
,&
¿nge
);

2695 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2699 ià(
•Œ
 =ğ
NULL
) {

2700 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2701 
	`z¦F»eLexRªge
(&
¿nge
);

2706 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2707 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2712 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2716 
•Œ
 && 
off£t
--) {

2717 ià(
»v”£
) {

2718 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2720 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2724 
•Œ
 && 
lim™
--) {

2726 ià(
»v”£
) {

2727 ià(!
	`zzlLexV®ueG‹Mš
(
•Œ
,&
¿nge
)) ;

2729 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) ;

2734 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2736 
¿ng–’
++;

2737 ià(
v¡r
 =ğ
NULL
) {

2738 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2740 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2744 ià(
»v”£
) {

2745 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2747 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2750 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2751 
z£t
 *
zs
 = 
zobj
->
±r
;

2752 
zskli¡
 *
z¦
 = 
zs
->zsl;

2753 
zskli¡Node
 *
Ê
;

2756 ià(
»v”£
) {

2757 
Ê
 = 
	`z¦La¡InLexRªge
(
z¦
,&
¿nge
);

2759 
Ê
 = 
	`z¦Fœ¡InLexRªge
(
z¦
,&
¿nge
);

2763 ià(
Ê
 =ğ
NULL
) {

2764 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2765 
	`z¦F»eLexRªge
(&
¿nge
);

2772 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2776 
Ê
 && 
off£t
--) {

2777 ià(
»v”£
) {

2778 
Ê
 =†n->
backw¬d
;

2780 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2784 
Ê
 && 
lim™
--) {

2786 ià(
»v”£
) {

2787 ià(!
	`z¦LexV®ueG‹Mš
(
Ê
->
obj
,&
¿nge
)) ;

2789 ià(!
	`z¦LexV®ueL‹Max
(
Ê
->
obj
,&
¿nge
)) ;

2792 
¿ng–’
++;

2793 
	`addR•lyBulk
(
c
,
Ê
->
obj
);

2796 ià(
»v”£
) {

2797 
Ê
 =†n->
backw¬d
;

2799 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2803 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2806 
	`z¦F»eLexRªge
(&
¿nge
);

2807 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2808 
	}
}

2810 
	$z¿ngebyËxCommªd
(
ş›Á
 *
c
) {

2811 
	`g’”icZ¿ngebyËxCommªd
(
c
,0);

2812 
	}
}

2814 
	$z»v¿ngebyËxCommªd
(
ş›Á
 *
c
) {

2815 
	`g’”icZ¿ngebyËxCommªd
(
c
,1);

2816 
	}
}

2818 
	$zÿrdCommªd
(
ş›Á
 *
c
) {

2819 
robj
 *
key
 = 
c
->
¬gv
[1];

2820 
robj
 *
zobj
;

2822 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2823 
	`lockDbR—d
(
c
->
db
);

2824 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
) {

2825 
	`uÆockDb
(
c
->
db
);

2826 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2828 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2829 
	`uÆockDb
(
c
->
db
);

2830 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2834 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
zobj
));

2836 
	`uÆockDb
(
c
->
db
);

2837 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2838 
	}
}

2840 
	$zscÜeCommªd
(
ş›Á
 *
c
) {

2841 
robj
 *
key
 = 
c
->
¬gv
[1];

2842 
robj
 *
zobj
;

2843 
scÜe
;

2845 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2846 
	`lockDbR—d
(
c
->
db
);

2847 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

2848 
	`uÆockDb
(
c
->
db
);

2849 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2851 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2852 
	`uÆockDb
(
c
->
db
);

2853 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2857 ià(
	`z£tScÜe
(
zobj
,
c
->
¬gv
[2],&
scÜe
è=ğ
VR_ERROR
) {

2858 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2860 
	`addR•lyDoubË
(
c
,
scÜe
);

2863 
	`uÆockDb
(
c
->
db
);

2864 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2865 
	}
}

2867 
	$z¿nkG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2868 
robj
 *
key
 = 
c
->
¬gv
[1];

2869 
robj
 *
–e
 = 
c
->
¬gv
[2];

2870 
robj
 *
zobj
;

2871 
Î’
;

2872 
¿nk
;

2874 
	`ãtchIÁ”ÇlDbByKey
(
c
, 
key
);

2875 
	`lockDbR—d
(
c
->
db
);

2876 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
) {

2877 
	`uÆockDb
(
c
->
db
);

2878 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_mis£s
, 1);

2880 } ià(
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) {

2881 
	`uÆockDb
(
c
->
db
);

2882 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2885 
Î’
 = 
	`z£tL’gth
(
zobj
);

2887 
	`£rv”As£¹W™hInfo
(
c
,
–e
,
	`sdsEncodedObjeù
(ele));

2889 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2890 *
zl
 = 
zobj
->
±r
;

2891 *
•Œ
, *
¥Œ
;

2893 
•Œ
 = 
	`zli¡Index
(
zl
,0);

2894 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2895 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2896 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
¥Œ
 !ğ
NULL
);

2898 
¿nk
 = 1;

2899 
•Œ
 !ğ
NULL
) {

2900 ià(
	`zli¡Com·»
(
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr)))

2902 
¿nk
++;

2903 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2906 ià(
•Œ
 !ğ
NULL
) {

2907 ià(
»v”£
)

2908 
	`addR•lyLÚgLÚg
(
c
,
Î’
-
¿nk
);

2910 
	`addR•lyLÚgLÚg
(
c
,
¿nk
-1);

2912 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2914 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2915 
z£t
 *
zs
 = 
zobj
->
±r
;

2916 
zskli¡
 *
z¦
 = 
zs
->zsl;

2917 
diùEÁry
 *
de
;

2918 
scÜe
;

2920 
–e
 = 
c
->
¬gv
[2];

2921 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

2922 ià(
de
 !ğ
NULL
) {

2923 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

2924 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
,
scÜe
,
–e
);

2925 
	`£rv”As£¹W™hInfo
(
c
,
–e
,
¿nk
);

2926 ià(
»v”£
)

2927 
	`addR•lyLÚgLÚg
(
c
,
Î’
-
¿nk
);

2929 
	`addR•lyLÚgLÚg
(
c
,
¿nk
-1);

2931 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2934 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2937 
	`uÆockDb
(
c
->
db
);

2938 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
key¥aû_h™s
, 1);

2939 
	}
}

2941 
	$z¿nkCommªd
(
ş›Á
 *
c
) {

2942 
	`z¿nkG’”icCommªd
(
c
, 0);

2943 
	}
}

2945 
	$z»v¿nkCommªd
(
ş›Á
 *
c
) {

2946 
	`z¿nkG’”icCommªd
(
c
, 1);

2947 
	}
}

2949 
	$zsÿnCommªd
(
ş›Á
 *
c
) {

2950 
	`sÿnG’”icCommªd
(
c
,
SCAN_TYPE_ZSET
);

2951 
	}
}

	@src/vr_t_zset.h

1 #iâdeà
_VR_T_ZSET_H_


2 
	#_VR_T_ZSET_H_


	)

6 
	mmš
, 
	mmax
;

7 
	mmšex
, 
	mmaxex
;

8 } 
	tz¿nge¥ec
;

12 
robj
 *
	mmš
, *
	mmax
;

13 
	mmšex
, 
	mmaxex
;

14 } 
	tzËx¿nge¥ec
;

17 
robj
 *
	msubjeù
;

18 
	mty³
;

19 
	m’codšg
;

20 
	mweight
;

24 
	u_™”£t
 {

26 
št£t
 *
	mis
;

27 
	mii
;

28 } 
	mis
;

30 
diù
 *
	mdiù
;

31 
diùI‹¿tÜ
 *
	mdi
;

32 
diùEÁry
 *
	mde
;

33 } 
	mht
;

34 } 
	m£t
;

37 
	u_™”z£t
 {

39 *
	mzl
;

40 *
	m•Œ
, *
	m¥Œ
;

41 } 
	mzl
;

43 
z£t
 *
	mzs
;

44 
zskli¡Node
 *
	mnode
;

45 } 
	m¦
;

46 } 
	mz£t
;

47 } 
	m™”
;

48 } 
	tz£tİ¤c
;

52 
	mæags
;

53 
	m_buf
[32];

54 
robj
 *
	m–e
;

55 *
	me¡r
;

56 
	m–’
;

57 
	m–l
;

58 
	mscÜe
;

59 } 
	tz£tİv®
;

61 
zskli¡Node
 *
z¦C»©eNode
(
Ëv–
, 
scÜe
, 
robj
 *
obj
);

62 
zskli¡
 *
z¦C»©e
();

63 
z¦F»eNode
(
zskli¡Node
 *
node
);

64 
z¦F»e
(
zskli¡
 *
z¦
);

65 
z¦RªdomLev–
();

66 
zskli¡Node
 *
z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
);

67 
z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
);

68 
z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
);

69 
z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

70 
z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

71 
zskli¡Node
 *
z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

72 
zskli¡Node
 *
z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

73 
z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict);

74 
z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict);

75 
z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict);

76 
z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
o
);

77 
zskli¡Node
* 
z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
);

78 
z¦P¬£LexRªgeI‹m
(
robj
 *
™em
,„obj **
de¡
, *
ex
);

79 
z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
);

80 
com·»SŒšgObjeùsFÜLexRªge
(
robj
 *
a
,„obj *
b
);

81 
z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

82 
zskli¡Node
 *
z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

83 
zskli¡Node
 *
z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

84 
zzlG‘ScÜe
(*
¥Œ
);

85 
robj
 *
zli¡G‘Objeù
(*
¥Œ
);

86 
zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
);

87 
zzlL’gth
(*
zl
);

88 
zzlNext
(*
zl
, **
•Œ
, **
¥Œ
);

89 
zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
);

90 
zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

91 *
zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

92 *
zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

93 
zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

94 *
zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

96 *
zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

97 *
zzlFšd
(*
zl
, 
robj
 *
–e
, *
scÜe
);

98 *
zzlD–‘e
(*
zl
, *
•Œ
);

99 *
zzlIn£¹At
(*
zl
, *
•Œ
, 
robj
 *
–e
, 
scÜe
);

100 *
zzlIn£¹
(*
zl
, 
robj
 *
–e
, 
scÜe
);

101 *
zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
);

102 *
zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
);

103 *
zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
);

104 
z£tL’gth
(
robj
 *
zobj
);

105 
z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
);

106 
z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
);

107 
z£tScÜe
(
robj
 *
zobj
,„obj *
memb”
, *
scÜe
);

109 
zaddG’”icCommªd
(
ş›Á
 *
c
, 
æags
);

110 
zaddCommªd
(
ş›Á
 *
c
);

111 
zšübyCommªd
(
ş›Á
 *
c
);

112 
z»mCommªd
(
ş›Á
 *
c
);

113 
z»m¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
¿ng‘y³
);

114 
z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
);

115 
z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

116 
z»m¿ngebyËxCommªd
(
ş›Á
 *
c
) ;

118 
zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
);

119 
zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
);

120 
zuiL’gth
(
z£tİ¤c
 *
İ
);

125 
zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
);

126 
zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
);

127 
robj
 *
zuiObjeùFromV®ue
(
z£tİv®
 *
v®
);

128 
zuiBufãrFromV®ue
(
z£tİv®
 *
v®
);

132 
zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
);

133 
zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
);

134 
zuniÚIÁ”G’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
d¡key
, 
İ
);

135 
zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

136 
zš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

137 
z¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
);

138 
z¿ngeCommªd
(
ş›Á
 *
c
);

139 
z»v¿ngeCommªd
(
ş›Á
 *
c
);

142 
g’”icZ¿ngebyscÜeCommªd
(
ş›Á
 *
c
, 
»v”£
);

143 
z¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

144 
z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

145 
zcouÁCommªd
(
ş›Á
 *
c
);

146 
zËxcouÁCommªd
(
ş›Á
 *
c
);

149 
g’”icZ¿ngebyËxCommªd
(
ş›Á
 *
c
, 
»v”£
);

150 
z¿ngebyËxCommªd
(
ş›Á
 *
c
);

151 
z»v¿ngebyËxCommªd
(
ş›Á
 *
c
);

152 
zÿrdCommªd
(
ş›Á
 *
c
);

153 
zscÜeCommªd
(
ş›Á
 *
c
);

154 
z¿nkG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
);

155 
z¿nkCommªd
(
ş›Á
 *
c
);

156 
z»v¿nkCommªd
(
ş›Á
 *
c
);

157 
zsÿnCommªd
(
ş›Á
 *
c
);

	@src/vr_t_zset.h

1 #iâdeà
_VR_T_ZSET_H_


2 
	#_VR_T_ZSET_H_


	)

6 
	mmš
, 
	mmax
;

7 
	mmšex
, 
	mmaxex
;

8 } 
	tz¿nge¥ec
;

12 
robj
 *
	mmš
, *
	mmax
;

13 
	mmšex
, 
	mmaxex
;

14 } 
	tzËx¿nge¥ec
;

17 
robj
 *
	msubjeù
;

18 
	mty³
;

19 
	m’codšg
;

20 
	mweight
;

24 
	u_™”£t
 {

26 
št£t
 *
	mis
;

27 
	mii
;

28 } 
	mis
;

30 
diù
 *
	mdiù
;

31 
diùI‹¿tÜ
 *
	mdi
;

32 
diùEÁry
 *
	mde
;

33 } 
	mht
;

34 } 
	m£t
;

37 
	u_™”z£t
 {

39 *
	mzl
;

40 *
	m•Œ
, *
	m¥Œ
;

41 } 
	mzl
;

43 
z£t
 *
	mzs
;

44 
zskli¡Node
 *
	mnode
;

45 } 
	m¦
;

46 } 
	mz£t
;

47 } 
	m™”
;

48 } 
	tz£tİ¤c
;

52 
	mæags
;

53 
	m_buf
[32];

54 
robj
 *
	m–e
;

55 *
	me¡r
;

56 
	m–’
;

57 
	m–l
;

58 
	mscÜe
;

59 } 
	tz£tİv®
;

61 
zskli¡Node
 *
z¦C»©eNode
(
Ëv–
, 
scÜe
, 
robj
 *
obj
);

62 
zskli¡
 *
z¦C»©e
();

63 
z¦F»eNode
(
zskli¡Node
 *
node
);

64 
z¦F»e
(
zskli¡
 *
z¦
);

65 
z¦RªdomLev–
();

66 
zskli¡Node
 *
z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
);

67 
z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
);

68 
z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
);

69 
z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

70 
z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

71 
zskli¡Node
 *
z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

72 
zskli¡Node
 *
z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

73 
z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict);

74 
z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict);

75 
z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict);

76 
z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
o
);

77 
zskli¡Node
* 
z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
);

78 
z¦P¬£LexRªgeI‹m
(
robj
 *
™em
,„obj **
de¡
, *
ex
);

79 
z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
);

80 
com·»SŒšgObjeùsFÜLexRªge
(
robj
 *
a
,„obj *
b
);

81 
z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

82 
zskli¡Node
 *
z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

83 
zskli¡Node
 *
z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

84 
zzlG‘ScÜe
(*
¥Œ
);

85 
robj
 *
zli¡G‘Objeù
(*
¥Œ
);

86 
zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
);

87 
zzlL’gth
(*
zl
);

88 
zzlNext
(*
zl
, **
•Œ
, **
¥Œ
);

89 
zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
);

90 
zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

91 *
zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

92 *
zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

93 
zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

94 *
zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

96 *
zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

97 *
zzlFšd
(*
zl
, 
robj
 *
–e
, *
scÜe
);

98 *
zzlD–‘e
(*
zl
, *
•Œ
);

99 *
zzlIn£¹At
(*
zl
, *
•Œ
, 
robj
 *
–e
, 
scÜe
);

100 *
zzlIn£¹
(*
zl
, 
robj
 *
–e
, 
scÜe
);

101 *
zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
);

102 *
zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
);

103 *
zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
);

104 
z£tL’gth
(
robj
 *
zobj
);

105 
z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
);

106 
z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
);

107 
z£tScÜe
(
robj
 *
zobj
,„obj *
memb”
, *
scÜe
);

109 
zaddG’”icCommªd
(
ş›Á
 *
c
, 
æags
);

110 
zaddCommªd
(
ş›Á
 *
c
);

111 
zšübyCommªd
(
ş›Á
 *
c
);

112 
z»mCommªd
(
ş›Á
 *
c
);

113 
z»m¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
¿ng‘y³
);

114 
z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
);

115 
z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

116 
z»m¿ngebyËxCommªd
(
ş›Á
 *
c
) ;

118 
zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
);

119 
zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
);

120 
zuiL’gth
(
z£tİ¤c
 *
İ
);

125 
zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
);

126 
zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
);

127 
robj
 *
zuiObjeùFromV®ue
(
z£tİv®
 *
v®
);

128 
zuiBufãrFromV®ue
(
z£tİv®
 *
v®
);

132 
zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
);

133 
zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
);

134 
zuniÚIÁ”G’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
d¡key
, 
İ
);

135 
zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

136 
zš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

137 
z¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
);

138 
z¿ngeCommªd
(
ş›Á
 *
c
);

139 
z»v¿ngeCommªd
(
ş›Á
 *
c
);

142 
g’”icZ¿ngebyscÜeCommªd
(
ş›Á
 *
c
, 
»v”£
);

143 
z¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

144 
z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

145 
zcouÁCommªd
(
ş›Á
 *
c
);

146 
zËxcouÁCommªd
(
ş›Á
 *
c
);

149 
g’”icZ¿ngebyËxCommªd
(
ş›Á
 *
c
, 
»v”£
);

150 
z¿ngebyËxCommªd
(
ş›Á
 *
c
);

151 
z»v¿ngebyËxCommªd
(
ş›Á
 *
c
);

152 
zÿrdCommªd
(
ş›Á
 *
c
);

153 
zscÜeCommªd
(
ş›Á
 *
c
);

154 
z¿nkG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
);

155 
z¿nkCommªd
(
ş›Á
 *
c
);

156 
z»v¿nkCommªd
(
ş›Á
 *
c
);

157 
zsÿnCommªd
(
ş›Á
 *
c
);

	@src/vr_thread.c

1 
	~<vr_cÜe.h
>

5 
	$vr_th»ad_š™
(
vr_th»ad
 *
th»ad
)

7 ià(
th»ad
 =ğ
NULL
) {

8  
VR_ERROR
;

11 
th»ad
->
id
 = 0;

12 
th»ad
->
th»ad_id
 = 0;

13 
th»ad
->
fun_run
 = 
NULL
;

14 
th»ad
->
d©a
 = 
NULL
;

16  
VR_OK
;

17 
	}
}

20 
	$vr_th»ad_deš™
(
vr_th»ad
 *
th»ad
)

22 ià(
th»ad
 =ğ
NULL
) {

26 
th»ad
->
id
 = 0;

27 
th»ad
->
th»ad_id
 = 0;

28 
th»ad
->
fun_run
 = 
NULL
;

29 
th»ad
->
d©a
 = 
NULL
;

30 
	}
}

33 *
	$vr_th»ad_run
(*
d©a
)

35 
vr_th»ad
 *
th»ad
 = 
d©a
;

36 
	`¤ªd
(
	`vr_u£c_now
()^()
	`±h»ad_£lf
());

38 
th»ad
->
	`fun_run
Ñh»ad->
d©a
);

39 
	}
}

42 
	$vr_th»ad_¡¬t
(
vr_th»ad
 *
th»ad
)

44 
±h»ad_©Œ_t
 
©Œ
;

45 
	`±h»ad_©Œ_š™
(&
©Œ
);

47 ià(
th»ad
 =ğ
NULL
 ||h»ad->
fun_run
 == NULL) {

48  
VR_ERROR
;

51 
	`±h»ad_ü—‹
(&
th»ad
->
th»ad_id
,

52 &
©Œ
, 
vr_th»ad_run
, 
th»ad
);

54  
VR_OK
;

55 
	}
}

	@src/vr_thread.c

1 
	~<vr_cÜe.h
>

5 
	$vr_th»ad_š™
(
vr_th»ad
 *
th»ad
)

7 ià(
th»ad
 =ğ
NULL
) {

8  
VR_ERROR
;

11 
th»ad
->
id
 = 0;

12 
th»ad
->
th»ad_id
 = 0;

13 
th»ad
->
fun_run
 = 
NULL
;

14 
th»ad
->
d©a
 = 
NULL
;

16  
VR_OK
;

17 
	}
}

20 
	$vr_th»ad_deš™
(
vr_th»ad
 *
th»ad
)

22 ià(
th»ad
 =ğ
NULL
) {

26 
th»ad
->
id
 = 0;

27 
th»ad
->
th»ad_id
 = 0;

28 
th»ad
->
fun_run
 = 
NULL
;

29 
th»ad
->
d©a
 = 
NULL
;

30 
	}
}

33 *
	$vr_th»ad_run
(*
d©a
)

35 
vr_th»ad
 *
th»ad
 = 
d©a
;

36 
	`¤ªd
(
	`vr_u£c_now
()^()
	`±h»ad_£lf
());

38 
th»ad
->
	`fun_run
Ñh»ad->
d©a
);

39 
	}
}

42 
	$vr_th»ad_¡¬t
(
vr_th»ad
 *
th»ad
)

44 
±h»ad_©Œ_t
 
©Œ
;

45 
	`±h»ad_©Œ_š™
(&
©Œ
);

47 ià(
th»ad
 =ğ
NULL
 ||h»ad->
fun_run
 == NULL) {

48  
VR_ERROR
;

51 
	`±h»ad_ü—‹
(&
th»ad
->
th»ad_id
,

52 &
©Œ
, 
vr_th»ad_run
, 
th»ad
);

54  
VR_OK
;

55 
	}
}

	@src/vr_thread.h

1 #iâdeà
_VR_THREAD_H_


2 
	#_VR_THREAD_H_


	)

6 *(*
	tvr_th»ad_func_t
)(*
	td©a
);

8 
	svr_th»ad
 {

10 
	mid
;

12 
±h»ad_t
 
	mth»ad_id
;

14 
vr_th»ad_func_t
 
	mfun_run
;

16 *
	md©a
;

17 }
	tvr_th»ad
;

20 
vr_th»ad_š™
(
vr_th»ad
 *
th»ad
);

21 
vr_th»ad_deš™
(
vr_th»ad
 *
th»ad
);

22 
vr_th»ad_¡¬t
(
vr_th»ad
 *
th»ad
);

	@src/vr_thread.h

1 #iâdeà
_VR_THREAD_H_


2 
	#_VR_THREAD_H_


	)

6 *(*
	tvr_th»ad_func_t
)(*
	td©a
);

8 
	svr_th»ad
 {

10 
	mid
;

12 
±h»ad_t
 
	mth»ad_id
;

14 
vr_th»ad_func_t
 
	mfun_run
;

16 *
	md©a
;

17 }
	tvr_th»ad
;

20 
vr_th»ad_š™
(
vr_th»ad
 *
th»ad
);

21 
vr_th»ad_deš™
(
vr_th»ad
 *
th»ad
);

22 
vr_th»ad_¡¬t
(
vr_th»ad
 *
th»ad
);

	@src/vr_util.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡d¬g.h
>

4 
	~<¡ršg.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<Ãtdb.h
>

9 
	~<sys/time.h
>

10 
	~<sys/ty³s.h
>

11 
	~<sys/sock‘.h
>

12 
	~<sys/ioùl.h
>

14 
	~<Ãtš‘/š.h
>

15 
	~<Ãtš‘/tı.h
>

17 
	~<vr_cÜe.h
>

19 #ifdeà
VR_HAVE_BACKTRACE


20 
	~<execšfo.h
>

24 
	$vr_£t_blockšg
(
sd
)

26 
æags
;

28 
æags
 = 
	`fú
(
sd
, 
F_GETFL
, 0);

29 ià(
æags
 < 0) {

30  
æags
;

33  
	`fú
(
sd
, 
F_SETFL
, 
æags
 & ~
O_NONBLOCK
);

34 
	}
}

37 
	$vr_£t_nÚblockšg
(
sd
)

39 
æags
;

41 
æags
 = 
	`fú
(
sd
, 
F_GETFL
, 0);

42 ià(
æags
 < 0) {

43  
æags
;

46  
	`fú
(
sd
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
);

47 
	}
}

50 
	$vr_£t_»u£addr
(
sd
)

52 
»u£
;

53 
sockËn_t
 
Ën
;

55 
»u£
 = 1;

56 
Ën
 = (
»u£
);

58  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
»u£
, 
Ën
);

59 
	}
}

71 
	$vr_£t_tınod–ay
(
sd
)

73 
nod–ay
;

74 
sockËn_t
 
Ën
;

76 
nod–ay
 = 1;

77 
Ën
 = (
nod–ay
);

79  
	`£tsockİt
(
sd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
nod–ay
, 
Ën
);

80 
	}
}

84 
	$vr_£t_lšg”
(
sd
, 
timeout
)

86 
lšg”
†inger;

87 
sockËn_t
 
Ën
;

89 
lšg”
.
l_Úoff
 = 1;

90 
lšg”
.
l_lšg”
 = 
timeout
;

92 
Ën
 = (
lšg”
);

94  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_LINGER
, &
lšg”
, 
Ën
);

95 
	}
}

98 
	$vr_£t_¢dbuf
(
sd
, 
size
)

100 
sockËn_t
 
Ën
;

102 
Ën
 = (
size
);

104  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
size
, 
Ën
);

105 
	}
}

108 
	$vr_£t_rcvbuf
(
sd
, 
size
)

110 
sockËn_t
 
Ën
;

112 
Ën
 = (
size
);

114  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
size
, 
Ën
);

115 
	}
}

118 
	$vr_g‘_sÛ¼Ü
(
sd
)

120 
¡©us
, 
”r
;

121 
sockËn_t
 
Ën
;

123 
”r
 = 0;

124 
Ën
 = (
”r
);

126 
¡©us
 = 
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”r
, &
Ën
);

127 ià(
¡©us
 == 0) {

128 
”ºo
 = 
”r
;

131  
¡©us
;

132 
	}
}

135 
	$vr_g‘_¢dbuf
(
sd
)

137 
¡©us
, 
size
;

138 
sockËn_t
 
Ën
;

140 
size
 = 0;

141 
Ën
 = (
size
);

143 
¡©us
 = 
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
size
, &
Ën
);

144 ià(
¡©us
 < 0) {

145  
¡©us
;

148  
size
;

149 
	}
}

152 
	$vr_g‘_rcvbuf
(
sd
)

154 
¡©us
, 
size
;

155 
sockËn_t
 
Ën
;

157 
size
 = 0;

158 
Ën
 = (
size
);

160 
¡©us
 = 
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
size
, &
Ën
);

161 ià(
¡©us
 < 0) {

162  
¡©us
;

165  
size
;

166 
	}
}

169 
	$vr_£t_tık“·live
(
sd
, 
k“pidË
, 
k“pš‹rv®
, 
k“pcouÁ
)

171 
r¡©us_t
 
¡©us
;

172 
tık“·live
;

173 
sockËn_t
 
Ën
;

175 
tık“·live
 = 1;

176 
Ën
 = (
tık“·live
);

178 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
tık“·live
, 
Ën
);

179 ià(
¡©us
 < 0) {

180 
	`log_”rÜ
("£tsockİˆSO_KEEPALIVE c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

181  
VR_ERROR
;

184 #ifdeà
SOL_TCP


185 ià(
k“pidË
 > 0) {

186 
Ën
 = (
k“pidË
);

187 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_TCP
, 
TCP_KEEPIDLE
, &
k“pidË
, 
Ën
);

188 ià(
¡©us
 < 0) {

189 
	`log_”rÜ
("£tsockİˆTCP_KEEPIDLE c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

190  
VR_ERROR
;

194 ià(
k“pš‹rv®
 > 0) {

195 
Ën
 = (
k“pš‹rv®
);

196 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_TCP
, 
TCP_KEEPINTVL
, &
k“pš‹rv®
, 
Ën
);

197 ià(
¡©us
 < 0) {

198 
	`log_”rÜ
("£tsockİˆTCP_KEEPINTVL c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

199  
VR_ERROR
;

203 ià(
k“pcouÁ
 > 0) {

204 
Ën
 = (
k“pcouÁ
);

205 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_TCP
, 
TCP_KEEPCNT
, &
k“pcouÁ
, 
Ën
);

206 ià(
¡©us
 < 0) {

207 
	`log_”rÜ
("£tsockİˆTCP_KEEPCNT c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

208  
VR_ERROR
;

213  
VR_OK
;

214 
	}
}

217 
	$_vr_©oi
(*
lše
, 
size_t
 
n
)

219 
v®ue
;

221 ià(
n
 == 0) {

225 
v®ue
 = 0; 
n
--; 
lše
++) {

226 ià(*
lše
 < '0' || *line > '9') {

230 
v®ue
 = v®u* 10 + (*
lše
 - '0');

233 ià(
v®ue
 < 0) {

237  
v®ue
;

238 
	}
}

242 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

243 ià(
v
 < 10)  1;

244 ià(
v
 < 100)  2;

245 ià(
v
 < 1000)  3;

246 ià(
v
 < 1000000000000UL) {

247 ià(
v
 < 100000000UL) {

248 ià(
v
 < 1000000) {

249 ià(
v
 < 10000)  4;

250  5 + (
v
 >= 100000);

252  7 + (
v
 >= 10000000UL);

254 ià(
v
 < 10000000000UL) {

255  9 + (
v
 >= 1000000000UL);

257  11 + (
v
 >= 100000000000UL);

259  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

260 
	}
}

263 
ušt32_t
 
	$sdig™s10
(
št64_t
 
v
) {

264 ià(
v
 < 0) {

266 
ušt64_t
 
uv
 = (
v
 !ğ
LLONG_MIN
) ?

267 (
ušt64_t
)-
v
 : ((ušt64_tè
LLONG_MAX
)+1;

268  
	`dig™s10
(
uv
)+1;

270  
	`dig™s10
(
v
);

272 
	}
}

286 
	$Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

287 cÚ¡ 
dig™s
[201] =

293 
Ãg©ive
;

294 
v®ue
;

298 ià(
sv®ue
 < 0) {

299 ià(
sv®ue
 !ğ
LLONG_MIN
) {

300 
v®ue
 = -
sv®ue
;

302 
v®ue
 = ((è
LLONG_MAX
)+1;

304 
Ãg©ive
 = 1;

306 
v®ue
 = 
sv®ue
;

307 
Ãg©ive
 = 0;

311 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

312 ià(
Ëngth
 >ğ
d¡Ën
)  0;

315 
ušt32_t
 
Ãxt
 = 
Ëngth
;

316 
d¡
[
Ãxt
] = '\0';

317 
Ãxt
--;

318 
v®ue
 >= 100) {

319 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

320 
v®ue
 /= 100;

321 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

322 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

323 
Ãxt
 -= 2;

327 ià(
v®ue
 < 10) {

328 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

330 
i
 = (
ušt32_t
è
v®ue
 * 2;

331 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

332 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

336 ià(
Ãg©ive
è
d¡
[0] = '-';

337  
Ëngth
;

338 
	}
}

344 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

345 cÚ¡ *
p
 = 
s
;

346 
size_t
 
¶’
 = 0;

347 
Ãg©ive
 = 0;

348 
v
;

350 ià(
¶’
 =ğ
¦’
)

354 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

355 ià(
v®ue
 !ğ
NULL
) *value = 0;

359 ià(
p
[0] == '-') {

360 
Ãg©ive
 = 1;

361 
p
++; 
¶’
++;

364 ià(
¶’
 =ğ
¦’
)

369 ià(
p
[0] >= '1' &&…[0] <= '9') {

370 
v
 = 
p
[0]-'0';

371 
p
++; 
¶’
++;

372 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

373 *
v®ue
 = 0;

379 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

380 ià(
v
 > (
ULLONG_MAX
 / 10))

382 
v
 *= 10;

384 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

386 
v
 +ğ
p
[0]-'0';

388 
p
++; 
¶’
++;

392 ià(
¶’
 < 
¦’
)

395 ià(
Ãg©ive
) {

396 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

398 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

400 ià(
v
 > 
LLONG_MAX
)

402 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

405 
	}
}

410 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

411 
Îv®
;

413 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

416 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

419 *
lv®
 = ()
Îv®
;

421 
	}
}

425 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

426 ià(
	`i¢ª
(
v®ue
)) {

427 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

428 } ià(
	`isšf
(
v®ue
)) {

429 ià(
v®ue
 < 0)

430 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

432 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

433 } ià(
v®ue
 == 0) {

435 ià(1.0/
v®ue
 < 0)

436 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

438 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

440 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

450 
mš
 = -4503599627370495;

451 
max
 = 4503599627370496;

452 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

453 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

456 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

459  
Ën
;

460 
	}
}

462 
boŞ


463 
	$vr_v®id_pÜt
(
n
)

465 ià(
n
 < 1 ||‚ > 
UINT16_MAX
) {

466  
çl£
;

469  
Œue
;

470 
	}
}

476 
ssize_t


477 
	$_vr_£ndn
(
sd
, cÚ¡ *
v±r
, 
size_t
 
n
)

479 
size_t
 
Æeá
;

480 
ssize_t
 
n£nd
;

481 cÚ¡ *
±r
;

483 
±r
 = 
v±r
;

484 
Æeá
 = 
n
;

485 
Æeá
 > 0) {

486 
n£nd
 = 
	`£nd
(
sd
, 
±r
, 
Æeá
, 0);

487 ià(
n£nd
 < 0) {

488 ià(
”ºo
 =ğ
EINTR
) {

491  
n£nd
;

493 ià(
n£nd
 == 0) {

497 
Æeá
 -ğ(
size_t
)
n£nd
;

498 
±r
 +ğ
n£nd
;

501  (
ssize_t
)
n
;

502 
	}
}

508 
ssize_t


509 
	$_vr_»cvn
(
sd
, *
v±r
, 
size_t
 
n
)

511 
size_t
 
Æeá
;

512 
ssize_t
 
Äecv
;

513 *
±r
;

515 
±r
 = 
v±r
;

516 
Æeá
 = 
n
;

517 
Æeá
 > 0) {

518 
Äecv
 = 
	`»cv
(
sd
, 
±r
, 
Æeá
, 0);

519 ià(
Äecv
 < 0) {

520 ià(
”ºo
 =ğ
EINTR
) {

523  
Äecv
;

525 ià(
Äecv
 == 0) {

529 
Æeá
 -ğ(
size_t
)
Äecv
;

530 
±r
 +ğ
Äecv
;

533  (
ssize_t
)(
n
 - 
Æeá
);

534 
	}
}

540 
št64_t


541 
	$vr_u£c_now
()

543 
timev®
 
now
;

544 
št64_t
 
u£c
;

545 
¡©us
;

547 
¡©us
 = 
	`g‘timeofday
(&
now
, 
NULL
);

548 ià(
¡©us
 < 0) {

549 
	`log_”rÜ
("g‘timeofday faed: %s", 
	`¡»¼Ü
(
”ºo
));

553 
u£c
 = (
št64_t
)
now
.
tv_£c
 * 1000000LL + (št64_têow.
tv_u£c
;

555  
u£c
;

556 
	}
}

561 
št64_t


562 
	$vr_m£c_now
()

564  
	`vr_u£c_now
() / 1000LL;

565 
	}
}

568 
	$vr_»sŞve_š‘
(
sds
 
Çme
, 
pÜt
, 
sockšfo
 *
si
)

570 
¡©us
;

571 
addršfo
 *
ai
, *
ÿi
;

572 
addršfo
 
hšts
;

573 *
node
, 
£rviû
[
VR_UINTMAX_MAXLEN
];

574 
boŞ
 
found
;

576 
	`ASSERT
(
	`vr_v®id_pÜt
(
pÜt
));

578 
	`mem£t
(&
hšts
, 0, (hints));

579 
hšts
.
ai_æags
 = 
AI_NUMERICSERV
;

580 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

581 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

582 
hšts
.
ai_´ÙocŞ
 = 0;

583 
hšts
.
ai_add¾’
 = 0;

584 
hšts
.
ai_addr
 = 
NULL
;

585 
hšts
.
ai_ÿnÚÇme
 = 
NULL
;

587 ià(
Çme
 !ğ
NULL
) {

588 
node
 = (*)
Çme
;

596 
node
 = 
NULL
;

597 
hšts
.
ai_æags
 |ğ
AI_PASSIVE
;

600 
	`d¢´štf
(
£rviû
, 
VR_UINTMAX_MAXLEN
, "%d", 
pÜt
);

606 
¡©us
 = 
	`g‘addršfo
(
node
, 
£rviû
, &
hšts
, &
ai
);

607 ià(
¡©us
 != 0) {

608 
	`log_”rÜ
("address„esolution of‚ode '%s' service '%s' failed: %s",

609 
node
, 
£rviû
, 
	`gai_¡»¼Ü
(
¡©us
));

624 
ÿi
 = 
ai
, 
found
 = 
çl£
; ca˜!ğ
NULL
; ca˜ğÿi->
ai_Ãxt
) {

625 
si
->
çmy
 = 
ÿi
->
ai_çmy
;

626 
si
->
add¾’
 = 
ÿi
->
ai_add¾’
;

627 
	`vr_memıy
(&
si
->
addr
, 
ÿi
->
ai_addr
, si->
add¾’
);

628 
found
 = 
Œue
;

632 
	`ä“addršfo
(
ai
);

634  !
found
 ? -1 : 0;

635 
	}
}

638 
	$vr_»sŞve_unix
(
sds
 
Çme
, 
sockšfo
 *
si
)

640 
sockaddr_un
 *
un
;

642 ià(
	`sd¦’
(
Çme
è>ğ
VR_UNIX_ADDRSTRLEN
) {

646 
un
 = &
si
->
addr
.un;

648 
un
->
sun_çmy
 = 
AF_UNIX
;

649 
	`vr_memıy
(
un
->
sun_·th
, 
Çme
, 
	`sd¦’
(name));

650 
un
->
sun_·th
[
	`sd¦’
(
Çme
)] = '\0';

652 
si
->
çmy
 = 
AF_UNIX
;

653 
si
->
add¾’
 = (*
un
);

657 
	}
}

666 
	$vr_»sŞve
(
sds
 
Çme
, 
pÜt
, 
sockšfo
 *
si
)

668 ià(
Çme
 !ğ
NULL
 &&‚ame[0] == '/') {

669  
	`vr_»sŞve_unix
(
Çme
, 
si
);

672  
	`vr_»sŞve_š‘
(
Çme
, 
pÜt
, 
si
);

673 
	}
}

675 
	$vr_Ãt_³”_to_¡ršg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

676 
sockaddr_¡Üage
 
§
;

677 
sockËn_t
 
§Ën
 = (
§
);

679 ià(
	`g‘³”Çme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
è=ğ-1è
”rÜ
;

680 ià(
_Ën
 =ğ0è
”rÜ
;

682 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

683 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

684 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

685 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

686 } ià(
§
.
ss_çmy
 =ğ
AF_INET6
) {

687 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

688 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

689 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

690 } ià(
§
.
ss_çmy
 =ğ
AF_UNIX
) {

691 ià(

è
	`¡ºıy
(,"/unixsock‘",
_Ën
);

692 ià(
pÜt
) *port = 0;

694 
”rÜ
;

698 
”rÜ
:

699 ià(

) {

700 ià(
_Ën
 >= 2) {

701 

[0] = '?';

702 

[1] = '\0';

703 } ià(
_Ën
 == 1) {

704 

[0] = '\0';

707 ià(
pÜt
) *port = 0;

709 
	}
}

715 
	$vr_Ãt_fÜm©_addr
(*
buf
, 
size_t
 
buf_Ën
, *

, 
pÜt
) {

716  
	`¢´štf
(
buf
,
buf_Ën
, 
	`¡rchr
(

,':') ?

717 "[%s]:%d" : "%s:%d", 

, 
pÜt
);

718 
	}
}

722 
	$vr_Ãt_fÜm©_³”
(
fd
, *
buf
, 
size_t
 
buf_Ën
) {

723 

[
VR_INET6_ADDRSTRLEN
];

724 
pÜt
;

726 
	`vr_Ãt_³”_to_¡ršg
(
fd
,

,(),&
pÜt
);

727  
	`vr_Ãt_fÜm©_addr
(
buf
, 
buf_Ën
, 

, 
pÜt
);

728 
	}
}

735 
	$g‘_¿ndom_hex_ch¬s
(*
p
, 
Ën
) {

736 *
ch¬£t
 = "0123456789abcdef";

737 
j
;

740 
£ed_š™Ÿlized
 = 0;

741 
£ed
[20];

742 
ušt64_t
 
couÁ”
 = 0;

744 ià(!
£ed_š™Ÿlized
) {

749 
FILE
 *
å
 = 
	`fİ’
("/dev/urandom","r");

750 ià(
å
 && 
	`ä—d
(
£ed
,(seed),1,fp) == 1)

751 
£ed_š™Ÿlized
 = 1;

752 ià(
å
è
	`fşo£
(fp);

755 ià(
£ed_š™Ÿlized
) {

756 
Ën
) {

757 
dige¡
[20];

758 
SHA1_CTX
 
ùx
;

759 
cİyËn
 = 
Ën
 > 20 ? 20 :†en;

761 
	`SHA1In™
(&
ùx
);

762 
	`SHA1Upd©e
(&
ùx
, 
£ed
, (seed));

763 
	`SHA1Upd©e
(&
ùx
, (*)&
couÁ”
,(counter));

764 
	`SHA1Fš®
(
dige¡
, &
ùx
);

765 
couÁ”
++;

767 
	`memıy
(
p
,
dige¡
,
cİyËn
);

769 
j
 = 0; j < 
cİyËn
; j++è
p
[j] = 
ch¬£t
[p[j] & 0x0F];

770 
Ën
 -ğ
cİyËn
;

771 
p
 +ğ
cİyËn
;

777 *
x
 = 
p
;

778 
l
 = 
Ën
;

779 
timev®
 
tv
;

780 
pid_t
 
pid
 = 
	`g‘pid
();

783 
	`g‘timeofday
(&
tv
,
NULL
);

784 ià(
l
 >ğ(
tv
.
tv_u£c
)) {

785 
	`memıy
(
x
,&
tv
.
tv_u£c
,(tv.tv_usec));

786 
l
 -ğ(
tv
.
tv_u£c
);

787 
x
 +ğ(
tv
.
tv_u£c
);

789 ià(
l
 >ğ(
tv
.
tv_£c
)) {

790 
	`memıy
(
x
,&
tv
.
tv_£c
,(tv.tv_sec));

791 
l
 -ğ(
tv
.
tv_£c
);

792 
x
 +ğ(
tv
.
tv_£c
);

794 ià(
l
 >ğ(
pid
)) {

795 
	`memıy
(
x
,&
pid
,(pid));

796 
l
 -ğ(
pid
);

797 
x
 +ğ(
pid
);

801 
j
 = 0; j < 
Ën
; j++) {

802 
p
[
j
] ^ğ
	`¿nd
();

803 
p
[
j
] = 
ch¬£t
[p[j] & 0x0F];

806 
	}
}

810 
	$¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

811 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

813 
·‰”nL’
) {

814 
·‰”n
[0]) {

816 
·‰”n
[1] == '*') {

817 
·‰”n
++;

818 
·‰”nL’
--;

820 ià(
·‰”nL’
 == 1)

822 
¡ršgL’
) {

823 ià(
	`¡ršgm©chËn
(
·‰”n
+1, 
·‰”nL’
-1,

824 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

826 
¡ršg
++;

827 
¡ršgL’
--;

832 ià(
¡ršgL’
 == 0)

834 
¡ršg
++;

835 
¡ršgL’
--;

839 
nÙ
, 
m©ch
;

841 
·‰”n
++;

842 
·‰”nL’
--;

843 
nÙ
 = 
·‰”n
[0] == '^';

844 ià(
nÙ
) {

845 
·‰”n
++;

846 
·‰”nL’
--;

848 
m©ch
 = 0;

850 ià(
·‰”n
[0] == '\\') {

851 
·‰”n
++;

852 
·‰”nL’
--;

853 ià(
·‰”n
[0] =ğ
¡ršg
[0])

854 
m©ch
 = 1;

855 } ià(
·‰”n
[0] == ']') {

857 } ià(
·‰”nL’
 == 0) {

858 
·‰”n
--;

859 
·‰”nL’
++;

861 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

862 
¡¬t
 = 
·‰”n
[0];

863 
’d
 = 
·‰”n
[2];

864 
c
 = 
¡ršg
[0];

865 ià(
¡¬t
 > 
’d
) {

866 
t
 = 
¡¬t
;

867 
¡¬t
 = 
’d
;

868 
’d
 = 
t
;

870 ià(
noÿ£
) {

871 
¡¬t
 = 
	`tŞow”
(start);

872 
’d
 = 
	`tŞow”
(end);

873 
c
 = 
	`tŞow”
(c);

875 
·‰”n
 += 2;

876 
·‰”nL’
 -= 2;

877 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

878 
m©ch
 = 1;

880 ià(!
noÿ£
) {

881 ià(
·‰”n
[0] =ğ
¡ršg
[0])

882 
m©ch
 = 1;

884 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

885 
m©ch
 = 1;

888 
·‰”n
++;

889 
·‰”nL’
--;

891 ià(
nÙ
)

892 
m©ch
 = !match;

893 ià(!
m©ch
)

895 
¡ršg
++;

896 
¡ršgL’
--;

900 ià(
·‰”nL’
 >= 2) {

901 
·‰”n
++;

902 
·‰”nL’
--;

906 ià(!
noÿ£
) {

907 ià(
·‰”n
[0] !ğ
¡ršg
[0])

910 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

913 
¡ršg
++;

914 
¡ršgL’
--;

917 
·‰”n
++;

918 
·‰”nL’
--;

919 ià(
¡ršgL’
 == 0) {

920 *
·‰”n
 == '*') {

921 
·‰”n
++;

922 
·‰”nL’
--;

927 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

930 
	}
}

932 
	$¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

933  
	`¡ršgm©chËn
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

934 
	}
}

938 
	$mem»v16
(*
p
) {

939 *
x
 = 
p
, 
t
;

941 
t
 = 
x
[0];

942 
x
[0] = x[1];

943 
x
[1] = 
t
;

944 
	}
}

948 
	$mem»v32
(*
p
) {

949 *
x
 = 
p
, 
t
;

951 
t
 = 
x
[0];

952 
x
[0] = x[3];

953 
x
[3] = 
t
;

954 
t
 = 
x
[1];

955 
x
[1] = x[2];

956 
x
[2] = 
t
;

957 
	}
}

961 
	$mem»v64
(*
p
) {

962 *
x
 = 
p
, 
t
;

964 
t
 = 
x
[0];

965 
x
[0] = x[7];

966 
x
[7] = 
t
;

967 
t
 = 
x
[1];

968 
x
[1] = x[6];

969 
x
[6] = 
t
;

970 
t
 = 
x
[2];

971 
x
[2] = x[5];

972 
x
[5] = 
t
;

973 
t
 = 
x
[3];

974 
x
[3] = x[4];

975 
x
[4] = 
t
;

976 
	}
}

978 
ušt16_t
 
	$šŒev16
(
ušt16_t
 
v
) {

979 
	`mem»v16
(&
v
);

980  
v
;

981 
	}
}

983 
ušt32_t
 
	$šŒev32
(
ušt32_t
 
v
) {

984 
	`mem»v32
(&
v
);

985  
v
;

986 
	}
}

988 
ušt64_t
 
	$šŒev64
(
ušt64_t
 
v
) {

989 
	`mem»v64
(&
v
);

990  
v
;

991 
	}
}

1000 
	$memtŞl
(cÚ¡ *
p
, *
”r
) {

1001 cÚ¡ *
u
;

1002 
buf
[128];

1003 
mul
;

1004 
v®
;

1005 
dig™s
;

1007 ià(
”r
) *err = 0;

1010 
u
 = 
p
;

1011 ià(*
u
 == '-') u++;

1012 *
u
 && 
	`isdig™
(*u)) u++;

1013 ià(*
u
 =ğ'\0' || !
	`¡rÿ£cmp
(u,"b")) {

1014 
mul
 = 1;

1015 } ià(!
	`¡rÿ£cmp
(
u
,"k")) {

1016 
mul
 = 1000;

1017 } ià(!
	`¡rÿ£cmp
(
u
,"kb")) {

1018 
mul
 = 1024;

1019 } ià(!
	`¡rÿ£cmp
(
u
,"m")) {

1020 
mul
 = 1000*1000;

1021 } ià(!
	`¡rÿ£cmp
(
u
,"mb")) {

1022 
mul
 = 1024*1024;

1023 } ià(!
	`¡rÿ£cmp
(
u
,"g")) {

1024 
mul
 = 1000L*1000*1000;

1025 } ià(!
	`¡rÿ£cmp
(
u
,"gb")) {

1026 
mul
 = 1024L*1024*1024;

1028 ià(
”r
) *err = 1;

1034 
dig™s
 = 
u
-
p
;

1035 ià(
dig™s
 >ğ(
buf
)) {

1036 ià(
”r
) *err = 1;

1039 
	`memıy
(
buf
,
p
,
dig™s
);

1040 
buf
[
dig™s
] = '\0';

1042 *
’d±r
;

1043 
”ºo
 = 0;

1044 
v®
 = 
	`¡¹Şl
(
buf
,&
’d±r
,10);

1045 ià((
v®
 =ğ0 && 
”ºo
 =ğ
EINVAL
è|| *
’d±r
 != '\0') {

1046 ià(
”r
) *err = 1;

1049  
v®
*
mul
;

1050 
	}
}

1054 
	$by‹sToHumª
(*
s
, 
n
) {

1055 
d
;

1057 ià(
n
 < 1024) {

1059 
	`¥rštf
(
s
,"%ÎuB",
n
);

1061 } ià(
n
 < (1024*1024)) {

1062 
d
 = ()
n
/(1024);

1063 
	`¥rštf
(
s
,"%.2fK",
d
);

1064 } ià(
n
 < (1024LL*1024*1024)) {

1065 
d
 = ()
n
/(1024*1024);

1066 
	`¥rštf
(
s
,"%.2fM",
d
);

1067 } ià(
n
 < (1024LL*1024*1024*1024)) {

1068 
d
 = ()
n
/(1024LL*1024*1024);

1069 
	`¥rštf
(
s
,"%.2fG",
d
);

1070 } ià(
n
 < (1024LL*1024*1024*1024*1024)) {

1071 
d
 = ()
n
/(1024LL*1024*1024*1024);

1072 
	`¥rštf
(
s
,"%.2fT",
d
);

1073 } ià(
n
 < (1024LL*1024*1024*1024*1024*1024)) {

1074 
d
 = ()
n
/(1024LL*1024*1024*1024*1024);

1075 
	`¥rštf
(
s
,"%.2fP",
d
);

1078 
	`¥rštf
(
s
,"%ÎuB",
n
);

1080 
	}
}

1090 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

1091 
cwd
[1024];

1092 
sds
 
ab¥©h
;

1093 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

1095 
»Í©h
 = 
	`sd¡rim
(relpath," \r\n\t");

1096 ià(
»Í©h
[0] == '/') „elpath;

1099 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

1100 
	`sdsä“
(
»Í©h
);

1101  
NULL
;

1103 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

1104 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

1105 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

1113 
	`sd¦’
(
»Í©h
) >= 3 &&

1114 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

1116 
	`sd¤ªge
(
»Í©h
,3,-1);

1117 ià(
	`sd¦’
(
ab¥©h
) > 1) {

1118 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

1119 
ŒimËn
 = 1;

1121 *
p
 != '/') {

1122 
p
--;

1123 
ŒimËn
++;

1125 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

1130 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

1131 
	`sdsä“
(
»Í©h
);

1132  
ab¥©h
;

1133 
	}
}

	@src/vr_util.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡d¬g.h
>

4 
	~<¡ršg.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<Ãtdb.h
>

9 
	~<sys/time.h
>

10 
	~<sys/ty³s.h
>

11 
	~<sys/sock‘.h
>

12 
	~<sys/ioùl.h
>

14 
	~<Ãtš‘/š.h
>

15 
	~<Ãtš‘/tı.h
>

17 
	~<vr_cÜe.h
>

19 #ifdeà
VR_HAVE_BACKTRACE


20 
	~<execšfo.h
>

24 
	$vr_£t_blockšg
(
sd
)

26 
æags
;

28 
æags
 = 
	`fú
(
sd
, 
F_GETFL
, 0);

29 ià(
æags
 < 0) {

30  
æags
;

33  
	`fú
(
sd
, 
F_SETFL
, 
æags
 & ~
O_NONBLOCK
);

34 
	}
}

37 
	$vr_£t_nÚblockšg
(
sd
)

39 
æags
;

41 
æags
 = 
	`fú
(
sd
, 
F_GETFL
, 0);

42 ià(
æags
 < 0) {

43  
æags
;

46  
	`fú
(
sd
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
);

47 
	}
}

50 
	$vr_£t_»u£addr
(
sd
)

52 
»u£
;

53 
sockËn_t
 
Ën
;

55 
»u£
 = 1;

56 
Ën
 = (
»u£
);

58  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
»u£
, 
Ën
);

59 
	}
}

71 
	$vr_£t_tınod–ay
(
sd
)

73 
nod–ay
;

74 
sockËn_t
 
Ën
;

76 
nod–ay
 = 1;

77 
Ën
 = (
nod–ay
);

79  
	`£tsockİt
(
sd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
nod–ay
, 
Ën
);

80 
	}
}

84 
	$vr_£t_lšg”
(
sd
, 
timeout
)

86 
lšg”
†inger;

87 
sockËn_t
 
Ën
;

89 
lšg”
.
l_Úoff
 = 1;

90 
lšg”
.
l_lšg”
 = 
timeout
;

92 
Ën
 = (
lšg”
);

94  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_LINGER
, &
lšg”
, 
Ën
);

95 
	}
}

98 
	$vr_£t_¢dbuf
(
sd
, 
size
)

100 
sockËn_t
 
Ën
;

102 
Ën
 = (
size
);

104  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
size
, 
Ën
);

105 
	}
}

108 
	$vr_£t_rcvbuf
(
sd
, 
size
)

110 
sockËn_t
 
Ën
;

112 
Ën
 = (
size
);

114  
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
size
, 
Ën
);

115 
	}
}

118 
	$vr_g‘_sÛ¼Ü
(
sd
)

120 
¡©us
, 
”r
;

121 
sockËn_t
 
Ën
;

123 
”r
 = 0;

124 
Ën
 = (
”r
);

126 
¡©us
 = 
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”r
, &
Ën
);

127 ià(
¡©us
 == 0) {

128 
”ºo
 = 
”r
;

131  
¡©us
;

132 
	}
}

135 
	$vr_g‘_¢dbuf
(
sd
)

137 
¡©us
, 
size
;

138 
sockËn_t
 
Ën
;

140 
size
 = 0;

141 
Ën
 = (
size
);

143 
¡©us
 = 
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
size
, &
Ën
);

144 ià(
¡©us
 < 0) {

145  
¡©us
;

148  
size
;

149 
	}
}

152 
	$vr_g‘_rcvbuf
(
sd
)

154 
¡©us
, 
size
;

155 
sockËn_t
 
Ën
;

157 
size
 = 0;

158 
Ën
 = (
size
);

160 
¡©us
 = 
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
size
, &
Ën
);

161 ià(
¡©us
 < 0) {

162  
¡©us
;

165  
size
;

166 
	}
}

169 
	$vr_£t_tık“·live
(
sd
, 
k“pidË
, 
k“pš‹rv®
, 
k“pcouÁ
)

171 
r¡©us_t
 
¡©us
;

172 
tık“·live
;

173 
sockËn_t
 
Ën
;

175 
tık“·live
 = 1;

176 
Ën
 = (
tık“·live
);

178 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
tık“·live
, 
Ën
);

179 ià(
¡©us
 < 0) {

180 
	`log_”rÜ
("£tsockİˆSO_KEEPALIVE c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

181  
VR_ERROR
;

184 #ifdeà
SOL_TCP


185 ià(
k“pidË
 > 0) {

186 
Ën
 = (
k“pidË
);

187 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_TCP
, 
TCP_KEEPIDLE
, &
k“pidË
, 
Ën
);

188 ià(
¡©us
 < 0) {

189 
	`log_”rÜ
("£tsockİˆTCP_KEEPIDLE c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

190  
VR_ERROR
;

194 ià(
k“pš‹rv®
 > 0) {

195 
Ën
 = (
k“pš‹rv®
);

196 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_TCP
, 
TCP_KEEPINTVL
, &
k“pš‹rv®
, 
Ën
);

197 ià(
¡©us
 < 0) {

198 
	`log_”rÜ
("£tsockİˆTCP_KEEPINTVL c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

199  
VR_ERROR
;

203 ià(
k“pcouÁ
 > 0) {

204 
Ën
 = (
k“pcouÁ
);

205 
¡©us
 = 
	`£tsockİt
(
sd
, 
SOL_TCP
, 
TCP_KEEPCNT
, &
k“pcouÁ
, 
Ën
);

206 ià(
¡©us
 < 0) {

207 
	`log_”rÜ
("£tsockİˆTCP_KEEPCNT c®È”rÜ(%s)", 
	`¡»¼Ü
(
”ºo
));

208  
VR_ERROR
;

213  
VR_OK
;

214 
	}
}

217 
	$_vr_©oi
(*
lše
, 
size_t
 
n
)

219 
v®ue
;

221 ià(
n
 == 0) {

225 
v®ue
 = 0; 
n
--; 
lše
++) {

226 ià(*
lše
 < '0' || *line > '9') {

230 
v®ue
 = v®u* 10 + (*
lše
 - '0');

233 ià(
v®ue
 < 0) {

237  
v®ue
;

238 
	}
}

242 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

243 ià(
v
 < 10)  1;

244 ià(
v
 < 100)  2;

245 ià(
v
 < 1000)  3;

246 ià(
v
 < 1000000000000UL) {

247 ià(
v
 < 100000000UL) {

248 ià(
v
 < 1000000) {

249 ià(
v
 < 10000)  4;

250  5 + (
v
 >= 100000);

252  7 + (
v
 >= 10000000UL);

254 ià(
v
 < 10000000000UL) {

255  9 + (
v
 >= 1000000000UL);

257  11 + (
v
 >= 100000000000UL);

259  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

260 
	}
}

263 
ušt32_t
 
	$sdig™s10
(
št64_t
 
v
) {

264 ià(
v
 < 0) {

266 
ušt64_t
 
uv
 = (
v
 !ğ
LLONG_MIN
) ?

267 (
ušt64_t
)-
v
 : ((ušt64_tè
LLONG_MAX
)+1;

268  
	`dig™s10
(
uv
)+1;

270  
	`dig™s10
(
v
);

272 
	}
}

286 
	$Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

287 cÚ¡ 
dig™s
[201] =

293 
Ãg©ive
;

294 
v®ue
;

298 ià(
sv®ue
 < 0) {

299 ià(
sv®ue
 !ğ
LLONG_MIN
) {

300 
v®ue
 = -
sv®ue
;

302 
v®ue
 = ((è
LLONG_MAX
)+1;

304 
Ãg©ive
 = 1;

306 
v®ue
 = 
sv®ue
;

307 
Ãg©ive
 = 0;

311 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

312 ià(
Ëngth
 >ğ
d¡Ën
)  0;

315 
ušt32_t
 
Ãxt
 = 
Ëngth
;

316 
d¡
[
Ãxt
] = '\0';

317 
Ãxt
--;

318 
v®ue
 >= 100) {

319 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

320 
v®ue
 /= 100;

321 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

322 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

323 
Ãxt
 -= 2;

327 ià(
v®ue
 < 10) {

328 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

330 
i
 = (
ušt32_t
è
v®ue
 * 2;

331 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

332 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

336 ià(
Ãg©ive
è
d¡
[0] = '-';

337  
Ëngth
;

338 
	}
}

344 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

345 cÚ¡ *
p
 = 
s
;

346 
size_t
 
¶’
 = 0;

347 
Ãg©ive
 = 0;

348 
v
;

350 ià(
¶’
 =ğ
¦’
)

354 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

355 ià(
v®ue
 !ğ
NULL
) *value = 0;

359 ià(
p
[0] == '-') {

360 
Ãg©ive
 = 1;

361 
p
++; 
¶’
++;

364 ià(
¶’
 =ğ
¦’
)

369 ià(
p
[0] >= '1' &&…[0] <= '9') {

370 
v
 = 
p
[0]-'0';

371 
p
++; 
¶’
++;

372 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

373 *
v®ue
 = 0;

379 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

380 ià(
v
 > (
ULLONG_MAX
 / 10))

382 
v
 *= 10;

384 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

386 
v
 +ğ
p
[0]-'0';

388 
p
++; 
¶’
++;

392 ià(
¶’
 < 
¦’
)

395 ià(
Ãg©ive
) {

396 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

398 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

400 ià(
v
 > 
LLONG_MAX
)

402 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

405 
	}
}

410 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

411 
Îv®
;

413 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

416 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

419 *
lv®
 = ()
Îv®
;

421 
	}
}

425 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

426 ià(
	`i¢ª
(
v®ue
)) {

427 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

428 } ià(
	`isšf
(
v®ue
)) {

429 ià(
v®ue
 < 0)

430 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

432 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

433 } ià(
v®ue
 == 0) {

435 ià(1.0/
v®ue
 < 0)

436 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

438 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

440 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

450 
mš
 = -4503599627370495;

451 
max
 = 4503599627370496;

452 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

453 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

456 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

459  
Ën
;

460 
	}
}

462 
boŞ


463 
	$vr_v®id_pÜt
(
n
)

465 ià(
n
 < 1 ||‚ > 
UINT16_MAX
) {

466  
çl£
;

469  
Œue
;

470 
	}
}

476 
ssize_t


477 
	$_vr_£ndn
(
sd
, cÚ¡ *
v±r
, 
size_t
 
n
)

479 
size_t
 
Æeá
;

480 
ssize_t
 
n£nd
;

481 cÚ¡ *
±r
;

483 
±r
 = 
v±r
;

484 
Æeá
 = 
n
;

485 
Æeá
 > 0) {

486 
n£nd
 = 
	`£nd
(
sd
, 
±r
, 
Æeá
, 0);

487 ià(
n£nd
 < 0) {

488 ià(
”ºo
 =ğ
EINTR
) {

491  
n£nd
;

493 ià(
n£nd
 == 0) {

497 
Æeá
 -ğ(
size_t
)
n£nd
;

498 
±r
 +ğ
n£nd
;

501  (
ssize_t
)
n
;

502 
	}
}

508 
ssize_t


509 
	$_vr_»cvn
(
sd
, *
v±r
, 
size_t
 
n
)

511 
size_t
 
Æeá
;

512 
ssize_t
 
Äecv
;

513 *
±r
;

515 
±r
 = 
v±r
;

516 
Æeá
 = 
n
;

517 
Æeá
 > 0) {

518 
Äecv
 = 
	`»cv
(
sd
, 
±r
, 
Æeá
, 0);

519 ià(
Äecv
 < 0) {

520 ià(
”ºo
 =ğ
EINTR
) {

523  
Äecv
;

525 ià(
Äecv
 == 0) {

529 
Æeá
 -ğ(
size_t
)
Äecv
;

530 
±r
 +ğ
Äecv
;

533  (
ssize_t
)(
n
 - 
Æeá
);

534 
	}
}

540 
št64_t


541 
	$vr_u£c_now
()

543 
timev®
 
now
;

544 
št64_t
 
u£c
;

545 
¡©us
;

547 
¡©us
 = 
	`g‘timeofday
(&
now
, 
NULL
);

548 ià(
¡©us
 < 0) {

549 
	`log_”rÜ
("g‘timeofday faed: %s", 
	`¡»¼Ü
(
”ºo
));

553 
u£c
 = (
št64_t
)
now
.
tv_£c
 * 1000000LL + (št64_têow.
tv_u£c
;

555  
u£c
;

556 
	}
}

561 
št64_t


562 
	$vr_m£c_now
()

564  
	`vr_u£c_now
() / 1000LL;

565 
	}
}

568 
	$vr_»sŞve_š‘
(
sds
 
Çme
, 
pÜt
, 
sockšfo
 *
si
)

570 
¡©us
;

571 
addršfo
 *
ai
, *
ÿi
;

572 
addršfo
 
hšts
;

573 *
node
, 
£rviû
[
VR_UINTMAX_MAXLEN
];

574 
boŞ
 
found
;

576 
	`ASSERT
(
	`vr_v®id_pÜt
(
pÜt
));

578 
	`mem£t
(&
hšts
, 0, (hints));

579 
hšts
.
ai_æags
 = 
AI_NUMERICSERV
;

580 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

581 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

582 
hšts
.
ai_´ÙocŞ
 = 0;

583 
hšts
.
ai_add¾’
 = 0;

584 
hšts
.
ai_addr
 = 
NULL
;

585 
hšts
.
ai_ÿnÚÇme
 = 
NULL
;

587 ià(
Çme
 !ğ
NULL
) {

588 
node
 = (*)
Çme
;

596 
node
 = 
NULL
;

597 
hšts
.
ai_æags
 |ğ
AI_PASSIVE
;

600 
	`d¢´štf
(
£rviû
, 
VR_UINTMAX_MAXLEN
, "%d", 
pÜt
);

606 
¡©us
 = 
	`g‘addršfo
(
node
, 
£rviû
, &
hšts
, &
ai
);

607 ià(
¡©us
 != 0) {

608 
	`log_”rÜ
("address„esolution of‚ode '%s' service '%s' failed: %s",

609 
node
, 
£rviû
, 
	`gai_¡»¼Ü
(
¡©us
));

624 
ÿi
 = 
ai
, 
found
 = 
çl£
; ca˜!ğ
NULL
; ca˜ğÿi->
ai_Ãxt
) {

625 
si
->
çmy
 = 
ÿi
->
ai_çmy
;

626 
si
->
add¾’
 = 
ÿi
->
ai_add¾’
;

627 
	`vr_memıy
(&
si
->
addr
, 
ÿi
->
ai_addr
, si->
add¾’
);

628 
found
 = 
Œue
;

632 
	`ä“addršfo
(
ai
);

634  !
found
 ? -1 : 0;

635 
	}
}

638 
	$vr_»sŞve_unix
(
sds
 
Çme
, 
sockšfo
 *
si
)

640 
sockaddr_un
 *
un
;

642 ià(
	`sd¦’
(
Çme
è>ğ
VR_UNIX_ADDRSTRLEN
) {

646 
un
 = &
si
->
addr
.un;

648 
un
->
sun_çmy
 = 
AF_UNIX
;

649 
	`vr_memıy
(
un
->
sun_·th
, 
Çme
, 
	`sd¦’
(name));

650 
un
->
sun_·th
[
	`sd¦’
(
Çme
)] = '\0';

652 
si
->
çmy
 = 
AF_UNIX
;

653 
si
->
add¾’
 = (*
un
);

657 
	}
}

666 
	$vr_»sŞve
(
sds
 
Çme
, 
pÜt
, 
sockšfo
 *
si
)

668 ià(
Çme
 !ğ
NULL
 &&‚ame[0] == '/') {

669  
	`vr_»sŞve_unix
(
Çme
, 
si
);

672  
	`vr_»sŞve_š‘
(
Çme
, 
pÜt
, 
si
);

673 
	}
}

675 
	$vr_Ãt_³”_to_¡ršg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

676 
sockaddr_¡Üage
 
§
;

677 
sockËn_t
 
§Ën
 = (
§
);

679 ià(
	`g‘³”Çme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
è=ğ-1è
”rÜ
;

680 ià(
_Ën
 =ğ0è
”rÜ
;

682 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

683 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

684 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

685 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

686 } ià(
§
.
ss_çmy
 =ğ
AF_INET6
) {

687 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

688 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

689 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

690 } ià(
§
.
ss_çmy
 =ğ
AF_UNIX
) {

691 ià(

è
	`¡ºıy
(,"/unixsock‘",
_Ën
);

692 ià(
pÜt
) *port = 0;

694 
”rÜ
;

698 
”rÜ
:

699 ià(

) {

700 ià(
_Ën
 >= 2) {

701 

[0] = '?';

702 

[1] = '\0';

703 } ià(
_Ën
 == 1) {

704 

[0] = '\0';

707 ià(
pÜt
) *port = 0;

709 
	}
}

715 
	$vr_Ãt_fÜm©_addr
(*
buf
, 
size_t
 
buf_Ën
, *

, 
pÜt
) {

716  
	`¢´štf
(
buf
,
buf_Ën
, 
	`¡rchr
(

,':') ?

717 "[%s]:%d" : "%s:%d", 

, 
pÜt
);

718 
	}
}

722 
	$vr_Ãt_fÜm©_³”
(
fd
, *
buf
, 
size_t
 
buf_Ën
) {

723 

[
VR_INET6_ADDRSTRLEN
];

724 
pÜt
;

726 
	`vr_Ãt_³”_to_¡ršg
(
fd
,

,(),&
pÜt
);

727  
	`vr_Ãt_fÜm©_addr
(
buf
, 
buf_Ën
, 

, 
pÜt
);

728 
	}
}

735 
	$g‘_¿ndom_hex_ch¬s
(*
p
, 
Ën
) {

736 *
ch¬£t
 = "0123456789abcdef";

737 
j
;

740 
£ed_š™Ÿlized
 = 0;

741 
£ed
[20];

742 
ušt64_t
 
couÁ”
 = 0;

744 ià(!
£ed_š™Ÿlized
) {

749 
FILE
 *
å
 = 
	`fİ’
("/dev/urandom","r");

750 ià(
å
 && 
	`ä—d
(
£ed
,(seed),1,fp) == 1)

751 
£ed_š™Ÿlized
 = 1;

752 ià(
å
è
	`fşo£
(fp);

755 ià(
£ed_š™Ÿlized
) {

756 
Ën
) {

757 
dige¡
[20];

758 
SHA1_CTX
 
ùx
;

759 
cİyËn
 = 
Ën
 > 20 ? 20 :†en;

761 
	`SHA1In™
(&
ùx
);

762 
	`SHA1Upd©e
(&
ùx
, 
£ed
, (seed));

763 
	`SHA1Upd©e
(&
ùx
, (*)&
couÁ”
,(counter));

764 
	`SHA1Fš®
(
dige¡
, &
ùx
);

765 
couÁ”
++;

767 
	`memıy
(
p
,
dige¡
,
cİyËn
);

769 
j
 = 0; j < 
cİyËn
; j++è
p
[j] = 
ch¬£t
[p[j] & 0x0F];

770 
Ën
 -ğ
cİyËn
;

771 
p
 +ğ
cİyËn
;

777 *
x
 = 
p
;

778 
l
 = 
Ën
;

779 
timev®
 
tv
;

780 
pid_t
 
pid
 = 
	`g‘pid
();

783 
	`g‘timeofday
(&
tv
,
NULL
);

784 ià(
l
 >ğ(
tv
.
tv_u£c
)) {

785 
	`memıy
(
x
,&
tv
.
tv_u£c
,(tv.tv_usec));

786 
l
 -ğ(
tv
.
tv_u£c
);

787 
x
 +ğ(
tv
.
tv_u£c
);

789 ià(
l
 >ğ(
tv
.
tv_£c
)) {

790 
	`memıy
(
x
,&
tv
.
tv_£c
,(tv.tv_sec));

791 
l
 -ğ(
tv
.
tv_£c
);

792 
x
 +ğ(
tv
.
tv_£c
);

794 ià(
l
 >ğ(
pid
)) {

795 
	`memıy
(
x
,&
pid
,(pid));

796 
l
 -ğ(
pid
);

797 
x
 +ğ(
pid
);

801 
j
 = 0; j < 
Ën
; j++) {

802 
p
[
j
] ^ğ
	`¿nd
();

803 
p
[
j
] = 
ch¬£t
[p[j] & 0x0F];

806 
	}
}

810 
	$¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

811 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

813 
·‰”nL’
) {

814 
·‰”n
[0]) {

816 
·‰”n
[1] == '*') {

817 
·‰”n
++;

818 
·‰”nL’
--;

820 ià(
·‰”nL’
 == 1)

822 
¡ršgL’
) {

823 ià(
	`¡ršgm©chËn
(
·‰”n
+1, 
·‰”nL’
-1,

824 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

826 
¡ršg
++;

827 
¡ršgL’
--;

832 ià(
¡ršgL’
 == 0)

834 
¡ršg
++;

835 
¡ršgL’
--;

839 
nÙ
, 
m©ch
;

841 
·‰”n
++;

842 
·‰”nL’
--;

843 
nÙ
 = 
·‰”n
[0] == '^';

844 ià(
nÙ
) {

845 
·‰”n
++;

846 
·‰”nL’
--;

848 
m©ch
 = 0;

850 ià(
·‰”n
[0] == '\\') {

851 
·‰”n
++;

852 
·‰”nL’
--;

853 ià(
·‰”n
[0] =ğ
¡ršg
[0])

854 
m©ch
 = 1;

855 } ià(
·‰”n
[0] == ']') {

857 } ià(
·‰”nL’
 == 0) {

858 
·‰”n
--;

859 
·‰”nL’
++;

861 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

862 
¡¬t
 = 
·‰”n
[0];

863 
’d
 = 
·‰”n
[2];

864 
c
 = 
¡ršg
[0];

865 ià(
¡¬t
 > 
’d
) {

866 
t
 = 
¡¬t
;

867 
¡¬t
 = 
’d
;

868 
’d
 = 
t
;

870 ià(
noÿ£
) {

871 
¡¬t
 = 
	`tŞow”
(start);

872 
’d
 = 
	`tŞow”
(end);

873 
c
 = 
	`tŞow”
(c);

875 
·‰”n
 += 2;

876 
·‰”nL’
 -= 2;

877 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

878 
m©ch
 = 1;

880 ià(!
noÿ£
) {

881 ià(
·‰”n
[0] =ğ
¡ršg
[0])

882 
m©ch
 = 1;

884 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

885 
m©ch
 = 1;

888 
·‰”n
++;

889 
·‰”nL’
--;

891 ià(
nÙ
)

892 
m©ch
 = !match;

893 ià(!
m©ch
)

895 
¡ršg
++;

896 
¡ršgL’
--;

900 ià(
·‰”nL’
 >= 2) {

901 
·‰”n
++;

902 
·‰”nL’
--;

906 ià(!
noÿ£
) {

907 ià(
·‰”n
[0] !ğ
¡ršg
[0])

910 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

913 
¡ršg
++;

914 
¡ršgL’
--;

917 
·‰”n
++;

918 
·‰”nL’
--;

919 ià(
¡ršgL’
 == 0) {

920 *
·‰”n
 == '*') {

921 
·‰”n
++;

922 
·‰”nL’
--;

927 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

930 
	}
}

932 
	$¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

933  
	`¡ršgm©chËn
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

934 
	}
}

938 
	$mem»v16
(*
p
) {

939 *
x
 = 
p
, 
t
;

941 
t
 = 
x
[0];

942 
x
[0] = x[1];

943 
x
[1] = 
t
;

944 
	}
}

948 
	$mem»v32
(*
p
) {

949 *
x
 = 
p
, 
t
;

951 
t
 = 
x
[0];

952 
x
[0] = x[3];

953 
x
[3] = 
t
;

954 
t
 = 
x
[1];

955 
x
[1] = x[2];

956 
x
[2] = 
t
;

957 
	}
}

961 
	$mem»v64
(*
p
) {

962 *
x
 = 
p
, 
t
;

964 
t
 = 
x
[0];

965 
x
[0] = x[7];

966 
x
[7] = 
t
;

967 
t
 = 
x
[1];

968 
x
[1] = x[6];

969 
x
[6] = 
t
;

970 
t
 = 
x
[2];

971 
x
[2] = x[5];

972 
x
[5] = 
t
;

973 
t
 = 
x
[3];

974 
x
[3] = x[4];

975 
x
[4] = 
t
;

976 
	}
}

978 
ušt16_t
 
	$šŒev16
(
ušt16_t
 
v
) {

979 
	`mem»v16
(&
v
);

980  
v
;

981 
	}
}

983 
ušt32_t
 
	$šŒev32
(
ušt32_t
 
v
) {

984 
	`mem»v32
(&
v
);

985  
v
;

986 
	}
}

988 
ušt64_t
 
	$šŒev64
(
ušt64_t
 
v
) {

989 
	`mem»v64
(&
v
);

990  
v
;

991 
	}
}

1000 
	$memtŞl
(cÚ¡ *
p
, *
”r
) {

1001 cÚ¡ *
u
;

1002 
buf
[128];

1003 
mul
;

1004 
v®
;

1005 
dig™s
;

1007 ià(
”r
) *err = 0;

1010 
u
 = 
p
;

1011 ià(*
u
 == '-') u++;

1012 *
u
 && 
	`isdig™
(*u)) u++;

1013 ià(*
u
 =ğ'\0' || !
	`¡rÿ£cmp
(u,"b")) {

1014 
mul
 = 1;

1015 } ià(!
	`¡rÿ£cmp
(
u
,"k")) {

1016 
mul
 = 1000;

1017 } ià(!
	`¡rÿ£cmp
(
u
,"kb")) {

1018 
mul
 = 1024;

1019 } ià(!
	`¡rÿ£cmp
(
u
,"m")) {

1020 
mul
 = 1000*1000;

1021 } ià(!
	`¡rÿ£cmp
(
u
,"mb")) {

1022 
mul
 = 1024*1024;

1023 } ià(!
	`¡rÿ£cmp
(
u
,"g")) {

1024 
mul
 = 1000L*1000*1000;

1025 } ià(!
	`¡rÿ£cmp
(
u
,"gb")) {

1026 
mul
 = 1024L*1024*1024;

1028 ià(
”r
) *err = 1;

1034 
dig™s
 = 
u
-
p
;

1035 ià(
dig™s
 >ğ(
buf
)) {

1036 ià(
”r
) *err = 1;

1039 
	`memıy
(
buf
,
p
,
dig™s
);

1040 
buf
[
dig™s
] = '\0';

1042 *
’d±r
;

1043 
”ºo
 = 0;

1044 
v®
 = 
	`¡¹Şl
(
buf
,&
’d±r
,10);

1045 ià((
v®
 =ğ0 && 
”ºo
 =ğ
EINVAL
è|| *
’d±r
 != '\0') {

1046 ià(
”r
) *err = 1;

1049  
v®
*
mul
;

1050 
	}
}

1054 
	$by‹sToHumª
(*
s
, 
n
) {

1055 
d
;

1057 ià(
n
 < 1024) {

1059 
	`¥rštf
(
s
,"%ÎuB",
n
);

1061 } ià(
n
 < (1024*1024)) {

1062 
d
 = ()
n
/(1024);

1063 
	`¥rštf
(
s
,"%.2fK",
d
);

1064 } ià(
n
 < (1024LL*1024*1024)) {

1065 
d
 = ()
n
/(1024*1024);

1066 
	`¥rštf
(
s
,"%.2fM",
d
);

1067 } ià(
n
 < (1024LL*1024*1024*1024)) {

1068 
d
 = ()
n
/(1024LL*1024*1024);

1069 
	`¥rštf
(
s
,"%.2fG",
d
);

1070 } ià(
n
 < (1024LL*1024*1024*1024*1024)) {

1071 
d
 = ()
n
/(1024LL*1024*1024*1024);

1072 
	`¥rštf
(
s
,"%.2fT",
d
);

1073 } ià(
n
 < (1024LL*1024*1024*1024*1024*1024)) {

1074 
d
 = ()
n
/(1024LL*1024*1024*1024*1024);

1075 
	`¥rštf
(
s
,"%.2fP",
d
);

1078 
	`¥rštf
(
s
,"%ÎuB",
n
);

1080 
	}
}

1090 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

1091 
cwd
[1024];

1092 
sds
 
ab¥©h
;

1093 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

1095 
»Í©h
 = 
	`sd¡rim
(relpath," \r\n\t");

1096 ià(
»Í©h
[0] == '/') „elpath;

1099 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

1100 
	`sdsä“
(
»Í©h
);

1101  
NULL
;

1103 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

1104 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

1105 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

1113 
	`sd¦’
(
»Í©h
) >= 3 &&

1114 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

1116 
	`sd¤ªge
(
»Í©h
,3,-1);

1117 ià(
	`sd¦’
(
ab¥©h
) > 1) {

1118 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

1119 
ŒimËn
 = 1;

1121 *
p
 != '/') {

1122 
p
--;

1123 
ŒimËn
++;

1125 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

1130 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

1131 
	`sdsä“
(
»Í©h
);

1132  
ab¥©h
;

1133 
	}
}

	@src/vr_util.h

1 #iâdeà
_VR_UTIL_H_


2 
	#_VR_UTIL_H_


	)

4 
	~<¡d¬g.h
>

5 
	~<¡dšt.h
>

6 
	~<¡dboŞ.h
>

8 
	~<Ãtš‘/š.h
>

9 
	~<sys/un.h
>

12 
	#__x¡r
(
s
è
	`__¡r
(s)

	)

13 
	#__¡r
(
s
è#s

	)

15 
	#VR_INET4_ADDRSTRLEN
 (("255.255.255.255"è- 1)

	)

16 
	#VR_INET6_ADDRSTRLEN
 \

17 (("ffff:ffff:ffff:ffff:ffff:ffff:255.255.255.255"è- 1)

	)

18 
	#VR_INET_ADDRSTRLEN
 
	`MAX
(
VR_INET4_ADDRSTRLEN
, 
VR_INET6_ADDRSTRLEN
)

	)

19 
	#VR_UNIX_ADDRSTRLEN
 \

20 ((
sockaddr_un
è- 
	`off£tof
(sockaddr_un, 
sun_·th
))

	)

22 
	#VR_INET_PEER_ID_LEN
 (
VR_INET_ADDRSTRLEN
+32è

	)

24 
	#VR_MAXHOSTNAMELEN
 256

	)

36 
	#VR_UINT8_MAXLEN
 (3 + 1)

	)

37 
	#VR_UINT16_MAXLEN
 (5 + 1)

	)

38 
	#VR_UINT32_MAXLEN
 (10 + 1)

	)

39 
	#VR_UINT64_MAXLEN
 (20 + 1)

	)

40 
	#VR_UINTMAX_MAXLEN
 
VR_UINT64_MAXLEN


	)

42 
	#LONG_STR_SIZE
 21

	)

48 
	#VR_ALIGNMENT
 (è

	)

49 
	#VR_ALIGN
(
d
, 
n
è(((dè+ (À- 1)è& ~Ò - 1))

	)

50 
	#VR_ALIGN_PTR
(
p
, 
n
) \

51 (*è(((
ušŒ_t
è(
p
è+ ((ušŒ_tè
n
 - 1)è& ~((ušŒ_tèÀ- 1))

	)

57 
	#vr_g‘ho¡Çme
(
_Çme
, 
_Ën
) \

58 
	`g‘ho¡Çme
((*)
_Çme
, (
size_t
)
_Ën
)

	)

60 
	#vr_©oi
(
_lše
, 
_n
) \

61 
	`_vr_©oi
((*)
_lše
, (
size_t
)
_n
)

	)

63 
vr_£t_blockšg
(
sd
);

64 
vr_£t_nÚblockšg
(
sd
);

65 
vr_£t_»u£addr
(
sd
);

66 
vr_£t_tınod–ay
(
sd
);

67 
vr_£t_lšg”
(
sd
, 
timeout
);

68 
vr_£t_¢dbuf
(
sd
, 
size
);

69 
vr_£t_rcvbuf
(
sd
, 
size
);

70 
vr_g‘_sÛ¼Ü
(
sd
);

71 
vr_g‘_¢dbuf
(
sd
);

72 
vr_g‘_rcvbuf
(
sd
);

73 
vr_£t_tık“·live
(
sd
, 
k“pidË
, 
k“pš‹rv®
, 
k“pcouÁ
);

75 
_vr_©oi
(*
lše
, 
size_t
 
n
);

76 
ušt32_t
 
dig™s10
(
ušt64_t
 
v
);

77 
ušt32_t
 
sdig™s10
(
št64_t
 
v
);

78 
Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
);

79 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

80 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
);

81 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

83 
boŞ
 
vr_v®id_pÜt
(
n
);

89 
	#vr_£ndn
(
_s
, 
_b
, 
_n
) \

90 
	`_vr_£ndn
(
_s
, 
_b
, (
size_t
)(
_n
))

	)

92 
	#vr_»cvn
(
_s
, 
_b
, 
_n
) \

93 
	`_vr_»cvn
(
_s
, 
_b
, (
size_t
)(
_n
))

	)

99 
	#vr_»ad
(
_d
, 
_b
, 
_n
) \

100 
	`»ad
(
_d
, 
_b
, (
size_t
)(
_n
))

	)

102 
	#vr_»adv
(
_d
, 
_b
, 
_n
) \

103 
	`»adv
(
_d
, 
_b
, ()(
_n
))

	)

105 
	#vr_wr™e
(
_d
, 
_b
, 
_n
) \

106 
	`wr™e
(
_d
, 
_b
, (
size_t
)(
_n
))

	)

108 
	#vr_wr™ev
(
_d
, 
_b
, 
_n
) \

109 
	`wr™ev
(
_d
, 
_b
, ()(
_n
))

	)

111 
ssize_t
 
_vr_£ndn
(
sd
, cÚ¡ *
v±r
, 
size_t
 
n
);

112 
ssize_t
 
_vr_»cvn
(
sd
, *
v±r
, 
size_t
 
n
);

114 
št64_t
 
vr_u£c_now
();

115 
št64_t
 
vr_m£c_now
();

122 
	ssockšfo
 {

123 
	mçmy
;

124 
sockËn_t
 
	madd¾’
;

126 
sockaddr_š
 
	mš
;

127 
sockaddr_š6
 
	mš6
;

128 
sockaddr_un
 
	mun
;

129 } 
	maddr
;

132 
vr_»sŞve
(
sds
 
Çme
, 
pÜt
, 
sockšfo
 *
si
);

133 
vr_Ãt_fÜm©_³”
(
fd
, *
buf
, 
size_t
 
buf_Ën
);

135 
g‘_¿ndom_hex_ch¬s
(*
p
, 
Ën
);

137 
¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
, cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
);

138 
¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
);

144 
	#vr_memıy
(
_d
, 
_c
, 
_n
) \

145 
	`memıy
(
_d
, 
_c
, (
size_t
)(
_n
))

	)

147 
	#vr_memmove
(
_d
, 
_c
, 
_n
) \

148 
	`memmove
(
_d
, 
_c
, (
size_t
)(
_n
))

	)

150 
	#vr_memchr
(
_d
, 
_c
, 
_n
) \

151 
	`memchr
(
_d
, 
_c
, (
size_t
)(
_n
))

	)

153 
	#vr_¡¾’
(
_s
) \

154 
	`¡¾’
((*)(
_s
))

	)

156 
	#vr_¡ºcmp
(
_s1
, 
_s2
, 
_n
) \

157 
	`¡ºcmp
((*)(
_s1
), (*)(
_s2
), (
size_t
)(
_n
))

	)

159 
	#vr_¡rchr
(
_p
, 
_l
, 
_c
) \

160 
	`_vr_¡rchr
((
ušt8_t
 *)(
_p
), (ušt8_ˆ*)(
_l
), (ušt8_t)(
_c
))

	)

162 
	#vr_¡¼chr
(
_p
, 
_s
, 
_c
) \

163 
	`_vr_¡¼chr
((
ušt8_t
 *)(
_p
),(ušt8_ˆ*)(
_s
), (ušt8_t)(
_c
))

	)

165 
	#vr_¡ºdup
(
_s
, 
_n
) \

166 (
ušt8_t
 *)
	`¡ºdup
((*)(
_s
), (
size_t
)(
_n
));

	)

168 
šlše
 
ušt8_t
 *

169 
	$_vr_¡rchr
(
ušt8_t
 *
p
, ušt8_ˆ*
Ï¡
, ušt8_ˆ
c
)

171 
p
 < 
Ï¡
) {

172 ià(*
p
 =ğ
c
) {

173  
p
;

175 
p
++;

178  
NULL
;

179 
	}
}

181 
šlše
 
ušt8_t
 *

182 
	$_vr_¡¼chr
(
ušt8_t
 *
p
, ušt8_ˆ*
¡¬t
, ušt8_ˆ
c
)

184 
p
 >ğ
¡¬t
) {

185 ià(*
p
 =ğ
c
) {

186  
p
;

188 
p
--;

191  
NULL
;

192 
	}
}

194 
mem»v16
(*
p
);

195 
mem»v32
(*
p
);

196 
mem»v64
(*
p
);

197 
ušt16_t
 
šŒev16
(ušt16_ˆ
v
);

198 
ušt32_t
 
šŒev32
(ušt32_ˆ
v
);

199 
ušt64_t
 
šŒev64
(ušt64_ˆ
v
);

203 #ifdeà
VR_LITTLE_ENDIAN


204 
	#mem»v16ifbe
(
p
)

	)

205 
	#mem»v32ifbe
(
p
)

	)

206 
	#mem»v64ifbe
(
p
)

	)

207 
	#šŒev16ifbe
(
v
è(v)

	)

208 
	#šŒev32ifbe
(
v
è(v)

	)

209 
	#šŒev64ifbe
(
v
è(v)

	)

211 
	#mem»v16ifbe
(
p
è
	`mem»v16
Õ)

	)

212 
	#mem»v32ifbe
(
p
è
	`mem»v32
Õ)

	)

213 
	#mem»v64ifbe
(
p
è
	`mem»v64
Õ)

	)

214 
	#šŒev16ifbe
(
v
è
	`šŒev16
(v)

	)

215 
	#šŒev32ifbe
(
v
è
	`šŒev32
(v)

	)

216 
	#šŒev64ifbe
(
v
è
	`šŒev64
(v)

	)

219 
memtŞl
(cÚ¡ *
p
, *
”r
);

220 
by‹sToHumª
(*
s
, 
n
);

222 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

	@src/vr_util.h

1 #iâdeà
_VR_UTIL_H_


2 
	#_VR_UTIL_H_


	)

4 
	~<¡d¬g.h
>

5 
	~<¡dšt.h
>

6 
	~<¡dboŞ.h
>

8 
	~<Ãtš‘/š.h
>

9 
	~<sys/un.h
>

12 
	#__x¡r
(
s
è
	`__¡r
(s)

	)

13 
	#__¡r
(
s
è#s

	)

15 
	#VR_INET4_ADDRSTRLEN
 (("255.255.255.255"è- 1)

	)

16 
	#VR_INET6_ADDRSTRLEN
 \

17 (("ffff:ffff:ffff:ffff:ffff:ffff:255.255.255.255"è- 1)

	)

18 
	#VR_INET_ADDRSTRLEN
 
	`MAX
(
VR_INET4_ADDRSTRLEN
, 
VR_INET6_ADDRSTRLEN
)

	)

19 
	#VR_UNIX_ADDRSTRLEN
 \

20 ((
sockaddr_un
è- 
	`off£tof
(sockaddr_un, 
sun_·th
))

	)

22 
	#VR_INET_PEER_ID_LEN
 (
VR_INET_ADDRSTRLEN
+32è

	)

24 
	#VR_MAXHOSTNAMELEN
 256

	)

36 
	#VR_UINT8_MAXLEN
 (3 + 1)

	)

37 
	#VR_UINT16_MAXLEN
 (5 + 1)

	)

38 
	#VR_UINT32_MAXLEN
 (10 + 1)

	)

39 
	#VR_UINT64_MAXLEN
 (20 + 1)

	)

40 
	#VR_UINTMAX_MAXLEN
 
VR_UINT64_MAXLEN


	)

42 
	#LONG_STR_SIZE
 21

	)

48 
	#VR_ALIGNMENT
 (è

	)

49 
	#VR_ALIGN
(
d
, 
n
è(((dè+ (À- 1)è& ~Ò - 1))

	)

50 
	#VR_ALIGN_PTR
(
p
, 
n
) \

51 (*è(((
ušŒ_t
è(
p
è+ ((ušŒ_tè
n
 - 1)è& ~((ušŒ_tèÀ- 1))

	)

57 
	#vr_g‘ho¡Çme
(
_Çme
, 
_Ën
) \

58 
	`g‘ho¡Çme
((*)
_Çme
, (
size_t
)
_Ën
)

	)

60 
	#vr_©oi
(
_lše
, 
_n
) \

61 
	`_vr_©oi
((*)
_lše
, (
size_t
)
_n
)

	)

63 
vr_£t_blockšg
(
sd
);

64 
vr_£t_nÚblockšg
(
sd
);

65 
vr_£t_»u£addr
(
sd
);

66 
vr_£t_tınod–ay
(
sd
);

67 
vr_£t_lšg”
(
sd
, 
timeout
);

68 
vr_£t_¢dbuf
(
sd
, 
size
);

69 
vr_£t_rcvbuf
(
sd
, 
size
);

70 
vr_g‘_sÛ¼Ü
(
sd
);

71 
vr_g‘_¢dbuf
(
sd
);

72 
vr_g‘_rcvbuf
(
sd
);

73 
vr_£t_tık“·live
(
sd
, 
k“pidË
, 
k“pš‹rv®
, 
k“pcouÁ
);

75 
_vr_©oi
(*
lše
, 
size_t
 
n
);

76 
ušt32_t
 
dig™s10
(
ušt64_t
 
v
);

77 
ušt32_t
 
sdig™s10
(
št64_t
 
v
);

78 
Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
);

79 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

80 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
);

81 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

83 
boŞ
 
vr_v®id_pÜt
(
n
);

89 
	#vr_£ndn
(
_s
, 
_b
, 
_n
) \

90 
	`_vr_£ndn
(
_s
, 
_b
, (
size_t
)(
_n
))

	)

92 
	#vr_»cvn
(
_s
, 
_b
, 
_n
) \

93 
	`_vr_»cvn
(
_s
, 
_b
, (
size_t
)(
_n
))

	)

99 
	#vr_»ad
(
_d
, 
_b
, 
_n
) \

100 
	`»ad
(
_d
, 
_b
, (
size_t
)(
_n
))

	)

102 
	#vr_»adv
(
_d
, 
_b
, 
_n
) \

103 
	`»adv
(
_d
, 
_b
, ()(
_n
))

	)

105 
	#vr_wr™e
(
_d
, 
_b
, 
_n
) \

106 
	`wr™e
(
_d
, 
_b
, (
size_t
)(
_n
))

	)

108 
	#vr_wr™ev
(
_d
, 
_b
, 
_n
) \

109 
	`wr™ev
(
_d
, 
_b
, ()(
_n
))

	)

111 
ssize_t
 
_vr_£ndn
(
sd
, cÚ¡ *
v±r
, 
size_t
 
n
);

112 
ssize_t
 
_vr_»cvn
(
sd
, *
v±r
, 
size_t
 
n
);

114 
št64_t
 
vr_u£c_now
();

115 
št64_t
 
vr_m£c_now
();

122 
	ssockšfo
 {

123 
	mçmy
;

124 
sockËn_t
 
	madd¾’
;

126 
sockaddr_š
 
	mš
;

127 
sockaddr_š6
 
	mš6
;

128 
sockaddr_un
 
	mun
;

129 } 
	maddr
;

132 
vr_»sŞve
(
sds
 
Çme
, 
pÜt
, 
sockšfo
 *
si
);

133 
vr_Ãt_fÜm©_³”
(
fd
, *
buf
, 
size_t
 
buf_Ën
);

135 
g‘_¿ndom_hex_ch¬s
(*
p
, 
Ën
);

137 
¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
, cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
);

138 
¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
);

144 
	#vr_memıy
(
_d
, 
_c
, 
_n
) \

145 
	`memıy
(
_d
, 
_c
, (
size_t
)(
_n
))

	)

147 
	#vr_memmove
(
_d
, 
_c
, 
_n
) \

148 
	`memmove
(
_d
, 
_c
, (
size_t
)(
_n
))

	)

150 
	#vr_memchr
(
_d
, 
_c
, 
_n
) \

151 
	`memchr
(
_d
, 
_c
, (
size_t
)(
_n
))

	)

153 
	#vr_¡¾’
(
_s
) \

154 
	`¡¾’
((*)(
_s
))

	)

156 
	#vr_¡ºcmp
(
_s1
, 
_s2
, 
_n
) \

157 
	`¡ºcmp
((*)(
_s1
), (*)(
_s2
), (
size_t
)(
_n
))

	)

159 
	#vr_¡rchr
(
_p
, 
_l
, 
_c
) \

160 
	`_vr_¡rchr
((
ušt8_t
 *)(
_p
), (ušt8_ˆ*)(
_l
), (ušt8_t)(
_c
))

	)

162 
	#vr_¡¼chr
(
_p
, 
_s
, 
_c
) \

163 
	`_vr_¡¼chr
((
ušt8_t
 *)(
_p
),(ušt8_ˆ*)(
_s
), (ušt8_t)(
_c
))

	)

165 
	#vr_¡ºdup
(
_s
, 
_n
) \

166 (
ušt8_t
 *)
	`¡ºdup
((*)(
_s
), (
size_t
)(
_n
));

	)

168 
šlše
 
ušt8_t
 *

169 
	$_vr_¡rchr
(
ušt8_t
 *
p
, ušt8_ˆ*
Ï¡
, ušt8_ˆ
c
)

171 
p
 < 
Ï¡
) {

172 ià(*
p
 =ğ
c
) {

173  
p
;

175 
p
++;

178  
NULL
;

179 
	}
}

181 
šlše
 
ušt8_t
 *

182 
	$_vr_¡¼chr
(
ušt8_t
 *
p
, ušt8_ˆ*
¡¬t
, ušt8_ˆ
c
)

184 
p
 >ğ
¡¬t
) {

185 ià(*
p
 =ğ
c
) {

186  
p
;

188 
p
--;

191  
NULL
;

192 
	}
}

194 
mem»v16
(*
p
);

195 
mem»v32
(*
p
);

196 
mem»v64
(*
p
);

197 
ušt16_t
 
šŒev16
(ušt16_ˆ
v
);

198 
ušt32_t
 
šŒev32
(ušt32_ˆ
v
);

199 
ušt64_t
 
šŒev64
(ušt64_ˆ
v
);

203 #ifdeà
VR_LITTLE_ENDIAN


204 
	#mem»v16ifbe
(
p
)

	)

205 
	#mem»v32ifbe
(
p
)

	)

206 
	#mem»v64ifbe
(
p
)

	)

207 
	#šŒev16ifbe
(
v
è(v)

	)

208 
	#šŒev32ifbe
(
v
è(v)

	)

209 
	#šŒev64ifbe
(
v
è(v)

	)

211 
	#mem»v16ifbe
(
p
è
	`mem»v16
Õ)

	)

212 
	#mem»v32ifbe
(
p
è
	`mem»v32
Õ)

	)

213 
	#mem»v64ifbe
(
p
è
	`mem»v64
Õ)

	)

214 
	#šŒev16ifbe
(
v
è
	`šŒev16
(v)

	)

215 
	#šŒev32ifbe
(
v
è
	`šŒev32
(v)

	)

216 
	#šŒev64ifbe
(
v
è
	`šŒev64
(v)

	)

219 
memtŞl
(cÚ¡ *
p
, *
”r
);

220 
by‹sToHumª
(*
s
, 
n
);

222 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

	@src/vr_worker.c

1 
	~<vr_cÜe.h
>

4 
	gÏ¡_wÜk”_th»ad
 = -1;

5 
	gnum_wÜk”_th»ads
;

7 
d¬¿y
 
	gwÜk”s
;

9 *
wÜk”_th»ad_run
(*
¬gs
);

11 
	#SU_PER_ALLOC
 64

	)

15 
cÚnsw­un™
 *
	gcsui_ä“li¡
;

16 
±h»ad_mu‹x_t
 
	gcsui_ä“li¡_lock
;

22 
cÚnsw­un™
 *

23 
	$csui_Ãw
() {

24 
cÚnsw­un™
 *
™em
 = 
NULL
;

26 
	`±h»ad_mu‹x_lock
(&
csui_ä“li¡_lock
);

27 ià(
csui_ä“li¡
) {

28 
™em
 = 
csui_ä“li¡
;

29 
csui_ä“li¡
 = 
™em
->
Ãxt
;

31 
	`±h»ad_mu‹x_uÆock
(&
csui_ä“li¡_lock
);

33 ià(
NULL
 =ğ
™em
) {

34 
i
;

37 
™em
 = 
	`d®loc
((
cÚnsw­un™
è* 
SU_PER_ALLOC
);

38 ià(
NULL
 =ğ
™em
) {

39  
NULL
;

47 
i
 = 2; i < 
SU_PER_ALLOC
; i++)

48 
™em
[
i
 - 1].
Ãxt
 = &item[i];

50 
	`±h»ad_mu‹x_lock
(&
csui_ä“li¡_lock
);

51 
™em
[
SU_PER_ALLOC
 - 1].
Ãxt
 = 
csui_ä“li¡
;

52 
csui_ä“li¡
 = &
™em
[1];

53 
	`±h»ad_mu‹x_uÆock
(&
csui_ä“li¡_lock
);

56  
™em
;

57 
	}
}

64 
	$csui_ä“
(
cÚnsw­un™
 *
™em
) {

65 
	`±h»ad_mu‹x_lock
(&
csui_ä“li¡_lock
);

66 
™em
->
Ãxt
 = 
csui_ä“li¡
;

67 
csui_ä“li¡
 = 
™em
;

68 
	`±h»ad_mu‹x_uÆock
(&
csui_ä“li¡_lock
);

69 
	}
}

73 
	$csul_push
(
vr_wÜk”
 *
wÜk”
, 
cÚnsw­un™
 *
su
)

75 
	`±h»ad_mu‹x_lock
(&
wÜk”
->
csuÎock
);

76 
	`dli¡Push
(
wÜk”
->
csul
, 
su
);

77 
	`±h»ad_mu‹x_uÆock
(&
wÜk”
->
csuÎock
);

78 
	}
}

81 
cÚnsw­un™
 *

82 
	$csul_pİ
(
vr_wÜk”
 *
wÜk”
)

84 
cÚnsw­un™
 *
su
 = 
NULL
;

86 
	`±h»ad_mu‹x_lock
(&
wÜk”
->
csuÎock
);

87 
su
 = 
	`dli¡Pİ
(
wÜk”
->
csul
);

88 
	`±h»ad_mu‹x_uÆock
(&
wÜk”
->
csuÎock
);

90  
su
;

91 
	}
}

95 
	$vr_wÜk”_š™
(
vr_wÜk”
 *
wÜk”
)

97 
r¡©us_t
 
¡©us
;

98 
maxş›Ás
, 
th»ads_num
;

99 
f–im™
;

101 ià(
wÜk”
 =ğ
NULL
) {

102  
VR_ERROR
;

105 
wÜk”
->
id
 = 0;

106 
wÜk”
->
sock‘·œs
[0] = -1;

107 
wÜk”
->
sock‘·œs
[1] = -1;

109 
wÜk”
->
csul
 = 
NULL
;

111 
	`±h»ad_mu‹x_š™
(&
wÜk”
->
csuÎock
, 
NULL
);

112 
wÜk”
->
cu¼’t_db
 = 0;

113 
wÜk”
->
tim–im™_ex™
 = 0;

114 
wÜk”
->
Ï¡_ç¡_cyşe
 = 0;

115 
wÜk”
->
»size_db
 = 0;

116 
wÜk”
->
»hash_db
 = 0;

118 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
maxş›Ás
);

120 
f–im™
 = 
	`adju¡O³nFesLim™
(
maxş›Ás
);

121 ià(
f–im™
 <= 0) {

122  
VR_ERROR
;

125 
	`vr_ev’oİ_š™
(&
wÜk”
->
v–
, 
f–im™
);

127 
wÜk”
->
v–
.
th»ad
.
fun_run
 = 
wÜk”_th»ad_run
;

129 
wÜk”
->
v–
.
th»ad
.
d©a
 = worker;

131 
wÜk”
->
v–
.
c¡abË
 = 
	`commªdStsTabËC»©e
();

133 
¡©us
 = 
	`sock‘·œ
(
AF_LOCAL
, 
SOCK_STREAM
, 0, 
wÜk”
->
sock‘·œs
);

134 ià(
¡©us
 < 0) {

135 
	`log_”rÜ
("ü—‹ sock‘·œ çed: %s", 
	`¡»¼Ü
(
”ºo
));

136  
VR_ERROR
;

139 
¡©us
 = 
	`vr_£t_nÚblockšg
(
wÜk”
->
sock‘·œs
[0]);

140 ià(
¡©us
 < 0) {

141 
	`log_”rÜ
("set socketpairs[0] %d‚onblocking failed: %s",

142 
wÜk”
->
sock‘·œs
[0], 
	`¡»¼Ü
(
”ºo
));

143 
	`şo£
(
wÜk”
->
sock‘·œs
[0]);

144 
wÜk”
->
sock‘·œs
[0] = -1;

145 
	`şo£
(
wÜk”
->
sock‘·œs
[1]);

146 
wÜk”
->
sock‘·œs
[1] = -1;

147  
VR_ERROR
;

149 
¡©us
 = 
	`vr_£t_nÚblockšg
(
wÜk”
->
sock‘·œs
[1]);

150 ià(
¡©us
 < 0) {

151 
	`log_”rÜ
("set socketpairs[1] %d‚onblocking failed: %s",

152 
wÜk”
->
sock‘·œs
[1], 
	`¡»¼Ü
(
”ºo
));

153 
	`şo£
(
wÜk”
->
sock‘·œs
[0]);

154 
wÜk”
->
sock‘·œs
[0] = -1;

155 
	`şo£
(
wÜk”
->
sock‘·œs
[1]);

156 
wÜk”
->
sock‘·œs
[1] = -1;

157  
VR_ERROR
;

160 
wÜk”
->
csul
 = 
	`dli¡C»©e
();

161 ià(
wÜk”
->
csul
 =ğ
NULL
) {

162 
	`log_”rÜ
("create†ist failed: out of memory");

163  
VR_ENOMEM
;

166  
VR_OK
;

167 
	}
}

171 
	$vr_wÜk”_deš™
(
vr_wÜk”
 *
wÜk”
)

173 ià(
wÜk”
 =ğ
NULL
) {

177 
	`vr_ev’oİ_deš™
(&
wÜk”
->
v–
);

179 ià(
wÜk”
->
sock‘·œs
[0] > 0){

180 
	`şo£
(
wÜk”
->
sock‘·œs
[0]);

181 
wÜk”
->
sock‘·œs
[0] = -1;

183 ià(
wÜk”
->
sock‘·œs
[1] > 0){

184 
	`şo£
(
wÜk”
->
sock‘·œs
[1]);

185 
wÜk”
->
sock‘·œs
[1] = -1;

188 ià(
wÜk”
->
csul
 !ğ
NULL
) {

189 
	`dli¡R–—£
(
wÜk”
->
csul
);

190 
wÜk”
->
csul
 = 
NULL
;

192 
	}
}

196 
	$wÜk”_g‘_Ãxt_idx
(
curidx
)

198 
idx
 = 
curidx
 + 1;

199  
idx
>=
num_wÜk”_th»ads
?0:idx;

200 
	}
}

204 
	$di¥©ch_cÚn_Ãw
(
vr_li¡’
 *
vli¡’
, 
sd
)

206 
cÚnsw­un™
 *
su
 = 
	`csui_Ãw
();

207 
buf
[1];

208 
vr_wÜk”
 *
wÜk”
;

210 ià(
su
 =ğ
NULL
) {

211 
	`şo£
(
sd
);

213 
	`log_”rÜ
("Failedo‡llocate memory for connection swap object\n");

218 
tid
 = (
Ï¡_wÜk”_th»ad
 + 1è% 
num_wÜk”_th»ads
;

219 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, (
ušt32_t
)
tid
);

222 
Ï¡_wÜk”_th»ad
 = 
tid
;

225 
su
->
num
 = 
sd
;

226 
su
->
d©a
 = 
vli¡’
;

229 
	`csul_push
(
wÜk”
, 
su
);

232 
buf
[0] = 'c';

233 ià(
	`vr_wr™e
(
wÜk”
->
sock‘·œs
[0], 
buf
, 1) != 1) {

234 
	`log_”rÜ
("Noticehe worker failed.");

237 
	`upd©e_cu¼_ş›Ás_add
(1);

238 
	}
}

242 
	$th»ad_ev’t_´oûss
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

244 
r¡©us_t
 
¡©us
;

246 
vr_wÜk”
 *
wÜk”
 = 
´ivd©a
;

247 
buf
[1];

248 
sd
;

250 
vr_li¡’
 *
vli¡’
;

251 
cÚn
 *conn;

252 
cÚnsw­un™
 *
csu
;

253 
ş›Á
 *
c
;

255 
	`ASSERT
(
–
 =ğ
wÜk”
->
v–
.el);

256 
	`ASSERT
(
fd
 =ğ
wÜk”
->
sock‘·œs
[1]);

258 ià(
	`vr_»ad
(
fd
, 
buf
, 1) != 1) {

259 
	`log_w¬n
("Can't„ead for worker(id:%d) socketpairs[1](%d)",

260 
wÜk”
->
v–
.
th»ad
.
id
, 
fd
);

261 
buf
[0] = 'c';

264 
buf
[0]) {

268 
csu
 = 
	`csul_pİ
(
wÜk”
);

269 ià(
csu
 =ğ
NULL
) {

273 
sd
 = 
csu
->
num
;

275 
vli¡’
 = 
csu
->
d©a
;

277 
	`csui_ä“
(
csu
);

278 
cÚn
 = 
	`cÚn_g‘
(
wÜk”
->
v–
.
cb
);

279 ià(
cÚn
 =ğ
NULL
) {

280 
	`log_”rÜ
("get conn for c %d failed: %s",

281 
sd
, 
	`¡»¼Ü
(
”ºo
));

282 
¡©us
 = 
	`şo£
(
sd
);

283 ià(
¡©us
 < 0) {

284 
	`log_”rÜ
("şo£ c %d faed, ignÜed: %s", 
sd
, 
	`¡»¼Ü
(
”ºo
));

288 
cÚn
->
sd
 = sd;

290 
¡©us
 = 
	`vr_£t_nÚblockšg
(
cÚn
->
sd
);

291 ià(
¡©us
 < 0) {

292 
	`log_”rÜ
("set‚onblock on c %d failed: %s",

293 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

294 
	`cÚn_put
(
cÚn
);

298 ià(
vli¡’
->
šfo
.
çmy
 =ğ
AF_INET
 || vli¡’->šfo.çmy =ğ
AF_INET6
) {

299 
¡©us
 = 
	`vr_£t_tınod–ay
(
cÚn
->
sd
);

300 ià(
¡©us
 < 0) {

301 
	`log_w¬n
("setcpnodelay on c %d failed, ignored: %s",

302 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

306 
c
 = 
	`ü—‹Cl›Á
(&
wÜk”
->
v–
, 
cÚn
);

307 ià(
c
 =ğ
NULL
) {

308 
	`log_”rÜ
("Create client failed");

309 
	`cÚn_put
(
cÚn
);

313 
c
->
curidx
 = 
wÜk”
->
id
;

315 
¡©us
 = 
	`«C»©eFeEv’t
(
wÜk”
->
v–
.
–
, 
cÚn
->
sd
, 
AE_READABLE
,

316 
»adQu”yFromCl›Á
, 
c
);

317 ià(
¡©us
 =ğ
AE_ERR
) {

318 
	`log_”rÜ
("Unrecoverableƒrror creating worker ipfd fileƒvent.");

322 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
numcÚÃùiÚs
, 1);

328 
csu
 = 
	`csul_pİ
(
wÜk”
);

329 ià(
csu
 =ğ
NULL
) {

333 
c
 = 
csu
->
d©a
;

335 
	`csui_ä“
(
csu
);

336 
c
->
v–
 = &
wÜk”
->vel;

337 
c
->
curidx
 = 
wÜk”
->
id
;

338 
c
->
¡•s
 ++;

339 
c
->
cmd
->
	`´oc
(c);

341 ià(
c
->
æags
&
CLIENT_JUMP
) {

342 
	`di¥©ch_cÚn_exi¡
(
c
,c->
ridx
);

344 
	`»£tCl›Á
(
c
);

345 
	`lškCl›ÁToEv’oİ
(
c
,c->
v–
);

349 
	`log_”rÜ
("readƒrror char '%c' for worker(id:%d) socketpairs[1](%d)",

350 
buf
[0], 
wÜk”
->
v–
.
th»ad
.
id
, wÜk”->
sock‘·œs
[1]);

353 
	}
}

356 
	$£tup_wÜk”
(
vr_wÜk”
 *
wÜk”
)

358 
r¡©us_t
 
¡©us
;

360 
¡©us
 = 
	`«C»©eFeEv’t
(
wÜk”
->
v–
.
–
, wÜk”->
sock‘·œs
[1], 
AE_READABLE
,

361 
th»ad_ev’t_´oûss
, 
wÜk”
);

362 ià(
¡©us
 =ğ
AE_ERR
) {

363 
	`log_”rÜ
("Unrecoverableƒrror creating worker ipfd fileƒvent.");

364  
VR_ERROR
;

367 
	`«S‘BefÜeSË•Proc
(
wÜk”
->
v–
.
–
, 
wÜk”_befÜe_¦“p
, worker);

372 if(
	`«C»©eTimeEv’t
(
wÜk”
->
v–
.
–
, 1, 
wÜk”_üÚ
, wÜk”, 
NULL
è=ğ
AE_ERR
) {

373 
	`£rv”Pªic
("Can't createhe serverCronimeƒvent.");

374  
VR_ERROR
;

377  
VR_OK
;

378 
	}
}

381 
	$wÜk”_th»ad_run
(*
¬gs
)

383 
vr_wÜk”
 *
wÜk”
 = 
¬gs
;

386 
	`«Maš
(
wÜk”
->
v–
.
–
);

388  
NULL
;

389 
	}
}

392 
	$wÜk”s_š™
(
ušt32_t
 
wÜk”_couÁ
)

394 
r¡©us_t
 
¡©us
;

395 
ušt32_t
 
idx
;

396 
vr_wÜk”
 *
wÜk”
;

398 
csui_ä“li¡
 = 
NULL
;

399 
	`±h»ad_mu‹x_š™
(&
csui_ä“li¡_lock
, 
NULL
);

401 
	`d¬¿y_š™
(&
wÜk”s
, 
wÜk”_couÁ
, (
vr_wÜk”
));

403 
idx
 = 0; idx < 
wÜk”_couÁ
; idx ++) {

404 
wÜk”
 = 
	`d¬¿y_push
(&
wÜk”s
);

405 
	`vr_wÜk”_š™
(
wÜk”
);

406 
wÜk”
->
id
 = 
idx
;

407 
¡©us
 = 
	`£tup_wÜk”
(
wÜk”
);

408 ià(
¡©us
 !ğ
VR_OK
) {

409 
	`ex™
(1);

413 
num_wÜk”_th»ads
 = ()
	`d¬¿y_n
(&
wÜk”s
);

415  
VR_OK
;

416 
	}
}

419 
	$wÜk”s_run
()

421 
ušt32_t
 
i
, 
th»ad_couÁ
;

422 
vr_wÜk”
 *
wÜk”
;

424 
th»ad_couÁ
 = (
ušt32_t
)
num_wÜk”_th»ads
;

426 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

427 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
i
);

428 
	`vr_th»ad_¡¬t
(&
wÜk”
->
v–
.
th»ad
);

431  
VR_OK
;

432 
	}
}

435 
	$wÜk”s_wa™
()

437 
ušt32_t
 
i
, 
th»ad_couÁ
;

438 
vr_wÜk”
 *
wÜk”
;

440 
th»ad_couÁ
 = (
ušt32_t
)
num_wÜk”_th»ads
;

442 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

443 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
i
);

444 
	`±h»ad_još
(
wÜk”
->
v–
.
th»ad
.
th»ad_id
, 
NULL
);

447  
VR_OK
;

448 
	}
}

451 
	$wÜk”s_deš™
()

453 
vr_wÜk”
 *
wÜk”
;

455 
	`d¬¿y_n
(&
wÜk”s
)) {

456 
wÜk”
 = 
	`d¬¿y_pİ
(&
wÜk”s
);

457 
	`vr_wÜk”_deš™
(
wÜk”
);

459 
	}
}

466 
	$wÜk”_befÜe_¦“p
(
«Ev’tLoİ
 *
ev’tLoİ
, *
´iv©e_d©a
) {

467 
vr_wÜk”
 *
wÜk”
 = 
´iv©e_d©a
;

469 
	`UNUSED
(
ev’tLoİ
);

470 
	`UNUSED
(
´iv©e_d©a
);

472 
	`ASSERT
(
ev’tLoİ
 =ğ
wÜk”
->
v–
.
–
);

475 
	`hªdËCl›ÁsW™hP’dšgWr™es
(&
wÜk”
->
v–
);

478 
	}
}

481 
	$wÜk”_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

482 
vr_wÜk”
 *
wÜk”
 = 
ş›ÁD©a
;

483 
vr_ev’oİ
 *
v–
 = &
wÜk”
->vel;

484 
size_t
 
¡©_u£d_memÜy
, 
¡©s_³ak_memÜy
;

486 
	`UNUSED
(
ev’tLoİ
);

487 
	`UNUSED
(
id
);

488 
	`UNUSED
(
ş›ÁD©a
);

490 
	`ASSERT
(
ev’tLoİ
 =ğ
v–
->
–
);

492 
v–
->
unixtime
 = 
	`time
(
NULL
);

493 
v–
->
m¡ime
 = 
	`vr_m£c_now
();

495 
	`run_w™h_³riod
(100, 
v–
->
üÚloİs
) {

496 
¡©s_v®ue
;

497 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
,
numcommªds
,&
¡©s_v®ue
);

498 
	`ŒackIn¡ªÃousM‘ric
(
v–
->
¡©s
,
STATS_METRIC_COMMAND
,
¡©s_v®ue
);

499 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
,
Ãt_šput_by‹s
,&
¡©s_v®ue
);

500 
	`ŒackIn¡ªÃousM‘ric
(
v–
->
¡©s
,
STATS_METRIC_NET_INPUT
,
¡©s_v®ue
);

501 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
,
Ãt_ouut_by‹s
,&
¡©s_v®ue
);

502 
	`ŒackIn¡ªÃousM‘ric
(
v–
->
¡©s
,
STATS_METRIC_NET_OUTPUT
,
¡©s_v®ue
);

506 
	`run_w™h_³riod
(1000, 
v–
->
üÚloİs
) {

507 
v–
->
»sid’t_£t_size
 = 
	`d®loc_g‘_rss
();

518 
	`ä“Cl›ÁsInAsyncF»eQueue
(
v–
);

523 
	`run_w™h_³riod
(1000, 
v–
->
üÚloİs
) {

524 
	`cÚf_ÿche_upd©e
(&
v–
->
cc
);

527 
v–
->
üÚloİs
 ++;

528  1000/
v–
->
hz
;

529 
	}
}

	@src/vr_worker.c

1 
	~<vr_cÜe.h
>

4 
	gÏ¡_wÜk”_th»ad
 = -1;

5 
	gnum_wÜk”_th»ads
;

7 
d¬¿y
 
	gwÜk”s
;

9 *
wÜk”_th»ad_run
(*
¬gs
);

11 
	#SU_PER_ALLOC
 64

	)

15 
cÚnsw­un™
 *
	gcsui_ä“li¡
;

16 
±h»ad_mu‹x_t
 
	gcsui_ä“li¡_lock
;

22 
cÚnsw­un™
 *

23 
	$csui_Ãw
() {

24 
cÚnsw­un™
 *
™em
 = 
NULL
;

26 
	`±h»ad_mu‹x_lock
(&
csui_ä“li¡_lock
);

27 ià(
csui_ä“li¡
) {

28 
™em
 = 
csui_ä“li¡
;

29 
csui_ä“li¡
 = 
™em
->
Ãxt
;

31 
	`±h»ad_mu‹x_uÆock
(&
csui_ä“li¡_lock
);

33 ià(
NULL
 =ğ
™em
) {

34 
i
;

37 
™em
 = 
	`d®loc
((
cÚnsw­un™
è* 
SU_PER_ALLOC
);

38 ià(
NULL
 =ğ
™em
) {

39  
NULL
;

47 
i
 = 2; i < 
SU_PER_ALLOC
; i++)

48 
™em
[
i
 - 1].
Ãxt
 = &item[i];

50 
	`±h»ad_mu‹x_lock
(&
csui_ä“li¡_lock
);

51 
™em
[
SU_PER_ALLOC
 - 1].
Ãxt
 = 
csui_ä“li¡
;

52 
csui_ä“li¡
 = &
™em
[1];

53 
	`±h»ad_mu‹x_uÆock
(&
csui_ä“li¡_lock
);

56  
™em
;

57 
	}
}

64 
	$csui_ä“
(
cÚnsw­un™
 *
™em
) {

65 
	`±h»ad_mu‹x_lock
(&
csui_ä“li¡_lock
);

66 
™em
->
Ãxt
 = 
csui_ä“li¡
;

67 
csui_ä“li¡
 = 
™em
;

68 
	`±h»ad_mu‹x_uÆock
(&
csui_ä“li¡_lock
);

69 
	}
}

73 
	$csul_push
(
vr_wÜk”
 *
wÜk”
, 
cÚnsw­un™
 *
su
)

75 
	`±h»ad_mu‹x_lock
(&
wÜk”
->
csuÎock
);

76 
	`dli¡Push
(
wÜk”
->
csul
, 
su
);

77 
	`±h»ad_mu‹x_uÆock
(&
wÜk”
->
csuÎock
);

78 
	}
}

81 
cÚnsw­un™
 *

82 
	$csul_pİ
(
vr_wÜk”
 *
wÜk”
)

84 
cÚnsw­un™
 *
su
 = 
NULL
;

86 
	`±h»ad_mu‹x_lock
(&
wÜk”
->
csuÎock
);

87 
su
 = 
	`dli¡Pİ
(
wÜk”
->
csul
);

88 
	`±h»ad_mu‹x_uÆock
(&
wÜk”
->
csuÎock
);

90  
su
;

91 
	}
}

95 
	$vr_wÜk”_š™
(
vr_wÜk”
 *
wÜk”
)

97 
r¡©us_t
 
¡©us
;

98 
maxş›Ás
, 
th»ads_num
;

99 
f–im™
;

101 ià(
wÜk”
 =ğ
NULL
) {

102  
VR_ERROR
;

105 
wÜk”
->
id
 = 0;

106 
wÜk”
->
sock‘·œs
[0] = -1;

107 
wÜk”
->
sock‘·œs
[1] = -1;

109 
wÜk”
->
csul
 = 
NULL
;

111 
	`±h»ad_mu‹x_š™
(&
wÜk”
->
csuÎock
, 
NULL
);

112 
wÜk”
->
cu¼’t_db
 = 0;

113 
wÜk”
->
tim–im™_ex™
 = 0;

114 
wÜk”
->
Ï¡_ç¡_cyşe
 = 0;

115 
wÜk”
->
»size_db
 = 0;

116 
wÜk”
->
»hash_db
 = 0;

118 
	`cÚf_£rv”_g‘
(
CONFIG_SOPN_MAXCLIENTS
,&
maxş›Ás
);

120 
f–im™
 = 
	`adju¡O³nFesLim™
(
maxş›Ás
);

121 ià(
f–im™
 <= 0) {

122  
VR_ERROR
;

125 
	`vr_ev’oİ_š™
(&
wÜk”
->
v–
, 
f–im™
);

127 
wÜk”
->
v–
.
th»ad
.
fun_run
 = 
wÜk”_th»ad_run
;

129 
wÜk”
->
v–
.
th»ad
.
d©a
 = worker;

131 
wÜk”
->
v–
.
c¡abË
 = 
	`commªdStsTabËC»©e
();

133 
¡©us
 = 
	`sock‘·œ
(
AF_LOCAL
, 
SOCK_STREAM
, 0, 
wÜk”
->
sock‘·œs
);

134 ià(
¡©us
 < 0) {

135 
	`log_”rÜ
("ü—‹ sock‘·œ çed: %s", 
	`¡»¼Ü
(
”ºo
));

136  
VR_ERROR
;

139 
¡©us
 = 
	`vr_£t_nÚblockšg
(
wÜk”
->
sock‘·œs
[0]);

140 ià(
¡©us
 < 0) {

141 
	`log_”rÜ
("set socketpairs[0] %d‚onblocking failed: %s",

142 
wÜk”
->
sock‘·œs
[0], 
	`¡»¼Ü
(
”ºo
));

143 
	`şo£
(
wÜk”
->
sock‘·œs
[0]);

144 
wÜk”
->
sock‘·œs
[0] = -1;

145 
	`şo£
(
wÜk”
->
sock‘·œs
[1]);

146 
wÜk”
->
sock‘·œs
[1] = -1;

147  
VR_ERROR
;

149 
¡©us
 = 
	`vr_£t_nÚblockšg
(
wÜk”
->
sock‘·œs
[1]);

150 ià(
¡©us
 < 0) {

151 
	`log_”rÜ
("set socketpairs[1] %d‚onblocking failed: %s",

152 
wÜk”
->
sock‘·œs
[1], 
	`¡»¼Ü
(
”ºo
));

153 
	`şo£
(
wÜk”
->
sock‘·œs
[0]);

154 
wÜk”
->
sock‘·œs
[0] = -1;

155 
	`şo£
(
wÜk”
->
sock‘·œs
[1]);

156 
wÜk”
->
sock‘·œs
[1] = -1;

157  
VR_ERROR
;

160 
wÜk”
->
csul
 = 
	`dli¡C»©e
();

161 ià(
wÜk”
->
csul
 =ğ
NULL
) {

162 
	`log_”rÜ
("create†ist failed: out of memory");

163  
VR_ENOMEM
;

166  
VR_OK
;

167 
	}
}

171 
	$vr_wÜk”_deš™
(
vr_wÜk”
 *
wÜk”
)

173 ià(
wÜk”
 =ğ
NULL
) {

177 
	`vr_ev’oİ_deš™
(&
wÜk”
->
v–
);

179 ià(
wÜk”
->
sock‘·œs
[0] > 0){

180 
	`şo£
(
wÜk”
->
sock‘·œs
[0]);

181 
wÜk”
->
sock‘·œs
[0] = -1;

183 ià(
wÜk”
->
sock‘·œs
[1] > 0){

184 
	`şo£
(
wÜk”
->
sock‘·œs
[1]);

185 
wÜk”
->
sock‘·œs
[1] = -1;

188 ià(
wÜk”
->
csul
 !ğ
NULL
) {

189 
	`dli¡R–—£
(
wÜk”
->
csul
);

190 
wÜk”
->
csul
 = 
NULL
;

192 
	}
}

196 
	$wÜk”_g‘_Ãxt_idx
(
curidx
)

198 
idx
 = 
curidx
 + 1;

199  
idx
>=
num_wÜk”_th»ads
?0:idx;

200 
	}
}

204 
	$di¥©ch_cÚn_Ãw
(
vr_li¡’
 *
vli¡’
, 
sd
)

206 
cÚnsw­un™
 *
su
 = 
	`csui_Ãw
();

207 
buf
[1];

208 
vr_wÜk”
 *
wÜk”
;

210 ià(
su
 =ğ
NULL
) {

211 
	`şo£
(
sd
);

213 
	`log_”rÜ
("Failedo‡llocate memory for connection swap object\n");

218 
tid
 = (
Ï¡_wÜk”_th»ad
 + 1è% 
num_wÜk”_th»ads
;

219 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, (
ušt32_t
)
tid
);

222 
Ï¡_wÜk”_th»ad
 = 
tid
;

225 
su
->
num
 = 
sd
;

226 
su
->
d©a
 = 
vli¡’
;

229 
	`csul_push
(
wÜk”
, 
su
);

232 
buf
[0] = 'c';

233 ià(
	`vr_wr™e
(
wÜk”
->
sock‘·œs
[0], 
buf
, 1) != 1) {

234 
	`log_”rÜ
("Noticehe worker failed.");

237 
	`upd©e_cu¼_ş›Ás_add
(1);

238 
	}
}

242 
	$th»ad_ev’t_´oûss
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

244 
r¡©us_t
 
¡©us
;

246 
vr_wÜk”
 *
wÜk”
 = 
´ivd©a
;

247 
buf
[1];

248 
sd
;

250 
vr_li¡’
 *
vli¡’
;

251 
cÚn
 *conn;

252 
cÚnsw­un™
 *
csu
;

253 
ş›Á
 *
c
;

255 
	`ASSERT
(
–
 =ğ
wÜk”
->
v–
.el);

256 
	`ASSERT
(
fd
 =ğ
wÜk”
->
sock‘·œs
[1]);

258 ià(
	`vr_»ad
(
fd
, 
buf
, 1) != 1) {

259 
	`log_w¬n
("Can't„ead for worker(id:%d) socketpairs[1](%d)",

260 
wÜk”
->
v–
.
th»ad
.
id
, 
fd
);

261 
buf
[0] = 'c';

264 
buf
[0]) {

268 
csu
 = 
	`csul_pİ
(
wÜk”
);

269 ià(
csu
 =ğ
NULL
) {

273 
sd
 = 
csu
->
num
;

275 
vli¡’
 = 
csu
->
d©a
;

277 
	`csui_ä“
(
csu
);

278 
cÚn
 = 
	`cÚn_g‘
(
wÜk”
->
v–
.
cb
);

279 ià(
cÚn
 =ğ
NULL
) {

280 
	`log_”rÜ
("get conn for c %d failed: %s",

281 
sd
, 
	`¡»¼Ü
(
”ºo
));

282 
¡©us
 = 
	`şo£
(
sd
);

283 ià(
¡©us
 < 0) {

284 
	`log_”rÜ
("şo£ c %d faed, ignÜed: %s", 
sd
, 
	`¡»¼Ü
(
”ºo
));

288 
cÚn
->
sd
 = sd;

290 
¡©us
 = 
	`vr_£t_nÚblockšg
(
cÚn
->
sd
);

291 ià(
¡©us
 < 0) {

292 
	`log_”rÜ
("set‚onblock on c %d failed: %s",

293 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

294 
	`cÚn_put
(
cÚn
);

298 ià(
vli¡’
->
šfo
.
çmy
 =ğ
AF_INET
 || vli¡’->šfo.çmy =ğ
AF_INET6
) {

299 
¡©us
 = 
	`vr_£t_tınod–ay
(
cÚn
->
sd
);

300 ià(
¡©us
 < 0) {

301 
	`log_w¬n
("setcpnodelay on c %d failed, ignored: %s",

302 
cÚn
->
sd
, 
	`¡»¼Ü
(
”ºo
));

306 
c
 = 
	`ü—‹Cl›Á
(&
wÜk”
->
v–
, 
cÚn
);

307 ià(
c
 =ğ
NULL
) {

308 
	`log_”rÜ
("Create client failed");

309 
	`cÚn_put
(
cÚn
);

313 
c
->
curidx
 = 
wÜk”
->
id
;

315 
¡©us
 = 
	`«C»©eFeEv’t
(
wÜk”
->
v–
.
–
, 
cÚn
->
sd
, 
AE_READABLE
,

316 
»adQu”yFromCl›Á
, 
c
);

317 ià(
¡©us
 =ğ
AE_ERR
) {

318 
	`log_”rÜ
("Unrecoverableƒrror creating worker ipfd fileƒvent.");

322 
	`upd©e_¡©s_add
(
c
->
v–
->
¡©s
, 
numcÚÃùiÚs
, 1);

328 
csu
 = 
	`csul_pİ
(
wÜk”
);

329 ià(
csu
 =ğ
NULL
) {

333 
c
 = 
csu
->
d©a
;

335 
	`csui_ä“
(
csu
);

336 
c
->
v–
 = &
wÜk”
->vel;

337 
c
->
curidx
 = 
wÜk”
->
id
;

338 
c
->
¡•s
 ++;

339 
c
->
cmd
->
	`´oc
(c);

341 ià(
c
->
æags
&
CLIENT_JUMP
) {

342 
	`di¥©ch_cÚn_exi¡
(
c
,c->
ridx
);

344 
	`»£tCl›Á
(
c
);

345 
	`lškCl›ÁToEv’oİ
(
c
,c->
v–
);

349 
	`log_”rÜ
("readƒrror char '%c' for worker(id:%d) socketpairs[1](%d)",

350 
buf
[0], 
wÜk”
->
v–
.
th»ad
.
id
, wÜk”->
sock‘·œs
[1]);

353 
	}
}

356 
	$£tup_wÜk”
(
vr_wÜk”
 *
wÜk”
)

358 
r¡©us_t
 
¡©us
;

360 
¡©us
 = 
	`«C»©eFeEv’t
(
wÜk”
->
v–
.
–
, wÜk”->
sock‘·œs
[1], 
AE_READABLE
,

361 
th»ad_ev’t_´oûss
, 
wÜk”
);

362 ià(
¡©us
 =ğ
AE_ERR
) {

363 
	`log_”rÜ
("Unrecoverableƒrror creating worker ipfd fileƒvent.");

364  
VR_ERROR
;

367 
	`«S‘BefÜeSË•Proc
(
wÜk”
->
v–
.
–
, 
wÜk”_befÜe_¦“p
, worker);

372 if(
	`«C»©eTimeEv’t
(
wÜk”
->
v–
.
–
, 1, 
wÜk”_üÚ
, wÜk”, 
NULL
è=ğ
AE_ERR
) {

373 
	`£rv”Pªic
("Can't createhe serverCronimeƒvent.");

374  
VR_ERROR
;

377  
VR_OK
;

378 
	}
}

381 
	$wÜk”_th»ad_run
(*
¬gs
)

383 
vr_wÜk”
 *
wÜk”
 = 
¬gs
;

386 
	`«Maš
(
wÜk”
->
v–
.
–
);

388  
NULL
;

389 
	}
}

392 
	$wÜk”s_š™
(
ušt32_t
 
wÜk”_couÁ
)

394 
r¡©us_t
 
¡©us
;

395 
ušt32_t
 
idx
;

396 
vr_wÜk”
 *
wÜk”
;

398 
csui_ä“li¡
 = 
NULL
;

399 
	`±h»ad_mu‹x_š™
(&
csui_ä“li¡_lock
, 
NULL
);

401 
	`d¬¿y_š™
(&
wÜk”s
, 
wÜk”_couÁ
, (
vr_wÜk”
));

403 
idx
 = 0; idx < 
wÜk”_couÁ
; idx ++) {

404 
wÜk”
 = 
	`d¬¿y_push
(&
wÜk”s
);

405 
	`vr_wÜk”_š™
(
wÜk”
);

406 
wÜk”
->
id
 = 
idx
;

407 
¡©us
 = 
	`£tup_wÜk”
(
wÜk”
);

408 ià(
¡©us
 !ğ
VR_OK
) {

409 
	`ex™
(1);

413 
num_wÜk”_th»ads
 = ()
	`d¬¿y_n
(&
wÜk”s
);

415  
VR_OK
;

416 
	}
}

419 
	$wÜk”s_run
()

421 
ušt32_t
 
i
, 
th»ad_couÁ
;

422 
vr_wÜk”
 *
wÜk”
;

424 
th»ad_couÁ
 = (
ušt32_t
)
num_wÜk”_th»ads
;

426 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

427 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
i
);

428 
	`vr_th»ad_¡¬t
(&
wÜk”
->
v–
.
th»ad
);

431  
VR_OK
;

432 
	}
}

435 
	$wÜk”s_wa™
()

437 
ušt32_t
 
i
, 
th»ad_couÁ
;

438 
vr_wÜk”
 *
wÜk”
;

440 
th»ad_couÁ
 = (
ušt32_t
)
num_wÜk”_th»ads
;

442 
i
 = 0; i < 
th»ad_couÁ
; i ++) {

443 
wÜk”
 = 
	`d¬¿y_g‘
(&
wÜk”s
, 
i
);

444 
	`±h»ad_još
(
wÜk”
->
v–
.
th»ad
.
th»ad_id
, 
NULL
);

447  
VR_OK
;

448 
	}
}

451 
	$wÜk”s_deš™
()

453 
vr_wÜk”
 *
wÜk”
;

455 
	`d¬¿y_n
(&
wÜk”s
)) {

456 
wÜk”
 = 
	`d¬¿y_pİ
(&
wÜk”s
);

457 
	`vr_wÜk”_deš™
(
wÜk”
);

459 
	}
}

466 
	$wÜk”_befÜe_¦“p
(
«Ev’tLoİ
 *
ev’tLoİ
, *
´iv©e_d©a
) {

467 
vr_wÜk”
 *
wÜk”
 = 
´iv©e_d©a
;

469 
	`UNUSED
(
ev’tLoİ
);

470 
	`UNUSED
(
´iv©e_d©a
);

472 
	`ASSERT
(
ev’tLoİ
 =ğ
wÜk”
->
v–
.
–
);

475 
	`hªdËCl›ÁsW™hP’dšgWr™es
(&
wÜk”
->
v–
);

478 
	}
}

481 
	$wÜk”_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

482 
vr_wÜk”
 *
wÜk”
 = 
ş›ÁD©a
;

483 
vr_ev’oİ
 *
v–
 = &
wÜk”
->vel;

484 
size_t
 
¡©_u£d_memÜy
, 
¡©s_³ak_memÜy
;

486 
	`UNUSED
(
ev’tLoİ
);

487 
	`UNUSED
(
id
);

488 
	`UNUSED
(
ş›ÁD©a
);

490 
	`ASSERT
(
ev’tLoİ
 =ğ
v–
->
–
);

492 
v–
->
unixtime
 = 
	`time
(
NULL
);

493 
v–
->
m¡ime
 = 
	`vr_m£c_now
();

495 
	`run_w™h_³riod
(100, 
v–
->
üÚloİs
) {

496 
¡©s_v®ue
;

497 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
,
numcommªds
,&
¡©s_v®ue
);

498 
	`ŒackIn¡ªÃousM‘ric
(
v–
->
¡©s
,
STATS_METRIC_COMMAND
,
¡©s_v®ue
);

499 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
,
Ãt_šput_by‹s
,&
¡©s_v®ue
);

500 
	`ŒackIn¡ªÃousM‘ric
(
v–
->
¡©s
,
STATS_METRIC_NET_INPUT
,
¡©s_v®ue
);

501 
	`upd©e_¡©s_g‘
(
v–
->
¡©s
,
Ãt_ouut_by‹s
,&
¡©s_v®ue
);

502 
	`ŒackIn¡ªÃousM‘ric
(
v–
->
¡©s
,
STATS_METRIC_NET_OUTPUT
,
¡©s_v®ue
);

506 
	`run_w™h_³riod
(1000, 
v–
->
üÚloİs
) {

507 
v–
->
»sid’t_£t_size
 = 
	`d®loc_g‘_rss
();

518 
	`ä“Cl›ÁsInAsyncF»eQueue
(
v–
);

523 
	`run_w™h_³riod
(1000, 
v–
->
üÚloİs
) {

524 
	`cÚf_ÿche_upd©e
(&
v–
->
cc
);

527 
v–
->
üÚloİs
 ++;

528  1000/
v–
->
hz
;

529 
	}
}

	@src/vr_worker.h

1 #iâdeà
_VR_WORKER_H_


2 
	#_VR_WORKER_H_


	)

4 
	svr_wÜk”
 {

6 
	mid
;

8 
vr_ev’oİ
 
	mv–
;

10 
	msock‘·œs
[2];

12 
dli¡
 *
	mcsul
;

13 
±h»ad_mu‹x_t
 
	mcsuÎock
;

18 
	mcu¼’t_db
;

20 
	mtim–im™_ex™
;

22 
	mÏ¡_ç¡_cyşe
;

28 
	m»size_db
;

29 
	m»hash_db
;

30 }
	tvr_wÜk”
;

33 
	scÚnsw­un™
 {

35 
	mnum
;

36 *
	md©a
;

37 
cÚnsw­un™
 *
	mÃxt
;

41 
d¬¿y
 
wÜk”s
;

45 
wÜk”s_š™
(
ušt32_t
 
wÜk”_couÁ
);

47 
wÜk”s_run
();

49 
wÜk”s_wa™
();

51 
wÜk”s_deš™
();

54 
cÚnsw­un™
 *
csui_Ãw
();

56 
csui_ä“
(
cÚnsw­un™
 *
™em
);

58 
csul_push
(
vr_wÜk”
 *
wÜk”
, 
cÚnsw­un™
 *
su
);

60 
cÚnsw­un™
 *
csul_pİ
(
vr_wÜk”
 *
wÜk”
);

63 
wÜk”_g‘_Ãxt_idx
(
curidx
);

65 
di¥©ch_cÚn_Ãw
(
vr_li¡’
 *
vli¡’
, 
sd
);

67 
wÜk”_befÜe_¦“p
(
«Ev’tLoİ
 *
ev’tLoİ
, *
´iv©e_d©a
);

69 
wÜk”_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
);

	@src/vr_worker.h

1 #iâdeà
_VR_WORKER_H_


2 
	#_VR_WORKER_H_


	)

4 
	svr_wÜk”
 {

6 
	mid
;

8 
vr_ev’oİ
 
	mv–
;

10 
	msock‘·œs
[2];

12 
dli¡
 *
	mcsul
;

13 
±h»ad_mu‹x_t
 
	mcsuÎock
;

18 
	mcu¼’t_db
;

20 
	mtim–im™_ex™
;

22 
	mÏ¡_ç¡_cyşe
;

28 
	m»size_db
;

29 
	m»hash_db
;

30 }
	tvr_wÜk”
;

33 
	scÚnsw­un™
 {

35 
	mnum
;

36 *
	md©a
;

37 
cÚnsw­un™
 *
	mÃxt
;

41 
d¬¿y
 
wÜk”s
;

45 
wÜk”s_š™
(
ušt32_t
 
wÜk”_couÁ
);

47 
wÜk”s_run
();

49 
wÜk”s_wa™
();

51 
wÜk”s_deš™
();

54 
cÚnsw­un™
 *
csui_Ãw
();

56 
csui_ä“
(
cÚnsw­un™
 *
™em
);

58 
csul_push
(
vr_wÜk”
 *
wÜk”
, 
cÚnsw­un™
 *
su
);

60 
cÚnsw­un™
 *
csul_pİ
(
vr_wÜk”
 *
wÜk”
);

63 
wÜk”_g‘_Ãxt_idx
(
curidx
);

65 
di¥©ch_cÚn_Ãw
(
vr_li¡’
 *
vli¡’
, 
sd
);

67 
wÜk”_befÜe_¦“p
(
«Ev’tLoİ
 *
ev’tLoİ
, *
´iv©e_d©a
);

69 
wÜk”_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
);

	@src/vr_ziplist.c

104 
	~<¡dio.h
>

105 
	~<¡dlib.h
>

106 
	~<¡ršg.h
>

107 
	~<¡dšt.h
>

108 
	~<lim™s.h
>

110 
	~<vr_cÜe.h
>

112 
	#ZIP_END
 255

	)

113 
	#ZIP_BIGLEN
 254

	)

116 
	#ZIP_STR_MASK
 0xc0

	)

117 
	#ZIP_INT_MASK
 0x30

	)

118 
	#ZIP_STR_06B
 (0 << 6)

	)

119 
	#ZIP_STR_14B
 (1 << 6)

	)

120 
	#ZIP_STR_32B
 (2 << 6)

	)

121 
	#ZIP_INT_16B
 (0xc0 | 0<<4)

	)

122 
	#ZIP_INT_32B
 (0xc0 | 1<<4)

	)

123 
	#ZIP_INT_64B
 (0xc0 | 2<<4)

	)

124 
	#ZIP_INT_24B
 (0xc0 | 3<<4)

	)

125 
	#ZIP_INT_8B
 0xã

	)

127 
	#ZIP_INT_IMM_MASK
 0x0f

	)

128 
	#ZIP_INT_IMM_MIN
 0xf1

	)

129 
	#ZIP_INT_IMM_MAX
 0xfd

	)

130 
	#ZIP_INT_IMM_VAL
(
v
è(v & 
ZIP_INT_IMM_MASK
)

	)

132 
	#INT24_MAX
 0x7fffff

	)

133 
	#INT24_MIN
 (-
INT24_MAX
 - 1)

	)

136 
	#ZIP_IS_STR
(
’c
è((Óncè& 
ZIP_STR_MASK
è< ZIP_STR_MASK)

	)

139 
	#ZIPLIST_BYTES
(
zl
è(*((
ušt32_t
*)(zl)))

	)

140 
	#ZIPLIST_TAIL_OFFSET
(
zl
è(*((
ušt32_t
*)((zl)+(ušt32_t))))

	)

141 
	#ZIPLIST_LENGTH
(
zl
è(*((
ušt16_t
*)((zl)+(
ušt32_t
)*2)))

	)

142 
	#ZIPLIST_HEADER_SIZE
 ((
ušt32_t
)*2+(
ušt16_t
))

	)

143 
	#ZIPLIST_END_SIZE
 ((
ušt8_t
))

	)

144 
	#ZIPLIST_ENTRY_HEAD
(
zl
è((zl)+
ZIPLIST_HEADER_SIZE
)

	)

145 
	#ZIPLIST_ENTRY_TAIL
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl)))

	)

146 
	#ZIPLIST_ENTRY_END
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-1)

	)

150 
	#ZIPLIST_INCR_LENGTH
(
zl
,
šü
) { \

151 ià(
	`ZIPLIST_LENGTH
(
zl
è< 
UINT16_MAX
) \

152 
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(šŒev16ifbe(ZIPLIST_LENGTH(zl))+
šü
); \

153 }

	)

155 
	szËÁry
 {

156 
	m´ev¿wËnsize
, 
	m´ev¿wËn
;

157 
	mËnsize
, 
	mËn
;

158 
	mh—d”size
;

159 
	m’codšg
;

160 *
	mp
;

161 } 
	tzËÁry
;

163 
	#ZIPLIST_ENTRY_ZERO
(
zË
) { \

164 (
zË
)->
´ev¿wËnsize
 = (zË)->
´ev¿wËn
 = 0; \

165 (
zË
)->
Ënsize
 = (zË)->
Ën
 = (zË)->
h—d”size
 = 0; \

166 (
zË
)->
’codšg
 = 0; \

167 (
zË
)->
p
 = 
NULL
; \

168 }

	)

172 
	#ZIP_ENTRY_ENCODING
(
±r
, 
’codšg
) do { \

173 (
’codšg
èğ(
±r
[0]); \

174 ià((
’codšg
è< 
ZIP_STR_MASK
) (encoding) &= ZIP_STR_MASK; \

175 } 0)

	)

177 
zli¡R•r
(*
zl
);

180 
	$zIÁSize
(
’codšg
) {

181 
’codšg
) {

182 
ZIP_INT_8B
:  1;

183 
ZIP_INT_16B
:  2;

184 
ZIP_INT_24B
:  3;

185 
ZIP_INT_32B
:  4;

186 
ZIP_INT_64B
:  8;

189 
	`ASSERT
(
NULL
);

191 
	}
}

195 
	$zEncodeL’gth
(*
p
, 
’codšg
, 
¿wËn
) {

196 
Ën
 = 1, 
buf
[5];

198 ià(
	`ZIP_IS_STR
(
’codšg
)) {

201 ià(
¿wËn
 <= 0x3f) {

202 ià(!
p
è 
Ën
;

203 
buf
[0] = 
ZIP_STR_06B
 | 
¿wËn
;

204 } ià(
¿wËn
 <= 0x3fff) {

205 
Ën
 += 1;

206 ià(!
p
è 
Ën
;

207 
buf
[0] = 
ZIP_STR_14B
 | ((
¿wËn
 >> 8) & 0x3f);

208 
buf
[1] = 
¿wËn
 & 0xff;

210 
Ën
 += 4;

211 ià(!
p
è 
Ën
;

212 
buf
[0] = 
ZIP_STR_32B
;

213 
buf
[1] = (
¿wËn
 >> 24) & 0xff;

214 
buf
[2] = (
¿wËn
 >> 16) & 0xff;

215 
buf
[3] = (
¿wËn
 >> 8) & 0xff;

216 
buf
[4] = 
¿wËn
 & 0xff;

220 ià(!
p
è 
Ën
;

221 
buf
[0] = 
’codšg
;

225 
	`memıy
(
p
,
buf
,
Ën
);

226  
Ën
;

227 
	}
}

233 
	#ZIP_DECODE_LENGTH
(
±r
, 
’codšg
, 
Ënsize
, 
Ën
) do { \

234 
	`ZIP_ENTRY_ENCODING
((
±r
), (
’codšg
)); \

235 ià((
’codšg
è< 
ZIP_STR_MASK
) { \

236 ià((
’codšg
è=ğ
ZIP_STR_06B
) { \

237 (
Ënsize
) = 1; \

238 (
Ën
èğ(
±r
)[0] & 0x3f; \

239 } ià((
’codšg
è=ğ
ZIP_STR_14B
) { \

240 (
Ënsize
) = 2; \

241 (
Ën
èğ(((
±r
)[0] & 0x3f) << 8) | (ptr)[1]; \

242 } ià(
’codšg
 =ğ
ZIP_STR_32B
) { \

243 (
Ënsize
) = 5; \

244 (
Ën
èğ((
±r
)[1] << 24) | \

245 ((
±r
)[2] << 16) | \

246 ((
±r
)[3] << 8) | \

247 ((
±r
)[4]); \

249 
	`ASSERT
(
NULL
); \

252 (
Ënsize
) = 1; \

253 (
Ën
èğ
	`zIÁSize
(
’codšg
); \

255 } 0);

	)

259 
	$zP»vEncodeL’gth
(*
p
, 
Ën
) {

260 ià(
p
 =ğ
NULL
) {

261  (
Ën
 < 
ZIP_BIGLEN
) ? 1 : (len)+1;

263 ià(
Ën
 < 
ZIP_BIGLEN
) {

264 
p
[0] = 
Ën
;

267 
p
[0] = 
ZIP_BIGLEN
;

268 
	`memıy
(
p
+1,&
Ën
,(len));

269 
	`mem»v32ifbe
(
p
+1);

270  1+(
Ën
);

273 
	}
}

277 
	$zP»vEncodeL’gthFÜûL¬ge
(*
p
, 
Ën
) {

278 ià(
p
 =ğ
NULL
) ;

279 
p
[0] = 
ZIP_BIGLEN
;

280 
	`memıy
(
p
+1,&
Ën
,(len));

281 
	`mem»v32ifbe
(
p
+1);

282 
	}
}

286 
	#ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
) do { \

287 ià((
±r
)[0] < 
ZIP_BIGLEN
) { \

288 (
´evËnsize
) = 1; \

290 (
´evËnsize
) = 5; \

292 } 0);

	)

296 
	#ZIP_DECODE_PREVLEN
(
±r
, 
´evËnsize
, 
´evËn
) do { \

297 
	`ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
); \

298 ià((
´evËnsize
) == 1) { \

299 (
´evËn
èğ(
±r
)[0]; \

300 } ià((
´evËnsize
) == 5) { \

301 
	`ASSERT
(((
´evËnsize
)) == 4); \

302 
	`memıy
(&(
´evËn
), ((*)(
±r
)) + 1, 4); \

303 
	`mem»v32ifbe
(&
´evËn
); \

305 } 0);

	)

309 
	$zP»vL’By‹Diff
(*
p
, 
Ën
) {

310 
´evËnsize
;

311 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

312  
	`zP»vEncodeL’gth
(
NULL
, 
Ën
è- 
´evËnsize
;

313 
	}
}

316 
	$zRawEÁryL’gth
(*
p
) {

317 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

318 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

319 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

320  
´evËnsize
 + 
Ënsize
 + 
Ën
;

321 
	}
}

325 
	$zTryEncodšg
(*
’Œy
, 
’ŒyËn
, *
v
, *
’codšg
) {

326 
v®ue
;

328 ià(
’ŒyËn
 >= 32 ||ƒntrylen == 0)  0;

329 ià(
	`¡ršg2Î
((*)
’Œy
,
’ŒyËn
,&
v®ue
)) {

332 ià(
v®ue
 >= 0 && value <= 12) {

333 *
’codšg
 = 
ZIP_INT_IMM_MIN
+
v®ue
;

334 } ià(
v®ue
 >ğ
INT8_MIN
 && v®u<ğ
INT8_MAX
) {

335 *
’codšg
 = 
ZIP_INT_8B
;

336 } ià(
v®ue
 >ğ
INT16_MIN
 && v®u<ğ
INT16_MAX
) {

337 *
’codšg
 = 
ZIP_INT_16B
;

338 } ià(
v®ue
 >ğ
INT24_MIN
 && v®u<ğ
INT24_MAX
) {

339 *
’codšg
 = 
ZIP_INT_24B
;

340 } ià(
v®ue
 >ğ
INT32_MIN
 && v®u<ğ
INT32_MAX
) {

341 *
’codšg
 = 
ZIP_INT_32B
;

343 *
’codšg
 = 
ZIP_INT_64B
;

345 *
v
 = 
v®ue
;

349 
	}
}

352 
	$zSaveIÁeg”
(*
p
, 
št64_t
 
v®ue
, 
’codšg
) {

353 
št16_t
 
i16
;

354 
št32_t
 
i32
;

355 
št64_t
 
i64
;

356 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

357 ((
št8_t
*)
p
)[0] = (št8_t)
v®ue
;

358 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

359 
i16
 = 
v®ue
;

360 
	`memıy
(
p
,&
i16
,(i16));

361 
	`mem»v16ifbe
(
p
);

362 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

363 
i32
 = 
v®ue
<<8;

364 
	`mem»v32ifbe
(&
i32
);

365 
	`memıy
(
p
,((
ušt8_t
*)&
i32
)+1,(i32)-(uint8_t));

366 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

367 
i32
 = 
v®ue
;

368 
	`memıy
(
p
,&
i32
,(i32));

369 
	`mem»v32ifbe
(
p
);

370 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

371 
i64
 = 
v®ue
;

372 
	`memıy
(
p
,&
i64
,(i64));

373 
	`mem»v64ifbe
(
p
);

374 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

377 
	`ASSERT
(
NULL
);

379 
	}
}

382 
št64_t
 
	$zLßdIÁeg”
(*
p
, 
’codšg
) {

383 
št16_t
 
i16
;

384 
št32_t
 
i32
;

385 
št64_t
 
i64
, 
»t
 = 0;

386 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

387 
»t
 = ((
št8_t
*)
p
)[0];

388 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

389 
	`memıy
(&
i16
,
p
,(i16));

390 
	`mem»v16ifbe
(&
i16
);

391 
»t
 = 
i16
;

392 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

393 
	`memıy
(&
i32
,
p
,(i32));

394 
	`mem»v32ifbe
(&
i32
);

395 
»t
 = 
i32
;

396 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

397 
i32
 = 0;

398 
	`memıy
(((
ušt8_t
*)&
i32
)+1,
p
,(i32)-(uint8_t));

399 
	`mem»v32ifbe
(&
i32
);

400 
»t
 = 
i32
>>8;

401 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

402 
	`memıy
(&
i64
,
p
,(i64));

403 
	`mem»v64ifbe
(&
i64
);

404 
»t
 = 
i64
;

405 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

406 
»t
 = (
’codšg
 & 
ZIP_INT_IMM_MASK
)-1;

408 
	`ASSERT
(
NULL
);

410  
»t
;

411 
	}
}

414 
	$zEÁry
(*
p
, 
zËÁry
 *
e
) {

416 
	`ZIP_DECODE_PREVLEN
(
p
, 
e
->
´ev¿wËnsize
,ƒ->
´ev¿wËn
);

417 
	`ZIP_DECODE_LENGTH
(
p
 + 
e
->
´ev¿wËnsize
,ƒ->
’codšg
,ƒ->
Ënsize
,ƒ->
Ën
);

418 
e
->
h—d”size
 =ƒ->
´ev¿wËnsize
 +ƒ->
Ënsize
;

419 
e
->
p
 =…;

420 
	}
}

423 *
	$zli¡New
() {

424 
by‹s
 = 
ZIPLIST_HEADER_SIZE
+1;

425 *
zl
 = 
	`d®loc
(
by‹s
);

426 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
by‹s
);

427 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
ZIPLIST_HEADER_SIZE
);

428 
	`ZIPLIST_LENGTH
(
zl
) = 0;

429 
zl
[
by‹s
-1] = 
ZIP_END
;

430  
zl
;

431 
	}
}

434 *
	$zli¡Resize
(*
zl
, 
Ën
) {

435 
zl
 = 
	`d»®loc
(zl,
Ën
);

436 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
Ën
);

437 
zl
[
Ën
-1] = 
ZIP_END
;

438  
zl
;

439 
	}
}

461 *
	$__zli¡CasÿdeUpd©e
(*
zl
, *
p
) {

462 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
¿wËn
, 
¿wËnsize
;

463 
size_t
 
off£t
, 
noff£t
, 
exŒa
;

464 *
Å
;

465 
zËÁry
 
cur
, 
Ãxt
;

467 
p
[0] !ğ
ZIP_END
) {

468 
	`zEÁry
(
p
, &
cur
);

469 
¿wËn
 = 
cur
.
h—d”size
 + cur.
Ën
;

470 
¿wËnsize
 = 
	`zP»vEncodeL’gth
(
NULL
,
¿wËn
);

473 ià(
p
[
¿wËn
] =ğ
ZIP_END
) ;

474 
	`zEÁry
(
p
+
¿wËn
, &
Ãxt
);

477 ià(
Ãxt
.
´ev¿wËn
 =ğ
¿wËn
) ;

479 ià(
Ãxt
.
´ev¿wËnsize
 < 
¿wËnsize
) {

482 
off£t
 = 
p
-
zl
;

483 
exŒa
 = 
¿wËnsize
-
Ãxt
.
´ev¿wËnsize
;

484 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
exŒa
);

485 
p
 = 
zl
+
off£t
;

488 
Å
 = 
p
+
¿wËn
;

489 
noff£t
 = 
Å
-
zl
;

492 ià((
zl
+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl))è!ğ
Å
) {

493 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

494 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
exŒa
);

498 
	`memmove
(
Å
+
¿wËnsize
,

499 
Å
+
Ãxt
.
´ev¿wËnsize
,

500 
cu¾’
-
noff£t
-
Ãxt
.
´ev¿wËnsize
-1);

501 
	`zP»vEncodeL’gth
(
Å
,
¿wËn
);

504 
p
 +ğ
¿wËn
;

505 
cu¾’
 +ğ
exŒa
;

507 ià(
Ãxt
.
´ev¿wËnsize
 > 
¿wËnsize
) {

510 
	`zP»vEncodeL’gthFÜûL¬ge
(
p
+
¿wËn
,rawlen);

512 
	`zP»vEncodeL’gth
(
p
+
¿wËn
,rawlen);

519  
zl
;

520 
	}
}

523 *
	$__zli¡D–‘e
(*
zl
, *
p
, 
num
) {

524 
i
, 
tÙËn
, 
d–‘ed
 = 0;

525 
size_t
 
off£t
;

526 
Ãxtdiff
 = 0;

527 
zËÁry
 
fœ¡
, 

;

529 
	`zEÁry
(
p
, &
fœ¡
);

530 
i
 = 0; 
p
[0] !ğ
ZIP_END
 && i < 
num
; i++) {

531 
p
 +ğ
	`zRawEÁryL’gth
(p);

532 
d–‘ed
++;

535 
tÙËn
 = 
p
-
fœ¡
.p;

536 ià(
tÙËn
 > 0) {

537 ià(
p
[0] !ğ
ZIP_END
) {

542 
Ãxtdiff
 = 
	`zP»vL’By‹Diff
(
p
,
fœ¡
.
´ev¿wËn
);

543 
p
 -ğ
Ãxtdiff
;

544 
	`zP»vEncodeL’gth
(
p
,
fœ¡
.
´ev¿wËn
);

547 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

548 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))-
tÙËn
);

553 
	`zEÁry
(
p
, &

);

554 ià(
p
[

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

555 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

556 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

560 
	`memmove
(
fœ¡
.
p
,p,

561 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
))-(
p
-zl)-1);

564 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

565 
	`šŒev32ifbe
((
fœ¡
.
p
-
zl
)-fœ¡.
´ev¿wËn
);

569 
off£t
 = 
fœ¡
.
p
-
zl
;

570 
zl
 = 
	`zli¡Resize
(zl, 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-
tÙËn
+
Ãxtdiff
);

571 
	`ZIPLIST_INCR_LENGTH
(
zl
,-
d–‘ed
);

572 
p
 = 
zl
+
off£t
;

576 ià(
Ãxtdiff
 != 0)

577 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
);

579  
zl
;

580 
	}
}

583 *
	$__zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

584 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
»qËn
;

585 
´evËnsize
, 
´evËn
 = 0;

586 
size_t
 
off£t
;

587 
Ãxtdiff
 = 0;

588 
’codšg
 = 0;

589 
v®ue
 = 123456789;

592 
zËÁry
 

;

595 ià(
p
[0] !ğ
ZIP_END
) {

596 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

598 *
±a
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

599 ià(
±a
[0] !ğ
ZIP_END
) {

600 
´evËn
 = 
	`zRawEÁryL’gth
(
±a
);

605 ià(
	`zTryEncodšg
(
s
,
¦’
,&
v®ue
,&
’codšg
)) {

607 
»qËn
 = 
	`zIÁSize
(
’codšg
);

611 
»qËn
 = 
¦’
;

615 
»qËn
 +ğ
	`zP»vEncodeL’gth
(
NULL
,
´evËn
);

616 
»qËn
 +ğ
	`zEncodeL’gth
(
NULL
,
’codšg
,
¦’
);

621 
Ãxtdiff
 = (
p
[0] !ğ
ZIP_END
è? 
	`zP»vL’By‹Diff
Õ,
»qËn
) : 0;

624 
off£t
 = 
p
-
zl
;

625 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
»qËn
+
Ãxtdiff
);

626 
p
 = 
zl
+
off£t
;

629 ià(
p
[0] !ğ
ZIP_END
) {

631 
	`memmove
(
p
+
»qËn
,p-
Ãxtdiff
,
cu¾’
-
off£t
-1+nextdiff);

634 
	`zP»vEncodeL’gth
(
p
+
»qËn
,reqlen);

637 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

638 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
»qËn
);

643 
	`zEÁry
(
p
+
»qËn
, &

);

644 ià(
p
[
»qËn
+

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

645 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

646 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

650 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
p
-zl);

655 ià(
Ãxtdiff
 != 0) {

656 
off£t
 = 
p
-
zl
;

657 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
+
»qËn
);

658 
p
 = 
zl
+
off£t
;

662 
p
 +ğ
	`zP»vEncodeL’gth
Õ,
´evËn
);

663 
p
 +ğ
	`zEncodeL’gth
Õ,
’codšg
,
¦’
);

664 ià(
	`ZIP_IS_STR
(
’codšg
)) {

665 
	`memıy
(
p
,
s
,
¦’
);

667 
	`zSaveIÁeg”
(
p
,
v®ue
,
’codšg
);

669 
	`ZIPLIST_INCR_LENGTH
(
zl
,1);

670  
zl
;

671 
	}
}

688 *
	$zli¡M”ge
(**
fœ¡
, **
£cÚd
) {

690 ià(
fœ¡
 =ğ
NULL
 || *fœ¡ =ğNULL || 
£cÚd
 == NULL || *second == NULL)

691  
NULL
;

694 ià(*
fœ¡
 =ğ*
£cÚd
)

695  
NULL
;

697 
size_t
 
fœ¡_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
fœ¡
));

698 
size_t
 
fœ¡_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
fœ¡
));

700 
size_t
 
£cÚd_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
£cÚd
));

701 
size_t
 
£cÚd_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
£cÚd
));

703 
­³nd
;

704 *
sourû
, *
rg‘
;

705 
size_t
 
rg‘_by‹s
, 
sourû_by‹s
;

709 ià(
fœ¡_Ën
 >ğ
£cÚd_Ën
) {

711 
rg‘
 = *
fœ¡
;

712 
rg‘_by‹s
 = 
fœ¡_by‹s
;

713 
sourû
 = *
£cÚd
;

714 
sourû_by‹s
 = 
£cÚd_by‹s
;

715 
­³nd
 = 1;

718 
rg‘
 = *
£cÚd
;

719 
rg‘_by‹s
 = 
£cÚd_by‹s
;

720 
sourû
 = *
fœ¡
;

721 
sourû_by‹s
 = 
fœ¡_by‹s
;

722 
­³nd
 = 0;

726 
size_t
 
zlby‹s
 = 
fœ¡_by‹s
 + 
£cÚd_by‹s
 -

727 
ZIPLIST_HEADER_SIZE
 - 
ZIPLIST_END_SIZE
;

728 
size_t
 
zÎ’gth
 = 
fœ¡_Ën
 + 
£cÚd_Ën
;

731 
zÎ’gth
 = zÎ’gth < 
UINT16_MAX
 ? zllength : UINT16_MAX;

734 
size_t
 
fœ¡_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
fœ¡
));

735 
size_t
 
£cÚd_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
£cÚd
));

738 
rg‘
 = 
	`d»®loc
Ñ¬g‘, 
zlby‹s
);

739 ià(
­³nd
) {

743 
	`memıy
(
rg‘
 + 
rg‘_by‹s
 - 
ZIPLIST_END_SIZE
,

744 
sourû
 + 
ZIPLIST_HEADER_SIZE
,

745 
sourû_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

751 
	`memmove
(
rg‘
 + 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
,

752 
rg‘
 + 
ZIPLIST_HEADER_SIZE
,

753 
rg‘_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

754 
	`memıy
(
rg‘
, 
sourû
, 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
);

758 
	`ZIPLIST_BYTES
(
rg‘
èğ
	`šŒev32ifbe
(
zlby‹s
);

759 
	`ZIPLIST_LENGTH
(
rg‘
èğ
	`šŒev16ifbe
(
zÎ’gth
);

765 
	`ZIPLIST_TAIL_OFFSET
(
rg‘
èğ
	`šŒev32ifbe
(

766 (
fœ¡_by‹s
 - 
ZIPLIST_END_SIZE
) +

767 (
£cÚd_off£t
 - 
ZIPLIST_HEADER_SIZE
));

773 
rg‘
 = 
	`__zli¡CasÿdeUpd©e
Ñ¬g‘,¬g‘+
fœ¡_off£t
);

776 ià(
­³nd
) {

777 
	`dä“
(*
£cÚd
);

778 *
£cÚd
 = 
NULL
;

779 *
fœ¡
 = 
rg‘
;

781 
	`dä“
(*
fœ¡
);

782 *
fœ¡
 = 
NULL
;

783 *
£cÚd
 = 
rg‘
;

785  
rg‘
;

786 
	}
}

788 *
	$zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
) {

789 *
p
;

790 
p
 = (
wh”e
 =ğ
ZIPLIST_HEAD
è? 
	`ZIPLIST_ENTRY_HEAD
(
zl
è: 
	`ZIPLIST_ENTRY_END
(zl);

791  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

792 
	}
}

797 *
	$zli¡Index
(*
zl
, 
šdex
) {

798 *
p
;

799 
´evËnsize
, 
´evËn
 = 0;

800 ià(
šdex
 < 0) {

801 
šdex
 = (-index)-1;

802 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

803 ià(
p
[0] !ğ
ZIP_END
) {

804 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

805 
´evËn
 > 0 && 
šdex
--) {

806 
p
 -ğ
´evËn
;

807 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

811 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

812 
p
[0] !ğ
ZIP_END
 && 
šdex
--) {

813 
p
 +ğ
	`zRawEÁryL’gth
(p);

816  (
p
[0] =ğ
ZIP_END
 || 
šdex
 > 0è? 
NULL
 :…;

817 
	}
}

825 *
	$zli¡Next
(*
zl
, *
p
) {

826 ((è
zl
);

831 ià(
p
[0] =ğ
ZIP_END
) {

832  
NULL
;

835 
p
 +ğ
	`zRawEÁryL’gth
(p);

836 ià(
p
[0] =ğ
ZIP_END
) {

837  
NULL
;

840  
p
;

841 
	}
}

844 *
	$zli¡P»v
(*
zl
, *
p
) {

845 
´evËnsize
, 
´evËn
 = 0;

850 ià(
p
[0] =ğ
ZIP_END
) {

851 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

852  (
p
[0] =ğ
ZIP_END
è? 
NULL
 :…;

853 } ià(
p
 =ğ
	`ZIPLIST_ENTRY_HEAD
(
zl
)) {

854  
NULL
;

856 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

857 
	`ASSERT
(
´evËn
 > 0);

858  
p
-
´evËn
;

860 
	}
}

866 
	$zli¡G‘
(*
p
, **
s¡r
, *
¦’
, *
sv®
) {

867 
zËÁry
 
’Œy
;

868 ià(
p
 =ğ
NULL
 ||…[0] =ğ
ZIP_END
)  0;

869 ià(
s¡r
è*s¡¸ğ
NULL
;

871 
	`zEÁry
(
p
, &
’Œy
);

872 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

873 ià(
s¡r
) {

874 *
¦’
 = 
’Œy
.
Ën
;

875 *
s¡r
 = 
p
+
’Œy
.
h—d”size
;

878 ià(
sv®
) {

879 *
sv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

883 
	}
}

886 *
	$zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

887  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

888 
	}
}

893 *
	$zli¡D–‘e
(*
zl
, **
p
) {

894 
size_t
 
off£t
 = *
p
-
zl
;

895 
zl
 = 
	`__zli¡D–‘e
(zl,*
p
,1);

901 *
p
 = 
zl
+
off£t
;

902  
zl
;

903 
	}
}

906 *
	$zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
) {

907 *
p
 = 
	`zli¡Index
(
zl
,
šdex
);

908  (
p
 =ğ
NULL
è? 
zl
 : 
	`__zli¡D–‘e
(zl,p,
num
);

909 
	}
}

913 
	$zli¡Com·»
(*
p
, *
s¡r
, 
¦’
) {

914 
zËÁry
 
’Œy
;

915 
£ncodšg
;

916 
zv®
, 
sv®
;

917 ià(
p
[0] =ğ
ZIP_END
)  0;

919 
	`zEÁry
(
p
, &
’Œy
);

920 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

922 ià(
’Œy
.
Ën
 =ğ
¦’
) {

923  
	`memcmp
(
p
+
’Œy
.
h—d”size
,
s¡r
,
¦’
) == 0;

930 ià(
	`zTryEncodšg
(
s¡r
,
¦’
,&
sv®
,&
£ncodšg
)) {

931 
zv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

932  
zv®
 =ğ
sv®
;

936 
	}
}

940 *
	$zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
) {

941 
skút
 = 0;

942 
v’codšg
 = 0;

943 
vÎ
 = 0;

945 
p
[0] !ğ
ZIP_END
) {

946 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

947 *
q
;

949 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

950 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

951 
q
 = 
p
 + 
´evËnsize
 + 
Ënsize
;

953 ià(
skút
 == 0) {

955 ià(
	`ZIP_IS_STR
(
’codšg
)) {

956 ià(
Ën
 =ğ
vËn
 && 
	`memcmp
(
q
, 
v¡r
, vlen) == 0) {

957  
p
;

963 ià(
v’codšg
 == 0) {

964 ià(!
	`zTryEncodšg
(
v¡r
, 
vËn
, &
vÎ
, &
v’codšg
)) {

968 
v’codšg
 = 
UCHAR_MAX
;

971 
	`ASSERT
(
v’codšg
);

977 ià(
v’codšg
 !ğ
UCHAR_MAX
) {

978 
Î
 = 
	`zLßdIÁeg”
(
q
, 
’codšg
);

979 ià(
Î
 =ğ
vÎ
) {

980  
p
;

986 
skút
 = 
sk
;

989 
skút
--;

993 
p
 = 
q
 + 
Ën
;

996  
NULL
;

997 
	}
}

1000 
	$zli¡L’
(*
zl
) {

1001 
Ën
 = 0;

1002 ià(
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)è< 
UINT16_MAX
) {

1003 
Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
));

1005 *
p
 = 
zl
+
ZIPLIST_HEADER_SIZE
;

1006 *
p
 !ğ
ZIP_END
) {

1007 
p
 +ğ
	`zRawEÁryL’gth
(p);

1008 
Ën
++;

1012 ià(
Ën
 < 
UINT16_MAX
è
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(len);

1014  
Ën
;

1015 
	}
}

1018 
size_t
 
	$zli¡BlobL’
(*
zl
) {

1019  
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
));

1020 
	}
}

1022 
	$zli¡R•r
(*
zl
) {

1023 *
p
;

1024 
šdex
 = 0;

1025 
zËÁry
 
’Œy
;

1027 
	`´štf
(

1031 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),

1032 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)),

1033 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(
zl
)));

1034 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

1035 *
p
 !ğ
ZIP_END
) {

1036 
	`zEÁry
(
p
, &
’Œy
);

1037 
	`´štf
(

1048 ()
p
,

1049 
šdex
,

1050 (è(
p
-
zl
),

1051 
’Œy
.
h—d”size
+’Œy.
Ën
,

1052 
’Œy
.
h—d”size
,

1053 
’Œy
.
´ev¿wËn
,

1054 
’Œy
.
´ev¿wËnsize
,

1055 
’Œy
.
Ën
);

1056 
p
 +ğ
’Œy
.
h—d”size
;

1057 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1058 ià(
’Œy
.
Ën
 > 40) {

1059 ià(
	`fwr™e
(
p
,40,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1060 
	`´štf
("...");

1062 ià(
’Œy
.
Ën
 &&

1063 
	`fwr™e
(
p
,
’Œy
.
Ën
,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1066 
	`´štf
("%Îd", (è
	`zLßdIÁeg”
(
p
,
’Œy
.
’codšg
));

1068 
	`´štf
("\n");

1069 
p
 +ğ
’Œy
.
Ën
;

1070 
šdex
++;

1072 
	`´štf
("{end}\n\n");

1073 
	}
}

1075 #ifdeà
REDIS_TEST


1076 
	~<sys/time.h
>

1077 
	~"adli¡.h
"

1078 
	~"sds.h
"

1080 
	#debug
(
f
, ...è{ ià(
DEBUG
è
	`´štf
(f, 
__VA_ARGS__
); }

	)

1082 *
	$ü—‹Li¡
() {

1083 *
zl
 = 
	`zli¡New
();

1084 
zl
 = 
	`zli¡Push
(zl, (*)"foo", 3, 
ZIPLIST_TAIL
);

1085 
zl
 = 
	`zli¡Push
(zl, (*)"quux", 4, 
ZIPLIST_TAIL
);

1086 
zl
 = 
	`zli¡Push
(zl, (*)"h–lo", 5, 
ZIPLIST_HEAD
);

1087 
zl
 = 
	`zli¡Push
(zl, (*)"1024", 4, 
ZIPLIST_TAIL
);

1088  
zl
;

1089 
	}
}

1091 *
	$ü—‹IÁLi¡
() {

1092 *
zl
 = 
	`zli¡New
();

1093 
buf
[32];

1095 
	`¥rštf
(
buf
, "100");

1096 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1097 
	`¥rštf
(
buf
, "128000");

1098 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1099 
	`¥rštf
(
buf
, "-100");

1100 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1101 
	`¥rštf
(
buf
, "4294967296");

1102 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1103 
	`¥rštf
(
buf
, "non integer");

1104 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1105 
	`¥rštf
(
buf
, "much much†onger‚on integer");

1106 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1107  
zl
;

1108 
	}
}

1110 
	$u£c
() {

1111 
timev®
 
tv
;

1112 
	`g‘timeofday
(&
tv
,
NULL
);

1113  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

1114 
	}
}

1116 
	$¡»ss
(
pos
, 
num
, 
maxsize
, 
dnum
) {

1117 
i
,
j
,
k
;

1118 *
zl
;

1119 
pos¡r
[2][5] = { "HEAD", "TAIL" };

1120 
¡¬t
;

1121 
i
 = 0; i < 
maxsize
; i+=
dnum
) {

1122 
zl
 = 
	`zli¡New
();

1123 
j
 = 0; j < 
i
; j++) {

1124 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
ZIPLIST_TAIL
);

1128 
¡¬t
 = 
	`u£c
();

1129 
k
 = 0; k < 
num
; k++) {

1130 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
pos
);

1131 
zl
 = 
	`zli¡D–‘eRªge
(zl,0,1);

1133 
	`´štf
("List size: %8d, bytes: %8d, %dx…ush+pop (%s): %6lld usec\n",

1134 
i
,
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),
num
,
pos¡r
[
pos
],
	`u£c
()-
¡¬t
);

1135 
	`dä“
(
zl
);

1137 
	}
}

1139 *
	$pİ
(*
zl
, 
wh”e
) {

1140 *
p
, *
v¡r
;

1141 
vËn
;

1142 
vlÚg
;

1144 
p
 = 
	`zli¡Index
(
zl
,
wh”e
 =ğ
ZIPLIST_HEAD
 ? 0 : -1);

1145 ià(
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

1146 ià(
wh”e
 =ğ
ZIPLIST_HEAD
)

1147 
	`´štf
("Pop head: ");

1149 
	`´štf
("Popail: ");

1151 ià(
v¡r
) {

1152 ià(
vËn
 && 
	`fwr™e
(
v¡r
,vËn,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1155 
	`´štf
("%Îd", 
vlÚg
);

1158 
	`´štf
("\n");

1159  
	`zli¡D–‘e
(
zl
,&
p
);

1161 
	`´štf
("ERROR: Could‚ot…op\n");

1162 
	`ex™
(1);

1164 
	}
}

1166 
	$¿nd¡ršg
(*
rg‘
, 
mš
, 
max
) {

1167 
p
 = 0;

1168 
Ën
 = 
mš
+
	`¿nd
()%(
max
-min+1);

1169 
mšv®
, 
maxv®
;

1170 
	`¿nd
() % 3) {

1172 
mšv®
 = 0;

1173 
maxv®
 = 255;

1176 
mšv®
 = 48;

1177 
maxv®
 = 122;

1180 
mšv®
 = 48;

1181 
maxv®
 = 52;

1184 
	`ASSERT
(
NULL
);

1187 
p
 < 
Ën
)

1188 
rg‘
[
p
++] = 
mšv®
+
	`¿nd
()%(
maxv®
-minval+1);

1189  
Ën
;

1190 
	}
}

1192 
	$v”ify
(*
zl
, 
zËÁry
 *
e
) {

1193 
Ën
 = 
	`zli¡L’
(
zl
);

1194 
zËÁry
 
_e
;

1196 
	`ZIPLIST_ENTRY_ZERO
(&
_e
);

1198 
i
 = 0; i < 
Ën
; i++) {

1199 
	`mem£t
(&
e
[
i
], 0, (
zËÁry
));

1200 
	`zEÁry
(
	`zli¡Index
(
zl
, 
i
), &
e
[i]);

1202 
	`mem£t
(&
_e
, 0, (
zËÁry
));

1203 
	`zEÁry
(
	`zli¡Index
(
zl
, -
Ën
+
i
), &
_e
);

1205 
	`ASSERT
(
	`memcmp
(&
e
[
i
], &
_e
, (
zËÁry
)) == 0);

1207 
	}
}

1209 
	$zli¡Te¡
(
¬gc
, **
¬gv
) {

1210 
»t
;

1211 *
zl
, *
p
;

1212 *
’Œy
;

1213 
–’
;

1214 
v®ue
;

1217 ià(
¬gc
 == 2)

1218 
	`¤ªd
(
	`©oi
(
¬gv
[1]));

1220 
zl
 = 
	`ü—‹IÁLi¡
();

1221 
	`zli¡R•r
(
zl
);

1223 
	`dä“
(
zl
);

1225 
zl
 = 
	`ü—‹Li¡
();

1226 
	`zli¡R•r
(
zl
);

1228 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1229 
	`zli¡R•r
(
zl
);

1231 
zl
 = 
	`pİ
(zl,
ZIPLIST_HEAD
);

1232 
	`zli¡R•r
(
zl
);

1234 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1235 
	`zli¡R•r
(
zl
);

1237 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1238 
	`zli¡R•r
(
zl
);

1240 
	`dä“
(
zl
);

1242 
	`´štf
("Getƒlement‡t index 3:\n");

1244 
zl
 = 
	`ü—‹Li¡
();

1245 
p
 = 
	`zli¡Index
(
zl
, 3);

1246 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1247 
	`´štf
("ERROR: Could‚ot‡ccess index 3\n");

1250 ià(
’Œy
) {

1251 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1252 
	`´štf
("\n");

1254 
	`´štf
("%Îd\n", 
v®ue
);

1256 
	`´štf
("\n");

1257 
	`dä“
(
zl
);

1260 
	`´štf
("Getƒlement‡t index 4 (out of„ange):\n");

1262 
zl
 = 
	`ü—‹Li¡
();

1263 
p
 = 
	`zli¡Index
(
zl
, 4);

1264 ià(
p
 =ğ
NULL
) {

1265 
	`´štf
("Noƒntry\n");

1267 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1270 
	`´štf
("\n");

1271 
	`dä“
(
zl
);

1274 
	`´štf
("Getƒlement‡t index -1 (lastƒlement):\n");

1276 
zl
 = 
	`ü—‹Li¡
();

1277 
p
 = 
	`zli¡Index
(
zl
, -1);

1278 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1279 
	`´štf
("ERROR: Could‚ot‡ccess index -1\n");

1282 ià(
’Œy
) {

1283 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1284 
	`´štf
("\n");

1286 
	`´štf
("%Îd\n", 
v®ue
);

1288 
	`´štf
("\n");

1289 
	`dä“
(
zl
);

1292 
	`´štf
("Getƒlement‡t index -4 (firstƒlement):\n");

1294 
zl
 = 
	`ü—‹Li¡
();

1295 
p
 = 
	`zli¡Index
(
zl
, -4);

1296 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1297 
	`´štf
("ERROR: Could‚ot‡ccess index -4\n");

1300 ià(
’Œy
) {

1301 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1302 
	`´štf
("\n");

1304 
	`´štf
("%Îd\n", 
v®ue
);

1306 
	`´štf
("\n");

1307 
	`dä“
(
zl
);

1310 
	`´štf
("Getƒlement‡t index -5 (reverse out of„ange):\n");

1312 
zl
 = 
	`ü—‹Li¡
();

1313 
p
 = 
	`zli¡Index
(
zl
, -5);

1314 ià(
p
 =ğ
NULL
) {

1315 
	`´štf
("Noƒntry\n");

1317 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1320 
	`´štf
("\n");

1321 
	`dä“
(
zl
);

1324 
	`´štf
("Iterate†ist from 0oƒnd:\n");

1326 
zl
 = 
	`ü—‹Li¡
();

1327 
p
 = 
	`zli¡Index
(
zl
, 0);

1328 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1329 
	`´štf
("Entry: ");

1330 ià(
’Œy
) {

1331 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1333 
	`´štf
("%Îd", 
v®ue
);

1335 
p
 = 
	`zli¡Next
(
zl
,p);

1336 
	`´štf
("\n");

1338 
	`´štf
("\n");

1339 
	`dä“
(
zl
);

1342 
	`´štf
("Iterate†ist from 1oƒnd:\n");

1344 
zl
 = 
	`ü—‹Li¡
();

1345 
p
 = 
	`zli¡Index
(
zl
, 1);

1346 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1347 
	`´štf
("Entry: ");

1348 ià(
’Œy
) {

1349 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1351 
	`´štf
("%Îd", 
v®ue
);

1353 
p
 = 
	`zli¡Next
(
zl
,p);

1354 
	`´štf
("\n");

1356 
	`´štf
("\n");

1357 
	`dä“
(
zl
);

1360 
	`´štf
("Iterate†ist from 2oƒnd:\n");

1362 
zl
 = 
	`ü—‹Li¡
();

1363 
p
 = 
	`zli¡Index
(
zl
, 2);

1364 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1365 
	`´štf
("Entry: ");

1366 ià(
’Œy
) {

1367 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1369 
	`´štf
("%Îd", 
v®ue
);

1371 
p
 = 
	`zli¡Next
(
zl
,p);

1372 
	`´štf
("\n");

1374 
	`´štf
("\n");

1375 
	`dä“
(
zl
);

1378 
	`´štf
("Iterate starting out of„ange:\n");

1380 
zl
 = 
	`ü—‹Li¡
();

1381 
p
 = 
	`zli¡Index
(
zl
, 4);

1382 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1383 
	`´štf
("Noƒntry\n");

1385 
	`´štf
("ERROR\n");

1387 
	`´štf
("\n");

1388 
	`dä“
(
zl
);

1391 
	`´štf
("Iterate from backo front:\n");

1393 
zl
 = 
	`ü—‹Li¡
();

1394 
p
 = 
	`zli¡Index
(
zl
, -1);

1395 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1396 
	`´štf
("Entry: ");

1397 ià(
’Œy
) {

1398 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1400 
	`´štf
("%Îd", 
v®ue
);

1402 
p
 = 
	`zli¡P»v
(
zl
,p);

1403 
	`´štf
("\n");

1405 
	`´štf
("\n");

1406 
	`dä“
(
zl
);

1409 
	`´štf
("Iterate from backo front, deleting‡ll items:\n");

1411 
zl
 = 
	`ü—‹Li¡
();

1412 
p
 = 
	`zli¡Index
(
zl
, -1);

1413 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1414 
	`´štf
("Entry: ");

1415 ià(
’Œy
) {

1416 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1418 
	`´štf
("%Îd", 
v®ue
);

1420 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1421 
p
 = 
	`zli¡P»v
(
zl
,p);

1422 
	`´štf
("\n");

1424 
	`´štf
("\n");

1425 
	`dä“
(
zl
);

1428 
	`´štf
("Delete inclusive„ange 0,0:\n");

1430 
zl
 = 
	`ü—‹Li¡
();

1431 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 1);

1432 
	`zli¡R•r
(
zl
);

1433 
	`dä“
(
zl
);

1436 
	`´štf
("Delete inclusive„ange 0,1:\n");

1438 
zl
 = 
	`ü—‹Li¡
();

1439 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 2);

1440 
	`zli¡R•r
(
zl
);

1441 
	`dä“
(
zl
);

1444 
	`´štf
("Delete inclusive„ange 1,2:\n");

1446 
zl
 = 
	`ü—‹Li¡
();

1447 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 2);

1448 
	`zli¡R•r
(
zl
);

1449 
	`dä“
(
zl
);

1452 
	`´štf
("Delete with start index out of„ange:\n");

1454 
zl
 = 
	`ü—‹Li¡
();

1455 
zl
 = 
	`zli¡D–‘eRªge
(zl, 5, 1);

1456 
	`zli¡R•r
(
zl
);

1457 
	`dä“
(
zl
);

1460 
	`´štf
("Delete with‚um overflow:\n");

1462 
zl
 = 
	`ü—‹Li¡
();

1463 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 5);

1464 
	`zli¡R•r
(
zl
);

1465 
	`dä“
(
zl
);

1468 
	`´štf
("Delete foo while iterating:\n");

1470 
zl
 = 
	`ü—‹Li¡
();

1471 
p
 = 
	`zli¡Index
(
zl
,0);

1472 
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
)) {

1473 ià(
’Œy
 && 
	`¡ºcmp
("foo",(*ëÁry,
–’
) == 0) {

1474 
	`´štf
("Delete foo\n");

1475 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1477 
	`´štf
("Entry: ");

1478 ià(
’Œy
) {

1479 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
) == 0)

1480 
	`³¼Ü
("fwrite");

1482 
	`´štf
("%Îd",
v®ue
);

1484 
p
 = 
	`zli¡Next
(
zl
,p);

1485 
	`´štf
("\n");

1488 
	`´štf
("\n");

1489 
	`zli¡R•r
(
zl
);

1490 
	`dä“
(
zl
);

1493 
	`´štf
("Regressionest for >255 byte strings:\n");

1495 
v1
[257] = {0}, 
v2
[257] = {0};

1496 
	`mem£t
(
v1
,'x',256);

1497 
	`mem£t
(
v2
,'y',256);

1498 
zl
 = 
	`zli¡New
();

1499 
zl
 = 
	`zli¡Push
(zl,(*)
v1
,
	`¡¾’
(v1),
ZIPLIST_TAIL
);

1500 
zl
 = 
	`zli¡Push
(zl,(*)
v2
,
	`¡¾’
(v2),
ZIPLIST_TAIL
);

1503 
p
 = 
	`zli¡Index
(
zl
,0);

1504 
»t
 = ()
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
);

1505 
	`ASSERT
(
»t
 > 0);

1506 
	`ASSERT
(
	`¡ºcmp
(
v1
,(*)
’Œy
,
–’
) == 0);

1507 
p
 = 
	`zli¡Index
(
zl
,1);

1508 
»t
 = ()
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
);

1509 
	`ASSERT
(
»t
 > 0);

1510 
	`ASSERT
(
	`¡ºcmp
(
v2
,(*)
’Œy
,
–’
) == 0);

1511 
	`´štf
("SUCCESS\n\n");

1512 
	`dä“
(
zl
);

1515 
	`´štf
("Regressionest deleting‚exto†astƒntries:\n");

1517 
v
[3][257] = {{0}};

1518 
zËÁry
 
e
[3] = {{.
´ev¿wËnsize
 = 0, .
´ev¿wËn
 = 0, .
Ënsize
 = 0,

1519 .
Ën
 = 0, .
h—d”size
 = 0, .
’codšg
 = 0, .
p
 = 
NULL
}};

1520 
size_t
 
i
;

1522 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1523 
	`mem£t
(
v
[
i
], 'a' + i, (v[0]));

1526 
v
[0][256] = '\0';

1527 
v
[1][ 1] = '\0';

1528 
v
[2][256] = '\0';

1530 
zl
 = 
	`zli¡New
();

1531 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1532 
zl
 = 
	`zli¡Push
(zl, (*è
v
[
i
], 
	`¡¾’
(v[i]), 
ZIPLIST_TAIL
);

1535 
	`v”ify
(
zl
, 
e
);

1537 
	`ASSERT
(
e
[0].
´ev¿wËnsize
 == 1);

1538 
	`ASSERT
(
e
[1].
´ev¿wËnsize
 == 5);

1539 
	`ASSERT
(
e
[2].
´ev¿wËnsize
 == 1);

1542 *
p
 = 
e
[1].p;

1543 
zl
 = 
	`zli¡D–‘e
(zl, &
p
);

1545 
	`v”ify
(
zl
, 
e
);

1547 
	`ASSERT
(
e
[0].
´ev¿wËnsize
 == 1);

1548 
	`ASSERT
(
e
[1].
´ev¿wËnsize
 == 5);

1550 
	`´štf
("SUCCESS\n\n");

1551 
	`dä“
(
zl
);

1554 
	`´štf
("Create†ong†ist‡nd check indices:\n");

1556 
zl
 = 
	`zli¡New
();

1557 
buf
[32];

1558 
i
,
Ën
;

1559 
i
 = 0; i < 1000; i++) {

1560 
Ën
 = 
	`¥rštf
(
buf
,"%d",
i
);

1561 
zl
 = 
	`zli¡Push
(zl,(*)
buf
,
Ën
,
ZIPLIST_TAIL
);

1563 
i
 = 0; i < 1000; i++) {

1564 
p
 = 
	`zli¡Index
(
zl
,
i
);

1565 
»t
 = ()
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
);

1566 
	`ASSERT
(
»t
 > 0);

1567 
	`ASSERT
(
i
 =ğ
v®ue
);

1569 
p
 = 
	`zli¡Index
(
zl
,-
i
-1);

1570 
»t
 = ()
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
);

1571 
	`ASSERT
(
»t
 > 0);

1572 
	`ASSERT
(999-
i
 =ğ
v®ue
);

1574 
	`´štf
("SUCCESS\n\n");

1575 
	`dä“
(
zl
);

1578 
	`´štf
("Compare strings with ziplistƒntries:\n");

1580 
zl
 = 
	`ü—‹Li¡
();

1581 
p
 = 
	`zli¡Index
(
zl
,0);

1582 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1583 
	`´štf
("ERROR:‚ot \"hello\"\n");

1586 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1587 
	`´štf
("ERROR: \"hella\"\n");

1591 
p
 = 
	`zli¡Index
(
zl
,3);

1592 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1593 
	`´štf
("ERROR:‚ot \"1024\"\n");

1596 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1597 
	`´štf
("ERROR: \"1025\"\n");

1600 
	`´štf
("SUCCESS\n\n");

1601 
	`dä“
(
zl
);

1604 
	`´štf
("Mergeest:\n");

1607 
zl
 = 
	`ü—‹Li¡
();

1608 *
zl2
 = 
	`ü—‹Li¡
();

1610 *
zl3
 = 
	`zli¡New
();

1611 *
zl4
 = 
	`zli¡New
();

1613 ià(
	`zli¡M”ge
(&
zl4
, &zl4)) {

1614 
	`´štf
("ERROR: Allowed merging of one ziplist into itself.\n");

1619 
zl4
 = 
	`zli¡M”ge
(&
zl3
, &zl4);

1620 
	`zli¡R•r
(
zl4
);

1621 ià(
	`zli¡L’
(
zl4
)) {

1622 
	`´štf
("ERROR: Mergingwoƒmpty ziplists createdƒntries.\n");

1625 
	`dä“
(
zl4
);

1627 
zl2
 = 
	`zli¡M”ge
(&
zl
, &zl2);

1629 
	`zli¡R•r
(
zl2
);

1631 ià(
	`zli¡L’
(
zl2
) != 8) {

1632 
	`´štf
("ERROR: M”ged†’gth‚Ù 8, but: %u\n", 
	`zli¡L’
(
zl2
));

1636 
p
 = 
	`zli¡Index
(
zl2
,0);

1637 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1638 
	`´štf
("ERROR:‚ot \"hello\"\n");

1641 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1642 
	`´štf
("ERROR: \"hella\"\n");

1646 
p
 = 
	`zli¡Index
(
zl2
,3);

1647 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1648 
	`´štf
("ERROR:‚ot \"1024\"\n");

1651 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1652 
	`´štf
("ERROR: \"1025\"\n");

1656 
p
 = 
	`zli¡Index
(
zl2
,4);

1657 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1658 
	`´štf
("ERROR:‚ot \"hello\"\n");

1661 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1662 
	`´štf
("ERROR: \"hella\"\n");

1666 
p
 = 
	`zli¡Index
(
zl2
,7);

1667 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1668 
	`´štf
("ERROR:‚ot \"1024\"\n");

1671 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1672 
	`´štf
("ERROR: \"1025\"\n");

1675 
	`´štf
("SUCCESS\n\n");

1676 
	`dä“
(
zl
);

1679 
	`´štf
("Stress with„andom…ayloads of differentƒncoding:\n");

1681 
i
,
j
,
Ën
,
wh”e
;

1682 *
p
;

1683 
buf
[1024];

1684 
buæ’
;

1685 
dli¡
 *
»f
;

1686 
dli¡Node
 *
»âode
;

1689 *
s¡r
;

1690 
¦’
;

1691 
sv®
;

1693 
i
 = 0; i < 20000; i++) {

1694 
zl
 = 
	`zli¡New
();

1695 
»f
 = 
	`dli¡C»©e
();

1696 
	`dli¡S‘F»eM‘hod
(
»f
,((*)(*))
sdsä“
);

1697 
Ën
 = 
	`¿nd
() % 256;

1700 
j
 = 0; j < 
Ën
; j++) {

1701 
wh”e
 = (
	`¿nd
(è& 1è? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
;

1702 ià(
	`¿nd
() % 2) {

1703 
buæ’
 = 
	`¿nd¡ršg
(
buf
,1,(buf)-1);

1705 
	`¿nd
() % 3) {

1707 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) >> 20);

1710 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()));

1713 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) << 20);

1716 
	`ASSERT
(
NULL
);

1721 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
buæ’
, 
wh”e
);

1724 ià(
wh”e
 =ğ
ZIPLIST_HEAD
) {

1725 
	`dli¡AddNodeH—d
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1726 } ià(
wh”e
 =ğ
ZIPLIST_TAIL
) {

1727 
	`dli¡AddNodeTa
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1729 
	`ASSERT
(
NULL
);

1733 
	`ASSERT
(
	`dli¡L’gth
(
»f
è=ğ
	`zli¡L’
(
zl
));

1734 
j
 = 0; j < 
Ën
; j++) {

1737 
p
 = 
	`zli¡Index
(
zl
,
j
);

1738 
»âode
 = 
	`dli¡Index
(
»f
,
j
);

1740 
»t
 = ()
	`zli¡G‘
(
p
,&
s¡r
,&
¦’
,&
sv®
);

1741 
	`ASSERT
(
»t
 > 0);

1742 ià(
s¡r
 =ğ
NULL
) {

1743 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",
sv®
);

1745 
buæ’
 = 
¦’
;

1746 
	`memıy
(
buf
,
s¡r
,
buæ’
);

1747 
buf
[
buæ’
] = '\0';

1749 
	`ASSERT
(
	`memcmp
(
buf
,
	`dli¡NodeV®ue
(
»âode
),
buæ’
) == 0);

1751 
	`dä“
(
zl
);

1752 
	`dli¡R–—£
(
»f
);

1754 
	`´štf
("SUCCESS\n\n");

1757 
	`´štf
("Stress with variable ziplist size:\n");

1759 
	`¡»ss
(
ZIPLIST_HEAD
,100000,16384,256);

1760 
	`¡»ss
(
ZIPLIST_TAIL
,100000,16384,256);

1764 
	}
}

	@src/vr_ziplist.c

104 
	~<¡dio.h
>

105 
	~<¡dlib.h
>

106 
	~<¡ršg.h
>

107 
	~<¡dšt.h
>

108 
	~<lim™s.h
>

110 
	~<vr_cÜe.h
>

112 
	#ZIP_END
 255

	)

113 
	#ZIP_BIGLEN
 254

	)

116 
	#ZIP_STR_MASK
 0xc0

	)

117 
	#ZIP_INT_MASK
 0x30

	)

118 
	#ZIP_STR_06B
 (0 << 6)

	)

119 
	#ZIP_STR_14B
 (1 << 6)

	)

120 
	#ZIP_STR_32B
 (2 << 6)

	)

121 
	#ZIP_INT_16B
 (0xc0 | 0<<4)

	)

122 
	#ZIP_INT_32B
 (0xc0 | 1<<4)

	)

123 
	#ZIP_INT_64B
 (0xc0 | 2<<4)

	)

124 
	#ZIP_INT_24B
 (0xc0 | 3<<4)

	)

125 
	#ZIP_INT_8B
 0xã

	)

127 
	#ZIP_INT_IMM_MASK
 0x0f

	)

128 
	#ZIP_INT_IMM_MIN
 0xf1

	)

129 
	#ZIP_INT_IMM_MAX
 0xfd

	)

130 
	#ZIP_INT_IMM_VAL
(
v
è(v & 
ZIP_INT_IMM_MASK
)

	)

132 
	#INT24_MAX
 0x7fffff

	)

133 
	#INT24_MIN
 (-
INT24_MAX
 - 1)

	)

136 
	#ZIP_IS_STR
(
’c
è((Óncè& 
ZIP_STR_MASK
è< ZIP_STR_MASK)

	)

139 
	#ZIPLIST_BYTES
(
zl
è(*((
ušt32_t
*)(zl)))

	)

140 
	#ZIPLIST_TAIL_OFFSET
(
zl
è(*((
ušt32_t
*)((zl)+(ušt32_t))))

	)

141 
	#ZIPLIST_LENGTH
(
zl
è(*((
ušt16_t
*)((zl)+(
ušt32_t
)*2)))

	)

142 
	#ZIPLIST_HEADER_SIZE
 ((
ušt32_t
)*2+(
ušt16_t
))

	)

143 
	#ZIPLIST_END_SIZE
 ((
ušt8_t
))

	)

144 
	#ZIPLIST_ENTRY_HEAD
(
zl
è((zl)+
ZIPLIST_HEADER_SIZE
)

	)

145 
	#ZIPLIST_ENTRY_TAIL
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl)))

	)

146 
	#ZIPLIST_ENTRY_END
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-1)

	)

150 
	#ZIPLIST_INCR_LENGTH
(
zl
,
šü
) { \

151 ià(
	`ZIPLIST_LENGTH
(
zl
è< 
UINT16_MAX
) \

152 
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(šŒev16ifbe(ZIPLIST_LENGTH(zl))+
šü
); \

153 }

	)

155 
	szËÁry
 {

156 
	m´ev¿wËnsize
, 
	m´ev¿wËn
;

157 
	mËnsize
, 
	mËn
;

158 
	mh—d”size
;

159 
	m’codšg
;

160 *
	mp
;

161 } 
	tzËÁry
;

163 
	#ZIPLIST_ENTRY_ZERO
(
zË
) { \

164 (
zË
)->
´ev¿wËnsize
 = (zË)->
´ev¿wËn
 = 0; \

165 (
zË
)->
Ënsize
 = (zË)->
Ën
 = (zË)->
h—d”size
 = 0; \

166 (
zË
)->
’codšg
 = 0; \

167 (
zË
)->
p
 = 
NULL
; \

168 }

	)

172 
	#ZIP_ENTRY_ENCODING
(
±r
, 
’codšg
) do { \

173 (
’codšg
èğ(
±r
[0]); \

174 ià((
’codšg
è< 
ZIP_STR_MASK
) (encoding) &= ZIP_STR_MASK; \

175 } 0)

	)

177 
zli¡R•r
(*
zl
);

180 
	$zIÁSize
(
’codšg
) {

181 
’codšg
) {

182 
ZIP_INT_8B
:  1;

183 
ZIP_INT_16B
:  2;

184 
ZIP_INT_24B
:  3;

185 
ZIP_INT_32B
:  4;

186 
ZIP_INT_64B
:  8;

189 
	`ASSERT
(
NULL
);

191 
	}
}

195 
	$zEncodeL’gth
(*
p
, 
’codšg
, 
¿wËn
) {

196 
Ën
 = 1, 
buf
[5];

198 ià(
	`ZIP_IS_STR
(
’codšg
)) {

201 ià(
¿wËn
 <= 0x3f) {

202 ià(!
p
è 
Ën
;

203 
buf
[0] = 
ZIP_STR_06B
 | 
¿wËn
;

204 } ià(
¿wËn
 <= 0x3fff) {

205 
Ën
 += 1;

206 ià(!
p
è 
Ën
;

207 
buf
[0] = 
ZIP_STR_14B
 | ((
¿wËn
 >> 8) & 0x3f);

208 
buf
[1] = 
¿wËn
 & 0xff;

210 
Ën
 += 4;

211 ià(!
p
è 
Ën
;

212 
buf
[0] = 
ZIP_STR_32B
;

213 
buf
[1] = (
¿wËn
 >> 24) & 0xff;

214 
buf
[2] = (
¿wËn
 >> 16) & 0xff;

215 
buf
[3] = (
¿wËn
 >> 8) & 0xff;

216 
buf
[4] = 
¿wËn
 & 0xff;

220 ià(!
p
è 
Ën
;

221 
buf
[0] = 
’codšg
;

225 
	`memıy
(
p
,
buf
,
Ën
);

226  
Ën
;

227 
	}
}

233 
	#ZIP_DECODE_LENGTH
(
±r
, 
’codšg
, 
Ënsize
, 
Ën
) do { \

234 
	`ZIP_ENTRY_ENCODING
((
±r
), (
’codšg
)); \

235 ià((
’codšg
è< 
ZIP_STR_MASK
) { \

236 ià((
’codšg
è=ğ
ZIP_STR_06B
) { \

237 (
Ënsize
) = 1; \

238 (
Ën
èğ(
±r
)[0] & 0x3f; \

239 } ià((
’codšg
è=ğ
ZIP_STR_14B
) { \

240 (
Ënsize
) = 2; \

241 (
Ën
èğ(((
±r
)[0] & 0x3f) << 8) | (ptr)[1]; \

242 } ià(
’codšg
 =ğ
ZIP_STR_32B
) { \

243 (
Ënsize
) = 5; \

244 (
Ën
èğ((
±r
)[1] << 24) | \

245 ((
±r
)[2] << 16) | \

246 ((
±r
)[3] << 8) | \

247 ((
±r
)[4]); \

249 
	`ASSERT
(
NULL
); \

252 (
Ënsize
) = 1; \

253 (
Ën
èğ
	`zIÁSize
(
’codšg
); \

255 } 0);

	)

259 
	$zP»vEncodeL’gth
(*
p
, 
Ën
) {

260 ià(
p
 =ğ
NULL
) {

261  (
Ën
 < 
ZIP_BIGLEN
) ? 1 : (len)+1;

263 ià(
Ën
 < 
ZIP_BIGLEN
) {

264 
p
[0] = 
Ën
;

267 
p
[0] = 
ZIP_BIGLEN
;

268 
	`memıy
(
p
+1,&
Ën
,(len));

269 
	`mem»v32ifbe
(
p
+1);

270  1+(
Ën
);

273 
	}
}

277 
	$zP»vEncodeL’gthFÜûL¬ge
(*
p
, 
Ën
) {

278 ià(
p
 =ğ
NULL
) ;

279 
p
[0] = 
ZIP_BIGLEN
;

280 
	`memıy
(
p
+1,&
Ën
,(len));

281 
	`mem»v32ifbe
(
p
+1);

282 
	}
}

286 
	#ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
) do { \

287 ià((
±r
)[0] < 
ZIP_BIGLEN
) { \

288 (
´evËnsize
) = 1; \

290 (
´evËnsize
) = 5; \

292 } 0);

	)

296 
	#ZIP_DECODE_PREVLEN
(
±r
, 
´evËnsize
, 
´evËn
) do { \

297 
	`ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
); \

298 ià((
´evËnsize
) == 1) { \

299 (
´evËn
èğ(
±r
)[0]; \

300 } ià((
´evËnsize
) == 5) { \

301 
	`ASSERT
(((
´evËnsize
)) == 4); \

302 
	`memıy
(&(
´evËn
), ((*)(
±r
)) + 1, 4); \

303 
	`mem»v32ifbe
(&
´evËn
); \

305 } 0);

	)

309 
	$zP»vL’By‹Diff
(*
p
, 
Ën
) {

310 
´evËnsize
;

311 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

312  
	`zP»vEncodeL’gth
(
NULL
, 
Ën
è- 
´evËnsize
;

313 
	}
}

316 
	$zRawEÁryL’gth
(*
p
) {

317 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

318 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

319 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

320  
´evËnsize
 + 
Ënsize
 + 
Ën
;

321 
	}
}

325 
	$zTryEncodšg
(*
’Œy
, 
’ŒyËn
, *
v
, *
’codšg
) {

326 
v®ue
;

328 ià(
’ŒyËn
 >= 32 ||ƒntrylen == 0)  0;

329 ià(
	`¡ršg2Î
((*)
’Œy
,
’ŒyËn
,&
v®ue
)) {

332 ià(
v®ue
 >= 0 && value <= 12) {

333 *
’codšg
 = 
ZIP_INT_IMM_MIN
+
v®ue
;

334 } ià(
v®ue
 >ğ
INT8_MIN
 && v®u<ğ
INT8_MAX
) {

335 *
’codšg
 = 
ZIP_INT_8B
;

336 } ià(
v®ue
 >ğ
INT16_MIN
 && v®u<ğ
INT16_MAX
) {

337 *
’codšg
 = 
ZIP_INT_16B
;

338 } ià(
v®ue
 >ğ
INT24_MIN
 && v®u<ğ
INT24_MAX
) {

339 *
’codšg
 = 
ZIP_INT_24B
;

340 } ià(
v®ue
 >ğ
INT32_MIN
 && v®u<ğ
INT32_MAX
) {

341 *
’codšg
 = 
ZIP_INT_32B
;

343 *
’codšg
 = 
ZIP_INT_64B
;

345 *
v
 = 
v®ue
;

349 
	}
}

352 
	$zSaveIÁeg”
(*
p
, 
št64_t
 
v®ue
, 
’codšg
) {

353 
št16_t
 
i16
;

354 
št32_t
 
i32
;

355 
št64_t
 
i64
;

356 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

357 ((
št8_t
*)
p
)[0] = (št8_t)
v®ue
;

358 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

359 
i16
 = 
v®ue
;

360 
	`memıy
(
p
,&
i16
,(i16));

361 
	`mem»v16ifbe
(
p
);

362 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

363 
i32
 = 
v®ue
<<8;

364 
	`mem»v32ifbe
(&
i32
);

365 
	`memıy
(
p
,((
ušt8_t
*)&
i32
)+1,(i32)-(uint8_t));

366 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

367 
i32
 = 
v®ue
;

368 
	`memıy
(
p
,&
i32
,(i32));

369 
	`mem»v32ifbe
(
p
);

370 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

371 
i64
 = 
v®ue
;

372 
	`memıy
(
p
,&
i64
,(i64));

373 
	`mem»v64ifbe
(
p
);

374 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

377 
	`ASSERT
(
NULL
);

379 
	}
}

382 
št64_t
 
	$zLßdIÁeg”
(*
p
, 
’codšg
) {

383 
št16_t
 
i16
;

384 
št32_t
 
i32
;

385 
št64_t
 
i64
, 
»t
 = 0;

386 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

387 
»t
 = ((
št8_t
*)
p
)[0];

388 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

389 
	`memıy
(&
i16
,
p
,(i16));

390 
	`mem»v16ifbe
(&
i16
);

391 
»t
 = 
i16
;

392 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

393 
	`memıy
(&
i32
,
p
,(i32));

394 
	`mem»v32ifbe
(&
i32
);

395 
»t
 = 
i32
;

396 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

397 
i32
 = 0;

398 
	`memıy
(((
ušt8_t
*)&
i32
)+1,
p
,(i32)-(uint8_t));

399 
	`mem»v32ifbe
(&
i32
);

400 
»t
 = 
i32
>>8;

401 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

402 
	`memıy
(&
i64
,
p
,(i64));

403 
	`mem»v64ifbe
(&
i64
);

404 
»t
 = 
i64
;

405 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

406 
»t
 = (
’codšg
 & 
ZIP_INT_IMM_MASK
)-1;

408 
	`ASSERT
(
NULL
);

410  
»t
;

411 
	}
}

414 
	$zEÁry
(*
p
, 
zËÁry
 *
e
) {

416 
	`ZIP_DECODE_PREVLEN
(
p
, 
e
->
´ev¿wËnsize
,ƒ->
´ev¿wËn
);

417 
	`ZIP_DECODE_LENGTH
(
p
 + 
e
->
´ev¿wËnsize
,ƒ->
’codšg
,ƒ->
Ënsize
,ƒ->
Ën
);

418 
e
->
h—d”size
 =ƒ->
´ev¿wËnsize
 +ƒ->
Ënsize
;

419 
e
->
p
 =…;

420 
	}
}

423 *
	$zli¡New
() {

424 
by‹s
 = 
ZIPLIST_HEADER_SIZE
+1;

425 *
zl
 = 
	`d®loc
(
by‹s
);

426 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
by‹s
);

427 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
ZIPLIST_HEADER_SIZE
);

428 
	`ZIPLIST_LENGTH
(
zl
) = 0;

429 
zl
[
by‹s
-1] = 
ZIP_END
;

430  
zl
;

431 
	}
}

434 *
	$zli¡Resize
(*
zl
, 
Ën
) {

435 
zl
 = 
	`d»®loc
(zl,
Ën
);

436 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
Ën
);

437 
zl
[
Ën
-1] = 
ZIP_END
;

438  
zl
;

439 
	}
}

461 *
	$__zli¡CasÿdeUpd©e
(*
zl
, *
p
) {

462 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
¿wËn
, 
¿wËnsize
;

463 
size_t
 
off£t
, 
noff£t
, 
exŒa
;

464 *
Å
;

465 
zËÁry
 
cur
, 
Ãxt
;

467 
p
[0] !ğ
ZIP_END
) {

468 
	`zEÁry
(
p
, &
cur
);

469 
¿wËn
 = 
cur
.
h—d”size
 + cur.
Ën
;

470 
¿wËnsize
 = 
	`zP»vEncodeL’gth
(
NULL
,
¿wËn
);

473 ià(
p
[
¿wËn
] =ğ
ZIP_END
) ;

474 
	`zEÁry
(
p
+
¿wËn
, &
Ãxt
);

477 ià(
Ãxt
.
´ev¿wËn
 =ğ
¿wËn
) ;

479 ià(
Ãxt
.
´ev¿wËnsize
 < 
¿wËnsize
) {

482 
off£t
 = 
p
-
zl
;

483 
exŒa
 = 
¿wËnsize
-
Ãxt
.
´ev¿wËnsize
;

484 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
exŒa
);

485 
p
 = 
zl
+
off£t
;

488 
Å
 = 
p
+
¿wËn
;

489 
noff£t
 = 
Å
-
zl
;

492 ià((
zl
+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl))è!ğ
Å
) {

493 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

494 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
exŒa
);

498 
	`memmove
(
Å
+
¿wËnsize
,

499 
Å
+
Ãxt
.
´ev¿wËnsize
,

500 
cu¾’
-
noff£t
-
Ãxt
.
´ev¿wËnsize
-1);

501 
	`zP»vEncodeL’gth
(
Å
,
¿wËn
);

504 
p
 +ğ
¿wËn
;

505 
cu¾’
 +ğ
exŒa
;

507 ià(
Ãxt
.
´ev¿wËnsize
 > 
¿wËnsize
) {

510 
	`zP»vEncodeL’gthFÜûL¬ge
(
p
+
¿wËn
,rawlen);

512 
	`zP»vEncodeL’gth
(
p
+
¿wËn
,rawlen);

519  
zl
;

520 
	}
}

523 *
	$__zli¡D–‘e
(*
zl
, *
p
, 
num
) {

524 
i
, 
tÙËn
, 
d–‘ed
 = 0;

525 
size_t
 
off£t
;

526 
Ãxtdiff
 = 0;

527 
zËÁry
 
fœ¡
, 

;

529 
	`zEÁry
(
p
, &
fœ¡
);

530 
i
 = 0; 
p
[0] !ğ
ZIP_END
 && i < 
num
; i++) {

531 
p
 +ğ
	`zRawEÁryL’gth
(p);

532 
d–‘ed
++;

535 
tÙËn
 = 
p
-
fœ¡
.p;

536 ià(
tÙËn
 > 0) {

537 ià(
p
[0] !ğ
ZIP_END
) {

542 
Ãxtdiff
 = 
	`zP»vL’By‹Diff
(
p
,
fœ¡
.
´ev¿wËn
);

543 
p
 -ğ
Ãxtdiff
;

544 
	`zP»vEncodeL’gth
(
p
,
fœ¡
.
´ev¿wËn
);

547 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

548 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))-
tÙËn
);

553 
	`zEÁry
(
p
, &

);

554 ià(
p
[

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

555 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

556 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

560 
	`memmove
(
fœ¡
.
p
,p,

561 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
))-(
p
-zl)-1);

564 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

565 
	`šŒev32ifbe
((
fœ¡
.
p
-
zl
)-fœ¡.
´ev¿wËn
);

569 
off£t
 = 
fœ¡
.
p
-
zl
;

570 
zl
 = 
	`zli¡Resize
(zl, 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-
tÙËn
+
Ãxtdiff
);

571 
	`ZIPLIST_INCR_LENGTH
(
zl
,-
d–‘ed
);

572 
p
 = 
zl
+
off£t
;

576 ià(
Ãxtdiff
 != 0)

577 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
);

579  
zl
;

580 
	}
}

583 *
	$__zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

584 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
»qËn
;

585 
´evËnsize
, 
´evËn
 = 0;

586 
size_t
 
off£t
;

587 
Ãxtdiff
 = 0;

588 
’codšg
 = 0;

589 
v®ue
 = 123456789;

592 
zËÁry
 

;

595 ià(
p
[0] !ğ
ZIP_END
) {

596 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

598 *
±a
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

599 ià(
±a
[0] !ğ
ZIP_END
) {

600 
´evËn
 = 
	`zRawEÁryL’gth
(
±a
);

605 ià(
	`zTryEncodšg
(
s
,
¦’
,&
v®ue
,&
’codšg
)) {

607 
»qËn
 = 
	`zIÁSize
(
’codšg
);

611 
»qËn
 = 
¦’
;

615 
»qËn
 +ğ
	`zP»vEncodeL’gth
(
NULL
,
´evËn
);

616 
»qËn
 +ğ
	`zEncodeL’gth
(
NULL
,
’codšg
,
¦’
);

621 
Ãxtdiff
 = (
p
[0] !ğ
ZIP_END
è? 
	`zP»vL’By‹Diff
Õ,
»qËn
) : 0;

624 
off£t
 = 
p
-
zl
;

625 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
»qËn
+
Ãxtdiff
);

626 
p
 = 
zl
+
off£t
;

629 ià(
p
[0] !ğ
ZIP_END
) {

631 
	`memmove
(
p
+
»qËn
,p-
Ãxtdiff
,
cu¾’
-
off£t
-1+nextdiff);

634 
	`zP»vEncodeL’gth
(
p
+
»qËn
,reqlen);

637 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

638 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
»qËn
);

643 
	`zEÁry
(
p
+
»qËn
, &

);

644 ià(
p
[
»qËn
+

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

645 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

646 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

650 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
p
-zl);

655 ià(
Ãxtdiff
 != 0) {

656 
off£t
 = 
p
-
zl
;

657 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
+
»qËn
);

658 
p
 = 
zl
+
off£t
;

662 
p
 +ğ
	`zP»vEncodeL’gth
Õ,
´evËn
);

663 
p
 +ğ
	`zEncodeL’gth
Õ,
’codšg
,
¦’
);

664 ià(
	`ZIP_IS_STR
(
’codšg
)) {

665 
	`memıy
(
p
,
s
,
¦’
);

667 
	`zSaveIÁeg”
(
p
,
v®ue
,
’codšg
);

669 
	`ZIPLIST_INCR_LENGTH
(
zl
,1);

670  
zl
;

671 
	}
}

688 *
	$zli¡M”ge
(**
fœ¡
, **
£cÚd
) {

690 ià(
fœ¡
 =ğ
NULL
 || *fœ¡ =ğNULL || 
£cÚd
 == NULL || *second == NULL)

691  
NULL
;

694 ià(*
fœ¡
 =ğ*
£cÚd
)

695  
NULL
;

697 
size_t
 
fœ¡_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
fœ¡
));

698 
size_t
 
fœ¡_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
fœ¡
));

700 
size_t
 
£cÚd_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
£cÚd
));

701 
size_t
 
£cÚd_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
£cÚd
));

703 
­³nd
;

704 *
sourû
, *
rg‘
;

705 
size_t
 
rg‘_by‹s
, 
sourû_by‹s
;

709 ià(
fœ¡_Ën
 >ğ
£cÚd_Ën
) {

711 
rg‘
 = *
fœ¡
;

712 
rg‘_by‹s
 = 
fœ¡_by‹s
;

713 
sourû
 = *
£cÚd
;

714 
sourû_by‹s
 = 
£cÚd_by‹s
;

715 
­³nd
 = 1;

718 
rg‘
 = *
£cÚd
;

719 
rg‘_by‹s
 = 
£cÚd_by‹s
;

720 
sourû
 = *
fœ¡
;

721 
sourû_by‹s
 = 
fœ¡_by‹s
;

722 
­³nd
 = 0;

726 
size_t
 
zlby‹s
 = 
fœ¡_by‹s
 + 
£cÚd_by‹s
 -

727 
ZIPLIST_HEADER_SIZE
 - 
ZIPLIST_END_SIZE
;

728 
size_t
 
zÎ’gth
 = 
fœ¡_Ën
 + 
£cÚd_Ën
;

731 
zÎ’gth
 = zÎ’gth < 
UINT16_MAX
 ? zllength : UINT16_MAX;

734 
size_t
 
fœ¡_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
fœ¡
));

735 
size_t
 
£cÚd_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
£cÚd
));

738 
rg‘
 = 
	`d»®loc
Ñ¬g‘, 
zlby‹s
);

739 ià(
­³nd
) {

743 
	`memıy
(
rg‘
 + 
rg‘_by‹s
 - 
ZIPLIST_END_SIZE
,

744 
sourû
 + 
ZIPLIST_HEADER_SIZE
,

745 
sourû_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

751 
	`memmove
(
rg‘
 + 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
,

752 
rg‘
 + 
ZIPLIST_HEADER_SIZE
,

753 
rg‘_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

754 
	`memıy
(
rg‘
, 
sourû
, 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
);

758 
	`ZIPLIST_BYTES
(
rg‘
èğ
	`šŒev32ifbe
(
zlby‹s
);

759 
	`ZIPLIST_LENGTH
(
rg‘
èğ
	`šŒev16ifbe
(
zÎ’gth
);

765 
	`ZIPLIST_TAIL_OFFSET
(
rg‘
èğ
	`šŒev32ifbe
(

766 (
fœ¡_by‹s
 - 
ZIPLIST_END_SIZE
) +

767 (
£cÚd_off£t
 - 
ZIPLIST_HEADER_SIZE
));

773 
rg‘
 = 
	`__zli¡CasÿdeUpd©e
Ñ¬g‘,¬g‘+
fœ¡_off£t
);

776 ià(
­³nd
) {

777 
	`dä“
(*
£cÚd
);

778 *
£cÚd
 = 
NULL
;

779 *
fœ¡
 = 
rg‘
;

781 
	`dä“
(*
fœ¡
);

782 *
fœ¡
 = 
NULL
;

783 *
£cÚd
 = 
rg‘
;

785  
rg‘
;

786 
	}
}

788 *
	$zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
) {

789 *
p
;

790 
p
 = (
wh”e
 =ğ
ZIPLIST_HEAD
è? 
	`ZIPLIST_ENTRY_HEAD
(
zl
è: 
	`ZIPLIST_ENTRY_END
(zl);

791  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

792 
	}
}

797 *
	$zli¡Index
(*
zl
, 
šdex
) {

798 *
p
;

799 
´evËnsize
, 
´evËn
 = 0;

800 ià(
šdex
 < 0) {

801 
šdex
 = (-index)-1;

802 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

803 ià(
p
[0] !ğ
ZIP_END
) {

804 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

805 
´evËn
 > 0 && 
šdex
--) {

806 
p
 -ğ
´evËn
;

807 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

811 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

812 
p
[0] !ğ
ZIP_END
 && 
šdex
--) {

813 
p
 +ğ
	`zRawEÁryL’gth
(p);

816  (
p
[0] =ğ
ZIP_END
 || 
šdex
 > 0è? 
NULL
 :…;

817 
	}
}

825 *
	$zli¡Next
(*
zl
, *
p
) {

826 ((è
zl
);

831 ià(
p
[0] =ğ
ZIP_END
) {

832  
NULL
;

835 
p
 +ğ
	`zRawEÁryL’gth
(p);

836 ià(
p
[0] =ğ
ZIP_END
) {

837  
NULL
;

840  
p
;

841 
	}
}

844 *
	$zli¡P»v
(*
zl
, *
p
) {

845 
´evËnsize
, 
´evËn
 = 0;

850 ià(
p
[0] =ğ
ZIP_END
) {

851 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

852  (
p
[0] =ğ
ZIP_END
è? 
NULL
 :…;

853 } ià(
p
 =ğ
	`ZIPLIST_ENTRY_HEAD
(
zl
)) {

854  
NULL
;

856 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

857 
	`ASSERT
(
´evËn
 > 0);

858  
p
-
´evËn
;

860 
	}
}

866 
	$zli¡G‘
(*
p
, **
s¡r
, *
¦’
, *
sv®
) {

867 
zËÁry
 
’Œy
;

868 ià(
p
 =ğ
NULL
 ||…[0] =ğ
ZIP_END
)  0;

869 ià(
s¡r
è*s¡¸ğ
NULL
;

871 
	`zEÁry
(
p
, &
’Œy
);

872 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

873 ià(
s¡r
) {

874 *
¦’
 = 
’Œy
.
Ën
;

875 *
s¡r
 = 
p
+
’Œy
.
h—d”size
;

878 ià(
sv®
) {

879 *
sv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

883 
	}
}

886 *
	$zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

887  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

888 
	}
}

893 *
	$zli¡D–‘e
(*
zl
, **
p
) {

894 
size_t
 
off£t
 = *
p
-
zl
;

895 
zl
 = 
	`__zli¡D–‘e
(zl,*
p
,1);

901 *
p
 = 
zl
+
off£t
;

902  
zl
;

903 
	}
}

906 *
	$zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
) {

907 *
p
 = 
	`zli¡Index
(
zl
,
šdex
);

908  (
p
 =ğ
NULL
è? 
zl
 : 
	`__zli¡D–‘e
(zl,p,
num
);

909 
	}
}

913 
	$zli¡Com·»
(*
p
, *
s¡r
, 
¦’
) {

914 
zËÁry
 
’Œy
;

915 
£ncodšg
;

916 
zv®
, 
sv®
;

917 ià(
p
[0] =ğ
ZIP_END
)  0;

919 
	`zEÁry
(
p
, &
’Œy
);

920 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

922 ià(
’Œy
.
Ën
 =ğ
¦’
) {

923  
	`memcmp
(
p
+
’Œy
.
h—d”size
,
s¡r
,
¦’
) == 0;

930 ià(
	`zTryEncodšg
(
s¡r
,
¦’
,&
sv®
,&
£ncodšg
)) {

931 
zv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

932  
zv®
 =ğ
sv®
;

936 
	}
}

940 *
	$zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
) {

941 
skút
 = 0;

942 
v’codšg
 = 0;

943 
vÎ
 = 0;

945 
p
[0] !ğ
ZIP_END
) {

946 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

947 *
q
;

949 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

950 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

951 
q
 = 
p
 + 
´evËnsize
 + 
Ënsize
;

953 ià(
skút
 == 0) {

955 ià(
	`ZIP_IS_STR
(
’codšg
)) {

956 ià(
Ën
 =ğ
vËn
 && 
	`memcmp
(
q
, 
v¡r
, vlen) == 0) {

957  
p
;

963 ià(
v’codšg
 == 0) {

964 ià(!
	`zTryEncodšg
(
v¡r
, 
vËn
, &
vÎ
, &
v’codšg
)) {

968 
v’codšg
 = 
UCHAR_MAX
;

971 
	`ASSERT
(
v’codšg
);

977 ià(
v’codšg
 !ğ
UCHAR_MAX
) {

978 
Î
 = 
	`zLßdIÁeg”
(
q
, 
’codšg
);

979 ià(
Î
 =ğ
vÎ
) {

980  
p
;

986 
skút
 = 
sk
;

989 
skút
--;

993 
p
 = 
q
 + 
Ën
;

996  
NULL
;

997 
	}
}

1000 
	$zli¡L’
(*
zl
) {

1001 
Ën
 = 0;

1002 ià(
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)è< 
UINT16_MAX
) {

1003 
Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
));

1005 *
p
 = 
zl
+
ZIPLIST_HEADER_SIZE
;

1006 *
p
 !ğ
ZIP_END
) {

1007 
p
 +ğ
	`zRawEÁryL’gth
(p);

1008 
Ën
++;

1012 ià(
Ën
 < 
UINT16_MAX
è
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(len);

1014  
Ën
;

1015 
	}
}

1018 
size_t
 
	$zli¡BlobL’
(*
zl
) {

1019  
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
));

1020 
	}
}

1022 
	$zli¡R•r
(*
zl
) {

1023 *
p
;

1024 
šdex
 = 0;

1025 
zËÁry
 
’Œy
;

1027 
	`´štf
(

1031 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),

1032 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)),

1033 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(
zl
)));

1034 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

1035 *
p
 !ğ
ZIP_END
) {

1036 
	`zEÁry
(
p
, &
’Œy
);

1037 
	`´štf
(

1048 ()
p
,

1049 
šdex
,

1050 (è(
p
-
zl
),

1051 
’Œy
.
h—d”size
+’Œy.
Ën
,

1052 
’Œy
.
h—d”size
,

1053 
’Œy
.
´ev¿wËn
,

1054 
’Œy
.
´ev¿wËnsize
,

1055 
’Œy
.
Ën
);

1056 
p
 +ğ
’Œy
.
h—d”size
;

1057 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1058 ià(
’Œy
.
Ën
 > 40) {

1059 ià(
	`fwr™e
(
p
,40,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1060 
	`´štf
("...");

1062 ià(
’Œy
.
Ën
 &&

1063 
	`fwr™e
(
p
,
’Œy
.
Ën
,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1066 
	`´štf
("%Îd", (è
	`zLßdIÁeg”
(
p
,
’Œy
.
’codšg
));

1068 
	`´štf
("\n");

1069 
p
 +ğ
’Œy
.
Ën
;

1070 
šdex
++;

1072 
	`´štf
("{end}\n\n");

1073 
	}
}

1075 #ifdeà
REDIS_TEST


1076 
	~<sys/time.h
>

1077 
	~"adli¡.h
"

1078 
	~"sds.h
"

1080 
	#debug
(
f
, ...è{ ià(
DEBUG
è
	`´štf
(f, 
__VA_ARGS__
); }

	)

1082 *
	$ü—‹Li¡
() {

1083 *
zl
 = 
	`zli¡New
();

1084 
zl
 = 
	`zli¡Push
(zl, (*)"foo", 3, 
ZIPLIST_TAIL
);

1085 
zl
 = 
	`zli¡Push
(zl, (*)"quux", 4, 
ZIPLIST_TAIL
);

1086 
zl
 = 
	`zli¡Push
(zl, (*)"h–lo", 5, 
ZIPLIST_HEAD
);

1087 
zl
 = 
	`zli¡Push
(zl, (*)"1024", 4, 
ZIPLIST_TAIL
);

1088  
zl
;

1089 
	}
}

1091 *
	$ü—‹IÁLi¡
() {

1092 *
zl
 = 
	`zli¡New
();

1093 
buf
[32];

1095 
	`¥rštf
(
buf
, "100");

1096 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1097 
	`¥rštf
(
buf
, "128000");

1098 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1099 
	`¥rštf
(
buf
, "-100");

1100 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1101 
	`¥rštf
(
buf
, "4294967296");

1102 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1103 
	`¥rštf
(
buf
, "non integer");

1104 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1105 
	`¥rštf
(
buf
, "much much†onger‚on integer");

1106 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1107  
zl
;

1108 
	}
}

1110 
	$u£c
() {

1111 
timev®
 
tv
;

1112 
	`g‘timeofday
(&
tv
,
NULL
);

1113  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

1114 
	}
}

1116 
	$¡»ss
(
pos
, 
num
, 
maxsize
, 
dnum
) {

1117 
i
,
j
,
k
;

1118 *
zl
;

1119 
pos¡r
[2][5] = { "HEAD", "TAIL" };

1120 
¡¬t
;

1121 
i
 = 0; i < 
maxsize
; i+=
dnum
) {

1122 
zl
 = 
	`zli¡New
();

1123 
j
 = 0; j < 
i
; j++) {

1124 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
ZIPLIST_TAIL
);

1128 
¡¬t
 = 
	`u£c
();

1129 
k
 = 0; k < 
num
; k++) {

1130 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
pos
);

1131 
zl
 = 
	`zli¡D–‘eRªge
(zl,0,1);

1133 
	`´štf
("List size: %8d, bytes: %8d, %dx…ush+pop (%s): %6lld usec\n",

1134 
i
,
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),
num
,
pos¡r
[
pos
],
	`u£c
()-
¡¬t
);

1135 
	`dä“
(
zl
);

1137 
	}
}

1139 *
	$pİ
(*
zl
, 
wh”e
) {

1140 *
p
, *
v¡r
;

1141 
vËn
;

1142 
vlÚg
;

1144 
p
 = 
	`zli¡Index
(
zl
,
wh”e
 =ğ
ZIPLIST_HEAD
 ? 0 : -1);

1145 ià(
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

1146 ià(
wh”e
 =ğ
ZIPLIST_HEAD
)

1147 
	`´štf
("Pop head: ");

1149 
	`´štf
("Popail: ");

1151 ià(
v¡r
) {

1152 ià(
vËn
 && 
	`fwr™e
(
v¡r
,vËn,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1155 
	`´štf
("%Îd", 
vlÚg
);

1158 
	`´štf
("\n");

1159  
	`zli¡D–‘e
(
zl
,&
p
);

1161 
	`´štf
("ERROR: Could‚ot…op\n");

1162 
	`ex™
(1);

1164 
	}
}

1166 
	$¿nd¡ršg
(*
rg‘
, 
mš
, 
max
) {

1167 
p
 = 0;

1168 
Ën
 = 
mš
+
	`¿nd
()%(
max
-min+1);

1169 
mšv®
, 
maxv®
;

1170 
	`¿nd
() % 3) {

1172 
mšv®
 = 0;

1173 
maxv®
 = 255;

1176 
mšv®
 = 48;

1177 
maxv®
 = 122;

1180 
mšv®
 = 48;

1181 
maxv®
 = 52;

1184 
	`ASSERT
(
NULL
);

1187 
p
 < 
Ën
)

1188 
rg‘
[
p
++] = 
mšv®
+
	`¿nd
()%(
maxv®
-minval+1);

1189  
Ën
;

1190 
	}
}

1192 
	$v”ify
(*
zl
, 
zËÁry
 *
e
) {

1193 
Ën
 = 
	`zli¡L’
(
zl
);

1194 
zËÁry
 
_e
;

1196 
	`ZIPLIST_ENTRY_ZERO
(&
_e
);

1198 
i
 = 0; i < 
Ën
; i++) {

1199 
	`mem£t
(&
e
[
i
], 0, (
zËÁry
));

1200 
	`zEÁry
(
	`zli¡Index
(
zl
, 
i
), &
e
[i]);

1202 
	`mem£t
(&
_e
, 0, (
zËÁry
));

1203 
	`zEÁry
(
	`zli¡Index
(
zl
, -
Ën
+
i
), &
_e
);

1205 
	`ASSERT
(
	`memcmp
(&
e
[
i
], &
_e
, (
zËÁry
)) == 0);

1207 
	}
}

1209 
	$zli¡Te¡
(
¬gc
, **
¬gv
) {

1210 
»t
;

1211 *
zl
, *
p
;

1212 *
’Œy
;

1213 
–’
;

1214 
v®ue
;

1217 ià(
¬gc
 == 2)

1218 
	`¤ªd
(
	`©oi
(
¬gv
[1]));

1220 
zl
 = 
	`ü—‹IÁLi¡
();

1221 
	`zli¡R•r
(
zl
);

1223 
	`dä“
(
zl
);

1225 
zl
 = 
	`ü—‹Li¡
();

1226 
	`zli¡R•r
(
zl
);

1228 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1229 
	`zli¡R•r
(
zl
);

1231 
zl
 = 
	`pİ
(zl,
ZIPLIST_HEAD
);

1232 
	`zli¡R•r
(
zl
);

1234 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1235 
	`zli¡R•r
(
zl
);

1237 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1238 
	`zli¡R•r
(
zl
);

1240 
	`dä“
(
zl
);

1242 
	`´štf
("Getƒlement‡t index 3:\n");

1244 
zl
 = 
	`ü—‹Li¡
();

1245 
p
 = 
	`zli¡Index
(
zl
, 3);

1246 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1247 
	`´štf
("ERROR: Could‚ot‡ccess index 3\n");

1250 ià(
’Œy
) {

1251 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1252 
	`´štf
("\n");

1254 
	`´štf
("%Îd\n", 
v®ue
);

1256 
	`´štf
("\n");

1257 
	`dä“
(
zl
);

1260 
	`´štf
("Getƒlement‡t index 4 (out of„ange):\n");

1262 
zl
 = 
	`ü—‹Li¡
();

1263 
p
 = 
	`zli¡Index
(
zl
, 4);

1264 ià(
p
 =ğ
NULL
) {

1265 
	`´štf
("Noƒntry\n");

1267 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1270 
	`´štf
("\n");

1271 
	`dä“
(
zl
);

1274 
	`´štf
("Getƒlement‡t index -1 (lastƒlement):\n");

1276 
zl
 = 
	`ü—‹Li¡
();

1277 
p
 = 
	`zli¡Index
(
zl
, -1);

1278 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1279 
	`´štf
("ERROR: Could‚ot‡ccess index -1\n");

1282 ià(
’Œy
) {

1283 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1284 
	`´štf
("\n");

1286 
	`´štf
("%Îd\n", 
v®ue
);

1288 
	`´štf
("\n");

1289 
	`dä“
(
zl
);

1292 
	`´štf
("Getƒlement‡t index -4 (firstƒlement):\n");

1294 
zl
 = 
	`ü—‹Li¡
();

1295 
p
 = 
	`zli¡Index
(
zl
, -4);

1296 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1297 
	`´štf
("ERROR: Could‚ot‡ccess index -4\n");

1300 ià(
’Œy
) {

1301 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1302 
	`´štf
("\n");

1304 
	`´štf
("%Îd\n", 
v®ue
);

1306 
	`´štf
("\n");

1307 
	`dä“
(
zl
);

1310 
	`´štf
("Getƒlement‡t index -5 (reverse out of„ange):\n");

1312 
zl
 = 
	`ü—‹Li¡
();

1313 
p
 = 
	`zli¡Index
(
zl
, -5);

1314 ià(
p
 =ğ
NULL
) {

1315 
	`´štf
("Noƒntry\n");

1317 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1320 
	`´štf
("\n");

1321 
	`dä“
(
zl
);

1324 
	`´štf
("Iterate†ist from 0oƒnd:\n");

1326 
zl
 = 
	`ü—‹Li¡
();

1327 
p
 = 
	`zli¡Index
(
zl
, 0);

1328 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1329 
	`´štf
("Entry: ");

1330 ià(
’Œy
) {

1331 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1333 
	`´štf
("%Îd", 
v®ue
);

1335 
p
 = 
	`zli¡Next
(
zl
,p);

1336 
	`´štf
("\n");

1338 
	`´štf
("\n");

1339 
	`dä“
(
zl
);

1342 
	`´štf
("Iterate†ist from 1oƒnd:\n");

1344 
zl
 = 
	`ü—‹Li¡
();

1345 
p
 = 
	`zli¡Index
(
zl
, 1);

1346 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1347 
	`´štf
("Entry: ");

1348 ià(
’Œy
) {

1349 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1351 
	`´štf
("%Îd", 
v®ue
);

1353 
p
 = 
	`zli¡Next
(
zl
,p);

1354 
	`´štf
("\n");

1356 
	`´štf
("\n");

1357 
	`dä“
(
zl
);

1360 
	`´štf
("Iterate†ist from 2oƒnd:\n");

1362 
zl
 = 
	`ü—‹Li¡
();

1363 
p
 = 
	`zli¡Index
(
zl
, 2);

1364 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1365 
	`´štf
("Entry: ");

1366 ià(
’Œy
) {

1367 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1369 
	`´štf
("%Îd", 
v®ue
);

1371 
p
 = 
	`zli¡Next
(
zl
,p);

1372 
	`´štf
("\n");

1374 
	`´štf
("\n");

1375 
	`dä“
(
zl
);

1378 
	`´štf
("Iterate starting out of„ange:\n");

1380 
zl
 = 
	`ü—‹Li¡
();

1381 
p
 = 
	`zli¡Index
(
zl
, 4);

1382 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1383 
	`´štf
("Noƒntry\n");

1385 
	`´štf
("ERROR\n");

1387 
	`´štf
("\n");

1388 
	`dä“
(
zl
);

1391 
	`´štf
("Iterate from backo front:\n");

1393 
zl
 = 
	`ü—‹Li¡
();

1394 
p
 = 
	`zli¡Index
(
zl
, -1);

1395 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1396 
	`´štf
("Entry: ");

1397 ià(
’Œy
) {

1398 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1400 
	`´štf
("%Îd", 
v®ue
);

1402 
p
 = 
	`zli¡P»v
(
zl
,p);

1403 
	`´štf
("\n");

1405 
	`´štf
("\n");

1406 
	`dä“
(
zl
);

1409 
	`´štf
("Iterate from backo front, deleting‡ll items:\n");

1411 
zl
 = 
	`ü—‹Li¡
();

1412 
p
 = 
	`zli¡Index
(
zl
, -1);

1413 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1414 
	`´štf
("Entry: ");

1415 ià(
’Œy
) {

1416 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1418 
	`´štf
("%Îd", 
v®ue
);

1420 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1421 
p
 = 
	`zli¡P»v
(
zl
,p);

1422 
	`´štf
("\n");

1424 
	`´štf
("\n");

1425 
	`dä“
(
zl
);

1428 
	`´štf
("Delete inclusive„ange 0,0:\n");

1430 
zl
 = 
	`ü—‹Li¡
();

1431 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 1);

1432 
	`zli¡R•r
(
zl
);

1433 
	`dä“
(
zl
);

1436 
	`´štf
("Delete inclusive„ange 0,1:\n");

1438 
zl
 = 
	`ü—‹Li¡
();

1439 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 2);

1440 
	`zli¡R•r
(
zl
);

1441 
	`dä“
(
zl
);

1444 
	`´štf
("Delete inclusive„ange 1,2:\n");

1446 
zl
 = 
	`ü—‹Li¡
();

1447 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 2);

1448 
	`zli¡R•r
(
zl
);

1449 
	`dä“
(
zl
);

1452 
	`´štf
("Delete with start index out of„ange:\n");

1454 
zl
 = 
	`ü—‹Li¡
();

1455 
zl
 = 
	`zli¡D–‘eRªge
(zl, 5, 1);

1456 
	`zli¡R•r
(
zl
);

1457 
	`dä“
(
zl
);

1460 
	`´štf
("Delete with‚um overflow:\n");

1462 
zl
 = 
	`ü—‹Li¡
();

1463 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 5);

1464 
	`zli¡R•r
(
zl
);

1465 
	`dä“
(
zl
);

1468 
	`´štf
("Delete foo while iterating:\n");

1470 
zl
 = 
	`ü—‹Li¡
();

1471 
p
 = 
	`zli¡Index
(
zl
,0);

1472 
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
)) {

1473 ià(
’Œy
 && 
	`¡ºcmp
("foo",(*ëÁry,
–’
) == 0) {

1474 
	`´štf
("Delete foo\n");

1475 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1477 
	`´štf
("Entry: ");

1478 ià(
’Œy
) {

1479 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
) == 0)

1480 
	`³¼Ü
("fwrite");

1482 
	`´štf
("%Îd",
v®ue
);

1484 
p
 = 
	`zli¡Next
(
zl
,p);

1485 
	`´štf
("\n");

1488 
	`´štf
("\n");

1489 
	`zli¡R•r
(
zl
);

1490 
	`dä“
(
zl
);

1493 
	`´štf
("Regressionest for >255 byte strings:\n");

1495 
v1
[257] = {0}, 
v2
[257] = {0};

1496 
	`mem£t
(
v1
,'x',256);

1497 
	`mem£t
(
v2
,'y',256);

1498 
zl
 = 
	`zli¡New
();

1499 
zl
 = 
	`zli¡Push
(zl,(*)
v1
,
	`¡¾’
(v1),
ZIPLIST_TAIL
);

1500 
zl
 = 
	`zli¡Push
(zl,(*)
v2
,
	`¡¾’
(v2),
ZIPLIST_TAIL
);

1503 
p
 = 
	`zli¡Index
(
zl
,0);

1504 
»t
 = ()
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
);

1505 
	`ASSERT
(
»t
 > 0);

1506 
	`ASSERT
(
	`¡ºcmp
(
v1
,(*)
’Œy
,
–’
) == 0);

1507 
p
 = 
	`zli¡Index
(
zl
,1);

1508 
»t
 = ()
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
);

1509 
	`ASSERT
(
»t
 > 0);

1510 
	`ASSERT
(
	`¡ºcmp
(
v2
,(*)
’Œy
,
–’
) == 0);

1511 
	`´štf
("SUCCESS\n\n");

1512 
	`dä“
(
zl
);

1515 
	`´štf
("Regressionest deleting‚exto†astƒntries:\n");

1517 
v
[3][257] = {{0}};

1518 
zËÁry
 
e
[3] = {{.
´ev¿wËnsize
 = 0, .
´ev¿wËn
 = 0, .
Ënsize
 = 0,

1519 .
Ën
 = 0, .
h—d”size
 = 0, .
’codšg
 = 0, .
p
 = 
NULL
}};

1520 
size_t
 
i
;

1522 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1523 
	`mem£t
(
v
[
i
], 'a' + i, (v[0]));

1526 
v
[0][256] = '\0';

1527 
v
[1][ 1] = '\0';

1528 
v
[2][256] = '\0';

1530 
zl
 = 
	`zli¡New
();

1531 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1532 
zl
 = 
	`zli¡Push
(zl, (*è
v
[
i
], 
	`¡¾’
(v[i]), 
ZIPLIST_TAIL
);

1535 
	`v”ify
(
zl
, 
e
);

1537 
	`ASSERT
(
e
[0].
´ev¿wËnsize
 == 1);

1538 
	`ASSERT
(
e
[1].
´ev¿wËnsize
 == 5);

1539 
	`ASSERT
(
e
[2].
´ev¿wËnsize
 == 1);

1542 *
p
 = 
e
[1].p;

1543 
zl
 = 
	`zli¡D–‘e
(zl, &
p
);

1545 
	`v”ify
(
zl
, 
e
);

1547 
	`ASSERT
(
e
[0].
´ev¿wËnsize
 == 1);

1548 
	`ASSERT
(
e
[1].
´ev¿wËnsize
 == 5);

1550 
	`´štf
("SUCCESS\n\n");

1551 
	`dä“
(
zl
);

1554 
	`´štf
("Create†ong†ist‡nd check indices:\n");

1556 
zl
 = 
	`zli¡New
();

1557 
buf
[32];

1558 
i
,
Ën
;

1559 
i
 = 0; i < 1000; i++) {

1560 
Ën
 = 
	`¥rštf
(
buf
,"%d",
i
);

1561 
zl
 = 
	`zli¡Push
(zl,(*)
buf
,
Ën
,
ZIPLIST_TAIL
);

1563 
i
 = 0; i < 1000; i++) {

1564 
p
 = 
	`zli¡Index
(
zl
,
i
);

1565 
»t
 = ()
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
);

1566 
	`ASSERT
(
»t
 > 0);

1567 
	`ASSERT
(
i
 =ğ
v®ue
);

1569 
p
 = 
	`zli¡Index
(
zl
,-
i
-1);

1570 
»t
 = ()
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
);

1571 
	`ASSERT
(
»t
 > 0);

1572 
	`ASSERT
(999-
i
 =ğ
v®ue
);

1574 
	`´štf
("SUCCESS\n\n");

1575 
	`dä“
(
zl
);

1578 
	`´štf
("Compare strings with ziplistƒntries:\n");

1580 
zl
 = 
	`ü—‹Li¡
();

1581 
p
 = 
	`zli¡Index
(
zl
,0);

1582 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1583 
	`´štf
("ERROR:‚ot \"hello\"\n");

1586 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1587 
	`´štf
("ERROR: \"hella\"\n");

1591 
p
 = 
	`zli¡Index
(
zl
,3);

1592 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1593 
	`´štf
("ERROR:‚ot \"1024\"\n");

1596 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1597 
	`´štf
("ERROR: \"1025\"\n");

1600 
	`´štf
("SUCCESS\n\n");

1601 
	`dä“
(
zl
);

1604 
	`´štf
("Mergeest:\n");

1607 
zl
 = 
	`ü—‹Li¡
();

1608 *
zl2
 = 
	`ü—‹Li¡
();

1610 *
zl3
 = 
	`zli¡New
();

1611 *
zl4
 = 
	`zli¡New
();

1613 ià(
	`zli¡M”ge
(&
zl4
, &zl4)) {

1614 
	`´štf
("ERROR: Allowed merging of one ziplist into itself.\n");

1619 
zl4
 = 
	`zli¡M”ge
(&
zl3
, &zl4);

1620 
	`zli¡R•r
(
zl4
);

1621 ià(
	`zli¡L’
(
zl4
)) {

1622 
	`´štf
("ERROR: Mergingwoƒmpty ziplists createdƒntries.\n");

1625 
	`dä“
(
zl4
);

1627 
zl2
 = 
	`zli¡M”ge
(&
zl
, &zl2);

1629 
	`zli¡R•r
(
zl2
);

1631 ià(
	`zli¡L’
(
zl2
) != 8) {

1632 
	`´štf
("ERROR: M”ged†’gth‚Ù 8, but: %u\n", 
	`zli¡L’
(
zl2
));

1636 
p
 = 
	`zli¡Index
(
zl2
,0);

1637 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1638 
	`´štf
("ERROR:‚ot \"hello\"\n");

1641 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1642 
	`´štf
("ERROR: \"hella\"\n");

1646 
p
 = 
	`zli¡Index
(
zl2
,3);

1647 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1648 
	`´štf
("ERROR:‚ot \"1024\"\n");

1651 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1652 
	`´štf
("ERROR: \"1025\"\n");

1656 
p
 = 
	`zli¡Index
(
zl2
,4);

1657 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1658 
	`´štf
("ERROR:‚ot \"hello\"\n");

1661 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1662 
	`´štf
("ERROR: \"hella\"\n");

1666 
p
 = 
	`zli¡Index
(
zl2
,7);

1667 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1668 
	`´štf
("ERROR:‚ot \"1024\"\n");

1671 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1672 
	`´štf
("ERROR: \"1025\"\n");

1675 
	`´štf
("SUCCESS\n\n");

1676 
	`dä“
(
zl
);

1679 
	`´štf
("Stress with„andom…ayloads of differentƒncoding:\n");

1681 
i
,
j
,
Ën
,
wh”e
;

1682 *
p
;

1683 
buf
[1024];

1684 
buæ’
;

1685 
dli¡
 *
»f
;

1686 
dli¡Node
 *
»âode
;

1689 *
s¡r
;

1690 
¦’
;

1691 
sv®
;

1693 
i
 = 0; i < 20000; i++) {

1694 
zl
 = 
	`zli¡New
();

1695 
»f
 = 
	`dli¡C»©e
();

1696 
	`dli¡S‘F»eM‘hod
(
»f
,((*)(*))
sdsä“
);

1697 
Ën
 = 
	`¿nd
() % 256;

1700 
j
 = 0; j < 
Ën
; j++) {

1701 
wh”e
 = (
	`¿nd
(è& 1è? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
;

1702 ià(
	`¿nd
() % 2) {

1703 
buæ’
 = 
	`¿nd¡ršg
(
buf
,1,(buf)-1);

1705 
	`¿nd
() % 3) {

1707 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) >> 20);

1710 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()));

1713 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) << 20);

1716 
	`ASSERT
(
NULL
);

1721 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
buæ’
, 
wh”e
);

1724 ià(
wh”e
 =ğ
ZIPLIST_HEAD
) {

1725 
	`dli¡AddNodeH—d
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1726 } ià(
wh”e
 =ğ
ZIPLIST_TAIL
) {

1727 
	`dli¡AddNodeTa
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1729 
	`ASSERT
(
NULL
);

1733 
	`ASSERT
(
	`dli¡L’gth
(
»f
è=ğ
	`zli¡L’
(
zl
));

1734 
j
 = 0; j < 
Ën
; j++) {

1737 
p
 = 
	`zli¡Index
(
zl
,
j
);

1738 
»âode
 = 
	`dli¡Index
(
»f
,
j
);

1740 
»t
 = ()
	`zli¡G‘
(
p
,&
s¡r
,&
¦’
,&
sv®
);

1741 
	`ASSERT
(
»t
 > 0);

1742 ià(
s¡r
 =ğ
NULL
) {

1743 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",
sv®
);

1745 
buæ’
 = 
¦’
;

1746 
	`memıy
(
buf
,
s¡r
,
buæ’
);

1747 
buf
[
buæ’
] = '\0';

1749 
	`ASSERT
(
	`memcmp
(
buf
,
	`dli¡NodeV®ue
(
»âode
),
buæ’
) == 0);

1751 
	`dä“
(
zl
);

1752 
	`dli¡R–—£
(
»f
);

1754 
	`´štf
("SUCCESS\n\n");

1757 
	`´štf
("Stress with variable ziplist size:\n");

1759 
	`¡»ss
(
ZIPLIST_HEAD
,100000,16384,256);

1760 
	`¡»ss
(
ZIPLIST_TAIL
,100000,16384,256);

1764 
	}
}

	@src/vr_ziplist.h

1 #iâdeà
_ZIPLIST_H


2 
	#_ZIPLIST_H


	)

4 
	#ZIPLIST_HEAD
 0

	)

5 
	#ZIPLIST_TAIL
 1

	)

7 *
zli¡New
();

8 *
zli¡M”ge
(**
fœ¡
, **
£cÚd
);

9 *
zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
);

10 *
zli¡Index
(*
zl
, 
šdex
);

11 *
zli¡Next
(*
zl
, *
p
);

12 *
zli¡P»v
(*
zl
, *
p
);

13 
zli¡G‘
(*
p
, **
sv®
, *
¦’
, *
lv®
);

14 *
zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
);

15 *
zli¡D–‘e
(*
zl
, **
p
);

16 *
zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
);

17 
zli¡Com·»
(*
p
, *
s
, 
¦’
);

18 *
zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
);

19 
zli¡L’
(*
zl
);

20 
size_t
 
zli¡BlobL’
(*
zl
);

22 #ifdeà
REDIS_TEST


23 
zli¡Te¡
(
¬gc
, *
¬gv
[]);

	@src/vr_ziplist.h

1 #iâdeà
_ZIPLIST_H


2 
	#_ZIPLIST_H


	)

4 
	#ZIPLIST_HEAD
 0

	)

5 
	#ZIPLIST_TAIL
 1

	)

7 *
zli¡New
();

8 *
zli¡M”ge
(**
fœ¡
, **
£cÚd
);

9 *
zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
);

10 *
zli¡Index
(*
zl
, 
šdex
);

11 *
zli¡Next
(*
zl
, *
p
);

12 *
zli¡P»v
(*
zl
, *
p
);

13 
zli¡G‘
(*
p
, **
sv®
, *
¦’
, *
lv®
);

14 *
zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
);

15 *
zli¡D–‘e
(*
zl
, **
p
);

16 *
zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
);

17 
zli¡Com·»
(*
p
, *
s
, 
¦’
);

18 *
zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
);

19 
zli¡L’
(*
zl
);

20 
size_t
 
zli¡BlobL’
(*
zl
);

22 #ifdeà
REDIS_TEST


23 
zli¡Te¡
(
¬gc
, *
¬gv
[]);

	@src/vr_zipmap.c

78 
	~<¡dio.h
>

79 
	~<¡ršg.h
>

81 
	~<vr_cÜe.h
>

83 
	#ZIPMAP_BIGLEN
 254

	)

84 
	#ZIPMAP_END
 255

	)

88 
	#ZIPMAP_VALUE_MAX_FREE
 4

	)

93 
	#ZIPMAP_LEN_BYTES
(
_l
è(((_lè< 
ZIPMAP_BIGLEN
è? 1 : ()+1)

	)

96 *
	$zm­New
() {

97 *
zm
 = 
	`d®loc
(2);

99 
zm
[0] = 0;

100 
zm
[1] = 
ZIPMAP_END
;

101  
zm
;

102 
	}
}

105 
	$zm­DecodeL’gth
(*
p
) {

106 
Ën
 = *
p
;

108 ià(
Ën
 < 
ZIPMAP_BIGLEN
) †en;

109 
	`memıy
(&
Ën
,
p
+1,());

110 
	`mem»v32ifbe
(&
Ën
);

111  
Ën
;

112 
	}
}

116 
	$zm­EncodeL’gth
(*
p
, 
Ën
) {

117 ià(
p
 =ğ
NULL
) {

118  
	`ZIPMAP_LEN_BYTES
(
Ën
);

120 ià(
Ën
 < 
ZIPMAP_BIGLEN
) {

121 
p
[0] = 
Ën
;

124 
p
[0] = 
ZIPMAP_BIGLEN
;

125 
	`memıy
(
p
+1,&
Ën
,(len));

126 
	`mem»v32ifbe
(
p
+1);

127  1+(
Ën
);

130 
	}
}

138 *
	$zm­LookupRaw
(*
zm
, *
key
, 
kËn
, *
tÙËn
) {

139 *
p
 = 
zm
+1, *
k
 = 
NULL
;

140 
l
,
Î’
;

142 *
p
 !ğ
ZIPMAP_END
) {

143 
ä“
;

146 
l
 = 
	`zm­DecodeL’gth
(
p
);

147 
Î’
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

148 ià(
key
 !ğ
NULL
 && 
k
 =ğNULL && 
l
 =ğ
kËn
 && !
	`memcmp
(
p
+
Î’
,key,l)) {

151 ià(
tÙËn
 !ğ
NULL
) {

152 
k
 = 
p
;

154  
p
;

157 
p
 +ğ
Î’
+
l
;

159 
l
 = 
	`zm­DecodeL’gth
(
p
);

160 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

161 
ä“
 = 
p
[0];

162 
p
 +ğ
l
+1+
ä“
;

164 ià(
tÙËn
 !ğ
NULL
è*tÙËÀğ()(
p
-
zm
)+1;

165  
k
;

166 
	}
}

168 
	$zm­RequœedL’gth
(
kËn
, 
vËn
) {

169 
l
;

171 
l
 = 
kËn
+
vËn
+3;

172 ià(
kËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

173 ià(
vËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

174  
l
;

175 
	}
}

178 
	$zm­RawKeyL’gth
(*
p
) {

179 
l
 = 
	`zm­DecodeL’gth
(
p
);

180  
	`zm­EncodeL’gth
(
NULL
,
l
) +†;

181 
	}
}

185 
	$zm­RawV®ueL’gth
(*
p
) {

186 
l
 = 
	`zm­DecodeL’gth
(
p
);

187 
u£d
;

189 
u£d
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

190 
u£d
 +ğ
p
[u£d] + 1 + 
l
;

191  
u£d
;

192 
	}
}

197 
	$zm­RawEÁryL’gth
(*
p
) {

198 
l
 = 
	`zm­RawKeyL’gth
(
p
);

199  
l
 + 
	`zm­RawV®ueL’gth
(
p
+l);

200 
	}
}

202 
šlše
 *
	$zm­Resize
(*
zm
, 
Ën
) {

203 
zm
 = 
	`d»®loc
(zm, 
Ën
);

204 
zm
[
Ën
-1] = 
ZIPMAP_END
;

205  
zm
;

206 
	}
}

211 *
	$zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
) {

212 
zmËn
, 
off£t
;

213 
ä“Ën
, 
»qËn
 = 
	`zm­RequœedL’gth
(
kËn
,
vËn
);

214 
em±y
, 
vem±y
;

215 *
p
;

217 
ä“Ën
 = 
»qËn
;

218 ià(
upd©e
) *update = 0;

219 
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

220 ià(
p
 =ğ
NULL
) {

222 
zm
 = 
	`zm­Resize
(zm, 
zmËn
+
»qËn
);

223 
p
 = 
zm
+
zmËn
-1;

224 
zmËn
 = zmËn+
»qËn
;

227 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]++;

231 ià(
upd©e
) *update = 1;

232 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

233 ià(
ä“Ën
 < 
»qËn
) {

237 
off£t
 = 
p
-
zm
;

238 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
+
»qËn
);

239 
p
 = 
zm
+
off£t
;

243 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

244 
zmËn
 = zmËn-
ä“Ën
+
»qËn
;

245 
ä“Ën
 = 
»qËn
;

253 
em±y
 = 
ä“Ën
-
»qËn
;

254 ià(
em±y
 >ğ
ZIPMAP_VALUE_MAX_FREE
) {

257 
off£t
 = 
p
-
zm
;

258 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

259 
zmËn
 -ğ
em±y
;

260 
zm
 = 
	`zm­Resize
(zm, 
zmËn
);

261 
p
 = 
zm
+
off£t
;

262 
vem±y
 = 0;

264 
vem±y
 = 
em±y
;

269 
p
 +ğ
	`zm­EncodeL’gth
Õ,
kËn
);

270 
	`memıy
(
p
,
key
,
kËn
);

271 
p
 +ğ
kËn
;

273 
p
 +ğ
	`zm­EncodeL’gth
Õ,
vËn
);

274 *
p
++ = 
vem±y
;

275 
	`memıy
(
p
,
v®
,
vËn
);

276  
zm
;

277 
	}
}

281 *
	$zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
) {

282 
zmËn
, 
ä“Ën
;

283 *
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

284 ià(
p
) {

285 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

286 
	`memmove
(
p
,…+
ä“Ën
, 
zmËn
-(Õ-
zm
)+freelen+1));

287 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
);

290 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]--;

292 ià(
d–‘ed
) *deleted = 1;

294 ià(
d–‘ed
) *deleted = 0;

296  
zm
;

297 
	}
}

300 *
	$zm­Rewšd
(*
zm
) {

301  
zm
+1;

302 
	}
}

315 *
	$zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
) {

316 ià(
zm
[0] =ğ
ZIPMAP_END
è 
NULL
;

317 ià(
key
) {

318 *
key
 = 
zm
;

319 *
kËn
 = 
	`zm­DecodeL’gth
(
zm
);

320 *
key
 +ğ
	`ZIPMAP_LEN_BYTES
(*
kËn
);

322 
zm
 +ğ
	`zm­RawKeyL’gth
(zm);

323 ià(
v®ue
) {

324 *
v®ue
 = 
zm
+1;

325 *
vËn
 = 
	`zm­DecodeL’gth
(
zm
);

326 *
v®ue
 +ğ
	`ZIPMAP_LEN_BYTES
(*
vËn
);

328 
zm
 +ğ
	`zm­RawV®ueL’gth
(zm);

329  
zm
;

330 
	}
}

334 
	$zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
) {

335 *
p
;

337 ià((
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
)) == NULL)  0;

338 
p
 +ğ
	`zm­RawKeyL’gth
(p);

339 *
vËn
 = 
	`zm­DecodeL’gth
(
p
);

340 *
v®ue
 = 
p
 + 
	`ZIPMAP_LEN_BYTES
(*
vËn
) + 1;

342 
	}
}

345 
	$zm­Exi¡s
(*
zm
, *
key
, 
kËn
) {

346  
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
) != NULL;

347 
	}
}

350 
	$zm­L’
(*
zm
) {

351 
Ën
 = 0;

352 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) {

353 
Ën
 = 
zm
[0];

355 *
p
 = 
	`zm­Rewšd
(
zm
);

356 (
p
 = 
	`zm­Next
Õ,
NULL
,NULL,NULL,NULL)è!ğNULLè
Ën
++;

359 ià(
Ën
 < 
ZIPMAP_BIGLEN
è
zm
[0] =†en;

361  
Ën
;

362 
	}
}

367 
size_t
 
	$zm­BlobL’
(*
zm
) {

368 
tÙËn
;

369 
	`zm­LookupRaw
(
zm
,
NULL
,0,&
tÙËn
);

370  
tÙËn
;

371 
	}
}

	@src/vr_zipmap.c

78 
	~<¡dio.h
>

79 
	~<¡ršg.h
>

81 
	~<vr_cÜe.h
>

83 
	#ZIPMAP_BIGLEN
 254

	)

84 
	#ZIPMAP_END
 255

	)

88 
	#ZIPMAP_VALUE_MAX_FREE
 4

	)

93 
	#ZIPMAP_LEN_BYTES
(
_l
è(((_lè< 
ZIPMAP_BIGLEN
è? 1 : ()+1)

	)

96 *
	$zm­New
() {

97 *
zm
 = 
	`d®loc
(2);

99 
zm
[0] = 0;

100 
zm
[1] = 
ZIPMAP_END
;

101  
zm
;

102 
	}
}

105 
	$zm­DecodeL’gth
(*
p
) {

106 
Ën
 = *
p
;

108 ià(
Ën
 < 
ZIPMAP_BIGLEN
) †en;

109 
	`memıy
(&
Ën
,
p
+1,());

110 
	`mem»v32ifbe
(&
Ën
);

111  
Ën
;

112 
	}
}

116 
	$zm­EncodeL’gth
(*
p
, 
Ën
) {

117 ià(
p
 =ğ
NULL
) {

118  
	`ZIPMAP_LEN_BYTES
(
Ën
);

120 ià(
Ën
 < 
ZIPMAP_BIGLEN
) {

121 
p
[0] = 
Ën
;

124 
p
[0] = 
ZIPMAP_BIGLEN
;

125 
	`memıy
(
p
+1,&
Ën
,(len));

126 
	`mem»v32ifbe
(
p
+1);

127  1+(
Ën
);

130 
	}
}

138 *
	$zm­LookupRaw
(*
zm
, *
key
, 
kËn
, *
tÙËn
) {

139 *
p
 = 
zm
+1, *
k
 = 
NULL
;

140 
l
,
Î’
;

142 *
p
 !ğ
ZIPMAP_END
) {

143 
ä“
;

146 
l
 = 
	`zm­DecodeL’gth
(
p
);

147 
Î’
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

148 ià(
key
 !ğ
NULL
 && 
k
 =ğNULL && 
l
 =ğ
kËn
 && !
	`memcmp
(
p
+
Î’
,key,l)) {

151 ià(
tÙËn
 !ğ
NULL
) {

152 
k
 = 
p
;

154  
p
;

157 
p
 +ğ
Î’
+
l
;

159 
l
 = 
	`zm­DecodeL’gth
(
p
);

160 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

161 
ä“
 = 
p
[0];

162 
p
 +ğ
l
+1+
ä“
;

164 ià(
tÙËn
 !ğ
NULL
è*tÙËÀğ()(
p
-
zm
)+1;

165  
k
;

166 
	}
}

168 
	$zm­RequœedL’gth
(
kËn
, 
vËn
) {

169 
l
;

171 
l
 = 
kËn
+
vËn
+3;

172 ià(
kËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

173 ià(
vËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

174  
l
;

175 
	}
}

178 
	$zm­RawKeyL’gth
(*
p
) {

179 
l
 = 
	`zm­DecodeL’gth
(
p
);

180  
	`zm­EncodeL’gth
(
NULL
,
l
) +†;

181 
	}
}

185 
	$zm­RawV®ueL’gth
(*
p
) {

186 
l
 = 
	`zm­DecodeL’gth
(
p
);

187 
u£d
;

189 
u£d
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

190 
u£d
 +ğ
p
[u£d] + 1 + 
l
;

191  
u£d
;

192 
	}
}

197 
	$zm­RawEÁryL’gth
(*
p
) {

198 
l
 = 
	`zm­RawKeyL’gth
(
p
);

199  
l
 + 
	`zm­RawV®ueL’gth
(
p
+l);

200 
	}
}

202 
šlše
 *
	$zm­Resize
(*
zm
, 
Ën
) {

203 
zm
 = 
	`d»®loc
(zm, 
Ën
);

204 
zm
[
Ën
-1] = 
ZIPMAP_END
;

205  
zm
;

206 
	}
}

211 *
	$zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
) {

212 
zmËn
, 
off£t
;

213 
ä“Ën
, 
»qËn
 = 
	`zm­RequœedL’gth
(
kËn
,
vËn
);

214 
em±y
, 
vem±y
;

215 *
p
;

217 
ä“Ën
 = 
»qËn
;

218 ià(
upd©e
) *update = 0;

219 
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

220 ià(
p
 =ğ
NULL
) {

222 
zm
 = 
	`zm­Resize
(zm, 
zmËn
+
»qËn
);

223 
p
 = 
zm
+
zmËn
-1;

224 
zmËn
 = zmËn+
»qËn
;

227 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]++;

231 ià(
upd©e
) *update = 1;

232 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

233 ià(
ä“Ën
 < 
»qËn
) {

237 
off£t
 = 
p
-
zm
;

238 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
+
»qËn
);

239 
p
 = 
zm
+
off£t
;

243 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

244 
zmËn
 = zmËn-
ä“Ën
+
»qËn
;

245 
ä“Ën
 = 
»qËn
;

253 
em±y
 = 
ä“Ën
-
»qËn
;

254 ià(
em±y
 >ğ
ZIPMAP_VALUE_MAX_FREE
) {

257 
off£t
 = 
p
-
zm
;

258 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

259 
zmËn
 -ğ
em±y
;

260 
zm
 = 
	`zm­Resize
(zm, 
zmËn
);

261 
p
 = 
zm
+
off£t
;

262 
vem±y
 = 0;

264 
vem±y
 = 
em±y
;

269 
p
 +ğ
	`zm­EncodeL’gth
Õ,
kËn
);

270 
	`memıy
(
p
,
key
,
kËn
);

271 
p
 +ğ
kËn
;

273 
p
 +ğ
	`zm­EncodeL’gth
Õ,
vËn
);

274 *
p
++ = 
vem±y
;

275 
	`memıy
(
p
,
v®
,
vËn
);

276  
zm
;

277 
	}
}

281 *
	$zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
) {

282 
zmËn
, 
ä“Ën
;

283 *
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

284 ià(
p
) {

285 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

286 
	`memmove
(
p
,…+
ä“Ën
, 
zmËn
-(Õ-
zm
)+freelen+1));

287 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
);

290 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]--;

292 ià(
d–‘ed
) *deleted = 1;

294 ià(
d–‘ed
) *deleted = 0;

296  
zm
;

297 
	}
}

300 *
	$zm­Rewšd
(*
zm
) {

301  
zm
+1;

302 
	}
}

315 *
	$zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
) {

316 ià(
zm
[0] =ğ
ZIPMAP_END
è 
NULL
;

317 ià(
key
) {

318 *
key
 = 
zm
;

319 *
kËn
 = 
	`zm­DecodeL’gth
(
zm
);

320 *
key
 +ğ
	`ZIPMAP_LEN_BYTES
(*
kËn
);

322 
zm
 +ğ
	`zm­RawKeyL’gth
(zm);

323 ià(
v®ue
) {

324 *
v®ue
 = 
zm
+1;

325 *
vËn
 = 
	`zm­DecodeL’gth
(
zm
);

326 *
v®ue
 +ğ
	`ZIPMAP_LEN_BYTES
(*
vËn
);

328 
zm
 +ğ
	`zm­RawV®ueL’gth
(zm);

329  
zm
;

330 
	}
}

334 
	$zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
) {

335 *
p
;

337 ià((
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
)) == NULL)  0;

338 
p
 +ğ
	`zm­RawKeyL’gth
(p);

339 *
vËn
 = 
	`zm­DecodeL’gth
(
p
);

340 *
v®ue
 = 
p
 + 
	`ZIPMAP_LEN_BYTES
(*
vËn
) + 1;

342 
	}
}

345 
	$zm­Exi¡s
(*
zm
, *
key
, 
kËn
) {

346  
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
) != NULL;

347 
	}
}

350 
	$zm­L’
(*
zm
) {

351 
Ën
 = 0;

352 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) {

353 
Ën
 = 
zm
[0];

355 *
p
 = 
	`zm­Rewšd
(
zm
);

356 (
p
 = 
	`zm­Next
Õ,
NULL
,NULL,NULL,NULL)è!ğNULLè
Ën
++;

359 ià(
Ën
 < 
ZIPMAP_BIGLEN
è
zm
[0] =†en;

361  
Ën
;

362 
	}
}

367 
size_t
 
	$zm­BlobL’
(*
zm
) {

368 
tÙËn
;

369 
	`zm­LookupRaw
(
zm
,
NULL
,0,&
tÙËn
);

370  
tÙËn
;

371 
	}
}

	@src/vr_zipmap.h

1 #iâdeà
_ZIPMAP_H


2 
	#_ZIPMAP_H


	)

4 *
zm­New
();

5 *
zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
);

6 *
zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
);

7 *
zm­Rewšd
(*
zm
);

8 *
zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
);

9 
zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
);

10 
zm­Exi¡s
(*
zm
, *
key
, 
kËn
);

11 
zm­L’
(*
zm
);

12 
size_t
 
zm­BlobL’
(*
zm
);

13 
zm­R•r
(*
p
);

	@src/vr_zipmap.h

1 #iâdeà
_ZIPMAP_H


2 
	#_ZIPMAP_H


	)

4 *
zm­New
();

5 *
zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
);

6 *
zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
);

7 *
zm­Rewšd
(*
zm
);

8 *
zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
);

9 
zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
);

10 
zm­Exi¡s
(*
zm
, *
key
, 
kËn
);

11 
zm­L’
(*
zm
);

12 
size_t
 
zm­BlobL’
(*
zm
);

13 
zm­R•r
(*
p
);

	@tests/vrabtest.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<fú.h
>

5 
	~<”ºo.h
>

6 
	~<sigÇl.h
>

7 
	~<as£¹.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

12 
	~<d¬¿y.h
>

13 
	~<dlog.h
>

15 
	~<v¹_ut.h
>

16 
	~<v¹_public.h
>

17 
	~<v¹_´oduû_d©a.h
>

18 
	~<v¹_di¥©ch_d©a.h
>

19 
	~<v¹_check_d©a.h
>

20 
	~<v¹_back’d.h
>

21 
	~<v¿b‹¡.h
>

23 
	#CONFIG_DEFAULT_PIDFILE
 
NULL


	)

24 
	#CONFIG_DEFAULT_CHECKER
 "my£lf"

	)

25 
	#CONFIG_DEFAULT_TEST_INTERVAL
 3600

	)

26 
	#CONFIG_DEFAULT_KEY_LENGTH_RANGE_BEGIN
 0

	)

27 
	#CONFIG_DEFAULT_KEY_LENGTH_RANGE_END
 100

	)

28 
	#CONFIG_DEFAULT_STRING_MAX_LENGTH
 512

	)

29 
	#CONFIG_DEFAULT_FIELDS_MAX_COUNT
 16

	)

30 
	#CONFIG_DEFAULT_TEST_TARGET
 ""

	)

31 
	#CONFIG_DEFAULT_PRODUCE_THREADS_COUNT
 1

	)

32 
	#CONFIG_DEFAULT_CACHED_KEYS_COUNT
 10000

	)

33 
	#CONFIG_DEFAULT_HIT_RATIO
 75

	)

34 
	#CONFIG_DEFAULT_DISPATCH_THREADS_COUNT
 1

	)

35 
	#CONFIG_DEFAULT_CLIENTS_PER_DISPATCH_THREAD
 10

	)

36 
	#CONFIG_DEFAULT_LOGFILE
 
NULL


	)

38 
	#VRABTEST_GROUP_TYPE_REDIS
 0

	)

39 
	#VRABTEST_GROUP_TYPE_VIRE
 1

	)

41 
	scÚfig
 {

42 *
	mcheck”
;

43 
	m‹¡_š‹rv®
;

44 
	mkey_Ëngth_¿nge_begš
;

45 
	mkey_Ëngth_¿nge_’d
;

46 
	m¡ršg_max_Ëngth
;

47 
	mf›lds_max_couÁ
;

48 
	mcmd_ty³
;

49 
d¬¿y
 *
	mcmd_bÏckli¡
;

50 
d¬¿y
 *
	mcmd_wh™–i¡
;

51 *
	m‹¡_rg‘s
;

52 
	m´oduû_d©a_th»ads
;

53 
	mÿched_keys_³r_´oduû_th»ad
;

54 
	mh™_¿tio
;

55 
	mdi¥©ch_d©a_th»ads
;

56 
	mş›Ás_³r_di¥©ch_th»ad
;

57 *
	mpid_f’ame
;

58 *
	mlog_f’ame
;

61 
cÚfig
 
	gcÚfig
;

63 
	gshow_h–p
;

64 
	gshow_v”siÚ
;

65 
	gd«mÚize
;

70 
	gexpœe_’abËd
;

74 
	g‹¡_š‹rv®
;

78 
	gÏ¡_‹¡_begš_time
;

80 
İtiÚ
 
	glÚg_İtiÚs
[] = {

81 { "h–p", 
no_¬gum’t
, 
NULL
, 'h' },

82 { "v”siÚ", 
no_¬gum’t
, 
NULL
, 'V' },

83 { "d«mÚize", 
no_¬gum’t
, 
NULL
, 'D' },

84 { "’abË-expœe", 
no_¬gum’t
, 
NULL
, 'E' },

85 { "pid-fe", 
»quœed_¬gum’t
, 
NULL
, 'P' },

86 { "check”", 
»quœed_¬gum’t
, 
NULL
, 'C' },

87 { "‹¡-š‹rv®", 
»quœed_¬gum’t
, 
NULL
, 'i' },

88 { "key-Ëngth-¿nge", 
»quœed_¬gum’t
, 
NULL
, 'k' },

89 { "¡ršg-max-Ëngth", 
»quœed_¬gum’t
, 
NULL
, 's' },

90 { "f›lds-max-couÁ", 
»quœed_¬gum’t
, 
NULL
, 'f' },

91 { "commªd-ty³s", 
»quœed_¬gum’t
, 
NULL
, 'T' },

92 { "commªd-bÏck-li¡", 
»quœed_¬gum’t
, 
NULL
, 'B' },

93 { "commªd-wh™e-li¡", 
»quœed_¬gum’t
, 
NULL
, 'W' },

94 { "‹¡-rg‘s", 
»quœed_¬gum’t
, 
NULL
, 't' },

95 { "´oduû-d©a-th»ads", 
»quœed_¬gum’t
, 
NULL
, 'p' },

96 { "ÿched-keys", 
»quœed_¬gum’t
, 
NULL
, 'K' },

97 { "h™-¿tio", 
»quœed_¬gum’t
, 
NULL
, 'H' },

98 { "di¥©ch-d©a-th»ads", 
»quœed_¬gum’t
, 
NULL
, 'd' },

99 { "ş›Ás", 
»quœed_¬gum’t
, 
NULL
, 'c' },

100 { "log-fe", 
»quœed_¬gum’t
, 
NULL
, 'o' },

101 { 
NULL
, 0, NULL, 0 }

104 
	gshÜt_İtiÚs
[] = "hVDEP:C:i:k:s:f:T:B:W:t:p:K:H:d:c:o:";

107 
	$v¹_show_u§ge
()

109 
	`´štf
(

110 "U§ge: vœ—b‹¡ [-?hVDE]" 
CRLF


111 "" 
CRLF
);

112 
	`´štf
(

113 "O±iÚs:" 
CRLF


114 " -h, --h–° :hi h–p" 
CRLF


115 " -V, --v”siÚ : show v”siÚ‡ndƒx™" 
CRLF


116 " -D, --d«mÚiz :„uÀa ¨d«mÚ" 
CRLF


117 " -E, --’abË-expœ :ƒÇbËhexpœe" 
CRLF
);

118 
	`´štf
(

119 " -P, --pid-f :…id fe" 
CRLF


120 " -C, --check” :hcheck”Øcheck d©¨cÚsi¡’cy" 
CRLF


121 " -i, --‹¡-š‹rv® :hš‹rv® fÜ checkšg d©¨cÚsi¡’cy, un™ i £cÚd" 
CRLF


122 " -k, --key-Ëngth-¿ng :hkey†’gth„ªgtØg’”©fÜe¡,†ik0-100" 
CRLF


123 " -s, --¡ršg-max-Ëngth :hmax sŒšg†’gthØg’”©fÜe¡, sŒšg i fÜ STRING/LIST... v®u–em’t" 
CRLF


124 " -f, --f›lds-max-couÁ :hmax f›ld couÁØg’”©fÜe¡, f›ld i thLIST/HASH...' –em’t" 
CRLF


125 " -T, --commªd-ty³  :hcommªdy³ tØg’”©fÜe¡,†ik¡ršg,hash,key" 
CRLF


126 " -B, --commªd-bÏck-li¡ :hcommªd nÙ wªˆtØ‹¡,†ikd–,Ìªge,mg‘" 
CRLF


127 " -W, --commªd-wh™e-li¡ :hcommªd Úly‡Îow tØ‹¡,†ikd–,Ìªge,mg‘" 
CRLF


128 " -t, --‹¡-rg‘  :h‹¡¬g‘ fÜe¡,†ikvœe[127.0.0.1:12301]-»dis[127.0.0.1:12311]" 
CRLF


129 " -p, --´oduû-d©a-th»ad  :hth»ad couÁØ´oduûe¡ d©a" 
CRLF


130 " -K, --ÿched-key  :hÿched key couÁ fÜƒv”y…roduû d©¨th»ad" 
CRLF


131 " -H, --h™-¿tiØ :hh™„©iØfÜ„—dÚly commªds, b‘w“À0‡nd 100" 
CRLF


132 " -d, --di¥©ch-d©a-th»ad  :hth»ad couÁØdi¥©che¡ d©¨tØrg‘ groups" 
CRLF


133 " -c, --ş›Á  :hş›Á couÁ fÜƒv”y di¥©ch d©¨th»ad" 
CRLF


134 " -o, --log-f : s‘†oggšg f(deçuÉ: %s)" 
CRLF


136 
CONFIG_DEFAULT_LOGFILE
 !ğ
NULL
 ? CONFIG_DEFAULT_LOGFILE : "stderr");

137 
	}
}

140 
	$v¹_£t_deçuÉ_İtiÚs
()

142 
cÚfig
.
pid_f’ame
 = 
CONFIG_DEFAULT_PIDFILE
;

143 
cÚfig
.
check”
 = 
CONFIG_DEFAULT_CHECKER
;

144 
cÚfig
.
‹¡_š‹rv®
 = 
CONFIG_DEFAULT_TEST_INTERVAL
;

145 
cÚfig
.
key_Ëngth_¿nge_begš
 = 
CONFIG_DEFAULT_KEY_LENGTH_RANGE_BEGIN
;

146 
cÚfig
.
key_Ëngth_¿nge_’d
 = 
CONFIG_DEFAULT_KEY_LENGTH_RANGE_END
;

147 
cÚfig
.
¡ršg_max_Ëngth
 = 
CONFIG_DEFAULT_STRING_MAX_LENGTH
;

148 
cÚfig
.
f›lds_max_couÁ
 = 
CONFIG_DEFAULT_FIELDS_MAX_COUNT
;

149 
cÚfig
.
cmd_ty³
 = 
TEST_CMD_TYPE_STRING
|
TEST_CMD_TYPE_LIST
|

150 
TEST_CMD_TYPE_SET
|
TEST_CMD_TYPE_ZSET
|
TEST_CMD_TYPE_HASH
|

151 
TEST_CMD_TYPE_SERVER
|
TEST_CMD_TYPE_KEY
;

152 
cÚfig
.
cmd_bÏckli¡
 = 
NULL
;

153 
cÚfig
.
cmd_wh™–i¡
 = 
NULL
;

154 
cÚfig
.
‹¡_rg‘s
 = 
CONFIG_DEFAULT_TEST_TARGET
;

155 
cÚfig
.
´oduû_d©a_th»ads
 = 
CONFIG_DEFAULT_PRODUCE_THREADS_COUNT
;

156 
cÚfig
.
ÿched_keys_³r_´oduû_th»ad
 = 
CONFIG_DEFAULT_CACHED_KEYS_COUNT
;

157 
cÚfig
.
h™_¿tio
 = 
CONFIG_DEFAULT_HIT_RATIO
;

158 
cÚfig
.
di¥©ch_d©a_th»ads
 = 
CONFIG_DEFAULT_DISPATCH_THREADS_COUNT
;

159 
cÚfig
.
ş›Ás_³r_di¥©ch_th»ad
 = 
CONFIG_DEFAULT_CLIENTS_PER_DISPATCH_THREAD
;

160 
cÚfig
.
log_f’ame
 = 
CONFIG_DEFAULT_LOGFILE
;

162 
expœe_’abËd
 = 0;

163 
	}
}

166 
	$v¹_ş—n_İtiÚs
()

168 ià(
cÚfig
.
cmd_bÏckli¡
 !ğ
NULL
) {

169 
sds
 *
commªd
;

170 
	`d¬¿y_n
(
cÚfig
.
cmd_bÏckli¡
) > 0) {

171 
commªd
 = 
	`d¬¿y_pİ
(
cÚfig
.
cmd_bÏckli¡
);

172 
	`sdsä“
(
commªd
);

174 
	`d¬¿y_de¡roy
(
cÚfig
.
cmd_bÏckli¡
);

175 
cÚfig
.
cmd_bÏckli¡
 = 
NULL
;

178 ià(
cÚfig
.
cmd_wh™–i¡
 !ğ
NULL
) {

179 
sds
 *
commªd
;

180 
	`d¬¿y_n
(
cÚfig
.
cmd_wh™–i¡
) > 0) {

181 
commªd
 = 
	`d¬¿y_pİ
(
cÚfig
.
cmd_wh™–i¡
);

182 
	`sdsä“
(
commªd
);

184 
	`d¬¿y_de¡roy
(
cÚfig
.
cmd_wh™–i¡
);

185 
cÚfig
.
cmd_wh™–i¡
 = 
NULL
;

187 
	}
}

190 
	$v¹_g‘_İtiÚs
(
¬gc
, **
¬gv
)

192 
c
;

193 
lv®ue
;

194 
Îv®ue
;

195 *
¿nge
;

196 
¿nge_couÁ
;

198 
İ‹¼
 = 0;

201 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İtiÚs
, 
lÚg_İtiÚs
, 
NULL
);

202 ià(
c
 == -1) {

207 
c
) {

209 
show_v”siÚ
 = 1;

210 
show_h–p
 = 1;

214 
show_v”siÚ
 = 1;

218 
d«mÚize
 = 1;

222 
expœe_’abËd
 = 1;

226 
cÚfig
.
check”
 = 
İrg
;

230 ià(
	`¡ršg2Î
(
İrg
,
	`¡¾’
(İrg),&
Îv®ue
) != 1) {

231 
	`log_¡d”r
("vireabtest: option -i„equires‡‚umber");

232  
VRT_ERROR
;

234 
cÚfig
.
‹¡_š‹rv®
 = 
Îv®ue
;

238 
¿nge
 = 
	`g‘_¿nge_äom_¡ršg
(
İrg
,
	`¡¾’
(İrg),&
¿nge_couÁ
);

239 ià(
¿nge
 =ğ
NULL
) {

240 
	`log_¡d”r
("vireabtest: option -k is invalid, you‚eed input‡„ange†ike 0-100");

241  
VRT_ERROR
;

243 
cÚfig
.
key_Ëngth_¿nge_begš
 = ()
¿nge
[0];

244 ià(
¿nge_couÁ
 =ğ1è
cÚfig
.
key_Ëngth_¿nge_’d
 = ()
¿nge
[0];

245 ià(
¿nge_couÁ
 =ğ2è
cÚfig
.
key_Ëngth_¿nge_’d
 = ()
¿nge
[1];

246 
	`as£¹
(0);

248 
	`ä“
(
¿nge
);

253 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

254 
	`log_¡d”r
("vireabtest: option -s„equires‡‚umber");

255  
VRT_ERROR
;

257 
cÚfig
.
¡ršg_max_Ëngth
 = ()
lv®ue
;

261 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

262 
	`log_¡d”r
("vireabtest: option -f„equires‡‚umber");

263  
VRT_ERROR
;

265 
cÚfig
.
f›lds_max_couÁ
 = ()
lv®ue
;

269 
cÚfig
.
cmd_ty³
 = 
	`·r£_commªd_ty³s
(
İrg
);

270 ià(
cÚfig
.
cmd_ty³
 <= 0) {

271 
	`log_¡d”r
("vireabtest: option -T„equireshe correct commandypes");

272  
VRT_ERROR
;

277 
cÚfig
.
cmd_bÏckli¡
 = 
	`·r£_commªd_li¡
(
İrg
);

278 ià(
cÚfig
.
cmd_bÏckli¡
 =ğ
NULL
) {

279 
	`log_¡d”r
("vireabtest: option -B„equireshe correct command†ist");

280  
VRT_ERROR
;

285 
cÚfig
.
cmd_wh™–i¡
 = 
	`·r£_commªd_li¡
(
İrg
);

286 ià(
cÚfig
.
cmd_wh™–i¡
 =ğ
NULL
) {

287 
	`log_¡d”r
("vireabtest: option -W„equireshe correct command†ist");

288  
VRT_ERROR
;

293 
cÚfig
.
‹¡_rg‘s
 = 
İrg
;

297 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

298 
	`log_¡d”r
("vireabtest: option -p„equires‡‚umber");

299  
VRT_ERROR
;

301 
cÚfig
.
´oduû_d©a_th»ads
 = ()
lv®ue
;

305 ià(
	`¡ršg2Î
(
İrg
,
	`¡¾’
(İrg),&
Îv®ue
) != 1) {

306 
	`log_¡d”r
("vireabtest: option -K„equires‡‚umber");

307  
VRT_ERROR
;

309 ià(
Îv®ue
 < 1000) {

310 
	`log_¡d”r
("vireabtest: option -K„equires‡‚umberhat must biggerhan 1000");

311  
VRT_ERROR
;

314 
cÚfig
.
ÿched_keys_³r_´oduû_th»ad
 = 
Îv®ue
;

318 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

319 
	`log_¡d”r
("vireabtest: option -H„equires‡‚umber");

320  
VRT_ERROR
;

322 ià(
lv®ue
 < 0 ||†value > 100) {

323 
	`log_¡d”r
("vireabtest: option hit-ratio‚eed between 0‡nd 100");

324  
VRT_ERROR
;

326 
cÚfig
.
h™_¿tio
 = ()
lv®ue
;

330 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

331 
	`log_¡d”r
("vireabtest: option -d„equires‡‚umber");

332  
VRT_ERROR
;

334 
cÚfig
.
di¥©ch_d©a_th»ads
 = ()
lv®ue
;

338 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

339 
	`log_¡d”r
("vireabtest: option -c„equires‡‚umber");

340  
VRT_ERROR
;

342 
cÚfig
.
ş›Ás_³r_di¥©ch_th»ad
 = ()
lv®ue
;

346 
cÚfig
.
pid_f’ame
 = 
İrg
;

350 
cÚfig
.
log_f’ame
 = 
İrg
;

354 
İtİt
) {

363 
	`log_¡d”r
("vire: option -%c„equires string",

364 
İtİt
);

372 
	`log_¡d”r
("vire: option -%c„equires‚umber",

373 
İtİt
);

377 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

380  
VRT_ERROR
;

383 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

384  
VRT_ERROR
;

389  
VRT_OK
;

390 
	}
}

392 
	$v¹_d«mÚize
(
dump_cÜe
)

394 
»t
;

395 
pid_t
 
pid
, 
sid
;

396 
fd
;

398 
pid
 = 
	`fÜk
();

399 
pid
) {

401 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

402  
VRT_ERROR
;

409 
	`_ex™
(0);

414 
sid
 = 
	`£tsid
();

415 ià(
sid
 < 0) {

416 
	`log_”rÜ
("£tsid(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

417  
VRT_ERROR
;

420 ià(
	`sigÇl
(
SIGHUP
, 
SIG_IGN
è=ğ
SIG_ERR
) {

421 
	`log_”rÜ
("sigÇl(SIGHUP, SIG_IGNèçed: %s", 
	`¡»¼Ü
(
”ºo
));

422  
VRT_ERROR
;

425 
pid
 = 
	`fÜk
();

426 
pid
) {

428 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

429  
VRT_ERROR
;

436 
	`_ex™
(0);

442 ià(
dump_cÜe
 == 0) {

443 
»t
 = 
	`chdœ
("/");

444 ià(
»t
 < 0) {

445 
	`log_”rÜ
("chdœ(\"/\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

446  
VRT_ERROR
;

451 
	`umask
(0);

455 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

456 ià(
fd
 < 0) {

457 
	`log_”rÜ
("İ’(\"/dev/nuÎ\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

458  
VRT_ERROR
;

461 
»t
 = 
	`dup2
(
fd
, 
STDIN_FILENO
);

462 ià(
»t
 < 0) {

463 
	`log_”rÜ
("dup2(%d, STDINèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

464 
	`şo£
(
fd
);

465  
VRT_ERROR
;

468 
»t
 = 
	`dup2
(
fd
, 
STDOUT_FILENO
);

469 ià(
»t
 < 0) {

470 
	`log_”rÜ
("dup2(%d, STDOUTèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

471 
	`şo£
(
fd
);

472  
VRT_ERROR
;

475 
»t
 = 
	`dup2
(
fd
, 
STDERR_FILENO
);

476 ià(
»t
 < 0) {

477 
	`log_”rÜ
("dup2(%d, STDERRèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

478 
	`şo£
(
fd
);

479  
VRT_ERROR
;

482 ià(
fd
 > 
STDERR_FILENO
) {

483 
»t
 = 
	`şo£
(
fd
);

484 ià(
»t
 < 0) {

485 
	`log_”rÜ
("şo£(%dèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

486  
VRT_ERROR
;

490  
VRT_OK
;

491 
	}
}

493 
	$ab‹¡_£rv”_š™
(
ab‹¡_£rv”
 *
abs
, *
add»ss
)

495 
sds
 *
ho¡_pÜt
;

496 
couÁ
;

497 
v®ue
;

499 
abs
->
ho¡
 = 
NULL
;

500 
abs
->
pÜt
 = 0;

501 
abs
->
cÚn_cÚ‹xts
 = 
NULL
;

502 
abs
->
d©a
 = 
NULL
;

504 
ho¡_pÜt
 = 
	`sds¥l™Ën
(
add»ss
,
	`¡¾’
×dd»ss),":",1,&
couÁ
);

505 ià(
ho¡_pÜt
 =ğ
NULL
) {

506  
VRT_ERROR
;

507 } ià(
couÁ
 != 2) {

508 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

509  
VRT_ERROR
;

512 
abs
->
ho¡
 = 
ho¡_pÜt
[0];

513 
ho¡_pÜt
[0] = 
NULL
;

515 ià(
	`¡ršg2l
(
ho¡_pÜt
[1],
	`sd¦’
(ho¡_pÜt[1]),&
v®ue
) != 1) {

516 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

517  
VRT_ERROR
;

520 
abs
->
pÜt
 = ()
v®ue
;

521 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

523  
VRT_OK
;

524 
	}
}

526 
	$ab‹¡_£rv”_deš™
(
ab‹¡_£rv”
 *
abs
)

528 ià(
abs
->
ho¡
) {

529 
	`sdsä“
(
abs
->
ho¡
);

530 
abs
->
ho¡
 = 
NULL
;

533 ià(
abs
->
pÜt
 > 0)‡bs->port = 0;

535 ià(
abs
->
cÚn_cÚ‹xts
) {

536 
	`ASSERT
(
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) == 0);

537 
	`d¬¿y_de¡roy
(
abs
->
cÚn_cÚ‹xts
);

538 
abs
->
cÚn_cÚ‹xts
 = 
NULL
;

540 
	}
}

542 
	$g‘_back’d_£rv”_idx
(
ab‹¡_group
 *
abg
, *
key
, 
size_t
 
keyËn
)

544 
hashv®ue
, 
£rv”s_couÁ
;

546 
£rv”s_couÁ
 = 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
);

547 ià(
£rv”s_couÁ
 == 1) {

551 
hashv®ue
 = ()
	`hash_üc32a
(
key
, 
keyËn
);

553  
hashv®ue
%
£rv”s_couÁ
;

554 
	}
}

556 
ab‹¡_£rv”
 *
	$g‘_back’d_£rv”
(
ab‹¡_group
 *
abg
, *
key
, 
size_t
 
keyËn
)

558 
ab‹¡_£rv”
 *
abs
;

559 
idx
;

561 
idx
 = 
abg
->
	`g‘_back’d_£rv”_idx
×bg,
key
,
keyËn
);

562 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
idx
);

564  
abs
;

565 
	}
}

567 
	$ab‹¡_group_š™
(
ab‹¡_group
 *
abg
, *
group_¡ršg
)

569 
sds
 *
ty³_addrs
, *
addrs
;

570 
ty³_addrs_couÁ
, 
addrs_couÁ
;

571 
j
;

573 
abg
->
ty³
 = 0;

574 
	`d¬¿y_š™
(&
abg
->
ab‹¡_£rv”s
, 1, (
ab‹¡_£rv”
));

576 
ty³_addrs
 = 
	`sds¥l™Ën
(
group_¡ršg
,
	`sd¦’
(group_¡ršg),"[",1,&
ty³_addrs_couÁ
);

577 ià(
ty³_addrs
 =ğ
NULL
) {

578  
VRT_ERROR
;

579 } ià(
ty³_addrs_couÁ
 != 2) {

580 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

581  
VRT_ERROR
;

584 ià(!
	`¡rÿ£cmp
(
ty³_addrs
[0],"vire")) {

585 
abg
->
ty³
 = 
VRABTEST_GROUP_TYPE_VIRE
;

586 } ià(!
	`¡rÿ£cmp
(
ty³_addrs
[0],"redis")) {

587 
abg
->
ty³
 = 
VRABTEST_GROUP_TYPE_REDIS
;

589 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

590  
VRT_ERROR
;

593 ià(
	`sd¦’
(
ty³_addrs
[1]) <= 1 ||

594 
ty³_addrs
[1][
	`sd¦’
(type_addrs[1])-1] != ']') {

595 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

596  
VRT_ERROR
;

599 
	`sd¤ªge
(
ty³_addrs
[1],0,-2);

601 
addrs
 = 
	`sds¥l™Ën
(
ty³_addrs
[1],
	`sd¦’
Ñy³_addrs[1]),",",1,&
addrs_couÁ
);

602 ià(
addrs
 =ğ
NULL
) {

603 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

604  
VRT_ERROR
;

605 } ià(
addrs_couÁ
 < 1) {

606 
	`sdsä“¥l™»s
(
addrs
,
addrs_couÁ
);

607 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

608  
VRT_ERROR
;

611 
j
 = 0; j < 
addrs_couÁ
; j ++) {

612 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_push
(&
abg
->
ab‹¡_£rv”s
);

613 ià(
	`ab‹¡_£rv”_š™
(
abs
,
addrs
[
j
]è!ğ
VRT_OK
) {

614 
	`sdsä“¥l™»s
(
addrs
,
addrs_couÁ
);

615 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

616  
VRT_ERROR
;

620 
	`sdsä“¥l™»s
(
addrs
,
addrs_couÁ
);

621 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

623 
abg
->
g‘_back’d_£rv”_idx
 = get_backend_server_idx;

624 
abg
->
g‘_back’d_£rv”
 = get_backend_server;

626  
VRT_OK
;

627 
	}
}

629 
	$ab‹¡_group_deš™
(
ab‹¡_group
 *
abg
)

631 
ab‹¡_£rv”
 *
abs
;

633 
abg
->
ty³
 = 0;

635 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
) > 0) {

636 
abs
 = 
	`d¬¿y_pİ
(&
abg
->
ab‹¡_£rv”s
);

637 
	`ab‹¡_£rv”_deš™
(
abs
);

639 
	`d¬¿y_deš™
(&
abg
->
ab‹¡_£rv”s
);

640 
	}
}

643 
d¬¿y
 *
	$ab‹¡_groups_ü—‹
(*
groups_¡ršg
)

645 
d¬¿y
 *
abgs
;

646 
sds
 *
group_¡ršgs
;

647 
group_couÁ
, 
j
;

649 
group_¡ršgs
 = 
	`sds¥l™Ën
(
groups_¡ršg
,
	`¡¾’
(groups_¡ršg),"-",1,&
group_couÁ
);

650 ià(
group_¡ršgs
 =ğ
NULL
) {

651  
NULL
;

652 } ià(
group_couÁ
 < 1) {

653 
	`sdsä“¥l™»s
(
group_¡ršgs
,
group_couÁ
);

654  
NULL
;

657 
abgs
 = 
	`d¬¿y_ü—‹
(2, (
ab‹¡_group
));

658 ià(
abgs
 =ğ
NULL
) {

659 
	`sdsä“¥l™»s
(
group_¡ršgs
,
group_couÁ
);

660  
NULL
;

663 
j
 = 0; j < 
group_couÁ
; j ++) {

664 
ab‹¡_group
 *
abg
;

665 
sds
 
group_¡ršg
 = 
group_¡ršgs
[
j
];

666 
sds
 *
ty³_addrs
;

667 
–em_couÁ
;

669 
abg
 = 
	`d¬¿y_push
(
abgs
);

670 ià(
	`ab‹¡_group_š™
(
abg
,
group_¡ršg
è!ğ
VRT_OK
) {

671 
	`sdsä“¥l™»s
(
group_¡ršgs
,
group_couÁ
);

672 
	`ab‹¡_groups_de¡roy
(
abgs
);

673  
NULL
;

677  
abgs
;

678 
	}
}

680 
	$ab‹¡_groups_de¡roy
(
d¬¿y
 *
abgs
)

682 
	`d¬¿y_n
(
abgs
) > 0) {

683 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_pİ
(
abgs
);

684 
	`ab‹¡_group_deš™
(
abg
);

687 
	`d¬¿y_de¡roy
(
abgs
);

688 
	}
}

691 
	$maš
(
¬gc
, **
¬gv
)

693 
»t
;

695 
	`v¹_£t_deçuÉ_İtiÚs
();

697 
»t
 = 
	`v¹_g‘_İtiÚs
(
¬gc
, 
¬gv
);

698 ià(
»t
 !ğ
VRT_OK
) {

699 
	`v¹_show_u§ge
();

700 
	`ex™
(1);

703 ià(
show_v”siÚ
) {

704 
	`log_¡dout
("Thi i vœ—b‹¡-%s", 
VR_VERSION_STRING
);

705 ià(
show_h–p
) {

706 
	`v¹_show_u§ge
();

708 
	`ex™
(0);

711 
»t
 = 
	`log_š™
(
LOG_INFO
, 
cÚfig
.
log_f’ame
);

712 ià(
»t
 < 0) {

713 
	`ex™
(1);

716 ià(
d«mÚize
) {

717 
»t
 = 
	`v¹_d«mÚize
(1);

718 ià(
»t
 !ğ
VRT_OK
) {

719 
	`ex™
(1);

723 
‹¡_š‹rv®
 = 
cÚfig
.test_interval;

725 
»t
 = 
	`v¹_´oduû_d©a_š™
(
cÚfig
.
key_Ëngth_¿nge_begš
,

726 
cÚfig
.
key_Ëngth_¿nge_’d
,

727 
cÚfig
.
¡ršg_max_Ëngth
,cÚfig.
f›lds_max_couÁ
,

728 
cÚfig
.
cmd_ty³
,cÚfig.
cmd_bÏckli¡
,cÚfig.
cmd_wh™–i¡
,

729 
cÚfig
.
´oduû_d©a_th»ads
,

730 
cÚfig
.
ÿched_keys_³r_´oduû_th»ad
,

731 
cÚfig
.
h™_¿tio
);

732 ià(
»t
 !ğ
VRT_OK
) {

733 
	`log_”rÜ
("Init data…roducer failed");

734 
	`ex™
(1);

736 
»t
 = 
	`v¹_di¥©ch_d©a_š™
(
cÚfig
.
di¥©ch_d©a_th»ads
,

737 
cÚfig
.
‹¡_rg‘s
, cÚfig.
ş›Ás_³r_di¥©ch_th»ad
);

738 ià(
»t
 !ğ
VRT_OK
) {

739 
	`log_”rÜ
("Init data dispatcher failed");

740 
	`ex™
(1);

742 
»t
 = 
	`v¹_back’d_š™
(
cÚfig
.
di¥©ch_d©a_th»ads
,

743 
cÚfig
.
‹¡_rg‘s
);

744 ià(
»t
 !ğ
VRT_OK
) {

745 
	`log_”rÜ
("Init backendhread failed");

746 
	`ex™
(1);

748 
»t
 = 
	`v¹_d©a_check”_š™
(
cÚfig
.
check”
, cÚfig.
‹¡_rg‘s
);

749 ià(
»t
 !ğ
VRT_OK
) {

750 
	`log_”rÜ
("Init check datahread failed");

751 
	`ex™
(1);

754 
	`log_debug
(
LOG_INFO
,"S‹†ocky³: %s", 
TEST_STATE_LOCK_TYPE
);

756 
	`v¹_¡¬t_´oduû_d©a
();

757 
	`v¹_¡¬t_di¥©ch_d©a
();

758 
	`v¹_¡¬t_back’d
();

759 
	`v¹_¡¬t_d©a_check”
();

761 
	`v¹_wa™_´oduû_d©a
();

762 
	`v¹_wa™_di¥©ch_d©a
();

763 
	`v¹_wa™_back’d
();

764 
	`v¹_wa™_d©a_check”
();

766 
	`v¹_d©a_check”_deš™
();

767 
	`v¹_back’d_deš™
();

768 
	`v¹_di¥©ch_d©a_deš™
();

769 
	`v¹_´oduû_d©a_deš™
();

771 
	`log_deš™
();

772 
	`v¹_ş—n_İtiÚs
();

774  
VRT_OK
;

775 
	}
}

	@tests/vrabtest.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<fú.h
>

5 
	~<”ºo.h
>

6 
	~<sigÇl.h
>

7 
	~<as£¹.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

12 
	~<d¬¿y.h
>

13 
	~<dlog.h
>

15 
	~<v¹_ut.h
>

16 
	~<v¹_public.h
>

17 
	~<v¹_´oduû_d©a.h
>

18 
	~<v¹_di¥©ch_d©a.h
>

19 
	~<v¹_check_d©a.h
>

20 
	~<v¹_back’d.h
>

21 
	~<v¿b‹¡.h
>

23 
	#CONFIG_DEFAULT_PIDFILE
 
NULL


	)

24 
	#CONFIG_DEFAULT_CHECKER
 "my£lf"

	)

25 
	#CONFIG_DEFAULT_TEST_INTERVAL
 3600

	)

26 
	#CONFIG_DEFAULT_KEY_LENGTH_RANGE_BEGIN
 0

	)

27 
	#CONFIG_DEFAULT_KEY_LENGTH_RANGE_END
 100

	)

28 
	#CONFIG_DEFAULT_STRING_MAX_LENGTH
 512

	)

29 
	#CONFIG_DEFAULT_FIELDS_MAX_COUNT
 16

	)

30 
	#CONFIG_DEFAULT_TEST_TARGET
 ""

	)

31 
	#CONFIG_DEFAULT_PRODUCE_THREADS_COUNT
 1

	)

32 
	#CONFIG_DEFAULT_CACHED_KEYS_COUNT
 10000

	)

33 
	#CONFIG_DEFAULT_HIT_RATIO
 75

	)

34 
	#CONFIG_DEFAULT_DISPATCH_THREADS_COUNT
 1

	)

35 
	#CONFIG_DEFAULT_CLIENTS_PER_DISPATCH_THREAD
 10

	)

36 
	#CONFIG_DEFAULT_LOGFILE
 
NULL


	)

38 
	#VRABTEST_GROUP_TYPE_REDIS
 0

	)

39 
	#VRABTEST_GROUP_TYPE_VIRE
 1

	)

41 
	scÚfig
 {

42 *
	mcheck”
;

43 
	m‹¡_š‹rv®
;

44 
	mkey_Ëngth_¿nge_begš
;

45 
	mkey_Ëngth_¿nge_’d
;

46 
	m¡ršg_max_Ëngth
;

47 
	mf›lds_max_couÁ
;

48 
	mcmd_ty³
;

49 
d¬¿y
 *
	mcmd_bÏckli¡
;

50 
d¬¿y
 *
	mcmd_wh™–i¡
;

51 *
	m‹¡_rg‘s
;

52 
	m´oduû_d©a_th»ads
;

53 
	mÿched_keys_³r_´oduû_th»ad
;

54 
	mh™_¿tio
;

55 
	mdi¥©ch_d©a_th»ads
;

56 
	mş›Ás_³r_di¥©ch_th»ad
;

57 *
	mpid_f’ame
;

58 *
	mlog_f’ame
;

61 
cÚfig
 
	gcÚfig
;

63 
	gshow_h–p
;

64 
	gshow_v”siÚ
;

65 
	gd«mÚize
;

70 
	gexpœe_’abËd
;

74 
	g‹¡_š‹rv®
;

78 
	gÏ¡_‹¡_begš_time
;

80 
İtiÚ
 
	glÚg_İtiÚs
[] = {

81 { "h–p", 
no_¬gum’t
, 
NULL
, 'h' },

82 { "v”siÚ", 
no_¬gum’t
, 
NULL
, 'V' },

83 { "d«mÚize", 
no_¬gum’t
, 
NULL
, 'D' },

84 { "’abË-expœe", 
no_¬gum’t
, 
NULL
, 'E' },

85 { "pid-fe", 
»quœed_¬gum’t
, 
NULL
, 'P' },

86 { "check”", 
»quœed_¬gum’t
, 
NULL
, 'C' },

87 { "‹¡-š‹rv®", 
»quœed_¬gum’t
, 
NULL
, 'i' },

88 { "key-Ëngth-¿nge", 
»quœed_¬gum’t
, 
NULL
, 'k' },

89 { "¡ršg-max-Ëngth", 
»quœed_¬gum’t
, 
NULL
, 's' },

90 { "f›lds-max-couÁ", 
»quœed_¬gum’t
, 
NULL
, 'f' },

91 { "commªd-ty³s", 
»quœed_¬gum’t
, 
NULL
, 'T' },

92 { "commªd-bÏck-li¡", 
»quœed_¬gum’t
, 
NULL
, 'B' },

93 { "commªd-wh™e-li¡", 
»quœed_¬gum’t
, 
NULL
, 'W' },

94 { "‹¡-rg‘s", 
»quœed_¬gum’t
, 
NULL
, 't' },

95 { "´oduû-d©a-th»ads", 
»quœed_¬gum’t
, 
NULL
, 'p' },

96 { "ÿched-keys", 
»quœed_¬gum’t
, 
NULL
, 'K' },

97 { "h™-¿tio", 
»quœed_¬gum’t
, 
NULL
, 'H' },

98 { "di¥©ch-d©a-th»ads", 
»quœed_¬gum’t
, 
NULL
, 'd' },

99 { "ş›Ás", 
»quœed_¬gum’t
, 
NULL
, 'c' },

100 { "log-fe", 
»quœed_¬gum’t
, 
NULL
, 'o' },

101 { 
NULL
, 0, NULL, 0 }

104 
	gshÜt_İtiÚs
[] = "hVDEP:C:i:k:s:f:T:B:W:t:p:K:H:d:c:o:";

107 
	$v¹_show_u§ge
()

109 
	`´štf
(

110 "U§ge: vœ—b‹¡ [-?hVDE]" 
CRLF


111 "" 
CRLF
);

112 
	`´štf
(

113 "O±iÚs:" 
CRLF


114 " -h, --h–° :hi h–p" 
CRLF


115 " -V, --v”siÚ : show v”siÚ‡ndƒx™" 
CRLF


116 " -D, --d«mÚiz :„uÀa ¨d«mÚ" 
CRLF


117 " -E, --’abË-expœ :ƒÇbËhexpœe" 
CRLF
);

118 
	`´štf
(

119 " -P, --pid-f :…id fe" 
CRLF


120 " -C, --check” :hcheck”Øcheck d©¨cÚsi¡’cy" 
CRLF


121 " -i, --‹¡-š‹rv® :hš‹rv® fÜ checkšg d©¨cÚsi¡’cy, un™ i £cÚd" 
CRLF


122 " -k, --key-Ëngth-¿ng :hkey†’gth„ªgtØg’”©fÜe¡,†ik0-100" 
CRLF


123 " -s, --¡ršg-max-Ëngth :hmax sŒšg†’gthØg’”©fÜe¡, sŒšg i fÜ STRING/LIST... v®u–em’t" 
CRLF


124 " -f, --f›lds-max-couÁ :hmax f›ld couÁØg’”©fÜe¡, f›ld i thLIST/HASH...' –em’t" 
CRLF


125 " -T, --commªd-ty³  :hcommªdy³ tØg’”©fÜe¡,†ik¡ršg,hash,key" 
CRLF


126 " -B, --commªd-bÏck-li¡ :hcommªd nÙ wªˆtØ‹¡,†ikd–,Ìªge,mg‘" 
CRLF


127 " -W, --commªd-wh™e-li¡ :hcommªd Úly‡Îow tØ‹¡,†ikd–,Ìªge,mg‘" 
CRLF


128 " -t, --‹¡-rg‘  :h‹¡¬g‘ fÜe¡,†ikvœe[127.0.0.1:12301]-»dis[127.0.0.1:12311]" 
CRLF


129 " -p, --´oduû-d©a-th»ad  :hth»ad couÁØ´oduûe¡ d©a" 
CRLF


130 " -K, --ÿched-key  :hÿched key couÁ fÜƒv”y…roduû d©¨th»ad" 
CRLF


131 " -H, --h™-¿tiØ :hh™„©iØfÜ„—dÚly commªds, b‘w“À0‡nd 100" 
CRLF


132 " -d, --di¥©ch-d©a-th»ad  :hth»ad couÁØdi¥©che¡ d©¨tØrg‘ groups" 
CRLF


133 " -c, --ş›Á  :hş›Á couÁ fÜƒv”y di¥©ch d©¨th»ad" 
CRLF


134 " -o, --log-f : s‘†oggšg f(deçuÉ: %s)" 
CRLF


136 
CONFIG_DEFAULT_LOGFILE
 !ğ
NULL
 ? CONFIG_DEFAULT_LOGFILE : "stderr");

137 
	}
}

140 
	$v¹_£t_deçuÉ_İtiÚs
()

142 
cÚfig
.
pid_f’ame
 = 
CONFIG_DEFAULT_PIDFILE
;

143 
cÚfig
.
check”
 = 
CONFIG_DEFAULT_CHECKER
;

144 
cÚfig
.
‹¡_š‹rv®
 = 
CONFIG_DEFAULT_TEST_INTERVAL
;

145 
cÚfig
.
key_Ëngth_¿nge_begš
 = 
CONFIG_DEFAULT_KEY_LENGTH_RANGE_BEGIN
;

146 
cÚfig
.
key_Ëngth_¿nge_’d
 = 
CONFIG_DEFAULT_KEY_LENGTH_RANGE_END
;

147 
cÚfig
.
¡ršg_max_Ëngth
 = 
CONFIG_DEFAULT_STRING_MAX_LENGTH
;

148 
cÚfig
.
f›lds_max_couÁ
 = 
CONFIG_DEFAULT_FIELDS_MAX_COUNT
;

149 
cÚfig
.
cmd_ty³
 = 
TEST_CMD_TYPE_STRING
|
TEST_CMD_TYPE_LIST
|

150 
TEST_CMD_TYPE_SET
|
TEST_CMD_TYPE_ZSET
|
TEST_CMD_TYPE_HASH
|

151 
TEST_CMD_TYPE_SERVER
|
TEST_CMD_TYPE_KEY
;

152 
cÚfig
.
cmd_bÏckli¡
 = 
NULL
;

153 
cÚfig
.
cmd_wh™–i¡
 = 
NULL
;

154 
cÚfig
.
‹¡_rg‘s
 = 
CONFIG_DEFAULT_TEST_TARGET
;

155 
cÚfig
.
´oduû_d©a_th»ads
 = 
CONFIG_DEFAULT_PRODUCE_THREADS_COUNT
;

156 
cÚfig
.
ÿched_keys_³r_´oduû_th»ad
 = 
CONFIG_DEFAULT_CACHED_KEYS_COUNT
;

157 
cÚfig
.
h™_¿tio
 = 
CONFIG_DEFAULT_HIT_RATIO
;

158 
cÚfig
.
di¥©ch_d©a_th»ads
 = 
CONFIG_DEFAULT_DISPATCH_THREADS_COUNT
;

159 
cÚfig
.
ş›Ás_³r_di¥©ch_th»ad
 = 
CONFIG_DEFAULT_CLIENTS_PER_DISPATCH_THREAD
;

160 
cÚfig
.
log_f’ame
 = 
CONFIG_DEFAULT_LOGFILE
;

162 
expœe_’abËd
 = 0;

163 
	}
}

166 
	$v¹_ş—n_İtiÚs
()

168 ià(
cÚfig
.
cmd_bÏckli¡
 !ğ
NULL
) {

169 
sds
 *
commªd
;

170 
	`d¬¿y_n
(
cÚfig
.
cmd_bÏckli¡
) > 0) {

171 
commªd
 = 
	`d¬¿y_pİ
(
cÚfig
.
cmd_bÏckli¡
);

172 
	`sdsä“
(
commªd
);

174 
	`d¬¿y_de¡roy
(
cÚfig
.
cmd_bÏckli¡
);

175 
cÚfig
.
cmd_bÏckli¡
 = 
NULL
;

178 ià(
cÚfig
.
cmd_wh™–i¡
 !ğ
NULL
) {

179 
sds
 *
commªd
;

180 
	`d¬¿y_n
(
cÚfig
.
cmd_wh™–i¡
) > 0) {

181 
commªd
 = 
	`d¬¿y_pİ
(
cÚfig
.
cmd_wh™–i¡
);

182 
	`sdsä“
(
commªd
);

184 
	`d¬¿y_de¡roy
(
cÚfig
.
cmd_wh™–i¡
);

185 
cÚfig
.
cmd_wh™–i¡
 = 
NULL
;

187 
	}
}

190 
	$v¹_g‘_İtiÚs
(
¬gc
, **
¬gv
)

192 
c
;

193 
lv®ue
;

194 
Îv®ue
;

195 *
¿nge
;

196 
¿nge_couÁ
;

198 
İ‹¼
 = 0;

201 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İtiÚs
, 
lÚg_İtiÚs
, 
NULL
);

202 ià(
c
 == -1) {

207 
c
) {

209 
show_v”siÚ
 = 1;

210 
show_h–p
 = 1;

214 
show_v”siÚ
 = 1;

218 
d«mÚize
 = 1;

222 
expœe_’abËd
 = 1;

226 
cÚfig
.
check”
 = 
İrg
;

230 ià(
	`¡ršg2Î
(
İrg
,
	`¡¾’
(İrg),&
Îv®ue
) != 1) {

231 
	`log_¡d”r
("vireabtest: option -i„equires‡‚umber");

232  
VRT_ERROR
;

234 
cÚfig
.
‹¡_š‹rv®
 = 
Îv®ue
;

238 
¿nge
 = 
	`g‘_¿nge_äom_¡ršg
(
İrg
,
	`¡¾’
(İrg),&
¿nge_couÁ
);

239 ià(
¿nge
 =ğ
NULL
) {

240 
	`log_¡d”r
("vireabtest: option -k is invalid, you‚eed input‡„ange†ike 0-100");

241  
VRT_ERROR
;

243 
cÚfig
.
key_Ëngth_¿nge_begš
 = ()
¿nge
[0];

244 ià(
¿nge_couÁ
 =ğ1è
cÚfig
.
key_Ëngth_¿nge_’d
 = ()
¿nge
[0];

245 ià(
¿nge_couÁ
 =ğ2è
cÚfig
.
key_Ëngth_¿nge_’d
 = ()
¿nge
[1];

246 
	`as£¹
(0);

248 
	`ä“
(
¿nge
);

253 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

254 
	`log_¡d”r
("vireabtest: option -s„equires‡‚umber");

255  
VRT_ERROR
;

257 
cÚfig
.
¡ršg_max_Ëngth
 = ()
lv®ue
;

261 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

262 
	`log_¡d”r
("vireabtest: option -f„equires‡‚umber");

263  
VRT_ERROR
;

265 
cÚfig
.
f›lds_max_couÁ
 = ()
lv®ue
;

269 
cÚfig
.
cmd_ty³
 = 
	`·r£_commªd_ty³s
(
İrg
);

270 ià(
cÚfig
.
cmd_ty³
 <= 0) {

271 
	`log_¡d”r
("vireabtest: option -T„equireshe correct commandypes");

272  
VRT_ERROR
;

277 
cÚfig
.
cmd_bÏckli¡
 = 
	`·r£_commªd_li¡
(
İrg
);

278 ià(
cÚfig
.
cmd_bÏckli¡
 =ğ
NULL
) {

279 
	`log_¡d”r
("vireabtest: option -B„equireshe correct command†ist");

280  
VRT_ERROR
;

285 
cÚfig
.
cmd_wh™–i¡
 = 
	`·r£_commªd_li¡
(
İrg
);

286 ià(
cÚfig
.
cmd_wh™–i¡
 =ğ
NULL
) {

287 
	`log_¡d”r
("vireabtest: option -W„equireshe correct command†ist");

288  
VRT_ERROR
;

293 
cÚfig
.
‹¡_rg‘s
 = 
İrg
;

297 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

298 
	`log_¡d”r
("vireabtest: option -p„equires‡‚umber");

299  
VRT_ERROR
;

301 
cÚfig
.
´oduû_d©a_th»ads
 = ()
lv®ue
;

305 ià(
	`¡ršg2Î
(
İrg
,
	`¡¾’
(İrg),&
Îv®ue
) != 1) {

306 
	`log_¡d”r
("vireabtest: option -K„equires‡‚umber");

307  
VRT_ERROR
;

309 ià(
Îv®ue
 < 1000) {

310 
	`log_¡d”r
("vireabtest: option -K„equires‡‚umberhat must biggerhan 1000");

311  
VRT_ERROR
;

314 
cÚfig
.
ÿched_keys_³r_´oduû_th»ad
 = 
Îv®ue
;

318 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

319 
	`log_¡d”r
("vireabtest: option -H„equires‡‚umber");

320  
VRT_ERROR
;

322 ià(
lv®ue
 < 0 ||†value > 100) {

323 
	`log_¡d”r
("vireabtest: option hit-ratio‚eed between 0‡nd 100");

324  
VRT_ERROR
;

326 
cÚfig
.
h™_¿tio
 = ()
lv®ue
;

330 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

331 
	`log_¡d”r
("vireabtest: option -d„equires‡‚umber");

332  
VRT_ERROR
;

334 
cÚfig
.
di¥©ch_d©a_th»ads
 = ()
lv®ue
;

338 ià(
	`¡ršg2l
(
İrg
,
	`¡¾’
(İrg),&
lv®ue
) != 1) {

339 
	`log_¡d”r
("vireabtest: option -c„equires‡‚umber");

340  
VRT_ERROR
;

342 
cÚfig
.
ş›Ás_³r_di¥©ch_th»ad
 = ()
lv®ue
;

346 
cÚfig
.
pid_f’ame
 = 
İrg
;

350 
cÚfig
.
log_f’ame
 = 
İrg
;

354 
İtİt
) {

363 
	`log_¡d”r
("vire: option -%c„equires string",

364 
İtİt
);

372 
	`log_¡d”r
("vire: option -%c„equires‚umber",

373 
İtİt
);

377 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

380  
VRT_ERROR
;

383 
	`log_¡d”r
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

384  
VRT_ERROR
;

389  
VRT_OK
;

390 
	}
}

392 
	$v¹_d«mÚize
(
dump_cÜe
)

394 
»t
;

395 
pid_t
 
pid
, 
sid
;

396 
fd
;

398 
pid
 = 
	`fÜk
();

399 
pid
) {

401 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

402  
VRT_ERROR
;

409 
	`_ex™
(0);

414 
sid
 = 
	`£tsid
();

415 ià(
sid
 < 0) {

416 
	`log_”rÜ
("£tsid(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

417  
VRT_ERROR
;

420 ià(
	`sigÇl
(
SIGHUP
, 
SIG_IGN
è=ğ
SIG_ERR
) {

421 
	`log_”rÜ
("sigÇl(SIGHUP, SIG_IGNèçed: %s", 
	`¡»¼Ü
(
”ºo
));

422  
VRT_ERROR
;

425 
pid
 = 
	`fÜk
();

426 
pid
) {

428 
	`log_”rÜ
("fÜk(èçed: %s", 
	`¡»¼Ü
(
”ºo
));

429  
VRT_ERROR
;

436 
	`_ex™
(0);

442 ià(
dump_cÜe
 == 0) {

443 
»t
 = 
	`chdœ
("/");

444 ià(
»t
 < 0) {

445 
	`log_”rÜ
("chdœ(\"/\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

446  
VRT_ERROR
;

451 
	`umask
(0);

455 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

456 ià(
fd
 < 0) {

457 
	`log_”rÜ
("İ’(\"/dev/nuÎ\"èçed: %s", 
	`¡»¼Ü
(
”ºo
));

458  
VRT_ERROR
;

461 
»t
 = 
	`dup2
(
fd
, 
STDIN_FILENO
);

462 ià(
»t
 < 0) {

463 
	`log_”rÜ
("dup2(%d, STDINèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

464 
	`şo£
(
fd
);

465  
VRT_ERROR
;

468 
»t
 = 
	`dup2
(
fd
, 
STDOUT_FILENO
);

469 ià(
»t
 < 0) {

470 
	`log_”rÜ
("dup2(%d, STDOUTèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

471 
	`şo£
(
fd
);

472  
VRT_ERROR
;

475 
»t
 = 
	`dup2
(
fd
, 
STDERR_FILENO
);

476 ià(
»t
 < 0) {

477 
	`log_”rÜ
("dup2(%d, STDERRèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

478 
	`şo£
(
fd
);

479  
VRT_ERROR
;

482 ià(
fd
 > 
STDERR_FILENO
) {

483 
»t
 = 
	`şo£
(
fd
);

484 ià(
»t
 < 0) {

485 
	`log_”rÜ
("şo£(%dèçed: %s", 
fd
, 
	`¡»¼Ü
(
”ºo
));

486  
VRT_ERROR
;

490  
VRT_OK
;

491 
	}
}

493 
	$ab‹¡_£rv”_š™
(
ab‹¡_£rv”
 *
abs
, *
add»ss
)

495 
sds
 *
ho¡_pÜt
;

496 
couÁ
;

497 
v®ue
;

499 
abs
->
ho¡
 = 
NULL
;

500 
abs
->
pÜt
 = 0;

501 
abs
->
cÚn_cÚ‹xts
 = 
NULL
;

502 
abs
->
d©a
 = 
NULL
;

504 
ho¡_pÜt
 = 
	`sds¥l™Ën
(
add»ss
,
	`¡¾’
×dd»ss),":",1,&
couÁ
);

505 ià(
ho¡_pÜt
 =ğ
NULL
) {

506  
VRT_ERROR
;

507 } ià(
couÁ
 != 2) {

508 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

509  
VRT_ERROR
;

512 
abs
->
ho¡
 = 
ho¡_pÜt
[0];

513 
ho¡_pÜt
[0] = 
NULL
;

515 ià(
	`¡ršg2l
(
ho¡_pÜt
[1],
	`sd¦’
(ho¡_pÜt[1]),&
v®ue
) != 1) {

516 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

517  
VRT_ERROR
;

520 
abs
->
pÜt
 = ()
v®ue
;

521 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

523  
VRT_OK
;

524 
	}
}

526 
	$ab‹¡_£rv”_deš™
(
ab‹¡_£rv”
 *
abs
)

528 ià(
abs
->
ho¡
) {

529 
	`sdsä“
(
abs
->
ho¡
);

530 
abs
->
ho¡
 = 
NULL
;

533 ià(
abs
->
pÜt
 > 0)‡bs->port = 0;

535 ià(
abs
->
cÚn_cÚ‹xts
) {

536 
	`ASSERT
(
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) == 0);

537 
	`d¬¿y_de¡roy
(
abs
->
cÚn_cÚ‹xts
);

538 
abs
->
cÚn_cÚ‹xts
 = 
NULL
;

540 
	}
}

542 
	$g‘_back’d_£rv”_idx
(
ab‹¡_group
 *
abg
, *
key
, 
size_t
 
keyËn
)

544 
hashv®ue
, 
£rv”s_couÁ
;

546 
£rv”s_couÁ
 = 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
);

547 ià(
£rv”s_couÁ
 == 1) {

551 
hashv®ue
 = ()
	`hash_üc32a
(
key
, 
keyËn
);

553  
hashv®ue
%
£rv”s_couÁ
;

554 
	}
}

556 
ab‹¡_£rv”
 *
	$g‘_back’d_£rv”
(
ab‹¡_group
 *
abg
, *
key
, 
size_t
 
keyËn
)

558 
ab‹¡_£rv”
 *
abs
;

559 
idx
;

561 
idx
 = 
abg
->
	`g‘_back’d_£rv”_idx
×bg,
key
,
keyËn
);

562 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
idx
);

564  
abs
;

565 
	}
}

567 
	$ab‹¡_group_š™
(
ab‹¡_group
 *
abg
, *
group_¡ršg
)

569 
sds
 *
ty³_addrs
, *
addrs
;

570 
ty³_addrs_couÁ
, 
addrs_couÁ
;

571 
j
;

573 
abg
->
ty³
 = 0;

574 
	`d¬¿y_š™
(&
abg
->
ab‹¡_£rv”s
, 1, (
ab‹¡_£rv”
));

576 
ty³_addrs
 = 
	`sds¥l™Ën
(
group_¡ršg
,
	`sd¦’
(group_¡ršg),"[",1,&
ty³_addrs_couÁ
);

577 ià(
ty³_addrs
 =ğ
NULL
) {

578  
VRT_ERROR
;

579 } ià(
ty³_addrs_couÁ
 != 2) {

580 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

581  
VRT_ERROR
;

584 ià(!
	`¡rÿ£cmp
(
ty³_addrs
[0],"vire")) {

585 
abg
->
ty³
 = 
VRABTEST_GROUP_TYPE_VIRE
;

586 } ià(!
	`¡rÿ£cmp
(
ty³_addrs
[0],"redis")) {

587 
abg
->
ty³
 = 
VRABTEST_GROUP_TYPE_REDIS
;

589 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

590  
VRT_ERROR
;

593 ià(
	`sd¦’
(
ty³_addrs
[1]) <= 1 ||

594 
ty³_addrs
[1][
	`sd¦’
(type_addrs[1])-1] != ']') {

595 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

596  
VRT_ERROR
;

599 
	`sd¤ªge
(
ty³_addrs
[1],0,-2);

601 
addrs
 = 
	`sds¥l™Ën
(
ty³_addrs
[1],
	`sd¦’
Ñy³_addrs[1]),",",1,&
addrs_couÁ
);

602 ià(
addrs
 =ğ
NULL
) {

603 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

604  
VRT_ERROR
;

605 } ià(
addrs_couÁ
 < 1) {

606 
	`sdsä“¥l™»s
(
addrs
,
addrs_couÁ
);

607 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

608  
VRT_ERROR
;

611 
j
 = 0; j < 
addrs_couÁ
; j ++) {

612 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_push
(&
abg
->
ab‹¡_£rv”s
);

613 ià(
	`ab‹¡_£rv”_š™
(
abs
,
addrs
[
j
]è!ğ
VRT_OK
) {

614 
	`sdsä“¥l™»s
(
addrs
,
addrs_couÁ
);

615 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

616  
VRT_ERROR
;

620 
	`sdsä“¥l™»s
(
addrs
,
addrs_couÁ
);

621 
	`sdsä“¥l™»s
(
ty³_addrs
,
ty³_addrs_couÁ
);

623 
abg
->
g‘_back’d_£rv”_idx
 = get_backend_server_idx;

624 
abg
->
g‘_back’d_£rv”
 = get_backend_server;

626  
VRT_OK
;

627 
	}
}

629 
	$ab‹¡_group_deš™
(
ab‹¡_group
 *
abg
)

631 
ab‹¡_£rv”
 *
abs
;

633 
abg
->
ty³
 = 0;

635 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
) > 0) {

636 
abs
 = 
	`d¬¿y_pİ
(&
abg
->
ab‹¡_£rv”s
);

637 
	`ab‹¡_£rv”_deš™
(
abs
);

639 
	`d¬¿y_deš™
(&
abg
->
ab‹¡_£rv”s
);

640 
	}
}

643 
d¬¿y
 *
	$ab‹¡_groups_ü—‹
(*
groups_¡ršg
)

645 
d¬¿y
 *
abgs
;

646 
sds
 *
group_¡ršgs
;

647 
group_couÁ
, 
j
;

649 
group_¡ršgs
 = 
	`sds¥l™Ën
(
groups_¡ršg
,
	`¡¾’
(groups_¡ršg),"-",1,&
group_couÁ
);

650 ià(
group_¡ršgs
 =ğ
NULL
) {

651  
NULL
;

652 } ià(
group_couÁ
 < 1) {

653 
	`sdsä“¥l™»s
(
group_¡ršgs
,
group_couÁ
);

654  
NULL
;

657 
abgs
 = 
	`d¬¿y_ü—‹
(2, (
ab‹¡_group
));

658 ià(
abgs
 =ğ
NULL
) {

659 
	`sdsä“¥l™»s
(
group_¡ršgs
,
group_couÁ
);

660  
NULL
;

663 
j
 = 0; j < 
group_couÁ
; j ++) {

664 
ab‹¡_group
 *
abg
;

665 
sds
 
group_¡ršg
 = 
group_¡ršgs
[
j
];

666 
sds
 *
ty³_addrs
;

667 
–em_couÁ
;

669 
abg
 = 
	`d¬¿y_push
(
abgs
);

670 ià(
	`ab‹¡_group_š™
(
abg
,
group_¡ršg
è!ğ
VRT_OK
) {

671 
	`sdsä“¥l™»s
(
group_¡ršgs
,
group_couÁ
);

672 
	`ab‹¡_groups_de¡roy
(
abgs
);

673  
NULL
;

677  
abgs
;

678 
	}
}

680 
	$ab‹¡_groups_de¡roy
(
d¬¿y
 *
abgs
)

682 
	`d¬¿y_n
(
abgs
) > 0) {

683 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_pİ
(
abgs
);

684 
	`ab‹¡_group_deš™
(
abg
);

687 
	`d¬¿y_de¡roy
(
abgs
);

688 
	}
}

691 
	$maš
(
¬gc
, **
¬gv
)

693 
»t
;

695 
	`v¹_£t_deçuÉ_İtiÚs
();

697 
»t
 = 
	`v¹_g‘_İtiÚs
(
¬gc
, 
¬gv
);

698 ià(
»t
 !ğ
VRT_OK
) {

699 
	`v¹_show_u§ge
();

700 
	`ex™
(1);

703 ià(
show_v”siÚ
) {

704 
	`log_¡dout
("Thi i vœ—b‹¡-%s", 
VR_VERSION_STRING
);

705 ià(
show_h–p
) {

706 
	`v¹_show_u§ge
();

708 
	`ex™
(0);

711 
»t
 = 
	`log_š™
(
LOG_INFO
, 
cÚfig
.
log_f’ame
);

712 ià(
»t
 < 0) {

713 
	`ex™
(1);

716 ià(
d«mÚize
) {

717 
»t
 = 
	`v¹_d«mÚize
(1);

718 ià(
»t
 !ğ
VRT_OK
) {

719 
	`ex™
(1);

723 
‹¡_š‹rv®
 = 
cÚfig
.test_interval;

725 
»t
 = 
	`v¹_´oduû_d©a_š™
(
cÚfig
.
key_Ëngth_¿nge_begš
,

726 
cÚfig
.
key_Ëngth_¿nge_’d
,

727 
cÚfig
.
¡ršg_max_Ëngth
,cÚfig.
f›lds_max_couÁ
,

728 
cÚfig
.
cmd_ty³
,cÚfig.
cmd_bÏckli¡
,cÚfig.
cmd_wh™–i¡
,

729 
cÚfig
.
´oduû_d©a_th»ads
,

730 
cÚfig
.
ÿched_keys_³r_´oduû_th»ad
,

731 
cÚfig
.
h™_¿tio
);

732 ià(
»t
 !ğ
VRT_OK
) {

733 
	`log_”rÜ
("Init data…roducer failed");

734 
	`ex™
(1);

736 
»t
 = 
	`v¹_di¥©ch_d©a_š™
(
cÚfig
.
di¥©ch_d©a_th»ads
,

737 
cÚfig
.
‹¡_rg‘s
, cÚfig.
ş›Ás_³r_di¥©ch_th»ad
);

738 ià(
»t
 !ğ
VRT_OK
) {

739 
	`log_”rÜ
("Init data dispatcher failed");

740 
	`ex™
(1);

742 
»t
 = 
	`v¹_back’d_š™
(
cÚfig
.
di¥©ch_d©a_th»ads
,

743 
cÚfig
.
‹¡_rg‘s
);

744 ià(
»t
 !ğ
VRT_OK
) {

745 
	`log_”rÜ
("Init backendhread failed");

746 
	`ex™
(1);

748 
»t
 = 
	`v¹_d©a_check”_š™
(
cÚfig
.
check”
, cÚfig.
‹¡_rg‘s
);

749 ià(
»t
 !ğ
VRT_OK
) {

750 
	`log_”rÜ
("Init check datahread failed");

751 
	`ex™
(1);

754 
	`log_debug
(
LOG_INFO
,"S‹†ocky³: %s", 
TEST_STATE_LOCK_TYPE
);

756 
	`v¹_¡¬t_´oduû_d©a
();

757 
	`v¹_¡¬t_di¥©ch_d©a
();

758 
	`v¹_¡¬t_back’d
();

759 
	`v¹_¡¬t_d©a_check”
();

761 
	`v¹_wa™_´oduû_d©a
();

762 
	`v¹_wa™_di¥©ch_d©a
();

763 
	`v¹_wa™_back’d
();

764 
	`v¹_wa™_d©a_check”
();

766 
	`v¹_d©a_check”_deš™
();

767 
	`v¹_back’d_deš™
();

768 
	`v¹_di¥©ch_d©a_deš™
();

769 
	`v¹_´oduû_d©a_deš™
();

771 
	`log_deš™
();

772 
	`v¹_ş—n_İtiÚs
();

774  
VRT_OK
;

775 
	}
}

	@tests/vrabtest.h

1 #iâdeà
_VRABTEST_H_


2 
	#_VRABTEST_H_


	)

4 
	~<d¬¿y.h
>

6 
	g»disCÚ‹xt
;

7 
	g»disAsyncCÚ‹xt
;

8 
	gab‹¡_group
;

10 
	scÚn_cÚ‹xt
 {

11 
»disCÚ‹xt
 *
	mùx
;

12 
»disAsyncCÚ‹xt
 *
	maùx
;

13 } 
	tcÚn_cÚ‹xt
;

15 
	sab‹¡_£rv”
 {

16 
sds
 
	mho¡
;

17 
	mpÜt
;

19 
d¬¿y
 *
	mcÚn_cÚ‹xts
;

21 *
	md©a
;

22 } 
	tab‹¡_£rv”
;

24 (*
	tback’d_£rv”_idx_t
)(
	tab‹¡_group
*, *, 
	tsize_t
);

25 
ab‹¡_£rv”
 *(*
	tback’d_£rv”_t
)(
	tab‹¡_group
*, *, 
	tsize_t
);

27 
	sab‹¡_group
 {

28 
ty³
;

30 
d¬¿y
 
ab‹¡_£rv”s
;

32 
back’d_£rv”_idx_t
 
g‘_back’d_£rv”_idx
;

33 
back’d_£rv”_t
 
g‘_back’d_£rv”
;

34 } 
	tab‹¡_group
;

36 
expœe_’abËd
;

37 
‹¡_š‹rv®
;

38 
Ï¡_‹¡_begš_time
;

40 
d¬¿y
 *
	`ab‹¡_groups_ü—‹
(*
groups_¡ršg
);

41 
	`ab‹¡_groups_de¡roy
(
d¬¿y
 *
abgs
);

	@tests/vrabtest.h

1 #iâdeà
_VRABTEST_H_


2 
	#_VRABTEST_H_


	)

4 
	~<d¬¿y.h
>

6 
	g»disCÚ‹xt
;

7 
	g»disAsyncCÚ‹xt
;

8 
	gab‹¡_group
;

10 
	scÚn_cÚ‹xt
 {

11 
»disCÚ‹xt
 *
	mùx
;

12 
»disAsyncCÚ‹xt
 *
	maùx
;

13 } 
	tcÚn_cÚ‹xt
;

15 
	sab‹¡_£rv”
 {

16 
sds
 
	mho¡
;

17 
	mpÜt
;

19 
d¬¿y
 *
	mcÚn_cÚ‹xts
;

21 *
	md©a
;

22 } 
	tab‹¡_£rv”
;

24 (*
	tback’d_£rv”_idx_t
)(
	tab‹¡_group
*, *, 
	tsize_t
);

25 
ab‹¡_£rv”
 *(*
	tback’d_£rv”_t
)(
	tab‹¡_group
*, *, 
	tsize_t
);

27 
	sab‹¡_group
 {

28 
ty³
;

30 
d¬¿y
 
ab‹¡_£rv”s
;

32 
back’d_£rv”_idx_t
 
g‘_back’d_£rv”_idx
;

33 
back’d_£rv”_t
 
g‘_back’d_£rv”
;

34 } 
	tab‹¡_group
;

36 
expœe_’abËd
;

37 
‹¡_š‹rv®
;

38 
Ï¡_‹¡_begš_time
;

40 
d¬¿y
 *
	`ab‹¡_groups_ü—‹
(*
groups_¡ršg
);

41 
	`ab‹¡_groups_de¡roy
(
d¬¿y
 *
abgs
);

	@tests/vrt_backend.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

12 
	~<async.h
>

13 
	~<ad­‹rs/«.h
>

15 
	~<dhashk™.h
>

16 
	~<dli¡.h
>

17 
	~<dmtqueue.h
>

19 
	~<v¹_ut.h
>

20 
	~<v¹_public.h
>

21 
	~<v¿b‹¡.h
>

22 
	~<v¹_´oduû_d©a.h
>

23 
	~<v¹_di¥©ch_d©a.h
>

24 
	~<v¹_back’d.h
>

26 
	ssk_d©a
 {

27 
	mmaxmemÜy
;

28 
	mu£d_memÜy
;

29 
	mtÙ®_sy¡em_memÜy
;

31 
	md–‘šg
;

32 
	mcursÜ
;

33 } 
	tsk_d©a
;

35 
	gback’d_th»ads_couÁ
;

36 
d¬¿y
 *
	gback’d_th»ads
 = 
NULL
;

38 
	gback’d_th»ads_·u£_fšished_couÁ
;

40 
	$sk_d©a_ü—‹
()

42 
sk_d©a
 *
td
;

44 
td
 = 
	`m®loc
((*td));

46 
td
->
maxmemÜy
 = 0;

47 
td
->
u£d_memÜy
 = 0;

48 
td
->
tÙ®_sy¡em_memÜy
 = 0;

49 
td
->
d–‘šg
 = 0;

50 
td
->
cursÜ
 = 0;

52  
td
;

53 
	}
}

55 
	$sk_d©a_de¡roy
(
sk_d©a
 *
td
)

57 
	`ä“
(
td
);

58 
	}
}

60 
	$back’d_cÚn_cÚ‹xt_š™
(
cÚn_cÚ‹xt
 *
cc
, *
ho¡
, 
pÜt
)

62 
cc
->
ùx
 = 
NULL
;

63 
cc
->
aùx
 = 
NULL
;

65 
cc
->
aùx
 = 
	`»disAsyncCÚÃù
(
ho¡
, 
pÜt
);

66 ià(
cc
->
aùx
 =ğ
NULL
) {

67  
VRT_ERROR
;

70  
VRT_OK
;

71 
	}
}

73 
	$back’d_cÚn_cÚ‹xt_deš™
(
cÚn_cÚ‹xt
 *
cc
)

75 ià(
cc
->
ùx
) {

76 
	`»disF»e
(
cc
->
ùx
);

77 
cc
->
ùx
 =ğ
NULL
;

80 ià(
cc
->
aùx
) {

81 
	`»disAsyncF»e
(
cc
->
aùx
);

82 
cc
->
aùx
 =ğ
NULL
;

84 
	}
}

86 
	$cÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

87 
back’d_th»ad
 *
bt
 = 
c
->
d©a
;

88 ià(
¡©us
 !ğ
REDIS_OK
) {

89 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

95 
	}
}

97 
	$discÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

98 
back’d_th»ad
 *
bt
 = 
c
->
d©a
;

99 ià(
¡©us
 !ğ
REDIS_OK
) {

100 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

107 
	}
}

109 
	$sÿn_fÜ_d–‘e_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

110 
»disR•ly
 *
»¶y
 = 
r
, *
»¶y_sub
, *
»¶y_–em
;

111 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

112 
sk_d©a
 *
td
 = 
abs
->
d©a
;

113 
cÚn_cÚ‹xt
 *
cc
;

114 
v®ue
;

115 
size_t
 
k
;

117 ià(
»¶y
 =ğ
NULL
) ;

119 ià(!
td
->
d–‘šg
) {

123 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

127 ià(
»¶y
->
–em’ts
 != 2) {

131 
»¶y_sub
 = 
»¶y
->
–em’t
[0];

132 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

133 
	`¡ršg2Î
(
»¶y_sub
->
¡r
,»¶y_sub->
Ën
,&
v®ue
) != 1) {

137 
td
->
cursÜ
 = 
v®ue
;

139 
»¶y_sub
 = 
»¶y
->
–em’t
[1];

140 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

144 
k
 = 0; k < 
»¶y_sub
->
–em’ts
; k ++) {

145 
»¶y_–em
 = 
»¶y_sub
->
–em’t
[
k
];

146 ià(
»¶y_–em
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

150 
d©a_un™
 *
du
 = 
	`d©a_un™_g‘
();

151 
du
->
dp
 = 
d–‘e_d©a_´oduûr
;

152 
du
->
¬gc
 = 2;

153 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

154 
du
->
¬gv
[0] = 
	`sd¢ew
(
d–‘e_d©a_´oduûr
->
Çme
);

155 
du
->
¬gv
[1] = 
	`sd¢ewËn
(
»¶y_–em
->
¡r
,»¶y_–em->
Ën
);

156 
	`d©a_di¥©ch
(
du
);

159 
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

160 
	`»disAsyncCommªd
(
cc
->
aùx
, 
sÿn_fÜ_d–‘e_ÿÎback
,

161 
abs
, "sÿÀ%Îd couÁ 1000", 
td
->
cursÜ
);

162 
	}
}

164 
	$upd©e_memÜy_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

165 
»disR•ly
 *
»¶y
 = 
r
;

166 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

167 
sk_d©a
 *
td
 = 
abs
->
d©a
;

169 ià(
»¶y
 =ğ
NULL
) ;

171 
td
->
u£d_memÜy
 = 
	`g‘_lÚglÚg_äom_šfo_»¶y
(
»¶y
, "used_memory");

173 ià(
td
->
maxmemÜy
 == 0) {

174 
td
->
tÙ®_sy¡em_memÜy
 = 
	`g‘_lÚglÚg_äom_šfo_»¶y
(
»¶y
, "total_system_memory");

176 
	}
}

178 
	$upd©e_maxmemÜy_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

179 
»disR•ly
 *
»¶y
 = 
r
;

180 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

181 
sk_d©a
 *
td
 = 
abs
->
d©a
;

182 
»disR•ly
 *
»¶y_sub
;

183 
v®ue
;

185 ià(
»¶y
 =ğ
NULL
) ;

187 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

191 ià(
»¶y
->
–em’ts
 != 2) {

195 
»¶y_sub
 = 
»¶y
->
–em’t
[0];

196 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

197 
	`¡rcmp
(
»¶y_sub
->
¡r
, "maxmemory")) {

201 
»¶y_sub
 = 
»¶y
->
–em’t
[1];

202 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

203 
	`¡ršg2Î
(
»¶y_sub
->
¡r
,»¶y_sub->
Ën
,&
v®ue
) != 1) {

207 
td
->
maxmemÜy
 = 
v®ue
;

208 
	}
}

210 
	$upd©e_memÜy_šfo
(
d¬¿y
 *
abgs
)

212 
i
, 
j
;

214 
i
 = 0; i < 
	`d¬¿y_n
(
abgs
); i ++) {

215 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
abgs
, 
i
);

216 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

217 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

218 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

220 
	`»disAsyncCommªd
(
cc
->
aùx
, 
upd©e_memÜy_ÿÎback
, 
abs
, "info memory");

221 
	`»disAsyncCommªd
(
cc
->
aùx
, 
upd©e_maxmemÜy_ÿÎback
, 
abs
, "config get maxmemory");

224 
	}
}

226 
	$check_memÜy_’ough
(
back’d_th»ad
 *
bt
)

228 
i
, 
j
;

229 
d¬¿y
 *
abgs
 = 
bt
->abgs;

231 
i
 = 0; i < 
	`d¬¿y_n
(
abgs
); i ++) {

232 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
abgs
, 
i
);

233 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

234 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

235 
sk_d©a
 *
td
 = 
abs
->
d©a
;

236 
max_memÜy_®lowed
 = 0;

238 ià(
td
->
u£d_memÜy
) {

239 ià(
td
->
maxmemÜy
) {

240 
max_memÜy_®lowed
 = 
td
->
maxmemÜy
;

241 } ià(
td
->
tÙ®_sy¡em_memÜy
) {

242 
max_memÜy_®lowed
 = 
td
->
tÙ®_sy¡em_memÜy
;

245 ià(
max_memÜy_®lowed
) {

246 ià(
td
->
u£d_memÜy
*100/
max_memÜy_®lowed
 > 80) {

247 ià(!
td
->
d–‘šg
) {

248 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

249 
	`»disAsyncCommªd
(
cc
->
aùx
, 
sÿn_fÜ_d–‘e_ÿÎback
,

250 
abs
, "sÿÀ%Îd couÁ 1000", 
td
->
cursÜ
);

251 
td
->
d–‘šg
 = 1;

252 
bt
->
d–‘šg
 ++;

254 } ià(
td
->
d–‘šg
) {

255 
td
->
d–‘šg
 = 0;

256 
bt
->
d–‘šg
 --;

262 
	}
}

264 
	$back’d_th»ad_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

266 
back’d_th»ad
 *
bt
 = 
ş›ÁD©a
;

268 
	`ASSERT
(
ev’tLoİ
 =ğ
bt
->
–
);

271 ià(
bt
->
·u£
) {

272 ià(!
	`‹¡_if_Ãed_·u£
()) {

273 
bt
->
·u£
 = 0;

275 
bt
->
üÚloİs
 ++;

280 
	`upd©e_memÜy_šfo
(
bt
->
abgs
);

281 
	`check_memÜy_’ough
(
bt
);

284 ià(!
bt
->
·u£
 && 
	`‹¡_if_Ãed_·u£
(è&& !bt->
d–‘šg
) {

285 
bt
->
·u£
 = 1;

286 
	`Úe_back’d_th»ad_·u£d
();

289 
bt
->
üÚloİs
 ++;

290  1000/
bt
->
hz
;

291 
	}
}

293 
	$back’d_th»ad_š™
(
back’d_th»ad
 *
bt
, *
‹¡_rg‘_groups
)

295 
i
, 
j
, 
k
;

297 
bt
->
id
 = 0;

298 
bt
->
th»ad_id
 = 0;

299 
bt
->
–
 = 
NULL
;

300 
bt
->
hz
 = 10;

301 
bt
->
üÚloİs
 = 0;

302 
bt
->
d–‘šg
 = 0;

303 
bt
->
·u£
 = 0;

305 
bt
->
–
 = 
	`«C»©eEv’tLoİ
(1);

306 ià(
bt
->
–
 =ğ
NULL
) {

307  
VRT_ERROR
;

310 
bt
->
abgs
 = 
	`ab‹¡_groups_ü—‹
(
‹¡_rg‘_groups
);

311 ià(
bt
->
abgs
 =ğ
NULL
) {

312  
VRT_ERROR
;

316 
i
 = 0; i < 
	`d¬¿y_n
(
bt
->
abgs
); i ++) {

317 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
bt
->
abgs
, 
i
);

318 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

319 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

321 
abs
->
cÚn_cÚ‹xts
 = 
	`d¬¿y_ü—‹
(1, (
cÚn_cÚ‹xt
));

322 
k
 = 0; k < 1; k ++) {

323 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_push
(
abs
->
cÚn_cÚ‹xts
);

324 ià(
	`back’d_cÚn_cÚ‹xt_š™
(
cc
,
abs
->
ho¡
,abs->
pÜt
è!ğ
VRT_OK
) {

325  
VRT_ERROR
;

327 
cc
->
aùx
->
d©a
 = 
bt
;

328 
	`»disAeA‰ach
(
bt
->
–
, 
cc
->
aùx
);

329 
	`»disAsyncS‘CÚÃùC®lback
(
cc
->
aùx
,
cÚÃù_ÿÎback
);

330 
	`»disAsyncS‘DiscÚÃùC®lback
(
cc
->
aùx
,
discÚÃù_ÿÎback
);

333 
abs
->
d©a
 = 
	`sk_d©a_ü—‹
();

337 ià(
	`«C»©eTimeEv’t
(
bt
->
–
, 1, 
back’d_th»ad_üÚ
, bt, 
NULL
è=ğ
AE_ERR
) {

338  
VRT_ERROR
;

341  
VRT_OK
;

342 
	}
}

344 
	$back’d_th»ad_deš™
(
back’d_th»ad
 *
bt
)

346 ià(
bt
->
–
) {

347 
	`«D–‘eEv’tLoİ
(
bt
->
–
);

348 
bt
->
–
 = 
NULL
;

351 ià(
bt
->
abgs
) {

352 
i
, 
j
, 
k
;

354 
i
 = 0; i < 
	`d¬¿y_n
(
bt
->
abgs
); i ++) {

355 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
bt
->
abgs
, 
i
);

356 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

357 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

358 
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) > 0) {

359 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_pİ
(
abs
->
cÚn_cÚ‹xts
);

360 
	`back’d_cÚn_cÚ‹xt_deš™
(
cc
);

363 ià(
abs
->
d©a
) {

364 
	`sk_d©a_de¡roy
(
abs
->
d©a
);

365 
abs
->
d©a
;

370 
	`ab‹¡_groups_de¡roy
(
bt
->
abgs
);

371 
bt
->
abgs
 = 
NULL
;

373 
	}
}

375 
	$v¹_back’d_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
)

377 
j
;

379 
back’d_th»ads_couÁ
 = 
th»ads_couÁ
;

380 
back’d_th»ads
 = 
	`d¬¿y_ü—‹
(
th»ads_couÁ
, (
back’d_th»ad
));

381 ià(
back’d_th»ads
 =ğ
NULL
) {

382  
VRT_ERROR
;

385 
j
 = 0; j < 
th»ads_couÁ
; j ++) {

386 
back’d_th»ad
 *
bt
 = 
	`d¬¿y_push
(
back’d_th»ads
);

387 ià(
	`back’d_th»ad_š™
(
bt
, 
‹¡_rg‘_groups
è!ğ
VRT_OK
) {

388  
VRT_ERROR
;

390 
bt
->
id
 = 
j
;

393  
VRT_OK
;

394 
	}
}

396 
	$v¹_back’d_deš™
()

398 ià(
back’d_th»ads
) {

399 
	`d¬¿y_n
(
back’d_th»ads
) > 0) {

400 
back’d_th»ad
 *
bt
 = 
	`d¬¿y_pİ
(
back’d_th»ads
);

401 
	`back’d_th»ad_deš™
(
bt
);

403 
	`d¬¿y_de¡roy
(
back’d_th»ads
);

404 
back’d_th»ads
 = 
NULL
;

406 
	}
}

408 *
	$v¹_back’d_th»ad_run
(*
¬gs
)

410 
back’d_th»ad
 *
bt
 = 
¬gs
;

411 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

413 
	`«Maš
(
bt
->
–
);

415  
NULL
;

416 
	}
}

418 
	$v¹_¡¬t_back’d
()

420 
i
;

421 
i
 = 0; i < 
	`d¬¿y_n
(
back’d_th»ads
); i ++) {

422 
±h»ad_©Œ_t
 
©Œ
;

423 
back’d_th»ad
 *
bt
;

424 
	`±h»ad_©Œ_š™
(&
©Œ
);

425 
bt
 = 
	`d¬¿y_g‘
(
back’d_th»ads
, 
i
);

426 
	`±h»ad_ü—‹
(&
bt
->
th»ad_id
,

427 &
©Œ
, 
v¹_back’d_th»ad_run
, 
bt
);

430  
VRT_OK
;

431 
	}
}

433 
	$v¹_wa™_back’d
()

435 
i
;

437 
i
 = 0; i < 
	`d¬¿y_n
(
back’d_th»ads
); i ++){

438 
back’d_th»ad
 *
bt
 = 
	`d¬¿y_g‘
(
back’d_th»ads
, 
i
);

439 
	`±h»ad_još
(
bt
->
th»ad_id
, 
NULL
);

442  
VRT_OK
;

443 
	}
}

	@tests/vrt_backend.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

12 
	~<async.h
>

13 
	~<ad­‹rs/«.h
>

15 
	~<dhashk™.h
>

16 
	~<dli¡.h
>

17 
	~<dmtqueue.h
>

19 
	~<v¹_ut.h
>

20 
	~<v¹_public.h
>

21 
	~<v¿b‹¡.h
>

22 
	~<v¹_´oduû_d©a.h
>

23 
	~<v¹_di¥©ch_d©a.h
>

24 
	~<v¹_back’d.h
>

26 
	ssk_d©a
 {

27 
	mmaxmemÜy
;

28 
	mu£d_memÜy
;

29 
	mtÙ®_sy¡em_memÜy
;

31 
	md–‘šg
;

32 
	mcursÜ
;

33 } 
	tsk_d©a
;

35 
	gback’d_th»ads_couÁ
;

36 
d¬¿y
 *
	gback’d_th»ads
 = 
NULL
;

38 
	gback’d_th»ads_·u£_fšished_couÁ
;

40 
	$sk_d©a_ü—‹
()

42 
sk_d©a
 *
td
;

44 
td
 = 
	`m®loc
((*td));

46 
td
->
maxmemÜy
 = 0;

47 
td
->
u£d_memÜy
 = 0;

48 
td
->
tÙ®_sy¡em_memÜy
 = 0;

49 
td
->
d–‘šg
 = 0;

50 
td
->
cursÜ
 = 0;

52  
td
;

53 
	}
}

55 
	$sk_d©a_de¡roy
(
sk_d©a
 *
td
)

57 
	`ä“
(
td
);

58 
	}
}

60 
	$back’d_cÚn_cÚ‹xt_š™
(
cÚn_cÚ‹xt
 *
cc
, *
ho¡
, 
pÜt
)

62 
cc
->
ùx
 = 
NULL
;

63 
cc
->
aùx
 = 
NULL
;

65 
cc
->
aùx
 = 
	`»disAsyncCÚÃù
(
ho¡
, 
pÜt
);

66 ià(
cc
->
aùx
 =ğ
NULL
) {

67  
VRT_ERROR
;

70  
VRT_OK
;

71 
	}
}

73 
	$back’d_cÚn_cÚ‹xt_deš™
(
cÚn_cÚ‹xt
 *
cc
)

75 ià(
cc
->
ùx
) {

76 
	`»disF»e
(
cc
->
ùx
);

77 
cc
->
ùx
 =ğ
NULL
;

80 ià(
cc
->
aùx
) {

81 
	`»disAsyncF»e
(
cc
->
aùx
);

82 
cc
->
aùx
 =ğ
NULL
;

84 
	}
}

86 
	$cÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

87 
back’d_th»ad
 *
bt
 = 
c
->
d©a
;

88 ià(
¡©us
 !ğ
REDIS_OK
) {

89 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

95 
	}
}

97 
	$discÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

98 
back’d_th»ad
 *
bt
 = 
c
->
d©a
;

99 ià(
¡©us
 !ğ
REDIS_OK
) {

100 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

107 
	}
}

109 
	$sÿn_fÜ_d–‘e_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

110 
»disR•ly
 *
»¶y
 = 
r
, *
»¶y_sub
, *
»¶y_–em
;

111 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

112 
sk_d©a
 *
td
 = 
abs
->
d©a
;

113 
cÚn_cÚ‹xt
 *
cc
;

114 
v®ue
;

115 
size_t
 
k
;

117 ià(
»¶y
 =ğ
NULL
) ;

119 ià(!
td
->
d–‘šg
) {

123 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

127 ià(
»¶y
->
–em’ts
 != 2) {

131 
»¶y_sub
 = 
»¶y
->
–em’t
[0];

132 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

133 
	`¡ršg2Î
(
»¶y_sub
->
¡r
,»¶y_sub->
Ën
,&
v®ue
) != 1) {

137 
td
->
cursÜ
 = 
v®ue
;

139 
»¶y_sub
 = 
»¶y
->
–em’t
[1];

140 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

144 
k
 = 0; k < 
»¶y_sub
->
–em’ts
; k ++) {

145 
»¶y_–em
 = 
»¶y_sub
->
–em’t
[
k
];

146 ià(
»¶y_–em
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

150 
d©a_un™
 *
du
 = 
	`d©a_un™_g‘
();

151 
du
->
dp
 = 
d–‘e_d©a_´oduûr
;

152 
du
->
¬gc
 = 2;

153 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

154 
du
->
¬gv
[0] = 
	`sd¢ew
(
d–‘e_d©a_´oduûr
->
Çme
);

155 
du
->
¬gv
[1] = 
	`sd¢ewËn
(
»¶y_–em
->
¡r
,»¶y_–em->
Ën
);

156 
	`d©a_di¥©ch
(
du
);

159 
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

160 
	`»disAsyncCommªd
(
cc
->
aùx
, 
sÿn_fÜ_d–‘e_ÿÎback
,

161 
abs
, "sÿÀ%Îd couÁ 1000", 
td
->
cursÜ
);

162 
	}
}

164 
	$upd©e_memÜy_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

165 
»disR•ly
 *
»¶y
 = 
r
;

166 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

167 
sk_d©a
 *
td
 = 
abs
->
d©a
;

169 ià(
»¶y
 =ğ
NULL
) ;

171 
td
->
u£d_memÜy
 = 
	`g‘_lÚglÚg_äom_šfo_»¶y
(
»¶y
, "used_memory");

173 ià(
td
->
maxmemÜy
 == 0) {

174 
td
->
tÙ®_sy¡em_memÜy
 = 
	`g‘_lÚglÚg_äom_šfo_»¶y
(
»¶y
, "total_system_memory");

176 
	}
}

178 
	$upd©e_maxmemÜy_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

179 
»disR•ly
 *
»¶y
 = 
r
;

180 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

181 
sk_d©a
 *
td
 = 
abs
->
d©a
;

182 
»disR•ly
 *
»¶y_sub
;

183 
v®ue
;

185 ià(
»¶y
 =ğ
NULL
) ;

187 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

191 ià(
»¶y
->
–em’ts
 != 2) {

195 
»¶y_sub
 = 
»¶y
->
–em’t
[0];

196 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

197 
	`¡rcmp
(
»¶y_sub
->
¡r
, "maxmemory")) {

201 
»¶y_sub
 = 
»¶y
->
–em’t
[1];

202 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

203 
	`¡ršg2Î
(
»¶y_sub
->
¡r
,»¶y_sub->
Ën
,&
v®ue
) != 1) {

207 
td
->
maxmemÜy
 = 
v®ue
;

208 
	}
}

210 
	$upd©e_memÜy_šfo
(
d¬¿y
 *
abgs
)

212 
i
, 
j
;

214 
i
 = 0; i < 
	`d¬¿y_n
(
abgs
); i ++) {

215 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
abgs
, 
i
);

216 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

217 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

218 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

220 
	`»disAsyncCommªd
(
cc
->
aùx
, 
upd©e_memÜy_ÿÎback
, 
abs
, "info memory");

221 
	`»disAsyncCommªd
(
cc
->
aùx
, 
upd©e_maxmemÜy_ÿÎback
, 
abs
, "config get maxmemory");

224 
	}
}

226 
	$check_memÜy_’ough
(
back’d_th»ad
 *
bt
)

228 
i
, 
j
;

229 
d¬¿y
 *
abgs
 = 
bt
->abgs;

231 
i
 = 0; i < 
	`d¬¿y_n
(
abgs
); i ++) {

232 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
abgs
, 
i
);

233 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

234 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

235 
sk_d©a
 *
td
 = 
abs
->
d©a
;

236 
max_memÜy_®lowed
 = 0;

238 ià(
td
->
u£d_memÜy
) {

239 ià(
td
->
maxmemÜy
) {

240 
max_memÜy_®lowed
 = 
td
->
maxmemÜy
;

241 } ià(
td
->
tÙ®_sy¡em_memÜy
) {

242 
max_memÜy_®lowed
 = 
td
->
tÙ®_sy¡em_memÜy
;

245 ià(
max_memÜy_®lowed
) {

246 ià(
td
->
u£d_memÜy
*100/
max_memÜy_®lowed
 > 80) {

247 ià(!
td
->
d–‘šg
) {

248 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

249 
	`»disAsyncCommªd
(
cc
->
aùx
, 
sÿn_fÜ_d–‘e_ÿÎback
,

250 
abs
, "sÿÀ%Îd couÁ 1000", 
td
->
cursÜ
);

251 
td
->
d–‘šg
 = 1;

252 
bt
->
d–‘šg
 ++;

254 } ià(
td
->
d–‘šg
) {

255 
td
->
d–‘šg
 = 0;

256 
bt
->
d–‘šg
 --;

262 
	}
}

264 
	$back’d_th»ad_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

266 
back’d_th»ad
 *
bt
 = 
ş›ÁD©a
;

268 
	`ASSERT
(
ev’tLoİ
 =ğ
bt
->
–
);

271 ià(
bt
->
·u£
) {

272 ià(!
	`‹¡_if_Ãed_·u£
()) {

273 
bt
->
·u£
 = 0;

275 
bt
->
üÚloİs
 ++;

280 
	`upd©e_memÜy_šfo
(
bt
->
abgs
);

281 
	`check_memÜy_’ough
(
bt
);

284 ià(!
bt
->
·u£
 && 
	`‹¡_if_Ãed_·u£
(è&& !bt->
d–‘šg
) {

285 
bt
->
·u£
 = 1;

286 
	`Úe_back’d_th»ad_·u£d
();

289 
bt
->
üÚloİs
 ++;

290  1000/
bt
->
hz
;

291 
	}
}

293 
	$back’d_th»ad_š™
(
back’d_th»ad
 *
bt
, *
‹¡_rg‘_groups
)

295 
i
, 
j
, 
k
;

297 
bt
->
id
 = 0;

298 
bt
->
th»ad_id
 = 0;

299 
bt
->
–
 = 
NULL
;

300 
bt
->
hz
 = 10;

301 
bt
->
üÚloİs
 = 0;

302 
bt
->
d–‘šg
 = 0;

303 
bt
->
·u£
 = 0;

305 
bt
->
–
 = 
	`«C»©eEv’tLoİ
(1);

306 ià(
bt
->
–
 =ğ
NULL
) {

307  
VRT_ERROR
;

310 
bt
->
abgs
 = 
	`ab‹¡_groups_ü—‹
(
‹¡_rg‘_groups
);

311 ià(
bt
->
abgs
 =ğ
NULL
) {

312  
VRT_ERROR
;

316 
i
 = 0; i < 
	`d¬¿y_n
(
bt
->
abgs
); i ++) {

317 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
bt
->
abgs
, 
i
);

318 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

319 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

321 
abs
->
cÚn_cÚ‹xts
 = 
	`d¬¿y_ü—‹
(1, (
cÚn_cÚ‹xt
));

322 
k
 = 0; k < 1; k ++) {

323 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_push
(
abs
->
cÚn_cÚ‹xts
);

324 ià(
	`back’d_cÚn_cÚ‹xt_š™
(
cc
,
abs
->
ho¡
,abs->
pÜt
è!ğ
VRT_OK
) {

325  
VRT_ERROR
;

327 
cc
->
aùx
->
d©a
 = 
bt
;

328 
	`»disAeA‰ach
(
bt
->
–
, 
cc
->
aùx
);

329 
	`»disAsyncS‘CÚÃùC®lback
(
cc
->
aùx
,
cÚÃù_ÿÎback
);

330 
	`»disAsyncS‘DiscÚÃùC®lback
(
cc
->
aùx
,
discÚÃù_ÿÎback
);

333 
abs
->
d©a
 = 
	`sk_d©a_ü—‹
();

337 ià(
	`«C»©eTimeEv’t
(
bt
->
–
, 1, 
back’d_th»ad_üÚ
, bt, 
NULL
è=ğ
AE_ERR
) {

338  
VRT_ERROR
;

341  
VRT_OK
;

342 
	}
}

344 
	$back’d_th»ad_deš™
(
back’d_th»ad
 *
bt
)

346 ià(
bt
->
–
) {

347 
	`«D–‘eEv’tLoİ
(
bt
->
–
);

348 
bt
->
–
 = 
NULL
;

351 ià(
bt
->
abgs
) {

352 
i
, 
j
, 
k
;

354 
i
 = 0; i < 
	`d¬¿y_n
(
bt
->
abgs
); i ++) {

355 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
bt
->
abgs
, 
i
);

356 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

357 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

358 
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) > 0) {

359 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_pİ
(
abs
->
cÚn_cÚ‹xts
);

360 
	`back’d_cÚn_cÚ‹xt_deš™
(
cc
);

363 ià(
abs
->
d©a
) {

364 
	`sk_d©a_de¡roy
(
abs
->
d©a
);

365 
abs
->
d©a
;

370 
	`ab‹¡_groups_de¡roy
(
bt
->
abgs
);

371 
bt
->
abgs
 = 
NULL
;

373 
	}
}

375 
	$v¹_back’d_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
)

377 
j
;

379 
back’d_th»ads_couÁ
 = 
th»ads_couÁ
;

380 
back’d_th»ads
 = 
	`d¬¿y_ü—‹
(
th»ads_couÁ
, (
back’d_th»ad
));

381 ià(
back’d_th»ads
 =ğ
NULL
) {

382  
VRT_ERROR
;

385 
j
 = 0; j < 
th»ads_couÁ
; j ++) {

386 
back’d_th»ad
 *
bt
 = 
	`d¬¿y_push
(
back’d_th»ads
);

387 ià(
	`back’d_th»ad_š™
(
bt
, 
‹¡_rg‘_groups
è!ğ
VRT_OK
) {

388  
VRT_ERROR
;

390 
bt
->
id
 = 
j
;

393  
VRT_OK
;

394 
	}
}

396 
	$v¹_back’d_deš™
()

398 ià(
back’d_th»ads
) {

399 
	`d¬¿y_n
(
back’d_th»ads
) > 0) {

400 
back’d_th»ad
 *
bt
 = 
	`d¬¿y_pİ
(
back’d_th»ads
);

401 
	`back’d_th»ad_deš™
(
bt
);

403 
	`d¬¿y_de¡roy
(
back’d_th»ads
);

404 
back’d_th»ads
 = 
NULL
;

406 
	}
}

408 *
	$v¹_back’d_th»ad_run
(*
¬gs
)

410 
back’d_th»ad
 *
bt
 = 
¬gs
;

411 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

413 
	`«Maš
(
bt
->
–
);

415  
NULL
;

416 
	}
}

418 
	$v¹_¡¬t_back’d
()

420 
i
;

421 
i
 = 0; i < 
	`d¬¿y_n
(
back’d_th»ads
); i ++) {

422 
±h»ad_©Œ_t
 
©Œ
;

423 
back’d_th»ad
 *
bt
;

424 
	`±h»ad_©Œ_š™
(&
©Œ
);

425 
bt
 = 
	`d¬¿y_g‘
(
back’d_th»ads
, 
i
);

426 
	`±h»ad_ü—‹
(&
bt
->
th»ad_id
,

427 &
©Œ
, 
v¹_back’d_th»ad_run
, 
bt
);

430  
VRT_OK
;

431 
	}
}

433 
	$v¹_wa™_back’d
()

435 
i
;

437 
i
 = 0; i < 
	`d¬¿y_n
(
back’d_th»ads
); i ++){

438 
back’d_th»ad
 *
bt
 = 
	`d¬¿y_g‘
(
back’d_th»ads
, 
i
);

439 
	`±h»ad_još
(
bt
->
th»ad_id
, 
NULL
);

442  
VRT_OK
;

443 
	}
}

	@tests/vrt_backend.h

1 #iâdeà
_VRT_BACKEND_H_


2 
	#_VRT_BACKEND_H_


	)

4 
	~<d¬¿y.h
>

6 
	gab‹¡_group
;

7 
	gdli¡
;

8 
	gdmi¡
;

9 
	gd©a_un™
;

10 
	g«Ev’tLoİ
;

12 
	sback’d_th»ad
 {

13 
	mid
;

14 
±h»ad_t
 
	mth»ad_id
;

16 
«Ev’tLoİ
 *
	m–
;

17 
	mhz
;

18 
	müÚloİs
;

20 
d¬¿y
 *
	mabgs
;

22 
	md–‘šg
;

23 
	m·u£
;

24 } 
	tback’d_th»ad
;

26 
back’d_th»ads_couÁ
;

28 
back’d_th»ads_·u£_fšished_couÁ
;

30 
v¹_back’d_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
);

31 
v¹_back’d_deš™
();

33 
v¹_¡¬t_back’d
();

34 
v¹_wa™_back’d
();

	@tests/vrt_backend.h

1 #iâdeà
_VRT_BACKEND_H_


2 
	#_VRT_BACKEND_H_


	)

4 
	~<d¬¿y.h
>

6 
	gab‹¡_group
;

7 
	gdli¡
;

8 
	gdmi¡
;

9 
	gd©a_un™
;

10 
	g«Ev’tLoİ
;

12 
	sback’d_th»ad
 {

13 
	mid
;

14 
±h»ad_t
 
	mth»ad_id
;

16 
«Ev’tLoİ
 *
	m–
;

17 
	mhz
;

18 
	müÚloİs
;

20 
d¬¿y
 *
	mabgs
;

22 
	md–‘šg
;

23 
	m·u£
;

24 } 
	tback’d_th»ad
;

26 
back’d_th»ads_couÁ
;

28 
back’d_th»ads_·u£_fšished_couÁ
;

30 
v¹_back’d_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
);

31 
v¹_back’d_deš™
();

33 
v¹_¡¬t_back’d
();

34 
v¹_wa™_back’d
();

	@tests/vrt_benchmark.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<as£¹.h
>

9 
	~<sys/¡©.h
>

10 
	~<sys/ut¢ame.h
>

12 
	~<«.h
>

14 
	~<hœedis.h
>

15 
	~<sds.h
>

17 
	~<d¬¿y.h
>

18 
	~<dli¡.h
>

19 
	~<dut.h
>

20 
	~<dlog.h
>

22 
	~<v¹_ut.h
>

23 
	~<v¹_public.h
>

24 
	~<himemÿched.h
>

26 
	#TEST_CMD_PROTOCOL_REDIS
 0

	)

27 
	#TEST_CMD_PROTOCOL_MEMCACHE
 1

	)

29 
	#RANDPTR_INITIAL_SIZE
 8

	)

31 
	scÚfig
 {

32 cÚ¡ *
	mho¡
;

33 
	mho¡pÜt
;

34 cÚ¡ *
	mho¡sock‘
;

35 
	mnumş›Ás
;

36 
	mliveş›Ás
;

37 
	m»que¡s
;

38 
	m»que¡s_issued
;

39 
	m»que¡s_fšished
;

40 
	mkeysize
;

41 
	md©asize
;

42 
	m¿ndomkeys
;

43 
	m¿ndomkeys_key¥aûËn
;

44 
	mk“·live
;

45 
	mp–še
;

46 
	mshow”rÜs
;

47 
	m¡¬t
;

48 
	mtÙÏ‹ncy
;

49 *
	mÏ‹ncy
;

50 cÚ¡ *
	mt™Ë
;

51 
	mqu›t
;

52 
	mcsv
;

53 
	mloİ
;

54 
	midËmode
;

55 
	mdbnum
;

56 
sds
 
	mdbnum¡r
;

57 *
	m‹¡s
;

58 *
	mauth
;

59 
	mth»ads_couÁ
;

60 
	m´ÙocŞ
;

61 
	mnošlše
;

62 } 
	gcÚfig
;

64 
	sb’chm¬k_th»ad
 {

65 
	mid
;

66 
±h»ad_t
 
	mth»ad_id
;

68 
«Ev’tLoİ
 *
	m–
;

69 
	mhz
;

70 
	müÚloİs
;

72 
dli¡
 *
	mş›Ás
;

73 
	mnumş›Ás
;

74 
	mliveş›Ás
;

76 
	m»que¡s
;

77 
	m»que¡s_issued
;

78 
	m»que¡s_fšished
;

80 
	m¡¬t
;

81 
	mtÙÏ‹ncy
;

82 *
	mÏ‹ncy
;

83 } 
	tb’chm¬k_th»ad
;

85 
	s_b’chm¬k_ş›Á
 {

86 
b’chm¬k_th»ad
 *
	mbt
;

88 
»disCÚ‹xt
 *
	mrc
;

89 
mcCÚ‹xt
 *
	mmc
;

90 
sds
 
	mobuf
;

91 **
	m¿nd±r
;

92 
size_t
 
	m¿ndËn
;

93 
size_t
 
	m¿ndä“
;

94 
size_t
 
	mwr™‹n
;

95 
	m¡¬t
;

96 
	mÏ‹ncy
;

97 
	m³ndšg
;

98 
	m´efix_³ndšg
;

101 
	m´efixËn
;

102 } *
	tb’chm¬k_ş›Á
;

104 
d¬¿y
 *
	gbts
;

107 
wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

108 
b’chm¬k_ş›Á
 
ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, b’chm¬k_ş›Á 
äom
, 
b’chm¬k_th»ad
 *
th»ad
);

109 
ü—‹MissšgCl›Ás
(
b’chm¬k_ş›Á
 
c
);

110 
showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
);

112 
	$ä“Cl›Á
(
b’chm¬k_ş›Á
 
c
) {

113 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

114 
dli¡Node
 *
Ê
;

116 ià(
bt
->
–
) {

117 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
);

118 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
);

120 
	`»disF»e
(
c
->
rc
);

121 ià(
c
->
mc
) {

122 
c
->
mc
->
fd
 = -1;

123 
	`memÿchedF»e
(
c
->
mc
);

125 
	`sdsä“
(
c
->
obuf
);

126 
	`ä“
(
c
->
¿nd±r
);

127 
	`ä“
(
c
);

128 
	`upd©e_¡©e_sub
(
bt
->
liveş›Ás
,1);

129 
Ê
 = 
	`dli¡S—rchKey
(
bt
->
ş›Ás
,
c
);

130 
	`ASSERT
(
Ê
 !ğ
NULL
);

131 
	`dli¡D–Node
(
bt
->
ş›Ás
,
Ê
);

132 
	}
}

134 
	$ä“AÎCl›Ás
(
dli¡
 *
ş›Ás
) {

135 
dli¡Node
 *
Ê
 = 
ş›Ás
->
h—d
, *
Ãxt
;

137 
Ê
) {

138 
Ãxt
 = 
Ê
->next;

139 
	`ä“Cl›Á
(
Ê
->
v®ue
);

140 
Ê
 = 
Ãxt
;

142 
	}
}

144 
	$»£tCl›Á
(
b’chm¬k_ş›Á
 
c
) {

145 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

147 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
);

148 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
);

149 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

150 
c
->
wr™‹n
 = 0;

151 
c
->
³ndšg
 = 
cÚfig
.
p–še
;

152 
	}
}

154 
	$¿ndomizeCl›ÁKey
(
b’chm¬k_ş›Á
 
c
) {

155 
size_t
 
i
;

157 
i
 = 0; i < 
c
->
¿ndËn
; i++) {

158 *
p
 = 
c
->
¿nd±r
[
i
]+11;

159 
size_t
 
r
 = 
	`¿ndom
(è% 
cÚfig
.
¿ndomkeys_key¥aûËn
;

160 
size_t
 
j
;

162 
j
 = 0; j < 12; j++) {

163 *
p
 = '0'+
r
%10;

164 
r
/=10;

165 
p
--;

168 
	}
}

170 
	$ş›ÁDÚe
(
b’chm¬k_ş›Á
 
c
) {

171 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

172 
»que¡s_fšished
;

174 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&requests_finished);

175 ià(
»que¡s_fšished
 =ğ
bt
->
»que¡s
) {

176 
	`ä“Cl›Á
(
c
);

177 
	`«Stİ
(
bt
->
–
);

180 ià(
cÚfig
.
k“·live
) {

181 
	`»£tCl›Á
(
c
);

183 
	`upd©e_¡©e_sub
(
bt
->
liveş›Ás
,1);

184 
	`ü—‹MissšgCl›Ás
(
c
);

185 
	`upd©e_¡©e_add
(
bt
->
liveş›Ás
,1);

186 
	`ä“Cl›Á
(
c
);

188 
	}
}

190 
	$b’chm¬k_th»ad_š™
(
b’chm¬k_th»ad
 *
bt
, 
»que¡s
, 
numş›Ás
, *
cmd
, 
size_t
 
Ën
)

192 
b’chm¬k_ş›Á
 
c
;

194 
bt
->
th»ad_id
 = 0;

195 
bt
->
–
 = 
NULL
;

196 
bt
->
hz
 = 10;

197 
bt
->
üÚloİs
 = 0;

198 
bt
->
ş›Ás
 = 
NULL
;

199 
bt
->
numş›Ás
 =‚umclients;

200 
bt
->
liveş›Ás
 = 0;

201 
bt
->
»que¡s
 =„equests;

202 
bt
->
»que¡s_issued
 = 0;

203 
bt
->
»que¡s_fšished
 = 0;

204 
bt
->
¡¬t
 = 0;

205 
bt
->
tÙÏ‹ncy
 = 0;

206 
bt
->
Ï‹ncy
 = 
NULL
;

208 
bt
->
–
 = 
	`«C»©eEv’tLoİ
(1024*10);

209 ià(
bt
->
–
 =ğ
NULL
) {

210  
VRT_ERROR
;

213 
bt
->
ş›Ás
 = 
	`dli¡C»©e
();

214 ià(
bt
->
ş›Ás
 =ğ
NULL
) {

215  
VRT_ERROR
;

218 
bt
->
Ï‹ncy
 = 
	`m®loc
(()*bt->
»que¡s
);

220 
c
 = 
	`ü—‹Cl›Á
(
cmd
,
Ën
,
NULL
,
bt
);

221 
	`ü—‹MissšgCl›Ás
(
c
);

223 ià(
bt
->
id
 == 0) {

224 
	`«C»©eTimeEv’t
(
bt
->
–
,1,
showThroughput
,
NULL
,NULL);

227  
VRT_OK
;

228 
	}
}

230 
	$b’chm¬k_th»ad_deš™
(
b’chm¬k_th»ad
 *
bt
)

232 ià(
bt
->
ş›Ás
) {

233 
	`ä“AÎCl›Ás
(
bt
->
ş›Ás
);

234 
	`dli¡R–—£
(
bt
->
ş›Ás
);

235 
bt
->
ş›Ás
 = 
NULL
;

238 ià(
bt
->
–
) {

239 
	`«D–‘eEv’tLoİ
(
bt
->
–
);

240 
bt
->
–
 = 
NULL
;

243 ià(
bt
->
Ï‹ncy
) {

244 
	`ä“
(
bt
->
Ï‹ncy
);

245 
bt
->
Ï‹ncy
 = 
NULL
;

247 
	}
}

249 *
	$b’chm¬k_th»ad_run
(*
¬gs
)

251 
b’chm¬k_th»ad
 *
bt
 = 
¬gs
;

252 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

254 
	`«Maš
(
bt
->
–
);

256  
NULL
;

257 
	}
}

259 
	$¡¬t_b’chm¬k_th»ads_uÁ_fšish
()

261 
i
;

262 
b’chm¬k_th»ad
 *
bt
;

264 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

265 
±h»ad_©Œ_t
 
©Œ
;

266 
	`±h»ad_©Œ_š™
(&
©Œ
);

267 
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

268 
	`±h»ad_ü—‹
(&
bt
->
th»ad_id
,

269 &
©Œ
, 
b’chm¬k_th»ad_run
, 
bt
);

272 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

273 
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

274 
	`±h»ad_još
(
bt
->
th»ad_id
, 
NULL
);

277  
VRT_OK
;

278 
	}
}

280 
	$»adHªdËrMC
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

281 
b’chm¬k_ş›Á
 
c
 = 
´ivd©a
;

282 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

283 
mcCÚ‹xt
 *
mc
 = 
c
->mc;

284 
»que¡s_fšished
;

285 *
»¶y
 = 
NULL
;

286 
	`UNUSED
(
–
);

287 
	`UNUSED
(
fd
);

288 
	`UNUSED
(
mask
);

293 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`du£c_now
()-(c->
¡¬t
);

295 ià(
	`memÿchedBufãrR—d
(
mc
è!ğ
MC_OK
) {

296 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
mc
->
”r¡r
);

297 
	`ex™
(1);

299 
c
->
³ndšg
) {

300 ià(
	`memÿchedG‘R•ly
(
mc
,&
»¶y
è!ğ
MC_OK
) {

301 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
mc
->
”r¡r
);

302 
	`ex™
(1);

305 ià(
»¶y
 !ğ
NULL
) {

306 ià(
»¶y
 =ğ(*)
MC_REPLY_ERROR
) {

307 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

308 
	`ex™
(1);

311 ià(
cÚfig
.
show”rÜs
) {

312 
time_t
 
Ï¡”r_time
 = 0;

313 
time_t
 
now
 = 
	`time
(
NULL
);

314 
mcR•ly
 *
r
 = 
»¶y
;

315 ià(
r
->
ty³
 =ğ
MC_REPLY_ERROR
 && 
Ï¡”r_time
 !ğ
now
) {

316 
Ï¡”r_time
 = 
now
;

317 
	`´štf
("E¼Ü from s”v”: %s\n", 
r
->
¡r
);

321 
	`ä“McR•lyObjeù
(
»¶y
);

323 ià(
c
->
´efix_³ndšg
 > 0) {

324 
c
->
´efix_³ndšg
--;

325 
c
->
³ndšg
--;

327 ià(
c
->
´efixËn
 > 0) {

328 
size_t
 
j
;

329 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

332 
j
 = 0; j < 
c
->
¿ndËn
; j++)

333 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

334 
c
->
´efixËn
 = 0;

339 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&requests_finished);

340 ià(
»que¡s_fšished
 < 
bt
->
»que¡s
) {

341 
bt
->
Ï‹ncy
[
»que¡s_fšished
] = 
c
->latency;

342 
	`upd©e_¡©e_add
(
bt
->
»que¡s_fšished
,1);

344 
c
->
³ndšg
--;

345 ià(
c
->
³ndšg
 == 0) {

346 
	`ş›ÁDÚe
(
c
);

354 
	}
}

356 
	$»adHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

357 
b’chm¬k_ş›Á
 
c
 = 
´ivd©a
;

358 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

359 
»que¡s_fšished
;

360 *
»¶y
 = 
NULL
;

361 
	`UNUSED
(
–
);

362 
	`UNUSED
(
fd
);

363 
	`UNUSED
(
mask
);

368 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`du£c_now
()-(c->
¡¬t
);

370 ià(
	`»disBufãrR—d
(
c
->
rc
è!ğ
REDIS_OK
) {

371 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
rc
->
”r¡r
);

372 
	`ex™
(1);

374 
c
->
³ndšg
) {

375 ià(
	`»disG‘R•ly
(
c
->
rc
,&
»¶y
è!ğ
REDIS_OK
) {

376 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
rc
->
”r¡r
);

377 
	`ex™
(1);

379 ià(
»¶y
 !ğ
NULL
) {

380 ià(
»¶y
 =ğ(*)
REDIS_REPLY_ERROR
) {

381 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

382 
	`ex™
(1);

385 ià(
cÚfig
.
show”rÜs
) {

386 
time_t
 
Ï¡”r_time
 = 0;

387 
time_t
 
now
 = 
	`time
(
NULL
);

388 
»disR•ly
 *
r
 = 
»¶y
;

389 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
 && 
Ï¡”r_time
 !ğ
now
) {

390 
Ï¡”r_time
 = 
now
;

391 
	`´štf
("E¼Ü from s”v”: %s\n", 
r
->
¡r
);

395 
	`ä“R•lyObjeù
(
»¶y
);

397 ià(
c
->
´efix_³ndšg
 > 0) {

398 
c
->
´efix_³ndšg
--;

399 
c
->
³ndšg
--;

401 ià(
c
->
´efixËn
 > 0) {

402 
size_t
 
j
;

403 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

406 
j
 = 0; j < 
c
->
¿ndËn
; j++)

407 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

408 
c
->
´efixËn
 = 0;

413 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&requests_finished);

414 ià(
»que¡s_fšished
 < 
bt
->
»que¡s
) {

415 
bt
->
Ï‹ncy
[
»que¡s_fšished
] = 
c
->latency;

416 
	`upd©e_¡©e_add
(
bt
->
»que¡s_fšished
,1);

418 
c
->
³ndšg
--;

419 ià(
c
->
³ndšg
 == 0) {

420 
	`ş›ÁDÚe
(
c
);

428 
	}
}

430 
	$wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

431 
b’chm¬k_ş›Á
 
c
 = 
´ivd©a
;

432 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

433 
	`UNUSED
(
–
);

434 
	`UNUSED
(
fd
);

435 
	`UNUSED
(
mask
);

438 ià(
c
->
wr™‹n
 == 0) {

440 ià(
bt
->
»que¡s_issued
++ >ğbt->
»que¡s
) {

441 
	`ä“Cl›Á
(
c
);

446 ià(
cÚfig
.
¿ndomkeys
è
	`¿ndomizeCl›ÁKey
(
c
);

447 
c
->
¡¬t
 = 
	`du£c_now
();

448 
c
->
Ï‹ncy
 = -1;

451 ià(
	`sd¦’
(
c
->
obuf
è> c->
wr™‹n
) {

452 *
±r
 = 
c
->
obuf
+c->
wr™‹n
;

453 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
c
->
rc
->
fd
,
±r
,
	`sd¦’
(c->
obuf
)-c->
wr™‹n
);

455 ià(
nwr™‹n
 == -1) {

456 ià(
”ºo
 !ğ
EPIPE
)

457 
	`årštf
(
¡d”r
, "Wr™šgØsock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

458 
	`ä“Cl›Á
(
c
);

461 
c
->
wr™‹n
 +ğ
nwr™‹n
;

462 ià(
	`sd¦’
(
c
->
obuf
è=ğc->
wr™‹n
) {

463 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
);

464 ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_REDIS
) {

465 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
,
»adHªdËr
,c);

466 } ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_MEMCACHE
) {

467 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
,
»adHªdËrMC
,c);

469 
	`NOT_REACHED
();

473 
	}
}

496 
b’chm¬k_ş›Á
 
	$ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, 
b’chm¬k_ş›Á
 
äom
, 
b’chm¬k_th»ad
 *
th»ad
) {

497 
j
;

498 
b’chm¬k_th»ad
 *
bt
;

499 
b’chm¬k_ş›Á
 
c
 = 
	`m®loc
((
_b’chm¬k_ş›Á
));

501 
c
->
bt
 = 
NULL
;

502 
c
->
rc
 = 
NULL
;

503 
c
->
mc
 = 
NULL
;

504 
c
->
obuf
 = 
NULL
;

505 
c
->
¿nd±r
 = 
NULL
;

506 
c
->
¿ndËn
 = 0;

507 
c
->
¿ndä“
 = 0;

508 
c
->
wr™‹n
 = 0;

509 
c
->
¡¬t
 = 0;

510 
c
->
Ï‹ncy
 = 0;

511 
c
->
³ndšg
 = 0;

512 
c
->
´efix_³ndšg
 = 0;

513 
c
->
´efixËn
 = 0;

515 ià(
äom
 =ğ
NULL
) {

516 
	`ASSERT
(
th»ad
 !ğ
NULL
);

517 
bt
 = 
th»ad
;

519 
bt
 = 
äom
->bt;

522 
c
->
bt
 = bt;

524 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

525 
c
->
rc
 = 
	`»disCÚÃùNÚBlock
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

527 
c
->
rc
 = 
	`»disCÚÃùUnixNÚBlock
(
cÚfig
.
ho¡sock‘
);

529 ià(
c
->
rc
->
”r
) {

530 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

531 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

532 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
c
->
rc
->
”r¡r
);

534 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
c
->
rc
->
”r¡r
);

535 
	`ex™
(1);

538 
c
->
rc
->
»ad”
->
maxbuf
 = 0;

543 
c
->
obuf
 = 
	`sd£m±y
();

547 
c
->
´efix_³ndšg
 = 0;

548 ià(
cÚfig
.
auth
) {

549 *
buf
 = 
NULL
;

550 
Ën
 = 
	`»disFÜm©Commªd
(&
buf
, "AUTH %s", 
cÚfig
.
auth
);

551 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf, 
buf
, 
Ën
);

552 
	`ä“
(
buf
);

553 
c
->
´efix_³ndšg
++;

560 ià(
cÚfig
.
dbnum
 != 0) {

561 
c
->
obuf
 = 
	`sdsÿrštf
(c->obuf,"*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n",

562 ()
	`sd¦’
(
cÚfig
.
dbnum¡r
),config.dbnumstr);

563 
c
->
´efix_³ndšg
++;

565 
c
->
´efixËn
 = 
	`sd¦’
(c->
obuf
);

567 ià(
äom
) {

568 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,

569 
äom
->
obuf
+äom->
´efixËn
,

570 
	`sd¦’
(
äom
->
obuf
)-äom->
´efixËn
);

572 
j
 = 0; j < 
cÚfig
.
p–še
; j++)

573 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,
cmd
,
Ën
);

576 
c
->
wr™‹n
 = 0;

577 
c
->
³ndšg
 = 
cÚfig
.
p–še
+c->
´efix_³ndšg
;

578 
c
->
¿nd±r
 = 
NULL
;

579 
c
->
¿ndËn
 = 0;

582 ià(
cÚfig
.
¿ndomkeys
) {

583 ià(
äom
) {

584 
c
->
¿ndËn
 = 
äom
->randlen;

585 
c
->
¿ndä“
 = 0;

586 
c
->
¿nd±r
 = 
	`m®loc
((*)*c->
¿ndËn
);

588 
j
 = 0; j < ()
c
->
¿ndËn
; j++) {

589 
c
->
¿nd±r
[
j
] = c->
obuf
 + (
äom
->randptr[j]-from->obuf);

591 
c
->
¿nd±r
[
j
] +ğc->
´efixËn
 - 
äom
->prefixlen;

594 *
p
 = 
c
->
obuf
;

596 
c
->
¿ndËn
 = 0;

597 
c
->
¿ndä“
 = 
RANDPTR_INITIAL_SIZE
;

598 
c
->
¿nd±r
 = 
	`m®loc
((*)*c->
¿ndä“
);

599 (
p
 = 
	`¡r¡r
Õ,"__¿nd_št__")è!ğ
NULL
) {

600 ià(
c
->
¿ndä“
 == 0) {

601 
c
->
¿nd±r
 = 
	`»®loc
(c->¿nd±r,(*)*c->
¿ndËn
*2);

602 
c
->
¿ndä“
 +ğc->
¿ndËn
;

604 
c
->
¿nd±r
[c->
¿ndËn
++] = 
p
;

605 
c
->
¿ndä“
--;

606 
p
 += 12;

610 ià(
cÚfig
.
idËmode
 == 0)

611 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

614 ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_MEMCACHE
) {

615 
c
->
mc
 = 
	`memÿchedCÚ‹xtIn™
();

616 
c
->
mc
->
fd
 = c->
rc
->fd;

617 
c
->
mc
->
æags
 &ğ~
MC_BLOCK
;

620 
	`dli¡AddNodeTa
(
bt
->
ş›Ás
,
c
);

621 
	`upd©e_¡©e_add
(
bt
->
liveş›Ás
,1);

623  
c
;

624 
	}
}

626 
	$ü—‹MissšgCl›Ás
(
b’chm¬k_ş›Á
 
c
) {

627 
n
 = 0;

628 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

629 
liveş›Ás
;

631 
	`upd©e_¡©e_g‘
(
bt
->
liveş›Ás
,&liveclients);

633 
liveş›Ás
 < 
bt
->
numş›Ás
) {

634 
	`ü—‹Cl›Á
(
NULL
,0,
c
,NULL);

637 ià(++
n
 > 64) {

638 
	`u¦“p
(50000);

639 
n
 = 0;

641 
	`upd©e_¡©e_g‘
(
bt
->
liveş›Ás
,&liveclients);

643 
	}
}

645 
	$com·»L©’cy
(cÚ¡ *
a
, cÚ¡ *
b
) {

646  (*(*)
a
)-(*(*)
b
);

647 
	}
}

649 
	$upd©eB’chm¬kSts
()

651 
i
;

652 
couÁ
;

654 
cÚfig
.
liveş›Ás
 = 0;

655 
cÚfig
.
»que¡s_fšished
 = 0;

657 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

658 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

659 
	`upd©e_¡©e_g‘
(
bt
->
liveş›Ás
,&
couÁ
);

660 
cÚfig
.
liveş›Ás
 +ğ
couÁ
;

661 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&
couÁ
);

662 
cÚfig
.
»que¡s_fšished
 +ğ
couÁ
;

664 
	}
}

666 
	$showL©’cyR•Üt
() {

667 
i
, 
j
, 
cu¾©
 = 0;

668 
n
 = 0;

669 
³rc
, 
»q³r£c
;

671 
	`upd©eB’chm¬kSts
();

673 
»q³r£c
 = ()
cÚfig
.
»que¡s_fšished
/(()cÚfig.
tÙÏ‹ncy
/1000);

674 ià(!
cÚfig
.
qu›t
 && !cÚfig.
csv
) {

675 
	`´štf
("=====ğ% ======\n", 
cÚfig
.
t™Ë
);

676 
	`´štf
(" %d„eque¡ com¶‘ed iÀ%.2à£cÚds\n", 
cÚfig
.
»que¡s_fšished
,

677 ()
cÚfig
.
tÙÏ‹ncy
/1000);

678 
	`´štf
(" %d…¬®ËÈş›Ás\n", 
cÚfig
.
numş›Ás
);

679 
	`´štf
(" %d by‹ ·ylßd\n", 
cÚfig
.
d©asize
);

680 
	`´štf
(" k“°®ive: %d\n", 
cÚfig
.
k“·live
);

681 
	`´štf
("\n");

683 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i++) {

684 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

685 
j
 = 0; j < 
bt
->
»que¡s
; j ++) {

686 
cÚfig
.
Ï‹ncy
[
n
++] = 
bt
->Ï‹ncy[
j
];

690 
	`qsÜt
(
cÚfig
.
Ï‹ncy
,cÚfig.
»que¡s
,(),
com·»L©’cy
);

691 
i
 = 0; i < 
cÚfig
.
»que¡s
; i++) {

692 ià(
cÚfig
.
Ï‹ncy
[
i
]/1000 !ğ
cu¾©
 || i =ğ(cÚfig.
»que¡s
-1)) {

693 
cu¾©
 = 
cÚfig
.
Ï‹ncy
[
i
]/1000;

694 
³rc
 = (()(
i
+1)*100)/
cÚfig
.
»que¡s
;

695 
	`´štf
("%.2f%% <ğ%d mli£cÚds\n", 
³rc
, 
cu¾©
);

698 
	`´štf
("%.2à»que¡ ³¸£cÚd\n\n", 
»q³r£c
);

699 } ià(
cÚfig
.
csv
) {

700 
	`´štf
("\"%s\",\"%.2f\"\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

702 
	`´štf
("%s: %.2à»que¡ ³¸£cÚd\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

704 
	}
}

706 
	$b’chm¬k
(*
t™Ë
, *
cmd
, 
Ën
) {

707 
i
;

708 
»que¡s_³r_th»ad
, 
»que¡s_»mašd”
;

709 
ş›Ás_³r_th»ad
, 
ş›Ás_»mašd”
;

710 
b’chm¬k_ş›Á
 
c
;

712 
cÚfig
.
t™Ë
 =itle;

713 
cÚfig
.
»que¡s_issued
 = 0;

714 
cÚfig
.
»que¡s_fšished
 = 0;

717 ià(
cÚfig
.
th»ads_couÁ
 <= 0) {

718 
	`´štf
("ERROR:hreads count‚eed biggerhan zero\n");

720 
bts
 = 
	`d¬¿y_ü—‹
(
cÚfig
.
th»ads_couÁ
, (
b’chm¬k_th»ad
));

721 
»que¡s_³r_th»ad
 = 
cÚfig
.
»que¡s
/cÚfig.
th»ads_couÁ
;

722 
»que¡s_»mašd”
 = 
cÚfig
.
»que¡s
%cÚfig.
th»ads_couÁ
;

723 
ş›Ás_³r_th»ad
 = 
cÚfig
.
numş›Ás
/cÚfig.
th»ads_couÁ
;

724 
ş›Ás_»mašd”
 = 
cÚfig
.
numş›Ás
%cÚfig.
th»ads_couÁ
;

725 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

726 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_push
(
bts
);

727 
bt
->
id
 = 
i
;

728 
	`b’chm¬k_th»ad_š™
(
bt
,

729 
»que¡s_»mašd”
-->0?
»que¡s_³r_th»ad
+1:requests_per_thread,

730 
ş›Ás_»mašd”
-->0?
ş›Ás_³r_th»ad
+1:clients_per_thread,

731 
cmd
,
Ën
);

734 
cÚfig
.
¡¬t
 = 
	`dm£c_now
();

735 
	`¡¬t_b’chm¬k_th»ads_uÁ_fšish
();

736 
cÚfig
.
tÙÏ‹ncy
 = 
	`dm£c_now
()-cÚfig.
¡¬t
;

738 
	`showL©’cyR•Üt
();

740 
	`d¬¿y_n
(
bts
) > 0) {

741 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_pİ
(
bts
);

742 
	`b’chm¬k_th»ad_deš™
(
bt
);

744 
	`d¬¿y_de¡roy
(
bts
);

745 
bts
 = 
NULL
;

746 
	}
}

749 
	$·r£O±iÚs
(
¬gc
, cÚ¡ **
¬gv
) {

750 
i
;

751 
Ï¡¬g
;

752 
ex™_¡©us
 = 1;

754 
i
 = 1; i < 
¬gc
; i++) {

755 
Ï¡¬g
 = (
i
 =ğ(
¬gc
-1));

757 ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

758 ià(
Ï¡¬g
è
šv®id
;

759 
cÚfig
.
numş›Ás
 = 
	`©oi
(
¬gv
[++
i
]);

760 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n")) {

761 ià(
Ï¡¬g
è
šv®id
;

762 
cÚfig
.
»que¡s
 = 
	`©oi
(
¬gv
[++
i
]);

763 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-k")) {

764 ià(
Ï¡¬g
è
šv®id
;

765 
cÚfig
.
k“·live
 = 
	`©oi
(
¬gv
[++
i
]);

766 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h")) {

767 ià(
Ï¡¬g
è
šv®id
;

768 
cÚfig
.
ho¡
 = 
	`¡rdup
(
¬gv
[++
i
]);

769 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p")) {

770 ià(
Ï¡¬g
è
šv®id
;

771 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

772 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s")) {

773 ià(
Ï¡¬g
è
šv®id
;

774 
cÚfig
.
ho¡sock‘
 = 
	`¡rdup
(
¬gv
[++
i
]);

775 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a") ) {

776 ià(
Ï¡¬g
è
šv®id
;

777 
cÚfig
.
auth
 = 
	`¡rdup
(
¬gv
[++
i
]);

778 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d")) {

779 ià(
Ï¡¬g
è
šv®id
;

780 
cÚfig
.
d©asize
 = 
	`©oi
(
¬gv
[++
i
]);

781 ià(
cÚfig
.
d©asize
 < 1) config.datasize=1;

782 ià(
cÚfig
.
d©asize
 > 1024*1024*1024) config.datasize = 1024*1024*1024;

783 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-P")) {

784 ià(
Ï¡¬g
è
šv®id
;

785 
cÚfig
.
p–še
 = 
	`©oi
(
¬gv
[++
i
]);

786 ià(
cÚfig
.
p–še
 <= 0) config.pipeline=1;

787 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r")) {

788 ià(
Ï¡¬g
è
šv®id
;

789 
cÚfig
.
¿ndomkeys
 = 1;

790 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 
	`©oi
(
¬gv
[++
i
]);

791 ià(
cÚfig
.
¿ndomkeys_key¥aûËn
 < 0)

792 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

793 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-q")) {

794 
cÚfig
.
qu›t
 = 1;

795 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

796 
cÚfig
.
csv
 = 1;

797 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-l")) {

798 
cÚfig
.
loİ
 = 1;

799 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-I")) {

800 
cÚfig
.
idËmode
 = 1;

801 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-e")) {

802 
cÚfig
.
show”rÜs
 = 1;

803 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-t")) {

804 ià(
Ï¡¬g
è
šv®id
;

810 
cÚfig
.
‹¡s
 = 
	`sd¢ew
(",");

811 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(cÚfig.‹¡s,(*)
¬gv
[++
i
]);

812 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(config.tests,",");

813 
	`sd¡Şow”
(
cÚfig
.
‹¡s
);

814 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--dbnum")) {

815 ià(
Ï¡¬g
è
šv®id
;

816 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

817 
cÚfig
.
dbnum¡r
 = 
	`sdsäomlÚglÚg
(cÚfig.
dbnum
);

818 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-T")) {

819 ià(
Ï¡¬g
è
šv®id
;

820 
cÚfig
.
th»ads_couÁ
 = 
	`©oi
(
¬gv
[++
i
]);

821 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-m")) {

822 
cÚfig
.
´ÙocŞ
 = 
TEST_CMD_PROTOCOL_MEMCACHE
;

823 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--noinline")) {

824 
cÚfig
.
nošlše
 = 1;

825 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

826 
ex™_¡©us
 = 0;

827 
u§ge
;

832 ià(
¬gv
[
i
][0] =ğ'-'è
šv®id
;

833  
i
;

837  
i
;

839 
šv®id
:

840 
	`´štf
("Inv®id o±iÚ \"%s\" o¸İtiÚ‡rgum’ˆmissšg\n\n",
¬gv
[
i
]);

842 
u§ge
:

843 
	`´štf
(

888 
	`ex™
(
ex™_¡©us
);

889 
	}
}

891 
	$showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

892 
	`UNUSED
(
ev’tLoİ
);

893 
	`UNUSED
(
id
);

894 
	`UNUSED
(
ş›ÁD©a
);

896 
	`upd©eB’chm¬kSts
();

898 ià(
cÚfig
.
liveş›Ás
 == 0) {

899 
	`årštf
(
¡d”r
,"All clients disconnected...‡borting.\n");

900 
	`ex™
(1);

902 ià(
cÚfig
.
csv
)  250;

903 ià(
cÚfig
.
idËmode
 == 1) {

904 
	`´štf
("ş›Ás: %d\r", 
cÚfig
.
liveş›Ás
);

905 
	`fæush
(
¡dout
);

908 
dt
 = ()(
	`dm£c_now
()-
cÚfig
.
¡¬t
)/1000.0;

909 
½s
 = ()
cÚfig
.
»que¡s_fšished
/
dt
;

910 
	`´štf
("%s: %.2f\r", 
cÚfig
.
t™Ë
, 
½s
);

911 
	`fæush
(
¡dout
);

913 
	}
}

917 
	$‹¡_is_£Ëùed
(*
Çme
) {

918 
buf
[256];

919 
l
 = 
	`¡¾’
(
Çme
);

921 ià(
cÚfig
.
‹¡s
 =ğ
NULL
)  1;

922 
buf
[0] = ',';

923 
	`memıy
(
buf
+1,
Çme
,
l
);

924 
buf
[
l
+1] = ',';

925 
buf
[
l
+2] = '\0';

926  
	`¡r¡r
(
cÚfig
.
‹¡s
,
buf
è!ğ
NULL
;

927 
	}
}

929 
	$‹¡_»dis
(
¬gc
, cÚ¡ **
¬gv
)

931 
i
;

932 *
d©a
, *
cmd
;

933 
Ën
;

936 ià(
¬gc
) {

937 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

938 
i
 = 1; i < 
¬gc
; i++) {

939 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

940 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

944 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

945 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

946 
	`ä“
(
cmd
);

947 } 
cÚfig
.
loİ
);

953 
d©a
 = 
	`m®loc
(
cÚfig
.
d©asize
+1);

955 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

956 
d©a
[
cÚfig
.
d©asize
] = '\0';

958 ià(!
cÚfig
.
nošlše
 && (
	`‹¡_is_£Ëùed
("ping_inline") ||est_is_selected("ping")))

959 
	`b’chm¬k
("PING_INLINE","PING\r\n",6);

961 ià(
	`‹¡_is_£Ëùed
("ping_mbulk") ||est_is_selected("ping")) {

962 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"PING");

963 
	`b’chm¬k
("PING_BULK",
cmd
,
Ën
);

964 
	`ä“
(
cmd
);

967 ià(
	`‹¡_is_£Ëùed
("set")) {

968 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET key:__¿nd_št__ %s",
d©a
);

969 
	`b’chm¬k
("SET",
cmd
,
Ën
);

970 
	`ä“
(
cmd
);

973 ià(
	`‹¡_is_£Ëùed
("get")) {

974 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"GET key:__rand_int__");

975 
	`b’chm¬k
("GET",
cmd
,
Ën
);

976 
	`ä“
(
cmd
);

979 ià(
	`‹¡_is_£Ëùed
("incr")) {

980 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"INCR counter:__rand_int__");

981 
	`b’chm¬k
("INCR",
cmd
,
Ën
);

982 
	`ä“
(
cmd
);

985 ià(
	`‹¡_is_£Ëùed
("lpush")) {

986 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

987 
	`b’chm¬k
("LPUSH",
cmd
,
Ën
);

988 
	`ä“
(
cmd
);

991 ià(
	`‹¡_is_£Ëùed
("rpush")) {

992 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPUSH myli¡ %s",
d©a
);

993 
	`b’chm¬k
("RPUSH",
cmd
,
Ën
);

994 
	`ä“
(
cmd
);

997 ià(
	`‹¡_is_£Ëùed
("lpop")) {

998 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPOP mylist");

999 
	`b’chm¬k
("LPOP",
cmd
,
Ën
);

1000 
	`ä“
(
cmd
);

1003 ià(
	`‹¡_is_£Ëùed
("rpop")) {

1004 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPOP mylist");

1005 
	`b’chm¬k
("RPOP",
cmd
,
Ën
);

1006 
	`ä“
(
cmd
);

1009 ià(
	`‹¡_is_£Ëùed
("sadd")) {

1010 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,

1012 
	`b’chm¬k
("SADD",
cmd
,
Ën
);

1013 
	`ä“
(
cmd
);

1016 ià(
	`‹¡_is_£Ëùed
("spop")) {

1017 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SPOP myset");

1018 
	`b’chm¬k
("SPOP",
cmd
,
Ën
);

1019 
	`ä“
(
cmd
);

1022 ià(
	`‹¡_is_£Ëùed
("lrange") ||

1023 
	`‹¡_is_£Ëùed
("lrange_100") ||

1024 
	`‹¡_is_£Ëùed
("lrange_300") ||

1025 
	`‹¡_is_£Ëùed
("lrange_500") ||

1026 
	`‹¡_is_£Ëùed
("lrange_600"))

1028 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

1029 
	`b’chm¬k
("LPUSH (ÃededØb’chm¬k LRANGE)",
cmd
,
Ën
);

1030 
	`ä“
(
cmd
);

1033 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_100")) {

1034 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 99");

1035 
	`b’chm¬k
("LRANGE_100 (fœ¡ 100ƒËm’ts)",
cmd
,
Ën
);

1036 
	`ä“
(
cmd
);

1039 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_300")) {

1040 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 299");

1041 
	`b’chm¬k
("LRANGE_300 (fœ¡ 300ƒËm’ts)",
cmd
,
Ën
);

1042 
	`ä“
(
cmd
);

1045 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_500")) {

1046 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 449");

1047 
	`b’chm¬k
("LRANGE_500 (fœ¡ 450ƒËm’ts)",
cmd
,
Ën
);

1048 
	`ä“
(
cmd
);

1051 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_600")) {

1052 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 599");

1053 
	`b’chm¬k
("LRANGE_600 (fœ¡ 600ƒËm’ts)",
cmd
,
Ën
);

1054 
	`ä“
(
cmd
);

1057 ià(
	`‹¡_is_£Ëùed
("mset")) {

1058 cÚ¡ *
¬gv
[21];

1059 
¬gv
[0] = "MSET";

1060 
i
 = 1; i < 21; i += 2) {

1061 
¬gv
[
i
] = "key:__rand_int__";

1062 
¬gv
[
i
+1] = 
d©a
;

1064 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,21,
¬gv
,
NULL
);

1065 
	`b’chm¬k
("MSET (10 keys)",
cmd
,
Ën
);

1066 
	`ä“
(
cmd
);

1069 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

1070 } 
cÚfig
.
loİ
);

1072  
VRT_OK
;

1073 
	}
}

1075 
	$‹¡_memÿched
(
¬gc
, cÚ¡ **
¬gv
)

1077 
i
;

1078 *
d©a
, *
cmd
;

1079 
Ën
;

1082 ià(
¬gc
) {

1083 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

1084 
i
 = 1; i < 
¬gc
; i++) {

1085 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

1086 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

1090 
Ën
 = 
	`memÿchedFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

1091 ià(
Ën
 < 0) {

1095 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

1096 
	`ä“
(
cmd
);

1097 } 
cÚfig
.
loİ
);

1103 
d©a
 = 
	`m®loc
(
cÚfig
.
d©asize
+1);

1105 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

1106 
d©a
[
cÚfig
.
d©asize
] = '\0';

1108 ià(
	`‹¡_is_£Ëùed
("set")) {

1109 
Ën
 = 
	`memÿchedFÜm©Commªd
(&
cmd
,"£ˆkey:__¿nd_št__ 0 0 %d %s", 
cÚfig
.
d©asize
, 
d©a
);

1111 
	`b’chm¬k
("SET",
cmd
,
Ën
);

1112 
	`ä“
(
cmd
);

1115 ià(
	`‹¡_is_£Ëùed
("get")) {

1116 
Ën
 = 
	`memÿchedFÜm©Commªd
(&
cmd
,"get key:__rand_int__");

1117 
	`b’chm¬k
("GET",
cmd
,
Ën
);

1118 
	`ä“
(
cmd
);

1121 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

1122 } 
cÚfig
.
loİ
);

1124  
VRT_OK
;

1125 
	}
}

1127 
	$maš
(
¬gc
, cÚ¡ **
¬gv
) {

1128 
i
;

1130 
b’chm¬k_ş›Á
 
c
;

1132 
	`¤ªdom
(
	`time
(
NULL
));

1133 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

1134 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

1136 
cÚfig
.
numş›Ás
 = 50;

1137 
cÚfig
.
»que¡s
 = 100000;

1138 
cÚfig
.
liveş›Ás
 = 0;

1139 
cÚfig
.
k“·live
 = 1;

1140 
cÚfig
.
d©asize
 = 3;

1141 
cÚfig
.
p–še
 = 1;

1142 
cÚfig
.
show”rÜs
 = 0;

1143 
cÚfig
.
¿ndomkeys
 = 0;

1144 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

1145 
cÚfig
.
qu›t
 = 0;

1146 
cÚfig
.
csv
 = 0;

1147 
cÚfig
.
loİ
 = 0;

1148 
cÚfig
.
idËmode
 = 0;

1149 
cÚfig
.
Ï‹ncy
 = 
NULL
;

1150 
cÚfig
.
ho¡
 = "127.0.0.1";

1151 
cÚfig
.
ho¡pÜt
 = 6379;

1152 
cÚfig
.
ho¡sock‘
 = 
NULL
;

1153 
cÚfig
.
‹¡s
 = 
NULL
;

1154 
cÚfig
.
dbnum
 = 0;

1155 
cÚfig
.
auth
 = 
NULL
;

1156 
cÚfig
.
th»ads_couÁ
 = 1;

1157 
cÚfig
.
´ÙocŞ
 = 
TEST_CMD_PROTOCOL_REDIS
;

1158 
cÚfig
.
nošlše
 = 0;

1160 
i
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

1161 
¬gc
 -ğ
i
;

1162 
¬gv
 +ğ
i
;

1164 
cÚfig
.
Ï‹ncy
 = 
	`m®loc
(()*cÚfig.
»que¡s
);

1166 ià(
cÚfig
.
k“·live
 == 0) {

1167 
	`´štf
("WARNING: keepalive disabled, you…robably‚eed 'echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse' for Linux‡nd 'sudo sysctl -w‚et.inet.tcp.msl=1000' for Mac OS X in ordero use‡†ot of clients/requests\n");

1178 ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_REDIS
) {

1179 
	`‹¡_»dis
(
¬gc
, 
¬gv
);

1180 } ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_MEMCACHE
) {

1181 
	`‹¡_memÿched
(
¬gc
, 
¬gv
);

1183 
	`NOT_REACHED
();

1187 
	}
}

	@tests/vrt_benchmark.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<as£¹.h
>

9 
	~<sys/¡©.h
>

10 
	~<sys/ut¢ame.h
>

12 
	~<«.h
>

14 
	~<hœedis.h
>

15 
	~<sds.h
>

17 
	~<d¬¿y.h
>

18 
	~<dli¡.h
>

19 
	~<dut.h
>

20 
	~<dlog.h
>

22 
	~<v¹_ut.h
>

23 
	~<v¹_public.h
>

24 
	~<himemÿched.h
>

26 
	#TEST_CMD_PROTOCOL_REDIS
 0

	)

27 
	#TEST_CMD_PROTOCOL_MEMCACHE
 1

	)

29 
	#RANDPTR_INITIAL_SIZE
 8

	)

31 
	scÚfig
 {

32 cÚ¡ *
	mho¡
;

33 
	mho¡pÜt
;

34 cÚ¡ *
	mho¡sock‘
;

35 
	mnumş›Ás
;

36 
	mliveş›Ás
;

37 
	m»que¡s
;

38 
	m»que¡s_issued
;

39 
	m»que¡s_fšished
;

40 
	mkeysize
;

41 
	md©asize
;

42 
	m¿ndomkeys
;

43 
	m¿ndomkeys_key¥aûËn
;

44 
	mk“·live
;

45 
	mp–še
;

46 
	mshow”rÜs
;

47 
	m¡¬t
;

48 
	mtÙÏ‹ncy
;

49 *
	mÏ‹ncy
;

50 cÚ¡ *
	mt™Ë
;

51 
	mqu›t
;

52 
	mcsv
;

53 
	mloİ
;

54 
	midËmode
;

55 
	mdbnum
;

56 
sds
 
	mdbnum¡r
;

57 *
	m‹¡s
;

58 *
	mauth
;

59 
	mth»ads_couÁ
;

60 
	m´ÙocŞ
;

61 
	mnošlše
;

62 } 
	gcÚfig
;

64 
	sb’chm¬k_th»ad
 {

65 
	mid
;

66 
±h»ad_t
 
	mth»ad_id
;

68 
«Ev’tLoİ
 *
	m–
;

69 
	mhz
;

70 
	müÚloİs
;

72 
dli¡
 *
	mş›Ás
;

73 
	mnumş›Ás
;

74 
	mliveş›Ás
;

76 
	m»que¡s
;

77 
	m»que¡s_issued
;

78 
	m»que¡s_fšished
;

80 
	m¡¬t
;

81 
	mtÙÏ‹ncy
;

82 *
	mÏ‹ncy
;

83 } 
	tb’chm¬k_th»ad
;

85 
	s_b’chm¬k_ş›Á
 {

86 
b’chm¬k_th»ad
 *
	mbt
;

88 
»disCÚ‹xt
 *
	mrc
;

89 
mcCÚ‹xt
 *
	mmc
;

90 
sds
 
	mobuf
;

91 **
	m¿nd±r
;

92 
size_t
 
	m¿ndËn
;

93 
size_t
 
	m¿ndä“
;

94 
size_t
 
	mwr™‹n
;

95 
	m¡¬t
;

96 
	mÏ‹ncy
;

97 
	m³ndšg
;

98 
	m´efix_³ndšg
;

101 
	m´efixËn
;

102 } *
	tb’chm¬k_ş›Á
;

104 
d¬¿y
 *
	gbts
;

107 
wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

108 
b’chm¬k_ş›Á
 
ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, b’chm¬k_ş›Á 
äom
, 
b’chm¬k_th»ad
 *
th»ad
);

109 
ü—‹MissšgCl›Ás
(
b’chm¬k_ş›Á
 
c
);

110 
showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
);

112 
	$ä“Cl›Á
(
b’chm¬k_ş›Á
 
c
) {

113 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

114 
dli¡Node
 *
Ê
;

116 ià(
bt
->
–
) {

117 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
);

118 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
);

120 
	`»disF»e
(
c
->
rc
);

121 ià(
c
->
mc
) {

122 
c
->
mc
->
fd
 = -1;

123 
	`memÿchedF»e
(
c
->
mc
);

125 
	`sdsä“
(
c
->
obuf
);

126 
	`ä“
(
c
->
¿nd±r
);

127 
	`ä“
(
c
);

128 
	`upd©e_¡©e_sub
(
bt
->
liveş›Ás
,1);

129 
Ê
 = 
	`dli¡S—rchKey
(
bt
->
ş›Ás
,
c
);

130 
	`ASSERT
(
Ê
 !ğ
NULL
);

131 
	`dli¡D–Node
(
bt
->
ş›Ás
,
Ê
);

132 
	}
}

134 
	$ä“AÎCl›Ás
(
dli¡
 *
ş›Ás
) {

135 
dli¡Node
 *
Ê
 = 
ş›Ás
->
h—d
, *
Ãxt
;

137 
Ê
) {

138 
Ãxt
 = 
Ê
->next;

139 
	`ä“Cl›Á
(
Ê
->
v®ue
);

140 
Ê
 = 
Ãxt
;

142 
	}
}

144 
	$»£tCl›Á
(
b’chm¬k_ş›Á
 
c
) {

145 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

147 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
);

148 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
);

149 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

150 
c
->
wr™‹n
 = 0;

151 
c
->
³ndšg
 = 
cÚfig
.
p–še
;

152 
	}
}

154 
	$¿ndomizeCl›ÁKey
(
b’chm¬k_ş›Á
 
c
) {

155 
size_t
 
i
;

157 
i
 = 0; i < 
c
->
¿ndËn
; i++) {

158 *
p
 = 
c
->
¿nd±r
[
i
]+11;

159 
size_t
 
r
 = 
	`¿ndom
(è% 
cÚfig
.
¿ndomkeys_key¥aûËn
;

160 
size_t
 
j
;

162 
j
 = 0; j < 12; j++) {

163 *
p
 = '0'+
r
%10;

164 
r
/=10;

165 
p
--;

168 
	}
}

170 
	$ş›ÁDÚe
(
b’chm¬k_ş›Á
 
c
) {

171 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

172 
»que¡s_fšished
;

174 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&requests_finished);

175 ià(
»que¡s_fšished
 =ğ
bt
->
»que¡s
) {

176 
	`ä“Cl›Á
(
c
);

177 
	`«Stİ
(
bt
->
–
);

180 ià(
cÚfig
.
k“·live
) {

181 
	`»£tCl›Á
(
c
);

183 
	`upd©e_¡©e_sub
(
bt
->
liveş›Ás
,1);

184 
	`ü—‹MissšgCl›Ás
(
c
);

185 
	`upd©e_¡©e_add
(
bt
->
liveş›Ás
,1);

186 
	`ä“Cl›Á
(
c
);

188 
	}
}

190 
	$b’chm¬k_th»ad_š™
(
b’chm¬k_th»ad
 *
bt
, 
»que¡s
, 
numş›Ás
, *
cmd
, 
size_t
 
Ën
)

192 
b’chm¬k_ş›Á
 
c
;

194 
bt
->
th»ad_id
 = 0;

195 
bt
->
–
 = 
NULL
;

196 
bt
->
hz
 = 10;

197 
bt
->
üÚloİs
 = 0;

198 
bt
->
ş›Ás
 = 
NULL
;

199 
bt
->
numş›Ás
 =‚umclients;

200 
bt
->
liveş›Ás
 = 0;

201 
bt
->
»que¡s
 =„equests;

202 
bt
->
»que¡s_issued
 = 0;

203 
bt
->
»que¡s_fšished
 = 0;

204 
bt
->
¡¬t
 = 0;

205 
bt
->
tÙÏ‹ncy
 = 0;

206 
bt
->
Ï‹ncy
 = 
NULL
;

208 
bt
->
–
 = 
	`«C»©eEv’tLoİ
(1024*10);

209 ià(
bt
->
–
 =ğ
NULL
) {

210  
VRT_ERROR
;

213 
bt
->
ş›Ás
 = 
	`dli¡C»©e
();

214 ià(
bt
->
ş›Ás
 =ğ
NULL
) {

215  
VRT_ERROR
;

218 
bt
->
Ï‹ncy
 = 
	`m®loc
(()*bt->
»que¡s
);

220 
c
 = 
	`ü—‹Cl›Á
(
cmd
,
Ën
,
NULL
,
bt
);

221 
	`ü—‹MissšgCl›Ás
(
c
);

223 ià(
bt
->
id
 == 0) {

224 
	`«C»©eTimeEv’t
(
bt
->
–
,1,
showThroughput
,
NULL
,NULL);

227  
VRT_OK
;

228 
	}
}

230 
	$b’chm¬k_th»ad_deš™
(
b’chm¬k_th»ad
 *
bt
)

232 ià(
bt
->
ş›Ás
) {

233 
	`ä“AÎCl›Ás
(
bt
->
ş›Ás
);

234 
	`dli¡R–—£
(
bt
->
ş›Ás
);

235 
bt
->
ş›Ás
 = 
NULL
;

238 ià(
bt
->
–
) {

239 
	`«D–‘eEv’tLoİ
(
bt
->
–
);

240 
bt
->
–
 = 
NULL
;

243 ià(
bt
->
Ï‹ncy
) {

244 
	`ä“
(
bt
->
Ï‹ncy
);

245 
bt
->
Ï‹ncy
 = 
NULL
;

247 
	}
}

249 *
	$b’chm¬k_th»ad_run
(*
¬gs
)

251 
b’chm¬k_th»ad
 *
bt
 = 
¬gs
;

252 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

254 
	`«Maš
(
bt
->
–
);

256  
NULL
;

257 
	}
}

259 
	$¡¬t_b’chm¬k_th»ads_uÁ_fšish
()

261 
i
;

262 
b’chm¬k_th»ad
 *
bt
;

264 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

265 
±h»ad_©Œ_t
 
©Œ
;

266 
	`±h»ad_©Œ_š™
(&
©Œ
);

267 
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

268 
	`±h»ad_ü—‹
(&
bt
->
th»ad_id
,

269 &
©Œ
, 
b’chm¬k_th»ad_run
, 
bt
);

272 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

273 
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

274 
	`±h»ad_još
(
bt
->
th»ad_id
, 
NULL
);

277  
VRT_OK
;

278 
	}
}

280 
	$»adHªdËrMC
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

281 
b’chm¬k_ş›Á
 
c
 = 
´ivd©a
;

282 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

283 
mcCÚ‹xt
 *
mc
 = 
c
->mc;

284 
»que¡s_fšished
;

285 *
»¶y
 = 
NULL
;

286 
	`UNUSED
(
–
);

287 
	`UNUSED
(
fd
);

288 
	`UNUSED
(
mask
);

293 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`du£c_now
()-(c->
¡¬t
);

295 ià(
	`memÿchedBufãrR—d
(
mc
è!ğ
MC_OK
) {

296 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
mc
->
”r¡r
);

297 
	`ex™
(1);

299 
c
->
³ndšg
) {

300 ià(
	`memÿchedG‘R•ly
(
mc
,&
»¶y
è!ğ
MC_OK
) {

301 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
mc
->
”r¡r
);

302 
	`ex™
(1);

305 ià(
»¶y
 !ğ
NULL
) {

306 ià(
»¶y
 =ğ(*)
MC_REPLY_ERROR
) {

307 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

308 
	`ex™
(1);

311 ià(
cÚfig
.
show”rÜs
) {

312 
time_t
 
Ï¡”r_time
 = 0;

313 
time_t
 
now
 = 
	`time
(
NULL
);

314 
mcR•ly
 *
r
 = 
»¶y
;

315 ià(
r
->
ty³
 =ğ
MC_REPLY_ERROR
 && 
Ï¡”r_time
 !ğ
now
) {

316 
Ï¡”r_time
 = 
now
;

317 
	`´štf
("E¼Ü from s”v”: %s\n", 
r
->
¡r
);

321 
	`ä“McR•lyObjeù
(
»¶y
);

323 ià(
c
->
´efix_³ndšg
 > 0) {

324 
c
->
´efix_³ndšg
--;

325 
c
->
³ndšg
--;

327 ià(
c
->
´efixËn
 > 0) {

328 
size_t
 
j
;

329 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

332 
j
 = 0; j < 
c
->
¿ndËn
; j++)

333 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

334 
c
->
´efixËn
 = 0;

339 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&requests_finished);

340 ià(
»que¡s_fšished
 < 
bt
->
»que¡s
) {

341 
bt
->
Ï‹ncy
[
»que¡s_fšished
] = 
c
->latency;

342 
	`upd©e_¡©e_add
(
bt
->
»que¡s_fšished
,1);

344 
c
->
³ndšg
--;

345 ià(
c
->
³ndšg
 == 0) {

346 
	`ş›ÁDÚe
(
c
);

354 
	}
}

356 
	$»adHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

357 
b’chm¬k_ş›Á
 
c
 = 
´ivd©a
;

358 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

359 
»que¡s_fšished
;

360 *
»¶y
 = 
NULL
;

361 
	`UNUSED
(
–
);

362 
	`UNUSED
(
fd
);

363 
	`UNUSED
(
mask
);

368 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`du£c_now
()-(c->
¡¬t
);

370 ià(
	`»disBufãrR—d
(
c
->
rc
è!ğ
REDIS_OK
) {

371 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
rc
->
”r¡r
);

372 
	`ex™
(1);

374 
c
->
³ndšg
) {

375 ià(
	`»disG‘R•ly
(
c
->
rc
,&
»¶y
è!ğ
REDIS_OK
) {

376 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
rc
->
”r¡r
);

377 
	`ex™
(1);

379 ià(
»¶y
 !ğ
NULL
) {

380 ià(
»¶y
 =ğ(*)
REDIS_REPLY_ERROR
) {

381 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

382 
	`ex™
(1);

385 ià(
cÚfig
.
show”rÜs
) {

386 
time_t
 
Ï¡”r_time
 = 0;

387 
time_t
 
now
 = 
	`time
(
NULL
);

388 
»disR•ly
 *
r
 = 
»¶y
;

389 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
 && 
Ï¡”r_time
 !ğ
now
) {

390 
Ï¡”r_time
 = 
now
;

391 
	`´štf
("E¼Ü from s”v”: %s\n", 
r
->
¡r
);

395 
	`ä“R•lyObjeù
(
»¶y
);

397 ià(
c
->
´efix_³ndšg
 > 0) {

398 
c
->
´efix_³ndšg
--;

399 
c
->
³ndšg
--;

401 ià(
c
->
´efixËn
 > 0) {

402 
size_t
 
j
;

403 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

406 
j
 = 0; j < 
c
->
¿ndËn
; j++)

407 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

408 
c
->
´efixËn
 = 0;

413 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&requests_finished);

414 ià(
»que¡s_fšished
 < 
bt
->
»que¡s
) {

415 
bt
->
Ï‹ncy
[
»que¡s_fšished
] = 
c
->latency;

416 
	`upd©e_¡©e_add
(
bt
->
»que¡s_fšished
,1);

418 
c
->
³ndšg
--;

419 ià(
c
->
³ndšg
 == 0) {

420 
	`ş›ÁDÚe
(
c
);

428 
	}
}

430 
	$wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

431 
b’chm¬k_ş›Á
 
c
 = 
´ivd©a
;

432 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

433 
	`UNUSED
(
–
);

434 
	`UNUSED
(
fd
);

435 
	`UNUSED
(
mask
);

438 ià(
c
->
wr™‹n
 == 0) {

440 ià(
bt
->
»que¡s_issued
++ >ğbt->
»que¡s
) {

441 
	`ä“Cl›Á
(
c
);

446 ià(
cÚfig
.
¿ndomkeys
è
	`¿ndomizeCl›ÁKey
(
c
);

447 
c
->
¡¬t
 = 
	`du£c_now
();

448 
c
->
Ï‹ncy
 = -1;

451 ià(
	`sd¦’
(
c
->
obuf
è> c->
wr™‹n
) {

452 *
±r
 = 
c
->
obuf
+c->
wr™‹n
;

453 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
c
->
rc
->
fd
,
±r
,
	`sd¦’
(c->
obuf
)-c->
wr™‹n
);

455 ià(
nwr™‹n
 == -1) {

456 ià(
”ºo
 !ğ
EPIPE
)

457 
	`årštf
(
¡d”r
, "Wr™šgØsock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

458 
	`ä“Cl›Á
(
c
);

461 
c
->
wr™‹n
 +ğ
nwr™‹n
;

462 ià(
	`sd¦’
(
c
->
obuf
è=ğc->
wr™‹n
) {

463 
	`«D–‘eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
);

464 ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_REDIS
) {

465 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
,
»adHªdËr
,c);

466 } ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_MEMCACHE
) {

467 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_READABLE
,
»adHªdËrMC
,c);

469 
	`NOT_REACHED
();

473 
	}
}

496 
b’chm¬k_ş›Á
 
	$ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, 
b’chm¬k_ş›Á
 
äom
, 
b’chm¬k_th»ad
 *
th»ad
) {

497 
j
;

498 
b’chm¬k_th»ad
 *
bt
;

499 
b’chm¬k_ş›Á
 
c
 = 
	`m®loc
((
_b’chm¬k_ş›Á
));

501 
c
->
bt
 = 
NULL
;

502 
c
->
rc
 = 
NULL
;

503 
c
->
mc
 = 
NULL
;

504 
c
->
obuf
 = 
NULL
;

505 
c
->
¿nd±r
 = 
NULL
;

506 
c
->
¿ndËn
 = 0;

507 
c
->
¿ndä“
 = 0;

508 
c
->
wr™‹n
 = 0;

509 
c
->
¡¬t
 = 0;

510 
c
->
Ï‹ncy
 = 0;

511 
c
->
³ndšg
 = 0;

512 
c
->
´efix_³ndšg
 = 0;

513 
c
->
´efixËn
 = 0;

515 ià(
äom
 =ğ
NULL
) {

516 
	`ASSERT
(
th»ad
 !ğ
NULL
);

517 
bt
 = 
th»ad
;

519 
bt
 = 
äom
->bt;

522 
c
->
bt
 = bt;

524 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

525 
c
->
rc
 = 
	`»disCÚÃùNÚBlock
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

527 
c
->
rc
 = 
	`»disCÚÃùUnixNÚBlock
(
cÚfig
.
ho¡sock‘
);

529 ià(
c
->
rc
->
”r
) {

530 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

531 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

532 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
c
->
rc
->
”r¡r
);

534 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
c
->
rc
->
”r¡r
);

535 
	`ex™
(1);

538 
c
->
rc
->
»ad”
->
maxbuf
 = 0;

543 
c
->
obuf
 = 
	`sd£m±y
();

547 
c
->
´efix_³ndšg
 = 0;

548 ià(
cÚfig
.
auth
) {

549 *
buf
 = 
NULL
;

550 
Ën
 = 
	`»disFÜm©Commªd
(&
buf
, "AUTH %s", 
cÚfig
.
auth
);

551 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf, 
buf
, 
Ën
);

552 
	`ä“
(
buf
);

553 
c
->
´efix_³ndšg
++;

560 ià(
cÚfig
.
dbnum
 != 0) {

561 
c
->
obuf
 = 
	`sdsÿrštf
(c->obuf,"*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n",

562 ()
	`sd¦’
(
cÚfig
.
dbnum¡r
),config.dbnumstr);

563 
c
->
´efix_³ndšg
++;

565 
c
->
´efixËn
 = 
	`sd¦’
(c->
obuf
);

567 ià(
äom
) {

568 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,

569 
äom
->
obuf
+äom->
´efixËn
,

570 
	`sd¦’
(
äom
->
obuf
)-äom->
´efixËn
);

572 
j
 = 0; j < 
cÚfig
.
p–še
; j++)

573 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,
cmd
,
Ën
);

576 
c
->
wr™‹n
 = 0;

577 
c
->
³ndšg
 = 
cÚfig
.
p–še
+c->
´efix_³ndšg
;

578 
c
->
¿nd±r
 = 
NULL
;

579 
c
->
¿ndËn
 = 0;

582 ià(
cÚfig
.
¿ndomkeys
) {

583 ià(
äom
) {

584 
c
->
¿ndËn
 = 
äom
->randlen;

585 
c
->
¿ndä“
 = 0;

586 
c
->
¿nd±r
 = 
	`m®loc
((*)*c->
¿ndËn
);

588 
j
 = 0; j < ()
c
->
¿ndËn
; j++) {

589 
c
->
¿nd±r
[
j
] = c->
obuf
 + (
äom
->randptr[j]-from->obuf);

591 
c
->
¿nd±r
[
j
] +ğc->
´efixËn
 - 
äom
->prefixlen;

594 *
p
 = 
c
->
obuf
;

596 
c
->
¿ndËn
 = 0;

597 
c
->
¿ndä“
 = 
RANDPTR_INITIAL_SIZE
;

598 
c
->
¿nd±r
 = 
	`m®loc
((*)*c->
¿ndä“
);

599 (
p
 = 
	`¡r¡r
Õ,"__¿nd_št__")è!ğ
NULL
) {

600 ià(
c
->
¿ndä“
 == 0) {

601 
c
->
¿nd±r
 = 
	`»®loc
(c->¿nd±r,(*)*c->
¿ndËn
*2);

602 
c
->
¿ndä“
 +ğc->
¿ndËn
;

604 
c
->
¿nd±r
[c->
¿ndËn
++] = 
p
;

605 
c
->
¿ndä“
--;

606 
p
 += 12;

610 ià(
cÚfig
.
idËmode
 == 0)

611 
	`«C»©eFeEv’t
(
bt
->
–
,
c
->
rc
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

614 ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_MEMCACHE
) {

615 
c
->
mc
 = 
	`memÿchedCÚ‹xtIn™
();

616 
c
->
mc
->
fd
 = c->
rc
->fd;

617 
c
->
mc
->
æags
 &ğ~
MC_BLOCK
;

620 
	`dli¡AddNodeTa
(
bt
->
ş›Ás
,
c
);

621 
	`upd©e_¡©e_add
(
bt
->
liveş›Ás
,1);

623  
c
;

624 
	}
}

626 
	$ü—‹MissšgCl›Ás
(
b’chm¬k_ş›Á
 
c
) {

627 
n
 = 0;

628 
b’chm¬k_th»ad
 *
bt
 = 
c
->bt;

629 
liveş›Ás
;

631 
	`upd©e_¡©e_g‘
(
bt
->
liveş›Ás
,&liveclients);

633 
liveş›Ás
 < 
bt
->
numş›Ás
) {

634 
	`ü—‹Cl›Á
(
NULL
,0,
c
,NULL);

637 ià(++
n
 > 64) {

638 
	`u¦“p
(50000);

639 
n
 = 0;

641 
	`upd©e_¡©e_g‘
(
bt
->
liveş›Ás
,&liveclients);

643 
	}
}

645 
	$com·»L©’cy
(cÚ¡ *
a
, cÚ¡ *
b
) {

646  (*(*)
a
)-(*(*)
b
);

647 
	}
}

649 
	$upd©eB’chm¬kSts
()

651 
i
;

652 
couÁ
;

654 
cÚfig
.
liveş›Ás
 = 0;

655 
cÚfig
.
»que¡s_fšished
 = 0;

657 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

658 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

659 
	`upd©e_¡©e_g‘
(
bt
->
liveş›Ás
,&
couÁ
);

660 
cÚfig
.
liveş›Ás
 +ğ
couÁ
;

661 
	`upd©e_¡©e_g‘
(
bt
->
»que¡s_fšished
,&
couÁ
);

662 
cÚfig
.
»que¡s_fšished
 +ğ
couÁ
;

664 
	}
}

666 
	$showL©’cyR•Üt
() {

667 
i
, 
j
, 
cu¾©
 = 0;

668 
n
 = 0;

669 
³rc
, 
»q³r£c
;

671 
	`upd©eB’chm¬kSts
();

673 
»q³r£c
 = ()
cÚfig
.
»que¡s_fšished
/(()cÚfig.
tÙÏ‹ncy
/1000);

674 ià(!
cÚfig
.
qu›t
 && !cÚfig.
csv
) {

675 
	`´štf
("=====ğ% ======\n", 
cÚfig
.
t™Ë
);

676 
	`´štf
(" %d„eque¡ com¶‘ed iÀ%.2à£cÚds\n", 
cÚfig
.
»que¡s_fšished
,

677 ()
cÚfig
.
tÙÏ‹ncy
/1000);

678 
	`´štf
(" %d…¬®ËÈş›Ás\n", 
cÚfig
.
numş›Ás
);

679 
	`´štf
(" %d by‹ ·ylßd\n", 
cÚfig
.
d©asize
);

680 
	`´štf
(" k“°®ive: %d\n", 
cÚfig
.
k“·live
);

681 
	`´štf
("\n");

683 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i++) {

684 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_g‘
(
bts
, 
i
);

685 
j
 = 0; j < 
bt
->
»que¡s
; j ++) {

686 
cÚfig
.
Ï‹ncy
[
n
++] = 
bt
->Ï‹ncy[
j
];

690 
	`qsÜt
(
cÚfig
.
Ï‹ncy
,cÚfig.
»que¡s
,(),
com·»L©’cy
);

691 
i
 = 0; i < 
cÚfig
.
»que¡s
; i++) {

692 ià(
cÚfig
.
Ï‹ncy
[
i
]/1000 !ğ
cu¾©
 || i =ğ(cÚfig.
»que¡s
-1)) {

693 
cu¾©
 = 
cÚfig
.
Ï‹ncy
[
i
]/1000;

694 
³rc
 = (()(
i
+1)*100)/
cÚfig
.
»que¡s
;

695 
	`´štf
("%.2f%% <ğ%d mli£cÚds\n", 
³rc
, 
cu¾©
);

698 
	`´štf
("%.2à»que¡ ³¸£cÚd\n\n", 
»q³r£c
);

699 } ià(
cÚfig
.
csv
) {

700 
	`´štf
("\"%s\",\"%.2f\"\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

702 
	`´štf
("%s: %.2à»que¡ ³¸£cÚd\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

704 
	}
}

706 
	$b’chm¬k
(*
t™Ë
, *
cmd
, 
Ën
) {

707 
i
;

708 
»que¡s_³r_th»ad
, 
»que¡s_»mašd”
;

709 
ş›Ás_³r_th»ad
, 
ş›Ás_»mašd”
;

710 
b’chm¬k_ş›Á
 
c
;

712 
cÚfig
.
t™Ë
 =itle;

713 
cÚfig
.
»que¡s_issued
 = 0;

714 
cÚfig
.
»que¡s_fšished
 = 0;

717 ià(
cÚfig
.
th»ads_couÁ
 <= 0) {

718 
	`´štf
("ERROR:hreads count‚eed biggerhan zero\n");

720 
bts
 = 
	`d¬¿y_ü—‹
(
cÚfig
.
th»ads_couÁ
, (
b’chm¬k_th»ad
));

721 
»que¡s_³r_th»ad
 = 
cÚfig
.
»que¡s
/cÚfig.
th»ads_couÁ
;

722 
»que¡s_»mašd”
 = 
cÚfig
.
»que¡s
%cÚfig.
th»ads_couÁ
;

723 
ş›Ás_³r_th»ad
 = 
cÚfig
.
numş›Ás
/cÚfig.
th»ads_couÁ
;

724 
ş›Ás_»mašd”
 = 
cÚfig
.
numş›Ás
%cÚfig.
th»ads_couÁ
;

725 
i
 = 0; i < 
cÚfig
.
th»ads_couÁ
; i ++) {

726 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_push
(
bts
);

727 
bt
->
id
 = 
i
;

728 
	`b’chm¬k_th»ad_š™
(
bt
,

729 
»que¡s_»mašd”
-->0?
»que¡s_³r_th»ad
+1:requests_per_thread,

730 
ş›Ás_»mašd”
-->0?
ş›Ás_³r_th»ad
+1:clients_per_thread,

731 
cmd
,
Ën
);

734 
cÚfig
.
¡¬t
 = 
	`dm£c_now
();

735 
	`¡¬t_b’chm¬k_th»ads_uÁ_fšish
();

736 
cÚfig
.
tÙÏ‹ncy
 = 
	`dm£c_now
()-cÚfig.
¡¬t
;

738 
	`showL©’cyR•Üt
();

740 
	`d¬¿y_n
(
bts
) > 0) {

741 
b’chm¬k_th»ad
 *
bt
 = 
	`d¬¿y_pİ
(
bts
);

742 
	`b’chm¬k_th»ad_deš™
(
bt
);

744 
	`d¬¿y_de¡roy
(
bts
);

745 
bts
 = 
NULL
;

746 
	}
}

749 
	$·r£O±iÚs
(
¬gc
, cÚ¡ **
¬gv
) {

750 
i
;

751 
Ï¡¬g
;

752 
ex™_¡©us
 = 1;

754 
i
 = 1; i < 
¬gc
; i++) {

755 
Ï¡¬g
 = (
i
 =ğ(
¬gc
-1));

757 ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

758 ià(
Ï¡¬g
è
šv®id
;

759 
cÚfig
.
numş›Ás
 = 
	`©oi
(
¬gv
[++
i
]);

760 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n")) {

761 ià(
Ï¡¬g
è
šv®id
;

762 
cÚfig
.
»que¡s
 = 
	`©oi
(
¬gv
[++
i
]);

763 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-k")) {

764 ià(
Ï¡¬g
è
šv®id
;

765 
cÚfig
.
k“·live
 = 
	`©oi
(
¬gv
[++
i
]);

766 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h")) {

767 ià(
Ï¡¬g
è
šv®id
;

768 
cÚfig
.
ho¡
 = 
	`¡rdup
(
¬gv
[++
i
]);

769 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p")) {

770 ià(
Ï¡¬g
è
šv®id
;

771 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

772 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s")) {

773 ià(
Ï¡¬g
è
šv®id
;

774 
cÚfig
.
ho¡sock‘
 = 
	`¡rdup
(
¬gv
[++
i
]);

775 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a") ) {

776 ià(
Ï¡¬g
è
šv®id
;

777 
cÚfig
.
auth
 = 
	`¡rdup
(
¬gv
[++
i
]);

778 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d")) {

779 ià(
Ï¡¬g
è
šv®id
;

780 
cÚfig
.
d©asize
 = 
	`©oi
(
¬gv
[++
i
]);

781 ià(
cÚfig
.
d©asize
 < 1) config.datasize=1;

782 ià(
cÚfig
.
d©asize
 > 1024*1024*1024) config.datasize = 1024*1024*1024;

783 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-P")) {

784 ià(
Ï¡¬g
è
šv®id
;

785 
cÚfig
.
p–še
 = 
	`©oi
(
¬gv
[++
i
]);

786 ià(
cÚfig
.
p–še
 <= 0) config.pipeline=1;

787 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r")) {

788 ià(
Ï¡¬g
è
šv®id
;

789 
cÚfig
.
¿ndomkeys
 = 1;

790 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 
	`©oi
(
¬gv
[++
i
]);

791 ià(
cÚfig
.
¿ndomkeys_key¥aûËn
 < 0)

792 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

793 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-q")) {

794 
cÚfig
.
qu›t
 = 1;

795 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

796 
cÚfig
.
csv
 = 1;

797 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-l")) {

798 
cÚfig
.
loİ
 = 1;

799 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-I")) {

800 
cÚfig
.
idËmode
 = 1;

801 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-e")) {

802 
cÚfig
.
show”rÜs
 = 1;

803 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-t")) {

804 ià(
Ï¡¬g
è
šv®id
;

810 
cÚfig
.
‹¡s
 = 
	`sd¢ew
(",");

811 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(cÚfig.‹¡s,(*)
¬gv
[++
i
]);

812 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(config.tests,",");

813 
	`sd¡Şow”
(
cÚfig
.
‹¡s
);

814 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--dbnum")) {

815 ià(
Ï¡¬g
è
šv®id
;

816 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

817 
cÚfig
.
dbnum¡r
 = 
	`sdsäomlÚglÚg
(cÚfig.
dbnum
);

818 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-T")) {

819 ià(
Ï¡¬g
è
šv®id
;

820 
cÚfig
.
th»ads_couÁ
 = 
	`©oi
(
¬gv
[++
i
]);

821 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-m")) {

822 
cÚfig
.
´ÙocŞ
 = 
TEST_CMD_PROTOCOL_MEMCACHE
;

823 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--noinline")) {

824 
cÚfig
.
nošlše
 = 1;

825 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

826 
ex™_¡©us
 = 0;

827 
u§ge
;

832 ià(
¬gv
[
i
][0] =ğ'-'è
šv®id
;

833  
i
;

837  
i
;

839 
šv®id
:

840 
	`´štf
("Inv®id o±iÚ \"%s\" o¸İtiÚ‡rgum’ˆmissšg\n\n",
¬gv
[
i
]);

842 
u§ge
:

843 
	`´štf
(

888 
	`ex™
(
ex™_¡©us
);

889 
	}
}

891 
	$showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

892 
	`UNUSED
(
ev’tLoİ
);

893 
	`UNUSED
(
id
);

894 
	`UNUSED
(
ş›ÁD©a
);

896 
	`upd©eB’chm¬kSts
();

898 ià(
cÚfig
.
liveş›Ás
 == 0) {

899 
	`årštf
(
¡d”r
,"All clients disconnected...‡borting.\n");

900 
	`ex™
(1);

902 ià(
cÚfig
.
csv
)  250;

903 ià(
cÚfig
.
idËmode
 == 1) {

904 
	`´štf
("ş›Ás: %d\r", 
cÚfig
.
liveş›Ás
);

905 
	`fæush
(
¡dout
);

908 
dt
 = ()(
	`dm£c_now
()-
cÚfig
.
¡¬t
)/1000.0;

909 
½s
 = ()
cÚfig
.
»que¡s_fšished
/
dt
;

910 
	`´štf
("%s: %.2f\r", 
cÚfig
.
t™Ë
, 
½s
);

911 
	`fæush
(
¡dout
);

913 
	}
}

917 
	$‹¡_is_£Ëùed
(*
Çme
) {

918 
buf
[256];

919 
l
 = 
	`¡¾’
(
Çme
);

921 ià(
cÚfig
.
‹¡s
 =ğ
NULL
)  1;

922 
buf
[0] = ',';

923 
	`memıy
(
buf
+1,
Çme
,
l
);

924 
buf
[
l
+1] = ',';

925 
buf
[
l
+2] = '\0';

926  
	`¡r¡r
(
cÚfig
.
‹¡s
,
buf
è!ğ
NULL
;

927 
	}
}

929 
	$‹¡_»dis
(
¬gc
, cÚ¡ **
¬gv
)

931 
i
;

932 *
d©a
, *
cmd
;

933 
Ën
;

936 ià(
¬gc
) {

937 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

938 
i
 = 1; i < 
¬gc
; i++) {

939 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

940 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

944 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

945 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

946 
	`ä“
(
cmd
);

947 } 
cÚfig
.
loİ
);

953 
d©a
 = 
	`m®loc
(
cÚfig
.
d©asize
+1);

955 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

956 
d©a
[
cÚfig
.
d©asize
] = '\0';

958 ià(!
cÚfig
.
nošlše
 && (
	`‹¡_is_£Ëùed
("ping_inline") ||est_is_selected("ping")))

959 
	`b’chm¬k
("PING_INLINE","PING\r\n",6);

961 ià(
	`‹¡_is_£Ëùed
("ping_mbulk") ||est_is_selected("ping")) {

962 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"PING");

963 
	`b’chm¬k
("PING_BULK",
cmd
,
Ën
);

964 
	`ä“
(
cmd
);

967 ià(
	`‹¡_is_£Ëùed
("set")) {

968 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET key:__¿nd_št__ %s",
d©a
);

969 
	`b’chm¬k
("SET",
cmd
,
Ën
);

970 
	`ä“
(
cmd
);

973 ià(
	`‹¡_is_£Ëùed
("get")) {

974 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"GET key:__rand_int__");

975 
	`b’chm¬k
("GET",
cmd
,
Ën
);

976 
	`ä“
(
cmd
);

979 ià(
	`‹¡_is_£Ëùed
("incr")) {

980 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"INCR counter:__rand_int__");

981 
	`b’chm¬k
("INCR",
cmd
,
Ën
);

982 
	`ä“
(
cmd
);

985 ià(
	`‹¡_is_£Ëùed
("lpush")) {

986 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

987 
	`b’chm¬k
("LPUSH",
cmd
,
Ën
);

988 
	`ä“
(
cmd
);

991 ià(
	`‹¡_is_£Ëùed
("rpush")) {

992 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPUSH myli¡ %s",
d©a
);

993 
	`b’chm¬k
("RPUSH",
cmd
,
Ën
);

994 
	`ä“
(
cmd
);

997 ià(
	`‹¡_is_£Ëùed
("lpop")) {

998 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPOP mylist");

999 
	`b’chm¬k
("LPOP",
cmd
,
Ën
);

1000 
	`ä“
(
cmd
);

1003 ià(
	`‹¡_is_£Ëùed
("rpop")) {

1004 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPOP mylist");

1005 
	`b’chm¬k
("RPOP",
cmd
,
Ën
);

1006 
	`ä“
(
cmd
);

1009 ià(
	`‹¡_is_£Ëùed
("sadd")) {

1010 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,

1012 
	`b’chm¬k
("SADD",
cmd
,
Ën
);

1013 
	`ä“
(
cmd
);

1016 ià(
	`‹¡_is_£Ëùed
("spop")) {

1017 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SPOP myset");

1018 
	`b’chm¬k
("SPOP",
cmd
,
Ën
);

1019 
	`ä“
(
cmd
);

1022 ià(
	`‹¡_is_£Ëùed
("lrange") ||

1023 
	`‹¡_is_£Ëùed
("lrange_100") ||

1024 
	`‹¡_is_£Ëùed
("lrange_300") ||

1025 
	`‹¡_is_£Ëùed
("lrange_500") ||

1026 
	`‹¡_is_£Ëùed
("lrange_600"))

1028 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

1029 
	`b’chm¬k
("LPUSH (ÃededØb’chm¬k LRANGE)",
cmd
,
Ën
);

1030 
	`ä“
(
cmd
);

1033 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_100")) {

1034 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 99");

1035 
	`b’chm¬k
("LRANGE_100 (fœ¡ 100ƒËm’ts)",
cmd
,
Ën
);

1036 
	`ä“
(
cmd
);

1039 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_300")) {

1040 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 299");

1041 
	`b’chm¬k
("LRANGE_300 (fœ¡ 300ƒËm’ts)",
cmd
,
Ën
);

1042 
	`ä“
(
cmd
);

1045 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_500")) {

1046 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 449");

1047 
	`b’chm¬k
("LRANGE_500 (fœ¡ 450ƒËm’ts)",
cmd
,
Ën
);

1048 
	`ä“
(
cmd
);

1051 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_600")) {

1052 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 599");

1053 
	`b’chm¬k
("LRANGE_600 (fœ¡ 600ƒËm’ts)",
cmd
,
Ën
);

1054 
	`ä“
(
cmd
);

1057 ià(
	`‹¡_is_£Ëùed
("mset")) {

1058 cÚ¡ *
¬gv
[21];

1059 
¬gv
[0] = "MSET";

1060 
i
 = 1; i < 21; i += 2) {

1061 
¬gv
[
i
] = "key:__rand_int__";

1062 
¬gv
[
i
+1] = 
d©a
;

1064 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,21,
¬gv
,
NULL
);

1065 
	`b’chm¬k
("MSET (10 keys)",
cmd
,
Ën
);

1066 
	`ä“
(
cmd
);

1069 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

1070 } 
cÚfig
.
loİ
);

1072  
VRT_OK
;

1073 
	}
}

1075 
	$‹¡_memÿched
(
¬gc
, cÚ¡ **
¬gv
)

1077 
i
;

1078 *
d©a
, *
cmd
;

1079 
Ën
;

1082 ià(
¬gc
) {

1083 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

1084 
i
 = 1; i < 
¬gc
; i++) {

1085 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

1086 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

1090 
Ën
 = 
	`memÿchedFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

1091 ià(
Ën
 < 0) {

1095 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

1096 
	`ä“
(
cmd
);

1097 } 
cÚfig
.
loİ
);

1103 
d©a
 = 
	`m®loc
(
cÚfig
.
d©asize
+1);

1105 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

1106 
d©a
[
cÚfig
.
d©asize
] = '\0';

1108 ià(
	`‹¡_is_£Ëùed
("set")) {

1109 
Ën
 = 
	`memÿchedFÜm©Commªd
(&
cmd
,"£ˆkey:__¿nd_št__ 0 0 %d %s", 
cÚfig
.
d©asize
, 
d©a
);

1111 
	`b’chm¬k
("SET",
cmd
,
Ën
);

1112 
	`ä“
(
cmd
);

1115 ià(
	`‹¡_is_£Ëùed
("get")) {

1116 
Ën
 = 
	`memÿchedFÜm©Commªd
(&
cmd
,"get key:__rand_int__");

1117 
	`b’chm¬k
("GET",
cmd
,
Ën
);

1118 
	`ä“
(
cmd
);

1121 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

1122 } 
cÚfig
.
loİ
);

1124  
VRT_OK
;

1125 
	}
}

1127 
	$maš
(
¬gc
, cÚ¡ **
¬gv
) {

1128 
i
;

1130 
b’chm¬k_ş›Á
 
c
;

1132 
	`¤ªdom
(
	`time
(
NULL
));

1133 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

1134 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

1136 
cÚfig
.
numş›Ás
 = 50;

1137 
cÚfig
.
»que¡s
 = 100000;

1138 
cÚfig
.
liveş›Ás
 = 0;

1139 
cÚfig
.
k“·live
 = 1;

1140 
cÚfig
.
d©asize
 = 3;

1141 
cÚfig
.
p–še
 = 1;

1142 
cÚfig
.
show”rÜs
 = 0;

1143 
cÚfig
.
¿ndomkeys
 = 0;

1144 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

1145 
cÚfig
.
qu›t
 = 0;

1146 
cÚfig
.
csv
 = 0;

1147 
cÚfig
.
loİ
 = 0;

1148 
cÚfig
.
idËmode
 = 0;

1149 
cÚfig
.
Ï‹ncy
 = 
NULL
;

1150 
cÚfig
.
ho¡
 = "127.0.0.1";

1151 
cÚfig
.
ho¡pÜt
 = 6379;

1152 
cÚfig
.
ho¡sock‘
 = 
NULL
;

1153 
cÚfig
.
‹¡s
 = 
NULL
;

1154 
cÚfig
.
dbnum
 = 0;

1155 
cÚfig
.
auth
 = 
NULL
;

1156 
cÚfig
.
th»ads_couÁ
 = 1;

1157 
cÚfig
.
´ÙocŞ
 = 
TEST_CMD_PROTOCOL_REDIS
;

1158 
cÚfig
.
nošlše
 = 0;

1160 
i
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

1161 
¬gc
 -ğ
i
;

1162 
¬gv
 +ğ
i
;

1164 
cÚfig
.
Ï‹ncy
 = 
	`m®loc
(()*cÚfig.
»que¡s
);

1166 ià(
cÚfig
.
k“·live
 == 0) {

1167 
	`´štf
("WARNING: keepalive disabled, you…robably‚eed 'echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse' for Linux‡nd 'sudo sysctl -w‚et.inet.tcp.msl=1000' for Mac OS X in ordero use‡†ot of clients/requests\n");

1178 ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_REDIS
) {

1179 
	`‹¡_»dis
(
¬gc
, 
¬gv
);

1180 } ià(
cÚfig
.
´ÙocŞ
 =ğ
TEST_CMD_PROTOCOL_MEMCACHE
) {

1181 
	`‹¡_memÿched
(
¬gc
, 
¬gv
);

1183 
	`NOT_REACHED
();

1187 
	}
}

	@tests/vrt_check_data.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<±h»ad.h
>

9 
	~<sys/¡©.h
>

10 
	~<sys/ut¢ame.h
>

12 
	~<hœedis.h
>

13 
	~<async.h
>

14 
	~<ad­‹rs/«.h
>

16 
	~<dhashk™.h
>

17 
	~<dli¡.h
>

18 
	~<dmtqueue.h
>

19 
	~<dlog.h
>

21 
	~<v¹_ut.h
>

22 
	~<v¹_public.h
>

23 
	~<v¿b‹¡.h
>

24 
	~<v¹_´oduû_d©a.h
>

25 
	~<v¹_di¥©ch_d©a.h
>

26 
	~<v¹_back’d.h
>

27 
	~<v¹_check_d©a.h
>

29 
	#CHECK_DATA_FLAG_NONE
 (1<<0)

	)

30 
	#CHECK_DATA_FLAG_MASTER
 (1<<1)

	)

31 
	#CHECK_DATA_FLAG_SLAVE
 (1<<2)

	)

33 
	#CHECK_UNIT_STATE_NULL
 0

	)

34 
	#CHECK_UNIT_STATE_GET_EXPIRE
 1

	)

35 
	#CHECK_UNIT_STATE_GET_TYPE
 2

	)

36 
	#CHECK_UNIT_STATE_GET_VALUE
 3

	)

38 
	scheck_d©a_th»ad
 {

39 
	mid
;

40 
±h»ad_t
 
	mth»ad_id
;

42 
«Ev’tLoİ
 *
	m–
;

43 
	mhz
;

44 
	müÚloİs
;

46 
d¬¿y
 *
	mabgs
;

47 
	msÿn_group_idx
;

48 
d¬¿y
 *
	msÿn_£rv”s
;

49 
	msÿn_fšished_couÁ
;

50 
	mcursÜ
;

51 
dli¡
 *
	mcheck_un™s
;

53 
	mcheck_begš_time
;

54 
	msÿn_keys_couÁ
;

55 } 
	tcheck_d©a_th»ad
;

57 
	scheck_un™
 {

58 
check_d©a_th»ad
 *
	mcdt
;

60 
dli¡Node
 *
	mÊode
;

62 
sds
 
	mkey
;

64 
	mkey_³rsi¡
;

65 
	mmš_‰l
, 
	mmax_‰l_g­
;

67 
	mkey_ty³
;

68 
	m¡©e
;

70 
d¬¿y
 
	m£rv”s
;

71 
d¬¿y
 
	m»¶ys
;

73 
	m£rv”s_couÁ
;

74 
	m»¶ys_couÁ
;

75 
	mnÙ_exi¡_couÁ
;

76 } 
	tcheck_un™
;

78 
	sd©a_check”
 {

79 
±h»ad_t
 
	mth»ad_id
;

81 
«Ev’tLoİ
 *
	m–
;

82 
	mhz
;

83 
	müÚloİs
;

85 
sds
 
	m‹¡_rg‘_groups
;

87 
	mæags
;

88 
sds
 
	mcheck”
;

89 
cÚn_cÚ‹xt
 *
	mma¡”
;

91 
	mcheck_begš_time
;

92 } 
	td©a_check”
;

94 
d©a_check”
 
	gdc
;

98 
	gÏ¡_check_begš_time
;

100 
d¬¿y
 *
	gcdts
 = 
NULL
;

102 
check_un™
 *
	$check_un™_ü—‹
()

104 
check_un™
 *
cun™
;

106 
cun™
 = 
	`m®loc
((*cunit));

107 ià(
cun™
 =ğ
NULL
) {

108  
NULL
;

111 
cun™
->
cdt
 = 
NULL
;

113 
cun™
->
Êode
 = 
NULL
;

115 
cun™
->
key
 = 
NULL
;

116 
cun™
->
key_³rsi¡
 = 0;

117 
cun™
->
mš_‰l
 = 0;

118 
cun™
->
max_‰l_g­
 = 0;

119 
cun™
->
key_ty³
 = -1;

120 
cun™
->
¡©e
 = 
CHECK_UNIT_STATE_NULL
;

121 
	`d¬¿y_š™
(&
cun™
->
£rv”s
, 2, (
ab‹¡_£rv”
*));

122 
	`d¬¿y_š™
(&
cun™
->
»¶ys
, 2, (
»disR•ly
*));

124 
cun™
->
£rv”s_couÁ
 = 0;

125 
cun™
->
»¶ys_couÁ
 = 0;

126 
cun™
->
nÙ_exi¡_couÁ
 = 0;

128  
cun™
;

129 
	}
}

131 
	$check_un™_de¡roy
(
check_un™
 *
cun™
)

133 ià(
cun™
->
cdt
 !ğ
NULL
 && cun™->
Êode
 != NULL) {

134 
	`dli¡D–Node
(
cun™
->
cdt
->
check_un™s
,cun™->
Êode
);

135 
cun™
->
Êode
 = 
NULL
;

138 ià(
cun™
->
key
 !ğ
NULL
) {

139 
	`sdsä“
(
cun™
->
key
);

140 
cun™
->
key
 = 
NULL
;

143 
	`d¬¿y_n
(&
cun™
->
£rv”s
) > 0) {

144 
	`d¬¿y_pİ
(&
cun™
->
£rv”s
);

146 
	`d¬¿y_deš™
(&
cun™
->
£rv”s
);

148 
	`d¬¿y_n
(&
cun™
->
»¶ys
) > 0) {

149 
»disR•ly
 **
»¶y
 = 
	`d¬¿y_pİ
(&
cun™
->
»¶ys
);

150 
	`ä“R•lyObjeù
(*
»¶y
);

152 
	`d¬¿y_deš™
(&
cun™
->
»¶ys
);

154 
	`ä“
(
cun™
);

155 
	}
}

157 
	$check_cÚn_cÚ‹xt_š™
(
cÚn_cÚ‹xt
 *
cc
, *
ho¡
, 
pÜt
)

159 
cc
->
ùx
 = 
NULL
;

160 
cc
->
aùx
 = 
NULL
;

162 
cc
->
aùx
 = 
	`»disAsyncCÚÃù
(
ho¡
, 
pÜt
);

163 ià(
cc
->
aùx
 =ğ
NULL
) {

164  
VRT_ERROR
;

167  
VRT_OK
;

168 
	}
}

170 
	$check_cÚn_cÚ‹xt_deš™
(
cÚn_cÚ‹xt
 *
cc
)

172 ià(
cc
->
ùx
) {

173 
	`»disF»e
(
cc
->
ùx
);

174 
cc
->
ùx
 =ğ
NULL
;

177 ià(
cc
->
aùx
) {

178 
cc
->
aùx
->
ev
.
ş—nup
 = 
NULL
;

179 
	`»disAsyncF»e
(
cc
->
aùx
);

180 
cc
->
aùx
 =ğ
NULL
;

182 
	}
}

184 
	$cÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

185 
check_d©a_th»ad
 *
cdt
 = 
c
->
d©a
;

186 ià(
¡©us
 !ğ
REDIS_OK
) {

187 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

193 
	}
}

195 
	$discÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

196 
check_d©a_th»ad
 *
cdt
 = 
c
->
d©a
;

197 ià(
¡©us
 !ğ
REDIS_OK
) {

198 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

205 
	}
}

207 
	$sÜt_»¶ys_if_Ãeded
(
check_un™
 *
cun™
)

209 
¡•
 = 0, 
idx_cmp
 = 0;

211 ià(
cun™
->
key_ty³
 =ğ
REDIS_SET
) {

212 
¡•
 = 1;

213 } ià(
cun™
->
key_ty³
 =ğ
REDIS_HASH
) {

214 
¡•
 = 2;

217 ià(
¡•
 > 0) {

218 
i
;

219 
»disR•ly
 **
»¶y
;

220 
i
 = 0; i < 
	`d¬¿y_n
(&
cun™
->
»¶ys
); i ++) {

221 
»¶y
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
, 
i
);

222 ià((*
»¶y
)->
ty³
 !ğ
REDIS_REPLY_ARRAY
)

224 
	`sÜt_¬¿y_by_¡•
((*
»¶y
)->
–em’t
, (*»¶y)->
–em’ts
,

225 
¡•
, 
idx_cmp
, 
»¶y_¡ršg_bš¬y_com·»
);

229  
VRT_OK
;

230 
	}
}

234 
	$check_»¶ys_if_§me
(
check_un™
 *
cun™
)

236 
j
;

237 
»disR•ly
 **
»¶yb
, **
»¶y
;

239 
	`sÜt_»¶ys_if_Ãeded
(
cun™
);

241 
»¶yb
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
,0);

243 
j
 = 1; j < 
cun™
->
»¶ys_couÁ
 ; j ++) {

244 
»¶y
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
,
j
);

245 ià(
	`check_two_»¶ys_if_§me
(*
»¶yb
, *
»¶y
)) {

251 
	}
}

253 
	#TTL_MISTAKE_CAN_BE_ACCEPT
 3

	)

254 
	$check_d©a_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

255 
»disR•ly
 *
»¶y
 = 
r
, *
»¶y_sub
, *
»¶y_–em
;

256 
»disR•ly
 *
»¶y_şÚe
, **
–em
;

257 
check_un™
 *
cun™
 = 
´ivd©a
;

258 
check_d©a_th»ad
 *
cdt
 = 
cun™
->cdt;

259 
cÚn_cÚ‹xt
 *
cc
;

260 
v®ue
;

261 *
”rmsg
;

262 
j
;

264 ià(
»¶y
 =ğ
NULL
) ;

266 ià(
cun™
->
¡©e
 =ğ
CHECK_UNIT_STATE_GET_EXPIRE
) {

267 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

268 
”rmsg
 = "ttl command„eplyype is‚ot integer";

269 
”rÜ
;

272 
»¶y_şÚe
 = 
	`¡—l_hœedis_»di¤•ly
(
»¶y
);

273 
–em
 = 
	`d¬¿y_push
(&
cun™
->
»¶ys
);

274 *
–em
 = 
»¶y_şÚe
;

275 
cun™
->
»¶ys_couÁ
 ++;

277 ià(
cun™
->
»¶ys_couÁ
 >ğcun™->
£rv”s_couÁ
) {

278 *
¬gv
[2];

279 
size_t
 
¬gvËn
[2];

280 
mš
, 
max
;

281 
³rsi¡
;

283 
–em
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
, 0);

284 
»¶y_–em
 = *
–em
;

285 ià(
»¶y_–em
->
š‹g”
 == -1) {

286 
³rsi¡
 = 1;

287 } ià(
»¶y_–em
->
š‹g”
 == -2) {

288 
cun™
->
nÙ_exi¡_couÁ
 ++;

289 
mš
 = 
max
 = 0;

290 } ià(
»¶y_–em
->
š‹g”
 < -2) {

291 
”rmsg
 = "ttl command„eply integer is†esshan -2";

292 
”rÜ
;

294 
mš
 = 
max
 = 
»¶y_–em
->
š‹g”
;

297 
j
 = 1; j < 
	`d¬¿y_n
(&
cun™
->
»¶ys
); j ++) {

298 
–em
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
, 
j
);

299 
»¶y_–em
 = *
–em
;

300 ià(
³rsi¡
 && 
»¶y_–em
->
š‹g”
 != -1) {

301 
”rmsg
 = "key in some server is…ersist, but others‡re‚ot";

302 
”rÜ
;

305 ià(
»¶y_–em
->
š‹g”
 == -1) {

306 ià(
³rsi¡
 != 1) {

307 
”rmsg
 = "key in some server is…ersist, but others‡re‚ot";

308 
”rÜ
;

310 } ià(
»¶y_–em
->
š‹g”
 == -2) {

311 
cun™
->
nÙ_exi¡_couÁ
 ++;

312 ià(
mš
 > 0) min = 0;

313 } ià(
»¶y_–em
->
š‹g”
 < -2) {

314 
”rmsg
 = "ttl command„eply integer is†esshan -2";

315 
”rÜ
;

317 ià(
»¶y_–em
->
š‹g”
 < 
mš
) min =„eply_elem->integer;

318 ià(
»¶y_–em
->
š‹g”
 > 
max
) max =„eply_elem->integer;

322 ià(
cun™
->
nÙ_exi¡_couÁ
 >ğcun™->
£rv”s_couÁ
) {

324 
dÚe
;

327 ià(
³rsi¡
) {

328 
cun™
->
key_³rsi¡
 = 1;

330 
cun™
->
mš_‰l
 = 
mš
;

331 
cun™
->
max_‰l_g­
 = 
max
-
mš
;

332 ià(
cun™
->
max_‰l_g­
 > 
TTL_MISTAKE_CAN_BE_ACCEPT
) {

333 
”rmsg
 = "ttl mistake isoo big between groups";

334 
”rÜ
;

339 
¬gv
[0] = "type";

340 
¬gvËn
[0] = 4;

341 
¬gv
[1] = 
cun™
->
key
;

342 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

343 
j
 = 0; j < 
	`d¬¿y_n
(&
cun™
->
£rv”s
); j ++) {

344 
ab‹¡_£rv”
 **
abs
 = 
	`d¬¿y_g‘
(&
cun™
->
£rv”s
,
j
);

345 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
((*
abs
)->
cÚn_cÚ‹xts
, 0);

347 
	`»disAsyncCommªdArgv
(
cc
->
aùx
, 
check_d©a_ÿÎback
,

348 
cun™
, 2, 
¬gv
, 
¬gvËn
);

351 
cun™
->
¡©e
 = 
CHECK_UNIT_STATE_GET_TYPE
;

352 
Ãxt_¡•
;

358 ià(
cun™
->
¡©e
 =ğ
CHECK_UNIT_STATE_GET_TYPE
) {

359 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STATUS
) {

360 
”rmsg
 = "type command„eplyype is‚ot status";

361 
”rÜ
;

364 ià(!
	`¡rcmp
(
»¶y
->
¡r
, "none")) {

366 
cun™
->
nÙ_exi¡_couÁ
 ++;

368 
»¶y_şÚe
 = 
	`¡—l_hœedis_»di¤•ly
(
»¶y
);

369 
–em
 = 
	`d¬¿y_push
(&
cun™
->
»¶ys
);

370 *
–em
 = 
»¶y_şÚe
;

371 
cun™
->
»¶ys_couÁ
 ++;

374 ià(
cun™
->
nÙ_exi¡_couÁ
 >ğcun™->
£rv”s_couÁ
) {

376 
dÚe
;

377 } ià(
cun™
->
»¶ys_couÁ
 >ğ(cun™->
£rv”s_couÁ
-cun™->
nÙ_exi¡_couÁ
)) {

378 
¬gc
;

379 **
¬gv
;

380 
size_t
 *
¬gvËn
;

382 ià(
cun™
->
nÙ_exi¡_couÁ
 > 0 && cun™->
key_³rsi¡
) {

383 
”rmsg
 = "key is…ersist, but‚otƒxist in some servers";

384 
”rÜ
;

387 ià(
	`check_»¶ys_if_§me
(
cun™
) != 1) {

388 
”rmsg
 = "type command„eplys‡re‚ot same";

389 
”rÜ
;

392 
–em
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
,0);

393 ià(!
	`¡rcmp
((*
–em
)->
¡r
,"string")) {

394 
cun™
->
key_ty³
 = 
REDIS_STRING
;

396 
¬gc
 = 2;

397 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

398 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

400 
¬gv
[0] = "get";

401 
¬gvËn
[0] = 3;

402 
¬gv
[1] = 
cun™
->
key
;

403 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

404 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"list")) {

405 
cun™
->
key_ty³
 = 
REDIS_LIST
;

407 
¬gc
 = 4;

408 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

409 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

411 
¬gv
[0] = "lrange";

412 
¬gvËn
[0] = 6;

413 
¬gv
[1] = 
cun™
->
key
;

414 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

415 
¬gv
[2] = "0";

416 
¬gvËn
[2] = 1;

417 
¬gv
[3] = "-1";

418 
¬gvËn
[3] = 2;

419 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"set")) {

420 
cun™
->
key_ty³
 = 
REDIS_SET
;

422 
¬gc
 = 2;

423 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

424 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

426 
¬gv
[0] = "smembers";

427 
¬gvËn
[0] = 8;

428 
¬gv
[1] = 
cun™
->
key
;

429 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

430 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"zset")) {

431 
cun™
->
key_ty³
 = 
REDIS_ZSET
;

433 
¬gc
 = 4;

434 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

435 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

437 
¬gv
[0] = "zrange";

438 
¬gvËn
[0] = 6;

439 
¬gv
[1] = 
cun™
->
key
;

440 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

441 
¬gv
[2] = "0";

442 
¬gvËn
[2] = 1;

443 
¬gv
[3] = "-1";

444 
¬gvËn
[3] = 2;

445 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"hash")) {

446 
cun™
->
key_ty³
 = 
REDIS_HASH
;

448 
¬gc
 = 2;

449 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

450 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

452 
¬gv
[0] = "hgetall";

453 
¬gvËn
[0] = 7;

454 
¬gv
[1] = 
cun™
->
key
;

455 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

457 
”rmsg
 = "not supported keyype";

458 
”rÜ
;

462 
j
 = 0; j < 
	`d¬¿y_n
(&
cun™
->
£rv”s
); j ++) {

463 
ab‹¡_£rv”
 **
abs
 = 
	`d¬¿y_g‘
(&
cun™
->
£rv”s
,
j
);

464 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
((*
abs
)->
cÚn_cÚ‹xts
, 0);

466 
	`»disAsyncCommªdArgv
(
cc
->
aùx
, 
check_d©a_ÿÎback
,

467 
cun™
, 
¬gc
, 
¬gv
, 
¬gvËn
);

469 
	`ä“
(
¬gv
);

470 
	`ä“
(
¬gvËn
);

472 
cun™
->
¡©e
 = 
CHECK_UNIT_STATE_GET_VALUE
;

473 
Ãxt_¡•
;

479 ià(
cun™
->
¡©e
 =ğ
CHECK_UNIT_STATE_GET_VALUE
) {

480 
nÙ_exi¡
 = 0;

481 ià(
cun™
->
key_ty³
 =ğ
REDIS_STRING
) {

482 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_NIL
) {

483 
nÙ_exi¡
 = 1;

484 } ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

485 
”rmsg
 = "get command„eplyype is‚ot string";

486 
”rÜ
;

488 } ià(
cun™
->
key_ty³
 =ğ
REDIS_LIST
) {

489 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

490 
”rmsg
 = "lrange command„eplyype is‚ot‡rray";

491 
”rÜ
;

493 ià(
»¶y
->
–em’ts
 == 0) {

494 
nÙ_exi¡
 = 1;

496 } ià(
cun™
->
key_ty³
 =ğ
REDIS_SET
) {

497 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

498 
”rmsg
 = "smembers command„eplyype is‚ot‡rray";

499 
”rÜ
;

501 ià(
»¶y
->
–em’ts
 == 0) {

502 
nÙ_exi¡
 = 1;

504 } ià(
cun™
->
key_ty³
 =ğ
REDIS_ZSET
) {

505 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

506 
”rmsg
 = "zrange command„eplyype is‚ot‡rray";

507 
”rÜ
;

509 ià(
»¶y
->
–em’ts
 == 0) {

510 
nÙ_exi¡
 = 1;

512 } ià(
cun™
->
key_ty³
 =ğ
REDIS_HASH
) {

513 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

514 
”rmsg
 = "hgetall command„eplyype is‚ot‡rray";

515 
”rÜ
;

517 ià(
»¶y
->
–em’ts
 == 0) {

518 
nÙ_exi¡
 = 1;

521 
”rmsg
 = "not supported keyype";

522 
”rÜ
;

525 ià(
nÙ_exi¡
) {

526 
cun™
->
nÙ_exi¡_couÁ
 ++;

528 
»¶y_şÚe
 = 
	`¡—l_hœedis_»di¤•ly
(
»¶y
);

529 
–em
 = 
	`d¬¿y_push
(&
cun™
->
»¶ys
);

530 *
–em
 = 
»¶y_şÚe
;

531 
cun™
->
»¶ys_couÁ
 ++;

534 ià(
cun™
->
nÙ_exi¡_couÁ
 >ğcun™->
£rv”s_couÁ
) {

536 
dÚe
;

537 } ià(
cun™
->
»¶ys_couÁ
 >ğ(cun™->
£rv”s_couÁ
-cun™->
nÙ_exi¡_couÁ
)) {

538 ià(
cun™
->
nÙ_exi¡_couÁ
 > 0 && cun™->
key_³rsi¡
) {

539 
”rmsg
 = "key is…ersist, but‚otƒxist in some servers";

540 
”rÜ
;

543 ià(
	`check_»¶ys_if_§me
(
cun™
) != 1) {

544 
”rmsg
 = "values for„eply‡re‚ot same";

545 
”rÜ
;

548 
dÚe
;

554 
dÚe
:

556 
	`check_un™_de¡roy
(
cun™
);

560 
Ãxt_¡•
:

562 
cun™
->
»¶ys_couÁ
 = 0;

563 
cun™
->
nÙ_exi¡_couÁ
 = 0;

564 
	`d¬¿y_n
(&
cun™
->
»¶ys
) > 0) {

565 
–em
 = 
	`d¬¿y_pİ
(&
cun™
->
»¶ys
);

566 
	`ä“R•lyObjeù
(*
–em
);

571 
”rÜ
:

573 
	`log_hexdump
(
LOG_ERR
,
cun™
->
key
,
	`sd¦’
(cunit->key),

575 
”rmsg
,

576 
cdt
->
sÿn_group_idx
,

577 
	`sd¦’
(
cun™
->
key
),
	`g‘_key_ty³_¡ršg
(cun™->
key_ty³
));

579 
	`check_un™_de¡roy
(
cun™
);

580 
	}
}

582 
	$¡¬t_check_d©a
(*
key
, 
size_t
 
keyËn
, 
check_d©a_th»ad
 *
cdt
)

584 
check_un™
 *
cu
 = 
	`check_un™_ü—‹
();

585 
j
;

587 
cu
->
cdt
 = cdt;

588 
cu
->
key
 = 
	`sd¢ewËn
(key,
keyËn
);

589 
	`dli¡Push
(
cdt
->
check_un™s
,
cu
);

590 
cu
->
Êode
 = 
	`dli¡La¡
(
cdt
->
check_un™s
);

592 
j
 = 0; j < 
	`d¬¿y_n
(
cdt
->
abgs
); j ++) {

593 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, 
j
);

594 
ab‹¡_£rv”
 *
abs
 = 
abg
->
	`g‘_back’d_£rv”
×bg,
key
,
keyËn
);

595 
ab‹¡_£rv”
 **
–em
 = 
	`d¬¿y_push
(&
cu
->
£rv”s
);

596 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

597 *
¬gv
[2];

598 
size_t
 
¬gvËn
[2];

600 *
–em
 = 
abs
;

601 
cu
->
£rv”s_couÁ
 ++;

604 
¬gv
[0] = "ttl";

605 
¬gvËn
[0] = 3;

606 
¬gv
[1] = 
key
;

607 
¬gvËn
[1] = 
keyËn
;

608 
	`»disAsyncCommªdArgv
(
cc
->
aùx
, 
check_d©a_ÿÎback
,

609 
cu
, 2, 
¬gv
, 
¬gvËn
);

611 
cu
->
¡©e
 = 
CHECK_UNIT_STATE_GET_EXPIRE
;

613  
VRT_OK
;

614 
	}
}

616 
	$sÿn_fÜ_check_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

617 
»disR•ly
 *
»¶y
 = 
r
, *
»¶y_sub
, *
»¶y_–em
;

618 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

619 
check_d©a_th»ad
 *
cdt
 = 
abs
->
d©a
;

620 
cÚn_cÚ‹xt
 *
cc
;

621 
v®ue
;

622 
size_t
 
k
;

624 ià(
»¶y
 =ğ
NULL
) ;

627 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

631 ià(
»¶y
->
–em’ts
 != 2) {

635 
»¶y_sub
 = 
»¶y
->
–em’t
[0];

636 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

637 
	`¡ršg2Î
(
»¶y_sub
->
¡r
,»¶y_sub->
Ën
,&
v®ue
) != 1) {

641 
cdt
->
cursÜ
 = 
v®ue
;

643 
»¶y_sub
 = 
»¶y
->
–em’t
[1];

644 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

648 
k
 = 0; k < 
»¶y_sub
->
–em’ts
; k ++) {

649 
»¶y_–em
 = 
»¶y_sub
->
–em’t
[
k
];

650 ià(
»¶y_–em
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

654 
	`¡¬t_check_d©a
(
»¶y_–em
->
¡r
,»¶y_–em->
Ën
,
cdt
);

657 
cdt
->
sÿn_keys_couÁ
 +ğ
»¶y_sub
->
–em’ts
;

659 ià(
cdt
->
cursÜ
 == 0) {

660 
cdt
->
sÿn_fšished_couÁ
 ++;

662 
	}
}

664 
	gcheck_d©a_th»ads_fšished_couÁ
 = 0;

665 
	$Úe_check_d©a_th»ad_fšished
()

667 
	`upd©e_¡©e_add
(
check_d©a_th»ads_fšished_couÁ
,1);

668 
	}
}

670 
	$®l_check_d©a_th»ads_fšished
()

672 
fšished_couÁ
;

673 
	`upd©e_¡©e_g‘
(
check_d©a_th»ads_fšished_couÁ
,&
fšished_couÁ
);

675 ià(
fšished_couÁ
 >ğ
	`d¬¿y_n
(
cdts
)) {

680 
	}
}

682 
	$check_d©a_th»ad_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

684 
check_d©a_th»ad
 *
cdt
 = 
ş›ÁD©a
;

686 
	`ASSERT
(
ev’tLoİ
 =ğ
cdt
->
–
);

688 ià(
cdt
->
sÿn_fšished_couÁ
 >ğ
	`d¬¿y_n
(cdt->
sÿn_£rv”s
)) {

689 ià(
	`dli¡L’gth
(
cdt
->
check_un™s
) == 0) {

690 
	`«Stİ
(
cdt
->
–
);

691 
	`Úe_check_d©a_th»ad_fšished
();

692 
	`log_debug
(
LOG_NOTICE
, "One checkhread finished,scaned %lld keys",

693 
cdt
->
sÿn_keys_couÁ
);

696 } ià(
	`dli¡L’gth
(
cdt
->
check_un™s
) < 3000) {

697 
ab‹¡_group
 *
abg
;

698 
ab‹¡_£rv”
 **
abs
;

699 *
idx
;

700 
cÚn_cÚ‹xt
 *
cc
;

702 
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, cdt->
sÿn_group_idx
);

703 
abs
 = 
	`d¬¿y_g‘
(
cdt
->
sÿn_£rv”s
, cdt->
sÿn_fšished_couÁ
);

704 
cc
 = 
	`d¬¿y_g‘
((*
abs
)->
cÚn_cÚ‹xts
, 0);

706 
	`»disAsyncCommªd
(
cc
->
aùx
, 
sÿn_fÜ_check_ÿÎback
,

707 *
abs
, "sÿÀ%Îd couÁ 1000", 
cdt
->
cursÜ
);

710 
cdt
->
üÚloİs
 ++;

711  1000/
cdt
->
hz
;

712 
	}
}

714 
	$check_d©a_th»ad_š™
(
check_d©a_th»ad
 *
cdt
, *
‹¡_rg‘_groups
)

716 
i
, 
j
, 
k
;

718 
cdt
->
id
 = 0;

719 
cdt
->
th»ad_id
 = 0;

720 
cdt
->
–
 = 
NULL
;

721 
cdt
->
hz
 = 200;

722 
cdt
->
üÚloİs
 = 0;

724 
cdt
->
abgs
 = 
NULL
;

725 
cdt
->
sÿn_group_idx
 = 0;

726 
cdt
->
sÿn_£rv”s
 = 
NULL
;

727 
cdt
->
sÿn_fšished_couÁ
 = 0;

728 
cdt
->
cursÜ
 = 0;

729 
cdt
->
check_un™s
 = 
NULL
;

731 
cdt
->
check_begš_time
 = 0;

732 
cdt
->
sÿn_keys_couÁ
 = 0;

734 
cdt
->
–
 = 
	`«C»©eEv’tLoİ
(200);

735 ià(
cdt
->
–
 =ğ
NULL
) {

736  
VRT_ERROR
;

739 
cdt
->
sÿn_£rv”s
 = 
	`d¬¿y_ü—‹
(1,(
ab‹¡_£rv”
*));

741 
cdt
->
abgs
 = 
	`ab‹¡_groups_ü—‹
(
‹¡_rg‘_groups
);

742 ià(
cdt
->
abgs
 =ğ
NULL
) {

743  
VRT_ERROR
;

747 
i
 = 0; i < 
	`d¬¿y_n
(
cdt
->
abgs
); i ++) {

748 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, 
i
);

749 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

750 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

751 
abs
->
cÚn_cÚ‹xts
 = 
	`d¬¿y_ü—‹
(1, (
cÚn_cÚ‹xt
));

752 
k
 = 0; k < 1; k ++) {

753 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_push
(
abs
->
cÚn_cÚ‹xts
);

754 ià(
	`check_cÚn_cÚ‹xt_š™
(
cc
,
abs
->
ho¡
,abs->
pÜt
è!ğ
VRT_OK
) {

755  
VRT_ERROR
;

757 
cc
->
aùx
->
d©a
 = 
cdt
;

758 
	`»disAeA‰ach
(
cdt
->
–
, 
cc
->
aùx
);

759 
	`»disAsyncS‘CÚÃùC®lback
(
cc
->
aùx
,
cÚÃù_ÿÎback
);

760 
	`»disAsyncS‘DiscÚÃùC®lback
(
cc
->
aùx
,
discÚÃù_ÿÎback
);

765 ià(
	`«C»©eTimeEv’t
(
cdt
->
–
, 1, 
check_d©a_th»ad_üÚ
, cdt, 
NULL
è=ğ
AE_ERR
) {

766  
VRT_ERROR
;

769 
cdt
->
check_un™s
 = 
	`dli¡C»©e
();

771  
VRT_OK
;

772 
	}
}

774 
	$check_d©a_th»ad_deš™
(
check_d©a_th»ad
 *
cdt
)

776 ià(
cdt
->
–
) {

777 
	`«D–‘eEv’tLoİ
(
cdt
->
–
);

778 
cdt
->
–
 = 
NULL
;

781 ià(
cdt
->
sÿn_£rv”s
) {

782 
	`d¬¿y_n
(
cdt
->
sÿn_£rv”s
) > 0) {

783 
	`d¬¿y_pİ
(
cdt
->
sÿn_£rv”s
);

785 
	`d¬¿y_de¡roy
(
cdt
->
sÿn_£rv”s
);

786 
cdt
->
sÿn_£rv”s
 = 
NULL
;

789 ià(
cdt
->
abgs
) {

790 
i
, 
j
, 
k
;

792 
i
 = 0; i < 
	`d¬¿y_n
(
cdt
->
abgs
); i ++) {

793 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, 
i
);

794 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

795 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

796 
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) > 0) {

797 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_pİ
(
abs
->
cÚn_cÚ‹xts
);

798 
	`check_cÚn_cÚ‹xt_deš™
(
cc
);

803 
	`ab‹¡_groups_de¡roy
(
cdt
->
abgs
);

804 
cdt
->
abgs
 = 
NULL
;

807 ià(
cdt
->
check_un™s
) {

808 
	`dli¡L’gth
(
cdt
->
check_un™s
) > 0) {

809 
check_un™
 *
cu
 = 
	`dli¡Pİ
(
cdt
->
check_un™s
);

810 
	`check_un™_de¡roy
(
cu
);

812 
	`dli¡R–—£
(
cdt
->
check_un™s
);

813 
cdt
->
check_un™s
 = 
NULL
;

815 
	}
}

817 
	gcheckšg_d©a
;

818 
	$checkšg_d©a_Ü_nÙ
()

820 
checkšg
;

822 
	`upd©e_¡©e_g‘
(
checkšg_d©a
,&
checkšg
);

824 ià(
checkšg
)  1;

826 
	}
}

828 
	gcheck_d©a_th»ads_couÁ
 = 8;

829 
de¡roy_check_d©a_th»ads
();

834 
	$ü—‹_check_d©a_th»ads
()

836 
d¬¿y
 *
abgs
 = 
NULL
;

837 
ab‹¡_group
 *
abg
;

838 
groups_couÁ
;

839 
th»ads_couÁ_³r_group
;

840 
check_th»ad_id
 = 0;

841 
i
, 
j
, 
k
;

843 ià(
cdts
 !ğ
NULL
) {

844 
	`de¡roy_check_d©a_th»ads
();

847 
cdts
 = 
	`d¬¿y_ü—‹
(2,(
check_d©a_th»ad
));

848 ià(
cdts
 =ğ
NULL
) {

852 
abgs
 = 
	`ab‹¡_groups_ü—‹
(
dc
.
‹¡_rg‘_groups
);

853 ià(
abgs
 =ğ
NULL
) {

857 
groups_couÁ
 = 
	`d¬¿y_n
(
abgs
);

858 ià(
groups_couÁ
 == 1) {

859 
	`ab‹¡_groups_de¡roy
(
abgs
);

863 
th»ads_couÁ_³r_group
 = 
check_d©a_th»ads_couÁ
/
groups_couÁ
;

864 ià(
th»ads_couÁ_³r_group
 <= 0) {

865 
th»ads_couÁ_³r_group
 = 1;

868 
i
 = 0; i < 
groups_couÁ
; i ++) {

869 
£rv”s_couÁ
, 
th»ads_couÁ
;

870 
£rv”s_couÁ_³r_th»ad
;

871 
£rv”_idx
 = 0;

873 
th»ads_couÁ
 = 
th»ads_couÁ_³r_group
;

874 
abg
 = 
	`d¬¿y_g‘
(
abgs
, 
i
);

875 
£rv”s_couÁ
 = 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
);

876 
£rv”s_couÁ_³r_th»ad
 = 
£rv”s_couÁ
/
th»ads_couÁ
;

877 ià(
£rv”s_couÁ_³r_th»ad
 == 0) {

878 
£rv”s_couÁ_³r_th»ad
 = 1;

879 
th»ads_couÁ
 = 
£rv”s_couÁ
;

881 
j
 = 0; j < 
th»ads_couÁ
; j ++) {

882 
ab‹¡_£rv”
 *
abs
;

884 
check_d©a_th»ad
 *
cdt
 = 
	`d¬¿y_push
(
cdts
);

885 
	`check_d©a_th»ad_š™
(
cdt
,
dc
.
‹¡_rg‘_groups
);

886 
cdt
->
id
 = 
check_th»ad_id
++;

887 
cdt
->
sÿn_group_idx
 = 
i
;

889 
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, cdt->
id
);

891 
k
 = 0; k < 
£rv”s_couÁ_³r_th»ad
; k ++) {

892 
ab‹¡_£rv”
 **
–em
 = 
	`d¬¿y_push
(
cdt
->
sÿn_£rv”s
);

893 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
£rv”_idx
++);

894 
abs
->
d©a
 = 
cdt
;

895 *
–em
 = 
abs
;

898 ià(
j
 =ğ
th»ads_couÁ
-1) {

899 
£rv”_idx
 < 
£rv”s_couÁ
) {

900 
ab‹¡_£rv”
 **
–em
 = 
	`d¬¿y_push
(
cdt
->
sÿn_£rv”s
);

901 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
£rv”_idx
++);

902 
abs
->
d©a
 = 
cdt
;

903 *
–em
 = 
abs
;

909 
	`ab‹¡_groups_de¡roy
(
abgs
);

912 
	}
}

914 
	$de¡roy_check_d©a_th»ads
()

916 ià(
cdts
 !ğ
NULL
) {

917 
	`d¬¿y_n
(
cdts
) > 0) {

918 
check_d©a_th»ad
 *
cdt
 = 
	`d¬¿y_pİ
(
cdts
);

919 
	`check_d©a_th»ad_deš™
(
cdt
);

921 
	`d¬¿y_de¡roy
(
cdts
);

922 
cdts
 = 
NULL
;

924 
	}
}

926 *
	$check_d©a_th»ad_run
(*
¬gs
)

928 
check_d©a_th»ad
 *
cdt
 = 
¬gs
;

930 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

932 
	`«Maš
(
cdt
->
–
);

934  
NULL
;

935 
	}
}

937 
	$¡¬t_check_d©a_th»ads
()

939 
j
;

940 
check_d©a_th»ad
 *
cdt
;

942 ià(
cdts
 =ğ
NULL
è 
VRT_ERROR
;

944 
j
 = 0; j < 
	`d¬¿y_n
(
cdts
); j ++) {

945 
±h»ad_©Œ_t
 
©Œ
;

947 
cdt
 = 
	`d¬¿y_g‘
(
cdts
, 
j
);

948 
	`±h»ad_©Œ_š™
(&
©Œ
);

949 
	`±h»ad_ü—‹
(&
cdt
->
th»ad_id
,

950 &
©Œ
, 
check_d©a_th»ad_run
, 
cdt
);

953  
VRT_OK
;

954 
	}
}

956 
	$begš_check_d©a
()

958 
	`ü—‹_check_d©a_th»ads
();

959 
	`¡¬t_check_d©a_th»ads
();

961 
	`upd©e_¡©e_£t
(
checkšg_d©a
,1);

963  
VRT_OK
;

964 
	}
}

966 
	$’d_check_d©a
()

968 
	`upd©e_¡©e_£t
(
check_d©a_th»ads_fšished_couÁ
,0);

969 
	`upd©e_¡©e_£t
(
checkšg_d©a
,0);

970 
	}
}

972 
	$d©a_check”_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

974 
	`ASSERT
(
ev’tLoİ
 =ğ
dc
.
–
);

976 ià(!
	`‹¡_if_Ãed_·u£
(è&& 
	`v¹_£c_now
()-
Ï¡_‹¡_begš_time
 > 
‹¡_š‹rv®
) {

977 
	`‹¡_Ãed_to_·u£
();

978 
	`log_nÙiû
("Start…auseheest...");

981 ià(!
	`checkšg_d©a_Ü_nÙ
(è&& 
	`‹¡_if_Ãed_·u£
() &&

982 
	`®l_th»ads_·u£d
()) {

984 
	`log_nÙiû
("Finished…auseheest. Tested %lld commands, %lldƒrror„eply(%.2f%%).",

985 
	`g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
(),

986 
	`g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
(),

987 ()
	`g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
()/()
	`g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
()*100);

988 
	`»£t_tÙ®_couÁ_³r_cyşe
();

989 
	`¦“p
(1);

990 
Ï¡_check_begš_time
 = 
	`v¹_£c_now
();

991 
	`begš_check_d©a
();

992 
	`log_nÙiû
("Start checkinghe data...");

995 ià(
	`checkšg_d©a_Ü_nÙ
(è&& 
	`®l_check_d©a_th»ads_fšished
()) {

996 
	`’d_check_d©a
();

997 
	`log_nÙiû
("Finished checkinghe data\n");

998 
	`‹¡_ÿn_cÚtšue
();

999 
Ï¡_‹¡_begš_time
 = 
	`v¹_£c_now
();

1002 
dc
.
üÚloİs
 ++;

1003  1000/
dc
.
hz
;

1004 
	}
}

1006 
	$v¹_d©a_check”_š™
(*
check”
, *
‹¡_rg‘_groups
)

1008 
»t
;

1010 
dc
.
th»ad_id
 = 0;

1011 
dc
.
–
 = 
NULL
;

1012 
dc
.
hz
 = 10;

1013 
dc
.
üÚloİs
 = 0;

1014 
dc
.
‹¡_rg‘_groups
 = 
NULL
;

1015 
dc
.
æags
 = 
CHECK_DATA_FLAG_NONE
;

1016 
dc
.
check”
 = 
NULL
;

1017 
dc
.
ma¡”
 = 
NULL
;

1018 
dc
.
check_begš_time
 = 0;

1020 
dc
.
–
 = 
	`«C»©eEv’tLoİ
(10);

1021 ià(
dc
.
–
 =ğ
NULL
) {

1022  
VRT_ERROR
;

1025 ià(
	`«C»©eTimeEv’t
(
dc
.
–
, 1, 
d©a_check”_üÚ
, 
NULL
, NULLè=ğ
AE_ERR
) {

1026  
VRT_ERROR
;

1029 
dc
.
‹¡_rg‘_groups
 = 
	`sd¢ew
(test_target_groups);

1031 
dc
.
check”
 = 
	`sd¢ew
(checker);

1033 ià(!
	`¡rÿ£cmp
(
check”
,"myself")) {

1034 
dc
.
æags
 |ğ
CHECK_DATA_FLAG_MASTER
;

1036 
sds
 
ho¡
;

1037 
pÜt
;

1038 
dc
.
æags
 |ğ
CHECK_DATA_FLAG_SLAVE
;

1039 
ho¡
 = 
	`g‘_ho¡_pÜt_äom_add»ss_¡ršg
(
check”
, &
pÜt
);

1040 ià(
ho¡
 =ğ
NULL
) {

1041  
VRT_ERROR
;

1043 
dc
.
ma¡”
 = 
	`m®loc
((
cÚn_cÚ‹xt
));

1044 
»t
 = 
	`check_cÚn_cÚ‹xt_š™
(
dc
.
ma¡”
, 
ho¡
, 
pÜt
);

1045 
	`sdsä“
(
ho¡
);

1046 ià(
»t
 !ğ
VRT_OK
) {

1047  
VRT_ERROR
;

1051  
VRT_OK
;

1052 
	}
}

1054 
	$v¹_d©a_check”_deš™
()

1056 ià(
dc
.
–
) {

1057 
	`«D–‘eEv’tLoİ
(
dc
.
–
);

1058 
dc
.
–
 = 
NULL
;

1061 ià(
dc
.
‹¡_rg‘_groups
) {

1062 
	`sdsä“
(
dc
.
‹¡_rg‘_groups
);

1063 
dc
.
‹¡_rg‘_groups
 = 
NULL
;

1066 ià(
dc
.
check”
) {

1067 
	`sdsä“
(
dc
.
check”
);

1068 
dc
.
check”
 = 
NULL
;

1071 ià(
dc
.
ma¡”
) {

1072 
	`check_cÚn_cÚ‹xt_deš™
(
dc
.
ma¡”
);

1073 
	`ä“
(
dc
.
ma¡”
);

1074 
dc
.
ma¡”
 = 
NULL
;

1077 
	`de¡roy_check_d©a_th»ads
();

1078 
	}
}

1080 *
	$v¹_d©a_check”_run
(*
¬gs
)

1082 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

1084 
	`«Maš
(
dc
.
–
);

1086  
NULL
;

1087 
	}
}

1089 
	$v¹_¡¬t_d©a_check”
()

1091 
±h»ad_©Œ_t
 
©Œ
;

1092 
	`±h»ad_©Œ_š™
(&
©Œ
);

1093 
	`±h»ad_ü—‹
(&
dc
.
th»ad_id
,

1094 &
©Œ
, 
v¹_d©a_check”_run
, 
NULL
);

1095  
VRT_OK
;

1096 
	}
}

1098 
	$v¹_wa™_d©a_check”
()

1100 
	`±h»ad_još
(
dc
.
th»ad_id
, 
NULL
);

1102  
VRT_OK
;

1103 
	}
}

1105 
	g‹¡_Ãed_·u£
 = 0;

1107 
	$‹¡_if_Ãed_·u£
()

1109 
Ãed_·u£
;

1111 
	`upd©e_¡©e_g‘
(
‹¡_Ãed_·u£
,&
Ãed_·u£
);

1113 ià(
Ãed_·u£
)  1;

1115 
	}
}

1117 
	$‹¡_ÿn_cÚtšue
()

1119 
	`upd©e_¡©e_£t
(
‹¡_Ãed_·u£
,0);

1120 
	`upd©e_¡©e_£t
(
´oduû_th»ads_·u£_fšished_couÁ
,0);

1121 
	`upd©e_¡©e_£t
(
di¥©ch_th»ads_·u£_fšished_couÁ
,0);

1122 
	`upd©e_¡©e_£t
(
back’d_th»ads_·u£_fšished_couÁ
,0);

1123 
	}
}

1125 
	$‹¡_Ãed_to_·u£
()

1127 
	`upd©e_¡©e_£t
(
‹¡_Ãed_·u£
,1);

1128 
	}
}

1130 
	$Úe_´oduû_th»ad_·u£d
()

1132 
	`upd©e_¡©e_add
(
´oduû_th»ads_·u£_fšished_couÁ
,1);

1133 
	}
}

1135 
	$Úe_di¥©ch_th»ad_·u£d
()

1137 
	`upd©e_¡©e_add
(
di¥©ch_th»ads_·u£_fšished_couÁ
,1);

1138 
	}
}

1140 
	$Úe_back’d_th»ad_·u£d
()

1142 
	`upd©e_¡©e_add
(
back’d_th»ads_·u£_fšished_couÁ
,1);

1143 
	}
}

1145 
	$®l_´oduû_th»ads_·u£d
()

1147 
·u£d_th»ads
;

1149 
	`upd©e_¡©e_g‘
(
´oduû_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1150 ià(
·u£d_th»ads
 < 
´oduû_d©a_th»ads_couÁ
) {

1155 
	}
}

1157 
	$®l_di¥©ch_th»ads_·u£d
()

1159 
·u£d_th»ads
;

1161 
	`upd©e_¡©e_g‘
(
di¥©ch_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1162 ià(
·u£d_th»ads
 < 
di¥©ch_d©a_th»ads_couÁ
) {

1167 
	}
}

1169 
	$®l_back’d_th»ads_·u£d
()

1171 
·u£d_th»ads
;

1173 
	`upd©e_¡©e_g‘
(
back’d_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1174 ià(
·u£d_th»ads
 < 
back’d_th»ads_couÁ
) {

1179 
	}
}

1181 
	$®l_th»ads_·u£d
()

1183 
·u£d_th»ads
;

1185 
	`upd©e_¡©e_g‘
(
´oduû_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1186 ià(
·u£d_th»ads
 < 
´oduû_d©a_th»ads_couÁ
) {

1190 
	`upd©e_¡©e_g‘
(
di¥©ch_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1191 ià(
·u£d_th»ads
 < 
di¥©ch_d©a_th»ads_couÁ
) {

1195 
	`upd©e_¡©e_g‘
(
back’d_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1196 ià(
·u£d_th»ads
 < 
back’d_th»ads_couÁ
) {

1201 
	}
}

	@tests/vrt_check_data.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<±h»ad.h
>

9 
	~<sys/¡©.h
>

10 
	~<sys/ut¢ame.h
>

12 
	~<hœedis.h
>

13 
	~<async.h
>

14 
	~<ad­‹rs/«.h
>

16 
	~<dhashk™.h
>

17 
	~<dli¡.h
>

18 
	~<dmtqueue.h
>

19 
	~<dlog.h
>

21 
	~<v¹_ut.h
>

22 
	~<v¹_public.h
>

23 
	~<v¿b‹¡.h
>

24 
	~<v¹_´oduû_d©a.h
>

25 
	~<v¹_di¥©ch_d©a.h
>

26 
	~<v¹_back’d.h
>

27 
	~<v¹_check_d©a.h
>

29 
	#CHECK_DATA_FLAG_NONE
 (1<<0)

	)

30 
	#CHECK_DATA_FLAG_MASTER
 (1<<1)

	)

31 
	#CHECK_DATA_FLAG_SLAVE
 (1<<2)

	)

33 
	#CHECK_UNIT_STATE_NULL
 0

	)

34 
	#CHECK_UNIT_STATE_GET_EXPIRE
 1

	)

35 
	#CHECK_UNIT_STATE_GET_TYPE
 2

	)

36 
	#CHECK_UNIT_STATE_GET_VALUE
 3

	)

38 
	scheck_d©a_th»ad
 {

39 
	mid
;

40 
±h»ad_t
 
	mth»ad_id
;

42 
«Ev’tLoİ
 *
	m–
;

43 
	mhz
;

44 
	müÚloİs
;

46 
d¬¿y
 *
	mabgs
;

47 
	msÿn_group_idx
;

48 
d¬¿y
 *
	msÿn_£rv”s
;

49 
	msÿn_fšished_couÁ
;

50 
	mcursÜ
;

51 
dli¡
 *
	mcheck_un™s
;

53 
	mcheck_begš_time
;

54 
	msÿn_keys_couÁ
;

55 } 
	tcheck_d©a_th»ad
;

57 
	scheck_un™
 {

58 
check_d©a_th»ad
 *
	mcdt
;

60 
dli¡Node
 *
	mÊode
;

62 
sds
 
	mkey
;

64 
	mkey_³rsi¡
;

65 
	mmš_‰l
, 
	mmax_‰l_g­
;

67 
	mkey_ty³
;

68 
	m¡©e
;

70 
d¬¿y
 
	m£rv”s
;

71 
d¬¿y
 
	m»¶ys
;

73 
	m£rv”s_couÁ
;

74 
	m»¶ys_couÁ
;

75 
	mnÙ_exi¡_couÁ
;

76 } 
	tcheck_un™
;

78 
	sd©a_check”
 {

79 
±h»ad_t
 
	mth»ad_id
;

81 
«Ev’tLoİ
 *
	m–
;

82 
	mhz
;

83 
	müÚloİs
;

85 
sds
 
	m‹¡_rg‘_groups
;

87 
	mæags
;

88 
sds
 
	mcheck”
;

89 
cÚn_cÚ‹xt
 *
	mma¡”
;

91 
	mcheck_begš_time
;

92 } 
	td©a_check”
;

94 
d©a_check”
 
	gdc
;

98 
	gÏ¡_check_begš_time
;

100 
d¬¿y
 *
	gcdts
 = 
NULL
;

102 
check_un™
 *
	$check_un™_ü—‹
()

104 
check_un™
 *
cun™
;

106 
cun™
 = 
	`m®loc
((*cunit));

107 ià(
cun™
 =ğ
NULL
) {

108  
NULL
;

111 
cun™
->
cdt
 = 
NULL
;

113 
cun™
->
Êode
 = 
NULL
;

115 
cun™
->
key
 = 
NULL
;

116 
cun™
->
key_³rsi¡
 = 0;

117 
cun™
->
mš_‰l
 = 0;

118 
cun™
->
max_‰l_g­
 = 0;

119 
cun™
->
key_ty³
 = -1;

120 
cun™
->
¡©e
 = 
CHECK_UNIT_STATE_NULL
;

121 
	`d¬¿y_š™
(&
cun™
->
£rv”s
, 2, (
ab‹¡_£rv”
*));

122 
	`d¬¿y_š™
(&
cun™
->
»¶ys
, 2, (
»disR•ly
*));

124 
cun™
->
£rv”s_couÁ
 = 0;

125 
cun™
->
»¶ys_couÁ
 = 0;

126 
cun™
->
nÙ_exi¡_couÁ
 = 0;

128  
cun™
;

129 
	}
}

131 
	$check_un™_de¡roy
(
check_un™
 *
cun™
)

133 ià(
cun™
->
cdt
 !ğ
NULL
 && cun™->
Êode
 != NULL) {

134 
	`dli¡D–Node
(
cun™
->
cdt
->
check_un™s
,cun™->
Êode
);

135 
cun™
->
Êode
 = 
NULL
;

138 ià(
cun™
->
key
 !ğ
NULL
) {

139 
	`sdsä“
(
cun™
->
key
);

140 
cun™
->
key
 = 
NULL
;

143 
	`d¬¿y_n
(&
cun™
->
£rv”s
) > 0) {

144 
	`d¬¿y_pİ
(&
cun™
->
£rv”s
);

146 
	`d¬¿y_deš™
(&
cun™
->
£rv”s
);

148 
	`d¬¿y_n
(&
cun™
->
»¶ys
) > 0) {

149 
»disR•ly
 **
»¶y
 = 
	`d¬¿y_pİ
(&
cun™
->
»¶ys
);

150 
	`ä“R•lyObjeù
(*
»¶y
);

152 
	`d¬¿y_deš™
(&
cun™
->
»¶ys
);

154 
	`ä“
(
cun™
);

155 
	}
}

157 
	$check_cÚn_cÚ‹xt_š™
(
cÚn_cÚ‹xt
 *
cc
, *
ho¡
, 
pÜt
)

159 
cc
->
ùx
 = 
NULL
;

160 
cc
->
aùx
 = 
NULL
;

162 
cc
->
aùx
 = 
	`»disAsyncCÚÃù
(
ho¡
, 
pÜt
);

163 ià(
cc
->
aùx
 =ğ
NULL
) {

164  
VRT_ERROR
;

167  
VRT_OK
;

168 
	}
}

170 
	$check_cÚn_cÚ‹xt_deš™
(
cÚn_cÚ‹xt
 *
cc
)

172 ià(
cc
->
ùx
) {

173 
	`»disF»e
(
cc
->
ùx
);

174 
cc
->
ùx
 =ğ
NULL
;

177 ià(
cc
->
aùx
) {

178 
cc
->
aùx
->
ev
.
ş—nup
 = 
NULL
;

179 
	`»disAsyncF»e
(
cc
->
aùx
);

180 
cc
->
aùx
 =ğ
NULL
;

182 
	}
}

184 
	$cÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

185 
check_d©a_th»ad
 *
cdt
 = 
c
->
d©a
;

186 ià(
¡©us
 !ğ
REDIS_OK
) {

187 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

193 
	}
}

195 
	$discÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

196 
check_d©a_th»ad
 *
cdt
 = 
c
->
d©a
;

197 ià(
¡©us
 !ğ
REDIS_OK
) {

198 
	`‹¡_log_out
("E¼Ü: %s\n", 
c
->
”r¡r
);

205 
	}
}

207 
	$sÜt_»¶ys_if_Ãeded
(
check_un™
 *
cun™
)

209 
¡•
 = 0, 
idx_cmp
 = 0;

211 ià(
cun™
->
key_ty³
 =ğ
REDIS_SET
) {

212 
¡•
 = 1;

213 } ià(
cun™
->
key_ty³
 =ğ
REDIS_HASH
) {

214 
¡•
 = 2;

217 ià(
¡•
 > 0) {

218 
i
;

219 
»disR•ly
 **
»¶y
;

220 
i
 = 0; i < 
	`d¬¿y_n
(&
cun™
->
»¶ys
); i ++) {

221 
»¶y
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
, 
i
);

222 ià((*
»¶y
)->
ty³
 !ğ
REDIS_REPLY_ARRAY
)

224 
	`sÜt_¬¿y_by_¡•
((*
»¶y
)->
–em’t
, (*»¶y)->
–em’ts
,

225 
¡•
, 
idx_cmp
, 
»¶y_¡ršg_bš¬y_com·»
);

229  
VRT_OK
;

230 
	}
}

234 
	$check_»¶ys_if_§me
(
check_un™
 *
cun™
)

236 
j
;

237 
»disR•ly
 **
»¶yb
, **
»¶y
;

239 
	`sÜt_»¶ys_if_Ãeded
(
cun™
);

241 
»¶yb
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
,0);

243 
j
 = 1; j < 
cun™
->
»¶ys_couÁ
 ; j ++) {

244 
»¶y
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
,
j
);

245 ià(
	`check_two_»¶ys_if_§me
(*
»¶yb
, *
»¶y
)) {

251 
	}
}

253 
	#TTL_MISTAKE_CAN_BE_ACCEPT
 3

	)

254 
	$check_d©a_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

255 
»disR•ly
 *
»¶y
 = 
r
, *
»¶y_sub
, *
»¶y_–em
;

256 
»disR•ly
 *
»¶y_şÚe
, **
–em
;

257 
check_un™
 *
cun™
 = 
´ivd©a
;

258 
check_d©a_th»ad
 *
cdt
 = 
cun™
->cdt;

259 
cÚn_cÚ‹xt
 *
cc
;

260 
v®ue
;

261 *
”rmsg
;

262 
j
;

264 ià(
»¶y
 =ğ
NULL
) ;

266 ià(
cun™
->
¡©e
 =ğ
CHECK_UNIT_STATE_GET_EXPIRE
) {

267 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

268 
”rmsg
 = "ttl command„eplyype is‚ot integer";

269 
”rÜ
;

272 
»¶y_şÚe
 = 
	`¡—l_hœedis_»di¤•ly
(
»¶y
);

273 
–em
 = 
	`d¬¿y_push
(&
cun™
->
»¶ys
);

274 *
–em
 = 
»¶y_şÚe
;

275 
cun™
->
»¶ys_couÁ
 ++;

277 ià(
cun™
->
»¶ys_couÁ
 >ğcun™->
£rv”s_couÁ
) {

278 *
¬gv
[2];

279 
size_t
 
¬gvËn
[2];

280 
mš
, 
max
;

281 
³rsi¡
;

283 
–em
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
, 0);

284 
»¶y_–em
 = *
–em
;

285 ià(
»¶y_–em
->
š‹g”
 == -1) {

286 
³rsi¡
 = 1;

287 } ià(
»¶y_–em
->
š‹g”
 == -2) {

288 
cun™
->
nÙ_exi¡_couÁ
 ++;

289 
mš
 = 
max
 = 0;

290 } ià(
»¶y_–em
->
š‹g”
 < -2) {

291 
”rmsg
 = "ttl command„eply integer is†esshan -2";

292 
”rÜ
;

294 
mš
 = 
max
 = 
»¶y_–em
->
š‹g”
;

297 
j
 = 1; j < 
	`d¬¿y_n
(&
cun™
->
»¶ys
); j ++) {

298 
–em
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
, 
j
);

299 
»¶y_–em
 = *
–em
;

300 ià(
³rsi¡
 && 
»¶y_–em
->
š‹g”
 != -1) {

301 
”rmsg
 = "key in some server is…ersist, but others‡re‚ot";

302 
”rÜ
;

305 ià(
»¶y_–em
->
š‹g”
 == -1) {

306 ià(
³rsi¡
 != 1) {

307 
”rmsg
 = "key in some server is…ersist, but others‡re‚ot";

308 
”rÜ
;

310 } ià(
»¶y_–em
->
š‹g”
 == -2) {

311 
cun™
->
nÙ_exi¡_couÁ
 ++;

312 ià(
mš
 > 0) min = 0;

313 } ià(
»¶y_–em
->
š‹g”
 < -2) {

314 
”rmsg
 = "ttl command„eply integer is†esshan -2";

315 
”rÜ
;

317 ià(
»¶y_–em
->
š‹g”
 < 
mš
) min =„eply_elem->integer;

318 ià(
»¶y_–em
->
š‹g”
 > 
max
) max =„eply_elem->integer;

322 ià(
cun™
->
nÙ_exi¡_couÁ
 >ğcun™->
£rv”s_couÁ
) {

324 
dÚe
;

327 ià(
³rsi¡
) {

328 
cun™
->
key_³rsi¡
 = 1;

330 
cun™
->
mš_‰l
 = 
mš
;

331 
cun™
->
max_‰l_g­
 = 
max
-
mš
;

332 ià(
cun™
->
max_‰l_g­
 > 
TTL_MISTAKE_CAN_BE_ACCEPT
) {

333 
”rmsg
 = "ttl mistake isoo big between groups";

334 
”rÜ
;

339 
¬gv
[0] = "type";

340 
¬gvËn
[0] = 4;

341 
¬gv
[1] = 
cun™
->
key
;

342 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

343 
j
 = 0; j < 
	`d¬¿y_n
(&
cun™
->
£rv”s
); j ++) {

344 
ab‹¡_£rv”
 **
abs
 = 
	`d¬¿y_g‘
(&
cun™
->
£rv”s
,
j
);

345 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
((*
abs
)->
cÚn_cÚ‹xts
, 0);

347 
	`»disAsyncCommªdArgv
(
cc
->
aùx
, 
check_d©a_ÿÎback
,

348 
cun™
, 2, 
¬gv
, 
¬gvËn
);

351 
cun™
->
¡©e
 = 
CHECK_UNIT_STATE_GET_TYPE
;

352 
Ãxt_¡•
;

358 ià(
cun™
->
¡©e
 =ğ
CHECK_UNIT_STATE_GET_TYPE
) {

359 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STATUS
) {

360 
”rmsg
 = "type command„eplyype is‚ot status";

361 
”rÜ
;

364 ià(!
	`¡rcmp
(
»¶y
->
¡r
, "none")) {

366 
cun™
->
nÙ_exi¡_couÁ
 ++;

368 
»¶y_şÚe
 = 
	`¡—l_hœedis_»di¤•ly
(
»¶y
);

369 
–em
 = 
	`d¬¿y_push
(&
cun™
->
»¶ys
);

370 *
–em
 = 
»¶y_şÚe
;

371 
cun™
->
»¶ys_couÁ
 ++;

374 ià(
cun™
->
nÙ_exi¡_couÁ
 >ğcun™->
£rv”s_couÁ
) {

376 
dÚe
;

377 } ià(
cun™
->
»¶ys_couÁ
 >ğ(cun™->
£rv”s_couÁ
-cun™->
nÙ_exi¡_couÁ
)) {

378 
¬gc
;

379 **
¬gv
;

380 
size_t
 *
¬gvËn
;

382 ià(
cun™
->
nÙ_exi¡_couÁ
 > 0 && cun™->
key_³rsi¡
) {

383 
”rmsg
 = "key is…ersist, but‚otƒxist in some servers";

384 
”rÜ
;

387 ià(
	`check_»¶ys_if_§me
(
cun™
) != 1) {

388 
”rmsg
 = "type command„eplys‡re‚ot same";

389 
”rÜ
;

392 
–em
 = 
	`d¬¿y_g‘
(&
cun™
->
»¶ys
,0);

393 ià(!
	`¡rcmp
((*
–em
)->
¡r
,"string")) {

394 
cun™
->
key_ty³
 = 
REDIS_STRING
;

396 
¬gc
 = 2;

397 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

398 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

400 
¬gv
[0] = "get";

401 
¬gvËn
[0] = 3;

402 
¬gv
[1] = 
cun™
->
key
;

403 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

404 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"list")) {

405 
cun™
->
key_ty³
 = 
REDIS_LIST
;

407 
¬gc
 = 4;

408 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

409 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

411 
¬gv
[0] = "lrange";

412 
¬gvËn
[0] = 6;

413 
¬gv
[1] = 
cun™
->
key
;

414 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

415 
¬gv
[2] = "0";

416 
¬gvËn
[2] = 1;

417 
¬gv
[3] = "-1";

418 
¬gvËn
[3] = 2;

419 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"set")) {

420 
cun™
->
key_ty³
 = 
REDIS_SET
;

422 
¬gc
 = 2;

423 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

424 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

426 
¬gv
[0] = "smembers";

427 
¬gvËn
[0] = 8;

428 
¬gv
[1] = 
cun™
->
key
;

429 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

430 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"zset")) {

431 
cun™
->
key_ty³
 = 
REDIS_ZSET
;

433 
¬gc
 = 4;

434 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

435 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

437 
¬gv
[0] = "zrange";

438 
¬gvËn
[0] = 6;

439 
¬gv
[1] = 
cun™
->
key
;

440 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

441 
¬gv
[2] = "0";

442 
¬gvËn
[2] = 1;

443 
¬gv
[3] = "-1";

444 
¬gvËn
[3] = 2;

445 } ià(!
	`¡rcmp
((*
–em
)->
¡r
,"hash")) {

446 
cun™
->
key_ty³
 = 
REDIS_HASH
;

448 
¬gc
 = 2;

449 
¬gv
 = 
	`m®loc
(
¬gc
*(*));

450 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

452 
¬gv
[0] = "hgetall";

453 
¬gvËn
[0] = 7;

454 
¬gv
[1] = 
cun™
->
key
;

455 
¬gvËn
[1] = 
	`sd¦’
(
cun™
->
key
);

457 
”rmsg
 = "not supported keyype";

458 
”rÜ
;

462 
j
 = 0; j < 
	`d¬¿y_n
(&
cun™
->
£rv”s
); j ++) {

463 
ab‹¡_£rv”
 **
abs
 = 
	`d¬¿y_g‘
(&
cun™
->
£rv”s
,
j
);

464 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
((*
abs
)->
cÚn_cÚ‹xts
, 0);

466 
	`»disAsyncCommªdArgv
(
cc
->
aùx
, 
check_d©a_ÿÎback
,

467 
cun™
, 
¬gc
, 
¬gv
, 
¬gvËn
);

469 
	`ä“
(
¬gv
);

470 
	`ä“
(
¬gvËn
);

472 
cun™
->
¡©e
 = 
CHECK_UNIT_STATE_GET_VALUE
;

473 
Ãxt_¡•
;

479 ià(
cun™
->
¡©e
 =ğ
CHECK_UNIT_STATE_GET_VALUE
) {

480 
nÙ_exi¡
 = 0;

481 ià(
cun™
->
key_ty³
 =ğ
REDIS_STRING
) {

482 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_NIL
) {

483 
nÙ_exi¡
 = 1;

484 } ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

485 
”rmsg
 = "get command„eplyype is‚ot string";

486 
”rÜ
;

488 } ià(
cun™
->
key_ty³
 =ğ
REDIS_LIST
) {

489 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

490 
”rmsg
 = "lrange command„eplyype is‚ot‡rray";

491 
”rÜ
;

493 ià(
»¶y
->
–em’ts
 == 0) {

494 
nÙ_exi¡
 = 1;

496 } ià(
cun™
->
key_ty³
 =ğ
REDIS_SET
) {

497 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

498 
”rmsg
 = "smembers command„eplyype is‚ot‡rray";

499 
”rÜ
;

501 ià(
»¶y
->
–em’ts
 == 0) {

502 
nÙ_exi¡
 = 1;

504 } ià(
cun™
->
key_ty³
 =ğ
REDIS_ZSET
) {

505 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

506 
”rmsg
 = "zrange command„eplyype is‚ot‡rray";

507 
”rÜ
;

509 ià(
»¶y
->
–em’ts
 == 0) {

510 
nÙ_exi¡
 = 1;

512 } ià(
cun™
->
key_ty³
 =ğ
REDIS_HASH
) {

513 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

514 
”rmsg
 = "hgetall command„eplyype is‚ot‡rray";

515 
”rÜ
;

517 ià(
»¶y
->
–em’ts
 == 0) {

518 
nÙ_exi¡
 = 1;

521 
”rmsg
 = "not supported keyype";

522 
”rÜ
;

525 ià(
nÙ_exi¡
) {

526 
cun™
->
nÙ_exi¡_couÁ
 ++;

528 
»¶y_şÚe
 = 
	`¡—l_hœedis_»di¤•ly
(
»¶y
);

529 
–em
 = 
	`d¬¿y_push
(&
cun™
->
»¶ys
);

530 *
–em
 = 
»¶y_şÚe
;

531 
cun™
->
»¶ys_couÁ
 ++;

534 ià(
cun™
->
nÙ_exi¡_couÁ
 >ğcun™->
£rv”s_couÁ
) {

536 
dÚe
;

537 } ià(
cun™
->
»¶ys_couÁ
 >ğ(cun™->
£rv”s_couÁ
-cun™->
nÙ_exi¡_couÁ
)) {

538 ià(
cun™
->
nÙ_exi¡_couÁ
 > 0 && cun™->
key_³rsi¡
) {

539 
”rmsg
 = "key is…ersist, but‚otƒxist in some servers";

540 
”rÜ
;

543 ià(
	`check_»¶ys_if_§me
(
cun™
) != 1) {

544 
”rmsg
 = "values for„eply‡re‚ot same";

545 
”rÜ
;

548 
dÚe
;

554 
dÚe
:

556 
	`check_un™_de¡roy
(
cun™
);

560 
Ãxt_¡•
:

562 
cun™
->
»¶ys_couÁ
 = 0;

563 
cun™
->
nÙ_exi¡_couÁ
 = 0;

564 
	`d¬¿y_n
(&
cun™
->
»¶ys
) > 0) {

565 
–em
 = 
	`d¬¿y_pİ
(&
cun™
->
»¶ys
);

566 
	`ä“R•lyObjeù
(*
–em
);

571 
”rÜ
:

573 
	`log_hexdump
(
LOG_ERR
,
cun™
->
key
,
	`sd¦’
(cunit->key),

575 
”rmsg
,

576 
cdt
->
sÿn_group_idx
,

577 
	`sd¦’
(
cun™
->
key
),
	`g‘_key_ty³_¡ršg
(cun™->
key_ty³
));

579 
	`check_un™_de¡roy
(
cun™
);

580 
	}
}

582 
	$¡¬t_check_d©a
(*
key
, 
size_t
 
keyËn
, 
check_d©a_th»ad
 *
cdt
)

584 
check_un™
 *
cu
 = 
	`check_un™_ü—‹
();

585 
j
;

587 
cu
->
cdt
 = cdt;

588 
cu
->
key
 = 
	`sd¢ewËn
(key,
keyËn
);

589 
	`dli¡Push
(
cdt
->
check_un™s
,
cu
);

590 
cu
->
Êode
 = 
	`dli¡La¡
(
cdt
->
check_un™s
);

592 
j
 = 0; j < 
	`d¬¿y_n
(
cdt
->
abgs
); j ++) {

593 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, 
j
);

594 
ab‹¡_£rv”
 *
abs
 = 
abg
->
	`g‘_back’d_£rv”
×bg,
key
,
keyËn
);

595 
ab‹¡_£rv”
 **
–em
 = 
	`d¬¿y_push
(&
cu
->
£rv”s
);

596 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
, 0);

597 *
¬gv
[2];

598 
size_t
 
¬gvËn
[2];

600 *
–em
 = 
abs
;

601 
cu
->
£rv”s_couÁ
 ++;

604 
¬gv
[0] = "ttl";

605 
¬gvËn
[0] = 3;

606 
¬gv
[1] = 
key
;

607 
¬gvËn
[1] = 
keyËn
;

608 
	`»disAsyncCommªdArgv
(
cc
->
aùx
, 
check_d©a_ÿÎback
,

609 
cu
, 2, 
¬gv
, 
¬gvËn
);

611 
cu
->
¡©e
 = 
CHECK_UNIT_STATE_GET_EXPIRE
;

613  
VRT_OK
;

614 
	}
}

616 
	$sÿn_fÜ_check_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

617 
»disR•ly
 *
»¶y
 = 
r
, *
»¶y_sub
, *
»¶y_–em
;

618 
ab‹¡_£rv”
 *
abs
 = 
´ivd©a
;

619 
check_d©a_th»ad
 *
cdt
 = 
abs
->
d©a
;

620 
cÚn_cÚ‹xt
 *
cc
;

621 
v®ue
;

622 
size_t
 
k
;

624 ià(
»¶y
 =ğ
NULL
) ;

627 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

631 ià(
»¶y
->
–em’ts
 != 2) {

635 
»¶y_sub
 = 
»¶y
->
–em’t
[0];

636 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

637 
	`¡ršg2Î
(
»¶y_sub
->
¡r
,»¶y_sub->
Ën
,&
v®ue
) != 1) {

641 
cdt
->
cursÜ
 = 
v®ue
;

643 
»¶y_sub
 = 
»¶y
->
–em’t
[1];

644 ià(
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

648 
k
 = 0; k < 
»¶y_sub
->
–em’ts
; k ++) {

649 
»¶y_–em
 = 
»¶y_sub
->
–em’t
[
k
];

650 ià(
»¶y_–em
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

654 
	`¡¬t_check_d©a
(
»¶y_–em
->
¡r
,»¶y_–em->
Ën
,
cdt
);

657 
cdt
->
sÿn_keys_couÁ
 +ğ
»¶y_sub
->
–em’ts
;

659 ià(
cdt
->
cursÜ
 == 0) {

660 
cdt
->
sÿn_fšished_couÁ
 ++;

662 
	}
}

664 
	gcheck_d©a_th»ads_fšished_couÁ
 = 0;

665 
	$Úe_check_d©a_th»ad_fšished
()

667 
	`upd©e_¡©e_add
(
check_d©a_th»ads_fšished_couÁ
,1);

668 
	}
}

670 
	$®l_check_d©a_th»ads_fšished
()

672 
fšished_couÁ
;

673 
	`upd©e_¡©e_g‘
(
check_d©a_th»ads_fšished_couÁ
,&
fšished_couÁ
);

675 ià(
fšished_couÁ
 >ğ
	`d¬¿y_n
(
cdts
)) {

680 
	}
}

682 
	$check_d©a_th»ad_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

684 
check_d©a_th»ad
 *
cdt
 = 
ş›ÁD©a
;

686 
	`ASSERT
(
ev’tLoİ
 =ğ
cdt
->
–
);

688 ià(
cdt
->
sÿn_fšished_couÁ
 >ğ
	`d¬¿y_n
(cdt->
sÿn_£rv”s
)) {

689 ià(
	`dli¡L’gth
(
cdt
->
check_un™s
) == 0) {

690 
	`«Stİ
(
cdt
->
–
);

691 
	`Úe_check_d©a_th»ad_fšished
();

692 
	`log_debug
(
LOG_NOTICE
, "One checkhread finished,scaned %lld keys",

693 
cdt
->
sÿn_keys_couÁ
);

696 } ià(
	`dli¡L’gth
(
cdt
->
check_un™s
) < 3000) {

697 
ab‹¡_group
 *
abg
;

698 
ab‹¡_£rv”
 **
abs
;

699 *
idx
;

700 
cÚn_cÚ‹xt
 *
cc
;

702 
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, cdt->
sÿn_group_idx
);

703 
abs
 = 
	`d¬¿y_g‘
(
cdt
->
sÿn_£rv”s
, cdt->
sÿn_fšished_couÁ
);

704 
cc
 = 
	`d¬¿y_g‘
((*
abs
)->
cÚn_cÚ‹xts
, 0);

706 
	`»disAsyncCommªd
(
cc
->
aùx
, 
sÿn_fÜ_check_ÿÎback
,

707 *
abs
, "sÿÀ%Îd couÁ 1000", 
cdt
->
cursÜ
);

710 
cdt
->
üÚloİs
 ++;

711  1000/
cdt
->
hz
;

712 
	}
}

714 
	$check_d©a_th»ad_š™
(
check_d©a_th»ad
 *
cdt
, *
‹¡_rg‘_groups
)

716 
i
, 
j
, 
k
;

718 
cdt
->
id
 = 0;

719 
cdt
->
th»ad_id
 = 0;

720 
cdt
->
–
 = 
NULL
;

721 
cdt
->
hz
 = 200;

722 
cdt
->
üÚloİs
 = 0;

724 
cdt
->
abgs
 = 
NULL
;

725 
cdt
->
sÿn_group_idx
 = 0;

726 
cdt
->
sÿn_£rv”s
 = 
NULL
;

727 
cdt
->
sÿn_fšished_couÁ
 = 0;

728 
cdt
->
cursÜ
 = 0;

729 
cdt
->
check_un™s
 = 
NULL
;

731 
cdt
->
check_begš_time
 = 0;

732 
cdt
->
sÿn_keys_couÁ
 = 0;

734 
cdt
->
–
 = 
	`«C»©eEv’tLoİ
(200);

735 ià(
cdt
->
–
 =ğ
NULL
) {

736  
VRT_ERROR
;

739 
cdt
->
sÿn_£rv”s
 = 
	`d¬¿y_ü—‹
(1,(
ab‹¡_£rv”
*));

741 
cdt
->
abgs
 = 
	`ab‹¡_groups_ü—‹
(
‹¡_rg‘_groups
);

742 ià(
cdt
->
abgs
 =ğ
NULL
) {

743  
VRT_ERROR
;

747 
i
 = 0; i < 
	`d¬¿y_n
(
cdt
->
abgs
); i ++) {

748 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, 
i
);

749 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

750 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

751 
abs
->
cÚn_cÚ‹xts
 = 
	`d¬¿y_ü—‹
(1, (
cÚn_cÚ‹xt
));

752 
k
 = 0; k < 1; k ++) {

753 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_push
(
abs
->
cÚn_cÚ‹xts
);

754 ià(
	`check_cÚn_cÚ‹xt_š™
(
cc
,
abs
->
ho¡
,abs->
pÜt
è!ğ
VRT_OK
) {

755  
VRT_ERROR
;

757 
cc
->
aùx
->
d©a
 = 
cdt
;

758 
	`»disAeA‰ach
(
cdt
->
–
, 
cc
->
aùx
);

759 
	`»disAsyncS‘CÚÃùC®lback
(
cc
->
aùx
,
cÚÃù_ÿÎback
);

760 
	`»disAsyncS‘DiscÚÃùC®lback
(
cc
->
aùx
,
discÚÃù_ÿÎback
);

765 ià(
	`«C»©eTimeEv’t
(
cdt
->
–
, 1, 
check_d©a_th»ad_üÚ
, cdt, 
NULL
è=ğ
AE_ERR
) {

766  
VRT_ERROR
;

769 
cdt
->
check_un™s
 = 
	`dli¡C»©e
();

771  
VRT_OK
;

772 
	}
}

774 
	$check_d©a_th»ad_deš™
(
check_d©a_th»ad
 *
cdt
)

776 ià(
cdt
->
–
) {

777 
	`«D–‘eEv’tLoİ
(
cdt
->
–
);

778 
cdt
->
–
 = 
NULL
;

781 ià(
cdt
->
sÿn_£rv”s
) {

782 
	`d¬¿y_n
(
cdt
->
sÿn_£rv”s
) > 0) {

783 
	`d¬¿y_pİ
(
cdt
->
sÿn_£rv”s
);

785 
	`d¬¿y_de¡roy
(
cdt
->
sÿn_£rv”s
);

786 
cdt
->
sÿn_£rv”s
 = 
NULL
;

789 ià(
cdt
->
abgs
) {

790 
i
, 
j
, 
k
;

792 
i
 = 0; i < 
	`d¬¿y_n
(
cdt
->
abgs
); i ++) {

793 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, 
i
);

794 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

795 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

796 
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) > 0) {

797 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_pİ
(
abs
->
cÚn_cÚ‹xts
);

798 
	`check_cÚn_cÚ‹xt_deš™
(
cc
);

803 
	`ab‹¡_groups_de¡roy
(
cdt
->
abgs
);

804 
cdt
->
abgs
 = 
NULL
;

807 ià(
cdt
->
check_un™s
) {

808 
	`dli¡L’gth
(
cdt
->
check_un™s
) > 0) {

809 
check_un™
 *
cu
 = 
	`dli¡Pİ
(
cdt
->
check_un™s
);

810 
	`check_un™_de¡roy
(
cu
);

812 
	`dli¡R–—£
(
cdt
->
check_un™s
);

813 
cdt
->
check_un™s
 = 
NULL
;

815 
	}
}

817 
	gcheckšg_d©a
;

818 
	$checkšg_d©a_Ü_nÙ
()

820 
checkšg
;

822 
	`upd©e_¡©e_g‘
(
checkšg_d©a
,&
checkšg
);

824 ià(
checkšg
)  1;

826 
	}
}

828 
	gcheck_d©a_th»ads_couÁ
 = 8;

829 
de¡roy_check_d©a_th»ads
();

834 
	$ü—‹_check_d©a_th»ads
()

836 
d¬¿y
 *
abgs
 = 
NULL
;

837 
ab‹¡_group
 *
abg
;

838 
groups_couÁ
;

839 
th»ads_couÁ_³r_group
;

840 
check_th»ad_id
 = 0;

841 
i
, 
j
, 
k
;

843 ià(
cdts
 !ğ
NULL
) {

844 
	`de¡roy_check_d©a_th»ads
();

847 
cdts
 = 
	`d¬¿y_ü—‹
(2,(
check_d©a_th»ad
));

848 ià(
cdts
 =ğ
NULL
) {

852 
abgs
 = 
	`ab‹¡_groups_ü—‹
(
dc
.
‹¡_rg‘_groups
);

853 ià(
abgs
 =ğ
NULL
) {

857 
groups_couÁ
 = 
	`d¬¿y_n
(
abgs
);

858 ià(
groups_couÁ
 == 1) {

859 
	`ab‹¡_groups_de¡roy
(
abgs
);

863 
th»ads_couÁ_³r_group
 = 
check_d©a_th»ads_couÁ
/
groups_couÁ
;

864 ià(
th»ads_couÁ_³r_group
 <= 0) {

865 
th»ads_couÁ_³r_group
 = 1;

868 
i
 = 0; i < 
groups_couÁ
; i ++) {

869 
£rv”s_couÁ
, 
th»ads_couÁ
;

870 
£rv”s_couÁ_³r_th»ad
;

871 
£rv”_idx
 = 0;

873 
th»ads_couÁ
 = 
th»ads_couÁ_³r_group
;

874 
abg
 = 
	`d¬¿y_g‘
(
abgs
, 
i
);

875 
£rv”s_couÁ
 = 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
);

876 
£rv”s_couÁ_³r_th»ad
 = 
£rv”s_couÁ
/
th»ads_couÁ
;

877 ià(
£rv”s_couÁ_³r_th»ad
 == 0) {

878 
£rv”s_couÁ_³r_th»ad
 = 1;

879 
th»ads_couÁ
 = 
£rv”s_couÁ
;

881 
j
 = 0; j < 
th»ads_couÁ
; j ++) {

882 
ab‹¡_£rv”
 *
abs
;

884 
check_d©a_th»ad
 *
cdt
 = 
	`d¬¿y_push
(
cdts
);

885 
	`check_d©a_th»ad_š™
(
cdt
,
dc
.
‹¡_rg‘_groups
);

886 
cdt
->
id
 = 
check_th»ad_id
++;

887 
cdt
->
sÿn_group_idx
 = 
i
;

889 
abg
 = 
	`d¬¿y_g‘
(
cdt
->
abgs
, cdt->
id
);

891 
k
 = 0; k < 
£rv”s_couÁ_³r_th»ad
; k ++) {

892 
ab‹¡_£rv”
 **
–em
 = 
	`d¬¿y_push
(
cdt
->
sÿn_£rv”s
);

893 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
£rv”_idx
++);

894 
abs
->
d©a
 = 
cdt
;

895 *
–em
 = 
abs
;

898 ià(
j
 =ğ
th»ads_couÁ
-1) {

899 
£rv”_idx
 < 
£rv”s_couÁ
) {

900 
ab‹¡_£rv”
 **
–em
 = 
	`d¬¿y_push
(
cdt
->
sÿn_£rv”s
);

901 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
£rv”_idx
++);

902 
abs
->
d©a
 = 
cdt
;

903 *
–em
 = 
abs
;

909 
	`ab‹¡_groups_de¡roy
(
abgs
);

912 
	}
}

914 
	$de¡roy_check_d©a_th»ads
()

916 ià(
cdts
 !ğ
NULL
) {

917 
	`d¬¿y_n
(
cdts
) > 0) {

918 
check_d©a_th»ad
 *
cdt
 = 
	`d¬¿y_pİ
(
cdts
);

919 
	`check_d©a_th»ad_deš™
(
cdt
);

921 
	`d¬¿y_de¡roy
(
cdts
);

922 
cdts
 = 
NULL
;

924 
	}
}

926 *
	$check_d©a_th»ad_run
(*
¬gs
)

928 
check_d©a_th»ad
 *
cdt
 = 
¬gs
;

930 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

932 
	`«Maš
(
cdt
->
–
);

934  
NULL
;

935 
	}
}

937 
	$¡¬t_check_d©a_th»ads
()

939 
j
;

940 
check_d©a_th»ad
 *
cdt
;

942 ià(
cdts
 =ğ
NULL
è 
VRT_ERROR
;

944 
j
 = 0; j < 
	`d¬¿y_n
(
cdts
); j ++) {

945 
±h»ad_©Œ_t
 
©Œ
;

947 
cdt
 = 
	`d¬¿y_g‘
(
cdts
, 
j
);

948 
	`±h»ad_©Œ_š™
(&
©Œ
);

949 
	`±h»ad_ü—‹
(&
cdt
->
th»ad_id
,

950 &
©Œ
, 
check_d©a_th»ad_run
, 
cdt
);

953  
VRT_OK
;

954 
	}
}

956 
	$begš_check_d©a
()

958 
	`ü—‹_check_d©a_th»ads
();

959 
	`¡¬t_check_d©a_th»ads
();

961 
	`upd©e_¡©e_£t
(
checkšg_d©a
,1);

963  
VRT_OK
;

964 
	}
}

966 
	$’d_check_d©a
()

968 
	`upd©e_¡©e_£t
(
check_d©a_th»ads_fšished_couÁ
,0);

969 
	`upd©e_¡©e_£t
(
checkšg_d©a
,0);

970 
	}
}

972 
	$d©a_check”_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

974 
	`ASSERT
(
ev’tLoİ
 =ğ
dc
.
–
);

976 ià(!
	`‹¡_if_Ãed_·u£
(è&& 
	`v¹_£c_now
()-
Ï¡_‹¡_begš_time
 > 
‹¡_š‹rv®
) {

977 
	`‹¡_Ãed_to_·u£
();

978 
	`log_nÙiû
("Start…auseheest...");

981 ià(!
	`checkšg_d©a_Ü_nÙ
(è&& 
	`‹¡_if_Ãed_·u£
() &&

982 
	`®l_th»ads_·u£d
()) {

984 
	`log_nÙiû
("Finished…auseheest. Tested %lld commands, %lldƒrror„eply(%.2f%%).",

985 
	`g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
(),

986 
	`g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
(),

987 ()
	`g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
()/()
	`g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
()*100);

988 
	`»£t_tÙ®_couÁ_³r_cyşe
();

989 
	`¦“p
(1);

990 
Ï¡_check_begš_time
 = 
	`v¹_£c_now
();

991 
	`begš_check_d©a
();

992 
	`log_nÙiû
("Start checkinghe data...");

995 ià(
	`checkšg_d©a_Ü_nÙ
(è&& 
	`®l_check_d©a_th»ads_fšished
()) {

996 
	`’d_check_d©a
();

997 
	`log_nÙiû
("Finished checkinghe data\n");

998 
	`‹¡_ÿn_cÚtšue
();

999 
Ï¡_‹¡_begš_time
 = 
	`v¹_£c_now
();

1002 
dc
.
üÚloİs
 ++;

1003  1000/
dc
.
hz
;

1004 
	}
}

1006 
	$v¹_d©a_check”_š™
(*
check”
, *
‹¡_rg‘_groups
)

1008 
»t
;

1010 
dc
.
th»ad_id
 = 0;

1011 
dc
.
–
 = 
NULL
;

1012 
dc
.
hz
 = 10;

1013 
dc
.
üÚloİs
 = 0;

1014 
dc
.
‹¡_rg‘_groups
 = 
NULL
;

1015 
dc
.
æags
 = 
CHECK_DATA_FLAG_NONE
;

1016 
dc
.
check”
 = 
NULL
;

1017 
dc
.
ma¡”
 = 
NULL
;

1018 
dc
.
check_begš_time
 = 0;

1020 
dc
.
–
 = 
	`«C»©eEv’tLoİ
(10);

1021 ià(
dc
.
–
 =ğ
NULL
) {

1022  
VRT_ERROR
;

1025 ià(
	`«C»©eTimeEv’t
(
dc
.
–
, 1, 
d©a_check”_üÚ
, 
NULL
, NULLè=ğ
AE_ERR
) {

1026  
VRT_ERROR
;

1029 
dc
.
‹¡_rg‘_groups
 = 
	`sd¢ew
(test_target_groups);

1031 
dc
.
check”
 = 
	`sd¢ew
(checker);

1033 ià(!
	`¡rÿ£cmp
(
check”
,"myself")) {

1034 
dc
.
æags
 |ğ
CHECK_DATA_FLAG_MASTER
;

1036 
sds
 
ho¡
;

1037 
pÜt
;

1038 
dc
.
æags
 |ğ
CHECK_DATA_FLAG_SLAVE
;

1039 
ho¡
 = 
	`g‘_ho¡_pÜt_äom_add»ss_¡ršg
(
check”
, &
pÜt
);

1040 ià(
ho¡
 =ğ
NULL
) {

1041  
VRT_ERROR
;

1043 
dc
.
ma¡”
 = 
	`m®loc
((
cÚn_cÚ‹xt
));

1044 
»t
 = 
	`check_cÚn_cÚ‹xt_š™
(
dc
.
ma¡”
, 
ho¡
, 
pÜt
);

1045 
	`sdsä“
(
ho¡
);

1046 ià(
»t
 !ğ
VRT_OK
) {

1047  
VRT_ERROR
;

1051  
VRT_OK
;

1052 
	}
}

1054 
	$v¹_d©a_check”_deš™
()

1056 ià(
dc
.
–
) {

1057 
	`«D–‘eEv’tLoİ
(
dc
.
–
);

1058 
dc
.
–
 = 
NULL
;

1061 ià(
dc
.
‹¡_rg‘_groups
) {

1062 
	`sdsä“
(
dc
.
‹¡_rg‘_groups
);

1063 
dc
.
‹¡_rg‘_groups
 = 
NULL
;

1066 ià(
dc
.
check”
) {

1067 
	`sdsä“
(
dc
.
check”
);

1068 
dc
.
check”
 = 
NULL
;

1071 ià(
dc
.
ma¡”
) {

1072 
	`check_cÚn_cÚ‹xt_deš™
(
dc
.
ma¡”
);

1073 
	`ä“
(
dc
.
ma¡”
);

1074 
dc
.
ma¡”
 = 
NULL
;

1077 
	`de¡roy_check_d©a_th»ads
();

1078 
	}
}

1080 *
	$v¹_d©a_check”_run
(*
¬gs
)

1082 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

1084 
	`«Maš
(
dc
.
–
);

1086  
NULL
;

1087 
	}
}

1089 
	$v¹_¡¬t_d©a_check”
()

1091 
±h»ad_©Œ_t
 
©Œ
;

1092 
	`±h»ad_©Œ_š™
(&
©Œ
);

1093 
	`±h»ad_ü—‹
(&
dc
.
th»ad_id
,

1094 &
©Œ
, 
v¹_d©a_check”_run
, 
NULL
);

1095  
VRT_OK
;

1096 
	}
}

1098 
	$v¹_wa™_d©a_check”
()

1100 
	`±h»ad_još
(
dc
.
th»ad_id
, 
NULL
);

1102  
VRT_OK
;

1103 
	}
}

1105 
	g‹¡_Ãed_·u£
 = 0;

1107 
	$‹¡_if_Ãed_·u£
()

1109 
Ãed_·u£
;

1111 
	`upd©e_¡©e_g‘
(
‹¡_Ãed_·u£
,&
Ãed_·u£
);

1113 ià(
Ãed_·u£
)  1;

1115 
	}
}

1117 
	$‹¡_ÿn_cÚtšue
()

1119 
	`upd©e_¡©e_£t
(
‹¡_Ãed_·u£
,0);

1120 
	`upd©e_¡©e_£t
(
´oduû_th»ads_·u£_fšished_couÁ
,0);

1121 
	`upd©e_¡©e_£t
(
di¥©ch_th»ads_·u£_fšished_couÁ
,0);

1122 
	`upd©e_¡©e_£t
(
back’d_th»ads_·u£_fšished_couÁ
,0);

1123 
	}
}

1125 
	$‹¡_Ãed_to_·u£
()

1127 
	`upd©e_¡©e_£t
(
‹¡_Ãed_·u£
,1);

1128 
	}
}

1130 
	$Úe_´oduû_th»ad_·u£d
()

1132 
	`upd©e_¡©e_add
(
´oduû_th»ads_·u£_fšished_couÁ
,1);

1133 
	}
}

1135 
	$Úe_di¥©ch_th»ad_·u£d
()

1137 
	`upd©e_¡©e_add
(
di¥©ch_th»ads_·u£_fšished_couÁ
,1);

1138 
	}
}

1140 
	$Úe_back’d_th»ad_·u£d
()

1142 
	`upd©e_¡©e_add
(
back’d_th»ads_·u£_fšished_couÁ
,1);

1143 
	}
}

1145 
	$®l_´oduû_th»ads_·u£d
()

1147 
·u£d_th»ads
;

1149 
	`upd©e_¡©e_g‘
(
´oduû_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1150 ià(
·u£d_th»ads
 < 
´oduû_d©a_th»ads_couÁ
) {

1155 
	}
}

1157 
	$®l_di¥©ch_th»ads_·u£d
()

1159 
·u£d_th»ads
;

1161 
	`upd©e_¡©e_g‘
(
di¥©ch_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1162 ià(
·u£d_th»ads
 < 
di¥©ch_d©a_th»ads_couÁ
) {

1167 
	}
}

1169 
	$®l_back’d_th»ads_·u£d
()

1171 
·u£d_th»ads
;

1173 
	`upd©e_¡©e_g‘
(
back’d_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1174 ià(
·u£d_th»ads
 < 
back’d_th»ads_couÁ
) {

1179 
	}
}

1181 
	$®l_th»ads_·u£d
()

1183 
·u£d_th»ads
;

1185 
	`upd©e_¡©e_g‘
(
´oduû_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1186 ià(
·u£d_th»ads
 < 
´oduû_d©a_th»ads_couÁ
) {

1190 
	`upd©e_¡©e_g‘
(
di¥©ch_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1191 ià(
·u£d_th»ads
 < 
di¥©ch_d©a_th»ads_couÁ
) {

1195 
	`upd©e_¡©e_g‘
(
back’d_th»ads_·u£_fšished_couÁ
,&
·u£d_th»ads
);

1196 ià(
·u£d_th»ads
 < 
back’d_th»ads_couÁ
) {

1201 
	}
}

	@tests/vrt_check_data.h

1 #iâdeà
_VRT_CHECK_DATA_H_


2 
	#_VRT_CHECK_DATA_H_


	)

4 
v¹_d©a_check”_š™
(*
check”
, *
‹¡_rg‘_groups
);

5 
v¹_d©a_check”_deš™
();

7 
v¹_¡¬t_d©a_check”
();

8 
v¹_wa™_d©a_check”
();

10 
‹¡_if_Ãed_·u£
();

11 
‹¡_ÿn_cÚtšue
();

12 
‹¡_Ãed_to_·u£
();

14 
Úe_´oduû_th»ad_·u£d
();

15 
Úe_di¥©ch_th»ad_·u£d
();

16 
Úe_back’d_th»ad_·u£d
();

18 
®l_´oduû_th»ads_·u£d
();

19 
®l_di¥©ch_th»ads_·u£d
();

20 
®l_back’d_th»ads_·u£d
();

21 
®l_th»ads_·u£d
();

	@tests/vrt_check_data.h

1 #iâdeà
_VRT_CHECK_DATA_H_


2 
	#_VRT_CHECK_DATA_H_


	)

4 
v¹_d©a_check”_š™
(*
check”
, *
‹¡_rg‘_groups
);

5 
v¹_d©a_check”_deš™
();

7 
v¹_¡¬t_d©a_check”
();

8 
v¹_wa™_d©a_check”
();

10 
‹¡_if_Ãed_·u£
();

11 
‹¡_ÿn_cÚtšue
();

12 
‹¡_Ãed_to_·u£
();

14 
Úe_´oduû_th»ad_·u£d
();

15 
Úe_di¥©ch_th»ad_·u£d
();

16 
Úe_back’d_th»ad_·u£d
();

18 
®l_´oduû_th»ads_·u£d
();

19 
®l_di¥©ch_th»ads_·u£d
();

20 
®l_back’d_th»ads_·u£d
();

21 
®l_th»ads_·u£d
();

	@tests/vrt_dispatch_data.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

12 
	~<async.h
>

13 
	~<ad­‹rs/«.h
>

15 
	~<dhashk™.h
>

16 
	~<dli¡.h
>

17 
	~<dmtqueue.h
>

18 
	~<dlog.h
>

20 
	~<v¹_ut.h
>

21 
	~<v¹_public.h
>

22 
	~<v¿b‹¡.h
>

23 
	~<v¹_di¥©ch_d©a.h
>

24 
	~<v¹_´oduû_d©a.h
>

26 
	gdi¥©ch_d©a_th»ads_couÁ
;

27 
d¬¿y
 *
	gdi¥©ch_d©a_th»ads
 = 
NULL
;

29 
	gdi¥©ch_th»ads_·u£_fšished_couÁ
;

31 
	gtÙ®_‹¡ed_commªds_couÁ_³r_cyşe
 = 0;

32 
	gtÙ®_»¶y_”r_couÁ_³r_cyşe
 = 0;

33 
	gtÙ®_‹¡ed_commªds_couÁ
 = 0;

34 
	gtÙ®_»¶y_”r_couÁ
 = 0;

36 
	$g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
()

38 
couÁ
;

39 
	`upd©e_¡©e_g‘
(
tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
,&
couÁ
);

40  
couÁ
;

41 
	}
}

43 
	$g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
()

45 
couÁ
;

46 
	`upd©e_¡©e_g‘
(
tÙ®_»¶y_”r_couÁ_³r_cyşe
,&
couÁ
);

47  
couÁ
;

48 
	}
}

50 
	$»£t_tÙ®_couÁ_³r_cyşe
()

52 
	`upd©e_¡©e_£t
(
tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
,0);

53 
	`upd©e_¡©e_£t
(
tÙ®_»¶y_”r_couÁ_³r_cyşe
,0);

54 
	}
}

56 
	s»¶y_un™
 {

57 
	mtÙ®_couÁ
;

58 
	m»ûived_couÁ
;

59 
»disR•ly
 **
	m»¶ys
;

60 
d©a_un™
 *
	mdu
;

61 } 
	t»¶y_un™
;

63 
	$show_»¶ys_šcÚsi¡’cy_msg
(
d©a_un™
 *
du
, 
»disR•ly
 *
»¶y1
,„edisR•ly *
»¶y2
)

65 *
keyšdex
, 
numkeys
;

66 
sds
 
key
 = 
NULL
;

68 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
, du->
¬gv
, du->
¬gc
, &
numkeys
);

69 ià(
numkeys
 > 0) {

70 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

72 
	`ä“
(
keyšdex
);

74 ià(
key
) {

75 
	`log_hexdump
(
LOG_ERR
,
key
,
	`sd¦’
(key),

83 
du
->
dp
->
Çme
,

84 
»¶y1
->
ty³
, 
»¶y2
->type,

85 
»¶y1
->
ty³
==
REDIS_REPLY_STATUS
?»¶y1->
¡r
:"NULL",

86 
»¶y2
->
ty³
==
REDIS_REPLY_STATUS
?»¶y2->
¡r
:"NULL",

87 
»¶y1
->
ty³
==
REDIS_REPLY_ERROR
?»¶y1->
¡r
:"NULL",

88 
»¶y2
->
ty³
==
REDIS_REPLY_ERROR
?»¶y2->
¡r
:"NULL",

89 
»¶y1
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y1->
š‹g”
:0,

90 
»¶y2
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y2->
š‹g”
:0,

91 
»¶y1
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y1->
–em’ts
:0,

92 
»¶y2
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y2->
–em’ts
:0,

93 
	`sd¦’
(
key
));

95 
	`log_”rÜ
("%s command„eplys‡re inconsistency, "

101 
du
->
dp
->
Çme
,

102 
»¶y1
->
ty³
, 
»¶y2
->type,

103 
»¶y1
->
ty³
==
REDIS_REPLY_STATUS
?»¶y1->
¡r
:"NULL",

104 
»¶y2
->
ty³
==
REDIS_REPLY_STATUS
?»¶y2->
¡r
:"NULL",

105 
»¶y1
->
ty³
==
REDIS_REPLY_ERROR
?»¶y1->
¡r
:"NULL",

106 
»¶y2
->
ty³
==
REDIS_REPLY_ERROR
?»¶y2->
¡r
:"NULL",

107 
»¶y1
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y1->
š‹g”
:0,

108 
»¶y2
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y2->
š‹g”
:0,

109 
»¶y1
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y1->
–em’ts
:0,

110 
»¶y2
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y2->
–em’ts
:0);

113 
	}
}

115 
	$sÜt_»¶ys_if_Ãeded
(
»¶y_un™
 *
ru
)

117 
d©a_un™
 *
du
 = 
ru
->du;

118 
d©a_´oduûr
 *
dp
 = 
du
->dp;

119 
¡•
 = 0, 
idx_cmp
 = 0;

121 ià(
dp
->
cmd_ty³
&
TEST_CMD_TYPE_SET
) {

122 ià(!
	`¡rcmp
(
dp
->
Çme
,"smembers") ||

123 !
	`¡rcmp
(
dp
->
Çme
,"sunion") ||

124 !
	`¡rcmp
(
dp
->
Çme
,"sdiff") ||

125 !
	`¡rcmp
(
dp
->
Çme
,"sinter")) {

126 
¡•
 = 1;

128 } ià(
dp
->
cmd_ty³
&
TEST_CMD_TYPE_HASH
) {

129 ià(!
	`¡rcmp
(
dp
->
Çme
,"hkeys") ||

130 !
	`¡rcmp
(
dp
->
Çme
,"hvals")) {

131 
¡•
 = 1;

132 } ià(!
	`¡rcmp
(
dp
->
Çme
,"hgetall")) {

133 
¡•
 = 2;

134 
idx_cmp
 = 0;

138 ià(
¡•
 > 0) {

139 
i
;

140 
»disR•ly
 *
»¶y
;

141 
i
 = 0; i < 
ru
->
»ûived_couÁ
; i ++) {

142 
»¶y
 = 
ru
->
»¶ys
[
i
];

143 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
)

145 
	`sÜt_¬¿y_by_¡•
(
»¶y
->
–em’t
,„•ly->
–em’ts
,

146 
¡•
, 
idx_cmp
, 
»¶y_¡ršg_bš¬y_com·»
);

150  
VRT_OK
;

151 
	}
}

153 
	$check_»¶ys_if_§me
(
»¶y_un™
 *
ru
)

155 
j
;

156 
»disR•ly
 **
»¶ys
 = 
ru
->replys;

157 
»disR•ly
 *
»¶yb
, *
»¶y
;

159 
	`sÜt_»¶ys_if_Ãeded
(
ru
);

161 
»¶yb
 = 
»¶ys
[0];

163 
j
 = 1; j < 
ru
->
tÙ®_couÁ
 ; j ++) {

164 
»¶y
 = 
»¶ys
[
j
];

165 ià(
	`check_two_»¶ys_if_§me
(
»¶yb
, 
»¶y
)) {

166 
	`show_»¶ys_šcÚsi¡’cy_msg
(
ru
->
du
, 
»¶yb
, 
»¶y
);

172 
	}
}

174 
	sÿÎback_d©a
 {

175 
di¥©ch_d©a_th»ad
 *
	mddt
;

176 
»¶y_un™
 *
	mru
;

177 
	midx
;

180 
	$»¶y_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

181 
»t
;

182 
»disR•ly
 *
»¶y
;

183 
ÿÎback_d©a
 *
cbd
 = 
´ivd©a
;

184 
di¥©ch_d©a_th»ad
 *
ddt
 = 
cbd
->ddt;

185 
»¶y_un™
 *
ru
 = 
cbd
->ru;

187 ià(
r
 =ğ
NULL
) {

188 
»¶y
 = 
NULL
;

191 
»¶y
 = 
	`¡—l_hœedis_»di¤•ly
(
r
);

194 
ru
->
»¶ys
[
cbd
->
idx
] = 
»¶y
;

195 
ru
->
»ûived_couÁ
 ++;

196 
	`ä“
(
cbd
);

198 ià(
ru
->
»ûived_couÁ
 >ğru->
tÙ®_couÁ
) {

199 
j
;

201 
»t
 = 
	`check_»¶ys_if_§me
(
ru
);

202 ià(
»t
 =ğ1 && 
»¶y
 !ğ
NULL
) {

203 
d©a_un™
 *
du
 = 
ru
->du;

204 
d©a_´oduûr
 *
dp
 = 
du
->dp;

205 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

206 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
++;

210 ià(
dp
->
Ãed_ÿche_key_´oc
 !ğ
NULL
) {

211 
´oduû_scheme
 *
ps
 = 
du
->
d©a
;

212 ià(
dp
->
	`Ãed_ÿche_key_´oc
(
»¶y
)) {

213 
key_ÿche_¬¿y
 *
kı
 = 
	`kı_g‘_äom_ps
(
ps
, 
dp
);

214 
sds
 
key
 = 
	`g‘_Úe_key_äom_d©a_un™
(
du
);

215 
	`key_ÿche_¬¿y_šput
(
kı
,
key
,
	`sd¦’
(key));

221 
j
 = 0; j < 
ru
->
tÙ®_couÁ
; j ++) {

222 
	`ä“R•lyObjeù
(
ru
->
»¶ys
[
j
]);

223 
ru
->
»¶ys
[
j
] = 
NULL
;

225 
	`ä“
(
ru
->
»¶ys
);

226 
	`d©a_un™_put
(
ru
->
du
);

227 
	`ä“
(
ru
);

229 
ddt
->
couÁ_wa™_fÜ_»¶y
 --;

230 
	`ASSERT
(
ddt
->
couÁ_wa™_fÜ_»¶y
 >= 0);

232 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
++;

234 
	}
}

236 
	$di¥©ch_th»ad_£nd_d©a
(
di¥©ch_d©a_th»ad
 *
ddt
)

238 
couÁ_³r_time
 = 1000;

239 
d©a_un™
 *
du
;

241 (
du
 = 
	`dmtqueue_pİ
(
ddt
->
d©as
)è!ğ
NULL
) {

242 
»disAsyncCÚ‹xt
 *
aùx
;

243 
j
;

245 
size_t
 *
¬gvËn
 = 
	`m®loc
(
du
->
¬gc
*(size_t));

246 
»¶y_un™
 *
ru
 = 
	`m®loc
((reply_unit));

247 
ru
->
du
 = du;

248 
ru
->
tÙ®_couÁ
 = 
	`d¬¿y_n
(
ddt
->
abgs
);

249 
ru
->
»ûived_couÁ
 = 0;

250 
ru
->
»¶ys
 = 
	`m®loc
Ôu->
tÙ®_couÁ
*(
»disR•ly
 *));

251 
j
 = 0; j < 
du
->
¬gc
; j ++) {

252 
¬gvËn
[
j
] = 
	`sd¦’
(
du
->
¬gv
[j]);

254 
j
 = 0; j < 
	`d¬¿y_n
(
ddt
->
abgs
); j ++) {

255 
ÿÎback_d©a
 *
cbd
;

256 *
keyšdex
, 
numkeys
;

257 
ab‹¡_£rv”
 *
abs
;

259 
cbd
 = 
	`m®loc
((
ÿÎback_d©a
));

260 
cbd
->
ddt
 = ddt;

261 
cbd
->
ru
 =„u;

262 
cbd
->
idx
 = 
j
;

263 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
ddt
->
abgs
, 
j
);

265 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
, du->
¬gv
, du->
¬gc
, &
numkeys
);

266 ià(
numkeys
 == 0) {

267 
idx
;

268 
idx
 = ()
	`¿nd
()%
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
);

269 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
,
idx
);

271 
sds
 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

272 
abs
 = 
abg
->
	`g‘_back’d_£rv”
×bg,
key
,
	`sd¦’
(key));

274 
	`ä“
(
keyšdex
);

276 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
,

277 
du
->
hashv®ue
%
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
));

278 
aùx
 = 
cc
->actx;

279 
	`»disAsyncCommªdArgv
(
aùx
, 
»¶y_ÿÎback
, 
cbd
, 
du
->
¬gc
, du->
¬gv
, 
¬gvËn
);

281 
	`ä“
(
¬gvËn
);

283 
ddt
->
couÁ_wa™_fÜ_»¶y
 ++;

285 ià(
couÁ_³r_time
-- <= 0) ;

288  
VRT_OK
;

289 
	}
}

291 
	$di¥©ch_d©a_th»ad_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

293 
di¥©ch_d©a_th»ad
 *
ddt
 = 
ş›ÁD©a
;

295 
	`ASSERT
(
ev’tLoİ
 =ğ
ddt
->
–
);

298 ià(
ddt
->
·u£
) {

299 ià(!
	`‹¡_if_Ãed_·u£
()) {

300 
ddt
->
·u£
 = 0;

302 
ddt
->
üÚloİs
 ++;

307 ià(
ddt
->
couÁ_wa™_fÜ_»¶y
 < 4000 &&

308 !
	`dmtqueue_em±y
(
ddt
->
d©as
)) {

309 
	`di¥©ch_th»ad_£nd_d©a
(
ddt
);

313 ià(
	`‹¡_if_Ãed_·u£
() &&

314 
	`®l_´oduû_th»ads_·u£d
() &&

315 
	`®l_back’d_th»ads_·u£d
() &&

316 
	`dmtqueue_em±y
(
ddt
->
d©as
) &&

317 
	`dli¡L’gth
(
ddt
->
rd©as
) == 0) {

319 
ddt
->
·u£
 = 1;

322 
	`upd©e_¡©e_add
(
tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
,

323 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
);

324 
	`upd©e_¡©e_add
(
tÙ®_‹¡ed_commªds_couÁ
,

325 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
);

326 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
 = 0;

327 
	`upd©e_¡©e_add
(
tÙ®_»¶y_”r_couÁ_³r_cyşe
,

328 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
);

329 
	`upd©e_¡©e_add
(
tÙ®_»¶y_”r_couÁ
,

330 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
);

331 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
 = 0;

333 
	`Úe_di¥©ch_th»ad_·u£d
();

336 
ddt
->
üÚloİs
 ++;

337  1000/
ddt
->
hz
;

338 
	}
}

340 
	$cÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

341 
di¥©ch_d©a_th»ad
 *
ddt
 = 
c
->
d©a
;

342 ià(
¡©us
 !ğ
REDIS_OK
) {

343 
	`log_”rÜ
("E¼Ü: %s\n", 
c
->
”r¡r
);

349 
	}
}

351 
	$discÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

352 
di¥©ch_d©a_th»ad
 *
ddt
 = 
c
->
d©a
;

353 ià(
¡©us
 !ğ
REDIS_OK
) {

354 
	`log_”rÜ
("E¼Ü: %s\n", 
c
->
”r¡r
);

361 
	}
}

363 
	$di¥©ch_cÚn_cÚ‹xt_š™
(
cÚn_cÚ‹xt
 *
cc
, *
ho¡
, 
pÜt
)

365 
cc
->
ùx
 = 
NULL
;

366 
cc
->
aùx
 = 
NULL
;

368 
cc
->
aùx
 = 
	`»disAsyncCÚÃù
(
ho¡
, 
pÜt
);

369 ià(
cc
->
aùx
 =ğ
NULL
) {

370  
VRT_ERROR
;

373  
VRT_OK
;

374 
	}
}

376 
	$di¥©ch_cÚn_cÚ‹xt_deš™
(
cÚn_cÚ‹xt
 *
cc
)

378 ià(
cc
->
ùx
) {

379 
	`»disF»e
(
cc
->
ùx
);

380 
cc
->
ùx
 =ğ
NULL
;

383 ià(
cc
->
aùx
) {

384 
	`»disAsyncF»e
(
cc
->
aùx
);

385 
cc
->
aùx
 =ğ
NULL
;

387 
	}
}

389 
	$di¥©ch_d©a_th»ad_š™
(
di¥©ch_d©a_th»ad
 *
ddt
, *
‹¡_rg‘_groups
, 
cÚÃùiÚs
)

391 
i
, 
j
, 
k
;

393 
ddt
->
id
 = 0;

394 
ddt
->
th»ad_id
 = 0;

395 
ddt
->
–
 = 
NULL
;

396 
ddt
->
hz
 = 10;

397 
ddt
->
üÚloİs
 = 0;

398 
ddt
->
d©as
 = 
NULL
;

399 
ddt
->
rd©as
 = 
NULL
;

400 
ddt
->
abgs
 = 
NULL
;

401 
ddt
->
·u£
 = 0;

402 
ddt
->
couÁ_wa™_fÜ_»¶y
 = 0;

403 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
 = 0;

404 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
 = 0;

406 
ddt
->
–
 = 
	`«C»©eEv’tLoİ
(200);

407 ià(
ddt
->
–
 =ğ
NULL
) {

408  
VRT_ERROR
;

411 
ddt
->
d©as
 = 
	`dmtqueue_ü—‹
();

412 ià(
ddt
->
d©as
 =ğ
NULL
) {

413  
VRT_ERROR
;

416 ià(
	`dmtqueue_š™_w™h_lockqueue
(
ddt
->
d©as
, 
NULL
) != 0) {

417  
VRT_ERROR
;

420 
ddt
->
rd©as
 = 
	`dli¡C»©e
();

421 ià(
ddt
->
rd©as
 =ğ
NULL
) {

422  
VRT_ERROR
;

425 
ddt
->
abgs
 = 
	`ab‹¡_groups_ü—‹
(
‹¡_rg‘_groups
);

426 ià(
ddt
->
abgs
 =ğ
NULL
) {

427  
VRT_ERROR
;

431 
i
 = 0; i < 
	`d¬¿y_n
(
ddt
->
abgs
); i ++) {

432 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
ddt
->
abgs
, 
i
);

433 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

434 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

435 
abs
->
cÚn_cÚ‹xts
 = 
	`d¬¿y_ü—‹
(
cÚÃùiÚs
, (
cÚn_cÚ‹xt
));

436 
k
 = 0; k < 
cÚÃùiÚs
; k ++) {

437 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_push
(
abs
->
cÚn_cÚ‹xts
);

438 ià(
	`di¥©ch_cÚn_cÚ‹xt_š™
(
cc
,
abs
->
ho¡
,abs->
pÜt
è!ğ
VRT_OK
) {

439  
VRT_ERROR
;

441 
cc
->
aùx
->
d©a
 = 
ddt
;

442 
	`»disAeA‰ach
(
ddt
->
–
, 
cc
->
aùx
);

443 
	`»disAsyncS‘CÚÃùC®lback
(
cc
->
aùx
,
cÚÃù_ÿÎback
);

444 
	`»disAsyncS‘DiscÚÃùC®lback
(
cc
->
aùx
,
discÚÃù_ÿÎback
);

449 ià(
	`«C»©eTimeEv’t
(
ddt
->
–
, 1, 
di¥©ch_d©a_th»ad_üÚ
, ddt, 
NULL
è=ğ
AE_ERR
) {

450  
VRT_ERROR
;

453  
VRT_OK
;

454 
	}
}

456 
	$di¥©ch_d©a_th»ad_deš™
(
di¥©ch_d©a_th»ad
 *
ddt
)

458 ià(
ddt
->
–
) {

459 
	`«D–‘eEv’tLoİ
(
ddt
->
–
);

460 
ddt
->
–
 = 
NULL
;

463 ià(
ddt
->
d©as
) {

464 
	`dmtqueue_de¡roy
(
ddt
->
d©as
);

465 
ddt
->
d©as
 = 
NULL
;

468 ià(
ddt
->
abgs
) {

469 
i
, 
j
, 
k
;

471 
i
 = 0; i < 
	`d¬¿y_n
(
ddt
->
abgs
); i ++) {

472 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
ddt
->
abgs
, 
i
);

473 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

474 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

475 
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) > 0) {

476 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_pİ
(
abs
->
cÚn_cÚ‹xts
);

477 
	`di¥©ch_cÚn_cÚ‹xt_deš™
(
cc
);

482 
	`ab‹¡_groups_de¡roy
(
ddt
->
abgs
);

483 
ddt
->
abgs
 = 
NULL
;

485 
	}
}

487 
	$v¹_di¥©ch_d©a_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
, 
cÚÃùiÚs
)

489 
j
;

491 
di¥©ch_d©a_th»ads_couÁ
 = 
th»ads_couÁ
;

492 
di¥©ch_d©a_th»ads
 = 
	`d¬¿y_ü—‹
(
th»ads_couÁ
, (
di¥©ch_d©a_th»ad
));

493 ià(
di¥©ch_d©a_th»ads
 =ğ
NULL
) {

494  
VRT_ERROR
;

497 
j
 = 0; j < 
th»ads_couÁ
; j ++) {

498 
di¥©ch_d©a_th»ad
 *
ddt
 = 
	`d¬¿y_push
(
di¥©ch_d©a_th»ads
);

499 ià(
	`di¥©ch_d©a_th»ad_š™
(
ddt
, 
‹¡_rg‘_groups
, 
cÚÃùiÚs
è!ğ
VRT_OK
) {

500  
VRT_ERROR
;

502 
ddt
->
id
 = 
j
;

505  
VRT_OK
;

506 
	}
}

508 
	$v¹_di¥©ch_d©a_deš™
()

510 ià(
di¥©ch_d©a_th»ads
) {

511 
	`d¬¿y_n
(
di¥©ch_d©a_th»ads
) > 0) {

512 
di¥©ch_d©a_th»ad
 *
ddt
 = 
	`d¬¿y_pİ
(
di¥©ch_d©a_th»ads
);

513 
	`di¥©ch_d©a_th»ad_deš™
(
ddt
);

515 
	`d¬¿y_de¡roy
(
di¥©ch_d©a_th»ads
);

516 
di¥©ch_d©a_th»ads
 = 
NULL
;

518 
	}
}

520 *
	$v¹_di¥©ch_d©a_th»ad_run
(*
¬gs
)

522 
di¥©ch_d©a_th»ad
 *
ddt
 = 
¬gs
;

523 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

525 
	`«Maš
(
ddt
->
–
);

527  
NULL
;

528 
	}
}

530 
	$v¹_¡¬t_di¥©ch_d©a
()

532 
i
;

533 
i
 = 0; i < 
	`d¬¿y_n
(
di¥©ch_d©a_th»ads
); i ++) {

534 
±h»ad_©Œ_t
 
©Œ
;

535 
di¥©ch_d©a_th»ad
 *
ddt
;

536 
	`±h»ad_©Œ_š™
(&
©Œ
);

537 
ddt
 = 
	`d¬¿y_g‘
(
di¥©ch_d©a_th»ads
, 
i
);

538 
	`±h»ad_ü—‹
(&
ddt
->
th»ad_id
,

539 &
©Œ
, 
v¹_di¥©ch_d©a_th»ad_run
, 
ddt
);

542  
VRT_OK
;

543 
	}
}

545 
	$v¹_wa™_di¥©ch_d©a
()

547 
i
;

549 
i
 = 0; i < 
	`d¬¿y_n
(
di¥©ch_d©a_th»ads
); i ++){

550 
di¥©ch_d©a_th»ad
 *
ddt
 = 
	`d¬¿y_g‘
(
di¥©ch_d©a_th»ads
, 
i
);

551 
	`±h»ad_još
(
ddt
->
th»ad_id
, 
NULL
);

554  
VRT_OK
;

555 
	}
}

561 
	$d©a_di¥©ch
(
d©a_un™
 *
du
)

563 
th»ad_idx
;

564 
di¥©ch_d©a_th»ad
 *
ddt
;

565 
Ëngth
;

566 *
keyšdex
, 
numkeys
;

568 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
, du->
¬gv
, du->
¬gc
, &
numkeys
);

570 ià(
numkeys
 == 0) {

571 
du
->
hashv®ue
 = ()
	`¿nd
();

573 
sds
 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

574 
du
->
hashv®ue
 = ()
	`hash_üc32a
(
key
, 
	`sd¦’
(key));

576 
	`ä“
(
keyšdex
);

578 
th»ad_idx
 = 
du
->
hashv®ue
%
di¥©ch_d©a_th»ads_couÁ
;

579 
ddt
 = 
	`d¬¿y_g‘
(
di¥©ch_d©a_th»ads
, 
th»ad_idx
);

580 
Ëngth
 = 
	`dmtqueue_push
(
ddt
->
d©as
, 
du
);

581 ià(
Ëngth
 <= 0) {

582 
	`‹¡_log_”rÜ
("D©¨un™…ushØdi¥©chh»ad %d faed", 
ddt
->
id
);

584 } ià(
Ëngth
 > 2000) {

589 
	}
}

	@tests/vrt_dispatch_data.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

12 
	~<async.h
>

13 
	~<ad­‹rs/«.h
>

15 
	~<dhashk™.h
>

16 
	~<dli¡.h
>

17 
	~<dmtqueue.h
>

18 
	~<dlog.h
>

20 
	~<v¹_ut.h
>

21 
	~<v¹_public.h
>

22 
	~<v¿b‹¡.h
>

23 
	~<v¹_di¥©ch_d©a.h
>

24 
	~<v¹_´oduû_d©a.h
>

26 
	gdi¥©ch_d©a_th»ads_couÁ
;

27 
d¬¿y
 *
	gdi¥©ch_d©a_th»ads
 = 
NULL
;

29 
	gdi¥©ch_th»ads_·u£_fšished_couÁ
;

31 
	gtÙ®_‹¡ed_commªds_couÁ_³r_cyşe
 = 0;

32 
	gtÙ®_»¶y_”r_couÁ_³r_cyşe
 = 0;

33 
	gtÙ®_‹¡ed_commªds_couÁ
 = 0;

34 
	gtÙ®_»¶y_”r_couÁ
 = 0;

36 
	$g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
()

38 
couÁ
;

39 
	`upd©e_¡©e_g‘
(
tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
,&
couÁ
);

40  
couÁ
;

41 
	}
}

43 
	$g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
()

45 
couÁ
;

46 
	`upd©e_¡©e_g‘
(
tÙ®_»¶y_”r_couÁ_³r_cyşe
,&
couÁ
);

47  
couÁ
;

48 
	}
}

50 
	$»£t_tÙ®_couÁ_³r_cyşe
()

52 
	`upd©e_¡©e_£t
(
tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
,0);

53 
	`upd©e_¡©e_£t
(
tÙ®_»¶y_”r_couÁ_³r_cyşe
,0);

54 
	}
}

56 
	s»¶y_un™
 {

57 
	mtÙ®_couÁ
;

58 
	m»ûived_couÁ
;

59 
»disR•ly
 **
	m»¶ys
;

60 
d©a_un™
 *
	mdu
;

61 } 
	t»¶y_un™
;

63 
	$show_»¶ys_šcÚsi¡’cy_msg
(
d©a_un™
 *
du
, 
»disR•ly
 *
»¶y1
,„edisR•ly *
»¶y2
)

65 *
keyšdex
, 
numkeys
;

66 
sds
 
key
 = 
NULL
;

68 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
, du->
¬gv
, du->
¬gc
, &
numkeys
);

69 ià(
numkeys
 > 0) {

70 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

72 
	`ä“
(
keyšdex
);

74 ià(
key
) {

75 
	`log_hexdump
(
LOG_ERR
,
key
,
	`sd¦’
(key),

83 
du
->
dp
->
Çme
,

84 
»¶y1
->
ty³
, 
»¶y2
->type,

85 
»¶y1
->
ty³
==
REDIS_REPLY_STATUS
?»¶y1->
¡r
:"NULL",

86 
»¶y2
->
ty³
==
REDIS_REPLY_STATUS
?»¶y2->
¡r
:"NULL",

87 
»¶y1
->
ty³
==
REDIS_REPLY_ERROR
?»¶y1->
¡r
:"NULL",

88 
»¶y2
->
ty³
==
REDIS_REPLY_ERROR
?»¶y2->
¡r
:"NULL",

89 
»¶y1
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y1->
š‹g”
:0,

90 
»¶y2
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y2->
š‹g”
:0,

91 
»¶y1
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y1->
–em’ts
:0,

92 
»¶y2
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y2->
–em’ts
:0,

93 
	`sd¦’
(
key
));

95 
	`log_”rÜ
("%s command„eplys‡re inconsistency, "

101 
du
->
dp
->
Çme
,

102 
»¶y1
->
ty³
, 
»¶y2
->type,

103 
»¶y1
->
ty³
==
REDIS_REPLY_STATUS
?»¶y1->
¡r
:"NULL",

104 
»¶y2
->
ty³
==
REDIS_REPLY_STATUS
?»¶y2->
¡r
:"NULL",

105 
»¶y1
->
ty³
==
REDIS_REPLY_ERROR
?»¶y1->
¡r
:"NULL",

106 
»¶y2
->
ty³
==
REDIS_REPLY_ERROR
?»¶y2->
¡r
:"NULL",

107 
»¶y1
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y1->
š‹g”
:0,

108 
»¶y2
->
ty³
==
REDIS_REPLY_INTEGER
?»¶y2->
š‹g”
:0,

109 
»¶y1
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y1->
–em’ts
:0,

110 
»¶y2
->
ty³
==
REDIS_REPLY_ARRAY
?»¶y2->
–em’ts
:0);

113 
	}
}

115 
	$sÜt_»¶ys_if_Ãeded
(
»¶y_un™
 *
ru
)

117 
d©a_un™
 *
du
 = 
ru
->du;

118 
d©a_´oduûr
 *
dp
 = 
du
->dp;

119 
¡•
 = 0, 
idx_cmp
 = 0;

121 ià(
dp
->
cmd_ty³
&
TEST_CMD_TYPE_SET
) {

122 ià(!
	`¡rcmp
(
dp
->
Çme
,"smembers") ||

123 !
	`¡rcmp
(
dp
->
Çme
,"sunion") ||

124 !
	`¡rcmp
(
dp
->
Çme
,"sdiff") ||

125 !
	`¡rcmp
(
dp
->
Çme
,"sinter")) {

126 
¡•
 = 1;

128 } ià(
dp
->
cmd_ty³
&
TEST_CMD_TYPE_HASH
) {

129 ià(!
	`¡rcmp
(
dp
->
Çme
,"hkeys") ||

130 !
	`¡rcmp
(
dp
->
Çme
,"hvals")) {

131 
¡•
 = 1;

132 } ià(!
	`¡rcmp
(
dp
->
Çme
,"hgetall")) {

133 
¡•
 = 2;

134 
idx_cmp
 = 0;

138 ià(
¡•
 > 0) {

139 
i
;

140 
»disR•ly
 *
»¶y
;

141 
i
 = 0; i < 
ru
->
»ûived_couÁ
; i ++) {

142 
»¶y
 = 
ru
->
»¶ys
[
i
];

143 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
)

145 
	`sÜt_¬¿y_by_¡•
(
»¶y
->
–em’t
,„•ly->
–em’ts
,

146 
¡•
, 
idx_cmp
, 
»¶y_¡ršg_bš¬y_com·»
);

150  
VRT_OK
;

151 
	}
}

153 
	$check_»¶ys_if_§me
(
»¶y_un™
 *
ru
)

155 
j
;

156 
»disR•ly
 **
»¶ys
 = 
ru
->replys;

157 
»disR•ly
 *
»¶yb
, *
»¶y
;

159 
	`sÜt_»¶ys_if_Ãeded
(
ru
);

161 
»¶yb
 = 
»¶ys
[0];

163 
j
 = 1; j < 
ru
->
tÙ®_couÁ
 ; j ++) {

164 
»¶y
 = 
»¶ys
[
j
];

165 ià(
	`check_two_»¶ys_if_§me
(
»¶yb
, 
»¶y
)) {

166 
	`show_»¶ys_šcÚsi¡’cy_msg
(
ru
->
du
, 
»¶yb
, 
»¶y
);

172 
	}
}

174 
	sÿÎback_d©a
 {

175 
di¥©ch_d©a_th»ad
 *
	mddt
;

176 
»¶y_un™
 *
	mru
;

177 
	midx
;

180 
	$»¶y_ÿÎback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

181 
»t
;

182 
»disR•ly
 *
»¶y
;

183 
ÿÎback_d©a
 *
cbd
 = 
´ivd©a
;

184 
di¥©ch_d©a_th»ad
 *
ddt
 = 
cbd
->ddt;

185 
»¶y_un™
 *
ru
 = 
cbd
->ru;

187 ià(
r
 =ğ
NULL
) {

188 
»¶y
 = 
NULL
;

191 
»¶y
 = 
	`¡—l_hœedis_»di¤•ly
(
r
);

194 
ru
->
»¶ys
[
cbd
->
idx
] = 
»¶y
;

195 
ru
->
»ûived_couÁ
 ++;

196 
	`ä“
(
cbd
);

198 ià(
ru
->
»ûived_couÁ
 >ğru->
tÙ®_couÁ
) {

199 
j
;

201 
»t
 = 
	`check_»¶ys_if_§me
(
ru
);

202 ià(
»t
 =ğ1 && 
»¶y
 !ğ
NULL
) {

203 
d©a_un™
 *
du
 = 
ru
->du;

204 
d©a_´oduûr
 *
dp
 = 
du
->dp;

205 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

206 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
++;

210 ià(
dp
->
Ãed_ÿche_key_´oc
 !ğ
NULL
) {

211 
´oduû_scheme
 *
ps
 = 
du
->
d©a
;

212 ià(
dp
->
	`Ãed_ÿche_key_´oc
(
»¶y
)) {

213 
key_ÿche_¬¿y
 *
kı
 = 
	`kı_g‘_äom_ps
(
ps
, 
dp
);

214 
sds
 
key
 = 
	`g‘_Úe_key_äom_d©a_un™
(
du
);

215 
	`key_ÿche_¬¿y_šput
(
kı
,
key
,
	`sd¦’
(key));

221 
j
 = 0; j < 
ru
->
tÙ®_couÁ
; j ++) {

222 
	`ä“R•lyObjeù
(
ru
->
»¶ys
[
j
]);

223 
ru
->
»¶ys
[
j
] = 
NULL
;

225 
	`ä“
(
ru
->
»¶ys
);

226 
	`d©a_un™_put
(
ru
->
du
);

227 
	`ä“
(
ru
);

229 
ddt
->
couÁ_wa™_fÜ_»¶y
 --;

230 
	`ASSERT
(
ddt
->
couÁ_wa™_fÜ_»¶y
 >= 0);

232 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
++;

234 
	}
}

236 
	$di¥©ch_th»ad_£nd_d©a
(
di¥©ch_d©a_th»ad
 *
ddt
)

238 
couÁ_³r_time
 = 1000;

239 
d©a_un™
 *
du
;

241 (
du
 = 
	`dmtqueue_pİ
(
ddt
->
d©as
)è!ğ
NULL
) {

242 
»disAsyncCÚ‹xt
 *
aùx
;

243 
j
;

245 
size_t
 *
¬gvËn
 = 
	`m®loc
(
du
->
¬gc
*(size_t));

246 
»¶y_un™
 *
ru
 = 
	`m®loc
((reply_unit));

247 
ru
->
du
 = du;

248 
ru
->
tÙ®_couÁ
 = 
	`d¬¿y_n
(
ddt
->
abgs
);

249 
ru
->
»ûived_couÁ
 = 0;

250 
ru
->
»¶ys
 = 
	`m®loc
Ôu->
tÙ®_couÁ
*(
»disR•ly
 *));

251 
j
 = 0; j < 
du
->
¬gc
; j ++) {

252 
¬gvËn
[
j
] = 
	`sd¦’
(
du
->
¬gv
[j]);

254 
j
 = 0; j < 
	`d¬¿y_n
(
ddt
->
abgs
); j ++) {

255 
ÿÎback_d©a
 *
cbd
;

256 *
keyšdex
, 
numkeys
;

257 
ab‹¡_£rv”
 *
abs
;

259 
cbd
 = 
	`m®loc
((
ÿÎback_d©a
));

260 
cbd
->
ddt
 = ddt;

261 
cbd
->
ru
 =„u;

262 
cbd
->
idx
 = 
j
;

263 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
ddt
->
abgs
, 
j
);

265 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
, du->
¬gv
, du->
¬gc
, &
numkeys
);

266 ià(
numkeys
 == 0) {

267 
idx
;

268 
idx
 = ()
	`¿nd
()%
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
);

269 
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
,
idx
);

271 
sds
 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

272 
abs
 = 
abg
->
	`g‘_back’d_£rv”
×bg,
key
,
	`sd¦’
(key));

274 
	`ä“
(
keyšdex
);

276 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_g‘
(
abs
->
cÚn_cÚ‹xts
,

277 
du
->
hashv®ue
%
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
));

278 
aùx
 = 
cc
->actx;

279 
	`»disAsyncCommªdArgv
(
aùx
, 
»¶y_ÿÎback
, 
cbd
, 
du
->
¬gc
, du->
¬gv
, 
¬gvËn
);

281 
	`ä“
(
¬gvËn
);

283 
ddt
->
couÁ_wa™_fÜ_»¶y
 ++;

285 ià(
couÁ_³r_time
-- <= 0) ;

288  
VRT_OK
;

289 
	}
}

291 
	$di¥©ch_d©a_th»ad_üÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
)

293 
di¥©ch_d©a_th»ad
 *
ddt
 = 
ş›ÁD©a
;

295 
	`ASSERT
(
ev’tLoİ
 =ğ
ddt
->
–
);

298 ià(
ddt
->
·u£
) {

299 ià(!
	`‹¡_if_Ãed_·u£
()) {

300 
ddt
->
·u£
 = 0;

302 
ddt
->
üÚloİs
 ++;

307 ià(
ddt
->
couÁ_wa™_fÜ_»¶y
 < 4000 &&

308 !
	`dmtqueue_em±y
(
ddt
->
d©as
)) {

309 
	`di¥©ch_th»ad_£nd_d©a
(
ddt
);

313 ià(
	`‹¡_if_Ãed_·u£
() &&

314 
	`®l_´oduû_th»ads_·u£d
() &&

315 
	`®l_back’d_th»ads_·u£d
() &&

316 
	`dmtqueue_em±y
(
ddt
->
d©as
) &&

317 
	`dli¡L’gth
(
ddt
->
rd©as
) == 0) {

319 
ddt
->
·u£
 = 1;

322 
	`upd©e_¡©e_add
(
tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
,

323 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
);

324 
	`upd©e_¡©e_add
(
tÙ®_‹¡ed_commªds_couÁ
,

325 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
);

326 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
 = 0;

327 
	`upd©e_¡©e_add
(
tÙ®_»¶y_”r_couÁ_³r_cyşe
,

328 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
);

329 
	`upd©e_¡©e_add
(
tÙ®_»¶y_”r_couÁ
,

330 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
);

331 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
 = 0;

333 
	`Úe_di¥©ch_th»ad_·u£d
();

336 
ddt
->
üÚloİs
 ++;

337  1000/
ddt
->
hz
;

338 
	}
}

340 
	$cÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

341 
di¥©ch_d©a_th»ad
 *
ddt
 = 
c
->
d©a
;

342 ià(
¡©us
 !ğ
REDIS_OK
) {

343 
	`log_”rÜ
("E¼Ü: %s\n", 
c
->
”r¡r
);

349 
	}
}

351 
	$discÚÃù_ÿÎback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

352 
di¥©ch_d©a_th»ad
 *
ddt
 = 
c
->
d©a
;

353 ià(
¡©us
 !ğ
REDIS_OK
) {

354 
	`log_”rÜ
("E¼Ü: %s\n", 
c
->
”r¡r
);

361 
	}
}

363 
	$di¥©ch_cÚn_cÚ‹xt_š™
(
cÚn_cÚ‹xt
 *
cc
, *
ho¡
, 
pÜt
)

365 
cc
->
ùx
 = 
NULL
;

366 
cc
->
aùx
 = 
NULL
;

368 
cc
->
aùx
 = 
	`»disAsyncCÚÃù
(
ho¡
, 
pÜt
);

369 ià(
cc
->
aùx
 =ğ
NULL
) {

370  
VRT_ERROR
;

373  
VRT_OK
;

374 
	}
}

376 
	$di¥©ch_cÚn_cÚ‹xt_deš™
(
cÚn_cÚ‹xt
 *
cc
)

378 ià(
cc
->
ùx
) {

379 
	`»disF»e
(
cc
->
ùx
);

380 
cc
->
ùx
 =ğ
NULL
;

383 ià(
cc
->
aùx
) {

384 
	`»disAsyncF»e
(
cc
->
aùx
);

385 
cc
->
aùx
 =ğ
NULL
;

387 
	}
}

389 
	$di¥©ch_d©a_th»ad_š™
(
di¥©ch_d©a_th»ad
 *
ddt
, *
‹¡_rg‘_groups
, 
cÚÃùiÚs
)

391 
i
, 
j
, 
k
;

393 
ddt
->
id
 = 0;

394 
ddt
->
th»ad_id
 = 0;

395 
ddt
->
–
 = 
NULL
;

396 
ddt
->
hz
 = 10;

397 
ddt
->
üÚloİs
 = 0;

398 
ddt
->
d©as
 = 
NULL
;

399 
ddt
->
rd©as
 = 
NULL
;

400 
ddt
->
abgs
 = 
NULL
;

401 
ddt
->
·u£
 = 0;

402 
ddt
->
couÁ_wa™_fÜ_»¶y
 = 0;

403 
ddt
->
»¶y_tÙ®_couÁ_³r_cyşe
 = 0;

404 
ddt
->
»¶y_ty³_”r_couÁ_³r_cyşe
 = 0;

406 
ddt
->
–
 = 
	`«C»©eEv’tLoİ
(200);

407 ià(
ddt
->
–
 =ğ
NULL
) {

408  
VRT_ERROR
;

411 
ddt
->
d©as
 = 
	`dmtqueue_ü—‹
();

412 ià(
ddt
->
d©as
 =ğ
NULL
) {

413  
VRT_ERROR
;

416 ià(
	`dmtqueue_š™_w™h_lockqueue
(
ddt
->
d©as
, 
NULL
) != 0) {

417  
VRT_ERROR
;

420 
ddt
->
rd©as
 = 
	`dli¡C»©e
();

421 ià(
ddt
->
rd©as
 =ğ
NULL
) {

422  
VRT_ERROR
;

425 
ddt
->
abgs
 = 
	`ab‹¡_groups_ü—‹
(
‹¡_rg‘_groups
);

426 ià(
ddt
->
abgs
 =ğ
NULL
) {

427  
VRT_ERROR
;

431 
i
 = 0; i < 
	`d¬¿y_n
(
ddt
->
abgs
); i ++) {

432 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
ddt
->
abgs
, 
i
);

433 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

434 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

435 
abs
->
cÚn_cÚ‹xts
 = 
	`d¬¿y_ü—‹
(
cÚÃùiÚs
, (
cÚn_cÚ‹xt
));

436 
k
 = 0; k < 
cÚÃùiÚs
; k ++) {

437 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_push
(
abs
->
cÚn_cÚ‹xts
);

438 ià(
	`di¥©ch_cÚn_cÚ‹xt_š™
(
cc
,
abs
->
ho¡
,abs->
pÜt
è!ğ
VRT_OK
) {

439  
VRT_ERROR
;

441 
cc
->
aùx
->
d©a
 = 
ddt
;

442 
	`»disAeA‰ach
(
ddt
->
–
, 
cc
->
aùx
);

443 
	`»disAsyncS‘CÚÃùC®lback
(
cc
->
aùx
,
cÚÃù_ÿÎback
);

444 
	`»disAsyncS‘DiscÚÃùC®lback
(
cc
->
aùx
,
discÚÃù_ÿÎback
);

449 ià(
	`«C»©eTimeEv’t
(
ddt
->
–
, 1, 
di¥©ch_d©a_th»ad_üÚ
, ddt, 
NULL
è=ğ
AE_ERR
) {

450  
VRT_ERROR
;

453  
VRT_OK
;

454 
	}
}

456 
	$di¥©ch_d©a_th»ad_deš™
(
di¥©ch_d©a_th»ad
 *
ddt
)

458 ià(
ddt
->
–
) {

459 
	`«D–‘eEv’tLoİ
(
ddt
->
–
);

460 
ddt
->
–
 = 
NULL
;

463 ià(
ddt
->
d©as
) {

464 
	`dmtqueue_de¡roy
(
ddt
->
d©as
);

465 
ddt
->
d©as
 = 
NULL
;

468 ià(
ddt
->
abgs
) {

469 
i
, 
j
, 
k
;

471 
i
 = 0; i < 
	`d¬¿y_n
(
ddt
->
abgs
); i ++) {

472 
ab‹¡_group
 *
abg
 = 
	`d¬¿y_g‘
(
ddt
->
abgs
, 
i
);

473 
j
 = 0; j < 
	`d¬¿y_n
(&
abg
->
ab‹¡_£rv”s
); j ++) {

474 
ab‹¡_£rv”
 *
abs
 = 
	`d¬¿y_g‘
(&
abg
->
ab‹¡_£rv”s
, 
j
);

475 
	`d¬¿y_n
(
abs
->
cÚn_cÚ‹xts
) > 0) {

476 
cÚn_cÚ‹xt
 *
cc
 = 
	`d¬¿y_pİ
(
abs
->
cÚn_cÚ‹xts
);

477 
	`di¥©ch_cÚn_cÚ‹xt_deš™
(
cc
);

482 
	`ab‹¡_groups_de¡roy
(
ddt
->
abgs
);

483 
ddt
->
abgs
 = 
NULL
;

485 
	}
}

487 
	$v¹_di¥©ch_d©a_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
, 
cÚÃùiÚs
)

489 
j
;

491 
di¥©ch_d©a_th»ads_couÁ
 = 
th»ads_couÁ
;

492 
di¥©ch_d©a_th»ads
 = 
	`d¬¿y_ü—‹
(
th»ads_couÁ
, (
di¥©ch_d©a_th»ad
));

493 ià(
di¥©ch_d©a_th»ads
 =ğ
NULL
) {

494  
VRT_ERROR
;

497 
j
 = 0; j < 
th»ads_couÁ
; j ++) {

498 
di¥©ch_d©a_th»ad
 *
ddt
 = 
	`d¬¿y_push
(
di¥©ch_d©a_th»ads
);

499 ià(
	`di¥©ch_d©a_th»ad_š™
(
ddt
, 
‹¡_rg‘_groups
, 
cÚÃùiÚs
è!ğ
VRT_OK
) {

500  
VRT_ERROR
;

502 
ddt
->
id
 = 
j
;

505  
VRT_OK
;

506 
	}
}

508 
	$v¹_di¥©ch_d©a_deš™
()

510 ià(
di¥©ch_d©a_th»ads
) {

511 
	`d¬¿y_n
(
di¥©ch_d©a_th»ads
) > 0) {

512 
di¥©ch_d©a_th»ad
 *
ddt
 = 
	`d¬¿y_pİ
(
di¥©ch_d©a_th»ads
);

513 
	`di¥©ch_d©a_th»ad_deš™
(
ddt
);

515 
	`d¬¿y_de¡roy
(
di¥©ch_d©a_th»ads
);

516 
di¥©ch_d©a_th»ads
 = 
NULL
;

518 
	}
}

520 *
	$v¹_di¥©ch_d©a_th»ad_run
(*
¬gs
)

522 
di¥©ch_d©a_th»ad
 *
ddt
 = 
¬gs
;

523 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

525 
	`«Maš
(
ddt
->
–
);

527  
NULL
;

528 
	}
}

530 
	$v¹_¡¬t_di¥©ch_d©a
()

532 
i
;

533 
i
 = 0; i < 
	`d¬¿y_n
(
di¥©ch_d©a_th»ads
); i ++) {

534 
±h»ad_©Œ_t
 
©Œ
;

535 
di¥©ch_d©a_th»ad
 *
ddt
;

536 
	`±h»ad_©Œ_š™
(&
©Œ
);

537 
ddt
 = 
	`d¬¿y_g‘
(
di¥©ch_d©a_th»ads
, 
i
);

538 
	`±h»ad_ü—‹
(&
ddt
->
th»ad_id
,

539 &
©Œ
, 
v¹_di¥©ch_d©a_th»ad_run
, 
ddt
);

542  
VRT_OK
;

543 
	}
}

545 
	$v¹_wa™_di¥©ch_d©a
()

547 
i
;

549 
i
 = 0; i < 
	`d¬¿y_n
(
di¥©ch_d©a_th»ads
); i ++){

550 
di¥©ch_d©a_th»ad
 *
ddt
 = 
	`d¬¿y_g‘
(
di¥©ch_d©a_th»ads
, 
i
);

551 
	`±h»ad_još
(
ddt
->
th»ad_id
, 
NULL
);

554  
VRT_OK
;

555 
	}
}

561 
	$d©a_di¥©ch
(
d©a_un™
 *
du
)

563 
th»ad_idx
;

564 
di¥©ch_d©a_th»ad
 *
ddt
;

565 
Ëngth
;

566 *
keyšdex
, 
numkeys
;

568 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
, du->
¬gv
, du->
¬gc
, &
numkeys
);

570 ià(
numkeys
 == 0) {

571 
du
->
hashv®ue
 = ()
	`¿nd
();

573 
sds
 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

574 
du
->
hashv®ue
 = ()
	`hash_üc32a
(
key
, 
	`sd¦’
(key));

576 
	`ä“
(
keyšdex
);

578 
th»ad_idx
 = 
du
->
hashv®ue
%
di¥©ch_d©a_th»ads_couÁ
;

579 
ddt
 = 
	`d¬¿y_g‘
(
di¥©ch_d©a_th»ads
, 
th»ad_idx
);

580 
Ëngth
 = 
	`dmtqueue_push
(
ddt
->
d©as
, 
du
);

581 ià(
Ëngth
 <= 0) {

582 
	`‹¡_log_”rÜ
("D©¨un™…ushØdi¥©chh»ad %d faed", 
ddt
->
id
);

584 } ià(
Ëngth
 > 2000) {

589 
	}
}

	@tests/vrt_dispatch_data.h

1 #iâdeà
_VRT_DISPATCH_DATA_H_


2 
	#_VRT_DISPATCH_DATA_H_


	)

4 
	~<d¬¿y.h
>

6 
	gab‹¡_group
;

7 
	gdli¡
;

8 
	gdmtqueue
;

9 
	gd©a_un™
;

10 
	g«Ev’tLoİ
;

12 
	sdi¥©ch_d©a_th»ad
 {

13 
	mid
;

14 
±h»ad_t
 
	mth»ad_id
;

16 
«Ev’tLoİ
 *
	m–
;

17 
	mhz
;

18 
	müÚloİs
;

20 
dmtqueue
 *
	md©as
;

22 
dli¡
 *
	mrd©as
;

25 
d¬¿y
 *
	mabgs
;

27 
	m·u£
;

29 
	mcouÁ_wa™_fÜ_»¶y
;

31 
	m»¶y_tÙ®_couÁ_³r_cyşe
;

32 
	m»¶y_ty³_”r_couÁ_³r_cyşe
;

33 } 
	tdi¥©ch_d©a_th»ad
;

35 
di¥©ch_d©a_th»ads_couÁ
;

37 
di¥©ch_th»ads_·u£_fšished_couÁ
;

39 
g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
();

40 
g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
();

41 
»£t_tÙ®_couÁ_³r_cyşe
();

43 
v¹_di¥©ch_d©a_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
, 
cÚÃùiÚs
);

44 
v¹_di¥©ch_d©a_deš™
();

46 
v¹_¡¬t_di¥©ch_d©a
();

47 
v¹_wa™_di¥©ch_d©a
();

49 
d©a_di¥©ch
(
d©a_un™
 *
du
);

	@tests/vrt_dispatch_data.h

1 #iâdeà
_VRT_DISPATCH_DATA_H_


2 
	#_VRT_DISPATCH_DATA_H_


	)

4 
	~<d¬¿y.h
>

6 
	gab‹¡_group
;

7 
	gdli¡
;

8 
	gdmtqueue
;

9 
	gd©a_un™
;

10 
	g«Ev’tLoİ
;

12 
	sdi¥©ch_d©a_th»ad
 {

13 
	mid
;

14 
±h»ad_t
 
	mth»ad_id
;

16 
«Ev’tLoİ
 *
	m–
;

17 
	mhz
;

18 
	müÚloİs
;

20 
dmtqueue
 *
	md©as
;

22 
dli¡
 *
	mrd©as
;

25 
d¬¿y
 *
	mabgs
;

27 
	m·u£
;

29 
	mcouÁ_wa™_fÜ_»¶y
;

31 
	m»¶y_tÙ®_couÁ_³r_cyşe
;

32 
	m»¶y_ty³_”r_couÁ_³r_cyşe
;

33 } 
	tdi¥©ch_d©a_th»ad
;

35 
di¥©ch_d©a_th»ads_couÁ
;

37 
di¥©ch_th»ads_·u£_fšished_couÁ
;

39 
g‘_tÙ®_‹¡ed_commªds_couÁ_³r_cyşe
();

40 
g‘_tÙ®_»¶y_”r_couÁ_³r_cyşe
();

41 
»£t_tÙ®_couÁ_³r_cyşe
();

43 
v¹_di¥©ch_d©a_š™
(
th»ads_couÁ
, *
‹¡_rg‘_groups
, 
cÚÃùiÚs
);

44 
v¹_di¥©ch_d©a_deš™
();

46 
v¹_¡¬t_di¥©ch_d©a
();

47 
v¹_wa™_di¥©ch_d©a
();

49 
d©a_di¥©ch
(
d©a_un™
 *
du
);

	@tests/vrt_produce_data.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<as£¹.h
>

9 
	~<m©h.h
>

10 
	~<sys/¡©.h
>

11 
	~<sys/ut¢ame.h
>

13 
	~<d¥ecŸlcÚfig.h
>

15 
	~<hœedis.h
>

16 
	~<d¬¿y.h
>

17 
	~<dut.h
>

18 
	~<dlog.h
>

20 
	~<v¹_ut.h
>

21 
	~<v¹_public.h
>

22 
	~<v¿b‹¡.h
>

23 
	~<v¹_´oduû_d©a.h
>

25 
	#PRODUCE_KEY_CACHE_POOL_COUNT
 5

	)

27 
	s´oduû_th»ad
 {

28 
	mid
;

29 
±h»ad_t
 
	mth»ad_id
;

31 
´oduû_scheme
 *
	mps
;

33 
	m·u£
;

34 
	mloİtimes
;

35 } 
	t´oduû_th»ad
;

37 
d©a_´oduûr
 *
	gd–‘e_d©a_´oduûr
 = 
NULL
;

39 
	gkey_Ëngth_mš
;

40 
	gkey_Ëngth_max
;

41 
	gkey_Ëngth_¿nge_g­
;

42 
	gf›ld_Ëngth_max
;

43 
	g¡ršg_Ëngth_max
;

45 
	gcmd_ty³
;

47 
	gkey_ÿche_poŞs_couÁ
 = 0;

49 
d¬¿y
 
	gÃeded_cmd_ty³_´oduûr
;

50 
	gÃeded_cmd_ty³_´oduûr_couÁ
;

52 
	g´oduû_d©a_th»ads_couÁ
;

53 
d¬¿y
 
	g´oduû_th»ads
;

55 
	g´oduû_th»ads_·u£_fšished_couÁ
;

57 
	gnÚ_em±y_kıs_couÁ
 = 0;

58 
	gnÚ_em±y_kıs_idx
[
PRODUCE_KEY_CACHE_POOL_COUNT
] = {-1};

60 
sds
 
	$g‘_¿ndom_ÿched_key
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
)

62 
key_ÿche_¬¿y
 *
kı
 = 
	`kı_g‘_äom_ps
(
ps
,
dp
);

63  
	`key_ÿche_¬¿y_¿ndom
(
kı
);

64 
	}
}

66 
	$g‘_¿ndom_št
()

68 ià(
	`¿nd
()%2 == 1) {

69  0 - ()
	`¿nd
();

71  ()
	`¿nd
();

73 
	}
}

75 
	$g‘_¿ndom_unsigÃd_št
()

77  ()
	`¿nd
();

78 
	}
}

80 
	$g‘_¿ndom_ch¬
()

82  ()
	`¿nd
()%250 + 5;

84 
	}
}

86 
sds
 
	$g‘_¿ndom_key
()

88 
i
, 
Ën
;

89 
sds
 
¡r
 = 
	`sd£m±y
();

91 
Ën
 = 
key_Ëngth_¿nge_g­
==0?
key_Ëngth_mš
:

92 (
	`g‘_¿ndom_unsigÃd_št
()%
key_Ëngth_¿nge_g­
+
key_Ëngth_mš
);

93 ià(
Ën
 == 0)†en ++;

94 
¡r
 = 
	`sdsMakeRoomFÜ
(¡r,(
size_t
)
Ën
);

95 
	`sdsInüL’
(
¡r
, ()
Ën
);

97 
i
 = 0; i < 
Ën
; i ++) {

98 
¡r
[
i
] = ()
	`g‘_¿ndom_ch¬
();

101  
¡r
;

102 
	}
}

104 
sds
 
	$g‘_¿ndom_¡ršg
()

106 
i
, 
Ën
;

107 
sds
 
¡r
 = 
	`sd£m±y
();

109 
Ën
 = 
	`g‘_¿ndom_unsigÃd_št
()%
¡ršg_Ëngth_max
;

110 
¡r
 = 
	`sdsMakeRoomFÜ
(¡r,(
size_t
)
Ën
);

111 
	`sdsInüL’
(
¡r
, ()
Ën
);

113 
i
 = 0; i < 
Ën
; i ++) {

114 
¡r
[
i
] = 
	`g‘_¿ndom_ch¬
();

117  
¡r
;

118 
	}
}

120 
sds
 
	$g‘_¿ndom_æßt_¡r
()

122 
decim®_Ën
;

123 
sds
 
¡r
;

125 ià(
	`¿nd
()%2 == 1) {

126 
¡r
 = 
	`sd¢ew
("-");

128 
¡r
 = 
	`sd£m±y
();

131 ià(
	`¿nd
()%2 == 1) {

132 
¡r
 = 
	`sdsÿtfmt
(str,"%u.%u",

133 
	`g‘_¿ndom_unsigÃd_št
(),

134 
	`g‘_¿ndom_unsigÃd_št
());

136 
¡r
 = 
	`sdsÿtfmt
(str,"%u",

137 
	`g‘_¿ndom_unsigÃd_št
());

140  
¡r
;

141 
	}
}

143 
	#ZSET_RANGE_MIN_MAX_TYPE_RANK
 0

	)

144 
	#ZSET_RANGE_MIN_MAX_TYPE_SCORE
 1

	)

145 
	#ZSET_RANGE_MIN_MAX_TYPE_LEX
 2

	)

146 
sds
 *
	$g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
¿nge_ty³
)

148 
sds
 *
¿nge
;

149 
´obab™y
 = 
	`¿nd
()%100;

151 
¿nge
 = 
	`m®loc
(2*(
sds
));

152 ià(
¿nge_ty³
 =ğ
ZSET_RANGE_MIN_MAX_TYPE_RANK
) {

153 
mš
 = 
	`g‘_¿ndom_unsigÃd_št
();

154 
max
 = 
	`g‘_¿ndom_unsigÃd_št
();

156 ià(
´obab™y
 >ğ95 && 
mš
 <ğ
max
 ||

157 
´obab™y
 < 95 && 
mš
 > 
max
) {

158 
¿nge
[0] = 
	`sdsäomlÚglÚg
(()
max
);

159 
¿nge
[1] = 
	`sdsäomlÚglÚg
(()
mš
);

161 
¿nge
[0] = 
	`sdsäomlÚglÚg
(()
mš
);

162 
¿nge
[1] = 
	`sdsäomlÚglÚg
(()
max
);

164 } ià(
¿nge_ty³
 =ğ
ZSET_RANGE_MIN_MAX_TYPE_SCORE
) {

165 
sds
 
mš_¡r
 = 
	`g‘_¿ndom_æßt_¡r
();

166 
sds
 
max_¡r
 = 
	`g‘_¿ndom_æßt_¡r
();

167 
mš
, 
max
;

168 *
•Œ
;

169 
sds
 
sw­
;

170 
mš_´obab™y
 = 
	`¿nd
()%3;

171 
max_´obab™y
 = 
	`¿nd
()%3;

173 
mš
 = 
	`¡¹od
(
mš_¡r
,&
•Œ
);

174 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
mš
)) {

175 
	`sdsä“
(
mš_¡r
);

176 
	`sdsä“
(
max_¡r
);

177 
	`ä“
(
¿nge
);

178  
NULL
;

180 
max
 = 
	`¡¹od
(
max_¡r
,&
•Œ
);

181 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
max
)) {

182 
	`sdsä“
(
mš_¡r
);

183 
	`sdsä“
(
max_¡r
);

184 
	`ä“
(
¿nge
);

185  
NULL
;

187 ià(
´obab™y
 >ğ95 && 
mš
 <ğ
max
 ||

188 
´obab™y
 < 95 && 
mš
 > 
max
) {

189 
sw­
 = 
mš_¡r
;

190 
mš_¡r
 = 
max_¡r
;

191 
max_¡r
 = 
sw­
;

194 ià(
mš_´obab™y
 == 0) {

195 
¿nge
[0] = 
	`sd¢ew
("-inf");

196 } ià(
mš_´obab™y
 == 1) {

197 
¿nge
[0] = 
	`sd¢ew
("(");

198 
¿nge
[0] = 
	`sdsÿtfmt
Ôªge[0],"%S",
mš_¡r
);

199 
	`sdsä“
(
mš_¡r
);

201 
¿nge
[0] = 
mš_¡r
;

203 ià(
max_´obab™y
 == 0) {

204 
¿nge
[1] = 
	`sd¢ew
("+inf");

205 } ià(
max_´obab™y
 == 1) {

206 
¿nge
[1] = 
	`sd¢ew
("(");

207 
¿nge
[1] = 
	`sdsÿtfmt
Ôªge[1],"%S",
max_¡r
);

208 
	`sdsä“
(
max_¡r
);

210 
¿nge
[1] = 
max_¡r
;

212 } ià(
¿nge_ty³
 =ğ
ZSET_RANGE_MIN_MAX_TYPE_LEX
) {

213 
sds
 
mš_¡r
 = 
	`g‘_¿ndom_¡ršg
();

214 
sds
 
max_¡r
 = 
	`g‘_¿ndom_¡ršg
();

215 
sds
 
sw­
;

216 
mš_´obab™y
 = 
	`¿nd
()%3;

217 
max_´obab™y
 = 
	`¿nd
()%3;

219 ià(
´obab™y
 >ğ95 && 
	`sdscmp
(
mš_¡r
,
max_¡r
) < 0 ||

220 
´obab™y
 < 95 && 
	`sdscmp
(
mš_¡r
,
max_¡r
) > 0) {

221 
sw­
 = 
mš_¡r
;

222 
mš_¡r
 = 
max_¡r
;

223 
max_¡r
 = 
sw­
;

226 ià(
mš_´obab™y
 == 0) {

227 
¿nge
[0] = 
	`sd¢ew
("-");

228 } ià(
mš_´obab™y
 == 1) {

229 
¿nge
[0] = 
	`sd¢ew
("(");

230 
¿nge
[0] = 
	`sdsÿtfmt
Ôªge[0],"%S",
mš_¡r
);

231 
	`sdsä“
(
mš_¡r
);

233 
¿nge
[0] = 
	`sd¢ew
("[");

234 
¿nge
[0] = 
	`sdsÿtfmt
Ôªge[0],"%S",
mš_¡r
);

235 
	`sdsä“
(
mš_¡r
);

237 ià(
max_´obab™y
 == 0) {

238 
¿nge
[1] = 
	`sd¢ew
("+");

239 } ià(
max_´obab™y
 == 1) {

240 
¿nge
[1] = 
	`sd¢ew
("(");

241 
¿nge
[1] = 
	`sdsÿtfmt
Ôªge[1],"%S",
max_¡r
);

242 
	`sdsä“
(
max_¡r
);

244 
¿nge
[1] = 
	`sd¢ew
("[");

245 
¿nge
[1] = 
	`sdsÿtfmt
Ôªge[1],"%S",
max_¡r
);

246 
	`sdsä“
(
max_¡r
);

249 
	`ä“
(
¿nge
);

250 
¿nge
 = 
NULL
;

253  
¿nge
;

254 
	}
}

256 
	$g‘_¿ndom_f›ld_Ën
()

258  
	`g‘_¿ndom_unsigÃd_št
()%
f›ld_Ëngth_max
 + 1;

259 
	}
}

261 
sds
 
	$g‘_¿ndom_key_w™h_h™_¿tio
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
)

263 
sds
 
key
;

264 ià(
ps
->
h™_¿tio_¬¿y
[ps->
h™_¿tio_idx
++] == 0) {

265 
key
 = 
	`g‘_¿ndom_key
();

267 
key
 = 
	`g‘_¿ndom_ÿched_key
(
ps
,
dp
);

268 ià(
key
 =ğ
NULL
èkey = 
	`g‘_¿ndom_key
();

270 ià(
ps
->
h™_¿tio_idx
 >ğps->
h™_¿tio_¬¿y_Ën
) {

271 
ps
->
h™_¿tio_idx
 = 0;

273  
key
;

274 
	}
}

277 
	$nck_wh’_nÛ¼Ü
(
»disR•ly
 *
»¶y
)

279 ià(
»¶y
 =ğ
NULL
)  0;

281 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

286 
	}
}

288 
	$nck_wh’_ok
(
»disR•ly
 *
»¶y
)

290 ià(
»¶y
 =ğ
NULL
)  0;

292 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STATUS
 &&

293 !
	`¡rcmp
(
»¶y
->
¡r
, "OK")) {

298 
	}
}

300 
	$nck_wh’_¡r
(
»disR•ly
 *
»¶y
)

302 ià(
»¶y
 =ğ
NULL
)  0;

304 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
) {

309 
	}
}

311 
	$nck_wh’_unsigÃd_š‹g”
(
»disR•ly
 *
»¶y
)

313 ià(
»¶y
 =ğ
NULL
)  0;

315 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

316 
»¶y
->
š‹g”
 >= 0) {

321 
	}
}

323 
	$nck_wh’_nÚz”o_unsigÃd_š‹g”
(
»disR•ly
 *
»¶y
)

325 ià(
»¶y
 =ğ
NULL
)  0;

327 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

328 
»¶y
->
š‹g”
 > 0) {

333 
	}
}

335 
	$nck_wh’_z”o_Ü_Úe
(
»disR•ly
 *
»¶y
)

337 ià(
»¶y
 =ğ
NULL
)  0;

339 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

340 (
»¶y
->
š‹g”
 == 0 ||„eply->integer == 1)) {

345 
	}
}

347 
	$nck_wh’_Úe
(
»disR•ly
 *
»¶y
)

349 ià(
»¶y
 =ğ
NULL
)  0;

351 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

352 
»¶y
->
š‹g”
 == 1) {

357 
	}
}

361 
d©a_un™
 *
	$g‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

363 
d©a_un™
 *
du
;

365 
du
 = 
	`d©a_un™_g‘
();

366 
du
->
dp
 = dp;

367 
du
->
¬gc
 = 2;

368 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

369 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

370 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

372  
du
;

373 
	}
}

375 
d©a_un™
 *
	$£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

377 
d©a_un™
 *
du
;

379 
du
 = 
	`d©a_un™_g‘
();

380 
du
->
dp
 = dp;

381 
du
->
¬gc
 = 3;

382 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

383 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

384 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

385 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

387  
du
;

388 
	}
}

390 
d©a_un™
 *
	$£Šx_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

392 
d©a_un™
 *
du
;

394 
du
 = 
	`d©a_un™_g‘
();

395 
du
->
dp
 = dp;

396 
du
->
¬gc
 = 3;

397 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

398 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

399 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

400 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

402  
du
;

403 
	}
}

406 
	$£Šx_cmd_nck
(
»disR•ly
 *
»¶y
)

408 ià(
»¶y
 =ğ
NULL
)  0;

410 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

411 
»¶y
->
š‹g”
 == 1) {

416 
	}
}

418 
d©a_un™
 *
	$£‹x_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

420 
d©a_un™
 *
du
;

422 
du
 = 
	`d©a_un™_g‘
();

423 
du
->
dp
 = dp;

424 
du
->
¬gc
 = 4;

425 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

426 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

427 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

428 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

429 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

431  
du
;

432 
	}
}

434 
d©a_un™
 *
	$p£‹x_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

436 
d©a_un™
 *
du
;

438 
du
 = 
	`d©a_un™_g‘
();

439 
du
->
dp
 = dp;

440 
du
->
¬gc
 = 4;

441 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

442 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

443 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

444 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

445 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

447  
du
;

448 
	}
}

450 
d©a_un™
 *
	$d–_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

452 
d©a_un™
 *
du
;

454 
du
 = 
	`d©a_un™_g‘
();

455 
du
->
dp
 = dp;

456 
du
->
¬gc
 = 2;

457 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

458 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

459 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

461  
du
;

462 
	}
}

464 
d©a_un™
 *
	$expœe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

466 
d©a_un™
 *
du
;

468 
du
 = 
	`d©a_un™_g‘
();

469 
du
->
dp
 = dp;

470 
du
->
¬gc
 = 3;

471 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

472 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

473 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

474 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

476  
du
;

477 
	}
}

479 
d©a_un™
 *
	$expœ—t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

481 
d©a_un™
 *
du
;

483 
du
 = 
	`d©a_un™_g‘
();

484 
du
->
dp
 = dp;

485 
du
->
¬gc
 = 3;

486 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

487 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

488 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

489 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`v¹_m£c_now
()/1000LL+
	`¿nd
()%10000);

491  
du
;

492 
	}
}

494 
d©a_un™
 *
	$exi¡s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

496 
d©a_un™
 *
du
;

498 
du
 = 
	`d©a_un™_g‘
();

499 
du
->
dp
 = dp;

500 
du
->
¬gc
 = 2;

501 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

502 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

503 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

505  
du
;

506 
	}
}

508 
d©a_un™
 *
	$‰l_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

510 
d©a_un™
 *
du
;

512 
du
 = 
	`d©a_un™_g‘
();

513 
du
->
dp
 = dp;

514 
du
->
¬gc
 = 2;

515 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

516 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

517 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

519  
du
;

520 
	}
}

522 
d©a_un™
 *
	$±_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

524 
d©a_un™
 *
du
;

526 
du
 = 
	`d©a_un™_g‘
();

527 
du
->
dp
 = dp;

528 
du
->
¬gc
 = 2;

529 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

530 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

531 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

533  
du
;

534 
	}
}

536 
d©a_un™
 *
	$šü_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

538 
d©a_un™
 *
du
;

540 
du
 = 
	`d©a_un™_g‘
();

541 
du
->
dp
 = dp;

542 
du
->
¬gc
 = 2;

543 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

544 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

545 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

547  
du
;

548 
	}
}

550 
d©a_un™
 *
	$deü_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

552 
d©a_un™
 *
du
;

554 
du
 = 
	`d©a_un™_g‘
();

555 
du
->
dp
 = dp;

556 
du
->
¬gc
 = 2;

557 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

558 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

559 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

561  
du
;

562 
	}
}

564 
d©a_un™
 *
	$šüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

566 
d©a_un™
 *
du
;

568 
du
 = 
	`d©a_un™_g‘
();

569 
du
->
dp
 = dp;

570 
du
->
¬gc
 = 3;

571 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

572 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

573 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

574 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

576  
du
;

577 
	}
}

579 
d©a_un™
 *
	$deüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

581 
d©a_un™
 *
du
;

583 
du
 = 
	`d©a_un™_g‘
();

584 
du
->
dp
 = dp;

585 
du
->
¬gc
 = 3;

586 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

587 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

588 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

589 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

591  
du
;

592 
	}
}

594 
d©a_un™
 *
	$­³nd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

596 
d©a_un™
 *
du
;

598 
du
 = 
	`d©a_un™_g‘
();

599 
du
->
dp
 = dp;

600 
du
->
¬gc
 = 3;

601 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

602 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

603 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

604 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

606  
du
;

607 
	}
}

610 
	$­³nd_cmd_nck
(
»disR•ly
 *
»¶y
)

612 ià(
»¶y
 =ğ
NULL
)  0;

614 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

619 
	}
}

621 
d©a_un™
 *
	$¡¾’_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

623 
d©a_un™
 *
du
;

625 
du
 = 
	`d©a_un™_g‘
();

626 
du
->
dp
 = dp;

627 
du
->
¬gc
 = 2;

628 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

629 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

630 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

632  
du
;

633 
	}
}

635 
d©a_un™
 *
	$g‘£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

637 
d©a_un™
 *
du
;

639 
du
 = 
	`d©a_un™_g‘
();

640 
du
->
dp
 = dp;

641 
du
->
¬gc
 = 3;

642 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

643 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

644 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

645 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

647  
du
;

648 
	}
}

650 
d©a_un™
 *
	$šübyæßt_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

652 
d©a_un™
 *
du
;

654 
du
 = 
	`d©a_un™_g‘
();

655 
du
->
dp
 = dp;

656 
du
->
¬gc
 = 3;

657 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

658 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

659 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

660 
du
->
¬gv
[2] = 
	`g‘_¿ndom_æßt_¡r
();

662  
du
;

663 
	}
}

665 
d©a_un™
 *
	$£tb™_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

667 
d©a_un™
 *
du
;

669 
du
 = 
	`d©a_un™_g‘
();

670 
du
->
dp
 = dp;

671 
du
->
¬gc
 = 4;

672 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

673 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

674 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

675 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
()%30000);

676 ià(
	`¿nd
()%2) {

677 
du
->
¬gv
[3] = 
	`sd¢ew
("1");

679 
du
->
¬gv
[3] = 
	`sd¢ew
("0");

682  
du
;

683 
	}
}

685 
d©a_un™
 *
	$g‘b™_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

687 
d©a_un™
 *
du
;

689 
du
 = 
	`d©a_un™_g‘
();

690 
du
->
dp
 = dp;

691 
du
->
¬gc
 = 3;

692 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

693 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

694 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

695 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
()%30000);

697  
du
;

698 
	}
}

700 
d©a_un™
 *
	$£Œªge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

702 
d©a_un™
 *
du
;

704 
du
 = 
	`d©a_un™_g‘
();

705 
du
->
dp
 = dp;

706 
du
->
¬gc
 = 4;

707 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

708 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

709 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

710 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
()%30000);

711 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

713  
du
;

714 
	}
}

716 
d©a_un™
 *
	$g‘¿nge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

718 
d©a_un™
 *
du
;

720 
du
 = 
	`d©a_un™_g‘
();

721 
du
->
dp
 = dp;

722 
du
->
¬gc
 = 4;

723 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

724 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

725 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

726 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

727 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

729  
du
;

730 
	}
}

732 
d©a_un™
 *
	$b™couÁ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

734 
d©a_un™
 *
du
;

735 
w™h_¿nge
 = 0;

737 ià(
	`¿nd
()%2)

738 
w™h_¿nge
 = 1;

740 
du
 = 
	`d©a_un™_g‘
();

741 
du
->
dp
 = dp;

742 
du
->
¬gc
 = 
w™h_¿nge
?4:2;

743 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

744 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

745 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

746 ià(
w™h_¿nge
) {

747 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

748 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

750  
du
;

751 
	}
}

753 
d©a_un™
 *
	$b™pos_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

755 
d©a_un™
 *
du
;

756 
w™h_¿nge
 = 0;

757 
´obab™y
 = 
	`¿nd
()%3;

759 ià(
´obab™y
 == 0)

760 
w™h_¿nge
 = 0;

761 ià(
´obab™y
 == 1)

762 
w™h_¿nge
 = 1;

763 ià(
´obab™y
 == 2)

764 
w™h_¿nge
 = 2;

766 
du
 = 
	`d©a_un™_g‘
();

767 
du
->
dp
 = dp;

768 
du
->
¬gc
 = 
w™h_¿nge
==0?3:(with_range==1?4:5);

769 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

770 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

771 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

772 ià(
	`¿nd
()%2)

773 
du
->
¬gv
[2] = 
	`sd¢ew
("0");

775 
du
->
¬gv
[2] = 
	`sd¢ew
("1");

776 ià(
w™h_¿nge
 > 0)

777 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

778 ià(
w™h_¿nge
 == 2)

779 
du
->
¬gv
[4] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

781  
du
;

782 
	}
}

784 
d©a_un™
 *
	$mg‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

786 
d©a_un™
 *
du
;

788 
du
 = 
	`d©a_un™_g‘
();

789 
du
->
dp
 = dp;

790 
du
->
¬gc
 = 2;

791 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

792 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

793 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

795  
du
;

796 
	}
}

798 
d©a_un™
 *
	$m£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

800 
d©a_un™
 *
du
;

802 
du
 = 
	`d©a_un™_g‘
();

803 
du
->
dp
 = dp;

804 
du
->
¬gc
 = 3;

805 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

806 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

807 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

808 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

810  
du
;

811 
	}
}

813 
d©a_un™
 *
	$h£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

815 
d©a_un™
 *
du
;

817 
du
 = 
	`d©a_un™_g‘
();

818 
du
->
dp
 = dp;

819 
du
->
¬gc
 = 4;

820 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

821 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

822 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

823 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

824 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

826  
du
;

827 
	}
}

829 
d©a_un™
 *
	$hg‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

831 
d©a_un™
 *
du
;

833 
du
 = 
	`d©a_un™_g‘
();

834 
du
->
dp
 = dp;

835 
du
->
¬gc
 = 3;

836 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

837 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

838 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

839 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

841  
du
;

842 
	}
}

844 
d©a_un™
 *
	$hËn_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

846 
d©a_un™
 *
du
;

848 
du
 = 
	`d©a_un™_g‘
();

849 
du
->
dp
 = dp;

850 
du
->
¬gc
 = 2;

851 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

852 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

853 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

855  
du
;

856 
	}
}

858 
d©a_un™
 *
	$hd–_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

860 
d©a_un™
 *
du
;

861 
j
, 
f›ld_Ëngth
;

863 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

865 
du
 = 
	`d©a_un™_g‘
();

866 
du
->
dp
 = dp;

867 
du
->
¬gc
 = 2 + 
f›ld_Ëngth
;

868 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

869 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

870 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

871 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

872 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

875  
du
;

876 
	}
}

878 
d©a_un™
 *
	$hexi¡s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

880 
d©a_un™
 *
du
;

882 
du
 = 
	`d©a_un™_g‘
();

883 
du
->
dp
 = dp;

884 
du
->
¬gc
 = 3;

885 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

886 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

887 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

888 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

890  
du
;

891 
	}
}

893 
d©a_un™
 *
	$hkeys_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

895 
d©a_un™
 *
du
;

897 
du
 = 
	`d©a_un™_g‘
();

898 
du
->
dp
 = dp;

899 
du
->
¬gc
 = 2;

900 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

901 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

902 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

904  
du
;

905 
	}
}

907 
d©a_un™
 *
	$hv®s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

909 
d©a_un™
 *
du
;

911 
du
 = 
	`d©a_un™_g‘
();

912 
du
->
dp
 = dp;

913 
du
->
¬gc
 = 2;

914 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

915 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

916 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

918  
du
;

919 
	}
}

921 
d©a_un™
 *
	$hg‘®l_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

923 
d©a_un™
 *
du
;

925 
du
 = 
	`d©a_un™_g‘
();

926 
du
->
dp
 = dp;

927 
du
->
¬gc
 = 2;

928 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

929 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

930 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

932  
du
;

933 
	}
}

935 
d©a_un™
 *
	$hšüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

937 
d©a_un™
 *
du
;

939 
du
 = 
	`d©a_un™_g‘
();

940 
du
->
dp
 = dp;

941 
du
->
¬gc
 = 4;

942 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

943 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

944 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

945 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

946 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
());

948  
du
;

949 
	}
}

951 
d©a_un™
 *
	$hšübyæßt_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

953 
d©a_un™
 *
du
;

955 
du
 = 
	`d©a_un™_g‘
();

956 
du
->
dp
 = dp;

957 
du
->
¬gc
 = 4;

958 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

959 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

960 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

961 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

962 
du
->
¬gv
[3] = 
	`g‘_¿ndom_æßt_¡r
();

964  
du
;

965 
	}
}

967 
d©a_un™
 *
	$hmg‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

969 
d©a_un™
 *
du
;

970 
j
, 
f›ld_Ëngth
;

972 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

974 
du
 = 
	`d©a_un™_g‘
();

975 
du
->
dp
 = dp;

976 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

977 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

978 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

979 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

980 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

981 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

984  
du
;

985 
	}
}

987 
d©a_un™
 *
	$hm£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

989 
d©a_un™
 *
du
;

990 
j
, 
f›ld_Ëngth
;

992 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

994 
du
 = 
	`d©a_un™_g‘
();

995 
du
->
dp
 = dp;

996 
du
->
¬gc
 = 2+
f›ld_Ëngth
*2;

997 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

998 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

999 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1000 
j
 = 2; j < 2+
f›ld_Ëngth
*2; j += 2) {

1001 
du
->
¬gv
[
j
] = 
	`g‘_¿ndom_¡ršg
();

1002 
du
->
¬gv
[
j
+1] = 
	`g‘_¿ndom_¡ršg
();

1005  
du
;

1006 
	}
}

1008 
d©a_un™
 *
	$h£Šx_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1010 
d©a_un™
 *
du
;

1012 
du
 = 
	`d©a_un™_g‘
();

1013 
du
->
dp
 = dp;

1014 
du
->
¬gc
 = 4;

1015 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1016 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1017 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1018 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1019 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1021  
du
;

1022 
	}
}

1024 
d©a_un™
 *
	$h¡¾’_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1026 
d©a_un™
 *
du
;

1028 
du
 = 
	`d©a_un™_g‘
();

1029 
du
->
dp
 = dp;

1030 
du
->
¬gc
 = 3;

1031 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1032 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1033 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1034 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1036  
du
;

1037 
	}
}

1039 
d©a_un™
 *
	$½ush_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1041 
d©a_un™
 *
du
;

1042 
j
, 
f›ld_Ëngth
;

1044 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1046 
du
 = 
	`d©a_un™_g‘
();

1047 
du
->
dp
 = dp;

1048 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1049 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1050 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1051 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1052 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1053 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1056  
du
;

1057 
	}
}

1060 
	$½ush_cmd_nck
(
»disR•ly
 *
»¶y
)

1062 ià(
»¶y
 =ğ
NULL
)  0;

1064 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1069 
	}
}

1071 
d©a_un™
 *
	$Íush_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1073 
d©a_un™
 *
du
;

1074 
j
, 
f›ld_Ëngth
;

1076 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1078 
du
 = 
	`d©a_un™_g‘
();

1079 
du
->
dp
 = dp;

1080 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1081 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1082 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1083 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1085 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1086 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1089  
du
;

1090 
	}
}

1092 
d©a_un™
 *
	$Ìªge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1094 
d©a_un™
 *
du
;

1096 
du
 = 
	`d©a_un™_g‘
();

1097 
du
->
dp
 = dp;

1098 
du
->
¬gc
 = 4;

1099 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1100 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1101 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1102 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1103 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1105  
du
;

1106 
	}
}

1108 
d©a_un™
 *
	$½İ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1110 
d©a_un™
 *
du
;

1112 
du
 = 
	`d©a_un™_g‘
();

1113 
du
->
dp
 = dp;

1114 
du
->
¬gc
 = 2;

1115 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1116 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1117 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1119  
du
;

1120 
	}
}

1122 
d©a_un™
 *
	$Íİ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1124 
d©a_un™
 *
du
;

1126 
du
 = 
	`d©a_un™_g‘
();

1127 
du
->
dp
 = dp;

1128 
du
->
¬gc
 = 2;

1129 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1130 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1131 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1133  
du
;

1134 
	}
}

1136 
d©a_un™
 *
	$Î’_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1138 
d©a_un™
 *
du
;

1140 
du
 = 
	`d©a_un™_g‘
();

1141 
du
->
dp
 = dp;

1142 
du
->
¬gc
 = 2;

1143 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1144 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1145 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1147  
du
;

1148 
	}
}

1150 
d©a_un™
 *
	$Ìem_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1152 
d©a_un™
 *
du
;

1154 
du
 = 
	`d©a_un™_g‘
();

1155 
du
->
dp
 = dp;

1156 
du
->
¬gc
 = 4;

1157 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1158 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1159 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1160 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1161 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1163  
du
;

1164 
	}
}

1166 
d©a_un™
 *
	$Érim_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1168 
d©a_un™
 *
du
;

1170 
du
 = 
	`d©a_un™_g‘
();

1171 
du
->
dp
 = dp;

1172 
du
->
¬gc
 = 4;

1173 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1174 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1175 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1176 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1177 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1179  
du
;

1180 
	}
}

1182 
d©a_un™
 *
	$lšdex_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1184 
d©a_un™
 *
du
;

1186 
du
 = 
	`d©a_un™_g‘
();

1187 
du
->
dp
 = dp;

1188 
du
->
¬gc
 = 3;

1189 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1190 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1191 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1192 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1194  
du
;

1195 
	}
}

1197 
d©a_un™
 *
	$l£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1199 
d©a_un™
 *
du
;

1201 
du
 = 
	`d©a_un™_g‘
();

1202 
du
->
dp
 = dp;

1203 
du
->
¬gc
 = 4;

1204 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1205 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1206 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1207 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1208 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1210  
du
;

1211 
	}
}

1213 
d©a_un™
 *
	$§dd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1215 
d©a_un™
 *
du
;

1216 
j
, 
f›ld_Ëngth
;

1218 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1220 
du
 = 
	`d©a_un™_g‘
();

1221 
du
->
dp
 = dp;

1222 
du
->
¬gc
 = 2 + 
f›ld_Ëngth
;

1223 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1224 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1225 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1226 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1227 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1230  
du
;

1231 
	}
}

1233 
d©a_un™
 *
	$smemb”s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1235 
d©a_un™
 *
du
;

1237 
du
 = 
	`d©a_un™_g‘
();

1238 
du
->
dp
 = dp;

1239 
du
->
¬gc
 = 2;

1240 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1241 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1242 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1244  
du
;

1245 
	}
}

1247 
d©a_un™
 *
	$sÿrd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1249 
d©a_un™
 *
du
;

1251 
du
 = 
	`d©a_un™_g‘
();

1252 
du
->
dp
 = dp;

1253 
du
->
¬gc
 = 2;

1254 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1255 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1256 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1258  
du
;

1259 
	}
}

1261 
d©a_un™
 *
	$¤em_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1263 
d©a_un™
 *
du
;

1264 
j
, 
f›ld_Ëngth
;

1266 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1268 
du
 = 
	`d©a_un™_g‘
();

1269 
du
->
dp
 = dp;

1270 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1271 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1272 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1273 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1274 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1275 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1278  
du
;

1279 
	}
}

1281 
d©a_un™
 *
	$sismemb”_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1283 
d©a_un™
 *
du
;

1285 
du
 = 
	`d©a_un™_g‘
();

1286 
du
->
dp
 = dp;

1287 
du
->
¬gc
 = 3;

1288 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1289 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1290 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1291 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1293  
du
;

1294 
	}
}

1296 
d©a_un™
 *
	$suniÚ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1298 
d©a_un™
 *
du
;

1300 
du
 = 
	`d©a_un™_g‘
();

1301 
du
->
dp
 = dp;

1302 
du
->
¬gc
 = 2;

1303 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1304 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1305 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1307  
du
;

1308 
	}
}

1310 
d©a_un™
 *
	$sdiff_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1312 
d©a_un™
 *
du
;

1314 
du
 = 
	`d©a_un™_g‘
();

1315 
du
->
dp
 = dp;

1316 
du
->
¬gc
 = 2;

1317 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1318 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1319 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1321  
du
;

1322 
	}
}

1324 
d©a_un™
 *
	$sš‹r_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1326 
d©a_un™
 *
du
;

1328 
du
 = 
	`d©a_un™_g‘
();

1329 
du
->
dp
 = dp;

1330 
du
->
¬gc
 = 2;

1331 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1332 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1333 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1335  
du
;

1336 
	}
}

1339 
	$Íush_cmd_nck
(
»disR•ly
 *
»¶y
)

1341 ià(
»¶y
 =ğ
NULL
)  0;

1343 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1348 
	}
}

1350 
d©a_un™
 *
	$zadd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1352 
d©a_un™
 *
du
;

1353 
j
, 
f›ld_Ëngth
;

1355 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1357 
du
 = 
	`d©a_un™_g‘
();

1358 
du
->
dp
 = dp;

1359 
du
->
¬gc
 = 2+
f›ld_Ëngth
*2;

1360 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1361 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1362 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1364 
j
 = 2; j < 2+
f›ld_Ëngth
*2; j += 2) {

1365 
du
->
¬gv
[
j
] = 
	`g‘_¿ndom_æßt_¡r
();

1366 
du
->
¬gv
[
j
+1] = 
	`g‘_¿ndom_¡ršg
();

1369  
du
;

1370 
	}
}

1373 
	$zadd_cmd_nck
(
»disR•ly
 *
»¶y
)

1375 ià(
»¶y
 =ğ
NULL
)  0;

1377 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1382 
	}
}

1384 
d©a_un™
 *
	$zšüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1386 
d©a_un™
 *
du
;

1387 
j
, 
f›ld_Ëngth
;

1389 
du
 = 
	`d©a_un™_g‘
();

1390 
du
->
dp
 = dp;

1391 
du
->
¬gc
 = 4;

1392 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1393 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1394 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1395 
du
->
¬gv
[2] = 
	`g‘_¿ndom_æßt_¡r
();;

1396 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1398  
du
;

1399 
	}
}

1402 
	$zšüby_cmd_nck
(
»disR•ly
 *
»¶y
)

1404 ià(
»¶y
 =ğ
NULL
)  0;

1406 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1411 
	}
}

1413 
d©a_un™
 *
	$z¿nge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1415 
d©a_un™
 *
du
;

1416 
j
, 
f›ld_Ëngth
;

1417 
w™hscÜes
;

1419 ià(
	`¿nd
()%2 == 1) {

1420 
w™hscÜes
 = 1;

1422 
w™hscÜes
 = 0;

1425 
du
 = 
	`d©a_un™_g‘
();

1426 
du
->
dp
 = dp;

1427 
du
->
¬gc
 = 
w™hscÜes
?5:4;

1428 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1429 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1430 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1431 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(0);

1432 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%10000);

1433 ià(
w™hscÜes
è
du
->
¬gv
[4] = 
	`sd¢ew
("withscores");

1435  
du
;

1436 
	}
}

1438 
d©a_un™
 *
	$z»v¿nge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1440 
d©a_un™
 *
du
;

1441 
j
, 
f›ld_Ëngth
;

1442 
w™hscÜes
;

1444 ià(
	`¿nd
()%2 == 1) {

1445 
w™hscÜes
 = 1;

1447 
w™hscÜes
 = 0;

1450 
du
 = 
	`d©a_un™_g‘
();

1451 
du
->
dp
 = dp;

1452 
du
->
¬gc
 = 
w™hscÜes
?5:4;

1453 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1454 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1455 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1456 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(0);

1457 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%10000);

1458 ià(
w™hscÜes
è
du
->
¬gv
[4] = 
	`sd¢ew
("withscores");

1460  
du
;

1461 
	}
}

1463 
d©a_un™
 *
	$z»m_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1465 
d©a_un™
 *
du
;

1466 
j
, 
f›ld_Ëngth
;

1468 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1470 
du
 = 
	`d©a_un™_g‘
();

1471 
du
->
dp
 = dp;

1472 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1473 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1474 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1475 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1477 
j
 = 2; j < 2+
f›ld_Ëngth
; j ++) {

1478 
du
->
¬gv
[
j
] = 
	`g‘_¿ndom_¡ršg
();

1481  
du
;

1482 
	}
}

1484 
d©a_un™
 *
	$zÿrd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1486 
d©a_un™
 *
du
;

1488 
du
 = 
	`d©a_un™_g‘
();

1489 
du
->
dp
 = dp;

1490 
du
->
¬gc
 = 2;

1491 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1492 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1493 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1495  
du
;

1496 
	}
}

1498 
d©a_un™
 *
	$zcouÁ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1500 
d©a_un™
 *
du
;

1501 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1503 
du
 = 
	`d©a_un™_g‘
();

1504 
du
->
dp
 = dp;

1505 
du
->
¬gc
 = 4;

1506 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1507 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1508 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1509 
du
->
¬gv
[2] = 
¿nge
[0];

1510 
du
->
¬gv
[3] = 
¿nge
[1];

1512 
	`ä“
(
¿nge
);

1513  
du
;

1514 
	}
}

1516 
d©a_un™
 *
	$z¿ngebyscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1518 
d©a_un™
 *
du
;

1519 
idx
 = 0, 
¬g_couÁ
 = 0;

1520 
w™hscÜes
,
lim™
;

1521 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1523 
¬g_couÁ
 = 4;

1524 ià(
	`¿nd
()%2 == 1) {

1525 
w™hscÜes
 = 1;

1526 
¬g_couÁ
 ++;

1528 
w™hscÜes
 = 0;

1530 ià(
	`¿nd
()%2 == 1) {

1531 
lim™
 = 1;

1532 
¬g_couÁ
 += 3;

1534 
lim™
 = 0;

1537 
du
 = 
	`d©a_un™_g‘
();

1538 
du
->
dp
 = dp;

1539 
du
->
¬gc
 = 
¬g_couÁ
;

1540 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1541 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
(
dp
->
Çme
);

1542 
du
->
¬gv
[
idx
++] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1543 
du
->
¬gv
[
idx
++] = 
¿nge
[0];

1544 
du
->
¬gv
[
idx
++] = 
¿nge
[1];

1545 ià(
w™hscÜes
è
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("withscores");

1546 ià(
lim™
) {

1547 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("limit");

1548 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1549 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1552 
	`ASSERT
(
¬g_couÁ
 =ğ
idx
);

1554 
	`ä“
(
¿nge
);

1555  
du
;

1556 
	}
}

1558 
d©a_un™
 *
	$z»v¿ngebyscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1560 
d©a_un™
 *
du
;

1561 
idx
 = 0, 
¬g_couÁ
 = 0;

1562 
w™hscÜes
,
lim™
;

1563 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1565 
¬g_couÁ
 = 4;

1566 ià(
	`¿nd
()%2 == 1) {

1567 
w™hscÜes
 = 1;

1568 
¬g_couÁ
 ++;

1570 
w™hscÜes
 = 0;

1572 ià(
	`¿nd
()%2 == 1) {

1573 
lim™
 = 1;

1574 
¬g_couÁ
 += 3;

1576 
lim™
 = 0;

1579 
du
 = 
	`d©a_un™_g‘
();

1580 
du
->
dp
 = dp;

1581 
du
->
¬gc
 = 
¬g_couÁ
;

1582 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1583 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
(
dp
->
Çme
);

1584 
du
->
¬gv
[
idx
++] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1585 
du
->
¬gv
[
idx
++] = 
¿nge
[0];

1586 
du
->
¬gv
[
idx
++] = 
¿nge
[1];

1587 ià(
w™hscÜes
è
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("withscores");

1588 ià(
lim™
) {

1589 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("limit");

1590 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1591 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1594 
	`ASSERT
(
¬g_couÁ
 =ğ
idx
);

1596 
	`ä“
(
¿nge
);

1597  
du
;

1598 
	}
}

1600 
d©a_un™
 *
	$z¿nk_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1602 
d©a_un™
 *
du
;

1604 
du
 = 
	`d©a_un™_g‘
();

1605 
du
->
dp
 = dp;

1606 
du
->
¬gc
 = 3;

1607 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1608 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1609 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1610 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1612  
du
;

1613 
	}
}

1615 
d©a_un™
 *
	$z»v¿nk_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1617 
d©a_un™
 *
du
;

1619 
du
 = 
	`d©a_un™_g‘
();

1620 
du
->
dp
 = dp;

1621 
du
->
¬gc
 = 3;

1622 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1623 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1624 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1625 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1627  
du
;

1628 
	}
}

1630 
d©a_un™
 *
	$zscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1632 
d©a_un™
 *
du
;

1634 
du
 = 
	`d©a_un™_g‘
();

1635 
du
->
dp
 = dp;

1636 
du
->
¬gc
 = 3;

1637 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1638 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1639 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1640 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1642  
du
;

1643 
	}
}

1645 
d©a_un™
 *
	$z»m¿ngebyscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1647 
d©a_un™
 *
du
;

1648 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1650 
du
 = 
	`d©a_un™_g‘
();

1651 
du
->
dp
 = dp;

1652 
du
->
¬gc
 = 4;

1653 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1654 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1655 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1656 
du
->
¬gv
[2] = 
¿nge
[0];

1657 
du
->
¬gv
[3] = 
¿nge
[1];

1659 
	`ä“
(
¿nge
);

1660  
du
;

1661 
	}
}

1663 
d©a_un™
 *
	$z»m¿ngeby¿nk_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1665 
d©a_un™
 *
du
;

1666 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_RANK
);

1668 
du
 = 
	`d©a_un™_g‘
();

1669 
du
->
dp
 = dp;

1670 
du
->
¬gc
 = 4;

1671 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1672 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1673 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1674 
du
->
¬gv
[2] = 
¿nge
[0];

1675 
du
->
¬gv
[3] = 
¿nge
[1];

1677 
	`ä“
(
¿nge
);

1678  
du
;

1679 
	}
}

1681 
d©a_un™
 *
	$z»m¿ngebyËx_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1683 
d©a_un™
 *
du
;

1684 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_LEX
);

1686 
du
 = 
	`d©a_un™_g‘
();

1687 
du
->
dp
 = dp;

1688 
du
->
¬gc
 = 4;

1689 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1690 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1691 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1692 
du
->
¬gv
[2] = 
¿nge
[0];

1693 
du
->
¬gv
[3] = 
¿nge
[1];

1695 
	`ä“
(
¿nge
);

1696  
du
;

1697 
	}
}

1699 
	g´oduûrs_couÁ
;

1700 
d©a_´oduûr
 
	g»dis_d©a_´oduûr_bË
[] = {

1702 {"d–",
d–_cmd_´oduûr
,-2,"w",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_KEY
,NULL},

1703 {"exi¡s",
exi¡s_cmd_´oduûr
,-2,"rF",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_KEY
,NULL},

1704 {"‰l",
‰l_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1705 {"±",
±_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1706 {"expœe",
expœe_cmd_´oduûr
,3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1707 {"expœ—t",
expœ—t_cmd_´oduûr
,3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1709 {"g‘",
g‘_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1710 {"£t",
£t_cmd_´oduûr
,-3,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_ok
},

1711 {"£Šx",
£Šx_cmd_´oduûr
,3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
£Šx_cmd_nck
},

1712 {"£‹x",
£‹x_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,
nck_wh’_ok
},

1713 {"p£‹x",
p£‹x_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,
nck_wh’_ok
},

1714 {"šü",
šü_cmd_´oduûr
,2,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1715 {"deü",
deü_cmd_´oduûr
,2,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1716 {"šüby",
šüby_cmd_´oduûr
,3,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1717 {"deüby",
deüby_cmd_´oduûr
,3,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1718 {"­³nd",
­³nd_cmd_´oduûr
,3,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
­³nd_cmd_nck
},

1719 {"¡¾’",
¡¾’_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1720 {"g‘£t",
g‘£t_cmd_´oduûr
,3,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_nÛ¼Ü
},

1721 {"šübyæßt",
šübyæßt_cmd_´oduûr
,3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_¡r
},

1722 {"£tb™",
£tb™_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_z”o_Ü_Úe
},

1723 {"g‘b™",
g‘b™_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1724 {"£Œªge",
£Œªge_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_nÚz”o_unsigÃd_š‹g”
},

1725 {"g‘¿nge",
g‘¿nge_cmd_´oduûr
,4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1726 {"b™couÁ",
b™couÁ_cmd_´oduûr
,-2,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1727 {"b™pos",
b™pos_cmd_´oduûr
,-3,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1728 {"mg‘",
mg‘_cmd_´oduûr
,-2,"r",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_STRING
,NULL},

1729 {"m£t",
m£t_cmd_´oduûr
,-3,"wmA",0,
NULL
,1,-1,2,
TEST_CMD_TYPE_STRING
,
nck_wh’_ok
},

1731 {"h£t",
h£t_cmd_´oduûr
,4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,
nck_wh’_Úe
},

1732 {"hg‘",
hg‘_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1733 {"hËn",
hËn_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1734 {"hd–",
hd–_cmd_´oduûr
,-3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1735 {"hexi¡s",
hexi¡s_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1736 {"hkeys",
hkeys_cmd_´oduûr
,2,"rS",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1737 {"hv®s",
hv®s_cmd_´oduûr
,2,"rS",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1738 {"hg‘®l",
hg‘®l_cmd_´oduûr
,2,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1739 {"hšüby",
hšüby_cmd_´oduûr
,4,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1740 {"hšübyæßt",
hšübyæßt_cmd_´oduûr
,4,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1741 {"hmg‘",
hmg‘_cmd_´oduûr
,-3,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1742 {"hm£t",
hm£t_cmd_´oduûr
,-4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,
nck_wh’_ok
},

1743 {"h£Šx",
h£Šx_cmd_´oduûr
,4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,
nck_wh’_Úe
},

1744 {"h¡¾’",
h¡¾’_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1746 {"½ush",
½ush_cmd_´oduûr
,-3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,
½ush_cmd_nck
},

1747 {"Íush",
Íush_cmd_´oduûr
,-3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,
Íush_cmd_nck
},

1748 {"Ìªge",
Ìªge_cmd_´oduûr
,4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1749 {"½İ",
½İ_cmd_´oduûr
,2,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1750 {"Íİ",
Íİ_cmd_´oduûr
,2,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1751 {"Î’",
Î’_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1752 {"Ìem",
Ìem_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1753 {"Érim",
Érim_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1754 {"lšdex",
lšdex_cmd_´oduûr
,3,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1755 {"l£t",
l£t_cmd_´oduûr
,4,"wm",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1757 {"§dd",
§dd_cmd_´oduûr
,-3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,
nck_wh’_unsigÃd_š‹g”
},

1758 {"smemb”s",
smemb”s_cmd_´oduûr
,2,"rS",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1759 {"sÿrd",
sÿrd_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1760 {"¤em",
¤em_cmd_´oduûr
,-3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1761 {"sismemb”",
sismemb”_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1762 {"suniÚ",
suniÚ_cmd_´oduûr
,-2,"rS",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_SET
,NULL},

1763 {"sdiff",
sdiff_cmd_´oduûr
,-2,"rS",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_SET
,NULL},

1764 {"sš‹r",
sš‹r_cmd_´oduûr
,-2,"rS",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_SET
,NULL},

1766 {"zadd",
zadd_cmd_´oduûr
,-4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,
zadd_cmd_nck
},

1767 {"zšüby",
zšüby_cmd_´oduûr
,4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,
zšüby_cmd_nck
},

1768 {"z¿nge",
z¿nge_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1769 {"z»v¿nge",
z»v¿nge_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1770 {"z»m",
z»m_cmd_´oduûr
,-3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1771 {"zÿrd",
zÿrd_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1772 {"zcouÁ",
zcouÁ_cmd_´oduûr
,4,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1773 {"z¿ngebyscÜe",
z¿ngebyscÜe_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1774 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜe_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1775 {"z¿nk",
z¿nk_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1776 {"z»v¿nk",
z»v¿nk_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1777 {"zscÜe",
zscÜe_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1778 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜe_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1779 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nk_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL}

1782 
d©a_un™
 *
	$d©a_un™_g‘
()

1784 
d©a_un™
 *
du
 = 
	`m®loc
((data_unit));

1785 
du
->
dp
 = 
NULL
;

1786 
du
->
¬gc
 = 0;

1787 
du
->
¬gv
 = 
NULL
;

1788 
du
->
hashv®ue
 = 0;

1789 
du
->
d©a
 = 
NULL
;

1790  
du
;

1791 
	}
}

1793 
	$d©a_un™_put
(
d©a_un™
 *
du
)

1795 
idx
;

1797 
idx
 = 0; idx < 
du
->
¬gc
; idx ++) {

1798 ià(
du
->
¬gv
[
idx
])

1799 
	`sdsä“
(
du
->
¬gv
[
idx
]);

1801 
	`ä“
(
du
->
¬gv
);

1802 
	`ä“
(
du
);

1803 
	}
}

1805 
´oduû_scheme
 *
	$´oduû_scheme_ü—‹
(
max_ÿched_keys
, 
h™_¿tio
)

1807 
´oduû_scheme
 *
ps
;

1808 
couÁ
, 
idx
;

1809 
¿tio
;

1811 
ps
 = 
	`m®loc
((*ps));

1812 ià(
ps
 =ğ
NULL
)  NULL;

1813 
ps
->
kıs
 = 
NULL
;

1814 
ps
->
h™_¿tio_¬¿y
 = 
NULL
;

1816 
ps
->
kıs
 = 
	`d¬¿y_ü—‹
(
PRODUCE_KEY_CACHE_POOL_COUNT
,(
key_ÿche_¬¿y
 *));

1817 
idx
 = 0; idx < 
PRODUCE_KEY_CACHE_POOL_COUNT
; idx ++) {

1818 
key_ÿche_¬¿y
 **
kı
 = 
	`d¬¿y_push
(
ps
->
kıs
);

1819 *
kı
 = 
	`key_ÿche_¬¿y_ü—‹
(
max_ÿched_keys
/
PRODUCE_KEY_CACHE_POOL_COUNT
);

1820 ià(*
kı
 =ğ
NULL
) {

1821  
NULL
;

1826 
ps
->
h™_¿tio_¬¿y_Ën
 = 100;

1827 
ps
->
h™_¿tio
 = hit_ratio;

1828 
ps
->
h™_¿tio_idx
 = 0;

1829 
ps
->
h™_¿tio_¬¿y
 = 
	`m®loc
Õs->
h™_¿tio_¬¿y_Ën
*());

1830 
¿tio
 = 
ps
->
h™_¿tio_¬¿y_Ën
/ps->
h™_¿tio
;

1831 ià(
¿tio
 > 1) {

1832 
couÁ
 = 
ps
->
h™_¿tio
;

1833 
idx
 = 0; idx < 
ps
->
h™_¿tio_¬¿y_Ën
; idx ++) {

1834 
ps
->
h™_¿tio_¬¿y
[
idx
] = 0;

1837 
couÁ
 = 
ps
->
h™_¿tio_¬¿y_Ën
 -…s->
h™_¿tio
;

1838 
idx
 = 0; idx < 
ps
->
h™_¿tio_¬¿y_Ën
; idx ++) {

1839 
ps
->
h™_¿tio_¬¿y
[
idx
] = 1;

1842 
couÁ
 > 0) {

1843 
idx
 = 
	`¿nd
()%
ps
->
h™_¿tio_¬¿y_Ën
;

1844 ià(
¿tio
 > 1) {

1845 ià(
ps
->
h™_¿tio_¬¿y
[
idx
] == 0) {

1846 
couÁ
 --;

1847 
ps
->
h™_¿tio_¬¿y
[
idx
] = 1;

1850 ià(
ps
->
h™_¿tio_¬¿y
[
idx
] == 1) {

1851 
couÁ
 --;

1852 
ps
->
h™_¿tio_¬¿y
[
idx
] = 0;

1857  
ps
;

1858 
	}
}

1860 
	$´oduû_scheme_de¡roy
(
´oduû_scheme
 *
ps
)

1862 
j
;

1863 ià(
ps
->
kıs
) {

1864 
j
 = 0; j < 
PRODUCE_KEY_CACHE_POOL_COUNT
; j ++) {

1865 
key_ÿche_¬¿y
 **
kı
 = 
	`d¬¿y_pİ
(
ps
->
kıs
);

1866 ià(*
kı
)
	`key_ÿche_¬¿y_de¡roy
(*kcp);

1868 
	`d¬¿y_de¡roy
(
ps
->
kıs
);

1871 
	`ä“
(
ps
->
h™_¿tio_¬¿y
);

1873 
	`ä“
(
ps
);

1874 
	}
}

1876 
	$g‘_kı_idx
(
ty³
)

1878 
idx
;

1880 
ty³
)

1882 
TEST_CMD_TYPE_STRING
:

1883 
idx
 = 0;

1886 
TEST_CMD_TYPE_LIST
:

1887 
idx
 = 1;

1890 
TEST_CMD_TYPE_SET
:

1891 
idx
 = 2;

1894 
TEST_CMD_TYPE_ZSET
:

1895 
idx
 = 3;

1898 
TEST_CMD_TYPE_HASH
:

1899 
idx
 = 4;

1903 
idx
 = -1;

1907  
idx
;

1908 
	}
}

1910 
	$£t_nÚ_em±y_kıs_idx
()

1912 ià(
cmd_ty³
&
TEST_CMD_TYPE_STRING
) {

1913 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1914 
	`g‘_kı_idx
(
TEST_CMD_TYPE_STRING
);

1916 ià(
cmd_ty³
&
TEST_CMD_TYPE_LIST
) {

1917 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1918 
	`g‘_kı_idx
(
TEST_CMD_TYPE_LIST
);

1920 ià(
cmd_ty³
&
TEST_CMD_TYPE_SET
) {

1921 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1922 
	`g‘_kı_idx
(
TEST_CMD_TYPE_SET
);

1924 ià(
cmd_ty³
&
TEST_CMD_TYPE_ZSET
) {

1925 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1926 
	`g‘_kı_idx
(
TEST_CMD_TYPE_ZSET
);

1928 ià(
cmd_ty³
&
TEST_CMD_TYPE_HASH
) {

1929 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1930 
	`g‘_kı_idx
(
TEST_CMD_TYPE_HASH
);

1932 
	}
}

1935 
key_ÿche_¬¿y
 *
	$kı_g‘_äom_ps
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
)

1937 
idx
;

1938 
key_ÿche_¬¿y
 **
kı
;

1940 ià(
ps
 =ğ
NULL
 ||…s->
kıs
 =ğNULL || 
dp
 == NULL)  NULL;

1942 ià(
dp
->
cmd_ty³
 =ğ
TEST_CMD_TYPE_KEY
) {

1943 ià(
nÚ_em±y_kıs_couÁ
==0) {

1944 
idx
 = -1;

1946 
idx
 = 
	`¿nd
()%
nÚ_em±y_kıs_couÁ
;

1947 
idx
 = 
nÚ_em±y_kıs_idx
[idx];

1948 
	`ASSERT
(
idx
 >= 0);

1951 
idx
 = 
	`g‘_kı_idx
(
dp
->
cmd_ty³
);

1954 ià(
idx
 >ğ
PRODUCE_KEY_CACHE_POOL_COUNT
 || idx < 0) {

1955  
NULL
;

1958 
kı
 = 
	`d¬¿y_g‘
(
ps
->
kıs
, 
idx
);

1960  *
kı
;

1961 
	}
}

1963 
	$v¹_´oduû_th»ads_š™
(
´oduû_th»ads_couÁ
,

1964 
ÿched_keys
, 
h™_¿tio
)

1966 
idx
;

1967 
	`d¬¿y_š™
(&
´oduû_th»ads
, 
´oduû_th»ads_couÁ
, (
´oduû_th»ad
));

1968 
´oduû_d©a_th»ads_couÁ
 = 
´oduû_th»ads_couÁ
;

1969 
idx
 = 0; idx < 
´oduû_th»ads_couÁ
; idx ++) {

1970 
´oduû_th»ad
 *
±
 = 
	`d¬¿y_push
(&
´oduû_th»ads
);

1971 
±
->
id
 = 
idx
;

1972 
±
->
th»ad_id
 = 0;

1973 
±
->
ps
 = 
	`´oduû_scheme_ü—‹
(
ÿched_keys
, 
h™_¿tio
);

1974 
±
->
·u£
 = 0;

1975 
±
->
loİtimes
 = 0;

1978  
VRT_OK
;

1979 
	}
}

1981 
	$v¹_´oduû_th»ads_deš™
()

1983 
´oduû_th»ad
 *
±
;

1984 
	`d¬¿y_n
(&
´oduû_th»ads
) > 0) {

1985 
±
 = 
	`d¬¿y_pİ
(&
´oduû_th»ads
);

1986 ià(
±
->
ps
) {

1987 
	`´oduû_scheme_de¡roy
(
±
->
ps
);

1988 
±
->
ps
 = 
NULL
;

1991 
	`d¬¿y_deš™
(&
´oduû_th»ads
);

1992 
	}
}

1994 *
	$v¹_´oduû_th»ad_run
(*
¬gs
)

1996 
»t
;

1997 
´oduû_th»ad
 *
±
 = 
¬gs
;

1998 
idx
, 
j
;

1999 
d©a_´oduûr
 **
dp
;

2000 
d©a_un™
 *
du
;

2002 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

2006 ià(
±
->
·u£
) {

2007 
	`u¦“p
(1000000);

2008 ià(!
	`‹¡_if_Ãed_·u£
()) {

2009 
±
->
·u£
 = 0;

2013 } ià(
±
->
loİtimes
%10000 == 0) {

2014 ià(
	`‹¡_if_Ãed_·u£
()) {

2015 
±
->
·u£
 = 1;

2016 
	`Úe_´oduû_th»ad_·u£d
();

2021 
idx
 = 
	`¿nd
()%
Ãeded_cmd_ty³_´oduûr_couÁ
;

2022 
dp
 = 
	`d¬¿y_g‘
(&
Ãeded_cmd_ty³_´oduûr
,
idx
);

2023 
du
 = (*
dp
)->
	`´oc
(*dp,
±
->
ps
);

2025 
du
->
d©a
 = 
±
->
ps
;

2028 
»t
 = 
	`d©a_di¥©ch
(
du
);

2029 ià(
»t
 == -1) {

2030 
	`d©a_un™_put
(
du
);

2031 } ià(
»t
 == 1) {

2032 
	`u¦“p
(100000);

2035 
±
->
loİtimes
 ++;

2038  
NULL
;

2039 
	}
}

2041 
	$add_to_Ãeded_cmd_ty³_´oduûr
(
d©a_´oduûr
 *
dp
)

2043 
d©a_´oduûr
 **
dp_–em
 = 
	`d¬¿y_push
(&
Ãeded_cmd_ty³_´oduûr
);

2045 *
dp_–em
 = 
dp
;

2046 
Ãeded_cmd_ty³_´oduûr_couÁ
 ++;

2048  
VRT_OK
;

2049 
	}
}

2051 
	$v¹_´oduû_d©a_š™
(
key_Ëngth_¿nge_mš
,
key_Ëngth_¿nge_max
,

2052 
¡ršg_max_Ëngth
,
f›lds_max_couÁ
,

2053 
´oduû_cmd_ty³s
,
d¬¿y
 *
´oduû_cmd_bÏckli¡
,d¬¿y *
´oduû_cmd_wh™–i¡
,

2054 
´oduû_th»ads_couÁ
,
ÿched_keys
,

2055 
h™_¿tio
)

2057 
j
, 
k
;

2059 
key_Ëngth_mš
 = 
key_Ëngth_¿nge_mš
;

2060 
key_Ëngth_max
 = 
key_Ëngth_¿nge_max
;

2061 ià(
key_Ëngth_max
 < 
key_Ëngth_mš
è 
VRT_ERROR
;

2062 
key_Ëngth_¿nge_g­
 = 
key_Ëngth_max
-
key_Ëngth_mš
;

2063 
f›ld_Ëngth_max
 = 
f›lds_max_couÁ
;

2064 
¡ršg_Ëngth_max
 = 
¡ršg_max_Ëngth
;

2065 
cmd_ty³
 = 
´oduû_cmd_ty³s
;

2066 
	`d¬¿y_š™
(&
Ãeded_cmd_ty³_´oduûr
, 100, (
d©a_´oduûr
*));

2068 
´oduûrs_couÁ
 = (
»dis_d©a_´oduûr_bË
)/(
d©a_´oduûr
);

2069 
j
 = 0; j < 
´oduûrs_couÁ
; j++) {

2070 
d©a_´oduûr
 *
dp
 = 
»dis_d©a_´oduûr_bË
+
j
;

2071 *
f
 = 
dp
->
sæags
;

2073 *
f
 != '\0') {

2074 *
f
) {

2075 'w': 
dp
->
æags
 |ğ
PRO_WRITE
; ;

2076 'r': 
dp
->
æags
 |ğ
PRO_READONLY
; ;

2077 'm': 
dp
->
æags
 |ğ
PRO_DENYOOM
; ;

2078 'a': 
dp
->
æags
 |ğ
PRO_ADMIN
; ;

2079 'p': 
dp
->
æags
 |ğ
PRO_PUBSUB
; ;

2080 's': 
dp
->
æags
 |ğ
PRO_NOSCRIPT
; ;

2081 'R': 
dp
->
æags
 |ğ
PRO_RANDOM
; ;

2082 'S': 
dp
->
æags
 |ğ
PRO_SORT_FOR_SCRIPT
; ;

2083 'l': 
dp
->
æags
 |ğ
PRO_LOADING
; ;

2084 't': 
dp
->
æags
 |ğ
PRO_STALE
; ;

2085 'M': 
dp
->
æags
 |ğ
PRO_SKIP_MONITOR
; ;

2086 'k': 
dp
->
æags
 |ğ
PRO_ASKING
; ;

2087 'F': 
dp
->
æags
 |ğ
PRO_FAST
; ;

2088 'A': 
dp
->
æags
 |ğ
PRO_ADD
; ;

2089 :  
VRT_ERROR
;

2091 
f
++;

2094 ià(
d–‘e_d©a_´oduûr
 =ğ
NULL
 &&

2095 !
	`¡rcmp
(
dp
->
Çme
,"del")) {

2096 
d–‘e_d©a_´oduûr
 = 
dp
;

2099 ià(
´oduû_cmd_wh™–i¡
 !ğ
NULL
) {

2100 
k
 = 0; k < 
	`d¬¿y_n
(
´oduû_cmd_wh™–i¡
); k ++) {

2101 
sds
 *
cmdÇme
 = 
	`d¬¿y_g‘
(
´oduû_cmd_wh™–i¡
, 
k
);

2102 ià(!
	`¡rÿ£cmp
(
dp
->
Çme
,*
cmdÇme
)) {

2103 
	`add_to_Ãeded_cmd_ty³_´oduûr
(
dp
);

2111 ià(
´oduû_cmd_bÏckli¡
 !ğ
NULL
) {

2112 
is_š_bÏckli¡
 = 0;

2113 
k
 = 0; k < 
	`d¬¿y_n
(
´oduû_cmd_bÏckli¡
); k ++) {

2114 
sds
 *
cmdÇme
 = 
	`d¬¿y_g‘
(
´oduû_cmd_bÏckli¡
, 
k
);

2115 ià(!
	`¡rÿ£cmp
(
dp
->
Çme
,*
cmdÇme
)) {

2116 
is_š_bÏckli¡
 = 1;

2121 ià(
is_š_bÏckli¡
) {

2127 ià(
dp
->
cmd_ty³
&cmd_type) {

2128 
	`add_to_Ãeded_cmd_ty³_´oduûr
(
dp
);

2130 ià(
dp
->
cmd_ty³
&
TEST_CMD_TYPE_EXPIRE
 && 
expœe_’abËd
) {

2131 
	`add_to_Ãeded_cmd_ty³_´oduûr
(
dp
);

2135 
	`£t_nÚ_em±y_kıs_idx
();

2137 ià(
	`d¬¿y_n
(&
Ãeded_cmd_ty³_´oduûr
) == 0) {

2138 
	`log_”rÜ
("No command‚eedoest");

2139  
VRT_ERROR
;

2142 ià(
d–‘e_d©a_´oduûr
 =ğ
NULL
) {

2143  
VRT_ERROR
;

2146 ià(
Ãeded_cmd_ty³_´oduûr_couÁ
 == 0) {

2147  
VRT_ERROR
;

2150 
j
 = 0; j < 
Ãeded_cmd_ty³_´oduûr_couÁ
; j ++) {

2151 
d©a_´oduûr
 **
dp_–em
 = 
	`d¬¿y_g‘
(&
Ãeded_cmd_ty³_´oduûr
,
j
);

2152 
	`log_debug
(
LOG_INFO
, "Ãedede¡ commªd[%d]: %s", 
j
, (*
dp_–em
)->
Çme
);

2155 
	`v¹_´oduû_th»ads_š™
(
´oduû_th»ads_couÁ
, 
ÿched_keys
, 
h™_¿tio
);

2157  
VRT_OK
;

2158 
	}
}

2160 
	$v¹_´oduû_d©a_deš™
()

2162 
	`v¹_´oduû_th»ads_deš™
();

2164 
Ãeded_cmd_ty³_´oduûr
.
ÃËm
 = 0;

2165 
	`d¬¿y_deš™
(&
Ãeded_cmd_ty³_´oduûr
);

2166 
	}
}

2168 
	$v¹_¡¬t_´oduû_d©a
()

2170 
i
;

2171 
i
 = 0; i < 
	`d¬¿y_n
(&
´oduû_th»ads
); i ++) {

2172 
±h»ad_©Œ_t
 
©Œ
;

2173 
´oduû_th»ad
 *
±
;

2174 
	`±h»ad_©Œ_š™
(&
©Œ
);

2175 
±
 = 
	`d¬¿y_g‘
(&
´oduû_th»ads
, 
i
);

2176 
	`±h»ad_ü—‹
(&
±
->
th»ad_id
,

2177 &
©Œ
, 
v¹_´oduû_th»ad_run
, 
±
);

2180 
Ï¡_‹¡_begš_time
 = 
	`v¹_£c_now
();

2181  
VRT_OK
;

2182 
	}
}

2184 
	$v¹_wa™_´oduû_d©a
()

2186 
i
;

2188 
i
 = 0; i < 
	`d¬¿y_n
(&
´oduû_th»ads
); i ++){

2189 
´oduû_th»ad
 *
±
 = 
	`d¬¿y_g‘
(&
´oduû_th»ads
, 
i
);

2190 
	`±h»ad_još
(
±
->
th»ad_id
, 
NULL
);

2193  
VRT_OK
;

2194 
	}
}

2202 *
	$g‘_keys_usšg_d©a_´oduûr_bË
(
d©a_´oduûr
 *
dp
,
sds
 *
¬gv
, 
¬gc
, *
numkeys
) {

2203 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

2205 ià(
dp
->
fœ¡key
 == 0) {

2206 *
numkeys
 = 0;

2207  
NULL
;

2209 
Ï¡
 = 
dp
->
Ï¡key
;

2210 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

2211 
keys
 = 
	`m®loc
(()*((
Ï¡
 - 
dp
->
fœ¡key
)+1));

2212 
j
 = 
dp
->
fœ¡key
; j <ğ
Ï¡
; j +ğdp->
key¡•
) {

2213 
keys
[
i
++] = 
j
;

2215 *
numkeys
 = 
i
;

2216  
keys
;

2217 
	}
}

2230 *
	$g‘_keys_äom_d©a_´oduûr
(
d©a_´oduûr
 *
dp
, 
sds
 *
¬gv
, 
¬gc
, *
numkeys
) {

2231 ià(
dp
->
g‘keys_´oc
) {

2232  
dp
->
	`g‘keys_´oc
(dp,
¬gv
,
¬gc
,
numkeys
);

2234  
	`g‘_keys_usšg_d©a_´oduûr_bË
(
dp
,
¬gv
,
¬gc
,
numkeys
);

2236 
	}
}

2238 
sds
 
	$g‘_Úe_key_äom_d©a_un™
(
d©a_un™
 *
du
)

2240 
numkeys
;

2241 *
keyšdex
;

2242 
sds
 
key
;

2244 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
,du->
¬gv
,du->
¬gc
,&
numkeys
);

2245 ià(
numkeys
 <= 0) {

2246 
	`NOT_REACHED
();

2247  
NULL
;

2250 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

2251 
	`ä“
(
keyšdex
);

2253  
key
;

2254 
	}
}

2256 
	$´št_´oduûr_commªd
(
d©a_un™
 *
du
)

2258 
j
;

2259 
sds
 
cmd
 = 
	`sd£m±y
();

2261 
j
 = 0; j < 
du
->
¬gc
; j ++) {

2262 
cmd
 = 
	`sdsÿtsds
(cmd,
du
->
¬gv
[
j
]);

2263 
cmd
 = 
	`sdsÿt
(cmd," ");

2265 
cmd
 = 
	`sdsÿt
(cmd,"\n");

2266 
	`log_wr™e_Ën
(
cmd
,
	`sd¦’
(cmd));

2267 
	`sdsä“
(
cmd
);

2268 
	}
}

	@tests/vrt_produce_data.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<as£¹.h
>

9 
	~<m©h.h
>

10 
	~<sys/¡©.h
>

11 
	~<sys/ut¢ame.h
>

13 
	~<d¥ecŸlcÚfig.h
>

15 
	~<hœedis.h
>

16 
	~<d¬¿y.h
>

17 
	~<dut.h
>

18 
	~<dlog.h
>

20 
	~<v¹_ut.h
>

21 
	~<v¹_public.h
>

22 
	~<v¿b‹¡.h
>

23 
	~<v¹_´oduû_d©a.h
>

25 
	#PRODUCE_KEY_CACHE_POOL_COUNT
 5

	)

27 
	s´oduû_th»ad
 {

28 
	mid
;

29 
±h»ad_t
 
	mth»ad_id
;

31 
´oduû_scheme
 *
	mps
;

33 
	m·u£
;

34 
	mloİtimes
;

35 } 
	t´oduû_th»ad
;

37 
d©a_´oduûr
 *
	gd–‘e_d©a_´oduûr
 = 
NULL
;

39 
	gkey_Ëngth_mš
;

40 
	gkey_Ëngth_max
;

41 
	gkey_Ëngth_¿nge_g­
;

42 
	gf›ld_Ëngth_max
;

43 
	g¡ršg_Ëngth_max
;

45 
	gcmd_ty³
;

47 
	gkey_ÿche_poŞs_couÁ
 = 0;

49 
d¬¿y
 
	gÃeded_cmd_ty³_´oduûr
;

50 
	gÃeded_cmd_ty³_´oduûr_couÁ
;

52 
	g´oduû_d©a_th»ads_couÁ
;

53 
d¬¿y
 
	g´oduû_th»ads
;

55 
	g´oduû_th»ads_·u£_fšished_couÁ
;

57 
	gnÚ_em±y_kıs_couÁ
 = 0;

58 
	gnÚ_em±y_kıs_idx
[
PRODUCE_KEY_CACHE_POOL_COUNT
] = {-1};

60 
sds
 
	$g‘_¿ndom_ÿched_key
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
)

62 
key_ÿche_¬¿y
 *
kı
 = 
	`kı_g‘_äom_ps
(
ps
,
dp
);

63  
	`key_ÿche_¬¿y_¿ndom
(
kı
);

64 
	}
}

66 
	$g‘_¿ndom_št
()

68 ià(
	`¿nd
()%2 == 1) {

69  0 - ()
	`¿nd
();

71  ()
	`¿nd
();

73 
	}
}

75 
	$g‘_¿ndom_unsigÃd_št
()

77  ()
	`¿nd
();

78 
	}
}

80 
	$g‘_¿ndom_ch¬
()

82  ()
	`¿nd
()%250 + 5;

84 
	}
}

86 
sds
 
	$g‘_¿ndom_key
()

88 
i
, 
Ën
;

89 
sds
 
¡r
 = 
	`sd£m±y
();

91 
Ën
 = 
key_Ëngth_¿nge_g­
==0?
key_Ëngth_mš
:

92 (
	`g‘_¿ndom_unsigÃd_št
()%
key_Ëngth_¿nge_g­
+
key_Ëngth_mš
);

93 ià(
Ën
 == 0)†en ++;

94 
¡r
 = 
	`sdsMakeRoomFÜ
(¡r,(
size_t
)
Ën
);

95 
	`sdsInüL’
(
¡r
, ()
Ën
);

97 
i
 = 0; i < 
Ën
; i ++) {

98 
¡r
[
i
] = ()
	`g‘_¿ndom_ch¬
();

101  
¡r
;

102 
	}
}

104 
sds
 
	$g‘_¿ndom_¡ršg
()

106 
i
, 
Ën
;

107 
sds
 
¡r
 = 
	`sd£m±y
();

109 
Ën
 = 
	`g‘_¿ndom_unsigÃd_št
()%
¡ršg_Ëngth_max
;

110 
¡r
 = 
	`sdsMakeRoomFÜ
(¡r,(
size_t
)
Ën
);

111 
	`sdsInüL’
(
¡r
, ()
Ën
);

113 
i
 = 0; i < 
Ën
; i ++) {

114 
¡r
[
i
] = 
	`g‘_¿ndom_ch¬
();

117  
¡r
;

118 
	}
}

120 
sds
 
	$g‘_¿ndom_æßt_¡r
()

122 
decim®_Ën
;

123 
sds
 
¡r
;

125 ià(
	`¿nd
()%2 == 1) {

126 
¡r
 = 
	`sd¢ew
("-");

128 
¡r
 = 
	`sd£m±y
();

131 ià(
	`¿nd
()%2 == 1) {

132 
¡r
 = 
	`sdsÿtfmt
(str,"%u.%u",

133 
	`g‘_¿ndom_unsigÃd_št
(),

134 
	`g‘_¿ndom_unsigÃd_št
());

136 
¡r
 = 
	`sdsÿtfmt
(str,"%u",

137 
	`g‘_¿ndom_unsigÃd_št
());

140  
¡r
;

141 
	}
}

143 
	#ZSET_RANGE_MIN_MAX_TYPE_RANK
 0

	)

144 
	#ZSET_RANGE_MIN_MAX_TYPE_SCORE
 1

	)

145 
	#ZSET_RANGE_MIN_MAX_TYPE_LEX
 2

	)

146 
sds
 *
	$g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
¿nge_ty³
)

148 
sds
 *
¿nge
;

149 
´obab™y
 = 
	`¿nd
()%100;

151 
¿nge
 = 
	`m®loc
(2*(
sds
));

152 ià(
¿nge_ty³
 =ğ
ZSET_RANGE_MIN_MAX_TYPE_RANK
) {

153 
mš
 = 
	`g‘_¿ndom_unsigÃd_št
();

154 
max
 = 
	`g‘_¿ndom_unsigÃd_št
();

156 ià(
´obab™y
 >ğ95 && 
mš
 <ğ
max
 ||

157 
´obab™y
 < 95 && 
mš
 > 
max
) {

158 
¿nge
[0] = 
	`sdsäomlÚglÚg
(()
max
);

159 
¿nge
[1] = 
	`sdsäomlÚglÚg
(()
mš
);

161 
¿nge
[0] = 
	`sdsäomlÚglÚg
(()
mš
);

162 
¿nge
[1] = 
	`sdsäomlÚglÚg
(()
max
);

164 } ià(
¿nge_ty³
 =ğ
ZSET_RANGE_MIN_MAX_TYPE_SCORE
) {

165 
sds
 
mš_¡r
 = 
	`g‘_¿ndom_æßt_¡r
();

166 
sds
 
max_¡r
 = 
	`g‘_¿ndom_æßt_¡r
();

167 
mš
, 
max
;

168 *
•Œ
;

169 
sds
 
sw­
;

170 
mš_´obab™y
 = 
	`¿nd
()%3;

171 
max_´obab™y
 = 
	`¿nd
()%3;

173 
mš
 = 
	`¡¹od
(
mš_¡r
,&
•Œ
);

174 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
mš
)) {

175 
	`sdsä“
(
mš_¡r
);

176 
	`sdsä“
(
max_¡r
);

177 
	`ä“
(
¿nge
);

178  
NULL
;

180 
max
 = 
	`¡¹od
(
max_¡r
,&
•Œ
);

181 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
max
)) {

182 
	`sdsä“
(
mš_¡r
);

183 
	`sdsä“
(
max_¡r
);

184 
	`ä“
(
¿nge
);

185  
NULL
;

187 ià(
´obab™y
 >ğ95 && 
mš
 <ğ
max
 ||

188 
´obab™y
 < 95 && 
mš
 > 
max
) {

189 
sw­
 = 
mš_¡r
;

190 
mš_¡r
 = 
max_¡r
;

191 
max_¡r
 = 
sw­
;

194 ià(
mš_´obab™y
 == 0) {

195 
¿nge
[0] = 
	`sd¢ew
("-inf");

196 } ià(
mš_´obab™y
 == 1) {

197 
¿nge
[0] = 
	`sd¢ew
("(");

198 
¿nge
[0] = 
	`sdsÿtfmt
Ôªge[0],"%S",
mš_¡r
);

199 
	`sdsä“
(
mš_¡r
);

201 
¿nge
[0] = 
mš_¡r
;

203 ià(
max_´obab™y
 == 0) {

204 
¿nge
[1] = 
	`sd¢ew
("+inf");

205 } ià(
max_´obab™y
 == 1) {

206 
¿nge
[1] = 
	`sd¢ew
("(");

207 
¿nge
[1] = 
	`sdsÿtfmt
Ôªge[1],"%S",
max_¡r
);

208 
	`sdsä“
(
max_¡r
);

210 
¿nge
[1] = 
max_¡r
;

212 } ià(
¿nge_ty³
 =ğ
ZSET_RANGE_MIN_MAX_TYPE_LEX
) {

213 
sds
 
mš_¡r
 = 
	`g‘_¿ndom_¡ršg
();

214 
sds
 
max_¡r
 = 
	`g‘_¿ndom_¡ršg
();

215 
sds
 
sw­
;

216 
mš_´obab™y
 = 
	`¿nd
()%3;

217 
max_´obab™y
 = 
	`¿nd
()%3;

219 ià(
´obab™y
 >ğ95 && 
	`sdscmp
(
mš_¡r
,
max_¡r
) < 0 ||

220 
´obab™y
 < 95 && 
	`sdscmp
(
mš_¡r
,
max_¡r
) > 0) {

221 
sw­
 = 
mš_¡r
;

222 
mš_¡r
 = 
max_¡r
;

223 
max_¡r
 = 
sw­
;

226 ià(
mš_´obab™y
 == 0) {

227 
¿nge
[0] = 
	`sd¢ew
("-");

228 } ià(
mš_´obab™y
 == 1) {

229 
¿nge
[0] = 
	`sd¢ew
("(");

230 
¿nge
[0] = 
	`sdsÿtfmt
Ôªge[0],"%S",
mš_¡r
);

231 
	`sdsä“
(
mš_¡r
);

233 
¿nge
[0] = 
	`sd¢ew
("[");

234 
¿nge
[0] = 
	`sdsÿtfmt
Ôªge[0],"%S",
mš_¡r
);

235 
	`sdsä“
(
mš_¡r
);

237 ià(
max_´obab™y
 == 0) {

238 
¿nge
[1] = 
	`sd¢ew
("+");

239 } ià(
max_´obab™y
 == 1) {

240 
¿nge
[1] = 
	`sd¢ew
("(");

241 
¿nge
[1] = 
	`sdsÿtfmt
Ôªge[1],"%S",
max_¡r
);

242 
	`sdsä“
(
max_¡r
);

244 
¿nge
[1] = 
	`sd¢ew
("[");

245 
¿nge
[1] = 
	`sdsÿtfmt
Ôªge[1],"%S",
max_¡r
);

246 
	`sdsä“
(
max_¡r
);

249 
	`ä“
(
¿nge
);

250 
¿nge
 = 
NULL
;

253  
¿nge
;

254 
	}
}

256 
	$g‘_¿ndom_f›ld_Ën
()

258  
	`g‘_¿ndom_unsigÃd_št
()%
f›ld_Ëngth_max
 + 1;

259 
	}
}

261 
sds
 
	$g‘_¿ndom_key_w™h_h™_¿tio
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
)

263 
sds
 
key
;

264 ià(
ps
->
h™_¿tio_¬¿y
[ps->
h™_¿tio_idx
++] == 0) {

265 
key
 = 
	`g‘_¿ndom_key
();

267 
key
 = 
	`g‘_¿ndom_ÿched_key
(
ps
,
dp
);

268 ià(
key
 =ğ
NULL
èkey = 
	`g‘_¿ndom_key
();

270 ià(
ps
->
h™_¿tio_idx
 >ğps->
h™_¿tio_¬¿y_Ën
) {

271 
ps
->
h™_¿tio_idx
 = 0;

273  
key
;

274 
	}
}

277 
	$nck_wh’_nÛ¼Ü
(
»disR•ly
 *
»¶y
)

279 ià(
»¶y
 =ğ
NULL
)  0;

281 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

286 
	}
}

288 
	$nck_wh’_ok
(
»disR•ly
 *
»¶y
)

290 ià(
»¶y
 =ğ
NULL
)  0;

292 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STATUS
 &&

293 !
	`¡rcmp
(
»¶y
->
¡r
, "OK")) {

298 
	}
}

300 
	$nck_wh’_¡r
(
»disR•ly
 *
»¶y
)

302 ià(
»¶y
 =ğ
NULL
)  0;

304 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
) {

309 
	}
}

311 
	$nck_wh’_unsigÃd_š‹g”
(
»disR•ly
 *
»¶y
)

313 ià(
»¶y
 =ğ
NULL
)  0;

315 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

316 
»¶y
->
š‹g”
 >= 0) {

321 
	}
}

323 
	$nck_wh’_nÚz”o_unsigÃd_š‹g”
(
»disR•ly
 *
»¶y
)

325 ià(
»¶y
 =ğ
NULL
)  0;

327 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

328 
»¶y
->
š‹g”
 > 0) {

333 
	}
}

335 
	$nck_wh’_z”o_Ü_Úe
(
»disR•ly
 *
»¶y
)

337 ià(
»¶y
 =ğ
NULL
)  0;

339 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

340 (
»¶y
->
š‹g”
 == 0 ||„eply->integer == 1)) {

345 
	}
}

347 
	$nck_wh’_Úe
(
»disR•ly
 *
»¶y
)

349 ià(
»¶y
 =ğ
NULL
)  0;

351 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

352 
»¶y
->
š‹g”
 == 1) {

357 
	}
}

361 
d©a_un™
 *
	$g‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

363 
d©a_un™
 *
du
;

365 
du
 = 
	`d©a_un™_g‘
();

366 
du
->
dp
 = dp;

367 
du
->
¬gc
 = 2;

368 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

369 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

370 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

372  
du
;

373 
	}
}

375 
d©a_un™
 *
	$£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

377 
d©a_un™
 *
du
;

379 
du
 = 
	`d©a_un™_g‘
();

380 
du
->
dp
 = dp;

381 
du
->
¬gc
 = 3;

382 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

383 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

384 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

385 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

387  
du
;

388 
	}
}

390 
d©a_un™
 *
	$£Šx_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

392 
d©a_un™
 *
du
;

394 
du
 = 
	`d©a_un™_g‘
();

395 
du
->
dp
 = dp;

396 
du
->
¬gc
 = 3;

397 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

398 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

399 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

400 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

402  
du
;

403 
	}
}

406 
	$£Šx_cmd_nck
(
»disR•ly
 *
»¶y
)

408 ià(
»¶y
 =ğ
NULL
)  0;

410 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

411 
»¶y
->
š‹g”
 == 1) {

416 
	}
}

418 
d©a_un™
 *
	$£‹x_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

420 
d©a_un™
 *
du
;

422 
du
 = 
	`d©a_un™_g‘
();

423 
du
->
dp
 = dp;

424 
du
->
¬gc
 = 4;

425 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

426 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

427 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

428 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

429 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

431  
du
;

432 
	}
}

434 
d©a_un™
 *
	$p£‹x_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

436 
d©a_un™
 *
du
;

438 
du
 = 
	`d©a_un™_g‘
();

439 
du
->
dp
 = dp;

440 
du
->
¬gc
 = 4;

441 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

442 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

443 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

444 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

445 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

447  
du
;

448 
	}
}

450 
d©a_un™
 *
	$d–_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

452 
d©a_un™
 *
du
;

454 
du
 = 
	`d©a_un™_g‘
();

455 
du
->
dp
 = dp;

456 
du
->
¬gc
 = 2;

457 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

458 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

459 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

461  
du
;

462 
	}
}

464 
d©a_un™
 *
	$expœe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

466 
d©a_un™
 *
du
;

468 
du
 = 
	`d©a_un™_g‘
();

469 
du
->
dp
 = dp;

470 
du
->
¬gc
 = 3;

471 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

472 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

473 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

474 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

476  
du
;

477 
	}
}

479 
d©a_un™
 *
	$expœ—t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

481 
d©a_un™
 *
du
;

483 
du
 = 
	`d©a_un™_g‘
();

484 
du
->
dp
 = dp;

485 
du
->
¬gc
 = 3;

486 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

487 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

488 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

489 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`v¹_m£c_now
()/1000LL+
	`¿nd
()%10000);

491  
du
;

492 
	}
}

494 
d©a_un™
 *
	$exi¡s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

496 
d©a_un™
 *
du
;

498 
du
 = 
	`d©a_un™_g‘
();

499 
du
->
dp
 = dp;

500 
du
->
¬gc
 = 2;

501 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

502 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

503 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

505  
du
;

506 
	}
}

508 
d©a_un™
 *
	$‰l_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

510 
d©a_un™
 *
du
;

512 
du
 = 
	`d©a_un™_g‘
();

513 
du
->
dp
 = dp;

514 
du
->
¬gc
 = 2;

515 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

516 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

517 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

519  
du
;

520 
	}
}

522 
d©a_un™
 *
	$±_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

524 
d©a_un™
 *
du
;

526 
du
 = 
	`d©a_un™_g‘
();

527 
du
->
dp
 = dp;

528 
du
->
¬gc
 = 2;

529 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

530 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

531 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

533  
du
;

534 
	}
}

536 
d©a_un™
 *
	$šü_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

538 
d©a_un™
 *
du
;

540 
du
 = 
	`d©a_un™_g‘
();

541 
du
->
dp
 = dp;

542 
du
->
¬gc
 = 2;

543 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

544 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

545 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

547  
du
;

548 
	}
}

550 
d©a_un™
 *
	$deü_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

552 
d©a_un™
 *
du
;

554 
du
 = 
	`d©a_un™_g‘
();

555 
du
->
dp
 = dp;

556 
du
->
¬gc
 = 2;

557 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

558 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

559 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

561  
du
;

562 
	}
}

564 
d©a_un™
 *
	$šüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

566 
d©a_un™
 *
du
;

568 
du
 = 
	`d©a_un™_g‘
();

569 
du
->
dp
 = dp;

570 
du
->
¬gc
 = 3;

571 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

572 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

573 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

574 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

576  
du
;

577 
	}
}

579 
d©a_un™
 *
	$deüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

581 
d©a_un™
 *
du
;

583 
du
 = 
	`d©a_un™_g‘
();

584 
du
->
dp
 = dp;

585 
du
->
¬gc
 = 3;

586 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

587 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

588 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

589 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`¿nd
()%10000);

591  
du
;

592 
	}
}

594 
d©a_un™
 *
	$­³nd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

596 
d©a_un™
 *
du
;

598 
du
 = 
	`d©a_un™_g‘
();

599 
du
->
dp
 = dp;

600 
du
->
¬gc
 = 3;

601 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

602 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

603 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

604 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

606  
du
;

607 
	}
}

610 
	$­³nd_cmd_nck
(
»disR•ly
 *
»¶y
)

612 ià(
»¶y
 =ğ
NULL
)  0;

614 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

619 
	}
}

621 
d©a_un™
 *
	$¡¾’_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

623 
d©a_un™
 *
du
;

625 
du
 = 
	`d©a_un™_g‘
();

626 
du
->
dp
 = dp;

627 
du
->
¬gc
 = 2;

628 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

629 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

630 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

632  
du
;

633 
	}
}

635 
d©a_un™
 *
	$g‘£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

637 
d©a_un™
 *
du
;

639 
du
 = 
	`d©a_un™_g‘
();

640 
du
->
dp
 = dp;

641 
du
->
¬gc
 = 3;

642 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

643 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

644 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

645 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

647  
du
;

648 
	}
}

650 
d©a_un™
 *
	$šübyæßt_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

652 
d©a_un™
 *
du
;

654 
du
 = 
	`d©a_un™_g‘
();

655 
du
->
dp
 = dp;

656 
du
->
¬gc
 = 3;

657 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

658 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

659 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

660 
du
->
¬gv
[2] = 
	`g‘_¿ndom_æßt_¡r
();

662  
du
;

663 
	}
}

665 
d©a_un™
 *
	$£tb™_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

667 
d©a_un™
 *
du
;

669 
du
 = 
	`d©a_un™_g‘
();

670 
du
->
dp
 = dp;

671 
du
->
¬gc
 = 4;

672 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

673 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

674 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

675 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
()%30000);

676 ià(
	`¿nd
()%2) {

677 
du
->
¬gv
[3] = 
	`sd¢ew
("1");

679 
du
->
¬gv
[3] = 
	`sd¢ew
("0");

682  
du
;

683 
	}
}

685 
d©a_un™
 *
	$g‘b™_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

687 
d©a_un™
 *
du
;

689 
du
 = 
	`d©a_un™_g‘
();

690 
du
->
dp
 = dp;

691 
du
->
¬gc
 = 3;

692 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

693 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

694 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

695 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
()%30000);

697  
du
;

698 
	}
}

700 
d©a_un™
 *
	$£Œªge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

702 
d©a_un™
 *
du
;

704 
du
 = 
	`d©a_un™_g‘
();

705 
du
->
dp
 = dp;

706 
du
->
¬gc
 = 4;

707 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

708 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

709 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

710 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
()%30000);

711 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

713  
du
;

714 
	}
}

716 
d©a_un™
 *
	$g‘¿nge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

718 
d©a_un™
 *
du
;

720 
du
 = 
	`d©a_un™_g‘
();

721 
du
->
dp
 = dp;

722 
du
->
¬gc
 = 4;

723 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

724 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

725 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

726 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

727 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

729  
du
;

730 
	}
}

732 
d©a_un™
 *
	$b™couÁ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

734 
d©a_un™
 *
du
;

735 
w™h_¿nge
 = 0;

737 ià(
	`¿nd
()%2)

738 
w™h_¿nge
 = 1;

740 
du
 = 
	`d©a_un™_g‘
();

741 
du
->
dp
 = dp;

742 
du
->
¬gc
 = 
w™h_¿nge
?4:2;

743 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

744 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

745 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

746 ià(
w™h_¿nge
) {

747 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

748 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

750  
du
;

751 
	}
}

753 
d©a_un™
 *
	$b™pos_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

755 
d©a_un™
 *
du
;

756 
w™h_¿nge
 = 0;

757 
´obab™y
 = 
	`¿nd
()%3;

759 ià(
´obab™y
 == 0)

760 
w™h_¿nge
 = 0;

761 ià(
´obab™y
 == 1)

762 
w™h_¿nge
 = 1;

763 ià(
´obab™y
 == 2)

764 
w™h_¿nge
 = 2;

766 
du
 = 
	`d©a_un™_g‘
();

767 
du
->
dp
 = dp;

768 
du
->
¬gc
 = 
w™h_¿nge
==0?3:(with_range==1?4:5);

769 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

770 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

771 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

772 ià(
	`¿nd
()%2)

773 
du
->
¬gv
[2] = 
	`sd¢ew
("0");

775 
du
->
¬gv
[2] = 
	`sd¢ew
("1");

776 ià(
w™h_¿nge
 > 0)

777 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

778 ià(
w™h_¿nge
 == 2)

779 
du
->
¬gv
[4] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%30000);

781  
du
;

782 
	}
}

784 
d©a_un™
 *
	$mg‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

786 
d©a_un™
 *
du
;

788 
du
 = 
	`d©a_un™_g‘
();

789 
du
->
dp
 = dp;

790 
du
->
¬gc
 = 2;

791 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

792 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

793 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

795  
du
;

796 
	}
}

798 
d©a_un™
 *
	$m£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

800 
d©a_un™
 *
du
;

802 
du
 = 
	`d©a_un™_g‘
();

803 
du
->
dp
 = dp;

804 
du
->
¬gc
 = 3;

805 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

806 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

807 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

808 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

810  
du
;

811 
	}
}

813 
d©a_un™
 *
	$h£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

815 
d©a_un™
 *
du
;

817 
du
 = 
	`d©a_un™_g‘
();

818 
du
->
dp
 = dp;

819 
du
->
¬gc
 = 4;

820 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

821 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

822 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

823 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

824 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

826  
du
;

827 
	}
}

829 
d©a_un™
 *
	$hg‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

831 
d©a_un™
 *
du
;

833 
du
 = 
	`d©a_un™_g‘
();

834 
du
->
dp
 = dp;

835 
du
->
¬gc
 = 3;

836 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

837 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

838 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

839 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

841  
du
;

842 
	}
}

844 
d©a_un™
 *
	$hËn_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

846 
d©a_un™
 *
du
;

848 
du
 = 
	`d©a_un™_g‘
();

849 
du
->
dp
 = dp;

850 
du
->
¬gc
 = 2;

851 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

852 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

853 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

855  
du
;

856 
	}
}

858 
d©a_un™
 *
	$hd–_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

860 
d©a_un™
 *
du
;

861 
j
, 
f›ld_Ëngth
;

863 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

865 
du
 = 
	`d©a_un™_g‘
();

866 
du
->
dp
 = dp;

867 
du
->
¬gc
 = 2 + 
f›ld_Ëngth
;

868 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

869 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

870 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

871 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

872 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

875  
du
;

876 
	}
}

878 
d©a_un™
 *
	$hexi¡s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

880 
d©a_un™
 *
du
;

882 
du
 = 
	`d©a_un™_g‘
();

883 
du
->
dp
 = dp;

884 
du
->
¬gc
 = 3;

885 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

886 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

887 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

888 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

890  
du
;

891 
	}
}

893 
d©a_un™
 *
	$hkeys_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

895 
d©a_un™
 *
du
;

897 
du
 = 
	`d©a_un™_g‘
();

898 
du
->
dp
 = dp;

899 
du
->
¬gc
 = 2;

900 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

901 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

902 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

904  
du
;

905 
	}
}

907 
d©a_un™
 *
	$hv®s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

909 
d©a_un™
 *
du
;

911 
du
 = 
	`d©a_un™_g‘
();

912 
du
->
dp
 = dp;

913 
du
->
¬gc
 = 2;

914 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

915 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

916 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

918  
du
;

919 
	}
}

921 
d©a_un™
 *
	$hg‘®l_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

923 
d©a_un™
 *
du
;

925 
du
 = 
	`d©a_un™_g‘
();

926 
du
->
dp
 = dp;

927 
du
->
¬gc
 = 2;

928 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

929 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

930 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

932  
du
;

933 
	}
}

935 
d©a_un™
 *
	$hšüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

937 
d©a_un™
 *
du
;

939 
du
 = 
	`d©a_un™_g‘
();

940 
du
->
dp
 = dp;

941 
du
->
¬gc
 = 4;

942 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

943 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

944 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

945 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

946 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
());

948  
du
;

949 
	}
}

951 
d©a_un™
 *
	$hšübyæßt_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

953 
d©a_un™
 *
du
;

955 
du
 = 
	`d©a_un™_g‘
();

956 
du
->
dp
 = dp;

957 
du
->
¬gc
 = 4;

958 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

959 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

960 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

961 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

962 
du
->
¬gv
[3] = 
	`g‘_¿ndom_æßt_¡r
();

964  
du
;

965 
	}
}

967 
d©a_un™
 *
	$hmg‘_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

969 
d©a_un™
 *
du
;

970 
j
, 
f›ld_Ëngth
;

972 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

974 
du
 = 
	`d©a_un™_g‘
();

975 
du
->
dp
 = dp;

976 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

977 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

978 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

979 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

980 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

981 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

984  
du
;

985 
	}
}

987 
d©a_un™
 *
	$hm£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

989 
d©a_un™
 *
du
;

990 
j
, 
f›ld_Ëngth
;

992 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

994 
du
 = 
	`d©a_un™_g‘
();

995 
du
->
dp
 = dp;

996 
du
->
¬gc
 = 2+
f›ld_Ëngth
*2;

997 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

998 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

999 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1000 
j
 = 2; j < 2+
f›ld_Ëngth
*2; j += 2) {

1001 
du
->
¬gv
[
j
] = 
	`g‘_¿ndom_¡ršg
();

1002 
du
->
¬gv
[
j
+1] = 
	`g‘_¿ndom_¡ršg
();

1005  
du
;

1006 
	}
}

1008 
d©a_un™
 *
	$h£Šx_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1010 
d©a_un™
 *
du
;

1012 
du
 = 
	`d©a_un™_g‘
();

1013 
du
->
dp
 = dp;

1014 
du
->
¬gc
 = 4;

1015 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1016 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1017 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1018 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1019 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1021  
du
;

1022 
	}
}

1024 
d©a_un™
 *
	$h¡¾’_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1026 
d©a_un™
 *
du
;

1028 
du
 = 
	`d©a_un™_g‘
();

1029 
du
->
dp
 = dp;

1030 
du
->
¬gc
 = 3;

1031 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1032 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1033 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1034 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1036  
du
;

1037 
	}
}

1039 
d©a_un™
 *
	$½ush_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1041 
d©a_un™
 *
du
;

1042 
j
, 
f›ld_Ëngth
;

1044 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1046 
du
 = 
	`d©a_un™_g‘
();

1047 
du
->
dp
 = dp;

1048 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1049 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1050 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1051 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1052 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1053 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1056  
du
;

1057 
	}
}

1060 
	$½ush_cmd_nck
(
»disR•ly
 *
»¶y
)

1062 ià(
»¶y
 =ğ
NULL
)  0;

1064 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1069 
	}
}

1071 
d©a_un™
 *
	$Íush_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1073 
d©a_un™
 *
du
;

1074 
j
, 
f›ld_Ëngth
;

1076 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1078 
du
 = 
	`d©a_un™_g‘
();

1079 
du
->
dp
 = dp;

1080 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1081 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1082 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1083 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1085 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1086 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1089  
du
;

1090 
	}
}

1092 
d©a_un™
 *
	$Ìªge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1094 
d©a_un™
 *
du
;

1096 
du
 = 
	`d©a_un™_g‘
();

1097 
du
->
dp
 = dp;

1098 
du
->
¬gc
 = 4;

1099 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1100 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1101 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1102 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1103 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1105  
du
;

1106 
	}
}

1108 
d©a_un™
 *
	$½İ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1110 
d©a_un™
 *
du
;

1112 
du
 = 
	`d©a_un™_g‘
();

1113 
du
->
dp
 = dp;

1114 
du
->
¬gc
 = 2;

1115 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1116 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1117 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1119  
du
;

1120 
	}
}

1122 
d©a_un™
 *
	$Íİ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1124 
d©a_un™
 *
du
;

1126 
du
 = 
	`d©a_un™_g‘
();

1127 
du
->
dp
 = dp;

1128 
du
->
¬gc
 = 2;

1129 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1130 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1131 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1133  
du
;

1134 
	}
}

1136 
d©a_un™
 *
	$Î’_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1138 
d©a_un™
 *
du
;

1140 
du
 = 
	`d©a_un™_g‘
();

1141 
du
->
dp
 = dp;

1142 
du
->
¬gc
 = 2;

1143 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1144 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1145 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1147  
du
;

1148 
	}
}

1150 
d©a_un™
 *
	$Ìem_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1152 
d©a_un™
 *
du
;

1154 
du
 = 
	`d©a_un™_g‘
();

1155 
du
->
dp
 = dp;

1156 
du
->
¬gc
 = 4;

1157 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1158 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1159 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1160 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1161 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1163  
du
;

1164 
	}
}

1166 
d©a_un™
 *
	$Érim_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1168 
d©a_un™
 *
du
;

1170 
du
 = 
	`d©a_un™_g‘
();

1171 
du
->
dp
 = dp;

1172 
du
->
¬gc
 = 4;

1173 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1174 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1175 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1176 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1177 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1179  
du
;

1180 
	}
}

1182 
d©a_un™
 *
	$lšdex_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1184 
d©a_un™
 *
du
;

1186 
du
 = 
	`d©a_un™_g‘
();

1187 
du
->
dp
 = dp;

1188 
du
->
¬gc
 = 3;

1189 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1190 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1191 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1192 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1194  
du
;

1195 
	}
}

1197 
d©a_un™
 *
	$l£t_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1199 
d©a_un™
 *
du
;

1201 
du
 = 
	`d©a_un™_g‘
();

1202 
du
->
dp
 = dp;

1203 
du
->
¬gc
 = 4;

1204 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1205 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1206 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1207 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(()
	`g‘_¿ndom_št
()%(
f›ld_Ëngth_max
+1));

1208 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1210  
du
;

1211 
	}
}

1213 
d©a_un™
 *
	$§dd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1215 
d©a_un™
 *
du
;

1216 
j
, 
f›ld_Ëngth
;

1218 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1220 
du
 = 
	`d©a_un™_g‘
();

1221 
du
->
dp
 = dp;

1222 
du
->
¬gc
 = 2 + 
f›ld_Ëngth
;

1223 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1224 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1225 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1226 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1227 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1230  
du
;

1231 
	}
}

1233 
d©a_un™
 *
	$smemb”s_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1235 
d©a_un™
 *
du
;

1237 
du
 = 
	`d©a_un™_g‘
();

1238 
du
->
dp
 = dp;

1239 
du
->
¬gc
 = 2;

1240 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1241 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1242 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1244  
du
;

1245 
	}
}

1247 
d©a_un™
 *
	$sÿrd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1249 
d©a_un™
 *
du
;

1251 
du
 = 
	`d©a_un™_g‘
();

1252 
du
->
dp
 = dp;

1253 
du
->
¬gc
 = 2;

1254 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1255 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1256 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1258  
du
;

1259 
	}
}

1261 
d©a_un™
 *
	$¤em_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1263 
d©a_un™
 *
du
;

1264 
j
, 
f›ld_Ëngth
;

1266 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1268 
du
 = 
	`d©a_un™_g‘
();

1269 
du
->
dp
 = dp;

1270 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1271 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1272 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1273 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1274 
j
 = 0; j < 
f›ld_Ëngth
; j ++) {

1275 
du
->
¬gv
[2+
j
] = 
	`g‘_¿ndom_¡ršg
();

1278  
du
;

1279 
	}
}

1281 
d©a_un™
 *
	$sismemb”_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1283 
d©a_un™
 *
du
;

1285 
du
 = 
	`d©a_un™_g‘
();

1286 
du
->
dp
 = dp;

1287 
du
->
¬gc
 = 3;

1288 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1289 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1290 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1291 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1293  
du
;

1294 
	}
}

1296 
d©a_un™
 *
	$suniÚ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1298 
d©a_un™
 *
du
;

1300 
du
 = 
	`d©a_un™_g‘
();

1301 
du
->
dp
 = dp;

1302 
du
->
¬gc
 = 2;

1303 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1304 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1305 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1307  
du
;

1308 
	}
}

1310 
d©a_un™
 *
	$sdiff_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1312 
d©a_un™
 *
du
;

1314 
du
 = 
	`d©a_un™_g‘
();

1315 
du
->
dp
 = dp;

1316 
du
->
¬gc
 = 2;

1317 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1318 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1319 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1321  
du
;

1322 
	}
}

1324 
d©a_un™
 *
	$sš‹r_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1326 
d©a_un™
 *
du
;

1328 
du
 = 
	`d©a_un™_g‘
();

1329 
du
->
dp
 = dp;

1330 
du
->
¬gc
 = 2;

1331 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1332 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1333 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1335  
du
;

1336 
	}
}

1339 
	$Íush_cmd_nck
(
»disR•ly
 *
»¶y
)

1341 ià(
»¶y
 =ğ
NULL
)  0;

1343 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1348 
	}
}

1350 
d©a_un™
 *
	$zadd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1352 
d©a_un™
 *
du
;

1353 
j
, 
f›ld_Ëngth
;

1355 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1357 
du
 = 
	`d©a_un™_g‘
();

1358 
du
->
dp
 = dp;

1359 
du
->
¬gc
 = 2+
f›ld_Ëngth
*2;

1360 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1361 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1362 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key
();

1364 
j
 = 2; j < 2+
f›ld_Ëngth
*2; j += 2) {

1365 
du
->
¬gv
[
j
] = 
	`g‘_¿ndom_æßt_¡r
();

1366 
du
->
¬gv
[
j
+1] = 
	`g‘_¿ndom_¡ršg
();

1369  
du
;

1370 
	}
}

1373 
	$zadd_cmd_nck
(
»disR•ly
 *
»¶y
)

1375 ià(
»¶y
 =ğ
NULL
)  0;

1377 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1382 
	}
}

1384 
d©a_un™
 *
	$zšüby_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1386 
d©a_un™
 *
du
;

1387 
j
, 
f›ld_Ëngth
;

1389 
du
 = 
	`d©a_un™_g‘
();

1390 
du
->
dp
 = dp;

1391 
du
->
¬gc
 = 4;

1392 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1393 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1394 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1395 
du
->
¬gv
[2] = 
	`g‘_¿ndom_æßt_¡r
();;

1396 
du
->
¬gv
[3] = 
	`g‘_¿ndom_¡ršg
();

1398  
du
;

1399 
	}
}

1402 
	$zšüby_cmd_nck
(
»disR•ly
 *
»¶y
)

1404 ià(
»¶y
 =ğ
NULL
)  0;

1406 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

1411 
	}
}

1413 
d©a_un™
 *
	$z¿nge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1415 
d©a_un™
 *
du
;

1416 
j
, 
f›ld_Ëngth
;

1417 
w™hscÜes
;

1419 ià(
	`¿nd
()%2 == 1) {

1420 
w™hscÜes
 = 1;

1422 
w™hscÜes
 = 0;

1425 
du
 = 
	`d©a_un™_g‘
();

1426 
du
->
dp
 = dp;

1427 
du
->
¬gc
 = 
w™hscÜes
?5:4;

1428 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1429 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1430 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1431 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(0);

1432 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%10000);

1433 ià(
w™hscÜes
è
du
->
¬gv
[4] = 
	`sd¢ew
("withscores");

1435  
du
;

1436 
	}
}

1438 
d©a_un™
 *
	$z»v¿nge_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1440 
d©a_un™
 *
du
;

1441 
j
, 
f›ld_Ëngth
;

1442 
w™hscÜes
;

1444 ià(
	`¿nd
()%2 == 1) {

1445 
w™hscÜes
 = 1;

1447 
w™hscÜes
 = 0;

1450 
du
 = 
	`d©a_un™_g‘
();

1451 
du
->
dp
 = dp;

1452 
du
->
¬gc
 = 
w™hscÜes
?5:4;

1453 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1454 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1455 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1456 
du
->
¬gv
[2] = 
	`sdsäomlÚglÚg
(0);

1457 
du
->
¬gv
[3] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_št
()%10000);

1458 ià(
w™hscÜes
è
du
->
¬gv
[4] = 
	`sd¢ew
("withscores");

1460  
du
;

1461 
	}
}

1463 
d©a_un™
 *
	$z»m_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1465 
d©a_un™
 *
du
;

1466 
j
, 
f›ld_Ëngth
;

1468 
f›ld_Ëngth
 = 
	`g‘_¿ndom_f›ld_Ën
();

1470 
du
 = 
	`d©a_un™_g‘
();

1471 
du
->
dp
 = dp;

1472 
du
->
¬gc
 = 2+
f›ld_Ëngth
;

1473 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1474 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1475 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1477 
j
 = 2; j < 2+
f›ld_Ëngth
; j ++) {

1478 
du
->
¬gv
[
j
] = 
	`g‘_¿ndom_¡ršg
();

1481  
du
;

1482 
	}
}

1484 
d©a_un™
 *
	$zÿrd_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1486 
d©a_un™
 *
du
;

1488 
du
 = 
	`d©a_un™_g‘
();

1489 
du
->
dp
 = dp;

1490 
du
->
¬gc
 = 2;

1491 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1492 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1493 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1495  
du
;

1496 
	}
}

1498 
d©a_un™
 *
	$zcouÁ_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1500 
d©a_un™
 *
du
;

1501 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1503 
du
 = 
	`d©a_un™_g‘
();

1504 
du
->
dp
 = dp;

1505 
du
->
¬gc
 = 4;

1506 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1507 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1508 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1509 
du
->
¬gv
[2] = 
¿nge
[0];

1510 
du
->
¬gv
[3] = 
¿nge
[1];

1512 
	`ä“
(
¿nge
);

1513  
du
;

1514 
	}
}

1516 
d©a_un™
 *
	$z¿ngebyscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1518 
d©a_un™
 *
du
;

1519 
idx
 = 0, 
¬g_couÁ
 = 0;

1520 
w™hscÜes
,
lim™
;

1521 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1523 
¬g_couÁ
 = 4;

1524 ià(
	`¿nd
()%2 == 1) {

1525 
w™hscÜes
 = 1;

1526 
¬g_couÁ
 ++;

1528 
w™hscÜes
 = 0;

1530 ià(
	`¿nd
()%2 == 1) {

1531 
lim™
 = 1;

1532 
¬g_couÁ
 += 3;

1534 
lim™
 = 0;

1537 
du
 = 
	`d©a_un™_g‘
();

1538 
du
->
dp
 = dp;

1539 
du
->
¬gc
 = 
¬g_couÁ
;

1540 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1541 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
(
dp
->
Çme
);

1542 
du
->
¬gv
[
idx
++] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1543 
du
->
¬gv
[
idx
++] = 
¿nge
[0];

1544 
du
->
¬gv
[
idx
++] = 
¿nge
[1];

1545 ià(
w™hscÜes
è
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("withscores");

1546 ià(
lim™
) {

1547 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("limit");

1548 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1549 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1552 
	`ASSERT
(
¬g_couÁ
 =ğ
idx
);

1554 
	`ä“
(
¿nge
);

1555  
du
;

1556 
	}
}

1558 
d©a_un™
 *
	$z»v¿ngebyscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1560 
d©a_un™
 *
du
;

1561 
idx
 = 0, 
¬g_couÁ
 = 0;

1562 
w™hscÜes
,
lim™
;

1563 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1565 
¬g_couÁ
 = 4;

1566 ià(
	`¿nd
()%2 == 1) {

1567 
w™hscÜes
 = 1;

1568 
¬g_couÁ
 ++;

1570 
w™hscÜes
 = 0;

1572 ià(
	`¿nd
()%2 == 1) {

1573 
lim™
 = 1;

1574 
¬g_couÁ
 += 3;

1576 
lim™
 = 0;

1579 
du
 = 
	`d©a_un™_g‘
();

1580 
du
->
dp
 = dp;

1581 
du
->
¬gc
 = 
¬g_couÁ
;

1582 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1583 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
(
dp
->
Çme
);

1584 
du
->
¬gv
[
idx
++] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1585 
du
->
¬gv
[
idx
++] = 
¿nge
[0];

1586 
du
->
¬gv
[
idx
++] = 
¿nge
[1];

1587 ià(
w™hscÜes
è
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("withscores");

1588 ià(
lim™
) {

1589 
du
->
¬gv
[
idx
++] = 
	`sd¢ew
("limit");

1590 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1591 
du
->
¬gv
[
idx
++] = 
	`sdsäomlÚglÚg
(
	`g‘_¿ndom_unsigÃd_št
());

1594 
	`ASSERT
(
¬g_couÁ
 =ğ
idx
);

1596 
	`ä“
(
¿nge
);

1597  
du
;

1598 
	}
}

1600 
d©a_un™
 *
	$z¿nk_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1602 
d©a_un™
 *
du
;

1604 
du
 = 
	`d©a_un™_g‘
();

1605 
du
->
dp
 = dp;

1606 
du
->
¬gc
 = 3;

1607 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1608 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1609 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1610 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1612  
du
;

1613 
	}
}

1615 
d©a_un™
 *
	$z»v¿nk_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1617 
d©a_un™
 *
du
;

1619 
du
 = 
	`d©a_un™_g‘
();

1620 
du
->
dp
 = dp;

1621 
du
->
¬gc
 = 3;

1622 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1623 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1624 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1625 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1627  
du
;

1628 
	}
}

1630 
d©a_un™
 *
	$zscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1632 
d©a_un™
 *
du
;

1634 
du
 = 
	`d©a_un™_g‘
();

1635 
du
->
dp
 = dp;

1636 
du
->
¬gc
 = 3;

1637 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1638 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1639 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1640 
du
->
¬gv
[2] = 
	`g‘_¿ndom_¡ršg
();

1642  
du
;

1643 
	}
}

1645 
d©a_un™
 *
	$z»m¿ngebyscÜe_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1647 
d©a_un™
 *
du
;

1648 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_SCORE
);

1650 
du
 = 
	`d©a_un™_g‘
();

1651 
du
->
dp
 = dp;

1652 
du
->
¬gc
 = 4;

1653 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1654 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1655 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1656 
du
->
¬gv
[2] = 
¿nge
[0];

1657 
du
->
¬gv
[3] = 
¿nge
[1];

1659 
	`ä“
(
¿nge
);

1660  
du
;

1661 
	}
}

1663 
d©a_un™
 *
	$z»m¿ngeby¿nk_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1665 
d©a_un™
 *
du
;

1666 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_RANK
);

1668 
du
 = 
	`d©a_un™_g‘
();

1669 
du
->
dp
 = dp;

1670 
du
->
¬gc
 = 4;

1671 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1672 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1673 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1674 
du
->
¬gv
[2] = 
¿nge
[0];

1675 
du
->
¬gv
[3] = 
¿nge
[1];

1677 
	`ä“
(
¿nge
);

1678  
du
;

1679 
	}
}

1681 
d©a_un™
 *
	$z»m¿ngebyËx_cmd_´oduûr
(
d©a_´oduûr
 *
dp
, 
´oduû_scheme
 *
ps
)

1683 
d©a_un™
 *
du
;

1684 
sds
 *
¿nge
 = 
	`g‘_¿ndom_z£t_¿nge_mš_max_¡r
(
ZSET_RANGE_MIN_MAX_TYPE_LEX
);

1686 
du
 = 
	`d©a_un™_g‘
();

1687 
du
->
dp
 = dp;

1688 
du
->
¬gc
 = 4;

1689 
du
->
¬gv
 = 
	`m®loc
(du->
¬gc
*(
sds
));

1690 
du
->
¬gv
[0] = 
	`sd¢ew
(
dp
->
Çme
);

1691 
du
->
¬gv
[1] = 
	`g‘_¿ndom_key_w™h_h™_¿tio
(
ps
,
dp
);

1692 
du
->
¬gv
[2] = 
¿nge
[0];

1693 
du
->
¬gv
[3] = 
¿nge
[1];

1695 
	`ä“
(
¿nge
);

1696  
du
;

1697 
	}
}

1699 
	g´oduûrs_couÁ
;

1700 
d©a_´oduûr
 
	g»dis_d©a_´oduûr_bË
[] = {

1702 {"d–",
d–_cmd_´oduûr
,-2,"w",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_KEY
,NULL},

1703 {"exi¡s",
exi¡s_cmd_´oduûr
,-2,"rF",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_KEY
,NULL},

1704 {"‰l",
‰l_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1705 {"±",
±_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1706 {"expœe",
expœe_cmd_´oduûr
,3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1707 {"expœ—t",
expœ—t_cmd_´oduûr
,3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,NULL},

1709 {"g‘",
g‘_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1710 {"£t",
£t_cmd_´oduûr
,-3,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_ok
},

1711 {"£Šx",
£Šx_cmd_´oduûr
,3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
£Šx_cmd_nck
},

1712 {"£‹x",
£‹x_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,
nck_wh’_ok
},

1713 {"p£‹x",
p£‹x_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_EXPIRE
,
nck_wh’_ok
},

1714 {"šü",
šü_cmd_´oduûr
,2,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1715 {"deü",
deü_cmd_´oduûr
,2,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1716 {"šüby",
šüby_cmd_´oduûr
,3,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1717 {"deüby",
deüby_cmd_´oduûr
,3,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1718 {"­³nd",
­³nd_cmd_´oduûr
,3,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
­³nd_cmd_nck
},

1719 {"¡¾’",
¡¾’_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1720 {"g‘£t",
g‘£t_cmd_´oduûr
,3,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_nÛ¼Ü
},

1721 {"šübyæßt",
šübyæßt_cmd_´oduûr
,3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_¡r
},

1722 {"£tb™",
£tb™_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_z”o_Ü_Úe
},

1723 {"g‘b™",
g‘b™_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1724 {"£Œªge",
£Œªge_cmd_´oduûr
,4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,
nck_wh’_nÚz”o_unsigÃd_š‹g”
},

1725 {"g‘¿nge",
g‘¿nge_cmd_´oduûr
,4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1726 {"b™couÁ",
b™couÁ_cmd_´oduûr
,-2,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1727 {"b™pos",
b™pos_cmd_´oduûr
,-3,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_STRING
,NULL},

1728 {"mg‘",
mg‘_cmd_´oduûr
,-2,"r",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_STRING
,NULL},

1729 {"m£t",
m£t_cmd_´oduûr
,-3,"wmA",0,
NULL
,1,-1,2,
TEST_CMD_TYPE_STRING
,
nck_wh’_ok
},

1731 {"h£t",
h£t_cmd_´oduûr
,4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,
nck_wh’_Úe
},

1732 {"hg‘",
hg‘_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1733 {"hËn",
hËn_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1734 {"hd–",
hd–_cmd_´oduûr
,-3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1735 {"hexi¡s",
hexi¡s_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1736 {"hkeys",
hkeys_cmd_´oduûr
,2,"rS",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1737 {"hv®s",
hv®s_cmd_´oduûr
,2,"rS",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1738 {"hg‘®l",
hg‘®l_cmd_´oduûr
,2,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1739 {"hšüby",
hšüby_cmd_´oduûr
,4,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1740 {"hšübyæßt",
hšübyæßt_cmd_´oduûr
,4,"wmF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1741 {"hmg‘",
hmg‘_cmd_´oduûr
,-3,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1742 {"hm£t",
hm£t_cmd_´oduûr
,-4,"wmA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,
nck_wh’_ok
},

1743 {"h£Šx",
h£Šx_cmd_´oduûr
,4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,
nck_wh’_Úe
},

1744 {"h¡¾’",
h¡¾’_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_HASH
,NULL},

1746 {"½ush",
½ush_cmd_´oduûr
,-3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,
½ush_cmd_nck
},

1747 {"Íush",
Íush_cmd_´oduûr
,-3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,
Íush_cmd_nck
},

1748 {"Ìªge",
Ìªge_cmd_´oduûr
,4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1749 {"½İ",
½İ_cmd_´oduûr
,2,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1750 {"Íİ",
Íİ_cmd_´oduûr
,2,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1751 {"Î’",
Î’_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1752 {"Ìem",
Ìem_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1753 {"Érim",
Érim_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1754 {"lšdex",
lšdex_cmd_´oduûr
,3,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1755 {"l£t",
l£t_cmd_´oduûr
,4,"wm",0,
NULL
,1,1,1,
TEST_CMD_TYPE_LIST
,NULL},

1757 {"§dd",
§dd_cmd_´oduûr
,-3,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,
nck_wh’_unsigÃd_š‹g”
},

1758 {"smemb”s",
smemb”s_cmd_´oduûr
,2,"rS",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1759 {"sÿrd",
sÿrd_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1760 {"¤em",
¤em_cmd_´oduûr
,-3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1761 {"sismemb”",
sismemb”_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_SET
,NULL},

1762 {"suniÚ",
suniÚ_cmd_´oduûr
,-2,"rS",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_SET
,NULL},

1763 {"sdiff",
sdiff_cmd_´oduûr
,-2,"rS",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_SET
,NULL},

1764 {"sš‹r",
sš‹r_cmd_´oduûr
,-2,"rS",0,
NULL
,1,-1,1,
TEST_CMD_TYPE_SET
,NULL},

1766 {"zadd",
zadd_cmd_´oduûr
,-4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,
zadd_cmd_nck
},

1767 {"zšüby",
zšüby_cmd_´oduûr
,4,"wmFA",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,
zšüby_cmd_nck
},

1768 {"z¿nge",
z¿nge_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1769 {"z»v¿nge",
z»v¿nge_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1770 {"z»m",
z»m_cmd_´oduûr
,-3,"wF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1771 {"zÿrd",
zÿrd_cmd_´oduûr
,2,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1772 {"zcouÁ",
zcouÁ_cmd_´oduûr
,4,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1773 {"z¿ngebyscÜe",
z¿ngebyscÜe_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1774 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜe_cmd_´oduûr
,-4,"r",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1775 {"z¿nk",
z¿nk_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1776 {"z»v¿nk",
z»v¿nk_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1777 {"zscÜe",
zscÜe_cmd_´oduûr
,3,"rF",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1778 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜe_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL},

1779 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nk_cmd_´oduûr
,4,"w",0,
NULL
,1,1,1,
TEST_CMD_TYPE_ZSET
,NULL}

1782 
d©a_un™
 *
	$d©a_un™_g‘
()

1784 
d©a_un™
 *
du
 = 
	`m®loc
((data_unit));

1785 
du
->
dp
 = 
NULL
;

1786 
du
->
¬gc
 = 0;

1787 
du
->
¬gv
 = 
NULL
;

1788 
du
->
hashv®ue
 = 0;

1789 
du
->
d©a
 = 
NULL
;

1790  
du
;

1791 
	}
}

1793 
	$d©a_un™_put
(
d©a_un™
 *
du
)

1795 
idx
;

1797 
idx
 = 0; idx < 
du
->
¬gc
; idx ++) {

1798 ià(
du
->
¬gv
[
idx
])

1799 
	`sdsä“
(
du
->
¬gv
[
idx
]);

1801 
	`ä“
(
du
->
¬gv
);

1802 
	`ä“
(
du
);

1803 
	}
}

1805 
´oduû_scheme
 *
	$´oduû_scheme_ü—‹
(
max_ÿched_keys
, 
h™_¿tio
)

1807 
´oduû_scheme
 *
ps
;

1808 
couÁ
, 
idx
;

1809 
¿tio
;

1811 
ps
 = 
	`m®loc
((*ps));

1812 ià(
ps
 =ğ
NULL
)  NULL;

1813 
ps
->
kıs
 = 
NULL
;

1814 
ps
->
h™_¿tio_¬¿y
 = 
NULL
;

1816 
ps
->
kıs
 = 
	`d¬¿y_ü—‹
(
PRODUCE_KEY_CACHE_POOL_COUNT
,(
key_ÿche_¬¿y
 *));

1817 
idx
 = 0; idx < 
PRODUCE_KEY_CACHE_POOL_COUNT
; idx ++) {

1818 
key_ÿche_¬¿y
 **
kı
 = 
	`d¬¿y_push
(
ps
->
kıs
);

1819 *
kı
 = 
	`key_ÿche_¬¿y_ü—‹
(
max_ÿched_keys
/
PRODUCE_KEY_CACHE_POOL_COUNT
);

1820 ià(*
kı
 =ğ
NULL
) {

1821  
NULL
;

1826 
ps
->
h™_¿tio_¬¿y_Ën
 = 100;

1827 
ps
->
h™_¿tio
 = hit_ratio;

1828 
ps
->
h™_¿tio_idx
 = 0;

1829 
ps
->
h™_¿tio_¬¿y
 = 
	`m®loc
Õs->
h™_¿tio_¬¿y_Ën
*());

1830 
¿tio
 = 
ps
->
h™_¿tio_¬¿y_Ën
/ps->
h™_¿tio
;

1831 ià(
¿tio
 > 1) {

1832 
couÁ
 = 
ps
->
h™_¿tio
;

1833 
idx
 = 0; idx < 
ps
->
h™_¿tio_¬¿y_Ën
; idx ++) {

1834 
ps
->
h™_¿tio_¬¿y
[
idx
] = 0;

1837 
couÁ
 = 
ps
->
h™_¿tio_¬¿y_Ën
 -…s->
h™_¿tio
;

1838 
idx
 = 0; idx < 
ps
->
h™_¿tio_¬¿y_Ën
; idx ++) {

1839 
ps
->
h™_¿tio_¬¿y
[
idx
] = 1;

1842 
couÁ
 > 0) {

1843 
idx
 = 
	`¿nd
()%
ps
->
h™_¿tio_¬¿y_Ën
;

1844 ià(
¿tio
 > 1) {

1845 ià(
ps
->
h™_¿tio_¬¿y
[
idx
] == 0) {

1846 
couÁ
 --;

1847 
ps
->
h™_¿tio_¬¿y
[
idx
] = 1;

1850 ià(
ps
->
h™_¿tio_¬¿y
[
idx
] == 1) {

1851 
couÁ
 --;

1852 
ps
->
h™_¿tio_¬¿y
[
idx
] = 0;

1857  
ps
;

1858 
	}
}

1860 
	$´oduû_scheme_de¡roy
(
´oduû_scheme
 *
ps
)

1862 
j
;

1863 ià(
ps
->
kıs
) {

1864 
j
 = 0; j < 
PRODUCE_KEY_CACHE_POOL_COUNT
; j ++) {

1865 
key_ÿche_¬¿y
 **
kı
 = 
	`d¬¿y_pİ
(
ps
->
kıs
);

1866 ià(*
kı
)
	`key_ÿche_¬¿y_de¡roy
(*kcp);

1868 
	`d¬¿y_de¡roy
(
ps
->
kıs
);

1871 
	`ä“
(
ps
->
h™_¿tio_¬¿y
);

1873 
	`ä“
(
ps
);

1874 
	}
}

1876 
	$g‘_kı_idx
(
ty³
)

1878 
idx
;

1880 
ty³
)

1882 
TEST_CMD_TYPE_STRING
:

1883 
idx
 = 0;

1886 
TEST_CMD_TYPE_LIST
:

1887 
idx
 = 1;

1890 
TEST_CMD_TYPE_SET
:

1891 
idx
 = 2;

1894 
TEST_CMD_TYPE_ZSET
:

1895 
idx
 = 3;

1898 
TEST_CMD_TYPE_HASH
:

1899 
idx
 = 4;

1903 
idx
 = -1;

1907  
idx
;

1908 
	}
}

1910 
	$£t_nÚ_em±y_kıs_idx
()

1912 ià(
cmd_ty³
&
TEST_CMD_TYPE_STRING
) {

1913 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1914 
	`g‘_kı_idx
(
TEST_CMD_TYPE_STRING
);

1916 ià(
cmd_ty³
&
TEST_CMD_TYPE_LIST
) {

1917 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1918 
	`g‘_kı_idx
(
TEST_CMD_TYPE_LIST
);

1920 ià(
cmd_ty³
&
TEST_CMD_TYPE_SET
) {

1921 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1922 
	`g‘_kı_idx
(
TEST_CMD_TYPE_SET
);

1924 ià(
cmd_ty³
&
TEST_CMD_TYPE_ZSET
) {

1925 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1926 
	`g‘_kı_idx
(
TEST_CMD_TYPE_ZSET
);

1928 ià(
cmd_ty³
&
TEST_CMD_TYPE_HASH
) {

1929 
nÚ_em±y_kıs_idx
[
nÚ_em±y_kıs_couÁ
++] =

1930 
	`g‘_kı_idx
(
TEST_CMD_TYPE_HASH
);

1932 
	}
}

1935 
key_ÿche_¬¿y
 *
	$kı_g‘_äom_ps
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
)

1937 
idx
;

1938 
key_ÿche_¬¿y
 **
kı
;

1940 ià(
ps
 =ğ
NULL
 ||…s->
kıs
 =ğNULL || 
dp
 == NULL)  NULL;

1942 ià(
dp
->
cmd_ty³
 =ğ
TEST_CMD_TYPE_KEY
) {

1943 ià(
nÚ_em±y_kıs_couÁ
==0) {

1944 
idx
 = -1;

1946 
idx
 = 
	`¿nd
()%
nÚ_em±y_kıs_couÁ
;

1947 
idx
 = 
nÚ_em±y_kıs_idx
[idx];

1948 
	`ASSERT
(
idx
 >= 0);

1951 
idx
 = 
	`g‘_kı_idx
(
dp
->
cmd_ty³
);

1954 ià(
idx
 >ğ
PRODUCE_KEY_CACHE_POOL_COUNT
 || idx < 0) {

1955  
NULL
;

1958 
kı
 = 
	`d¬¿y_g‘
(
ps
->
kıs
, 
idx
);

1960  *
kı
;

1961 
	}
}

1963 
	$v¹_´oduû_th»ads_š™
(
´oduû_th»ads_couÁ
,

1964 
ÿched_keys
, 
h™_¿tio
)

1966 
idx
;

1967 
	`d¬¿y_š™
(&
´oduû_th»ads
, 
´oduû_th»ads_couÁ
, (
´oduû_th»ad
));

1968 
´oduû_d©a_th»ads_couÁ
 = 
´oduû_th»ads_couÁ
;

1969 
idx
 = 0; idx < 
´oduû_th»ads_couÁ
; idx ++) {

1970 
´oduû_th»ad
 *
±
 = 
	`d¬¿y_push
(&
´oduû_th»ads
);

1971 
±
->
id
 = 
idx
;

1972 
±
->
th»ad_id
 = 0;

1973 
±
->
ps
 = 
	`´oduû_scheme_ü—‹
(
ÿched_keys
, 
h™_¿tio
);

1974 
±
->
·u£
 = 0;

1975 
±
->
loİtimes
 = 0;

1978  
VRT_OK
;

1979 
	}
}

1981 
	$v¹_´oduû_th»ads_deš™
()

1983 
´oduû_th»ad
 *
±
;

1984 
	`d¬¿y_n
(&
´oduû_th»ads
) > 0) {

1985 
±
 = 
	`d¬¿y_pİ
(&
´oduû_th»ads
);

1986 ià(
±
->
ps
) {

1987 
	`´oduû_scheme_de¡roy
(
±
->
ps
);

1988 
±
->
ps
 = 
NULL
;

1991 
	`d¬¿y_deš™
(&
´oduû_th»ads
);

1992 
	}
}

1994 *
	$v¹_´oduû_th»ad_run
(*
¬gs
)

1996 
»t
;

1997 
´oduû_th»ad
 *
±
 = 
¬gs
;

1998 
idx
, 
j
;

1999 
d©a_´oduûr
 **
dp
;

2000 
d©a_un™
 *
du
;

2002 
	`¤ªd
(
	`v¹_u£c_now
()^()
	`±h»ad_£lf
());

2006 ià(
±
->
·u£
) {

2007 
	`u¦“p
(1000000);

2008 ià(!
	`‹¡_if_Ãed_·u£
()) {

2009 
±
->
·u£
 = 0;

2013 } ià(
±
->
loİtimes
%10000 == 0) {

2014 ià(
	`‹¡_if_Ãed_·u£
()) {

2015 
±
->
·u£
 = 1;

2016 
	`Úe_´oduû_th»ad_·u£d
();

2021 
idx
 = 
	`¿nd
()%
Ãeded_cmd_ty³_´oduûr_couÁ
;

2022 
dp
 = 
	`d¬¿y_g‘
(&
Ãeded_cmd_ty³_´oduûr
,
idx
);

2023 
du
 = (*
dp
)->
	`´oc
(*dp,
±
->
ps
);

2025 
du
->
d©a
 = 
±
->
ps
;

2028 
»t
 = 
	`d©a_di¥©ch
(
du
);

2029 ià(
»t
 == -1) {

2030 
	`d©a_un™_put
(
du
);

2031 } ià(
»t
 == 1) {

2032 
	`u¦“p
(100000);

2035 
±
->
loİtimes
 ++;

2038  
NULL
;

2039 
	}
}

2041 
	$add_to_Ãeded_cmd_ty³_´oduûr
(
d©a_´oduûr
 *
dp
)

2043 
d©a_´oduûr
 **
dp_–em
 = 
	`d¬¿y_push
(&
Ãeded_cmd_ty³_´oduûr
);

2045 *
dp_–em
 = 
dp
;

2046 
Ãeded_cmd_ty³_´oduûr_couÁ
 ++;

2048  
VRT_OK
;

2049 
	}
}

2051 
	$v¹_´oduû_d©a_š™
(
key_Ëngth_¿nge_mš
,
key_Ëngth_¿nge_max
,

2052 
¡ršg_max_Ëngth
,
f›lds_max_couÁ
,

2053 
´oduû_cmd_ty³s
,
d¬¿y
 *
´oduû_cmd_bÏckli¡
,d¬¿y *
´oduû_cmd_wh™–i¡
,

2054 
´oduû_th»ads_couÁ
,
ÿched_keys
,

2055 
h™_¿tio
)

2057 
j
, 
k
;

2059 
key_Ëngth_mš
 = 
key_Ëngth_¿nge_mš
;

2060 
key_Ëngth_max
 = 
key_Ëngth_¿nge_max
;

2061 ià(
key_Ëngth_max
 < 
key_Ëngth_mš
è 
VRT_ERROR
;

2062 
key_Ëngth_¿nge_g­
 = 
key_Ëngth_max
-
key_Ëngth_mš
;

2063 
f›ld_Ëngth_max
 = 
f›lds_max_couÁ
;

2064 
¡ršg_Ëngth_max
 = 
¡ršg_max_Ëngth
;

2065 
cmd_ty³
 = 
´oduû_cmd_ty³s
;

2066 
	`d¬¿y_š™
(&
Ãeded_cmd_ty³_´oduûr
, 100, (
d©a_´oduûr
*));

2068 
´oduûrs_couÁ
 = (
»dis_d©a_´oduûr_bË
)/(
d©a_´oduûr
);

2069 
j
 = 0; j < 
´oduûrs_couÁ
; j++) {

2070 
d©a_´oduûr
 *
dp
 = 
»dis_d©a_´oduûr_bË
+
j
;

2071 *
f
 = 
dp
->
sæags
;

2073 *
f
 != '\0') {

2074 *
f
) {

2075 'w': 
dp
->
æags
 |ğ
PRO_WRITE
; ;

2076 'r': 
dp
->
æags
 |ğ
PRO_READONLY
; ;

2077 'm': 
dp
->
æags
 |ğ
PRO_DENYOOM
; ;

2078 'a': 
dp
->
æags
 |ğ
PRO_ADMIN
; ;

2079 'p': 
dp
->
æags
 |ğ
PRO_PUBSUB
; ;

2080 's': 
dp
->
æags
 |ğ
PRO_NOSCRIPT
; ;

2081 'R': 
dp
->
æags
 |ğ
PRO_RANDOM
; ;

2082 'S': 
dp
->
æags
 |ğ
PRO_SORT_FOR_SCRIPT
; ;

2083 'l': 
dp
->
æags
 |ğ
PRO_LOADING
; ;

2084 't': 
dp
->
æags
 |ğ
PRO_STALE
; ;

2085 'M': 
dp
->
æags
 |ğ
PRO_SKIP_MONITOR
; ;

2086 'k': 
dp
->
æags
 |ğ
PRO_ASKING
; ;

2087 'F': 
dp
->
æags
 |ğ
PRO_FAST
; ;

2088 'A': 
dp
->
æags
 |ğ
PRO_ADD
; ;

2089 :  
VRT_ERROR
;

2091 
f
++;

2094 ià(
d–‘e_d©a_´oduûr
 =ğ
NULL
 &&

2095 !
	`¡rcmp
(
dp
->
Çme
,"del")) {

2096 
d–‘e_d©a_´oduûr
 = 
dp
;

2099 ià(
´oduû_cmd_wh™–i¡
 !ğ
NULL
) {

2100 
k
 = 0; k < 
	`d¬¿y_n
(
´oduû_cmd_wh™–i¡
); k ++) {

2101 
sds
 *
cmdÇme
 = 
	`d¬¿y_g‘
(
´oduû_cmd_wh™–i¡
, 
k
);

2102 ià(!
	`¡rÿ£cmp
(
dp
->
Çme
,*
cmdÇme
)) {

2103 
	`add_to_Ãeded_cmd_ty³_´oduûr
(
dp
);

2111 ià(
´oduû_cmd_bÏckli¡
 !ğ
NULL
) {

2112 
is_š_bÏckli¡
 = 0;

2113 
k
 = 0; k < 
	`d¬¿y_n
(
´oduû_cmd_bÏckli¡
); k ++) {

2114 
sds
 *
cmdÇme
 = 
	`d¬¿y_g‘
(
´oduû_cmd_bÏckli¡
, 
k
);

2115 ià(!
	`¡rÿ£cmp
(
dp
->
Çme
,*
cmdÇme
)) {

2116 
is_š_bÏckli¡
 = 1;

2121 ià(
is_š_bÏckli¡
) {

2127 ià(
dp
->
cmd_ty³
&cmd_type) {

2128 
	`add_to_Ãeded_cmd_ty³_´oduûr
(
dp
);

2130 ià(
dp
->
cmd_ty³
&
TEST_CMD_TYPE_EXPIRE
 && 
expœe_’abËd
) {

2131 
	`add_to_Ãeded_cmd_ty³_´oduûr
(
dp
);

2135 
	`£t_nÚ_em±y_kıs_idx
();

2137 ià(
	`d¬¿y_n
(&
Ãeded_cmd_ty³_´oduûr
) == 0) {

2138 
	`log_”rÜ
("No command‚eedoest");

2139  
VRT_ERROR
;

2142 ià(
d–‘e_d©a_´oduûr
 =ğ
NULL
) {

2143  
VRT_ERROR
;

2146 ià(
Ãeded_cmd_ty³_´oduûr_couÁ
 == 0) {

2147  
VRT_ERROR
;

2150 
j
 = 0; j < 
Ãeded_cmd_ty³_´oduûr_couÁ
; j ++) {

2151 
d©a_´oduûr
 **
dp_–em
 = 
	`d¬¿y_g‘
(&
Ãeded_cmd_ty³_´oduûr
,
j
);

2152 
	`log_debug
(
LOG_INFO
, "Ãedede¡ commªd[%d]: %s", 
j
, (*
dp_–em
)->
Çme
);

2155 
	`v¹_´oduû_th»ads_š™
(
´oduû_th»ads_couÁ
, 
ÿched_keys
, 
h™_¿tio
);

2157  
VRT_OK
;

2158 
	}
}

2160 
	$v¹_´oduû_d©a_deš™
()

2162 
	`v¹_´oduû_th»ads_deš™
();

2164 
Ãeded_cmd_ty³_´oduûr
.
ÃËm
 = 0;

2165 
	`d¬¿y_deš™
(&
Ãeded_cmd_ty³_´oduûr
);

2166 
	}
}

2168 
	$v¹_¡¬t_´oduû_d©a
()

2170 
i
;

2171 
i
 = 0; i < 
	`d¬¿y_n
(&
´oduû_th»ads
); i ++) {

2172 
±h»ad_©Œ_t
 
©Œ
;

2173 
´oduû_th»ad
 *
±
;

2174 
	`±h»ad_©Œ_š™
(&
©Œ
);

2175 
±
 = 
	`d¬¿y_g‘
(&
´oduû_th»ads
, 
i
);

2176 
	`±h»ad_ü—‹
(&
±
->
th»ad_id
,

2177 &
©Œ
, 
v¹_´oduû_th»ad_run
, 
±
);

2180 
Ï¡_‹¡_begš_time
 = 
	`v¹_£c_now
();

2181  
VRT_OK
;

2182 
	}
}

2184 
	$v¹_wa™_´oduû_d©a
()

2186 
i
;

2188 
i
 = 0; i < 
	`d¬¿y_n
(&
´oduû_th»ads
); i ++){

2189 
´oduû_th»ad
 *
±
 = 
	`d¬¿y_g‘
(&
´oduû_th»ads
, 
i
);

2190 
	`±h»ad_još
(
±
->
th»ad_id
, 
NULL
);

2193  
VRT_OK
;

2194 
	}
}

2202 *
	$g‘_keys_usšg_d©a_´oduûr_bË
(
d©a_´oduûr
 *
dp
,
sds
 *
¬gv
, 
¬gc
, *
numkeys
) {

2203 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

2205 ià(
dp
->
fœ¡key
 == 0) {

2206 *
numkeys
 = 0;

2207  
NULL
;

2209 
Ï¡
 = 
dp
->
Ï¡key
;

2210 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

2211 
keys
 = 
	`m®loc
(()*((
Ï¡
 - 
dp
->
fœ¡key
)+1));

2212 
j
 = 
dp
->
fœ¡key
; j <ğ
Ï¡
; j +ğdp->
key¡•
) {

2213 
keys
[
i
++] = 
j
;

2215 *
numkeys
 = 
i
;

2216  
keys
;

2217 
	}
}

2230 *
	$g‘_keys_äom_d©a_´oduûr
(
d©a_´oduûr
 *
dp
, 
sds
 *
¬gv
, 
¬gc
, *
numkeys
) {

2231 ià(
dp
->
g‘keys_´oc
) {

2232  
dp
->
	`g‘keys_´oc
(dp,
¬gv
,
¬gc
,
numkeys
);

2234  
	`g‘_keys_usšg_d©a_´oduûr_bË
(
dp
,
¬gv
,
¬gc
,
numkeys
);

2236 
	}
}

2238 
sds
 
	$g‘_Úe_key_äom_d©a_un™
(
d©a_un™
 *
du
)

2240 
numkeys
;

2241 *
keyšdex
;

2242 
sds
 
key
;

2244 
keyšdex
 = 
	`g‘_keys_äom_d©a_´oduûr
(
du
->
dp
,du->
¬gv
,du->
¬gc
,&
numkeys
);

2245 ià(
numkeys
 <= 0) {

2246 
	`NOT_REACHED
();

2247  
NULL
;

2250 
key
 = 
du
->
¬gv
[
keyšdex
[0]];

2251 
	`ä“
(
keyšdex
);

2253  
key
;

2254 
	}
}

2256 
	$´št_´oduûr_commªd
(
d©a_un™
 *
du
)

2258 
j
;

2259 
sds
 
cmd
 = 
	`sd£m±y
();

2261 
j
 = 0; j < 
du
->
¬gc
; j ++) {

2262 
cmd
 = 
	`sdsÿtsds
(cmd,
du
->
¬gv
[
j
]);

2263 
cmd
 = 
	`sdsÿt
(cmd," ");

2265 
cmd
 = 
	`sdsÿt
(cmd,"\n");

2266 
	`log_wr™e_Ën
(
cmd
,
	`sd¦’
(cmd));

2267 
	`sdsä“
(
cmd
);

2268 
	}
}

	@tests/vrt_produce_data.h

1 #iâdeà
_VRT_PRODUCE_DATA_H_


2 
	#_VRT_PRODUCE_DATA_H_


	)

34 
	#PRO_WRITE
 1

	)

35 
	#PRO_READONLY
 2

	)

36 
	#PRO_DENYOOM
 4

	)

37 
	#PRO_NOT_USED_1
 8

	)

38 
	#PRO_ADMIN
 16

	)

39 
	#PRO_PUBSUB
 32

	)

40 
	#PRO_NOSCRIPT
 64

	)

41 
	#PRO_RANDOM
 128

	)

42 
	#PRO_SORT_FOR_SCRIPT
 256

	)

43 
	#PRO_LOADING
 512

	)

44 
	#PRO_STALE
 1024

	)

45 
	#PRO_SKIP_MONITOR
 2048

	)

46 
	#PRO_ASKING
 4096

	)

47 
	#PRO_FAST
 8192

	)

48 
	#PRO_ADD
 16384

	)

50 
	gd©a_´oduûr
;

51 
	g´oduû_scheme
;

52 
	gkey_ÿche_¬¿y
;

54 
d©a_un™
 *
	t»dis_commªd_´oc
(
	td©a_´oduûr
 *
	tdp
, 
	t´oduû_scheme
 *
	tps
);

55 *
	t»dis_g‘_keys_´oc
(
	td©a_´oduûr
 *
	tdp
, 
	tsds
 *
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

56 
	t´oduû_Ãed_ÿche_key_´oc
(
	t»disR•ly
 *
	t»¶y
);

57 
	sd©a_´oduûr
 {

58 *
	mÇme
;

59 
»dis_commªd_´oc
 *
	m´oc
;

60 
	m¬™y
;

62 *
	msæags
;

63 
	mæags
;

66 
»dis_g‘_keys_´oc
 *
	mg‘keys_´oc
;

68 
	mfœ¡key
;

69 
	mÏ¡key
;

70 
	mkey¡•
;

71 
	mcmd_ty³
;

72 
´oduû_Ãed_ÿche_key_´oc
 *
	mÃed_ÿche_key_´oc
;

73 } 
	td©a_´oduûr
;

75 
	sd©a_un™
 {

76 
d©a_´oduûr
 *
	mdp
;

77 
	m¬gc
;

78 
sds
 *
	m¬gv
;

80 
	mhashv®ue
;

82 *
	md©a
;

83 } 
	td©a_un™
;

85 
	s´oduû_scheme
 {

86 
d¬¿y
 *
	mkıs
;

88 
	mh™_¿tio
;

89 
	mh™_¿tio_idx
;

90 
	mh™_¿tio_¬¿y_Ën
;

91 *
	mh™_¿tio_¬¿y
;

92 } 
	t´oduû_scheme
;

94 
d©a_´oduûr
 *
d–‘e_d©a_´oduûr
;

96 
´oduû_d©a_th»ads_couÁ
;

98 
´oduû_th»ads_·u£_fšished_couÁ
;

100 
key_ÿche_¬¿y
 *
kı_g‘_äom_ps
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
);

102 
d©a_un™
 *
d©a_un™_g‘
();

103 
d©a_un™_put
(
d©a_un™
 *
du
);

105 
v¹_´oduû_d©a_š™
(
key_Ëngth_¿nge_mš
, 
key_Ëngth_¿nge_max
,

106 
¡ršg_max_Ëngth
,
f›lds_max_couÁ
,

107 
´oduû_cmd_ty³s
,
d¬¿y
 *
´oduû_cmd_bÏckli¡
,d¬¿y *
´oduû_cmd_wh™–i¡
,

108 
´oduû_th»ads_couÁ
, 
ÿched_keys
,

109 
h™_¿tio
);

110 
v¹_´oduû_d©a_deš™
();

112 
v¹_¡¬t_´oduû_d©a
();

113 
v¹_wa™_´oduû_d©a
();

115 *
g‘_keys_äom_d©a_´oduûr
(
d©a_´oduûr
 *
dp
, 
sds
 *
¬gv
, 
¬gc
, *
numkeys
);

117 
sds
 
g‘_Úe_key_äom_d©a_un™
(
d©a_un™
 *
du
);

119 
´št_´oduûr_commªd
(
d©a_un™
 *
du
);

	@tests/vrt_produce_data.h

1 #iâdeà
_VRT_PRODUCE_DATA_H_


2 
	#_VRT_PRODUCE_DATA_H_


	)

34 
	#PRO_WRITE
 1

	)

35 
	#PRO_READONLY
 2

	)

36 
	#PRO_DENYOOM
 4

	)

37 
	#PRO_NOT_USED_1
 8

	)

38 
	#PRO_ADMIN
 16

	)

39 
	#PRO_PUBSUB
 32

	)

40 
	#PRO_NOSCRIPT
 64

	)

41 
	#PRO_RANDOM
 128

	)

42 
	#PRO_SORT_FOR_SCRIPT
 256

	)

43 
	#PRO_LOADING
 512

	)

44 
	#PRO_STALE
 1024

	)

45 
	#PRO_SKIP_MONITOR
 2048

	)

46 
	#PRO_ASKING
 4096

	)

47 
	#PRO_FAST
 8192

	)

48 
	#PRO_ADD
 16384

	)

50 
	gd©a_´oduûr
;

51 
	g´oduû_scheme
;

52 
	gkey_ÿche_¬¿y
;

54 
d©a_un™
 *
	t»dis_commªd_´oc
(
	td©a_´oduûr
 *
	tdp
, 
	t´oduû_scheme
 *
	tps
);

55 *
	t»dis_g‘_keys_´oc
(
	td©a_´oduûr
 *
	tdp
, 
	tsds
 *
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

56 
	t´oduû_Ãed_ÿche_key_´oc
(
	t»disR•ly
 *
	t»¶y
);

57 
	sd©a_´oduûr
 {

58 *
	mÇme
;

59 
»dis_commªd_´oc
 *
	m´oc
;

60 
	m¬™y
;

62 *
	msæags
;

63 
	mæags
;

66 
»dis_g‘_keys_´oc
 *
	mg‘keys_´oc
;

68 
	mfœ¡key
;

69 
	mÏ¡key
;

70 
	mkey¡•
;

71 
	mcmd_ty³
;

72 
´oduû_Ãed_ÿche_key_´oc
 *
	mÃed_ÿche_key_´oc
;

73 } 
	td©a_´oduûr
;

75 
	sd©a_un™
 {

76 
d©a_´oduûr
 *
	mdp
;

77 
	m¬gc
;

78 
sds
 *
	m¬gv
;

80 
	mhashv®ue
;

82 *
	md©a
;

83 } 
	td©a_un™
;

85 
	s´oduû_scheme
 {

86 
d¬¿y
 *
	mkıs
;

88 
	mh™_¿tio
;

89 
	mh™_¿tio_idx
;

90 
	mh™_¿tio_¬¿y_Ën
;

91 *
	mh™_¿tio_¬¿y
;

92 } 
	t´oduû_scheme
;

94 
d©a_´oduûr
 *
d–‘e_d©a_´oduûr
;

96 
´oduû_d©a_th»ads_couÁ
;

98 
´oduû_th»ads_·u£_fšished_couÁ
;

100 
key_ÿche_¬¿y
 *
kı_g‘_äom_ps
(
´oduû_scheme
 *
ps
, 
d©a_´oduûr
 *
dp
);

102 
d©a_un™
 *
d©a_un™_g‘
();

103 
d©a_un™_put
(
d©a_un™
 *
du
);

105 
v¹_´oduû_d©a_š™
(
key_Ëngth_¿nge_mš
, 
key_Ëngth_¿nge_max
,

106 
¡ršg_max_Ëngth
,
f›lds_max_couÁ
,

107 
´oduû_cmd_ty³s
,
d¬¿y
 *
´oduû_cmd_bÏckli¡
,d¬¿y *
´oduû_cmd_wh™–i¡
,

108 
´oduû_th»ads_couÁ
, 
ÿched_keys
,

109 
h™_¿tio
);

110 
v¹_´oduû_d©a_deš™
();

112 
v¹_¡¬t_´oduû_d©a
();

113 
v¹_wa™_´oduû_d©a
();

115 *
g‘_keys_äom_d©a_´oduûr
(
d©a_´oduûr
 *
dp
, 
sds
 *
¬gv
, 
¬gc
, *
numkeys
);

117 
sds
 
g‘_Úe_key_äom_d©a_un™
(
d©a_un™
 *
du
);

119 
´št_´oduûr_commªd
(
d©a_un™
 *
du
);

	@tests/vrt_public.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<fú.h
>

5 
	~<”ºo.h
>

6 
	~<sigÇl.h
>

7 
	~<±h»ad.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

13 
	~<d¬¿y.h
>

14 
	~<dlog.h
>

16 
	~<v¹_ut.h
>

17 
	~<v¹_public.h
>

20 #ià
defšed
(
__ATOMIC_RELAXED
)

22 #–ià
defšed
(
HAVE_ATOMIC
)

24 
±h»ad_mu‹x_t
 
	g¡©e_lock”
 = 
PTHREAD_MUTEX_INITIALIZER
;

27 
	#VIRE_TEST_CONFIG_DEFAULT_EXECUTE_FILE
 "¤c/vœe"

	)

29 *
	gexecu‹_fe
 = 
VIRE_TEST_CONFIG_DEFAULT_EXECUTE_FILE
;

31 
sds
 
	gwÜkdœ
 = 
NULL
;

33 
	gvœ•Üt
 = 55556;

35 
	$£t_execu‹_fe
(*
fe
)

37 
execu‹_fe
 = 
fe
;

38 
	}
}

40 
sds
 
	$vœe_cÚf_ü—‹
(*
dœ
, 
pÜt
)

42 
sds
 
cÚf_fe
;

43 
fd
;

44 
sds
 
lše
;

46 
cÚf_fe
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/vœe.cÚf",
dœ
);

48 
fd
 = 
	`İ’
(
cÚf_fe
,
O_WRONLY
|
O_CREAT
|
O_TRUNC
,0644);

49 ià(
fd
 < 0) {

50 
	`‹¡_log_”rÜ
("O³ÀcÚàf% çed: %s", 
cÚf_fe
, 
	`¡»¼Ü
(
”ºo
));

51 
	`sdsä“
(
cÚf_fe
);

52  
NULL
;

55 
lše
 = 
	`sd£m±y
();

57 
lše
 = 
	`sdsÿtfmt
Öše,"pÜˆ%i\n",
pÜt
);

58 
	`wr™e
(
fd
, 
lše
, 
	`sd¦’
(line));

60 
	`sdsş—r
(
lše
);

61 
lše
 = 
	`sdsÿtfmt
(line,"\n");

62 
	`wr™e
(
fd
, 
lše
, 
	`sd¦’
(line));

64 
	`şo£
(
fd
);

65 
	`sdsä“
(
lše
);

66  
cÚf_fe
;

67 
	}
}

69 
vœe_š¡ªû
 *
	$vœe_š¡ªû_ü—‹
(
pÜt
)

71 
vœe_š¡ªû
 *
vi
;

73 
vi
 = 
	`m®loc
((
vœe_š¡ªû
));

74 
vi
->
ho¡
 = 
NULL
;

75 
vi
->
pÜt
 = 0;

76 
vi
->
dœ
 = 
NULL
;

77 
vi
->
cÚf_fe
 = 
NULL
;

78 
vi
->
pid_fe
 = 
NULL
;

79 
vi
->
log_fe
 = 
NULL
;

80 
vi
->
ruÂšg
 = 0;

81 
vi
->
pid
 = -1;

82 
vi
->
ùx
 = 
NULL
;

84 
vi
->
ho¡
 = 
	`sd¢ew
("127.0.0.1");

85 
vi
->
pÜt
 =…ort;

86 
vi
->
dœ
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/%i",
wÜkdœ
,
pÜt
);

88 ià(
	`mkdœ
(
vi
->
dœ
,0755) < 0) {

89 
	`vœe_š¡ªû_de¡roy
(
vi
);

90  
NULL
;

93 
vi
->
cÚf_fe
 = 
	`vœe_cÚf_ü—‹
(vi->
dœ
, 
pÜt
);

94 ià(
vi
->
cÚf_fe
 =ğ
NULL
) {

95 
	`vœe_š¡ªû_de¡roy
(
vi
);

96  
NULL
;

99 
vi
->
pid_fe
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/vœe.pid",vi->
dœ
);

100 
vi
->
log_fe
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/vœe.log",vi->
dœ
);

102 
	`‹¡_log_debug
("vœho¡: %s", 
vi
->
ho¡
);

103 
	`‹¡_log_debug
("vœpÜt: %d", 
vi
->
pÜt
);

104 
	`‹¡_log_debug
("vœdœ: %s", 
vi
->
dœ
);

105 
	`‹¡_log_debug
("vœcÚf_fe: %s", 
vi
->
cÚf_fe
);

106 
	`‹¡_log_debug
("vœpid_fe: %s", 
vi
->
pid_fe
);

107 
	`‹¡_log_debug
("vœlog_fe: %s", 
vi
->
log_fe
);

109  
vi
;

110 
	}
}

112 
	$vœe_š¡ªû_de¡roy
(
vœe_š¡ªû
 *
vi
)

114 ià(
vi
->
ruÂšg
) {

115 
	`vœe_£rv”_¡İ
(
vi
);

118 ià(
vi
->
dœ
) {

119 
	`de¡roy_dœ
(
vi
->
dœ
);

120 
	`sdsä“
(
vi
->
dœ
);

123 ià(
vi
->
cÚf_fe
) {

124 
	`sdsä“
(
vi
->
cÚf_fe
);

127 ià(
vi
->
pid_fe
) {

128 
	`sdsä“
(
vi
->
pid_fe
);

131 ià(
vi
->
log_fe
) {

132 
	`sdsä“
(
vi
->
log_fe
);

135 ià(
vi
->
ùx
) {

136 
	`»disF»e
(
vi
->
ùx
);

139 ià(
vi
->
ho¡
) {

140 
	`sdsä“
(
vi
->
ho¡
);

143 
	`ä“
(
vi
);

144 
	}
}

146 
	$vœe_£rv”_run
(
vœe_š¡ªû
 *
vi
)

148 
»t
;

149 
pid_t
 
pid
;

150 
¡©us
;

151 
timev®
 
timeout
 = { 3, 500000 };

153 ià((
pid
 = 
	`fÜk
()) < 0) {

154 
	`‹¡_log_”rÜ
("FÜk‡ chšd faed: %s", 
	`¡»¼Ü
(
”ºo
));

155  
VRT_ERROR
;

156 } ià(
pid
 == 0) {

157 
»t
 = 
	`exeş
(
execu‹_fe
,"vœe","-c",
vi
->
cÚf_fe
,

158 "-p",
vi
->
pid_fe
,"-o",vi->
log_fe
,"-v","8",
NULL
);

159 ià(
»t
 < 0) {

160 
	`‹¡_log_”rÜ
("Exeşhvœ£rv” faed: %s", 
	`¡»¼Ü
(
”ºo
));

161  
VRT_ERROR
;

166 
	`¦“p
(1);

168 
»t
 = 
	`wa™pid
(
pid
,
NULL
,
WNOHANG
);

169 ià(
»t
 != 0) {

170 
	`‹¡_log_debug
("RuÀvœ£rv”ÕÜˆ%dèçed",
vi
->
pÜt
);

171  
VRT_ERROR
;

174 
vi
->
ùx
 = 
	`»disCÚÃùW™hTimeout
(vi->
ho¡
,vi->
pÜt
,
timeout
);

175 ià(
vi
->
ùx
 =ğ
NULL
 || vi->ùx->
”r
) {

176 
	`‹¡_log_”rÜ
("Connecto %s:%d failed: %s",

177 
vi
->
ho¡
, vi->
pÜt
, vi->
ùx
?vi->ùx->
”r¡r
:"out of memory");

178 ià(
vi
->
ùx
) {

179 
	`»disF»e
(
vi
->
ùx
);

180 
vi
->
ùx
 = 
NULL
;

182  
VRT_ERROR
;

185 
vi
->
pid
 = 
	`g‘_pid_äom_»¶y
(vi->
ùx
,vi->
ho¡
,vi->
pÜt
);

186 ià(
vi
->
pid
 < 0) {

187 
	`‹¡_log_”rÜ
("G‘…id from %s:%d„•lyƒ¼Ü", 
vi
->
ho¡
, vi->
pÜt
);

188  
VRT_ERROR
;

189 } ià(
vi
->
pid
 !=…id) {

190 
	`‹¡_log_”rÜ
("G‘ wrÚg…id from %s:%d„•ly", 
vi
->
ho¡
, vi->
pÜt
);

191  
VRT_ERROR
;

194 
	`‹¡_log_debug
("RuÀvœ£rv”ÕÜˆ%dèsucûss",
vi
->
pÜt
);

196 
vi
->
ruÂšg
 = 1;

198  
VRT_OK
;

199 
	}
}

201 
	$vœe_£rv”_¡İ
(
vœe_š¡ªû
 *
vi
)

203 
pid
;

205 ià(!
vi
->
ruÂšg
) ;

207 ià(
vi
->
pid
 > 0) {

208 
pid
 = 
vi
->pid;

209 } ià(
vi
->
pid_fe
) {

210 
fd
;

211 
pid_¡r
[20];

212 
size_t
 
Ä—d
;

213 
fd
 = 
	`İ’
(
vi
->
pid_fe
, 
O_RDONLY
);

214 ià(
fd
 < 0) {

215 
	`‹¡_log_”rÜ
("O³Àpid f% çed", 
vi
->
pid_fe
);

218 
Ä—d
 = 
	`»ad
(
fd
,
pid_¡r
,20);

219 ià(
	`¡ršg2l
(
pid_¡r
,
Ä—d
,&
pid
) == 0) {

220 
	`‹¡_log_”rÜ
("CÚv”ˆpid sŒšg %.* tØlÚg faed",
Ä—d
,
pid_¡r
);

224 
pid
 = 
	`g‘_pid_äom_»¶y
(
vi
->
ùx
, vi->
ho¡
, vi->
pÜt
);

227 ià(
pid
 < 0) {

228 
	`‹¡_log_”rÜ
("Get…id failed");

232 
	`kl
(
pid
,9);

234 
vi
->
ruÂšg
 = 0;

235 
vi
->
pid
 = -1;

236 ià(
vi
->
ùx
) {

237 
	`»disF»e
(
vi
->
ùx
);

238 
vi
->
ùx
 = 
NULL
;

240 
	}
}

242 
	$ü—‹_wÜk_dœ
()

244 
sds
 
dœÇme
;

245 
dœÇme
 = 
	`sdsÿtfmt
(
	`sd£m±y
(), "tmp_‹¡_%I", 
	`v¹_u£c_now
());

246 
wÜkdœ
 = 
	`g‘AbsŞu‹P©h
(
dœÇme
);

247 
	`sdsä“
(
dœÇme
);

249 ià(
	`ü—‹_dœ
(
wÜkdœ
è!ğ
VRT_OK
) {

250 
	`‹¡_log_”rÜ
("C»©wÜkdœ % çed",
wÜkdœ
);

251  
VRT_ERROR
;

254 
	`‹¡_log_debug
("C»©wÜkdœ: %s",
wÜkdœ
);

256  
VRT_OK
;

257 
	}
}

259 
	$de¡roy_wÜk_dœ
()

261 ià(
wÜkdœ
 =ğ
NULL
è 
VRT_OK
;

263 ià(
	`de¡roy_dœ
(
wÜkdœ
è!ğ
VRT_OK
) {

264 
	`‹¡_log_”rÜ
("D–‘thwÜkdœ % çed",
wÜkdœ
);

266 
	`‹¡_log_debug
("D–‘thwÜkdœ: %s",
wÜkdœ
);

269 
	`sdsä“
(
wÜkdœ
);

270 
wÜkdœ
 = 
NULL
;

272  
VRT_OK
;

273 
	}
}

275 
	$g‘_Ãxt_pÜt
()

277 
pÜt
 = 
vœ•Üt
;

278 
vœ•Üt
 += 11;

280  
pÜt
;

281 
	}
}

283 
vœe_š¡ªû
 *
	$¡¬t_Úe_vœe_š¡ªû
()

285 
»t
;

286 
»Œy
 = 0;

287 
vœe_š¡ªû
 *
vi
;

289 
vi
 = 
	`vœe_š¡ªû_ü—‹
(
	`g‘_Ãxt_pÜt
());

290 ià(
vi
 =ğ
NULL
) {

291  
NULL
;

294 
»t
 = 
	`vœe_£rv”_run
(
vi
);

295 
»t
 !ğ
VRT_OK
 && 
»Œy
++ < 10) {

296 
	`vœe_š¡ªû_de¡roy
(
vi
);

297 
vi
 = 
	`vœe_š¡ªû_ü—‹
(
	`g‘_Ãxt_pÜt
());

298 ià(
vi
 =ğ
NULL
) {

299  
NULL
;

301 
»t
 = 
	`vœe_£rv”_run
(
vi
);

304 ià(
»t
 !ğ
VRT_OK
) {

305 
	`vœe_š¡ªû_de¡roy
(
vi
);

306  
NULL
;

309  
vi
;

310 
	}
}

312 
	$show_‹¡_»suÉ
(
»suÉ
,*
‹¡_cÚ‹Á
,*
”rmsg
)

314 ià(
»suÉ
 =ğ
VRT_TEST_OK
) {

315 
	`‹¡_log_out
("[\033[32mOK\033[0m]: %s", 
‹¡_cÚ‹Á
);

316 } ià(
»suÉ
 =ğ
VRT_TEST_ERR
) {

317 
	`‹¡_log_out
("[\033[31mERR\033[0m]: %s, \033[33mç cau£: %s\033[0m", 
‹¡_cÚ‹Á
,

318 (
”rmsg
==
NULL
||
	`¡¾’
(errmsg)==0)?"unknown":errmsg);

320 
	}
}

323 
key_ÿche_¬¿y
 *
	$key_ÿche_¬¿y_ü—‹
(
max_poŞ_size
)

325 
idx
;

326 
key_ÿche_¬¿y
 *
kÿ
;

329 ià(
max_poŞ_size
 < 10è 
NULL
;

331 
kÿ
 = 
	`m®loc
((*kca));

332 ià(
kÿ
 =ğ
NULL
)  NULL;

334 
kÿ
->
ÿched_keys_couÁ
 = 0;

335 
kÿ
->
ckeys_wr™e_idx
 = 0;

336 
kÿ
->
max_poŞ_size
 = max_pool_size;

337 
kÿ
->
ckeys
 = 
NULL
;

338 
	`±h»ad_mu‹x_š™
(&
kÿ
->
pmu‹x
,
NULL
);

340 
kÿ
->
ckeys
 = 
	`m®loc
(
max_poŞ_size
*(
sds
));

341 
idx
 = 0; idx < 
max_poŞ_size
; idx ++) {

342 
kÿ
->
ckeys
[
idx
] = 
	`sd£m±y
();

345  
kÿ
;

346 
	}
}

348 
	$key_ÿche_¬¿y_de¡roy
(
key_ÿche_¬¿y
 *
kÿ
)

350 
idx
;

352 ià(
kÿ
 =ğ
NULL
) ;

354 
	`±h»ad_mu‹x_de¡roy
(&
kÿ
->
pmu‹x
);

356 ià(
kÿ
->
ckeys
) {

357 
idx
 = 0; idx < 
kÿ
->
max_poŞ_size
; idx ++) {

358 
	`sdsä“
(
kÿ
->
ckeys
[
idx
]);

360 
	`ä“
(
kÿ
->
ckeys
);

363 
	`ä“
(
kÿ
);

364 
	}
}

366 
	$key_ÿche_¬¿y_šput
(
key_ÿche_¬¿y
 *
kÿ
, *
key
, 
size_t
 
keyËn
)

368 ià(
kÿ
 =ğ
NULL
 || 
key
 =ğNULL || 
keyËn
 =ğ0è 
VRT_ERROR
;

370 
	`±h»ad_mu‹x_lock
(&
kÿ
->
pmu‹x
);

371 
kÿ
->
ckeys
[kÿ->
ckeys_wr™e_idx
]=
	`sdsıyËn
(kÿ->ckeys[kÿ->ckeys_wr™e_idx],
key
,
keyËn
);

372 
kÿ
->
ckeys_wr™e_idx
++;

373 ià(
kÿ
->
ckeys_wr™e_idx
 >ğkÿ->
max_poŞ_size
) {

374 
kÿ
->
ckeys_wr™e_idx
 = 0;

377 ià(
kÿ
->
ÿched_keys_couÁ
 < kÿ->
max_poŞ_size
) {

378 
kÿ
->
ÿched_keys_couÁ
++;

380 
	`±h»ad_mu‹x_uÆock
(&
kÿ
->
pmu‹x
);

382  
VRT_OK
;

383 
	}
}

385 
sds
 
	$key_ÿche_¬¿y_¿ndom
(
key_ÿche_¬¿y
 *
kÿ
)

387 
idx
, 
¿ndomv®
;

388 
sds
 
key
;

390 ià(
kÿ
 =ğ
NULL
) {

391  
NULL
;

394 
¿ndomv®
 = ()
	`¿nd
();

396 
	`±h»ad_mu‹x_lock
(&
kÿ
->
pmu‹x
);

397 ià(
kÿ
->
ÿched_keys_couÁ
 == 0) {

398 
	`±h»ad_mu‹x_uÆock
(&
kÿ
->
pmu‹x
);

399  
NULL
;

402 
idx
 = 
¿ndomv®
%()
kÿ
->
ÿched_keys_couÁ
;

404 
key
 = 
	`sdsdup
(
kÿ
->
ckeys
[
idx
]);

405 
	`±h»ad_mu‹x_uÆock
(&
kÿ
->
pmu‹x
);

407  
key
;

408 
	}
}

412 
	$g‘_lÚglÚg_äom_šfo_»¶y
(
»disR•ly
 *
»¶y
, *
Çme
)

414 
sds
 *
lšes
;

415 
size_t
 
lše_Ën
, 
Ën
;

416 
couÁ
, 
j
;

417 
v®ue
 = -1;

419 
Ën
 = 
	`¡¾’
(
Çme
);

421 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

422 
	`‹¡_log_”rÜ
("Reply for 'info' command from vireype %d isƒrror",

423 
»¶y
->
ty³
);

427 
lšes
 = 
	`sds¥l™Ën
(
»¶y
->
¡r
,»¶y->
Ën
,"\r\n",2,&
couÁ
);

428 ià(
lšes
 =ğ
NULL
) {

429 
	`‹¡_log_”rÜ
("Reply for 'info server' command from vire isƒrror");

433 
j
 = 0; j < 
couÁ
; j ++) {

434 
lše_Ën
 = 
	`sd¦’
(
lšes
[
j
]);

435 ià(
lše_Ën
 > 
Ën
+1 && !
	`¡ºcmp
(
Çme
, 
lšes
[
j
],†en)) {

436 ià(
	`¡ršg2Î
(
lšes
[
j
]+
Ën
+1,
lše_Ën
-Ën-1,&
v®ue
) == 0) {

437 
	`‹¡_log_”rÜ
("Convert…id string %.*so†ong failed",

438 
lše_Ën
-
Ën
-1,
lšes
[
j
]+len+1);

439 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

446 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

447  
v®ue
;

448 
	}
}

450 
»disR•ly
 *
	$¡—l_hœedis_»di¤•ly
(
»disR•ly
 *
r
)

452 
»disR•ly
 *
»¶y
;

454 
»¶y
 = 
	`ÿÎoc
(1,(*reply));

455 ià(
»¶y
 =ğ
NULL
) {

456  
NULL
;

459 
»¶y
->
ty³
 = 
r
->type;

460 
»¶y
->
š‹g”
 = 
r
->integer;

461 
»¶y
->
Ën
 = 
r
->len;

462 
»¶y
->
¡r
 = 
r
->str;

463 
»¶y
->
–em’ts
 = 
r
->elements;

464 
»¶y
->
–em’t
 = 
r
->element;

466 
r
->
Ën
 = 0;

467 
r
->
¡r
 = 
NULL
;

468 
r
->
–em’ts
 = 0;

469 
r
->
–em’t
 = 
NULL
;

471  
»¶y
;

472 
	}
}

474 
	$check_two_»¶ys_if_§me
(
»disR•ly
 *
»¶y1
,„edisR•ly *
»¶y2
)

476 ià(
»¶y1
 =ğ
NULL
 || 
»¶y2
 == NULL) {

480 ià(
»¶y1
->
ty³
 !ğ
»¶y2
->type) {

484 ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_STRING
 ||

485 
»¶y1
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

486 
»¶y1
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

487 ià(
»¶y1
->
Ën
 !ğ
»¶y2
->len) {

488  
»¶y1
->
Ën
-
»¶y2
->len;

491  
	`memcmp
(
»¶y1
->
¡r
, 
»¶y2
->¡r,„•ly1->
Ën
);

492 } ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_ARRAY
) {

493 
size_t
 
j
;

494 ià(
»¶y1
->
–em’ts
 !ğ
»¶y2
->elements) {

495  (
»¶y1
->
–em’ts
-
»¶y2
->elements);

498 
j
 = 0; j < 
»¶y1
->
–em’ts
; j ++) {

499 
»t
 = 
	`check_two_»¶ys_if_§me
(
»¶y1
->
–em’t
[
j
], 
»¶y2
->element[j]);

500 ià(
»t
 != 0) „et;

503 } ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

504  (
»¶y1
->
š‹g”
-
»¶y2
->integer);

505 } ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_NIL
) {

508 
	`‹¡_log_”rÜ
("»¶yy³ %d i ”rÜ", 
»¶y1
->
ty³
);

512 
	}
}

514 
	ssÜt_un™
 {

515 
size_t
 
	mnf›ld
;

516 **
	mf›lds
;

517 
	midx_cmp
;

518 (*
	mfcmp
)(const *,const *);

521 
	$–em’t_cmp_muÉi_¡•
(cÚ¡ *
–e1
,cÚ¡ *
–e2
)

523 
sÜt_un™
 *
su1
 = (sÜt_un™ *)
–e1
, *
su2
 = (sÜt_un™ *)
–e2
;

525 
	`ASSERT
(
su1
->
fcmp
 =ğ
su2
->fcmp);

526 
	`ASSERT
(
su1
->
nf›ld
 =ğ
su2
->nfield);

527 
	`ASSERT
(
su1
->
idx_cmp
 =ğ
su2
->idx_cmp);

528 
	`ASSERT
(
su1
->
idx_cmp
 < su1->
nf›ld
);

530  
su1
->
	`fcmp
(&(su1->
f›lds
[su1->
idx_cmp
]),&(
su2
->fields[su2->idx_cmp]));

531 
	}
}

534 
	$sÜt_¬¿y_by_¡•
(**
–em’t
, 
size_t
 
–em’ts
,

535 
¡•
, 
idx_cmp
, (*
fcmp
)(const *,const *))

537 
sÜt_un™
 *
sus
;

538 
size_t
 
couÁ
, 
j
, 
k
;

540 ià(
–em’ts
 <= 1)

541  
VRT_OK
;

543 ià(
¡•
 <= 0)

544  
VRT_ERROR
;

546 ià(
¡•
 == 1) {

547 
	`qsÜt
(
–em’t
, 
–em’ts
, (*), 
fcmp
);

548  
VRT_OK
;

551 ià(
–em’ts
%
¡•
 != 0)

552  
VRT_ERROR
;

554 
couÁ
 = 
–em’ts
/
¡•
;

555 ià(
couÁ
 == 0)

556  
VRT_ERROR
;

557 
sus
 = 
	`ÿÎoc
(
couÁ
,(
sÜt_un™
));

558 
j
 = 0; j < 
couÁ
; j ++) {

559 
sus
[
j
].
nf›ld
 = 
¡•
;

560 
sus
[
j
].
idx_cmp
 = idx_cmp;

561 
sus
[
j
].
fcmp
 = fcmp;

562 
sus
[
j
].
f›lds
 = 
	`m®loc
(
¡•
*(*));

563 
k
 = 0; k < 
¡•
; k ++) {

564 
sus
[
j
].
f›lds
[
k
] = 
–em’t
[j*
¡•
+k];

568 
	`qsÜt
(
sus
, 
couÁ
, (
sÜt_un™
), 
–em’t_cmp_muÉi_¡•
);

570 
j
 = 0; j < 
couÁ
; j ++) {

571 
k
 = 0; k < 
¡•
; k ++) {

572 
–em’t
[
j
*
¡•
+
k
] = 
sus
[j].
f›lds
[k];

574 
	`ä“
(
sus
[
j
].
f›lds
);

576 
	`ä“
(
sus
);

577  
VRT_OK
;

578 
	}
}

581 
	$»¶y_¡ršg_bš¬y_com·»
(cÚ¡ *
r1
,cÚ¡ *
r2
)

583 
»disR•ly
 *
»¶y1
 = *ÔedisR•ly **)
r1
, *
»¶y2
 = *ÔedisR•ly **)
r2
;

584 
mšËn
;

585 
cmp
;

587 
mšËn
 = (
»¶y1
->
Ën
 < 
»¶y2
->len) ?„eply1->len:reply2->len;

588 
cmp
 = 
	`memcmp
(
»¶y1
->
¡r
,
»¶y2
->¡r,
mšËn
);

589 ià(
cmp
 =ğ0è 
»¶y1
->
Ën
 - 
»¶y2
->len;

590  
cmp
;

591 
	}
}

594 
	$·r£_commªd_ty³s
(*
commªd_ty³s_¡r
)

596 
ty³s
 = 0;

597 
sds
 *
ty³s_¡rs
;

598 
ty³s_couÁ
, 
j
;

600 
ty³s_¡rs
 = 
	`sds¥l™Ën
(
commªd_ty³s_¡r
,
	`¡¾’
(commªd_ty³s_¡r),",",1,&
ty³s_couÁ
);

601 ià(
ty³s_¡rs
 =ğ
NULL
) {

603 } ià(
ty³s_couÁ
 <= 0) {

604 
	`sdsä“¥l™»s
(
ty³s_¡rs
,
ty³s_couÁ
);

608 
j
 = 0; j < 
ty³s_couÁ
; j ++) {

609 ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"string")) {

610 
ty³s
 |ğ
TEST_CMD_TYPE_STRING
;

611 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"list")) {

612 
ty³s
 |ğ
TEST_CMD_TYPE_LIST
;

613 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"set")) {

614 
ty³s
 |ğ
TEST_CMD_TYPE_SET
;

615 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"zset")) {

616 
ty³s
 |ğ
TEST_CMD_TYPE_ZSET
;

617 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"hash")) {

618 
ty³s
 |ğ
TEST_CMD_TYPE_HASH
;

619 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"server")) {

620 
ty³s
 |ğ
TEST_CMD_TYPE_SERVER
;

621 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"key")) {

622 
ty³s
 |ğ
TEST_CMD_TYPE_KEY
;

623 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"expire")) {

624 
ty³s
 |ğ
TEST_CMD_TYPE_EXPIRE
;

626 
	`sdsä“¥l™»s
(
ty³s_¡rs
,
ty³s_couÁ
);

631 
	`sdsä“¥l™»s
(
ty³s_¡rs
,
ty³s_couÁ
);

633  
ty³s
;

634 
	}
}

637 
d¬¿y
 *
	$·r£_commªd_li¡
(*
commªd_li¡_¡r
)

639 
d¬¿y
 *
commªds
;

640 
sds
 *
commªd_–em
;

641 
sds
 *
commªd_¡rs
;

642 
commªd_couÁ
, 
j
;

644 
commªd_¡rs
 = 
	`sds¥l™Ën
(
commªd_li¡_¡r
,
	`¡¾’
(commªd_li¡_¡r),",",1,&
commªd_couÁ
);

645 ià(
commªd_¡rs
 =ğ
NULL
) {

647 } ià(
commªd_couÁ
 <= 0) {

648 
	`sdsä“¥l™»s
(
commªd_¡rs
,
commªd_couÁ
);

652 
commªds
 = 
	`d¬¿y_ü—‹
(
commªd_couÁ
, (
sds
));

653 
j
 = 0; j < 
commªd_couÁ
; j ++) {

654 
commªd_–em
 = 
	`d¬¿y_push
(
commªds
);

655 *
commªd_–em
 = 
commªd_¡rs
[
j
];

656 
commªd_¡rs
[
j
] = 
NULL
;

659 
	`sdsä“¥l™»s
(
commªd_¡rs
,
commªd_couÁ
);

661  
commªds
;

662 
	}
}

665 
	$g‘_key_ty³_¡ršg
(
keyty³
)

667 
keyty³
) {

668 
REDIS_STRING
:

671 
REDIS_LIST
:

674 
REDIS_SET
:

677 
REDIS_ZSET
:

680 
REDIS_HASH
:

689 
	}
}

	@tests/vrt_public.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<fú.h
>

5 
	~<”ºo.h
>

6 
	~<sigÇl.h
>

7 
	~<±h»ad.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

13 
	~<d¬¿y.h
>

14 
	~<dlog.h
>

16 
	~<v¹_ut.h
>

17 
	~<v¹_public.h
>

20 #ià
defšed
(
__ATOMIC_RELAXED
)

22 #–ià
defšed
(
HAVE_ATOMIC
)

24 
±h»ad_mu‹x_t
 
	g¡©e_lock”
 = 
PTHREAD_MUTEX_INITIALIZER
;

27 
	#VIRE_TEST_CONFIG_DEFAULT_EXECUTE_FILE
 "¤c/vœe"

	)

29 *
	gexecu‹_fe
 = 
VIRE_TEST_CONFIG_DEFAULT_EXECUTE_FILE
;

31 
sds
 
	gwÜkdœ
 = 
NULL
;

33 
	gvœ•Üt
 = 55556;

35 
	$£t_execu‹_fe
(*
fe
)

37 
execu‹_fe
 = 
fe
;

38 
	}
}

40 
sds
 
	$vœe_cÚf_ü—‹
(*
dœ
, 
pÜt
)

42 
sds
 
cÚf_fe
;

43 
fd
;

44 
sds
 
lše
;

46 
cÚf_fe
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/vœe.cÚf",
dœ
);

48 
fd
 = 
	`İ’
(
cÚf_fe
,
O_WRONLY
|
O_CREAT
|
O_TRUNC
,0644);

49 ià(
fd
 < 0) {

50 
	`‹¡_log_”rÜ
("O³ÀcÚàf% çed: %s", 
cÚf_fe
, 
	`¡»¼Ü
(
”ºo
));

51 
	`sdsä“
(
cÚf_fe
);

52  
NULL
;

55 
lše
 = 
	`sd£m±y
();

57 
lše
 = 
	`sdsÿtfmt
Öše,"pÜˆ%i\n",
pÜt
);

58 
	`wr™e
(
fd
, 
lše
, 
	`sd¦’
(line));

60 
	`sdsş—r
(
lše
);

61 
lše
 = 
	`sdsÿtfmt
(line,"\n");

62 
	`wr™e
(
fd
, 
lše
, 
	`sd¦’
(line));

64 
	`şo£
(
fd
);

65 
	`sdsä“
(
lše
);

66  
cÚf_fe
;

67 
	}
}

69 
vœe_š¡ªû
 *
	$vœe_š¡ªû_ü—‹
(
pÜt
)

71 
vœe_š¡ªû
 *
vi
;

73 
vi
 = 
	`m®loc
((
vœe_š¡ªû
));

74 
vi
->
ho¡
 = 
NULL
;

75 
vi
->
pÜt
 = 0;

76 
vi
->
dœ
 = 
NULL
;

77 
vi
->
cÚf_fe
 = 
NULL
;

78 
vi
->
pid_fe
 = 
NULL
;

79 
vi
->
log_fe
 = 
NULL
;

80 
vi
->
ruÂšg
 = 0;

81 
vi
->
pid
 = -1;

82 
vi
->
ùx
 = 
NULL
;

84 
vi
->
ho¡
 = 
	`sd¢ew
("127.0.0.1");

85 
vi
->
pÜt
 =…ort;

86 
vi
->
dœ
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/%i",
wÜkdœ
,
pÜt
);

88 ià(
	`mkdœ
(
vi
->
dœ
,0755) < 0) {

89 
	`vœe_š¡ªû_de¡roy
(
vi
);

90  
NULL
;

93 
vi
->
cÚf_fe
 = 
	`vœe_cÚf_ü—‹
(vi->
dœ
, 
pÜt
);

94 ià(
vi
->
cÚf_fe
 =ğ
NULL
) {

95 
	`vœe_š¡ªû_de¡roy
(
vi
);

96  
NULL
;

99 
vi
->
pid_fe
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/vœe.pid",vi->
dœ
);

100 
vi
->
log_fe
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),"%s\/vœe.log",vi->
dœ
);

102 
	`‹¡_log_debug
("vœho¡: %s", 
vi
->
ho¡
);

103 
	`‹¡_log_debug
("vœpÜt: %d", 
vi
->
pÜt
);

104 
	`‹¡_log_debug
("vœdœ: %s", 
vi
->
dœ
);

105 
	`‹¡_log_debug
("vœcÚf_fe: %s", 
vi
->
cÚf_fe
);

106 
	`‹¡_log_debug
("vœpid_fe: %s", 
vi
->
pid_fe
);

107 
	`‹¡_log_debug
("vœlog_fe: %s", 
vi
->
log_fe
);

109  
vi
;

110 
	}
}

112 
	$vœe_š¡ªû_de¡roy
(
vœe_š¡ªû
 *
vi
)

114 ià(
vi
->
ruÂšg
) {

115 
	`vœe_£rv”_¡İ
(
vi
);

118 ià(
vi
->
dœ
) {

119 
	`de¡roy_dœ
(
vi
->
dœ
);

120 
	`sdsä“
(
vi
->
dœ
);

123 ià(
vi
->
cÚf_fe
) {

124 
	`sdsä“
(
vi
->
cÚf_fe
);

127 ià(
vi
->
pid_fe
) {

128 
	`sdsä“
(
vi
->
pid_fe
);

131 ià(
vi
->
log_fe
) {

132 
	`sdsä“
(
vi
->
log_fe
);

135 ià(
vi
->
ùx
) {

136 
	`»disF»e
(
vi
->
ùx
);

139 ià(
vi
->
ho¡
) {

140 
	`sdsä“
(
vi
->
ho¡
);

143 
	`ä“
(
vi
);

144 
	}
}

146 
	$vœe_£rv”_run
(
vœe_š¡ªû
 *
vi
)

148 
»t
;

149 
pid_t
 
pid
;

150 
¡©us
;

151 
timev®
 
timeout
 = { 3, 500000 };

153 ià((
pid
 = 
	`fÜk
()) < 0) {

154 
	`‹¡_log_”rÜ
("FÜk‡ chšd faed: %s", 
	`¡»¼Ü
(
”ºo
));

155  
VRT_ERROR
;

156 } ià(
pid
 == 0) {

157 
»t
 = 
	`exeş
(
execu‹_fe
,"vœe","-c",
vi
->
cÚf_fe
,

158 "-p",
vi
->
pid_fe
,"-o",vi->
log_fe
,"-v","8",
NULL
);

159 ià(
»t
 < 0) {

160 
	`‹¡_log_”rÜ
("Exeşhvœ£rv” faed: %s", 
	`¡»¼Ü
(
”ºo
));

161  
VRT_ERROR
;

166 
	`¦“p
(1);

168 
»t
 = 
	`wa™pid
(
pid
,
NULL
,
WNOHANG
);

169 ià(
»t
 != 0) {

170 
	`‹¡_log_debug
("RuÀvœ£rv”ÕÜˆ%dèçed",
vi
->
pÜt
);

171  
VRT_ERROR
;

174 
vi
->
ùx
 = 
	`»disCÚÃùW™hTimeout
(vi->
ho¡
,vi->
pÜt
,
timeout
);

175 ià(
vi
->
ùx
 =ğ
NULL
 || vi->ùx->
”r
) {

176 
	`‹¡_log_”rÜ
("Connecto %s:%d failed: %s",

177 
vi
->
ho¡
, vi->
pÜt
, vi->
ùx
?vi->ùx->
”r¡r
:"out of memory");

178 ià(
vi
->
ùx
) {

179 
	`»disF»e
(
vi
->
ùx
);

180 
vi
->
ùx
 = 
NULL
;

182  
VRT_ERROR
;

185 
vi
->
pid
 = 
	`g‘_pid_äom_»¶y
(vi->
ùx
,vi->
ho¡
,vi->
pÜt
);

186 ià(
vi
->
pid
 < 0) {

187 
	`‹¡_log_”rÜ
("G‘…id from %s:%d„•lyƒ¼Ü", 
vi
->
ho¡
, vi->
pÜt
);

188  
VRT_ERROR
;

189 } ià(
vi
->
pid
 !=…id) {

190 
	`‹¡_log_”rÜ
("G‘ wrÚg…id from %s:%d„•ly", 
vi
->
ho¡
, vi->
pÜt
);

191  
VRT_ERROR
;

194 
	`‹¡_log_debug
("RuÀvœ£rv”ÕÜˆ%dèsucûss",
vi
->
pÜt
);

196 
vi
->
ruÂšg
 = 1;

198  
VRT_OK
;

199 
	}
}

201 
	$vœe_£rv”_¡İ
(
vœe_š¡ªû
 *
vi
)

203 
pid
;

205 ià(!
vi
->
ruÂšg
) ;

207 ià(
vi
->
pid
 > 0) {

208 
pid
 = 
vi
->pid;

209 } ià(
vi
->
pid_fe
) {

210 
fd
;

211 
pid_¡r
[20];

212 
size_t
 
Ä—d
;

213 
fd
 = 
	`İ’
(
vi
->
pid_fe
, 
O_RDONLY
);

214 ià(
fd
 < 0) {

215 
	`‹¡_log_”rÜ
("O³Àpid f% çed", 
vi
->
pid_fe
);

218 
Ä—d
 = 
	`»ad
(
fd
,
pid_¡r
,20);

219 ià(
	`¡ršg2l
(
pid_¡r
,
Ä—d
,&
pid
) == 0) {

220 
	`‹¡_log_”rÜ
("CÚv”ˆpid sŒšg %.* tØlÚg faed",
Ä—d
,
pid_¡r
);

224 
pid
 = 
	`g‘_pid_äom_»¶y
(
vi
->
ùx
, vi->
ho¡
, vi->
pÜt
);

227 ià(
pid
 < 0) {

228 
	`‹¡_log_”rÜ
("Get…id failed");

232 
	`kl
(
pid
,9);

234 
vi
->
ruÂšg
 = 0;

235 
vi
->
pid
 = -1;

236 ià(
vi
->
ùx
) {

237 
	`»disF»e
(
vi
->
ùx
);

238 
vi
->
ùx
 = 
NULL
;

240 
	}
}

242 
	$ü—‹_wÜk_dœ
()

244 
sds
 
dœÇme
;

245 
dœÇme
 = 
	`sdsÿtfmt
(
	`sd£m±y
(), "tmp_‹¡_%I", 
	`v¹_u£c_now
());

246 
wÜkdœ
 = 
	`g‘AbsŞu‹P©h
(
dœÇme
);

247 
	`sdsä“
(
dœÇme
);

249 ià(
	`ü—‹_dœ
(
wÜkdœ
è!ğ
VRT_OK
) {

250 
	`‹¡_log_”rÜ
("C»©wÜkdœ % çed",
wÜkdœ
);

251  
VRT_ERROR
;

254 
	`‹¡_log_debug
("C»©wÜkdœ: %s",
wÜkdœ
);

256  
VRT_OK
;

257 
	}
}

259 
	$de¡roy_wÜk_dœ
()

261 ià(
wÜkdœ
 =ğ
NULL
è 
VRT_OK
;

263 ià(
	`de¡roy_dœ
(
wÜkdœ
è!ğ
VRT_OK
) {

264 
	`‹¡_log_”rÜ
("D–‘thwÜkdœ % çed",
wÜkdœ
);

266 
	`‹¡_log_debug
("D–‘thwÜkdœ: %s",
wÜkdœ
);

269 
	`sdsä“
(
wÜkdœ
);

270 
wÜkdœ
 = 
NULL
;

272  
VRT_OK
;

273 
	}
}

275 
	$g‘_Ãxt_pÜt
()

277 
pÜt
 = 
vœ•Üt
;

278 
vœ•Üt
 += 11;

280  
pÜt
;

281 
	}
}

283 
vœe_š¡ªû
 *
	$¡¬t_Úe_vœe_š¡ªû
()

285 
»t
;

286 
»Œy
 = 0;

287 
vœe_š¡ªû
 *
vi
;

289 
vi
 = 
	`vœe_š¡ªû_ü—‹
(
	`g‘_Ãxt_pÜt
());

290 ià(
vi
 =ğ
NULL
) {

291  
NULL
;

294 
»t
 = 
	`vœe_£rv”_run
(
vi
);

295 
»t
 !ğ
VRT_OK
 && 
»Œy
++ < 10) {

296 
	`vœe_š¡ªû_de¡roy
(
vi
);

297 
vi
 = 
	`vœe_š¡ªû_ü—‹
(
	`g‘_Ãxt_pÜt
());

298 ià(
vi
 =ğ
NULL
) {

299  
NULL
;

301 
»t
 = 
	`vœe_£rv”_run
(
vi
);

304 ià(
»t
 !ğ
VRT_OK
) {

305 
	`vœe_š¡ªû_de¡roy
(
vi
);

306  
NULL
;

309  
vi
;

310 
	}
}

312 
	$show_‹¡_»suÉ
(
»suÉ
,*
‹¡_cÚ‹Á
,*
”rmsg
)

314 ià(
»suÉ
 =ğ
VRT_TEST_OK
) {

315 
	`‹¡_log_out
("[\033[32mOK\033[0m]: %s", 
‹¡_cÚ‹Á
);

316 } ià(
»suÉ
 =ğ
VRT_TEST_ERR
) {

317 
	`‹¡_log_out
("[\033[31mERR\033[0m]: %s, \033[33mç cau£: %s\033[0m", 
‹¡_cÚ‹Á
,

318 (
”rmsg
==
NULL
||
	`¡¾’
(errmsg)==0)?"unknown":errmsg);

320 
	}
}

323 
key_ÿche_¬¿y
 *
	$key_ÿche_¬¿y_ü—‹
(
max_poŞ_size
)

325 
idx
;

326 
key_ÿche_¬¿y
 *
kÿ
;

329 ià(
max_poŞ_size
 < 10è 
NULL
;

331 
kÿ
 = 
	`m®loc
((*kca));

332 ià(
kÿ
 =ğ
NULL
)  NULL;

334 
kÿ
->
ÿched_keys_couÁ
 = 0;

335 
kÿ
->
ckeys_wr™e_idx
 = 0;

336 
kÿ
->
max_poŞ_size
 = max_pool_size;

337 
kÿ
->
ckeys
 = 
NULL
;

338 
	`±h»ad_mu‹x_š™
(&
kÿ
->
pmu‹x
,
NULL
);

340 
kÿ
->
ckeys
 = 
	`m®loc
(
max_poŞ_size
*(
sds
));

341 
idx
 = 0; idx < 
max_poŞ_size
; idx ++) {

342 
kÿ
->
ckeys
[
idx
] = 
	`sd£m±y
();

345  
kÿ
;

346 
	}
}

348 
	$key_ÿche_¬¿y_de¡roy
(
key_ÿche_¬¿y
 *
kÿ
)

350 
idx
;

352 ià(
kÿ
 =ğ
NULL
) ;

354 
	`±h»ad_mu‹x_de¡roy
(&
kÿ
->
pmu‹x
);

356 ià(
kÿ
->
ckeys
) {

357 
idx
 = 0; idx < 
kÿ
->
max_poŞ_size
; idx ++) {

358 
	`sdsä“
(
kÿ
->
ckeys
[
idx
]);

360 
	`ä“
(
kÿ
->
ckeys
);

363 
	`ä“
(
kÿ
);

364 
	}
}

366 
	$key_ÿche_¬¿y_šput
(
key_ÿche_¬¿y
 *
kÿ
, *
key
, 
size_t
 
keyËn
)

368 ià(
kÿ
 =ğ
NULL
 || 
key
 =ğNULL || 
keyËn
 =ğ0è 
VRT_ERROR
;

370 
	`±h»ad_mu‹x_lock
(&
kÿ
->
pmu‹x
);

371 
kÿ
->
ckeys
[kÿ->
ckeys_wr™e_idx
]=
	`sdsıyËn
(kÿ->ckeys[kÿ->ckeys_wr™e_idx],
key
,
keyËn
);

372 
kÿ
->
ckeys_wr™e_idx
++;

373 ià(
kÿ
->
ckeys_wr™e_idx
 >ğkÿ->
max_poŞ_size
) {

374 
kÿ
->
ckeys_wr™e_idx
 = 0;

377 ià(
kÿ
->
ÿched_keys_couÁ
 < kÿ->
max_poŞ_size
) {

378 
kÿ
->
ÿched_keys_couÁ
++;

380 
	`±h»ad_mu‹x_uÆock
(&
kÿ
->
pmu‹x
);

382  
VRT_OK
;

383 
	}
}

385 
sds
 
	$key_ÿche_¬¿y_¿ndom
(
key_ÿche_¬¿y
 *
kÿ
)

387 
idx
, 
¿ndomv®
;

388 
sds
 
key
;

390 ià(
kÿ
 =ğ
NULL
) {

391  
NULL
;

394 
¿ndomv®
 = ()
	`¿nd
();

396 
	`±h»ad_mu‹x_lock
(&
kÿ
->
pmu‹x
);

397 ià(
kÿ
->
ÿched_keys_couÁ
 == 0) {

398 
	`±h»ad_mu‹x_uÆock
(&
kÿ
->
pmu‹x
);

399  
NULL
;

402 
idx
 = 
¿ndomv®
%()
kÿ
->
ÿched_keys_couÁ
;

404 
key
 = 
	`sdsdup
(
kÿ
->
ckeys
[
idx
]);

405 
	`±h»ad_mu‹x_uÆock
(&
kÿ
->
pmu‹x
);

407  
key
;

408 
	}
}

412 
	$g‘_lÚglÚg_äom_šfo_»¶y
(
»disR•ly
 *
»¶y
, *
Çme
)

414 
sds
 *
lšes
;

415 
size_t
 
lše_Ën
, 
Ën
;

416 
couÁ
, 
j
;

417 
v®ue
 = -1;

419 
Ën
 = 
	`¡¾’
(
Çme
);

421 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

422 
	`‹¡_log_”rÜ
("Reply for 'info' command from vireype %d isƒrror",

423 
»¶y
->
ty³
);

427 
lšes
 = 
	`sds¥l™Ën
(
»¶y
->
¡r
,»¶y->
Ën
,"\r\n",2,&
couÁ
);

428 ià(
lšes
 =ğ
NULL
) {

429 
	`‹¡_log_”rÜ
("Reply for 'info server' command from vire isƒrror");

433 
j
 = 0; j < 
couÁ
; j ++) {

434 
lše_Ën
 = 
	`sd¦’
(
lšes
[
j
]);

435 ià(
lše_Ën
 > 
Ën
+1 && !
	`¡ºcmp
(
Çme
, 
lšes
[
j
],†en)) {

436 ià(
	`¡ršg2Î
(
lšes
[
j
]+
Ën
+1,
lše_Ën
-Ën-1,&
v®ue
) == 0) {

437 
	`‹¡_log_”rÜ
("Convert…id string %.*so†ong failed",

438 
lše_Ën
-
Ën
-1,
lšes
[
j
]+len+1);

439 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

446 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

447  
v®ue
;

448 
	}
}

450 
»disR•ly
 *
	$¡—l_hœedis_»di¤•ly
(
»disR•ly
 *
r
)

452 
»disR•ly
 *
»¶y
;

454 
»¶y
 = 
	`ÿÎoc
(1,(*reply));

455 ià(
»¶y
 =ğ
NULL
) {

456  
NULL
;

459 
»¶y
->
ty³
 = 
r
->type;

460 
»¶y
->
š‹g”
 = 
r
->integer;

461 
»¶y
->
Ën
 = 
r
->len;

462 
»¶y
->
¡r
 = 
r
->str;

463 
»¶y
->
–em’ts
 = 
r
->elements;

464 
»¶y
->
–em’t
 = 
r
->element;

466 
r
->
Ën
 = 0;

467 
r
->
¡r
 = 
NULL
;

468 
r
->
–em’ts
 = 0;

469 
r
->
–em’t
 = 
NULL
;

471  
»¶y
;

472 
	}
}

474 
	$check_two_»¶ys_if_§me
(
»disR•ly
 *
»¶y1
,„edisR•ly *
»¶y2
)

476 ià(
»¶y1
 =ğ
NULL
 || 
»¶y2
 == NULL) {

480 ià(
»¶y1
->
ty³
 !ğ
»¶y2
->type) {

484 ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_STRING
 ||

485 
»¶y1
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

486 
»¶y1
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

487 ià(
»¶y1
->
Ën
 !ğ
»¶y2
->len) {

488  
»¶y1
->
Ën
-
»¶y2
->len;

491  
	`memcmp
(
»¶y1
->
¡r
, 
»¶y2
->¡r,„•ly1->
Ën
);

492 } ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_ARRAY
) {

493 
size_t
 
j
;

494 ià(
»¶y1
->
–em’ts
 !ğ
»¶y2
->elements) {

495  (
»¶y1
->
–em’ts
-
»¶y2
->elements);

498 
j
 = 0; j < 
»¶y1
->
–em’ts
; j ++) {

499 
»t
 = 
	`check_two_»¶ys_if_§me
(
»¶y1
->
–em’t
[
j
], 
»¶y2
->element[j]);

500 ià(
»t
 != 0) „et;

503 } ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

504  (
»¶y1
->
š‹g”
-
»¶y2
->integer);

505 } ià(
»¶y1
->
ty³
 =ğ
REDIS_REPLY_NIL
) {

508 
	`‹¡_log_”rÜ
("»¶yy³ %d i ”rÜ", 
»¶y1
->
ty³
);

512 
	}
}

514 
	ssÜt_un™
 {

515 
size_t
 
	mnf›ld
;

516 **
	mf›lds
;

517 
	midx_cmp
;

518 (*
	mfcmp
)(const *,const *);

521 
	$–em’t_cmp_muÉi_¡•
(cÚ¡ *
–e1
,cÚ¡ *
–e2
)

523 
sÜt_un™
 *
su1
 = (sÜt_un™ *)
–e1
, *
su2
 = (sÜt_un™ *)
–e2
;

525 
	`ASSERT
(
su1
->
fcmp
 =ğ
su2
->fcmp);

526 
	`ASSERT
(
su1
->
nf›ld
 =ğ
su2
->nfield);

527 
	`ASSERT
(
su1
->
idx_cmp
 =ğ
su2
->idx_cmp);

528 
	`ASSERT
(
su1
->
idx_cmp
 < su1->
nf›ld
);

530  
su1
->
	`fcmp
(&(su1->
f›lds
[su1->
idx_cmp
]),&(
su2
->fields[su2->idx_cmp]));

531 
	}
}

534 
	$sÜt_¬¿y_by_¡•
(**
–em’t
, 
size_t
 
–em’ts
,

535 
¡•
, 
idx_cmp
, (*
fcmp
)(const *,const *))

537 
sÜt_un™
 *
sus
;

538 
size_t
 
couÁ
, 
j
, 
k
;

540 ià(
–em’ts
 <= 1)

541  
VRT_OK
;

543 ià(
¡•
 <= 0)

544  
VRT_ERROR
;

546 ià(
¡•
 == 1) {

547 
	`qsÜt
(
–em’t
, 
–em’ts
, (*), 
fcmp
);

548  
VRT_OK
;

551 ià(
–em’ts
%
¡•
 != 0)

552  
VRT_ERROR
;

554 
couÁ
 = 
–em’ts
/
¡•
;

555 ià(
couÁ
 == 0)

556  
VRT_ERROR
;

557 
sus
 = 
	`ÿÎoc
(
couÁ
,(
sÜt_un™
));

558 
j
 = 0; j < 
couÁ
; j ++) {

559 
sus
[
j
].
nf›ld
 = 
¡•
;

560 
sus
[
j
].
idx_cmp
 = idx_cmp;

561 
sus
[
j
].
fcmp
 = fcmp;

562 
sus
[
j
].
f›lds
 = 
	`m®loc
(
¡•
*(*));

563 
k
 = 0; k < 
¡•
; k ++) {

564 
sus
[
j
].
f›lds
[
k
] = 
–em’t
[j*
¡•
+k];

568 
	`qsÜt
(
sus
, 
couÁ
, (
sÜt_un™
), 
–em’t_cmp_muÉi_¡•
);

570 
j
 = 0; j < 
couÁ
; j ++) {

571 
k
 = 0; k < 
¡•
; k ++) {

572 
–em’t
[
j
*
¡•
+
k
] = 
sus
[j].
f›lds
[k];

574 
	`ä“
(
sus
[
j
].
f›lds
);

576 
	`ä“
(
sus
);

577  
VRT_OK
;

578 
	}
}

581 
	$»¶y_¡ršg_bš¬y_com·»
(cÚ¡ *
r1
,cÚ¡ *
r2
)

583 
»disR•ly
 *
»¶y1
 = *ÔedisR•ly **)
r1
, *
»¶y2
 = *ÔedisR•ly **)
r2
;

584 
mšËn
;

585 
cmp
;

587 
mšËn
 = (
»¶y1
->
Ën
 < 
»¶y2
->len) ?„eply1->len:reply2->len;

588 
cmp
 = 
	`memcmp
(
»¶y1
->
¡r
,
»¶y2
->¡r,
mšËn
);

589 ià(
cmp
 =ğ0è 
»¶y1
->
Ën
 - 
»¶y2
->len;

590  
cmp
;

591 
	}
}

594 
	$·r£_commªd_ty³s
(*
commªd_ty³s_¡r
)

596 
ty³s
 = 0;

597 
sds
 *
ty³s_¡rs
;

598 
ty³s_couÁ
, 
j
;

600 
ty³s_¡rs
 = 
	`sds¥l™Ën
(
commªd_ty³s_¡r
,
	`¡¾’
(commªd_ty³s_¡r),",",1,&
ty³s_couÁ
);

601 ià(
ty³s_¡rs
 =ğ
NULL
) {

603 } ià(
ty³s_couÁ
 <= 0) {

604 
	`sdsä“¥l™»s
(
ty³s_¡rs
,
ty³s_couÁ
);

608 
j
 = 0; j < 
ty³s_couÁ
; j ++) {

609 ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"string")) {

610 
ty³s
 |ğ
TEST_CMD_TYPE_STRING
;

611 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"list")) {

612 
ty³s
 |ğ
TEST_CMD_TYPE_LIST
;

613 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"set")) {

614 
ty³s
 |ğ
TEST_CMD_TYPE_SET
;

615 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"zset")) {

616 
ty³s
 |ğ
TEST_CMD_TYPE_ZSET
;

617 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"hash")) {

618 
ty³s
 |ğ
TEST_CMD_TYPE_HASH
;

619 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"server")) {

620 
ty³s
 |ğ
TEST_CMD_TYPE_SERVER
;

621 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"key")) {

622 
ty³s
 |ğ
TEST_CMD_TYPE_KEY
;

623 } ià(!
	`¡rÿ£cmp
(
ty³s_¡rs
[
j
],"expire")) {

624 
ty³s
 |ğ
TEST_CMD_TYPE_EXPIRE
;

626 
	`sdsä“¥l™»s
(
ty³s_¡rs
,
ty³s_couÁ
);

631 
	`sdsä“¥l™»s
(
ty³s_¡rs
,
ty³s_couÁ
);

633  
ty³s
;

634 
	}
}

637 
d¬¿y
 *
	$·r£_commªd_li¡
(*
commªd_li¡_¡r
)

639 
d¬¿y
 *
commªds
;

640 
sds
 *
commªd_–em
;

641 
sds
 *
commªd_¡rs
;

642 
commªd_couÁ
, 
j
;

644 
commªd_¡rs
 = 
	`sds¥l™Ën
(
commªd_li¡_¡r
,
	`¡¾’
(commªd_li¡_¡r),",",1,&
commªd_couÁ
);

645 ià(
commªd_¡rs
 =ğ
NULL
) {

647 } ià(
commªd_couÁ
 <= 0) {

648 
	`sdsä“¥l™»s
(
commªd_¡rs
,
commªd_couÁ
);

652 
commªds
 = 
	`d¬¿y_ü—‹
(
commªd_couÁ
, (
sds
));

653 
j
 = 0; j < 
commªd_couÁ
; j ++) {

654 
commªd_–em
 = 
	`d¬¿y_push
(
commªds
);

655 *
commªd_–em
 = 
commªd_¡rs
[
j
];

656 
commªd_¡rs
[
j
] = 
NULL
;

659 
	`sdsä“¥l™»s
(
commªd_¡rs
,
commªd_couÁ
);

661  
commªds
;

662 
	}
}

665 
	$g‘_key_ty³_¡ršg
(
keyty³
)

667 
keyty³
) {

668 
REDIS_STRING
:

671 
REDIS_LIST
:

674 
REDIS_SET
:

677 
REDIS_ZSET
:

680 
REDIS_HASH
:

689 
	}
}

	@tests/vrt_public.h

1 #iâdeà
_VRT_PUBLIC_H_


2 
	#_VRT_PUBLIC_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	~<d¥ecŸlcÚfig.h
>

10 
	~<uni¡d.h
>

12 
	~<hœedis.h
>

14 
	gd¬¿y
;

15 
	gkey_ÿche_poŞ
;

17 
	#VRT_TEST_OK
 0

	)

18 
	#VRT_TEST_ERR
 1

	)

20 
	#TEST_CMD_TYPE_STRING
 (1<<0)

	)

21 
	#TEST_CMD_TYPE_LIST
 (1<<1)

	)

22 
	#TEST_CMD_TYPE_SET
 (1<<2)

	)

23 
	#TEST_CMD_TYPE_ZSET
 (1<<3)

	)

24 
	#TEST_CMD_TYPE_HASH
 (1<<4)

	)

25 
	#TEST_CMD_TYPE_SERVER
 (1<<5)

	)

26 
	#TEST_CMD_TYPE_KEY
 (1<<6)

	)

27 
	#TEST_CMD_TYPE_EXPIRE
 (1<<7)

	)

30 
	#REDIS_STRING
 0

	)

31 
	#REDIS_LIST
 1

	)

32 
	#REDIS_SET
 2

	)

33 
	#REDIS_ZSET
 3

	)

34 
	#REDIS_HASH
 4

	)

38 #ià
defšed
(
__ATOMIC_RELAXED
)

39 
	#upd©e_¡©e_add
(
_v®ue
, 
_n
è
	`__©omic_add_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

40 
	#upd©e_¡©e_sub
(
_v®ue
, 
_n
è
	`__©omic_sub_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

41 
	#upd©e_¡©e_£t
(
_v®ue
, 
_n
è
	`__©omic_¡Üe_n
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

42 
	#upd©e_¡©e_g‘
(
_v®ue
, 
_v
) do { \

43 
	`__©omic_lßd
(&
_v®ue
, 
_v
, 
__ATOMIC_RELAXED
); \

44 } 0)

	)

46 
	#TEST_STATE_LOCK_TYPE
 "__ATOMIC_RELAXED"

	)

48 #–ià
defšed
(
HAVE_ATOMIC
)

49 
	#upd©e_¡©e_add
(
_v®ue
, 
_n
è
	`__sync_add_ªd_ãtch
(&_v®ue, (_n))

	)

50 
	#upd©e_¡©e_sub
(
_v®ue
, 
_n
è
	`__sync_sub_ªd_ãtch
(&_v®ue, (_n))

	)

51 
	#upd©e_¡©e_£t
(
_v®ue
, 
_n
è
	`__sync_lock_‹¡_ªd_£t
(&_v®ue, (_n))

	)

52 
	#upd©e_¡©e_g‘
(
_v®ue
, 
_v
) do { \

53 (*
_v
èğ
	`__sync_add_ªd_ãtch
(&
_v®ue
, 0); \

54 } 0)

	)

56 
	#TEST_STATE_LOCK_TYPE
 "HAVE_ATOMIC"

	)

58 
±h»ad_mu‹x_t
 
¡©e_lock”
;

60 
	#upd©e_¡©e_add
(
_v®ue
, 
_n
) do { \

61 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

62 
_v®ue
 +ğ(
_n
); \

63 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

64 } 0)

	)

66 
	#upd©e_¡©e_sub
(
_v®ue
, 
_n
) do { \

67 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

68 
_v®ue
 -ğ(
_n
); \

69 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

70 } 0)

	)

72 
	#upd©e_¡©e_£t
(
_v®ue
, 
_n
) do { \

73 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

74 
_v®ue
 = (
_n
); \

75 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

76 } 0)

	)

78 
	#upd©e_¡©e_g‘
(
_v®ue
, 
_v
) do { \

79 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

80 (*
_v
èğ
_v®ue
; \

81 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

82 } 0)

	)

84 
	#TEST_STATE_LOCK_TYPE
 "±h»ad_mu‹x_lock"

	)

87 
	svœe_š¡ªû
 {

88 
sds
 
	mho¡
;

89 
	mpÜt
;

91 
sds
 
	mdœ
;

92 
sds
 
	mcÚf_fe
;

93 
sds
 
	mpid_fe
;

94 
sds
 
	mlog_fe
;

96 
	mruÂšg
;

97 
	mpid
;

98 
»disCÚ‹xt
 *
	mùx
;

99 } 
	tvœe_š¡ªû
;

101 
£t_execu‹_fe
(*
fe
);

103 
vœe_š¡ªû
 *
vœe_š¡ªû_ü—‹
(
pÜt
);

104 
vœe_š¡ªû_de¡roy
(
vœe_š¡ªû
 *
vi
);

106 
vœe_£rv”_run
(
vœe_š¡ªû
 *
vi
);

107 
vœe_£rv”_¡İ
(
vœe_š¡ªû
 *
vi
);

109 
ü—‹_wÜk_dœ
();

110 
de¡roy_wÜk_dœ
();

112 
vœe_š¡ªû
 *
¡¬t_Úe_vœe_š¡ªû
();

114 
show_‹¡_»suÉ
(
»suÉ
,*
‹¡_cÚ‹Á
,*
”rmsg
);

116 
	skey_ÿche_¬¿y
 {

117 
	mÿched_keys_couÁ
;

118 
	mckeys_wr™e_idx
;

119 
	mmax_poŞ_size
;

120 
sds
 *
	mckeys
;

121 
±h»ad_mu‹x_t
 
	mpmu‹x
;

122 } 
	tkey_ÿche_¬¿y
;

124 
key_ÿche_¬¿y
 *
key_ÿche_¬¿y_ü—‹
(
max_poŞ_size
);

125 
key_ÿche_¬¿y_de¡roy
(
key_ÿche_¬¿y
 *
kÿ
);

126 
key_ÿche_¬¿y_šput
(
key_ÿche_¬¿y
 *
kÿ
, *
key
, 
size_t
 
keyËn
);

127 
sds
 
key_ÿche_¬¿y_¿ndom
(
key_ÿche_¬¿y
 *
kÿ
);

129 
g‘_lÚglÚg_äom_šfo_»¶y
(
»disR•ly
 *
»¶y
, *
Çme
);

131 
»disR•ly
 *
¡—l_hœedis_»di¤•ly
ÔedisR•ly *
r
);

132 
check_two_»¶ys_if_§me
(
»disR•ly
 *
»¶y1
,„edisR•ly *
»¶y2
);

133 
sÜt_¬¿y_by_¡•
(**
–em’t
, 
size_t
 
–em’ts
, 
¡•
, 
idx_cmp
, (*
fcmp
)(const *,const *));

134 
	`»¶y_¡ršg_bš¬y_com·»
(cÚ¡ *
r1
,cÚ¡ *
r2
);

136 
	`·r£_commªd_ty³s
(*
commªd_ty³s_¡r
);

137 
d¬¿y
 *
	`·r£_commªd_li¡
(*
commªd_li¡_¡r
);

139 *
	`g‘_key_ty³_¡ršg
(
keyty³
);

	@tests/vrt_public.h

1 #iâdeà
_VRT_PUBLIC_H_


2 
	#_VRT_PUBLIC_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 
	~<d¥ecŸlcÚfig.h
>

10 
	~<uni¡d.h
>

12 
	~<hœedis.h
>

14 
	gd¬¿y
;

15 
	gkey_ÿche_poŞ
;

17 
	#VRT_TEST_OK
 0

	)

18 
	#VRT_TEST_ERR
 1

	)

20 
	#TEST_CMD_TYPE_STRING
 (1<<0)

	)

21 
	#TEST_CMD_TYPE_LIST
 (1<<1)

	)

22 
	#TEST_CMD_TYPE_SET
 (1<<2)

	)

23 
	#TEST_CMD_TYPE_ZSET
 (1<<3)

	)

24 
	#TEST_CMD_TYPE_HASH
 (1<<4)

	)

25 
	#TEST_CMD_TYPE_SERVER
 (1<<5)

	)

26 
	#TEST_CMD_TYPE_KEY
 (1<<6)

	)

27 
	#TEST_CMD_TYPE_EXPIRE
 (1<<7)

	)

30 
	#REDIS_STRING
 0

	)

31 
	#REDIS_LIST
 1

	)

32 
	#REDIS_SET
 2

	)

33 
	#REDIS_ZSET
 3

	)

34 
	#REDIS_HASH
 4

	)

38 #ià
defšed
(
__ATOMIC_RELAXED
)

39 
	#upd©e_¡©e_add
(
_v®ue
, 
_n
è
	`__©omic_add_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

40 
	#upd©e_¡©e_sub
(
_v®ue
, 
_n
è
	`__©omic_sub_ãtch
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

41 
	#upd©e_¡©e_£t
(
_v®ue
, 
_n
è
	`__©omic_¡Üe_n
(&_v®ue, (_n), 
__ATOMIC_RELAXED
)

	)

42 
	#upd©e_¡©e_g‘
(
_v®ue
, 
_v
) do { \

43 
	`__©omic_lßd
(&
_v®ue
, 
_v
, 
__ATOMIC_RELAXED
); \

44 } 0)

	)

46 
	#TEST_STATE_LOCK_TYPE
 "__ATOMIC_RELAXED"

	)

48 #–ià
defšed
(
HAVE_ATOMIC
)

49 
	#upd©e_¡©e_add
(
_v®ue
, 
_n
è
	`__sync_add_ªd_ãtch
(&_v®ue, (_n))

	)

50 
	#upd©e_¡©e_sub
(
_v®ue
, 
_n
è
	`__sync_sub_ªd_ãtch
(&_v®ue, (_n))

	)

51 
	#upd©e_¡©e_£t
(
_v®ue
, 
_n
è
	`__sync_lock_‹¡_ªd_£t
(&_v®ue, (_n))

	)

52 
	#upd©e_¡©e_g‘
(
_v®ue
, 
_v
) do { \

53 (*
_v
èğ
	`__sync_add_ªd_ãtch
(&
_v®ue
, 0); \

54 } 0)

	)

56 
	#TEST_STATE_LOCK_TYPE
 "HAVE_ATOMIC"

	)

58 
±h»ad_mu‹x_t
 
¡©e_lock”
;

60 
	#upd©e_¡©e_add
(
_v®ue
, 
_n
) do { \

61 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

62 
_v®ue
 +ğ(
_n
); \

63 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

64 } 0)

	)

66 
	#upd©e_¡©e_sub
(
_v®ue
, 
_n
) do { \

67 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

68 
_v®ue
 -ğ(
_n
); \

69 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

70 } 0)

	)

72 
	#upd©e_¡©e_£t
(
_v®ue
, 
_n
) do { \

73 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

74 
_v®ue
 = (
_n
); \

75 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

76 } 0)

	)

78 
	#upd©e_¡©e_g‘
(
_v®ue
, 
_v
) do { \

79 
	`±h»ad_mu‹x_lock
(&
¡©e_lock”
); \

80 (*
_v
èğ
_v®ue
; \

81 
	`±h»ad_mu‹x_uÆock
(&
¡©e_lock”
); \

82 } 0)

	)

84 
	#TEST_STATE_LOCK_TYPE
 "±h»ad_mu‹x_lock"

	)

87 
	svœe_š¡ªû
 {

88 
sds
 
	mho¡
;

89 
	mpÜt
;

91 
sds
 
	mdœ
;

92 
sds
 
	mcÚf_fe
;

93 
sds
 
	mpid_fe
;

94 
sds
 
	mlog_fe
;

96 
	mruÂšg
;

97 
	mpid
;

98 
»disCÚ‹xt
 *
	mùx
;

99 } 
	tvœe_š¡ªû
;

101 
£t_execu‹_fe
(*
fe
);

103 
vœe_š¡ªû
 *
vœe_š¡ªû_ü—‹
(
pÜt
);

104 
vœe_š¡ªû_de¡roy
(
vœe_š¡ªû
 *
vi
);

106 
vœe_£rv”_run
(
vœe_š¡ªû
 *
vi
);

107 
vœe_£rv”_¡İ
(
vœe_š¡ªû
 *
vi
);

109 
ü—‹_wÜk_dœ
();

110 
de¡roy_wÜk_dœ
();

112 
vœe_š¡ªû
 *
¡¬t_Úe_vœe_š¡ªû
();

114 
show_‹¡_»suÉ
(
»suÉ
,*
‹¡_cÚ‹Á
,*
”rmsg
);

116 
	skey_ÿche_¬¿y
 {

117 
	mÿched_keys_couÁ
;

118 
	mckeys_wr™e_idx
;

119 
	mmax_poŞ_size
;

120 
sds
 *
	mckeys
;

121 
±h»ad_mu‹x_t
 
	mpmu‹x
;

122 } 
	tkey_ÿche_¬¿y
;

124 
key_ÿche_¬¿y
 *
key_ÿche_¬¿y_ü—‹
(
max_poŞ_size
);

125 
key_ÿche_¬¿y_de¡roy
(
key_ÿche_¬¿y
 *
kÿ
);

126 
key_ÿche_¬¿y_šput
(
key_ÿche_¬¿y
 *
kÿ
, *
key
, 
size_t
 
keyËn
);

127 
sds
 
key_ÿche_¬¿y_¿ndom
(
key_ÿche_¬¿y
 *
kÿ
);

129 
g‘_lÚglÚg_äom_šfo_»¶y
(
»disR•ly
 *
»¶y
, *
Çme
);

131 
»disR•ly
 *
¡—l_hœedis_»di¤•ly
ÔedisR•ly *
r
);

132 
check_two_»¶ys_if_§me
(
»disR•ly
 *
»¶y1
,„edisR•ly *
»¶y2
);

133 
sÜt_¬¿y_by_¡•
(**
–em’t
, 
size_t
 
–em’ts
, 
¡•
, 
idx_cmp
, (*
fcmp
)(const *,const *));

134 
	`»¶y_¡ršg_bš¬y_com·»
(cÚ¡ *
r1
,cÚ¡ *
r2
);

136 
	`·r£_commªd_ty³s
(*
commªd_ty³s_¡r
);

137 
d¬¿y
 *
	`·r£_commªd_li¡
(*
commªd_li¡_¡r
);

139 *
	`g‘_key_ty³_¡ršg
(
keyty³
);

	@tests/vrt_simple.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

13 
	~<v¹_ut.h
>

14 
	~<v¹_public.h
>

15 
	~<v¹_sim¶e.h
>

17 
	#ERRMSG_MAX_LEN
 
LOG_MAX_LEN
-100

	)

18 
	g”rmsg
[
ERRMSG_MAX_LEN
];

20 
	$sim¶e_‹¡_cmd_g‘_£t
(
vœe_š¡ªû
 *
vi
)

22 *
key
 = "test_cmd_get_set-key";

23 *
v®ue
 = "test_cmd_get_set-value";

24 *
MESSAGE
 = "GET/SET simpleest";

25 
»disR•ly
 * 
»¶y
 = 
NULL
;

27 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, 
v®ue
);

28 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

29 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

30 
”rÜ
;

32 
	`ä“R•lyObjeù
(
»¶y
);

34 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

35 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

36 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

37 
”rÜ
;

39 
	`ä“R•lyObjeù
(
»¶y
);

40 
»¶y
 = 
NULL
;

42 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

46 
”rÜ
:

48 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

50 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

51 
”rmsg
[0] = '\0';

54 
	}
}

56 
	$sim¶e_‹¡_cmd_£Šx
(
vœe_š¡ªû
 *
vi
)

58 *
key
 = "test_cmd_setnx-key";

59 *
v®ue
 = "test_cmd_setnx-value";

60 *
MESSAGE
 = "SETNX simpleest";

61 
»disR•ly
 * 
»¶y
 = 
NULL
;

63 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

64 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

65 
”rÜ
;

67 
	`ä“R•lyObjeù
(
»¶y
);

69 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£Šx % %s", 
key
, 
v®ue
);

70 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

71 
»¶y
->
š‹g”
 != 1) {

72 
”rÜ
;

74 
	`ä“R•lyObjeù
(
»¶y
);

76 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

77 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

78 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

79 
”rÜ
;

81 
	`ä“R•lyObjeù
(
»¶y
);

83 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£Šx % %s", 
key
, 
v®ue
);

84 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

85 
»¶y
->
š‹g”
 != 0) {

86 
”rÜ
;

88 
	`ä“R•lyObjeù
(
»¶y
);

90 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

94 
”rÜ
:

96 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

98 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

99 
”rmsg
[0] = '\0';

102 
	}
}

104 
	$sim¶e_‹¡_cmd_£‹x
(
vœe_š¡ªû
 *
vi
)

106 *
key
 = "test_cmd_setex-key";

107 *
v®ue
 = "test_cmd_setex-value";

108 
£cÚds
 = 100;

109 *
MESSAGE
 = "SETEX simpleest";

110 
»disR•ly
 * 
»¶y
 = 
NULL
;

112 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£‹x % %Îd %s", 
key
, 
£cÚds
, 
v®ue
);

113 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

114 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

115 
”rÜ
;

117 
	`ä“R•lyObjeù
(
»¶y
);

119 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

120 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

121 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

122 
”rÜ
;

124 
	`ä“R•lyObjeù
(
»¶y
);

126 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "‰È%s", 
key
);

127 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

128 
»¶y
->
š‹g”
 > 
£cÚds
 ||„eply->integer < seconds - 2) {

129 
”rÜ
;

131 
	`ä“R•lyObjeù
(
»¶y
);

133 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

137 
”rÜ
:

139 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

141 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

142 
”rmsg
[0] = '\0';

145 
	}
}

147 
	$sim¶e_‹¡_cmd_p£‹x
(
vœe_š¡ªû
 *
vi
)

149 *
key
 = "test_cmd_psetex-key";

150 *
v®ue
 = "test_cmd_psetex-value";

151 
mli£cÚds
 = 100000;

152 *
MESSAGE
 = "PSETEX simpleest";

153 
»disR•ly
 * 
»¶y
 = 
NULL
;

155 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "p£‹x % %Îd %s", 
key
, 
mli£cÚds
, 
v®ue
);

156 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

157 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

158 
”rÜ
;

160 
	`ä“R•lyObjeù
(
»¶y
);

162 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

163 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

164 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

165 
”rÜ
;

167 
	`ä“R•lyObjeù
(
»¶y
);

169 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "± %s", 
key
);

170 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

171 
»¶y
->
š‹g”
 > 
mli£cÚds
 ||„eply->integer < milliseconds - 2000) {

172 
”rÜ
;

174 
	`ä“R•lyObjeù
(
»¶y
);

176 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

180 
”rÜ
:

182 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

184 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

185 
”rmsg
[0] = '\0';

188 
	}
}

190 
	$sim¶e_‹¡_cmd_šü
(
vœe_š¡ªû
 *
vi
)

192 *
key
 = "test_cmd_incr-key";

193 
n
 = 0, 
šü_times
 = 100;

194 *
MESSAGE
 = "INCR simpleest";

195 
»disR•ly
 * 
»¶y
 = 
NULL
;

197 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

198 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

199 
”rÜ
;

201 
	`ä“R•lyObjeù
(
»¶y
);

203 
n
 < 
šü_times
) {

204 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šü %s", 
key
);

205 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

206 
»¶y
->
š‹g”
 !ğ
n
+1) {

207 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "šü %Îdime ”rÜ", 
n
+1);

208 
”rÜ
;

210 
	`ä“R•lyObjeù
(
»¶y
);

212 
n
 ++;

215 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

216 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

217 
”rÜ
;

219 
v®ue
;

220 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
è|| v®u!ğ
šü_times
) {

221 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incro %lldƒrror, %s in fact",

222 
šü_times
, 
»¶y
->
¡r
);

223 
”rÜ
;

226 
	`ä“R•lyObjeù
(
»¶y
);

228 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

229 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

230 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

231 
”rÜ
;

233 
	`ä“R•lyObjeù
(
»¶y
);

235 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šü %s", 
key
);

236 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

237 
”rÜ
;

239 
	`ä“R•lyObjeù
(
»¶y
);

241 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

245 
”rÜ
:

247 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

249 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

250 
”rmsg
[0] = '\0';

253 
	}
}

255 
	$sim¶e_‹¡_cmd_deü
(
vœe_š¡ªû
 *
vi
)

257 *
key
 = "test_cmd_decr-key";

258 
n
 = 0, 
deü_times
 = 100;

259 *
MESSAGE
 = "DECR simpleest";

260 
»disR•ly
 * 
»¶y
 = 
NULL
;

262 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

263 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

264 
”rÜ
;

266 
	`ä“R•lyObjeù
(
»¶y
);

268 
n
 < 
deü_times
) {

269 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "deü %s", 
key
);

270 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

271 
»¶y
->
š‹g”
 + 
n
 != -1) {

272 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "šü %Îdime ”rÜ", 
n
+1);

273 
”rÜ
;

275 
	`ä“R•lyObjeù
(
»¶y
);

277 
n
 ++;

280 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

281 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

282 
”rÜ
;

284 
v®ue
;

285 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
è|| v®u+ 
deü_times
 != 0) {

286 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "decro -%lldƒrror, %s in fact",

287 
deü_times
, 
»¶y
->
¡r
);

288 
”rÜ
;

291 
	`ä“R•lyObjeù
(
»¶y
);

293 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

294 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

295 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

296 
”rÜ
;

298 
	`ä“R•lyObjeù
(
»¶y
);

300 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šü %s", 
key
);

301 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

302 
”rÜ
;

304 
	`ä“R•lyObjeù
(
»¶y
);

306 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

310 
”rÜ
:

312 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

314 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

315 
”rmsg
[0] = '\0';

318 
	}
}

320 
	$sim¶e_‹¡_cmd_šüby
(
vœe_š¡ªû
 *
vi
)

322 *
key
 = "test_cmd_incrby-key";

323 
n
 = 0, 
šüby_times
 = 100, 
šüby_¡•
 = 3;

324 *
MESSAGE
 = "INCRBY simpleest";

325 
»disR•ly
 * 
»¶y
 = 
NULL
;

327 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

328 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

329 
”rÜ
;

331 
	`ä“R•lyObjeù
(
»¶y
);

333 
n
 < 
šüby_times
) {

334 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šüby % %Îd", 
key
, 
šüby_¡•
);

335 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

336 
»¶y
->
š‹g”
 !ğ(
n
+1)*
šüby_¡•
) {

337 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incrby %lld %lldimesƒrror",

338 
šüby_¡•
, 
n
+1);

339 
”rÜ
;

341 
	`ä“R•lyObjeù
(
»¶y
);

343 
n
 ++;

346 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

347 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

348 
”rÜ
;

350 
v®ue
;

351 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
) ||

352 
v®ue
 !ğ
šüby_times
*
šüby_¡•
) {

353 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incrbyo %lldƒrror, %s in fact",

354 
šüby_times
*
šüby_¡•
, 
»¶y
->
¡r
);

355 
”rÜ
;

358 
	`ä“R•lyObjeù
(
»¶y
);

360 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

361 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

362 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

363 
”rÜ
;

365 
	`ä“R•lyObjeù
(
»¶y
);

367 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šüby % %Îd", 
key
, 
šüby_¡•
);

368 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

369 
”rÜ
;

371 
	`ä“R•lyObjeù
(
»¶y
);

373 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

377 
”rÜ
:

379 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

381 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

382 
”rmsg
[0] = '\0';

385 
	}
}

387 
	$sim¶e_‹¡_cmd_deüby
(
vœe_š¡ªû
 *
vi
)

389 *
key
 = "test_cmd_decrby-key";

390 
n
 = 0, 
deüby_times
 = 100, 
deüby_¡•
 = 3;

391 *
MESSAGE
 = "DECRBY simpleest";

392 
»disR•ly
 * 
»¶y
 = 
NULL
;

394 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

395 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

396 
”rÜ
;

398 
	`ä“R•lyObjeù
(
»¶y
);

400 
n
 < 
deüby_times
) {

401 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "deüby % %Îd", 
key
, 
deüby_¡•
);

402 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

403 
»¶y
->
š‹g”
 + (
n
+1)*
deüby_¡•
 != 0) {

404 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "decrby %lld %lldimesƒrror",

405 
deüby_¡•
, 
n
+1);

406 
”rÜ
;

408 
	`ä“R•lyObjeù
(
»¶y
);

410 
n
 ++;

413 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

414 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

415 
”rÜ
;

417 
v®ue
;

418 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
) ||

419 
v®ue
 + 
deüby_times
*
deüby_¡•
 != 0) {

420 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "decrbyo -%lldƒrror, %s in fact",

421 
deüby_times
*
deüby_¡•
, 
»¶y
->
¡r
);

422 
”rÜ
;

425 
	`ä“R•lyObjeù
(
»¶y
);

427 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

428 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

429 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

430 
”rÜ
;

432 
	`ä“R•lyObjeù
(
»¶y
);

434 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "deüby % %Îd", 
key
, 
deüby_¡•
);

435 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

436 
”rÜ
;

438 
	`ä“R•lyObjeù
(
»¶y
);

440 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

444 
”rÜ
:

446 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

448 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

449 
”rmsg
[0] = '\0';

452 
	}
}

454 
	$sim¶e_‹¡_cmd_­³nd
(
vœe_š¡ªû
 *
vi
)

456 *
key
 = "test_cmd_append-key";

457 *
fš®_v®ue
 = "pqwpioqjqwoiuqiorueljsakhdflkqueuquewqwei[oqfiqpq-0ewrq0hdalkjz.zhjaidhfioahd";

458 *
¡¬t
 = 
fš®_v®ue
, *
pos
 = s¹, *
’d
 = fš®_v®ue+
	`¡¾’
(final_value);

459 
¡•
 = 3, 
Ën
;

460 
buf
[20];

461 *
MESSAGE
 = "APPEND simpleest";

462 
»disR•ly
 * 
»¶y
 = 
NULL
;

464 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

465 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

466 
”rÜ
;

468 
	`ä“R•lyObjeù
(
»¶y
);

470 
pos
 < 
’d
) {

471 
Ën
 = (
’d
-
pos
 >ğ
¡•
) ? step : (end-pos);

472 
	`memıy
(
buf
,
pos
,
Ën
);

473 
buf
[
Ën
] = '\0';

474 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "­³nd % %s", 
key
, 
buf
);

475 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

476 
”rÜ
;

477 } ià(
»¶y
->
š‹g”
 !ğ
pos
-
¡¬t
+
Ën
) {

478 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "append %s %sƒrror",

479 
key
, 
buf
);

480 
”rÜ
;

482 
	`ä“R•lyObjeù
(
»¶y
);

484 
pos
 +ğ
Ën
;

487 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

488 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

489 
»¶y
->
Ën
 !ğ
	`¡¾’
(
fš®_v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,final_value)) {

490 
”rÜ
;

492 
	`ä“R•lyObjeù
(
»¶y
);

494 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

498 
”rÜ
:

500 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

502 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

503 
”rmsg
[0] = '\0';

506 
	}
}

508 
	$sim¶e_‹¡_cmd_¡¾’
(
vœe_š¡ªû
 *
vi
)

510 *
key
 = "test_cmd_strlen-key";

511 *
v®ue
 = "test_cmd_strlen-value";

512 *
MESSAGE
 = "STRLEN simpleest";

513 
»disR•ly
 * 
»¶y
 = 
NULL
;

515 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, 
v®ue
);

516 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

517 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

518 
”rÜ
;

520 
	`ä“R•lyObjeù
(
»¶y
);

522 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "¡¾’ %s", 
key
);

523 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

524 
»¶y
->
š‹g”
 !ğ
	`¡¾’
(
v®ue
)) {

525 
”rÜ
;

527 
	`ä“R•lyObjeù
(
»¶y
);

528 
»¶y
 = 
NULL
;

530 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

534 
”rÜ
:

536 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

538 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

539 
”rmsg
[0] = '\0';

542 
	}
}

544 
	$sim¶e_‹¡_cmd_g‘£t
(
vœe_š¡ªû
 *
vi
)

546 *
key
 = "test_cmd_getset-key";

547 *
Şdv®ue
 = "test_cmd_getset-oldvalue";

548 *
Ãwv®ue
 = "test_cmd_getset-newvalue";

549 *
MESSAGE
 = "GETSET simpleest";

550 
»disR•ly
 * 
»¶y
 = 
NULL
;

552 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, 
Şdv®ue
);

553 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

554 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

555 
”rÜ
;

557 
	`ä“R•lyObjeù
(
»¶y
);

559 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘£ˆ% %s", 
key
, 
Ãwv®ue
);

560 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

561 
»¶y
->
Ën
 !ğ
	`¡¾’
(
Şdv®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,oldvalue)) {

562 
”rÜ
;

564 
	`ä“R•lyObjeù
(
»¶y
);

566 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

567 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

568 
»¶y
->
Ën
 !ğ
	`¡¾’
(
Ãwv®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,newvalue)) {

569 
”rÜ
;

571 
	`ä“R•lyObjeù
(
»¶y
);

573 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

577 
”rÜ
:

579 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

581 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

582 
”rmsg
[0] = '\0';

585 
	}
}

587 
	$sim¶e_‹¡_cmd_šübyæßt
(
vœe_š¡ªû
 *
vi
)

589 *
key
 = "test_cmd_incrbyfloat-key";

590 *
fš®_v®ue
 = "314.00000000000000022";

591 
n
 = 0, 
šüby_times
 = 100;

592 
šübyæßt_¡•
 = 3.14;

593 *
MESSAGE
 = "INCRBYFLOAT simpleest";

594 
»disR•ly
 * 
»¶y
 = 
NULL
;

596 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

597 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

598 
”rÜ
;

600 
	`ä“R•lyObjeù
(
»¶y
);

602 
n
 < 
šüby_times
) {

603 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šübyæßˆ% %f", 
key
, 
šübyæßt_¡•
);

604 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

605 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incrbyfloat %f %lldimesƒrror",

606 
šübyæßt_¡•
, 
n
+1);

607 
”rÜ
;

609 
	`ä“R•lyObjeù
(
»¶y
);

611 
n
 ++;

614 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

615 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

616 
	`¡rcmp
(
»¶y
->
¡r
,
fš®_v®ue
)) {

617 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "šübyæßˆtØ% ”rÜ", 
fš®_v®ue
);

618 
”rÜ
;

620 
	`ä“R•lyObjeù
(
»¶y
);

622 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

623 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

624 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

625 
”rÜ
;

627 
	`ä“R•lyObjeù
(
»¶y
);

629 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šübyæßˆ% %f", 
key
, 
šübyæßt_¡•
);

630 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

631 
”rÜ
;

633 
	`ä“R•lyObjeù
(
»¶y
);

635 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

639 
”rÜ
:

641 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

643 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

644 
”rmsg
[0] = '\0';

647 
	}
}

649 
	$sim¶e_‹¡_cmd_g‘b™_£tb™_b™couÁ
(
vœe_š¡ªû
 *
vi
)

651 *
key
 = "test_cmd_getbit_setbit_bitcount-key";

652 *
MESSAGE
 = "GETBIT/SETBIT/BITCOUNT simpleest";

653 
begš
 = 11, 
¡•
 = 3, 
times
 = 79, 
n
;

654 
»disR•ly
 * 
»¶y
 = 
NULL
;

656 
n
 = 0;

657 
n
 < 
times
) {

658 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£tb™ % %d 1", 
key
, 
begš
+
n
*
¡•
);

659 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

660 
»¶y
->
š‹g”
 != 0) {

661 
”rÜ
;

663 
	`ä“R•lyObjeù
(
»¶y
);

665 
n
 ++;

668 
n
 = 0;

669 
n
 < 
times
) {

670 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘b™ % %d", 
key
, 
begš
+
n
*
¡•
);

671 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

672 
»¶y
->
š‹g”
 != 1) {

673 
”rÜ
;

675 
	`ä“R•lyObjeù
(
»¶y
);

677 
n
 ++;

680 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™couÁ %s", 
key
);

681 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

682 
»¶y
->
š‹g”
 !ğ
times
) {

683 
”rÜ
;

685 
	`ä“R•lyObjeù
(
»¶y
);

687 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

691 
”rÜ
:

693 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

695 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

696 
”rmsg
[0] = '\0';

699 
	}
}

701 
	$sim¶e_‹¡_cmd_g‘¿nge_£Œªge
(
vœe_š¡ªû
 *
vi
)

703 *
key
 = "test_cmd_getrange_setrange-key";

704 *
MESSAGE
 = "GETRANGE/SETRANGE simpleest";

705 *
¿nge_v®ue
 = "o090pl[]m,187h";

706 
begš
 = 11, 
¡•
 = 53, 
times
 = 79, 
n
;

707 
»disR•ly
 * 
»¶y
 = 
NULL
;

709 
n
 = 0;

710 
n
 < 
times
) {

711 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "setrange %s %d %s",

712 
key
, 
begš
+
n
*
¡•
, 
¿nge_v®ue
);

713 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

714 
»¶y
->
š‹g”
 !ğ
begš
+
n
*
¡•
+
	`¡¾’
(
¿nge_v®ue
)) {

715 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "setrange %s %d %sƒrror",

716 
key
, 
begš
+
n
*
¡•
, 
¿nge_v®ue
);

717 
”rÜ
;

719 
	`ä“R•lyObjeù
(
»¶y
);

721 
n
 ++;

724 
n
 = 0;

725 
n
 < 
times
) {

726 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘¿ng% %d %d", 
key
,

727 
begš
+
n
*
¡•
, begš+n*¡•+
	`¡¾’
(
¿nge_v®ue
)-1);

728 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

729 
»¶y
->
Ën
 !ğ
	`¡¾’
(
¿nge_v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,„ange_value)) {

730 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "getrange %s %d %dƒrror",

731 
key
, 
begš
+
n
*
¡•
, begš+n*¡•+
	`¡¾’
(
¿nge_v®ue
)-1);

732 
”rÜ
;

734 
	`ä“R•lyObjeù
(
»¶y
);

736 
n
 ++;

739 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

743 
”rÜ
:

745 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

747 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

748 
”rmsg
[0] = '\0';

751 
	}
}

753 
	$sim¶e_‹¡_cmd_b™pos
(
vœe_š¡ªû
 *
vi
)

755 *
key
 = "test_cmd_bitpos-key";

756 *
MESSAGE
 = "BITPOS simpleest";

757 
pos
 = 11;

758 
»disR•ly
 * 
»¶y
 = 
NULL
;

760 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

761 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

762 
”rÜ
;

764 
	`ä“R•lyObjeù
(
»¶y
);

766 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™po % 1", 
key
);

767 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

768 
»¶y
->
š‹g”
 != -1) {

769 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "bitpos %s 1 firstimeƒrror",

770 
key
);

771 
”rÜ
;

773 
	`ä“R•lyObjeù
(
»¶y
);

775 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£tb™ % 1 0", 
key
);

776 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

777 
»¶y
->
š‹g”
 != 0) {

778 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "setbit %s 1 0ƒrror",

779 
key
);

780 
”rÜ
;

782 
	`ä“R•lyObjeù
(
»¶y
);

784 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™po % 1", 
key
);

785 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

786 
»¶y
->
š‹g”
 != -1) {

787 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "bitpos %s 1 secondimeƒrror",

788 
key
);

789 
”rÜ
;

791 
	`ä“R•lyObjeù
(
»¶y
);

793 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£tb™ % %d 1", 
key
, 
pos
);

794 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

795 
»¶y
->
š‹g”
 != 0) {

796 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "setbit %s %d 1ƒrror",

797 
key
, 
pos
);

798 
”rÜ
;

800 
	`ä“R•lyObjeù
(
»¶y
);

802 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™po % 1", 
key
);

803 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

804 
»¶y
->
š‹g”
 !ğ
pos
) {

805 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "bitpos %s 1hirdimeƒrror",

806 
key
);

807 
”rÜ
;

809 
	`ä“R•lyObjeù
(
»¶y
);

811 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

815 
”rÜ
:

817 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

819 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

820 
”rmsg
[0] = '\0';

823 
	}
}

825 
	#MGET_MSET_KEYS_COUNT
 333

	)

826 
	$sim¶e_‹¡_cmd_mg‘_m£t
(
vœe_š¡ªû
 *
vi
)

828 *
key
 = "test_cmd_mget_mset-key";

829 *
v®ue
 = "test_cmd_mget_mset-value";

830 *
MESSAGE
 = "MGET/MSET simpleest";

831 
keys
[
MGET_MSET_KEYS_COUNT
][30];

832 
v®ues
[
MGET_MSET_KEYS_COUNT
][30];

833 *
¬gv
[1+2*
MGET_MSET_KEYS_COUNT
];

834 
size_t
 
¬gvËn
[1+2*
MGET_MSET_KEYS_COUNT
];

835 
j
, 
idx
;

836 
»disR•ly
 *
»¶y
 = 
NULL
;

838 
j
 = 0; j < 
MGET_MSET_KEYS_COUNT
; j ++) {

839 
	`v¹_sú´štf
(
keys
[
j
], 30,"%s%d", 
key
, j);

840 
	`v¹_sú´štf
(
v®ues
[
j
], 30,"%s%d", 
v®ue
, j);

843 
¬gv
[0] = "mset";

844 
¬gvËn
[0] = 
	`¡¾’
(
¬gv
[0]);

845 
idx
 = 1;

846 
j
 = 0; j < 
MGET_MSET_KEYS_COUNT
; j ++) {

847 
¬gv
[
idx
] = 
keys
[
j
];

848 
¬gvËn
[
idx
++] = 
	`¡¾’
(
keys
[
j
]);

849 
¬gv
[
idx
] = 
v®ues
[
j
];

850 
¬gvËn
[
idx
++] = 
	`¡¾’
(
v®ues
[
j
]);

853 
»¶y
 = 
	`»disCommªdArgv
(
vi
->
ùx
, 1+2*
MGET_MSET_KEYS_COUNT
, 
¬gv
, 
¬gvËn
);

854 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

855 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

856 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "mset %d keysƒrror",

857 
MGET_MSET_KEYS_COUNT
);

858 
”rÜ
;

860 
	`ä“R•lyObjeù
(
»¶y
);

862 
¬gv
[0] = "mget";

863 
¬gvËn
[0] = 
	`¡¾’
(
¬gv
[0]);

864 
j
 = 1; j < 1+
MGET_MSET_KEYS_COUNT
; j ++) {

865 
¬gv
[
j
] = 
keys
[j-1];

866 
¬gvËn
[
j
] = 
	`¡¾’
(
¬gv
[j]);

869 
»¶y
 = 
	`»disCommªdArgv
(
vi
->
ùx
, 1+
MGET_MSET_KEYS_COUNT
, 
¬gv
, 
¬gvËn
);

870 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ARRAY
 ||

871 
»¶y
->
–em’ts
 !ğ
MGET_MSET_KEYS_COUNT
) {

872 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "mget %d keysƒrror",

873 
MGET_MSET_KEYS_COUNT
);

874 
”rÜ
;

876 
j
 = 0; j < 
MGET_MSET_KEYS_COUNT
; j ++) {

877 
»disR•ly
 *
»¶y_sub
 = 
»¶y
->
–em’t
[
j
];

878 ià(
»¶y_sub
 =ğ
NULL
 ||

879 
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

880 
»¶y_sub
->
Ën
 !ğ
	`¡¾’
(
v®ues
[
j
]) ||

881 
	`¡rcmp
(
»¶y_sub
->
¡r
, 
v®ues
[
j
]))

882 
”rÜ
;

884 
	`ä“R•lyObjeù
(
»¶y
);

885 
»¶y
 = 
NULL
;

887 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

891 
”rÜ
:

893 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

895 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

896 
”rmsg
[0] = '\0';

899 
	}
}

901 
	#TEST_HASH_ENCODED_ZIPLIST
 0

	)

902 
	#TEST_HASH_ENCODED_HT
 1

	)

903 
	#TEST_HASH_ENCODED_CAUSED_BY_FILED
 0

	)

904 
	#TEST_HASH_ENCODED_CAUSED_BY_VALUE
 1

	)

905 
	#TEST_HASH_ENCODED_CAUSED_BY_ALL
 2

	)

906 
	#TEST_HASH_ENCODED_ZIPLIST_FIELD_COUNT
 56

	)

907 
	#TEST_HASH_ENCODED_HT_FIELD_COUNT
 678

	)

908 
	#TEST_HASH_ENCODED_ZIPLIST_VALUE_LEN
 21

	)

909 
	#TEST_HASH_ENCODED_HT_VALUE_LEN
 111

	)

911 
	s‹¡_hash_memb”
 {

912 *
	mf›ld
;

913 *
	mv®ue
;

916 
	$‹¡_hash_memb”_Ëngth
(
‹¡_hash_memb”
 **
thms
)

918 
j
 = 0;

919 
thms
[
j
]) {

920 
j
 ++;

922  
j
;

923 
	}
}

925 
	$‹¡_hash_memb”s_de¡roy
(
‹¡_hash_memb”
 **
thms
)

927 
j
 = 0;

928 
thms
[
j
]) {

929 
	`ä“
(
thms
[
j
]->
f›ld
);

930 
	`ä“
(
thms
[
j
]->
v®ue
);

931 
	`ä“
(
thms
[
j
]);

932 
j
 ++;

934 
	`ä“
(
thms
);

935 
	}
}

937 
‹¡_hash_memb”
 **
	$sim¶e_‹¡_hash_š™
(
vœe_š¡ªû
 *
vi
, *
key
, 
hash_’code
, 
’code_ÿu£
)

939 *
f›ld
 = "test_hash-field";

940 *
v®ue
 = "test_hash-value";

941 
f›ld_couÁ
, 
v®ue_Ën
;

942 
j
,
n
;

943 
‹¡_hash_memb”
 **
thms
 = 
NULL
;

944 
»disR•ly
 *
»¶y
 = 
NULL
;

946 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

947 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

948 
”rÜ
;

950 
	`ä“R•lyObjeù
(
»¶y
);

952 ià(
hash_’code
 =ğ
TEST_HASH_ENCODED_ZIPLIST
) {

953 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_ZIPLIST_FIELD_COUNT
;

954 
v®ue_Ën
 = 
TEST_HASH_ENCODED_ZIPLIST_VALUE_LEN
;

955 } ià(
’code_ÿu£
 =ğ
TEST_HASH_ENCODED_CAUSED_BY_FILED
) {

956 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_HT_FIELD_COUNT
;

957 
v®ue_Ën
 = 
TEST_HASH_ENCODED_ZIPLIST_VALUE_LEN
;

958 } ià(
’code_ÿu£
 =ğ
TEST_HASH_ENCODED_CAUSED_BY_VALUE
) {

959 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_ZIPLIST_FIELD_COUNT
;

960 
v®ue_Ën
 = 
TEST_HASH_ENCODED_HT_VALUE_LEN
;

961 } ià(
’code_ÿu£
 =ğ
TEST_HASH_ENCODED_CAUSED_BY_ALL
) {

962 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_HT_FIELD_COUNT
;

963 
v®ue_Ën
 = 
TEST_HASH_ENCODED_HT_VALUE_LEN
;

966 
thms
 = 
	`m®loc
((
f›ld_couÁ
+1)*(
‹¡_hash_memb”
*));

967 
j
 = 0; j < 
f›ld_couÁ
; j ++) {

968 
thms
[
j
] = 
	`m®loc
((
‹¡_hash_memb”
));

969 
thms
[
j
]->
f›ld
 = 
	`m®loc
(30*());

970 
thms
[
j
]->
v®ue
 = 
	`m®loc
((
v®ue_Ën
+1)*());

971 
	`v¹_sú´štf
(
thms
[
j
]->
f›ld
, 30, "%s%d", field, j);

972 
n
 = 
	`v¹_sú´štf
(
thms
[
j
]->
v®ue
, 
v®ue_Ën
, "%s%d", value, j);

973 ià(
n
 < 
v®ue_Ën
) {

974 
	`mem£t
(
thms
[
j
]->
v®ue
,'x',
v®ue_Ën
-
n
);

975 
thms
[
j
]->
v®ue
[
v®ue_Ën
] = '\0';

978 
thms
[
f›ld_couÁ
] = 
NULL
;

980 
j
 = 0; j < 
f›ld_couÁ
; j ++) {

981 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hset %s %s %s",

982 
key
, 
thms
[
j
]->
f›ld
,hms[j]->
v®ue
);

983 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

984 
»¶y
->
š‹g”
 != 1) {

985 
”rÜ
;

987 
	`ä“R•lyObjeù
(
»¶y
);

990 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hËÀ%s", 
key
);

991 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

992 
»¶y
->
š‹g”
 !ğ
f›ld_couÁ
) {

993 
”rÜ
;

995 
	`ä“R•lyObjeù
(
»¶y
);

997 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "objeùƒncodšg %s", 
key
);

998 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

999 
”rÜ
;

1001 ià(
hash_’code
 =ğ
TEST_HASH_ENCODED_ZIPLIST
) {

1002 if(
»¶y
->
Ën
 !ğ7 || 
	`¡rcmp
Ô•ly->
¡r
, "ziplist")) {

1003 
”rÜ
;

1006 if(
»¶y
->
Ën
 !ğ9 || 
	`¡rcmp
Ô•ly->
¡r
, "hashtable")) {

1007 
”rÜ
;

1011 
	`ä“R•lyObjeù
(
»¶y
);

1013  
thms
;

1015 
”rÜ
:

1017 ià(
thms
) {

1018 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1019 
thms
 = 
NULL
;

1022 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1024  
NULL
;

1025 
	}
}

1027 
	$sim¶e_‹¡_hash_’code
(
vœe_š¡ªû
 *
vi
)

1029 *
key
 = "test_hash_encode";

1030 *
MESSAGE
 = "HASH ENCODE simpleest";

1031 
‹¡_hash_memb”
 **
thms
;

1033 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_ZIPLIST
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1034 ià(
thms
 =ğ
NULL
) {

1035 
”rÜ
;

1037 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1038 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_ZIPLIST
,
TEST_HASH_ENCODED_CAUSED_BY_VALUE
);

1039 ià(
thms
 =ğ
NULL
) {

1040 
”rÜ
;

1042 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1043 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1044 ià(
thms
 =ğ
NULL
) {

1045 
”rÜ
;

1047 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1048 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_VALUE
);

1049 ià(
thms
 =ğ
NULL
) {

1050 
”rÜ
;

1052 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1053 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_ALL
);

1054 ià(
thms
 =ğ
NULL
) {

1055 
”rÜ
;

1057 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1059 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1063 
”rÜ
:

1065 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1066 
”rmsg
[0] = '\0';

1069 
	}
}

1071 
	$sim¶e_‹¡_cmd_hg‘_h£t
(
vœe_š¡ªû
 *
vi
)

1073 *
key
 = "test_cmd_hget_hset-key";

1074 *
f›ld
 = "test_cmd_hget_hset-field";

1075 *
v®ue
 = "test_cmd_hget_hset-value";

1076 *
MESSAGE
 = "HGET/HSET simpleest";

1077 
»disR•ly
 * 
»¶y
 = 
NULL
;

1078 
‹¡_hash_memb”
 **
thms
 = 
NULL
;

1079 
idx
;

1081 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1082 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1083 
”rÜ
;

1085 
	`ä“R•lyObjeù
(
»¶y
);

1087 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% % %s", 
key
, 
f›ld
, 
v®ue
);

1088 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1089 
»¶y
->
š‹g”
 != 1) {

1090 
”rÜ
;

1092 
	`ä“R•lyObjeù
(
»¶y
);

1094 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
f›ld
);

1095 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1096 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

1097 
”rÜ
;

1099 
	`ä“R•lyObjeù
(
»¶y
);

1101 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1102 ià(
thms
 =ğ
NULL
) {

1103 
”rÜ
;

1105 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% % %s", 
key
, 
f›ld
, 
v®ue
);

1106 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1107 
»¶y
->
š‹g”
 != 1) {

1108 
”rÜ
;

1110 
	`ä“R•lyObjeù
(
»¶y
);

1111 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
f›ld
);

1112 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1113 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

1114 
”rÜ
;

1116 
	`ä“R•lyObjeù
(
»¶y
);

1117 
idx
 = 
	`‹¡_hash_memb”_Ëngth
(
thms
)/2;

1118 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
thms
[
idx
]->
f›ld
);

1119 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1120 
»¶y
->
Ën
 !ğ
	`¡¾’
(
thms
[
idx
]->
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,thms[idx]->value)) {

1121 
”rÜ
;

1123 
	`ä“R•lyObjeù
(
»¶y
);

1124 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1126 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1130 
”rÜ
:

1132 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1133 ià(
thms
è
	`‹¡_hash_memb”s_de¡roy
(thms);

1135 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1136 
”rmsg
[0] = '\0';

1139 
	}
}

1141 
	$sim¶e_‹¡_cmd_hËn
(
vœe_š¡ªû
 *
vi
)

1143 *
key
 = "test_cmd_hlen-key";

1144 *
f›ld
 = "test_cmd_hlen-field";

1145 *
v®ue
 = "test_cmd_hlen-value";

1146 *
MESSAGE
 = "HLEN simpleest";

1147 
»disR•ly
 * 
»¶y
 = 
NULL
;

1148 
hash_Ën
, 
j
;

1150 
hash_Ën
 = 51;

1151 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1152 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1153 
”rÜ
;

1155 
	`ä“R•lyObjeù
(
»¶y
);

1156 
j
 = 0; j < 
hash_Ën
; j ++) {

1157 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 
j
, 
v®ue
);

1158 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1159 
»¶y
->
š‹g”
 != 1) {

1160 
”rÜ
;

1162 
	`ä“R•lyObjeù
(
»¶y
);

1164 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hËÀ%s", 
key
);

1165 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1166 
»¶y
->
š‹g”
 !ğ
hash_Ën
) {

1167 
”rÜ
;

1169 
	`ä“R•lyObjeù
(
»¶y
);

1171 
hash_Ën
 = 5111;

1172 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1173 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1174 
”rÜ
;

1176 
	`ä“R•lyObjeù
(
»¶y
);

1177 
j
 = 0; j < 
hash_Ën
; j ++) {

1178 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 
j
, 
v®ue
);

1179 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1180 
»¶y
->
š‹g”
 != 1) {

1181 
”rÜ
;

1183 
	`ä“R•lyObjeù
(
»¶y
);

1185 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hËÀ%s", 
key
);

1186 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1187 
»¶y
->
š‹g”
 !ğ
hash_Ën
) {

1188 
”rÜ
;

1190 
	`ä“R•lyObjeù
(
»¶y
);

1192 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1196 
”rÜ
:

1198 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1200 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1201 
”rmsg
[0] = '\0';

1204 
	}
}

1206 
	$sim¶e_‹¡_cmd_hd–
(
vœe_š¡ªû
 *
vi
)

1208 *
key
 = "test_cmd_hdel-key";

1209 *
f›ld
 = "test_cmd_hdel-field";

1210 *
v®ue
 = "test_cmd_hdel-value";

1211 *
MESSAGE
 = "HDEL simpleest";

1212 
»disR•ly
 * 
»¶y
 = 
NULL
;

1213 
‹¡_hash_memb”
 **
thms
 = 
NULL
;

1214 
idx
;

1216 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1217 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1218 
”rÜ
;

1220 
	`ä“R•lyObjeù
(
»¶y
);

1222 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 1, 
v®ue
);

1223 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1224 
»¶y
->
š‹g”
 != 1) {

1225 
”rÜ
;

1227 
	`ä“R•lyObjeù
(
»¶y
);

1228 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 2, 
v®ue
);

1229 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1230 
»¶y
->
š‹g”
 != 1) {

1231 
”rÜ
;

1233 
	`ä“R•lyObjeù
(
»¶y
);

1235 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s%d", 
key
, 
f›ld
, 1);

1236 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1237 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
, value)) {

1238 
”rÜ
;

1240 
	`ä“R•lyObjeù
(
»¶y
);

1241 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hd– % %s%d", 
key
, 
f›ld
, 1);

1242 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1243 
»¶y
->
š‹g”
 != 1) {

1244 
”rÜ
;

1246 
	`ä“R•lyObjeù
(
»¶y
);

1247 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s%d", 
key
, 
f›ld
, 1);

1248 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_NIL
) {

1249 
”rÜ
;

1251 
	`ä“R•lyObjeù
(
»¶y
);

1253 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hd– % %s%d", 
key
, 
f›ld
, 2);

1254 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1255 
»¶y
->
š‹g”
 != 1) {

1256 
”rÜ
;

1258 
	`ä“R•lyObjeù
(
»¶y
);

1259 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "exi¡ %s", 
key
);

1260 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1261 
»¶y
->
š‹g”
 != 0) {

1262 
”rÜ
;

1264 
	`ä“R•lyObjeù
(
»¶y
);

1266 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1267 ià(
thms
 =ğ
NULL
) {

1268 
”rÜ
;

1270 
idx
 = 
	`‹¡_hash_memb”_Ëngth
(
thms
)/2;

1271 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hd– % %s", 
key
, 
thms
[
idx
]->
f›ld
);

1272 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1273 
»¶y
->
š‹g”
 != 1) {

1274 
”rÜ
;

1276 
	`ä“R•lyObjeù
(
»¶y
);

1277 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
thms
[
idx
]->
f›ld
);

1278 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_NIL
) {

1279 
”rÜ
;

1281 
	`ä“R•lyObjeù
(
»¶y
);

1282 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1284 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1288 
”rÜ
:

1290 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1291 ià(
thms
è
	`‹¡_hash_memb”s_de¡roy
(thms);

1293 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1294 
”rmsg
[0] = '\0';

1297 
	}
}

1299 
	$sim¶e_‹¡_cmd_pçdd_pfcouÁ
(
vœe_š¡ªû
 *
vi
)

1301 *
key
 = "test_cmd_pfadd_pfcount-key";

1302 *
v®ue
 = "test_cmd_pfadd_pfcount-value";

1303 *
MESSAGE
 = "PFADD/PFCOUNT simpleest";

1304 
»disR•ly
 * 
»¶y
 = 
NULL
;

1305 
n
 = 0, 
couÁ
 = 20329, 
»³©
;

1307 
»³©
 < 2) {

1308 
ex³ù_couÁ
;

1309 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "pçdd % %s%d", 
key
, 
v®ue
, 
n
++);

1310 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

1311 
”rÜ
;

1313 
	`ä“R•lyObjeù
(
»¶y
);

1314 ià(
n
 >ğ
couÁ
) {

1315 
»³©
++;

1316 
n
 = 0;

1319 ià(
»³©
 == 0) {

1320 
ex³ù_couÁ
 = 
n
;

1322 
ex³ù_couÁ
 = 
couÁ
;

1325 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "pfcouÁ %s", 
key
);

1326 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

1327 
”rÜ
;

1329 ià(
»¶y
->
š‹g”
 !ğ()
ex³ù_couÁ
) {

1330 
mi¡ake
 = (()
ex³ù_couÁ
-()
»¶y
->
š‹g”
)/()expect_count;

1331 ià(
mi¡ake
 < -0.02 || mistake > 0.02) {

1332 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "pfadd %d differentƒlements is‚ot‡pproximated…fcount„eturned %lld, mistake %f",

1333 
ex³ù_couÁ
, 
»¶y
->
š‹g”
, 
mi¡ake
);

1334 
”rÜ
;

1337 
	`ä“R•lyObjeù
(
»¶y
);

1340 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1344 
”rÜ
:

1346 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1348 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1349 
”rmsg
[0] = '\0';

1352 
	}
}

1354 
	$sim¶e_‹¡
()

1356 
vœe_š¡ªû
 *
vi
;

1357 
ok_couÁ
 = 0, 
®l_couÁ
 = 0;

1359 
vi
 = 
	`¡¬t_Úe_vœe_š¡ªû
();

1360 ià(
vi
 =ğ
NULL
) {

1361 
	`‹¡_log_”rÜ
("Run vire instance failed");

1365 
”rmsg
[0] = '\0';

1368 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘_£t
(
vi
); 
®l_couÁ
++;

1369 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_£Šx
(
vi
); 
®l_couÁ
++;

1370 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_£‹x
(
vi
); 
®l_couÁ
++;

1371 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_p£‹x
(
vi
); 
®l_couÁ
++;

1372 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_šü
(
vi
); 
®l_couÁ
++;

1373 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_deü
(
vi
); 
®l_couÁ
++;

1374 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_šüby
(
vi
); 
®l_couÁ
++;

1375 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_deüby
(
vi
); 
®l_couÁ
++;

1376 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_­³nd
(
vi
); 
®l_couÁ
++;

1377 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_¡¾’
(
vi
); 
®l_couÁ
++;

1378 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘£t
(
vi
); 
®l_couÁ
++;

1379 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_šübyæßt
(
vi
); 
®l_couÁ
++;

1380 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘b™_£tb™_b™couÁ
(
vi
); 
®l_couÁ
++;

1381 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘¿nge_£Œªge
(
vi
); 
®l_couÁ
++;

1382 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_b™pos
(
vi
); 
®l_couÁ
++;

1383 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_mg‘_m£t
(
vi
); 
®l_couÁ
++;

1385 
ok_couÁ
+=
	`sim¶e_‹¡_hash_’code
(
vi
); 
®l_couÁ
++;

1386 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_hg‘_h£t
(
vi
); 
®l_couÁ
++;

1387 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_hËn
(
vi
); 
®l_couÁ
++;

1388 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_hd–
(
vi
); 
®l_couÁ
++;

1390 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_pçdd_pfcouÁ
(
vi
); 
®l_couÁ
++;

1392 
	`vœe_š¡ªû_de¡roy
(
vi
);

1394  
ok_couÁ
==
®l_couÁ
?1:0;

1395 
	}
}

	@tests/vrt_simple.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<g‘İt.h
>

5 
	~<fú.h
>

6 
	~<”ºo.h
>

7 
	~<sigÇl.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ut¢ame.h
>

11 
	~<hœedis.h
>

13 
	~<v¹_ut.h
>

14 
	~<v¹_public.h
>

15 
	~<v¹_sim¶e.h
>

17 
	#ERRMSG_MAX_LEN
 
LOG_MAX_LEN
-100

	)

18 
	g”rmsg
[
ERRMSG_MAX_LEN
];

20 
	$sim¶e_‹¡_cmd_g‘_£t
(
vœe_š¡ªû
 *
vi
)

22 *
key
 = "test_cmd_get_set-key";

23 *
v®ue
 = "test_cmd_get_set-value";

24 *
MESSAGE
 = "GET/SET simpleest";

25 
»disR•ly
 * 
»¶y
 = 
NULL
;

27 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, 
v®ue
);

28 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

29 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

30 
”rÜ
;

32 
	`ä“R•lyObjeù
(
»¶y
);

34 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

35 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

36 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

37 
”rÜ
;

39 
	`ä“R•lyObjeù
(
»¶y
);

40 
»¶y
 = 
NULL
;

42 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

46 
”rÜ
:

48 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

50 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

51 
”rmsg
[0] = '\0';

54 
	}
}

56 
	$sim¶e_‹¡_cmd_£Šx
(
vœe_š¡ªû
 *
vi
)

58 *
key
 = "test_cmd_setnx-key";

59 *
v®ue
 = "test_cmd_setnx-value";

60 *
MESSAGE
 = "SETNX simpleest";

61 
»disR•ly
 * 
»¶y
 = 
NULL
;

63 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

64 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

65 
”rÜ
;

67 
	`ä“R•lyObjeù
(
»¶y
);

69 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£Šx % %s", 
key
, 
v®ue
);

70 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

71 
»¶y
->
š‹g”
 != 1) {

72 
”rÜ
;

74 
	`ä“R•lyObjeù
(
»¶y
);

76 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

77 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

78 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

79 
”rÜ
;

81 
	`ä“R•lyObjeù
(
»¶y
);

83 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£Šx % %s", 
key
, 
v®ue
);

84 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

85 
»¶y
->
š‹g”
 != 0) {

86 
”rÜ
;

88 
	`ä“R•lyObjeù
(
»¶y
);

90 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

94 
”rÜ
:

96 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

98 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

99 
”rmsg
[0] = '\0';

102 
	}
}

104 
	$sim¶e_‹¡_cmd_£‹x
(
vœe_š¡ªû
 *
vi
)

106 *
key
 = "test_cmd_setex-key";

107 *
v®ue
 = "test_cmd_setex-value";

108 
£cÚds
 = 100;

109 *
MESSAGE
 = "SETEX simpleest";

110 
»disR•ly
 * 
»¶y
 = 
NULL
;

112 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£‹x % %Îd %s", 
key
, 
£cÚds
, 
v®ue
);

113 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

114 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

115 
”rÜ
;

117 
	`ä“R•lyObjeù
(
»¶y
);

119 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

120 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

121 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

122 
”rÜ
;

124 
	`ä“R•lyObjeù
(
»¶y
);

126 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "‰È%s", 
key
);

127 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

128 
»¶y
->
š‹g”
 > 
£cÚds
 ||„eply->integer < seconds - 2) {

129 
”rÜ
;

131 
	`ä“R•lyObjeù
(
»¶y
);

133 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

137 
”rÜ
:

139 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

141 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

142 
”rmsg
[0] = '\0';

145 
	}
}

147 
	$sim¶e_‹¡_cmd_p£‹x
(
vœe_š¡ªû
 *
vi
)

149 *
key
 = "test_cmd_psetex-key";

150 *
v®ue
 = "test_cmd_psetex-value";

151 
mli£cÚds
 = 100000;

152 *
MESSAGE
 = "PSETEX simpleest";

153 
»disR•ly
 * 
»¶y
 = 
NULL
;

155 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "p£‹x % %Îd %s", 
key
, 
mli£cÚds
, 
v®ue
);

156 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

157 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

158 
”rÜ
;

160 
	`ä“R•lyObjeù
(
»¶y
);

162 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

163 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

164 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

165 
”rÜ
;

167 
	`ä“R•lyObjeù
(
»¶y
);

169 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "± %s", 
key
);

170 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

171 
»¶y
->
š‹g”
 > 
mli£cÚds
 ||„eply->integer < milliseconds - 2000) {

172 
”rÜ
;

174 
	`ä“R•lyObjeù
(
»¶y
);

176 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

180 
”rÜ
:

182 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

184 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

185 
”rmsg
[0] = '\0';

188 
	}
}

190 
	$sim¶e_‹¡_cmd_šü
(
vœe_š¡ªû
 *
vi
)

192 *
key
 = "test_cmd_incr-key";

193 
n
 = 0, 
šü_times
 = 100;

194 *
MESSAGE
 = "INCR simpleest";

195 
»disR•ly
 * 
»¶y
 = 
NULL
;

197 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

198 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

199 
”rÜ
;

201 
	`ä“R•lyObjeù
(
»¶y
);

203 
n
 < 
šü_times
) {

204 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šü %s", 
key
);

205 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

206 
»¶y
->
š‹g”
 !ğ
n
+1) {

207 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "šü %Îdime ”rÜ", 
n
+1);

208 
”rÜ
;

210 
	`ä“R•lyObjeù
(
»¶y
);

212 
n
 ++;

215 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

216 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

217 
”rÜ
;

219 
v®ue
;

220 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
è|| v®u!ğ
šü_times
) {

221 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incro %lldƒrror, %s in fact",

222 
šü_times
, 
»¶y
->
¡r
);

223 
”rÜ
;

226 
	`ä“R•lyObjeù
(
»¶y
);

228 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

229 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

230 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

231 
”rÜ
;

233 
	`ä“R•lyObjeù
(
»¶y
);

235 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šü %s", 
key
);

236 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

237 
”rÜ
;

239 
	`ä“R•lyObjeù
(
»¶y
);

241 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

245 
”rÜ
:

247 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

249 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

250 
”rmsg
[0] = '\0';

253 
	}
}

255 
	$sim¶e_‹¡_cmd_deü
(
vœe_š¡ªû
 *
vi
)

257 *
key
 = "test_cmd_decr-key";

258 
n
 = 0, 
deü_times
 = 100;

259 *
MESSAGE
 = "DECR simpleest";

260 
»disR•ly
 * 
»¶y
 = 
NULL
;

262 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

263 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

264 
”rÜ
;

266 
	`ä“R•lyObjeù
(
»¶y
);

268 
n
 < 
deü_times
) {

269 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "deü %s", 
key
);

270 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

271 
»¶y
->
š‹g”
 + 
n
 != -1) {

272 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "šü %Îdime ”rÜ", 
n
+1);

273 
”rÜ
;

275 
	`ä“R•lyObjeù
(
»¶y
);

277 
n
 ++;

280 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

281 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

282 
”rÜ
;

284 
v®ue
;

285 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
è|| v®u+ 
deü_times
 != 0) {

286 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "decro -%lldƒrror, %s in fact",

287 
deü_times
, 
»¶y
->
¡r
);

288 
”rÜ
;

291 
	`ä“R•lyObjeù
(
»¶y
);

293 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

294 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

295 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

296 
”rÜ
;

298 
	`ä“R•lyObjeù
(
»¶y
);

300 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šü %s", 
key
);

301 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

302 
”rÜ
;

304 
	`ä“R•lyObjeù
(
»¶y
);

306 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

310 
”rÜ
:

312 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

314 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

315 
”rmsg
[0] = '\0';

318 
	}
}

320 
	$sim¶e_‹¡_cmd_šüby
(
vœe_š¡ªû
 *
vi
)

322 *
key
 = "test_cmd_incrby-key";

323 
n
 = 0, 
šüby_times
 = 100, 
šüby_¡•
 = 3;

324 *
MESSAGE
 = "INCRBY simpleest";

325 
»disR•ly
 * 
»¶y
 = 
NULL
;

327 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

328 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

329 
”rÜ
;

331 
	`ä“R•lyObjeù
(
»¶y
);

333 
n
 < 
šüby_times
) {

334 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šüby % %Îd", 
key
, 
šüby_¡•
);

335 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

336 
»¶y
->
š‹g”
 !ğ(
n
+1)*
šüby_¡•
) {

337 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incrby %lld %lldimesƒrror",

338 
šüby_¡•
, 
n
+1);

339 
”rÜ
;

341 
	`ä“R•lyObjeù
(
»¶y
);

343 
n
 ++;

346 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

347 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

348 
”rÜ
;

350 
v®ue
;

351 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
) ||

352 
v®ue
 !ğ
šüby_times
*
šüby_¡•
) {

353 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incrbyo %lldƒrror, %s in fact",

354 
šüby_times
*
šüby_¡•
, 
»¶y
->
¡r
);

355 
”rÜ
;

358 
	`ä“R•lyObjeù
(
»¶y
);

360 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

361 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

362 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

363 
”rÜ
;

365 
	`ä“R•lyObjeù
(
»¶y
);

367 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šüby % %Îd", 
key
, 
šüby_¡•
);

368 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

369 
”rÜ
;

371 
	`ä“R•lyObjeù
(
»¶y
);

373 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

377 
”rÜ
:

379 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

381 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

382 
”rmsg
[0] = '\0';

385 
	}
}

387 
	$sim¶e_‹¡_cmd_deüby
(
vœe_š¡ªû
 *
vi
)

389 *
key
 = "test_cmd_decrby-key";

390 
n
 = 0, 
deüby_times
 = 100, 
deüby_¡•
 = 3;

391 *
MESSAGE
 = "DECRBY simpleest";

392 
»disR•ly
 * 
»¶y
 = 
NULL
;

394 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

395 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

396 
”rÜ
;

398 
	`ä“R•lyObjeù
(
»¶y
);

400 
n
 < 
deüby_times
) {

401 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "deüby % %Îd", 
key
, 
deüby_¡•
);

402 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

403 
»¶y
->
š‹g”
 + (
n
+1)*
deüby_¡•
 != 0) {

404 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "decrby %lld %lldimesƒrror",

405 
deüby_¡•
, 
n
+1);

406 
”rÜ
;

408 
	`ä“R•lyObjeù
(
»¶y
);

410 
n
 ++;

413 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

414 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

415 
”rÜ
;

417 
v®ue
;

418 ià(!
	`¡ršg2Î
(
»¶y
->
¡r
,»¶y->
Ën
,&
v®ue
) ||

419 
v®ue
 + 
deüby_times
*
deüby_¡•
 != 0) {

420 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "decrbyo -%lldƒrror, %s in fact",

421 
deüby_times
*
deüby_¡•
, 
»¶y
->
¡r
);

422 
”rÜ
;

425 
	`ä“R•lyObjeù
(
»¶y
);

427 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

428 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

429 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

430 
”rÜ
;

432 
	`ä“R•lyObjeù
(
»¶y
);

434 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "deüby % %Îd", 
key
, 
deüby_¡•
);

435 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

436 
”rÜ
;

438 
	`ä“R•lyObjeù
(
»¶y
);

440 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

444 
”rÜ
:

446 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

448 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

449 
”rmsg
[0] = '\0';

452 
	}
}

454 
	$sim¶e_‹¡_cmd_­³nd
(
vœe_š¡ªû
 *
vi
)

456 *
key
 = "test_cmd_append-key";

457 *
fš®_v®ue
 = "pqwpioqjqwoiuqiorueljsakhdflkqueuquewqwei[oqfiqpq-0ewrq0hdalkjz.zhjaidhfioahd";

458 *
¡¬t
 = 
fš®_v®ue
, *
pos
 = s¹, *
’d
 = fš®_v®ue+
	`¡¾’
(final_value);

459 
¡•
 = 3, 
Ën
;

460 
buf
[20];

461 *
MESSAGE
 = "APPEND simpleest";

462 
»disR•ly
 * 
»¶y
 = 
NULL
;

464 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

465 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

466 
”rÜ
;

468 
	`ä“R•lyObjeù
(
»¶y
);

470 
pos
 < 
’d
) {

471 
Ën
 = (
’d
-
pos
 >ğ
¡•
) ? step : (end-pos);

472 
	`memıy
(
buf
,
pos
,
Ën
);

473 
buf
[
Ën
] = '\0';

474 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "­³nd % %s", 
key
, 
buf
);

475 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

476 
”rÜ
;

477 } ià(
»¶y
->
š‹g”
 !ğ
pos
-
¡¬t
+
Ën
) {

478 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "append %s %sƒrror",

479 
key
, 
buf
);

480 
”rÜ
;

482 
	`ä“R•lyObjeù
(
»¶y
);

484 
pos
 +ğ
Ën
;

487 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

488 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

489 
»¶y
->
Ën
 !ğ
	`¡¾’
(
fš®_v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,final_value)) {

490 
”rÜ
;

492 
	`ä“R•lyObjeù
(
»¶y
);

494 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

498 
”rÜ
:

500 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

502 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

503 
”rmsg
[0] = '\0';

506 
	}
}

508 
	$sim¶e_‹¡_cmd_¡¾’
(
vœe_š¡ªû
 *
vi
)

510 *
key
 = "test_cmd_strlen-key";

511 *
v®ue
 = "test_cmd_strlen-value";

512 *
MESSAGE
 = "STRLEN simpleest";

513 
»disR•ly
 * 
»¶y
 = 
NULL
;

515 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, 
v®ue
);

516 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

517 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

518 
”rÜ
;

520 
	`ä“R•lyObjeù
(
»¶y
);

522 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "¡¾’ %s", 
key
);

523 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

524 
»¶y
->
š‹g”
 !ğ
	`¡¾’
(
v®ue
)) {

525 
”rÜ
;

527 
	`ä“R•lyObjeù
(
»¶y
);

528 
»¶y
 = 
NULL
;

530 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

534 
”rÜ
:

536 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

538 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

539 
”rmsg
[0] = '\0';

542 
	}
}

544 
	$sim¶e_‹¡_cmd_g‘£t
(
vœe_š¡ªû
 *
vi
)

546 *
key
 = "test_cmd_getset-key";

547 *
Şdv®ue
 = "test_cmd_getset-oldvalue";

548 *
Ãwv®ue
 = "test_cmd_getset-newvalue";

549 *
MESSAGE
 = "GETSET simpleest";

550 
»disR•ly
 * 
»¶y
 = 
NULL
;

552 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, 
Şdv®ue
);

553 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

554 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

555 
”rÜ
;

557 
	`ä“R•lyObjeù
(
»¶y
);

559 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘£ˆ% %s", 
key
, 
Ãwv®ue
);

560 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

561 
»¶y
->
Ën
 !ğ
	`¡¾’
(
Şdv®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,oldvalue)) {

562 
”rÜ
;

564 
	`ä“R•lyObjeù
(
»¶y
);

566 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

567 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

568 
»¶y
->
Ën
 !ğ
	`¡¾’
(
Ãwv®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,newvalue)) {

569 
”rÜ
;

571 
	`ä“R•lyObjeù
(
»¶y
);

573 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

577 
”rÜ
:

579 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

581 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

582 
”rmsg
[0] = '\0';

585 
	}
}

587 
	$sim¶e_‹¡_cmd_šübyæßt
(
vœe_š¡ªû
 *
vi
)

589 *
key
 = "test_cmd_incrbyfloat-key";

590 *
fš®_v®ue
 = "314.00000000000000022";

591 
n
 = 0, 
šüby_times
 = 100;

592 
šübyæßt_¡•
 = 3.14;

593 *
MESSAGE
 = "INCRBYFLOAT simpleest";

594 
»disR•ly
 * 
»¶y
 = 
NULL
;

596 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

597 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

598 
”rÜ
;

600 
	`ä“R•lyObjeù
(
»¶y
);

602 
n
 < 
šüby_times
) {

603 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šübyæßˆ% %f", 
key
, 
šübyæßt_¡•
);

604 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

605 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "incrbyfloat %f %lldimesƒrror",

606 
šübyæßt_¡•
, 
n
+1);

607 
”rÜ
;

609 
	`ä“R•lyObjeù
(
»¶y
);

611 
n
 ++;

614 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘ %s", 
key
);

615 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

616 
	`¡rcmp
(
»¶y
->
¡r
,
fš®_v®ue
)) {

617 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "šübyæßˆtØ% ”rÜ", 
fš®_v®ue
);

618 
”rÜ
;

620 
	`ä“R•lyObjeù
(
»¶y
);

622 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£ˆ% %s", 
key
, "a");

623 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

624 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

625 
”rÜ
;

627 
	`ä“R•lyObjeù
(
»¶y
);

629 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "šübyæßˆ% %f", 
key
, 
šübyæßt_¡•
);

630 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ERROR
) {

631 
”rÜ
;

633 
	`ä“R•lyObjeù
(
»¶y
);

635 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

639 
”rÜ
:

641 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

643 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

644 
”rmsg
[0] = '\0';

647 
	}
}

649 
	$sim¶e_‹¡_cmd_g‘b™_£tb™_b™couÁ
(
vœe_š¡ªû
 *
vi
)

651 *
key
 = "test_cmd_getbit_setbit_bitcount-key";

652 *
MESSAGE
 = "GETBIT/SETBIT/BITCOUNT simpleest";

653 
begš
 = 11, 
¡•
 = 3, 
times
 = 79, 
n
;

654 
»disR•ly
 * 
»¶y
 = 
NULL
;

656 
n
 = 0;

657 
n
 < 
times
) {

658 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£tb™ % %d 1", 
key
, 
begš
+
n
*
¡•
);

659 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

660 
»¶y
->
š‹g”
 != 0) {

661 
”rÜ
;

663 
	`ä“R•lyObjeù
(
»¶y
);

665 
n
 ++;

668 
n
 = 0;

669 
n
 < 
times
) {

670 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘b™ % %d", 
key
, 
begš
+
n
*
¡•
);

671 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

672 
»¶y
->
š‹g”
 != 1) {

673 
”rÜ
;

675 
	`ä“R•lyObjeù
(
»¶y
);

677 
n
 ++;

680 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™couÁ %s", 
key
);

681 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

682 
»¶y
->
š‹g”
 !ğ
times
) {

683 
”rÜ
;

685 
	`ä“R•lyObjeù
(
»¶y
);

687 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

691 
”rÜ
:

693 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

695 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

696 
”rmsg
[0] = '\0';

699 
	}
}

701 
	$sim¶e_‹¡_cmd_g‘¿nge_£Œªge
(
vœe_š¡ªû
 *
vi
)

703 *
key
 = "test_cmd_getrange_setrange-key";

704 *
MESSAGE
 = "GETRANGE/SETRANGE simpleest";

705 *
¿nge_v®ue
 = "o090pl[]m,187h";

706 
begš
 = 11, 
¡•
 = 53, 
times
 = 79, 
n
;

707 
»disR•ly
 * 
»¶y
 = 
NULL
;

709 
n
 = 0;

710 
n
 < 
times
) {

711 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "setrange %s %d %s",

712 
key
, 
begš
+
n
*
¡•
, 
¿nge_v®ue
);

713 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

714 
»¶y
->
š‹g”
 !ğ
begš
+
n
*
¡•
+
	`¡¾’
(
¿nge_v®ue
)) {

715 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "setrange %s %d %sƒrror",

716 
key
, 
begš
+
n
*
¡•
, 
¿nge_v®ue
);

717 
”rÜ
;

719 
	`ä“R•lyObjeù
(
»¶y
);

721 
n
 ++;

724 
n
 = 0;

725 
n
 < 
times
) {

726 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "g‘¿ng% %d %d", 
key
,

727 
begš
+
n
*
¡•
, begš+n*¡•+
	`¡¾’
(
¿nge_v®ue
)-1);

728 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

729 
»¶y
->
Ën
 !ğ
	`¡¾’
(
¿nge_v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,„ange_value)) {

730 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "getrange %s %d %dƒrror",

731 
key
, 
begš
+
n
*
¡•
, begš+n*¡•+
	`¡¾’
(
¿nge_v®ue
)-1);

732 
”rÜ
;

734 
	`ä“R•lyObjeù
(
»¶y
);

736 
n
 ++;

739 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

743 
”rÜ
:

745 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

747 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

748 
”rmsg
[0] = '\0';

751 
	}
}

753 
	$sim¶e_‹¡_cmd_b™pos
(
vœe_š¡ªû
 *
vi
)

755 *
key
 = "test_cmd_bitpos-key";

756 *
MESSAGE
 = "BITPOS simpleest";

757 
pos
 = 11;

758 
»disR•ly
 * 
»¶y
 = 
NULL
;

760 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

761 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

762 
”rÜ
;

764 
	`ä“R•lyObjeù
(
»¶y
);

766 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™po % 1", 
key
);

767 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

768 
»¶y
->
š‹g”
 != -1) {

769 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "bitpos %s 1 firstimeƒrror",

770 
key
);

771 
”rÜ
;

773 
	`ä“R•lyObjeù
(
»¶y
);

775 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£tb™ % 1 0", 
key
);

776 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

777 
»¶y
->
š‹g”
 != 0) {

778 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "setbit %s 1 0ƒrror",

779 
key
);

780 
”rÜ
;

782 
	`ä“R•lyObjeù
(
»¶y
);

784 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™po % 1", 
key
);

785 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

786 
»¶y
->
š‹g”
 != -1) {

787 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "bitpos %s 1 secondimeƒrror",

788 
key
);

789 
”rÜ
;

791 
	`ä“R•lyObjeù
(
»¶y
);

793 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "£tb™ % %d 1", 
key
, 
pos
);

794 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

795 
»¶y
->
š‹g”
 != 0) {

796 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "setbit %s %d 1ƒrror",

797 
key
, 
pos
);

798 
”rÜ
;

800 
	`ä“R•lyObjeù
(
»¶y
);

802 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "b™po % 1", 
key
);

803 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

804 
»¶y
->
š‹g”
 !ğ
pos
) {

805 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "bitpos %s 1hirdimeƒrror",

806 
key
);

807 
”rÜ
;

809 
	`ä“R•lyObjeù
(
»¶y
);

811 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

815 
”rÜ
:

817 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

819 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

820 
”rmsg
[0] = '\0';

823 
	}
}

825 
	#MGET_MSET_KEYS_COUNT
 333

	)

826 
	$sim¶e_‹¡_cmd_mg‘_m£t
(
vœe_š¡ªû
 *
vi
)

828 *
key
 = "test_cmd_mget_mset-key";

829 *
v®ue
 = "test_cmd_mget_mset-value";

830 *
MESSAGE
 = "MGET/MSET simpleest";

831 
keys
[
MGET_MSET_KEYS_COUNT
][30];

832 
v®ues
[
MGET_MSET_KEYS_COUNT
][30];

833 *
¬gv
[1+2*
MGET_MSET_KEYS_COUNT
];

834 
size_t
 
¬gvËn
[1+2*
MGET_MSET_KEYS_COUNT
];

835 
j
, 
idx
;

836 
»disR•ly
 *
»¶y
 = 
NULL
;

838 
j
 = 0; j < 
MGET_MSET_KEYS_COUNT
; j ++) {

839 
	`v¹_sú´štf
(
keys
[
j
], 30,"%s%d", 
key
, j);

840 
	`v¹_sú´štf
(
v®ues
[
j
], 30,"%s%d", 
v®ue
, j);

843 
¬gv
[0] = "mset";

844 
¬gvËn
[0] = 
	`¡¾’
(
¬gv
[0]);

845 
idx
 = 1;

846 
j
 = 0; j < 
MGET_MSET_KEYS_COUNT
; j ++) {

847 
¬gv
[
idx
] = 
keys
[
j
];

848 
¬gvËn
[
idx
++] = 
	`¡¾’
(
keys
[
j
]);

849 
¬gv
[
idx
] = 
v®ues
[
j
];

850 
¬gvËn
[
idx
++] = 
	`¡¾’
(
v®ues
[
j
]);

853 
»¶y
 = 
	`»disCommªdArgv
(
vi
->
ùx
, 1+2*
MGET_MSET_KEYS_COUNT
, 
¬gv
, 
¬gvËn
);

854 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STATUS
 ||

855 
»¶y
->
Ën
 !ğ2 || 
	`¡rcmp
Ô•ly->
¡r
,"OK")) {

856 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "mset %d keysƒrror",

857 
MGET_MSET_KEYS_COUNT
);

858 
”rÜ
;

860 
	`ä“R•lyObjeù
(
»¶y
);

862 
¬gv
[0] = "mget";

863 
¬gvËn
[0] = 
	`¡¾’
(
¬gv
[0]);

864 
j
 = 1; j < 1+
MGET_MSET_KEYS_COUNT
; j ++) {

865 
¬gv
[
j
] = 
keys
[j-1];

866 
¬gvËn
[
j
] = 
	`¡¾’
(
¬gv
[j]);

869 
»¶y
 = 
	`»disCommªdArgv
(
vi
->
ùx
, 1+
MGET_MSET_KEYS_COUNT
, 
¬gv
, 
¬gvËn
);

870 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ARRAY
 ||

871 
»¶y
->
–em’ts
 !ğ
MGET_MSET_KEYS_COUNT
) {

872 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "mget %d keysƒrror",

873 
MGET_MSET_KEYS_COUNT
);

874 
”rÜ
;

876 
j
 = 0; j < 
MGET_MSET_KEYS_COUNT
; j ++) {

877 
»disR•ly
 *
»¶y_sub
 = 
»¶y
->
–em’t
[
j
];

878 ià(
»¶y_sub
 =ğ
NULL
 ||

879 
»¶y_sub
->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

880 
»¶y_sub
->
Ën
 !ğ
	`¡¾’
(
v®ues
[
j
]) ||

881 
	`¡rcmp
(
»¶y_sub
->
¡r
, 
v®ues
[
j
]))

882 
”rÜ
;

884 
	`ä“R•lyObjeù
(
»¶y
);

885 
»¶y
 = 
NULL
;

887 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

891 
”rÜ
:

893 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

895 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

896 
”rmsg
[0] = '\0';

899 
	}
}

901 
	#TEST_HASH_ENCODED_ZIPLIST
 0

	)

902 
	#TEST_HASH_ENCODED_HT
 1

	)

903 
	#TEST_HASH_ENCODED_CAUSED_BY_FILED
 0

	)

904 
	#TEST_HASH_ENCODED_CAUSED_BY_VALUE
 1

	)

905 
	#TEST_HASH_ENCODED_CAUSED_BY_ALL
 2

	)

906 
	#TEST_HASH_ENCODED_ZIPLIST_FIELD_COUNT
 56

	)

907 
	#TEST_HASH_ENCODED_HT_FIELD_COUNT
 678

	)

908 
	#TEST_HASH_ENCODED_ZIPLIST_VALUE_LEN
 21

	)

909 
	#TEST_HASH_ENCODED_HT_VALUE_LEN
 111

	)

911 
	s‹¡_hash_memb”
 {

912 *
	mf›ld
;

913 *
	mv®ue
;

916 
	$‹¡_hash_memb”_Ëngth
(
‹¡_hash_memb”
 **
thms
)

918 
j
 = 0;

919 
thms
[
j
]) {

920 
j
 ++;

922  
j
;

923 
	}
}

925 
	$‹¡_hash_memb”s_de¡roy
(
‹¡_hash_memb”
 **
thms
)

927 
j
 = 0;

928 
thms
[
j
]) {

929 
	`ä“
(
thms
[
j
]->
f›ld
);

930 
	`ä“
(
thms
[
j
]->
v®ue
);

931 
	`ä“
(
thms
[
j
]);

932 
j
 ++;

934 
	`ä“
(
thms
);

935 
	}
}

937 
‹¡_hash_memb”
 **
	$sim¶e_‹¡_hash_š™
(
vœe_š¡ªû
 *
vi
, *
key
, 
hash_’code
, 
’code_ÿu£
)

939 *
f›ld
 = "test_hash-field";

940 *
v®ue
 = "test_hash-value";

941 
f›ld_couÁ
, 
v®ue_Ën
;

942 
j
,
n
;

943 
‹¡_hash_memb”
 **
thms
 = 
NULL
;

944 
»disR•ly
 *
»¶y
 = 
NULL
;

946 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

947 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

948 
”rÜ
;

950 
	`ä“R•lyObjeù
(
»¶y
);

952 ià(
hash_’code
 =ğ
TEST_HASH_ENCODED_ZIPLIST
) {

953 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_ZIPLIST_FIELD_COUNT
;

954 
v®ue_Ën
 = 
TEST_HASH_ENCODED_ZIPLIST_VALUE_LEN
;

955 } ià(
’code_ÿu£
 =ğ
TEST_HASH_ENCODED_CAUSED_BY_FILED
) {

956 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_HT_FIELD_COUNT
;

957 
v®ue_Ën
 = 
TEST_HASH_ENCODED_ZIPLIST_VALUE_LEN
;

958 } ià(
’code_ÿu£
 =ğ
TEST_HASH_ENCODED_CAUSED_BY_VALUE
) {

959 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_ZIPLIST_FIELD_COUNT
;

960 
v®ue_Ën
 = 
TEST_HASH_ENCODED_HT_VALUE_LEN
;

961 } ià(
’code_ÿu£
 =ğ
TEST_HASH_ENCODED_CAUSED_BY_ALL
) {

962 
f›ld_couÁ
 = 
TEST_HASH_ENCODED_HT_FIELD_COUNT
;

963 
v®ue_Ën
 = 
TEST_HASH_ENCODED_HT_VALUE_LEN
;

966 
thms
 = 
	`m®loc
((
f›ld_couÁ
+1)*(
‹¡_hash_memb”
*));

967 
j
 = 0; j < 
f›ld_couÁ
; j ++) {

968 
thms
[
j
] = 
	`m®loc
((
‹¡_hash_memb”
));

969 
thms
[
j
]->
f›ld
 = 
	`m®loc
(30*());

970 
thms
[
j
]->
v®ue
 = 
	`m®loc
((
v®ue_Ën
+1)*());

971 
	`v¹_sú´štf
(
thms
[
j
]->
f›ld
, 30, "%s%d", field, j);

972 
n
 = 
	`v¹_sú´štf
(
thms
[
j
]->
v®ue
, 
v®ue_Ën
, "%s%d", value, j);

973 ià(
n
 < 
v®ue_Ën
) {

974 
	`mem£t
(
thms
[
j
]->
v®ue
,'x',
v®ue_Ën
-
n
);

975 
thms
[
j
]->
v®ue
[
v®ue_Ën
] = '\0';

978 
thms
[
f›ld_couÁ
] = 
NULL
;

980 
j
 = 0; j < 
f›ld_couÁ
; j ++) {

981 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hset %s %s %s",

982 
key
, 
thms
[
j
]->
f›ld
,hms[j]->
v®ue
);

983 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

984 
»¶y
->
š‹g”
 != 1) {

985 
”rÜ
;

987 
	`ä“R•lyObjeù
(
»¶y
);

990 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hËÀ%s", 
key
);

991 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

992 
»¶y
->
š‹g”
 !ğ
f›ld_couÁ
) {

993 
”rÜ
;

995 
	`ä“R•lyObjeù
(
»¶y
);

997 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "objeùƒncodšg %s", 
key
);

998 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
) {

999 
”rÜ
;

1001 ià(
hash_’code
 =ğ
TEST_HASH_ENCODED_ZIPLIST
) {

1002 if(
»¶y
->
Ën
 !ğ7 || 
	`¡rcmp
Ô•ly->
¡r
, "ziplist")) {

1003 
”rÜ
;

1006 if(
»¶y
->
Ën
 !ğ9 || 
	`¡rcmp
Ô•ly->
¡r
, "hashtable")) {

1007 
”rÜ
;

1011 
	`ä“R•lyObjeù
(
»¶y
);

1013  
thms
;

1015 
”rÜ
:

1017 ià(
thms
) {

1018 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1019 
thms
 = 
NULL
;

1022 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1024  
NULL
;

1025 
	}
}

1027 
	$sim¶e_‹¡_hash_’code
(
vœe_š¡ªû
 *
vi
)

1029 *
key
 = "test_hash_encode";

1030 *
MESSAGE
 = "HASH ENCODE simpleest";

1031 
‹¡_hash_memb”
 **
thms
;

1033 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_ZIPLIST
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1034 ià(
thms
 =ğ
NULL
) {

1035 
”rÜ
;

1037 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1038 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_ZIPLIST
,
TEST_HASH_ENCODED_CAUSED_BY_VALUE
);

1039 ià(
thms
 =ğ
NULL
) {

1040 
”rÜ
;

1042 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1043 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1044 ià(
thms
 =ğ
NULL
) {

1045 
”rÜ
;

1047 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1048 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_VALUE
);

1049 ià(
thms
 =ğ
NULL
) {

1050 
”rÜ
;

1052 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1053 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_ALL
);

1054 ià(
thms
 =ğ
NULL
) {

1055 
”rÜ
;

1057 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1059 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1063 
”rÜ
:

1065 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1066 
”rmsg
[0] = '\0';

1069 
	}
}

1071 
	$sim¶e_‹¡_cmd_hg‘_h£t
(
vœe_š¡ªû
 *
vi
)

1073 *
key
 = "test_cmd_hget_hset-key";

1074 *
f›ld
 = "test_cmd_hget_hset-field";

1075 *
v®ue
 = "test_cmd_hget_hset-value";

1076 *
MESSAGE
 = "HGET/HSET simpleest";

1077 
»disR•ly
 * 
»¶y
 = 
NULL
;

1078 
‹¡_hash_memb”
 **
thms
 = 
NULL
;

1079 
idx
;

1081 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1082 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1083 
”rÜ
;

1085 
	`ä“R•lyObjeù
(
»¶y
);

1087 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% % %s", 
key
, 
f›ld
, 
v®ue
);

1088 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1089 
»¶y
->
š‹g”
 != 1) {

1090 
”rÜ
;

1092 
	`ä“R•lyObjeù
(
»¶y
);

1094 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
f›ld
);

1095 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1096 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

1097 
”rÜ
;

1099 
	`ä“R•lyObjeù
(
»¶y
);

1101 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1102 ià(
thms
 =ğ
NULL
) {

1103 
”rÜ
;

1105 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% % %s", 
key
, 
f›ld
, 
v®ue
);

1106 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1107 
»¶y
->
š‹g”
 != 1) {

1108 
”rÜ
;

1110 
	`ä“R•lyObjeù
(
»¶y
);

1111 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
f›ld
);

1112 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1113 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,value)) {

1114 
”rÜ
;

1116 
	`ä“R•lyObjeù
(
»¶y
);

1117 
idx
 = 
	`‹¡_hash_memb”_Ëngth
(
thms
)/2;

1118 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
thms
[
idx
]->
f›ld
);

1119 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1120 
»¶y
->
Ën
 !ğ
	`¡¾’
(
thms
[
idx
]->
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
,thms[idx]->value)) {

1121 
”rÜ
;

1123 
	`ä“R•lyObjeù
(
»¶y
);

1124 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1126 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1130 
”rÜ
:

1132 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1133 ià(
thms
è
	`‹¡_hash_memb”s_de¡roy
(thms);

1135 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1136 
”rmsg
[0] = '\0';

1139 
	}
}

1141 
	$sim¶e_‹¡_cmd_hËn
(
vœe_š¡ªû
 *
vi
)

1143 *
key
 = "test_cmd_hlen-key";

1144 *
f›ld
 = "test_cmd_hlen-field";

1145 *
v®ue
 = "test_cmd_hlen-value";

1146 *
MESSAGE
 = "HLEN simpleest";

1147 
»disR•ly
 * 
»¶y
 = 
NULL
;

1148 
hash_Ën
, 
j
;

1150 
hash_Ën
 = 51;

1151 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1152 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1153 
”rÜ
;

1155 
	`ä“R•lyObjeù
(
»¶y
);

1156 
j
 = 0; j < 
hash_Ën
; j ++) {

1157 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 
j
, 
v®ue
);

1158 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1159 
»¶y
->
š‹g”
 != 1) {

1160 
”rÜ
;

1162 
	`ä“R•lyObjeù
(
»¶y
);

1164 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hËÀ%s", 
key
);

1165 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1166 
»¶y
->
š‹g”
 !ğ
hash_Ën
) {

1167 
”rÜ
;

1169 
	`ä“R•lyObjeù
(
»¶y
);

1171 
hash_Ën
 = 5111;

1172 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1173 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1174 
”rÜ
;

1176 
	`ä“R•lyObjeù
(
»¶y
);

1177 
j
 = 0; j < 
hash_Ën
; j ++) {

1178 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 
j
, 
v®ue
);

1179 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1180 
»¶y
->
š‹g”
 != 1) {

1181 
”rÜ
;

1183 
	`ä“R•lyObjeù
(
»¶y
);

1185 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hËÀ%s", 
key
);

1186 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1187 
»¶y
->
š‹g”
 !ğ
hash_Ën
) {

1188 
”rÜ
;

1190 
	`ä“R•lyObjeù
(
»¶y
);

1192 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1196 
”rÜ
:

1198 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1200 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1201 
”rmsg
[0] = '\0';

1204 
	}
}

1206 
	$sim¶e_‹¡_cmd_hd–
(
vœe_š¡ªû
 *
vi
)

1208 *
key
 = "test_cmd_hdel-key";

1209 *
f›ld
 = "test_cmd_hdel-field";

1210 *
v®ue
 = "test_cmd_hdel-value";

1211 *
MESSAGE
 = "HDEL simpleest";

1212 
»disR•ly
 * 
»¶y
 = 
NULL
;

1213 
‹¡_hash_memb”
 **
thms
 = 
NULL
;

1214 
idx
;

1216 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "d– %s", 
key
);

1217 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1218 
”rÜ
;

1220 
	`ä“R•lyObjeù
(
»¶y
);

1222 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 1, 
v®ue
);

1223 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1224 
»¶y
->
š‹g”
 != 1) {

1225 
”rÜ
;

1227 
	`ä“R•lyObjeù
(
»¶y
);

1228 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "h£ˆ% %s%d %s", 
key
, 
f›ld
, 2, 
v®ue
);

1229 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1230 
»¶y
->
š‹g”
 != 1) {

1231 
”rÜ
;

1233 
	`ä“R•lyObjeù
(
»¶y
);

1235 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s%d", 
key
, 
f›ld
, 1);

1236 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

1237 
»¶y
->
Ën
 !ğ
	`¡¾’
(
v®ue
è|| 
	`¡rcmp
Ô•ly->
¡r
, value)) {

1238 
”rÜ
;

1240 
	`ä“R•lyObjeù
(
»¶y
);

1241 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hd– % %s%d", 
key
, 
f›ld
, 1);

1242 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1243 
»¶y
->
š‹g”
 != 1) {

1244 
”rÜ
;

1246 
	`ä“R•lyObjeù
(
»¶y
);

1247 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s%d", 
key
, 
f›ld
, 1);

1248 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_NIL
) {

1249 
”rÜ
;

1251 
	`ä“R•lyObjeù
(
»¶y
);

1253 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hd– % %s%d", 
key
, 
f›ld
, 2);

1254 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1255 
»¶y
->
š‹g”
 != 1) {

1256 
”rÜ
;

1258 
	`ä“R•lyObjeù
(
»¶y
);

1259 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "exi¡ %s", 
key
);

1260 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1261 
»¶y
->
š‹g”
 != 0) {

1262 
”rÜ
;

1264 
	`ä“R•lyObjeù
(
»¶y
);

1266 
thms
 = 
	`sim¶e_‹¡_hash_š™
(
vi
,
key
,
TEST_HASH_ENCODED_HT
,
TEST_HASH_ENCODED_CAUSED_BY_FILED
);

1267 ià(
thms
 =ğ
NULL
) {

1268 
”rÜ
;

1270 
idx
 = 
	`‹¡_hash_memb”_Ëngth
(
thms
)/2;

1271 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hd– % %s", 
key
, 
thms
[
idx
]->
f›ld
);

1272 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

1273 
»¶y
->
š‹g”
 != 1) {

1274 
”rÜ
;

1276 
	`ä“R•lyObjeù
(
»¶y
);

1277 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "hg‘ % %s", 
key
, 
thms
[
idx
]->
f›ld
);

1278 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_NIL
) {

1279 
”rÜ
;

1281 
	`ä“R•lyObjeù
(
»¶y
);

1282 
	`‹¡_hash_memb”s_de¡roy
(
thms
);

1284 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1288 
”rÜ
:

1290 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1291 ià(
thms
è
	`‹¡_hash_memb”s_de¡roy
(thms);

1293 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1294 
”rmsg
[0] = '\0';

1297 
	}
}

1299 
	$sim¶e_‹¡_cmd_pçdd_pfcouÁ
(
vœe_š¡ªû
 *
vi
)

1301 *
key
 = "test_cmd_pfadd_pfcount-key";

1302 *
v®ue
 = "test_cmd_pfadd_pfcount-value";

1303 *
MESSAGE
 = "PFADD/PFCOUNT simpleest";

1304 
»disR•ly
 * 
»¶y
 = 
NULL
;

1305 
n
 = 0, 
couÁ
 = 20329, 
»³©
;

1307 
»³©
 < 2) {

1308 
ex³ù_couÁ
;

1309 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "pçdd % %s%d", 
key
, 
v®ue
, 
n
++);

1310 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

1311 
”rÜ
;

1313 
	`ä“R•lyObjeù
(
»¶y
);

1314 ià(
n
 >ğ
couÁ
) {

1315 
»³©
++;

1316 
n
 = 0;

1319 ià(
»³©
 == 0) {

1320 
ex³ù_couÁ
 = 
n
;

1322 
ex³ù_couÁ
 = 
couÁ
;

1325 
»¶y
 = 
	`»disCommªd
(
vi
->
ùx
, "pfcouÁ %s", 
key
);

1326 ià(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

1327 
”rÜ
;

1329 ià(
»¶y
->
š‹g”
 !ğ()
ex³ù_couÁ
) {

1330 
mi¡ake
 = (()
ex³ù_couÁ
-()
»¶y
->
š‹g”
)/()expect_count;

1331 ià(
mi¡ake
 < -0.02 || mistake > 0.02) {

1332 
	`v¹_sú´štf
(
”rmsg
, 
LOG_MAX_LEN
, "pfadd %d differentƒlements is‚ot‡pproximated…fcount„eturned %lld, mistake %f",

1333 
ex³ù_couÁ
, 
»¶y
->
š‹g”
, 
mi¡ake
);

1334 
”rÜ
;

1337 
	`ä“R•lyObjeù
(
»¶y
);

1340 
	`show_‹¡_»suÉ
(
VRT_TEST_OK
,
MESSAGE
,
”rmsg
);

1344 
”rÜ
:

1346 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1348 
	`show_‹¡_»suÉ
(
VRT_TEST_ERR
,
MESSAGE
,
”rmsg
);

1349 
”rmsg
[0] = '\0';

1352 
	}
}

1354 
	$sim¶e_‹¡
()

1356 
vœe_š¡ªû
 *
vi
;

1357 
ok_couÁ
 = 0, 
®l_couÁ
 = 0;

1359 
vi
 = 
	`¡¬t_Úe_vœe_š¡ªû
();

1360 ià(
vi
 =ğ
NULL
) {

1361 
	`‹¡_log_”rÜ
("Run vire instance failed");

1365 
”rmsg
[0] = '\0';

1368 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘_£t
(
vi
); 
®l_couÁ
++;

1369 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_£Šx
(
vi
); 
®l_couÁ
++;

1370 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_£‹x
(
vi
); 
®l_couÁ
++;

1371 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_p£‹x
(
vi
); 
®l_couÁ
++;

1372 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_šü
(
vi
); 
®l_couÁ
++;

1373 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_deü
(
vi
); 
®l_couÁ
++;

1374 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_šüby
(
vi
); 
®l_couÁ
++;

1375 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_deüby
(
vi
); 
®l_couÁ
++;

1376 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_­³nd
(
vi
); 
®l_couÁ
++;

1377 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_¡¾’
(
vi
); 
®l_couÁ
++;

1378 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘£t
(
vi
); 
®l_couÁ
++;

1379 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_šübyæßt
(
vi
); 
®l_couÁ
++;

1380 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘b™_£tb™_b™couÁ
(
vi
); 
®l_couÁ
++;

1381 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_g‘¿nge_£Œªge
(
vi
); 
®l_couÁ
++;

1382 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_b™pos
(
vi
); 
®l_couÁ
++;

1383 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_mg‘_m£t
(
vi
); 
®l_couÁ
++;

1385 
ok_couÁ
+=
	`sim¶e_‹¡_hash_’code
(
vi
); 
®l_couÁ
++;

1386 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_hg‘_h£t
(
vi
); 
®l_couÁ
++;

1387 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_hËn
(
vi
); 
®l_couÁ
++;

1388 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_hd–
(
vi
); 
®l_couÁ
++;

1390 
ok_couÁ
+=
	`sim¶e_‹¡_cmd_pçdd_pfcouÁ
(
vi
); 
®l_couÁ
++;

1392 
	`vœe_š¡ªû_de¡roy
(
vi
);

1394  
ok_couÁ
==
®l_couÁ
?1:0;

1395 
	}
}

	@tests/vrt_simple.h

1 #iâdeà
_VRT_SIMPLE_H_


2 
	#_VRT_SIMPLE_H_


	)

4 
sim¶e_‹¡
();

	@tests/vrt_simple.h

1 #iâdeà
_VRT_SIMPLE_H_


2 
	#_VRT_SIMPLE_H_


	)

4 
sim¶e_‹¡
();

	@tests/vrt_util.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<”ºo.h
>

5 
	~<fú.h
>

6 
	~<uni¡d.h
>

7 
	~<dœ’t.h
>

8 
	~<¡ršg.h
>

9 
	~<ùy³.h
>

10 
	~<lim™s.h
>

11 
	~<sys/¡©.h
>

12 
	~<sys/ty³s.h
>

14 
	~<hœedis.h
>

16 
	~<v¹_ut.h
>

19 
	$v¹_as£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
)

21 
	`‹¡_log_”rÜ
("as£¹ '%s' faed @ (%s, %d)", 
cÚd
, 
fe
, 
lše
);

22 ià(
·nic
) {

23 
	`abÜt
();

25 
	}
}

28 
	$v¹_vsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
)

30 
n
;

32 
n
 = 
	`v¢´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

44 ià(
n
 <= 0) {

48 ià(
n
 < (è
size
) {

49  
n
;

52  ()(
size
 - 1);

53 
	}
}

56 
	$v¹_sú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...)

58 
va_li¡
 
¬gs
;

59 
n
;

61 
	`va_¡¬t
(
¬gs
, 
fmt
);

62 
n
 = 
	`v¹_vsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

63 
	`va_’d
(
¬gs
);

65  
n
;

66 
	}
}

69 
	$_‹¡_log_”rÜ
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
fmt
, ...)

71 
Ën
, 
size
, 
”ºo_§ve
;

72 
buf
[
LOG_MAX_LEN
];

73 
va_li¡
 
¬gs
;

75 
”ºo_§ve
 = 
”ºo
;

76 
Ën
 = 0;

77 
size
 = 
LOG_MAX_LEN
;

79 
Ën
 +ğ
	`v¹_sú´štf
(
buf
 +†’, 
size
 -†’, "%s:%d ", 
fe
, 
lše
);

81 
	`va_¡¬t
(
¬gs
, 
fmt
);

82 
Ën
 +ğ
	`v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

83 
	`va_’d
(
¬gs
);

85 
buf
[
Ën
++] = '\n';

87 
	`wr™e
(
STDERR_FILENO
, 
buf
, 
Ën
);

89 
”ºo
 = 
”ºo_§ve
;

90 
	}
}

93 
	$_‹¡_log_out
(cÚ¡ *
fmt
, ...)

95 
Ën
, 
size
, 
”ºo_§ve
;

96 
buf
[
LOG_MAX_LEN
];

97 
va_li¡
 
¬gs
;

99 
”ºo_§ve
 = 
”ºo
;

100 
Ën
 = 0;

101 
size
 = 
LOG_MAX_LEN
;

103 
	`va_¡¬t
(
¬gs
, 
fmt
);

104 
Ën
 +ğ
	`v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

105 
	`va_’d
(
¬gs
);

107 
buf
[
Ën
++] = '\n';

109 
	`wr™e
(
STDOUT_FILENO
, 
buf
, 
Ën
);

111 
”ºo
 = 
”ºo_§ve
;

112 
	}
}

117 
št64_t


118 
	$v¹_u£c_now
()

120 
timev®
 
now
;

121 
št64_t
 
u£c
;

122 
¡©us
;

124 
¡©us
 = 
	`g‘timeofday
(&
now
, 
NULL
);

125 ià(
¡©us
 < 0) {

129 
u£c
 = (
št64_t
)
now
.
tv_£c
 * 1000000LL + (št64_têow.
tv_u£c
;

131  
u£c
;

132 
	}
}

137 
št64_t


138 
	$v¹_m£c_now
()

140  
	`v¹_u£c_now
() / 1000LL;

141 
	}
}

146 
št64_t


147 
	$v¹_£c_now
()

149  
	`v¹_u£c_now
() / 1000000LL;

150 
	}
}

159 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

160 
cwd
[1024];

161 
sds
 
ab¥©h
;

162 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

164 
	`sd¡rim
(
»Í©h
," \r\n\t");

165 ià(
»Í©h
[0] == '/') „elpath;

168 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

169 
	`sdsä“
(
»Í©h
);

170  
NULL
;

172 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

173 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

174 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

182 
	`sd¦’
(
»Í©h
) >= 3 &&

183 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

185 
	`sd¤ªge
(
»Í©h
,3,-1);

186 ià(
	`sd¦’
(
ab¥©h
) > 1) {

187 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

188 
ŒimËn
 = 1;

190 *
p
 != '/') {

191 
p
--;

192 
ŒimËn
++;

194 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

199 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

200 
	`sdsä“
(
»Í©h
);

201  
ab¥©h
;

202 
	}
}

206 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

207 ià(
v
 < 10)  1;

208 ià(
v
 < 100)  2;

209 ià(
v
 < 1000)  3;

210 ià(
v
 < 1000000000000UL) {

211 ià(
v
 < 100000000UL) {

212 ià(
v
 < 1000000) {

213 ià(
v
 < 10000)  4;

214  5 + (
v
 >= 100000);

216  7 + (
v
 >= 10000000UL);

218 ià(
v
 < 10000000000UL) {

219  9 + (
v
 >= 1000000000UL);

221  11 + (
v
 >= 100000000000UL);

223  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

224 
	}
}

227 
ušt32_t
 
	$sdig™s10
(
št64_t
 
v
) {

228 ià(
v
 < 0) {

230 
ušt64_t
 
uv
 = (
v
 !ğ
LLONG_MIN
) ?

231 (
ušt64_t
)-
v
 : ((ušt64_tè
LLONG_MAX
)+1;

232  
	`dig™s10
(
uv
)+1;

234  
	`dig™s10
(
v
);

236 
	}
}

249 
	$Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

250 cÚ¡ 
dig™s
[201] =

256 
Ãg©ive
;

257 
v®ue
;

261 ià(
sv®ue
 < 0) {

262 ià(
sv®ue
 !ğ
LLONG_MIN
) {

263 
v®ue
 = -
sv®ue
;

265 
v®ue
 = ((è
LLONG_MAX
)+1;

267 
Ãg©ive
 = 1;

269 
v®ue
 = 
sv®ue
;

270 
Ãg©ive
 = 0;

274 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

275 ià(
Ëngth
 >ğ
d¡Ën
)  0;

278 
ušt32_t
 
Ãxt
 = 
Ëngth
;

279 
d¡
[
Ãxt
] = '\0';

280 
Ãxt
--;

281 
v®ue
 >= 100) {

282 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

283 
v®ue
 /= 100;

284 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

285 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

286 
Ãxt
 -= 2;

290 ià(
v®ue
 < 10) {

291 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

293 
i
 = (
ušt32_t
è
v®ue
 * 2;

294 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

295 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

299 ià(
Ãg©ive
è
d¡
[0] = '-';

300  
Ëngth
;

301 
	}
}

306 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

307 cÚ¡ *
p
 = 
s
;

308 
size_t
 
¶’
 = 0;

309 
Ãg©ive
 = 0;

310 
v
;

312 ià(
¶’
 =ğ
¦’
)

316 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

317 ià(
v®ue
 !ğ
NULL
) *value = 0;

321 ià(
p
[0] == '-') {

322 
Ãg©ive
 = 1;

323 
p
++; 
¶’
++;

326 ià(
¶’
 =ğ
¦’
)

331 ià(
p
[0] >= '1' &&…[0] <= '9') {

332 
v
 = 
p
[0]-'0';

333 
p
++; 
¶’
++;

334 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

335 *
v®ue
 = 0;

341 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

342 ià(
v
 > (
ULLONG_MAX
 / 10))

344 
v
 *= 10;

346 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

348 
v
 +ğ
p
[0]-'0';

350 
p
++; 
¶’
++;

354 ià(
¶’
 < 
¦’
)

357 ià(
Ãg©ive
) {

358 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

360 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

362 ià(
v
 > 
LLONG_MAX
)

364 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

367 
	}
}

372 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

373 
Îv®
;

375 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

378 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

381 *
lv®
 = ()
Îv®
;

383 
	}
}

387 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

388 ià(
	`i¢ª
(
v®ue
)) {

389 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

390 } ià(
	`isšf
(
v®ue
)) {

391 ià(
v®ue
 < 0)

392 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

394 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

395 } ià(
v®ue
 == 0) {

397 ià(1.0/
v®ue
 < 0)

398 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

400 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

402 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

412 
mš
 = -4503599627370495;

413 
max
 = 4503599627370496;

414 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

415 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

418 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

421  
Ën
;

422 
	}
}

424 
	$ü—‹_dœ
(*
·th
)

426 ià(
	`mkdœ
(
·th
,0755) < 0) {

427  
VRT_ERROR
;

430  
VRT_OK
;

431 
	}
}

433 
	$de¡roy_dœ
(*
·th
)

435 
DIR
 *
dp
;

436 
dœ’t
 *
’Œy
;

437 
¡©
 
¡©buf
;

438 
cwd
[1024];

440 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

441  
VRT_ERROR
;

444 ià((
dp
 = 
	`İ’dœ
(
·th
)è=ğ
NULL
) {

445 
	`‹¡_log_”rÜ
("Cª'ˆİ’ dœ: %s", 
·th
);

446  
VRT_ERROR
;

449 
	`chdœ
 (
·th
);

450 (
’Œy
 = 
	`»addœ
(
dp
)è!ğ
NULL
) {

451 
	`l¡©
(
’Œy
->
d_Çme
, &
¡©buf
);

452 ià(
S_IFDIR
 & 
¡©buf
.
¡_mode
) {

453 ià(
	`¡rcmp
(".", 
’Œy
->
d_Çme
) == 0 || strcmp("..",ƒntry->d_name) == 0)

456 
	`de¡roy_dœ
(
’Œy
->
d_Çme
);

458 
	`»move
(
’Œy
->
d_Çme
);

462 
	`chdœ
(
cwd
);

463 
	`şo£dœ
(
dp
);

465 
	`»move
(
·th
);

466  
VRT_OK
;

467 
	}
}

469 
	$g‘_pid_äom_»¶y
(
»disCÚ‹xt
 *
»disùx
, *
ho¡
, 
pÜt
)

471 
»disCÚ‹xt
 *
ùx
 = 
»disùx
;

472 
»disR•ly
 * 
»¶y
;

473 
sds
 *
lšes
;

474 
size_t
 
lše_Ën
;

475 
couÁ
, 
j
;

476 
pid
 = -1;

478 ià(
ùx
 =ğ
NULL
) {

479 
ùx
 = 
	`»disCÚÃù
(
ho¡
,
pÜt
);

482 ià(
ùx
 =ğ
NULL
) {

483 
	`‹¡_log_”rÜ
("G‘…id from in¡ªû faed: cª'ˆcÚÃùØ%s:%d",
ho¡
,
pÜt
);

487 
»¶y
 = 
	`»disCommªd
(
ùx
, "info server");

488 ià(
»¶y
 =ğ
NULL
) {

489 
	`‹¡_log_”rÜ
("Execute 'info server' command on vire failed: %s\n",

490 
ùx
->
”r
?ùx->
”r¡r
:"");

491 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

495 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

496 
	`‹¡_log_”rÜ
("Reply for 'info server' command from vireype %d isƒrror",

497 
»¶y
->
ty³
);

498 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

499 
	`ä“R•lyObjeù
(
»¶y
);

503 
lšes
 = 
	`sds¥l™Ën
(
»¶y
->
¡r
,»¶y->
Ën
,"\r\n",2,&
couÁ
);

504 ià(
lšes
 =ğ
NULL
) {

505 
	`‹¡_log_”rÜ
("Reply for 'info server' command from vire isƒrror");

506 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

507 
	`ä“R•lyObjeù
(
»¶y
);

511 
j
 = 0; j < 
couÁ
; j ++) {

512 
lše_Ën
 = 
	`sd¦’
(
lšes
[
j
]);

513 ià(
lše_Ën
 > 11 && !
	`¡ºcmp
("´oûss_id", 
lšes
[
j
], 10)) {

514 ià(
	`¡ršg2l
(
lšes
[
j
]+11,
lše_Ën
-11,&
pid
) == 0) {

515 
	`‹¡_log_”rÜ
("Convert…id string %.*so†ong failed",

516 
lše_Ën
-11,
lšes
[
j
]+11);

517 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

518 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

519 
	`ä“R•lyObjeù
(
»¶y
);

526 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

527 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

528 
	`ä“R•lyObjeù
(
»¶y
);

530  
pid
;

531 
	}
}

535 *
	$g‘_¿nge_äom_¡ršg
(*
¡r
, 
size_t
 
Ën
, *
couÁ
)

537 
–em_couÁ
;

538 
sds
 *
–ems
;

539 
v®ue
;

540 *
¿nge
;

542 
–ems
 = 
	`sds¥l™Ën
(
İrg
,
	`¡¾’
(İrg),"-",1,&
–em_couÁ
);

543 ià(
–ems
 =ğ
NULL
) {

544 
”rÜ
;

545 } ià(
–em_couÁ
 <= 0 ||ƒlem_count >= 3) {

546 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

547 
”rÜ
;

550 ià(
–em_couÁ
 == 1) {

551 ià(
	`¡ršg2Î
(
–ems
[0],
	`sd¦’
ÓËms[0]),&
v®ue
) != 1) {

552 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

553 
”rÜ
;

556 
¿nge
 = 
	`m®loc
(1*(*range));

557 
¿nge
[0] = 
v®ue
;

558 *
couÁ
 = 1;

559 } ià(
–em_couÁ
 == 2) {

560 ià(
	`¡ršg2Î
(
–ems
[0],
	`sd¦’
ÓËms[0]),&
v®ue
) != 1) {

561 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

562 
”rÜ
;

565 
¿nge
 = 
	`m®loc
(2*(*range));

566 
¿nge
[0] = 
v®ue
;

568 ià(
	`¡ršg2Î
(
–ems
[1],
	`sd¦’
ÓËms[1]),&
v®ue
) != 1) {

569 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

570 
	`ä“
(
¿nge
);

571 
”rÜ
;

574 
¿nge
[1] = 
v®ue
;

575 *
couÁ
 = 2;

577 ià(
¿nge
[0] >„ange[1]) {

578 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

579 
	`ä“
(
¿nge
);

580 
”rÜ
;

584 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

586  
¿nge
;

588 
”rÜ
:

590 *
couÁ
 = -1;

591  
NULL
;

592 
	}
}

594 
sds
 
	$g‘_ho¡_pÜt_äom_add»ss_¡ršg
(*
add»ss
, *
pÜt
)

596 
sds
 *
ho¡_pÜt
;

597 
couÁ
 = 0;

598 
sds
 
ho¡
;

599 
v®ue
;

601 *
pÜt
 = 0;

603 
ho¡_pÜt
 = 
	`sds¥l™Ën
(
add»ss
,
	`¡¾’
×dd»ss),":",1,&
couÁ
);

604 ià(
ho¡_pÜt
 =ğ
NULL
) {

605  
NULL
;

606 } ià(
couÁ
 != 2) {

607 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

608  
NULL
;

611 ià(
	`¡ršg2l
(
ho¡_pÜt
[1],
	`sd¦’
(ho¡_pÜt[1]),&
v®ue
) != 1 ||

612 
v®ue
 <= 0 || value >= 65535) {

613 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

614  
NULL
;

617 *
pÜt
 = ()
v®ue
;

618 
ho¡
 = 
ho¡_pÜt
[0];

619 
ho¡_pÜt
[0] = 
NULL
;

620 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

622  
ho¡
;

623 
	}
}

	@tests/vrt_util.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<”ºo.h
>

5 
	~<fú.h
>

6 
	~<uni¡d.h
>

7 
	~<dœ’t.h
>

8 
	~<¡ršg.h
>

9 
	~<ùy³.h
>

10 
	~<lim™s.h
>

11 
	~<sys/¡©.h
>

12 
	~<sys/ty³s.h
>

14 
	~<hœedis.h
>

16 
	~<v¹_ut.h
>

19 
	$v¹_as£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
)

21 
	`‹¡_log_”rÜ
("as£¹ '%s' faed @ (%s, %d)", 
cÚd
, 
fe
, 
lše
);

22 ià(
·nic
) {

23 
	`abÜt
();

25 
	}
}

28 
	$v¹_vsú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
)

30 
n
;

32 
n
 = 
	`v¢´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

44 ià(
n
 <= 0) {

48 ià(
n
 < (è
size
) {

49  
n
;

52  ()(
size
 - 1);

53 
	}
}

56 
	$v¹_sú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...)

58 
va_li¡
 
¬gs
;

59 
n
;

61 
	`va_¡¬t
(
¬gs
, 
fmt
);

62 
n
 = 
	`v¹_vsú´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

63 
	`va_’d
(
¬gs
);

65  
n
;

66 
	}
}

69 
	$_‹¡_log_”rÜ
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
fmt
, ...)

71 
Ën
, 
size
, 
”ºo_§ve
;

72 
buf
[
LOG_MAX_LEN
];

73 
va_li¡
 
¬gs
;

75 
”ºo_§ve
 = 
”ºo
;

76 
Ën
 = 0;

77 
size
 = 
LOG_MAX_LEN
;

79 
Ën
 +ğ
	`v¹_sú´štf
(
buf
 +†’, 
size
 -†’, "%s:%d ", 
fe
, 
lše
);

81 
	`va_¡¬t
(
¬gs
, 
fmt
);

82 
Ën
 +ğ
	`v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

83 
	`va_’d
(
¬gs
);

85 
buf
[
Ën
++] = '\n';

87 
	`wr™e
(
STDERR_FILENO
, 
buf
, 
Ën
);

89 
”ºo
 = 
”ºo_§ve
;

90 
	}
}

93 
	$_‹¡_log_out
(cÚ¡ *
fmt
, ...)

95 
Ën
, 
size
, 
”ºo_§ve
;

96 
buf
[
LOG_MAX_LEN
];

97 
va_li¡
 
¬gs
;

99 
”ºo_§ve
 = 
”ºo
;

100 
Ën
 = 0;

101 
size
 = 
LOG_MAX_LEN
;

103 
	`va_¡¬t
(
¬gs
, 
fmt
);

104 
Ën
 +ğ
	`v¢´štf
(
buf
 +†’, 
size
 -†’, 
fmt
, 
¬gs
);

105 
	`va_’d
(
¬gs
);

107 
buf
[
Ën
++] = '\n';

109 
	`wr™e
(
STDOUT_FILENO
, 
buf
, 
Ën
);

111 
”ºo
 = 
”ºo_§ve
;

112 
	}
}

117 
št64_t


118 
	$v¹_u£c_now
()

120 
timev®
 
now
;

121 
št64_t
 
u£c
;

122 
¡©us
;

124 
¡©us
 = 
	`g‘timeofday
(&
now
, 
NULL
);

125 ià(
¡©us
 < 0) {

129 
u£c
 = (
št64_t
)
now
.
tv_£c
 * 1000000LL + (št64_têow.
tv_u£c
;

131  
u£c
;

132 
	}
}

137 
št64_t


138 
	$v¹_m£c_now
()

140  
	`v¹_u£c_now
() / 1000LL;

141 
	}
}

146 
št64_t


147 
	$v¹_£c_now
()

149  
	`v¹_u£c_now
() / 1000000LL;

150 
	}
}

159 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

160 
cwd
[1024];

161 
sds
 
ab¥©h
;

162 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

164 
	`sd¡rim
(
»Í©h
," \r\n\t");

165 ià(
»Í©h
[0] == '/') „elpath;

168 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

169 
	`sdsä“
(
»Í©h
);

170  
NULL
;

172 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

173 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

174 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

182 
	`sd¦’
(
»Í©h
) >= 3 &&

183 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

185 
	`sd¤ªge
(
»Í©h
,3,-1);

186 ià(
	`sd¦’
(
ab¥©h
) > 1) {

187 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

188 
ŒimËn
 = 1;

190 *
p
 != '/') {

191 
p
--;

192 
ŒimËn
++;

194 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

199 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

200 
	`sdsä“
(
»Í©h
);

201  
ab¥©h
;

202 
	}
}

206 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

207 ià(
v
 < 10)  1;

208 ià(
v
 < 100)  2;

209 ià(
v
 < 1000)  3;

210 ià(
v
 < 1000000000000UL) {

211 ià(
v
 < 100000000UL) {

212 ià(
v
 < 1000000) {

213 ià(
v
 < 10000)  4;

214  5 + (
v
 >= 100000);

216  7 + (
v
 >= 10000000UL);

218 ià(
v
 < 10000000000UL) {

219  9 + (
v
 >= 1000000000UL);

221  11 + (
v
 >= 100000000000UL);

223  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

224 
	}
}

227 
ušt32_t
 
	$sdig™s10
(
št64_t
 
v
) {

228 ià(
v
 < 0) {

230 
ušt64_t
 
uv
 = (
v
 !ğ
LLONG_MIN
) ?

231 (
ušt64_t
)-
v
 : ((ušt64_tè
LLONG_MAX
)+1;

232  
	`dig™s10
(
uv
)+1;

234  
	`dig™s10
(
v
);

236 
	}
}

249 
	$Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

250 cÚ¡ 
dig™s
[201] =

256 
Ãg©ive
;

257 
v®ue
;

261 ià(
sv®ue
 < 0) {

262 ià(
sv®ue
 !ğ
LLONG_MIN
) {

263 
v®ue
 = -
sv®ue
;

265 
v®ue
 = ((è
LLONG_MAX
)+1;

267 
Ãg©ive
 = 1;

269 
v®ue
 = 
sv®ue
;

270 
Ãg©ive
 = 0;

274 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

275 ià(
Ëngth
 >ğ
d¡Ën
)  0;

278 
ušt32_t
 
Ãxt
 = 
Ëngth
;

279 
d¡
[
Ãxt
] = '\0';

280 
Ãxt
--;

281 
v®ue
 >= 100) {

282 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

283 
v®ue
 /= 100;

284 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

285 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

286 
Ãxt
 -= 2;

290 ià(
v®ue
 < 10) {

291 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

293 
i
 = (
ušt32_t
è
v®ue
 * 2;

294 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

295 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

299 ià(
Ãg©ive
è
d¡
[0] = '-';

300  
Ëngth
;

301 
	}
}

306 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

307 cÚ¡ *
p
 = 
s
;

308 
size_t
 
¶’
 = 0;

309 
Ãg©ive
 = 0;

310 
v
;

312 ià(
¶’
 =ğ
¦’
)

316 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

317 ià(
v®ue
 !ğ
NULL
) *value = 0;

321 ià(
p
[0] == '-') {

322 
Ãg©ive
 = 1;

323 
p
++; 
¶’
++;

326 ià(
¶’
 =ğ
¦’
)

331 ià(
p
[0] >= '1' &&…[0] <= '9') {

332 
v
 = 
p
[0]-'0';

333 
p
++; 
¶’
++;

334 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

335 *
v®ue
 = 0;

341 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

342 ià(
v
 > (
ULLONG_MAX
 / 10))

344 
v
 *= 10;

346 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

348 
v
 +ğ
p
[0]-'0';

350 
p
++; 
¶’
++;

354 ià(
¶’
 < 
¦’
)

357 ià(
Ãg©ive
) {

358 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

360 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

362 ià(
v
 > 
LLONG_MAX
)

364 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

367 
	}
}

372 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

373 
Îv®
;

375 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

378 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

381 *
lv®
 = ()
Îv®
;

383 
	}
}

387 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

388 ià(
	`i¢ª
(
v®ue
)) {

389 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

390 } ià(
	`isšf
(
v®ue
)) {

391 ià(
v®ue
 < 0)

392 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

394 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

395 } ià(
v®ue
 == 0) {

397 ià(1.0/
v®ue
 < 0)

398 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

400 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

402 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

412 
mš
 = -4503599627370495;

413 
max
 = 4503599627370496;

414 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

415 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

418 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

421  
Ën
;

422 
	}
}

424 
	$ü—‹_dœ
(*
·th
)

426 ià(
	`mkdœ
(
·th
,0755) < 0) {

427  
VRT_ERROR
;

430  
VRT_OK
;

431 
	}
}

433 
	$de¡roy_dœ
(*
·th
)

435 
DIR
 *
dp
;

436 
dœ’t
 *
’Œy
;

437 
¡©
 
¡©buf
;

438 
cwd
[1024];

440 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

441  
VRT_ERROR
;

444 ià((
dp
 = 
	`İ’dœ
(
·th
)è=ğ
NULL
) {

445 
	`‹¡_log_”rÜ
("Cª'ˆİ’ dœ: %s", 
·th
);

446  
VRT_ERROR
;

449 
	`chdœ
 (
·th
);

450 (
’Œy
 = 
	`»addœ
(
dp
)è!ğ
NULL
) {

451 
	`l¡©
(
’Œy
->
d_Çme
, &
¡©buf
);

452 ià(
S_IFDIR
 & 
¡©buf
.
¡_mode
) {

453 ià(
	`¡rcmp
(".", 
’Œy
->
d_Çme
) == 0 || strcmp("..",ƒntry->d_name) == 0)

456 
	`de¡roy_dœ
(
’Œy
->
d_Çme
);

458 
	`»move
(
’Œy
->
d_Çme
);

462 
	`chdœ
(
cwd
);

463 
	`şo£dœ
(
dp
);

465 
	`»move
(
·th
);

466  
VRT_OK
;

467 
	}
}

469 
	$g‘_pid_äom_»¶y
(
»disCÚ‹xt
 *
»disùx
, *
ho¡
, 
pÜt
)

471 
»disCÚ‹xt
 *
ùx
 = 
»disùx
;

472 
»disR•ly
 * 
»¶y
;

473 
sds
 *
lšes
;

474 
size_t
 
lše_Ën
;

475 
couÁ
, 
j
;

476 
pid
 = -1;

478 ià(
ùx
 =ğ
NULL
) {

479 
ùx
 = 
	`»disCÚÃù
(
ho¡
,
pÜt
);

482 ià(
ùx
 =ğ
NULL
) {

483 
	`‹¡_log_”rÜ
("G‘…id from in¡ªû faed: cª'ˆcÚÃùØ%s:%d",
ho¡
,
pÜt
);

487 
»¶y
 = 
	`»disCommªd
(
ùx
, "info server");

488 ià(
»¶y
 =ğ
NULL
) {

489 
	`‹¡_log_”rÜ
("Execute 'info server' command on vire failed: %s\n",

490 
ùx
->
”r
?ùx->
”r¡r
:"");

491 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

495 ià(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STRING
) {

496 
	`‹¡_log_”rÜ
("Reply for 'info server' command from vireype %d isƒrror",

497 
»¶y
->
ty³
);

498 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

499 
	`ä“R•lyObjeù
(
»¶y
);

503 
lšes
 = 
	`sds¥l™Ën
(
»¶y
->
¡r
,»¶y->
Ën
,"\r\n",2,&
couÁ
);

504 ià(
lšes
 =ğ
NULL
) {

505 
	`‹¡_log_”rÜ
("Reply for 'info server' command from vire isƒrror");

506 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

507 
	`ä“R•lyObjeù
(
»¶y
);

511 
j
 = 0; j < 
couÁ
; j ++) {

512 
lše_Ën
 = 
	`sd¦’
(
lšes
[
j
]);

513 ià(
lše_Ën
 > 11 && !
	`¡ºcmp
("´oûss_id", 
lšes
[
j
], 10)) {

514 ià(
	`¡ršg2l
(
lšes
[
j
]+11,
lše_Ën
-11,&
pid
) == 0) {

515 
	`‹¡_log_”rÜ
("Convert…id string %.*so†ong failed",

516 
lše_Ën
-11,
lšes
[
j
]+11);

517 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

518 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

519 
	`ä“R•lyObjeù
(
»¶y
);

526 
	`sdsä“¥l™»s
(
lšes
,
couÁ
);

527 ià(
»disùx
 =ğ
NULL
è
	`»disF»e
(
ùx
);

528 
	`ä“R•lyObjeù
(
»¶y
);

530  
pid
;

531 
	}
}

535 *
	$g‘_¿nge_äom_¡ršg
(*
¡r
, 
size_t
 
Ën
, *
couÁ
)

537 
–em_couÁ
;

538 
sds
 *
–ems
;

539 
v®ue
;

540 *
¿nge
;

542 
–ems
 = 
	`sds¥l™Ën
(
İrg
,
	`¡¾’
(İrg),"-",1,&
–em_couÁ
);

543 ià(
–ems
 =ğ
NULL
) {

544 
”rÜ
;

545 } ià(
–em_couÁ
 <= 0 ||ƒlem_count >= 3) {

546 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

547 
”rÜ
;

550 ià(
–em_couÁ
 == 1) {

551 ià(
	`¡ršg2Î
(
–ems
[0],
	`sd¦’
ÓËms[0]),&
v®ue
) != 1) {

552 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

553 
”rÜ
;

556 
¿nge
 = 
	`m®loc
(1*(*range));

557 
¿nge
[0] = 
v®ue
;

558 *
couÁ
 = 1;

559 } ià(
–em_couÁ
 == 2) {

560 ià(
	`¡ršg2Î
(
–ems
[0],
	`sd¦’
ÓËms[0]),&
v®ue
) != 1) {

561 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

562 
”rÜ
;

565 
¿nge
 = 
	`m®loc
(2*(*range));

566 
¿nge
[0] = 
v®ue
;

568 ià(
	`¡ršg2Î
(
–ems
[1],
	`sd¦’
ÓËms[1]),&
v®ue
) != 1) {

569 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

570 
	`ä“
(
¿nge
);

571 
”rÜ
;

574 
¿nge
[1] = 
v®ue
;

575 *
couÁ
 = 2;

577 ià(
¿nge
[0] >„ange[1]) {

578 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

579 
	`ä“
(
¿nge
);

580 
”rÜ
;

584 
	`sdsä“¥l™»s
(
–ems
,
–em_couÁ
);

586  
¿nge
;

588 
”rÜ
:

590 *
couÁ
 = -1;

591  
NULL
;

592 
	}
}

594 
sds
 
	$g‘_ho¡_pÜt_äom_add»ss_¡ršg
(*
add»ss
, *
pÜt
)

596 
sds
 *
ho¡_pÜt
;

597 
couÁ
 = 0;

598 
sds
 
ho¡
;

599 
v®ue
;

601 *
pÜt
 = 0;

603 
ho¡_pÜt
 = 
	`sds¥l™Ën
(
add»ss
,
	`¡¾’
×dd»ss),":",1,&
couÁ
);

604 ià(
ho¡_pÜt
 =ğ
NULL
) {

605  
NULL
;

606 } ià(
couÁ
 != 2) {

607 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

608  
NULL
;

611 ià(
	`¡ršg2l
(
ho¡_pÜt
[1],
	`sd¦’
(ho¡_pÜt[1]),&
v®ue
) != 1 ||

612 
v®ue
 <= 0 || value >= 65535) {

613 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

614  
NULL
;

617 *
pÜt
 = ()
v®ue
;

618 
ho¡
 = 
ho¡_pÜt
[0];

619 
ho¡_pÜt
[0] = 
NULL
;

620 
	`sdsä“¥l™»s
(
ho¡_pÜt
,
couÁ
);

622  
ho¡
;

623 
	}
}

	@tests/vrt_util.h

1 #iâdeà
_VRT_UTIL_H_


2 
	#_VRT_UTIL_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 #ifdeà
HAVE_DEBUG_LOG


9 
	#VRT_DEBUG_LOG
 1

	)

12 
	~<d¥ecŸlcÚfig.h
>

14 
	~<sds.h
>

16 
	#VRT_OK
 0

	)

17 
	#VRT_ERROR
 -1

	)

19 
	#VRT_UINT8_MAXLEN
 (3 + 1)

	)

20 
	#VRT_UINT16_MAXLEN
 (5 + 1)

	)

21 
	#VRT_UINT32_MAXLEN
 (10 + 1)

	)

22 
	#VRT_UINT64_MAXLEN
 (20 + 1)

	)

23 
	#VRT_UINTMAX_MAXLEN
 
VRT_UINT64_MAXLEN


	)

25 
	#VRT_MAXHOSTNAMELEN
 256

	)

27 
	#LF
 (
ušt8_t
è10

	)

28 
	#CR
 (
ušt8_t
è13

	)

29 
	#CRLF
 "\x0d\x0a"

	)

30 
	#CRLF_LEN
 (("\x0d\x0a"è- 1)

	)

32 
	#LOG_MAX_LEN
 256

	)

34 
_‹¡_log_”rÜ
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
fmt
, ...);

35 
_‹¡_log_out
(cÚ¡ *
fmt
, ...);

36 #ià
defšed
(
VRT_DEBUG_LOG
)

37 
	#‹¡_log_debug
(...) do { \

38 
	`_‹¡_log_”rÜ
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
); \

39 } 0)

	)

41 
	#‹¡_log_debug
(...)

	)

43 
	#‹¡_log_”rÜ
(...) do { \

44 
	`_‹¡_log_”rÜ
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
); \

45 } 0)

	)

46 
	#‹¡_log_out
(...) do { \

47 
	`_‹¡_log_out
(
__VA_ARGS__
); \

48 } 0)

	)

50 
v¹_as£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
);

52 
	#ASSERT
(
_x
) do { \

53 ià(!(
_x
)) { \

54 
	`v¹_as£¹
(#_x, 
__FILE__
, 
__LINE__
, 1); \

56 } 0)

	)

58 
v¹_sú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...);

60 
št64_t
 
v¹_u£c_now
();

61 
št64_t
 
v¹_m£c_now
();

62 
št64_t
 
v¹_£c_now
();

64 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

66 
Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
);

67 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

68 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
);

69 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

71 
ü—‹_dœ
(*
·th
);

72 
de¡roy_dœ
(*
dœ
);

74 
g‘_pid_äom_»¶y
(
»disCÚ‹xt
 *
»disùx
, *
ho¡
, 
pÜt
);

76 *
g‘_¿nge_äom_¡ršg
(*
¡r
, 
size_t
 
Ën
, *
couÁ
);

78 
sds
 
g‘_ho¡_pÜt_äom_add»ss_¡ršg
(*
add»ss
, *
pÜt
);

	@tests/vrt_util.h

1 #iâdeà
_VRT_UTIL_H_


2 
	#_VRT_UTIL_H_


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~<cÚfig.h
>

8 #ifdeà
HAVE_DEBUG_LOG


9 
	#VRT_DEBUG_LOG
 1

	)

12 
	~<d¥ecŸlcÚfig.h
>

14 
	~<sds.h
>

16 
	#VRT_OK
 0

	)

17 
	#VRT_ERROR
 -1

	)

19 
	#VRT_UINT8_MAXLEN
 (3 + 1)

	)

20 
	#VRT_UINT16_MAXLEN
 (5 + 1)

	)

21 
	#VRT_UINT32_MAXLEN
 (10 + 1)

	)

22 
	#VRT_UINT64_MAXLEN
 (20 + 1)

	)

23 
	#VRT_UINTMAX_MAXLEN
 
VRT_UINT64_MAXLEN


	)

25 
	#VRT_MAXHOSTNAMELEN
 256

	)

27 
	#LF
 (
ušt8_t
è10

	)

28 
	#CR
 (
ušt8_t
è13

	)

29 
	#CRLF
 "\x0d\x0a"

	)

30 
	#CRLF_LEN
 (("\x0d\x0a"è- 1)

	)

32 
	#LOG_MAX_LEN
 256

	)

34 
_‹¡_log_”rÜ
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
fmt
, ...);

35 
_‹¡_log_out
(cÚ¡ *
fmt
, ...);

36 #ià
defšed
(
VRT_DEBUG_LOG
)

37 
	#‹¡_log_debug
(...) do { \

38 
	`_‹¡_log_”rÜ
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
); \

39 } 0)

	)

41 
	#‹¡_log_debug
(...)

	)

43 
	#‹¡_log_”rÜ
(...) do { \

44 
	`_‹¡_log_”rÜ
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
); \

45 } 0)

	)

46 
	#‹¡_log_out
(...) do { \

47 
	`_‹¡_log_out
(
__VA_ARGS__
); \

48 } 0)

	)

50 
v¹_as£¹
(cÚ¡ *
cÚd
, cÚ¡ *
fe
, 
lše
, 
·nic
);

52 
	#ASSERT
(
_x
) do { \

53 ià(!(
_x
)) { \

54 
	`v¹_as£¹
(#_x, 
__FILE__
, 
__LINE__
, 1); \

56 } 0)

	)

58 
v¹_sú´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...);

60 
št64_t
 
v¹_u£c_now
();

61 
št64_t
 
v¹_m£c_now
();

62 
št64_t
 
v¹_£c_now
();

64 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

66 
Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
);

67 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

68 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
);

69 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

71 
ü—‹_dœ
(*
·th
);

72 
de¡roy_dœ
(*
dœ
);

74 
g‘_pid_äom_»¶y
(
»disCÚ‹xt
 *
»disùx
, *
ho¡
, 
pÜt
);

76 *
g‘_¿nge_äom_¡ršg
(*
¡r
, 
size_t
 
Ën
, *
couÁ
);

78 
sds
 
g‘_ho¡_pÜt_äom_add»ss_¡ršg
(*
add»ss
, *
pÜt
);

	@tests/vrtest.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<fú.h
>

5 
	~<”ºo.h
>

6 
	~<sigÇl.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/ut¢ame.h
>

10 
	~<hœedis.h
>

12 
	~<v¹_ut.h
>

13 
	~<v¹_public.h
>

14 
	~<v¹_sim¶e.h
>

16 
	scÚfig
 {

17 *
	mpid_f’ame
;

19 
	mpidfe
;

20 
	mpid
;

23 
cÚfig
 
	gcÚfig
;

25 
	gshow_h–p
;

26 
	gshow_v”siÚ
;

28 
İtiÚ
 
	glÚg_İtiÚs
[] = {

29 { "h–p", 
no_¬gum’t
, 
NULL
, 'h' },

30 { "v”siÚ", 
no_¬gum’t
, 
NULL
, 'V' },

31 { "execu‹-fe", 
»quœed_¬gum’t
, 
NULL
, 'e' },

32 { "pid-fe", 
»quœed_¬gum’t
, 
NULL
, 'p' },

33 { 
NULL
, 0, NULL, 0 }

36 
	gshÜt_İtiÚs
[] = "hVe:p:";

39 
	$vr_show_u§ge
()

41 
	`´štf
(

42 "U§ge: vœ‘e¡ [-?hV] [-execu‹-fe] [-°pid-fe]" 
CRLF


43 "" 
CRLF
);

44 
	`´štf
(

45 "O±iÚs:" 
CRLF


46 " -h, --h–° :hi h–p" 
CRLF


47 " -V, --v”siÚ : show v”siÚ‡ndƒx™" 
CRLF


48 " -e, --execu‹-f : vœexecu‹ fe, deçuÉ i ¤c/vœe" 
CRLF


49 " -p, --pid-f :…id fe" 
CRLF


50 "" 
CRLF
);

51 
	}
}

54 
	$vr_£t_deçuÉ_İtiÚs
()

56 
cÚfig
.
pid_f’ame
 = 
NULL
;

57 
	}
}

60 
	$vr_g‘_İtiÚs
(
¬gc
, **
¬gv
)

62 
c
;

64 
İ‹¼
 = 0;

67 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İtiÚs
, 
lÚg_İtiÚs
, 
NULL
);

68 ià(
c
 == -1) {

73 
c
) {

75 
show_v”siÚ
 = 1;

76 
show_h–p
 = 1;

80 
show_v”siÚ
 = 1;

84 
	`£t_execu‹_fe
(
İrg
);

88 
cÚfig
.
pid_f’ame
 = 
İrg
;

92 
İtİt
) {

95 
	`‹¡_log_”rÜ
("vire: option -%c„equires string",

96 
İtİt
);

100 
	`‹¡_log_”rÜ
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

103  
VRT_ERROR
;

106 
	`‹¡_log_”rÜ
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

107  
VRT_ERROR
;

112  
VRT_OK
;

113 
	}
}

116 
	$maš
(
¬gc
, **
¬gv
)

118 
»t
;

119 
ok_couÁ
 = 0, 
®l_couÁ
 = 0;

121 
	`vr_£t_deçuÉ_İtiÚs
();

123 
»t
 = 
	`vr_g‘_İtiÚs
(
¬gc
, 
¬gv
);

124 ià(
»t
 !ğ
VRT_OK
) {

125 
	`vr_show_u§ge
();

126 
	`ex™
(1);

129 ià(
show_v”siÚ
) {

130 
	`‹¡_log_out
("Thi i vœ‘e¡-%s", 
VR_VERSION_STRING
);

131 ià(
show_h–p
) {

132 
	`vr_show_u§ge
();

134 
	`ex™
(0);

137 
	`ü—‹_wÜk_dœ
();

139 
	`‹¡_log_out
("Te¡šg Vœv”siÚ % \n", 
VR_VERSION_STRING
);

141 
ok_couÁ
+=
	`sim¶e_‹¡
(); 
®l_couÁ
++;

143 
ş—n
:

144 
	`de¡roy_wÜk_dœ
();

146 ià(
ok_couÁ
 =ğ
®l_couÁ
)

147 
	`‹¡_log_out
("\n\\o/ \033[32;1mAllests…assed withoutƒrrors!\033[0m\n");

148  
VRT_OK
;

149 
	}
}

	@tests/vrtest.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<fú.h
>

5 
	~<”ºo.h
>

6 
	~<sigÇl.h
>

7 
	~<sys/¡©.h
>

8 
	~<sys/ut¢ame.h
>

10 
	~<hœedis.h
>

12 
	~<v¹_ut.h
>

13 
	~<v¹_public.h
>

14 
	~<v¹_sim¶e.h
>

16 
	scÚfig
 {

17 *
	mpid_f’ame
;

19 
	mpidfe
;

20 
	mpid
;

23 
cÚfig
 
	gcÚfig
;

25 
	gshow_h–p
;

26 
	gshow_v”siÚ
;

28 
İtiÚ
 
	glÚg_İtiÚs
[] = {

29 { "h–p", 
no_¬gum’t
, 
NULL
, 'h' },

30 { "v”siÚ", 
no_¬gum’t
, 
NULL
, 'V' },

31 { "execu‹-fe", 
»quœed_¬gum’t
, 
NULL
, 'e' },

32 { "pid-fe", 
»quœed_¬gum’t
, 
NULL
, 'p' },

33 { 
NULL
, 0, NULL, 0 }

36 
	gshÜt_İtiÚs
[] = "hVe:p:";

39 
	$vr_show_u§ge
()

41 
	`´štf
(

42 "U§ge: vœ‘e¡ [-?hV] [-execu‹-fe] [-°pid-fe]" 
CRLF


43 "" 
CRLF
);

44 
	`´štf
(

45 "O±iÚs:" 
CRLF


46 " -h, --h–° :hi h–p" 
CRLF


47 " -V, --v”siÚ : show v”siÚ‡ndƒx™" 
CRLF


48 " -e, --execu‹-f : vœexecu‹ fe, deçuÉ i ¤c/vœe" 
CRLF


49 " -p, --pid-f :…id fe" 
CRLF


50 "" 
CRLF
);

51 
	}
}

54 
	$vr_£t_deçuÉ_İtiÚs
()

56 
cÚfig
.
pid_f’ame
 = 
NULL
;

57 
	}
}

60 
	$vr_g‘_İtiÚs
(
¬gc
, **
¬gv
)

62 
c
;

64 
İ‹¼
 = 0;

67 
c
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İtiÚs
, 
lÚg_İtiÚs
, 
NULL
);

68 ià(
c
 == -1) {

73 
c
) {

75 
show_v”siÚ
 = 1;

76 
show_h–p
 = 1;

80 
show_v”siÚ
 = 1;

84 
	`£t_execu‹_fe
(
İrg
);

88 
cÚfig
.
pid_f’ame
 = 
İrg
;

92 
İtİt
) {

95 
	`‹¡_log_”rÜ
("vire: option -%c„equires string",

96 
İtİt
);

100 
	`‹¡_log_”rÜ
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

103  
VRT_ERROR
;

106 
	`‹¡_log_”rÜ
("vœe: inv®id o±iÚ -- '%c'", 
İtİt
);

107  
VRT_ERROR
;

112  
VRT_OK
;

113 
	}
}

116 
	$maš
(
¬gc
, **
¬gv
)

118 
»t
;

119 
ok_couÁ
 = 0, 
®l_couÁ
 = 0;

121 
	`vr_£t_deçuÉ_İtiÚs
();

123 
»t
 = 
	`vr_g‘_İtiÚs
(
¬gc
, 
¬gv
);

124 ià(
»t
 !ğ
VRT_OK
) {

125 
	`vr_show_u§ge
();

126 
	`ex™
(1);

129 ià(
show_v”siÚ
) {

130 
	`‹¡_log_out
("Thi i vœ‘e¡-%s", 
VR_VERSION_STRING
);

131 ià(
show_h–p
) {

132 
	`vr_show_u§ge
();

134 
	`ex™
(0);

137 
	`ü—‹_wÜk_dœ
();

139 
	`‹¡_log_out
("Te¡šg Vœv”siÚ % \n", 
VR_VERSION_STRING
);

141 
ok_couÁ
+=
	`sim¶e_‹¡
(); 
®l_couÁ
++;

143 
ş—n
:

144 
	`de¡roy_wÜk_dœ
();

146 ià(
ok_couÁ
 =ğ
®l_couÁ
)

147 
	`‹¡_log_out
("\n\\o/ \033[32;1mAllests…assed withoutƒrrors!\033[0m\n");

148  
VRT_OK
;

149 
	}
}

	@
1
.
0
495
14297
config.h
dep/ae/ae.c
dep/ae/ae.c
dep/ae/ae.h
dep/ae/ae.h
dep/ae/ae_epoll.c
dep/ae/ae_epoll.c
dep/ae/ae_evport.c
dep/ae/ae_evport.c
dep/ae/ae_kqueue.c
dep/ae/ae_kqueue.c
dep/ae/ae_select.c
dep/ae/ae_select.c
dep/darray/darray.c
dep/darray/darray.c
dep/darray/darray.h
dep/darray/darray.h
dep/dhashkit/dcrc16.c
dep/dhashkit/dcrc16.c
dep/dhashkit/dcrc32.c
dep/dhashkit/dcrc32.c
dep/dhashkit/dfnv.c
dep/dhashkit/dfnv.c
dep/dhashkit/dhashkit.h
dep/dhashkit/dhashkit.h
dep/dhashkit/dhsieh.c
dep/dhashkit/dhsieh.c
dep/dhashkit/djenkins.c
dep/dhashkit/djenkins.c
dep/dhashkit/dketama.c
dep/dhashkit/dketama.c
dep/dhashkit/dmd5.c
dep/dhashkit/dmd5.c
dep/dhashkit/dmodula.c
dep/dhashkit/dmodula.c
dep/dhashkit/dmurmur.c
dep/dhashkit/dmurmur.c
dep/dhashkit/done_at_a_time.c
dep/dhashkit/done_at_a_time.c
dep/dhashkit/drandom.c
dep/dhashkit/drandom.c
dep/dhashkit/dsha1.c
dep/dhashkit/dsha1.c
dep/dlist/dlist.c
dep/dlist/dlist.c
dep/dlist/dlist.h
dep/dlist/dlist.h
dep/dlist/dlockqueue.c
dep/dlist/dlockqueue.c
dep/dlist/dlockqueue.h
dep/dlist/dlockqueue.h
dep/dlist/dmtqueue.c
dep/dlist/dmtqueue.c
dep/dlist/dmtqueue.h
dep/dlist/dmtqueue.h
dep/dmalloc/dmalloc.c
dep/dmalloc/dmalloc.c
dep/dmalloc/dmalloc.h
dep/dmalloc/dmalloc.h
dep/himemcached-0.1.0/himcdep/sds.c
dep/himemcached-0.1.0/himcdep/sds.c
dep/himemcached-0.1.0/himcdep/sds.h
dep/himemcached-0.1.0/himcdep/sds.h
dep/himemcached-0.1.0/himcread.c
dep/himemcached-0.1.0/himcread.c
dep/himemcached-0.1.0/himcread.h
dep/himemcached-0.1.0/himcread.h
dep/himemcached-0.1.0/himemcached.c
dep/himemcached-0.1.0/himemcached.c
dep/himemcached-0.1.0/himemcached.h
dep/himemcached-0.1.0/himemcached.h
dep/hiredis-0.13.3/adapters/ae.h
dep/hiredis-0.13.3/adapters/glib.h
dep/hiredis-0.13.3/adapters/ivykis.h
dep/hiredis-0.13.3/adapters/libev.h
dep/hiredis-0.13.3/adapters/libevent.h
dep/hiredis-0.13.3/adapters/libuv.h
dep/hiredis-0.13.3/adapters/macosx.h
dep/hiredis-0.13.3/adapters/qt.h
dep/hiredis-0.13.3/async.c
dep/hiredis-0.13.3/async.h
dep/hiredis-0.13.3/dict.c
dep/hiredis-0.13.3/dict.h
dep/hiredis-0.13.3/examples/example-ae.c
dep/hiredis-0.13.3/examples/example-glib.c
dep/hiredis-0.13.3/examples/example-ivykis.c
dep/hiredis-0.13.3/examples/example-libev.c
dep/hiredis-0.13.3/examples/example-libevent.c
dep/hiredis-0.13.3/examples/example-libuv.c
dep/hiredis-0.13.3/examples/example-macosx.c
dep/hiredis-0.13.3/examples/example-qt.cpp
dep/hiredis-0.13.3/examples/example-qt.h
dep/hiredis-0.13.3/examples/example.c
dep/hiredis-0.13.3/fmacros.h
dep/hiredis-0.13.3/hiredis.c
dep/hiredis-0.13.3/hiredis.h
dep/hiredis-0.13.3/net.c
dep/hiredis-0.13.3/net.h
dep/hiredis-0.13.3/read.c
dep/hiredis-0.13.3/read.h
dep/hiredis-0.13.3/sds.c
dep/hiredis-0.13.3/sds.h
dep/hiredis-0.13.3/test.c
dep/hiredis-0.13.3/win32.h
dep/jemalloc-4.2.0/include/jemalloc/internal/arena.h
dep/jemalloc-4.2.0/include/jemalloc/internal/assert.h
dep/jemalloc-4.2.0/include/jemalloc/internal/atomic.h
dep/jemalloc-4.2.0/include/jemalloc/internal/base.h
dep/jemalloc-4.2.0/include/jemalloc/internal/bitmap.h
dep/jemalloc-4.2.0/include/jemalloc/internal/chunk.h
dep/jemalloc-4.2.0/include/jemalloc/internal/chunk_dss.h
dep/jemalloc-4.2.0/include/jemalloc/internal/chunk_mmap.h
dep/jemalloc-4.2.0/include/jemalloc/internal/ckh.h
dep/jemalloc-4.2.0/include/jemalloc/internal/ctl.h
dep/jemalloc-4.2.0/include/jemalloc/internal/extent.h
dep/jemalloc-4.2.0/include/jemalloc/internal/hash.h
dep/jemalloc-4.2.0/include/jemalloc/internal/huge.h
dep/jemalloc-4.2.0/include/jemalloc/internal/jemalloc_internal.h
dep/jemalloc-4.2.0/include/jemalloc/internal/jemalloc_internal_decls.h
dep/jemalloc-4.2.0/include/jemalloc/internal/jemalloc_internal_defs.h
dep/jemalloc-4.2.0/include/jemalloc/internal/jemalloc_internal_macros.h
dep/jemalloc-4.2.0/include/jemalloc/internal/mb.h
dep/jemalloc-4.2.0/include/jemalloc/internal/mutex.h
dep/jemalloc-4.2.0/include/jemalloc/internal/nstime.h
dep/jemalloc-4.2.0/include/jemalloc/internal/pages.h
dep/jemalloc-4.2.0/include/jemalloc/internal/ph.h
dep/jemalloc-4.2.0/include/jemalloc/internal/private_namespace.h
dep/jemalloc-4.2.0/include/jemalloc/internal/private_unnamespace.h
dep/jemalloc-4.2.0/include/jemalloc/internal/prng.h
dep/jemalloc-4.2.0/include/jemalloc/internal/prof.h
dep/jemalloc-4.2.0/include/jemalloc/internal/public_namespace.h
dep/jemalloc-4.2.0/include/jemalloc/internal/public_unnamespace.h
dep/jemalloc-4.2.0/include/jemalloc/internal/ql.h
dep/jemalloc-4.2.0/include/jemalloc/internal/qr.h
dep/jemalloc-4.2.0/include/jemalloc/internal/quarantine.h
dep/jemalloc-4.2.0/include/jemalloc/internal/rb.h
dep/jemalloc-4.2.0/include/jemalloc/internal/rtree.h
dep/jemalloc-4.2.0/include/jemalloc/internal/size_classes.h
dep/jemalloc-4.2.0/include/jemalloc/internal/smoothstep.h
dep/jemalloc-4.2.0/include/jemalloc/internal/stats.h
dep/jemalloc-4.2.0/include/jemalloc/internal/tcache.h
dep/jemalloc-4.2.0/include/jemalloc/internal/ticker.h
dep/jemalloc-4.2.0/include/jemalloc/internal/tsd.h
dep/jemalloc-4.2.0/include/jemalloc/internal/util.h
dep/jemalloc-4.2.0/include/jemalloc/internal/valgrind.h
dep/jemalloc-4.2.0/include/jemalloc/internal/witness.h
dep/jemalloc-4.2.0/include/jemalloc/jemalloc.h
dep/jemalloc-4.2.0/include/jemalloc/jemalloc_defs.h
dep/jemalloc-4.2.0/include/jemalloc/jemalloc_macros.h
dep/jemalloc-4.2.0/include/jemalloc/jemalloc_mangle.h
dep/jemalloc-4.2.0/include/jemalloc/jemalloc_mangle_jet.h
dep/jemalloc-4.2.0/include/jemalloc/jemalloc_protos.h
dep/jemalloc-4.2.0/include/jemalloc/jemalloc_protos_jet.h
dep/jemalloc-4.2.0/include/jemalloc/jemalloc_rename.h
dep/jemalloc-4.2.0/include/jemalloc/jemalloc_typedefs.h
dep/jemalloc-4.2.0/include/msvc_compat/C99/stdbool.h
dep/jemalloc-4.2.0/include/msvc_compat/C99/stdint.h
dep/jemalloc-4.2.0/include/msvc_compat/strings.h
dep/jemalloc-4.2.0/include/msvc_compat/windows_extra.h
dep/jemalloc-4.2.0/msvc/projects/vc2015/test_threads/test_threads.cpp
dep/jemalloc-4.2.0/msvc/projects/vc2015/test_threads/test_threads.h
dep/jemalloc-4.2.0/msvc/projects/vc2015/test_threads/test_threads_main.cpp
dep/jemalloc-4.2.0/src/arena.c
dep/jemalloc-4.2.0/src/atomic.c
dep/jemalloc-4.2.0/src/base.c
dep/jemalloc-4.2.0/src/bitmap.c
dep/jemalloc-4.2.0/src/chunk.c
dep/jemalloc-4.2.0/src/chunk_dss.c
dep/jemalloc-4.2.0/src/chunk_mmap.c
dep/jemalloc-4.2.0/src/ckh.c
dep/jemalloc-4.2.0/src/ctl.c
dep/jemalloc-4.2.0/src/extent.c
dep/jemalloc-4.2.0/src/hash.c
dep/jemalloc-4.2.0/src/huge.c
dep/jemalloc-4.2.0/src/jemalloc.c
dep/jemalloc-4.2.0/src/mb.c
dep/jemalloc-4.2.0/src/mutex.c
dep/jemalloc-4.2.0/src/nstime.c
dep/jemalloc-4.2.0/src/pages.c
dep/jemalloc-4.2.0/src/prng.c
dep/jemalloc-4.2.0/src/prof.c
dep/jemalloc-4.2.0/src/quarantine.c
dep/jemalloc-4.2.0/src/rtree.c
dep/jemalloc-4.2.0/src/stats.c
dep/jemalloc-4.2.0/src/tcache.c
dep/jemalloc-4.2.0/src/ticker.c
dep/jemalloc-4.2.0/src/tsd.c
dep/jemalloc-4.2.0/src/util.c
dep/jemalloc-4.2.0/src/valgrind.c
dep/jemalloc-4.2.0/src/witness.c
dep/jemalloc-4.2.0/src/zone.c
dep/jemalloc-4.2.0/test/include/test/SFMT-alti.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params11213.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params1279.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params132049.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params19937.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params216091.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params2281.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params4253.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params44497.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params607.h
dep/jemalloc-4.2.0/test/include/test/SFMT-params86243.h
dep/jemalloc-4.2.0/test/include/test/SFMT-sse2.h
dep/jemalloc-4.2.0/test/include/test/SFMT.h
dep/jemalloc-4.2.0/test/include/test/btalloc.h
dep/jemalloc-4.2.0/test/include/test/jemalloc_test.h
dep/jemalloc-4.2.0/test/include/test/jemalloc_test_defs.h
dep/jemalloc-4.2.0/test/include/test/math.h
dep/jemalloc-4.2.0/test/include/test/mq.h
dep/jemalloc-4.2.0/test/include/test/mtx.h
dep/jemalloc-4.2.0/test/include/test/test.h
dep/jemalloc-4.2.0/test/include/test/thd.h
dep/jemalloc-4.2.0/test/include/test/timer.h
dep/jemalloc-4.2.0/test/integration/MALLOCX_ARENA.c
dep/jemalloc-4.2.0/test/integration/aligned_alloc.c
dep/jemalloc-4.2.0/test/integration/allocated.c
dep/jemalloc-4.2.0/test/integration/chunk.c
dep/jemalloc-4.2.0/test/integration/mallocx.c
dep/jemalloc-4.2.0/test/integration/overflow.c
dep/jemalloc-4.2.0/test/integration/posix_memalign.c
dep/jemalloc-4.2.0/test/integration/rallocx.c
dep/jemalloc-4.2.0/test/integration/sdallocx.c
dep/jemalloc-4.2.0/test/integration/thread_arena.c
dep/jemalloc-4.2.0/test/integration/thread_tcache_enabled.c
dep/jemalloc-4.2.0/test/integration/xallocx.c
dep/jemalloc-4.2.0/test/src/SFMT.c
dep/jemalloc-4.2.0/test/src/btalloc.c
dep/jemalloc-4.2.0/test/src/btalloc_0.c
dep/jemalloc-4.2.0/test/src/btalloc_1.c
dep/jemalloc-4.2.0/test/src/math.c
dep/jemalloc-4.2.0/test/src/mq.c
dep/jemalloc-4.2.0/test/src/mtx.c
dep/jemalloc-4.2.0/test/src/test.c
dep/jemalloc-4.2.0/test/src/thd.c
dep/jemalloc-4.2.0/test/src/timer.c
dep/jemalloc-4.2.0/test/stress/microbench.c
dep/jemalloc-4.2.0/test/unit/SFMT.c
dep/jemalloc-4.2.0/test/unit/a0.c
dep/jemalloc-4.2.0/test/unit/arena_reset.c
dep/jemalloc-4.2.0/test/unit/atomic.c
dep/jemalloc-4.2.0/test/unit/bitmap.c
dep/jemalloc-4.2.0/test/unit/ckh.c
dep/jemalloc-4.2.0/test/unit/decay.c
dep/jemalloc-4.2.0/test/unit/fork.c
dep/jemalloc-4.2.0/test/unit/hash.c
dep/jemalloc-4.2.0/test/unit/junk.c
dep/jemalloc-4.2.0/test/unit/junk_alloc.c
dep/jemalloc-4.2.0/test/unit/junk_free.c
dep/jemalloc-4.2.0/test/unit/lg_chunk.c
dep/jemalloc-4.2.0/test/unit/mallctl.c
dep/jemalloc-4.2.0/test/unit/math.c
dep/jemalloc-4.2.0/test/unit/mq.c
dep/jemalloc-4.2.0/test/unit/mtx.c
dep/jemalloc-4.2.0/test/unit/nstime.c
dep/jemalloc-4.2.0/test/unit/ph.c
dep/jemalloc-4.2.0/test/unit/prng.c
dep/jemalloc-4.2.0/test/unit/prof_accum.c
dep/jemalloc-4.2.0/test/unit/prof_active.c
dep/jemalloc-4.2.0/test/unit/prof_gdump.c
dep/jemalloc-4.2.0/test/unit/prof_idump.c
dep/jemalloc-4.2.0/test/unit/prof_reset.c
dep/jemalloc-4.2.0/test/unit/prof_thread_name.c
dep/jemalloc-4.2.0/test/unit/ql.c
dep/jemalloc-4.2.0/test/unit/qr.c
dep/jemalloc-4.2.0/test/unit/quarantine.c
dep/jemalloc-4.2.0/test/unit/rb.c
dep/jemalloc-4.2.0/test/unit/rtree.c
dep/jemalloc-4.2.0/test/unit/run_quantize.c
dep/jemalloc-4.2.0/test/unit/size_classes.c
dep/jemalloc-4.2.0/test/unit/smoothstep.c
dep/jemalloc-4.2.0/test/unit/stats.c
dep/jemalloc-4.2.0/test/unit/ticker.c
dep/jemalloc-4.2.0/test/unit/tsd.c
dep/jemalloc-4.2.0/test/unit/util.c
dep/jemalloc-4.2.0/test/unit/witness.c
dep/jemalloc-4.2.0/test/unit/zero.c
dep/sds/sds.c
dep/sds/sds.c
dep/sds/sds.h
dep/sds/sds.h
dep/sds/sdsalloc.h
dep/sds/sdsalloc.h
dep/util/dlog.c
dep/util/dlog.c
dep/util/dlog.h
dep/util/dlog.h
dep/util/dspecialconfig.h
dep/util/dspecialconfig.h
dep/util/dutil.c
dep/util/dutil.c
dep/util/dutil.h
dep/util/dutil.h
src/vr.c
src/vr.c
src/vr_aof.c
src/vr_aof.c
src/vr_aof.h
src/vr_aof.h
src/vr_backend.c
src/vr_backend.c
src/vr_backend.h
src/vr_backend.h
src/vr_bitops.c
src/vr_bitops.c
src/vr_bitops.h
src/vr_bitops.h
src/vr_block.c
src/vr_block.c
src/vr_block.h
src/vr_block.h
src/vr_client.c
src/vr_client.c
src/vr_client.h
src/vr_client.h
src/vr_command.c
src/vr_command.c
src/vr_command.h
src/vr_command.h
src/vr_conf.c
src/vr_conf.c
src/vr_conf.h
src/vr_conf.h
src/vr_connection.c
src/vr_connection.c
src/vr_connection.h
src/vr_connection.h
src/vr_core.c
src/vr_core.c
src/vr_core.h
src/vr_core.h
src/vr_db.c
src/vr_db.c
src/vr_db.h
src/vr_db.h
src/vr_dict.c
src/vr_dict.c
src/vr_dict.h
src/vr_dict.h
src/vr_eventloop.c
src/vr_eventloop.c
src/vr_eventloop.h
src/vr_eventloop.h
src/vr_hyperloglog.c
src/vr_hyperloglog.c
src/vr_hyperloglog.h
src/vr_hyperloglog.h
src/vr_intset.c
src/vr_intset.c
src/vr_intset.h
src/vr_intset.h
src/vr_listen.c
src/vr_listen.c
src/vr_listen.h
src/vr_listen.h
src/vr_lzf.h
src/vr_lzf.h
src/vr_lzfP.h
src/vr_lzfP.h
src/vr_lzf_c.c
src/vr_lzf_c.c
src/vr_lzf_d.c
src/vr_lzf_d.c
src/vr_master.c
src/vr_master.c
src/vr_master.h
src/vr_master.h
src/vr_multi.c
src/vr_multi.c
src/vr_multi.h
src/vr_multi.h
src/vr_notify.c
src/vr_notify.c
src/vr_notify.h
src/vr_notify.h
src/vr_object.c
src/vr_object.c
src/vr_object.h
src/vr_object.h
src/vr_pubsub.c
src/vr_pubsub.c
src/vr_pubsub.h
src/vr_pubsub.h
src/vr_quicklist.c
src/vr_quicklist.c
src/vr_quicklist.h
src/vr_quicklist.h
src/vr_rbtree.c
src/vr_rbtree.c
src/vr_rbtree.h
src/vr_rbtree.h
src/vr_rdb.c
src/vr_rdb.c
src/vr_rdb.h
src/vr_rdb.h
src/vr_replication.c
src/vr_replication.c
src/vr_replication.h
src/vr_replication.h
src/vr_scripting.c
src/vr_scripting.c
src/vr_scripting.h
src/vr_scripting.h
src/vr_server.c
src/vr_server.c
src/vr_server.h
src/vr_server.h
src/vr_signal.c
src/vr_signal.c
src/vr_signal.h
src/vr_signal.h
src/vr_slowlog.c
src/vr_slowlog.c
src/vr_slowlog.h
src/vr_slowlog.h
src/vr_stats.c
src/vr_stats.c
src/vr_stats.h
src/vr_stats.h
src/vr_t_hash.c
src/vr_t_hash.c
src/vr_t_hash.h
src/vr_t_hash.h
src/vr_t_list.c
src/vr_t_list.c
src/vr_t_list.h
src/vr_t_list.h
src/vr_t_set.c
src/vr_t_set.c
src/vr_t_set.h
src/vr_t_set.h
src/vr_t_string.c
src/vr_t_string.c
src/vr_t_string.h
src/vr_t_string.h
src/vr_t_zset.c
src/vr_t_zset.c
src/vr_t_zset.h
src/vr_t_zset.h
src/vr_thread.c
src/vr_thread.c
src/vr_thread.h
src/vr_thread.h
src/vr_util.c
src/vr_util.c
src/vr_util.h
src/vr_util.h
src/vr_worker.c
src/vr_worker.c
src/vr_worker.h
src/vr_worker.h
src/vr_ziplist.c
src/vr_ziplist.c
src/vr_ziplist.h
src/vr_ziplist.h
src/vr_zipmap.c
src/vr_zipmap.c
src/vr_zipmap.h
src/vr_zipmap.h
tests/vrabtest.c
tests/vrabtest.c
tests/vrabtest.h
tests/vrabtest.h
tests/vrt_backend.c
tests/vrt_backend.c
tests/vrt_backend.h
tests/vrt_backend.h
tests/vrt_benchmark.c
tests/vrt_benchmark.c
tests/vrt_check_data.c
tests/vrt_check_data.c
tests/vrt_check_data.h
tests/vrt_check_data.h
tests/vrt_dispatch_data.c
tests/vrt_dispatch_data.c
tests/vrt_dispatch_data.h
tests/vrt_dispatch_data.h
tests/vrt_produce_data.c
tests/vrt_produce_data.c
tests/vrt_produce_data.h
tests/vrt_produce_data.h
tests/vrt_public.c
tests/vrt_public.c
tests/vrt_public.h
tests/vrt_public.h
tests/vrt_simple.c
tests/vrt_simple.c
tests/vrt_simple.h
tests/vrt_simple.h
tests/vrt_util.c
tests/vrt_util.c
tests/vrt_util.h
tests/vrt_util.h
tests/vrtest.c
tests/vrtest.c
